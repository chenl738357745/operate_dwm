--------------------------------------------------------
--  文件已创建 - 星期五-一月-29-2021   
--------------------------------------------------------
--------------------------------------------------------
--  DDL for Procedure CHENL_P_SYS_GET_COMPANY_TREE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "CHENL_P_SYS_GET_COMPANY_TREE" (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    data_auth_info   OUT              SYS_REFCURSOR
) AS
--获取公司树
--作者：谷国斌
--日期：2019/12/13
    rulevalue   VARCHAR2(50);
    authcount   INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    spid        VARCHAR2(36);--使用临时表的批次号
BEGIN
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;
--插入集团作为根节点

    INSERT INTO tmp_company_tree (
        id,
        org_id,
        org_name,
        org_type,
        parent_id,
        is_company,
        order_code
    )
        SELECT
            spid,
            id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_hierarchy_code
        FROM
            sys_business_unit
        WHERE
            id = '003200000000000000000000000000';

--获取隔离规则：

    SELECT
        isolation_rule_value
    INTO rulevalue
    FROM
        sys_data_auth_biz
    WHERE
        biz_obj_code = bizcode;

    IF rulevalue = '全集团' THEN
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                is_company,
                order_hierarchy_code
            FROM
                sys_business_unit
            WHERE
                is_company = 1;

    ELSE 
--插入本公司及其父级
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                is_company,
                order_hierarchy_code
            FROM
                sys_business_unit
            WHERE
                is_company = 1
            START WITH
                id = companyid
            CONNECT BY
                PRIOR parent_id = id;

--插入数据授权的数据：

        DECLARE
            ownerid     VARCHAR2(36);
            oenertype   NVARCHAR2(50);
            CURSOR cursor_company IS
            SELECT DISTINCT
                auth_owner_id,
                auth_owner_type
            FROM
                sys_data_auth
            WHERE
                auth_biz_code = bizcode
                AND is_disabled = 0;

        BEGIN   

            --打开游标
            OPEN cursor_company;
            LOOP
                FETCH cursor_company INTO
                    ownerid,
                    oenertype;
                EXIT WHEN cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                IF oenertype = '公司' OR oenertype = '集团' THEN
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                        AND id = companyid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF oenertype = '部门' THEN
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 0
                        AND id = deptid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                    INSERT INTO tmp_auth_owner (
                        id,
                        auth_owner_id,
                        auth_owner_type
                    ) VALUES (
                        spid,
                        ownerid,
                        oenertype
                    );

                END IF;

            END LOOP;

            CLOSE cursor_company;
        END;   

          --获取有权限的公司及其父级：            
        DBMS_OUTPUT.PUT_LINE('获取有权限的公司及其父级');
        DECLARE
            ownerid2 VARCHAR2(36);
            CURSOR cursor_auth IS
            SELECT
                auth_owner_id
            FROM
                tmp_auth_owner
            WHERE
                id = spid;

        BEGIN   

                    --打开游标
            OPEN cursor_auth;
            LOOP
                FETCH cursor_auth INTO ownerid2;
                
                EXIT WHEN cursor_auth%notfound;



                            --授权对象为公司：
                            --取授权公司的子级：
                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type IN (
                                    '公司',
                                    '集团'
                                )
                        )
                    CONNECT BY
                        PRIOR id = parent_id;


                            --取授权公司的父级：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type IN (
                                    '公司',
                                    '集团'
                                )
                        )
                    CONNECT BY
                        PRIOR parent_id = id;

                             --授权对应为部门：
                               --取授权部门的父级：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type = '部门'
                        )
                    CONNECT BY
                        PRIOR parent_id = id;
                --授权对应为项目：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT
                                unit_id
                            FROM
                                sys_project
                            WHERE
                                id IN (
                                    SELECT DISTINCT
                                        auth_scope_id
                                    FROM
                                        sys_data_auth
                                    WHERE
                                        auth_biz_code = bizcode
                                        AND is_disabled = 0
                                        AND auth_owner_id = ownerid2
                                        AND auth_scope_type = '项目'
                                        and auth_type='项目'
                                )
                        )
                    CONNECT BY
                        PRIOR parent_id = id;

            END LOOP;

            CLOSE cursor_auth;
        END;

    END IF;

    OPEN data_auth_info FOR SELECT DISTINCT
                               org_id       AS orgid,
                               org_name     AS orgname,
                               org_type     AS orgtype,
                               parent_id    AS parentid,
                               is_company   AS iscompany,
                               order_code   AS ordercode
                           FROM
                               tmp_company_tree
                           WHERE
                               id = spid
                           ORDER BY
                               order_code;

END chenl_p_sys_get_company_tree;

/
--------------------------------------------------------
--  DDL for Procedure CL_P_DWM_SALE_RATE_BY_GRA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "CL_P_DWM_SALE_RATE_BY_GRA" (
    spid_info   OUT  SYS_REFCURSOR,
    t_room_info   OUT  SYS_REFCURSOR ,
    spid_tree_info   OUT  SYS_REFCURSOR,
    info OUT  SYS_REFCURSOR
) AS
		--业态面积段颗粒度去化率；作用=》定时任务拍照
		--作者：陈丽
		--日期：2020-04-10
  PROJ_BASE_SPID VARCHAR2(2000);
  sys_created date:=sysdate;
  spid VARCHAR2(360); --使用临时表的批次号
  spid_tree VARCHAR2(360); --使用临时表的批次号
  dwm_REMARK VARCHAR2(200):='测试-chenl';
  ----------------------
  v_sql clob;
  v_sql_start VARCHAR2(2000):= ' case ';
  v_sql_content clob:= '';
  v_sql_end VARCHAR2(2000):= '  else ''主数据面积段外'' end  ';
BEGIN
delete TMP_ROOM;
delete TMP_SALE_RATE_BY_GRANULARITY;
---------------------------
--------------------------------------------------------创建临时表批次号
    SELECT
        get_uuid(),get_uuid()
    INTO spid,spid_tree
    FROM
        dual;  
---------------------------------------------计算业态面积段1.拼接查询语句
 FOR item IN (
   select 
    ' when '||l.lower_limit_value||l.lower_limit_type||'room.NEW_BLD_AREA and room.NEW_BLD_AREA '||l.upper_limit_type||l.upper_limit_value
    ||' and (case when room.PRODUCT_NAME<>''住宅'' then ''商铺及其他'' else ''住宅'' end)='''||p.attribute_name||''' then ''' ||l.attribute_name||''' ' as aa,
    l.upper_limit_type,
    l.lower_limit_type,
    l.upper_limit_value,
    p.attribute_name as ptype from mdm_attribute_area_level l
    left join mdm_attribute_area_level p on l.parent_id=p.id 
    where p.id is not null
        ) LOOP 
    ---拼接字符串
         v_sql_content := v_sql_content||item.aa;
        END LOOP;
    --规则内容大于0才拼规则语句
        IF length(v_sql_content) > 0 THEN
            v_sql := v_sql_start
                     || v_sql_content
                     || v_sql_end;
        ELSE
            v_sql := '''''';
        END IF;

       v_sql:= 'INSERT INTO TMP_ROOM(id,room_ID,BLD_AREA,ROOM_NAME,PRODUCT_NAME,AREA_LEVEL) select '''||spid||''',id,NEW_BLD_AREA,room_name,case when room.product_name<>''住宅'' then ''商铺及其他'' else ''住宅'' end,'
       ||v_sql|| ' as NODE_WARNING from mdm_room room';
         dbms_output.put_line(v_sql);
       execute immediate v_sql;

        OPEN t_room_info FOR select * from TMP_ROOM;  
-----------------------------------------------项目基本信息
BEGIN
  P_DWM_SALE_RATE_PROJ(0,
    PROJ_BASE_SPID => PROJ_BASE_SPID
  );
    END;
 ------------------------------------------------------------业态面积段树拼接 spid_tree
 INSERT INTO TMP_SALE_RATE_BY_GRANULARITY (ID---【1】主键
,"SORT"
,GRANULARITY_ID--颗粒度id
,PROJECT_ID---【2】项目ID
,PROJECT_NAME--项目名称
,PARENT_ID---父级id
,DATA_GRANULARITY--颗粒度名称
)
-----业态
select spid_tree
,b.order_code
,proj.PROJECT_ID||b."业态" as GRANULARITY_ID
,proj.PROJECT_ID as projectId
,proj.PROJECT_NAME
,null as parentId 
,b."业态" as text   
 from (select * from tmp_proj_base where id = PROJ_BASE_SPID) proj cross join
(select 
   case when l.attribute_name<>'住宅' then '商铺及其他' else '住宅' end  as "业态",order_code  from mdm_attribute_area_level l where parent_id is null) b
   union all
-----面积段
select spid_tree
,a.order_code
,proj.PROJECT_ID||ptype||a.areaStage as GRANULARITY_ID
,proj.PROJECT_ID as projectId
,proj.PROJECT_NAME
,proj.PROJECT_ID||ptype as parentId 
,a.areaStage as text
from  (select * from tmp_proj_base where id = PROJ_BASE_SPID) proj cross join
( select 
    l.attribute_name as areaStage,l.order_code,case when p.attribute_name<>'住宅' then '商铺及其他' else '住宅' end  as ptype from mdm_attribute_area_level l
    left join mdm_attribute_area_level p on l.parent_id=p.id 
    where p.id is not null) a;

OPEN spid_tree_info FOR select * from TMP_SALE_RATE_BY_GRANULARITY where id=spid_tree;  
------------------------------------------------------面积段数据 spid

 INSERT INTO TMP_SALE_RATE_BY_GRANULARITY (ID---【1】主键
,GRANULARITY_ID
,PROJECT_ID---【2】项目ID
,PROJECT_NAME
,FO_SALE_OUT_COUNT---【3】首开去化套数
,FO_SALE_COUNT---【4】首开推售套数
,FO_SALE_RATE_BY_COUNT---【5】首开去化率(按套数)（3/4）
,FO_SALE_OUT_AREA---【6】首开去化面积
,FO_SALE_AREA---【7】首开推售面积
,FO_SALE_RATE_BY_AREA---【8】首开去化率(按面积)（6/7）
,FO_SALE_OUT_MONEY---【9】首开去化货值
,FO_SALE_MONEY---【10】首开推售货值
,FO_SALE_RATE_BY_MONEY---【11】首开去化率(按货值)（9/10）
,FO_SURPLUS_SALE_MONEY---【12】首开剩余货值(10-9)
,FO_SALE_AVERAGE_MONEY---【13】首开标准均价(10/7)
,FO_SALE_OUT_AVERAGE_MONEY---【14】首开签约均价(9/6)
,PO_SALE_OUT_COUNT---【15】全案去化套数
,PO_SALE_COUNT---【16】全案推售套数
,PO_SALE_RATE_BY_COUNT---【17】全案去化率(按套数)(15/16)
,PO_SALE_OUT_AREA---【18】全案去化面积
,PO_SALE_AREA---【19】全案推售面积
,PO_SALE_RATE_BY_AREA---【20】全案去化率(按面积)(18/19)
,PO_SALE_OUT_MONEY---【21】全案去化货值
,PO_SALE_MONEY---【22】全案推售货值
,PO_SALE_RATE_BY_MONEY---【23】全案去化率(按货值)(21/22)
,PO_SURPLUS_SALE_MONEY---【24】全案剩余货值(22-21)
,PO_SALE_AVERAGE_MONEY---【25】全案标准均价(22/19)
,PO_SALE_OUT_AVERAGE_MONEY---【26】全案签约均价(21/18)
,EH_SALE_OUT_COUNT---【27】现房去化套数
,EH_SALE_COUNT---【28】现房推售套数
,EH_SALE_RATE_BY_COUNT---【29】现房去化率(按套数)(27/28)
,EH_SALE_OUT_AREA---【30】现房去化面积
,EH_SALE_AREA---【31】现房推售面积
,EH_SALE_RATE_BY_AREA---【32】现房去化率(按面积)(30/31)
,EH_SALE_OUT_MONEY---【33】现房去化货值
,EH_SALE_MONEY---【34】现房推售货值
,EH_SALE_RATE_BY_MONEY---【35】现房去化率(按货值)(33/34)
,EH_SURPLUS_SALE_MONEY---【36】现房剩余货值(34-33)
,EH_SALE_AVERAGE_MONEY---【37】现房标准均价(34/31)
,EH_SALE_OUT_AVERAGE_MONEY---【38】现房签约均价(33/30)
,SI_SALE_OUT_COUNT---【39】顽固性库存去化套数
,SI_SALE_COUNT---【40】顽固性库存推售套数
,SI_SALE_RATE_BY_COUNT---【41】顽固性库存去化率(按套数)(39/40)
,SI_SALE_OUT_AREA---【42】顽固性库存去化面积
,SI_SALE_AREA---【43】顽固性库存推售面积
,SI_SALE_RATE_BY_AREA---【44】顽固性库存去化率(按面积)(42/43)
,SI_SALE_OUT_MONEY---【45】顽固性库存去化货值
,SI_SALE_MONEY---【46】顽固性库存推售货值
,SI_SALE_RATE_BY_MONEY---【47】顽固性库存去化率(按货值)(45/46)
,SI_SURPLUS_SALE_MONEY---【48】顽固性库存剩余货值(46-45)
,SI_SALE_AVERAGE_MONEY---【49】顽固性库存标准均价(46/43)
,SI_SALE_OUT_AVERAGE_MONEY---【50】顽固性库存签约均价(45/42)
,PARENT_ID  
,DATA_GRANULARITY
,PRODUCT_NAME
,CREATED---【51】创建日期
,REMARK
)select 
spid as ID---【1】主键
,project_id||PRODUCT_NAME||AREA_LEVEL
,project_id as PROJECT_ID---【2】项目ID
,project_name
-----------------------------------K1、首开去化率开始--------------------
,"首开去化套数" as FO_SALE_OUT_COUNT---【3】首开去化套数
,"首开推售套数" as FO_SALE_COUNT---【4】首开推售套数
,case when 首开推售套数=0 then 0 else round("首开去化套数"/"首开推售套数",4)  end as FO_SALE_RATE_BY_COUNT---【5】首开去化率(按套数)（3/4）
,"首开去化面积" as FO_SALE_OUT_AREA---【6】首开去化面积
,"首开推售面积" as FO_SALE_AREA---【7】首开推售面积
,case when 首开推售面积=0 then 0 else round("首开去化面积"/"首开推售面积",4)  end as FO_SALE_RATE_BY_AREA---【8】首开去化率(按面积)（6/7）
,"首开去化货值" as FO_SALE_OUT_MONEY---【9】首开去化货值
,"首开推售货值" as FO_SALE_MONEY---【10】首开推售货值
,case when 首开推售货值=0 then 0 else round("首开去化货值"/"首开推售货值",4)  end as FO_SALE_RATE_BY_MONEY---【11】首开去化率(按货值)（9/10）
,"首开推售货值"-"首开去化货值" as FO_SURPLUS_SALE_MONEY---【12】首开剩余货值(10-9)
,case when 首开推售面积=0 then 0 else round("首开推售货值"/"首开推售面积",4)  end  as FO_SALE_AVERAGE_MONEY---【13】首开标准均价(10/7)
,case when 首开去化面积=0 then 0 else round("首开去化货值"/"首开去化面积",4)  end as FO_SALE_OUT_AVERAGE_MONEY---【14】首开签约均价(9/6)
-----------------------------------K3、全案去化率 （单位：%）--------------------
,"全案已去化套数" as PO_SALE_OUT_COUNT---【15】全案去化套数
,"全案已领证套数" as PO_SALE_COUNT---【16】全案推售套数
,case when 全案已领证套数=0 then 0 else round("全案已去化套数"/"全案已领证套数",4)  end as PO_SALE_RATE_BY_COUNT---【17】全案去化率(按套数)(15/16)
,"全案已去化面积" as PO_SALE_OUT_AREA---【18】全案去化面积
,"全案已领证面积" as PO_SALE_AREA---【19】全案推售面积
,case when 全案已领证面积=0 then 0 else round("全案已去化面积"/"全案已领证面积",4)  end as PO_SALE_RATE_BY_AREA---【20】全案去化率(按面积)(18/19)
,"全案已去化货值" as PO_SALE_OUT_MONEY---【21】全案去化货值
,"全案已领证货值" as PO_SALE_MONEY---【22】全案推售货值
,case when 全案已领证货值=0 then 0 else round("全案已去化货值"/"全案已领证货值",4)  end  as PO_SALE_RATE_BY_MONEY---【23】全案去化率(按货值)(21/22)
,"全案已领证货值"-"全案已去化货值" as PO_SURPLUS_SALE_MONEY---【24】全案剩余货值(22-21)
,case when 全案已领证面积=0 then 0 else round("全案已领证货值"/"全案已领证面积",4)  end  as PO_SALE_AVERAGE_MONEY---【25】全案标准均价(22/19)
,case when 全案已去化面积=0 then 0 else round("全案已去化货值"/"全案已去化面积",4)  end   PO_SALE_OUT_AVERAGE_MONEY---【26】全案签约均价(21/18)
-----------------------------------K4、现房去化率 （单位：%）--------------------
,"现房去化套数" as EH_SALE_OUT_COUNT---【27】现房去化套数
,"现房推售套数" as EH_SALE_COUNT---【28】现房推售套数
,case when 现房推售套数=0 then 0 else  round("现房去化套数"/"现房推售套数",4) end as EH_SALE_RATE_BY_COUNT---【29】现房去化率(按套数)(27/28)
,"现房去化面积" as EH_SALE_OUT_AREA---【30】现房去化面积
,"现房推售面积" as EH_SALE_AREA---【31】现房推售面积
,case when 现房推售面积=0 then 0 else  round("现房去化面积"/"现房推售面积",4) end as EH_SALE_RATE_BY_AREA---【32】现房去化率(按面积)(30/31)
,"现房去化金额" as EH_SALE_OUT_MONEY---【33】现房去化货值
,"现房推售金额" as EH_SALE_MONEY---【34】现房推售货值
,case when 现房推售金额=0 then 0 else  round("现房去化金额"/"现房推售金额",4) end as EH_SALE_RATE_BY_MONEY---【35】现房去化率(按货值)(33/34)
,"现房推售金额"-"现房去化金额" as EH_SURPLUS_SALE_MONEY---【36】现房剩余货值(34-33)
,case when 现房推售面积=0 then 0 else  round("现房推售金额"/"现房推售面积",4) end  as EH_SALE_AVERAGE_MONEY---【37】现房标准均价(34/31)
,case when 现房去化面积=0 then 0 else  round("现房去化金额"/"现房去化面积",4) end  as EH_SALE_OUT_AVERAGE_MONEY---【38】现房签约均价(33/30)
-----------------------------------K5、顽固性库存去化率 （单位：%）--------------------
,"顽固去化套数" as SI_SALE_OUT_COUNT---【39】顽固性库存去化套数
,"顽固推售套数" as SI_SALE_COUNT---【40】顽固性库存推售套数
,case when 顽固推售套数=0 then 0 else  round("顽固去化套数"/"顽固推售套数",4) end as SI_SALE_RATE_BY_COUNT---【41】顽固性库存去化率(按套数)(39/40)
,"顽固去化面积" as SI_SALE_OUT_AREA---【42】顽固性库存去化面积
,"顽固推售面积" as SI_SALE_AREA---【43】顽固性库存推售面积
,case when 顽固推售面积=0 then 0 else  round("顽固去化面积"/"顽固推售面积",4) end  as SI_SALE_RATE_BY_AREA---【44】顽固性库存去化率(按面积)(42/43)
,"顽固去化金额" as SI_SALE_OUT_MONEY---【45】顽固性库存去化货值
,"顽固推售金额" as SI_SALE_MONEY---【46】顽固性库存推售货值
,case when 顽固推售金额=0 then 0 else  round("顽固去化金额"/"顽固推售金额",4) end as SI_SALE_RATE_BY_MONEY---【47】顽固性库存去化率(按货值)(45/46)
,"顽固推售金额"-"顽固去化金额" SI_SURPLUS_SALE_MONEY---【48】顽固性库存剩余货值(46-45)
,case when 顽固推售面积=0 then 0 else  round("顽固推售金额"/"顽固推售面积",4) end as SI_SALE_AVERAGE_MONEY---【49】顽固性库存标准均价(46/43)
,case when 顽固推售面积=0 then 0 else  round("顽固去化金额"/"顽固推售面积",4) end as SI_SALE_OUT_AVERAGE_MONEY---【50】顽固性库存签约均价(45/42)
-------------------- 业态面积段特有 start
,project_id||PRODUCT_NAME  as PARENT_ID  
,AREA_LEVEL as DATA_GRANULARITY
,PRODUCT_NAME    
,sys_created as CREATED---【51】创建日期
,dwm_REMARK
-------------------- 业态面积段特有 end
from 
(select 
------首次开盘30天内的签约金额（首开去化货值）: 
---------->房间“合同成交总价”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约
sum(case when room.SALE_STATE='签约' and proj.first_open_date<build.GET_PRE_SALE_PERMIT_DATE and room.TRADE_CONTRACT_DATE<proj.first_open_date +30 then room.TRADE_TOTAL else 0 end ) as "首开去化货值"
------首次开盘已取证货值（首开推售货值）：
---------->房间“面价标准总价”:在计算“货值去化率”时，对已签约房间（有可能出现优惠打折），分子分母均按“签约金额”计算“货值去化率”。
---------->房间所属“楼栋预售许可证获取日期”<"项目开盘"的实际完成日期 
,sum(case when room.SALE_STATE='签约' and build.GET_PRE_SALE_PERMIT_DATE<proj.first_open_date then room.TRADE_TOTAL 
when build.GET_PRE_SALE_PERMIT_DATE<proj.first_open_date then room.BZ_TOTAL else 0 end )  as "首开推售货值"
------首次开盘30天内的签约面积（首开去化面积）:
---------->房间“最新建筑面积”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' and proj.first_open_date<build.GET_PRE_SALE_PERMIT_DATE and room.TRADE_CONTRACT_DATE<proj.first_open_date +30  then room.NEW_BLD_AREA else 0 end ) as "首开去化面积"
------首次开盘的已取证面积（首开推售面积）:
---------->房间“最新建筑面积”
---------->房间所属“楼栋预售许可证获取日期”<"项目开盘"的实际完成日期 
,sum(case when build.GET_PRE_SALE_PERMIT_DATE<proj.first_open_date then room.NEW_BLD_AREA  else 0 end )  as "首开推售面积"
------首次开盘30天内的签约套数（首开去化套数）:
---------->房间“汇总”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' and proj.first_open_date<build.GET_PRE_SALE_PERMIT_DATE and room.TRADE_CONTRACT_DATE<proj.first_open_date +30 then 1 else 0 end ) as "首开去化套数"
------首次开盘的已取证套数（首开推售套数）:
---------->房间“汇总”
---------->房间所属“楼栋预售许可证获取日期”<"项目开盘"的实际完成日期 
,sum(case when build.GET_PRE_SALE_PERMIT_DATE<proj.first_open_date then 1 else 0 end )  as "首开推售套数"

------全案------全案------全案------全案------全案------全案------全案 
------全案（已去化货值）: 
---------->房间“合同成交总价”
---------->房间“销售状态”=签约
,sum(case when room.SALE_STATE='签约' then room.TRADE_TOTAL else 0 end ) as "全案已去化货值"
------全案（已领证货值）：
---------->房间“面价标准总价”:在计算“货值去化率”时，对已签约房间（有可能出现优惠打折），分子分母均按“签约金额”计算“货值去化率”。
,sum(case when room.SALE_STATE='签约'  then room.TRADE_TOTAL  
when room.SALE_STATE<>'签约' and build.GET_PRE_SALE_PERMIT_DATE is not null then room.BZ_TOTAL else 0 end )  as "全案已领证货值"
------全案（已去化面积）:
---------->房间“最新建筑面积”
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约'  then room.NEW_BLD_AREA else 0 end ) as "全案已去化面积"
------全案（已领证面积）:
---------->房间“最新建筑面积”
,sum(case when room.SALE_STATE='签约' or build.GET_PRE_SALE_PERMIT_DATE is not null then room.NEW_BLD_AREA  else 0 end )  as "全案已领证面积"
------全案（已去化套数):
---------->房间“汇总”
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' then 1 else 0 end ) as "全案已去化套数"
------全案（已领证套数):
---------->房间“汇总”
,sum(case when room.SALE_STATE='签约' or build.GET_PRE_SALE_PERMIT_DATE is not null then 1 else 0 end )  as "全案已领证套数"
------现房------现房------现房------现房------现房------现房------现房------现房------现房
----现房去化面积
,sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE = '签约' and build.GET_PRE_SALE_PERMIT_DATE>proj.COMPLETION_RECORD_DATE then  room.NEW_BLD_AREA else 0 end) as "现房去化面积" ,
----现房推售面积
sum(case when  proj.COMPLETION_RECORD_DATE is not null and  (room.SALE_STATE <> '签约' or (room.SALE_STATE = '签约' and build.GET_PRE_SALE_PERMIT_DATE>proj.COMPLETION_RECORD_DATE) )  then room.NEW_BLD_AREA else 0 end) as 现房推售面积,
----现房去化金额
sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE = '签约' and build.GET_PRE_SALE_PERMIT_DATE>proj.COMPLETION_RECORD_DATE then  room.TRADE_TOTAL else 0 end) as  现房去化金额,
--推售金额需要根据房间是否已经签约来判断取签约金额还是标准金额
----现房推售金额
sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE <> '签约'   then room.BZ_TOTAL  when room.SALE_STATE = '签约' and proj.COMPLETION_RECORD_DATE is not null and  build.GET_PRE_SALE_PERMIT_DATE>proj.COMPLETION_RECORD_DATE then room.TRADE_TOTAL else 0 end) as 现房推售金额,
----现房去化套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE = '签约' and build.GET_PRE_SALE_PERMIT_DATE>proj.COMPLETION_RECORD_DATE then  1 else 0 end) as  现房去化套数,
----现房推售套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null and  (room.SALE_STATE <> '签约' or  (room.SALE_STATE = '签约' and build.GET_PRE_SALE_PERMIT_DATE>proj.COMPLETION_RECORD_DATE) )  then 1 else 0 end) as 现房推售套数
------顽固性库存------顽固性库存------顽固性库存------顽固性库存------顽固性库存------顽固性库存------顽固性库存
----顽固推售面积
,sum(case when  proj.COMPLETION_RECORD_DATE is not null  and room.SALE_STATE = '签约' and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and build.GET_PRE_SALE_PERMIT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  build.GET_PRE_SALE_PERMIT_DATE<sysdate then  room.NEW_BLD_AREA else 0 end) as 顽固去化面积,
----顽固去化面积
sum(case when  proj.COMPLETION_RECORD_DATE is not null  and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and ((TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  build.GET_PRE_SALE_PERMIT_DATE<sysdate  and room.SALE_STATE = '签约') or  room.SALE_STATE <> '签约') then room.NEW_BLD_AREA else 0 end) as 顽固推售面积,
----顽固去化金额
sum(case when  proj.COMPLETION_RECORD_DATE is not null  and room.SALE_STATE = '签约' and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and build.GET_PRE_SALE_PERMIT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  build.GET_PRE_SALE_PERMIT_DATE<sysdate  then  room.TRADE_TOTAL else 0 end) as  顽固去化金额,
--推售金额需要根据房间是否已经签约来判断取签约金额还是标准金额
----顽固推售金额
sum(case  when  proj.COMPLETION_RECORD_DATE is not null  and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and (TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  build.GET_PRE_SALE_PERMIT_DATE<sysdate  and room.SALE_STATE = '签约') then room.TRADE_TOTAL  --已经在今年签约的算签约金额
 when  proj.COMPLETION_RECORD_DATE is not null  and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  room.SALE_STATE <> '签约' then room.BZ_TOTAL  else 0 end) as 顽固推售金额,  --未签约的算校准总价
----顽固去化套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null  and room.SALE_STATE = '签约' and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and build.GET_PRE_SALE_PERMIT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  build.GET_PRE_SALE_PERMIT_DATE<sysdate then  1 else 0 end) as  顽固去化套数,
----顽固推售套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null  and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and ((TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  build.GET_PRE_SALE_PERMIT_DATE<sysdate  and room.SALE_STATE = '签约') or  room.SALE_STATE <> '签约') then 1 else 0 end) as 顽固推售套数
,proj.project_id,
proj.project_name,
proj.org_id,
proj.org_name,
proj.first_open_date,
proj.obtain_date,
proj.COMPLETION_RECORD_DATE,
proj.take_land_date,
proj.plan_first_open_date,
proj.first_open_duration_by_tl,
proj.first_open_duration_by_plan,
proj.new_plan_first_open_date,
proj.exhibition_area_open_date,
proj.plan_approval_date,
proj.is_operate,
proj.is_construction_began
,t_room.AREA_LEVEL
,t_room.PRODUCT_NAME 
from tmp_proj_base proj
left join MDM_ROOM room  on proj.project_id=room.project_id  and  proj.id = PROJ_BASE_SPID
left join TMP_ROOM t_room on  room.id=t_room.room_id
left join  mdm_build build on room.BUILDING_ID=build.id 
group by proj.project_id
-------------------- 业态面积段特有 start
    ,t_room.AREA_LEVEL
    ,t_room.PRODUCT_NAME
----------------------业态面积段特有 end
    ,proj.project_name,
    proj.org_id,
    proj.org_name,
    proj.first_open_date,
    proj.obtain_date,
    proj.COMPLETION_RECORD_DATE,
    proj.take_land_date,
    proj.plan_first_open_date,
    proj.first_open_duration_by_tl,
    proj.first_open_duration_by_plan,
    proj.new_plan_first_open_date,
    proj.exhibition_area_open_date,
    proj.plan_approval_date,
    proj.is_operate,
    proj.is_construction_began
    ) result 
-------------------- 业态面积段特有 start
   where  PRODUCT_NAME  is not null
----------------------业态面积段特有 end
;

OPEN spid_info FOR select * from TMP_SALE_RATE_BY_GRANULARITY where id=spid;  
------------------------------------------------------数据移入历史表;
OPEN info FOR
   select  tree.GRANULARITY_ID--颗粒度id---【1】主键
   ,tree.sort
,tree.PROJECT_ID,---【2】项目ID
nvl(apdata.fo_sale_out_count,0),
nvl(apdata.fo_sale_count,0),
nvl(apdata.fo_sale_rate_by_count,0),
nvl(apdata.fo_sale_out_area,0),
nvl(apdata.fo_sale_area,0),
nvl(apdata.fo_sale_rate_by_area,0),
nvl(apdata.fo_sale_out_money,0),
nvl(apdata.fo_sale_money,0),
nvl(apdata.fo_sale_rate_by_money,0),
nvl(apdata.fo_surplus_sale_money,0),
nvl(apdata.fo_sale_average_money,0),
nvl(apdata.fo_sale_out_average_money,0),
nvl(apdata.po_sale_out_count,0),
nvl(apdata.po_sale_count,0),
nvl(apdata.po_sale_rate_by_count,0),
nvl(apdata.po_sale_out_area,0),
nvl(apdata.po_sale_area,0),
nvl(apdata.po_sale_rate_by_area,0),
nvl(apdata.po_sale_out_money,0),
nvl(apdata.po_sale_money,0),
nvl(apdata.po_sale_rate_by_money,0),
nvl(apdata.po_surplus_sale_money,0),
nvl(apdata.po_sale_average_money,0),
nvl(apdata.po_sale_out_average_money,0),
nvl(apdata.eh_sale_out_count,0),
nvl(apdata.eh_sale_count,0),
nvl(apdata.eh_sale_rate_by_count,0),
nvl(apdata.eh_sale_out_area,0),
nvl(apdata.eh_sale_area,0),
nvl(apdata.eh_sale_rate_by_area,0),
nvl(apdata.eh_sale_out_money,0),
nvl(apdata.eh_sale_money,0),
nvl(apdata.eh_sale_rate_by_money,0),
nvl(apdata.eh_surplus_sale_money,0),
nvl(apdata.eh_sale_average_money,0),
nvl(apdata.eh_sale_out_average_money,0),
nvl(apdata.si_sale_out_count,0),
nvl(apdata.si_sale_count,0),
nvl(apdata.si_sale_rate_by_count,0),
nvl(apdata.si_sale_out_area,0),
nvl(apdata.si_sale_area,0),
nvl(apdata.si_sale_rate_by_area,0),
nvl(apdata.si_sale_out_money,0),
nvl(apdata.si_sale_money,0),
nvl(apdata.si_sale_rate_by_money,0),
nvl(apdata.si_surplus_sale_money,0),
nvl(apdata.si_sale_average_money,0),
nvl(apdata.si_sale_out_average_money,0)
,tree.PARENT_ID---父级id
,tree.DATA_GRANULARITY--颗粒度名称
,sys_created
,dwm_REMARK
from 
( select * from TMP_SALE_RATE_BY_GRANULARITY where id=spid_tree) tree
left join 
( 
    select  parent_id||data_granularity as id,
    project_id,
    fo_sale_out_count,
    fo_sale_count,
    fo_sale_rate_by_count,
    fo_sale_out_area,
    fo_sale_area,
    fo_sale_rate_by_area,
    fo_sale_out_money,
    fo_sale_money,
    fo_sale_rate_by_money,
    fo_surplus_sale_money,
    fo_sale_average_money,
    fo_sale_out_average_money,
    po_sale_out_count,
    po_sale_count,
    po_sale_rate_by_count,
    po_sale_out_area,
    po_sale_area,
    po_sale_rate_by_area,
    po_sale_out_money,
    po_sale_money,
    po_sale_rate_by_money,
    po_surplus_sale_money,
    po_sale_average_money,
    po_sale_out_average_money,
    eh_sale_out_count,
    eh_sale_count,
    eh_sale_rate_by_count,
    eh_sale_out_area,
    eh_sale_area,
    eh_sale_rate_by_area,
    eh_sale_out_money,
    eh_sale_money,
    eh_sale_rate_by_money,
    eh_surplus_sale_money,
    eh_sale_average_money,
    eh_sale_out_average_money,
    si_sale_out_count,
    si_sale_count,
    si_sale_rate_by_count,
    si_sale_out_area,
    si_sale_area,
    si_sale_rate_by_area,
    si_sale_out_money,
    si_sale_money,
    si_sale_rate_by_money,
    si_surplus_sale_money,
    si_sale_average_money,
    si_sale_out_average_money
 from  TMP_SALE_RATE_BY_GRANULARITY where id=spid
union all 
select  project_id||PRODUCT_NAME
,project_id,
sum(FO_SALE_OUT_COUNT),--【3】首开去化套数
sum(FO_SALE_COUNT),--【4】首开推售套数 
case when sum(FO_SALE_COUNT)=0 then 0 else  round(sum(FO_SALE_OUT_COUNT)/sum(FO_SALE_COUNT),4) end,--【5】首开去化率(按套数)（3/4）
sum(FO_SALE_OUT_AREA),--【6】首开去化面积
sum(FO_SALE_AREA),--【7】首开推售面积
case when sum(FO_SALE_AREA)=0 then 0 else  round(sum(FO_SALE_OUT_AREA)/sum(FO_SALE_AREA),4) end,--【8】首开去化率(按面积)（6/7）
sum(FO_SALE_OUT_MONEY),--【9】首开去化货值
sum(FO_SALE_MONEY),--【10】首开推售货值
case when sum(FO_SALE_MONEY)=0 then 0 else  round(sum(FO_SALE_OUT_MONEY)/sum(FO_SALE_MONEY),4) end,--【11】首开去化率(按货值)（9/10）
sum(FO_SURPLUS_SALE_MONEY),--【12】首开剩余货值(10-9)
case when sum(FO_SALE_AREA)=0 then 0 else  round(sum(FO_SALE_MONEY)/sum(FO_SALE_AREA),4) end,--【13】首开标准均价(10/7)
case when sum(FO_SALE_OUT_AREA)=0 then 0 else  round(sum(FO_SALE_OUT_MONEY)/sum(FO_SALE_OUT_AREA),4) end,--【14】首开签约均价(9/6)
sum(PO_SALE_OUT_COUNT),--【15】全案去化套数
sum(PO_SALE_COUNT),--【16】全案推售套数
case when sum(PO_SALE_COUNT)=0 then 0 else  round(sum(PO_SALE_OUT_COUNT)/sum(PO_SALE_COUNT),4) end,--【17】全案去化率(按套数)(15/16)
sum(PO_SALE_OUT_AREA),--【18】全案去化面积
sum(PO_SALE_AREA),--【19】全案推售面积
case when sum(PO_SALE_AREA)=0 then 0 else  round(sum(PO_SALE_OUT_AREA)/sum(PO_SALE_AREA),4) end,--【20】全案去化率(按面积)(18/19)
sum(PO_SALE_OUT_MONEY),--【21】全案去化货值
sum(PO_SALE_MONEY),--【22】全案推售货值
case when sum(PO_SALE_MONEY)=0 then 0 else  round(sum(PO_SALE_OUT_MONEY)/sum(PO_SALE_MONEY),4) end,--【23】全案去化率(按货值)(21/22)
sum(PO_SURPLUS_SALE_MONEY),--【24】全案剩余货值(22-21)
case when sum(PO_SALE_AREA)=0 then 0 else  round(sum(PO_SALE_MONEY)/sum(PO_SALE_AREA),4) end,--【25】全案标准均价(22/19)
case when sum(PO_SALE_OUT_AREA)=0 then 0 else  round(sum(PO_SALE_OUT_MONEY)/sum(PO_SALE_OUT_AREA),4) end,--【26】全案签约均价(21/18)
sum(EH_SALE_OUT_COUNT),--【27】现房去化套数
sum(EH_SALE_COUNT),--【28】现房推售套数
case when sum(EH_SALE_COUNT)=0 then 0 else  round(sum(EH_SALE_OUT_COUNT)/sum(EH_SALE_COUNT),4) end,--【29】现房去化率(按套数)(27/28)
sum(EH_SALE_OUT_AREA),--【30】现房去化面积
sum(EH_SALE_AREA),--【31】现房推售面积
case when sum(EH_SALE_AREA)=0 then 0 else  round(sum(EH_SALE_OUT_AREA)/sum(EH_SALE_AREA),4) end,--【32】现房去化率(按面积)(30/31)
sum(EH_SALE_OUT_MONEY),--【33】现房去化货值
sum(EH_SALE_MONEY),--【34】现房推售货值
case when sum(EH_SALE_MONEY)=0 then 0 else  round(sum(EH_SALE_OUT_MONEY)/sum(EH_SALE_MONEY),4) end,--【35】现房去化率(按货值)(33/34)
sum(EH_SURPLUS_SALE_MONEY),--【36】现房剩余货值(34-33)
case when sum(EH_SALE_AREA)=0 then 0 else  round(sum(EH_SALE_MONEY)/sum(EH_SALE_AREA),4) end,--【37】现房标准均价(34/31)
case when sum(EH_SALE_OUT_AREA)=0 then 0 else  round(sum(EH_SALE_OUT_MONEY)/sum(EH_SALE_OUT_AREA),4) end,--【38】现房签约均价(33/30)
sum(SI_SALE_OUT_COUNT),--【39】顽固性库存去化套数
sum(SI_SALE_COUNT),--【40】顽固性库存推售套数
case when sum(SI_SALE_COUNT)=0 then 0 else  round(sum(SI_SALE_OUT_COUNT)/sum(SI_SALE_COUNT),4) end,--【41】顽固性库存去化率(按套数)(39/40)
sum(SI_SALE_OUT_AREA),--【42】顽固性库存去化面积
sum(SI_SALE_AREA),--【43】顽固性库存推售面积
case when sum(SI_SALE_AREA)=0 then 0 else  round(sum(SI_SALE_OUT_AREA)/sum(SI_SALE_AREA),4) end,--【44】顽固性库存去化率(按面积)(42/43)
sum(SI_SALE_OUT_MONEY),--【45】顽固性库存去化货值
sum(SI_SALE_MONEY),--【46】顽固性库存推售货值
case when sum(SI_SALE_MONEY)=0 then 0 else  round(sum(SI_SALE_OUT_MONEY)/sum(SI_SALE_MONEY),4) end,--【47】顽固性库存去化率(按货值)(45/46)
sum(SI_SURPLUS_SALE_MONEY),--【48】顽固性库存剩余货值(46-45)
case when sum(SI_SALE_AREA)=0 then 0 else  round(sum(SI_SALE_MONEY)/sum(SI_SALE_AREA),4) end,--【49】顽固性库存标准均价(46/43)
case when sum(SI_SALE_OUT_AREA)=0 then 0 else  round(sum(SI_SALE_OUT_MONEY)/sum(SI_SALE_OUT_AREA),4) end--【50】顽固性库存签约均价(45/42)
 from  TMP_SALE_RATE_BY_GRANULARITY where id=spid group by project_id,
 parent_id,PRODUCT_NAME) apdata  
on tree.GRANULARITY_ID=apdata.id order by apdata.project_id;


END CL_P_DWM_SALE_RATE_BY_GRA;

/
--------------------------------------------------------
--  DDL for Procedure COMPILE_INVALID_PROCEDURES
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "COMPILE_INVALID_PROCEDURES" (
    p_owner varchar2 -- 所有者名称，即 SCHEMA
) as

--编译某个用户下的无效存储过程

    str_sql varchar2(200);

begin
    for invalid_procedures in (select object_name from all_objects
       where status = 'INVALID' and object_type = 'PROCEDURE' and owner=upper(p_owner))
    loop
        str_sql := 'alter procedure '||p_owner||'.'||invalid_procedures.object_name || ' compile';
        begin
            execute immediate str_sql;
        exception
          --When Others Then Null;
            when OTHERS Then
                dbms_output.put_line(sqlerrm);
        end;
    end loop;
end;

/
--------------------------------------------------------
--  DDL for Procedure INI_SWM_SUPPLY_MONITOR_LIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "INI_SWM_SUPPLY_MONITOR_LIST" 
AS 

BEGIN 
DELETE  SWM_SUPPLY_MONITOR_LIST ;
INSERT INTO  SWM_SUPPLY_MONITOR_LIST
WITH  LIST_SWM_SUPPLY_MONITOR 
(

"PROJ_ID"
,"OBJ_TYPE"
,"OBJ_ID"
,"OBJ_NAME"
,"PD_NAME"
,"OBJ_PARENT_ID"
,"LEVEL"
,"LEVEL_ORDER"
,"ORDER_CODE"
,"COMPANY_NAME"
,"COMPANY_ID"
,"COMPANY_ORDER_HIERARCHY_CODE"
,"id"
,"projConstitute"
,"parentId"
,"ORDER_HIERARCHY_CODE"
,"objId"
,"objType"
,"buildProductTypeName"
,"ownBuildProductTypeId"
,"buildProductTypeId"
,"thisYearSupplyAmount"
,"thisYearSupplyNumber"
,"thisYearSupplyArea"
,"firstSeasonSupplyAmount"
,"firstSeasonSupplyNumber"
,"firstSeasonSupplyArea"
,"januarySupplyAmount"
,"januarySupplyNumberx"
,"januarySupplyNumber"
,"februarySupplyAmount"
,"februarySupplyNumber"
,"februarySupplyArea"
,"marchSupplyAmount"
,"marchSupplyNumber"
,"marchSupplyArea"
,"secondSeasonSupplyAmount"
,"secondSeasonSupplyNumber"
,"secondSeasonSupplyArea"
,"aprilSupplyAmount"
,"aprilSupplyNumber"
,"aprilSupplyArea"
,"maySupplyAmount"
,"maySupplyNumber"
,"maySupplyArea"
,"juneSupplyAmount"
,"juneSupplyNumber"
,"juneSupplyArea"
,"thirdSeasonSupplyAmount"
,"thirdSeasonSupplyNumber"
,"thirdSeasonSupplyArea"
,"julySupplyAmount"
,"julySupplyNumber"
,"julySupplyArea"
,"augustSupplyAmount"
,"augustSupplyNumber"
,"augustSupplyArea"
,"septemberSupplyAmount"
,"septemberSupplyNumber"
,"septemberSupplyArea"
,"fourthSeasonSupplyAmount"
,"fourthSeasonSupplyNumber"
,"fourthSeasonSupplyArea"
,"octoberSupplyAmount"
,"octoberSupplyNumber"
,"octoberSupplyArea"
,"novemberSupplyAmount"
,"novemberSupplyNumber"
,"novemberSupplyArea"
,"decemberSupplyAmount"
,"decemberSupplyNumber"
,"decemberSupplyArea"
------计划销售

,"thisYearSellPlannedAmount"--金额（年计划销售）
,"thisYearSellPlannedNumber"--套数（年计划销售）
,"thisYearSellPlannedArea"--面积（年计划销售）
,"firstSeonSellPlannedAmount"--金额（1季度计划销售）
,"firstSeonSellPlannedNumber"--套数（1季度计划销售）
,"firstSeonSellPlannedArea"--面积（1季度计划销售）
,"secondSeonSellPlannedAmount"--金额（2季度计划销售）
,"secondSeonSellPlannedNumber"--套数（2季度计划销售）
,"secondSeonSellPlannedArea"--面积（2季度计划销售）
,"thirdSeonSellPlannedAmount"--金额（3季度计划销售）
,"thirdSeonSellPlannedNumber"--套数（3季度计划销售）
,"thirdSeonSellPlannedArea"--面积（3季度计划销售）
,"fourthSeonSellPlannedAmount"--金额（4季度计划销售）
,"fourthSeonSellPlannedNumber"--套数（4季度计划销售）
,"fourthSeonSellPlannedArea"--面积（4季度计划销售）
,"januarySellPlannedAmount"--金额（1月计划销售）
,"januarySellPlannedNumber"--套数（1月计划销售）
,"januarySellPlannedArea"--面积（1月计划销售）
,"februarySellPlannedAmount"--金额（2月计划销售）
,"februarySellPlannedNumber"--套数（2月计划销售）
,"februarySellPlannedArea"--面积（2月计划销售）
,"marchSellPlannedAmount"--金额（3月计划销售）
,"marchSellPlannedNumber"--套数（3月计划销售）
,"marchSellPlannedArea"--面积（3月计划销售）
,"aprilSellPlannedAmount"--金额（4月计划销售）
,"aprilSellPlannedNumber"--套数（4月计划销售）
,"aprilSellPlannedArea"--面积（4月计划销售）
,"maySellPlannedAmount"--金额（5月计划销售）
,"maySellPlannedNumber"--套数（5月计划销售）
,"maySellPlannedArea"--面积（5月计划销售）
,"juneSellPlannedAmount"--金额（6月计划销售）
,"juneSellPlannedNumber"--套数（6月计划销售）
,"juneSellPlannedArea"--面积（6月计划销售）
,"julySellPlannedAmount"--金额（7月计划销售）
,"julySellPlannedNumber"--套数（7月计划销售）
,"julySellPlannedArea"--面积（7月计划销售）
,"augustSellPlannedAmount"--金额（8月计划销售）
,"augustSellPlannedNumber"--套数（8月计划销售）
,"augustSellPlannedArea"--面积（8月计划销售）
,"septemberSellPlannedAmount"--金额（10月计划销售）
,"septemberSellPlannedNumber"--套数（10月计划销售）
,"septemberSellPlannedArea"--面积（10月计划销售）
,"octoberSellPlannedAmount"--金额（10月计划销售）
,"octoberSellPlannedNumber"--套数（10月计划销售）
,"octoberSellPlannedArea"--面积（10月计划销售）
,"novemberSellPlannedAmount"--金额（11月计划销售）
,"novemberSellPlannedNumber"--套数（11月计划销售）
,"novemberSellPlannedArea"--面积（11月计划销售）
,"decemberSellPlannedAmount"--金额（12月计划销售）
,"decemberSellPlannedNumber"--套数（12月计划销售）
,"decemberSellPlannedArea"--面积（12月计划销售）


------------实际
,"LEVEL(1)"
,"poTotalSaleCount"
,"poTotalSaleArea"
,"poTotalSaleAmount"
,"rpTotalArea"
,"rpTotalAmount"
,"rpTotalCount"
,"poSaleArea"
,"poSaleAmount"
,"poSaleCount"
,"rpSurplusArea"
,"rpSurplusAmount"
,"rpSurplusCount"
,"poSurplusSaleAmount"
,"poSurplusSaleArea"
,"poSurplusSaleCount"
,"thisYearActualSupplyArea"
,"thisYearActualSupplyNumber"
,"thisYearActualSupplyAmount"
,"firstSeasonActualSupplyArea"
,"firstSeasonActualSupplyNumber"
,"firstSeasonActualSupplyAmount"
,"secondSeasonActualSupplyArea"
,"secondSeasonActualSupplyNumber"
,"secondSeasonActualSupplyAmount"
,"thirdSeasonActualSupplyArea"
,"thirdSeasonActualSupplyNumber"
,"thirdSeasonActualSupplyAmount"
,"fourthSeasonActualSupplyArea"
,"fourthSeasonActualSupplyNumber"
,"fourthSeasonActualSupplyAmount"
,"januaryActualSupplyArea"
,"januaryActualSupplyNumber"
,"januaryActualSupplyAmount"
,"februaryActualSupplyArea"
,"februaryActualSupplyNumber"
,"februaryActualSupplyAmount"
,"marchActualSupplyArea"
,"marchActualSupplyNumber"
,"marchActualSupplyAmount"
,"aprilActualSupplyArea"
,"aprilActualSupplyNumber"
,"aprilActualSupplyAmount"
,"mayActualSupplyArea"
,"mayActualSupplyNumber"
,"mayActualSupplyAmount"
,"juneActualSupplyArea"
,"juneActualSupplyNumber"
,"juneActualSupplyAmount"
,"julyActualSupplyArea"
,"julyActualSupplyNumber"
,"julyActualSupplyAmount"
,"augustActualSupplyArea"
,"augustActualSupplyNumber"
,"augustActualSupplyAmount"
,"septemberActualSupplyArea"
,"septemberActualSupplyNumber"
,"septemberActualSupplyAmount"
,"octoberActualSupplyArea"
,"octoberActualSupplyNumber"
,"octoberActualSupplyAmount"
,"novemberActualSupplyArea"
,"novemberActualSupplyNumber"
,"novemberActualSupplyAmount"
,"decemberActualSupplyArea"
,"decemberActualSupplyNumber"
,"decemberActualSupplyAmount"
,"thisYearSellArea"
,"thisYearSellNumber"
,"thisYearSellAmount"
,"firstSellArea"
,"firstSellNumber"
,"firstSellAmount"
,"secondSeasonSellArea"
,"secondSeasonSellNumber"
,"secondSeasonSellAmount"
,"thirdSeasonSellArea"
,"thirdSeasonSellNumber"
,"thirdSeasonSellAmount"
,"fourthSeasonSellArea"
,"fourthSeasonSellNumber"
,"fourthSeasonSellAmount"
,"januarySellArea"
,"januarySellNumber"
,"januarySellAmount"
,"februarySellArea"
,"februarySellNumber"
,"februarySellAmount"
,"marchSellArea"
,"marchSellNumber"
,"marchSellAmount"
,"aprilSellArea"
,"aprilSellNumber"
,"aprilSellAmount"
,"maySellArea"
,"maySellNumber"
,"maySellAmount"
,"juneSellArea"
,"juneSellNumber"
,"juneSellAmount"
,"julySellArea"
,"julySellNumber"
,"julySellAmount"
,"augustSellArea"
,"augustSellNumber"
,"augustSellAmount"
,"septemberSellArea"
,"septemberSellNumber"
,"septemberSellAmount"
,"octoberSellArea"
,"octoberSellNumber"
,"octoberSellAmount"
,"novemberSellArea"
,"novemberSellNumber"
,"novemberSellAmount"
,"decemberSellArea"
,"decemberSellNumber"
,"decemberSellAmount"
)
AS (

SELECT 	
A1.*
,A1.OBJ_ID	      as "id"
, A1.OBJ_NAME AS "projConstitute"--项目构成 objName 项目构成
,A1.OBJ_PARENT_ID AS "parentId"--父级id（生成树父级id）业务父ID bizPrentId
,A1.ORDER_CODE AS ORDER_HIERARCHY_CODE
,A1.OBJ_ID	    AS "objId"--项目ID
,A1.OBJ_TYPE    AS "objType"--对象类型
,A1.PD_NAME    AS "buildProductTypeName"--业态名称
,A1.OBJ_ID      AS "ownBuildProductTypeId"--所属的一级业态id
,A1.OBJ_ID      AS "buildProductTypeId"--业态Id
, "本年计划供货金额" AS "thisYearSupplyAmount"--金额（年计划供货）,
, "本年计划供货套数" AS "thisYearSupplyNumber"--套数（年计划供货）
, "本年计划供货面积" AS "thisYearSupplyArea"--面积（年计划供货）
, "一季度供货金额" AS "firstSeasonSupplyAmount"--金额（1季度计划供货）
, "一季度供货套数" AS "firstSeasonSupplyNumber"--套数（1季度计划供货）
, "一季度供货面积" AS "firstSeasonSupplyArea"--面积（1季度计划供货）
, "一月供货金额" AS "januarySupplyAmount"--金额（一月计划供货）
, "一月供货套数" AS "januarySupplyNumberx"--套数（一月计划供货）
, "一月供货面积" AS "januarySupplyNumber"--面积（一月计划供货）
, "二月供货金额" AS "februarySupplyAmount"--金额（二月计划供货）
, "二月供货套数" AS "februarySupplyNumber"--套数（二月计划供货）
, "二月供货面积" AS "februarySupplyArea"--面积（二月计划供货）
, "三月供货金额" AS "marchSupplyAmount"--金额（三月计划供货）
, "三月供货套数" AS "marchSupplyNumber"--套数（三月计划供货）
, "三月供货面积" AS "marchSupplyArea"--面积（三月计划供货）
, "二季度供货金额" AS "secondSeasonSupplyAmount"--金额（2季度计划供货）
, "二季度供货套数" AS "secondSeasonSupplyNumber"--套数（2季度计划供货）
, "二季度供货面积" AS "secondSeasonSupplyArea"--面积（2季度计划供货）
, "四月供货金额" AS "aprilSupplyAmount"--金额（四月计划供货）
, "四月供货套数" AS "aprilSupplyNumber"--套数（四月计划供货）
, "四月供货面积" AS "aprilSupplyArea"--面积（四月计划供货）
, "五月供货金额" AS "maySupplyAmount"--金额（五月计划供货）
, "五月供货套数" AS "maySupplyNumber"--套数（五月计划供货）
, "五月供货面积" AS "maySupplyArea"--面积（五月计划供货）
, "六月供货金额" AS "juneSupplyAmount"--金额（六月计划供货）
, "六月供货套数" AS "juneSupplyNumber"--套数（六月计划供货）
, "六月供货面积" AS "juneSupplyArea"--面积（六月计划供货）
, "三季度供货金额" AS "thirdSeasonSupplyAmount"--金额（3季度计划供货）
, "三季度供货套数" AS "thirdSeasonSupplyNumber"--套数（3季度计划供货）
, "三季度供货面积" AS "thirdSeasonSupplyArea"--面积（3季度计划供货）
, "七月供货金额" AS "julySupplyAmount"--金额（七月计划供货）
, "七月供货套数" AS "julySupplyNumber"--套数（七月计划供货）
, "七月供货面积" AS "julySupplyArea"--面积（七月计划供货）
, "八月供货金额" AS "augustSupplyAmount"--金额（八月计划供货）
, "八月供货套数" AS "augustSupplyNumber"--套数（八月计划供货）
, "八月供货面积" AS "augustSupplyArea"--面积（八月计划供货）
, "九月供货金额" AS "septemberSupplyAmount"--金额（九月计划供货）
, "九月供货套数" AS "septemberSupplyNumber"--套数（九月计划供货）
, "九月供货面积" AS "septemberSupplyArea"--面积（九月计划供货）
, "四季度供货金额" AS "fourthSeasonSupplyAmount"--金额（4季度计划供货）
, "四季度供货套数" AS "fourthSeasonSupplyNumber"--套数（4季度计划供货）
, "四季度供货面积" AS "fourthSeasonSupplyArea"--面积（4季度计划供货）
, "十月供货金额" AS "octoberSupplyAmount"--金额（十月计划供货）
, "十月供货套数" AS "octoberSupplyNumber"--套数（十月计划供货）
, "十月供货面积" AS "octoberSupplyArea"--面积（十月计划供货）
, "十一月供货金额" AS "novemberSupplyAmount"--金额（十一月计划供货）
, "十一月供货套数" AS "novemberSupplyNumber"--套数（十一月计划供货）
, "十一月供货面积" AS "novemberSupplyArea"--面积（十一月计划供货）
, "十二月供货金额" AS "decemberSupplyAmount"--金额（十二月计划供货）
, "十二月供货套数" AS "decemberSupplyNumber"--套数（十二月计划供货）
, "十二月供货面积" AS "decemberSupplyArea"--面积（十二月计划供货）
--,本年计划销售金额  AS  "thisYearSellPlannedArea"
----计划销售
,"本年计划销售金额" AS "thisYearSellPlannedAmount"--金额（年计划销售）
,"本年计划销售套数" AS "thisYearSellPlannedNumber"--套数（年计划销售）
,"本年计划销售面积" AS "thisYearSellPlannedArea"--面积（年计划销售）
,"一季度销售金额" AS "firstSeonSellPlannedAmount"--金额（1季度计划销售）
,"一季度销售套数" AS "firstSeonSellPlannedNumber"--套数（1季度计划销售）
,"一季度销售面积" AS "firstSeonSellPlannedArea"--面积（1季度计划销售）
,"二季度销售金额" AS "secondSeonSellPlannedAmount"--金额（2季度计划销售）
,"二季度销售套数" AS "secondSeonSellPlannedNumber"--套数（2季度计划销售）
,"二季度销售面积" AS "secondSeonSellPlannedArea"--面积（2季度计划销售）
,"三季度销售金额" AS "thirdSeonSellPlannedAmount"--金额（3季度计划销售）
,"三季度销售套数" AS "thirdSeonSellPlannedNumber"--套数（3季度计划销售）
,"三季度销售面积" AS "thirdSeonSellPlannedArea"--面积（3季度计划销售）
,"四季度销售金额" AS "fourthSeonSellPlannedAmount"--金额（4季度计划销售）
,"四季度销售套数" AS "fourthSeonSellPlannedNumber"--套数（4季度计划销售）
,"四季度销售面积" AS "fourthSeonSellPlannedArea"--面积（4季度计划销售）
,"一月签约金额" AS "januarySellPlannedAmount"--金额（1月计划销售）
,"一月签约套数" AS "januarySellPlannedNumber"--套数（1月计划销售）
,"一月签约面积" AS "januarySellPlannedArea"--面积（1月计划销售）
,"二月签约金额" AS "februarySellPlannedAmount"--金额（2月计划销售）
,"二月签约套数" AS "februarySellPlannedNumber"--套数（2月计划销售）
,"二月签约面积" AS "februarySellPlannedArea"--面积（2月计划销售）
,"三月签约金额" AS "marchSellPlannedAmount"--金额（3月计划销售）
,"三月签约套数" AS "marchSellPlannedNumber"--套数（3月计划销售）
,"三月签约面积" AS "marchSellPlannedArea"--面积（3月计划销售）
,"四月签约金额" AS "aprilSellPlannedAmount"--金额（4月计划销售）
,"四月签约套数" AS "aprilSellPlannedNumber"--套数（4月计划销售）
,"四月签约面积" AS "aprilSellPlannedArea"--面积（4月计划销售）
,"五月签约金额" AS "maySellPlannedAmount"--金额（5月计划销售）
,"五月签约套数" AS "maySellPlannedNumber"--套数（5月计划销售）
,"五月签约面积" AS "maySellPlannedArea"--面积（5月计划销售）
,"六月签约金额" AS "juneSellPlannedAmount"--金额（6月计划销售）
,"六月签约套数" AS "juneSellPlannedNumber"--套数（6月计划销售）
,"六月签约面积" AS "juneSellPlannedArea"--面积（6月计划销售）
,"七月签约金额" AS "julySellPlannedAmount"--金额（7月计划销售）
,"七月签约套数" AS "julySellPlannedNumber"--套数（7月计划销售）
,"七月签约面积" AS "julySellPlannedArea"--面积（7月计划销售）
,"八月签约金额" AS "augustSellPlannedAmount"--金额（8月计划销售）
,"八月签约套数" AS "augustSellPlannedNumber"--套数（8月计划销售）
,"八月签约面积" AS "augustSellPlannedArea"--面积（8月计划销售）
,"九月签约金额" AS "septemberSellPlannedAmount"--金额（10月计划销售）
,"九月签约套数" AS "septemberSellPlannedNumber"--套数（10月计划销售）
,"九月签约面积" AS "septemberSellPlannedArea"--面积（10月计划销售）
,"十月签约金额" AS "octoberSellPlannedAmount"--金额（10月计划销售）
,"十月签约套数" AS "octoberSellPlannedNumber"--套数（10月计划销售）
,"十月签约面积" AS "octoberSellPlannedArea"--面积（10月计划销售）
,"十一月签约金额" AS "novemberSellPlannedAmount"--金额（11月计划销售）
,"十一月签约套数" AS "novemberSellPlannedNumber"--套数（11月计划销售）
,"十一月签约面积" AS "novemberSellPlannedArea"--面积（11月计划销售）
,"十二月签约金额" AS "decemberSellPlannedAmount"--金额（12月计划销售）
,"十二月签约套数" AS "decemberSellPlannedNumber"--套数（12月计划销售）
,"十二月签约面积" AS "decemberSellPlannedArea"--面积（12月计划销售）



------实际
,P2."LEVEL"					
,P2."poTotalSaleCount"
,P2."poTotalSaleArea"
,P2."poTotalSaleAmount"
,P2."rpTotalArea"
,P2."rpTotalAmount"
,P2."rpTotalCount"
,P2."poSaleArea"
,P2."poSaleAmount"
,P2."poSaleCount"
,P2."rpSurplusArea"
,P2."rpSurplusAmount"
,P2."rpSurplusCount"
,P2."poSurplusSaleAmount"
,P2."poSurplusSaleArea"
,P2."poSurplusSaleCount"
,P2."thisYearActualSupplyArea"
,P2."thisYearActualSupplyNumber"
,P2."thisYearActualSupplyAmount"
,P2."firstSeasonActualSupplyArea"
,P2."firstSeasonActualSupplyNumber"
,P2."firstSeasonActualSupplyAmount"
,P2."secondSeasonActualSupplyArea"
,P2."secondSeasonActualSupplyNumber"
,P2."secondSeasonActualSupplyAmount"
,P2."thirdSeasonActualSupplyArea"
,P2."thirdSeasonActualSupplyNumber"
,P2."thirdSeasonActualSupplyAmount"
,P2."fourthSeasonActualSupplyArea"
,P2."fourthSeasonActualSupplyNumber"
,P2."fourthSeasonActualSupplyAmount"
,P2."januaryActualSupplyArea"
,P2."januaryActualSupplyNumber"
,P2."januaryActualSupplyAmount"
,P2."februaryActualSupplyArea"
,P2."februaryActualSupplyNumber"
,P2."februaryActualSupplyAmount"
,P2."marchActualSupplyArea"
,P2."marchActualSupplyNumber"
,P2."marchActualSupplyAmount"
,P2."aprilActualSupplyArea"
,P2."aprilActualSupplyNumber"
,P2."aprilActualSupplyAmount"
,P2."mayActualSupplyArea"
,P2."mayActualSupplyNumber"
,P2."mayActualSupplyAmount"
,P2."juneActualSupplyArea"
,P2."juneActualSupplyNumber"
,P2."juneActualSupplyAmount"
,P2."julyActualSupplyArea"
,P2."julyActualSupplyNumber"
,P2."julyActualSupplyAmount"
,P2."augustActualSupplyArea"
,P2."augustActualSupplyNumber"
,P2."augustActualSupplyAmount"
,P2."septemberActualSupplyArea"
,P2."septemberActualSupplyNumber"
,P2."septemberActualSupplyAmount"
,P2."octoberActualSupplyArea"
,P2."octoberActualSupplyNumber"
,P2."octoberActualSupplyAmount"
,P2."novemberActualSupplyArea"
,P2."novemberActualSupplyNumber"
,P2."novemberActualSupplyAmount"
,P2."decemberActualSupplyArea"
,P2."decemberActualSupplyNumber"
,P2."decemberActualSupplyAmount"
,P2."thisYearSellArea"
,P2."thisYearSellNumber"
,P2."thisYearSellAmount"
,P2."firstSellArea"
,P2."firstSellNumber"
,P2."firstSellAmount"
,P2."secondSeasonSellArea"
,P2."secondSeasonSellNumber"
,P2."secondSeasonSellAmount"
,P2."thirdSeasonSellArea"
,P2."thirdSeasonSellNumber"
,P2."thirdSeasonSellAmount"
,P2."fourthSeasonSellArea"
,P2."fourthSeasonSellNumber"
,P2."fourthSeasonSellAmount"
,P2."januarySellArea"
,P2."januarySellNumber"
,P2."januarySellAmount"
,P2."februarySellArea"
,P2."februarySellNumber"
,P2."februarySellAmount"
,P2."marchSellArea"
,P2."marchSellNumber"
,P2."marchSellAmount"
,P2."aprilSellArea"
,P2."aprilSellNumber"
,P2."aprilSellAmount"
,P2."maySellArea"
,P2."maySellNumber"
,P2."maySellAmount"
,P2."juneSellArea"
,P2."juneSellNumber"
,P2."juneSellAmount"
,P2."julySellArea"
,P2."julySellNumber"
,P2."julySellAmount"
,P2."augustSellArea"
,P2."augustSellNumber"
,P2."augustSellAmount"
,P2."septemberSellArea"
,P2."septemberSellNumber"
,P2."septemberSellAmount"
,P2."octoberSellArea"
,P2."octoberSellNumber"
,P2."octoberSellAmount"
,P2."novemberSellArea"
,P2."novemberSellNumber"
,P2."novemberSellAmount"
,P2."decemberSellArea"
,P2."decemberSellNumber"
,P2."decemberSellAmount"

FROM 
--项目树
 (
--项目
SELECT PR.ID AS PROJ_ID,'项目' OBJ_TYPE,PR.ID AS OBJ_ID
,PROJECT_NAME AS OBJ_NAME
,NULL AS PD_NAME
,COMPANY_ID AS OBJ_PARENT_ID  --项目所属公司为父级
--,(SELECT O.ID FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID)  AS OBJ_PARENT_ID  --项目所属区域公司为父级
,'1' AS "LEVEL"
,'1' AS "LEVEL_ORDER" 
--,COMPANY_ORDER_HIERARCHY_CODE||'_'||PROJECT_CODE||'_0' AS ORDER_CODE --奥霖排序
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) ||'_'||PROJECT_CODE AS ORDER_CODE --lixc排序
,(SELECT O.ORG_NAME FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_NAME
,(SELECT O.ID FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ID
,(SELECT O.ORDER_HIERARCHY_CODE  FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ORDER_HIERARCHY_CODE 
 FROM SYS_PROJECT PR 
--存在供货计划才查询
	WHERE    EXISTS ( SELECT 1 FROM SWM_SUPPLY_SELL_PLAN SP WHERE  SP.PROJECT_ID=PR.ID AND IS_DELETED=0 AND APPROVAL_STATUS='已审核' )
 UNION ALL 
--按业态汇总-
SELECT PR.ID AS PROJ_ID,'按业态汇总' OBJ_TYPE,PR.ID||'_firstLevelProductTypeStatistics' AS OBJ_ID
,'按业态汇总' AS OBJ_NAME
, NULL AS PD_NAME
,PR.ID AS OBJ_PARENT_ID ,'2' AS "LEVEL",'2' AS "LEVEL_ORDER" 
--,'99_'||LPAD (PR.SN , 6 , '0')||'_00' AS ORDER_CODE  
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) ||'_'||PROJECT_CODE||'_0' ----lixc排序
,(SELECT O.ORG_NAME FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_NAME
,(SELECT O.ID FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ID 
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ORDER_HIERARCHY_CODE 
FROM SYS_PROJECT PR 
UNION ALL 
--按业态汇总一级业态

SELECT PR.ID AS PROJ_ID,'一级业态' OBJ_TYPE,PR.ID||'_'||PD.ID AS OBJ_ID
,PRODUCT_TYPE_NAME AS OBJ_NAME
,PRODUCT_TYPE_NAME AS PD_NAME
,PR.ID||'_firstLevelProductTypeStatistics' AS OBJ_PARENT_ID  
,'3' AS "LEVEL",'4' AS "LEVEL_ORDER" 
--,'99_'||LPAD (PR.SN , 6 , '0')||'_00_'||PRODUCT_TYPE_SHORT_CODE   AS ORDER_CODE
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) ||'_'||PROJECT_CODE||'_0'||CASE WHEN  PRODUCT_TYPE_NAME='住宅' THEN '1'  WHEN  PRODUCT_TYPE_NAME='商办产业' THEN '2'  WHEN  PRODUCT_TYPE_NAME='车位仓储' THEN '3'  WHEN  PRODUCT_TYPE_NAME='配套设施' THEN '4'  END AS  ORDER_CODE----lixc排序
,(SELECT O.ORG_NAME FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_NAME
,(SELECT O.ID FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ID
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ORDER_HIERARCHY_CODE 
	FROM SYS_PROJECT PR 
	INNER JOIN MDM_BUILD_PRODUCT_TYPE PD ON 1=1 AND PRODUCT_TYPE_LEVEL=1 --and  PROJECT_NAME='北京西派国际'
	
--分期
UNION ALL 
SELECT PS.ID AS STAGE_ID,'分期' OBJ_TYPE,PR.ID||'_'||PS.ID AS OBJ_ID
,STAGE_NAME AS OBJ_NAME
,NULL PD_NAME
,PR.ID AS OBJ_PARENT_ID 
,'2' AS "LEVEL",'3' AS "LEVEL_ORDER"
--,'99_'||LPAD (PR.SN , 6 , '0')||'_10_'||PS.ORDER_CODE  AS ORDER_CODE  
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) ||'_'||PROJECT_CODE||'_'||PS.ORDER_CODE AS  ORDER_CODE
,(SELECT O.ORG_NAME FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_NAME
,(SELECT O.ID FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ID
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ORDER_HIERARCHY_CODE 
FROM SYS_PROJECT PR  INNER JOIN SYS_PROJECT_STAGE PS ON PR.ID=PROJECT_ID

--分期业态
UNION ALL 
SELECT PS.ID AS STAGE_ID,'分期业态' OBJ_TYPE
,PR.ID||'_'||PS.ID||'_'||Pd.ID AS OBJ_ID
,PRODUCT_TYPE_NAME AS OBJ_NAME
,PRODUCT_TYPE_NAME AS PD_NAME
,PR.ID||'_'||PS.ID AS OBJ_PARENT_ID 
,'3' AS "LEVEL",'4' AS "LEVEL_ORDER"
--, '99_'||LPAD (PR.SN , 6 , '0')||'_10_'||PS.ORDER_CODE||'_'||PRODUCT_TYPE_SHORT_CODE   AS ORDER_CODE  
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) ||'_'||PROJECT_CODE||'_'||PS.ORDER_CODE||CASE WHEN  PRODUCT_TYPE_NAME='住宅' THEN '1'  WHEN  PRODUCT_TYPE_NAME='商办产业' THEN '2'  WHEN  PRODUCT_TYPE_NAME='车位仓储' THEN '3'  WHEN  PRODUCT_TYPE_NAME='配套设施' THEN '4'  END  AS  ORDER_CODE
,(SELECT O.ORG_NAME FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_NAME
,(SELECT O.ID FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ID
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ORDER_HIERARCHY_CODE 
FROM SYS_PROJECT PR  INNER JOIN SYS_PROJECT_STAGE PS ON PR.ID=PROJECT_ID
	

INNER JOIN MDM_BUILD_PRODUCT_TYPE PD ON 1=1 AND PRODUCT_TYPE_LEVEL=1 ) A1
LEFT JOIN    
(

	SELECT  
	PROJECT_ID
	,PROJECT_NAME
	,B.OBJ_TYPE
	,CASE WHEN  B.OBJ_TYPE='楼栋' THEN B.BIZ_PARENT_ID||'_'||B.BUILD_PRODUCT_TYPE_ID ELSE  B.BIZ_ID  END  AS OBJ_ID
	,B.BIZ_PARENT_ID AS obj_PARENT_ID
	,CASE WHEN  B.OBJ_TYPE='楼栋' THEN B.BUILD_PRODUCT_TYPE_NAME ELSE  B.OBJ_NAME  END  AS OBJ_NAME
	,C.OBJ_NAME  AS OBJ_PARENT_NAME
	,SUM(NVL(B.JANUARY_SUPPLY_AMOUNT,0))+SUM(NVL(B.FEBRUARY_SUPPLY_AMOUNT,0))+SUM(NVL(B.MARCH_SUPPLY_AMOUNT,0)) +SUM(NVL(B.APRIL_SUPPLY_AMOUNT,0))+SUM(NVL(B.MAY_SUPPLY_AMOUNT,0)) +SUM(NVL(B.JUNE_SUPPLY_AMOUNT,0))+SUM(NVL(B.JULY_SUPPLY_AMOUNT,0))+SUM(NVL(B.AUGUST_SUPPLY_AMOUNT,0))+SUM(NVL(B.SEPTEMBER_SUPPLY_AMOUNT,0))+SUM(NVL(B.OCTOBER_SUPPLY_AMOUNT,0)) +SUM(NVL(B.NOVEMBER_SUPPLY_AMOUNT,0)) +SUM(NVL(B.DECEMBER_SUPPLY_AMOUNT,0))  AS 本年计划供货金额
	,SUM(NVL(B.JANUARY_SUPPLY_Area,0))+SUM(NVL(B.FEBRUARY_SUPPLY_Area,0))+SUM(NVL(B.MARCH_SUPPLY_Area,0)) +SUM(NVL(B.APRIL_SUPPLY_Area,0))+SUM(NVL(B.MAY_SUPPLY_Area,0)) +SUM(NVL(B.JUNE_SUPPLY_Area,0))+SUM(NVL(B.JULY_SUPPLY_Area,0))+SUM(NVL(B.AUGUST_SUPPLY_Area,0))+SUM(NVL(B.SEPTEMBER_SUPPLY_Area,0))+SUM(NVL(B.OCTOBER_SUPPLY_Area,0)) +SUM(NVL(B.NOVEMBER_SUPPLY_Area,0)) +SUM(NVL(B.DECEMBER_SUPPLY_Area,0))  AS 本年计划供货面积
	,SUM(NVL(B.JANUARY_SUPPLY_Number,0))+SUM(NVL(B.FEBRUARY_SUPPLY_Number,0))+SUM(NVL(B.MARCH_SUPPLY_Number,0)) +SUM(NVL(B.APRIL_SUPPLY_Number,0))+SUM(NVL(B.MAY_SUPPLY_Number,0)) +SUM(NVL(B.JUNE_SUPPLY_Number,0))+SUM(NVL(B.JULY_SUPPLY_Number,0))+SUM(NVL(B.AUGUST_SUPPLY_Number,0))+SUM(NVL(B.SEPTEMBER_SUPPLY_Number,0))+SUM(NVL(B.OCTOBER_SUPPLY_Number,0)) +SUM(NVL(B.NOVEMBER_SUPPLY_Number,0)) +SUM(NVL(B.DECEMBER_SUPPLY_Number,0))  AS 本年计划供货套数
	,SUM(NVL(B.JANUARY_SUPPLY_AMOUNT,0))+SUM(NVL(B.FEBRUARY_SUPPLY_AMOUNT,0))+SUM(NVL(B.MARCH_SUPPLY_AMOUNT,0))  AS 一季度供货金额
	,SUM(NVL(B.JANUARY_SUPPLY_AREA,0))+SUM(NVL(B.FEBRUARY_SUPPLY_AREA,0))+SUM(NVL(B.MARCH_SUPPLY_AREA,0))  AS 一季度供货面积
	,SUM(NVL(B.JANUARY_SUPPLY_NUMBER,0))+SUM(NVL(B.FEBRUARY_SUPPLY_NUMBER,0))+SUM(NVL(B.MARCH_SUPPLY_NUMBER,0))  AS 一季度供货套数
	,SUM(NVL(B.APRIL_SUPPLY_AMOUNT,0))+SUM(NVL(B.MAY_SUPPLY_AMOUNT,0)) +SUM(NVL(B.JUNE_SUPPLY_AMOUNT,0))  AS 二季度供货金额
	,SUM(NVL(B.APRIL_SUPPLY_AREA,0))+SUM(NVL(B.MAY_SUPPLY_AREA,0)) +SUM(NVL(B.JUNE_SUPPLY_AREA,0))  AS 二季度供货面积
	,SUM(NVL(B.APRIL_SUPPLY_NUMBER,0))+SUM(NVL(B.MAY_SUPPLY_NUMBER,0)) +SUM(NVL(B.JUNE_SUPPLY_NUMBER,0))  AS 二季度供货套数
	,SUM(NVL(B.JULY_SUPPLY_AMOUNT,0))+SUM(NVL(B.AUGUST_SUPPLY_AMOUNT,0))+SUM(NVL(B.SEPTEMBER_SUPPLY_AMOUNT,0))  AS 三季度供货金额 
	,SUM(NVL(B.JULY_SUPPLY_AREA,0))+SUM(NVL(B.AUGUST_SUPPLY_AREA,0))+SUM(NVL(B.SEPTEMBER_SUPPLY_AREA,0))  AS 三季度供货面积
	,SUM(NVL(B.JULY_SUPPLY_NUMBER,0))+SUM(NVL(B.AUGUST_SUPPLY_NUMBER,0))+SUM(NVL(B.SEPTEMBER_SUPPLY_NUMBER,0))  AS 三季度供货套数
	,SUM(NVL(B.OCTOBER_SUPPLY_AMOUNT,0)) +SUM(NVL(B.NOVEMBER_SUPPLY_AMOUNT,0)) +SUM(NVL(B.DECEMBER_SUPPLY_AMOUNT,0)) AS 四季度供货金额
	,SUM(NVL(B.OCTOBER_SUPPLY_AREA,0)) +SUM(NVL(B.NOVEMBER_SUPPLY_AREA,0)) +SUM(NVL(B.DECEMBER_SUPPLY_AREA,0)) AS 四季度供货面积
	,SUM(NVL(B.OCTOBER_SUPPLY_NUMBER,0)) +SUM(NVL(B.NOVEMBER_SUPPLY_NUMBER,0)) +SUM(NVL(B.DECEMBER_SUPPLY_NUMBER,0)) AS 四季度供货套数

	,SUM(NVL(B.JANUARY_SELL_AMOUNT,0))+SUM(NVL(B.FEBRUARY_SELL_AMOUNT,0))+SUM(NVL(B.MARCH_SELL_AMOUNT,0)) +SUM(NVL(B.APRIL_SELL_AMOUNT,0))+SUM(NVL(B.MAY_SELL_AMOUNT,0)) +SUM(NVL(B.JUNE_SELL_AMOUNT,0))+SUM(NVL(B.JULY_SELL_AMOUNT,0))+SUM(NVL(B.AUGUST_SELL_AMOUNT,0))+SUM(NVL(B.SEPTEMBER_SELL_AMOUNT,0))+SUM(NVL(B.OCTOBER_SELL_AMOUNT,0)) +SUM(NVL(B.NOVEMBER_SELL_AMOUNT,0)) +SUM(NVL(B.DECEMBER_SELL_AMOUNT,0))  AS 本年计划销售金额
	,SUM(NVL(B.JANUARY_SELL_Area,0))+SUM(NVL(B.FEBRUARY_SELL_Area,0))+SUM(NVL(B.MARCH_SELL_Area,0)) +SUM(NVL(B.APRIL_SELL_Area,0))+SUM(NVL(B.MAY_SELL_Area,0)) +SUM(NVL(B.JUNE_SELL_Area,0))+SUM(NVL(B.JULY_SELL_Area,0))+SUM(NVL(B.AUGUST_SELL_Area,0))+SUM(NVL(B.SEPTEMBER_SELL_Area,0))+SUM(NVL(B.OCTOBER_SELL_Area,0)) +SUM(NVL(B.NOVEMBER_SELL_Area,0)) +SUM(NVL(B.DECEMBER_SELL_Area,0))  AS 本年计划销售面积
	,SUM(NVL(B.JANUARY_SELL_Number,0))+SUM(NVL(B.FEBRUARY_SELL_Number,0))+SUM(NVL(B.MARCH_SELL_Number,0)) +SUM(NVL(B.APRIL_SELL_Number,0))+SUM(NVL(B.MAY_SELL_Number,0)) +SUM(NVL(B.JUNE_SELL_Number,0))+SUM(NVL(B.JULY_SELL_Number,0))+SUM(NVL(B.AUGUST_SELL_Number,0))+SUM(NVL(B.SEPTEMBER_SELL_Number,0))+SUM(NVL(B.OCTOBER_SELL_Number,0)) +SUM(NVL(B.NOVEMBER_SELL_Number,0)) +SUM(NVL(B.DECEMBER_SELL_Number,0))  AS 本年计划销售套数
	,SUM(NVL(B.JANUARY_SELL_AMOUNT,0))+SUM(NVL(B.FEBRUARY_SELL_AMOUNT,0))+SUM(NVL(B.MARCH_SELL_AMOUNT,0))  AS 一季度销售金额
	,SUM(NVL(B.JANUARY_SELL_AREA,0))+SUM(NVL(B.FEBRUARY_SELL_AREA,0))+SUM(NVL(B.MARCH_SELL_AREA,0))  AS 一季度销售面积
	,SUM(NVL(B.JANUARY_SELL_NUMBER,0))+SUM(NVL(B.FEBRUARY_SELL_NUMBER,0))+SUM(NVL(B.MARCH_SELL_NUMBER,0))  AS 一季度销售套数
	,SUM(NVL(B.APRIL_SELL_AMOUNT,0))+SUM(NVL(B.MAY_SELL_AMOUNT,0)) +SUM(NVL(B.JUNE_SELL_AMOUNT,0))  AS 二季度销售金额
	,SUM(NVL(B.APRIL_SELL_AREA,0))+SUM(NVL(B.MAY_SELL_AREA,0)) +SUM(NVL(B.JUNE_SELL_AREA,0))  AS 二季度销售面积
	,SUM(NVL(B.APRIL_SELL_NUMBER,0))+SUM(NVL(B.MAY_SELL_NUMBER,0)) +SUM(NVL(B.JUNE_SELL_NUMBER,0))  AS 二季度销售套数
	,SUM(NVL(B.JULY_SELL_AMOUNT,0))+SUM(NVL(B.AUGUST_SELL_AMOUNT,0))+SUM(NVL(B.SEPTEMBER_SELL_AMOUNT,0))  AS 三季度销售金额 
	,SUM(NVL(B.JULY_SELL_AREA,0))+SUM(NVL(B.AUGUST_SELL_AREA,0))+SUM(NVL(B.SEPTEMBER_SELL_AREA,0))  AS 三季度销售面积
	,SUM(NVL(B.JULY_SELL_NUMBER,0))+SUM(NVL(B.AUGUST_SELL_NUMBER,0))+SUM(NVL(B.SEPTEMBER_SELL_NUMBER,0))  AS 三季度销售套数
	,SUM(NVL(B.OCTOBER_SELL_AMOUNT,0)) +SUM(NVL(B.NOVEMBER_SELL_AMOUNT,0)) +SUM(NVL(B.DECEMBER_SELL_AMOUNT,0)) AS 四季度销售金额
	,SUM(NVL(B.OCTOBER_SELL_AREA,0)) +SUM(NVL(B.NOVEMBER_SELL_AREA,0)) +SUM(NVL(B.DECEMBER_SELL_AREA,0)) AS 四季度销售面积
	,SUM(NVL(B.OCTOBER_SELL_NUMBER,0)) +SUM(NVL(B.NOVEMBER_SELL_NUMBER,0)) +SUM(NVL(B.DECEMBER_SELL_NUMBER,0)) AS 四季度销售套数

	,SUM(NVL(B.JANUARY_SUPPLY_AMOUNT,0)) AS 一月供货金额
	,SUM(NVL(B.JANUARY_SUPPLY_AREA,0)) AS 一月供货面积
	,SUM(NVL(B.JANUARY_SUPPLY_NUMBER,0)) AS 一月供货套数
	,SUM(NVL(B.JANUARY_SELL_AMOUNT,0)) AS 一月签约金额
	,SUM(NVL(B.JANUARY_SELL_AREA,0)) AS 一月签约面积
	,SUM(NVL(B.JANUARY_SELL_NUMBER,0)) AS 一月签约套数
	,SUM(NVL(B.FEBRUARY_SUPPLY_AMOUNT,0)) AS 二月供货金额
	,SUM(NVL(B.FEBRUARY_SUPPLY_AREA,0)) AS 二月供货面积
	,SUM(NVL(B.FEBRUARY_SUPPLY_NUMBER,0)) AS 二月供货套数
	,SUM(NVL(B.FEBRUARY_SELL_AMOUNT,0)) AS 二月签约金额
	,SUM(NVL(B.FEBRUARY_SELL_AREA,0)) AS 二月签约面积
	,SUM(NVL(B.FEBRUARY_SELL_NUMBER,0)) AS 二月签约套数
	,SUM(NVL(B.MARCH_SUPPLY_AMOUNT,0)) AS 三月供货金额
	,SUM(NVL(B.MARCH_SUPPLY_AREA,0)) AS 三月供货面积
	,SUM(NVL(B.MARCH_SUPPLY_NUMBER,0)) AS 三月供货套数
	,SUM(NVL(B.MARCH_SELL_AMOUNT,0)) AS 三月签约金额
	,SUM(NVL(B.MARCH_SELL_AREA,0)) AS 三月签约面积
	,SUM(NVL(B.MARCH_SELL_NUMBER,0)) AS 三月签约套数
	,SUM(NVL(B.APRIL_SUPPLY_AMOUNT,0)) AS 四月供货金额
	,SUM(NVL(B.APRIL_SUPPLY_AREA,0)) AS 四月供货面积
	,SUM(NVL(B.APRIL_SUPPLY_NUMBER,0)) AS 四月供货套数
	,SUM(NVL(B.APRIL_SELL_AMOUNT,0)) AS 四月签约金额
	,SUM(NVL(B.APRIL_SELL_AREA,0)) AS 四月签约面积
	,SUM(NVL(B.APRIL_SELL_NUMBER,0)) AS 四月签约套数
	,SUM(NVL(B.MAY_SUPPLY_AMOUNT,0)) AS 五月供货金额
	,SUM(NVL(B.MAY_SUPPLY_AREA,0)) AS 五月供货面积
	,SUM(NVL(B.MAY_SUPPLY_NUMBER,0)) AS 五月供货套数
	,SUM(NVL(B.MAY_SELL_AMOUNT,0)) AS 五月签约金额
	,SUM(NVL(B.MAY_SELL_AREA,0)) AS 五月签约面积
	,SUM(NVL(B.MAY_SELL_NUMBER,0)) AS 五月签约套数
	,SUM(NVL(B.JUNE_SUPPLY_AMOUNT,0)) AS 六月供货金额
	,SUM(NVL(B.JUNE_SUPPLY_AREA,0)) AS 六月供货面积
	,SUM(NVL(B.JUNE_SUPPLY_NUMBER,0)) AS 六月供货套数
	,SUM(NVL(B.JUNE_SELL_AMOUNT,0)) AS 六月签约金额
	,SUM(NVL(B.JUNE_SELL_AREA,0)) AS 六月签约面积
	,SUM(NVL(B.JUNE_SELL_NUMBER,0)) AS 六月签约套数
	,SUM(NVL(B.JULY_SUPPLY_AMOUNT,0)) AS 七月供货金额
	,SUM(NVL(B.JULY_SUPPLY_AREA,0)) AS 七月供货面积
	,SUM(NVL(B.JULY_SUPPLY_NUMBER,0)) AS 七月供货套数
	,SUM(NVL(B.JULY_SELL_AMOUNT,0)) AS 七月签约金额
	,SUM(NVL(B.JULY_SELL_AREA,0)) AS 七月签约面积
	,SUM(NVL(B.JULY_SELL_NUMBER,0)) AS 七月签约套数
	,SUM(NVL(B.AUGUST_SUPPLY_AMOUNT,0)) AS 八月供货金额
	,SUM(NVL(B.AUGUST_SUPPLY_AREA,0)) AS 八月供货面积
	,SUM(NVL(B.AUGUST_SUPPLY_NUMBER,0)) AS 八月供货套数
	,SUM(NVL(B.AUGUST_SELL_AMOUNT,0)) AS 八月签约金额
	,SUM(NVL(B.AUGUST_SELL_AREA,0)) AS 八月签约面积
	,SUM(NVL(B.AUGUST_SELL_NUMBER,0)) AS 八月签约套数
	,SUM(NVL(B.SEPTEMBER_SUPPLY_AMOUNT,0)) AS 九月供货金额
	,SUM(NVL(B.SEPTEMBER_SUPPLY_AREA,0)) AS 九月供货面积
	,SUM(NVL(B.SEPTEMBER_SUPPLY_NUMBER,0)) AS 九月供货套数
	,SUM(NVL(B.SEPTEMBER_SELL_AMOUNT,0)) AS 九月签约金额
	,SUM(NVL(B.SEPTEMBER_SELL_AREA,0)) AS 九月签约面积
	,SUM(NVL(B.SEPTEMBER_SELL_NUMBER,0)) AS 九月签约套数
	,SUM(NVL(B.OCTOBER_SUPPLY_AMOUNT,0)) AS 十月供货金额
	,SUM(NVL(B.OCTOBER_SUPPLY_AREA,0)) AS 十月供货面积
	,SUM(NVL(B.OCTOBER_SUPPLY_NUMBER,0)) AS 十月供货套数
	,SUM(NVL(B.OCTOBER_SELL_AMOUNT,0)) AS 十月签约金额
	,SUM(NVL(B.OCTOBER_SELL_AREA,0)) AS 十月签约面积
	,SUM(NVL(B.OCTOBER_SELL_NUMBER,0)) AS 十月签约套数
	,SUM(NVL(B.NOVEMBER_SUPPLY_AMOUNT,0)) AS 十一月供货金额
	,SUM(NVL(B.NOVEMBER_SUPPLY_AREA,0)) AS 十一月供货面积
	,SUM(NVL(B.NOVEMBER_SUPPLY_NUMBER,0)) AS 十一月供货套数
	,SUM(NVL(B.NOVEMBER_SELL_AMOUNT,0)) AS 十一月签约金额
	,SUM(NVL(B.NOVEMBER_SELL_AREA,0)) AS 十一月签约面积
	,SUM(NVL(B.NOVEMBER_SELL_NUMBER,0)) AS 十一月签约套数
	,SUM(NVL(B.DECEMBER_SUPPLY_AMOUNT,0)) AS 十二月供货金额
	,SUM(NVL(B.DECEMBER_SUPPLY_AREA,0)) AS 十二月供货面积
	,SUM(NVL(B.DECEMBER_SUPPLY_NUMBER,0)) AS 十二月供货套数
	,SUM(NVL(B.DECEMBER_SELL_AMOUNT,0)) AS 十二月签约金额
	,SUM(NVL(B.DECEMBER_SELL_AREA,0)) AS 十二月签约面积
	,SUM(NVL(B.DECEMBER_SELL_NUMBER,0)) AS 十二月签约套数


FROM
	SWM_SUPPLY_SELL_PLAN A  --ON  A.PROJ_ID=PR.PROJ_ID
    left join (select ID from ( select tmp.*, row_number() over(PARTITION BY project_id order by LPAD (PERIOD_CODE , 6 , '0') desc) as rn from  SWM_SUPPLY_SELL_PLAN  tmp where tmp.APPROVAL_STATUS='已审核' AND IS_DELETED =0 ) where rn = 1) newPlan
    on newPlan.id=A.ID
	LEFT  JOIN SWM_SUPPLY_SELL_PLAN_DTL B ON A.ID=B.SUPPLY_SELL_PLAN_ID
	LEFT JOIN SWM_SUPPLY_SELL_PLAN_DTL C ON C.BIZ_ID=B.BIZ_PARENT_ID  AND  A.ID=C.SUPPLY_SELL_PLAN_ID
	WHERE B.IS_DELETED =0 and  newPlan.id is not null --AND B.SUPPLY_SELL_PLAN_ID='97187e1c-f056-44aa-93fa-7fa9bcb0d813'
	
	AND PERIOD_CODE =(
	SELECT MAX(PERIOD_CODE) FROM SWM_SUPPLY_SELL_PLAN A1 WHERE A.PROJECT_ID=A1.PROJECT_ID AND IS_DELETED=0 AND APPROVAL_STATUS='已审核'
	)
	GROUP BY 
    PROJECT_ID
	,PROJECT_NAME
	,B.BIZ_PARENT_ID 
	,B.OBJ_TYPE
	-- ,B.OBJ_NAME
	-- ,BUILD_PRODUCT_TYPE_NAME
	-- ,ORDER_CODE
	,CASE WHEN  B.OBJ_TYPE='楼栋' THEN 'XXX'  ELSE  B.BIZ_ID  END 
	,CASE WHEN  B.OBJ_TYPE='楼栋' THEN B.BUILD_PRODUCT_TYPE_NAME ELSE  B.OBJ_NAME  END
	,CASE WHEN  B.OBJ_TYPE='楼栋' THEN '99'  ELSE  B.ORDER_CODE  END
	,C.OBJ_NAME,c.BIZ_ID
	,CASE WHEN  B.OBJ_TYPE='楼栋' THEN B.BIZ_PARENT_ID||'_'||B.BUILD_PRODUCT_TYPE_ID ELSE  B.BIZ_ID  END 
	 --ORDER BY  CASE WHEN  B.OBJ_TYPE='楼栋' THEN '99'  ELSE  B.ORDER_CODE END ,C.OBJ_NAME||CASE WHEN  B.OBJ_TYPE='楼栋' THEN B.BUILD_PRODUCT_TYPE_NAME ELSE  B.OBJ_NAME  END 
 ) P1 on A1.OBJ_ID=P1.OBJ_ID --AND P1.PROJECT_ID=A1.PROJ_ID AND P1.OBJ_TYPE=A1.OBJ_TYPE  AND P1.OBJ_NAME=A1.OBJ_NAME  

 
 LEFT JOIN 
 -----------------------------------------------------------------------------------------------------
SWM_SUPPLY_MONITOR_TABLE  P2 ON A1.OBJ_ID=P2.OBJID 
--order by A1.COMPANY_ORDER_HIERARCHY_CODE,A1.ORDER_CODE 


UNION ALL 

select    

a2.ID 
,'公司' "OBJ_TYPE"
,a2.ID AS "OBJ_ID"
,a2.ORG_NAME AS "OBJ_NAME"
,null
,a2.PARENT_ID AS "OBJ_PARENT_ID"
,TO_CHAR(A2.LEVEL_RANK)
,NULL
,A2.ORDER_HIERARCHY_CODE AS  "ORDER_CODE"
,a2.ORG_NAME AS  "COMPANY_NAME"
,a2.ID AS  "COMPANY_ID"
,A2.ORDER_HIERARCHY_CODE  "COMPANY_ORDER_HIERARCHY_CODE"
,a2.ID  AS "id"
, a2.ORG_NAME AS "projConstitute"
,a2.PARENT_ID  AS "parentId"
,a2.ORDER_HIERARCHY_CODE  AS "ORDER_HIERARCHY_CODE"
,a2.ID AS "objId"
,'公司'"objType"
,NULL AS "buildProductTypeName"
,NULL AS "ownBuildProductTypeId"
,NULL AS "buildProductTypeId"
,a1."thisYearSupplyAmount"
,a1."thisYearSupplyNumber"
,a1."thisYearSupplyArea"
,a1."firstSeasonSupplyAmount"
,a1."firstSeasonSupplyNumber"
,a1."firstSeasonSupplyArea"
,a1."januarySupplyAmount"
,a1."januarySupplyNumberx"
,a1."januarySupplyNumber"
,a1."februarySupplyAmount"
,a1."februarySupplyNumber"
,a1."februarySupplyArea"
,a1."marchSupplyAmount"
,a1."marchSupplyNumber"
,a1."marchSupplyArea"
,a1."secondSeasonSupplyAmount"
,a1."secondSeasonSupplyNumber"
,a1."secondSeasonSupplyArea"
,a1."aprilSupplyAmount"
,a1."aprilSupplyNumber"
,a1."aprilSupplyArea"
,a1."maySupplyAmount"
,a1."maySupplyNumber"
,a1."maySupplyArea"
,a1."juneSupplyAmount"
,a1."juneSupplyNumber"
,a1."juneSupplyArea"
,a1."thirdSeasonSupplyAmount"
,a1."thirdSeasonSupplyNumber"
,a1."thirdSeasonSupplyArea"
,a1."julySupplyAmount"
,a1."julySupplyNumber"
,a1."julySupplyArea"
,a1."augustSupplyAmount"
,a1."augustSupplyNumber"
,a1."augustSupplyArea"
,a1."septemberSupplyAmount"
,a1."septemberSupplyNumber"
,a1."septemberSupplyArea"
,a1."fourthSeasonSupplyAmount"
,a1."fourthSeasonSupplyNumber"
,a1."fourthSeasonSupplyArea"
,a1."octoberSupplyAmount"
,a1."octoberSupplyNumber"
,a1."octoberSupplyArea"
,a1."novemberSupplyAmount"
,a1."novemberSupplyNumber"
,a1."novemberSupplyArea"
,a1."decemberSupplyAmount"
,a1."decemberSupplyNumber"
,a1."decemberSupplyArea"


,"thisYearSellPlannedAmount"--金额（年计划销售）
,"thisYearSellPlannedNumber"--套数（年计划销售）
,"thisYearSellPlannedArea"--面积（年计划销售）
,"firstSeonSellPlannedAmount"--金额（1季度计划销售）
,"firstSeonSellPlannedNumber"--套数（1季度计划销售）
,"firstSeonSellPlannedArea"--面积（1季度计划销售）
,"secondSeonSellPlannedAmount"--金额（2季度计划销售）
,"secondSeonSellPlannedNumber"--套数（2季度计划销售）
,"secondSeonSellPlannedArea"--面积（2季度计划销售）
,"thirdSeonSellPlannedAmount"--金额（3季度计划销售）
,"thirdSeonSellPlannedNumber"--套数（3季度计划销售）
,"thirdSeonSellPlannedArea"--面积（3季度计划销售）
,"fourthSeonSellPlannedAmount"--金额（4季度计划销售）
,"fourthSeonSellPlannedNumber"--套数（4季度计划销售）
,"fourthSeonSellPlannedArea"--面积（4季度计划销售）
,"januarySellPlannedAmount"--金额（1月计划销售）
,"januarySellPlannedNumber"--套数（1月计划销售）
,"januarySellPlannedArea"--面积（1月计划销售）
,"februarySellPlannedAmount"--金额（2月计划销售）
,"februarySellPlannedNumber"--套数（2月计划销售）
,"februarySellPlannedArea"--面积（2月计划销售）
,"marchSellPlannedAmount"--金额（3月计划销售）
,"marchSellPlannedNumber"--套数（3月计划销售）
,"marchSellPlannedArea"--面积（3月计划销售）
,"aprilSellPlannedAmount"--金额（4月计划销售）
,"aprilSellPlannedNumber"--套数（4月计划销售）
,"aprilSellPlannedArea"--面积（4月计划销售）
,"maySellPlannedAmount"--金额（5月计划销售）
,"maySellPlannedNumber"--套数（5月计划销售）
,"maySellPlannedArea"--面积（5月计划销售）
,"juneSellPlannedAmount"--金额（6月计划销售）
,"juneSellPlannedNumber"--套数（6月计划销售）
,"juneSellPlannedArea"--面积（6月计划销售）
,"julySellPlannedAmount"--金额（7月计划销售）
,"julySellPlannedNumber"--套数（7月计划销售）
,"julySellPlannedArea"--面积（7月计划销售）
,"augustSellPlannedAmount"--金额（8月计划销售）
,"augustSellPlannedNumber"--套数（8月计划销售）
,"augustSellPlannedArea"--面积（8月计划销售）
,"septemberSellPlannedAmount"--金额（10月计划销售）
,"septemberSellPlannedNumber"--套数（10月计划销售）
,"septemberSellPlannedArea"--面积（10月计划销售）
,"octoberSellPlannedAmount"--金额（10月计划销售）
,"octoberSellPlannedNumber"--套数（10月计划销售）
,"octoberSellPlannedArea"--面积（10月计划销售）
,"novemberSellPlannedAmount"--金额（11月计划销售）
,"novemberSellPlannedNumber"--套数（11月计划销售）
,"novemberSellPlannedArea"--面积（11月计划销售）
,"decemberSellPlannedAmount"--金额（12月计划销售）
,"decemberSellPlannedNumber"--套数（12月计划销售）
,"decemberSellPlannedArea"--面积（12月计划销售）



,TO_CHAR(a2."LEVEL_RANK")
,a1."poTotalSaleCount"
,a1."poTotalSaleArea"
,a1."poTotalSaleAmount"
,a1."rpTotalArea"
,a1."rpTotalAmount"
,a1."rpTotalCount"
,a1."poSaleArea"
,a1."poSaleAmount"
,a1."poSaleCount"
,a1."rpSurplusArea"
,a1."rpSurplusAmount"
,a1."rpSurplusCount"
,a1."poSurplusSaleAmount"
,a1."poSurplusSaleArea"
,a1."poSurplusSaleCount"
,a1."thisYearActualSupplyArea"
,a1."thisYearActualSupplyNumber"
,a1."thisYearActualSupplyAmount"
,a1."firstSeasonActualSupplyArea"
,a1."firstSeasonActualSupplyNumber"
,a1."firstSeasonActualSupplyAmount"
,a1."secondSeasonActualSupplyArea"
,a1."secondSeasonActualSupplyNumber"
,a1."secondSeasonActualSupplyAmount"
,a1."thirdSeasonActualSupplyArea"
,a1."thirdSeasonActualSupplyNumber"
,a1."thirdSeasonActualSupplyAmount"
,a1."fourthSeasonActualSupplyArea"
,a1."fourthSeasonActualSupplyNumber"
,a1."fourthSeasonActualSupplyAmount"
,a1."januaryActualSupplyArea"
,a1."januaryActualSupplyNumber"
,a1."januaryActualSupplyAmount"
,a1."februaryActualSupplyArea"
,a1."februaryActualSupplyNumber"
,a1."februaryActualSupplyAmount"
,a1."marchActualSupplyArea"
,a1."marchActualSupplyNumber"
,a1."marchActualSupplyAmount"
,a1."aprilActualSupplyArea"
,a1."aprilActualSupplyNumber"
,a1."aprilActualSupplyAmount"
,a1."mayActualSupplyArea"
,a1."mayActualSupplyNumber"
,a1."mayActualSupplyAmount"
,a1."juneActualSupplyArea"
,a1."juneActualSupplyNumber"
,a1."juneActualSupplyAmount"
,a1."julyActualSupplyArea"
,a1."julyActualSupplyNumber"
,a1."julyActualSupplyAmount"
,a1."augustActualSupplyArea"
,a1."augustActualSupplyNumber"
,a1."augustActualSupplyAmount"
,a1."septemberActualSupplyArea"
,a1."septemberActualSupplyNumber"
,a1."septemberActualSupplyAmount"
,a1."octoberActualSupplyArea"
,a1."octoberActualSupplyNumber"
,a1."octoberActualSupplyAmount"
,a1."novemberActualSupplyArea"
,a1."novemberActualSupplyNumber"
,a1."novemberActualSupplyAmount"
,a1."decemberActualSupplyArea"
,a1."decemberActualSupplyNumber"
,a1."decemberActualSupplyAmount"
,a1."thisYearSellArea"
,a1."thisYearSellNumber"
,a1."thisYearSellAmount"
,a1."firstSellArea"
,a1."firstSellNumber"
,a1."firstSellAmount"
,a1."secondSeasonSellArea"
,a1."secondSeasonSellNumber"
,a1."secondSeasonSellAmount"
,a1."thirdSeasonSellArea"
,a1."thirdSeasonSellNumber"
,a1."thirdSeasonSellAmount"
,a1."fourthSeasonSellArea"
,a1."fourthSeasonSellNumber"
,a1."fourthSeasonSellAmount"
,a1."januarySellArea"
,a1."januarySellNumber"
,a1."januarySellAmount"
,a1."februarySellArea"
,a1."februarySellNumber"
,a1."februarySellAmount"
,a1."marchSellArea"
,a1."marchSellNumber"
,a1."marchSellAmount"
,a1."aprilSellArea"
,a1."aprilSellNumber"
,a1."aprilSellAmount"
,a1."maySellArea"
,a1."maySellNumber"
,a1."maySellAmount"
,a1."juneSellArea"
,a1."juneSellNumber"
,a1."juneSellAmount"
,a1."julySellArea"
,a1."julySellNumber"
,a1."julySellAmount"
,a1."augustSellArea"
,a1."augustSellNumber"
,a1."augustSellAmount"
,a1."septemberSellArea"
,a1."septemberSellNumber"
,a1."septemberSellAmount"
,a1."octoberSellArea"
,a1."octoberSellNumber"
,a1."octoberSellAmount"
,a1."novemberSellArea"
,a1."novemberSellNumber"
,a1."novemberSellAmount"
,a1."decemberSellArea"
,a1."decemberSellNumber"
,a1."decemberSellAmount"

from  LIST_SWM_SUPPLY_MONITOR 
a1 INNER JOIN　SYS_BUSINESS_UNIT a2 on a1.OBJ_PARENT_ID=a2.id 

		where is_company=1 
		--and a2.PARENT_ID=''||unitid||''


)

SELECT 




"PROJ_ID"
,"OBJ_TYPE"
,"OBJ_ID"
,"OBJ_NAME"
,"OBJ_PARENT_ID"
,"LEVEL"
,"LEVEL_ORDER"
,"ORDER_CODE"
,"COMPANY_NAME"
,"COMPANY_ID"
,"COMPANY_ORDER_HIERARCHY_CODE"
,"id"
,"projConstitute"
,"parentId"
,"ORDER_HIERARCHY_CODE"
,"objId"
,"objType"
,"buildProductTypeName"
,"ownBuildProductTypeId"
,"buildProductTypeId"
,SUM(NVL("thisYearSupplyAmount",0)) AS "thisYearSupplyAmount"
,SUM(NVL("thisYearSupplyNumber",0)) AS "thisYearSupplyNumber"
,SUM(NVL("thisYearSupplyArea",0)) AS "thisYearSupplyArea"
,SUM(NVL("firstSeasonSupplyAmount",0))/10000 AS "firstSeasonSupplyAmount"
,SUM(NVL("firstSeasonSupplyNumber",0)) AS "firstSeasonSupplyNumber"
,SUM(NVL("firstSeasonSupplyArea",0)) AS "firstSeasonSupplyArea"
,SUM(NVL("januarySupplyAmount",0))/10000 AS "januarySupplyAmount"
,SUM(NVL("januarySupplyNumberx",0)) AS "januarySupplyNumberx"
,SUM(NVL("januarySupplyNumber",0)) AS "januarySupplyNumber"
,SUM(NVL("februarySupplyAmount",0))/10000 AS "februarySupplyAmount"
,SUM(NVL("februarySupplyNumber",0)) AS "februarySupplyNumber"
,SUM(NVL("februarySupplyArea",0)) AS "februarySupplyArea"
,SUM(NVL("marchSupplyAmount",0))/10000 AS "marchSupplyAmount"
,SUM(NVL("marchSupplyNumber",0)) AS "marchSupplyNumber"
,SUM(NVL("marchSupplyArea",0)) AS "marchSupplyArea"
,SUM(NVL("secondSeasonSupplyAmount",0))/10000 AS "secondSeasonSupplyAmount"
,SUM(NVL("secondSeasonSupplyNumber",0)) AS "secondSeasonSupplyNumber"
,SUM(NVL("secondSeasonSupplyArea",0)) AS "secondSeasonSupplyArea"
,SUM(NVL("aprilSupplyAmount",0))/10000 AS "aprilSupplyAmount"
,SUM(NVL("aprilSupplyNumber",0)) AS "aprilSupplyNumber"
,SUM(NVL("aprilSupplyArea",0)) AS "aprilSupplyArea"
,SUM(NVL("maySupplyAmount",0))/10000 AS "maySupplyAmount"
,SUM(NVL("maySupplyNumber",0)) AS "maySupplyNumber"
,SUM(NVL("maySupplyArea",0)) AS "maySupplyArea"
,SUM(NVL("juneSupplyAmount",0))/10000 AS "juneSupplyAmount"
,SUM(NVL("juneSupplyNumber",0)) AS "juneSupplyNumber"
,SUM(NVL("juneSupplyArea",0)) AS "juneSupplyArea"
,SUM(NVL("thirdSeasonSupplyAmount",0))/10000 AS "thirdSeasonSupplyAmount"
,SUM(NVL("thirdSeasonSupplyNumber",0)) AS "thirdSeasonSupplyNumber"
,SUM(NVL("thirdSeasonSupplyArea",0)) AS "thirdSeasonSupplyArea"
,SUM(NVL("julySupplyAmount",0))/10000 AS "julySupplyAmount"
,SUM(NVL("julySupplyNumber",0)) AS "julySupplyNumber"
,SUM(NVL("julySupplyArea",0)) AS "julySupplyArea"
,SUM(NVL("augustSupplyAmount",0))/10000 AS "augustSupplyAmount"
,SUM(NVL("augustSupplyNumber",0)) AS "augustSupplyNumber"
,SUM(NVL("augustSupplyArea",0)) AS "augustSupplyArea"
,SUM(NVL("septemberSupplyAmount",0))/10000 AS "septemberSupplyAmount"
,SUM(NVL("septemberSupplyNumber",0)) AS "septemberSupplyNumber"
,SUM(NVL("septemberSupplyArea",0)) AS "septemberSupplyArea"
,SUM(NVL("fourthSeasonSupplyAmount",0))/10000 AS "fourthSeasonSupplyAmount"
,SUM(NVL("fourthSeasonSupplyNumber",0)) AS "fourthSeasonSupplyNumber"
,SUM(NVL("fourthSeasonSupplyArea",0)) AS "fourthSeasonSupplyArea"
,SUM(NVL("octoberSupplyAmount",0))/10000 AS "octoberSupplyAmount"
,SUM(NVL("octoberSupplyNumber",0)) AS "octoberSupplyNumber"
,SUM(NVL("octoberSupplyArea",0)) AS "octoberSupplyArea"
,SUM(NVL("novemberSupplyAmount",0))/10000 AS "novemberSupplyAmount"
,SUM(NVL("novemberSupplyNumber",0)) AS "novemberSupplyNumber"
,SUM(NVL("novemberSupplyArea",0)) AS "novemberSupplyArea"
,SUM(NVL("decemberSupplyAmount",0))/10000 AS "decemberSupplyAmount"
,SUM(NVL("decemberSupplyNumber",0)) AS "decemberSupplyNumber"
,SUM(NVL("decemberSupplyArea",0)) AS "decemberSupplyArea"
,SUM(NVL("poTotalSaleCount",0)) AS "poTotalSaleCount"
,SUM(NVL("poTotalSaleArea",0)) AS "poTotalSaleArea"
,SUM(NVL("poTotalSaleAmount",0))/10000 AS "poTotalSaleAmount"
,SUM(NVL("rpTotalArea",0)) AS "rpTotalArea"
,SUM(NVL("rpTotalAmount",0))/10000 AS "rpTotalAmount"
,SUM(NVL("rpTotalCount",0)) AS "rpTotalCount"
,SUM(NVL("poSaleArea",0)) AS "poSaleArea"
,SUM(NVL("poSaleAmount",0))/10000 AS "poSaleAmount"
,SUM(NVL("poSaleCount",0)) AS "poSaleCount"
,SUM(NVL("rpSurplusArea",0)) AS "rpSurplusArea"
,SUM(NVL("rpSurplusAmount",0))/10000 AS "rpSurplusAmount"
,SUM(NVL("rpSurplusCount",0)) AS "rpSurplusCount"
,SUM(NVL("poSurplusSaleAmount",0))/10000 AS "poSurplusSaleAmount"
,SUM(NVL("poSurplusSaleArea",0)) AS "poSurplusSaleArea"
,SUM(NVL("poSurplusSaleCount",0)) AS "poSurplusSaleCount"
,SUM(NVL("thisYearActualSupplyArea",0)) AS "thisYearActualSupplyArea"
,SUM(NVL("thisYearActualSupplyNumber",0)) AS "thisYearActualSupplyNumber"
,SUM(NVL("thisYearActualSupplyAmount",0))/10000 AS "thisYearActualSupplyAmount"
,SUM(NVL("firstSeasonActualSupplyArea",0)) AS "firstSeasonActualSupplyArea"
,SUM(NVL("firstSeasonActualSupplyNumber",0)) AS "firstSeasonActualSupplyNumber"
,SUM(NVL("firstSeasonActualSupplyAmount",0))/10000 AS "firstSeasonActualSupplyAmount"
,SUM(NVL("secondSeasonActualSupplyArea",0)) AS "secondSeasonActualSupplyArea"
,SUM(NVL("secondSeasonActualSupplyNumber",0)) AS "secondSeasonActualSupplyNumber"
,SUM(NVL("secondSeasonActualSupplyAmount",0))/10000 AS "secondSeasonActualSupplyAmount"
,SUM(NVL("thirdSeasonActualSupplyArea",0)) AS "thirdSeasonActualSupplyArea"
,SUM(NVL("thirdSeasonActualSupplyNumber",0)) AS "thirdSeasonActualSupplyNumber"
,SUM(NVL("thirdSeasonActualSupplyAmount",0))/10000 AS "thirdSeasonActualSupplyAmount"
,SUM(NVL("fourthSeasonActualSupplyArea",0)) AS "fourthSeasonActualSupplyArea"
,SUM(NVL("fourthSeasonActualSupplyNumber",0)) AS "fourthSeasonActualSupplyNumber"
,SUM(NVL("fourthSeasonActualSupplyAmount",0))/10000 AS "fourthSeasonActualSupplyAmount"
,SUM(NVL("januaryActualSupplyArea",0)) AS "januaryActualSupplyArea"
,SUM(NVL("januaryActualSupplyNumber",0)) AS "januaryActualSupplyNumber"
,SUM(NVL("januaryActualSupplyAmount",0))/10000 AS "januaryActualSupplyAmount"
,SUM(NVL("februaryActualSupplyArea",0)) AS "februaryActualSupplyArea"
,SUM(NVL("februaryActualSupplyNumber",0)) AS "februaryActualSupplyNumber"
,SUM(NVL("februaryActualSupplyAmount",0))/10000 AS "februaryActualSupplyAmount"
,SUM(NVL("marchActualSupplyArea",0)) AS "marchActualSupplyArea"
,SUM(NVL("marchActualSupplyNumber",0)) AS "marchActualSupplyNumber"
,SUM(NVL("marchActualSupplyAmount",0))/10000 AS "marchActualSupplyAmount"
,SUM(NVL("aprilActualSupplyArea",0)) AS "aprilActualSupplyArea"
,SUM(NVL("aprilActualSupplyNumber",0)) AS "aprilActualSupplyNumber"
,SUM(NVL("aprilActualSupplyAmount",0))/10000 AS "aprilActualSupplyAmount"
,SUM(NVL("mayActualSupplyArea",0)) AS "mayActualSupplyArea"
,SUM(NVL("mayActualSupplyNumber",0)) AS "mayActualSupplyNumber"
,SUM(NVL("mayActualSupplyAmount",0))/10000 AS "mayActualSupplyAmount"
,SUM(NVL("juneActualSupplyArea",0)) AS "juneActualSupplyArea"
,SUM(NVL("juneActualSupplyNumber",0)) AS "juneActualSupplyNumber"
,SUM(NVL("juneActualSupplyAmount",0))/10000 AS "juneActualSupplyAmount"
,SUM(NVL("julyActualSupplyArea",0)) AS "julyActualSupplyArea"
,SUM(NVL("julyActualSupplyNumber",0)) AS "julyActualSupplyNumber"
,SUM(NVL("julyActualSupplyAmount",0))/10000 AS "julyActualSupplyAmount"
,SUM(NVL("augustActualSupplyArea",0)) AS "augustActualSupplyArea"
,SUM(NVL("augustActualSupplyNumber",0)) AS "augustActualSupplyNumber"
,SUM(NVL("augustActualSupplyAmount",0))/10000 AS "augustActualSupplyAmount"
,SUM(NVL("septemberActualSupplyArea",0)) AS "septemberActualSupplyArea"
,SUM(NVL("septemberActualSupplyNumber",0)) AS "septemberActualSupplyNumber"
,SUM(NVL("septemberActualSupplyAmount",0))/10000 AS "septemberActualSupplyAmount"
,SUM(NVL("octoberActualSupplyArea",0)) AS "octoberActualSupplyArea"
,SUM(NVL("octoberActualSupplyNumber",0)) AS "octoberActualSupplyNumber"
,SUM(NVL("octoberActualSupplyAmount",0))/10000 AS "octoberActualSupplyAmount"
,SUM(NVL("novemberActualSupplyArea",0)) AS "novemberActualSupplyArea"
,SUM(NVL("novemberActualSupplyNumber",0)) AS "novemberActualSupplyNumber"
,SUM(NVL("novemberActualSupplyAmount",0))/10000 AS "novemberActualSupplyAmount"
,SUM(NVL("decemberActualSupplyArea",0)) AS "decemberActualSupplyArea"
,SUM(NVL("decemberActualSupplyNumber",0)) AS "decemberActualSupplyNumber"
,SUM(NVL("decemberActualSupplyAmount",0))/10000 AS "decemberActualSupplyAmount"
,SUM(NVL("thisYearSellArea",0)) AS "thisYearSellArea"
,SUM(NVL("thisYearSellNumber",0)) AS "thisYearSellNumber"
,SUM(NVL("thisYearSellAmount",0))/10000 AS "thisYearSellAmount"
,SUM(NVL("firstSellArea",0)) AS "firstSellArea"
,SUM(NVL("firstSellNumber",0)) AS "firstSellNumber"
,SUM(NVL("firstSellAmount",0))/10000 AS "firstSellAmount"
,SUM(NVL("secondSeasonSellArea",0)) AS "secondSeasonSellArea"
,SUM(NVL("secondSeasonSellNumber",0)) AS "secondSeasonSellNumber"
,SUM(NVL("secondSeasonSellAmount",0))/10000 AS "secondSeasonSellAmount"
,SUM(NVL("thirdSeasonSellArea",0)) AS "thirdSeasonSellArea"
,SUM(NVL("thirdSeasonSellNumber",0)) AS "thirdSeasonSellNumber"
,SUM(NVL("thirdSeasonSellAmount",0))/10000 AS "thirdSeasonSellAmount"
,SUM(NVL("fourthSeasonSellArea",0)) AS "fourthSeasonSellArea"
,SUM(NVL("fourthSeasonSellNumber",0)) AS "fourthSeasonSellNumber"
,SUM(NVL("fourthSeasonSellAmount",0))/10000 AS "fourthSeasonSellAmount"
,SUM(NVL("januarySellArea",0)) AS "januarySellArea"
,SUM(NVL("januarySellNumber",0)) AS "januarySellNumber"
,SUM(NVL("januarySellAmount",0))/10000 AS "januarySellAmount"
,SUM(NVL("februarySellArea",0)) AS "februarySellArea"
,SUM(NVL("februarySellNumber",0)) AS "februarySellNumber"
,SUM(NVL("februarySellAmount",0))/10000 AS "februarySellAmount"
,SUM(NVL("marchSellArea",0)) AS "marchSellArea"
,SUM(NVL("marchSellNumber",0)) AS "marchSellNumber"
,SUM(NVL("marchSellAmount",0))/10000 AS "marchSellAmount"
,SUM(NVL("aprilSellArea",0)) AS "aprilSellArea"
,SUM(NVL("aprilSellNumber",0)) AS "aprilSellNumber"
,SUM(NVL("aprilSellAmount",0))/10000 AS "aprilSellAmount"
,SUM(NVL("maySellArea",0)) AS "maySellArea"
,SUM(NVL("maySellNumber",0)) AS "maySellNumber"
,SUM(NVL("maySellAmount",0))/10000 AS "maySellAmount"
,SUM(NVL("juneSellArea",0)) AS "juneSellArea"
,SUM(NVL("juneSellNumber",0)) AS "juneSellNumber"
,SUM(NVL("juneSellAmount",0))/10000 AS "juneSellAmount"
,SUM(NVL("julySellArea",0)) AS "julySellArea"
,SUM(NVL("julySellNumber",0)) AS "julySellNumber"
,SUM(NVL("julySellAmount",0))/10000 AS "julySellAmount"
,SUM(NVL("augustSellArea",0)) AS "augustSellArea"
,SUM(NVL("augustSellNumber",0)) AS "augustSellNumber"
,SUM(NVL("augustSellAmount",0))/10000 AS "augustSellAmount"
,SUM(NVL("septemberSellArea",0)) AS "septemberSellArea"
,SUM(NVL("septemberSellNumber",0)) AS "septemberSellNumber"
,SUM(NVL("septemberSellAmount",0))/10000 AS "septemberSellAmount"
,SUM(NVL("octoberSellArea",0)) AS "octoberSellArea"
,SUM(NVL("octoberSellNumber",0)) AS "octoberSellNumber"
,SUM(NVL("octoberSellAmount",0)) AS "octoberSellAmount"
,SUM(NVL("novemberSellArea",0)) AS "novemberSellArea"
,SUM(NVL("novemberSellNumber",0)) AS "novemberSellNumber"
,SUM(NVL("novemberSellAmount",0))/10000 AS "novemberSellAmount"
,SUM(NVL("decemberSellArea",0)) AS "decemberSellArea"
,SUM(NVL("decemberSellNumber",0)) AS "decemberSellNumber"
,SUM(NVL("decemberSellAmount",0))/10000 AS "decemberSellAmount"
,SUM(NVL("thisYearSellPlannedAmount",0))  AS "thisYearSellPlannedAmount"--金额（年计划销售）
,SUM(NVL("thisYearSellPlannedNumber",0))  AS "thisYearSellPlannedNumber"--套数（年计划销售）
,SUM(NVL("thisYearSellPlannedArea",0))  AS "thisYearSellPlannedArea"--面积（年计划销售）
,SUM(NVL("firstSeonSellPlannedAmount",0))  AS "firstSeonSellPlannedAmount"--金额（1季度计划销售）
,SUM(NVL("firstSeonSellPlannedNumber",0))  AS "firstSeonSellPlannedNumber"--套数（1季度计划销售）
,SUM(NVL("firstSeonSellPlannedArea",0))  AS "firstSeonSellPlannedArea"--面积（1季度计划销售）
,SUM(NVL("secondSeonSellPlannedAmount",0))  AS "secondSeonSellPlannedAmount"--金额（2季度计划销售）
,SUM(NVL("secondSeonSellPlannedNumber",0))  AS "secondSeonSellPlannedNumber"--套数（2季度计划销售）
,SUM(NVL("secondSeonSellPlannedArea",0))  AS "secondSeonSellPlannedArea"--面积（2季度计划销售）
,SUM(NVL("thirdSeonSellPlannedAmount",0))  AS "thirdSeonSellPlannedAmount"--金额（3季度计划销售）
,SUM(NVL("thirdSeonSellPlannedNumber",0))  AS "thirdSeonSellPlannedNumber"--套数（3季度计划销售）
,SUM(NVL("thirdSeonSellPlannedArea",0))  AS "thirdSeonSellPlannedArea"--面积（3季度计划销售）
,SUM(NVL("fourthSeonSellPlannedAmount",0))  AS "fourthSeonSellPlannedAmount"--金额（4季度计划销售）
,SUM(NVL("fourthSeonSellPlannedNumber",0))  AS "fourthSeonSellPlannedNumber"--套数（4季度计划销售）
,SUM(NVL("fourthSeonSellPlannedArea",0))  AS "fourthSeonSellPlannedArea"--面积（4季度计划销售）
,SUM(NVL("januarySellPlannedAmount",0))  AS "januarySellPlannedAmount"--金额（1月计划销售）
,SUM(NVL("januarySellPlannedNumber",0))  AS "januarySellPlannedNumber"--套数（1月计划销售）
,SUM(NVL("januarySellPlannedArea",0))  AS "januarySellPlannedArea"--面积（1月计划销售）
,SUM(NVL("februarySellPlannedAmount",0))  AS "februarySellPlannedAmount"--金额（2月计划销售）
,SUM(NVL("februarySellPlannedNumber",0))  AS "februarySellPlannedNumber"--套数（2月计划销售）
,SUM(NVL("februarySellPlannedArea",0))  AS "februarySellPlannedArea"--面积（2月计划销售）
,SUM(NVL("marchSellPlannedAmount",0))  AS "marchSellPlannedAmount"--金额（3月计划销售）
,SUM(NVL("marchSellPlannedNumber",0))  AS "marchSellPlannedNumber"--套数（3月计划销售）
,SUM(NVL("marchSellPlannedArea",0))  AS "marchSellPlannedArea"--面积（3月计划销售）
,SUM(NVL("aprilSellPlannedAmount",0))  AS "aprilSellPlannedAmount"--金额（4月计划销售）
,SUM(NVL("aprilSellPlannedNumber",0))  AS "aprilSellPlannedNumber"--套数（4月计划销售）
,SUM(NVL("aprilSellPlannedArea",0))  AS "aprilSellPlannedArea"--面积（4月计划销售）
,SUM(NVL("maySellPlannedAmount",0))  AS "maySellPlannedAmount"--金额（5月计划销售）
,SUM(NVL("maySellPlannedNumber",0))  AS "maySellPlannedNumber"--套数（5月计划销售）
,SUM(NVL("maySellPlannedArea",0))  AS "maySellPlannedArea"--面积（5月计划销售）
,SUM(NVL("juneSellPlannedAmount",0))  AS "juneSellPlannedAmount"--金额（6月计划销售）
,SUM(NVL("juneSellPlannedNumber",0))  AS "juneSellPlannedNumber"--套数（6月计划销售）
,SUM(NVL("juneSellPlannedArea",0))  AS "juneSellPlannedArea"--面积（6月计划销售）
,SUM(NVL("julySellPlannedAmount",0))  AS "julySellPlannedAmount"--金额（7月计划销售）
,SUM(NVL("julySellPlannedNumber",0))  AS "julySellPlannedNumber"--套数（7月计划销售）
,SUM(NVL("julySellPlannedArea",0))  AS "julySellPlannedArea"--面积（7月计划销售）
,SUM(NVL("augustSellPlannedAmount",0))  AS "augustSellPlannedAmount"--金额（8月计划销售）
,SUM(NVL("augustSellPlannedNumber",0))  AS "augustSellPlannedNumber"--套数（8月计划销售）
,SUM(NVL("augustSellPlannedArea",0))  AS "augustSellPlannedArea"--面积（8月计划销售）
,SUM(NVL("septemberSellPlannedAmount",0))  AS "septemberSellPlannedAmount"--金额（10月计划销售）
,SUM(NVL("septemberSellPlannedNumber",0))  AS "septemberSellPlannedNumber"--套数（10月计划销售）
,SUM(NVL("septemberSellPlannedArea",0))  AS "septemberSellPlannedArea"--面积（10月计划销售）
,SUM(NVL("octoberSellPlannedAmount",0))  AS "octoberSellPlannedAmount"--金额（10月计划销售）
,SUM(NVL("octoberSellPlannedNumber",0))  AS "octoberSellPlannedNumber"--套数（10月计划销售）
,SUM(NVL("octoberSellPlannedArea",0))  AS "octoberSellPlannedArea"--面积（10月计划销售）
,SUM(NVL("novemberSellPlannedAmount",0))  AS "novemberSellPlannedAmount"--金额（11月计划销售）
,SUM(NVL("novemberSellPlannedNumber",0))  AS "novemberSellPlannedNumber"--套数（11月计划销售）
,SUM(NVL("novemberSellPlannedArea",0))  AS "novemberSellPlannedArea"--面积（11月计划销售）
,SUM(NVL("decemberSellPlannedAmount",0))  AS "decemberSellPlannedAmount"--金额（12月计划销售）
,SUM(NVL("decemberSellPlannedNumber",0))  AS "decemberSellPlannedNumber"--套数（12月计划销售）
,SUM(NVL("decemberSellPlannedArea",0))  AS "decemberSellPlannedArea"--面积（12月计划销售）


 FROM  LIST_SWM_SUPPLY_MONITOR LIST
		 --WHERE "thisYearSupplyAmount">0
		
		 


 GROUP BY "PROJ_ID"
,"OBJ_TYPE"
,"OBJ_ID"
,"OBJ_NAME"
,"OBJ_PARENT_ID"
,"LEVEL"
,"LEVEL_ORDER"
,"ORDER_CODE"
,"COMPANY_NAME"
,"COMPANY_ID"
,"COMPANY_ORDER_HIERARCHY_CODE"
,"id"
,"projConstitute"
,"parentId"
,"ORDER_HIERARCHY_CODE"
,"objId"
,"objType"
,"buildProductTypeName"
,"ownBuildProductTypeId"
,"buildProductTypeId"
 ORDER BY "COMPANY_ORDER_HIERARCHY_CODE","ORDER_CODE"
 ;
 END  INI_SWM_SUPPLY_MONITOR_LIST;

/
--------------------------------------------------------
--  DDL for Procedure P_API_ROLE_USER_RELATION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_API_ROLE_USER_RELATION" AS
BEGIN
    delete from SYS_ROLE_USER_RELATION_RESULT where ROLE_TYPE='30';
	--添加数据到目标表  
	insert into SYS_ROLE_USER_RELATION_RESULT(ID,ROLE_TYPE,ROLE_CODE,ROLE_NAME,USER_ACCOUNT,USER_NAME,PROJECT_ID,PROJECT_NAME,CREATED) 
		SELECT get_uuid(),'30',ROLECODE,ROLENAME,USERACCOUNT,USERNAME,PROJECTID,PROJECTNAME,sysdate FROM API_ROLE_USER_RELATION where USERACCOUNT is not null;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_API_TRANS_MANAGEMENT_NODE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_API_TRANS_MANAGEMENT_NODE" AS
BEGIN
    --去重，否则有可能违反主键约束。原因是发现从集团抓取的数据有重复id的情况。
    delete from API_MANAGEMENT_NODE a where (a.ID) in (
        select ID from API_MANAGEMENT_NODE group by ID having count(*) > 1) and rowid not in (
        select min(rowid) from API_MANAGEMENT_NODE group by ID having count(*)>1);

    --组织表
    delete from SYS_BUSINESS_UNIT;
    --新增公司
    insert into SYS_BUSINESS_UNIT(ID,ORG_NAME,PARENT_ID,ORG_TYPE,ORDER_CODE,IS_COMPANY)
    SELECT lower(ID),NAME,lower(PID),'0' as NODETYPE,ORDERNUM as ORDER_CODE,1 as IS_COMPANY
    FROM API_MANAGEMENT_NODE where NODETYPE = 1;
    --新增部门
    insert into SYS_BUSINESS_UNIT(ID,ORG_NAME,PARENT_ID,ORG_TYPE,ORDER_CODE,IS_COMPANY)
    SELECT lower(ID),NAME,lower(PID),'1' as NODETYPE,ORDERNUM as ORDER_CODE,0 as IS_COMPANY
    FROM  API_MANAGEMENT_NODE where NODETYPE = 2;


    --岗位表
    delete from SYS_STATION;
    insert into SYS_STATION(ID,STATION_NAME,ORG_ID, ORDER_CODE)
    SELECT lower(ID),NAME,lower(PID),ORDERNUM as ORDER_CODE
    FROM API_MANAGEMENT_NODE where NODETYPE = 3;

    --用户表
    delete from SYS_USER;
    --只有alpha测试环境才需要 PASSWORD 数据，默认为 123
    insert into SYS_USER(ID,USER_CODE,USER_NAME,EMAIL,PASSWORD)
    SELECT DISTINCT lower(USERID),USERACCOUNT,NAME,EMAIL,'1$2a$10$ogMzoaGWd4MFaPX6E/z7x.gzZ9CbbiaXWvnujsSVnVm2Okj10U5Gq'
    FROM API_MANAGEMENT_NODE where NODETYPE = 4;

    --只有alpha测试环境才需要 admin 账号
    --insert into SYS_USER(ID,USER_CODE,USER_NAME,PASSWORD) VALUES('9604c692-e3d0-6e95-e053-0100007f8f52','admin','admin','$2a$10$ogMzoaGWd4MFaPX6E/z7x.gzZ9CbbiaXWvnujsSVnVm2Okj10U5Gq');

    --用户岗位关系表
    delete from SYS_STATION_TO_USER;

    insert into SYS_STATION_TO_USER (ID,STATION_ID,USER_ID, ORDER_CODE)
    SELECT lower(get_uuid()) as STATION_TO_USER_ID,lower(PID),lower(USERID), ORDERNUM
    FROM API_MANAGEMENT_NODE where NODETYPE = 4;


    --计算组织层级：
    DECLARE
        levelcount   int;
        orgid varchar(36);
        CURSOR cursor_calc IS
            SELECT
                id
            FROM
                sys_business_unit;

    BEGIN
        --打开游标
        OPEN cursor_calc;
        loop
            fetch cursor_calc into orgid;
            exit when cursor_calc%notfound;
            begin
                select count(*) into levelcount FROM  sys_business_unit
                START WITH ID=orgid  CONNECT BY PRIOR  parent_id=ID;
            exception
                when NO_DATA_FOUND then
                    levelcount:=0;
            end;
            update sys_business_unit set level_rank=levelcount where id=orgid;
        end loop;

        close cursor_calc;

    END;


    --计算全局编码：
    DECLARE

        parentcode varchar(500);
        orgid varchar(36);
        CURSOR cursor_calc2 IS
            SELECT
                id
            FROM
                sys_business_unit;

    BEGIN
        --打开游标
        OPEN cursor_calc2;
        loop
            fetch cursor_calc2 into orgid;
            exit when cursor_calc2%notfound;


            begin
                select replace(wm_concat(order_code),',','.') into parentcode from (
                                                                                       select replace(lpad(order_code,3),' ','0') as order_code FROM      sys_business_unit
                                                                                       START WITH ID=orgid  CONNECT BY PRIOR  parent_id=ID
                                                                                       order by level_rank) ds;
            exception
                when NO_DATA_FOUND then
                    parentcode:='';
            end;

            update sys_business_unit set order_hierarchy_code=parentcode where id=orgid;


        end loop;

        close cursor_calc2;

    END;


--计算组织人数：
    DECLARE
        total int;
        orgid varchar(36);
        CURSOR cursor_calc2 IS
            SELECT
                id
            FROM
                sys_business_unit;

    BEGIN
        --打开游标
        OPEN cursor_calc2;
        loop
            fetch cursor_calc2 into orgid;
            exit when cursor_calc2%notfound;

            begin
                select count(distinct user_id) into total from (
                                                                   select id FROM  sys_business_unit
                                                                   START WITH ID=orgid  CONNECT BY PRIOR  ID=parent_id) ds inner join
                                                               (select org_id,user_id from sys_station a inner join SYS_STATION_TO_USER b on a.id=b.station_id) b
                                                               on ds.id=b.org_id;
            exception
                when NO_DATA_FOUND then
                    total:=0;
            end;

            update sys_business_unit set staff_total=total where id=orgid;

        end loop;

        close cursor_calc2;

    END;

    UPDATE SYS_BUSINESS_UNIT A
    SET    A.ORG_FULL_NAME =
               (WITH TMP(ORGID, ORGNAME, ORGFULLNAME) AS (SELECT A1.ID, A1.ORG_NAME, A1.ORG_NAME
                                                          FROM   SYS_BUSINESS_UNIT A1
                                                          WHERE  A1.ID = '003200000000000000000000000000'
                                                          UNION ALL
                                                          SELECT B2.ID, B2.ORG_NAME, A2.ORGFULLNAME || '->' || B2.ORG_NAME
                                                          FROM   TMP A2
                                                                     INNER  JOIN SYS_BUSINESS_UNIT B2
                                                                                 ON     A2.ORGID = B2.PARENT_ID)
                SELECT ORGFULLNAME FROM TMP B WHERE A.ID = B.ORGID);

--调用存储过程，写入用户与岗位的关系到SYS_ROLE_USER_RELATION_RESULT 目标表
    P_API_TRANS_STATION_USER();
    -----更新用户手机 chenl 2020-02-28 定时任务获取手机有问题暂时同步api表手机号码
    update sys_user  set mobile_phone=(select mobile from api_user  where api_user.USERACCOUNT = sys_user.USER_CODE);


    commit;

END P_API_TRANS_MANAGEMENT_NODE;

/
--------------------------------------------------------
--  DDL for Procedure P_API_TRANS_PROJECT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_API_TRANS_PROJECT" AS
BEGIN
		--描述：整理API_PROJECT表中从集团抓取过来的数据。
		--作者：雷吉
		--日期：2019/11/22

		DELETE FROM SYS_PROJECT;
		UPDATE API_PROJECT_NEW SET SN = '0' WHERE SN = 'null';
		--插入项目
		INSERT INTO SYS_PROJECT
				(ID, PROJECT_NAME, PROJECT_CODE, ADDRESS, VICE_PM_NAME, UNIT_NAME,
				 CORP_ID, UPDATE_USER_ID, CITY_CODE, COPR_ID, UPDATE_USER, CORP_NAME,
				 COPR_NAME, VICE_PM_ID, CITY_NAME, STRUCT_TYPE, UNIT_ID, SN,
				 PROJECT_STATE)
		
	/*			SELECT PP.ID, PP.PROJECT_NAME, PP.PROJECT_CODE, PP.PROJ_ADDRESS,
							 PP.VICE_PM_NAME, PP.COMPANY_NAME, PP.CORP_ID, PP.CREATOR_ID,
							 PP.CITY_CODE, PP.COPR_ID, PP.CREATOR, PP.CORP_NAME,
							 PP.COPR_NAME, PP.VICE_PM_ID, PP.PROVINCE_NAME, PP.STRUCT_TYPE,
							 PP.COMPANY_ID, PP.SN, PP.PROJECT_STATE
				FROM   (SELECT ROW_NUMBER() OVER(PARTITION BY P.PROJECT_ORIGINAL_ID ORDER BY P.PROJECT_VERSION) AS NUM,
												LOWER(P.PROJECT_ORIGINAL_ID) AS ID, P.PROJECT_NAME,
												P.PROJECT_CODE, P.PROJ_ADDRESS, NULL AS VICE_PM_NAME,
												P.COMPANY_NAME, NULL AS CORP_ID, P.CREATOR_ID,
												NULL AS CITY_CODE, NULL AS COPR_ID, P.CREATOR,
												P.LEGAL_PERSON_COMPANY AS CORP_NAME,
												P.LEGAL_PERSON_COMPANY AS COPR_NAME,
												NULL AS VICE_PM_ID, P.PROVINCE_NAME,
												NULL AS STRUCT_TYPE, P.COMPANY_ID, '0' AS SN,
												NULL AS PROJECT_STATE
								 FROM   MDM_PROJECT P
								 WHERE  P.APPROVAL_STATUS = '已审核') PP
				WHERE  PP.NUM = 1;*/
		        SELECT LOWER(ID), NAME, CODE, ADDRESS, VICEPMNAME, UNITNAME, CORPID,
           UPDATEUSERID, CITYCODE, COPRID, UPDATEUSER, CORPNAME,
           COPRNAME, VICEPMID, CITYNAME, STRUCTTYPE, LOWER(UNITID),
           TO_NUMBER(SN), STATE
    FROM   API_PROJECT_NEW;
		COMMIT;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_API_TRANS_PROJECT_STAGE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_API_TRANS_PROJECT_STAGE" AS
BEGIN
		--描述：整理API_PROJECT_STAGE表中从集团抓取过来的数据。
		--作者：雷吉
		--日期：2019/11/22

		DELETE FROM SYS_PROJECT_STAGE;
		UPDATE API_PROJECT_STAGE SET SN = '0' WHERE SN = 'null';
		--插入项目分期
		INSERT INTO SYS_PROJECT_STAGE

				(ID, STAGE, STAGE_NAME, SN, PROJECT_STATE, PROJECT_ID,IS_FIRST_OPEN_PERIOD)
/*				(SELECT DISTINCT LOWER(C.ID), NULL, C.PERIOD_NAME, '0', NULL,
								LOWER(B.PROJECT_ORIGINAL_ID)
				 FROM   MDM_PROJECT A
				 INNER  JOIN MDM_PERIOD_VERSION B
				 ON     A.PROJECT_ORIGINAL_ID = B.PROJECT_ORIGINAL_ID
				 INNER  JOIN MDM_PERIOD C
				 ON     B.ID = C.PERIOD_VERSION_ID
				 INNER  JOIN (SELECT ROW_NUMBER() OVER(PARTITION BY A.PROJECT_ORIGINAL_ID ORDER BY B.PERIOD_VERSION) AS NUM,
														B.PERIOD_VERSION, B.ID
										 FROM   MDM_PROJECT A
										 INNER  JOIN MDM_PERIOD_VERSION B
										 ON     A.PROJECT_ORIGINAL_ID = B.PROJECT_ORIGINAL_ID
										 \*INNER  JOIN MDM_PERIOD C
                     ON     B.ID = C.PERIOD_VERSION_ID*\
										 WHERE  B.APPROVAL_STATUS = '已审核') P
				 ON     P.ID = B.ID AND
								P.NUM = 1
				 WHERE  B.APPROVAL_STATUS = '已审核');*/

		SELECT DISTINCT LOWER(ID), STAGE, NAME, TO_NUMBER(SN), STATE,
                    LOWER(PROJECTID),ISFIRSTOPENPERIOD 
    FROM   API_PROJECT_STAGE;
		--更新分期表fullName
		COMMIT;
		UPDATE SYS_PROJECT_STAGE C
		SET    C.STAGE_FULL_NAME =
						(SELECT (PROJECT_NAME || STAGE_NAME) AS STAGE_FULL_NAME
						 FROM   SYS_PROJECT_STAGE A
						 LEFT   JOIN SYS_PROJECT B
						 ON     A.PROJECT_ID = B.ID
						 WHERE  C.ID = A.ID);
		COMMIT;
		-- SELECT lower(ID),STAGE,NAME,TO_NUMBER(SN),STATE,lower(PROJECTID) from API_PROJECT_STAGE;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_API_TRANS_STATION_USER
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_API_TRANS_STATION_USER" AS
BEGIN
  DELETE FROM sys_role_user_relation_result where role_type='120';
  
  insert into sys_role_user_relation_result(id,role_type,user_account,user_name, station_id, station_name)
  SELECT a.id,'120',c.user_code,c.user_name,b.id,b.station_name  from SYS_STATION_TO_USER a
  left join SYS_STATION b on a.station_id=b.id
  left join SYS_USER c on a.user_id=c.id;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_API_TRANS_VIRTUAL_ORG_USER
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_API_TRANS_VIRTUAL_ORG_USER" AS
		STATIONID    VARCHAR2(36);
		ORGID        VARCHAR2(36);
		DEPTID       VARCHAR2(36);
		DEPTNAME     VARCHAR2(200);
		BUSINESSID   VARCHAR2(36);
		BUSINESSNAME VARCHAR2(200);
		CURSOR CURSOR_STATION IS
				SELECT DISTINCT B.ORG_ID, A.PID FROM API_VIRTUAL_ORG_USER_bak A INNER JOIN SYS_STATION B ON A.PID = B.ID;
BEGIN
		OPEN CURSOR_STATION;
		LOOP
				FETCH CURSOR_STATION
						INTO ORGID, STATIONID;
				EXIT WHEN CURSOR_STATION%NOTFOUND;
		
				SELECT ID, ORG_NAME
				INTO   DEPTID, DEPTNAME
				FROM   SYS_BUSINESS_UNIT
				WHERE  ORG_TYPE = 1 AND
							 ROWNUM = 1
				START  WITH ID = ORGID
				CONNECT BY PRIOR PARENT_ID = ID;
				UPDATE API_VIRTUAL_ORG_USER_BAK SET DEPT_ID = DEPTID, DEPT_NAME = DEPTNAME WHERE PID = STATIONID;
		
		
				SELECT ID, ORG_NAME
				INTO   BUSINESSID, BUSINESSNAME
				FROM   SYS_BUSINESS_UNIT
				WHERE  ORG_TYPE = 0 AND
							 ROWNUM = 1
				START  WITH ID = ORGID
				CONNECT BY PRIOR PARENT_ID = ID;
				UPDATE API_VIRTUAL_ORG_USER_BAK SET COMPANY_ID = businessid, COMPANY_NAME = businessname WHERE PID = STATIONID;
		
		END LOOP;
		CLOSE CURSOR_STATION;

		COMMIT;



		DELETE FROM SYS_ROLE_USER_RELATION_RESULT WHERE ROLE_TYPE = '40';
		INSERT INTO SYS_ROLE_USER_RELATION_RESULT
				(ID, ROLE_TYPE, USER_ACCOUNT, USER_NAME, VIRTUAL_GROUP_ID, VIRTUAL_GROUP_NAME, CREATED, DEPT_ID, DEPT_NAME, COMPANY_ID, COMPANY_NAME)
				SELECT GET_UUID(), '40', USERACCOUNT, NAME, VGUID, VNAME, SYSDATE, DEPT_ID, DEPT_NAME, COMPANY_ID, COMPANY_NAME FROM API_VIRTUAL_ORG_USER_BAK;
		COMMIT;

END;

/
--------------------------------------------------------
--  DDL for Procedure P_AUTH_BLOCK_PROJ_COMPANY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_AUTH_BLOCK_PROJ_COMPANY" (
    USERID IN VARCHAR2,
    STATIONID IN VARCHAR2,
    DEPTID IN VARCHAR2,
    COMPANYID IN VARCHAR2,
    BIZCODE IN VARCHAR2,
    DATA_SPID_ID out VARCHAR
)
    -- 根据用户，岗位，部门，公司id获取器所拥有的项目和公司权限
-- 权限获取 select ORG_ID from TMP_AUTH_LIST where id = DATA_SPID_ID
-- @author: 韩金明
-- @date: 2020-09-04
AS
    bizAuthId varchar(36); --隔离规则权限id
begin
    DATA_SPID_ID := GET_UUID();
    -- 获取隔离规则id
    select
        decode(sdab.ISOLATION_RULE_VALUE, '全集团', '003200000000000000000000000000', '本公司', COMPANYID,
               '本部门', DEPTID, '本岗位', STATIONID, '本人', USERID, GET_UUID()) into bizAuthId
    from SYS_DATA_AUTH_BIZ sdab
    where sdab.BIZ_OBJ_CODE = BIZCODE;
    -- 将权限插入临时表
    insert into TMP_AUTH_LIST(ID, ORG_ID)
    with T_PARENT_ORG as (
        select ID
        from SYS_BUSINESS_UNIT sbu
        start with sbu.id in (STATIONID, DEPTID, COMPANYID)
        connect by prior id = PARENT_ID
        union all select USERID from dual
    ),
         T_AUTH_SCOPE as (
             select sda.AUTH_SCOPE_ID, sda.AUTH_SCOPE_NAME, sda.AUTH_TYPE
             from SYS_DATA_AUTH sda
                      inner join T_PARENT_ORG tpo on tpo.ID = sda.AUTH_OWNER_ID
             where sda.AUTH_BIZ_CODE = BIZCODE
             union select bizAuthId, '隔离规则', '' from dual
         )
    select DATA_SPID_ID ID, ID ORG_ID
    from (
             select ID, ORG_NAME NAME, PARENT_ID from SYS_BUSINESS_UNIT
             union select PROJECT_ORIGINAL_ID, PROJECT_NAME NAME, COMPANY_ID PARENT_ID from MDM_PROJECT
             union select PERIOD_ORIGINAL_ID, PERIOD_NAME, PROJECT_ORIGINAL_ID from MDM_PERIOD
         ) tac start with tac.ID in (
        select AUTH_SCOPE_ID from T_AUTH_SCOPE
    ) connect by prior ID = PARENT_ID;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_CHENL_TEST_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_CHENL_TEST_DATA" (
    USERID IN VARCHAR2,
    STATIONID IN VARCHAR2,
    DEPTID IN VARCHAR2,
    COMPANYID IN VARCHAR2,
    authcode in VARCHAR2,
    userInfo     OUT      SYS_REFCURSOR,--当前用户信息
    data_auth_info OUT SYS_REFCURSOR,--权限数据
    plan_test_info OUT SYS_REFCURSOR,--计划测试数据
    test_out out VARCHAR2
) AS

    bizcode          VARCHAR2(200);
    data_auth_spid   VARCHAR2(200);
    orgid            VARCHAR2(200);
BEGIN
    bizcode :=nvl(authcode,'POM.JHBZYTZ.03');
    p_sys_auth_data_rule_spid(userid => userid, stationid => stationid, deptid => deptid, companyid => companyid, bizcode => bizcode
    , data_auth_spid => data_auth_spid);
---测试多输出
 test_out:='authcode=>'||bizcode;
-- 当前用户数据

    OPEN userInfo FOR SELECT  USERID as "USERID",
    STATIONID as "STATIONID",
    DEPTID as "DEPTID",
    COMPANYID as "COMPANYID",
    bizcode as "bizcode"
                  FROM
                      dual;
----权限数据
open DATA_AUTH_INFO for
select ROWNUM as s,a.orgid,p.ORG_NAME,p.ORG_NAME,p.ORG_TYPE,u.org_name as  UNIT,u.ORDER_HIERARCHY_CODE  from (select distinct ORG_ID as orgId  
from TMP_AUTH_LIST  WHERE ID=DATA_AUTH_SPID ) a 
left join V_SYS_PROJECT  p on a.orgId=p.ORG_id
left join SYS_BUSINESS_UNIT u on a.orgId=u.id;
---计划测试数据
    OPEN plan_test_info FOR select '测试' as from dual;


END p_chenl_test_data;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_ALLFILTERCONDITION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_ALLFILTERCONDITION" (filter OUT sys_refcursor)
as
begin
open filter for
select * from(
select 'isStart' as id, 'isStart' as "value",'是否已开工' as "lable",null as ParentId,1 as "sort",1 as "isChecked"  from dual
UNION
select 'isStart-01' as id,'1' as "value",'已开工' as "lable",'isStart' as ParentId,1 as "sort",1 as "isChecked"  from dual
UNION
select 'isStart-00' as id,'0' as "value",'未开工' as "lable",'isStart' as ParentId,2 as "sort",1 as "isChecked"  from dual

UNION
select  'opening' as id, 'opening' as "value",'是否已开盘' as "lable",null as ParentId,2 as "sort",0 as "isChecked"  from dual
UNION
select 'opening-01' as id ,'1' as "value",'是' as "lable",'opening' as ParentId,1 as "sort",1 as "isChecked"  from dual
UNION
select  'opening-00' as id,'0' as "value",'否' as "lable",'opening' as ParentId,2 as "sort",0 as "isChecked"  from dual

UNION
select 'openingYear' as id,'openingYear' as "value",'项目首开年份' as "lable",null as ParentId,3 as "sort",0 as "isChecked"  from dual
UNION
select 'openingYear-<2017' as id,'<2017' as "value" ,'2017年之前' as "lable",'openingYear' as ParentId,0 as "sort",0 as "isChecked"   from dual
UNION
select 'openingYear-'||to_char(tab.year) as id,to_char(tab.year) as "value",
to_char(tab.year)||'年' as "lable",
'openingYear' as ParentId,
ROWNUM+1 as "sort",
0 as "isChecked"
from (SELECT to_number(to_char(sysdate,'yyyy'))-ROWNUM+1 year FROM DUAL
CONNECT BY LEVEL<=4 order by year asc) tab

union
select 'isOperate' as id,'isOperate' as "value",'是否操盘' as "lable",null as ParentId,4 as "sort",0 as "isChecked"  from dual
UNION
select 'isOperate-01' as id ,'1' as "value",'是' as "lable",'isOperate' as ParentId,1 as "sort",0 as "isChecked"  from dual
UNION
select  'isOperate-00' as id,'0' as "value",'否' as "lable",'isOperate' as ParentId,2 as "sort",0 as "isChecked"  from dual

union
select 'isHasExistingHouse' as id,'isHasExistingHouse' as "value",'是否有现房存货' as "lable",null as ParentId,5 as "sort",0 as "isChecked"  from dual
UNION
select 'isHasExistingHouse-01' as id ,'1' as "value",'是' as "lable",'isHasExistingHouse' as ParentId,1 as "sort",0 as "isChecked"  from dual
UNION
select  'isHasExistingHouse-00' as id,'0' as "value",'否' as "lable",'isHasExistingHouse' as ParentId,2 as "sort",0 as "isChecked"  from dual


UNION
select 'obtainYear' as id, 'obtainYear' as "value",'项目获得年份' as "lable",null as ParentId,6 as "sort",0 as "isChecked"  from dual
UNION
select
'obtainYear-'||to_char(tab.year) as id,
case when ROWNUM=1 then '<='||to_char(tab.year) else to_char(tab.year) end "value",
case when ROWNUM=1 then to_char(tab.year)||'年之前' else to_char(tab.year)||'年' end "lable",
'obtainYear' as ParentId,
ROWNUM as "sort",
0 as "isChecked"
from (SELECT to_number(to_char(sysdate,'yyyy'))-ROWNUM+1 year FROM DUAL
CONNECT BY LEVEL<=5 order by year asc) tab


UNION
select  'org' as id, 'org' as "value",'二级单位' as "lable",null as ParentId,7 as "sort",0 as "isChecked"  from dual
UNION
select  'org-'||tab."value" as id,tab."value",tab."lable",tab."ParentId",ROWNUM as "sort",tab."isChecked" from 
(select id "value" ,org_name  "lable",'org' as "ParentId",ORDER_HIERARCHY_CODE as "sort",0 as "isChecked"  from (SELECT ID,org_name,order_hierarchy_code FROM SYS_BUSINESS_UNIT
            WHERE LEVEL_RANK=1
            UNION
            SELECT ID,org_name,order_hierarchy_code
            FROM (SELECT ORG_ID
                FROM DWM_SALE_RATE_BY_ORG where X_AXIS_PERIOD IS NOT NULL AND PO_SALE_OUT_COUNT <> 0
                GROUP BY  ORG_ID) tab
                LEFT JOIN SYS_BUSINESS_UNIT
                    ON tab.ORG_ID=SYS_BUSINESS_UNIT.ID
                WHERE SYS_BUSINESS_UNIT.LEVEL_RANK=2
         ) orgs order by orgs.order_hierarchy_code)tab

UNION
select  'hasFirstPhaseKeyPlan' as id, 'hasFirstPhaseKeyPlan' as "value",'已上线首期关键节点计划' as "lable",null as ParentId,8 as "sort",0 as "isChecked"  from dual
UNION
select 'hasFirstPhaseKeyPlan-01' as id ,'1' as "value",'是' as "lable",'hasFirstPhaseKeyPlan' as ParentId,1 as "sort",1 as "isChecked"  from dual
UNION
select  'hasFirstPhaseKeyPlan-00' as id,'0' as "value",'否' as "lable",'hasFirstPhaseKeyPlan' as ParentId,2 as "sort",0 as "isChecked"  from dual

        )filterItems order by filterItems."sort" ;
end P_DWM_AllFilterCondition;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_ALLPROJECTSALERATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_ALLPROJECTSALERATE" (
    filter         IN    CLOB,
    keyword        IN    VARCHAR2,
    rowcnt         IN    NUMBER,
    sortfield      IN    VARCHAR,
    orderby        IN    VARCHAR,
    datalist       OUT   SYS_REFCURSOR,
    total          OUT   NUMBER,
    describe       OUT   CLOB,
    allsortfield   OUT   SYS_REFCURSOR
) AS
BEGIN
    DELETE person_role_analysis_table;

    OPEN allsortfield FOR SELECT
                             column_value AS "fieldName"
                         FROM
                             TABLE ( split('projectName,obtainDate,firstOpenDate,fmSaleRateByMoney,fohySaleRateByMoney,crSaleRateByMoney,croySaleRateByMoney,firstOpenDurationByTl,poSaleRateByMoney,ehSaleRateByMoney,poSurplusSaleMoney,ehSurplusSaleMoney'
                             ) );

    p_dwm_projectsaleratedatalist(
    filter => filter, 
    keyword => keyword, 
    rowcnt => rowcnt, 
    sortfield => sortfield, 
    orderby => orderby,
    items => datalist, 
    total => total);

    describe := '符合条件的共'
                || fn_dwm_font_color(total || '个项目')
                || '。点击表头可再次排序；点击项目名称，可穿透查看单项目去化率分析详情。';
END p_dwm_allprojectsalerate;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_BRIEFINGANDK1K2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_BRIEFINGANDK1K2" (k1DataList OUT sys_refcursor,k2DataList OUT sys_refcursor,bigData  OUT sys_refcursor,k1DataSortField OUT sys_refcursor,k2DataSortField OUT sys_refcursor,k2preparedatasortfield OUT sys_refcursor,tabitems OUT sys_refcursor,k1DataListCount out number,k2DataListCount out number,k2preparedatalistcount out number)
AS  
k1_1abstract varchar2(4000);
k1_2abstract varchar2(4000);
k2_1abstract varchar2(4000);
k2_2abstract varchar2(4000);
k2_3abstract varchar2(4000);
k2_1ListCount number;
k2_3ListCount number;
k2_3_2ListCount number;
begin
SELECT details into k1_1abstract FROM dwm_sale_rate_data_briefing where CODE='k1.1' and rownum=1;
SELECT details into k1_2abstract FROM dwm_sale_rate_data_briefing where CODE='k1.2' and rownum=1;
SELECT details into k2_1abstract FROM dwm_sale_rate_data_briefing where CODE='k2.1' and rownum=1;
SELECT details into k2_2abstract FROM dwm_sale_rate_data_briefing where CODE='k2.2' and rownum=1;
SELECT details into k2_3abstract  FROM dwm_sale_rate_data_briefing where CODE='k2.3' and rownum=1;
select Count(1) into k2_1ListCount from  dwm_sale_rate_project where FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'));
select Count(1) into k2_3ListCount from  dwm_sale_rate_project where FIRST_OPEN_DATE is null and( to_number(to_char(PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) or to_number(to_char(NEW_PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')));
select Count(1) into k2_3_2ListCount from  dwm_sale_rate_project where FIRST_OPEN_DATE is null and (to_number(to_char(PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) or to_number(to_char(NEW_PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'))) and (NEW_PLAN_FIRST_OPEN_DATE< sysdate or PLAN_FIRST_OPEN_DATE< sysdate);

select count(1) into k1DataListCount from DWM_SALE_RATE_PROJECT p left join  dwm_sale_rate_by_project fo on fo.project_id=p.project_id where  p.PROJECT_NAME is not null and to_number(to_char(p.FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'));
select count(1) into k2DataListCount from dwm_sale_rate_project where FIRST_OPEN_DATE is not null and  to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'));

k2preparedatalistcount:=k2_3ListCount;
open k1DataList for  
select * from (SELECT
    fo.project_id as "projectId",
    FN_DWM_FONT_COLOR(p.PROJECT_NAME) as "projectName",
    to_char(p.FIRST_OPEN_DATE,'yyyy-mm-dd') as "firstOpenDate",
    case when fo.fo_sale_out_count is not null then
    to_char(fo.fo_sale_out_count)||'套'else
    '0套' end as "foSaleOutCount",
    case when fo.fo_sale_count is not null then
    to_char(fo.fo_sale_count)||'套'else
    '0套' end as "foSaleCount",
    case when fo.fo_sale_rate_by_count is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo.fo_sale_rate_by_count)) else 
    FN_DWM_FONT_COLOR('0%') end as "foSaleRateByCount",
    FN_DWN_AreaTo1000Square(fo.fo_sale_out_area) as "foSaleOutArea",
    FN_DWN_AreaTo1000Square(fo.fo_sale_area) as "foSaleArea",
    case when fo.fo_sale_rate_by_area is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo.fo_sale_rate_by_area)) else
    FN_DWM_FONT_COLOR('0%') end as "foSaleRateByArea",
    FN_DWN_AmountToBillionYuan(fo.fo_sale_out_money) as "foSaleOutMoney",
    FN_DWN_AmountToBillionYuan(fo.fo_sale_money) as "foSaleMoney",
    case when fo.fo_sale_rate_by_money is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo.fo_sale_rate_by_money)) else
    FN_DWM_FONT_COLOR('0%') end as "foSaleRateByMoney",
    case when fo.fo_sale_rate_by_money  is  null then
    0 else fo.fo_sale_rate_by_money end as "fo_sale_rate_by_money"
FROM
    DWM_SALE_RATE_PROJECT p left join 
    dwm_sale_rate_by_project fo on fo.project_id=p.project_id where  p.PROJECT_NAME is not null and to_number(to_char(p.FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) ) tab where  rownum<=10  order by tab."fo_sale_rate_by_money"  desc;
open k2DataList for  
select * from (SELECT
    project_id as "projectId",
    FN_DWM_FONT_COLOR(project_name) as "projectName",
    FN_DWM_FONT_COLOR(to_char(FIRST_OPEN_DATE,'yyyy-mm-dd')) as "firstOpenDate",
    to_char(take_land_date,'yyyy-mm-dd') as "takeLandDate",
    FN_DWM_FONT_COLOR(FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_TL)) as "firstOpenDurationByTL",
    to_char(PLAN_FIRST_OPEN_DATE,'yyyy-mm-dd') as "planFirstOpenDate",
    FN_DWM_DAY_CONVERT_MONTH(first_open_duration_by_plan) as "firstOpenDurationByPlan",
   Fn_DWM_DurationDaysDeal(PLAN_FIRST_OPEN_DATE,FIRST_OPEN_DATE,'label')  as "advanceFirstOpenDate",
   FIRST_OPEN_DURATION_BY_TL
FROM
    dwm_sale_rate_project where FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'))  order by FIRST_OPEN_DURATION_BY_TL desc) tab where rownum<=10;
open bigData for SELECT
    details as "describe"
FROM
    dwm_sale_rate_data_briefing where GROUP_NAME='BigDataBriefing' order by SORT;

open k1DataSortField for
SELECT COLUMN_VALUE as "fieldName" FROM table (split ('firstOpenDate,foSaleOutCount,foSaleCount,foSaleRateByCount,foSaleOutArea,foSaleArea,foSaleRateByArea,foSaleOutMoney,foSaleMoney,foSaleRateByMoney'));

open k2DataSortField for
SELECT COLUMN_VALUE as "fieldName" FROM table (split ('firstOpenDate,takeLandDate,firstOpenDurationByTL,planFirstOpenDate,firstOpenDurationByPlan'));

open k2preparedatasortfield for
SELECT COLUMN_VALUE as "fieldName" FROM table (split ('takeLandDate,planFirstOpenDate,firstOpenDurationByPlan,advanceFirstOpenDate,newPlanFirstOpenDate'));

open tabItems for
select * from (SELECT 
'1、本年首开项目去化率排行' as  "title",
k1_1abstract as  "abstract",
'k1' as "code",
1 as "sortNum"
from dual
UNION
select
'2、首开去化率变动趋势图' as  "title",
k1_2abstract as  "abstract",
'k1' as "code",
2 as "sortNum"
from dual
UNION
select
'1、本年已首开项目（'||to_char(k2_1ListCount)||'个）' as  "title",
k2_1abstract as  "abstract",
'k2' as "code",
21 as "sortNum"
from dual
UNION
select
'2、首开时间变动趋势图' as  "title",
k2_2abstract as  "abstract",
'k2' as "code",
22 as "sortNum"
from dual
UNION
select
'<p id="cache20" style=""><span style="color: rgb(64, 64, 64);" id="cache21">3、本年待首开项目（共'||to_char(k2_3ListCount)||'个，</span><span style="color: rgb(255, 0, 0);" id="cache22">其中已延误'||to_char(k2_3_2ListCount)||'个</span><span style="color: rgb(64, 64, 64);" id="cache23">）</span></p>' as  "title",
k2_3abstract as  "abstract",
'k2' as "code",
23 as "sortNum"
from dual) tab order by  tab."sortNum";
END P_DWM_briefingAndK1K2;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_BRIEFINGUPDATEBYCR
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_BRIEFINGUPDATEBYCR" 
AS  
cr clob;
cr_1 clob;
cr_2 clob;
crRateByBymoney clob;
crBymoneyMax clob;
crBymoneyMin clob;
crProjectCount number;
rowCount number;
begin
--Author:吴洋  date:2020/12/10
--竣工备案去化率大数据简报，定时任务，计算公式：取"货值"去化率
select case when sum(CR_SALE_OUT_MONEY) <> 0 then fn_ConvertDecimalToPercentage((sum(CR_SALE_OUT_MONEY))/(sum(CR_SALE_MONEY))) else  fn_ConvertDecimalToPercentage(0.0) end into crRateByBymoney
from  dwm_sale_rate_project  left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id 
where COMPLETION_ON_RECORD_DATE is not null and to_number(to_char(COMPLETION_ON_RECORD_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')); 

-- 项目个数
select count(1) into crProjectCount  from  dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where COMPLETION_ON_RECORD_DATE is not null and to_number(to_char(COMPLETION_ON_RECORD_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) and DWM_SALE_RATE_BY_PROJECT.cr_sale_out_money is not null and DWM_SALE_RATE_BY_PROJECT.cr_sale_out_count is not null and DWM_SALE_RATE_BY_PROJECT.cr_sale_out_area is not null;
-- 竣工备案日期 COMPLETION_ON_RECORD_DATE
select fn_ConvertDecimalToPercentage(max(CR_SALE_RATE_BY_MONEY)) into crBymoneyMax from dwm_sale_rate_project  left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where COMPLETION_ON_RECORD_DATE is not null and to_number(to_char(COMPLETION_ON_RECORD_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')); 
select fn_ConvertDecimalToPercentage(min(CR_SALE_RATE_BY_MONEY)) into crBymoneyMin from dwm_sale_rate_project  left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id
where COMPLETION_ON_RECORD_DATE is not null and to_number(to_char(COMPLETION_ON_RECORD_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')); 

cr:='<center>
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;font-size: 36px;color: #FF9900;">'||crRateByBymoney||'</span>
        </center>
        <p style="font-size:14px;text-align:center;line-height:18px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">K3竣工备案去化率</span>
        </p>
        <p style="font-size:11px;text-align:left;line-height:20px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >1、竣工备案去化率均值'||crRateByBymoney||'：</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#00CC66;">最高值'||crBymoneyMax|| '</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">，</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#FF99FF;">最低值'||crBymoneyMin||'</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">。</span>
        </p>';
    cr_1:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">本年达到竣工备案的项目共</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||crProjectCount|| '个项目</span><span style="font-family:''微软雅黑'';font-weight:400;">，竣工备案去化率</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">均值'||crRateByBymoney||'</span><span style="font-family:''微软雅黑'';font-weight:400;">，</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">最高值'||crBymoneyMax||'</span><span style="font-family:''微软雅黑'';font-weight:400;">、</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">最低值'||crBymoneyMin||'</span><span style="font-family:''微软雅黑'';font-weight:400;">。</span></p>';
    cr_2:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">集团整体竣工备案去化率均值为</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||crRateByBymoney||'</span><span style="font-family:''微软雅黑'';font-weight:400;color:#666666;">。</span></p>';

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='cr';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=cr,MODIFIED=sysdate where code='cr';
    dbms_output.put_line('update--cr----'||cr);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'cr',cr,3,'BigDataBriefing',sysdate);
    dbms_output.put_line('insert---cr-----'||cr);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='cr.1';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=cr_1,MODIFIED=sysdate where code='cr.1';
     dbms_output.put_line('update--cr.1----'||cr_1);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'cr.1',cr_1,11,'cr',sysdate);
    dbms_output.put_line('insert---cr.1---'||cr_1);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='cr.2';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=cr_2,MODIFIED=sysdate where code='cr.2';
      dbms_output.put_line('update---cr.2----'||cr_2);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'cr.2',cr_2,12,'cr',sysdate);
     dbms_output.put_line('insert---cr.2----'||cr_2);  
end if;
commit;
end P_DWM_BRIEFINGUPDATEBYCR;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_BRIEFINGUPDATEBYCROY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_BRIEFINGUPDATEBYCROY" 
AS  
croy clob;
croy_1 clob;
croy_2 clob;
croyRateByBymoney clob;
croyBymoneyMax clob;
croyBymoneyMin clob;
croyProjectCount number;
rowCount number;
begin
--Author:吴洋  date:2020/12/10
--竣工备案后一年去化率大数据简报，定时任务，计算公式：取"货值"去化率
-- 调整：竣工备案一年，取达到一年数据，当前系统日期 >= 竣工备案日期+360  2020/12/21
select case when sum(CROY_SALE_OUT_MONEY) <> 0 then fn_ConvertDecimalToPercentage((sum(CROY_SALE_OUT_MONEY))/(sum(CROY_SALE_MONEY))) else  fn_ConvertDecimalToPercentage(0.0) end into croyRateByBymoney
from  dwm_sale_rate_project  left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id 
where  COMPLETION_ON_RECORD_DATE is not null and to_number(to_char(COMPLETION_ON_RECORD_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) ; 

-- 项目个数
select count(1) into croyProjectCount  from  dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where COMPLETION_ON_RECORD_DATE is not null and to_number(to_char(COMPLETION_ON_RECORD_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) and DWM_SALE_RATE_BY_PROJECT.croy_sale_out_money is not null and DWM_SALE_RATE_BY_PROJECT.croy_sale_out_count is not null and DWM_SALE_RATE_BY_PROJECT.croy_sale_out_area is not null;

select fn_ConvertDecimalToPercentage(max(CROY_SALE_RATE_BY_MONEY)) into croyBymoneyMax from dwm_sale_rate_project  left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where COMPLETION_ON_RECORD_DATE is not null and to_number(to_char(COMPLETION_ON_RECORD_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) and DWM_SALE_RATE_BY_PROJECT.croy_sale_out_count is not null and DWM_SALE_RATE_BY_PROJECT.croy_sale_out_money is not null and DWM_SALE_RATE_BY_PROJECT.croy_sale_out_area is not null; 
select fn_ConvertDecimalToPercentage(min(CROY_SALE_RATE_BY_MONEY)) into croyBymoneyMin from dwm_sale_rate_project  left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id
where COMPLETION_ON_RECORD_DATE is not null and to_number(to_char(COMPLETION_ON_RECORD_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) and CROY_SALE_RATE_BY_MONEY is not null; 

croy:='<center>
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;font-size: 36px;color: #FF9900;">'||croyRateByBymoney||'</span>
        </center>
        <p style="font-size:14px;text-align:center;line-height:18px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">K4竣工备案后一年去化率</span>
        </p>
        <p style="font-size:11px;text-align:left;line-height:20px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >1、竣工备案后一年去化率均值'||croyRateByBymoney||'：</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#00CC66;">最高值'||croyBymoneyMax|| '</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">，</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#FF99FF;">最低值'||croyBymoneyMin||'</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">。</span>
        </p>';
    croy_1:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">本年已达“竣工备案一年”的项目共</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||croyProjectCount|| '个项目</span><span style="font-family:''微软雅黑'';font-weight:400;">，竣工备案后一年去化率</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">均值'||croyRateByBymoney||'</span><span style="font-family:''微软雅黑'';font-weight:400;">，</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">最高值'||croyBymoneyMax||'</span><span style="font-family:''微软雅黑'';font-weight:400;">、</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">最低值'||croyBymoneyMin||'</span><span style="font-family:''微软雅黑'';font-weight:400;">。</span></p>';
    croy_2:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">集团整体竣工备案一年后去化率均值为</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||croyRateByBymoney||'</span><span style="font-family:''微软雅黑'';font-weight:400;color:#666666;">。</span></p>';

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='croy';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=croy,MODIFIED=sysdate where code='croy';
    dbms_output.put_line('update--croy----'||croy);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'croy',croy,4,'BigDataBriefing',sysdate);
    dbms_output.put_line('insert---croy-----'||croy);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='croy.1';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=croy_1,MODIFIED=sysdate where code='croy.1';
     dbms_output.put_line('update--croy.1----'||croy_1);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'croy.1',croy_1,11,'croy',sysdate);
    dbms_output.put_line('insert---croy.1---'||croy_1);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='croy.2';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=croy_2,MODIFIED=sysdate where code='croy.2';
      dbms_output.put_line('update---croy.2----'||croy_2);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'croy.2',croy_2,12,'croy',sysdate);
     dbms_output.put_line('insert---croy.2----'||croy_2);  
end if;
commit;
end P_DWM_BRIEFINGUPDATEBYCROY;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_BRIEFINGUPDATEBYFM
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_BRIEFINGUPDATEBYFM" 
AS  
fm clob;
fm_1 clob;
fm_2 clob;
fmRateByBymoney clob;
fmBymoneyMax clob;
fmBymoneyMin clob;
fmProjectCount number;
fmProjectNamesBySaleMoney clob:='';
fmProjectCountByNearly3Months  number;
fmRateByCountByNearly3Months  clob;
rowCount number;
begin
--Author:吴洋  date:2020/12/10
--首月去化率大数据简报，定时任务，计算公式：取"货值"去化率
select case when sum(FO_SALE_MONEY) <> 0 then fn_ConvertDecimalToPercentage((sum(FM_SALE_OUT_MONEY))/(sum(FO_SALE_MONEY))) else  fn_ConvertDecimalToPercentage(0.0) end into fmRateByBymoney
from  dwm_sale_rate_project  left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id 
where FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')); 

--近3个月  首月去化率均值
select case when sum(FO_SALE_MONEY) <>0 then fn_ConvertDecimalToPercentage((sum(FM_SALE_OUT_MONEY))/(sum(FO_SALE_MONEY))) else fn_ConvertDecimalToPercentage(0.0) end into fmRateByCountByNearly3Months 
from  dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id 
where FIRST_OPEN_DATE is not null  and FIRST_OPEN_DATE >= ADD_MONTHS(to_date(TO_CHAR(sysdate,'yyyy-mm-dd'),'yyyy-mm-dd'), -2) and FIRST_OPEN_DATE<=sysdate;

-- 本年实际首开项目个数,
select count(1) into fmProjectCount  from  dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'));
--近三个月实际首开项目个数
select count(1) into fmProjectCountByNearly3Months  from   dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where FIRST_OPEN_DATE is not null  and FIRST_OPEN_DATE >= ADD_MONTHS(to_date(TO_CHAR(sysdate,'yyyy-mm-dd'),'yyyy-mm-dd'), -2) and FIRST_OPEN_DATE<=sysdate;

--近三个月实际首开项目 明细展示
-- 2020/12/14 调整，首月去化率列表获取所有本年已经首开的项目，不判断首月去化率的值是否为空！
--首开半年、竣工备案、竣工备案一年列表需判断对应去化率值是否为空，原型摘要标注“达到”关键字。
if fmProjectCount <> 0 then
select listagg(project_name||FN_DWM_DEC_CONVERT_PCT(FM_SALE_RATE_BY_MONEY),'、') WITHIN GROUP (ORDER BY FM_SALE_RATE_BY_MONEY desc) into  fmProjectNamesBySaleMoney  from (select dwm_sale_rate_project.project_name,DWM_SALE_RATE_BY_PROJECT.fm_sale_rate_by_money as FM_SALE_RATE_BY_MONEY
from  dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where FIRST_OPEN_DATE is not null and FIRST_OPEN_DATE >= ADD_MONTHS(to_date(TO_CHAR(sysdate,'yyyy-mm-dd'),'yyyy-mm-dd'),-2) and FIRST_OPEN_DATE <=sysdate )tab;
end if;

select fn_ConvertDecimalToPercentage(max(FM_SALE_RATE_BY_MONEY)) into fmBymoneyMax from dwm_sale_rate_project  left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')); 
select fn_ConvertDecimalToPercentage(min(FM_SALE_RATE_BY_MONEY)) into fmBymoneyMin from dwm_sale_rate_project  left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id
where FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')); 

fm:='<center>
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;font-size: 36px;color: #FF9900;">'||fmRateByBymoney||'</span>
        </center>
        <p style="font-size:14px;text-align:center;line-height:18px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">K1首月去化率</span>
        </p>
        <p style="font-size:11px;text-align:left;line-height:20px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >1、本年实际首开项目'||fmProjectCount|| '个项目，首月去化率均值'||fmRateByBymoney||'：</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#00CC66;">最高值'||fmBymoneyMax|| '</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">，</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#FF99FF;">最低值'||fmBymoneyMin||'</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">。</span>
        </p>
        <p style="font-size:11px;text-align:left;line-height:20px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >2、近3个月实际首开项目'||fmProjectCountByNearly3Months||'个项目，首月去化率均值'||fmRateByCountByNearly3Months||'：</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">'||fmProjectNamesBySaleMoney||'。</span>
        </p>';
    fm_1:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">本年首开共</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||fmProjectCount|| '个项目</span><span style="font-family:''微软雅黑'';font-weight:400;">，首月去化率</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">均值'||fmRateByBymoney||'</span><span style="font-family:''微软雅黑'';font-weight:400;">，</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">最高值'||fmBymoneyMax||'</span><span style="font-family:''微软雅黑'';font-weight:400;">、</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">最低值'||fmBymoneyMin||'</span><span style="font-family:''微软雅黑'';font-weight:400;">。</span></p>';
    fm_2:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">集团整体首月去化率均值为</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||fmRateByBymoney||'</span><span style="font-family:''微软雅黑'';font-weight:400;color:#666666;">。</span></p>';

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='fm';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=fm,MODIFIED=sysdate where code='fm';
    dbms_output.put_line('update--fm----'||fm);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'fm',fm,1,'BigDataBriefing',sysdate);
    dbms_output.put_line('insert---fm-----'||fm);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='fm.1';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=fm_1,MODIFIED=sysdate where code='fm.1';
     dbms_output.put_line('update--fm.1----'||fm_1);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'fm.1',fm_1,11,'fm',sysdate);
    dbms_output.put_line('insert---fm.1---'||fm_1);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='fm.2';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=fm_2,MODIFIED=sysdate where code='fm.2';
      dbms_output.put_line('update---fm.2----'||fm_2);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'fm.2',fm_2,12,'fm',sysdate);
     dbms_output.put_line('insert---fm.2----'||fm_2);  
end if;
commit;
end P_DWM_BRIEFINGUPDATEBYFM;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_BRIEFINGUPDATEBYFOHY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_BRIEFINGUPDATEBYFOHY" 
AS  
fohy clob;
fohy_1 clob;
fohy_2 clob;
fohyRateByBymoney clob;
fohyBymoneyMax clob;
fohyBymoneyMin clob;
fohyProjectCount number;
rowCount number;
begin
--Author:吴洋  date:2020/12/10
--首开半年去化率大数据简报，定时任务，计算公式：取"货值"去化率
select case when sum(FOHY_SALE_OUT_MONEY) <> 0 then fn_ConvertDecimalToPercentage((sum(FOHY_SALE_OUT_MONEY))/(sum(FOHY_SALE_MONEY))) else  fn_ConvertDecimalToPercentage(0.0) end into fohyRateByBymoney
from  dwm_sale_rate_project  left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id 
where FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')); 


--2020/12/17 调整，首开半年去化率 取“本年首开达到半年”的项目，取本年首开的
--首开日期年份=系统当前年份
--首开日期+180天<= 当前系统时间（去掉）
-- 项目个数
select count(1) into fohyProjectCount  from  dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where FIRST_OPEN_DATE is not null and to_char(sysdate,'yyyy')=to_char(FIRST_OPEN_DATE,'yyyy');

select fn_ConvertDecimalToPercentage(max(FOHY_SALE_RATE_BY_MONEY)) into fohyBymoneyMax from dwm_sale_rate_project  left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id 
where FIRST_OPEN_DATE is not null and to_char(sysdate,'yyyy')=to_char(FIRST_OPEN_DATE,'yyyy');

select fn_ConvertDecimalToPercentage(min(FOHY_SALE_RATE_BY_MONEY)) into fohyBymoneyMin from dwm_sale_rate_project  left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id
where FIRST_OPEN_DATE is not null  and to_char(sysdate,'yyyy')=to_char(FIRST_OPEN_DATE,'yyyy');

fohy:='<center>
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;font-size: 36px;color: #FF9900;">'||fohyRateByBymoney||'</span>
        </center>
        <p style="font-size:14px;text-align:center;line-height:18px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">K2首开半年去化率</span>
        </p>
        <p style="font-size:11px;text-align:left;line-height:20px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >1、首开半年去化率均值'||fohyRateByBymoney||'：</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#00CC66;">最高值'||fohyBymoneyMax|| '</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">，</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#FF99FF;">最低值'||fohyBymoneyMin||'</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">。</span>
        </p>';
    fohy_1:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">本年首开达到半年的项目共</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||fohyProjectCount|| '个项目</span><span style="font-family:''微软雅黑'';font-weight:400;">，首开半年去化率</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">均值'||fohyRateByBymoney||'</span><span style="font-family:''微软雅黑'';font-weight:400;">，</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">最高值'||fohyBymoneyMax||'</span><span style="font-family:''微软雅黑'';font-weight:400;">、</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">最低值'||fohyBymoneyMin||'</span><span style="font-family:''微软雅黑'';font-weight:400;">。</span></p>';
    fohy_2:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">集团整体首开半年去化率均值为</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||fohyRateByBymoney||'</span><span style="font-family:''微软雅黑'';font-weight:400;color:#666666;">。</span></p>';

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='fohy';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=fohy,MODIFIED=sysdate where code='fohy';
    dbms_output.put_line('update--fohy----'||fohy);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'fohy',fohy,2,'BigDataBriefing',sysdate);
    dbms_output.put_line('insert---fohy-----'||fohy);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='fohy.1';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=fohy_1,MODIFIED=sysdate where code='fohy.1';
     dbms_output.put_line('update--fohy.1----'||fohy_1);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'fohy.1',fohy_1,11,'fohy',sysdate);
    dbms_output.put_line('insert---fohy.1---'||fohy_1);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='fohy.2';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=fohy_2,MODIFIED=sysdate where code='fohy.2';
      dbms_output.put_line('update---fohy.2----'||fohy_2);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'fohy.2',fohy_2,12,'fohy',sysdate);
     dbms_output.put_line('insert---fohy.2----'||fohy_2);  
end if;
commit;
end P_DWM_BRIEFINGUPDATEBYFOHY;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_BRIEFINGUPDATEBYK1
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_BRIEFINGUPDATEBYK1" 
AS  
k1 clob;
k1_1 clob;
k1_2 clob;
k1RateByBycount clob;
k1BycountMax clob;
k1BycountMin clob;
k1ProjectCount number;
k1ProjectCountByNearly3Months  number;
k1RateByCountByNearly3Months  clob;
k1ProjectRateByNearly3Months  clob;
rowCount number;
begin
select case when sum(FO_SALE_COUNT) <> 0 then fn_ConvertDecimalToPercentage((sum(FO_SALE_OUT_COUNT))/(sum(FO_SALE_COUNT))) else  fn_ConvertDecimalToPercentage(0.0) end into k1RateByBycount
from  dwm_sale_rate_project  left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id 
where FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')); 

select case when sum(FO_SALE_COUNT) <>0 then fn_ConvertDecimalToPercentage((sum(FO_SALE_OUT_COUNT))/(sum(FO_SALE_COUNT))) else fn_ConvertDecimalToPercentage(0.0) end into k1RateByCountByNearly3Months 
from  dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id 
where FIRST_OPEN_DATE is not null  and FIRST_OPEN_DATE >= ADD_MONTHS(to_date(TO_CHAR(sysdate,'yyyy-mm-dd'),'yyyy-mm-dd'), -2) and FIRST_OPEN_DATE<=sysdate;

select count(1) into k1ProjectCount  from  dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'));
select count(1) into k1ProjectCountByNearly3Months  from   dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where FIRST_OPEN_DATE is not null  and FIRST_OPEN_DATE >= ADD_MONTHS(to_date(TO_CHAR(sysdate,'yyyy-mm-dd'),'yyyy-mm-dd'), -2) and FIRST_OPEN_DATE<=sysdate;

select fn_ConvertDecimalToPercentage(max(FO_SALE_RATE_BY_COUNT)) into k1BycountMax from dwm_sale_rate_project  left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')); 
select fn_ConvertDecimalToPercentage(min(FO_SALE_RATE_BY_COUNT)) into k1BycountMin from dwm_sale_rate_project  left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id
where FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) and FO_SALE_COUNT is not null and FO_SALE_COUNT <> 0; 

select  listagg(project_name||fn_ConvertDecimalToPercentage(FO_SALE_RATE_BY_COUNT),'、') WITHIN GROUP (ORDER BY FO_SALE_RATE_BY_COUNT desc)  into k1ProjectRateByNearly3Months  from (select dwm_sale_rate_project.project_name,case when FO_SALE_RATE_BY_COUNT is null or FO_SALE_RATE_BY_COUNT=0 then 0.0 else FO_SALE_RATE_BY_COUNT end as FO_SALE_RATE_BY_COUNT
from  dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id
where FIRST_OPEN_DATE is not null  and FIRST_OPEN_DATE >= ADD_MONTHS(to_date(TO_CHAR(sysdate,'yyyy-mm-dd'),'yyyy-mm-dd'), -2) and FIRST_OPEN_DATE<=sysdate and FO_SALE_RATE_BY_COUNT <>0 and FO_SALE_RATE_BY_COUNT is not null)tab ;
k1:='<center>
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;font-size: 36px;color: #FF9900;">'||k1RateByBycount||'</span>
        </center>
        <p style="font-size:14px;text-align:center;line-height:18px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">K1首开去化率</span>
        </p>
        <p style="font-size:11px;text-align:left;line-height:20px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >1、本年实际首开项目'||k1ProjectCount|| '个项目，首开去化率均值'||k1RateByBycount||'：</span
          ><span style="font-family:''微软雅黑'';font-weight:400;"></span
          ><span style="font-family:''微软雅黑'';font-weight:400;"></span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#00CC66;">最高值'||k1BycountMax|| '</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">，</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#FF99FF;">最低值'||k1BycountMin||'</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">。</span>
        </p>
        <p style="font-size:11px;text-align:left;line-height:20px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >2、近3个月实际首开项目'||k1ProjectCountByNearly3Months||'个项目，首开去化率均值'||k1RateByCountByNearly3Months||'：</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">'||k1ProjectRateByNearly3Months||'。</span>
        </p>';
    k1_1:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">本年首开共</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k1ProjectCount|| '个项目</span><span style="font-family:''微软雅黑'';font-weight:400;">，首开去化率</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">均值'||k1RateByBycount||'</span><span style="font-family:''微软雅黑'';font-weight:400;">，</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">最高值'||k1BycountMax||'</span><span style="font-family:''微软雅黑'';font-weight:400;">、</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">最低值'||k1BycountMin||'</span><span style="font-family:''微软雅黑'';font-weight:400;">。</span></p>';
    k1_2:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">集团整体首开去化率均值为</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k1RateByBycount||'</span><span style="font-family:''微软雅黑'';font-weight:400;color:#666666;">。</span></p>';

-- 删除一期大数据简报 删除内容
select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k1';
if rowCount <> 0 then
    delete from DWM_SALE_RATE_DATA_BRIEFING where code ='k1';
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k1.1';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k1_1,MODIFIED=sysdate where code='k1.1';
     dbms_output.put_line('update--k1.1----'||k1_1);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k1.1',k1_1,11,'k1',sysdate);
    dbms_output.put_line('insert---k1.1---'||k1_1);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k1.2';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k1_2,MODIFIED=sysdate where code='k1.2';
      dbms_output.put_line('update---k1.2----'||k1_2);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k1.2',k1_2,12,'k1',sysdate);
     dbms_output.put_line('insert---k1.2----'||k1_2);  
end if;
commit;
end P_DWM_briefingUpdateByK1;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_BRIEFINGUPDATEBYK2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_BRIEFINGUPDATEBYK2" 
AS  
k2 clob:='';
k2str clob:='';
k2_1 clob:='';
k2_2 clob:='';
k2_3 clob:='';
k2ProjectCount number:=0;
k2MinProjectNames clob:='';
k2MaxProjectNames clob:='';
k2MinFirstOpenDurationByTl number:=0;
k2MaxFirstOpenDurationByTl number:=0;
DelayFirstOpenDurationByTl number:=0;
k2onTimeProjectCount number:=0;
DelayFirstOpen number:=0;
DelayLastFirstOpen number:=0;
rowCount number:=0;
begin
SELECT
   count(1)
   into k2ProjectCount
FROM
    dwm_sale_rate_project where  FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'));
SELECT
   to_char(trunc( (sum(FIRST_OPEN_DURATION_BY_TL)/count(1))/ 31, 1),'fm9999999990.0')
   into k2
FROM
    dwm_sale_rate_project where  FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) and TAKE_LAND_DATE is not null;
SELECT 
  min(FIRST_OPEN_DURATION_BY_TL) into k2MinFirstOpenDurationByTl
FROM
    dwm_sale_rate_project where  FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'));

SELECT 
   replace(WMSYS.WM_CONCAT(project_name),',','、') into k2MinProjectNames
FROM
    dwm_sale_rate_project where  FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'))  and
    FIRST_OPEN_DURATION_BY_TL=k2MinFirstOpenDurationByTl;
k2MinFirstOpenDurationByTl:=trunc(k2MinFirstOpenDurationByTl / 31, 1);

SELECT 
  max(FIRST_OPEN_DURATION_BY_TL) into k2MaxFirstOpenDurationByTl
FROM
    dwm_sale_rate_project where  FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'));

SELECT 
   replace(WMSYS.WM_CONCAT(project_name),',','、') into k2MaxProjectNames
FROM
    dwm_sale_rate_project where  FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'))  and
    FIRST_OPEN_DURATION_BY_TL=k2MaxFirstOpenDurationByTl;

k2MaxFirstOpenDurationByTl:=trunc(k2MaxFirstOpenDurationByTl / 31, 1);

SELECT 
  count(1) into k2onTimeProjectCount
FROM
     dwm_sale_rate_project where  FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'))  and PLAN_FIRST_OPEN_DATE>=FIRST_OPEN_DATE;

select Count(1) into DelayFirstOpen from  dwm_sale_rate_project where FIRST_OPEN_DATE is null and (to_number(to_char(PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) or to_number(to_char(NEW_PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')));
select Count(1) into DelayLastFirstOpen from  dwm_sale_rate_project where FIRST_OPEN_DATE is null and (to_number(to_char(PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) or to_number(to_char(NEW_PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'))) and (NEW_PLAN_FIRST_OPEN_DATE< sysdate or PLAN_FIRST_OPEN_DATE< sysdate);

select case when DelayFirstOpen=0 then 0 else trunc(sum(FIRST_OPEN_DURATION_BY_PLAN)/DelayFirstOpen/31,1) end  into DelayFirstOpenDurationByTl from  dwm_sale_rate_project where FIRST_OPEN_DATE is null and (to_number(to_char(PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) or to_number(to_char(NEW_PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')));
k2str:=' <center>
          <span
            style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;font-size: 36px;color: #FF9900;"
            >'||k2||'个月</span
          >
        </center>
        <p style="font-size:14px;text-align:center;line-height:18px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >K5拿地至首开时间</span
          >
        </p>
        <p style="font-size:11px;text-align:left;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >1、本年已首开'||to_char(k2ProjectCount)||'个项目，首开平均时长'||k2||'月：</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">首开最快'||k2MinProjectNames||'，</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#33CC99;">'||to_char(k2minfirstOpenDurationByTl,'fm9999999990.0')||'个月</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">；首开最慢'||k2MaxProjectNames||'，</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#FF6666;">'||to_char(k2MaxFirstOpenDurationByTl,'fm9999999990.0')||'个月</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">。</span>
        </p>
        <p style="font-size:11px;text-align:left;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;color:#000000;"
            >2、本年按时已首开项目</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#33CC99;">'||to_char(k2onTimeProjectCount)||'个</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#000000;">，</span
          ><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;color:#000000;"
            >延迟已首开项目</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#FF6633;">'||to_char(k2ProjectCount-k2onTimeProjectCount)||'个</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#000000;">；</span>
        </p>
        <p style="font-size:11px;text-align:left;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >3、本年剩余首开项目'||to_char(DelayFirstOpen)||'个：</span
          >
        </p>
        <p style="font-size:11px;text-align:left;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑'';font-weight:400;"> </span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#FF99FF;">延迟未首开项目'||to_char(DelayLastFirstOpen)||'个</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">，未到期首开项目'||to_char(DelayFirstOpen-DelayLastFirstOpen)||'个。</span>
        </p>';
    k2_2:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">集团整体首开时长均值为</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k2||'个月</span><span style="font-family:''微软雅黑'';font-weight:400;color:#666666;">。</span></p>';
    k2_3:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">本年待首开项目'||DelayFirstOpen||'个，首开时长目标均值为</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||to_char(DelayFirstOpenDurationByTl,'fm9999999990.0')||'个月；</span><span style="font-family:''微软雅黑'';font-weight:400;">已延误首开的项目</span><span style="font-family:''微软雅黑'';font-weight:400;color:#FF0000;">共'||DelayLastFirstOpen||'个</span><span style="font-family:''微软雅黑'';font-weight:400;color:#666666;">，预计</span><span style="font-family:''微软雅黑'';font-weight:400;">。</span></p>';
    k2_1:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">本年首开项目'||to_char(k2ProjectCount)||'个，“拿地至首开”</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">平均时长'||k2||'个月</span><span style="font-family:''微软雅黑'';font-weight:400;">，首开</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">最快为'||to_char(k2MinFirstOpenDurationByTl,'fm9999999990.0')||'月</span><span style="font-family:''微软雅黑'';font-weight:400;">，首开</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">最慢'||to_char(k2MaxFirstOpenDurationByTl,'fm9999999990.0')||'个月；</span><span style="font-family:''微软雅黑'';font-weight:400;">按时首开项目</span><span style="font-family:''微软雅黑'';font-weight:400;color:#00CC66;">'||to_char(k2onTimeProjectCount)||'个</span><span style="font-family:''微软雅黑'';font-weight:400;">，延迟首开项目</span><span style="font-family:''微软雅黑'';font-weight:400;color:#E68CB2;">'||to_char(k2ProjectCount-k2onTimeProjectCount)||'个</span><span style="font-family:''微软雅黑'';font-weight:400;">。</span></p>';

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k2';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k2str,MODIFIED=sysdate,SORT=5 where code='k2';
    dbms_output.put_line('update--k2---'||k2str);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k2',k2str,5,'BigDataBriefing',sysdate);
    dbms_output.put_line('insert---k2-----'||k2str);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k2.1';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k2_1,MODIFIED=sysdate where code='k2.1';
     dbms_output.put_line('update--k2.1----'||k2_1);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k2.1',k2_1,11,'k2',sysdate);
    dbms_output.put_line('insert--k2.1----'||k2_1);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k2.2';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k2_2,MODIFIED=sysdate where code='k2.2';
      dbms_output.put_line('update--k2.2----'||k2_2);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k2.2',k2_2,12,'k2',sysdate);
     dbms_output.put_line('inser--k2.2t----'||k2_2);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k2.3';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k2_3,MODIFIED=sysdate where code='k2.3';
      dbms_output.put_line('update----'||k2_3);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k2.3',k2_3,12,'k2',sysdate);
     dbms_output.put_line('insert----'||k2_3);  
end if;
end P_DWM_briefingUpdateByK2;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_BRIEFINGUPDATEBYK3
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_BRIEFINGUPDATEBYK3" 
AS  
k3 clob:='';
k3_1 clob:='';
k3RateByMoney clob:='';
k3RateByMoneyCout number:=0;
k3RateByMoneyOver90Cout number:=0;
k3RateByMoneyOver90Rate  varchar(50):='0%';
k3RateByMoneyOver99Cout number:=0;
k3RateByMoneyOver99Rate  varchar(50):='0%';
k3RemainingValue varchar(50):='0亿';
k3RemainingValueByParkingSpace varchar(50):='0亿';
k3RemainingValueByParkingBusin varchar(50):='0亿';
k3RemainingValueByParkingHouse varchar(50):='0亿';
ROWCOUNT number;
begin
select case when sum(FO_SALE_COUNT) <> 0 then fn_ConvertDecimalToPercentage(sum(PO_SALE_OUT_MONEY)/sum(PO_SALE_MONEY)) else  fn_ConvertDecimalToPercentage(0.0) end into  k3RateByMoney
from   DWM_SALE_RATE_BY_PROJECT; 

select count(1) into k3RateByMoneyOver90Cout
from DWM_SALE_RATE_BY_PROJECT where trim(to_char((DWM_SALE_RATE_BY_PROJECT.PO_SALE_RATE_BY_MONEY * 100),'fm9999999990'))>=90;

select count(1) into k3RateByMoneyCout
from DWM_SALE_RATE_BY_PROJECT where DWM_SALE_RATE_BY_PROJECT.PO_SALE_RATE_BY_MONEY is not null;

select count(1) into k3RateByMoneyOver99Cout
from   DWM_SALE_RATE_BY_PROJECT  where trim(to_char((DWM_SALE_RATE_BY_PROJECT.PO_SALE_RATE_BY_MONEY * 100),'fm9999999990')) >=99;

select case when sum(PO_SURPLUS_SALE_MONEY) <> 0 then FN_DWN_AmountToBillionYuan(sum(PO_SURPLUS_SALE_MONEY))  else  '0亿' end into  k3RemainingValue
from   DWM_SALE_RATE_BY_GRANULARITY where DATA_GRANULARITY in ('车位仓储','商办产业','住宅');

select case when sum(PO_SURPLUS_SALE_MONEY) <> 0 then FN_DWN_AmountToBillionYuan(sum(PO_SURPLUS_SALE_MONEY))  else  '0亿' end into  k3RemainingValueByParkingSpace
from   DWM_SALE_RATE_BY_GRANULARITY where DATA_GRANULARITY='车位仓储';

select case when sum(PO_SURPLUS_SALE_MONEY) <> 0 then FN_DWN_AmountToBillionYuan(sum(PO_SURPLUS_SALE_MONEY))  else  '0亿' end into  k3RemainingValueByParkingBusin
from   DWM_SALE_RATE_BY_GRANULARITY  where DATA_GRANULARITY='商办产业';

select case when sum(PO_SURPLUS_SALE_MONEY) <> 0 then FN_DWN_AmountToBillionYuan(sum(PO_SURPLUS_SALE_MONEY))  else  '0亿' end into  k3RemainingValueByParkingHouse

from   DWM_SALE_RATE_BY_GRANULARITY  where DATA_GRANULARITY='住宅';

if k3RateByMoneyCout<>0 then 
k3RateByMoneyOver90Rate:=fn_ConvertDecimalToPercentage(k3RateByMoneyOver90Cout/k3RateByMoneyCout);
end if;

if k3RateByMoneyCout<>0 then 
k3RateByMoneyOver99Rate:=fn_ConvertDecimalToPercentage(k3RateByMoneyOver99Cout/k3RateByMoneyCout);
end if;


k3:='  <center>
          <span
            style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;font-size: 36px;color: #FF9900;"
            >'||k3RateByMoney||'</span
          >
        </center>
        <p style="font-size:14px;text-align:center;line-height:18px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >K6全案去化率</span
          >
        </p>
        <p style="font-size:11px;text-align:left;line-height:16px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >1、共'||k3RateByMoneyOver90Cout||'个项目全案已取证去化率达90%，占所有项目的'||k3RateByMoneyOver90Rate||' ：</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">本年达到90%去化的'||k3RateByMoneyOver90Cout||'个</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#00CC66;"></span
          ><span style="font-family:''微软雅黑'';font-weight:400;">。</span>
        </p>
        <p style="font-size:11px;text-align:left;line-height:16px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >2、共'||k3RateByMoneyOver99Cout||'个项目全案已取证去化率达99%，占所有项目的'||k3RateByMoneyOver99Rate||'：</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">本年达到99%去化的'||k3RateByMoneyOver99Cout||'个</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#00CC66;"></span
          ><span style="font-family:''微软雅黑'';font-weight:400;">。</span>
        </p>
        <p style="font-size:11px;text-align:left;line-height:16px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">3</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">、</span
          ><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >库存货值共'||k3RemainingValue||'</span
          ><span style="font-family:''微软雅黑'';font-weight:400;"
            >：住宅'||k3RemainingValueByParkingHouse||'、商业'||k3RemainingValueByParkingBusin||'、车位'||k3RemainingValueByParkingSpace||'。</span
          >
        </p>';
    k3_1:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">全案已取证去化率达到90%的项目，本年新增</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k3RateByMoneyOver90Cout||'个</span><span style="font-family:''微软雅黑'';font-weight:400;">；全案已取证去化率达到99%的项目，本年</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">新增'||k3RateByMoneyOver99Cout||'个</span><span style="font-family:''微软雅黑'';font-weight:400;">。</span></p>';

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k3';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k3,MODIFIED=sysdate,SORT=6 where code='k3';
    dbms_output.put_line('update--k3----'||k3);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k3',k3,6,'BigDataBriefing',sysdate);
    dbms_output.put_line('insert--k3-----'||k3);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k3.1';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k3_1,MODIFIED=sysdate where code='k3.1';
     dbms_output.put_line('update--k3.1----'||k3_1);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k3.1',k3_1,11,'k3',sysdate);
    dbms_output.put_line('insert--k3.1----'||k3_1);  
end if;

commit;
end P_DWM_briefingUpdateByK3;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_BRIEFINGUPDATEBYK4
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_BRIEFINGUPDATEBYK4" 
AS  
k4 clob:='';
k4_1 clob:='';
k4RateByMoney clob:='';
AllEhSaleOutMoney number:=0;
AllEhSaleMoney number:=0;
AllEhSurplusSaleMoney number:=0;
ROWCOUNT number;
begin
select case when sum(EH_SALE_MONEY) <> 0 then fn_ConvertDecimalToPercentage(sum(EH_SALE_OUT_MONEY)/sum(EH_SALE_MONEY)) else  fn_ConvertDecimalToPercentage(0.0) end into  k4RateByMoney
from   DWM_SALE_RATE_BY_PROJECT; 

select sum(EH_SALE_OUT_MONEY) into  AllEhSaleOutMoney
from   DWM_SALE_RATE_BY_PROJECT; 

select sum(EH_SALE_MONEY) into  AllEhSaleMoney
from   DWM_SALE_RATE_BY_PROJECT; 

select sum(EH_SURPLUS_SALE_MONEY) into  AllEhSurplusSaleMoney
from   DWM_SALE_RATE_BY_PROJECT; 

k4:='<center>
          <span
            style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;font-size: 36px;color: #FF9900;"
            >'||k4RateByMoney||'</span>
        </center>
        <p style="font-size:14px;text-align:center;line-height:18px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >K7现房去化率</span>
        </p>
        <p style="font-size:11px;text-align:left;line-height:16px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑'';font-weight:400;">1.竣备时未签约货值</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||FN_DWN_AmountToBillionYuan(AllEhSaleMoney)||'</span><span style="font-family:''微软雅黑'';font-weight:400;">，竣备后签约货值</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||FN_DWN_AmountToBillionYuan(AllEhSaleOutMoney)||'</span><span style="font-family:''微软雅黑'';font-weight:400;">，现房去化率</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k4RateByMoney||'</span><span style="font-family:''微软雅黑'';font-weight:400;">；剩余现房货值</span><span style="font-family:''微软雅黑'';font-weight:400;color:#E68CB2;">'||FN_DWN_AmountToBillionYuan(AllEhSurplusSaleMoney)||'</span><span style="font-family:''微软雅黑'';font-weight:400;">。</span>
        </p>';
    k4_1:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">竣备时未签约货值</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||FN_DWN_AmountToBillionYuan(AllEhSaleMoney)||'</span><span style="font-family:''微软雅黑'';font-weight:400;">，竣备后签约货值</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||FN_DWN_AmountToBillionYuan(AllEhSaleOutMoney)||'</span><span style="font-family:''微软雅黑'';font-weight:400;">，现房去化率</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k4RateByMoney||'</span><span style="font-family:''微软雅黑'';font-weight:400;">；剩余现房货值</span><span style="font-family:''微软雅黑'';font-weight:400;color:#E68CB2;">'||FN_DWN_AmountToBillionYuan(AllEhSurplusSaleMoney)||'</span><span style="font-family:''微软雅黑'';font-weight:400;">。</span></p>';

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k4';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k4,MODIFIED=sysdate,SORT=7 where code='k4';
    dbms_output.put_line('update----'||k4);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k4',k4,7,'BigDataBriefing',sysdate);
    dbms_output.put_line('insert------'||k4);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k4.1';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k4_1,MODIFIED=sysdate where code='k4.1';
     dbms_output.put_line('update----'||k4_1);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k4.1',k4_1,11,'k4',sysdate);
    dbms_output.put_line('insert----'||k4_1);  
end if;

commit;
end P_DWM_briefingUpdateByK4;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_BRIEFINGUPDATEBYK5
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_BRIEFINGUPDATEBYK5" 
AS  
k5 clob:='';
k5_1 clob:='';
k5RateByMoney clob:='0%';
k5SaleOutByMoney varchar(50):='0亿';
k5SaleByMoney varchar(50):='0亿';
k5RemainingValue varchar(50):='0亿';
k5RemainingValueByParkingSpace varchar(50):='0亿';
k5RemainingValueByParkingBusin varchar(50):='0亿';
k5RemainingValueByParkingHouse varchar(50):='0亿';
k5ProjectNamesBySaleArea clob:='';
k5ProjectNamesBySaleOutArea clob:='';
k5ProjectNamesByRemainingValue clob:='';
k5tNamesRemainingValueByTop clob:='';
appearindex number;
ROWCOUNT number;
begin
select case when sum(SI_SALE_MONEY) <> 0 then fn_ConvertDecimalToPercentage(sum(SI_SALE_OUT_MONEY)/sum(SI_SALE_MONEY)) else  fn_ConvertDecimalToPercentage(0.0) end into  k5RateByMoney
from    dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id; 

select FN_DWN_AmountToBillionYuan(sum(SI_SALE_MONEY)) into k5SaleByMoney
from    dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id; 

select FN_DWN_AmountToBillionYuan(sum(SI_SALE_OUT_MONEY)) into k5SaleOutByMoney
from    dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id; 

select FN_DWN_AmountToBillionYuan(sum(SI_SALE_MONEY)-sum(SI_SALE_OUT_MONEY)) into k5RemainingValue
from    dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id; 

if k5SaleByMoney <> '0亿' then
select listagg(project_name||FN_DWN_AmountToBillionYuan(SI_SALE_MONEY),'、') WITHIN GROUP (ORDER BY SI_SALE_MONEY desc) into  k5ProjectNamesBySaleArea  from (select dwm_sale_rate_project.project_name,case when SI_SALE_MONEY is null or SI_SALE_MONEY=0 then 0.0 else SI_SALE_MONEY end as SI_SALE_MONEY
from  dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where SI_SALE_MONEY is not null and SI_SALE_MONEY <>0  )tab;
end if;
if k5SaleOutByMoney <> '0亿' then
select listagg(project_name||FN_DWN_AmountToBillionYuan(SI_SALE_OUT_MONEY),'、') WITHIN GROUP (ORDER BY SI_SALE_OUT_MONEY desc) into  k5ProjectNamesBySaleOutArea  from (select dwm_sale_rate_project.project_name,case when SI_SALE_OUT_MONEY is null or SI_SALE_OUT_MONEY=0 then 0.0 else SI_SALE_OUT_MONEY end as SI_SALE_OUT_MONEY
from  dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where SI_SALE_OUT_MONEY is not null and SI_SALE_OUT_MONEY <>0  )tab;
end if;
if k5RemainingValue <> '0亿' then
select listagg(project_name||FN_DWN_AmountToBillionYuan(RemainingValue),'、') WITHIN GROUP (ORDER BY RemainingValue desc)  into  k5ProjectNamesByRemainingValue from (select dwm_sale_rate_project.project_name,SI_SALE_MONEY-SI_SALE_OUT_MONEY as RemainingValue
from  dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where SI_SALE_OUT_MONEY is not null )tab where tab.RemainingValue <> 0;
end if;

if k5ProjectNamesByRemainingValue is not null then
appearindex:=INSTR(k5ProjectNamesByRemainingValue,'、');
k5tNamesRemainingValueByTop:=substr(k5ProjectNamesByRemainingValue,0,appearindex-1);
 dbms_output.put_line('----'||k5tNamesRemainingValueByTop);  
k5ProjectNamesByRemainingValue:=substr(k5ProjectNamesByRemainingValue,appearindex,length(k5ProjectNamesByRemainingValue));
 dbms_output.put_line('----'||k5ProjectNamesByRemainingValue);  
end if;

k5:='  <center>
          <span
            style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;font-size: 36px;color: #FF9900;"
            >'||k5RateByMoney||'</span
          >
        </center>
         <p style="font-size:14px;text-align:center;line-height:18px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"> K5、顽固性库存去化率</span>
        </p>
        <p style="font-size:11px;line-height:16px;margin-bottom:0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >1、年初顽固性库存为'||k5SaleByMoney||'。</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">'||k5ProjectNamesBySaleArea||'。</span>
        </p>
        <p style="font-size:11px;line-height:16px;margin-bottom:0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >2、今年已去化顽固性库存'||k5SaleOutByMoney||'，去化率'||k5RateByMoney||'：</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">'||k5ProjectNamesBySaleOutArea||'。</span>
        </p>
        <p style="font-size:11px;line-height:16px;margin-bottom:0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >3、剩余顽固性库存'||k5RemainingValue||'：</span
          >
        </p>
        <p style="font-size:11px;line-height:16px;margin-bottom:0px;">
          <span style="font-family:''微软雅黑'';font-weight:400;"> </span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#FF99CC;">'||k5tNamesRemainingValueByTop||'</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">'||k5ProjectNamesByRemainingValue||'。</span>
        </p>';
    k5_1:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">年初顽固性库存</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k5SaleByMoney||'</span><span style="font-family:''微软雅黑'';font-weight:400;">，本年已去化</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k5SaleOutByMoney||'</span><span style="font-family:''微软雅黑'';font-weight:400;">，去化率</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k5RateByMoney||'</span><span style="font-family:''微软雅黑'';font-weight:400;">；剩余顽固性库存</span><span style="font-family:''微软雅黑'';font-weight:400;color:#E68CB2;">'||k5RemainingValue||'</span><span style="font-family:''微软雅黑'';font-weight:400;">。</span></p>';

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k5';
if rowCount <> 0 then
    delete from DWM_SALE_RATE_DATA_BRIEFING where code ='k5';
    dbms_output.put_line('update--k5----'||k5);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k5.1';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k5_1,MODIFIED=sysdate where code='k5.1';
     dbms_output.put_line('update--k5.1----'||k5_1);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k5.1',k5_1,11,'k5',sysdate);
    dbms_output.put_line('insert--k5.1----'||k5_1);  
end if;

commit;
end P_DWM_briefingUpdateByK5;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_CHARTFILTER_CR_CROY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_CHARTFILTER_CR_CROY" 
(
 type_name in varchar2,
  orgFilter OUT sys_refcursor 
, title OUT string 
, orgTitle  OUT string 
) AS 
BEGIN
  open orgFilter for 
    SELECT id "orgId" ,org_name "orgName",case WHEN rownum=1 THEN 1 ELSE 0
        END AS "isCheck"
    FROM 
        (SELECT orgs.* FROM (SELECT ID,org_name,order_hierarchy_code FROM SYS_BUSINESS_UNIT
            WHERE LEVEL_RANK=1
            UNION
            SELECT ID,org_name,order_hierarchy_code
            FROM (SELECT ORG_ID
                FROM DWM_SALE_RATE_BY_ORG where X_AXIS_PERIOD IS NOT NULL AND PO_SALE_OUT_COUNT <> 0
                GROUP BY  ORG_ID) tab
                LEFT JOIN SYS_BUSINESS_UNIT
                    ON tab.ORG_ID=SYS_BUSINESS_UNIT.ID
                WHERE SYS_BUSINESS_UNIT.LEVEL_RANK=2 ) orgs ORDER BY  orgs.order_hierarchy_code)tab;	  
  if  type_name is null or type_name='cr' then 
     orgTitle:='二级单位';
     title:='竣工备案去化率变动趋势';
   else
      title := '竣工备案一年后去化率变动趋势';
      orgTitle := '二级单位';
   end if;
END P_DWM_CHARTFILTER_CR_CROY;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_CHARTFILTER_FM_FOHY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_CHARTFILTER_FM_FOHY" 
(
 type_name in varchar2,
  orgFilter OUT sys_refcursor 
, typeFilter OUT sys_refcursor 
, title OUT string 
, typeTitle  OUT string
, orgTitle  OUT string 
) AS 
-- Author:吴洋  Date:2020/12/9  首月去化率和首开半年去化率 趋势图筛选条件,去化率类型 和 二级单位
BEGIN
  open orgFilter for 
    SELECT id "orgId" ,org_name "orgName",case WHEN rownum=1 THEN 1 ELSE 0
        END AS "isCheck"
    FROM 
        (SELECT orgs.* FROM (SELECT ID,org_name,order_hierarchy_code FROM SYS_BUSINESS_UNIT
            WHERE LEVEL_RANK=1
            UNION
            SELECT ID,org_name,order_hierarchy_code
            FROM (SELECT ORG_ID
                FROM DWM_SALE_RATE_BY_ORG where X_AXIS_PERIOD IS NOT NULL AND PO_SALE_OUT_COUNT <> 0
                GROUP BY  ORG_ID) tab
                LEFT JOIN SYS_BUSINESS_UNIT
                    ON tab.ORG_ID=SYS_BUSINESS_UNIT.ID
                WHERE SYS_BUSINESS_UNIT.LEVEL_RANK=2 ) orgs ORDER BY  orgs.order_hierarchy_code)tab;	    
  if  type_name is null or type_name='fm' then
  open typeFilter for 
        select '按面积' as "name", 'area' as "typeName", 0 as "isCheck" from dual
        union
        select '按货值' as "name", 'money' as "typeName", 0 as "isCheck" from dual
        union
        select '按套数' as "name", 'count' as "typeName", 1 as "isCheck" from dual;      
   title := '首月去化率变动趋势';
   typeTitle := '去化率类型';
   orgTitle := '二级单位';
   else
    title := '首开半年去化率变动趋势';
    typeTitle := '去化率类型';
    orgTitle := '二级单位';
     open typeFilter for 
        select '按面积' as "name", 'area' as "typeName", 0 as "isCheck" from dual
        union
        select '按货值' as "name", 'money' as "typeName", 1 as "isCheck" from dual
        union
        select '按套数' as "name", 'count' as "typeName", 0 as "isCheck" from dual;    
   end if;
END P_DWM_CHARTFILTER_FM_FOHY;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_CHARTFILTER_K1
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_CHARTFILTER_K1" 
(
  orgFilter OUT sys_refcursor 
, typeFilter OUT sys_refcursor 
, title OUT string 
, abstract OUT string
, typeTitle  OUT string
, orgTitle  OUT string 
) AS 
BEGIN
  open orgFilter for 
        select ID as "orgId", ORG_NAME as "orgName", KEY as "isCheck" from(
        select * from (select ID, ORG_NAME, 1 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        union
        select ID, ORG_NAME, 0 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 and ID not in (
        select ID from (select ID from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        )) order by ORDER_HIERARCHY_CODE asc;
  open typeFilter for 
        select '按面积' as "name", 'area' as "typeName", 0 as "isCheck" from dual
        union
        select '按货值' as "name", 'money' as "typeName", 0 as "isCheck" from dual
        union
        select '按套数' as "name", 'count' as "typeName", 1 as "isCheck" from dual;      
   title := '首开去化率变动趋势';
   abstract := '';
   typeTitle := '去化率类型';
   orgTitle := '二级单位';
END P_DWM_CHARTFILTER_K1;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_CHARTFILTER_K1K3
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_CHARTFILTER_K1K3" 
(
 type_name in varchar2,
  orgFilter OUT sys_refcursor 
, typeFilter OUT sys_refcursor 
, title OUT string 
, typeTitle  OUT string
, orgTitle  OUT string 
) AS 
BEGIN
  open orgFilter for 
        SELECT id "orgId" ,org_name "orgName",case WHEN rownum=1 THEN 1 ELSE 0
        END AS "isCheck"
    FROM 
        (SELECT orgs.* FROM (SELECT ID,org_name,order_hierarchy_code FROM SYS_BUSINESS_UNIT
            WHERE LEVEL_RANK=1
            UNION
            SELECT ID,org_name,order_hierarchy_code
            FROM (SELECT ORG_ID
                FROM DWM_SALE_RATE_BY_ORG where X_AXIS_PERIOD IS NOT NULL AND PO_SALE_OUT_COUNT <> 0
                GROUP BY  ORG_ID) tab
                LEFT JOIN SYS_BUSINESS_UNIT
                    ON tab.ORG_ID=SYS_BUSINESS_UNIT.ID
                WHERE SYS_BUSINESS_UNIT.LEVEL_RANK=2 ) orgs ORDER BY  orgs.order_hierarchy_code)tab;
  if  type_name is null or type_name='k1' then
  open typeFilter for 
        select '按面积' as "name", 'area' as "typeName", 0 as "isCheck" from dual
        union
        select '按货值' as "name", 'money' as "typeName", 0 as "isCheck" from dual
        union
        select '按套数' as "name", 'count' as "typeName", 1 as "isCheck" from dual;      
   title := '首开去化率变动趋势';
   typeTitle := '去化率类型';
   orgTitle := '二级单位';
   else
    title := '"全案已取证去化率"变动趋势';
    typeTitle := '去化率类型';
    orgTitle := '二级单位';
     open typeFilter for 
        select '按面积' as "name", 'area' as "typeName", 0 as "isCheck" from dual
        union
        select '按货值' as "name", 'money' as "typeName", 1 as "isCheck" from dual
        union
        select '按套数' as "name", 'count' as "typeName", 0 as "isCheck" from dual;    
   end if;
END P_DWM_CHARTFILTER_K1K3;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_CHARTFILTER_K2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_CHARTFILTER_K2" (orgFilter out sys_refcursor,orgTitle out varchar,title out varchar)
as
begin
orgTitle:='二级单位';
title:='“拿地至首开时间”  变动趋势      (单位：月)';

open orgFilter for 
select id "orgId" ,org_name  "orgName",
case when id='c4571e06-dc50-4780-b663-9d3d358f4888' then
1 else 0 end as "isCheck"
from SYS_BUSINESS_UNIT where LEVEL_RANK=2   order by order_hierarchy_code;

end P_DWM_ChartFilter_K2;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_CHARTFILTER_K2K4K5
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_CHARTFILTER_K2K4K5" 
(
 type_name in varchar2,
  orgFilter OUT sys_refcursor 
, title OUT string 
, orgTitle  OUT string 
) AS 
BEGIN
  open orgFilter for 
        SELECT id "orgId" ,org_name "orgName",case WHEN rownum=1 THEN 1 ELSE 0
        END AS "isCheck"
    FROM 
        (SELECT orgs.* FROM (SELECT ID,org_name,order_hierarchy_code FROM SYS_BUSINESS_UNIT
            WHERE LEVEL_RANK=1
            UNION
            SELECT ID,org_name,order_hierarchy_code
            FROM (SELECT ORG_ID
                FROM DWM_SALE_RATE_BY_ORG where X_AXIS_PERIOD IS NOT NULL AND PO_SALE_OUT_COUNT <> 0
                GROUP BY  ORG_ID) tab
                LEFT JOIN SYS_BUSINESS_UNIT
                    ON tab.ORG_ID=SYS_BUSINESS_UNIT.ID
                WHERE SYS_BUSINESS_UNIT.LEVEL_RANK=2 ) orgs ORDER BY  orgs.order_hierarchy_code)tab;
  if  type_name is null or type_name='k2' then 
     orgTitle:='二级单位';
     title:='“拿地至首开时间”  变动趋势      (单位：月)';
   elsif type_name='k4_2' then 
      title := '现房去化率变动趋势';
      orgTitle := '二级单位';
   elsif type_name='k4_3' then 
     title := '剩余现房货值变动趋势 (单位:亿元)';
     orgTitle := '二级单位';
   elsif  type_name='k5_2' then 
     title := '顽固性库存去化率变动趋势图';
     orgTitle := '二级单位';
   elsif  type_name='k5_3' then 
     title := '"剩余顽固性库存"变动趋势 (单位:亿元)';
     orgTitle := '二级单位';
   end if;
END P_DWM_CHARTFILTER_K2k4k5;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_CHARTFILTER_K3
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_CHARTFILTER_K3" 
(
  orgFilter OUT sys_refcursor 
, typeFilter OUT sys_refcursor 
, typeTitle OUT string 
, orgTitle  OUT string
, title  OUT string 
)  AS 
BEGIN
  open orgFilter for 
        select ID as "orgId", ORG_NAME as "orgName", KEY as "isCheck" from(
        select * from (select ID, ORG_NAME, 1 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        union
        select ID, ORG_NAME, 0 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 and ID not in (
        select ID from (select ID from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        )) order by ORDER_HIERARCHY_CODE asc;
  open typeFilter for 
        select '按面积' as "name", 'area' as "typeName", 0 as "isCheck" from dual
        union
        select '按货值' as "name", 'money' as "typeName", 1 as "isCheck" from dual
        union
        select '按套数' as "name", 'count' as "typeName", 0 as "isCheck" from dual;
   title := '"全案已取证去化率"变动趋势';
   typeTitle := '去化率类型';
   orgTitle := '二级单位';
END P_DWM_CHARTFILTER_K3;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_CHARTFILTER_K4_2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_CHARTFILTER_K4_2" 
(
  orgfilter OUT sys_refcursor 
, title OUT string 
, orgtitle OUT string 
) AS 
BEGIN
  open orgfilter for 
       select ID as "orgId", ORG_NAME as "orgName", KEY as "isCheck" from(
        select * from (select ID, ORG_NAME, 1 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        union
        select ID, ORG_NAME, 0 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 and ID not in (
        select ID from (select ID from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        )) order by ORDER_HIERARCHY_CODE asc;
  title := '现房去化率变动趋势';
  orgTitle := '二级单位';
END P_DWM_CHARTFILTER_K4_2;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_CHARTFILTER_K4_3
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_CHARTFILTER_K4_3" 
(
  orgfilter OUT sys_refcursor 
, title OUT string 
, orgtitle OUT string  
) AS 
BEGIN
  open orgfilter for 
       select ID as "orgId", ORG_NAME as "orgName", KEY as "isCheck" from(
        select * from (select ID, ORG_NAME, 1 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        union
        select ID, ORG_NAME, 0 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 and ID not in (
        select ID from (select ID from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        )) order by ORDER_HIERARCHY_CODE asc;
  title := '剩余现房货值变动趋势 (单位:亿元)';
  orgTitle := '二级单位';
END P_DWM_CHARTFILTER_K4_3;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_CHARTFILTER_K5_2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_CHARTFILTER_K5_2" 
(
  orgfilter OUT sys_refcursor 
, title OUT string 
, orgtitle OUT string 
) AS 
BEGIN
  open orgfilter for 
        select ID as "orgId", ORG_NAME as "orgName", KEY as "isCheck" from(
        select * from (select ID, ORG_NAME, 1 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        union
        select ID, ORG_NAME, 0 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 and ID not in (
        select ID from (select ID from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        )) order by ORDER_HIERARCHY_CODE asc;
  title := '顽固性库存去化率变动趋势图';
  orgTitle := '二级单位';
END P_DWM_CHARTFILTER_K5_2;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_CHARTFILTER_K5_3
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_CHARTFILTER_K5_3" 
(
  orgfilter OUT sys_refcursor 
, title OUT string 
, orgtitle OUT string 
) AS 
BEGIN
  open orgfilter for 
        select ID as "orgId", ORG_NAME as "orgName", KEY as "isCheck" from(
            select * from (select ID, ORG_NAME, 1 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
            union
            select ID, ORG_NAME, 0 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 and ID not in (
        select ID from (select ID from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        )) order by ORDER_HIERARCHY_CODE asc;
  title := '"剩余顽固性库存"变动趋势 (单位:亿元)';
  orgTitle := '二级单位';
END P_DWM_CHARTFILTER_K5_3;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_COMPANY_PROJ_SITUATION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_COMPANY_PROJ_SITUATION" (
    USERID IN VARCHAR2,
    STATIONID IN VARCHAR2,
    DEPTID IN VARCHAR2,
    COMPANYID IN VARCHAR2,
    BIZCODE IN VARCHAR2 ,
    wacthinfo OUT SYS_REFCURSOR
) AS
    --动态货值首页-项目货值概况
--作者：陈丽
--日期：2019/11/13
-- 黄伟：2019-12-26修正过本脚本
    RULEVALUE varchar2(50);
    AUTHCOUNT INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    SPID VARCHAR2(36);--使用临时表的批次号
    data_auth_spid   VARCHAR2(200);
    authCode VARCHAR2(50);---- 权限编码
BEGIN
    --权限查询
    authCode := 'DWM.DTHZGL.03';
    p_sys_get_company_tree_spid(userid => USERID, stationid => STATIONID, deptid => DEPTID, companyid => COMPANYID, bizcode
        => authCode, data_auth_spid => data_auth_spid);
    open wacthinfo for
        with tm1 as (
            select * from SYS_BUSINESS_UNIT
            where ID in (select ORG_ID from TMP_COMPANY_TREE where id = data_auth_spid)
        ), tm2 as (
            select distinct t1.*
            from tm1 t1 where not exists(select 1 from tm1 where tm1.PARENT_ID = t1.ID)
        ), tm3 as (
            select * from SYS_BUSINESS_UNIT sbu
            where sbu.IS_COMPANY=1
            start with ID in (select ID from tm2 )
            connect by prior sbu.ID = sbu.PARENT_ID
        ), tm4 as (
            select * from SYS_BUSINESS_UNIT sbu
            where sbu.IS_COMPANY=1
            start with ID in (select ID from tm2 )
            connect by prior sbu.PARENT_ID = sbu.ID
        ), tm5 as (
            SELECT
                A.order_hierarchy_code, -- 对象全路径排序编码
                A.orgId    AS id,--组织id
                A.orgName            AS orgName,--组织名称名称
                lower(A.parentId) AS parentsId,--父级id
                A.Proj_Code,
                (CASE  WHEN A.orgType = 10 THEN 1  ELSE 0  END) AS projTotal,
                round((CASE
                           WHEN X.PROJ_ID IS NOT NULL AND NVL(X.TARGET_WORTH,0)>0 THEN
                               X.TARGET_WORTH
                           WHEN Y.PROJ_ID IS NOT NULL AND NVL(Y.TARGET_WORTH,0)>0 THEN
                               Y.TARGET_WORTH
                           WHEN Z.PROJ_ID IS NOT NULL AND NVL(Z.TARGET_WORTH,0)>0 THEN
                               Z.TARGET_WORTH
                           ELSE   0  END)/10000,2)  AS newestWorth,    -- 最新目标货值
                --E.VALUE_DT_ALL,E.VALUE_IN_PROCESS,E.VALUE_STOCK,E.VALUE_HAVED_SALE
                round(DT.VALUE_DT_ALL_OPT/100000000,2) AS dynamicWorth,  -- 动态总货值
                round(DT.VALUE_RESERVE/100000000,2) AS reserveWorth,      -- 储备货值
--    round(22,2)    as InTransitWorth,  -- 在途货值
                round(nvl(DT.VALUE_IN_PROCESS,0)/100000000,2)    as InTransitWorth,  -- 在途货值
--    round(DT.VALUE_IN_PROCESS/100000000,2) as InTransitWorth,
                round(DT.VALUE_STOCK/100000000,2) AS inventoryWorth,       -- 库存货值
                round(DT.VALUE_HAVED_SALE/100000000,2) AS explaination,  -- 已售货值
                '/dwm/value-manage/dynamic-value/value-monitor' AS jumpUrl
            FROM(
                SELECT
                    t.order_hierarchy_code,-- 对象全路径排序编码
                    t.project_original_id     orgId,--组织id
                    t.project_name            AS orgName,--组织名称名称
                    t.org_type                AS orgType,--组织类型 0公司，1项目
                    t.Proj_Code,
                    lower(t.parent_id) AS parentId--父级id
                FROM(
                    SELECT
                        mdm_project.order_hierarchy_code,-- 对象全路径排序编码
                        mdm_project.project_original_id,
                            project_name||(CASE WHEN proj_cooperate='不操盘' THEN '（非操盘）' ELSE ''END) AS project_Name,
                        mdm_phase.phase_name   AS proj_phase,
                        phase.phase_id,
                        phase.id               AS proj_phase_id,
                        Project_Code AS Proj_Code,
                        10 AS org_type,
                        CASE WHEN phase.phase_id IS NULL THEN 0 ELSE 1 END AS is_exist_proj_phase,
                        company_id             AS parent_id,
                        mdm_obj_phase_index.total_site_area,
                        mdm_obj_phase_index.overall_floorage_area,
                        mdm_obj_phase_index.total_sale_area,
                        mdm_obj_phase_index.total_capacity_area
                    FROM mdm_project left JOIN (
                        SELECT t1.id, t1.phase_id, t1.proj_id, t2.phase_order
                        FROM mdm_project_phase t1 LEFT JOIN (
                            SELECT proj_id, MAX(phase_order) AS phase_order
                            FROM mdm_project_phase
                            GROUP BY proj_id
                        ) t2 ON t1.proj_id = t2.proj_id AND t1.phase_order = t2.phase_order
                        WHERE t2.phase_order IS NOT NULL
                    ) phase ON mdm_project.project_original_id = phase.proj_id
                             LEFT JOIN mdm_phase ON phase.phase_id = mdm_phase.id
                             LEFT JOIN mdm_obj_phase_index ON phase.id = mdm_obj_phase_index.obj_phase_id
                        AND mdm_obj_phase_index.obj_type = 0
                    WHERE approval_status = '已审核'
                    UNION ALL
                    SELECT
                        tm.order_hierarchy_code,-- 对象全路径排序编码
                        id,
                        org_name,
                        '' AS proj_phase,
                        '' AS phase_id,
                        '' AS proj_phase_id,
                        '' AS Proj_Code,
                        0 org_type,
                        NULL is_exist_proj_phase,
                        parent_id,
                        0 AS "totalSiteArea",
                        0 AS "overallFloorageArea",
                        0 AS "totalSalableArea",
                        0 AS "totalCapacityArea"
                    FROM (select * from tm3 union select * from tm4) tm WHERE org_type = 0
                                                                          AND (id != '000100000000000000000000000000' AND id != '000200000000000000000000000000')
                ) t
            )A LEFT JOIN (
                SELECT A.PROJ_ID,A.TARGET_WORTH
                FROM DWM_TARGET_WORTH A RIGHT JOIN (
                    SELECT D.PROJ_ID,D.TARGET_WORTH_PHASE,MAX(WORTH_V) AS WORTH_V
                    FROM DWM_TARGET_WORTH D
                    WHERE D.IS_DELETE = 0 AND D.APPROVAL_STATUS IN ('审核中', '已审核') AND D.TARGET_WORTH_PHASE = 20
                    GROUP BY D.PROJ_ID,D.TARGET_WORTH_PHASE
                )A1 ON A.PROJ_ID = A1.PROJ_ID AND A.WORTH_V = A1.WORTH_V
                    AND A.TARGET_WORTH_PHASE = A1.TARGET_WORTH_PHASE
                where a1.worth_v is not null and a.is_delete = 0
                  AND a.approval_status IN ('审核中','已审核') AND a.target_worth_phase = 20
            )X ON A.orgId = X.PROJ_ID LEFT JOIN (
                SELECT B.PROJ_ID,B.TARGET_WORTH FROM DWM_TARGET_WORTH B RIGHT JOIN (
                    SELECT D.ID,D.PROJ_ID,MAX(APPROVAL_TIME)
                    FROM DWM_TARGET_WORTH D
                    WHERE D.IS_DELETE = 0 AND D.APPROVAL_STATUS IN ('审核中', '已审核') AND D.TARGET_WORTH_PHASE = 10
                    GROUP BY D.ID,D.PROJ_ID) B1 ON B.ID = B1.ID
            )Y ON A.orgId = Y.PROJ_ID LEFT JOIN (
                SELECT C.PROJ_ID,C.TARGET_WORTH
                FROM DWM_TARGET_WORTH C  RIGHT JOIN(
                    SELECT ID,D.PROJ_ID,MAX(APPROVAL_TIME)
                    FROM DWM_TARGET_WORTH D
                    WHERE D.IS_DELETE = 0 AND D.APPROVAL_STATUS IN ('审核中', '已审核') AND D.TARGET_WORTH_PHASE = 0
                    GROUP BY D.ID,D.PROJ_ID
                ) C1 ON C.ID = C1.ID
            )Z ON A.orgId = Z.PROJ_ID LEFT JOIN (
                SELECT E.OBJ_ID,E.VALUE_DT_ALL
                     ,(E.Value_Reserve+E.VALUE_IN_PROCESS+E.VALUE_STOCK+E.VALUE_HAVED_SALE) AS VALUE_DT_ALL_OPT
                     ,E.Value_Reserve,E.VALUE_IN_PROCESS,E.VALUE_STOCK,E.VALUE_HAVED_SALE FROM DWM_DT_VALUE E
                WHERE E.Obj_Type='项目'
            )DT ON A.orgId = DT.OBJ_ID
            ORDER BY A.order_hierarchy_code,A.proj_Code
        )
        select * from tm5
        where tm5.id in (select ID from tm3 union select ID from tm4) or parentsId in (select ID from tm4);
END p_dwm_company_proj_situation;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_COMPANY_WORTH_SITUATION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_COMPANY_WORTH_SITUATION" (wacthinfo OUT sys_refcursor)
AS  
--首页-公司可售货值情况（树列表）
--作者：陈丽
--日期：2019/11/13
BEGIN  
open wacthinfo for  
select 
'A' as "id",
'' as "parentsId",
'A项目' as "orgName",
'300' as  "projTotal",
'1000' as "dynamicWorth", 
'111' as "reserveWorth", 
'111' as "wayWorth", 
'111' as "inventoryWorth",
'111' as "jumpUrl"
from dual
union all
select
'B' as "id",
'' as "parentsId",
'A项目' as "orgName",
'300' as  "projTotal",
'1000' as "dynamicWorth", 
'111' as "reserveWorth", 
'111' as "wayWorth", 
'111' as "inventoryWorth",
'111' as "jumpUrl"
from dual
union all
select 
'A1' as "id",
'A' as "parentsId",
'A项目' as "orgName",
'300' as  "projTotal",
'1000' as "dynamicWorth", 
'111' as "reserveWorth", 
'111' as "wayWorth", 
'111' as "inventoryWorth",
'111' as "jumpUrl"
from dual
union all
select 
'A2' as "id",
'A' as "parentsId",
'A项目' as "orgName",
'300' as  "projTotal",
'1000' as "dynamicWorth", 
'111' as "reserveWorth", 
'111' as "wayWorth", 
'111' as "inventoryWorth",
'111' as "jumpUrl"
from dual;
END P_DWM_COMPANY_WORTH_SITUATION;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DATALIST_K2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_DATALIST_K2" 
(
  sortField IN VARCHAR2
, orderBy IN VARCHAR2 
, rowNumber IN number
, k2DataList OUT sys_refcursor 
) AS 
whereStr varchar2(500):='';
v_sql clob :='';
-- 用于返回筛选的列
v_column clob :='';
-- 用于解决排序字段有span标签问题
sortStr varchar2(100):='';
BEGIN
  sortStr := sortField;
  if sortStr = 'firstOpenDurationByPlan' then
    sortStr := 'FIRST_OPEN_DURATION_BY_PLAN';
  elsif sortStr = 'firstOpenDate' then
    sortStr := 'FIRST_OPEN_DATE';
  elsif sortStr = 'takeLandDate' then
    sortStr := 'TAKE_LAND_DATE'; 
  elsif sortStr = 'planFirstOpenDate' then
    sortStr := 'PLAN_FIRST_OPEN_DATE';  
  elsif sortStr = 'firstOpenDurationByTL' then
    sortStr := 'FIRST_OPEN_DURATION_BY_TL';
  elsif sortStr = 'projectName' then
    sortStr := 'projectNameCopy';  
  end if;
  v_sql:='select 
        NVL(FIRST_OPEN_DURATION_BY_PLAN,0) as "FIRST_OPEN_DURATION_BY_PLAN",
        FIRST_OPEN_DATE,
        TAKE_LAND_DATE,
        PLAN_FIRST_OPEN_DATE,
        NVL(FIRST_OPEN_DURATION_BY_TL,0) as "FIRST_OPEN_DURATION_BY_TL",

        PROJECT_NAME as "projectNameCopy",
        FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_PLAN) as "firstOpenDurationByPlanCopy",
        FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_TL) as "firstOpenDurationByTLCopy",
        to_char(FIRST_OPEN_DATE,''yyyy-mm-dd'') as "firstOpenDateCopy",
        Fn_DWM_DurationDaysDeal(PLAN_FIRST_OPEN_DATE, FIRST_OPEN_DATE, ''pure'') as "advanceFirstOpenDateCopy",

        PROJECT_ID as "projectId", 
        FN_DWM_FONT_COLOR(PROJECT_NAME) as "projectName",
        FN_DWM_FONT_COLOR(FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_TL)) as "firstOpenDurationByTL",
        FN_DWM_FONT_COLOR(to_char(FIRST_OPEN_DATE,''yyyy-mm-dd'')) as "firstOpenDate",
        to_char(TAKE_LAND_DATE,''yyyy-mm-dd'') as "takeLandDate",
        to_char(PLAN_FIRST_OPEN_DATE,''yyyy-mm-dd'') as "planFirstOpenDate",
        FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_PLAN) as "firstOpenDurationByPlan",
        Fn_DWM_DurationDaysDeal(PLAN_FIRST_OPEN_DATE, FIRST_OPEN_DATE, ''label'') as "advanceFirstOpenDate"
    from DWM_SALE_RATE_PROJECT 
    where TO_DATE(trunc(sysdate,''yyyy'')) <= FIRST_OPEN_DATE';
  v_column := ' "projectId",
      "projectName",
      "firstOpenDurationByPlan",
      "firstOpenDate",
      "takeLandDate",
      "planFirstOpenDate",
      "firstOpenDurationByTL",
      "advanceFirstOpenDate",
      "projectNameCopy", 
      "firstOpenDurationByPlanCopy",
      "firstOpenDateCopy",
      "advanceFirstOpenDateCopy",
      "firstOpenDurationByTLCopy" ';
--    if rowNumber <> 0 then
--    whereStr:='where rownum<= ' || rowNumber;
--    end if;
    if sortStr is not null and orderBy is not null then
        whereStr:=whereStr||' order by tab."'||sortStr||'"  '||orderBy;
    end if;
    if whereStr is not null then
        v_sql:='select ' || v_column || ' from ('||v_sql||') tab '||whereStr;
    else
        v_sql:='select ' || v_column || ' from (' ||v_sql || ' )';
    end if;
    -- 选择前n条数据，rownum必须拼接在排序后面，不然会先运行rownum再运行排序，会导致筛选数据并不准确
    if rowNumber <> 0 then
        v_sql := 'select ' || v_column || ' from (' ||v_sql || ' )' || ' where rownum <= ' || rowNumber;
    end if;
    dbms_output.put_line(v_sql);
OPEN k2DataList FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE k2DataList;
END P_DWM_DATALIST_K2;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DATALIST_K3
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_DATALIST_K3" 
(
  sortField IN VARCHAR2
, orderBy IN VARCHAR2  
, rowNumber IN NUMBER
, appachAll IN NUMBER
, k3DataList OUT sys_refcursor
) AS
whereStr varchar2(500):='where 1 = 1 ';
v_sql clob :='';
-- 用于返回筛选的列
v_column clob :='';
-- 用于解决排序字段有span标签问题
sortStr varchar2(100):='';
BEGIN
  sortStr := sortField;
  if sortStr = 'firstOpenDate' then
    sortStr := 'FIRST_OPEN_DATE';
  elsif sortStr = 'poSaleRateByMoney' then
    sortStr := 'PO_SALE_RATE_BY_MONEY';
  elsif sortStr = 'poSaleMoney' then
    sortStr := 'PO_SALE_MONEY'; 
  elsif sortStr = 'poSaleOutMoney' then
    sortStr := 'PO_SALE_OUT_MONEY';  
  elsif sortStr = 'poSaleRateByCount' then
    sortStr := 'PO_SALE_RATE_BY_COUNT';
  elsif sortStr = 'poSaleCount' then
    sortStr := 'PO_SALE_COUNT';
  elsif sortStr = 'poSaleOutCount' then
    sortStr := 'PO_SALE_OUT_COUNT';
  elsif sortStr = 'poSaleRateByArea' then
    sortStr := 'PO_SALE_RATE_BY_AREA';
  elsif sortStr = 'poSaleArea' then
    sortStr := 'PO_SALE_AREA';
  elsif sortStr = 'poSaleOutArea' then
    sortStr := 'PO_SALE_OUT_AREA';
  elsif sortStr = 'projectName' then
    sortStr := 'projectNameCopy';  
  end if;
  v_sql:='select
        p.FIRST_OPEN_DATE as "FIRST_OPEN_DATE",
        NVL(sr.PO_SALE_RATE_BY_MONEY,0) as "PO_SALE_RATE_BY_MONEY",
        NVL(sr.PO_SALE_MONEY,0) as "PO_SALE_MONEY",
        NVL(sr.PO_SALE_OUT_MONEY,0) as "PO_SALE_OUT_MONEY",
        NVL(sr.PO_SALE_RATE_BY_COUNT,0) as "PO_SALE_RATE_BY_COUNT",
        NVL(sr.PO_SALE_COUNT,0) as "PO_SALE_COUNT",
        NVL(sr.PO_SALE_OUT_COUNT,0) as "PO_SALE_OUT_COUNT",
        NVL(sr.PO_SALE_RATE_BY_AREA,0) as "PO_SALE_RATE_BY_AREA",
        NVL(sr.PO_SALE_AREA,0) as "PO_SALE_AREA",
        NVL(sr.PO_SALE_OUT_AREA,0) as "PO_SALE_OUT_AREA",

        p.PROJECT_NAME as "projectNameCopy",
        FN_DWM_DEC_CONVERT_PCT(sr.PO_SALE_RATE_BY_MONEY) as "poSaleRateByMoneyCopy",
        FN_DWM_DEC_CONVERT_PCT(sr.PO_SALE_RATE_BY_COUNT) as "poSaleRateByCountCopy",
        FN_DWM_DEC_CONVERT_PCT(sr.PO_SALE_RATE_BY_AREA) as "poSaleRateByAreaCopy",

        p.PROJECT_ID as "projectId",
        FN_DWM_FONT_COLOR(p.PROJECT_NAME) as "projectName",
        to_char(p.FIRST_OPEN_DATE,''yyyy-mm-dd'') as "firstOpenDate",
        FN_DWM_FONT_LAYERED_COLOR(sr.PO_SALE_RATE_BY_MONEY, 0.9) as "poSaleRateByMoney",
        FN_DWM_MULTIPLE_AND_UNIT(sr.PO_SALE_MONEY, 100000000, ''亿'') as "poSaleMoney",
        FN_DWM_MULTIPLE_AND_UNIT(sr.PO_SALE_OUT_MONEY, 100000000, ''亿'') as "poSaleOutMoney",
        FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(sr.PO_SALE_RATE_BY_COUNT)) as "poSaleRateByCount",
        sr.PO_SALE_COUNT || ''套'' as "poSaleCount",
        sr.PO_SALE_OUT_COUNT || ''套'' as "poSaleOutCount",
        FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(sr.PO_SALE_RATE_BY_AREA)) as "poSaleRateByArea",
        FN_DWM_MULTIPLE_AND_UNIT(sr.PO_SALE_AREA, 10000, ''万方'') as "poSaleArea",
        FN_DWM_MULTIPLE_AND_UNIT(sr.PO_SALE_OUT_AREA, 10000, ''万方'') as "poSaleOutArea"
    from DWM_SALE_RATE_BY_PROJECT sr
    left join DWM_SALE_RATE_PROJECT p 
    on sr.PROJECT_ID = p.PROJECT_ID
    where p.PROJECT_NAME is not null';
  v_column := ' "projectId",
      "projectName",
      "firstOpenDate",
      "poSaleRateByMoney",
      "poSaleMoney",
      "poSaleOutMoney",
      "poSaleRateByCount",
      "poSaleCount",
      "poSaleOutCount", 
      "poSaleRateByArea",
      "poSaleArea",
      "poSaleOutArea",

      "projectNameCopy",
      "poSaleRateByMoneyCopy",
      "poSaleRateByCountCopy",
      "poSaleRateByAreaCopy"';
  if appachAll = 1 then
    whereStr := whereStr || ' and tab.PO_SALE_RATE_BY_MONEY <= 0.99 ';
  end if;
  if sortStr is not null and orderBy is not null then
    whereStr:=whereStr||' order by tab."'||sortStr||'"  '||orderBy;
  end if;
  if whereStr is not null then
    v_sql:='select ' || v_column || ' from ('||v_sql||') tab '||whereStr;
  else
    v_sql:='select ' || v_column || ' from (' ||v_sql || ' )';
  end if;
-- 选择前n条数据，rownum必须拼接在排序后面，不然会先运行rownum再运行排序，会导致筛选数据并不准确
  if rowNumber <> 0 then
    v_sql := 'select ' || v_column || ' from (' ||v_sql || ' )' || ' where rownum <= ' || rowNumber;
  end if;  
    dbms_output.put_line(v_sql);
OPEN k3DataList FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE k3DataList;   
END P_DWM_DATALIST_K3;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DATALIST_K4
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_DATALIST_K4" 
(
  sortField IN VARCHAR2 
, orderBy IN VARCHAR2 
, rowNumber IN number
, k4DataList OUT sys_refcursor 
) AS
whereStr varchar2(500):='where 1 = 1 ';
v_sql clob :='';
-- 用于返回筛选的列
v_column clob :='';
-- 用于解决排序字段有span标签问题
sortStr varchar2(100):='';
BEGIN
sortStr := sortField;
  if sortStr = 'completionRecordDate' then
    sortStr := 'COMPLETION_RECORD_DATE';
  elsif sortStr = 'ehSaleMoney' then
    sortStr := 'EH_SALE_MONEY';
  elsif sortStr = 'ehSaleOutMoney' then
    sortStr := 'EH_SALE_OUT_MONEY'; 
  elsif sortStr = 'ehSaleRateByMoney' then
    sortStr := 'EH_SALE_RATE_BY_MONEY';
  elsif sortStr = 'ehSurplusSaleMoney' then
    sortStr := 'EH_SURPLUS_MONEY';
  elsif sortStr = 'projectName' then
    sortStr := 'projectNameCopy';  
  end if;

  v_sql:= 'select
        p.COMPLETION_RECORD_DATE as "COMPLETION_RECORD_DATE",
        NVL(sa.EH_SALE_MONEY,0) as "EH_SALE_MONEY",
        NVL(sa.EH_SALE_OUT_MONEY,0) as "EH_SALE_OUT_MONEY",
        NVL(sa.EH_SALE_RATE_BY_MONEY,0) as "EH_SALE_RATE_BY_MONEY",
        NVL(sa.EH_SALE_MONEY - sa.EH_SALE_OUT_MONEY,0) as "EH_SURPLUS_MONEY",

        p.PROJECT_NAME as "projectNameCopy",
        fn_ConvertDecimalToPercentage(sa.EH_SALE_RATE_BY_MONEY) as "ehSaleRateByMoneyCopy",

        p.PROJECT_ID as "projectId",
        FN_DWM_FONT_COLOR(p.PROJECT_NAME) as "projectName",
        to_char(p.COMPLETION_RECORD_DATE,''yyyy-mm-dd'') as "completionRecordDate",
        FN_DWM_MULTIPLE_AND_UNIT(sa.EH_SALE_MONEY, 100000000, ''亿'') as "ehSaleMoney",
        FN_DWM_MULTIPLE_AND_UNIT(sa.EH_SALE_OUT_MONEY, 100000000, ''亿'') as "ehSaleOutMoney",
        FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(sa.EH_SALE_RATE_BY_MONEY)) as "ehSaleRateByMoney",
        FN_DWM_MULTIPLE_AND_UNIT((sa.EH_SALE_MONEY - sa.EH_SALE_OUT_MONEY), 100000000, ''亿'') as "ehSurplusSaleMoney"
    from DWM_SALE_RATE_PROJECT p 
    left join DWM_SALE_RATE_BY_PROJECT sa
    on sa.PROJECT_ID = p.PROJECT_ID
    where p.COMPLETION_RECORD_DATE is not null';
  v_column := ' "projectId",
      "projectName",
      "completionRecordDate",
      "ehSaleMoney",
      "ehSaleOutMoney",
      "ehSaleRateByMoney",
      "ehSurplusSaleMoney",

      "projectNameCopy",
      "ehSaleRateByMoneyCopy"';

--  if rowNumber <> 0 then
--    whereStr := whereStr || ' and rownum <= ' || rowNumber;
--  end if;
  if sortStr is not null and orderBy is not null then
    whereStr:= whereStr||' order by tab."'||sortStr||'"  '||orderBy || ' nulls last ';
  end if;
  if whereStr is not null then
    v_sql:='select ' || v_column || ' from ('||v_sql||') tab '||whereStr;
  else
    v_sql:='select ' || v_column || ' from (' ||v_sql || ' )';
  end if;
  -- 选择前n条数据，rownum必须拼接在排序后面，不然会先运行rownum再运行排序，会导致筛选数据并不准确
    if rowNumber <> 0 then
        v_sql := 'select ' || v_column || ' from (' ||v_sql || ' )' || ' where rownum <= ' || rowNumber;
    end if;
    dbms_output.put_line(v_sql);

OPEN k4DataList FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE k4DataList;
END P_DWM_DATALIST_K4;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DATALIST_K5
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_DATALIST_K5" 
(
  sortField IN VARCHAR2 
, orderBy IN VARCHAR2 
, rowNumber IN number 
, k5DataList OUT sys_refcursor 
) AS 
whereStr varchar2(500):='where 1 = 1 ';
v_sql clob :='';
-- 用于返回筛选的列
v_column clob :='';
-- 用于解决排序字段有span标签问题
sortStr varchar2(100):='';
BEGIN
sortStr := sortField;
  if sortStr = 'completionRecordDate' then
    sortStr := 'COMPLETION_RECORD_DATE';
  elsif sortStr = 'siSaleArea' then
    sortStr := 'SI_SALE_AREA';
  elsif sortStr = 'siSaleOutArea' then
    sortStr := 'SI_SALE_OUT_AREA'; 
  elsif sortStr = 'siSaleRateByArea' then
    sortStr := 'SI_SALE_RATE_BY_AREA';
  elsif sortStr = 'siSurplusSaleArea' then
    sortStr := 'SI_SURPLUS_AREA';
  elsif sortStr = 'projectName' then
    sortStr := 'projectNameCopy';
  elsif sortStr = 'siSaleMoney' then
    sortStr := 'SI_SALE_MONEY';
  elsif sortStr = 'siSaleOutMoney' then
    sortStr := 'SI_SALE_OUT_MONEY';
  elsif sortStr = 'siSaleRateByMoney' then
    sortStr := 'SI_SALE_RATE_BY_MONEY';
  elsif sortStr = 'siSurplusSaleMoney' then
    sortStr := 'SI_SURPLUS_SALE_MONEY';  
  end if;

  v_sql:= 'select
        p.COMPLETION_RECORD_DATE as "COMPLETION_RECORD_DATE",
        NVL(sa.SI_SALE_AREA,0) as "SI_SALE_AREA",
        NVL(sa.SI_SALE_OUT_AREA,0) as "SI_SALE_OUT_AREA",
        NVL(sa.SI_SALE_RATE_BY_AREA,0) as "SI_SALE_RATE_BY_AREA",
        NVL(sa.SI_SALE_AREA - sa.SI_SALE_OUT_AREA,0) as "SI_SURPLUS_AREA",
        NVL(sa.SI_SALE_MONEY,0) as "SI_SALE_MONEY",
        NVL(sa.SI_SALE_OUT_MONEY,0) as "SI_SALE_OUT_MONEY",
        NVL(sa.SI_SALE_RATE_BY_MONEY,0) as "SI_SALE_RATE_BY_MONEY",
        NVL(sa.SI_SURPLUS_SALE_MONEY,0) as "SI_SURPLUS_SALE_MONEY",

        p.PROJECT_NAME as "projectNameCopy",
        fn_ConvertDecimalToPercentage(sa.SI_SALE_RATE_BY_AREA) as "siSaleRateByAreaCopy",
        fn_ConvertDecimalToPercentage(sa.SI_SALE_RATE_BY_MONEY) as "siSaleRateByMoneyCopy",

        p.PROJECT_ID as "projectId",
        FN_DWM_FONT_COLOR(p.PROJECT_NAME) as "projectName",
        to_char(p.COMPLETION_RECORD_DATE,''yyyy-mm-dd'') as "completionRecordDate",
        FN_DWM_MULTIPLE_AND_UNIT(sa.SI_SALE_AREA, 10000, ''万方'') as "siSaleArea",
        FN_DWM_MULTIPLE_AND_UNIT(sa.SI_SALE_OUT_AREA, 10000, ''万方'') as "siSaleOutArea",
        FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(sa.SI_SALE_RATE_BY_AREA)) as "siSaleRateByArea",
        FN_DWM_MULTIPLE_AND_UNIT((sa.SI_SALE_AREA - sa.SI_SALE_OUT_AREA), 10000, ''万方'') as "siSurplusSaleArea",
        FN_DWM_MULTIPLE_AND_UNIT(sa.SI_SALE_MONEY, 100000000, ''亿'') as "siSaleMoney",
        FN_DWM_MULTIPLE_AND_UNIT(sa.SI_SALE_OUT_MONEY, 100000000, ''亿'') as "siSaleOutMoney",
        FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(sa.SI_SALE_RATE_BY_MONEY)) as "siSaleRateByMoney",
        FN_DWM_MULTIPLE_AND_UNIT(sa.SI_SURPLUS_SALE_MONEY, 100000000, ''亿'') as "siSurplusSaleMoney"
    from DWM_SALE_RATE_PROJECT p 
    left join DWM_SALE_RATE_BY_PROJECT sa
    on sa.PROJECT_ID = p.PROJECT_ID
    where p.COMPLETION_RECORD_DATE is not null';

  v_column := '"projectId",
      "projectName",
      "completionRecordDate",
      "siSaleArea",
      "siSaleOutArea",
      "siSaleRateByArea",
      "siSurplusSaleArea",
      "siSaleMoney",
      "siSaleOutMoney",
      "siSaleRateByMoney",
      "siSurplusSaleMoney",

      "projectNameCopy",
      "siSaleRateByAreaCopy",
      "siSaleRateByMoneyCopy"';

--  if rowNumber <> 0 then
--    whereStr := whereStr || ' and rownum <= ' || rowNumber;
--  end if;
  if sortStr is not null and orderBy is not null then
    whereStr:= whereStr||' order by tab."'||sortStr||'"  '||orderBy || ' nulls last ';
  end if;
  if whereStr is not null then
    v_sql:='select ' || v_column || ' from ('||v_sql||') tab '||whereStr;
  else
    v_sql:='select ' || v_column || ' from (' ||v_sql || ' )';
  end if;
  -- 选择前n条数据，rownum必须拼接在排序后面，不然会先运行rownum再运行排序，会导致筛选数据并不准确
    if rowNumber <> 0 then
        v_sql := 'select ' || v_column || ' from (' ||v_sql || ' )' || ' where rownum <= ' || rowNumber;
    end if;
  dbms_output.put_line(v_sql);

OPEN k5DataList FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE k5DataList;
END P_DWM_DATALIST_K5;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DEFAULTDATALIST_K3K4K5
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_DEFAULTDATALIST_K3K4K5" 
(
  k3DataList OUT sys_refcursor 
, k4DataList OUT sys_refcursor 
, k5DataList OUT sys_refcursor 
, k3DataSortField OUT sys_refcursor
, k4DataSortField OUT sys_refcursor
, k5DataSortField OUT sys_refcursor
, tabItems OUT sys_refcursor
, k3total OUT number
, k4total OUT number
, k5total OUT number
) AS
k3_1abstract varchar2(1000);
--k3_3abstract varchar2(1000);
--k3_4abstract varchar2(1000);
k4_1abstract varchar2(1000);
k5_1abstract varchar2(1000);
BEGIN
  select count(1) into k3total from DWM_SALE_RATE_BY_PROJECT sr
    left join DWM_SALE_RATE_PROJECT p 
    on sr.PROJECT_ID = p.PROJECT_ID
    where p.PROJECT_NAME is not null;
  select count(1) into k4total from DWM_SALE_RATE_PROJECT p 
    left join DWM_SALE_RATE_BY_PROJECT sa
    on sa.PROJECT_ID = p.PROJECT_ID
    where p.COMPLETION_RECORD_DATE is not null;
  select count(1) into k5total from DWM_SALE_RATE_PROJECT p 
    left join DWM_SALE_RATE_BY_PROJECT sa
    on sa.PROJECT_ID = p.PROJECT_ID
    where p.COMPLETION_RECORD_DATE is not null;
  SELECT
    details into k3_1abstract
  FROM
    dwm_sale_rate_data_briefing where CODE='k3.1' and rownum=1;
--  SELECT
--    details into k3_3abstract
--  FROM
--    dwm_sale_rate_data_briefing where CODE='k3.3' and rownum=1;
--  SELECT
--    details into k3_4abstract
--  FROM
--    dwm_sale_rate_data_briefing where CODE='k3.4' and rownum=1;
  SELECT
    details into k4_1abstract
  FROM
    dwm_sale_rate_data_briefing where CODE='k4.1' and rownum=1;  
  SELECT
    details into k5_1abstract
  FROM
    dwm_sale_rate_data_briefing where CODE='k5.1' and rownum=1;  

--  open k3DataList for
--    select 
--        p.PROJECT_ID as "projectId",
--        FN_DWM_FONT_COLOR(p.PROJECT_NAME) as "projectName",
--        to_char(p.FIRST_OPEN_DATE,'yyyy-mm-dd') as "firstOpenDate",
--        FN_DWM_FONT_LAYERED_COLOR(sr.PO_SALE_RATE_BY_MONEY, 0.9) as "poSaleRateByMoney",
--        FN_DWM_MULTIPLE_AND_UNIT(sr.PO_SALE_MONEY, 100000000, '亿') as "poSaleMoney",
--        FN_DWM_MULTIPLE_AND_UNIT(sr.PO_SALE_OUT_MONEY, 100000000, '亿') as "poSaleOutMoney",
--        FN_DWM_FONT_COLOR(FN_DWM_DEC_CONVERT_PCT(sr.PO_SALE_RATE_BY_COUNT)) as "poSaleRateByCount",
--        sr.PO_SALE_COUNT || '套' as "poSaleCount",
--        sr.PO_SALE_OUT_COUNT || '套' as "poSaleOutCount",
--        FN_DWM_FONT_COLOR(FN_DWM_DEC_CONVERT_PCT(sr.PO_SALE_RATE_BY_AREA)) as "poSaleRateByArea",
--        FN_DWM_MULTIPLE_AND_UNIT(sr.PO_SALE_AREA, 10000, '万方') as "poSaleArea",
--        FN_DWM_MULTIPLE_AND_UNIT(sr.PO_SALE_OUT_AREA, 10000, '万方') as "poSaleOutArea"
--    from DWM_SALE_RATE_BY_PROJECT sr
--    left join DWM_SALE_RATE_PROJECT p 
--    on sr.PROJECT_ID = p.PROJECT_ID
----  sr.PO_SALE_RATE_BY_MONEY <= 0.99 and   
--    where rowNum < 11
--    order by sr.PO_SALE_RATE_BY_MONEY desc;
  P_DWM_DATALIST_K3('poSaleRateByMoney', 'desc', 10, 0, k3DataList);
  P_DWM_DATALIST_K4('ehSaleRateByMoney', 'desc', 10, k4DataList);
  P_DWM_DATALIST_K5('siSaleRateByArea', 'desc', 10, k5DataList);


  open k3DataSortField for 
    select 'firstOpenDate' as "fieldName" from dual
    union all select 'poSaleRateByMoney' as "fieldName" from dual
    union all select 'poSaleMoney' as "fieldName" from dual
    union all select 'poSaleOutMoney' as "fieldName" from dual
    union all select 'poSaleRateByCount' as "fieldName" from dual
    union all select 'poSaleCount' as "fieldName" from dual
    union all select 'poSaleOutCount' as "fieldName" from dual
    union all select 'poSaleRateByArea' as "fieldName" from dual
    union all select 'poSaleArea' as "fieldName" from dual
    union all select 'poSaleOutArea' as "fieldName" from dual
    union all select 'projectName' as "fieldName" from dual;
  open k4DataSortField for 
    select 'completionRecordDate' as "fieldName" from dual
    union all select 'ehSaleMoney' as "fieldName" from dual
    union all select 'ehSaleOutMoney' as "fieldName" from dual
    union all select 'ehSaleRateByMoney' as "fieldName" from dual
    union all select 'ehSurplusSaleMoney' as "fieldName" from dual
    union all select 'projectName' as "fieldName" from dual;
  open k5DataSortField for 
    select 'completionRecordDate' as  "fieldName" from dual
    union all select 'siSaleArea' as "fieldName" from dual
    union all select 'siSaleOutArea' as "fieldName" from dual
    union all select 'siSaleRateByArea' as "fieldName" from dual
    union all select 'siSurplusSaleArea' as "fieldName" from dual
    union all select 'projectName' as "fieldName" from dual
    union all select 'siSaleMoney' as "fieldName" from dual
    union all select 'siSaleOutMoney' as "fieldName" from dual
    union all select 'siSaleRateByMoney' as "fieldName" from dual
    union all select 'siSurplusSaleMoney' as "fieldName" from dual;

  open tabItems for
    select '1、全案已取证去化率排行' as "title",k3_1abstract as "abstract",'k3' as "code",1 as "sort" from dual
    union
    select '2、全案已取证去化率变动趋势图' as "title",'' as "abstract",'k3' as "code",2 as "sort" from dual
--    union
--    select '3、本年新取证货值的去化率排行' as "title",k3_3abstract as "abstract",'k3' as "code",3 as "sort" from dual
--    union
--    select '4、本年新取证货值的去化率趋势图' as "title",k3_4abstract as "abstract",'k3' as "code",4 as "sort" from dual

    union
    select '1、现房去化率排行' as "title",k4_1abstract as "abstract",'k4' as "code",1 as "sort" from dual
    union
    select '2、现房去化率变动趋势图' as "title",'' as "abstract",'k4' as "code",2 as "sort" from dual
    union
    select '3、剩余现房货值变动趋势图' as "title",'' as "abstract",'k4' as "code",3 as "sort" from dual

    union
    select '1、顽固性库存去化率排行' as "title",k5_1abstract as "abstract",'k5' as "code",1 as "sort" from dual
    union
    select '2、顽固性库存去化率变动趋势图' as "title",'' as "abstract",'k5' as "code",2 as "sort" from dual
    union
    select '3、剩余顽固性库存变动趋势图' as "title",'' as "abstract",'k5' as "code",3 as "sort" from dual;
END P_DWM_DEFAULTDATALIST_K3K4K5;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DETAILBARCHARTKK3K4K5
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_DETAILBARCHARTKK3K4K5" (projectId in varchar2,tabName in varchar2,bartitle out varchar2,seriesdataName out  varchar2,saleratebycount out sys_refcursor,saleratebyarea out sys_refcursor,saleratebymoney out sys_refcursor)
AS 
SALE_OUT_COUNT_Business number(16,0):=0;
SALE_COUNT_Business number(16,0):=0;
SALE_RATE_BY_COUNT_Business number(16,4):=0;
SALE_OUT_AREA_Business number(16,2):=0;
SALE_AREA_Business number(16,2):=0;
SALE_RATE_BY_AREA_Business number(16,4):=0;
SALE_OUT_MONEY_Business number(16,2):=0;
SALE_MONEY_Business number(16,2):=0;
SALE_RATE_BY_MONEY_Business number(16,4):=0;

SALE_OUT_COUNT_House number(16,0):=0;
SALE_COUNT_House number(16,0):=0;
SALE_RATE_BY_COUNT_House number(16,4):=0;
SALE_OUT_AREA_House number(16,2):=0;
SALE_AREA_House number(16,2):=0;
SALE_RATE_BY_AREA_House number(16,4):=0;
SALE_OUT_MONEY_House number(16,2):=0;
SALE_MONEY_House number(16,2):=0;
SALE_RATE_BY_MONEY_House number(16,4):=0;

SALE_OUT_COUNT_ParkingSpace number(16,0):=0;
SALE_COUNT_ParkingSpace number(16,0):=0;
SALE_RATE_BY_COUNT_ParkingSpa number(16,4):=0;
SALE_OUT_AREA_ParkingSpace number(16,2):=0;
SALE_AREA_ParkingSpace number(16,2):=0;
SALE_RATE_BY_AREA_ParkingSpace number(16,4):=0;
SALE_OUT_MONEY_ParkingSpace number(16,2):=0;
SALE_MONEY_ParkingSpace number(16,2):=0;
SALE_RATE_BY_MONEY_ParkingSpa number(16,4):=0;

typeName varchar2(500):='';
rowcount number:=0;
series  varchar2(500):='';
begin
if tabName='k3' then
    select count(1) into rowcount  from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='商办产业';
    if rowcount<>0 then
    select PO_SALE_OUT_COUNT,
    PO_SALE_COUNT,
    PO_SALE_RATE_BY_COUNT,
    PO_SALE_OUT_AREA,
    PO_SALE_AREA,
    PO_SALE_RATE_BY_AREA,
    PO_SALE_OUT_MONEY,
    PO_SALE_MONEY,
    PO_SALE_RATE_BY_MONEY into  SALE_OUT_COUNT_Business,SALE_COUNT_Business,SALE_RATE_BY_COUNT_Business,SALE_OUT_AREA_Business,SALE_AREA_Business,SALE_RATE_BY_AREA_Business ,SALE_OUT_MONEY_Business ,SALE_MONEY_Business ,SALE_RATE_BY_MONEY_Business
    from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='商办产业';
    end if;
    select count(1) into rowcount  from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='车位仓储';
    if rowcount<>0 then
    select PO_SALE_OUT_COUNT,
    PO_SALE_COUNT,
    PO_SALE_RATE_BY_COUNT,
    PO_SALE_OUT_AREA,
    PO_SALE_AREA,
    PO_SALE_RATE_BY_AREA,
    PO_SALE_OUT_MONEY,
    PO_SALE_MONEY,
    PO_SALE_RATE_BY_MONEY  into  SALE_OUT_COUNT_ParkingSpace,SALE_COUNT_ParkingSpace,SALE_RATE_BY_COUNT_ParkingSpa ,SALE_OUT_AREA_ParkingSpace,SALE_AREA_ParkingSpace ,SALE_RATE_BY_AREA_ParkingSpace ,SALE_OUT_MONEY_ParkingSpace ,SALE_MONEY_ParkingSpace ,SALE_RATE_BY_MONEY_ParkingSpa 
    from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='车位仓储';
    end if;
    select count(1) into rowcount  from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='住宅';
    if rowcount<>0 then
    select PO_SALE_OUT_COUNT,
    PO_SALE_COUNT,
    PO_SALE_RATE_BY_COUNT,
    PO_SALE_OUT_AREA,
    PO_SALE_AREA,
    PO_SALE_RATE_BY_AREA,
    PO_SALE_OUT_MONEY,
    PO_SALE_MONEY,
    PO_SALE_RATE_BY_MONEY  into  SALE_OUT_COUNT_House,SALE_COUNT_House,SALE_RATE_BY_COUNT_House ,SALE_OUT_AREA_House,SALE_AREA_House ,SALE_RATE_BY_AREA_House ,SALE_OUT_MONEY_House ,SALE_MONEY_House ,SALE_RATE_BY_MONEY_House 
    from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='住宅';
    end if;
    typeName:='全案已取证';
    bartitle:='<span style="font-weight: bold;color: #333;">二、'||typeName||'去化率(%) ――按业态</span>';
    seriesdataName:='住宅,商业,车位';
    series:='已取证';
elsif tabName='k4' then
    select count(1) into rowcount  from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='商办产业';
    if rowcount<>0 then
    select EH_SALE_OUT_COUNT,
    EH_SALE_COUNT,
    EH_SALE_RATE_BY_COUNT,
    EH_SALE_OUT_AREA,
    EH_SALE_AREA,
    EH_SALE_RATE_BY_AREA,
    EH_SALE_OUT_MONEY,
    EH_SALE_MONEY,
    EH_SALE_RATE_BY_MONEY into  SALE_OUT_COUNT_Business,SALE_COUNT_Business,SALE_RATE_BY_COUNT_Business,SALE_OUT_AREA_Business,SALE_AREA_Business,SALE_RATE_BY_AREA_Business ,SALE_OUT_MONEY_Business ,SALE_MONEY_Business ,SALE_RATE_BY_MONEY_Business
    from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='商办产业';
    end if;
    select count(1) into rowcount  from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='车位仓储';
    if rowcount<>0 then
    select EH_SALE_OUT_COUNT,
    EH_SALE_COUNT,
    EH_SALE_RATE_BY_COUNT,
    EH_SALE_OUT_AREA,
    EH_SALE_AREA,
    EH_SALE_RATE_BY_AREA,
    EH_SALE_OUT_MONEY,
    EH_SALE_MONEY,
    EH_SALE_RATE_BY_MONEY  into  SALE_OUT_COUNT_ParkingSpace,SALE_COUNT_ParkingSpace,SALE_RATE_BY_COUNT_ParkingSpa ,SALE_OUT_AREA_ParkingSpace,SALE_AREA_ParkingSpace ,SALE_RATE_BY_AREA_ParkingSpace ,SALE_OUT_MONEY_ParkingSpace ,SALE_MONEY_ParkingSpace ,SALE_RATE_BY_MONEY_ParkingSpa 
    from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='车位仓储';
    end if;
    select count(1) into rowcount  from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='住宅';
    if rowcount<>0 then
    select EH_SALE_OUT_COUNT,
    EH_SALE_COUNT,
    EH_SALE_RATE_BY_COUNT,
    EH_SALE_OUT_AREA,
    EH_SALE_AREA,
    EH_SALE_RATE_BY_AREA,
    EH_SALE_OUT_MONEY,
    EH_SALE_MONEY,
    EH_SALE_RATE_BY_MONEY  into  SALE_OUT_COUNT_House,SALE_COUNT_House,SALE_RATE_BY_COUNT_House ,SALE_OUT_AREA_House,SALE_AREA_House ,SALE_RATE_BY_AREA_House ,SALE_OUT_MONEY_House ,SALE_MONEY_House ,SALE_RATE_BY_MONEY_House 
    from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='住宅';
    end if;
    typeName:='现房';
    bartitle:='<span style="font-weight: bold;color: #333;">二、'||typeName||'去化率(%) ――按业态</span>';
    seriesdataName:='住宅,商业,车位';
    series:='已竣备';
elsif tabName='k5' then
    select count(1) into rowcount  from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='商办产业';
    if rowcount<>0 then
    select SI_SALE_OUT_COUNT,
    SI_SALE_COUNT,
    SI_SALE_RATE_BY_COUNT,
    SI_SALE_OUT_AREA,
    SI_SALE_AREA,
    SI_SALE_RATE_BY_AREA,
    SI_SALE_OUT_MONEY,
    SI_SALE_MONEY,
    SI_SALE_RATE_BY_MONEY into  SALE_OUT_COUNT_Business,SALE_COUNT_Business,SALE_RATE_BY_COUNT_Business,SALE_OUT_AREA_Business,SALE_AREA_Business,SALE_RATE_BY_AREA_Business ,SALE_OUT_MONEY_Business ,SALE_MONEY_Business ,SALE_RATE_BY_MONEY_Business
    from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='商办产业';
    end if;
    select count(1) into rowcount  from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='车位仓储';
    if rowcount<>0 then
    select SI_SALE_OUT_COUNT,
    SI_SALE_COUNT,
    SI_SALE_RATE_BY_COUNT,
    SI_SALE_OUT_AREA,
    SI_SALE_AREA,
    SI_SALE_RATE_BY_AREA,
    SI_SALE_OUT_MONEY,
    SI_SALE_MONEY,
    SI_SALE_RATE_BY_MONEY  into  SALE_OUT_COUNT_ParkingSpace,SALE_COUNT_ParkingSpace,SALE_RATE_BY_COUNT_ParkingSpa ,SALE_OUT_AREA_ParkingSpace,SALE_AREA_ParkingSpace ,SALE_RATE_BY_AREA_ParkingSpace ,SALE_OUT_MONEY_ParkingSpace ,SALE_MONEY_ParkingSpace ,SALE_RATE_BY_MONEY_ParkingSpa 
    from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='车位仓储';
    end if;
    typeName:='顽固性库存';
    bartitle:='<span style="font-weight: bold;color: #333;">二、'||typeName||'去化率(%) ――按业态</span>';
    seriesdataName:='商业,车位';
    series:='顽固性库存';
end if;
open saleratebycount for
select 
 series||'套数,签约套数,去化率' as "series", 
 typeName||'去化率（按套数）' as "chartTitle",
 '' as "abstract",
  case  when  tabName<>'k5' then
      to_char(SALE_COUNT_House)||','||to_char(SALE_COUNT_Business)||','||to_char(SALE_COUNT_ParkingSpace) else
      to_char(SALE_COUNT_Business)||','||to_char(SALE_COUNT_ParkingSpace) end as "saleData",
  case  when  tabName<>'k5' then
    to_char(SALE_OUT_COUNT_House)||','||to_char(SALE_OUT_COUNT_Business)||','||to_char(SALE_OUT_COUNT_ParkingSpace) else 
    to_char(SALE_OUT_COUNT_Business)||','||to_char(SALE_OUT_COUNT_ParkingSpace) end as "saleOutData",
  case  when  tabName<>'k5' then
    to_char(trunc(SALE_RATE_BY_COUNT_House*100,2))||','||to_char(trunc(SALE_RATE_BY_COUNT_Business*100,2))||','||to_char(trunc(SALE_RATE_BY_COUNT_ParkingSpa*100,2)) else 
    to_char(trunc(SALE_RATE_BY_COUNT_Business*100,2))||','||to_char(trunc(SALE_RATE_BY_COUNT_ParkingSpa*100,2)) end as "saleRateData",
  1 as sort,
  '套' "unit"
from dual;
open saleratebyarea for
select 
 series||'面积,签约面积,去化率' as "series", 
 typeName||'去化率（按面积）' as "chartTitle",
 '（面积单位：万方）' as "abstract",
  case  when  tabName<>'k5' then
      FN_DWM_MULTIPLE_AND_UNIT(SALE_AREA_House,10000,'')||','|| FN_DWM_MULTIPLE_AND_UNIT(SALE_AREA_Business,10000,'')||','||FN_DWM_MULTIPLE_AND_UNIT(SALE_AREA_ParkingSpace,10000,'') else 
      FN_DWM_MULTIPLE_AND_UNIT(SALE_AREA_Business,10000,'')||','||FN_DWM_MULTIPLE_AND_UNIT(SALE_AREA_ParkingSpace,10000,'') end as "saleData",
 case  when  tabName<>'k5' then
      FN_DWM_MULTIPLE_AND_UNIT(SALE_OUT_AREA_House,10000,'')||','||FN_DWM_MULTIPLE_AND_UNIT(SALE_OUT_AREA_Business,10000,'')||','||FN_DWM_MULTIPLE_AND_UNIT(SALE_OUT_AREA_ParkingSpace,10000,'') else 
      FN_DWM_MULTIPLE_AND_UNIT(SALE_OUT_AREA_Business,10000,'')||','||FN_DWM_MULTIPLE_AND_UNIT(SALE_OUT_AREA_ParkingSpace,10000,'') end as "saleOutData",
  case  when  tabName<>'k5' then
      to_char(trunc(SALE_RATE_BY_AREA_House*100,2))||','||to_char(trunc(SALE_RATE_BY_AREA_Business*100,2))||','||to_char(trunc(SALE_RATE_BY_AREA_ParkingSpace*100,2)) else
      to_char(trunc(SALE_RATE_BY_AREA_Business*100,2))||','||to_char(trunc(SALE_RATE_BY_AREA_ParkingSpace*100,2)) end as "saleRateData",
  3 as sort,
   '万方' "unit"
from dual;
open saleratebymoney for
select 
 series||'货值,签约货值,去化率' as "series", 
 typeName||'去化率（按货值）' as "chartTitle",
 '（货值单位：亿）' as "abstract",
  case  when  tabName<>'k5' then
      FN_DWM_MULTIPLE_AND_UNIT(SALE_MONEY_House,100000000,'')||','||FN_DWM_MULTIPLE_AND_UNIT(SALE_MONEY_Business,100000000,'')||','|| FN_DWM_MULTIPLE_AND_UNIT(SALE_MONEY_ParkingSpace,100000000,'') else 
      FN_DWM_MULTIPLE_AND_UNIT(SALE_MONEY_Business,100000000,'')||','|| FN_DWM_MULTIPLE_AND_UNIT(SALE_MONEY_ParkingSpace,100000000,'') end  as "saleData",
  case  when  tabName<>'k5' then
     FN_DWM_MULTIPLE_AND_UNIT(SALE_OUT_MONEY_House,100000000,'')||','||FN_DWM_MULTIPLE_AND_UNIT(SALE_OUT_MONEY_Business,100000000,'')||','|| FN_DWM_MULTIPLE_AND_UNIT(SALE_OUT_MONEY_ParkingSpace,100000000,'') else 
     FN_DWM_MULTIPLE_AND_UNIT(SALE_OUT_MONEY_Business,100000000,'')||','|| FN_DWM_MULTIPLE_AND_UNIT(SALE_OUT_MONEY_ParkingSpace,100000000,'') end as "saleOutData",
 case  when  tabName<>'k5' then
      to_char(trunc(SALE_RATE_BY_MONEY_House*100,2))||','||to_char(trunc(SALE_RATE_BY_MONEY_Business*100,2))||','||to_char(trunc(SALE_RATE_BY_MONEY_ParkingSpa*100,2))  else
      to_char(trunc(SALE_RATE_BY_MONEY_Business*100,2))||','||to_char(trunc(SALE_RATE_BY_MONEY_ParkingSpa*100,2)) end  as "saleRateData",
 2 as sort,
  '亿' "unit"
from dual;
end P_DWM_detailBarChartkK3k4k5;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DETAILDATAK2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_DETAILDATAK2" (projectId in varchar2,bartitle out varchar2,firstopendate out varchar2,planfirstopendate out varchar2,bardata out sys_refcursor,
listdata out sys_refcursor,nodeplantitle out varchar2,nodeplanlist out sys_refcursor,chartTitle out varchar2,chartDescription out varchar2)
AS 
firstopendateValue date;
takeLandDate date;
planfirstopendateValue date;
newPlanFirstOpenDate date;
exhibitionAreaOpenDate date;
exhibitionAreaOpenByPlan date;
planApprovalDate date;
planApprovalDateByPlan date;
rowcount number :=0;
begin
execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd''';
bartitle:='<span style="font-weight: bold;color: #333;">一、拿地至首开时间</span>';
chartTitle:='拿地至首开时间';
nodeplantitle:='<span style="font-weight: bold;color: #333;">二、首开分期“关键节点计划”</span>';
select count(1) into  rowcount  from  DWM_SALE_RATE_PROJECT where PROJECT_ID=projectId;
select FIRST_OPEN_DATE,
TAKE_LAND_DATE,
PLAN_FIRST_OPEN_DATE,
NEW_PLAN_FIRST_OPEN_DATE,
EXHIBITION_AREA_OPEN_DATE,
EXHIBITION_AREA_OPEN_BY_PLAN,
PLAN_APPROVAL_DATE,
PLAN_APPROVAL_DATE_BY_PLAN 
into 
firstopendateValue,
takeLandDate,
planfirstopendateValue,
newPlanFirstOpenDate,
exhibitionAreaOpenDate,
exhibitionAreaOpenByPlan,
planApprovalDate,
planApprovalDateByPlan
from DWM_SALE_RATE_PROJECT where PROJECT_ID=projectId;
firstopendate:='<span style="font-weight: bold;color:#333">实际首开日期：</span>';
planfirstopendate:='<span style="font-weight: bold;color:#333">计划首开日期：</span>';
if firstopendateValue is not null then
    firstopendate:='<span style="font-weight: bold;color:#333">实际首开日期：'||to_char(firstopendateValue,'yyyy-mm-dd')||'</span>';
end if;
if planfirstopendateValue is not null then
    planfirstopendate:='<span style="font-weight: bold;color:#333">计划首开日期：'||to_char(planfirstopendateValue,'yyyy-mm-dd')||'</span>';
end if;
if planfirstopendateValue is not null and firstopendateValue is not null then
    firstopendate:=firstopendate||'<span style="font-weight: bold;">     '||Fn_DWM_DurationDaysDeal(planfirstopendateValue,firstopendateValue,'label')||'';
    open bardata for
    select 
    '实际首开时间' as "seriesName",
    case when planfirstopendateValue is not null then
     trunc(months_between(firstopendateValue,takeLandDate),1)
     else 0 end as "seriesValue"
    from  dual 
    union 
    select 
    '计划首开时间' as "seriesName",
    case when planfirstopendateValue is not null then
    trunc(months_between(planfirstopendateValue,takeLandDate),1) 
    else 0 end as "seriesValue"
    from  dual;
chartDescription:=to_char(trunc(months_between(firstopendateValue,takeLandDate),1))||'月';
end if;

open listdata for
    select * from(select 
    '<span style="font-weight: bold;color:#333">拿地 -->方案批复</ span>' as "description",
    case when takeLandDate is not null and planApprovalDate is not null then trunc(months_between(planApprovalDate,takeLandDate),1) else null end  as "realityDuration",
    case when takeLandDate is not null and planApprovalDateByPlan is not null then trunc(months_between(planApprovalDateByPlan,takeLandDate),1) else null end  as "planDuration",
    replace(Fn_DWM_DurationDaysDeal(planApprovalDateByPlan,planApprovalDate,'label'),'首开','') as "abstract",
    1 as sort
    from  dual  union
    select 
    '<span style="font-weight: bold;color:#333">拿地 -->展示区开放</ span>' as "description",
    case when takeLandDate is not null and exhibitionAreaOpenDate is not null then trunc(months_between(exhibitionAreaOpenDate,takeLandDate),1) else null end  as "realityDuration",
    case when takeLandDate is not null and exhibitionAreaOpenByPlan is not null then trunc(months_between(exhibitionAreaOpenByPlan,takeLandDate),1) else null end  as "planDuration",
    replace(Fn_DWM_DurationDaysDeal(exhibitionAreaOpenByPlan,exhibitionAreaOpenDate,'label'),'首开','') as "abstract",
     2 as sort
    from  dual  union
    select 
    '<span style="color:#FF0000;">*</ span><span style="font-weight: bold;color:#333">拿地 -->首期开盘</ span>' as "description",
    case when takeLandDate is not null and firstopendateValue is not null then trunc(months_between(firstopendateValue,takeLandDate),1) else null end  as "realityDuration",
    case when takeLandDate is not null and planfirstopendateValue is not null then trunc(months_between(planfirstopendateValue,takeLandDate),1) else null end  as "planDuration",
    replace(Fn_DWM_DurationDaysDeal(planfirstopendateValue,firstopendateValue,'label'),'首开','') as "abstract",
     3 as sort
    from  dual) tab order by tab.sort;
open nodeplanlist for    
select 
    nodeStartSales.node_name as "nodeName",
    nodeStartSales.node_level as "nodeType",
    to_char(nodeStartSales.plan_end_Date,'yyyy-mm-dd') as "planCompletionDate",
     to_char(nodeStartSales.actual_end_date,'yyyy-mm-dd') as "actualCompletionDate",
    case when nodeStartSales.actual_end_date is not null then '<div style="display:flex"><span style="display:inline-block;background-color:#33CC99;width:15px;height:15px;border-radius:50%" ></span><span  style="margin-left:2px">已完成</span></div>' else '' end  as "status",
     to_char(nodeStartSales.ESTIMATE_END_DATE,'yyyy-mm-dd') as "expectedCompletionDate"
    from SYS_PROJECT_STAGE ps 
    --join--计划
    left join POM_PROJ_PLAN plan on ps.id=plan.proj_id
    left join POM_PROJ_PLAN_NODE  nodeStartSales on plan.id=nodeStartSales.PROJ_PLAN_ID
    where ps.PROJECT_ID=projectId and ps.IS_FIRST_OPEN_PERIOD =1  and plan.PLAN_TYPE='关键节点计划' and plan.APPROVAL_STATUS='已审核'  and nodeStartSales.IS_DELETE<>1 and nodeStartSales.IS_DISABLE<>1 order by  nodeStartSales.plan_end_Date asc;
end P_DWM_detailDatak2;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DETAILRINGCHART1K3K4K5
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_DETAILRINGCHART1K3K4K5" (
    projectid         IN    VARCHAR2,
    tabname           IN    VARCHAR2,
    ringtitle         OUT   CLOB,
    seriesdataname    OUT   VARCHAR2,
    saleratebycount   OUT   SYS_REFCURSOR,
    saleratebyarea    OUT   SYS_REFCURSOR,
    saleratebymoney   OUT   SYS_REFCURSOR
) AS

    sale_out_count       NUMBER(16, 0) := 0;
    sale_count           NUMBER(16, 0) := 0;
    sale_rate_by_count   NUMBER(16, 4) := 0;
    sale_out_area        NUMBER(16, 2) := 0;
    sale_area            NUMBER(16, 2) := 0;
    sale_rate_by_area    NUMBER(16, 4) := 0;
    sale_out_money       NUMBER(16, 2) := 0;
    sale_money           NUMBER(16, 2) := 0;
    sale_rate_by_money   NUMBER(16, 4) := 0;
    surplus_sale_money   NUMBER(16, 2) := 0;
    typename             VARCHAR2(500) := '';
    chartname            VARCHAR2(500) := '';
    rowcount             NUMBER := 0;
BEGIN
    SELECT
        COUNT(1)
    INTO rowcount
    FROM
        dwm_sale_rate_by_project
    WHERE
        project_id = projectid;

    IF tabname = 'k1' THEN
        ringtitle := '<span style="font-weight: bold;color: #333;">一、首开去化率</span><span style="color: #333;margin-left:10px;">注：首开的统计时间区间默认为“首次开盘后30天”。</span>'
        ;
        typename := '首开';
        chartname := typename;
    ELSIF tabname = 'k3' THEN
        ringtitle := '<span style="font-weight: bold;color: #333;">一、全案已取证去化率</span>';
        typename := '全案已取证';
        chartname := '已取证';
    ELSIF tabname = 'k4' THEN
        ringtitle := '<span style="font-weight: bold;color: #333;">一、现房去化率(%) </span><span style="color: #333;margin-left:10px;">注：现房指已竣备的可售资源。</span>'
        ;
        typename := '现房';
        chartname := '现房';
    ELSIF tabname = 'k5' THEN
        ringtitle := '<span style="font-weight: bold;color: #333;">一、顽固性库存去化率(%) </span><span style="color: #333;margin-left:10px;">注：顽固性库存指“本年1月1日前已竣备，且未实现签约”的可售资源。</span>'
        ;
        typename := '顽固性库存';
        chartname := '共';
    END IF;

    IF tabname = 'k1' AND rowcount <> 0 THEN
        SELECT
            fo_sale_out_count,
            fo_sale_count,
            fo_sale_rate_by_count,
            fo_sale_out_area,
            fo_sale_area,
            fo_sale_rate_by_area,
            fo_sale_out_money,
            fo_sale_money,
            fo_sale_rate_by_money,
            fo_surplus_sale_money
        INTO
            sale_out_count,
            sale_count,
            sale_rate_by_count,
            sale_out_area,
            sale_area,
            sale_rate_by_area,
            sale_out_money,
            sale_money,
            sale_rate_by_money,
            surplus_sale_money
        FROM
            dwm_sale_rate_by_project
        WHERE
            project_id = projectid
            AND ROWNUM = 1;

    ELSIF tabname = 'k3' AND rowcount <> 0 THEN
        SELECT
            po_sale_out_count,
            po_sale_count,
            po_sale_rate_by_count,
            po_sale_out_area,
            po_sale_area,
            po_sale_rate_by_area,
            po_sale_out_money,
            po_sale_money,
            po_sale_rate_by_money,
            po_surplus_sale_money
        INTO
            sale_out_count,
            sale_count,
            sale_rate_by_count,
            sale_out_area,
            sale_area,
            sale_rate_by_area,
            sale_out_money,
            sale_money,
            sale_rate_by_money,
            surplus_sale_money
        FROM
            dwm_sale_rate_by_project
        WHERE
            project_id = projectid
            AND ROWNUM = 1;

    ELSIF tabname = 'k4' AND rowcount <> 0 THEN
        SELECT
            eh_sale_out_count,
            eh_sale_count,
            eh_sale_rate_by_count,
            eh_sale_out_area,
            eh_sale_area,
            eh_sale_rate_by_area,
            eh_sale_out_money,
            eh_sale_money,
            eh_sale_rate_by_money,
            eh_surplus_sale_money
        INTO
            sale_out_count,
            sale_count,
            sale_rate_by_count,
            sale_out_area,
            sale_area,
            sale_rate_by_area,
            sale_out_money,
            sale_money,
            sale_rate_by_money,
            surplus_sale_money
        FROM
            dwm_sale_rate_by_project
        WHERE
            project_id = projectid
            AND ROWNUM = 1;

    ELSIF tabname = 'k5' AND rowcount <> 0 THEN
        SELECT
            si_sale_out_count,
            si_sale_count,
            si_sale_rate_by_count,
            si_sale_out_area,
            si_sale_area,
            si_sale_rate_by_area,
            si_sale_out_money,
            si_sale_money,
            si_sale_rate_by_money,
            si_surplus_sale_money
        INTO
            sale_out_count,
            sale_count,
            sale_rate_by_count,
            sale_out_area,
            sale_area,
            sale_rate_by_area,
            sale_out_money,
            sale_money,
            sale_rate_by_money,
            surplus_sale_money
        FROM
            dwm_sale_rate_by_project
        WHERE
            project_id = projectid
            AND ROWNUM = 1;

    END IF;

    seriesdataname := '已签约,未签约';
    OPEN saleratebycount FOR SELECT
                                 typename || '去化率（按套数）' AS "chartTitle",
                                 '' AS "chartDescription",
                                 fn_convertdecimaltopercentage(sale_rate_by_count) AS "centerTitle",
                                 chartname
                                 || to_char(sale_count)
                                 || '套' AS "centerDescription",
                                 to_char(sale_out_count)
                                 || ','
                                 || to_char(sale_count - sale_out_count) AS "seriesdata",
                                 '套' "unit",
                                 1 AS sort
                             FROM
                                 dual;
-- 20201126 二期去化率列表详情页，环形图
--FM (First Month): 首月
--FOHY(First Open Half Year):首开半年
--CR(Completed Record):竣工备案
--CROY(Completed Record One Year):竣工备案后一年

    IF ( tabname = 'FM' OR tabname = 'FOHY' OR tabname ='CR' OR tabname ='CROY' ) AND rowcount <> 0 THEN
        BEGIN
            p_dwm_sr_detailring_chart(
            projectid,
            tabname, 
            ringtitle => ringtitle, 
            seriesdataname => seriesdataname, 
            saleratebycount => saleratebycount,
            saleratebyarea => saleratebyarea, 
            saleratebymoney => saleratebymoney
            );

        END;
--- 20201126 非二期按源逻辑去化率详情，环形图
    ELSE
        OPEN saleratebymoney FOR SELECT
                                     typename || '去化率（按货值）' AS "chartTitle",
                                     '（货值单位：亿）' AS "chartDescription",
                                     fn_convertdecimaltopercentage(sale_rate_by_money) AS "centerTitle",
                                     chartname || fn_dwn_amounttobillionyuan(sale_money) AS "centerDescription",
                                     fn_dwm_multiple_and_unit(sale_out_money, 100000000, '')
                                     || ','
                                     || fn_dwm_multiple_and_unit(surplus_sale_money, 100000000, '') AS "seriesdata",
                                     '亿' "unit",
                                     2 AS sort
                                 FROM
                                     dual;

        OPEN saleratebyarea FOR SELECT
                                   typename || '去化率（按面积）' AS "chartTitle",
                                   '（面积单位：万方）' AS "chartDescription",
                                   fn_convertdecimaltopercentage(sale_rate_by_area) AS "centerTitle",
                                   chartname || fn_dwn_areato1000square(sale_area) AS "centerDescription",
                                   fn_dwm_multiple_and_unit(sale_out_area, 10000, '')
                                   || ','
                                   || fn_dwm_multiple_and_unit(trunc(sale_area - sale_out_area, 2), 10000, '') AS "seriesdata",
                                   '万方' "unit",
                                   3 AS sort
                               FROM
                                   dual;

    END IF;

EXCEPTION
    WHEN OTHERS THEN
        CLOSE saleratebyarea;
        CLOSE saleratebycount;
        CLOSE saleratebymoney;
END p_dwm_detailringchart1k3k4k5;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DETAILSALERATEKLIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_DETAILSALERATEKLIST" (projectId in varchar2,tabName in varchar2,isShowAreaSection in number,listTitle out varchar2 ,tableData out sys_refcursor)
AS 
v_sql clob:='';
begin
if tabName='k1' then
listTitle:='<span style="font-weight: bold;color: #333;">二、首开去化明细情况（项目-->业态-->面积段）</span>';
v_sql:=
'SELECT
   dwm_sale_rate_by_project.PROJECT_ID as "id",
   FN_DWM_FONT_COLOR(dwm_sale_rate_project.PROJECT_NAME) as "typeName",
    fo_sale_out_count||''套'' as "saleOutCount",
    fo_sale_count||''套'' as "saleCount",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(fo_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(fo_sale_area) as "saleArea",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo_sale_rate_by_area))  as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(fo_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(fo_sale_money) as "saleMoney",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo_sale_rate_by_money))  as "saleRateByMoney",
    fo_sale_average_money as "standardPrice",
    fo_sale_out_average_money as "signPrice",
    '''' as "parentId",
    0 as "isAreaSection",
    0 as Sort
FROM
    dwm_sale_rate_by_project left join dwm_sale_rate_project on dwm_sale_rate_by_project.PROJECT_ID = dwm_sale_rate_project.PROJECT_ID where  rownum=1 and dwm_sale_rate_by_project.PROJECT_ID='''||projectId||'''
    union 
    SELECT
    id as "id",
    FN_DWM_FONT_COLOR(DATA_GRANULARITY) as "typeName",
    fo_sale_out_count||''套'' as "saleOutCount",
    fo_sale_count||''套'' as "saleCount",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(fo_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(fo_sale_area) as "saleArea",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo_sale_rate_by_area))  as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(fo_sale_out_money)  as "saleOutMoney",
   FN_DWN_AmountToBillionYuan( fo_sale_money) as "saleMoney",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo_sale_rate_by_money))  as "saleRateByMoney",
    fo_sale_average_money as "standardPrice",
    fo_sale_out_average_money as "signPrice",
    case when PARENT_ID is null then PROJECT_ID  else PARENT_ID end as "parentId",
    case when PARENT_ID is null then 0 else 1 end as "isAreaSection",
    Sort
FROM
    DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID='''||projectId||''' ' ;
    elsif  tabName='k3' then
    listTitle:='<span style="font-weight: bold;color: #333;">三、全案已取证货值去化明细表</span>';
v_sql:=
'SELECT
   dwm_sale_rate_by_project.PROJECT_ID as "id",
   FN_DWM_FONT_COLOR(dwm_sale_rate_project.PROJECT_NAME) as "typeName",
    po_sale_out_count||''套'' as "saleOutCount",
    po_sale_count||''套'' as "saleCount",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(po_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(po_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(po_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(po_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(po_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(po_sale_money) as "saleMoney",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(po_sale_rate_by_money))  as "saleRateByMoney",
    po_sale_average_money as "standardPrice",
    po_sale_out_average_money as "signPrice",
    '''' as "parentId",
    0 as "isAreaSection",
    0 as Sort
FROM
    dwm_sale_rate_by_project left join dwm_sale_rate_project on dwm_sale_rate_by_project.PROJECT_ID = dwm_sale_rate_project.PROJECT_ID where  rownum=1 and  dwm_sale_rate_by_project.PROJECT_ID='''||projectId||'''
    union 
    SELECT
    id as "id",
     FN_DWM_FONT_COLOR(DATA_GRANULARITY) as "typeName",
    po_sale_out_count||''套'' as "saleOutCount",
    po_sale_count||''套'' as "saleCount",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(po_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(po_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(po_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(po_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(po_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(po_sale_money) as "saleMoney",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(po_sale_rate_by_money))  as "saleRateByMoney",
    po_sale_average_money as "standardPrice",
    po_sale_out_average_money as "signPrice",
    case when PARENT_ID is null then PROJECT_ID  else PARENT_ID end as "parentId",
    case when PARENT_ID is null then 0 else 1 end as "isAreaSection",
    sort
FROM
    DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID='''||projectId||''' ' ;
     elsif  tabName='k4' then
    listTitle:='<span style="font-weight: bold;color: #333;">三、现房去化明细表</span>';
v_sql:=
'SELECT
   dwm_sale_rate_by_project.PROJECT_ID as "id",
   FN_DWM_FONT_COLOR(dwm_sale_rate_project.PROJECT_NAME) as "typeName",
    EH_sale_out_count||''套'' as "saleOutCount",
    EH_sale_count||''套'' as "saleCount",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(EH_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(EH_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(EH_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(EH_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(EH_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(EH_sale_money) as "saleMoney",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(EH_sale_rate_by_money))  as "saleRateByMoney",
    EH_sale_average_money as "standardPrice",
    EH_sale_out_average_money as "signPrice",
    '''' as "parentId",
    0 as "isAreaSection",
    0 as sort
FROM
    dwm_sale_rate_by_project left join dwm_sale_rate_project on dwm_sale_rate_by_project.PROJECT_ID = dwm_sale_rate_project.PROJECT_ID where  rownum=1 and  dwm_sale_rate_by_project.PROJECT_ID='''||projectId||'''
    union 
    SELECT
    id as "id",
     FN_DWM_FONT_COLOR(DATA_GRANULARITY) as "typeName",
    EH_sale_out_count||''套'' as "saleOutCount",
    EH_sale_count||''套'' as "saleCount",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(EH_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(EH_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(EH_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(EH_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(EH_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(EH_sale_money) as "saleMoney",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(EH_sale_rate_by_money))  as "saleRateByMoney",
    EH_sale_average_money as "standardPrice",
    EH_sale_out_average_money as "signPrice",
    case when PARENT_ID is null then PROJECT_ID  else PARENT_ID end as "parentId",
    case when PARENT_ID is null then 0 else 1 end as "isAreaSection",
    sort
FROM
    DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID='''||projectId||''' ' ;
elsif  tabName='k5' then
    listTitle:='<span style="font-weight: bold;color: #333;">三、已竣备货值去化明细表</span>';
v_sql:=
'SELECT
   dwm_sale_rate_by_project.PROJECT_ID as "id",
   FN_DWM_FONT_COLOR(dwm_sale_rate_project.PROJECT_NAME) as "typeName",
   SI_sale_out_count||''套'' as "saleOutCount",
   SI_sale_count||''套'' as "saleCount",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(SI_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(SI_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(SI_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(SI_sale_money) as "saleMoney",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_money))  as "saleRateByMoney",
    SI_sale_average_money as "standardPrice",
    SI_sale_out_average_money as "signPrice",
    '''' as "parentId",
    0 as "isAreaSection",
    0 as sort
FROM
    dwm_sale_rate_by_project left join dwm_sale_rate_project on dwm_sale_rate_by_project.PROJECT_ID = dwm_sale_rate_project.PROJECT_ID where  rownum=1 and  dwm_sale_rate_by_project.PROJECT_ID='''||projectId||'''
    union 
    SELECT
    id as "id",
    FN_DWM_FONT_COLOR(DATA_GRANULARITY) as "typeName",
    SI_sale_out_count||''套'' as "saleOutCount",
    SI_sale_count||''套'' as "saleCount",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(SI_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(SI_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(SI_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(SI_sale_money) as "saleMoney",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_money))  as "saleRateByMoney",
    SI_sale_average_money as "standardPrice",
    SI_sale_out_average_money as "signPrice",
    case when PARENT_ID is null then PROJECT_ID  else PARENT_ID end as "parentId",
    case when PARENT_ID is null then 0 else 1 end as "isAreaSection",
    Sort
FROM
    DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID='''||projectId||''' and  DATA_GRANULARITY <> ''住宅''   and PARENT_ID is null
    union 
    SELECT
    id as "id",
    FN_DWM_FONT_COLOR(DATA_GRANULARITY) as "typeName",
    SI_sale_out_count||''套'' as "saleOutCount",
    SI_sale_count||''套'' as "saleCount",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(SI_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(SI_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(SI_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(SI_sale_money) as "saleMoney",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_money))  as "saleRateByMoney",
    SI_sale_average_money as "standardPrice",
    SI_sale_out_average_money as "signPrice",
    case when PARENT_ID is null then PROJECT_ID  else PARENT_ID end as "parentId",
    case when PARENT_ID is null then 0 else 1 end as "isAreaSection",
    Sort
FROM
    DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID='''||projectId||''' and  PARENT_ID is not null and
    PARENT_ID not in (select Id from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID='''||projectId||''' and DATA_GRANULARITY = ''住宅'' )' ;
end if;
        dbms_output.put_line(v_sql);
    if isShowAreaSection = 0 then
         v_sql:='select * from ('||v_sql||') tab where tab."isAreaSection" = 0 order by sort';
         else
         v_sql:='select * from ('||v_sql||') tab  order by sort';
    end if;
OPEN tableData FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE tableData;
END P_DWM_DetailSaleRatekList;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DT_AREA_DTL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_DT_AREA_DTL" (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    projectid      IN             VARCHAR2, --选择公司id
    tabsindex      IN             VARCHAR2, --选择选项卡。1开始
    isoperate      IN             VARCHAR2,--是否操盘
    info           OUT            SYS_REFCURSOR
) AS
--动态货量管理-全案动态货量-穿透详情
--作者：陈丽
--日期：2019/12/17
    data_auth_spid   VARCHAR2(200);
    bizcode          VARCHAR2(200);
BEGIN
    IF tabsindex = 1 THEN
        dbms_output.put_line('所有业态!');
    ELSIF tabsindex = 2 THEN
        dbms_output.put_line('住宅及商办!');
    ELSIF tabsindex = 3 THEN
        dbms_output.put_line('住宅!');
    ELSIF tabsindex = 4 THEN
        dbms_output.put_line('商办!');
    ELSIF tabsindex = 5 THEN
        dbms_output.put_line('车位!');
    ELSe--IF tabsindex = 6 THEN
        dbms_output.put_line('剩余货量表!');
        OPEN info FOR SELECT
                          a.id             AS "id",--主键id（生成树的id，唯一可以是业务id）
                          level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '' || project_name
                              WHEN level = 2 THEN
                                  '        ' || project_name
                              WHEN level = 3 THEN
                                  '                ' || project_name
                              WHEN level = 4 THEN
                                  '                        ' || project_name
                              ELSE
                                  '                                ' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          a.parent_id      AS "parentId",--父级id（生成树父级id）
                          a.project_name   AS "orgName",--项目/分期/业态/楼栋
                            NVL(b.ZZ_area_remain,0) AS "projWholeDwellingArea",--项目全案剩余可售货量（S=A+B+C+D）-住宅(m2)
                            NVL( b.SY_area_remain,0) AS "projWholeBusinessArea",--项目全案剩余可售货量（S=A+B+C+D）-商业(m2)
                            NVL( b.CW_area_remain,0) AS "projWholeCarport",--项目全案剩余可售货量（S=A+B+C+D）-车位(个)
                            NVL(b.area_remain,0) AS "projWholeTotalArea",--项目全案剩余可售货量（S=A+B+C+D）-合计(m2)
                            NVL( b.zz_area_not_planning_permit,0) AS "ADwellingArea",--A未取规证的可售货量-住宅(m2)
                            NVL( b.sy_area_not_planning_permit,0) AS "ABusinessArea",--A未取规证的可售货量-商业(m2)
                            NVL( b.CW_Area_not_planning_permit,0) AS "ACarport",--A未取规证的可售货量-车位(个)
                            NVL( b.Area_not_planning_permit,0) AS "ATotalArea",--A未取规证的可售货量-合计(m2)
                            NVL(b.zz_area_not_construction_per,0) AS "BDwellingArea",--B已取规证未取施工证的可售货量-住宅(m2)
                            NVL(b.SY_area_not_construction_per,0) AS "BBusinessArea",--B已取规证未取施工证的可售货量-商业(m2)
                            NVL(b.CW_area_not_construction_per,0) AS "BCarport",--B已取规证未取施工证的可售货量-车位(个)
                            NVL(b.area_not_construction_permit,0) AS "BTotalArea",--B已取规证未取施工证的可售货量-合计(m2)
                            NVL(b.zz_area_not_sale_permit,0) as "CDwellingArea",--C已取规证未取预售证的可售货量-住宅(m2)
                            NVL(b.SY_area_not_sale_permit,0) AS "CBusinessArea",--C已取规证未取预售证的可售货量-商业(m2)
                            NVL(b.CW_area_not_sale_permit,0) AS "CCarport",--C已取规证未取预售证的可售货量-车位(个)
                            NVL(b.area_not_sale_permit,0) AS "CTotalArea",--C已取规证未取预售证的可售货量-合计(m2)
                            NVL(b.zz_area_stock,0) AS "DDwellingArea",--D已取预售证未售的可售货量-住宅(m2)
                            NVL(b.SY_area_stock,0) AS "DBusinessArea",--D已取预售证未售的可售货量-商业(m2)
                            NVL(b.CW_area_stock,0) AS "DCarport",--D已取预售证未售的可售货量-车位(个)
                            NVL(b.area_Stock,0) AS "DTotalArea"--D已取预售证未售的可售货量-合计(m2)
                      FROM
                          (
                              SELECT
                                  id,
                                  project_name,
                                  '' AS parent_id,
                                  sn AS order_code
                              FROM
                                  sys_project
                              WHERE
                                  id = ''
                                       || projectid
                                       || ''
                              UNION ALL
--分期
                              SELECT
                                  id,
                                  stage_name,
                                  project_id AS parent_id,
                                  lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  sys_project_stage
                              WHERE
                                  project_id = ''
                                               || projectid
                                               || ''
                                  AND stage_name <> '无分期'
                              UNION ALL
--楼栋
                              SELECT
                                  mdm_build.id,
                                  build_name,
                                  (
                                      CASE
                                          WHEN mdm_period.period_name <> '无分期' THEN
                                              period_id
                                          ELSE
                                              mdm_build.proj_id
                                      END
                                  ) AS parent_id,
                                  lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  mdm_build left
                                  JOIN mdm_period ON mdm_build.period_id = mdm_period.id
                              WHERE
                                  proj_id = ''
                                            || projectid
                                            || ''
                                  AND build_state = 10--10已发布楼栋
                          ) a LEFT JOIN dwm_dt_value   b ON a.id = b.obj_id
                      START WITH
                          a.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR a.id = a.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(a.order_code, ','), 2);

    END IF;

    IF tabsindex = 1 THEN--OR tabsindex = 2-- OR tabsindex = 3 OR tabsindex = 4 OR tabsindex = 5 THEN
        OPEN info FOR SELECT
                          a.id             AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id      AS "parentId",--父级id（生成树父级id）
                          project_name   AS "orgName",--项目/分期/业态/楼栋
                          level,
                          level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '1' || project_name
                              WHEN level = 2 THEN
                                  '        2' || project_name
                              WHEN level = 3 THEN
                                  '                3' || project_name
                              WHEN level = 4 THEN
                                  '                        4' || project_name
                              ELSE
                                  '                                5' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          TO_CHAR(NVL(b.area_dt_all,0), '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR(NVL(b.area_dt_all,0), '999,999,999,999,990.00') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR(NVL(b.area_dt_all,0), '999,999,999,999,990.00') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR(NVL(b.area_reserve,0), '999,999,999,999,990.00') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR(NVL(b.area_in_process,0), '999,999,999,999,990.00') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR(NVL(b.area_stock,0), '999,999,999,999,990.00') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR(NVL(b.area_haved_sale,0), '999,999,999,999,990.00') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR(NVL(b.area_remain,0), '999,999,999,999,990.00') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR(NVL(b.area_allow_sale,0), '999,999,999,999,990.00') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                            CASE
                                WHEN ( b.Area_stock + b.area_haved_sale ) = 0 THEN
                                    '-'
                                ELSE
                                    TO_CHAR(NVL(b.area_haved_sale /(b.area_stock + b.area_haved_sale) * 100,0), '999,999,999,999,990.00'
                                    )
                                    || '%'
                            END
                        )  AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(NVL(b.area_not_planning_permit,0), '999,999,999,999,990.00') AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(NVL(b.area_not_construction_permit,0), '999,999,999,999,990.00') AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(NVL(b.area_not_sale_permit,0), '999,999,999,999,990.00') AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(NVL(b.area_not_completion,0), '999,999,999,999,990.00') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(NVL(b.area_yes_completion,0), '999,999,999,999,990.00') AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(NVL(b.area_yes_settlement,0), '999,999,999,999,990.00') AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR(NVL(b.area_dt_all,0), '999,999,999,999,990.00') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR(NVL(b.cw_area_reserve,0), '999,999,999,999,990.00') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR(NVL(b.cw_area_in_process,0), '999,999,999,999,990.00') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR(NVL(b.cw_area_stock,0), '999,999,999,999,990.00') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR(NVL(b.cw_area_haved_sale,0), '999,999,999,999,990.00') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR(NVL(b.cw_area_not_planning_permit,0), '999,999,999,999,990.00') AS "carportNoPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(NVL(b.cw_area_not_construction_per,0), '999,999,999,999,990.00') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(NVL(b.cw_area_not_sale_permit,0), '999,999,999,999,990.00') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(NVL(b.cw_area_not_completion,0), '999,999,999,999,990.00') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(NVL(b.cw_value_yes_completion,0), '999,999,999,999,990.00') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(NVL(b.cw_area_yes_settlement,0), '999,999,999,999,990.00') AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM
                          (
                              SELECT
                                  id,
                                  project_name,
                                  '' AS parent_id,
                                  sn AS order_code
                              FROM
                                  sys_project
                              WHERE
                                  id = ''
                                       || projectid
                                       || ''
                              UNION ALL
--分期
                              SELECT
                                  id,
                                  stage_name,
                                  project_id AS parent_id,
                                  lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  sys_project_stage
                              WHERE
                                  project_id = ''
                                               || projectid
                                               || ''
                                  AND stage_name <> '无分期'
                              UNION ALL
--楼栋
                              SELECT
                                  mdm_build.id,
                                  build_name,
                                  (
                                      CASE
                                          WHEN mdm_period.period_name <> '无分期' THEN
                                              period_id
                                          ELSE
                                              mdm_build.proj_id
                                      END
                                  ) AS parent_id,
                                  lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  mdm_build left
                                  JOIN mdm_period ON mdm_build.period_id = mdm_period.id
                              WHERE
                                  proj_id = ''
                                            || projectid
                                            || ''
                                  AND build_state = 10--10已发布楼栋
                          ) a LEFT JOIN dwm_dt_value  b ON a.id= b.obj_id
                      START WITH
                          a.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR a.id = a.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(a.order_code, ','), 2);

    END IF;
    
       IF tabsindex = 2 THEN--OR tabsindex = 4 OR tabsindex = 5 THEN
        OPEN info FOR SELECT
                          a.id             AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id      AS "parentId",--父级id（生成树父级id）
                          project_name   AS "orgName",--项目/分期/业态/楼栋
                          level,
                          level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '1' || project_name
                              WHEN level = 2 THEN
                                  '        2' || project_name
                              WHEN level = 3 THEN
                                  '                3' || project_name
                              WHEN level = 4 THEN
                                  '                        4' || project_name
                              ELSE
                                  '                                5' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          TO_CHAR(NVL(b.ZZ_area_dt_all+b.SY_area_dt_all,0), '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR(NVL(b.ZZ_area_dt_all+b.SY_area_dt_all,0), '999,999,999,999,990.00') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR(NVL(b.ZZ_area_dt_all+b.SY_area_dt_all,0), '999,999,999,999,990.00') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR(NVL(b.zz_area_reserve+b.SY_area_reserve,0), '999,999,999,999,990.00') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR(NVL(b.ZZ_area_in_process+b.SY_area_in_process,0), '999,999,999,999,990.00') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR(NVL(b.ZZ_area_stock+ b.sy_Area_stock,0), '999,999,999,999,990.00') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR(NVL(b.ZZ_area_haved_sale+b.sy_area_haved_sale,0), '999,999,999,999,990.00') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR(NVL(b.ZZ_area_remain+b.sy_area_remain,0), '999,999,999,999,990.00') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR(NVL(b.ZZ_area_allow_sale+b.SY_area_allow_sale,0), '999,999,999,999,990.00') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                            CASE
                                WHEN ( b.ZZ_Area_stock + b.ZZ_area_haved_sale +b.SY_Area_stock + b.SY_area_haved_sale ) = 0 THEN
                                    '-'
                                ELSE
                                    TO_CHAR(NVL((b.ZZ_area_haved_sale +b.SY_area_haved_sale)/( b.ZZ_Area_stock + b.ZZ_area_haved_sale +b.SY_Area_stock + b.SY_area_haved_sale) * 100,0), '999,999,999,999,990.00'
                                    )
                                    || '%'
                            END
                        )  AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(NVL(b.ZZ_area_not_planning_permit+b.SY_area_not_planning_permit,0), '999,999,999,999,990.00') AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(NVL(b.ZZ_area_not_construction_per+b.SY_area_not_construction_per,0), '999,999,999,999,990.00') AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(NVL(b.ZZ_area_not_sale_permit+b.SY_area_not_sale_permit,0), '999,999,999,999,990.00') AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(NVL(b.ZZ_area_not_completion+b.SY_area_not_completion,0), '999,999,999,999,990.00') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(NVL(b.ZZ_area_yes_completion+b.SY_area_yes_completion,0), '999,999,999,999,990.00') AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(NVL(b.ZZ_area_yes_settlement+b.SY_area_yes_settlement,0), '999,999,999,999,990.00') AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR(NVL(b.CW_area_dt_all,0), '999,999,999,999,990.00') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR(NVL(b.cw_area_reserve,0), '999,999,999,999,990.00') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR(NVL(b.cw_area_in_process,0), '999,999,999,999,990.00') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR(NVL(b.cw_area_stock,0), '999,999,999,999,990.00') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR(NVL(b.cw_area_haved_sale,0), '999,999,999,999,990.00') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR(NVL(b.cw_area_not_planning_permit,0), '999,999,999,999,990.00') AS "carportNoPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(NVL(b.cw_area_not_construction_per,0), '999,999,999,999,990.00') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(NVL(b.cw_area_not_sale_permit,0), '999,999,999,999,990.00') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(NVL(b.cw_area_not_completion,0), '999,999,999,999,990.00') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(NVL(b.cw_value_yes_completion,0), '999,999,999,999,990.00') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(NVL(b.cw_area_yes_settlement,0), '999,999,999,999,990.00') AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM
                          (
                              SELECT
                                  id,
                                  project_name,
                                  '' AS parent_id,
                                  sn AS order_code
                              FROM
                                  sys_project
                              WHERE
                                  id = ''
                                       || projectid
                                       || ''
                              UNION ALL
--分期
                              SELECT
                                  id,
                                  stage_name,
                                  project_id AS parent_id,
                                  lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  sys_project_stage
                              WHERE
                                  project_id = ''
                                               || projectid
                                               || ''
                                  AND stage_name <> '无分期'
                              UNION ALL
--楼栋
                              SELECT
                                  mdm_build.id,
                                  build_name,
                                  (
                                      CASE
                                          WHEN mdm_period.period_name <> '无分期' THEN
                                              period_id
                                          ELSE
                                              mdm_build.proj_id
                                      END
                                  ) AS parent_id,
                                  lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  mdm_build left
                                  JOIN mdm_period ON mdm_build.period_id = mdm_period.id
                              WHERE
                                  proj_id = ''
                                            || projectid
                                            || ''
                                  AND build_state = 10--10已发布楼栋
                          ) a LEFT JOIN dwm_dt_value  b ON a.id= b.obj_id
                      START WITH
                          a.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR a.id = a.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(a.order_code, ','), 2);

    END IF;
    
    IF tabsindex = 3 THEN--OR tabsindex = 4 OR tabsindex = 5 THEN
        OPEN info FOR SELECT
                          a.id             AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id      AS "parentId",--父级id（生成树父级id）
                          project_name   AS "orgName",--项目/分期/业态/楼栋
                          level,
                          level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '1' || project_name
                              WHEN level = 2 THEN
                                  '        2' || project_name
                              WHEN level = 3 THEN
                                  '                3' || project_name
                              WHEN level = 4 THEN
                                  '                        4' || project_name
                              ELSE
                                  '                                5' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          TO_CHAR(NVL(b.ZZ_area_dt_all,0), '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR(NVL(b.ZZ_area_dt_all,0), '999,999,999,999,990.00') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR(NVL(b.ZZ_area_dt_all,0), '999,999,999,999,990.00') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR(NVL(b.ZZ_area_reserve,0), '999,999,999,999,990.00') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR(NVL(b.ZZ_area_in_process,0), '999,999,999,999,990.00') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR(NVL(b.ZZ_area_stock,0), '999,999,999,999,990.00') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR(NVL(b.ZZ_area_haved_sale,0), '999,999,999,999,990.00') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR(NVL(b.ZZ_area_remain,0), '999,999,999,999,990.00') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR(NVL(b.ZZ_area_allow_sale,0), '999,999,999,999,990.00') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                            CASE
                                WHEN ( b.ZZ_Area_stock + b.ZZ_area_haved_sale ) = 0 THEN
                                    '-'
                                ELSE
                                    TO_CHAR(NVL(b.ZZ_area_haved_sale /(b.ZZ_area_stock + b.ZZ_area_haved_sale) * 100,0), '999,999,999,999,990.00'
                                    )
                                    || '%'
                            END
                        )  AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(NVL(b.ZZ_area_not_planning_permit,0), '999,999,999,999,990.00') AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(NVL(b.ZZ_area_not_construction_per,0), '999,999,999,999,990.00') AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(NVL(b.ZZ_area_not_sale_permit,0), '999,999,999,999,990.00') AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(NVL(b.ZZ_area_not_completion,0), '999,999,999,999,990.00') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(NVL(b.ZZ_area_yes_completion,0), '999,999,999,999,990.00') AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(NVL(b.ZZ_area_yes_settlement,0), '999,999,999,999,990.00') AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR(NVL(b.ZZ_area_dt_all,0), '999,999,999,999,990.00') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR(NVL(b.cw_area_reserve,0), '999,999,999,999,990.00') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR(NVL(b.cw_area_in_process,0), '999,999,999,999,990.00') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR(NVL(b.cw_area_stock,0), '999,999,999,999,990.00') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR(NVL(b.cw_area_haved_sale,0), '999,999,999,999,990.00') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR(NVL(b.cw_area_not_planning_permit,0), '999,999,999,999,990.00') AS "carportNoPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(NVL(b.cw_area_not_construction_per,0), '999,999,999,999,990.00') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(NVL(b.cw_area_not_sale_permit,0), '999,999,999,999,990.00') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(NVL(b.cw_area_not_completion,0), '999,999,999,999,990.00') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(NVL(b.cw_value_yes_completion,0), '999,999,999,999,990.00') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(NVL(b.cw_area_yes_settlement,0), '999,999,999,999,990.00') AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM
                          (
                              SELECT
                                  id,
                                  project_name,
                                  '' AS parent_id,
                                  sn AS order_code
                              FROM
                                  sys_project
                              WHERE
                                  id = ''
                                       || projectid
                                       || ''
                              UNION ALL
--分期
                              SELECT
                                  id,
                                  stage_name,
                                  project_id AS parent_id,
                                  lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  sys_project_stage
                              WHERE
                                  project_id = ''
                                               || projectid
                                               || ''
                                  AND stage_name <> '无分期'
                              UNION ALL
--楼栋
                              SELECT
                                  mdm_build.id,
                                  build_name,
                                  (
                                      CASE
                                          WHEN mdm_period.period_name <> '无分期' THEN
                                              period_id
                                          ELSE
                                              mdm_build.proj_id
                                      END
                                  ) AS parent_id,
                                  lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  mdm_build left
                                  JOIN mdm_period ON mdm_build.period_id = mdm_period.id
                              WHERE
                                  proj_id = ''
                                            || projectid
                                            || ''
                                  AND build_state = 10--10已发布楼栋
                          ) a LEFT JOIN dwm_dt_value  b ON a.id= b.obj_id
                      START WITH
                          a.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR a.id = a.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(a.order_code, ','), 2);

    END IF;
    
       IF tabsindex = 4 THEN--OR tabsindex = 4 OR tabsindex = 5 THEN
        OPEN info FOR SELECT
                          a.id             AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id      AS "parentId",--父级id（生成树父级id）
                          project_name   AS "orgName",--项目/分期/业态/楼栋
                          level,
                          level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '1' || project_name
                              WHEN level = 2 THEN
                                  '        2' || project_name
                              WHEN level = 3 THEN
                                  '                3' || project_name
                              WHEN level = 4 THEN
                                  '                        4' || project_name
                              ELSE
                                  '                                5' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          TO_CHAR(NVL(b.SY_area_dt_all,0), '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR(NVL(b.SY_area_dt_all,0), '999,999,999,999,990.00') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR(NVL(b.SY_area_dt_all,0), '999,999,999,999,990.00') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR(NVL(b.SY_area_reserve,0), '999,999,999,999,990.00') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR(NVL(b.SY_area_in_process,0), '999,999,999,999,990.00') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR(NVL(b.SY_area_stock,0), '999,999,999,999,990.00') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR(NVL(b.SY_area_haved_sale,0), '999,999,999,999,990.00') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR(NVL(b.SY_area_remain,0), '999,999,999,999,990.00') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR(NVL(b.SY_area_allow_sale,0), '999,999,999,999,990.00') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                            CASE
                                WHEN ( b.SY_Area_stock + b.SY_area_haved_sale ) = 0 THEN
                                    '-'
                                ELSE
                                    TO_CHAR(NVL(b.SY_area_haved_sale /(b.SY_area_stock + b.SY_area_haved_sale) * 100,0), '999,999,999,999,990.00'
                                    )
                                    || '%'
                            END
                        )  AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(NVL(b.SY_area_not_planning_permit,0), '999,999,999,999,990.00') AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(NVL(b.SY_area_not_construction_per,0), '999,999,999,999,990.00') AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(NVL(b.SY_area_not_sale_permit,0), '999,999,999,999,990.00') AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(NVL(b.SY_area_not_completion,0), '999,999,999,999,990.00') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(NVL(b.SY_area_yes_completion,0), '999,999,999,999,990.00') AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(NVL(b.SY_area_yes_settlement,0), '999,999,999,999,990.00') AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR(NVL(b.CW_area_dt_all,0), '999,999,999,999,990.00') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR(NVL(b.cw_area_reserve,0), '999,999,999,999,990.00') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR(NVL(b.cw_area_in_process,0), '999,999,999,999,990.00') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR(NVL(b.cw_area_stock,0), '999,999,999,999,990.00') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR(NVL(b.cw_area_haved_sale,0), '999,999,999,999,990.00') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR(NVL(b.cw_area_not_planning_permit,0), '999,999,999,999,990.00') AS "carportNoPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(NVL(b.cw_area_not_construction_per,0), '999,999,999,999,990.00') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(NVL(b.cw_area_not_sale_permit,0), '999,999,999,999,990.00') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(NVL(b.cw_area_not_completion,0), '999,999,999,999,990.00') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(NVL(b.cw_value_yes_completion,0), '999,999,999,999,990.00') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(NVL(b.cw_area_yes_settlement,0), '999,999,999,999,990.00') AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM
                          (
                              SELECT
                                  id,
                                  project_name,
                                  '' AS parent_id,
                                  sn AS order_code
                              FROM
                                  sys_project
                              WHERE
                                  id = ''
                                       || projectid
                                       || ''
                              UNION ALL
--分期
                              SELECT
                                  id,
                                  stage_name,
                                  project_id AS parent_id,
                                  lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  sys_project_stage
                              WHERE
                                  project_id = ''
                                               || projectid
                                               || ''
                                  AND stage_name <> '无分期'
                              UNION ALL
--楼栋
                              SELECT
                                  mdm_build.id,
                                  build_name,
                                  (
                                      CASE
                                          WHEN mdm_period.period_name <> '无分期' THEN
                                              period_id
                                          ELSE
                                              mdm_build.proj_id
                                      END
                                  ) AS parent_id,
                                  lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  mdm_build left
                                  JOIN mdm_period ON mdm_build.period_id = mdm_period.id
                              WHERE
                                  proj_id = ''
                                            || projectid
                                            || ''
                                  AND build_state = 10--10已发布楼栋
                          ) a LEFT JOIN dwm_dt_value  b ON a.id= b.obj_id
                      START WITH
                          a.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR a.id = a.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(a.order_code, ','), 2);

    END IF;
    
       IF tabsindex = 5 THEN--OR tabsindex = 4 OR tabsindex = 5 THEN
        OPEN info FOR SELECT
                          a.id             AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id      AS "parentId",--父级id（生成树父级id）
                          project_name   AS "orgName",--项目/分期/业态/楼栋
                          level,
                          level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '1' || project_name
                              WHEN level = 2 THEN
                                  '        2' || project_name
                              WHEN level = 3 THEN
                                  '                3' || project_name
                              WHEN level = 4 THEN
                                  '                        4' || project_name
                              ELSE
                                  '                                5' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          TO_CHAR(NVL(b.CW_area_dt_all,0), '999,999,999,999,999') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR(NVL(b.CW_area_dt_all,0), '999,999,999,999,999') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR(NVL(b.CW_area_dt_all,0), '999,999,999,999,999') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR(NVL(b.CW_area_reserve,0), '999,999,999,999,999') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR(NVL(b.CW_area_in_process,0), '999,999,999,999,999') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR(NVL(b.CW_area_stock,0), '999,999,999,999,999') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR(NVL(b.CW_area_haved_sale,0), '999,999,999,999,999') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR(NVL(b.CW_area_remain,0), '999,999,999,999,999') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR(NVL(b.CW_area_allow_sale,0), '999,999,999,999,999') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                            CASE
                                WHEN ( b.CW_Area_stock + b.CW_area_haved_sale ) = 0 THEN
                                    '-'
                                ELSE
                                    TO_CHAR(NVL(b.CW_area_haved_sale /(b.CW_area_stock + b.CW_area_haved_sale) * 100,0), '999,999,999,999,999'
                                    )
                                    || '%'
                            END
                        )  AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(NVL(b.CW_area_not_planning_permit,0), '999,999,999,999,999') AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(NVL(b.CW_area_not_construction_per,0), '999,999,999,999,999') AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(NVL(b.CW_area_not_sale_permit,0), '999,999,999,999,999') AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(NVL(b.CW_area_not_completion,0), '999,999,999,999,999') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(NVL(b.CW_area_yes_completion,0), '999,999,999,999,999') AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(NVL(b.CW_area_yes_settlement,0), '999,999,999,999,999') AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR(NVL(b.CW_area_dt_all,0), '999,999,999,999,999') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR(NVL(b.cw_area_reserve,0), '999,999,999,999,999') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR(NVL(b.cw_area_in_process,0), '999,999,999,999,999') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR(NVL(b.cw_area_stock,0), '999,999,999,999,999') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR(NVL(b.cw_area_haved_sale,0), '999,999,999,999,999') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR(NVL(b.cw_area_not_planning_permit,0), '999,999,999,999,999') AS "carportNoPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(NVL(b.cw_area_not_construction_per,0), '999,999,999,999,999') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(NVL(b.cw_area_not_sale_permit,0), '999,999,999,999,999') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(NVL(b.cw_area_not_completion,0), '999,999,999,999,999') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(NVL(b.cw_value_yes_completion,0), '999,999,999,999,999') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(NVL(b.cw_area_yes_settlement,0), '999,999,999,999,999') AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM
                          (
                              SELECT
                                  id,
                                  project_name,
                                  '' AS parent_id,
                                  sn AS order_code
                              FROM
                                  sys_project
                              WHERE
                                  id = ''
                                       || projectid
                                       || ''
                              UNION ALL
--分期
                              SELECT
                                  id,
                                  stage_name,
                                  project_id AS parent_id,
                                  lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  sys_project_stage
                              WHERE
                                  project_id = ''
                                               || projectid
                                               || ''
                                  AND stage_name <> '无分期'
                              UNION ALL
--楼栋
                              SELECT
                                  mdm_build.id,
                                  build_name,
                                  (
                                      CASE
                                          WHEN mdm_period.period_name <> '无分期' THEN
                                              period_id
                                          ELSE
                                              mdm_build.proj_id
                                      END
                                  ) AS parent_id,
                                  lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  mdm_build left
                                  JOIN mdm_period ON mdm_build.period_id = mdm_period.id
                              WHERE
                                  proj_id = ''
                                            || projectid
                                            || ''
                                  AND build_state = 10--10已发布楼栋
                          ) a LEFT JOIN dwm_dt_value  b ON a.id= b.obj_id
                      START WITH
                          a.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR a.id = a.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(a.order_code, ','), 2);

    END IF;

END p_dwm_dt_area_dtl;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DT_AREA_LIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_DT_AREA_LIST" (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    unitid         IN             VARCHAR2, --选择公司id
    isoperate      IN             VARCHAR2,--是否操盘
    tabsindex      IN             INT, --选择选项卡。1开始
    info           OUT            SYS_REFCURSOR--返回结果
) AS
--动态货量管理-全案动态货量
--作者：陈丽
--日期：2019/12/17
    data_auth_spid   VARCHAR2(200);
    bizcode          VARCHAR2(200);
    unitid_val       VARCHAR2(200);
BEGIN 
    --权限编码
    unitid_val:=nvl(unitid,'003200000000000000000000000000');
    bizcode := 'DWM.DTHZGL.03';
    p_sys_get_company_proj_spid(userid => userid, stationid => stationid, deptid => departmentid, companyid => companyid, bizcode
    => bizcode, data_auth_spid => data_auth_spid);

    IF tabsindex = 1 THEN
        dbms_output.put_line('所有业态!');
    ELSIF tabsindex = 2 THEN
        dbms_output.put_line('住宅及商办!');
    ELSIF tabsindex = 3 THEN
        dbms_output.put_line('住宅!');
    ELSIF tabsindex = 4 THEN
        dbms_output.put_line('商办!');
    ELSIF tabsindex = 5 THEN
        dbms_output.put_line('车位!');
    ELSIF tabsindex = 6 THEN
        dbms_output.put_line('剩余货量表!');
        OPEN info FOR 
				WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   MDM_PROJECT A1
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
				
				
				SELECT
                          a.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id   AS "parentId",--父级id（生成树父级id）
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/value-project/detail?code=area_dtl&isOperate='
                                  || proj_cooperate
                                  || '&projectId='
                                  || a.id
                                  || '&projectName='
                                  || org_name
                                  || '&projectDate='
                                  || take_date
                                  || '&tabIndex='
                                  || tabsindex
                                  || '&pageTitle='
                                  || org_name--页面标题名称
                              ELSE
                                  ''
                          END AS "openUrl",--详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/dynamic-volume/circular?companyId='
                                  || a.parent_id
                                  || '&projectId='
                                  || a.id
                                  || '&type=2'--companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
                              ELSE
                                  ''
                          END AS "openVisualUrl",--打开可视化地址
                          ORG_LEVEL,
                          CASE
                              WHEN ORG_LEVEL = 1 THEN
                                  '#eaf6ff'
                              WHEN ORG_LEVEL = 2 THEN
                                  '#ecfbee'
                              WHEN ORG_LEVEL = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN ORG_LEVEL = 1 THEN
                                  '' || org_name
                              WHEN ORG_LEVEL = 2 THEN
                                  '        ' || org_name
                              WHEN ORG_LEVEL = 3 THEN
                                  '                ' || org_name
                              WHEN ORG_LEVEL = 4 THEN
                                  '                        ' || org_name
                              ELSE
                                  '                                '|| org_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          org_name      AS "orgName",--公司/项目
                          TO_CHAR( SUM(a.zz_area_remain), '999,999,999,999,990.00') AS "projWholeDwellingArea",--项目全案剩余可售货量（S=A+B+C+D）-住宅(m2)
                          TO_CHAR( SUM(a.sy_area_remain), '999,999,999,999,990.00') AS "projWholeBusinessArea",--项目全案剩余可售货量（S=A+B+C+D）-商业(m2)
                          TO_CHAR( SUM(a.cw_area_remain), '999,999,999,999,990.00') AS "projWholeCarport",--项目全案剩余可售货量（S=A+B+C+D）-车位(个)
                          TO_CHAR(( SUM(a.cw_area_remain)+SUM(a.sy_area_remain)+SUM(a.zz_area_remain)), '999,999,999,999,990.00') AS "projWholeTotalArea",--项目全案剩余可售货量（S=A+B+C+D）-合计(m2)
                          TO_CHAR( SUM(a.zz_area_not_planning_permit), '999,999,999,999,990.00') AS "ADwellingArea",--A未取规证的可售货量-住宅(m2)
                          TO_CHAR( SUM(A.sy_area_not_planning_permit), '999,999,999,999,990.00') AS "ABusinessArea",--A未取规证的可售货量-商业(m2)
                          TO_CHAR( SUM(A.cw_area_not_planning_permit), '999,999,999,999,990.00') AS "ACarport",--A未取规证的可售货量-车位(个)
                          TO_CHAR(( SUM(A.zz_area_not_planning_permit)+SUM(a.sy_area_not_planning_permit)+SUM(a.cw_area_not_planning_permit)), '999,999,999,999,990.00'
                          ) AS "ATotalArea",--A未取规证的可售货量-合计(m2)
                          TO_CHAR( SUM(A.zz_area_not_construction_per), '999,999,999,999,990.00') AS "BDwellingArea",--B已取规证未取施工证的可售货量-住宅(m2)
                          TO_CHAR( SUM(A.sy_area_not_construction_per), '999,999,999,999,990.00') AS "BBusinessArea",--B已取规证未取施工证的可售货量-商业(m2)
                          TO_CHAR( SUM(A.cw_area_not_construction_per), '999,999,999,999,990.00') AS "BCarport",--B已取规证未取施工证的可售货量-车位(个)
                          TO_CHAR(( SUM(A.zz_area_not_construction_per)+SUM(A.sy_area_not_construction_per)+SUM(A.cw_area_not_construction_per)), '999,999,999,999,990.00'
                          ) AS "BTotalArea",--B已取规证未取施工证的可售货量-合计(m2)
                          TO_CHAR( SUM(A.zz_area_not_sale_permit), '999,999,999,999,990.00') AS "CDwellingArea",--C已取规证未取预售证的可售货量-住宅(m2)
                          TO_CHAR( SUM(a.sy_area_not_sale_permit), '999,999,999,999,990.00') AS "CBusinessArea",--C已取规证未取预售证的可售货量-商业(m2)
                          TO_CHAR( SUM(a.cw_area_not_sale_permit), '999,999,999,999,990.00') AS "CCarport",--C已取规证未取预售证的可售货量-车位(个)
                          TO_CHAR(( SUM(a.zz_area_not_sale_permit)+SUM(a.sy_area_not_sale_permit)+SUM(a.cw_area_not_sale_permit)), '999,999,999,999,990.00') AS "CTotalArea"
                          ,--C已取规证未取预售证的可售货量-合计(m2)
                          TO_CHAR( SUM(a.zz_area_stock), '999,999,999,999,990.00') AS "DDwellingArea",--D已取预售证未售的可售货量-住宅(m2)
                          TO_CHAR( SUM(A.sy_area_stock), '999,999,999,999,990.00') AS "DBusinessArea",--D已取预售证未售的可售货量-商业(m2)
                          TO_CHAR( SUM(A.cw_area_stock), '999,999,999,999,990.00') AS "DCarport",--D已取预售证未售的可售货量-车位(个)
                          TO_CHAR((SUM(A.zz_area_stock)+SUM(A.sy_area_stock)+SUM(A.cw_area_stock)), '999,999,999,999,990.00') AS "DTotalArea"--D已取预售证未售的可售货量-合计(m2)
                      FROM
                         TEMP_DT_VALUE A
												 INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
                       --WHERE  a.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END)    
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE order by ORDER_HIERARCHY_CODE;

    END IF;

    IF tabsindex = 1 OR tabsindex = 2  THEN
        OPEN info FOR 
				WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   MDM_PROJECT A1
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
				SELECT
                          a.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id   AS "parentId",--父级id（生成树父级id）
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/area-project/detail?code=area_dtl&isOperate='
                                  || proj_cooperate
                                  || '&projectId='
                                  || a.id--项目id
                                  || '&projectName='
                                  || org_name---项目名称
                                  || '&projectDate='
                                  || take_date--项目获取时间
                                  || '&tabIndex='
                                  || tabsindex--选中的tabindex
                                  || '&pageTitle='
                                  || org_name--页面标题名称
                              ELSE
                                  ''
                          END AS "openUrl",--详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/dynamic-volume/circular?companyId='
                                  || a.parent_id---公司id
                                  || '&projectId='
                                  || a.id---项目id
                                  || '&type=1'--companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
                              ELSE
                                  ''
                          END AS "openVisualUrl",--打开可视化地址
                          ORG_LEVEL,
                          CASE
                              WHEN ORG_LEVEL = 1 THEN
                                  '#eaf6ff'
                              WHEN ORG_LEVEL = 2 THEN
                                  '#ecfbee'
                              WHEN ORG_LEVEL = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN ORG_LEVEL = 1 THEN
                                  '' || org_name
                              WHEN ORG_LEVEL = 2 THEN
                                  '        ' || org_name
                              WHEN ORG_LEVEL = 3 THEN
                                  '                ' || org_name
                              WHEN ORG_LEVEL = 4 THEN
                                  '                        ' || org_name
                              ELSE
                                  '                                '|| org_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          org_name      AS "orgName",--项目/分期/业态/楼栋
                          TO_CHAR( SUM(A.area_dt_all), '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR( SUM(A.area_dt_all), '999,999,999,999,990.00') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR( SUM(A.area_dt_all), '999,999,999,999,990.00') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR( SUM(A.area_reserve), '999,999,999,999,990.00') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR( SUM(A.AREA_IN_PROCESS), '999,999,999,999,990.00') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR( SUM(A.area_stock), '999,999,999,999,990.00') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR(SUM(A.area_haved_sale), '999,999,999,999,990.00') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR( SUM(A.area_remain), '999,999,999,999,990.00') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR( SUM(A.area_allow_sale), '999,999,999,999,990.00') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                              CASE
                                  WHEN ( SUM(A.area_stock)+SUM(A.area_haved_sale)) = 0 THEN
                                      '-'
                                  ELSE
                                      TO_CHAR( SUM(A.area_haved_sale) /( SUM(a.area_stock)+SUM(a.area_haved_sale)) * 100, '999,999,999,999,990.00'
                                      )
                                      || '%'
                              END
                          ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(( SUM(A.zz_area_not_planning_permit)+SUM(A.sy_area_not_planning_permit)), '999,999,999,999,990.00'
                          ) AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(( SUM(A.zz_area_not_construction_per)+SUM(A.sy_area_not_construction_per)), '999,999,999,999,990.00'
                          ) AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(( SUM(A.zz_area_not_sale_permit)+SUM(A.sy_area_not_sale_permit)), '999,999,999,999,990.00'
                          ) AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR( SUM(a.area_not_completion), '999,999,999,999,990.00') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(( SUM(a.zz_area_yes_completion)+SUM(a.sy_area_yes_completion)), '999,999,999,999,990.00'
                          ) AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          '-' AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR( SUM(a.cw_area_dt_all), '999,999,999,999,990.00') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR( SUM(a.cw_value_reserve), '999,999,999,999,990.00') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR( SUM(a.cw_area_in_process), '999,999,999,999,990.00') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR( SUM(a.cw_area_stock), '999,999,999,999,990.00') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR( SUM(a.cw_area_haved_sale), '999,999,999,999,990.00') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR( SUM(a.area_not_planning_permit), '999,999,999,999,990.00') AS "carportNoPermitObtainedPhase"
                          ,--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR( SUM(a.area_not_construction_permit), '999,999,999,999,990.00') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR( SUM(a.area_not_sale_permit), '999,999,999,999,990.00') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR( SUM(A.area_not_completion), '999,999,999,999,990.00') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR( SUM(a.area_yes_completion), '999,999,999,999,990.00') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          '-' AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM
                          TEMP_DT_VALUE A
												 INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
                      -- WHERE  a.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END)    
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE order by ORDER_HIERARCHY_CODE; 


    ELSIF tabsindex = 3  THEN
        OPEN info FOR 
				WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   MDM_PROJECT A1
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
				SELECT
                          a.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id   AS "parentId",--父级id（生成树父级id）
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/area-project/detail?code=area_dtl&isOperate='
                                  || proj_cooperate
                                  || '&projectId='
                                  || a.id--项目id
                                  || '&projectName='
                                  || org_name---项目名称
                                  || '&projectDate='
                                  || take_date--项目获取时间
                                  || '&tabIndex='
                                  || tabsindex--选中的tabindex
                                  || '&pageTitle='
                                  || org_name--页面标题名称
                              ELSE
                                  ''
                          END AS "openUrl",--详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/dynamic-volume/circular?companyId='
                                  || a.parent_id---公司id
                                  || '&projectId='
                                  || a.id---项目id
                                  || '&type=1'--companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
                              ELSE
                                  ''
                          END AS "openVisualUrl",--打开可视化地址
                          ORG_LEVEL,
                          CASE
                              WHEN ORG_LEVEL = 1 THEN
                                  '#eaf6ff'
                              WHEN ORG_LEVEL = 2 THEN
                                  '#ecfbee'
                              WHEN ORG_LEVEL = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN ORG_LEVEL = 1 THEN
                                  '' || org_name
                              WHEN ORG_LEVEL = 2 THEN
                                  '        ' || org_name
                              WHEN ORG_LEVEL = 3 THEN
                                  '                ' || org_name
                              WHEN ORG_LEVEL = 4 THEN
                                  '                        ' || org_name
                              ELSE
                                  '                                '|| org_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          org_name      AS "orgName",--项目/分期/业态/楼栋
                          TO_CHAR( SUM(A.zz_area_dt_all), '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR( SUM(a.zz_area_dt_all), '999,999,999,999,990.00') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR( SUM(A.zz_area_dt_all), '999,999,999,999,990.00') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR( SUM(a.zz_area_reserve), '999,999,999,999,990.00') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR( SUM(A.zz_AREA_IN_PROCESS), '999,999,999,999,990.00') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR( SUM(A.zz_area_stock), '999,999,999,999,990.00') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR( SUM(A.zz_area_haved_sale), '999,999,999,999,990.00') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR( SUM(A.zz_area_remain), '999,999,999,999,990.00') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR( SUM(A.zz_area_allow_sale), '999,999,999,999,990.00') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                              CASE
                                  WHEN ( SUM(a.zz_area_stock)+SUM(a.zz_area_haved_sale)) = 0 THEN
                                      '-'
                                  ELSE
                                      TO_CHAR( SUM(A.zz_area_haved_sale) /( SUM(A.zz_area_stock)+SUM(A.zz_area_haved_sale)) * 100, '999,999,999,999,990.00'
                                      )
                                      || '%'
                              END
                          ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR( SUM(A.zz_area_not_planning_permit), '999,999,999,999,990.00'
                          ) AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR( SUM(A.zz_area_not_construction_per), '999,999,999,999,990.00'
                          ) AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR( SUM(A.zz_area_not_sale_permit), '999,999,999,999,990.00'
                          ) AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR( SUM(A.zz_area_not_completion), '999,999,999,999,990.00') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR( SUM(A.zz_area_yes_completion), '999,999,999,999,990.00'
                          ) AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          '-' AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR( SUM(a.cw_area_dt_all), '999,999,999,999,990.00') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR( SUM(a.cw_value_reserve), '999,999,999,999,990.00') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR( SUM(A.cw_area_in_process), '999,999,999,999,990.00') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR( SUM(A.cw_area_stock), '999,999,999,999,990.00') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR( SUM(A.cw_area_haved_sale), '999,999,999,999,990.00') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR( SUM(A.zz_area_not_planning_permit), '999,999,999,999,990.00') AS "carportNoPermitObtainedPhase"
                          ,--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR( SUM(A.zz_area_not_construction_per), '999,999,999,999,990.00') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR( SUM(A.zz_area_not_sale_permit), '999,999,999,999,990.00') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR( SUM(a.zz_area_not_completion), '999,999,999,999,990.00') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR( SUM(A.zz_area_yes_completion), '999,999,999,999,990.00') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          '-' AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM   TEMP_DT_VALUE A
            INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
                       --WHERE  a.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END)    
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE order by ORDER_HIERARCHY_CODE;
						
ELSIF tabsindex = 4  THEN
        OPEN info FOR 
				WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   MDM_PROJECT A1
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
				SELECT
                          a.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id   AS "parentId",--父级id（生成树父级id）
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/area-project/detail?code=area_dtl&isOperate='
                                  || proj_cooperate
                                  || '&projectId='
                                  || a.id--项目id
                                  || '&projectName='
                                  || org_name---项目名称
                                  || '&projectDate='
                                  || take_date--项目获取时间
                                  || '&tabIndex='
                                  || tabsindex--选中的tabindex
                                  || '&pageTitle='
                                  || org_name--页面标题名称
                              ELSE
                                  ''
                          END AS "openUrl",--详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/dynamic-volume/circular?companyId='
                                  || a.parent_id---公司id
                                  || '&projectId='
                                  || a.id---项目id
                                  || '&type=1'--companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
                              ELSE
                                  ''
                          END AS "openVisualUrl",--打开可视化地址
                          ORG_LEVEL,
                          CASE
                              WHEN ORG_LEVEL = 1 THEN
                                  '#eaf6ff'
                              WHEN ORG_LEVEL = 2 THEN
                                  '#ecfbee'
                              WHEN ORG_LEVEL = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN ORG_LEVEL = 1 THEN
                                  '' || org_name
                              WHEN ORG_LEVEL = 2 THEN
                                  '        ' || org_name
                              WHEN ORG_LEVEL = 3 THEN
                                  '                ' || org_name
                              WHEN ORG_LEVEL = 4 THEN
                                  '                        ' || org_name
                              ELSE
                                  '                                '|| org_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          org_name      AS "orgName",--项目/分期/业态/楼栋
                          TO_CHAR( SUM(A.sy_area_dt_all), '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR( SUM(A.sy_area_dt_all), '999,999,999,999,990.00') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR( SUM(a.sy_area_dt_all), '999,999,999,999,990.00') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR( SUM(a.sy_area_reserve), '999,999,999,999,990.00') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR( SUM(a.sy_AREA_IN_PROCESS), '999,999,999,999,990.00') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR( SUM(a.sy_area_stock), '999,999,999,999,990.00') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR( SUM(a.sy_area_haved_sale), '999,999,999,999,990.00') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR( SUM(a.sy_area_remain), '999,999,999,999,990.00') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR( SUM(a.sy_area_allow_sale), '999,999,999,999,990.00') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                              CASE
                                  WHEN ( SUM(A.sy_area_stock)+SUM(A.sy_area_haved_sale)) = 0 THEN
                                      '-'
                                  ELSE
                                      TO_CHAR( SUM(A.sy_area_haved_sale) /( SUM(A.sy_area_stock)+SUM(A.sy_area_haved_sale)) * 100, '999,999,999,999,990.00'
                                      )
                                      || '%'
                              END
                          ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR( SUM(A.sy_area_not_planning_permit), '999,999,999,999,990.00'
                          ) AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR( SUM(a.sy_area_not_construction_per), '999,999,999,999,990.00'
                          ) AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR( SUM(A.sy_area_not_sale_permit), '999,999,999,999,990.00'
                          ) AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR( SUM(a.sy_area_not_completion), '999,999,999,999,990.00') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR( SUM(A.sy_area_yes_completion), '999,999,999,999,990.00'
                          ) AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          '-' AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR( SUM(A.cw_area_dt_all), '999,999,999,999,990.00') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR( SUM(A.cw_value_reserve), '999,999,999,999,990.00') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR( SUM(a.cw_area_in_process), '999,999,999,999,990.00') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR( SUM(a.cw_area_stock), '999,999,999,999,990.00') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR( SUM(a.cw_area_haved_sale), '999,999,999,999,990.00') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR( SUM(a.sy_area_not_planning_permit), '999,999,999,999,990.00') AS "carportNoPermitObtainedPhase"
                          ,--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR( SUM(a.sy_area_not_construction_per), '999,999,999,999,990.00') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR( SUM(a.sy_area_not_sale_permit), '999,999,999,999,990.00') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR( SUM(a.sy_area_not_completion), '999,999,999,999,990.00') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR( SUM(a.sy_area_yes_completion), '999,999,999,999,990.00') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          '-' AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM   TEMP_DT_VALUE A
            INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
                      -- WHERE  a.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END)    
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE order by ORDER_HIERARCHY_CODE;

ELSIF tabsindex = 5  THEN
        OPEN info FOR 
				WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   MDM_PROJECT A1
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
				SELECT
                          a.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id   AS "parentId",--父级id（生成树父级id）
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/area-project/detail?code=area_dtl&isOperate='
                                  || proj_cooperate
                                  || '&projectId='
                                  || a.id--项目id
                                  || '&projectName='
                                  || org_name---项目名称
                                  || '&projectDate='
                                  || take_date--项目获取时间
                                  || '&tabIndex='
                                  || tabsindex--选中的tabindex
                                  || '&pageTitle='
                                  || org_name--页面标题名称
                              ELSE
                                  ''
                          END AS "openUrl",--详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/dynamic-volume/circular?companyId='
                                  || a.parent_id---公司id
                                  || '&projectId='
                                  || a.id---项目id
                                  || '&type=1'--companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
                              ELSE
                                  ''
                          END AS "openVisualUrl",--打开可视化地址
                          ORG_LEVEL,
                          CASE
                              WHEN ORG_LEVEL = 1 THEN
                                  '#eaf6ff'
                              WHEN ORG_LEVEL = 2 THEN
                                  '#ecfbee'
                              WHEN ORG_LEVEL = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN ORG_LEVEL = 1 THEN
                                  '' || org_name
                              WHEN ORG_LEVEL = 2 THEN
                                  '        ' || org_name
                              WHEN ORG_LEVEL = 3 THEN
                                  '                ' || org_name
                              WHEN ORG_LEVEL = 4 THEN
                                  '                        ' || org_name
                              ELSE
                                  '                                '|| org_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          org_name      AS "orgName",--项目/分期/业态/楼栋
                          TO_CHAR( SUM(A.cw_area_dt_all), '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR( SUM(A.cw_area_dt_all), '999,999,999,999,990.00') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR( SUM(A.cw_area_dt_all), '999,999,999,999,990.00') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR( SUM(A.Cw_Area_Reserve), '999,999,999,999,990.00') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR( SUM(A.cw_AREA_IN_PROCESS), '999,999,999,999,990.00') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR( SUM(A.cw_area_stock), '999,999,999,999,990.00') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR( SUM(a.cw_area_haved_sale), '999,999,999,999,990.00') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR( SUM(A.cw_area_remain), '999,999,999,999,990.00') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR( SUM(a.cw_area_allow_sale), '999,999,999,999,990.00') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                              CASE
                                  WHEN ( SUM(a.cw_area_stock)+SUM(a.cw_area_haved_sale)) = 0 THEN
                                      '-'
                                  ELSE
                                      TO_CHAR( SUM(a.cw_area_haved_sale) /( SUM(a.cw_area_stock)+SUM(a.cw_area_haved_sale)) * 100, '999,999,999,999,990.00'
                                      )
                                      || '%'
                              END
                          ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR( SUM(a.cw_area_not_planning_permit), '999,999,999,999,990.00'
                          ) AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR( SUM(a.cw_area_not_construction_per), '999,999,999,999,990.00'
                          ) AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR( SUM(a.cw_area_not_sale_permit), '999,999,999,999,990.00'
                          ) AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR( SUM(a.cw_area_not_completion), '999,999,999,999,990.00') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR( SUM(a.cw_area_yes_completion), '999,999,999,999,990.00'
                          ) AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          '-' AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR( SUM(a.cw_area_dt_all), '999,999,999,999,990.00') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR( SUM(a.Cw_Area_Reserve), '999,999,999,999,990.00') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR( SUM(a.cw_area_in_process), '999,999,999,999,990.00') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR( SUM(a.cw_area_stock), '999,999,999,999,990.00') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR( SUM(a.cw_area_haved_sale), '999,999,999,999,990.00') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR( SUM(a.cw_area_not_planning_permit), '999,999,999,999,990.00') AS "carportNoPermitObtainedPhase"
                          ,--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR( SUM(a.cw_area_not_construction_per), '999,999,999,999,990.00') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR( SUM(a.cw_area_not_sale_permit), '999,999,999,999,990.00') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR( SUM(a.cw_area_not_completion), '999,999,999,999,990.00') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR( SUM(a.cw_area_yes_completion), '999,999,999,999,990.00') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          '-' AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM   TEMP_DT_VALUE A
            INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
                          
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE order by ORDER_HIERARCHY_CODE;
    END IF;
		

END p_dwm_dt_area_list;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DT_EXCEL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_DT_EXCEL" (
    userid          IN              VARCHAR2, --当前用户id
    stationid       IN              VARCHAR2, --当前用户岗位id
    departmentid    IN              VARCHAR2, --当前用户部门id
    companyid       IN              VARCHAR2, --当前用户公司id
    unitid          IN              VARCHAR2, --选择公司id
    isoperate       IN              VARCHAR2,--是否操盘
    dttype          IN              VARCHAR2,--类型： dt_value:货值，dt_area:货量，value_dtl:货值，area_dtl:货量
    tabsindex       IN              INT, --选择选项卡。1开始
    colorfiled      OUT             VARCHAR2,--excel 指定颜色字段名称
    exceldescribe   OUT             VARCHAR2,--excel 顶部描述，空不显示对应区域
    excelname       OUT             VARCHAR2,--excel导出文件名，已弃用
    excelfileds     OUT             SYS_REFCURSOR,--excel需要导出的列及中文列名，及表头颜色
    info            OUT             SYS_REFCURSOR--返回结果
) AS
--动态货量管理-全案动态货量
--作者：陈丽
--日期：2019/12/17
    data_auth_spid   VARCHAR2(200);
    bizcode          VARCHAR2(200);
    v_sql            CLOB;
    v_tab1_sql       CLOB;
    v_build_sql      CLOB;
    v_tab2_sql       CLOB;
    v_tab3_sql       CLOB;
    v_pub_sql        CLOB;
    v_sql_exec       CLOB;
BEGIN
    exceldescribe := '全案动态表';--excel 顶部描述，空不显示对应区域
    excelname := '';--excel导出文件名，已弃用
    colorfiled := 'excelRowBgColor';
    v_build_sql := 'SELECT
                           2  as "order",
                           get_uuid() AS "id",
                             '''' AS "parentId",
                            ''newestBuildArea'' AS "filed",
                            ''最新建筑面积'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION '
    ;
    v_pub_sql := 'SELECT
                           1 as "order",
                             get_uuid() AS "id",
                             '''' AS "parentId",
                            ''excelRowTextTreeOrgName'' AS "filed",
                          case when '''
                 || dttype
                 || ''' = ''dt_value'' or '''
                 || dttype
                 || ''' = ''dt_area'' then ''公司/项目'' else ''项目/分期/业态/楼栋'' end AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                            UNION 
                        '
                 ;
    IF ( dttype = 'dt_area' OR dttype = 'area_dtl' ) THEN
        IF ( dttype = 'dt_area' ) THEN
            p_dwm_dt_area_list(userid => userid, stationid => stationid, departmentid => departmentid, companyid => companyid, unitid
            => unitid, isoperate => isoperate, tabsindex => tabsindex, info => info);
        ELSE
            p_dwm_dt_area_dtl(userid => userid, stationid => stationid, departmentid => departmentid, companyid => companyid, projectid
            => unitid, isoperate => isoperate, tabsindex => tabsindex, info => info);
        END IF;
        v_tab1_sql := '  
                        SELECT
                             3  as "order",
                             get_uuid() AS "id",
                             '''' AS "parentId",
                            ''newestSalesArea'' AS "filed",
                            ''最新可售面积（不含车位）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                            UNION
                            SELECT
                            4  as "order",
                            ''1'' AS "id",
                            '''' AS "parentId",
                            ''noCarportDynamicCargo'' AS "filed",
                            ''动态货量（不含车位）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                            4.1  as "order",
                            get_uuid() AS "id",
                             ''1'' AS "parentId",
                            ''dynamicCargo'' AS "filed",
                            ''动态货量'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor" --表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                         4.2  as "order",
                         get_uuid() AS "id",
                             ''1'' AS "parentId",
                            ''reserveCargo'' AS "filed",
                            ''储备货量(A1)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        4.3  as "order",
                         get_uuid() AS "id",
                             ''1'' AS "parentId",
                            ''inProcessTotalCargo'' AS "filed",
                            ''在途货量(A2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        4.4 as "order",
                         get_uuid() AS "id",
                             ''1'' AS "parentId",
                            ''stockCargo'' AS "filed",
                            ''库存货量(A3)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        4.5  as "order",
                         get_uuid() AS "id",
                             ''1'' AS "parentId",
                            ''alreadySalesCargo'' AS "filed",
                            ''已售货量(A4)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        5  as "order",
                              ''2'' AS "id",
                            '''' AS "parentId",
                            ''noPermitObtainedPhase'' AS "filed",
                            ''动态货量的各阶段分布（不含车位）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                          SELECT
                          5.1 as "order",
                            get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''noPermitObtainedPhase'' AS "filed",
                            ''0未取规证'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                          5.2  as "order",
                        get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''PermitObtainedOhase'' AS "filed",
                            ''1规划许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                          SELECT
                          5.3  as "order",
                          get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''constructionPermitOhase'' AS "filed",
                            ''2施工许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                         5.4  as "order",
                         get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''PreSalePermitPhase'' AS "filed",
                            ''3预售许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                          5.5 as "order",
                         get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''completedRecordPhase'' AS "filed",
                            ''4竣备阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                          5.6  as "order",
                         get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''carryDownPhase'' AS "filed",
                            ''5结转阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual'
        ;
        v_tab2_sql := ' 
                        SELECT
                           6  as "order",
                            ''3'' AS "id",
                            '''' AS "parentId",
                            ''dynamicCargo'' AS "filed",
                            ''动态货量（车位按“个”）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        6.1 as "order",
                            get_uuid() AS "id",
                             ''3'' AS "parentId",
                            ''carportDynamicCargo'' AS "filed",
                            ''动态货量'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor" --表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        6.2 as "order",
                         get_uuid() AS "id",
                             ''3'' AS "parentId",
                            ''carportReserveCargo'' AS "filed",
                            ''储备货量(A1)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        6.3  as "order",
                         get_uuid() AS "id",
                             ''3'' AS "parentId",
                            ''carportInProcessTotalCargo'' AS "filed",
                            ''在途货量(A2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        6.4  as "order",
                         get_uuid() AS "id",
                             ''3'' AS "parentId",
                            ''carportStockCargo'' AS "filed",
                            ''库存货量(A3)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        6.5  as "order",
                         get_uuid() AS "id",
                             ''3'' AS "parentId",
                            ''carportAlreadySalesCargo'' AS "filed",
                            ''已售货量(A4)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        7  as "order",
                              ''4'' AS "id",
                            '''' AS "parentId",
                            ''permitObtainedPhase'' AS "filed",
                            ''动态货量的各阶段分布（车位按“个”）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                          SELECT
                          7.1  as "order",
                            get_uuid() AS "id",
                             ''4'' AS "parentId",
                            ''carportNoPermitObtainedPhase'' AS "filed",
                            ''0未取规证'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        7.2  as "order",
                        get_uuid() AS "id",
                             ''4'' AS "parentId",
                            ''carportPermitObtainedOhase'' AS "filed",
                            ''1规划许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                          SELECT
                         7.3  as "order",
                          get_uuid() AS "id",
                             ''4'' AS "parentId",
                            ''carportConstructionPermitOhase'' AS "filed",
                            ''2施工许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                         7.4  as "order",
                         get_uuid() AS "id",
                             ''4'' AS "parentId",
                            ''carportPreSalePermitPhase'' AS "filed",
                            ''3预售许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                         7.5 as "order",
                         get_uuid() AS "id",
                             ''4'' AS "parentId",
                            ''carportCompletedRecordPhase'' AS "filed",
                            ''4竣备阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor" --表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                        7.6 as "order",
                         get_uuid() AS "id",
                             ''4'' AS "parentId",
                            ''carportCarryDownPhase'' AS "filed",
                            ''5结转阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual'
        ;
        v_tab3_sql := ' 
                        SELECT
                       8  as "order",
                            ''5'' AS "id",
                             '''' AS "parentId",
                            ''projSurplusArea'' AS "filed",
                            ''项目全案剩余可售货量（S=A+B+C+D）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                         8.1  as "order",
                             get_uuid() AS "id",
                             ''5'' AS "parentId",
                            ''projWholeDwellingArea'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                            UNION
                            SELECT
                            8.2 as "order",
                             get_uuid() AS "id",
                            ''5'' AS "parentId",
                            ''projWholeBusinessArea'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                         8.3 as "order",
                            get_uuid() AS "id",
                             ''5'' AS "parentId",
                            ''projWholeCarport'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor" --表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                         8.4  as "order",
                         get_uuid() AS "id",
                             ''5'' AS "parentId",
                            ''projWholeTotalArea'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                         9  as "order",
                         ''6'' AS "id",
                             '''' AS "parentId",
                            ''noA'' AS "filed",
                            ''A未取规证的可售货量'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        9.1  as "order",
                         get_uuid() AS "id",
                             ''6'' AS "parentId",
                            ''ADwellingArea'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                         9.2  as "order",
                         get_uuid() AS "id",
                             ''6'' AS "parentId",
                            ''ABusinessArea'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        9.3  as "order",
                             get_uuid() AS "id",
                            ''6'' AS "parentId",
                            ''ACarport'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                          SELECT
                           9.4 as "order",
                            get_uuid() AS "id",
                             ''6'' AS "parentId",
                            ''ATotalArea'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                            UNION
                        SELECT
                         10  as "order",
                         ''7'' AS "id",
                             '''' AS "parentId",
                            ''noB1'' AS "filed",
                            ''B已取规证未取施工证的可售货量'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        10.1  as "order",
                         get_uuid() AS "id",
                             ''7'' AS "parentId",
                            ''BDwellingArea'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                         10.2 as "order",
                         get_uuid() AS "id",
                             ''7'' AS "parentId",
                            ''BBusinessArea'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                         10.3  as "order",
                             get_uuid() AS "id",
                            ''7'' AS "parentId",
                            ''BCarport'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                          SELECT
                           10.4  as "order",
                            get_uuid() AS "id",
                             ''7'' AS "parentId",
                            ''BTotalArea'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual   
                        UNION
                        SELECT
                         11 as "order",
                        ''8'' AS "id",
                             '''' AS "parentId",
                            ''CA'' AS "filed",
                            ''C已取施工证未取预售证的可售货量'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                          SELECT
                            11.1 as "order",
                          get_uuid() AS "id",
                             ''8'' AS "parentId",
                            ''CDwellingArea'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                           11.2 as "order",
                         get_uuid() AS "id",
                             ''8'' AS "parentId",
                            ''CBusinessArea'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                           11.3 as "order",
                         get_uuid() AS "id",
                             ''8'' AS "parentId",
                            ''CCarport'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                          11.4 as "order",
                         get_uuid() AS "id",
                             ''8'' AS "parentId",
                            ''CTotalArea'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                             UNION
                         SELECT
                          12 as "order",
                         ''9'' AS "id",
                             '''' AS "parentId",
                            ''DA'' AS "filed",
                            ''D已取预售证未售的可售货量'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                            UNION
                         SELECT
                           12.1 as "order",
                         get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''DDwellingArea'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                             UNION
                         SELECT
                           12.2 as "order",
                         get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''DBusinessArea'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                             UNION
                         SELECT
                           12.3 as "order",
                         get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''DCarport'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                              UNION
                         SELECT
                          12.4 as "order",
                         get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''DTotalArea'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                            '
        ;
        IF ( tabsindex = 1 ) THEN
            v_sql := v_pub_sql
                     || v_build_sql
                     || v_tab1_sql
                     || ' UNION '
                     || v_tab2_sql;
        ELSIF ( tabsindex = 2 OR tabsindex = 3 OR tabsindex = 4 ) THEN
            v_sql := v_pub_sql
                     || v_build_sql
                     || v_tab1_sql;
        ELSIF ( tabsindex = 5 ) THEN
            v_sql := v_pub_sql
                     || v_build_sql
                     || v_tab2_sql;
        ELSIF ( tabsindex = 6 ) THEN
            v_sql := v_pub_sql || v_tab3_sql;
        ELSE
            v_sql := v_pub_sql
                     || v_build_sql
                     || v_tab2_sql;
        END IF;
        v_sql_exec := 'select  level,
                             a."id",
                            a."parentId",
                            a."filed",
                            a."filedName",
                            a."filedTitleBgColor",
                            a."filedTitleColor"  from ('
                      || v_sql
                      || ') a   START WITH
                            "parentId" IS NULL
                        CONNECT BY
                            PRIOR "id" = "parentId"  order by a."order"'
                      ;
        dbms_output.put_line(v_sql_exec);
        OPEN excelfileds FOR v_sql_exec;
    ELSE
        IF ( dttype = 'dt_value' ) THEN
            p_dwm_dt_value_list(userid => userid, stationid => stationid, departmentid => departmentid, companyid => companyid, unitid
            => unitid, isoperate => isoperate, tabsindex => tabsindex, info => info);
        ELSE
            p_dwm_dt_value_dtl(userid => userid, stationid => stationid, departmentid => departmentid, companyid => companyid, projectid
            => unitid, isoperate => isoperate, tabsindex => tabsindex, info => info);
        END IF;
        v_tab1_sql := ' SELECT
                          3 as "order",
                          ''2'' AS "id",
                             '''' AS "parentId",
                            ''A1'' AS "filed",
                            ''目标总货值（A）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                            SELECT
                              3.1 as "order",
                         get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''targetFeasibleWorth'' AS "filed",
                            ''可研版(A1)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                              SELECT
                                3.2 as "order",
                         get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''targetWholeWorth'' AS "filed",
                            ''全盘版(A2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               3.3 as "order",
                         get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''targetDynamicWorth'' AS "filed",
                            ''动态版(A3)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               3.4 as "order",
                         get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''targetNewestWorth'' AS "filed",
                            ''最新版(A4)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               4 as "order",
                         ''3'' AS "id",
                             '''' AS "parentId",
                            ''dynamicTotalWorth'' AS "filed",
                            ''动态总货值(B)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                              5 as "order",
                            ''4'' AS "id",
                             '''' AS "parentId",
                            ''dynamicTotalWorthExportText'' AS "filed",
                            ''总货值差额(B-A)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                               6 as "order",
                           ''5'' AS "id",
                             '''' AS "parentId",
                            ''dt'' AS "filed",
                            ''动态总货值构成（B=B1+B2+B3+B4）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               6.1 as "order",
                           get_uuid() AS "id",
                             ''5'' AS "parentId",
                            ''reserveTotalWorth'' AS "filed",
                            ''储备货值(B1)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                              6.2 as "order",
                           get_uuid() AS "id",
                             ''5'' AS "parentId",
                            ''inProcessTotalWorth'' AS "filed",
                            ''在途货值(B2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                               UNION
                             SELECT
                              6.3 as "order",
                           get_uuid() AS "id",
                             ''5'' AS "parentId",
                            ''stockWorth'' AS "filed",
                            ''库存货值(B3)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                             SELECT
                              6.4 as "order",
                           get_uuid() AS "id",
                             ''5'' AS "parentId",
                            ''alreadySalesWorth'' AS "filed",
                            ''已售货值(B4)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                              7 as "order",
                           ''6'' AS "id",
                             '''' AS "parentId",
                            ''residueWorth'' AS "filed",
                            ''剩余货值(C=B1+B2+B3)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                               8 as "order",
                           ''7'' AS "id",
                             '''' AS "parentId",
                            ''getWorth'' AS "filed",
                            ''已领证货值(D=B3+B4)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               9 as "order",
                           ''8'' AS "id",
                             '''' AS "parentId",
                            ''salesRate'' AS "filed",
                            ''去化率(E=B4/D)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                               10 as "order",
                           ''9'' AS "id",
                             '''' AS "parentId",
                            ''noPlanningPermitObtainedPhase'' AS "filed",
                            ''F、动态货值的各阶段分布'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               10.1 as "order",
                              get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''noPlanningPermitObtainedPhase'' AS "filed",
                            ''F0未取规证'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                               UNION
                             SELECT
                               10.2 as "order",
                              get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''planningPermitObtainedOhase'' AS "filed",
                            ''F1规划许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                               10.3 as "order",
                              get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''constructionPermitOhase'' AS "filed",
                            ''F2施工许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                              10.4 as "order",
                              get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''PreSalePermitPhase'' AS "filed",
                            ''F3预售许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                                10.5 as "order",
                              get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''completedRecordPhase'' AS "filed",
                            ''F4竣备阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                               UNION
                             SELECT
                                10.6 as "order",
                              get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''carryDownPhase'' AS "filed",
                            ''F5结转阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                               UNION
                             SELECT
                                11 as "order",
                             ''10'' AS "id",
                             '''' AS "parentId",
                            ''G1'' AS "filed",
                            ''G1、储备货值的量价情况'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               11.1 as "order",
                             get_uuid() AS "id",
                             ''10'' AS "parentId",
                            ''reserveWorth'' AS "filed",
                            ''货值（G1=a1*b1）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                               11.2 as "order",
                             get_uuid() AS "id",
                             ''10'' AS "parentId",
                            ''reserveCargo'' AS "filed",
                            ''货值(a1)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                               11.3 as "order",
                             get_uuid() AS "id",
                             ''10'' AS "parentId",
                            ''reservePrice'' AS "filed",
                            ''单价(b1)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               12 as "order",
                             ''11'' AS "id",
                             '''' AS "parentId",
                            ''reservePrice'' AS "filed",
                            ''G2、在途货值的量价情况'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               12.1 as "order",
                             get_uuid() AS "id",
                             ''11'' AS "parentId",
                            ''inTransitWorth'' AS "filed",
                            ''货值（G2=a2*b2）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                               12.2 as "order",
                             get_uuid() AS "id",
                             ''11'' AS "parentId",
                            ''inTransitCargo'' AS "filed",
                            ''货值(a2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               12.3 as "order",
                             get_uuid() AS "id",
                             ''11'' AS "parentId",
                            ''inTransitPrice'' AS "filed",
                            ''单价(b2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                               13 as "order",
                             ''12'' AS "id",
                             '''' AS "parentId",
                            ''G3'' AS "filed",
                            ''G3、库存货值的量价情况'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                                  13.1 as "order",
                             get_uuid() AS "id",
                             ''12'' AS "parentId",
                            ''stockWorth'' AS "filed",
                            ''货值（G3=a3*b3）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                               UNION
                             SELECT
                                  13.2 as "order",
                             get_uuid() AS "id",
                             ''12'' AS "parentId",
                            ''stockCargo'' AS "filed",
                            ''货值(a3)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                                  13.3 as "order",
                             get_uuid() AS "id",
                             ''12'' AS "parentId",
                            ''stockPrice'' AS "filed",
                            ''单价(b3)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                                  14 as "order",
                             ''13'' AS "id",
                             '''' AS "parentId",
                            ''G4'' AS "filed",
                            ''G4、已售货值的量价情况'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                                14.1 as "order",
                            get_uuid() AS "id",
                             ''13'' AS "parentId",
                            ''soldWorth'' AS "filed",
                            ''货值（G4=a4*b4）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                                14.2 as "order",
                            get_uuid() AS "id",
                             ''13'' AS "parentId",
                            ''soldCargo'' AS "filed",
                            ''货值(a4)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                             SELECT
                                14.3 as "order",
                            get_uuid() AS "id",
                             ''13'' AS "parentId",
                            ''soldPrice'' AS "filed",
                            ''单价(b4)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual '
        ;
        v_tab2_sql := ' SELECT
                              15 as "order",
                            ''14'' AS "id",
                             '''' AS "parentId",
                            ''S1'' AS "filed",
                            ''项目全案剩余可售货值（万元）（S=A+B+C+D）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                            SELECT
                            15.1 as "order",
                          get_uuid() AS "id",
                             ''14'' AS "parentId",
                            ''projWholeDwellingValue'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                               SELECT
                                   15.2 as "order",
                          get_uuid() AS "id",
                             ''14'' AS "parentId",
                            ''projWholeBusinessValue'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                 SELECT
                                   15.3 as "order",
                          get_uuid() AS "id",
                             ''14'' AS "parentId",
                            ''projWholeCarportValue'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                  SELECT
                                    15.4 as "order",
                          get_uuid() AS "id",
                             ''14'' AS "parentId",
                            ''projWholeTotalValue'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                            SELECT
                              16 as "order",
                            ''15'' AS "id",
                             '''' AS "parentId",
                            ''S2'' AS "filed",
                            ''A未取规证的可售货值（万元）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                            SELECT
                              16.1 as "order",
                          get_uuid() AS "id",
                             ''15'' AS "parentId",
                            ''ADwellingValue'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                               SELECT
                               16.2 as "order",
                          get_uuid() AS "id",
                             ''15'' AS "parentId",
                            ''ABusinessValue'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                 SELECT
                                 16.3 as "order",
                          get_uuid() AS "id",
                             ''15'' AS "parentId",
                            ''ACarportValue'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                  SELECT
                                  16.4 as "order",
                          get_uuid() AS "id",
                             ''15'' AS "parentId",
                            ''ATotalValue'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                             SELECT
                             17 as "order",
                            ''16'' AS "id",
                             '''' AS "parentId",
                            ''S3'' AS "filed",
                            ''B已取规证未取施工证的可售货值（万元）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                            SELECT
                              17.1 as "order",
                          get_uuid() AS "id",
                             ''16'' AS "parentId",
                            ''BDwellingValue'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                               SELECT
                                  17.2 as "order",
                          get_uuid() AS "id",
                             ''16'' AS "parentId",
                            ''BBusinessValue'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                 SELECT
                                   17.3 as "order",
                          get_uuid() AS "id",
                             ''16'' AS "parentId",
                            ''BCarportValue'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                  SELECT
                                    17.4 as "order",
                          get_uuid() AS "id",
                             ''16'' AS "parentId",
                            ''BTotalValue'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                SELECT
                                  18 as "order",
                            ''17'' AS "id",
                             '''' AS "parentId",
                            ''S4'' AS "filed",
                            ''C已取施工证未取预售证的可售货值（万元）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                            SELECT
                            18.1 as "order",
                          get_uuid() AS "id",
                             ''17'' AS "parentId",
                            ''CDwellingValue'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                               SELECT
                               18.2 as "order",
                          get_uuid() AS "id",
                             ''17'' AS "parentId",
                            ''CBusinessValue'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                 SELECT
                                 18.3 as "order",
                          get_uuid() AS "id",
                             ''17'' AS "parentId",
                            ''CCarportValue'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                  SELECT
                                  18.4 as "order",
                          get_uuid() AS "id",
                             ''17'' AS "parentId",
                            ''CTotalValue'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                               SELECT
                               19 as "order",
                            ''18'' AS "id",
                             '''' AS "parentId",
                            ''S5'' AS "filed",
                            ''D已取预售证未售的可售货值（万元）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                            SELECT
                                19.1 as "order",
                          get_uuid() AS "id",
                             ''18'' AS "parentId",
                            ''DDwellingValue'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                               SELECT
                                  19.2 as "order",
                          get_uuid() AS "id",
                             ''18'' AS "parentId",
                            ''DBusinessValue'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                 SELECT
                                          19.3 as "order",
                          get_uuid() AS "id",
                             ''18'' AS "parentId",
                            ''DCarportValue'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                  SELECT
                                           19.4 as "order",
                          get_uuid() AS "id",
                             ''18'' AS "parentId",
                            ''DTotalValue'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual '
        ;
        IF ( tabsindex = 1 OR tabsindex = 2 OR tabsindex = 3 OR tabsindex = 4 OR tabsindex = 5 ) THEN
            v_sql := v_pub_sql || v_tab1_sql;
        ELSIF ( tabsindex = 6 ) THEN
            v_sql := v_pub_sql || v_tab2_sql;
        END IF;
        v_sql_exec := 'select  level,
                              a."id",
                            a."parentId",
                            a."filed",
                            a."filedName",
                            a."filedTitleBgColor",
                            a."filedTitleColor"  from ('
                      || v_sql
                      || ') a   START WITH
                            "parentId" IS NULL
                        CONNECT BY
                            PRIOR "id" = "parentId" order by a."order" '
                      ;
        OPEN excelfileds FOR v_sql_exec;
    END IF;
 END p_dwm_dt_excel;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DT_VALUE_DTL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_DT_VALUE_DTL" (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    projectid      IN             VARCHAR2, --选择公司id
    tabsindex      IN             VARCHAR2, --选择选项卡。1开始
    isoperate      IN             VARCHAR2,--是否操盘
    info           OUT            SYS_REFCURSOR
) AS
--动态货值管理-全案动态货值-详情
--作者：陈丽
--日期：2019/12/17
BEGIN
 IF tabsindex = 1 THEN
        dbms_output.put_line('所有业态!');
    ELSIF tabsindex = 2 THEN
        dbms_output.put_line('住宅及商办!');
    ELSIF tabsindex = 3 THEN
        dbms_output.put_line('住宅!');
    ELSIF tabsindex = 4 THEN
        dbms_output.put_line('商办!');
    ELSIF tabsindex = 5 THEN
        dbms_output.put_line('车位!');
    ELSIF tabsindex = 6 THEN
        dbms_output.put_line('剩余货量表!');
        OPEN info FOR SELECT
                          t.id             AS "id",--主键id（生成树的id，唯一可以是业务id）
                           level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '' || project_name
                              WHEN level = 2 THEN
                                  '        ' || project_name
                              WHEN level = 3 THEN
                                  '                ' || project_name
                              WHEN level = 4 THEN
                                  '                        ' || project_name
                              ELSE
                                  '                                ' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          t.parent_id      AS "parentId",--父级id（生成树父级id）
                          project_name   AS "orgName",--项目/分期/业态/楼栋
                          TO_CHAR(nvl(round(b.zz_value_remain/10000,2),0), 'fm999,999,999,990.00') AS "projWholeDwellingValue",--项目全案剩余可售货值（S=A+B+C+D）-住宅(m2)
                          TO_CHAR(nvl(round(b.SY_value_remain/10000,2),0), 'fm999,999,999,990.00') AS "projWholeBusinessValue",--项目全案剩余可售货值（S=A+B+C+D）-商业(m2)
                          TO_CHAR(nvl(round(b.CW_value_remain/10000,2),0), 'fm999,999,999,990.00') AS "projWholeCarportValue",--项目全案剩余可售货值（S=A+B+C+D）-车位(个)
                          TO_CHAR(nvl(round((b.zz_value_remain+b.SY_value_remain+b.CW_value_remain)/10000,2),0), 'fm999,999,999,990.00') AS "projWholeTotalValue",--项目全案剩余可售货值（S=A+B+C+D）-合计(m2)

                          TO_CHAR(nvl(round(b.zz_value_not_planning_permit/10000,2),0), 'fm999,999,999,990.00') AS "ADwellingValue",--A未取规证的可售货值-住宅(m2)
                          TO_CHAR(nvl(round(b.SY_value_not_planning_permit/10000,2),0), 'fm999,999,999,990.00') AS "ABusinessValue",--A未取规证的可售货值-商业(m2)
                          TO_CHAR(nvl(round(b.CW_value_not_planning_permit/10000,2),0), 'fm999,999,999,990.00') AS "ACarportValue",--A未取规证的可售货值-车位(个)
                          TO_CHAR(nvl(round((b.ZZ_value_not_planning_permit+b.SY_value_not_planning_permit+b.CW_value_not_planning_permit)/10000,2),0), 'fm999,999,999,990.00') AS "ATotalValue",--A未取规证的可售货值-合计(m2)

                          TO_CHAR(nvl(round(b.zz_value_not_construction_per/10000,2),0), 'fm999,999,999,990.00') AS "BDwellingValue",--B已取规证未取施工证的可售货值-住宅(m2)
                          TO_CHAR(nvl(round(b.SY_value_not_construction_per/10000,2),0), 'fm999,999,999,990.00') AS "BBusinessValue",--B已取规证未取施工证的可售货值-商业(m2)
                          TO_CHAR(nvl(round(b.CW_value_not_construction_per/10000,2),0), 'fm999,999,999,990.00') AS "BCarportValue",--B已取规证未取施工证的可售货值-车位(个)
                          TO_CHAR(nvl(round((b.zz_value_not_construction_per+b.SY_value_not_construction_per+b.CW_value_not_construction_per)/10000,2),0), 'fm999,999,999,990.00') AS "BTotalValue",--B已取规证未取施工证的可售货值-合计(m2)

                          TO_CHAR(nvl(round(b.zz_value_not_sale_permit/10000,2),0), 'fm999,999,999,990.00') AS "CDwellingValue",--C已取施工证未取预售证的可售货值-住宅(m2)
                          TO_CHAR(nvl(round(b.sy_value_not_sale_permit/10000,2),0), 'fm999,999,999,990.00') AS "CBusinessValue",--C已取施工证未取预售证的可售货值-商业(m2)
                          TO_CHAR(nvl(round(b.cw_value_not_sale_permit/10000,2),0), 'fm999,999,999,990.00') AS "CCarportValue",--C已取施工证未取预售证的可售货值-车位(个)
                         TO_CHAR(nvl( round((b.zz_value_not_sale_permit+b.sy_value_not_sale_permit+b.Cw_value_not_sale_permit)/10000,2),0), 'fm999,999,999,990.00') AS "CTotalValue",--C已取施工证未取预售证的可售货值-合计(m2)

                          TO_CHAR(nvl(round(b.zz_value_stock/10000,2),0), 'fm999,999,999,990.00') AS "DDwellingValue",--D已取预售证未售的可售货值-住宅(m2)
                        TO_CHAR(nvl(round(b.sy_value_stock/10000,2),0), 'fm999,999,999,990.00') AS "DBusinessValue",--D已取预售证未售的可售货值-商业(m2)
                         TO_CHAR(nvl(round(b.cw_value_stock/10000,2),0), 'fm999,999,999,990.00') AS "DCarportValue",--D已取预售证未售的可售货值-车位(个)
                          TO_CHAR(nvl(round((b.zz_value_stock+b.sy_value_stock+b.cw_value_stock)/10000,2),0), 'fm999,999,999,990.00') AS "DTotalValue"--D已取预售证未售的可售货值-合计(m2)
                       FROM
                          (
                              SELECT
                                  id,
                                  project_name,
                                  '' AS parent_id,
                                  sn AS order_code
                              FROM
                                  sys_project
                              WHERE
                                  id = ''
                                       || projectid
                                       || ''
                              UNION ALL
--分期
                              SELECT
                                  id,
                                  stage_name,
                                  project_id AS parent_id,
                                  lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  sys_project_stage
                              WHERE
                                  project_id = ''
                                               || projectid
                                               || ''  AND stage_name<>'无分期'
                              UNION ALL
--楼栋
                              SELECT
                                  mdm_build.id,
                                  mdm_build.build_name||'（'||v_MDM_BUILDING.Permit_Status||'）' AS BuildName,
                              (CASE WHEN mdm_period.period_name<>'无分期' THEN  period_id ELSE mdm_build.proj_id END)  AS parent_id,
                                  lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  mdm_build LEFT JOIN mdm_period ON mdm_build.period_id=mdm_period.id
                                  LEFT JOIN v_MDM_BUILDING ON mdm_build.id=v_MDM_BUILDING.BUILDINGID
                              WHERE
                                  mdm_build.proj_id = ''
                                            || projectid
                                            || ''
                                  AND build_state = 10--10已发布楼栋
                          ) t LEFT JOIN dwm_dt_value   b ON t.id = b.obj_id
                       START WITH
                          t.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR t.id = t.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(t.order_code, ','), 2);

    END IF;

    IF tabsindex = 1 THEN
    OPEN info FOR SELECT
                      t.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                       level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '' || project_name
                              WHEN level = 2 THEN
                                  '        ' || project_name
                              WHEN level = 3 THEN
                                  '                ' || project_name
                              WHEN level = 4 THEN
                                  '                        ' || project_name
                              ELSE
                                  '                                ' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                      t.parent_id   AS "parentId",--父级id（生成树父级id）
                      project_name    AS "orgName",--公司/项目
                        TO_CHAR(nvl(b.area_dt_all,0), 'fm999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
                        TO_CHAR(nvl(nvl(b.area_dt_all, 0),0), 'fm999,999,999,999,990.00') AS "targetSalesArea",--最新可售面积（不含车位）
                        TO_CHAR(nvl(b.TARGET_A1_VALUE,0), 'fm999,999,999,999,990.00') AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
                        TO_CHAR(nvl(b.TARGET_A2_VALUE,0), 'fm999,999,999,999,990.00')  AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
                        TO_CHAR( nvl(b.TARGET_A3_VALUE, 0), 'fm999,999,999,999,990.00') AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
                        TO_CHAR( NVL(b.TARGET_A_VALUE,0), 'fm999,999,999,999,990.00') AS "targetNewestWorth",--目标总货值（A）-最新版(A)
                        TO_CHAR(nvl(b.value_dt_all / 10000,0), 'fm999,999,999,999,990.00') AS "dynamicTotalWorth",--动态总货值(B)
                       (CASE WHEN round(nvl(b.value_dt_all,0) / 10000 - nvl(b.TARGET_A_VALUE,0),2)<0 
                         THEN  '<font color=red>'||TO_CHAR(round(b.value_dt_all / 10000 - nvl(b.TARGET_A_VALUE,0),2), 'fm999,999,999,999,990.00')||'</font>'
                         ELSE  '<font color=green>'||TO_CHAR(round(b.value_dt_all / 10000 - nvl(b.TARGET_A_VALUE,0),2), 'fm999,999,999,999,990.00')||'</font>'
                         END  ) AS "dynamicTotalWorthDifference"
                        ,--总货值差额(B-A)
                        TO_CHAR(nvl(b.value_reserve / 10000,0), 'fm999,999,999,999,990.00') AS "reserveTotalWorth",--动态总货值构成（B=B1+B2+B3+B4）---动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1) 
                        TO_CHAR(nvl(b.value_in_process / 10000,0), 'fm999,999,999,999,990.00') AS "inProcessTotalWorth",--动态总货值构成（B=B1+B2+B3+B4）-在途货值(B2)
                        TO_CHAR(nvl(b.value_stock/10000 ,0), 'fm999,999,999,999,990.00') AS "stockWorth",--动态总货值构成（B=B1+B2+B3+B4）-库存货值(B3)
                        TO_CHAR(nvl(b.value_haved_sale / 10000,0), 'fm999,999,999,999,990.00') AS "alreadySalesWorth",--动态总货值构成（B=B1+B2+B3+B4）-已售货值(B4)
                        TO_CHAR(nvl((b.value_remain) / 10000,0), 'fm999,999,999,999,990.00') AS "residueWorth",---剩余货值(C=B1+B2+B3)
                        TO_CHAR(nvl((b.value_stock + b.value_haved_sale) / 10000,0), 'fm999,999,999,999,990.00') AS "getWorth",--已领证货值(D=B3+B4)
                        (
                            CASE
                                WHEN ( b.value_stock + b.value_haved_sale ) = 0 THEN
                                    '-'
                                ELSE
                                    TO_CHAR(nvl(b.value_haved_sale /(b.value_stock + b.value_haved_sale) * 100,0), 'fm999,999,999,999,990.00'
                                    )
                                    || '%'
                            END
                        ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(nvl(b.value_not_planning_permit / 10000,0), 'fm999,999,999,999,990.00') AS "noPlanningPermitObtainedPhase",--F、动态货值的各阶段分布-F0未取规证
                          TO_CHAR(nvl(b.value_not_construction_permit / 10000,0), 'fm999,999,999,999,990.00') AS "planningPermitObtainedOhase",--F、动态货值的各阶段分布-F1规划许可证阶段
                          TO_CHAR(nvl(b.value_not_sale_permit / 10000,0), 'fm999,999,999,999,990.00') AS "constructionPermitOhase",--F、动态货值的各阶段分布-F2施工许可证阶段
                          TO_CHAR(nvl(b.value_not_completion / 10000,0), 'fm999,999,999,999,990.00') AS "PreSalePermitPhase",--F、动态货值的各阶段分布-F3预售许可证阶段
                          --TO_CHAR(nvl(b.value_yes_completion / 10000,0), 'fm999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          TO_CHAR(nvl(b.value_yes_completion / 10000,0), 'fm999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          '-' AS "carryDownPhase",--F、动态货值的各阶段分布-F5结转阶段

                          TO_CHAR(nvl(b.value_reserve / 10000,0), 'fm999,999,999,999,990.00') AS "reserveWorth",--G1、储备货值的量价情况-货值（G1=a1*b1）
                          TO_CHAR(nvl(b.zz_area_reserve+b.SY_area_reserve,0), 'fm999,999,999,999,990.00') AS "reserveCargo",--G1、储备货值的量价情况-货量(a1)
                          '-' AS "reservePrice",--G1、储备货值的量价情况-单价(b1)
                          TO_CHAR(nvl(b.value_in_process / 10000,0), 'fm999,999,999,999,990.00') AS "inTransitWorth",--G2、在途货值的量价情况-货值（G2=a2*b2）
                          TO_CHAR(nvl(b.zz_area_in_process+b.SY_area_in_process,0), 'fm999,999,999,999,990.00') AS "inTransitCargo",--G2、在途货值的量价情况-货量(a2)
                          '-' AS "inTransitPrice",--G2、在途货值的量价情况-单价(b2)
                          TO_CHAR(nvl(b.value_stock / 10000,0), 'fm999,999,999,999,990.00') AS "stockWorth",--G3、库存货值的量价情况-货值（G3=a3*b3）
                          TO_CHAR(nvl(b.zz_area_stock+b.sy_area_stock,0), 'fm999,999,999,999,990.00') AS "stockCargo",--G3、库存货值的量价情况-货量(a3)
                          '-' AS "stockPrice",--G3、库存货值的量价情况-单价(b3)
                          TO_CHAR(nvl(b.value_haved_sale / 10000,0), 'fm999,999,999,999,990.00') AS "soldWorth",--G4、已售货值的量价情况-货值（G4=a4*b4）
                          TO_CHAR(nvl(b.zz_area_haved_sale+b.sy_area_haved_sale,0), 'fm999,999,999,999,990.00') AS "soldCargo",--G4、已售货值的量价情况-货量(a4)
                          '-' AS "soldPrice"--G4、已售货值的量价情况-单价(b4)
                  FROM
                      (
                          SELECT
                              id,
                              project_name,
                              '' AS parent_id,
                              sn AS order_code,
                              '项目' AS Obj_Type
                          FROM
                              sys_project
                          WHERE
                              id = ''
                                   || projectid
                                   || ''
                          UNION ALL
--分期
                          SELECT
                              id,
                              stage_name,
                              project_id AS parent_id,
                              lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code,
                              '分期' AS Obj_Type
                          FROM
                              sys_project_stage
                          WHERE
                              project_id = ''|| projectid|| '' AND stage_name<>'无分期'

                          UNION ALL
--楼栋
                          SELECT
                              mdm_build.id,
                               mdm_build.build_name||'（'||nvl(mdm_build.NEWEST_VALUE_PHASE,'未取证')||'）' AS BuildName,
                              (CASE WHEN mdm_period.period_name<>'无分期' THEN  period_id ELSE mdm_build.proj_id END)  AS parent_id,
                              lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code,
                              '楼栋' AS Obj_Type
                          FROM
                              mdm_build LEFT JOIN mdm_period ON mdm_build.period_id=mdm_period.id
                              LEFT JOIN v_MDM_BUILDING ON mdm_build.id=v_MDM_BUILDING.BUILDINGID
                          WHERE
                              mdm_build.proj_id = ''
                                        || projectid
                                        || ''
                              AND build_state = 10--10已发布楼栋
                      ) t LEFT JOIN dwm_dt_value  b ON t.id= b.obj_id
                          LEFT JOIN dwm_target_worth c1 ON b.obj_id = c1.proj_id  AND c1.target_worth_phase = 0 and c1.IS_DELETE=0 
                               AND c1.approval_status IN ('已审核','审核中')
                          LEFT JOIN dwm_target_worth c2 ON b.obj_id = c2.proj_id AND c2.target_worth_phase = 10 and c2.IS_DELETE=0
                                AND c2.approval_status IN ('已审核','审核中')
                          LEFT JOIN dwm_target_worth c3 ON b.obj_id = c3.proj_id AND c3.target_worth_phase = 20 and c3.IS_DELETE=0
                               AND c3.approval_status IN ('已审核','审核中') AND c3.id IN (SELECT id FROM V_DWM_TARGET_WORTH_NOW)
                          LEFT JOIN v_dwm_target_worth_now c4 ON b.obj_id= c4.proj_id
                               AND c4.approval_status IN ('已审核','审核中')
                          LEFT JOIN v_dwm_target_worth_dtl_now d ON b.obj_id=d.obj_id AND d.obj_type=30
                   START WITH
                          t.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR t.id = t.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(t.order_code, ','), 2);
    END IF;

    IF tabsindex = 2 THEN--OR tabsindex = 3 OR tabsindex = 4 OR tabsindex = 5 
    OPEN info FOR SELECT
                      t.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                       level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '' || project_name
                              WHEN level = 2 THEN
                                  '        ' || project_name
                              WHEN level = 3 THEN
                                  '                ' || project_name
                              WHEN level = 4 THEN
                                  '                        ' || project_name
                              ELSE
                                  '                                ' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                      t.parent_id   AS "parentId",--父级id（生成树父级id）
                      project_name    AS "orgName",--公司/项目
                        TO_CHAR(nvl(b.area_dt_all,0), 'fm999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
                        TO_CHAR(nvl(nvl(b.area_dt_all, 0),0), 'fm999,999,999,999,990.00') AS "targetSalesArea",--最新可售面积（不含车位）
                        (CASE WHEN b.obj_type='楼栋' THEN '-' ELSE TO_CHAR(nvl(nvl(c1.target_worth, 0),0), 'fm999,999,999,999,990.00') END)AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
                        (CASE WHEN b.obj_type='楼栋' THEN '-' ELSE TO_CHAR(nvl(nvl(c2.target_worth, 0),0), 'fm999,999,999,999,990.00') END) AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
                        TO_CHAR(nvl(nvl(c3.target_worth, 0),0), 'fm999,999,999,999,990.00') AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
                        TO_CHAR(nvl(nvl(c4.target_worth, 0),0), 'fm999,999,999,999,990.00') AS "targetNewestWorth",--目标总货值（A）-最新版(A)
                        TO_CHAR(nvl(b.value_dt_all / 10000,0), 'fm999,999,999,999,990.00') AS "dynamicTotalWorth",--动态总货值(B)
                       (CASE WHEN b.value_dt_all / 10000 - nvl(c4.target_worth, 0)<0 
                         THEN  '<font color=red>'||TO_CHAR(nvl(b.value_dt_all / 10000 - nvl(c4.target_worth, 0),0), 'fm999,999,999,999,990.00')||'</font>'
                         ELSE  '<font color=green>'||TO_CHAR(nvl(b.value_dt_all / 10000 - nvl(c4.target_worth, 0),0), 'fm999,999,999,999,990.00')||'</font>'
                         END  ) AS "dynamicTotalWorthDifference"
                        ,--总货值差额(B-A)
                          TO_CHAR(nvl((b.ZZ_value_reserve+b.SY_value_reserve) / 10000,0), 'fm999,999,999,999,990.00') AS "reserveTotalWorth",----动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1) 20200101 修正字段reserveWorth=》reserveTotalWorth
                          TO_CHAR(nvl((b.ZZ_value_in_process+b.SY_value_in_process) / 10000,0), 'fm999,999,999,999,990.00') AS "inProcessTotalWorth",--在途货值(B2)
                          TO_CHAR(nvl((b.ZZ_value_stock+b.SY_value_stock)/10000 ,0), 'fm999,999,999,999,990.00') AS "stockWorth",--库存货值(B3)
                          TO_CHAR(nvl((b.ZZ_value_haved_sale+b.SY_value_haved_sale) / 10000,0), 'fm999,999,999,999,990.00') AS "alreadySalesWorth",--已售货值(B4)
                          TO_CHAR(nvl((b.ZZ_value_remain+b.SY_value_remain) / 10000,0), 'fm999,999,999,999,990.00') AS "residueWorth",--剩余货值(C=B1+B2+B3)
                          TO_CHAR(nvl((b.ZZ_value_stock + b.ZZ_value_haved_sale+b.SY_value_stock + b.SY_value_haved_sale) / 10000,0), 'fm999,999,999,999,990.00') AS "getWorth",--已领证货值(D=B3+B4)
                          (
                              CASE
                                  WHEN (b.ZZ_value_stock + b.ZZ_value_haved_sale+b.SY_value_stock + b.SY_value_haved_sale ) = 0 THEN
                                      '-'
                                  ELSE
                                      TO_CHAR(nvl((b.ZZ_value_haved_sale+b.SY_value_haved_sale) /(b.ZZ_value_stock + b.ZZ_value_haved_sale+b.SY_value_stock + b.SY_value_haved_sale) * 100,0), 'fm999,999,999,999,990.00'
                                      )
                                      || '%'
                              END
                          ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(nvl((b.ZZ_value_not_planning_permit+b.SY_value_not_planning_permit) / 10000,0), 'fm999,999,999,999,990.00') AS "noPlanningPermitObtainedPhase",--F、动态货值的各阶段分布-F0未取规证
                          TO_CHAR(nvl((b.ZZ_value_not_construction_per+b.SY_value_not_construction_per) / 10000,0), 'fm999,999,999,999,990.00') AS "planningPermitObtainedOhase",--F、动态货值的各阶段分布-F1规划许可证阶段
                          TO_CHAR(nvl((b.ZZ_value_not_sale_permit+b.SY_value_not_sale_permit) / 10000,0), 'fm999,999,999,999,990.00') AS "constructionPermitOhase",--F、动态货值的各阶段分布-F2施工许可证阶段
                          TO_CHAR(nvl((b.ZZ_value_not_completion+b.SY_value_not_completion) / 10000,0), 'fm999,999,999,999,990.00') AS "PreSalePermitPhase",--F、动态货值的各阶段分布-F3预售许可证阶段
                          --TO_CHAR(nvl(b.value_yes_completion / 10000,0), 'fm999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          TO_CHAR(nvl((b.ZZ_value_yes_completion+b.SY_value_yes_completion) / 10000,0), 'fm999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          '-' AS "carryDownPhase",--F、动态货值的各阶段分布-F5结转阶段

                          TO_CHAR(nvl((b.ZZ_value_reserve +b.SY_value_reserve )/ 10000,0), 'fm999,999,999,999,990.00') AS "reserveWorth",--G1、储备货值的量价情况-货值（G1=a1*b1）
                          TO_CHAR(nvl((b.zz_area_reserve+b.SY_area_reserve),0), 'fm999,999,999,999,990.00') AS "reserveCargo",--G1、储备货值的量价情况-货量(a1)
                          (CASE WHEN (b.zz_area_reserve+b.SY_area_reserve)=0 THEN '-' ELSE TO_CHAR(nvl((b.ZZ_value_reserve +b.SY_value_reserve )/(b.zz_area_reserve+b.SY_area_reserve),0), 'fm999,,999,990.00') END) AS "reservePrice",--G1、储备货值的量价情况-单价(b1)
                          TO_CHAR(nvl((b.ZZ_value_in_process+b.SY_value_in_process) / 10000,0), 'fm999,999,999,999,990.00') AS "inTransitWorth",--G2、在途货值的量价情况-货值（G2=a2*b2）
                          TO_CHAR(nvl((b.zz_area_in_process+b.SY_area_in_process),0), 'fm999,999,999,999,990.00') AS "inTransitCargo",--G2、在途货值的量价情况-货量(a2)
                          (CASE WHEN (b.zz_area_in_process+b.SY_area_in_process)=0 THEN '-' 
                              ELSE TO_CHAR(nvl((b.ZZ_value_in_process+b.SY_value_in_process)/(b.zz_area_in_process+b.SY_area_in_process),0), 'fm999,,999,990.00') 
                            END) AS "inTransitPrice",--G2、在途货值的量价情况-单价(b2)
                          TO_CHAR(nvl((b.ZZ_value_stock+b.SY_value_stock) / 10000,0), 'fm999,999,999,999,990.00') AS "stockWorth",--G3、库存货值的量价情况-货值（G3=a3*b3）
                          TO_CHAR(nvl(b.ZZ_area_stock+b.SY_area_stock,0), 'fm999,999,999,999,990.00') AS "stockCargo",--G3、库存货值的量价情况-货量(a3)
                          (CASE WHEN (b.ZZ_area_stock+b.SY_area_stock)=0 THEN '-' 
                              ELSE TO_CHAR(nvl((b.ZZ_value_stock+b.SY_value_stock)/(b.ZZ_area_stock+b.SY_area_stock),0), 'fm999,,999,990.00') 
                            END) AS "stockPrice",--G3、库存货值的量价情况-单价(b3)
                          TO_CHAR(nvl((b.ZZ_value_haved_sale+b.SY_value_haved_sale) / 10000,0), 'fm999,999,999,999,990.00') AS "soldWorth",--G4、已售货值的量价情况-货值（G4=a4*b4）
                          TO_CHAR(nvl(b.zz_area_haved_sale+b.sy_area_haved_sale,0), 'fm999,999,999,999,990.00') AS "soldCargo",--G4、已售货值的量价情况-货量(a4)
                          (CASE WHEN (b.zz_area_haved_sale+b.sy_area_haved_sale)=0 THEN '-' 
                              ELSE TO_CHAR(nvl((b.ZZ_value_haved_sale+b.SY_value_haved_sale)/(b.zz_area_haved_sale+b.sy_area_haved_sale),0), 'fm999,,999,990.00') 
                            END) AS "soldPrice"--G4、已售货值的量价情况-单价(b4)
                  FROM
                      (
                          SELECT
                              id,
                              project_name,
                              '' AS parent_id,
                              sn AS order_code
                          FROM
                              sys_project
                          WHERE
                              id = ''
                                   || projectid
                                   || ''
                          UNION ALL
--分期
                          SELECT
                              id,
                              stage_name,
                              project_id AS parent_id,
                              lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                          FROM
                              sys_project_stage
                          WHERE
                              project_id = ''|| projectid|| '' AND stage_name<>'无分期'

                          UNION ALL
--楼栋
                          SELECT
                              mdm_build.id,
                              build_name,
                              (CASE WHEN mdm_period.period_name<>'无分期' THEN  period_id ELSE mdm_build.proj_id END)  AS parent_id,
                              lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                          FROM
                              mdm_build LEFT JOIN mdm_period ON mdm_build.period_id=mdm_period.id
                          WHERE
                              mdm_build.proj_id = ''
                                        || projectid
                                        || ''
                              AND build_state = 10--10已发布楼栋
                      ) t LEFT JOIN dwm_dt_value  b ON t.id= b.obj_id
                          LEFT JOIN dwm_target_worth c1 ON b.obj_id = c1.proj_id  AND c1.target_worth_phase = 0 and c1.IS_DELETE=0 
                               AND c1.approval_status IN ('已审核','审核中')
                          LEFT JOIN dwm_target_worth c2 ON b.obj_id = c2.proj_id AND c2.target_worth_phase = 10 and c2.IS_DELETE=0
                                AND c2.approval_status IN ('已审核','审核中')
                          LEFT JOIN dwm_target_worth c3 ON b.obj_id = c3.proj_id AND c3.target_worth_phase = 20 and c3.IS_DELETE=0
                               AND c3.approval_status IN ('已审核','审核中') AND c3.id IN (SELECT id FROM V_DWM_TARGET_WORTH_NOW)
                          LEFT JOIN v_dwm_target_worth_now c4 ON b.obj_id= c4.proj_id
                               AND c4.approval_status IN ('已审核','审核中')
                    START WITH
                          t.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR t.id = t.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(t.order_code, ','), 2);
    END IF;

    IF tabsindex = 3 THEN  
    OPEN info FOR SELECT
                      t.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                       level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '' || project_name
                              WHEN level = 2 THEN
                                  '        ' || project_name
                              WHEN level = 3 THEN
                                  '                ' || project_name
                              WHEN level = 4 THEN
                                  '                        ' || project_name
                              ELSE
                                  '                                ' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                      t.parent_id   AS "parentId",--父级id（生成树父级id）
                      project_name    AS "orgName",--公司/项目
                        TO_CHAR(nvl(b.area_dt_all,0), 'fm999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
                        TO_CHAR(nvl(nvl(b.area_dt_all, 0),0), 'fm999,999,999,999,990.00') AS "targetSalesArea",--最新可售面积（不含车位）
                        (CASE WHEN b.obj_type='楼栋' THEN '-' ELSE TO_CHAR(nvl(nvl(c1.target_worth, 0),0), 'fm999,999,999,999,990.00') END)AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
                        (CASE WHEN b.obj_type='楼栋' THEN '-' ELSE TO_CHAR(nvl(nvl(c2.target_worth, 0),0), 'fm999,999,999,999,990.00') END) AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
                        TO_CHAR(nvl(nvl(c3.target_worth, 0),0), 'fm999,999,999,999,990.00') AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
                        TO_CHAR(nvl(nvl(c4.target_worth, 0),0), 'fm999,999,999,999,990.00') AS "targetNewestWorth",--目标总货值（A）-最新版(A)
                        TO_CHAR(nvl(b.value_dt_all / 10000,0), 'fm999,999,999,999,990.00') AS "dynamicTotalWorth",--动态总货值(B)
                       (CASE WHEN b.value_dt_all / 10000 - nvl(c4.target_worth, 0)<0 
                         THEN  '<font color=red>'||TO_CHAR(nvl(b.value_dt_all / 10000 - nvl(c4.target_worth, 0),0), 'fm999,999,999,999,990.00')||'</font>'
                         ELSE  '<font color=green>'||TO_CHAR(nvl(b.value_dt_all / 10000 - nvl(c4.target_worth, 0),0), 'fm999,999,999,999,990.00')||'</font>'
                         END  ) AS "dynamicTotalWorthDifference"
                        ,--总货值差额(B-A)
                          TO_CHAR(nvl((b.ZZ_value_reserve) / 10000,0), 'fm999,999,999,999,990.00') AS "reserveTotalWorth",----动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
                          TO_CHAR(nvl((b.ZZ_value_in_process) / 10000,0), 'fm999,999,999,999,990.00') AS "inProcessTotalWorth",--在途货值(B2)
                          TO_CHAR(nvl((b.ZZ_value_stock)/10000 ,0), 'fm999,999,999,999,990.00') AS "stockWorth",--库存货值(B3)
                          TO_CHAR(nvl((b.ZZ_value_haved_sale) / 10000,0), 'fm999,999,999,999,990.00') AS "alreadySalesWorth",--已售货值(B4)
                          TO_CHAR(nvl((b.ZZ_value_remain) / 10000,0), 'fm999,999,999,999,990.00') AS "residueWorth",--剩余货值(C=B1+B2+B3)
                          TO_CHAR(nvl((b.ZZ_value_stock + b.ZZ_value_haved_sale) / 10000,0), 'fm999,999,999,999,990.00') AS "getWorth",--已领证货值(D=B3+B4)
                          (
                              CASE
                                  WHEN (b.ZZ_value_stock + b.ZZ_value_haved_sale) = 0 THEN
                                      '-'
                                  ELSE
                                      TO_CHAR(nvl((b.ZZ_value_haved_sale) /(b.ZZ_value_stock + b.ZZ_value_haved_sale) * 100,0), 'fm999,999,999,999,990.00'
                                      )
                                      || '%'
                              END
                          ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(nvl((b.ZZ_value_not_planning_permit) / 10000,0), 'fm999,999,999,999,990.00') AS "noPlanningPermitObtainedPhase",--F、动态货值的各阶段分布-F0未取规证
                          TO_CHAR(nvl((b.ZZ_value_not_construction_per) / 10000,0), 'fm999,999,999,999,990.00') AS "planningPermitObtainedOhase",--F、动态货值的各阶段分布-F1规划许可证阶段
                          TO_CHAR(nvl((b.ZZ_value_not_sale_permit) / 10000,0), 'fm999,999,999,999,990.00') AS "constructionPermitOhase",--F、动态货值的各阶段分布-F2施工许可证阶段
                          TO_CHAR(nvl((b.ZZ_value_not_completion) / 10000,0), 'fm999,999,999,999,990.00') AS "PreSalePermitPhase",--F、动态货值的各阶段分布-F3预售许可证阶段
                          --TO_CHAR(nvl(b.value_yes_completion / 10000,0), 'fm999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          TO_CHAR(nvl((b.ZZ_value_yes_completion) / 10000,0), 'fm999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          '-' AS "carryDownPhase",--F、动态货值的各阶段分布-F5结转阶段

                          TO_CHAR(nvl((b.ZZ_value_reserve)/ 10000,0), 'fm999,999,999,999,990.00') AS "reserveWorth",--G1、储备货值的量价情况-货值（G1=a1*b1）
                          TO_CHAR(nvl((b.zz_area_reserve),0), 'fm999,999,999,999,990.00') AS "reserveCargo",--G1、储备货值的量价情况-货量(a1)
                          (CASE WHEN (b.zz_area_reserve)=0 THEN '-' ELSE TO_CHAR(nvl((b.ZZ_value_reserve)/(b.zz_area_reserve),0), 'fm999,,999,990.00') END) AS "reservePrice",--G1、储备货值的量价情况-单价(b1)
                          TO_CHAR(nvl((b.ZZ_value_in_process) / 10000,0), 'fm999,999,999,999,990.00') AS "inTransitWorth",--G2、在途货值的量价情况-货值（G2=a2*b2）
                          TO_CHAR(nvl((b.zz_area_in_process),0), 'fm999,999,999,999,990.00') AS "inTransitCargo",--G2、在途货值的量价情况-货量(a2)
                          (CASE WHEN (b.zz_area_in_process)=0 THEN '-' 
                              ELSE TO_CHAR(nvl((b.ZZ_value_in_process)/(b.zz_area_in_process),0), 'fm999,,999,990.00') 
                            END) AS "inTransitPrice",--G2、在途货值的量价情况-单价(b2)
                          TO_CHAR(nvl((b.ZZ_value_stock) / 10000,0), 'fm999,999,999,999,990.00') AS "stockWorth",--G3、库存货值的量价情况-货值（G3=a3*b3）
                          TO_CHAR(nvl(b.ZZ_area_stock,0), 'fm999,999,999,999,990.00') AS "stockCargo",--G3、库存货值的量价情况-货量(a3)
                          (CASE WHEN (b.ZZ_area_stock)=0 THEN '-' 
                              ELSE TO_CHAR(nvl((b.ZZ_value_stock)/(b.ZZ_area_stock),0), 'fm999,,999,990.00') 
                            END) AS "stockPrice",--G3、库存货值的量价情况-单价(b3)
                          TO_CHAR(nvl((b.ZZ_value_haved_sale) / 10000,0), 'fm999,999,999,999,990.00') AS "soldWorth",--G4、已售货值的量价情况-货值（G4=a4*b4）
                          TO_CHAR(nvl(b.zz_area_haved_sale,0), 'fm999,999,999,999,990.00') AS "soldCargo",--G4、已售货值的量价情况-货量(a4)
                          (CASE WHEN (b.zz_area_haved_sale)=0 THEN '-' 
                              ELSE TO_CHAR(nvl((b.ZZ_value_haved_sale)/(b.zz_area_haved_sale),0), 'fm999,,999,990.00') 
                            END) AS "soldPrice"--G4、已售货值的量价情况-单价(b4)
                  FROM
                      (
                          SELECT
                              id,
                              project_name,
                              '' AS parent_id,
                              sn AS order_code
                          FROM
                              sys_project
                          WHERE
                              id = ''
                                   || projectid
                                   || ''
                          UNION ALL
--分期
                          SELECT
                              id,
                              stage_name,
                              project_id AS parent_id,
                              lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                          FROM
                              sys_project_stage
                          WHERE
                              project_id = ''|| projectid|| '' AND stage_name<>'无分期'

                          UNION ALL
--楼栋
                          SELECT
                              mdm_build.id,
                              build_name,
                              (CASE WHEN mdm_period.period_name<>'无分期' THEN  period_id ELSE mdm_build.proj_id END)  AS parent_id,
                              lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                          FROM
                              mdm_build LEFT JOIN mdm_period ON mdm_build.period_id=mdm_period.id
                          WHERE
                              mdm_build.proj_id = ''
                                        || projectid
                                        || ''
                              AND build_state = 10--10已发布楼栋
                      ) t LEFT JOIN dwm_dt_value  b ON t.id= b.obj_id
                          LEFT JOIN dwm_target_worth c1 ON b.obj_id = c1.proj_id  AND c1.target_worth_phase = 0 and c1.IS_DELETE=0 
                               AND c1.approval_status IN ('已审核','审核中')
                          LEFT JOIN dwm_target_worth c2 ON b.obj_id = c2.proj_id AND c2.target_worth_phase = 10 and c2.IS_DELETE=0
                                AND c2.approval_status IN ('已审核','审核中')
                          LEFT JOIN dwm_target_worth c3 ON b.obj_id = c3.proj_id AND c3.target_worth_phase = 20 and c3.IS_DELETE=0
                               AND c3.approval_status IN ('已审核','审核中') AND c3.id IN (SELECT id FROM V_DWM_TARGET_WORTH_NOW)
                          LEFT JOIN v_dwm_target_worth_now c4 ON b.obj_id= c4.proj_id
                               AND c4.approval_status IN ('已审核','审核中')
                    START WITH
                          t.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR t.id = t.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(t.order_code, ','), 2);
    END IF;

    IF tabsindex = 4 THEN  
    OPEN info FOR SELECT
                      t.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                       level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '' || project_name
                              WHEN level = 2 THEN
                                  '        ' || project_name
                              WHEN level = 3 THEN
                                  '                ' || project_name
                              WHEN level = 4 THEN
                                  '                        ' || project_name
                              ELSE
                                  '                                ' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                      t.parent_id   AS "parentId",--父级id（生成树父级id）
                      project_name    AS "orgName",--公司/项目
                        TO_CHAR(nvl(b.area_dt_all,0), 'fm999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
                        TO_CHAR(nvl(nvl(b.area_dt_all, 0),0), 'fm999,999,999,999,990.00') AS "targetSalesArea",--最新可售面积（不含车位）
                        (CASE WHEN b.obj_type='楼栋' THEN '-' ELSE TO_CHAR(nvl(nvl(c1.target_worth, 0),0), 'fm999,999,999,999,990.00') END)AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
                        (CASE WHEN b.obj_type='楼栋' THEN '-' ELSE TO_CHAR(nvl(nvl(c2.target_worth, 0),0), 'fm999,999,999,999,990.00') END) AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
                        TO_CHAR(nvl(nvl(c3.target_worth, 0),0), 'fm999,999,999,999,990.00') AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
                        TO_CHAR(nvl(nvl(c4.target_worth, 0),0), 'fm999,999,999,999,990.00') AS "targetNewestWorth",--目标总货值（A）-最新版(A)
                        TO_CHAR(nvl(b.value_dt_all / 10000,0), 'fm999,999,999,999,990.00') AS "dynamicTotalWorth",--动态总货值(B)
                       (CASE WHEN b.value_dt_all / 10000 - nvl(c4.target_worth, 0)<0 
                         THEN  '<font color=red>'||TO_CHAR(nvl(b.value_dt_all / 10000 - nvl(c4.target_worth, 0),0), 'fm999,999,999,999,990.00')||'</font>'
                         ELSE  '<font color=green>'||TO_CHAR(nvl(b.value_dt_all / 10000 - nvl(c4.target_worth, 0),0), 'fm999,999,999,999,990.00')||'</font>'
                         END  ) AS "dynamicTotalWorthDifference"
                        ,--总货值差额(B-A)
                          TO_CHAR(nvl((b.SY_value_reserve) / 10000,0), 'fm999,999,999,999,990.00') AS "reserveTotalWorth",----动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
                          TO_CHAR(nvl((b.SY_value_in_process) / 10000,0), 'fm999,999,999,999,990.00') AS "inProcessTotalWorth",--在途货值(B2)
                          TO_CHAR(nvl((b.SY_value_stock)/10000 ,0), 'fm999,999,999,999,990.00') AS "stockWorth",--库存货值(B3)
                          TO_CHAR(nvl((b.SY_value_haved_sale) / 10000,0), 'fm999,999,999,999,990.00') AS "alreadySalesWorth",--已售货值(B4)
                          TO_CHAR(nvl((b.SY_value_remain) / 10000,0), 'fm999,999,999,999,990.00') AS "residueWorth",--剩余货值(C=B1+B2+B3)
                          TO_CHAR(nvl((b.SY_value_stock + b.SY_value_haved_sale) / 10000,0), 'fm999,999,999,999,990.00') AS "getWorth",--已领证货值(D=B3+B4)
                          (
                              CASE
                                  WHEN (b.SY_value_stock + b.SY_value_haved_sale ) = 0 THEN
                                      '-'
                                  ELSE
                                      TO_CHAR(nvl((b.SY_value_haved_sale) /(b.SY_value_stock + b.SY_value_haved_sale) * 100,0), 'fm999,999,999,999,990.00'
                                      )
                                      || '%'
                              END
                          ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(nvl((b.SY_value_not_planning_permit) / 10000,0), 'fm999,999,999,999,990.00') AS "noPlanningPermitObtainedPhase",--F、动态货值的各阶段分布-F0未取规证
                          TO_CHAR(nvl((b.SY_value_not_construction_per) / 10000,0), 'fm999,999,999,999,990.00') AS "planningPermitObtainedOhase",--F、动态货值的各阶段分布-F1规划许可证阶段
                          TO_CHAR(nvl((b.SY_value_not_sale_permit) / 10000,0), 'fm999,999,999,999,990.00') AS "constructionPermitOhase",--F、动态货值的各阶段分布-F2施工许可证阶段
                          TO_CHAR(nvl((b.SY_value_not_completion) / 10000,0), 'fm999,999,999,999,990.00') AS "PreSalePermitPhase",--F、动态货值的各阶段分布-F3预售许可证阶段
                          --TO_CHAR(nvl(b.value_yes_completion / 10000,0), 'fm999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          TO_CHAR(nvl((b.SY_value_yes_completion) / 10000,0), 'fm999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          '-' AS "carryDownPhase",--F、动态货值的各阶段分布-F5结转阶段

                          TO_CHAR(nvl((b.SY_value_reserve )/ 10000,0), 'fm999,999,999,999,990.00') AS "reserveWorth",--G1、储备货值的量价情况-货值（G1=a1*b1）
                          TO_CHAR(nvl((b.SY_area_reserve),0), 'fm999,999,999,999,990.00') AS "reserveCargo",--G1、储备货值的量价情况-货量(a1)
                          (CASE WHEN (b.SY_area_reserve)=0 THEN '-' ELSE TO_CHAR(nvl((b.SY_value_reserve )/(b.SY_area_reserve),0), 'fm999,,999,990.00') END) AS "reservePrice",--G1、储备货值的量价情况-单价(b1)
                          TO_CHAR(nvl((b.SY_value_in_process) / 10000,0), 'fm999,999,999,999,990.00') AS "inTransitWorth",--G2、在途货值的量价情况-货值（G2=a2*b2）
                          TO_CHAR(nvl((b.SY_area_in_process),0), 'fm999,999,999,999,990.00') AS "inTransitCargo",--G2、在途货值的量价情况-货量(a2)
                          (CASE WHEN (b.SY_area_in_process)=0 THEN '-' 
                              ELSE TO_CHAR(nvl((b.SY_value_in_process)/(b.SY_area_in_process),0), 'fm999,,999,990.00') 
                            END) AS "inTransitPrice",--G2、在途货值的量价情况-单价(b2)
                          TO_CHAR(nvl((b.SY_value_stock) / 10000,0), 'fm999,999,999,999,990.00') AS "stockWorth",--G3、库存货值的量价情况-货值（G3=a3*b3）
                          TO_CHAR(nvl(b.SY_area_stock,0), 'fm999,999,999,999,990.00') AS "stockCargo",--G3、库存货值的量价情况-货量(a3)
                          (CASE WHEN (b.SY_area_stock)=0 THEN '-' 
                              ELSE TO_CHAR(nvl((b.SY_value_stock)/(b.SY_area_stock),0), 'fm999,,999,990.00') 
                            END) AS "stockPrice",--G3、库存货值的量价情况-单价(b3)
                          TO_CHAR(nvl((b.SY_value_haved_sale) / 10000,0), 'fm999,999,999,999,990.00') AS "soldWorth",--G4、已售货值的量价情况-货值（G4=a4*b4）
                          TO_CHAR(nvl(b.sy_area_haved_sale,0), 'fm999,999,999,999,990.00') AS "soldCargo",--G4、已售货值的量价情况-货量(a4)
                          (CASE WHEN (b.sy_area_haved_sale)=0 THEN '-' 
                              ELSE TO_CHAR(nvl((b.SY_value_haved_sale)/(b.sy_area_haved_sale),0), 'fm999,,999,990.00') 
                            END) AS "soldPrice"--G4、已售货值的量价情况-单价(b4)
                  FROM
                      (
                          SELECT
                              id,
                              project_name,
                              '' AS parent_id,
                              sn AS order_code
                          FROM
                              sys_project
                          WHERE
                              id = ''
                                   || projectid
                                   || ''
                          UNION ALL
--分期
                          SELECT
                              id,
                              stage_name,
                              project_id AS parent_id,
                              lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                          FROM
                              sys_project_stage
                          WHERE
                              project_id = ''|| projectid|| '' AND stage_name<>'无分期'

                          UNION ALL
--楼栋
                          SELECT
                              mdm_build.id,
                              build_name,
                              (CASE WHEN mdm_period.period_name<>'无分期' THEN  period_id ELSE mdm_build.proj_id END)  AS parent_id,
                              lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                          FROM
                              mdm_build LEFT JOIN mdm_period ON mdm_build.period_id=mdm_period.id
                          WHERE
                              mdm_build.proj_id = ''
                                        || projectid
                                        || ''
                              AND build_state = 10--10已发布楼栋
                      ) t LEFT JOIN dwm_dt_value  b ON t.id= b.obj_id
                          LEFT JOIN dwm_target_worth c1 ON b.obj_id = c1.proj_id  AND c1.target_worth_phase = 0 and c1.IS_DELETE=0 
                               AND c1.approval_status IN ('已审核','审核中')
                          LEFT JOIN dwm_target_worth c2 ON b.obj_id = c2.proj_id AND c2.target_worth_phase = 10 and c2.IS_DELETE=0
                                AND c2.approval_status IN ('已审核','审核中')
                          LEFT JOIN dwm_target_worth c3 ON b.obj_id = c3.proj_id AND c3.target_worth_phase = 20 and c3.IS_DELETE=0
                               AND c3.approval_status IN ('已审核','审核中') AND c3.id IN (SELECT id FROM V_DWM_TARGET_WORTH_NOW)
                          LEFT JOIN v_dwm_target_worth_now c4 ON b.obj_id= c4.proj_id
                               AND c4.approval_status IN ('已审核','审核中')
                    START WITH
                          t.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR t.id = t.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(t.order_code, ','), 2);
    END IF;

    IF tabsindex = 5 THEN  
    OPEN info FOR SELECT
                      t.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                       level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '' || project_name
                              WHEN level = 2 THEN
                                  '        ' || project_name
                              WHEN level = 3 THEN
                                  '                ' || project_name
                              WHEN level = 4 THEN
                                  '                        ' || project_name
                              ELSE
                                  '                                ' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                      t.parent_id   AS "parentId",--父级id（生成树父级id）
                      project_name    AS "orgName",--公司/项目
                        TO_CHAR(nvl(b.area_dt_all,0), 'fm999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
                        TO_CHAR(nvl(nvl(b.area_dt_all, 0),0), 'fm999,999,999,999,990.00') AS "targetSalesArea",--最新可售面积（不含车位）
                        (CASE WHEN b.obj_type='楼栋' THEN '-' ELSE TO_CHAR(nvl(nvl(c1.target_worth, 0),0), 'fm999,999,999,999,990.00') END)AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
                        (CASE WHEN b.obj_type='楼栋' THEN '-' ELSE TO_CHAR(nvl(nvl(c2.target_worth, 0),0), 'fm999,999,999,999,990.00') END) AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
                        TO_CHAR(nvl(nvl(c3.target_worth, 0),0), 'fm999,999,999,999,990.00') AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
                        TO_CHAR(nvl(nvl(c4.target_worth, 0),0), 'fm999,999,999,999,990.00') AS "targetNewestWorth",--目标总货值（A）-最新版(A)
                        TO_CHAR(nvl(b.value_dt_all / 10000,0), 'fm999,999,999,999,990.00') AS "dynamicTotalWorth",--动态总货值(B)
                       (CASE WHEN b.value_dt_all / 10000 - nvl(c4.target_worth, 0)<0 
                         THEN  '<font color=red>'||TO_CHAR(nvl(b.value_dt_all / 10000 - nvl(c4.target_worth, 0),0), 'fm999,999,999,999,990.00')||'</font>'
                         ELSE  '<font color=green>'||TO_CHAR(nvl(b.value_dt_all / 10000 - nvl(c4.target_worth, 0),0), 'fm999,999,999,999,990.00')||'</font>'
                         END  ) AS "dynamicTotalWorthDifference"
                        ,--总货值差额(B-A)
                          TO_CHAR(nvl((b.CW_value_reserve) / 10000,0), 'fm999,999,999,999,990.00') AS "reserveTotalWorth",----动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
                          TO_CHAR(nvl((b.CW_value_in_process) / 10000,0), 'fm999,999,999,999,990.00') AS "inProcessTotalWorth",--在途货值(B2)
                          TO_CHAR(nvl((b.CW_value_stock)/10000 ,0), 'fm999,999,999,999,990.00') AS "stockWorth",--库存货值(B3)
                          TO_CHAR(nvl((b.CW_value_haved_sale) / 10000,0), 'fm999,999,999,999,990.00') AS "alreadySalesWorth",--已售货值(B4)
                          TO_CHAR(nvl((b.CW_value_remain) / 10000,0), 'fm999,999,999,999,990.00') AS "residueWorth",--剩余货值(C=B1+B2+B3)
                          TO_CHAR(nvl((b.CW_value_stock + b.CW_value_haved_sale) / 10000,0), 'fm999,999,999,999,990.00') AS "getWorth",--已领证货值(D=B3+B4)
                          (
                              CASE
                                  WHEN (b.CW_value_stock + b.CW_value_haved_sale ) = 0 THEN
                                      '-'
                                  ELSE
                                      TO_CHAR(nvl((b.CW_value_haved_sale) /(b.CW_value_stock + b.CW_value_haved_sale) * 100,0), 'fm999,999,999,999,990.00'
                                      )
                                      || '%'
                              END
                          ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(nvl((b.CW_value_not_planning_permit) / 10000,0), 'fm999,999,999,999,990.00') AS "noPlanningPermitObtainedPhase",--F、动态货值的各阶段分布-F0未取规证
                          TO_CHAR(nvl((b.CW_value_not_construction_per) / 10000,0), 'fm999,999,999,999,990.00') AS "planningPermitObtainedOhase",--F、动态货值的各阶段分布-F1规划许可证阶段
                          TO_CHAR(nvl((b.CW_value_not_sale_permit) / 10000,0), 'fm999,999,999,999,990.00') AS "constructionPermitOhase",--F、动态货值的各阶段分布-F2施工许可证阶段
                          TO_CHAR(nvl((b.CW_value_not_completion) / 10000,0), 'fm999,999,999,999,990.00') AS "PreSalePermitPhase",--F、动态货值的各阶段分布-F3预售许可证阶段
                          --TO_CHAR(nvl(b.value_yes_completion / 10000,0), 'fm999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          TO_CHAR(nvl((b.CW_value_yes_completion) / 10000,0), 'fm999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          '-' AS "carryDownPhase",--F、动态货值的各阶段分布-F5结转阶段

                          TO_CHAR(nvl((b.CW_value_reserve )/ 10000,0), 'fm999,999,999,999,990.00') AS "reserveWorth",--G1、储备货值的量价情况-货值（G1=a1*b1）
                          TO_CHAR(nvl((b.CW_area_reserve),0), 'fm999,999,999,999,999') AS "reserveCargo",--G1、储备货值的量价情况-货量(a1)
                          (CASE WHEN (b.CW_area_reserve)=0 THEN '-' ELSE TO_CHAR(nvl((b.CW_value_reserve)/(b.CW_area_reserve),0), 'fm999,,999,990.00') END) AS "reservePrice",--G1、储备货值的量价情况-单价(b1)
                          TO_CHAR(nvl((b.CW_value_in_process) / 10000,0), 'fm999,999,999,999,990.00') AS "inTransitWorth",--G2、在途货值的量价情况-货值（G2=a2*b2）
                          TO_CHAR(nvl((b.CW_area_in_process),0), 'fm999,999,999,999,999') AS "inTransitCargo",--G2、在途货值的量价情况-货量(a2)
                          (CASE WHEN (b.CW_area_in_process)=0 THEN '-' 
                              ELSE TO_CHAR(nvl((b.CW_value_in_process)/(b.CW_area_in_process),0), 'fm999,,999,990.00') 
                            END) AS "inTransitPrice",--G2、在途货值的量价情况-单价(b2)
                          TO_CHAR(nvl((b.CW_value_stock) / 10000,0), 'fm999,999,999,999,990.00') AS "stockWorth",--G3、库存货值的量价情况-货值（G3=a3*b3）
                          TO_CHAR(nvl(b.CW_area_stock,0), 'fm999,999,999,999,999') AS "stockCargo",--G3、库存货值的量价情况-货量(a3)
                          (CASE WHEN (b.CW_area_stock)=0 THEN '-' 
                              ELSE TO_CHAR(nvl((b.CW_value_stock)/(b.CW_area_stock),0), 'fm999,,999,990.00') 
                            END) AS "stockPrice",--G3、库存货值的量价情况-单价(b3)
                          TO_CHAR(nvl((b.CW_value_haved_sale) / 10000,0), 'fm999,999,999,999,990.00') AS "soldWorth",--G4、已售货值的量价情况-货值（G4=a4*b4）
                          TO_CHAR(nvl(b.CW_area_haved_sale,0), 'fm999,999,999,999,999') AS "soldCargo",--G4、已售货值的量价情况-货量(a4)
                          (CASE WHEN (b.CW_area_haved_sale)=0 THEN '-' 
                              ELSE TO_CHAR(nvl((b.CW_value_haved_sale)/(b.CW_area_haved_sale),0), 'fm999,,999,990.00') 
                            END) AS "soldPrice"--G4、已售货值的量价情况-单价(b4)
                  FROM
                      (
                          SELECT
                              id,
                              project_name,
                              '' AS parent_id,
                              sn AS order_code
                          FROM
                              sys_project
                          WHERE
                              id = ''
                                   || projectid
                                   || ''
                          UNION ALL
--分期
                          SELECT
                              id,
                              stage_name,
                              project_id AS parent_id,
                              lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                          FROM
                              sys_project_stage
                          WHERE
                              project_id = ''|| projectid|| '' AND stage_name<>'无分期'

                          UNION ALL
--楼栋
                          SELECT
                              mdm_build.id,
                              build_name,
                              (CASE WHEN mdm_period.period_name<>'无分期' THEN  period_id ELSE mdm_build.proj_id END)  AS parent_id,
                              lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                          FROM
                              mdm_build LEFT JOIN mdm_period ON mdm_build.period_id=mdm_period.id
                          WHERE
                              mdm_build.proj_id = ''
                                        || projectid
                                        || ''
                              AND build_state = 10--10已发布楼栋
                      ) t LEFT JOIN dwm_dt_value  b ON t.id= b.obj_id
                          LEFT JOIN dwm_target_worth c1 ON b.obj_id = c1.proj_id  AND c1.target_worth_phase = 0 and c1.IS_DELETE=0 
                               AND c1.approval_status IN ('已审核','审核中') 
                          LEFT JOIN dwm_target_worth c2 ON b.obj_id = c2.proj_id AND c2.target_worth_phase = 10 and c2.IS_DELETE=0 
                                AND c2.approval_status IN ('已审核','审核中') 
                          LEFT JOIN dwm_target_worth c3 ON b.obj_id = c3.proj_id AND c3.target_worth_phase = 20 and c3.IS_DELETE=0 and c3.IS_DELETE=0
                               AND c3.approval_status IN ('已审核','审核中') AND c3.id IN (SELECT id FROM V_DWM_TARGET_WORTH_NOW)
                          LEFT JOIN v_dwm_target_worth_now c4 ON b.obj_id= c4.proj_id
                               AND c4.approval_status IN ('已审核','审核中')
                  START WITH
                          t.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR t.id = t.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(t.order_code, ','), 2);
    END IF;

END p_dwm_dt_value_dtl;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DT_VALUE_LIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_DT_VALUE_LIST" 
(
		USERID       IN VARCHAR2 --当前用户id
	 ,STATIONID    IN VARCHAR2 --当前用户岗位id
	 ,DEPARTMENTID IN VARCHAR2 --当前用户部门id
	 ,COMPANYID    IN VARCHAR2 --当前用户公司id
	 ,UNITID       IN VARCHAR2 --选择公司id
	 ,ISOPERATE    IN VARCHAR2 --是否操盘
	 ,TABSINDEX    IN INT --选择选项卡。1开始
	 ,INFO         OUT SYS_REFCURSOR
) AS
		--动态货值管理-全案动态货值-主列表
		--作者：陈丽
		--日期：2019/12/17
		DATA_AUTH_SPID VARCHAR2(200);
		BIZCODE        VARCHAR2(200);
        IS_P_OPERATE VARCHAR2(200);
         unitid_val       VARCHAR2(200);
BEGIN
		unitid_val:=nvl(UNITID,'003200000000000000000000000000');
        --权限编码
		BIZCODE := 'DWM.DTHZGL.03';
		P_SYS_GET_COMPANY_PROJ_SPID(USERID         => USERID,
																STATIONID      => STATIONID,
																DEPTID         => DEPARTMENTID,
																COMPANYID      => COMPANYID,
																BIZCODE        => BIZCODE,
																DATA_AUTH_SPID => DATA_AUTH_SPID);

		IF TABSINDEX = 1 THEN
				DBMS_OUTPUT.PUT_LINE('所有业态!');
		ELSIF TABSINDEX = 2 THEN
				DBMS_OUTPUT.PUT_LINE('住宅及商办!');
		ELSIF TABSINDEX = 3 THEN
				DBMS_OUTPUT.PUT_LINE('住宅!');
		ELSIF TABSINDEX = 4 THEN
				DBMS_OUTPUT.PUT_LINE('商办!');
		ELSIF TABSINDEX = 5 THEN
				DBMS_OUTPUT.PUT_LINE('车位!');
		ELSIF TABSINDEX = 6 THEN
				DBMS_OUTPUT.PUT_LINE('剩余货值表!');
				OPEN INFO FOR
						WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   SYS_PROJECT A1  
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
            SELECT A.ID AS "id",
                   --主键id（生成树的id，唯一可以是业务id）
                   A.PARENT_ID AS "parentId",
                   --父级id（生成树父级id）
                   CASE
                       WHEN A.IS_COMPANY = 0 THEN
                        '/dwm/value-manage/value-project/detail?code=value_dtl'||CHR(38)||'isOperate=' ||
                        A.PROJ_COOPERATE || CHR(38)||'projectId=' || A.ID ||CHR(38)||
                        'projectName=' || A.ORG_NAME || CHR(38)||'projectDate=' ||
                        A.TAKE_DATE ||CHR(38) ||'tabIndex=' || TABSINDEX ||CHR(38)||
                        'pageTitle=' || A.ORG_NAME --页面标题名称
                       ELSE
                        ''
                   END AS "openUrl",
                   --详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
                   CASE
                       WHEN A.IS_COMPANY = 0 THEN
                        '/dwm/value-manage/dynamic-volume/circular?companyId=' ||
                        A.PARENT_ID ||CHR(38) ||'projectId=' || A.ID || CHR(38)||'type=2' --companyId加载项目的公司id，项目id：默认选中的项目id，type：货值是1，货值是2
                       ELSE
                        ''
                   END AS "openVisualUrl",
                   --打开可视化地址
                   ORG_LEVEL,
                   CASE
                       WHEN ORG_LEVEL = 1 THEN
                        '#eaf6ff'
                       WHEN ORG_LEVEL = 2 THEN
                        '#ecfbee'
                       WHEN ORG_LEVEL = 3 THEN
                        '#f2eed4'
                       ELSE
                        ''
                   END AS "excelRowBgColor",
                   --数据行导出excel背景色
                   CASE
                       WHEN ORG_LEVEL = 1 THEN
                        '' || ORG_NAME
                       WHEN ORG_LEVEL = 2 THEN
                        '        ' || ORG_NAME
                       WHEN ORG_LEVEL = 3 THEN
                        '                ' || ORG_NAME
                       WHEN ORG_LEVEL = 4 THEN
                        '                        ' || ORG_NAME
                       ELSE
                        '                                ' || ORG_NAME
                   END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                   A.ORG_NAME AS "orgName",--公司/项目
                   TO_CHAR(NVL(ROUND( SUM(A.ZZ_VALUE_REMAIN) / 10000, 2),0),'FM999,999,999,990.00') AS "projWholeDwellingValue",--项目全案剩余可售货值（S=A+B+C+D）-住宅(m2)
                   TO_CHAR(NVL(ROUND( SUM(A.SY_VALUE_REMAIN) / 10000, 2),0),'FM999,999,999,990.00') AS "projWholeBusinessValue",--项目全案剩余可售货值（S=A+B+C+D）-商业(m2)
                   TO_CHAR(NVL(ROUND( SUM(A.CW_VALUE_REMAIN) / 10000, 2),0),'FM999,999,999,990.00') AS "projWholeCarportValue",--项目全案剩余可售货值（S=A+B+C+D）-车位(个)
                   TO_CHAR(NVL(ROUND(( SUM(A.ZZ_VALUE_REMAIN)+SUM(A.CW_VALUE_REMAIN)+SUM(A.SY_VALUE_REMAIN)) / 10000,2),0),'FM999,999,999,990.00') AS "projWholeTotalValue",
                   --项目全案剩余可售货值（S=A+B+C+D）-合计(m2)

                   TO_CHAR(NVL(ROUND( SUM(A.ZZ_VALUE_NOT_PLANNING_PERMIT),0) / 10000, 2),'FM999,999,999,990.00') AS "ADwellingValue",--A未取规证的可售货值-住宅(m2)
                   TO_CHAR(NVL(ROUND( SUM(A.SY_VALUE_NOT_PLANNING_PERMIT),0) / 10000, 2),'FM999,999,999,990.00') AS "ABusinessValue",--A未取规证的可售货值-商业(m2)
                   TO_CHAR(NVL(ROUND( SUM(A.CW_VALUE_NOT_PLANNING_PERMIT),0) / 10000, 2),'FM999,999,999,990.00') AS "ACarportValue",--A未取规证的可售货值-车位(个)
                   TO_CHAR(NVL(ROUND((SUM(A.ZZ_VALUE_NOT_PLANNING_PERMIT)+SUM(A.CW_VALUE_NOT_PLANNING_PERMIT)+SUM(A.SY_VALUE_NOT_PLANNING_PERMIT)),0) / 10000,2),'FM999,999,999,990.00') AS "ATotalValue",--A未取规证的可售货值-合计(m2)
                   TO_CHAR(ROUND( NVL(SUM(A.ZZ_VALUE_NOT_CONSTRUCTION_PER),0) / 10000, 2),'FM999,999,999,990.00') AS "BDwellingValue",--B已取规证未取施工证的可售货值-住宅(m2)
                   TO_CHAR(ROUND(NVL(SUM(A.SY_VALUE_NOT_CONSTRUCTION_PER) / 10000, 2),0),'FM999,999,999,990.00') AS "BBusinessValue",--B已取规证未取施工证的可售货值-商业(m2)
                   TO_CHAR(ROUND(NVL(SUM(A.CW_VALUE_NOT_CONSTRUCTION_PER) / 10000, 2),0),'FM999,999,999,990.00') AS "BCarportValue",--B已取规证未取施工证的可售货值-车位(个)
                   TO_CHAR(NVL(ROUND((SUM(A.ZZ_VALUE_NOT_CONSTRUCTION_PER)+SUM(A.SY_VALUE_NOT_CONSTRUCTION_PER) + SUM(A.CW_VALUE_NOT_CONSTRUCTION_PER))/ 10000,2),0),'FM999,999,999,990.00') AS "BTotalValue",--B已取规证未取施工证的可售货值-合计(m2)

                   TO_CHAR(NVL(ROUND(SUM(A.ZZ_VALUE_NOT_SALE_PERMIT),0) / 10000, 2),'FM999,999,999,990.00') AS "CDwellingValue",--C已取施工证未取预售证的可售货值-住宅(m2)
                   TO_CHAR(NVL(ROUND(SUM(A.SY_VALUE_NOT_SALE_PERMIT),0) / 10000, 2),'FM999,999,999,990.00') AS "CBusinessValue",--C已取施工证未取预售证的可售货值-商业(m2)
                   TO_CHAR(NVL(ROUND(SUM(A.CW_VALUE_NOT_SALE_PERMIT),0) / 10000, 2),'FM999,999,999,990.00') AS "CCarportValue",--C已取施工证未取预售证的可售货值-车位(个)
                   TO_CHAR(NVL(ROUND((SUM(A.ZZ_VALUE_NOT_SALE_PERMIT)+SUM(A.SY_VALUE_NOT_SALE_PERMIT)+SUM(A.CW_VALUE_NOT_SALE_PERMIT)) / 10000,2),0),'FM999,999,999,990.00') AS "CTotalValue",--C已取施工证未取预售证的可售货值-合计(m2)

                   TO_CHAR(NVL(ROUND( SUM(A.ZZ_VALUE_STOCK) / 10000, 2),0),'FM999,999,999,990.00') AS "DDwellingValue",--D已取预售证未售的可售货值-住宅(m2)
                   TO_CHAR(NVL(ROUND(SUM(A.SY_VALUE_STOCK) / 10000, 2),0),'FM999,999,999,990.00') AS "DBusinessValue",--D已取预售证未售的可售货值-商业(m2)
                   TO_CHAR(NVL(ROUND(SUM(A.CW_VALUE_STOCK) / 10000, 2),0),'FM999,999,999,990.00') AS "DCarportValue",--D已取预售证未售的可售货值-车位(个)
                   TO_CHAR(NVL(ROUND((SUM(A.ZZ_VALUE_STOCK)+SUM(A.SY_VALUE_STOCK)+SUM(A.CW_VALUE_STOCK)) / 10000,2),0),'FM999,999,999,990.00') AS "DTotalValue" --D已取预售证未售的可售货值-合计(m2)
            FROM   TEMP_DT_VALUE A
            INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
            --WHERE  a.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END)
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE order by ORDER_HIERARCHY_CODE;

		END IF;

		IF TABSINDEX = 1   THEN
				OPEN INFO FOR
				WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   SYS_PROJECT A1
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
						SELECT A.ID AS "id",
									 --主键id（生成树的id，唯一可以是业务id）
									 A.PARENT_ID AS "parentId",
									 --父级id（生成树父级id）
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/value-project/detail?code=value_dtl&isOperate=' ||
												 A.PROJ_COOPERATE || '&projectId=' || A.ID || '&projectName=' ||
												 A.ORG_NAME || '&projectDate=' || A.TAKE_DATE || '&tabIndex=' ||
												 TABSINDEX || '&pageTitle=' || A.ORG_NAME --页面标题名称
												ELSE
												 ''
										END) AS "openUrl",
									 --详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/dynamic-volume/circular?companyId=' || A.PARENT_ID ||
												 '&projectId=' || A.ID || '&type=2' --companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
												ELSE
												 ''
										END) AS "openVisualUrl",
									 --打开可视化地址
									 ORG_LEVEL,
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '#eaf6ff'
												WHEN ORG_LEVEL = 2 THEN
												 '#ecfbee'
												WHEN ORG_LEVEL = 3 THEN
												 '#f2eed4'
												ELSE
												 ''
										END AS "excelRowBgColor",
									 --数据行导出excel背景色
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '' || ORG_NAME
												WHEN ORG_LEVEL = 2 THEN
												 '        ' || ORG_NAME
												WHEN ORG_LEVEL = 3 THEN
												 '                ' || ORG_NAME
												WHEN ORG_LEVEL = 4 THEN
												 '                        ' || ORG_NAME
												ELSE
												 '                                ' || ORG_NAME
										END AS "excelRowTextTreeOrgName",
									 --文本前面加空格模仿树
									 A.ORG_NAME AS "orgName",--公司/项目
									 --TO_CHAR(b.area_dt_all, '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
									 TO_CHAR( NVL(SUM(A.AREA_DT_ALL),0), '999,999,999,999,990.00') AS "targetSalesArea",--最新可售面积（不含车位）
									 TO_CHAR(NVL(SUM(A.TARGET_A1_VALUE),0),'999,999,999,999,990.00') AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
									 TO_CHAR( NVL(SUM(A.TARGET_A2_VALUE),0),'999,999,999,999,990.00') AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
									 TO_CHAR( NVL(SUM(A.TARGET_A3_VALUE),0),'999,999,999,999,990.00') AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
									  TO_CHAR( NVL(SUM(A.TARGET_A_VALUE),0),'999,999,999,999,990.00') AS "targetNewestWorth",--目标总货值（A）-最新版(A)

/*                   TO_CHAR((SELECT SUM(A.Target_Now)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN SYS_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN v_DWM_DT_VALUE DDV ON A.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID)
                            ,'999,999,999,999,990.00') AS "targetNewestWorth",--目标总货值（A）-最新版(A)*/

									 TO_CHAR( round(NVL(SUM(A.value_dt_all),0)/10000,2), '999,999,999,999,990.00') AS "dynamicTotalWorth",--动态总货值(B)
									 (CASE
												WHEN round( SUM(A.value_dt_all)/10000-SUM(A.TARGET_A_VALUE),2) < -1 THEN
												 '<font color=red>' ||TO_CHAR( SUM(A.value_dt_all)/10000-SUM(A.TARGET_A_VALUE),'999,999,999,999,990.00') || '</font>'
												ELSE
												 '<font color=green>' ||TO_CHAR( SUM(A.value_dt_all)/10000-SUM(A.TARGET_A_VALUE),'999,999,999,999,990.00') || '</font>'
										END) AS "dynamicTotalWorthDifference",--总货值差额(B-A)
									 TO_CHAR( NVL(SUM(A.VALUE_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "reserveTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
									 TO_CHAR( NVL(SUM(A.VALUE_IN_PROCESS),0) / 10000, '999,999,999,999,990.00') AS "inProcessTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-在途货值(B2)--修改字段holdConstructionPermit=》inTransitWorth
									 TO_CHAR(  SUM(nvl(A.VALUE_STOCK,0))/ 10000 ,'999,999,999,999,990.00') AS "stockWorth",  --动态总货值构成（B=B1+B2+B3+B4）-库存货值(B3)
									 TO_CHAR( NVL(SUM(A.VALUE_HAVED_SALE),0) / 10000, '999,999,999,999,990.00') AS "alreadySalesWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-已售货值(B4)
									 TO_CHAR( NVL(SUM(A.VALUE_REMAIN),0), '999,999,999,999,990.00') AS "residueWorth",
									 --剩余货值(C=B1+B2+B3)
									 TO_CHAR( NVL(( SUM(A.Value_Stock)+SUM(A.VALUE_HAVED_SALE)),0)/10000, '999,999,999,999,990.00') AS "getWorth",
									 --已领证货值(D=B3+B4)
									 (CASE
												WHEN (SUM(A.VALUE_STOCK)+SUM(A.VALUE_HAVED_SALE)) = 0 
                        THEN  '-'
												ELSE
												 TO_CHAR(NVL( SUM(A.VALUE_HAVED_SALE) / ( SUM(A.VALUE_STOCK)+SUM(A.VALUE_HAVED_SALE)),0) * 100, '999,999,999,999,990.00') || '%'
										END) AS "salesRate",
									 --去化率(E=B4/D)
									 TO_CHAR( NVL(SUM(A.VALUE_NOT_PLANNING_PERMIT),0) / 10000, '999,999,999,999,990.00') AS "noPlanningPermitObtainedPhase",
									 --F、动态货值的各阶段分布-F0未取规证
									 TO_CHAR( NVL(SUM(A.VALUE_NOT_CONSTRUCTION_PERMIT),0) / 10000, '999,999,999,999,990.00') AS "planningPermitObtainedOhase",
									 --F、动态货值的各阶段分布-F1规划许可证阶段
									 TO_CHAR( NVL(SUM(A.VALUE_NOT_SALE_PERMIT) ,0)/ 10000, '999,999,999,999,990.00') AS "constructionPermitOhase",
									 --F、动态货值的各阶段分布-F2施工许可证阶段
									 TO_CHAR( NVL(SUM(A.VALUE_NOT_COMPLETION),0) / 10000, '999,999,999,999,990.00') AS "PreSalePermitPhase",
									 --F、动态货值的各阶段分布-F3预售许可证阶段
									 --TO_CHAR(b.value_yes_completion / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
									 TO_CHAR( NVL(SUM(A.VALUE_YES_COMPLETION),0) / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",
									 --F、动态货值的各阶段分布-F4竣备阶段
									 '-' AS "carryDownPhase",
									 --F、动态货值的各阶段分布-F5结转阶段

									 TO_CHAR( NVL(SUM(A.VALUE_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "reserveWorth",
									 --G1、储备货值的量价情况-货值（G1=a1*b1）
									 TO_CHAR(NVL(( SUM(A.ZZ_AREA_RESERVE)+SUM(A.SY_AREA_RESERVE)),0), '999,999,999,999,990.00') AS "reserveCargo",
									 --G1、储备货值的量价情况-货量(a1)
									 '-' AS "reservePrice",
									 --G1、储备货值的量价情况-单价(b1)
									 TO_CHAR( NVL(SUM(A.value_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "inTransitWorth",
									 --G2、在途货值的量价情况-货值（G2=a2*b2）
									 TO_CHAR(NVL(( SUM(A.ZZ_AREA_IN_PROCESS)+SUM(A.SY_AREA_IN_PROCESS)),0), '999,999,999,999,990.00') AS "inTransitCargo",
									 --G2、在途货值的量价情况-货量(a2)
									 '-' AS "inTransitPrice",
									 --G2、在途货值的量价情况-单价(b2)
									 TO_CHAR( NVL(SUM(VALUE_STOCK),0) / 10000, '999,999,999,999,990.00') AS "stockWorth",
									 --G3、库存货值的量价情况-货值（G3=a3*b3）
									 TO_CHAR(NVL(( SUM(A.ZZ_AREA_STOCK) + SUM(A.SY_AREA_STOCK)),0), '999,999,999,999,990.00') AS "stockCargo",
									 --G3、库存货值的量价情况-货量(a3)
									 '-' AS "stockPrice",
									 --G3、库存货值的量价情况-单价(b3)
									 TO_CHAR( NVL(SUM(VALUE_HAVED_SALE),0) / 10000, '999,999,999,999,990.00') AS "soldWorth",
									 --G4、已售货值的量价情况-货值（G4=a4*b4）
									 TO_CHAR(NVL(( SUM(A.ZZ_AREA_HAVED_SALE)+SUM(A.SY_AREA_HAVED_SALE)),0), '999,999,999,999,990.00') AS "soldCargo",
									 --G4、已售货值的量价情况-货量(a4)
									 '-' AS "soldPrice" --G4、已售货值的量价情况-单价(b4)
						FROM   TEMP_DT_VALUE A
            INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
                       --WHERE  a.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END)
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE order by ORDER_HIERARCHY_CODE;
		END IF;

		IF TABSINDEX = 2 THEN
				OPEN INFO FOR
				WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   SYS_PROJECT A1
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
						SELECT A.ID AS "id",
									 --主键id（生成树的id，唯一可以是业务id）
									 A.PARENT_ID AS "parentId",
									 --父级id（生成树父级id）
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/value-project/detail?code=value_dtl&isOperate=' ||
												 A.PROJ_COOPERATE || '&projectId=' || A.ID || '&projectName=' ||
												 A.ORG_NAME || '&projectDate=' || A.TAKE_DATE || '&tabIndex=' ||
												 TABSINDEX || '&pageTitle=' || A.ORG_NAME --页面标题名称
												ELSE
												 ''
										END) AS "openUrl",
									 --详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/dynamic-volume/circular?companyId=' || A.PARENT_ID ||
												 '&projectId=' || A.ID || '&type=2' --companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
												ELSE
												 ''
										END) AS "openVisualUrl",
									 --打开可视化地址
									 ORG_LEVEL,
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '#eaf6ff'
												WHEN ORG_LEVEL = 2 THEN
												 '#ecfbee'
												WHEN ORG_LEVEL = 3 THEN
												 '#f2eed4'
												ELSE
												 ''
										END AS "excelRowBgColor",
									 --数据行导出excel背景色
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '' || ORG_NAME
												WHEN ORG_LEVEL = 2 THEN
												 '        ' || ORG_NAME
												WHEN ORG_LEVEL = 3 THEN
												 '                ' || ORG_NAME
												WHEN ORG_LEVEL = 4 THEN
												 '                        ' || ORG_NAME
												ELSE
												 '                                ' || ORG_NAME
										END AS "excelRowTextTreeOrgName",
									 --文本前面加空格模仿树
									 A.ORG_NAME AS "orgName",--公司/项目
									 --TO_CHAR(b.area_dt_all, '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
									 TO_CHAR(( SUM(A.ZZ_AREA_DT_ALL)+SUM(A.SY_AREA_DT_ALL)), '999,999,999,999,990.00') AS "targetSalesArea",--最新可售面积（不含车位）
									 '-' AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
									 '-' AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
									 '-' AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
									 '-' AS "targetNewestWorth",--目标总货值（A）-最新版(A)


									 '-' AS "dynamicTotalWorth",--动态总货值(B)
									 '-' AS "dynamicTotalWorthDifference",--总货值差额(B-A)
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_RESERVE)+SUM(A.SY_VALUE_RESERVE)),0) / 10000, '999,999,999,999,990.00') AS "reserveTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_IN_PROCESS) +SUM(A.SY_VALUE_IN_PROCESS)),0) / 10000, '999,999,999,999,990.00') AS "inProcessTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-在途货值(B2)--修改字段holdConstructionPermit=》inTransitWorth
									 TO_CHAR( NVL(( SUM(nvl(A.ZZ_VALUE_REMAIN,0))+SUM(nvl(A.SY_VALUE_REMAIN,0))),0) / 10000 ,'999,999,999,999,990.00') AS "stockWorth",  --动态总货值构成（B=B1+B2+B3+B4）-库存货值(B3)
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_HAVED_SALE) + SUM(A.SY_VALUE_HAVED_SALE)),0) / 10000, '999,999,999,999,990.00') AS "alreadySalesWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-已售货值(B4)
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_REMAIN) + SUM(A.SY_VALUE_REMAIN)),0) / 10000, '999,999,999,999,990.00') AS "residueWorth",
									 --剩余货值(C=B1+B2+B3)
									 TO_CHAR( NVL(( SUM(A.ZZ_VALUE_Stock)+SUM(A.ZZ_VALUE_HAVED_SALE) +SUM(A.SY_VALUE_STOCK)+SUM(A.SY_VALUE_HAVED_SALE)),0)/10000, '999,999,999,999,990.00') AS "getWorth",
									 --已领证货值(D=B3+B4)
									 (CASE
												WHEN  SUM(A.ZZ_VALUE_STOCK)+SUM(A.ZZ_VALUE_HAVED_SALE) + SUM(A.SY_VALUE_STOCK)+SUM(A.SY_VALUE_HAVED_SALE) = 0 
                        THEN  '-'
												ELSE
												 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_HAVED_SALE) + SUM(A.SY_VALUE_HAVED_SALE)),0) / ( SUM(A.ZZ_VALUE_STOCK)+SUM(A.ZZ_VALUE_HAVED_SALE) + SUM(A.SY_VALUE_STOCK)+SUM(A.SY_VALUE_HAVED_SALE)) * 100, '999,999,999,999,990.00') || '%'
										END) AS "salesRate",
									 --去化率(E=B4/D)
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_NOT_PLANNING_PERMIT) + SUM(A.SY_VALUE_NOT_PLANNING_PERMIT)),0) / 10000, '999,999,999,999,990.00') AS "noPlanningPermitObtainedPhase",
									 --F、动态货值的各阶段分布-F0未取规证
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_NOT_CONSTRUCTION_PER) + SUM(A.SY_VALUE_NOT_CONSTRUCTION_PER)),0) / 10000, '999,999,999,999,990.00') AS "planningPermitObtainedOhase",
									 --F、动态货值的各阶段分布-F1规划许可证阶段
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_NOT_SALE_PERMIT) + SUM(A.SY_VALUE_NOT_SALE_PERMIT)),0) / 10000, '999,999,999,999,990.00') AS "constructionPermitOhase",
									 --F、动态货值的各阶段分布-F2施工许可证阶段
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_NOT_COMPLETION) + SUM(A.SY_VALUE_NOT_COMPLETION)),0) / 10000, '999,999,999,999,990.00') AS "PreSalePermitPhase",
									 --F、动态货值的各阶段分布-F3预售许可证阶段
									 --TO_CHAR(b.value_yes_completion / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_YES_COMPLETION) + SUM(A.SY_VALUE_YES_COMPLETION)),0) / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",
									 --F、动态货值的各阶段分布-F4竣备阶段
									 '-' AS "carryDownPhase",
									 --F、动态货值的各阶段分布-F5结转阶段

									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_RESERVE) + SUM(A.SY_VALUE_RESERVE)),0) / 10000, '999,999,999,999,990.00') AS "reserveWorth",
									 --G1、储备货值的量价情况-货值（G1=a1*b1）
									 TO_CHAR(NVL(( SUM(A.ZZ_AREA_RESERVE) + SUM(A.SY_AREA_RESERVE)),0), '999,999,999,999,990.00') AS "reserveCargo",
									 --G1、储备货值的量价情况-货量(a1)
									 '-' AS "reservePrice",
									 --G1、储备货值的量价情况-单价(b1)
									 TO_CHAR(NVL(( SUM(A.ZZ_value_RESERVE) + SUM(A.SY_value_RESERVE)),0) / 10000,
														'999,999,999,999,990.00') AS "inTransitWorth",
									 --G2、在途货值的量价情况-货值（G2=a2*b2）
									 TO_CHAR(NVL(( SUM(A.ZZ_AREA_IN_PROCESS) + SUM(A.SY_AREA_IN_PROCESS)),0), '999,999,999,999,990.00') AS "inTransitCargo",
									 --G2、在途货值的量价情况-货量(a2)
									 '-' AS "inTransitPrice",
									 --G2、在途货值的量价情况-单价(b2)
									 TO_CHAR(NVL(( SUM(ZZ_VALUE_STOCK) + SUM(SY_VALUE_STOCK)),0) / 10000, '999,999,999,999,990.00') AS "stockWorth",
									 --G3、库存货值的量价情况-货值（G3=a3*b3）
									 TO_CHAR(NVl(( SUM(A.ZZ_AREA_STOCK) + SUM(A.SY_AREA_STOCK)),0), '999,999,999,999,990.00') AS "stockCargo",
									 --G3、库存货值的量价情况-货量(a3)
									 '-' AS "stockPrice",
									 --G3、库存货值的量价情况-单价(b3)
									 TO_CHAR(NVL(( SUM(ZZ_VALUE_HAVED_SALE) + SUM(SY_VALUE_HAVED_SALE)),0) / 10000, '999,999,999,999,990.00') AS "soldWorth",
									 --G4、已售货值的量价情况-货值（G4=a4*b4）
									 TO_CHAR(NVL(( SUM(A.ZZ_AREA_HAVED_SALE)+SUM(A.SY_AREA_HAVED_SALE)),0), '999,999,999,999,990.00') AS "soldCargo",
									 --G4、已售货值的量价情况-货量(a4)
									 '-' AS "soldPrice" --G4、已售货值的量价情况-单价(b4)
						FROM   TEMP_DT_VALUE A
            INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
                       --WHERE  a.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END)
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE order by ORDER_HIERARCHY_CODE;
		END IF;

		IF TABSINDEX = 3 --OR tabsindex = 4 OR tabsindex = 5 
		 THEN
				OPEN INFO FOR
				WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   SYS_PROJECT A1
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
						SELECT A.ID AS "id",
									 --主键id（生成树的id，唯一可以是业务id）
									 A.PARENT_ID AS "parentId",
									 --父级id（生成树父级id）
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/value-project/detail?code=value_dtl&isOperate=' ||
												 A.PROJ_COOPERATE || '&projectId=' || A.ID || '&projectName=' ||
												 A.ORG_NAME || '&projectDate=' || A.TAKE_DATE || '&tabIndex=' ||
												 TABSINDEX || '&pageTitle=' || A.ORG_NAME --页面标题名称
												ELSE
												 ''
										END) AS "openUrl",
									 --详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/dynamic-volume/circular?companyId=' || A.PARENT_ID ||
												 '&projectId=' || A.ID || '&type=2' --companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
												ELSE
												 ''
										END) AS "openVisualUrl",
									 --打开可视化地址
									 ORG_LEVEL,
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '#eaf6ff'
												WHEN ORG_LEVEL = 2 THEN
												 '#ecfbee'
												WHEN ORG_LEVEL = 3 THEN
												 '#f2eed4'
												ELSE
												 ''
										END AS "excelRowBgColor",
									 --数据行导出excel背景色
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '' || ORG_NAME
												WHEN ORG_LEVEL = 2 THEN
												 '        ' || ORG_NAME
												WHEN ORG_LEVEL = 3 THEN
												 '                ' || ORG_NAME
												WHEN ORG_LEVEL = 4 THEN
												 '                        ' || ORG_NAME
												ELSE
												 '                                ' || ORG_NAME
										END AS "excelRowTextTreeOrgName",
									 --文本前面加空格模仿树
									 A.ORG_NAME AS "orgName",--公司/项目
									 --TO_CHAR(b.area_dt_all, '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
									 TO_CHAR( SUM(A.ZZ_AREA_DT_ALL), '999,999,999,999,990.00') AS "targetSalesArea",--最新可售面积（不含车位）
									 '-' AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
									 '-' AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
									 '-' AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
									 '-' AS "targetNewestWorth",--目标总货值（A）-最新版(A)


									 '-' AS "dynamicTotalWorth",--动态总货值(B)
									 '-' AS "dynamicTotalWorthDifference",--总货值差额(B-A)
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "reserveTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_IN_PROCESS),0) / 10000, '999,999,999,999,990.00') AS "inProcessTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-在途货值(B2)--修改字段holdConstructionPermit=》inTransitWorth
									 TO_CHAR(  NVL(SUM(nvl(A.ZZ_VALUE_REMAIN,0)),0) / 10000 ,'999,999,999,999,990.00') AS "stockWorth",  --动态总货值构成（B=B1+B2+B3+B4）-库存货值(B3)
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_HAVED_SALE),0) / 10000, '999,999,999,999,990.00') AS "alreadySalesWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-已售货值(B4)
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_REMAIN),0)/ 10000, '999,999,999,999,990.00') AS "residueWorth",
									 --剩余货值(C=B1+B2+B3)
									 TO_CHAR( NVL(( SUM(A.ZZ_VALUE_Stock)+SUM(A.ZZ_VALUE_HAVED_SALE)),0)/10000, '999,999,999,999,990.00') AS "getWorth",
									 --已领证货值(D=B3+B4)
									 (CASE
												WHEN  SUM(A.ZZ_VALUE_STOCK)+SUM(A.ZZ_VALUE_HAVED_SALE) = 0 
                        THEN  '-'
												ELSE
												 TO_CHAR( NVL(SUM(A.ZZ_VALUE_HAVED_SALE),0) / ( SUM(A.ZZ_VALUE_STOCK)+SUM(A.ZZ_VALUE_HAVED_SALE)) * 100,
																 '999,999,999,999,990.00') || '%'
										END) AS "salesRate",
									 --去化率(E=B4/D)
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_NOT_PLANNING_PERMIT),0) / 10000, '999,999,999,999,990.00') AS "noPlanningPermitObtainedPhase",
									 --F、动态货值的各阶段分布-F0未取规证
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_NOT_CONSTRUCTION_PER),0) / 10000, '999,999,999,999,990.00') AS "planningPermitObtainedOhase",
									 --F、动态货值的各阶段分布-F1规划许可证阶段
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_NOT_SALE_PERMIT),0) / 10000, '999,999,999,999,990.00') AS "constructionPermitOhase",
									 --F、动态货值的各阶段分布-F2施工许可证阶段
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_NOT_COMPLETION),0) / 10000, '999,999,999,999,990.00') AS "PreSalePermitPhase",
									 --F、动态货值的各阶段分布-F3预售许可证阶段
									 --TO_CHAR(b.value_yes_completion / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_YES_COMPLETION),0) / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",
									 --F、动态货值的各阶段分布-F4竣备阶段
									 '-' AS "carryDownPhase",
									 --F、动态货值的各阶段分布-F5结转阶段

									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "reserveWorth",
									 --G1、储备货值的量价情况-货值（G1=a1*b1）
									 TO_CHAR( NVL(SUM(A.ZZ_AREA_RESERVE),0), '999,999,999,999,990.00') AS "reserveCargo",
									 --G1、储备货值的量价情况-货量(a1)
									 '-' AS "reservePrice",
									 --G1、储备货值的量价情况-单价(b1)
									 TO_CHAR( NVL(SUM(A.ZZ_value_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "inTransitWorth",
									 --G2、在途货值的量价情况-货值（G2=a2*b2）
									 TO_CHAR( NVL(SUM(A.ZZ_AREA_IN_PROCESS),0), '999,999,999,999,990.00') AS "inTransitCargo",
									 --G2、在途货值的量价情况-货量(a2)
									 '-' AS "inTransitPrice",
									 --G2、在途货值的量价情况-单价(b2)
									 TO_CHAR( NVL(SUM(ZZ_VALUE_STOCK),0) / 10000, '999,999,999,999,990.00') AS "stockWorth",
									 --G3、库存货值的量价情况-货值（G3=a3*b3）
									 TO_CHAR( NVL(SUM(A.ZZ_AREA_STOCK),0) , '999,999,999,999,990.00') AS "stockCargo",
									 --G3、库存货值的量价情况-货量(a3)
									 '-' AS "stockPrice",
									 --G3、库存货值的量价情况-单价(b3)
									 TO_CHAR( NVL(SUM(ZZ_VALUE_HAVED_SALE),0) / 10000, '999,999,999,999,990.00') AS "soldWorth",
									 --G4、已售货值的量价情况-货值（G4=a4*b4）
									 TO_CHAR( NVL(SUM(A.ZZ_AREA_HAVED_SALE),0), '999,999,999,999,990.00') AS "soldCargo",
									 --G4、已售货值的量价情况-货量(a4)
									 '-' AS "soldPrice" --G4、已售货值的量价情况-单价(b4)
												FROM   TEMP_DT_VALUE A
            INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
                       --WHERE  a.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END)
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE order by ORDER_HIERARCHY_CODE;
		END IF;

		IF TABSINDEX = 4 THEN
				OPEN INFO FOR
				WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   SYS_PROJECT A1
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
						SELECT A.ID AS "id",
									 --主键id（生成树的id，唯一可以是业务id）
									 A.PARENT_ID AS "parentId",
									 --父级id（生成树父级id）
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/value-project/detail?code=value_dtl&isOperate=' ||
												 A.PROJ_COOPERATE || '&projectId=' || A.ID || '&projectName=' ||
												 A.ORG_NAME || '&projectDate=' || A.TAKE_DATE || '&tabIndex=' ||
												 TABSINDEX || '&pageTitle=' || A.ORG_NAME --页面标题名称
												ELSE
												 ''
										END) AS "openUrl",
									 --详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/dynamic-volume/circular?companyId=' || A.PARENT_ID ||
												 '&projectId=' || A.ID || '&type=2' --companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
												ELSE
												 ''
										END) AS "openVisualUrl",
									 --打开可视化地址
									 ORG_LEVEL,
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '#eaf6ff'
												WHEN ORG_LEVEL = 2 THEN
												 '#ecfbee'
												WHEN ORG_LEVEL = 3 THEN
												 '#f2eed4'
												ELSE
												 ''
										END AS "excelRowBgColor",
									 --数据行导出excel背景色
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '' || ORG_NAME
												WHEN ORG_LEVEL = 2 THEN
												 '        ' || ORG_NAME
												WHEN ORG_LEVEL = 3 THEN
												 '                ' || ORG_NAME
												WHEN ORG_LEVEL = 4 THEN
												 '                        ' || ORG_NAME
												ELSE
												 '                                ' || ORG_NAME
										END AS "excelRowTextTreeOrgName",
									 --文本前面加空格模仿树
									 A.ORG_NAME AS "orgName",--公司/项目
									 --TO_CHAR(b.area_dt_all, '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
									 TO_CHAR( SUM(A.SY_AREA_DT_ALL), '999,999,999,999,990.00') AS "targetSalesArea",--最新可售面积（不含车位）
									 '-' AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
									 '-' AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
									 '-' AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
									 '-' AS "targetNewestWorth",--目标总货值（A）-最新版(A)
                   '-' AS "dynamicTotalWorth",--动态总货值(B)
									 '-' AS "dynamicTotalWorthDifference",--总货值差额(B-A)
									 TO_CHAR( NVL(SUM(A.SY_VALUE_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "reserveTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
									 TO_CHAR(NVL(SUM(A.SY_VALUE_IN_PROCESS),0) / 10000, '999,999,999,999,990.00') AS "inProcessTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-在途货值(B2)--修改字段holdConstructionPermit=》inTransitWorth
									 TO_CHAR(SUM(nvl(A.SY_VALUE_REMAIN,0)) / 10000 ,'999,999,999,999,990.00') AS "stockWorth",  --动态总货值构成（B=B1+B2+B3+B4）-库存货值(B3)
									 TO_CHAR( NVL(SUM(A.SY_VALUE_HAVED_SALE),0) / 10000, '999,999,999,999,990.00') AS "alreadySalesWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-已售货值(B4)
									 TO_CHAR( NVL(SUM(A.SY_VALUE_REMAIN),0) / 10000, '999,999,999,999,990.00') AS "residueWorth",
									 --剩余货值(C=B1+B2+B3)
									 TO_CHAR(  NVL((SUM(A.SY_VALUE_Stock)+SUM(A.SY_VALUE_HAVED_SALE)),0)/10000, '999,999,999,999,990.00') AS "getWorth",
									 --已领证货值(D=B3+B4)
									 (CASE
												WHEN  SUM(A.SY_VALUE_STOCK)+SUM(A.SY_VALUE_HAVED_SALE) = 0 
                        THEN  '-'
												ELSE
												 TO_CHAR( NVL(SUM(A.SY_VALUE_HAVED_SALE),0) / ( SUM(A.SY_VALUE_STOCK)+SUM(A.SY_VALUE_HAVED_SALE)) * 100, '999,999,999,999,990.00') || '%'
										END) AS "salesRate",
									 --去化率(E=B4/D)
									 TO_CHAR( NVL(SUM(A.SY_VALUE_NOT_PLANNING_PERMIT),0) / 10000, '999,999,999,999,990.00') AS "noPlanningPermitObtainedPhase",
									 --F、动态货值的各阶段分布-F0未取规证
									 TO_CHAR( NVL(SUM(A.SY_VALUE_NOT_CONSTRUCTION_PER),0) / 10000, '999,999,999,999,990.00') AS "planningPermitObtainedOhase",
									 --F、动态货值的各阶段分布-F1规划许可证阶段
									 TO_CHAR( NVL(SUM(A.SY_VALUE_NOT_SALE_PERMIT),0) / 10000, '999,999,999,999,990.00') AS "constructionPermitOhase",
									 --F、动态货值的各阶段分布-F2施工许可证阶段
									 TO_CHAR( NVL(SUM(A.SY_VALUE_NOT_COMPLETION),0) / 10000, '999,999,999,999,990.00') AS "PreSalePermitPhase",
									 --F、动态货值的各阶段分布-F3预售许可证阶段
									 --TO_CHAR(b.value_yes_completion / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
									 TO_CHAR( NVL(SUM(A.SY_VALUE_YES_COMPLETION),0) / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",
									 --F、动态货值的各阶段分布-F4竣备阶段
									 '-' AS "carryDownPhase",
									 --F、动态货值的各阶段分布-F5结转阶段

									 TO_CHAR( NVL(SUM(A.SY_VALUE_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "reserveWorth",
									 --G1、储备货值的量价情况-货值（G1=a1*b1）
									 TO_CHAR( NVL(SUM(A.SY_AREA_RESERVE),0), '999,999,999,999,990.00') AS "reserveCargo",
									 --G1、储备货值的量价情况-货量(a1)
									 '-' AS "reservePrice",
									 --G1、储备货值的量价情况-单价(b1)
									 TO_CHAR( NVL(SUM(A.SY_value_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "inTransitWorth",
									 --G2、在途货值的量价情况-货值（G2=a2*b2）
									 TO_CHAR( NVL(SUM(A.SY_AREA_IN_PROCESS),0), '999,999,999,999,990.00') AS "inTransitCargo",
									 --G2、在途货值的量价情况-货量(a2)
									 '-' AS "inTransitPrice",
									 --G2、在途货值的量价情况-单价(b2)
									 TO_CHAR( NVL(SUM(SY_VALUE_STOCK),0) / 10000, '999,999,999,999,990.00') AS "stockWorth",
									 --G3、库存货值的量价情况-货值（G3=a3*b3）
									 TO_CHAR( NVL(SUM(A.SY_AREA_STOCK),0) , '999,999,999,999,990.00') AS "stockCargo",
									 --G3、库存货值的量价情况-货量(a3)
									 '-' AS "stockPrice",
									 --G3、库存货值的量价情况-单价(b3)
									 TO_CHAR( NVL(SUM(SY_VALUE_HAVED_SALE),0) / 10000, '999,999,999,999,990.00') AS "soldWorth",
									 --G4、已售货值的量价情况-货值（G4=a4*b4）
									 TO_CHAR( NVL(SUM(A.SY_AREA_HAVED_SALE),0), '999,999,999,999,990.00') AS "soldCargo",
									 --G4、已售货值的量价情况-货量(a4)
									 '-' AS "soldPrice" --G4、已售货值的量价情况-单价(b4)
						FROM   TEMP_DT_VALUE A
            INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
                       --WHERE  a.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END)
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE order by ORDER_HIERARCHY_CODE;
		END IF;

		IF TABSINDEX = 5 THEN
				OPEN INFO FOR
				WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   SYS_PROJECT A1
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
						SELECT A.ID AS "id",
									 --主键id（生成树的id，唯一可以是业务id）
									 A.PARENT_ID AS "parentId",
									 --父级id（生成树父级id）
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/value-project/detail?code=value_dtl&isOperate=' ||
												 A.PROJ_COOPERATE || '&projectId=' || A.ID || '&projectName=' ||
												 A.ORG_NAME || '&projectDate=' || A.TAKE_DATE || '&tabIndex=' ||
												 TABSINDEX || '&pageTitle=' || A.ORG_NAME --页面标题名称
												ELSE
												 ''
										END) AS "openUrl",
									 --详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/dynamic-volume/circular?companyId=' || A.PARENT_ID ||
												 '&projectId=' || A.ID || '&type=2' --companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
												ELSE
												 ''
										END) AS "openVisualUrl",
									 --打开可视化地址
									 ORG_LEVEL,
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '#eaf6ff'
												WHEN ORG_LEVEL = 2 THEN
												 '#ecfbee'
												WHEN ORG_LEVEL = 3 THEN
												 '#f2eed4'
												ELSE
												 ''
										END AS "excelRowBgColor",
									 --数据行导出excel背景色
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '' || ORG_NAME
												WHEN ORG_LEVEL = 2 THEN
												 '        ' || ORG_NAME
												WHEN ORG_LEVEL = 3 THEN
												 '                ' || ORG_NAME
												WHEN ORG_LEVEL = 4 THEN
												 '                        ' || ORG_NAME
												ELSE
												 '                                ' || ORG_NAME
										END AS "excelRowTextTreeOrgName",
									 --文本前面加空格模仿树
									 A.ORG_NAME AS "orgName",--公司/项目
									 --TO_CHAR(b.area_dt_all, '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
									 TO_CHAR( NVL(SUM(A.CW_AREA_DT_ALL),0), '999,999,999,999,990.00') AS "targetSalesArea",--最新可售面积（不含车位）
									 '-' AS "targetFeasibleWorth",--目标总货值（A）-可研版(A2)
									 '-' AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
									 '-' AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
									  '-' AS "targetNewestWorth",--目标总货值（A）-最新版(A)

                   '-' AS "dynamicTotalWorth",--动态总货值(B)
									 '-' AS "dynamicTotalWorthDifference",--总货值差额(B-A)
									 TO_CHAR( NVL(SUM(A.CW_VALUE_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "reserveTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
									 TO_CHAR( NVL(SUM(A.CW_VALUE_IN_PROCESS),0) / 10000, '999,999,999,999,990.00') AS "inProcessTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-在途货值(B2)--修改字段holdConstructionPermit=》inTransitWorth
									 TO_CHAR(  NVL(SUM(nvl(A.CW_VALUE_REMAIN,0)),0) / 10000 ,'999,999,999,999,990.00') AS "stockWorth",  --动态总货值构成（B=B1+B2+B3+B4）-库存货值(B3)
									 TO_CHAR( NVL(SUM(A.CW_VALUE_HAVED_SALE),0) / 10000, '999,999,999,999,990.00') AS "alreadySalesWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-已售货值(B4)
									 TO_CHAR( NVL(SUM(A.CW_VALUE_REMAIN),0) / 10000, '999,999,999,999,990.00') AS "residueWorth",
									 --剩余货值(C=B1+B2+B3)
									 TO_CHAR( NVL(( SUM(A.CW_VALUE_Stock)+SUM(A.CW_VALUE_HAVED_SALE)),0)/10000, '999,999,999,999,990.00') AS "getWorth",
									 --已领证货值(D=B3+B4)
									 CASE
												WHEN  SUM(A.CW_VALUE_STOCK)+SUM(A.CW_VALUE_HAVED_SALE) = 0 
                        THEN  '-'
												ELSE
												 TO_CHAR( NVL(SUM(A.CW_VALUE_HAVED_SALE),0) / ( SUM(A.CW_VALUE_STOCK)+SUM(A.CW_VALUE_HAVED_SALE)) * 100, '999,999,999,999,990.00') || '%'
										END AS "salesRate",
									 --去化率(E=B4/D)
									 TO_CHAR(NVL( SUM(A.CW_VALUE_NOT_PLANNING_PERMIT),0) / 10000, '999,999,999,999,990.00') AS "noPlanningPermitObtainedPhase",
									 --F、动态货值的各阶段分布-F0未取规证
									 TO_CHAR( NVL(SUM(A.CW_VALUE_NOT_CONSTRUCTION_PER),0) / 10000, '999,999,999,999,990.00') AS "planningPermitObtainedOhase",
									 --F、动态货值的各阶段分布-F1规划许可证阶段
									 TO_CHAR( NVL(SUM(A.CW_VALUE_NOT_SALE_PERMIT),0) / 10000, '999,999,999,999,990.00') AS "constructionPermitOhase",
									 --F、动态货值的各阶段分布-F2施工许可证阶段
									 TO_CHAR( NVL(SUM(A.CW_VALUE_NOT_COMPLETION),0) / 10000, '999,999,999,999,990.00') AS "PreSalePermitPhase",
									 --F、动态货值的各阶段分布-F3预售许可证阶段
									 --TO_CHAR(b.value_yes_completion / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
									 TO_CHAR( NVL(SUM(A.CW_VALUE_YES_COMPLETION),0) / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",
									 --F、动态货值的各阶段分布-F4竣备阶段
									 '-' AS "carryDownPhase",
									 --F、动态货值的各阶段分布-F5结转阶段

									 TO_CHAR( NVL(SUM(A.CW_VALUE_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "reserveWorth",
									 --G1、储备货值的量价情况-货值（G1=a1*b1）
									 TO_CHAR( NVL(SUM(A.CW_AREA_RESERVE),0), '999,999,999,999,990.00') AS "reserveCargo",
									 --G1、储备货值的量价情况-货量(a1)
									 '-' AS "reservePrice",
									 --G1、储备货值的量价情况-单价(b1)
									 TO_CHAR( NVL(SUM(A.CW_value_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "inTransitWorth",
									 --G2、在途货值的量价情况-货值（G2=a2*b2）
									 TO_CHAR( NVL(SUM(A.CW_AREA_IN_PROCESS),0), '999,999,999,999,990.00') AS "inTransitCargo",
									 --G2、在途货值的量价情况-货量(a2)
									 '-' AS "inTransitPrice",
									 --G2、在途货值的量价情况-单价(b2)
									 TO_CHAR( NVL(SUM(CW_VALUE_STOCK),0) / 10000, '999,999,999,999,990.00') AS "stockWorth",
									 --G3、库存货值的量价情况-货值（G3=a3*b3）
									 TO_CHAR( NVL(SUM(A.CW_AREA_STOCK),0) , '999,999,999,999,990.00') AS "stockCargo",
									 --G3、库存货值的量价情况-货量(a3)
									 '-' AS "stockPrice",
									 --G3、库存货值的量价情况-单价(b3)
									 TO_CHAR( NVL(SUM(CW_VALUE_HAVED_SALE),0) / 10000, '999,999,999,999,990.00') AS "soldWorth",
									 --G4、已售货值的量价情况-货值（G4=a4*b4）
									 TO_CHAR( NVL(SUM(A.CW_AREA_HAVED_SALE),0), '999,999,999,999,990.00') AS "soldCargo",
									 --G4、已售货值的量价情况-货量(a4)
									 '-' AS "soldPrice" --G4、已售货值的量价情况-单价(b4)
						FROM   TEMP_DT_VALUE A
            INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
                       --WHERE  a.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END)    
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE
                    
                        order by ORDER_HIERARCHY_CODE;
		END IF;

END P_DWM_DT_VALUE_LIST;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DT_VALUE_LISTE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_DT_VALUE_LISTE" 
(
		USERID       IN VARCHAR2 --当前用户id
	 ,STATIONID    IN VARCHAR2 --当前用户岗位id
	 ,DEPARTMENTID IN VARCHAR2 --当前用户部门id
	 ,COMPANYID    IN VARCHAR2 --当前用户公司id
	 ,UNITID       IN VARCHAR2 --选择公司id
	 ,ISOPERATE    IN VARCHAR2 --是否操盘
	 ,TABSINDEX    IN INT --选择选项卡。1开始
	 ,INFO         OUT SYS_REFCURSOR
) AS
		--动态货值管理-全案动态货值-主列表
		--作者：陈丽
		--日期：2019/12/17
		DATA_AUTH_SPID VARCHAR2(200);
		BIZCODE        VARCHAR2(200);
        IS_P_OPERATE VARCHAR2(200);
         unitid_val       VARCHAR2(200);
BEGIN
		unitid_val:=nvl(UNITID,'003200000000000000000000000000');
        --权限编码
		BIZCODE := 'DWM.DTHZGL.03';
		P_SYS_GET_COMPANY_PROJ_SPID(USERID         => USERID,
																STATIONID      => STATIONID,
																DEPTID         => DEPARTMENTID,
																COMPANYID      => COMPANYID,
																BIZCODE        => BIZCODE,
																DATA_AUTH_SPID => DATA_AUTH_SPID);

		IF TABSINDEX = 1 THEN
				DBMS_OUTPUT.PUT_LINE('所有业态!');
		ELSIF TABSINDEX = 2 THEN
				DBMS_OUTPUT.PUT_LINE('住宅及商办!');
		ELSIF TABSINDEX = 3 THEN
				DBMS_OUTPUT.PUT_LINE('住宅!');
		ELSIF TABSINDEX = 4 THEN
				DBMS_OUTPUT.PUT_LINE('商办!');
		ELSIF TABSINDEX = 5 THEN
				DBMS_OUTPUT.PUT_LINE('车位!');
		ELSIF TABSINDEX = 6 THEN
				DBMS_OUTPUT.PUT_LINE('剩余货值表!');
				OPEN INFO FOR
						WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   MDM_PROJECT A1  
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
            SELECT A.ID AS "id",
                   --主键id（生成树的id，唯一可以是业务id）
                   A.PARENT_ID AS "parentId",
                   --父级id（生成树父级id）
                   CASE
                       WHEN A.IS_COMPANY = 0 THEN
                        '/dwm/value-manage/value-project/detail?code=value_dtl'||CHR(38)||'isOperate=' ||
                        A.PROJ_COOPERATE || CHR(38)||'projectId=' || A.ID ||CHR(38)||
                        'projectName=' || A.ORG_NAME || CHR(38)||'projectDate=' ||
                        A.TAKE_DATE ||CHR(38) ||'tabIndex=' || TABSINDEX ||CHR(38)||
                        'pageTitle=' || A.ORG_NAME --页面标题名称
                       ELSE
                        ''
                   END AS "openUrl",
                   --详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
                   CASE
                       WHEN A.IS_COMPANY = 0 THEN
                        '/dwm/value-manage/dynamic-volume/circular?companyId=' ||
                        A.PARENT_ID ||CHR(38) ||'projectId=' || A.ID || CHR(38)||'type=2' --companyId加载项目的公司id，项目id：默认选中的项目id，type：货值是1，货值是2
                       ELSE
                        ''
                   END AS "openVisualUrl",
                   --打开可视化地址
                   ORG_LEVEL,
                   CASE
                       WHEN ORG_LEVEL = 1 THEN
                        '#eaf6ff'
                       WHEN ORG_LEVEL = 2 THEN
                        '#ecfbee'
                       WHEN ORG_LEVEL = 3 THEN
                        '#f2eed4'
                       ELSE
                        ''
                   END AS "excelRowBgColor",
                   --数据行导出excel背景色
                   CASE
                       WHEN ORG_LEVEL = 1 THEN
                        '' || ORG_NAME
                       WHEN ORG_LEVEL = 2 THEN
                        '        ' || ORG_NAME
                       WHEN ORG_LEVEL = 3 THEN
                        '                ' || ORG_NAME
                       WHEN ORG_LEVEL = 4 THEN
                        '                        ' || ORG_NAME
                       ELSE
                        '                                ' || ORG_NAME
                   END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                   A.ORG_NAME AS "orgName",--公司/项目
                   TO_CHAR(NVL(ROUND( SUM(A.ZZ_VALUE_REMAIN) / 10000, 2),0),'FM999,999,999,990.00') AS "projWholeDwellingValue",--项目全案剩余可售货值（S=A+B+C+D）-住宅(m2)
                   TO_CHAR(NVL(ROUND( SUM(A.SY_VALUE_REMAIN) / 10000, 2),0),'FM999,999,999,990.00') AS "projWholeBusinessValue",--项目全案剩余可售货值（S=A+B+C+D）-商业(m2)
                   TO_CHAR(NVL(ROUND( SUM(A.CW_VALUE_REMAIN) / 10000, 2),0),'FM999,999,999,990.00') AS "projWholeCarportValue",--项目全案剩余可售货值（S=A+B+C+D）-车位(个)
                   TO_CHAR(NVL(ROUND(( SUM(A.ZZ_VALUE_REMAIN)+SUM(A.CW_VALUE_REMAIN)+SUM(A.SY_VALUE_REMAIN)) / 10000,2),0),'FM999,999,999,990.00') AS "projWholeTotalValue",
                   --项目全案剩余可售货值（S=A+B+C+D）-合计(m2)

                   TO_CHAR(NVL(ROUND( SUM(A.ZZ_VALUE_NOT_PLANNING_PERMIT),0) / 10000, 2),'FM999,999,999,990.00') AS "ADwellingValue",--A未取规证的可售货值-住宅(m2)
                   TO_CHAR(NVL(ROUND( SUM(A.SY_VALUE_NOT_PLANNING_PERMIT),0) / 10000, 2),'FM999,999,999,990.00') AS "ABusinessValue",--A未取规证的可售货值-商业(m2)
                   TO_CHAR(NVL(ROUND( SUM(A.CW_VALUE_NOT_PLANNING_PERMIT),0) / 10000, 2),'FM999,999,999,990.00') AS "ACarportValue",--A未取规证的可售货值-车位(个)
                   TO_CHAR(NVL(ROUND((SUM(A.ZZ_VALUE_NOT_PLANNING_PERMIT)+SUM(A.CW_VALUE_NOT_PLANNING_PERMIT)+SUM(A.SY_VALUE_NOT_PLANNING_PERMIT)),0) / 10000,2),'FM999,999,999,990.00') AS "ATotalValue",--A未取规证的可售货值-合计(m2)
                   TO_CHAR(ROUND( NVL(SUM(A.ZZ_VALUE_NOT_CONSTRUCTION_PER),0) / 10000, 2),'FM999,999,999,990.00') AS "BDwellingValue",--B已取规证未取施工证的可售货值-住宅(m2)
                   TO_CHAR(ROUND(NVL(SUM(A.SY_VALUE_NOT_CONSTRUCTION_PER) / 10000, 2),0),'FM999,999,999,990.00') AS "BBusinessValue",--B已取规证未取施工证的可售货值-商业(m2)
                   TO_CHAR(ROUND(NVL(SUM(A.CW_VALUE_NOT_CONSTRUCTION_PER) / 10000, 2),0),'FM999,999,999,990.00') AS "BCarportValue",--B已取规证未取施工证的可售货值-车位(个)
                   TO_CHAR(NVL(ROUND((SUM(A.ZZ_VALUE_NOT_CONSTRUCTION_PER)+SUM(A.SY_VALUE_NOT_CONSTRUCTION_PER) + SUM(A.CW_VALUE_NOT_CONSTRUCTION_PER))/ 10000,2),0),'FM999,999,999,990.00') AS "BTotalValue",--B已取规证未取施工证的可售货值-合计(m2)

                   TO_CHAR(NVL(ROUND(SUM(A.ZZ_VALUE_NOT_SALE_PERMIT),0) / 10000, 2),'FM999,999,999,990.00') AS "CDwellingValue",--C已取施工证未取预售证的可售货值-住宅(m2)
                   TO_CHAR(NVL(ROUND(SUM(A.SY_VALUE_NOT_SALE_PERMIT),0) / 10000, 2),'FM999,999,999,990.00') AS "CBusinessValue",--C已取施工证未取预售证的可售货值-商业(m2)
                   TO_CHAR(NVL(ROUND(SUM(A.CW_VALUE_NOT_SALE_PERMIT),0) / 10000, 2),'FM999,999,999,990.00') AS "CCarportValue",--C已取施工证未取预售证的可售货值-车位(个)
                   TO_CHAR(NVL(ROUND((SUM(A.ZZ_VALUE_NOT_SALE_PERMIT)+SUM(A.SY_VALUE_NOT_SALE_PERMIT)+SUM(A.CW_VALUE_NOT_SALE_PERMIT)) / 10000,2),0),'FM999,999,999,990.00') AS "CTotalValue",--C已取施工证未取预售证的可售货值-合计(m2)

                   TO_CHAR(NVL(ROUND( SUM(A.ZZ_VALUE_STOCK) / 10000, 2),0),'FM999,999,999,990.00') AS "DDwellingValue",--D已取预售证未售的可售货值-住宅(m2)
                   TO_CHAR(NVL(ROUND(SUM(A.SY_VALUE_STOCK) / 10000, 2),0),'FM999,999,999,990.00') AS "DBusinessValue",--D已取预售证未售的可售货值-商业(m2)
                   TO_CHAR(NVL(ROUND(SUM(A.CW_VALUE_STOCK) / 10000, 2),0),'FM999,999,999,990.00') AS "DCarportValue",--D已取预售证未售的可售货值-车位(个)
                   TO_CHAR(NVL(ROUND((SUM(A.ZZ_VALUE_STOCK)+SUM(A.SY_VALUE_STOCK)+SUM(A.CW_VALUE_STOCK)) / 10000,2),0),'FM999,999,999,990.00') AS "DTotalValue" --D已取预售证未售的可售货值-合计(m2)
            FROM   TEMP_DT_VALUE A
            INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
            --WHERE  a.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END)
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE order by ORDER_HIERARCHY_CODE;

		END IF;

		IF TABSINDEX = 1   THEN
				OPEN INFO FOR
				WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   MDM_PROJECT A1
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
						SELECT A.ID AS "id",
									 --主键id（生成树的id，唯一可以是业务id）
									 A.PARENT_ID AS "parentId",
									 --父级id（生成树父级id）
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/value-project/detail?code=value_dtl&isOperate=' ||
												 A.PROJ_COOPERATE || '&projectId=' || A.ID || '&projectName=' ||
												 A.ORG_NAME || '&projectDate=' || A.TAKE_DATE || '&tabIndex=' ||
												 TABSINDEX || '&pageTitle=' || A.ORG_NAME --页面标题名称
												ELSE
												 ''
										END) AS "openUrl",
									 --详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/dynamic-volume/circular?companyId=' || A.PARENT_ID ||
												 '&projectId=' || A.ID || '&type=2' --companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
												ELSE
												 ''
										END) AS "openVisualUrl",
									 --打开可视化地址
									 ORG_LEVEL,
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '#eaf6ff'
												WHEN ORG_LEVEL = 2 THEN
												 '#ecfbee'
												WHEN ORG_LEVEL = 3 THEN
												 '#f2eed4'
												ELSE
												 ''
										END AS "excelRowBgColor",
									 --数据行导出excel背景色
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '' || ORG_NAME
												WHEN ORG_LEVEL = 2 THEN
												 '        ' || ORG_NAME
												WHEN ORG_LEVEL = 3 THEN
												 '                ' || ORG_NAME
												WHEN ORG_LEVEL = 4 THEN
												 '                        ' || ORG_NAME
												ELSE
												 '                                ' || ORG_NAME
										END AS "excelRowTextTreeOrgName",
									 --文本前面加空格模仿树
									 A.ORG_NAME AS "orgName",--公司/项目
									 --TO_CHAR(b.area_dt_all, '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
									 TO_CHAR( NVL(SUM(A.AREA_DT_ALL),0), '999,999,999,999,990.00') AS "targetSalesArea",--最新可售面积（不含车位）
									 TO_CHAR(NVL(SUM(A.TARGET_A1_VALUE),0),'999,999,999,999,990.00') AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
									 TO_CHAR( NVL(SUM(A.TARGET_A2_VALUE),0),'999,999,999,999,990.00') AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
									 TO_CHAR( NVL(SUM(A.TARGET_A3_VALUE),0),'999,999,999,999,990.00') AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
									  TO_CHAR( NVL(SUM(A.TARGET_A_VALUE),0),'999,999,999,999,990.00') AS "targetNewestWorth",--目标总货值（A）-最新版(A)

/*                   TO_CHAR((SELECT SUM(A.Target_Now)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN v_DWM_DT_VALUE DDV ON A.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID)
                            ,'999,999,999,999,990.00') AS "targetNewestWorth",--目标总货值（A）-最新版(A)*/

									 TO_CHAR( round(NVL(SUM(A.value_dt_all),0)/10000,2), '999,999,999,999,990.00') AS "dynamicTotalWorth",--动态总货值(B)
									 (CASE
												WHEN round( SUM(A.value_dt_all)/10000-SUM(A.TARGET_A_VALUE),2) < -1 THEN
												 '<font color=red>' ||TO_CHAR( SUM(A.value_dt_all)/10000-SUM(A.TARGET_A_VALUE),'999,999,999,999,990.00') || '</font>'
												ELSE
												 '<font color=green>' ||TO_CHAR( SUM(A.value_dt_all)/10000-SUM(A.TARGET_A_VALUE),'999,999,999,999,990.00') || '</font>'
										END) AS "dynamicTotalWorthDifference",--总货值差额(B-A)
									 TO_CHAR( NVL(SUM(A.VALUE_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "reserveTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
									 TO_CHAR( NVL(SUM(A.VALUE_IN_PROCESS),0) / 10000, '999,999,999,999,990.00') AS "inProcessTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-在途货值(B2)--修改字段holdConstructionPermit=》inTransitWorth
									 TO_CHAR(  SUM(nvl(A.VALUE_STOCK,0))/ 10000 ,'999,999,999,999,990.00') AS "stockWorth",  --动态总货值构成（B=B1+B2+B3+B4）-库存货值(B3)
									 TO_CHAR( NVL(SUM(A.VALUE_HAVED_SALE),0) / 10000, '999,999,999,999,990.00') AS "alreadySalesWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-已售货值(B4)
									 TO_CHAR( NVL(SUM(A.VALUE_REMAIN),0), '999,999,999,999,990.00') AS "residueWorth",
									 --剩余货值(C=B1+B2+B3)
									 TO_CHAR( NVL(( SUM(A.Value_Stock)+SUM(A.VALUE_HAVED_SALE)),0)/10000, '999,999,999,999,990.00') AS "getWorth",
									 --已领证货值(D=B3+B4)
									 (CASE
												WHEN (SUM(A.VALUE_STOCK)+SUM(A.VALUE_HAVED_SALE)) = 0 
                        THEN  '-'
												ELSE
												 TO_CHAR(NVL( SUM(A.VALUE_HAVED_SALE) / ( SUM(A.VALUE_STOCK)+SUM(A.VALUE_HAVED_SALE)),0) * 100, '999,999,999,999,990.00') || '%'
										END) AS "salesRate",
									 --去化率(E=B4/D)
									 TO_CHAR( NVL(SUM(A.VALUE_NOT_PLANNING_PERMIT),0) / 10000, '999,999,999,999,990.00') AS "noPlanningPermitObtainedPhase",
									 --F、动态货值的各阶段分布-F0未取规证
									 TO_CHAR( NVL(SUM(A.VALUE_NOT_CONSTRUCTION_PERMIT),0) / 10000, '999,999,999,999,990.00') AS "planningPermitObtainedOhase",
									 --F、动态货值的各阶段分布-F1规划许可证阶段
									 TO_CHAR( NVL(SUM(A.VALUE_NOT_SALE_PERMIT) ,0)/ 10000, '999,999,999,999,990.00') AS "constructionPermitOhase",
									 --F、动态货值的各阶段分布-F2施工许可证阶段
									 TO_CHAR( NVL(SUM(A.VALUE_NOT_COMPLETION),0) / 10000, '999,999,999,999,990.00') AS "PreSalePermitPhase",
									 --F、动态货值的各阶段分布-F3预售许可证阶段
									 --TO_CHAR(b.value_yes_completion / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
									 TO_CHAR( NVL(SUM(A.VALUE_YES_COMPLETION),0) / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",
									 --F、动态货值的各阶段分布-F4竣备阶段
									 '-' AS "carryDownPhase",
									 --F、动态货值的各阶段分布-F5结转阶段

									 TO_CHAR( NVL(SUM(A.VALUE_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "reserveWorth",
									 --G1、储备货值的量价情况-货值（G1=a1*b1）
									 TO_CHAR(NVL(( SUM(A.ZZ_AREA_RESERVE)+SUM(A.SY_AREA_RESERVE)),0), '999,999,999,999,990.00') AS "reserveCargo",
									 --G1、储备货值的量价情况-货量(a1)
									 '-' AS "reservePrice",
									 --G1、储备货值的量价情况-单价(b1)
									 TO_CHAR( NVL(SUM(A.value_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "inTransitWorth",
									 --G2、在途货值的量价情况-货值（G2=a2*b2）
									 TO_CHAR(NVL(( SUM(A.ZZ_AREA_IN_PROCESS)+SUM(A.SY_AREA_IN_PROCESS)),0), '999,999,999,999,990.00') AS "inTransitCargo",
									 --G2、在途货值的量价情况-货量(a2)
									 '-' AS "inTransitPrice",
									 --G2、在途货值的量价情况-单价(b2)
									 TO_CHAR( NVL(SUM(VALUE_STOCK),0) / 10000, '999,999,999,999,990.00') AS "stockWorth",
									 --G3、库存货值的量价情况-货值（G3=a3*b3）
									 TO_CHAR(NVL(( SUM(A.ZZ_AREA_STOCK) + SUM(A.SY_AREA_STOCK)),0), '999,999,999,999,990.00') AS "stockCargo",
									 --G3、库存货值的量价情况-货量(a3)
									 '-' AS "stockPrice",
									 --G3、库存货值的量价情况-单价(b3)
									 TO_CHAR( NVL(SUM(VALUE_HAVED_SALE),0) / 10000, '999,999,999,999,990.00') AS "soldWorth",
									 --G4、已售货值的量价情况-货值（G4=a4*b4）
									 TO_CHAR(NVL(( SUM(A.ZZ_AREA_HAVED_SALE)+SUM(A.SY_AREA_HAVED_SALE)),0), '999,999,999,999,990.00') AS "soldCargo",
									 --G4、已售货值的量价情况-货量(a4)
									 '-' AS "soldPrice" --G4、已售货值的量价情况-单价(b4)
						FROM   TEMP_DT_VALUE A
            INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
                       --WHERE  a.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END)
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE order by ORDER_HIERARCHY_CODE;
		END IF;

		IF TABSINDEX = 2 THEN
				OPEN INFO FOR
				WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   MDM_PROJECT A1
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
						SELECT A.ID AS "id",
									 --主键id（生成树的id，唯一可以是业务id）
									 A.PARENT_ID AS "parentId",
									 --父级id（生成树父级id）
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/value-project/detail?code=value_dtl&isOperate=' ||
												 A.PROJ_COOPERATE || '&projectId=' || A.ID || '&projectName=' ||
												 A.ORG_NAME || '&projectDate=' || A.TAKE_DATE || '&tabIndex=' ||
												 TABSINDEX || '&pageTitle=' || A.ORG_NAME --页面标题名称
												ELSE
												 ''
										END) AS "openUrl",
									 --详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/dynamic-volume/circular?companyId=' || A.PARENT_ID ||
												 '&projectId=' || A.ID || '&type=2' --companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
												ELSE
												 ''
										END) AS "openVisualUrl",
									 --打开可视化地址
									 ORG_LEVEL,
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '#eaf6ff'
												WHEN ORG_LEVEL = 2 THEN
												 '#ecfbee'
												WHEN ORG_LEVEL = 3 THEN
												 '#f2eed4'
												ELSE
												 ''
										END AS "excelRowBgColor",
									 --数据行导出excel背景色
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '' || ORG_NAME
												WHEN ORG_LEVEL = 2 THEN
												 '        ' || ORG_NAME
												WHEN ORG_LEVEL = 3 THEN
												 '                ' || ORG_NAME
												WHEN ORG_LEVEL = 4 THEN
												 '                        ' || ORG_NAME
												ELSE
												 '                                ' || ORG_NAME
										END AS "excelRowTextTreeOrgName",
									 --文本前面加空格模仿树
									 A.ORG_NAME AS "orgName",--公司/项目
									 --TO_CHAR(b.area_dt_all, '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
									 TO_CHAR(( SUM(A.ZZ_AREA_DT_ALL)+SUM(A.SY_AREA_DT_ALL)), '999,999,999,999,990.00') AS "targetSalesArea",--最新可售面积（不含车位）
									 '-' AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
									 '-' AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
									 '-' AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
									 '-' AS "targetNewestWorth",--目标总货值（A）-最新版(A)


									 '-' AS "dynamicTotalWorth",--动态总货值(B)
									 '-' AS "dynamicTotalWorthDifference",--总货值差额(B-A)
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_RESERVE)+SUM(A.SY_VALUE_RESERVE)),0) / 10000, '999,999,999,999,990.00') AS "reserveTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_IN_PROCESS) +SUM(A.SY_VALUE_IN_PROCESS)),0) / 10000, '999,999,999,999,990.00') AS "inProcessTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-在途货值(B2)--修改字段holdConstructionPermit=》inTransitWorth
									 TO_CHAR( NVL(( SUM(nvl(A.ZZ_VALUE_REMAIN,0))+SUM(nvl(A.SY_VALUE_REMAIN,0))),0) / 10000 ,'999,999,999,999,990.00') AS "stockWorth",  --动态总货值构成（B=B1+B2+B3+B4）-库存货值(B3)
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_HAVED_SALE) + SUM(A.SY_VALUE_HAVED_SALE)),0) / 10000, '999,999,999,999,990.00') AS "alreadySalesWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-已售货值(B4)
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_REMAIN) + SUM(A.SY_VALUE_REMAIN)),0) / 10000, '999,999,999,999,990.00') AS "residueWorth",
									 --剩余货值(C=B1+B2+B3)
									 TO_CHAR( NVL(( SUM(A.ZZ_VALUE_Stock)+SUM(A.ZZ_VALUE_HAVED_SALE) +SUM(A.SY_VALUE_STOCK)+SUM(A.SY_VALUE_HAVED_SALE)),0)/10000, '999,999,999,999,990.00') AS "getWorth",
									 --已领证货值(D=B3+B4)
									 (CASE
												WHEN  SUM(A.ZZ_VALUE_STOCK)+SUM(A.ZZ_VALUE_HAVED_SALE) + SUM(A.SY_VALUE_STOCK)+SUM(A.SY_VALUE_HAVED_SALE) = 0 
                        THEN  '-'
												ELSE
												 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_HAVED_SALE) + SUM(A.SY_VALUE_HAVED_SALE)),0) / ( SUM(A.ZZ_VALUE_STOCK)+SUM(A.ZZ_VALUE_HAVED_SALE) + SUM(A.SY_VALUE_STOCK)+SUM(A.SY_VALUE_HAVED_SALE)) * 100, '999,999,999,999,990.00') || '%'
										END) AS "salesRate",
									 --去化率(E=B4/D)
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_NOT_PLANNING_PERMIT) + SUM(A.SY_VALUE_NOT_PLANNING_PERMIT)),0) / 10000, '999,999,999,999,990.00') AS "noPlanningPermitObtainedPhase",
									 --F、动态货值的各阶段分布-F0未取规证
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_NOT_CONSTRUCTION_PER) + SUM(A.SY_VALUE_NOT_CONSTRUCTION_PER)),0) / 10000, '999,999,999,999,990.00') AS "planningPermitObtainedOhase",
									 --F、动态货值的各阶段分布-F1规划许可证阶段
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_NOT_SALE_PERMIT) + SUM(A.SY_VALUE_NOT_SALE_PERMIT)),0) / 10000, '999,999,999,999,990.00') AS "constructionPermitOhase",
									 --F、动态货值的各阶段分布-F2施工许可证阶段
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_NOT_COMPLETION) + SUM(A.SY_VALUE_NOT_COMPLETION)),0) / 10000, '999,999,999,999,990.00') AS "PreSalePermitPhase",
									 --F、动态货值的各阶段分布-F3预售许可证阶段
									 --TO_CHAR(b.value_yes_completion / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_YES_COMPLETION) + SUM(A.SY_VALUE_YES_COMPLETION)),0) / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",
									 --F、动态货值的各阶段分布-F4竣备阶段
									 '-' AS "carryDownPhase",
									 --F、动态货值的各阶段分布-F5结转阶段

									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_RESERVE) + SUM(A.SY_VALUE_RESERVE)),0) / 10000, '999,999,999,999,990.00') AS "reserveWorth",
									 --G1、储备货值的量价情况-货值（G1=a1*b1）
									 TO_CHAR(NVL(( SUM(A.ZZ_AREA_RESERVE) + SUM(A.SY_AREA_RESERVE)),0), '999,999,999,999,990.00') AS "reserveCargo",
									 --G1、储备货值的量价情况-货量(a1)
									 '-' AS "reservePrice",
									 --G1、储备货值的量价情况-单价(b1)
									 TO_CHAR(NVL(( SUM(A.ZZ_value_RESERVE) + SUM(A.SY_value_RESERVE)),0) / 10000,
														'999,999,999,999,990.00') AS "inTransitWorth",
									 --G2、在途货值的量价情况-货值（G2=a2*b2）
									 TO_CHAR(NVL(( SUM(A.ZZ_AREA_IN_PROCESS) + SUM(A.SY_AREA_IN_PROCESS)),0), '999,999,999,999,990.00') AS "inTransitCargo",
									 --G2、在途货值的量价情况-货量(a2)
									 '-' AS "inTransitPrice",
									 --G2、在途货值的量价情况-单价(b2)
									 TO_CHAR(NVL(( SUM(ZZ_VALUE_STOCK) + SUM(SY_VALUE_STOCK)),0) / 10000, '999,999,999,999,990.00') AS "stockWorth",
									 --G3、库存货值的量价情况-货值（G3=a3*b3）
									 TO_CHAR(NVl(( SUM(A.ZZ_AREA_STOCK) + SUM(A.SY_AREA_STOCK)),0), '999,999,999,999,990.00') AS "stockCargo",
									 --G3、库存货值的量价情况-货量(a3)
									 '-' AS "stockPrice",
									 --G3、库存货值的量价情况-单价(b3)
									 TO_CHAR(NVL(( SUM(ZZ_VALUE_HAVED_SALE) + SUM(SY_VALUE_HAVED_SALE)),0) / 10000, '999,999,999,999,990.00') AS "soldWorth",
									 --G4、已售货值的量价情况-货值（G4=a4*b4）
									 TO_CHAR(NVL(( SUM(A.ZZ_AREA_HAVED_SALE)+SUM(A.SY_AREA_HAVED_SALE)),0), '999,999,999,999,990.00') AS "soldCargo",
									 --G4、已售货值的量价情况-货量(a4)
									 '-' AS "soldPrice" --G4、已售货值的量价情况-单价(b4)
						FROM   TEMP_DT_VALUE A
            INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
                       --WHERE  a.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END)
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE order by ORDER_HIERARCHY_CODE;
		END IF;

		IF TABSINDEX = 3 --OR tabsindex = 4 OR tabsindex = 5 
		 THEN
				OPEN INFO FOR
				WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   MDM_PROJECT A1
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
						SELECT A.ID AS "id",
									 --主键id（生成树的id，唯一可以是业务id）
									 A.PARENT_ID AS "parentId",
									 --父级id（生成树父级id）
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/value-project/detail?code=value_dtl&isOperate=' ||
												 A.PROJ_COOPERATE || '&projectId=' || A.ID || '&projectName=' ||
												 A.ORG_NAME || '&projectDate=' || A.TAKE_DATE || '&tabIndex=' ||
												 TABSINDEX || '&pageTitle=' || A.ORG_NAME --页面标题名称
												ELSE
												 ''
										END) AS "openUrl",
									 --详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/dynamic-volume/circular?companyId=' || A.PARENT_ID ||
												 '&projectId=' || A.ID || '&type=2' --companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
												ELSE
												 ''
										END) AS "openVisualUrl",
									 --打开可视化地址
									 ORG_LEVEL,
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '#eaf6ff'
												WHEN ORG_LEVEL = 2 THEN
												 '#ecfbee'
												WHEN ORG_LEVEL = 3 THEN
												 '#f2eed4'
												ELSE
												 ''
										END AS "excelRowBgColor",
									 --数据行导出excel背景色
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '' || ORG_NAME
												WHEN ORG_LEVEL = 2 THEN
												 '        ' || ORG_NAME
												WHEN ORG_LEVEL = 3 THEN
												 '                ' || ORG_NAME
												WHEN ORG_LEVEL = 4 THEN
												 '                        ' || ORG_NAME
												ELSE
												 '                                ' || ORG_NAME
										END AS "excelRowTextTreeOrgName",
									 --文本前面加空格模仿树
									 A.ORG_NAME AS "orgName",--公司/项目
									 --TO_CHAR(b.area_dt_all, '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
									 TO_CHAR( SUM(A.ZZ_AREA_DT_ALL), '999,999,999,999,990.00') AS "targetSalesArea",--最新可售面积（不含车位）
									 '-' AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
									 '-' AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
									 '-' AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
									 '-' AS "targetNewestWorth",--目标总货值（A）-最新版(A)


									 '-' AS "dynamicTotalWorth",--动态总货值(B)
									 '-' AS "dynamicTotalWorthDifference",--总货值差额(B-A)
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "reserveTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_IN_PROCESS),0) / 10000, '999,999,999,999,990.00') AS "inProcessTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-在途货值(B2)--修改字段holdConstructionPermit=》inTransitWorth
									 TO_CHAR(  NVL(SUM(nvl(A.ZZ_VALUE_REMAIN,0)),0) / 10000 ,'999,999,999,999,990.00') AS "stockWorth",  --动态总货值构成（B=B1+B2+B3+B4）-库存货值(B3)
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_HAVED_SALE),0) / 10000, '999,999,999,999,990.00') AS "alreadySalesWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-已售货值(B4)
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_REMAIN),0)/ 10000, '999,999,999,999,990.00') AS "residueWorth",
									 --剩余货值(C=B1+B2+B3)
									 TO_CHAR( NVL(( SUM(A.ZZ_VALUE_Stock)+SUM(A.ZZ_VALUE_HAVED_SALE)),0)/10000, '999,999,999,999,990.00') AS "getWorth",
									 --已领证货值(D=B3+B4)
									 (CASE
												WHEN  SUM(A.ZZ_VALUE_STOCK)+SUM(A.ZZ_VALUE_HAVED_SALE) = 0 
                        THEN  '-'
												ELSE
												 TO_CHAR( NVL(SUM(A.ZZ_VALUE_HAVED_SALE),0) / ( SUM(A.ZZ_VALUE_STOCK)+SUM(A.ZZ_VALUE_HAVED_SALE)) * 100,
																 '999,999,999,999,990.00') || '%'
										END) AS "salesRate",
									 --去化率(E=B4/D)
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_NOT_PLANNING_PERMIT),0) / 10000, '999,999,999,999,990.00') AS "noPlanningPermitObtainedPhase",
									 --F、动态货值的各阶段分布-F0未取规证
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_NOT_CONSTRUCTION_PER),0) / 10000, '999,999,999,999,990.00') AS "planningPermitObtainedOhase",
									 --F、动态货值的各阶段分布-F1规划许可证阶段
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_NOT_SALE_PERMIT),0) / 10000, '999,999,999,999,990.00') AS "constructionPermitOhase",
									 --F、动态货值的各阶段分布-F2施工许可证阶段
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_NOT_COMPLETION),0) / 10000, '999,999,999,999,990.00') AS "PreSalePermitPhase",
									 --F、动态货值的各阶段分布-F3预售许可证阶段
									 --TO_CHAR(b.value_yes_completion / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_YES_COMPLETION),0) / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",
									 --F、动态货值的各阶段分布-F4竣备阶段
									 '-' AS "carryDownPhase",
									 --F、动态货值的各阶段分布-F5结转阶段

									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "reserveWorth",
									 --G1、储备货值的量价情况-货值（G1=a1*b1）
									 TO_CHAR( NVL(SUM(A.ZZ_AREA_RESERVE),0), '999,999,999,999,990.00') AS "reserveCargo",
									 --G1、储备货值的量价情况-货量(a1)
									 '-' AS "reservePrice",
									 --G1、储备货值的量价情况-单价(b1)
									 TO_CHAR( NVL(SUM(A.ZZ_value_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "inTransitWorth",
									 --G2、在途货值的量价情况-货值（G2=a2*b2）
									 TO_CHAR( NVL(SUM(A.ZZ_AREA_IN_PROCESS),0), '999,999,999,999,990.00') AS "inTransitCargo",
									 --G2、在途货值的量价情况-货量(a2)
									 '-' AS "inTransitPrice",
									 --G2、在途货值的量价情况-单价(b2)
									 TO_CHAR( NVL(SUM(ZZ_VALUE_STOCK),0) / 10000, '999,999,999,999,990.00') AS "stockWorth",
									 --G3、库存货值的量价情况-货值（G3=a3*b3）
									 TO_CHAR( NVL(SUM(A.ZZ_AREA_STOCK),0) , '999,999,999,999,990.00') AS "stockCargo",
									 --G3、库存货值的量价情况-货量(a3)
									 '-' AS "stockPrice",
									 --G3、库存货值的量价情况-单价(b3)
									 TO_CHAR( NVL(SUM(ZZ_VALUE_HAVED_SALE),0) / 10000, '999,999,999,999,990.00') AS "soldWorth",
									 --G4、已售货值的量价情况-货值（G4=a4*b4）
									 TO_CHAR( NVL(SUM(A.ZZ_AREA_HAVED_SALE),0), '999,999,999,999,990.00') AS "soldCargo",
									 --G4、已售货值的量价情况-货量(a4)
									 '-' AS "soldPrice" --G4、已售货值的量价情况-单价(b4)
												FROM   TEMP_DT_VALUE A
            INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
                       --WHERE  a.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END)
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE order by ORDER_HIERARCHY_CODE;
		END IF;

		IF TABSINDEX = 4 THEN
				OPEN INFO FOR
				WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   MDM_PROJECT A1
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
						SELECT A.ID AS "id",
									 --主键id（生成树的id，唯一可以是业务id）
									 A.PARENT_ID AS "parentId",
									 --父级id（生成树父级id）
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/value-project/detail?code=value_dtl&isOperate=' ||
												 A.PROJ_COOPERATE || '&projectId=' || A.ID || '&projectName=' ||
												 A.ORG_NAME || '&projectDate=' || A.TAKE_DATE || '&tabIndex=' ||
												 TABSINDEX || '&pageTitle=' || A.ORG_NAME --页面标题名称
												ELSE
												 ''
										END) AS "openUrl",
									 --详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/dynamic-volume/circular?companyId=' || A.PARENT_ID ||
												 '&projectId=' || A.ID || '&type=2' --companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
												ELSE
												 ''
										END) AS "openVisualUrl",
									 --打开可视化地址
									 ORG_LEVEL,
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '#eaf6ff'
												WHEN ORG_LEVEL = 2 THEN
												 '#ecfbee'
												WHEN ORG_LEVEL = 3 THEN
												 '#f2eed4'
												ELSE
												 ''
										END AS "excelRowBgColor",
									 --数据行导出excel背景色
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '' || ORG_NAME
												WHEN ORG_LEVEL = 2 THEN
												 '        ' || ORG_NAME
												WHEN ORG_LEVEL = 3 THEN
												 '                ' || ORG_NAME
												WHEN ORG_LEVEL = 4 THEN
												 '                        ' || ORG_NAME
												ELSE
												 '                                ' || ORG_NAME
										END AS "excelRowTextTreeOrgName",
									 --文本前面加空格模仿树
									 A.ORG_NAME AS "orgName",--公司/项目
									 --TO_CHAR(b.area_dt_all, '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
									 TO_CHAR( SUM(A.SY_AREA_DT_ALL), '999,999,999,999,990.00') AS "targetSalesArea",--最新可售面积（不含车位）
									 '-' AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
									 '-' AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
									 '-' AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
									 '-' AS "targetNewestWorth",--目标总货值（A）-最新版(A)
                   '-' AS "dynamicTotalWorth",--动态总货值(B)
									 '-' AS "dynamicTotalWorthDifference",--总货值差额(B-A)
									 TO_CHAR( NVL(SUM(A.SY_VALUE_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "reserveTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
									 TO_CHAR(NVL(SUM(A.SY_VALUE_IN_PROCESS),0) / 10000, '999,999,999,999,990.00') AS "inProcessTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-在途货值(B2)--修改字段holdConstructionPermit=》inTransitWorth
									 TO_CHAR(SUM(nvl(A.SY_VALUE_REMAIN,0)) / 10000 ,'999,999,999,999,990.00') AS "stockWorth",  --动态总货值构成（B=B1+B2+B3+B4）-库存货值(B3)
									 TO_CHAR( NVL(SUM(A.SY_VALUE_HAVED_SALE),0) / 10000, '999,999,999,999,990.00') AS "alreadySalesWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-已售货值(B4)
									 TO_CHAR( NVL(SUM(A.SY_VALUE_REMAIN),0) / 10000, '999,999,999,999,990.00') AS "residueWorth",
									 --剩余货值(C=B1+B2+B3)
									 TO_CHAR(  NVL((SUM(A.SY_VALUE_Stock)+SUM(A.SY_VALUE_HAVED_SALE)),0)/10000, '999,999,999,999,990.00') AS "getWorth",
									 --已领证货值(D=B3+B4)
									 (CASE
												WHEN  SUM(A.SY_VALUE_STOCK)+SUM(A.SY_VALUE_HAVED_SALE) = 0 
                        THEN  '-'
												ELSE
												 TO_CHAR( NVL(SUM(A.SY_VALUE_HAVED_SALE),0) / ( SUM(A.SY_VALUE_STOCK)+SUM(A.SY_VALUE_HAVED_SALE)) * 100, '999,999,999,999,990.00') || '%'
										END) AS "salesRate",
									 --去化率(E=B4/D)
									 TO_CHAR( NVL(SUM(A.SY_VALUE_NOT_PLANNING_PERMIT),0) / 10000, '999,999,999,999,990.00') AS "noPlanningPermitObtainedPhase",
									 --F、动态货值的各阶段分布-F0未取规证
									 TO_CHAR( NVL(SUM(A.SY_VALUE_NOT_CONSTRUCTION_PER),0) / 10000, '999,999,999,999,990.00') AS "planningPermitObtainedOhase",
									 --F、动态货值的各阶段分布-F1规划许可证阶段
									 TO_CHAR( NVL(SUM(A.SY_VALUE_NOT_SALE_PERMIT),0) / 10000, '999,999,999,999,990.00') AS "constructionPermitOhase",
									 --F、动态货值的各阶段分布-F2施工许可证阶段
									 TO_CHAR( NVL(SUM(A.SY_VALUE_NOT_COMPLETION),0) / 10000, '999,999,999,999,990.00') AS "PreSalePermitPhase",
									 --F、动态货值的各阶段分布-F3预售许可证阶段
									 --TO_CHAR(b.value_yes_completion / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
									 TO_CHAR( NVL(SUM(A.SY_VALUE_YES_COMPLETION),0) / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",
									 --F、动态货值的各阶段分布-F4竣备阶段
									 '-' AS "carryDownPhase",
									 --F、动态货值的各阶段分布-F5结转阶段

									 TO_CHAR( NVL(SUM(A.SY_VALUE_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "reserveWorth",
									 --G1、储备货值的量价情况-货值（G1=a1*b1）
									 TO_CHAR( NVL(SUM(A.SY_AREA_RESERVE),0), '999,999,999,999,990.00') AS "reserveCargo",
									 --G1、储备货值的量价情况-货量(a1)
									 '-' AS "reservePrice",
									 --G1、储备货值的量价情况-单价(b1)
									 TO_CHAR( NVL(SUM(A.SY_value_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "inTransitWorth",
									 --G2、在途货值的量价情况-货值（G2=a2*b2）
									 TO_CHAR( NVL(SUM(A.SY_AREA_IN_PROCESS),0), '999,999,999,999,990.00') AS "inTransitCargo",
									 --G2、在途货值的量价情况-货量(a2)
									 '-' AS "inTransitPrice",
									 --G2、在途货值的量价情况-单价(b2)
									 TO_CHAR( NVL(SUM(SY_VALUE_STOCK),0) / 10000, '999,999,999,999,990.00') AS "stockWorth",
									 --G3、库存货值的量价情况-货值（G3=a3*b3）
									 TO_CHAR( NVL(SUM(A.SY_AREA_STOCK),0) , '999,999,999,999,990.00') AS "stockCargo",
									 --G3、库存货值的量价情况-货量(a3)
									 '-' AS "stockPrice",
									 --G3、库存货值的量价情况-单价(b3)
									 TO_CHAR( NVL(SUM(SY_VALUE_HAVED_SALE),0) / 10000, '999,999,999,999,990.00') AS "soldWorth",
									 --G4、已售货值的量价情况-货值（G4=a4*b4）
									 TO_CHAR( NVL(SUM(A.SY_AREA_HAVED_SALE),0), '999,999,999,999,990.00') AS "soldCargo",
									 --G4、已售货值的量价情况-货量(a4)
									 '-' AS "soldPrice" --G4、已售货值的量价情况-单价(b4)
						FROM   TEMP_DT_VALUE A
            INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
                       --WHERE  a.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END)
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE order by ORDER_HIERARCHY_CODE;
		END IF;

		IF TABSINDEX = 5 THEN
				OPEN INFO FOR
				WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   MDM_PROJECT A1
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
						SELECT A.ID AS "id",
									 --主键id（生成树的id，唯一可以是业务id）
									 A.PARENT_ID AS "parentId",
									 --父级id（生成树父级id）
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/value-project/detail?code=value_dtl&isOperate=' ||
												 A.PROJ_COOPERATE || '&projectId=' || A.ID || '&projectName=' ||
												 A.ORG_NAME || '&projectDate=' || A.TAKE_DATE || '&tabIndex=' ||
												 TABSINDEX || '&pageTitle=' || A.ORG_NAME --页面标题名称
												ELSE
												 ''
										END) AS "openUrl",
									 --详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/dynamic-volume/circular?companyId=' || A.PARENT_ID ||
												 '&projectId=' || A.ID || '&type=2' --companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
												ELSE
												 ''
										END) AS "openVisualUrl",
									 --打开可视化地址
									 ORG_LEVEL,
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '#eaf6ff'
												WHEN ORG_LEVEL = 2 THEN
												 '#ecfbee'
												WHEN ORG_LEVEL = 3 THEN
												 '#f2eed4'
												ELSE
												 ''
										END AS "excelRowBgColor",
									 --数据行导出excel背景色
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '' || ORG_NAME
												WHEN ORG_LEVEL = 2 THEN
												 '        ' || ORG_NAME
												WHEN ORG_LEVEL = 3 THEN
												 '                ' || ORG_NAME
												WHEN ORG_LEVEL = 4 THEN
												 '                        ' || ORG_NAME
												ELSE
												 '                                ' || ORG_NAME
										END AS "excelRowTextTreeOrgName",
									 --文本前面加空格模仿树
									 A.ORG_NAME AS "orgName",--公司/项目
									 --TO_CHAR(b.area_dt_all, '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
									 TO_CHAR( NVL(SUM(A.CW_AREA_DT_ALL),0), '999,999,999,999,990.00') AS "targetSalesArea",--最新可售面积（不含车位）
									 '-' AS "targetFeasibleWorth",--目标总货值（A）-可研版(A2)
									 '-' AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
									 '-' AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
									  '-' AS "targetNewestWorth",--目标总货值（A）-最新版(A)

                   '-' AS "dynamicTotalWorth",--动态总货值(B)
									 '-' AS "dynamicTotalWorthDifference",--总货值差额(B-A)
									 TO_CHAR( NVL(SUM(A.CW_VALUE_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "reserveTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
									 TO_CHAR( NVL(SUM(A.CW_VALUE_IN_PROCESS),0) / 10000, '999,999,999,999,990.00') AS "inProcessTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-在途货值(B2)--修改字段holdConstructionPermit=》inTransitWorth
									 TO_CHAR(  NVL(SUM(nvl(A.CW_VALUE_REMAIN,0)),0) / 10000 ,'999,999,999,999,990.00') AS "stockWorth",  --动态总货值构成（B=B1+B2+B3+B4）-库存货值(B3)
									 TO_CHAR( NVL(SUM(A.CW_VALUE_HAVED_SALE),0) / 10000, '999,999,999,999,990.00') AS "alreadySalesWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-已售货值(B4)
									 TO_CHAR( NVL(SUM(A.CW_VALUE_REMAIN),0) / 10000, '999,999,999,999,990.00') AS "residueWorth",
									 --剩余货值(C=B1+B2+B3)
									 TO_CHAR( NVL(( SUM(A.CW_VALUE_Stock)+SUM(A.CW_VALUE_HAVED_SALE)),0)/10000, '999,999,999,999,990.00') AS "getWorth",
									 --已领证货值(D=B3+B4)
									 CASE
												WHEN  SUM(A.CW_VALUE_STOCK)+SUM(A.CW_VALUE_HAVED_SALE) = 0 
                        THEN  '-'
												ELSE
												 TO_CHAR( NVL(SUM(A.CW_VALUE_HAVED_SALE),0) / ( SUM(A.CW_VALUE_STOCK)+SUM(A.CW_VALUE_HAVED_SALE)) * 100, '999,999,999,999,990.00') || '%'
										END AS "salesRate",
									 --去化率(E=B4/D)
									 TO_CHAR(NVL( SUM(A.CW_VALUE_NOT_PLANNING_PERMIT),0) / 10000, '999,999,999,999,990.00') AS "noPlanningPermitObtainedPhase",
									 --F、动态货值的各阶段分布-F0未取规证
									 TO_CHAR( NVL(SUM(A.CW_VALUE_NOT_CONSTRUCTION_PER),0) / 10000, '999,999,999,999,990.00') AS "planningPermitObtainedOhase",
									 --F、动态货值的各阶段分布-F1规划许可证阶段
									 TO_CHAR( NVL(SUM(A.CW_VALUE_NOT_SALE_PERMIT),0) / 10000, '999,999,999,999,990.00') AS "constructionPermitOhase",
									 --F、动态货值的各阶段分布-F2施工许可证阶段
									 TO_CHAR( NVL(SUM(A.CW_VALUE_NOT_COMPLETION),0) / 10000, '999,999,999,999,990.00') AS "PreSalePermitPhase",
									 --F、动态货值的各阶段分布-F3预售许可证阶段
									 --TO_CHAR(b.value_yes_completion / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
									 TO_CHAR( NVL(SUM(A.CW_VALUE_YES_COMPLETION),0) / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",
									 --F、动态货值的各阶段分布-F4竣备阶段
									 '-' AS "carryDownPhase",
									 --F、动态货值的各阶段分布-F5结转阶段

									 TO_CHAR( NVL(SUM(A.CW_VALUE_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "reserveWorth",
									 --G1、储备货值的量价情况-货值（G1=a1*b1）
									 TO_CHAR( NVL(SUM(A.CW_AREA_RESERVE),0), '999,999,999,999,990.00') AS "reserveCargo",
									 --G1、储备货值的量价情况-货量(a1)
									 '-' AS "reservePrice",
									 --G1、储备货值的量价情况-单价(b1)
									 TO_CHAR( NVL(SUM(A.CW_value_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "inTransitWorth",
									 --G2、在途货值的量价情况-货值（G2=a2*b2）
									 TO_CHAR( NVL(SUM(A.CW_AREA_IN_PROCESS),0), '999,999,999,999,990.00') AS "inTransitCargo",
									 --G2、在途货值的量价情况-货量(a2)
									 '-' AS "inTransitPrice",
									 --G2、在途货值的量价情况-单价(b2)
									 TO_CHAR( NVL(SUM(CW_VALUE_STOCK),0) / 10000, '999,999,999,999,990.00') AS "stockWorth",
									 --G3、库存货值的量价情况-货值（G3=a3*b3）
									 TO_CHAR( NVL(SUM(A.CW_AREA_STOCK),0) , '999,999,999,999,990.00') AS "stockCargo",
									 --G3、库存货值的量价情况-货量(a3)
									 '-' AS "stockPrice",
									 --G3、库存货值的量价情况-单价(b3)
									 TO_CHAR( NVL(SUM(CW_VALUE_HAVED_SALE),0) / 10000, '999,999,999,999,990.00') AS "soldWorth",
									 --G4、已售货值的量价情况-货值（G4=a4*b4）
									 TO_CHAR( NVL(SUM(A.CW_AREA_HAVED_SALE),0), '999,999,999,999,990.00') AS "soldCargo",
									 --G4、已售货值的量价情况-货量(a4)
									 '-' AS "soldPrice" --G4、已售货值的量价情况-单价(b4)
						FROM   TEMP_DT_VALUE A
            INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
                       --WHERE  a.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END)    
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE
                    
                        order by ORDER_HIERARCHY_CODE;
		END IF;

END P_DWM_DT_VALUE_LISTE;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_EXPLANATIONBYCODE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_EXPLANATIONBYCODE" (keycode in varchar2,Explanation out clob)
as
keycodeStr varchar2(100):='';
begin
Explanation:='';
    if keycode is not null then
     keycodeStr:=keycode||'.explanation';
     end if;
    select DETAILS into Explanation from DWM_SALE_RATE_DATA_BRIEFING where code=keycodeStr and rownum=1;
end P_DWM_ExplanationByCode;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_GET_DT_VALUE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_GET_DT_VALUE" 
IS
/*
CREATE BY:WANGCK
CREATE DATE:20200601
后续需优化事项：取可研阶段数据时，要按照地块下的业态去取。
*/


    CURSOR CUR_BLD_LIST IS --取楼栋基础信息。
        SELECT A.ID as ID, A.PROJ_ID, A.PERIOD_ID, A.BUILD_NAME, A.IS_GET_CON_PLAN_PERMIT, A.GET_CON_PLAN_PERMIT_DATE, A.IS_GET_CONSTRCUTION_PERMIT, A.GET_CONSTRCUTION_PERMIT_DATE, A.IS_GET_PRE_SALE_PERMIT,
               A.GET_PRE_SALE_PERMIT_DATE, A.IS_GET_COMPLETED_PERMIT, A.GET_COMPLETED_PERMIT_DATE
        FROM   MDM_BUILD A
        WHERE  NVL(A.IS_DELETE, 0) = 0
        ;

    ITEM_BLD_LIST CUR_BLD_LIST%ROWTYPE;

    V_NEWEST_PHASE VARCHAR2(100); --存储楼栋当前对应阶段，跟据此值更新对应动态货值。

    CURSOR CUR_ROOM_ACCOUNT_LIST(V_BLD_ID VARCHAR2) IS --计算“已推货值”使用，取从《销售系统》同步房源数据。
    SELECT B.BUILDING_ID, B.PROJECT_NAME, B.PROJECT_ID AS PROJ_ID,
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' THEN ROUND(B.BZ_PRICE * NVL(B.NEW_BLD_AREA, 0), 2) ELSE 0 END), 0)) AS ALL库存货值_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' THEN NVL(B.TRADE_TOTAL, 0) ELSE 0 END), 0)) AS ALL已售货值_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' THEN ROUND(B.BZ_PRICE * NVL(B.NEW_BLD_AREA, 0), 2) ELSE 0 END), 0)) + SUM(NVL((CASE WHEN B.SALE_STATE = '签约' THEN NVL(B.TRADE_TOTAL, 0) ELSE 0 END), 0)) AS ALL库存及已售总货值 ,
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' THEN NVL(B.NEW_BLD_AREA, 0) ELSE 0 END), 0)) AS ALL库存面积_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' THEN NVL(B.NEW_BLD_AREA, 0) ELSE 0 END), 0)) AS ALL已售面积_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' THEN 1 ELSE 0 END), 0)) AS ALL库存套数_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' THEN 1 ELSE 0 END), 0)) AS ALL已售套数_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' AND B.PRODUCT_NAME IN ('住宅', '商办') THEN NVL(B.NEW_BLD_AREA, 0) ELSE 0 END), 0)) AS ALL库存货量_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' AND B.PRODUCT_NAME IN ('住宅', '商办') THEN NVL(B.NEW_BLD_AREA, 0) ELSE 0 END), 0)) AS ALL已售货量_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME IN ('住宅', '商办') THEN B.ACTUAL_BLD_AREA ELSE 0 END), 0)) AS ALL竣备面积_房间合计,
         SUM(NVL((CASE WHEN NVL(B.ACTUAL_BLD_AREA, 0) <> 0 AND B.SALE_STATE = '签约' THEN B.TRADE_TOTAL WHEN NVL(B.ACTUAL_BLD_AREA, 0) <> 0 AND B.SALE_STATE <> '签约' THEN B.BZ_TOTAL ELSE 0 END), 0)) AS ALL竣备货值_房间合计,
         SUM(NVL((CASE WHEN B.IS_INDIRECT = 1 THEN B.TRADE_TOTAL ELSE 0 END), 0)) AS ALL结转货值_房间合计,
         SUM(NVL((CASE WHEN B.IS_INDIRECT = 1 THEN B.ACTUAL_BLD_AREA ELSE 0 END), 0)) AS ALL结转货量_房间合计 ,
         --住宅
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' AND B.PRODUCT_NAME = '住宅' THEN ROUND(B.BZ_PRICE * NVL(B.NEW_BLD_AREA, 0), 2) ELSE 0 END), 0)) AS ZZ库存货值_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' AND B.PRODUCT_NAME = '住宅' THEN NVL(B.TRADE_TOTAL, 0) ELSE 0 END), 0)) AS ZZ已售货值_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' AND B.PRODUCT_NAME = '住宅' THEN NVL(B.NEW_BLD_AREA, 0) ELSE 0 END), 0)) AS ZZ库存面积_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' AND B.PRODUCT_NAME = '住宅' THEN NVL(B.NEW_BLD_AREA, 0) ELSE 0 END), 0)) AS ZZ已售面积_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' AND B.PRODUCT_NAME = '住宅' THEN 1 ELSE 0 END), 0)) AS ZZ库存套数_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' AND B.PRODUCT_NAME = '住宅' THEN 1 ELSE 0 END), 0)) AS ZZ已售套数_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME = '住宅' THEN B.ACTUAL_BLD_AREA ELSE 0 END), 0)) AS ZZ竣备面积_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME = '住宅' AND B.SALE_STATE = '签约' AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0 THEN B.TRADE_TOTAL WHEN B.PRODUCT_NAME = '住宅' AND B.SALE_STATE <> '签约' AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0 THEN B.BZ_TOTAL ELSE 0 END), 0)) AS ZZ竣备货值_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME = '住宅' AND B.IS_INDIRECT = 1 THEN B.TRADE_TOTAL ELSE 0 END), 0)) AS ZZ结转货值_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME = '住宅' AND B.IS_INDIRECT = 1 THEN B.ACTUAL_BLD_AREA ELSE 0 END), 0)) AS ZZ结转货量_房间合计 ,
         --商业
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' AND B.PRODUCT_NAME = '商办' THEN ROUND(B.BZ_PRICE * NVL(B.NEW_BLD_AREA, 0), 2) ELSE 0 END), 0)) AS SY库存货值_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' AND B.PRODUCT_NAME = '商办' THEN NVL(B.TRADE_TOTAL, 0) ELSE 0 END), 0)) AS SY已售货值_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' AND B.PRODUCT_NAME = '商办' THEN NVL(B.NEW_BLD_AREA, 0) ELSE 0 END), 0)) AS SY库存面积_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' AND B.PRODUCT_NAME = '商办' THEN NVL(B.NEW_BLD_AREA, 0) ELSE 0 END), 0)) AS SY已售面积_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' AND B.PRODUCT_NAME = '商办' THEN 1 ELSE 0 END), 0)) AS SY库存套数_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' AND B.PRODUCT_NAME = '商办' THEN 1 ELSE 0 END), 0)) AS SY已售套数_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME = '商办' THEN B.ACTUAL_BLD_AREA ELSE 0 END), 0)) AS SY竣备面积_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME = '商办' AND B.SALE_STATE = '签约' AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0 THEN B.TRADE_TOTAL WHEN B.PRODUCT_NAME = '商办' AND B.SALE_STATE <> '签约' AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0 THEN B.BZ_TOTAL ELSE 0 END), 0)) AS SY竣备货值_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME = '商办' AND B.IS_INDIRECT = 1 THEN B.TRADE_TOTAL ELSE 0 END), 0)) AS SY结转货值_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME = '商办' AND B.IS_INDIRECT = 1 THEN B.ACTUAL_BLD_AREA ELSE 0 END), 0)) AS SY结转货量_房间合计 ,
         --住宅、商业
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' AND B.PRODUCT_NAME IN ('住宅', '商办') THEN ROUND(B.BZ_PRICE * NVL(B.NEW_BLD_AREA, 0), 2) ELSE 0 END), 0)) AS ZS库存货值_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' AND B.PRODUCT_NAME IN ('住宅', '商办') THEN NVL(B.TRADE_TOTAL, 0) ELSE 0 END), 0)) AS ZS已售货值_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' AND B.PRODUCT_NAME IN ('住宅', '商办') THEN NVL(B.NEW_BLD_AREA, 0) ELSE 0 END), 0)) AS ZS库存面积_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' AND B.PRODUCT_NAME IN ('住宅', '商办') THEN NVL(B.NEW_BLD_AREA, 0) ELSE 0 END), 0)) AS ZS已售面积_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' AND B.PRODUCT_NAME IN ('住宅', '商办') THEN 1 ELSE 0 END), 0)) AS ZS库存套数_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' AND B.PRODUCT_NAME IN ('住宅', '商办') THEN 1 ELSE 0 END), 0)) AS ZS已售套数_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME IN ('住宅', '商办') THEN B.ACTUAL_BLD_AREA ELSE 0 END), 0)) AS ZS竣备面积_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME IN ('住宅', '商办') AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0 AND B.SALE_STATE = '签约' THEN B.TRADE_TOTAL WHEN B.PRODUCT_NAME IN ('住宅', '商办') AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0 AND B.SALE_STATE <> '签约' THEN B.BZ_TOTAL ELSE 0 END), 0)) AS ZS竣备货值_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME IN ('住宅', '商办') AND B.IS_INDIRECT = 1 THEN B.TRADE_TOTAL ELSE 0 END), 0)) AS ZS结转货值_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME IN ('住宅', '商办') AND B.IS_INDIRECT = 1 THEN B.ACTUAL_BLD_AREA ELSE 0 END), 0)) AS ZS结转货量_房间合计 ,
         --车位
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' AND B.PRODUCT_NAME = '车位' THEN ROUND(B.BZ_PRICE * NVL(B.NEW_BLD_AREA, 0), 2) ELSE 0 END), 0)) AS CW库存货值_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' AND B.PRODUCT_NAME = '车位' THEN NVL(B.TRADE_TOTAL, 0) ELSE 0 END), 0)) AS CW已售货值_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' AND B.PRODUCT_NAME = '车位' THEN NVL(B.NEW_BLD_AREA, 0) ELSE 0 END), 0)) AS CW库存面积_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' AND B.PRODUCT_NAME = '车位' THEN NVL(B.NEW_BLD_AREA, 0) ELSE 0 END), 0)) AS CW已售面积_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' AND B.PRODUCT_NAME = '车位' THEN 1 ELSE 0 END), 0)) AS CW库存套数_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' AND B.PRODUCT_NAME = '车位' THEN 1 ELSE 0 END), 0)) AS CW已售套数_房间合计,
         SUM(CASE WHEN B.PRODUCT_NAME = '车位' AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0 THEN 1 ELSE 0 END) AS CW已竣备套数_房间合计,
         SUM(CASE WHEN B.PRODUCT_NAME = '车位' AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0 AND B.SALE_STATE = '签约' THEN B.TRADE_TOTAL WHEN B.PRODUCT_NAME = '车位' AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0 AND B.SALE_STATE <> '签约' THEN B.BZ_TOTAL ELSE 0 END) AS CW已竣备货值_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME = '车位' AND B.IS_INDIRECT = 1 THEN B.TRADE_TOTAL ELSE 0 END), 0)) AS CW结转货值_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME = '车位' AND B.IS_INDIRECT = 1 THEN B.ACTUAL_BLD_AREA ELSE 0 END), 0)) AS CW结转货量_房间合计
  FROM   MDM_ROOM B
  WHERE B.BUILDING_ID = V_BLD_ID
  GROUP  BY B.PROJECT_NAME, B.PROJECT_ID, B.BUILDING_ID;
    ITEM_ROOM_ACCOUNT_LIST CUR_ROOM_ACCOUNT_LIST%ROWTYPE;

    CURSOR CUR_OBJ_INDEX_LIST(V_OBJ_ID VARCHAR2) IS --取楼栋“最新阶段”主数据下业态数据
        SELECT C.*
        FROM   MDM_BUILD A
        INNER  JOIN MDM_BUILD_PHASE B
        ON     A.ID = B.BUILD_ID AND B.PHASE_ORDER = (SELECT MAX(P.PHASE_ORDER) FROM MDM_BUILD_PHASE P WHERE P.BUILD_ID = B.BUILD_ID AND P.PHASE_STATE >= 19)
        INNER  JOIN MDM_OBJ_PHASE_PT_INDEX C
        ON     B.ID = C.OBJ_PHASE_ID
        WHERE  A.ID = V_OBJ_ID;
    ITEM_OBJ_INDEX_LIST CUR_OBJ_INDEX_LIST%ROWTYPE;

    CURSOR CUR_PERIOD_LIST IS --取当前主数据在“全盘阶段”的分期
        SELECT B.PROJECT_ID, A.ID AS PERIOD_ID, A.PERIOD_NAME, D.*
        FROM   MDM_PERIOD A
        INNER  JOIN MDM_PERIOD_VERSION B
        ON     A.PERIOD_VERSION_ID = B.ID
        INNER  JOIN MDM_PERIOD_PHASE C
        ON     A.ID = C.PERIOD_ID AND c.PHASE_ORDER = (SELECT MAX(p.PHASE_ORDER) FROM MDM_PERIOD_PHASE p WHERE p.PERIOD_ID = c.PERIOD_ID AND p.PHASE_STATE >= 19 GROUP BY p.PERIOD_ID HAVING MAX(p.PHASE_ORDER) = 2)
        INNER  JOIN MDM_OBJ_PHASE_PT_INDEX D
        ON     C.ID = D.OBJ_PHASE_ID
        ;
    ITEM_PERIOD_LIST CUR_PERIOD_LIST%ROWTYPE;

    CURSOR CUR_PROJECT_LIST IS --取当前主数据阶段在可研的项目
        SELECT A.ID AS PROJECT_ID, A.PROJECT_NAME, B.PHASE_ID, C.*
        FROM   MDM_PROJECT A
        INNER  JOIN MDM_PROJECT_PHASE B
        ON     A.ID = B.PROJ_ID AND EXISTS  (SELECT O.PROJ_ID,MAX(O.PHASE_ORDER) FROM MDM_PROJECT_PHASE O WHERE O.PROJ_ID = B.PROJ_ID AND O.PHASE_STATE >=19 GROUP BY O.PROJ_ID HAVING MAX(O.PHASE_ORDER) = 1)
        INNER  JOIN MDM_OBJ_PHASE_PT_INDEX C
        ON     B.ID = C.OBJ_PHASE_ID
        --WHERE a.ID = '50af8807-b767-4fc8-b7a1-d7fc1bce9384'
        ;
    ITEM_PROJECT_LIST CUR_PROJECT_LIST%ROWTYPE;


    V_PRODUCT_TYPE VARCHAR2(100); --计算“规证阶段、施工证阶段”动态货值时，存储一级业态

    V_COUNT              NUMBER(10, 2); --计数器
    V_TARGET_WORTH_PHASE NUMBER(10, 0); --最新目标货值版本
    V_WORTH_VERSION      NUMBER(10, 0); --目标货值VERSION
    V_TARGET_WORTH_ID    VARCHAR2(100); --最新目标货值ID
    V_IS_CARPORT         NUMBER(5, 0); --标记业态是否为车位，1：车位；0：非车位
    V_PRICE              NUMBER(20, 2); --业态均价

BEGIN
    /*楼栋级数据初始化为0*/
    UPDATE DWM_DT_VALUE A
    SET    VALUE_DT_ALL = 0, VALUE_REMAIN = 0, VALUE_HAVED_SALE = 0, VALUE_RESERVE = 0, VALUE_IN_PROCESS = 0, VALUE_ALLOW_SALE = 0, VALUE_STOCK = 0, VALUE_NOT_PLANNING_PERMIT = 0,
           VALUE_NOT_CONSTRUCTION_PERMIT = 0, VALUE_NOT_SALE_PERMIT = 0, VALUE_NOT_COMPLETION = 0, VALUE_YES_COMPLETION = 0, VALUE_YES_SETTLEMENT = 0, AREA_DT_ALL = 0, AREA_REMAIN = 0,
           AREA_HAVED_SALE = 0, AREA_RESERVE = 0, AREA_IN_PROCESS = 0, AREA_ALLOW_SALE = 0, AREA_STOCK = 0, AREA_NOT_PLANNING_PERMIT = 0, AREA_NOT_CONSTRUCTION_PERMIT = 0, AREA_NOT_SALE_PERMIT = 0,
           AREA_NOT_COMPLETION = 0, AREA_YES_COMPLETION = 0, AREA_YES_SETTLEMENT = 0, TMP_1KY_VALUE = 0, TMP_1KY_AREA = 0, TMP_1KY_PRICE = 0, TMP_2QP_VALUE = 0, TMP_2QP_AREA = 0, TMP_2QP_PRICE = 0,
           CW_VALUE_DT_ALL = 0, CW_VALUE_REMAIN = 0, CW_VALUE_HAVED_SALE = 0, CW_VALUE_RESERVE = 0, CW_VALUE_IN_PROCESS = 0, CW_VALUE_ALLOW_SALE = 0, CW_VALUE_STOCK = 0,
           CW_VALUE_NOT_PLANNING_PERMIT = 0, CW_VALUE_NOT_CONSTRUCTION_PER = 0, CW_VALUE_NOT_SALE_PERMIT = 0, CW_VALUE_NOT_COMPLETION = 0, CW_VALUE_YES_COMPLETION = 0, CW_VALUE_YES_SETTLEMENT = 0,
           CW_AREA_DT_ALL = 0, CW_AREA_REMAIN = 0, CW_AREA_HAVED_SALE = 0, CW_AREA_RESERVE = 0, CW_AREA_IN_PROCESS = 0, CW_AREA_ALLOW_SALE = 0, CW_AREA_STOCK = 0, CW_AREA_NOT_PLANNING_PERMIT = 0,
           CW_AREA_NOT_CONSTRUCTION_PER = 0, CW_AREA_NOT_SALE_PERMIT = 0, CW_AREA_NOT_COMPLETION = 0, CW_AREA_YES_COMPLETION = 0, CW_AREA_YES_SETTLEMENT = 0, ZZ_VALUE_DT_ALL = 0, ZZ_VALUE_REMAIN = 0,
           ZZ_VALUE_HAVED_SALE = 0, ZZ_VALUE_RESERVE = 0, ZZ_VALUE_IN_PROCESS = 0, ZZ_VALUE_ALLOW_SALE = 0, ZZ_VALUE_STOCK = 0, ZZ_VALUE_NOT_PLANNING_PERMIT = 0, ZZ_VALUE_NOT_CONSTRUCTION_PER = 0,
           ZZ_VALUE_NOT_SALE_PERMIT = 0, ZZ_VALUE_NOT_COMPLETION = 0, ZZ_VALUE_YES_COMPLETION = 0, ZZ_VALUE_YES_SETTLEMENT = 0, ZZ_AREA_DT_ALL = 0, ZZ_AREA_REMAIN = 0, ZZ_AREA_HAVED_SALE = 0,
           ZZ_AREA_RESERVE = 0, ZZ_AREA_IN_PROCESS = 0, ZZ_AREA_ALLOW_SALE = 0, ZZ_AREA_STOCK = 0, ZZ_AREA_NOT_PLANNING_PERMIT = 0, ZZ_AREA_NOT_CONSTRUCTION_PER = 0, ZZ_AREA_NOT_SALE_PERMIT = 0,
           ZZ_AREA_NOT_COMPLETION = 0, ZZ_AREA_YES_COMPLETION = 0, ZZ_AREA_YES_SETTLEMENT = 0, SY_VALUE_DT_ALL = 0, SY_VALUE_REMAIN = 0, SY_VALUE_HAVED_SALE = 0, SY_VALUE_RESERVE = 0,
           SY_VALUE_IN_PROCESS = 0, SY_VALUE_ALLOW_SALE = 0, SY_VALUE_STOCK = 0, SY_VALUE_NOT_PLANNING_PERMIT = 0, SY_VALUE_NOT_CONSTRUCTION_PER = 0, SY_VALUE_NOT_SALE_PERMIT = 0,
           SY_VALUE_NOT_COMPLETION = 0, SY_VALUE_YES_COMPLETION = 0, SY_VALUE_YES_SETTLEMENT = 0, SY_AREA_DT_ALL = 0, SY_AREA_REMAIN = 0, SY_AREA_HAVED_SALE = 0, SY_AREA_RESERVE = 0,
           SY_AREA_IN_PROCESS = 0, SY_AREA_ALLOW_SALE = 0, SY_AREA_STOCK = 0, SY_AREA_NOT_PLANNING_PERMIT = 0, SY_AREA_NOT_CONSTRUCTION_PER = 0, SY_AREA_NOT_SALE_PERMIT = 0, SY_AREA_NOT_COMPLETION = 0,
           SY_AREA_YES_COMPLETION = 0, SY_AREA_YES_SETTLEMENT = 0

 /*   WHERE  A.OBJ_TYPE = '楼栋'*/;

    OPEN CUR_BLD_LIST;
    LOOP
        FETCH CUR_BLD_LIST
            INTO ITEM_BLD_LIST;
        EXIT WHEN CUR_BLD_LIST%NOTFOUND;
        BEGIN
            --判断楼栋当前所处阶段,需考虑现售的情况
            IF ITEM_BLD_LIST.GET_COMPLETED_PERMIT_DATE IS NOT NULL THEN
                V_NEWEST_PHASE := '竣工备案证';
            ELSIF ITEM_BLD_LIST.GET_PRE_SALE_PERMIT_DATE IS NOT NULL THEN
                V_NEWEST_PHASE := '预售许可证';
            ELSIF ITEM_BLD_LIST.GET_CONSTRCUTION_PERMIT_DATE IS NOT NULL THEN
                V_NEWEST_PHASE := '施工许可证';
            ELSIF ITEM_BLD_LIST.GET_CON_PLAN_PERMIT_DATE IS NOT NULL THEN
                V_NEWEST_PHASE := '规划许可证';
            ELSE
                V_NEWEST_PHASE := '未取证';
            END IF;

            UPDATE MDM_BUILD A SET A.NEWEST_VALUE_PHASE = V_NEWEST_PHASE WHERE A.ID = ITEM_BLD_LIST.ID;
            --销售系统已有楼栋，但当前阶段未到“预售许可证”楼栋更新

            SELECT COUNT(1) INTO V_COUNT FROM MDM_BUILD A WHERE NVL(A.NEWEST_VALUE_PHASE,'未取证') IN ('未取证','规划许可证','施工许可证') AND EXISTS (SELECT 1 FROM MDM_ROOM P WHERE P.BUILDING_ID = A.ID) AND A.ID = ITEM_BLD_LIST.ID /*AND A.IS_EXISTING_HOME = 1 AND A.IS_PUSH_OUT = 1*/;
            IF V_COUNT <> 0 THEN
            UPDATE MDM_BUILD A SET A.NEWEST_VALUE_PHASE='预售许可证' WHERE NVL(A.NEWEST_VALUE_PHASE,'未取证') IN ('未取证','规划许可证','施工许可证') AND EXISTS (SELECT 1 FROM MDM_ROOM P WHERE P.BUILDING_ID = A.ID) AND A.ID = ITEM_BLD_LIST.ID;
            V_NEWEST_PHASE := '预售许可证';
            END IF;


            SELECT COUNT(1) INTO V_COUNT FROM MDM_BUILD A WHERE NVL(A.NEWEST_VALUE_PHASE,'未取证') IN ('未取证','规划许可证','施工许可证') AND EXISTS (SELECT 1 FROM MDM_ROOM P WHERE P.BUILDING_ID = A.ID) AND A.ID = ITEM_BLD_LIST.ID AND A.IS_PUSH_OUT = 0;
            IF V_COUNT <> 0 THEN
            UPDATE MDM_BUILD A SET A.NEWEST_VALUE_PHASE='预售许可证' WHERE NVL(A.NEWEST_VALUE_PHASE,'未取证') IN ('未取证','规划许可证','施工许可证') AND EXISTS (SELECT 1 FROM MDM_ROOM P WHERE P.BUILDING_ID = A.ID) AND A.ID = ITEM_BLD_LIST.ID;
            V_NEWEST_PHASE := '预售许可证';
            END IF;

            --DWM_DT_VALUE表楼栋数据处理

            /*
            ===========处理楼栋为竣工备案证阶段数据
            */
            IF V_NEWEST_PHASE = '竣工备案证' THEN

                --更新所有货值
                BEGIN
                    OPEN CUR_ROOM_ACCOUNT_LIST(ITEM_BLD_LIST.ID);
                    LOOP
                        FETCH CUR_ROOM_ACCOUNT_LIST
                            INTO ITEM_ROOM_ACCOUNT_LIST;
                        EXIT WHEN CUR_ROOM_ACCOUNT_LIST%NOTFOUND;
                        UPDATE DWM_DT_VALUE A
                        SET    (A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                                (SELECT ITEM_ROOM_ACCOUNT_LIST.ALL库存及已售总货值, ITEM_ROOM_ACCOUNT_LIST.ALL库存货值_房间合计, ITEM_ROOM_ACCOUNT_LIST.ALL已售货值_房间合计, 0, 0, ITEM_ROOM_ACCOUNT_LIST.ALL库存及已售总货值,
                                        ITEM_ROOM_ACCOUNT_LIST.ALL库存货值_房间合计, 0, 0, 0, 0, ITEM_ROOM_ACCOUNT_LIST.ALL库存及已售总货值, 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                        --更新车位货值
                        UPDATE DWM_DT_VALUE A
                        SET    (A.CW_VALUE_DT_ALL, A.CW_VALUE_REMAIN, A.CW_VALUE_HAVED_SALE, A.CW_VALUE_RESERVE, A.CW_VALUE_IN_PROCESS, A.CW_VALUE_ALLOW_SALE, A.CW_VALUE_STOCK, A.CW_VALUE_NOT_PLANNING_PERMIT, A.CW_VALUE_NOT_CONSTRUCTION_PER, A.CW_VALUE_NOT_SALE_PERMIT, A.CW_VALUE_NOT_COMPLETION, A.CW_VALUE_YES_COMPLETION, A.CW_VALUE_YES_SETTLEMENT) =
                                (SELECT NVL(ITEM_ROOM_ACCOUNT_LIST.CW库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.CW已售货值_房间合计, 0), ITEM_ROOM_ACCOUNT_LIST.CW库存货值_房间合计, ITEM_ROOM_ACCOUNT_LIST.CW已售货值_房间合计, 0,
                                        0, NVL(ITEM_ROOM_ACCOUNT_LIST.CW库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.CW已售货值_房间合计, 0), ITEM_ROOM_ACCOUNT_LIST.CW库存货值_房间合计, 0, 0, 0, 0,
                                        NVL(ITEM_ROOM_ACCOUNT_LIST.CW库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.CW已售货值_房间合计, 0), 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        --更新商业货值
                        UPDATE DWM_DT_VALUE A
                        SET    (A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT) =
                                (SELECT NVL(ITEM_ROOM_ACCOUNT_LIST.SY库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.SY已售货值_房间合计, 0), ITEM_ROOM_ACCOUNT_LIST.SY库存货值_房间合计, ITEM_ROOM_ACCOUNT_LIST.SY已售货值_房间合计, 0,
                                        0, NVL(ITEM_ROOM_ACCOUNT_LIST.SY库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.SY已售货值_房间合计, 0), ITEM_ROOM_ACCOUNT_LIST.SY库存货值_房间合计, 0, 0, 0, 0,
                                        NVL(ITEM_ROOM_ACCOUNT_LIST.SY库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.SY已售货值_房间合计, 0), 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        --更新住宅货值
                        UPDATE DWM_DT_VALUE A
                        SET    (A.ZZ_VALUE_DT_ALL, A.ZZ_VALUE_REMAIN, A.ZZ_VALUE_HAVED_SALE, A.ZZ_VALUE_RESERVE, A.ZZ_VALUE_IN_PROCESS, A.ZZ_VALUE_ALLOW_SALE, A.ZZ_VALUE_STOCK, A.ZZ_VALUE_NOT_PLANNING_PERMIT, A.ZZ_VALUE_NOT_CONSTRUCTION_PER, A.ZZ_VALUE_NOT_SALE_PERMIT, A.ZZ_VALUE_NOT_COMPLETION, A.ZZ_VALUE_YES_COMPLETION, A.ZZ_VALUE_YES_SETTLEMENT) =
                                (SELECT NVL(ITEM_ROOM_ACCOUNT_LIST.ZZ库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.ZZ已售货值_房间合计, 0), ITEM_ROOM_ACCOUNT_LIST.ZZ库存货值_房间合计, ITEM_ROOM_ACCOUNT_LIST.ZZ已售货值_房间合计, 0,
                                        0, NVL(ITEM_ROOM_ACCOUNT_LIST.ZZ库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.ZZ已售货值_房间合计, 0), ITEM_ROOM_ACCOUNT_LIST.ZZ库存货值_房间合计, 0, 0, 0, 0,
                                        NVL(ITEM_ROOM_ACCOUNT_LIST.ZZ库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.ZZ已售货值_房间合计, 0), 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        --更新所有货量
                        UPDATE DWM_DT_VALUE A
                        SET    (A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                                (SELECT ITEM_ROOM_ACCOUNT_LIST.ZS库存面积_房间合计 + ITEM_ROOM_ACCOUNT_LIST.ZS已售面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.ZS库存面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.ZS已售面积_房间合计, 0, 0,
                                        ITEM_ROOM_ACCOUNT_LIST.ZS库存面积_房间合计 + ITEM_ROOM_ACCOUNT_LIST.ZS已售面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.ZS库存面积_房间合计, 0, 0, 0, 0, ITEM_ROOM_ACCOUNT_LIST.ZS竣备面积_房间合计, 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        --更新车位货量
                        UPDATE DWM_DT_VALUE A
                        SET    (A.CW_AREA_DT_ALL, A.CW_AREA_REMAIN, A.CW_AREA_HAVED_SALE, A.CW_AREA_RESERVE, A.CW_AREA_IN_PROCESS, A.CW_AREA_ALLOW_SALE, A.CW_AREA_STOCK, A.CW_AREA_NOT_PLANNING_PERMIT, A.CW_AREA_NOT_CONSTRUCTION_PER, A.CW_AREA_NOT_SALE_PERMIT, A.CW_AREA_NOT_COMPLETION, A.CW_AREA_YES_COMPLETION, A.CW_AREA_YES_SETTLEMENT) =
                                (SELECT ITEM_ROOM_ACCOUNT_LIST.CW已竣备套数_房间合计, ITEM_ROOM_ACCOUNT_LIST.CW库存套数_房间合计, ITEM_ROOM_ACCOUNT_LIST.CW已售套数_房间合计, 0, 0, ITEM_ROOM_ACCOUNT_LIST.CW已竣备套数_房间合计,
                                        ITEM_ROOM_ACCOUNT_LIST.CW库存套数_房间合计, 0, 0, 0, 0, ITEM_ROOM_ACCOUNT_LIST.CW已竣备套数_房间合计, 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        --更新商业货量
                        UPDATE DWM_DT_VALUE A
                        SET    (A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT) =
                                (SELECT ITEM_ROOM_ACCOUNT_LIST.SY竣备面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.SY库存面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.SY已售面积_房间合计, 0, 0, ITEM_ROOM_ACCOUNT_LIST.SY竣备面积_房间合计,
                                        ITEM_ROOM_ACCOUNT_LIST.SY库存面积_房间合计, 0, 0, 0, 0, ITEM_ROOM_ACCOUNT_LIST.SY竣备面积_房间合计, 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        --更新住宅货量
                        UPDATE DWM_DT_VALUE A
                        SET    (A.ZZ_AREA_DT_ALL, A.ZZ_AREA_REMAIN, A.ZZ_AREA_HAVED_SALE, A.ZZ_AREA_RESERVE, A.ZZ_AREA_IN_PROCESS, A.ZZ_AREA_ALLOW_SALE, A.ZZ_AREA_STOCK, A.ZZ_AREA_NOT_PLANNING_PERMIT, A.ZZ_AREA_NOT_CONSTRUCTION_PER, A.ZZ_AREA_NOT_SALE_PERMIT, A.ZZ_AREA_NOT_COMPLETION, A.ZZ_AREA_YES_COMPLETION, A.ZZ_AREA_YES_SETTLEMENT) =
                                (SELECT ITEM_ROOM_ACCOUNT_LIST.ZZ竣备面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.ZZ库存面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.ZZ已售面积_房间合计, 0, 0, ITEM_ROOM_ACCOUNT_LIST.ZZ竣备面积_房间合计,
                                        ITEM_ROOM_ACCOUNT_LIST.ZZ库存面积_房间合计, 0, 0, 0, 0, ITEM_ROOM_ACCOUNT_LIST.ZZ竣备面积_房间合计, 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        /*
                        ==========更新楼栋为预售许可证阶段动态货值数据
                        */
                    END LOOP;
                    CLOSE CUR_ROOM_ACCOUNT_LIST;
                END;
            ELSIF V_NEWEST_PHASE = '预售许可证' THEN
                --更新所有货值
                BEGIN

                    OPEN CUR_ROOM_ACCOUNT_LIST(ITEM_BLD_LIST.ID);
                    LOOP
                        FETCH CUR_ROOM_ACCOUNT_LIST
                            INTO ITEM_ROOM_ACCOUNT_LIST;
                        EXIT WHEN CUR_ROOM_ACCOUNT_LIST%NOTFOUND;
                        UPDATE DWM_DT_VALUE A
                        SET    (A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                                (SELECT ITEM_ROOM_ACCOUNT_LIST.ALL库存及已售总货值, ITEM_ROOM_ACCOUNT_LIST.ALL库存货值_房间合计, ITEM_ROOM_ACCOUNT_LIST.ALL已售货值_房间合计, 0, 0, ITEM_ROOM_ACCOUNT_LIST.ALL库存及已售总货值,
                                        ITEM_ROOM_ACCOUNT_LIST.ALL库存货值_房间合计, 0, 0, 0, ITEM_ROOM_ACCOUNT_LIST.ALL库存及已售总货值, 0, 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        --更新车位货值
                        UPDATE DWM_DT_VALUE A
                        SET    (A.CW_VALUE_DT_ALL, A.CW_VALUE_REMAIN, A.CW_VALUE_HAVED_SALE, A.CW_VALUE_RESERVE, A.CW_VALUE_IN_PROCESS, A.CW_VALUE_ALLOW_SALE, A.CW_VALUE_STOCK, A.CW_VALUE_NOT_PLANNING_PERMIT, A.CW_VALUE_NOT_CONSTRUCTION_PER, A.CW_VALUE_NOT_SALE_PERMIT, A.CW_VALUE_NOT_COMPLETION, A.CW_VALUE_YES_COMPLETION, A.CW_VALUE_YES_SETTLEMENT) =
                                (SELECT NVL(ITEM_ROOM_ACCOUNT_LIST.CW库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.CW已售货值_房间合计, 0), ITEM_ROOM_ACCOUNT_LIST.CW库存货值_房间合计, ITEM_ROOM_ACCOUNT_LIST.CW已售货值_房间合计, 0,
                                        0, NVL(ITEM_ROOM_ACCOUNT_LIST.CW库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.CW已售货值_房间合计, 0), ITEM_ROOM_ACCOUNT_LIST.CW库存货值_房间合计, 0, 0, 0,
                                        NVL(ITEM_ROOM_ACCOUNT_LIST.CW库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.CW已售货值_房间合计, 0), 0, 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        --更新商业货值
                        UPDATE DWM_DT_VALUE A
                        SET    (A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT) =
                                (SELECT NVL(ITEM_ROOM_ACCOUNT_LIST.SY库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.SY已售货值_房间合计, 0), ITEM_ROOM_ACCOUNT_LIST.SY库存货值_房间合计, ITEM_ROOM_ACCOUNT_LIST.SY已售货值_房间合计, 0,
                                        0, NVL(ITEM_ROOM_ACCOUNT_LIST.SY库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.SY已售货值_房间合计, 0), ITEM_ROOM_ACCOUNT_LIST.SY库存货值_房间合计, 0, 0, 0,
                                        NVL(ITEM_ROOM_ACCOUNT_LIST.SY库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.SY已售货值_房间合计, 0), 0, 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        --更新住宅货值
                        UPDATE DWM_DT_VALUE A
                        SET    (A.ZZ_VALUE_DT_ALL, A.ZZ_VALUE_REMAIN, A.ZZ_VALUE_HAVED_SALE, A.ZZ_VALUE_RESERVE, A.ZZ_VALUE_IN_PROCESS, A.ZZ_VALUE_ALLOW_SALE, A.ZZ_VALUE_STOCK, A.ZZ_VALUE_NOT_PLANNING_PERMIT, A.ZZ_VALUE_NOT_CONSTRUCTION_PER, A.ZZ_VALUE_NOT_SALE_PERMIT, A.ZZ_VALUE_NOT_COMPLETION, A.ZZ_VALUE_YES_COMPLETION, A.ZZ_VALUE_YES_SETTLEMENT) =
                                (SELECT NVL(ITEM_ROOM_ACCOUNT_LIST.ZZ库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.ZZ已售货值_房间合计, 0), ITEM_ROOM_ACCOUNT_LIST.ZZ库存货值_房间合计, ITEM_ROOM_ACCOUNT_LIST.ZZ已售货值_房间合计, 0,
                                        0, NVL(ITEM_ROOM_ACCOUNT_LIST.ZZ库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.ZZ已售货值_房间合计, 0), ITEM_ROOM_ACCOUNT_LIST.ZZ库存货值_房间合计, 0, 0, 0,
                                        NVL(ITEM_ROOM_ACCOUNT_LIST.ZZ库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.ZZ已售货值_房间合计, 0), 0, 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        --更新所有货量
                        UPDATE DWM_DT_VALUE A
                        SET    (A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                                (SELECT ITEM_ROOM_ACCOUNT_LIST.ZS库存面积_房间合计 + ITEM_ROOM_ACCOUNT_LIST.ZS已售面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.ZS库存面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.ZS已售面积_房间合计, 0, 0,
                                        ITEM_ROOM_ACCOUNT_LIST.ZS库存面积_房间合计 + ITEM_ROOM_ACCOUNT_LIST.ZS已售面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.ZS库存面积_房间合计, 0, 0, 0,
                                        ITEM_ROOM_ACCOUNT_LIST.ZS库存面积_房间合计 + ITEM_ROOM_ACCOUNT_LIST.ZS已售面积_房间合计, 0, 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        --更新车位货量
                        UPDATE DWM_DT_VALUE A
                        SET    (A.CW_AREA_DT_ALL, A.CW_AREA_REMAIN, A.CW_AREA_HAVED_SALE, A.CW_AREA_RESERVE, A.CW_AREA_IN_PROCESS, A.CW_AREA_ALLOW_SALE, A.CW_AREA_STOCK, A.CW_AREA_NOT_PLANNING_PERMIT, A.CW_AREA_NOT_CONSTRUCTION_PER, A.CW_AREA_NOT_SALE_PERMIT, A.CW_AREA_NOT_COMPLETION, A.CW_AREA_YES_COMPLETION, A.CW_AREA_YES_SETTLEMENT) =
                                (SELECT ITEM_ROOM_ACCOUNT_LIST.CW库存套数_房间合计 + ITEM_ROOM_ACCOUNT_LIST.CW已售套数_房间合计, ITEM_ROOM_ACCOUNT_LIST.CW库存套数_房间合计, ITEM_ROOM_ACCOUNT_LIST.CW已售套数_房间合计, 0, 0,
                                        ITEM_ROOM_ACCOUNT_LIST.CW库存套数_房间合计 + ITEM_ROOM_ACCOUNT_LIST.CW已售套数_房间合计, ITEM_ROOM_ACCOUNT_LIST.CW库存套数_房间合计, 0, 0, 0,
                                        ITEM_ROOM_ACCOUNT_LIST.CW库存套数_房间合计 + ITEM_ROOM_ACCOUNT_LIST.CW已售套数_房间合计, 0, 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        --更新商业货量
                        UPDATE DWM_DT_VALUE A
                        SET    (A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT) =
                                (SELECT ITEM_ROOM_ACCOUNT_LIST.SY库存面积_房间合计 + ITEM_ROOM_ACCOUNT_LIST.SY已售面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.SY库存面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.SY已售面积_房间合计, 0, 0,
                                        ITEM_ROOM_ACCOUNT_LIST.SY库存面积_房间合计 + ITEM_ROOM_ACCOUNT_LIST.SY已售面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.SY库存面积_房间合计, 0, 0, 0,
                                        ITEM_ROOM_ACCOUNT_LIST.SY库存面积_房间合计 + ITEM_ROOM_ACCOUNT_LIST.SY已售面积_房间合计, 0, 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        --更新住宅货量
                        UPDATE DWM_DT_VALUE A
                        SET    (A.ZZ_AREA_DT_ALL, A.ZZ_AREA_REMAIN, A.ZZ_AREA_HAVED_SALE, A.ZZ_AREA_RESERVE, A.ZZ_AREA_IN_PROCESS, A.ZZ_AREA_ALLOW_SALE, A.ZZ_AREA_STOCK, A.ZZ_AREA_NOT_PLANNING_PERMIT, A.ZZ_AREA_NOT_CONSTRUCTION_PER, A.ZZ_AREA_NOT_SALE_PERMIT, A.ZZ_AREA_NOT_COMPLETION, A.ZZ_AREA_YES_COMPLETION, A.ZZ_AREA_YES_SETTLEMENT) =
                                (SELECT ITEM_ROOM_ACCOUNT_LIST.ZZ库存面积_房间合计 + ITEM_ROOM_ACCOUNT_LIST.ZZ已售面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.ZZ库存面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.ZZ已售面积_房间合计, 0, 0,
                                        ITEM_ROOM_ACCOUNT_LIST.ZZ库存面积_房间合计 + ITEM_ROOM_ACCOUNT_LIST.ZZ已售面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.ZZ库存面积_房间合计, 0, 0, 0,
                                        ITEM_ROOM_ACCOUNT_LIST.ZZ库存面积_房间合计 + ITEM_ROOM_ACCOUNT_LIST.ZZ已售面积_房间合计, 0, 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                    END LOOP;
                    CLOSE CUR_ROOM_ACCOUNT_LIST;
                END;
                /*
                ===========更新楼栋在施工证阶段货值数据
                */
            ELSIF V_NEWEST_PHASE = '施工许可证' THEN
                BEGIN

                    OPEN CUR_OBJ_INDEX_LIST(ITEM_BLD_LIST.ID);
                    LOOP
                        --开始循环，取楼栋下业态数据
                        FETCH CUR_OBJ_INDEX_LIST
                            INTO ITEM_OBJ_INDEX_LIST;
                        EXIT WHEN CUR_OBJ_INDEX_LIST%NOTFOUND;

                        V_PRODUCT_TYPE := SUBSTR(ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_NAME, 0, INSTR(ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_NAME, '/', 1) - 1); --取一级业态
                        V_IS_CARPORT := CASE
                                            WHEN ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_JSON = '{"isCarport":1}' THEN
                                             1
                                            ELSE
                                             0
                                        END; -- 取当前业态是否为车位，1：车位；0：非车位

                        --取最新的业态均价，取值原则：动态版→全盘版→可研版


                        SELECT COUNT(1) INTO V_COUNT FROM DWM_DT_VALUE A WHERE A.TARGET_A_ID IS NOT NULL AND A.OBJ_ID = ITEM_BLD_LIST.ID;

                        IF V_COUNT = 0 THEN
                            --无目标货值
                            V_PRICE := 0;
                        ELSE
                            SELECT COUNT(1) INTO V_COUNT FROM DWM_DT_VALUE A WHERE A.OBJ_ID = ITEM_BLD_LIST.ID AND A.OBJ_TYPE = '楼栋';
                            SELECT A.TARGET_A_ID INTO V_TARGET_WORTH_ID FROM DWM_DT_VALUE A WHERE A.OBJ_ID = ITEM_BLD_LIST.ID AND A.OBJ_TYPE = '楼栋';


                            SELECT A.TARGET_WORTH_PHASE INTO V_TARGET_WORTH_PHASE FROM DWM_TARGET_WORTH A WHERE A.ID = V_TARGET_WORTH_ID;

                            IF V_TARGET_WORTH_PHASE = 0 THEN

                                SELECT COUNT(1) INTO V_COUNT FROM DWM_TARGET_WORTH_DTL A WHERE A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;

                                IF V_COUNT = 1 THEN
                                    SELECT NVL(A.AVERAGE_PRICE, 0)
                                    INTO   V_PRICE
                                    FROM   DWM_TARGET_WORTH_DTL A
                                    WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;
                                ELSE
                                    V_PRICE := 0;
                                END IF;

                            ELSIF V_TARGET_WORTH_PHASE = 10 THEN
                                SELECT COUNT(1)
                                INTO   V_COUNT
                                FROM   DWM_TARGET_WORTH_DTL A
                                WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_PARENT_ID = ITEM_BLD_LIST.PERIOD_ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;

                                IF V_COUNT = 1 THEN
                                    SELECT NVL(A.AVERAGE_PRICE, 0)
                                    INTO   V_PRICE
                                    FROM   DWM_TARGET_WORTH_DTL A
                                    WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_PARENT_ID = ITEM_BLD_LIST.PERIOD_ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;
                                ELSE
                                    V_PRICE := 0;
                                END IF;

                            ELSE
                                SELECT COUNT(1)
                                INTO   V_COUNT
                                FROM   DWM_TARGET_WORTH_DTL A
                                WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_PARENT_ID = ITEM_BLD_LIST.ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;

                                IF V_COUNT = 1 THEN
                                    SELECT NVL(A.AVERAGE_PRICE, 0)
                                    INTO   V_PRICE
                                    FROM   DWM_TARGET_WORTH_DTL A
                                    WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_PARENT_ID = ITEM_BLD_LIST.ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;
                                ELSE
                                    V_PRICE := 0;

                                END IF;
                            END IF;

                        END IF;

                        --更新车位动态货值、货量
                        IF V_PRODUCT_TYPE = '车位仓储' AND V_IS_CARPORT = 1 THEN
                            --车位动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.CW_VALUE_DT_ALL, A.CW_VALUE_REMAIN, A.CW_VALUE_HAVED_SALE, A.CW_VALUE_RESERVE, A.CW_VALUE_IN_PROCESS, A.CW_VALUE_ALLOW_SALE, A.CW_VALUE_STOCK, A.CW_VALUE_NOT_PLANNING_PERMIT, A.CW_VALUE_NOT_CONSTRUCTION_PER, A.CW_VALUE_NOT_SALE_PERMIT, A.CW_VALUE_NOT_COMPLETION, A.CW_VALUE_YES_COMPLETION, A.CW_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.CW_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT * V_PRICE, 0),
                                            NVL(A.CW_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT * V_PRICE, 0), NVL(A.CW_VALUE_HAVED_SALE, 0) + 0,
                                            NVL(A.CW_VALUE_RESERVE, 0) + 0, NVL(A.CW_VALUE_IN_PROCESS, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT * V_PRICE, 0),
                                            NVL(A.CW_VALUE_ALLOW_SALE, 0) + 0, NVL(A.CW_VALUE_STOCK, 0) + 0, NVL(A.CW_VALUE_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.CW_VALUE_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.CW_VALUE_NOT_SALE_PERMIT, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT * V_PRICE, 0), NVL(A.CW_VALUE_NOT_COMPLETION, 0) + 0,
                                            NVL(A.CW_VALUE_YES_COMPLETION, 0) + 0, NVL(A.CW_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --车位动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.CW_AREA_DT_ALL, A.CW_AREA_REMAIN, A.CW_AREA_HAVED_SALE, A.CW_AREA_RESERVE, A.CW_AREA_IN_PROCESS, A.CW_AREA_ALLOW_SALE, A.CW_AREA_STOCK, A.CW_AREA_NOT_PLANNING_PERMIT, A.CW_AREA_NOT_CONSTRUCTION_PER, A.CW_AREA_NOT_SALE_PERMIT, A.CW_AREA_NOT_COMPLETION, A.CW_AREA_YES_COMPLETION, A.CW_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.CW_AREA_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                                            NVL(A.CW_AREA_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_HAVED_SALE, 0) + 0, NVL(A.CW_AREA_RESERVE, 0) + 0,
                                            NVL(A.CW_AREA_IN_PROCESS, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_ALLOW_SALE, 0) + 0, NVL(A.CW_AREA_STOCK, 0) + 0,
                                            NVL(A.CW_AREA_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.CW_AREA_NOT_CONSTRUCTION_PER, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                                            NVL(A.CW_AREA_NOT_SALE_PERMIT, 0) + 0, NVL(A.CW_AREA_NOT_COMPLETION, 0) + 0, NVL(A.CW_AREA_YES_COMPLETION, 0) + 0, NVL(A.CW_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --更新仓储部分动态货量、动态货值
                        ELSIF V_PRODUCT_TYPE = '车位仓储' AND V_IS_CARPORT = 0 THEN
                            --商业动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_HAVED_SALE, 0) + 0, NVL(A.SY_VALUE_RESERVE, 0) + 0,
                                            NVL(A.SY_VALUE_IN_PROCESS, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0) + 0, NVL(A.SY_VALUE_STOCK, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_NOT_COMPLETION, 0) + 0,
                                            NVL(A.SY_VALUE_YES_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --商业动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.ZZ_AREA_DT_ALL, A.ZZ_AREA_REMAIN, A.ZZ_AREA_HAVED_SALE, A.ZZ_AREA_RESERVE, A.ZZ_AREA_IN_PROCESS, A.ZZ_AREA_ALLOW_SALE, A.ZZ_AREA_STOCK, A.ZZ_AREA_NOT_PLANNING_PERMIT, A.ZZ_AREA_NOT_CONSTRUCTION_PER, A.ZZ_AREA_NOT_SALE_PERMIT, A.ZZ_AREA_NOT_COMPLETION, A.ZZ_AREA_YES_COMPLETION, A.ZZ_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.ZZ_AREA_DT_ALL, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.ZZ_AREA_REMAIN, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.ZZ_AREA_HAVED_SALE, 0) + 0, NVL(A.ZZ_AREA_RESERVE, 0) + 0, NVL(A.ZZ_AREA_IN_PROCESS, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.ZZ_AREA_ALLOW_SALE, 0) + 0, NVL(A.ZZ_AREA_STOCK, 0) + 0, NVL(A.ZZ_AREA_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.ZZ_AREA_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.ZZ_AREA_NOT_SALE_PERMIT, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.ZZ_AREA_NOT_COMPLETION, 0) + 0, NVL(A.ZZ_AREA_YES_COMPLETION, 0) + 0,
                                            NVL(A.ZZ_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                        ELSIF V_PRODUCT_TYPE = '住宅' THEN
                            --住宅动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.ZZ_VALUE_DT_ALL, A.ZZ_VALUE_REMAIN, A.ZZ_VALUE_HAVED_SALE, A.ZZ_VALUE_RESERVE, A.ZZ_VALUE_IN_PROCESS, A.ZZ_VALUE_ALLOW_SALE, A.ZZ_VALUE_STOCK, A.ZZ_VALUE_NOT_PLANNING_PERMIT, A.ZZ_VALUE_NOT_CONSTRUCTION_PER, A.ZZ_VALUE_NOT_SALE_PERMIT, A.ZZ_VALUE_NOT_COMPLETION, A.ZZ_VALUE_YES_COMPLETION, A.ZZ_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.ZZ_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.ZZ_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.ZZ_VALUE_HAVED_SALE, 0) + 0, NVL(A.ZZ_VALUE_RESERVE, 0) + 0,
                                            NVL(A.ZZ_VALUE_IN_PROCESS, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.ZZ_VALUE_ALLOW_SALE, 0) + 0, NVL(A.ZZ_VALUE_STOCK, 0) + 0,
                                            NVL(A.ZZ_VALUE_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.ZZ_VALUE_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.ZZ_VALUE_NOT_SALE_PERMIT, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.ZZ_VALUE_NOT_COMPLETION, 0) + 0,
                                            NVL(A.ZZ_VALUE_YES_COMPLETION, 0) + 0, NVL(A.ZZ_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --住宅动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.ZZ_AREA_DT_ALL, A.ZZ_AREA_REMAIN, A.ZZ_AREA_HAVED_SALE, A.ZZ_AREA_RESERVE, A.ZZ_AREA_IN_PROCESS, A.ZZ_AREA_ALLOW_SALE, A.ZZ_AREA_STOCK, A.ZZ_AREA_NOT_PLANNING_PERMIT, A.ZZ_AREA_NOT_CONSTRUCTION_PER, A.ZZ_AREA_NOT_SALE_PERMIT, A.ZZ_AREA_NOT_COMPLETION, A.ZZ_AREA_YES_COMPLETION, A.ZZ_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.ZZ_AREA_DT_ALL, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.ZZ_AREA_REMAIN, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.ZZ_AREA_HAVED_SALE, 0) + 0, NVL(A.ZZ_AREA_RESERVE, 0) + 0, NVL(A.ZZ_AREA_IN_PROCESS, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.ZZ_AREA_ALLOW_SALE, 0) + 0, NVL(A.ZZ_AREA_STOCK, 0) + 0, NVL(A.ZZ_AREA_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.ZZ_AREA_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.ZZ_AREA_NOT_SALE_PERMIT, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.ZZ_AREA_NOT_COMPLETION, 0) + 0, NVL(A.ZZ_AREA_YES_COMPLETION, 0) + 0,
                                            NVL(A.ZZ_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                        ELSIF V_PRODUCT_TYPE = '商办产业' THEN
                            --商业动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_HAVED_SALE, 0) + 0, NVL(A.SY_VALUE_RESERVE, 0) + 0,
                                            NVL(A.SY_VALUE_IN_PROCESS, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0) + 0, NVL(A.SY_VALUE_STOCK, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_NOT_COMPLETION, 0) + 0,
                                            NVL(A.SY_VALUE_YES_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --商业动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.ZZ_AREA_DT_ALL, A.ZZ_AREA_REMAIN, A.ZZ_AREA_HAVED_SALE, A.ZZ_AREA_RESERVE, A.ZZ_AREA_IN_PROCESS, A.ZZ_AREA_ALLOW_SALE, A.ZZ_AREA_STOCK, A.ZZ_AREA_NOT_PLANNING_PERMIT, A.ZZ_AREA_NOT_CONSTRUCTION_PER, A.ZZ_AREA_NOT_SALE_PERMIT, A.ZZ_AREA_NOT_COMPLETION, A.ZZ_AREA_YES_COMPLETION, A.ZZ_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.ZZ_AREA_DT_ALL, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.ZZ_AREA_REMAIN, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.ZZ_AREA_HAVED_SALE, 0) + 0, NVL(A.ZZ_AREA_RESERVE, 0) + 0, NVL(A.ZZ_AREA_IN_PROCESS, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.ZZ_AREA_ALLOW_SALE, 0) + 0, NVL(A.ZZ_AREA_STOCK, 0) + 0, NVL(A.ZZ_AREA_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.ZZ_AREA_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.ZZ_AREA_NOT_SALE_PERMIT, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.ZZ_AREA_NOT_COMPLETION, 0) + 0, NVL(A.ZZ_AREA_YES_COMPLETION, 0) + 0,
                                            NVL(A.ZZ_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                        ELSIF V_PRODUCT_TYPE = '配套设施' THEN
                            --商业动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_HAVED_SALE, 0) + 0, NVL(A.SY_VALUE_RESERVE, 0) + 0,
                                            NVL(A.SY_VALUE_IN_PROCESS, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0) + 0, NVL(A.SY_VALUE_STOCK, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_NOT_COMPLETION, 0) + 0,
                                            NVL(A.SY_VALUE_YES_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --商业动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.ZZ_AREA_DT_ALL, A.ZZ_AREA_REMAIN, A.ZZ_AREA_HAVED_SALE, A.ZZ_AREA_RESERVE, A.ZZ_AREA_IN_PROCESS, A.ZZ_AREA_ALLOW_SALE, A.ZZ_AREA_STOCK, A.ZZ_AREA_NOT_PLANNING_PERMIT, A.ZZ_AREA_NOT_CONSTRUCTION_PER, A.ZZ_AREA_NOT_SALE_PERMIT, A.ZZ_AREA_NOT_COMPLETION, A.ZZ_AREA_YES_COMPLETION, A.ZZ_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.ZZ_AREA_DT_ALL, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.ZZ_AREA_REMAIN, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.ZZ_AREA_HAVED_SALE, 0) + 0, NVL(A.ZZ_AREA_RESERVE, 0) + 0, NVL(A.ZZ_AREA_IN_PROCESS, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.ZZ_AREA_ALLOW_SALE, 0) + 0, NVL(A.ZZ_AREA_STOCK, 0) + 0, NVL(A.ZZ_AREA_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.ZZ_AREA_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.ZZ_AREA_NOT_SALE_PERMIT, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.ZZ_AREA_NOT_COMPLETION, 0) + 0, NVL(A.ZZ_AREA_YES_COMPLETION, 0) + 0,
                                            NVL(A.ZZ_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                        ELSE
                            DBMS_OUTPUT.PUT_LINE('1');

                        END IF;
                    END LOOP;
                    CLOSE CUR_OBJ_INDEX_LIST;

                    UPDATE DWM_DT_VALUE A
                    SET    (A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                            (SELECT NVL(A.CW_VALUE_DT_ALL, 0) + NVL(A.SY_VALUE_DT_ALL, 0) + NVL(A.ZZ_VALUE_DT_ALL, 0), NVL(A.CW_VALUE_REMAIN, 0) + NVL(A.SY_VALUE_REMAIN, 0) + NVL(A.ZZ_VALUE_REMAIN, 0),
                                    NVL(A.CW_VALUE_HAVED_SALE, 0) + NVL(A.SY_VALUE_HAVED_SALE, 0) + NVL(A.ZZ_VALUE_HAVED_SALE, 0),
                                    NVL(A.CW_VALUE_RESERVE, 0) + NVL(A.SY_VALUE_RESERVE, 0) + NVL(A.ZZ_VALUE_RESERVE, 0),
                                    NVL(A.CW_VALUE_IN_PROCESS, 0) + NVL(A.SY_VALUE_IN_PROCESS, 0) + NVL(A.ZZ_VALUE_IN_PROCESS, 0),
                                    NVL(A.CW_VALUE_ALLOW_SALE, 0) + NVL(A.SY_VALUE_ALLOW_SALE, 0) + NVL(A.ZZ_VALUE_ALLOW_SALE, 0),
                                    NVL(A.CW_VALUE_STOCK, 0) + NVL(A.SY_VALUE_STOCK, 0) + NVL(A.ZZ_VALUE_STOCK, 0),
                                    NVL(A.CW_VALUE_NOT_PLANNING_PERMIT, 0) + NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + NVL(A.ZZ_VALUE_NOT_PLANNING_PERMIT, 0),
                                    NVL(A.CW_VALUE_NOT_CONSTRUCTION_PER, 0) + NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0) + NVL(A.ZZ_VALUE_NOT_CONSTRUCTION_PER, 0),
                                    NVL(A.CW_VALUE_NOT_SALE_PERMIT, 0) + NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0) + NVL(A.ZZ_VALUE_NOT_SALE_PERMIT, 0),
                                    NVL(A.CW_VALUE_NOT_COMPLETION, 0) + NVL(A.SY_VALUE_NOT_COMPLETION, 0) + NVL(A.ZZ_VALUE_NOT_COMPLETION, 0),
                                    NVL(A.CW_VALUE_YES_COMPLETION, 0) + NVL(A.SY_VALUE_YES_COMPLETION, 0) + NVL(A.ZZ_VALUE_YES_COMPLETION, 0),
                                    NVL(A.CW_VALUE_YES_SETTLEMENT, 0) + NVL(A.SY_VALUE_YES_SETTLEMENT, 0) + NVL(A.ZZ_VALUE_YES_SETTLEMENT, 0)
                             FROM   DUAL)
                    WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                    UPDATE DWM_DT_VALUE A
                    SET    (A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                            (SELECT NVL(A.CW_AREA_DT_ALL, 0) + NVL(A.SY_AREA_DT_ALL, 0) + NVL(A.ZZ_AREA_DT_ALL, 0), NVL(A.CW_AREA_REMAIN, 0) + NVL(A.SY_AREA_REMAIN, 0) + NVL(A.ZZ_AREA_REMAIN, 0),
                                    NVL(A.CW_AREA_HAVED_SALE, 0) + NVL(A.SY_AREA_HAVED_SALE, 0) + NVL(A.ZZ_AREA_HAVED_SALE, 0),
                                    NVL(A.CW_AREA_RESERVE, 0) + NVL(A.SY_AREA_RESERVE, 0) + NVL(A.ZZ_AREA_RESERVE, 0),
                                    NVL(A.CW_AREA_IN_PROCESS, 0) + NVL(A.SY_AREA_IN_PROCESS, 0) + NVL(A.ZZ_AREA_IN_PROCESS, 0),
                                    NVL(A.CW_AREA_ALLOW_SALE, 0) + NVL(A.SY_AREA_ALLOW_SALE, 0) + NVL(A.ZZ_AREA_ALLOW_SALE, 0),
                                    NVL(A.CW_AREA_STOCK, 0) + NVL(A.SY_AREA_STOCK, 0) + NVL(A.ZZ_AREA_STOCK, 0),
                                    NVL(A.CW_AREA_NOT_PLANNING_PERMIT, 0) + NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + NVL(A.ZZ_AREA_NOT_PLANNING_PERMIT, 0),
                                    NVL(A.CW_AREA_NOT_CONSTRUCTION_PER, 0) + NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0) + NVL(A.ZZ_AREA_NOT_CONSTRUCTION_PER, 0),
                                    NVL(A.CW_AREA_NOT_SALE_PERMIT, 0) + NVL(A.SY_AREA_NOT_SALE_PERMIT, 0) + NVL(A.ZZ_AREA_NOT_SALE_PERMIT, 0),
                                    NVL(A.CW_AREA_NOT_COMPLETION, 0) + NVL(A.SY_AREA_NOT_COMPLETION, 0) + NVL(A.ZZ_AREA_NOT_COMPLETION, 0),
                                    NVL(A.CW_AREA_YES_COMPLETION, 0) + NVL(A.SY_AREA_YES_COMPLETION, 0) + NVL(A.ZZ_AREA_YES_COMPLETION, 0),
                                    NVL(A.CW_AREA_YES_SETTLEMENT, 0) + NVL(A.SY_AREA_YES_SETTLEMENT, 0) + NVL(A.ZZ_AREA_YES_SETTLEMENT, 0)
                             FROM   DUAL)
                    WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                END;
                /*
                ===========更新楼栋在规证阶段货值数据
                */
            ELSIF V_NEWEST_PHASE = '规划许可证' THEN
                BEGIN

                    OPEN CUR_OBJ_INDEX_LIST(ITEM_BLD_LIST.ID);
                    LOOP
                        --开始循环，取楼栋下业态数据
                        FETCH CUR_OBJ_INDEX_LIST
                            INTO ITEM_OBJ_INDEX_LIST;
                        EXIT WHEN CUR_OBJ_INDEX_LIST%NOTFOUND;

                        V_PRODUCT_TYPE := SUBSTR(ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_NAME, 0, INSTR(ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_NAME, '/', 1) - 1); --取一级业态
                        V_IS_CARPORT := CASE
                                            WHEN ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_JSON = '{"isCarport":1}' THEN
                                             1
                                            ELSE
                                             0
                                        END; -- 取当前业态是否为车位，1：车位；0：非车位

                        --取最新的业态均价，取值原则：动态版→全盘版→可研版

                        SELECT COUNT(1) INTO V_COUNT FROM DWM_DT_VALUE A WHERE A.TARGET_A_ID IS NOT NULL AND A.OBJ_ID = ITEM_BLD_LIST.ID;

                        IF V_COUNT = 0 THEN
                            --无目标货值
                            V_PRICE := 0;
                        ELSE
                            SELECT A.TARGET_A_ID INTO V_TARGET_WORTH_ID FROM DWM_DT_VALUE A WHERE A.OBJ_ID = ITEM_BLD_LIST.ID AND A.OBJ_TYPE = '楼栋';


                            SELECT A.TARGET_WORTH_PHASE INTO V_TARGET_WORTH_PHASE FROM DWM_TARGET_WORTH A WHERE A.ID = V_TARGET_WORTH_ID;

                            IF V_TARGET_WORTH_PHASE = 0 THEN

                                SELECT COUNT(1) INTO V_COUNT FROM DWM_TARGET_WORTH_DTL A WHERE A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;

                                IF V_COUNT = 1 THEN
                                    SELECT NVL(A.AVERAGE_PRICE, 0)
                                    INTO   V_PRICE
                                    FROM   DWM_TARGET_WORTH_DTL A
                                    WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;
                                ELSE
                                    V_PRICE := 0;
                                END IF;

                            ELSIF V_TARGET_WORTH_PHASE = 10 THEN
                                SELECT COUNT(1)
                                INTO   V_COUNT
                                FROM   DWM_TARGET_WORTH_DTL A
                                WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_PARENT_ID = ITEM_BLD_LIST.PERIOD_ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;

                                IF V_COUNT = 1 THEN
                                    SELECT NVL(A.AVERAGE_PRICE, 0)
                                    INTO   V_PRICE
                                    FROM   DWM_TARGET_WORTH_DTL A
                                    WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_PARENT_ID = ITEM_BLD_LIST.PERIOD_ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;
                                ELSE
                                    V_PRICE := 0;
                                END IF;

                            ELSE
                                SELECT COUNT(1)
                                INTO   V_COUNT
                                FROM   DWM_TARGET_WORTH_DTL A
                                WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_PARENT_ID = ITEM_BLD_LIST.ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;

                                IF V_COUNT = 1 THEN
                                    SELECT NVL(A.AVERAGE_PRICE, 0)
                                    INTO   V_PRICE
                                    FROM   DWM_TARGET_WORTH_DTL A
                                    WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_PARENT_ID = ITEM_BLD_LIST.ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;
                                ELSE
                                    V_PRICE := 0;
                                END IF;
                            END IF;

                        END IF;


                        --更新车位动态货值、货量
                        IF V_PRODUCT_TYPE = '车位仓储' AND V_IS_CARPORT = 1 THEN
                            --车位动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.CW_VALUE_DT_ALL, A.CW_VALUE_REMAIN, A.CW_VALUE_HAVED_SALE, A.CW_VALUE_RESERVE, A.CW_VALUE_IN_PROCESS, A.CW_VALUE_ALLOW_SALE, A.CW_VALUE_STOCK, A.CW_VALUE_NOT_PLANNING_PERMIT, A.CW_VALUE_NOT_CONSTRUCTION_PER, A.CW_VALUE_NOT_SALE_PERMIT, A.CW_VALUE_NOT_COMPLETION, A.CW_VALUE_YES_COMPLETION, A.CW_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.CW_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT * V_PRICE, 0),
                                            NVL(A.CW_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT * V_PRICE, 0), NVL(A.CW_VALUE_HAVED_SALE, 0) + 0,
                                            NVL(A.CW_VALUE_RESERVE, 0) + 0, NVL(A.CW_VALUE_IN_PROCESS, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT * V_PRICE, 0),
                                            NVL(A.CW_VALUE_ALLOW_SALE, 0) + 0, NVL(A.CW_VALUE_STOCK, 0) + 0, NVL(A.CW_VALUE_NOT_PLANNING_PERMIT, 0) + 0,
                                            NVL(A.CW_VALUE_NOT_CONSTRUCTION_PER, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT * V_PRICE, 0), NVL(A.CW_VALUE_NOT_SALE_PERMIT, 0) + 0,
                                            NVL(A.CW_VALUE_NOT_COMPLETION, 0) + 0, NVL(A.CW_VALUE_YES_COMPLETION, 0) + 0, NVL(A.CW_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --车位动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.CW_AREA_DT_ALL, A.CW_AREA_REMAIN, A.CW_AREA_HAVED_SALE, A.CW_AREA_RESERVE, A.CW_AREA_IN_PROCESS, A.CW_AREA_ALLOW_SALE, A.CW_AREA_STOCK, A.CW_AREA_NOT_PLANNING_PERMIT, A.CW_AREA_NOT_CONSTRUCTION_PER, A.CW_AREA_NOT_SALE_PERMIT, A.CW_AREA_NOT_COMPLETION, A.CW_AREA_YES_COMPLETION, A.CW_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.CW_AREA_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                                            NVL(A.CW_AREA_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_HAVED_SALE, 0) + 0, NVL(A.CW_AREA_RESERVE, 0) + 0,
                                            NVL(A.CW_AREA_IN_PROCESS, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_ALLOW_SALE, 0) + 0, NVL(A.CW_AREA_STOCK, 0) + 0,
                                            NVL(A.CW_AREA_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.CW_AREA_NOT_CONSTRUCTION_PER, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                                            NVL(A.CW_AREA_NOT_SALE_PERMIT, 0) + 0, NVL(A.CW_AREA_NOT_COMPLETION, 0) + 0, NVL(A.CW_AREA_YES_COMPLETION, 0) + 0, NVL(A.CW_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --更新仓储部分动态货量、动态货值
                        ELSIF V_PRODUCT_TYPE = '车位仓储' AND V_IS_CARPORT = 0 THEN
                            --商业动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_HAVED_SALE, 0) + 0, NVL(A.SY_VALUE_RESERVE, 0) + 0,
                                            NVL(A.SY_VALUE_IN_PROCESS, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0) + 0, NVL(A.SY_VALUE_STOCK, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0) + 0, NVL(A.SY_VALUE_NOT_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --商业动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_AREA_DT_ALL, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.SY_AREA_REMAIN, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.SY_AREA_HAVED_SALE, 0) + 0, NVL(A.SY_AREA_RESERVE, 0) + 0, NVL(A.SY_AREA_IN_PROCESS, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.SY_AREA_ALLOW_SALE, 0) + 0, NVL(A.SY_AREA_STOCK, 0) + 0, NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + 0,
                                            NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.SY_AREA_NOT_SALE_PERMIT, 0) + 0, NVL(A.SY_AREA_NOT_COMPLETION, 0) + 0,
                                            NVL(A.SY_AREA_YES_COMPLETION, 0) + 0, NVL(A.SY_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                        ELSIF V_PRODUCT_TYPE = '住宅' THEN
                            --住宅动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.ZZ_VALUE_DT_ALL, A.ZZ_VALUE_REMAIN, A.ZZ_VALUE_HAVED_SALE, A.ZZ_VALUE_RESERVE, A.ZZ_VALUE_IN_PROCESS, A.ZZ_VALUE_ALLOW_SALE, A.ZZ_VALUE_STOCK, A.ZZ_VALUE_NOT_PLANNING_PERMIT, A.ZZ_VALUE_NOT_CONSTRUCTION_PER, A.ZZ_VALUE_NOT_SALE_PERMIT, A.ZZ_VALUE_NOT_COMPLETION, A.ZZ_VALUE_YES_COMPLETION, A.ZZ_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.ZZ_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.ZZ_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.ZZ_VALUE_HAVED_SALE, 0) + 0, NVL(A.ZZ_VALUE_RESERVE, 0) + 0,
                                            NVL(A.ZZ_VALUE_IN_PROCESS, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.ZZ_VALUE_ALLOW_SALE, 0) + 0, NVL(A.ZZ_VALUE_STOCK, 0) + 0,
                                            NVL(A.ZZ_VALUE_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.ZZ_VALUE_NOT_CONSTRUCTION_PER, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.ZZ_VALUE_NOT_SALE_PERMIT, 0) + 0, NVL(A.ZZ_VALUE_NOT_COMPLETION, 0) + 0, NVL(A.ZZ_VALUE_YES_COMPLETION, 0) + 0, NVL(A.ZZ_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --住宅动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.ZZ_AREA_DT_ALL, A.ZZ_AREA_REMAIN, A.ZZ_AREA_HAVED_SALE, A.ZZ_AREA_RESERVE, A.ZZ_AREA_IN_PROCESS, A.ZZ_AREA_ALLOW_SALE, A.ZZ_AREA_STOCK, A.ZZ_AREA_NOT_PLANNING_PERMIT, A.ZZ_AREA_NOT_CONSTRUCTION_PER, A.ZZ_AREA_NOT_SALE_PERMIT, A.ZZ_AREA_NOT_COMPLETION, A.ZZ_AREA_YES_COMPLETION, A.ZZ_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.ZZ_AREA_DT_ALL, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.ZZ_AREA_REMAIN, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.ZZ_AREA_HAVED_SALE, 0) + 0, NVL(A.ZZ_AREA_RESERVE, 0) + 0, NVL(A.ZZ_AREA_IN_PROCESS, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.ZZ_AREA_ALLOW_SALE, 0) + 0, NVL(A.ZZ_AREA_STOCK, 0) + 0, NVL(A.ZZ_AREA_NOT_PLANNING_PERMIT, 0) + 0,
                                            NVL(A.ZZ_AREA_NOT_CONSTRUCTION_PER, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.ZZ_AREA_NOT_SALE_PERMIT, 0) + 0, NVL(A.ZZ_AREA_NOT_COMPLETION, 0) + 0,
                                            NVL(A.ZZ_AREA_YES_COMPLETION, 0) + 0, NVL(A.ZZ_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                        ELSIF V_PRODUCT_TYPE = '商办产业' THEN
                            --商业动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_HAVED_SALE, 0) + 0, NVL(A.SY_VALUE_RESERVE, 0) + 0,
                                            NVL(A.SY_VALUE_IN_PROCESS, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0) + 0, NVL(A.SY_VALUE_STOCK, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0) + 0, NVL(A.SY_VALUE_NOT_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --商业动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_AREA_DT_ALL, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.SY_AREA_REMAIN, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.SY_AREA_HAVED_SALE, 0) + 0, NVL(A.SY_AREA_RESERVE, 0) + 0, NVL(A.SY_AREA_IN_PROCESS, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.SY_AREA_ALLOW_SALE, 0) + 0, NVL(A.SY_AREA_STOCK, 0) + 0, NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + 0,
                                            NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.SY_AREA_NOT_SALE_PERMIT, 0) + 0, NVL(A.SY_AREA_NOT_COMPLETION, 0) + 0,
                                            NVL(A.SY_AREA_YES_COMPLETION, 0) + 0, NVL(A.SY_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                        ELSIF V_PRODUCT_TYPE = '配套设施' THEN
                            --商业动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_HAVED_SALE, 0) + 0, NVL(A.SY_VALUE_RESERVE, 0) + 0,
                                            NVL(A.SY_VALUE_IN_PROCESS, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0) + 0, NVL(A.SY_VALUE_STOCK, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0) + 0, NVL(A.SY_VALUE_NOT_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --商业动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_AREA_DT_ALL, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.SY_AREA_REMAIN, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.SY_AREA_HAVED_SALE, 0) + 0, NVL(A.SY_AREA_RESERVE, 0) + 0, NVL(A.SY_AREA_IN_PROCESS, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.SY_AREA_ALLOW_SALE, 0) + 0, NVL(A.SY_AREA_STOCK, 0) + 0, NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + 0,
                                            NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.SY_AREA_NOT_SALE_PERMIT, 0) + 0, NVL(A.SY_AREA_NOT_COMPLETION, 0) + 0,
                                            NVL(A.SY_AREA_YES_COMPLETION, 0) + 0, NVL(A.SY_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                        ELSE
                            DBMS_OUTPUT.PUT_LINE('1');
                        END IF;
                    END LOOP;
                    CLOSE CUR_OBJ_INDEX_LIST;


                UPDATE DWM_DT_VALUE A
                SET    (A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                        (SELECT NVL(A.CW_VALUE_DT_ALL, 0) + NVL(A.SY_VALUE_DT_ALL, 0) + NVL(A.ZZ_VALUE_DT_ALL, 0), NVL(A.CW_VALUE_REMAIN, 0) + NVL(A.SY_VALUE_REMAIN, 0) + NVL(A.ZZ_VALUE_REMAIN, 0),
                                NVL(A.CW_VALUE_HAVED_SALE, 0) + NVL(A.SY_VALUE_HAVED_SALE, 0) + NVL(A.ZZ_VALUE_HAVED_SALE, 0),
                                NVL(A.CW_VALUE_RESERVE, 0) + NVL(A.SY_VALUE_RESERVE, 0) + NVL(A.ZZ_VALUE_RESERVE, 0),
                                NVL(A.CW_VALUE_IN_PROCESS, 0) + NVL(A.SY_VALUE_IN_PROCESS, 0) + NVL(A.ZZ_VALUE_IN_PROCESS, 0),
                                NVL(A.CW_VALUE_ALLOW_SALE, 0) + NVL(A.SY_VALUE_ALLOW_SALE, 0) + NVL(A.ZZ_VALUE_ALLOW_SALE, 0),
                                NVL(A.CW_VALUE_STOCK, 0) + NVL(A.SY_VALUE_STOCK, 0) + NVL(A.ZZ_VALUE_STOCK, 0),
                                NVL(A.CW_VALUE_NOT_PLANNING_PERMIT, 0) + NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + NVL(A.ZZ_VALUE_NOT_PLANNING_PERMIT, 0),
                                NVL(A.CW_VALUE_NOT_CONSTRUCTION_PER, 0) + NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0) + NVL(A.ZZ_VALUE_NOT_CONSTRUCTION_PER, 0),
                                NVL(A.CW_VALUE_NOT_SALE_PERMIT, 0) + NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0) + NVL(A.ZZ_VALUE_NOT_SALE_PERMIT, 0),
                                NVL(A.CW_VALUE_NOT_COMPLETION, 0) + NVL(A.SY_VALUE_NOT_COMPLETION, 0) + NVL(A.ZZ_VALUE_NOT_COMPLETION, 0),
                                NVL(A.CW_VALUE_YES_COMPLETION, 0) + NVL(A.SY_VALUE_YES_COMPLETION, 0) + NVL(A.ZZ_VALUE_YES_COMPLETION, 0),
                                NVL(A.CW_VALUE_YES_SETTLEMENT, 0) + NVL(A.SY_VALUE_YES_SETTLEMENT, 0) + NVL(A.ZZ_VALUE_YES_SETTLEMENT, 0)
                         FROM   DUAL)
                WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                UPDATE DWM_DT_VALUE A
                SET    (A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                        (SELECT NVL(A.CW_AREA_DT_ALL, 0) + NVL(A.SY_AREA_DT_ALL, 0) + NVL(A.ZZ_AREA_DT_ALL, 0), NVL(A.CW_AREA_REMAIN, 0) + NVL(A.SY_AREA_REMAIN, 0) + NVL(A.ZZ_AREA_REMAIN, 0),
                                NVL(A.CW_AREA_HAVED_SALE, 0) + NVL(A.SY_AREA_HAVED_SALE, 0) + NVL(A.ZZ_AREA_HAVED_SALE, 0),
                                NVL(A.CW_AREA_RESERVE, 0) + NVL(A.SY_AREA_RESERVE, 0) + NVL(A.ZZ_AREA_RESERVE, 0),
                                NVL(A.CW_AREA_IN_PROCESS, 0) + NVL(A.SY_AREA_IN_PROCESS, 0) + NVL(A.ZZ_AREA_IN_PROCESS, 0),
                                NVL(A.CW_AREA_ALLOW_SALE, 0) + NVL(A.SY_AREA_ALLOW_SALE, 0) + NVL(A.ZZ_AREA_ALLOW_SALE, 0), NVL(A.CW_AREA_STOCK, 0) + NVL(A.SY_AREA_STOCK, 0) + NVL(A.ZZ_AREA_STOCK, 0),
                                NVL(A.CW_AREA_NOT_PLANNING_PERMIT, 0) + NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + NVL(A.ZZ_AREA_NOT_PLANNING_PERMIT, 0),
                                NVL(A.CW_AREA_NOT_CONSTRUCTION_PER, 0) + NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0) + NVL(A.ZZ_AREA_NOT_CONSTRUCTION_PER, 0),
                                NVL(A.CW_AREA_NOT_SALE_PERMIT, 0) + NVL(A.SY_AREA_NOT_SALE_PERMIT, 0) + NVL(A.ZZ_AREA_NOT_SALE_PERMIT, 0),
                                NVL(A.CW_AREA_NOT_COMPLETION, 0) + NVL(A.SY_AREA_NOT_COMPLETION, 0) + NVL(A.ZZ_AREA_NOT_COMPLETION, 0),
                                NVL(A.CW_AREA_YES_COMPLETION, 0) + NVL(A.SY_AREA_YES_COMPLETION, 0) + NVL(A.ZZ_AREA_YES_COMPLETION, 0),
                                NVL(A.CW_AREA_YES_SETTLEMENT, 0) + NVL(A.SY_AREA_YES_SETTLEMENT, 0) + NVL(A.ZZ_AREA_YES_SETTLEMENT, 0)
                         FROM   DUAL)
                WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                END;


           ELSIF V_NEWEST_PHASE = '未取证' THEN
               BEGIN

                    OPEN CUR_OBJ_INDEX_LIST(ITEM_BLD_LIST.ID);
                    LOOP
                        --开始循环，取楼栋下业态数据
                        FETCH CUR_OBJ_INDEX_LIST
                            INTO ITEM_OBJ_INDEX_LIST;
                        EXIT WHEN CUR_OBJ_INDEX_LIST%NOTFOUND;

                        V_PRODUCT_TYPE := SUBSTR(ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_NAME, 0, INSTR(ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_NAME, '/', 1) - 1); --取一级业态
                        V_IS_CARPORT := CASE
                                            WHEN ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_JSON = '{"isCarport":1}' THEN
                                             1
                                            ELSE
                                             0
                                        END; -- 取当前业态是否为车位，1：车位；0：非车位

                        --取最新的业态均价，取值原则：动态版→全盘版→可研版

                        SELECT COUNT(1) INTO V_COUNT FROM DWM_DT_VALUE A WHERE A.TARGET_A_ID IS NOT NULL AND A.OBJ_ID = ITEM_BLD_LIST.ID;

                        IF V_COUNT = 0 THEN
                            --无目标货值
                            V_PRICE := 0;
                        ELSE
                            SELECT A.TARGET_A_ID INTO V_TARGET_WORTH_ID FROM DWM_DT_VALUE A WHERE A.OBJ_ID = ITEM_BLD_LIST.ID AND A.OBJ_TYPE = '楼栋';


                            SELECT A.TARGET_WORTH_PHASE INTO V_TARGET_WORTH_PHASE FROM DWM_TARGET_WORTH A WHERE A.ID = V_TARGET_WORTH_ID;

                            IF V_TARGET_WORTH_PHASE = 0 THEN

                                SELECT COUNT(1) INTO V_COUNT FROM DWM_TARGET_WORTH_DTL A WHERE A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;

                                IF V_COUNT = 1 THEN
                                    SELECT NVL(A.AVERAGE_PRICE, 0)
                                    INTO   V_PRICE
                                    FROM   DWM_TARGET_WORTH_DTL A
                                    WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;
                                ELSE
                                    V_PRICE := 0;
                                END IF;

                            ELSIF V_TARGET_WORTH_PHASE = 10 THEN
                                SELECT COUNT(1)
                                INTO   V_COUNT
                                FROM   DWM_TARGET_WORTH_DTL A
                                WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_PARENT_ID = ITEM_BLD_LIST.PERIOD_ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;

                                IF V_COUNT = 1 THEN
                                    SELECT NVL(A.AVERAGE_PRICE, 0)
                                    INTO   V_PRICE
                                    FROM   DWM_TARGET_WORTH_DTL A
                                    WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_PARENT_ID = ITEM_BLD_LIST.PERIOD_ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;
                                ELSE
                                    V_PRICE := 0;
                                END IF;

                            ELSE
                                SELECT COUNT(1)
                                INTO   V_COUNT
                                FROM   DWM_TARGET_WORTH_DTL A
                                WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_PARENT_ID = ITEM_BLD_LIST.ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;

                                IF V_COUNT = 1 THEN
                                    SELECT NVL(A.AVERAGE_PRICE, 0)
                                    INTO   V_PRICE
                                    FROM   DWM_TARGET_WORTH_DTL A
                                    WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_PARENT_ID = ITEM_BLD_LIST.ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;
                                ELSE
                                    V_PRICE := 0;
                                END IF;
                            END IF;

                        END IF;


                        --更新车位动态货值、货量
                        IF V_PRODUCT_TYPE = '车位仓储' AND V_IS_CARPORT = 1 THEN
                            --车位动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.CW_VALUE_DT_ALL, A.CW_VALUE_REMAIN, A.CW_VALUE_HAVED_SALE, A.CW_VALUE_RESERVE, A.CW_VALUE_IN_PROCESS, A.CW_VALUE_ALLOW_SALE, A.CW_VALUE_STOCK, A.CW_VALUE_NOT_PLANNING_PERMIT, A.CW_VALUE_NOT_CONSTRUCTION_PER, A.CW_VALUE_NOT_SALE_PERMIT, A.CW_VALUE_NOT_COMPLETION, A.CW_VALUE_YES_COMPLETION, A.CW_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.CW_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT * V_PRICE, 0),
                                            NVL(A.CW_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT * V_PRICE, 0), NVL(A.CW_VALUE_HAVED_SALE, 0) + 0,
                                            NVL(A.CW_VALUE_RESERVE, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT * V_PRICE, 0), NVL(A.CW_VALUE_IN_PROCESS, 0) + 0,
                                            NVL(A.CW_VALUE_ALLOW_SALE, 0) + 0, NVL(A.CW_VALUE_STOCK, 0) + 0, NVL(A.CW_VALUE_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT * V_PRICE, 0),
                                            NVL(A.CW_VALUE_NOT_CONSTRUCTION_PER, 0) + 0, NVL(A.CW_VALUE_NOT_SALE_PERMIT, 0) + 0,
                                            NVL(A.CW_VALUE_NOT_COMPLETION, 0) + 0, NVL(A.CW_VALUE_YES_COMPLETION, 0) + 0, NVL(A.CW_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --车位动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.CW_AREA_DT_ALL, A.CW_AREA_REMAIN, A.CW_AREA_HAVED_SALE, A.CW_AREA_RESERVE, A.CW_AREA_IN_PROCESS, A.CW_AREA_ALLOW_SALE, A.CW_AREA_STOCK, A.CW_AREA_NOT_PLANNING_PERMIT, A.CW_AREA_NOT_CONSTRUCTION_PER, A.CW_AREA_NOT_SALE_PERMIT, A.CW_AREA_NOT_COMPLETION, A.CW_AREA_YES_COMPLETION, A.CW_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.CW_AREA_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                                            NVL(A.CW_AREA_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_HAVED_SALE, 0) + 0, NVL(A.CW_AREA_RESERVE, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                                            NVL(A.CW_AREA_IN_PROCESS, 0) + 0, NVL(A.CW_AREA_ALLOW_SALE, 0) + 0, NVL(A.CW_AREA_STOCK, 0) + 0,
                                            NVL(A.CW_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.CW_AREA_NOT_SALE_PERMIT, 0) + 0, NVL(A.CW_AREA_NOT_COMPLETION, 0) + 0, NVL(A.CW_AREA_YES_COMPLETION, 0) + 0, NVL(A.CW_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --更新仓储部分动态货量、动态货值
                        ELSIF V_PRODUCT_TYPE = '车位仓储' AND V_IS_CARPORT = 0 THEN
                            --商业动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_HAVED_SALE, 0) + 0, NVL(A.SY_VALUE_RESERVE, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_IN_PROCESS, 0) + 0, NVL(A.SY_VALUE_ALLOW_SALE, 0) + 0, NVL(A.SY_VALUE_STOCK, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0) + 0, NVL(A.SY_VALUE_NOT_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --商业动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_AREA_DT_ALL, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.SY_AREA_REMAIN, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.SY_AREA_HAVED_SALE, 0) + 0, NVL(A.SY_AREA_RESERVE, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.SY_AREA_IN_PROCESS, 0) + 0,
                                            NVL(A.SY_AREA_ALLOW_SALE, 0) + 0, NVL(A.SY_AREA_STOCK, 0) + 0, NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0) + 0, NVL(A.SY_AREA_NOT_SALE_PERMIT, 0) + 0, NVL(A.SY_AREA_NOT_COMPLETION, 0) + 0,
                                            NVL(A.SY_AREA_YES_COMPLETION, 0) + 0, NVL(A.SY_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                        ELSIF V_PRODUCT_TYPE = '住宅' THEN
                            --住宅动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.ZZ_VALUE_DT_ALL, A.ZZ_VALUE_REMAIN, A.ZZ_VALUE_HAVED_SALE, A.ZZ_VALUE_RESERVE, A.ZZ_VALUE_IN_PROCESS, A.ZZ_VALUE_ALLOW_SALE, A.ZZ_VALUE_STOCK, A.ZZ_VALUE_NOT_PLANNING_PERMIT, A.ZZ_VALUE_NOT_CONSTRUCTION_PER, A.ZZ_VALUE_NOT_SALE_PERMIT, A.ZZ_VALUE_NOT_COMPLETION, A.ZZ_VALUE_YES_COMPLETION, A.ZZ_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.ZZ_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.ZZ_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.ZZ_VALUE_HAVED_SALE, 0) + 0, NVL(A.ZZ_VALUE_RESERVE, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.ZZ_VALUE_IN_PROCESS, 0) + 0, NVL(A.ZZ_VALUE_ALLOW_SALE, 0) + 0, NVL(A.ZZ_VALUE_STOCK, 0) + 0,
                                            NVL(A.ZZ_VALUE_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.ZZ_VALUE_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.ZZ_VALUE_NOT_SALE_PERMIT, 0) + 0, NVL(A.ZZ_VALUE_NOT_COMPLETION, 0) + 0, NVL(A.ZZ_VALUE_YES_COMPLETION, 0) + 0, NVL(A.ZZ_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --住宅动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.ZZ_AREA_DT_ALL, A.ZZ_AREA_REMAIN, A.ZZ_AREA_HAVED_SALE, A.ZZ_AREA_RESERVE, A.ZZ_AREA_IN_PROCESS, A.ZZ_AREA_ALLOW_SALE, A.ZZ_AREA_STOCK, A.ZZ_AREA_NOT_PLANNING_PERMIT, A.ZZ_AREA_NOT_CONSTRUCTION_PER, A.ZZ_AREA_NOT_SALE_PERMIT, A.ZZ_AREA_NOT_COMPLETION, A.ZZ_AREA_YES_COMPLETION, A.ZZ_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.ZZ_AREA_DT_ALL, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.ZZ_AREA_REMAIN, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.ZZ_AREA_HAVED_SALE, 0) + 0, NVL(A.ZZ_AREA_RESERVE, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.ZZ_AREA_IN_PROCESS, 0) + 0,
                                            NVL(A.ZZ_AREA_ALLOW_SALE, 0) + 0, NVL(A.ZZ_AREA_STOCK, 0) + 0, NVL(A.ZZ_AREA_NOT_PLANNING_PERMIT, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.ZZ_AREA_NOT_CONSTRUCTION_PER, 0) + 0, NVL(A.ZZ_AREA_NOT_SALE_PERMIT, 0) + 0, NVL(A.ZZ_AREA_NOT_COMPLETION, 0) + 0,
                                            NVL(A.ZZ_AREA_YES_COMPLETION, 0) + 0, NVL(A.ZZ_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                        ELSIF V_PRODUCT_TYPE = '商办产业' THEN
                            --商业动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_HAVED_SALE, 0) + 0, NVL(A.SY_VALUE_RESERVE, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_IN_PROCESS, 0) + 0, NVL(A.SY_VALUE_ALLOW_SALE, 0) + 0, NVL(A.SY_VALUE_STOCK, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0) + 0, NVL(A.SY_VALUE_NOT_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --商业动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_AREA_DT_ALL, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.SY_AREA_REMAIN, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.SY_AREA_HAVED_SALE, 0) + 0, NVL(A.SY_AREA_RESERVE, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.SY_AREA_IN_PROCESS, 0) + 0,
                                            NVL(A.SY_AREA_ALLOW_SALE, 0) + 0, NVL(A.SY_AREA_STOCK, 0) + 0, NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0) + 0, NVL(A.SY_AREA_NOT_SALE_PERMIT, 0) + 0, NVL(A.SY_AREA_NOT_COMPLETION, 0) + 0,
                                            NVL(A.SY_AREA_YES_COMPLETION, 0) + 0, NVL(A.SY_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                        ELSIF V_PRODUCT_TYPE = '配套设施' THEN
                            --商业动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_HAVED_SALE, 0) + 0, NVL(A.SY_VALUE_RESERVE, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_IN_PROCESS, 0) + 0, NVL(A.SY_VALUE_ALLOW_SALE, 0) + 0, NVL(A.SY_VALUE_STOCK, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0) + 0, NVL(A.SY_VALUE_NOT_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --商业动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_AREA_DT_ALL, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.SY_AREA_REMAIN, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.SY_AREA_HAVED_SALE, 0) + 0, NVL(A.SY_AREA_RESERVE, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.SY_AREA_IN_PROCESS, 0) + 0,
                                            NVL(A.SY_AREA_ALLOW_SALE, 0) + 0, NVL(A.SY_AREA_STOCK, 0) + 0, NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0) + 0, NVL(A.SY_AREA_NOT_SALE_PERMIT, 0) + 0, NVL(A.SY_AREA_NOT_COMPLETION, 0) + 0,
                                            NVL(A.SY_AREA_YES_COMPLETION, 0) + 0, NVL(A.SY_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                        ELSE
                            DBMS_OUTPUT.PUT_LINE('1');
                        END IF;
                    END LOOP;
                CLOSE CUR_OBJ_INDEX_LIST;


                UPDATE DWM_DT_VALUE A
                SET    (A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                        (SELECT NVL(A.CW_VALUE_DT_ALL, 0) + NVL(A.SY_VALUE_DT_ALL, 0) + NVL(A.ZZ_VALUE_DT_ALL, 0), NVL(A.CW_VALUE_REMAIN, 0) + NVL(A.SY_VALUE_REMAIN, 0) + NVL(A.ZZ_VALUE_REMAIN, 0),
                                NVL(A.CW_VALUE_HAVED_SALE, 0) + NVL(A.SY_VALUE_HAVED_SALE, 0) + NVL(A.ZZ_VALUE_HAVED_SALE, 0),
                                NVL(A.CW_VALUE_RESERVE, 0) + NVL(A.SY_VALUE_RESERVE, 0) + NVL(A.ZZ_VALUE_RESERVE, 0),
                                NVL(A.CW_VALUE_IN_PROCESS, 0) + NVL(A.SY_VALUE_IN_PROCESS, 0) + NVL(A.ZZ_VALUE_IN_PROCESS, 0),
                                NVL(A.CW_VALUE_ALLOW_SALE, 0) + NVL(A.SY_VALUE_ALLOW_SALE, 0) + NVL(A.ZZ_VALUE_ALLOW_SALE, 0),
                                NVL(A.CW_VALUE_STOCK, 0) + NVL(A.SY_VALUE_STOCK, 0) + NVL(A.ZZ_VALUE_STOCK, 0),
                                NVL(A.CW_VALUE_NOT_PLANNING_PERMIT, 0) + NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + NVL(A.ZZ_VALUE_NOT_PLANNING_PERMIT, 0),
                                NVL(A.CW_VALUE_NOT_CONSTRUCTION_PER, 0) + NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0) + NVL(A.ZZ_VALUE_NOT_CONSTRUCTION_PER, 0),
                                NVL(A.CW_VALUE_NOT_SALE_PERMIT, 0) + NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0) + NVL(A.ZZ_VALUE_NOT_SALE_PERMIT, 0),
                                NVL(A.CW_VALUE_NOT_COMPLETION, 0) + NVL(A.SY_VALUE_NOT_COMPLETION, 0) + NVL(A.ZZ_VALUE_NOT_COMPLETION, 0),
                                NVL(A.CW_VALUE_YES_COMPLETION, 0) + NVL(A.SY_VALUE_YES_COMPLETION, 0) + NVL(A.ZZ_VALUE_YES_COMPLETION, 0),
                                NVL(A.CW_VALUE_YES_SETTLEMENT, 0) + NVL(A.SY_VALUE_YES_SETTLEMENT, 0) + NVL(A.ZZ_VALUE_YES_SETTLEMENT, 0)
                         FROM   DUAL)
                WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                UPDATE DWM_DT_VALUE A
                SET    (A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                        (SELECT NVL(A.CW_AREA_DT_ALL, 0) + NVL(A.SY_AREA_DT_ALL, 0) + NVL(A.ZZ_AREA_DT_ALL, 0), NVL(A.CW_AREA_REMAIN, 0) + NVL(A.SY_AREA_REMAIN, 0) + NVL(A.ZZ_AREA_REMAIN, 0),
                                NVL(A.CW_AREA_HAVED_SALE, 0) + NVL(A.SY_AREA_HAVED_SALE, 0) + NVL(A.ZZ_AREA_HAVED_SALE, 0),
                                NVL(A.CW_AREA_RESERVE, 0) + NVL(A.SY_AREA_RESERVE, 0) + NVL(A.ZZ_AREA_RESERVE, 0),
                                NVL(A.CW_AREA_IN_PROCESS, 0) + NVL(A.SY_AREA_IN_PROCESS, 0) + NVL(A.ZZ_AREA_IN_PROCESS, 0),
                                NVL(A.CW_AREA_ALLOW_SALE, 0) + NVL(A.SY_AREA_ALLOW_SALE, 0) + NVL(A.ZZ_AREA_ALLOW_SALE, 0), NVL(A.CW_AREA_STOCK, 0) + NVL(A.SY_AREA_STOCK, 0) + NVL(A.ZZ_AREA_STOCK, 0),
                                NVL(A.CW_AREA_NOT_PLANNING_PERMIT, 0) + NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + NVL(A.ZZ_AREA_NOT_PLANNING_PERMIT, 0),
                                NVL(A.CW_AREA_NOT_CONSTRUCTION_PER, 0) + NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0) + NVL(A.ZZ_AREA_NOT_CONSTRUCTION_PER, 0),
                                NVL(A.CW_AREA_NOT_SALE_PERMIT, 0) + NVL(A.SY_AREA_NOT_SALE_PERMIT, 0) + NVL(A.ZZ_AREA_NOT_SALE_PERMIT, 0),
                                NVL(A.CW_AREA_NOT_COMPLETION, 0) + NVL(A.SY_AREA_NOT_COMPLETION, 0) + NVL(A.ZZ_AREA_NOT_COMPLETION, 0),
                                NVL(A.CW_AREA_YES_COMPLETION, 0) + NVL(A.SY_AREA_YES_COMPLETION, 0) + NVL(A.ZZ_AREA_YES_COMPLETION, 0),
                                NVL(A.CW_AREA_YES_SETTLEMENT, 0) + NVL(A.SY_AREA_YES_SETTLEMENT, 0) + NVL(A.ZZ_AREA_YES_SETTLEMENT, 0)
                         FROM   DUAL)
                WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                END;

            ELSE
                NULL;
            END IF;
        END;
    END LOOP;
    CLOSE CUR_BLD_LIST;

    /*
    --项目级动态货值、货量更新
    */
    --项目级动态货值更新
    UPDATE DWM_DT_VALUE B
    SET    (B.VALUE_DT_ALL, B.VALUE_REMAIN, B.VALUE_HAVED_SALE, B.VALUE_RESERVE, B.VALUE_IN_PROCESS, B.VALUE_ALLOW_SALE, B.VALUE_STOCK, B.VALUE_NOT_PLANNING_PERMIT, B.VALUE_NOT_CONSTRUCTION_PERMIT, B.VALUE_NOT_SALE_PERMIT, B.VALUE_NOT_COMPLETION, B.VALUE_YES_COMPLETION, B.VALUE_YES_SETTLEMENT) =
            (SELECT SUM(A.VALUE_DT_ALL), SUM(A.VALUE_REMAIN), SUM(A.VALUE_HAVED_SALE), SUM(A.VALUE_RESERVE), SUM(A.VALUE_IN_PROCESS), SUM(A.VALUE_ALLOW_SALE), SUM(A.VALUE_STOCK),
                    SUM(A.VALUE_NOT_PLANNING_PERMIT), SUM(A.VALUE_NOT_CONSTRUCTION_PERMIT), SUM(A.VALUE_NOT_SALE_PERMIT), SUM(A.VALUE_NOT_COMPLETION), SUM(A.VALUE_YES_COMPLETION),
                    SUM(A.VALUE_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PROJ_ID = B.PROJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  B.OBJ_TYPE = '项目';

    UPDATE DWM_DT_VALUE P
    SET    (P.CW_VALUE_DT_ALL, P.CW_VALUE_REMAIN, P.CW_VALUE_HAVED_SALE, P.CW_VALUE_RESERVE, P.CW_VALUE_IN_PROCESS, P.CW_VALUE_ALLOW_SALE, P.CW_VALUE_STOCK, P.CW_VALUE_NOT_PLANNING_PERMIT, P.CW_VALUE_NOT_CONSTRUCTION_PER, P.CW_VALUE_NOT_SALE_PERMIT, P.CW_VALUE_NOT_COMPLETION, P.CW_VALUE_YES_COMPLETION, P.CW_VALUE_YES_SETTLEMENT) =
            (SELECT SUM(A.CW_VALUE_DT_ALL), SUM(A.CW_VALUE_REMAIN), SUM(A.CW_VALUE_HAVED_SALE), SUM(A.CW_VALUE_RESERVE), SUM(A.CW_VALUE_IN_PROCESS), SUM(A.CW_VALUE_ALLOW_SALE), SUM(A.CW_VALUE_STOCK),
                    SUM(A.CW_VALUE_NOT_PLANNING_PERMIT), SUM(A.CW_VALUE_NOT_CONSTRUCTION_PER), SUM(A.CW_VALUE_NOT_SALE_PERMIT), SUM(A.CW_VALUE_NOT_COMPLETION), SUM(A.CW_VALUE_YES_COMPLETION),
                    SUM(A.CW_VALUE_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PROJ_ID = P.PROJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  P.OBJ_TYPE = '项目';

    UPDATE DWM_DT_VALUE P
    SET    (P.ZZ_VALUE_DT_ALL, P.ZZ_VALUE_REMAIN, P.ZZ_VALUE_HAVED_SALE, P.ZZ_VALUE_RESERVE, P.ZZ_VALUE_IN_PROCESS, P.ZZ_VALUE_ALLOW_SALE, P.ZZ_VALUE_STOCK, P.ZZ_VALUE_NOT_PLANNING_PERMIT, P.ZZ_VALUE_NOT_CONSTRUCTION_PER, P.ZZ_VALUE_NOT_SALE_PERMIT, P.ZZ_VALUE_NOT_COMPLETION, P.ZZ_VALUE_YES_COMPLETION, P.ZZ_VALUE_YES_SETTLEMENT) =
            (SELECT SUM(A.ZZ_VALUE_DT_ALL), SUM(A.ZZ_VALUE_REMAIN), SUM(A.ZZ_VALUE_HAVED_SALE), SUM(A.ZZ_VALUE_RESERVE), SUM(A.ZZ_VALUE_IN_PROCESS), SUM(A.ZZ_VALUE_ALLOW_SALE), SUM(A.ZZ_VALUE_STOCK),
                    SUM(A.ZZ_VALUE_NOT_PLANNING_PERMIT), SUM(A.ZZ_VALUE_NOT_CONSTRUCTION_PER), SUM(A.ZZ_VALUE_NOT_SALE_PERMIT), SUM(A.ZZ_VALUE_NOT_COMPLETION), SUM(A.ZZ_VALUE_YES_COMPLETION),
                    SUM(A.ZZ_VALUE_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PROJ_ID = P.PROJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  P.OBJ_TYPE = '项目';

    UPDATE DWM_DT_VALUE P
    SET    (P.SY_VALUE_DT_ALL, P.SY_VALUE_REMAIN, P.SY_VALUE_HAVED_SALE, P.SY_VALUE_RESERVE, P.SY_VALUE_IN_PROCESS, P.SY_VALUE_ALLOW_SALE, P.SY_VALUE_STOCK, P.SY_VALUE_NOT_PLANNING_PERMIT, P.SY_VALUE_NOT_CONSTRUCTION_PER, P.SY_VALUE_NOT_SALE_PERMIT, P.SY_VALUE_NOT_COMPLETION, P.SY_VALUE_YES_COMPLETION, P.SY_VALUE_YES_SETTLEMENT) =
            (SELECT SUM(A.SY_VALUE_DT_ALL), SUM(A.SY_VALUE_REMAIN), SUM(A.SY_VALUE_HAVED_SALE), SUM(A.SY_VALUE_RESERVE), SUM(A.SY_VALUE_IN_PROCESS), SUM(A.SY_VALUE_ALLOW_SALE), SUM(A.SY_VALUE_STOCK),
                    SUM(A.SY_VALUE_NOT_PLANNING_PERMIT), SUM(A.SY_VALUE_NOT_CONSTRUCTION_PER), SUM(A.SY_VALUE_NOT_SALE_PERMIT), SUM(A.SY_VALUE_NOT_COMPLETION), SUM(A.SY_VALUE_YES_COMPLETION),
                    SUM(A.SY_VALUE_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PROJ_ID = P.PROJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  P.OBJ_TYPE = '项目';

    --项目级动态货量更新
    UPDATE DWM_DT_VALUE B
    SET    (B.AREA_DT_ALL, B.AREA_REMAIN, B.AREA_HAVED_SALE, B.AREA_RESERVE, B.AREA_IN_PROCESS, B.AREA_ALLOW_SALE, B.AREA_STOCK, B.AREA_NOT_PLANNING_PERMIT, B.AREA_NOT_CONSTRUCTION_PERMIT, B.AREA_NOT_SALE_PERMIT, B.AREA_NOT_COMPLETION, B.AREA_YES_COMPLETION, B.AREA_YES_SETTLEMENT) =
            (SELECT SUM(A.AREA_DT_ALL), SUM(A.AREA_REMAIN), SUM(A.AREA_HAVED_SALE), SUM(A.AREA_RESERVE), SUM(A.AREA_IN_PROCESS), SUM(A.AREA_ALLOW_SALE), SUM(A.AREA_STOCK),
                    SUM(A.AREA_NOT_PLANNING_PERMIT), SUM(A.AREA_NOT_CONSTRUCTION_PERMIT), SUM(A.AREA_NOT_SALE_PERMIT), SUM(A.AREA_NOT_COMPLETION), SUM(A.AREA_YES_COMPLETION), SUM(A.AREA_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PROJ_ID = B.PROJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  B.OBJ_TYPE = '项目';

    UPDATE DWM_DT_VALUE P
    SET    (P.CW_AREA_DT_ALL, P.CW_AREA_REMAIN, P.CW_AREA_HAVED_SALE, P.CW_AREA_RESERVE, P.CW_AREA_IN_PROCESS, P.CW_AREA_ALLOW_SALE, P.CW_AREA_STOCK, P.CW_AREA_NOT_PLANNING_PERMIT, P.CW_AREA_NOT_CONSTRUCTION_PER, P.CW_AREA_NOT_SALE_PERMIT, P.CW_AREA_NOT_COMPLETION, P.CW_AREA_YES_COMPLETION, P.CW_AREA_YES_SETTLEMENT) =
            (SELECT SUM(A.CW_AREA_DT_ALL), SUM(A.CW_AREA_REMAIN), SUM(A.CW_AREA_HAVED_SALE), SUM(A.CW_AREA_RESERVE), SUM(A.CW_AREA_IN_PROCESS), SUM(A.CW_AREA_ALLOW_SALE), SUM(A.CW_AREA_STOCK),
                    SUM(A.CW_AREA_NOT_PLANNING_PERMIT), SUM(A.CW_AREA_NOT_CONSTRUCTION_PER), SUM(A.CW_AREA_NOT_SALE_PERMIT), SUM(A.CW_AREA_NOT_COMPLETION), SUM(A.CW_AREA_YES_COMPLETION),
                    SUM(A.CW_AREA_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PROJ_ID = P.PROJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  P.OBJ_TYPE = '项目';

    UPDATE DWM_DT_VALUE P
    SET    (P.ZZ_AREA_DT_ALL, P.ZZ_AREA_REMAIN, P.ZZ_AREA_HAVED_SALE, P.ZZ_AREA_RESERVE, P.ZZ_AREA_IN_PROCESS, P.ZZ_AREA_ALLOW_SALE, P.ZZ_AREA_STOCK, P.ZZ_AREA_NOT_PLANNING_PERMIT, P.ZZ_AREA_NOT_CONSTRUCTION_PER, P.ZZ_AREA_NOT_SALE_PERMIT, P.ZZ_AREA_NOT_COMPLETION, P.ZZ_AREA_YES_COMPLETION, P.ZZ_AREA_YES_SETTLEMENT) =
            (SELECT SUM(A.ZZ_AREA_DT_ALL), SUM(A.ZZ_AREA_REMAIN), SUM(A.ZZ_AREA_HAVED_SALE), SUM(A.ZZ_AREA_RESERVE), SUM(A.ZZ_AREA_IN_PROCESS), SUM(A.ZZ_AREA_ALLOW_SALE), SUM(A.ZZ_AREA_STOCK),
                    SUM(A.ZZ_AREA_NOT_PLANNING_PERMIT), SUM(A.ZZ_AREA_NOT_CONSTRUCTION_PER), SUM(A.ZZ_AREA_NOT_SALE_PERMIT), SUM(A.ZZ_AREA_NOT_COMPLETION), SUM(A.ZZ_AREA_YES_COMPLETION),
                    SUM(A.ZZ_AREA_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PROJ_ID = P.PROJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  P.OBJ_TYPE = '项目';

    UPDATE DWM_DT_VALUE P
    SET    (P.SY_AREA_DT_ALL, P.SY_AREA_REMAIN, P.SY_AREA_HAVED_SALE, P.SY_AREA_RESERVE, P.SY_AREA_IN_PROCESS, P.SY_AREA_ALLOW_SALE, P.SY_AREA_STOCK, P.SY_AREA_NOT_PLANNING_PERMIT, P.SY_AREA_NOT_CONSTRUCTION_PER, P.SY_AREA_NOT_SALE_PERMIT, P.SY_AREA_NOT_COMPLETION, P.SY_AREA_YES_COMPLETION, P.SY_AREA_YES_SETTLEMENT) =
            (SELECT SUM(A.SY_AREA_DT_ALL), SUM(A.SY_AREA_REMAIN), SUM(A.SY_AREA_HAVED_SALE), SUM(A.SY_AREA_RESERVE), SUM(A.SY_AREA_IN_PROCESS), SUM(A.SY_AREA_ALLOW_SALE), SUM(A.SY_AREA_STOCK),
                    SUM(A.SY_AREA_NOT_PLANNING_PERMIT), SUM(A.SY_AREA_NOT_CONSTRUCTION_PER), SUM(A.SY_AREA_NOT_SALE_PERMIT), SUM(A.SY_AREA_NOT_COMPLETION), SUM(A.SY_AREA_YES_COMPLETION),
                    SUM(A.SY_AREA_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PROJ_ID = P.PROJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  P.OBJ_TYPE = '项目';

    /*
    --分期级动态货值、货量更新
    */

    --动态货值更新
    UPDATE DWM_DT_VALUE B
    SET    (B.VALUE_DT_ALL, B.VALUE_REMAIN, B.VALUE_HAVED_SALE, B.VALUE_RESERVE, B.VALUE_IN_PROCESS, B.VALUE_ALLOW_SALE, B.VALUE_STOCK, B.VALUE_NOT_PLANNING_PERMIT, B.VALUE_NOT_CONSTRUCTION_PERMIT, B.VALUE_NOT_SALE_PERMIT, B.VALUE_NOT_COMPLETION, B.VALUE_YES_COMPLETION, B.VALUE_YES_SETTLEMENT) =
            (SELECT SUM(A.VALUE_DT_ALL), SUM(A.VALUE_REMAIN), SUM(A.VALUE_HAVED_SALE), SUM(A.VALUE_RESERVE), SUM(A.VALUE_IN_PROCESS), SUM(A.VALUE_ALLOW_SALE), SUM(A.VALUE_STOCK),
                    SUM(A.VALUE_NOT_PLANNING_PERMIT), SUM(A.VALUE_NOT_CONSTRUCTION_PERMIT), SUM(A.VALUE_NOT_SALE_PERMIT), SUM(A.VALUE_NOT_COMPLETION), SUM(A.VALUE_YES_COMPLETION),
                    SUM(A.VALUE_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PARENT_ID = B.OBJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  B.OBJ_TYPE = '分期';

    UPDATE DWM_DT_VALUE P
    SET    (P.CW_VALUE_DT_ALL, P.CW_VALUE_REMAIN, P.CW_VALUE_HAVED_SALE, P.CW_VALUE_RESERVE, P.CW_VALUE_IN_PROCESS, P.CW_VALUE_ALLOW_SALE, P.CW_VALUE_STOCK, P.CW_VALUE_NOT_PLANNING_PERMIT, P.CW_VALUE_NOT_CONSTRUCTION_PER, P.CW_VALUE_NOT_SALE_PERMIT, P.CW_VALUE_NOT_COMPLETION, P.CW_VALUE_YES_COMPLETION, P.CW_VALUE_YES_SETTLEMENT) =
            (SELECT SUM(A.CW_VALUE_DT_ALL), SUM(A.CW_VALUE_REMAIN), SUM(A.CW_VALUE_HAVED_SALE), SUM(A.CW_VALUE_RESERVE), SUM(A.CW_VALUE_IN_PROCESS), SUM(A.CW_VALUE_ALLOW_SALE), SUM(A.CW_VALUE_STOCK),
                    SUM(A.CW_VALUE_NOT_PLANNING_PERMIT), SUM(A.CW_VALUE_NOT_CONSTRUCTION_PER), SUM(A.CW_VALUE_NOT_SALE_PERMIT), SUM(A.CW_VALUE_NOT_COMPLETION), SUM(A.CW_VALUE_YES_COMPLETION),
                    SUM(A.CW_VALUE_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PARENT_ID = P.OBJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  P.OBJ_TYPE = '分期';

    UPDATE DWM_DT_VALUE P
    SET    (P.ZZ_VALUE_DT_ALL, P.ZZ_VALUE_REMAIN, P.ZZ_VALUE_HAVED_SALE, P.ZZ_VALUE_RESERVE, P.ZZ_VALUE_IN_PROCESS, P.ZZ_VALUE_ALLOW_SALE, P.ZZ_VALUE_STOCK, P.ZZ_VALUE_NOT_PLANNING_PERMIT, P.ZZ_VALUE_NOT_CONSTRUCTION_PER, P.ZZ_VALUE_NOT_SALE_PERMIT, P.ZZ_VALUE_NOT_COMPLETION, P.ZZ_VALUE_YES_COMPLETION, P.ZZ_VALUE_YES_SETTLEMENT) =
            (SELECT SUM(A.ZZ_VALUE_DT_ALL), SUM(A.ZZ_VALUE_REMAIN), SUM(A.ZZ_VALUE_HAVED_SALE), SUM(A.ZZ_VALUE_RESERVE), SUM(A.ZZ_VALUE_IN_PROCESS), SUM(A.ZZ_VALUE_ALLOW_SALE), SUM(A.ZZ_VALUE_STOCK),
                    SUM(A.ZZ_VALUE_NOT_PLANNING_PERMIT), SUM(A.ZZ_VALUE_NOT_CONSTRUCTION_PER), SUM(A.ZZ_VALUE_NOT_SALE_PERMIT), SUM(A.ZZ_VALUE_NOT_COMPLETION), SUM(A.ZZ_VALUE_YES_COMPLETION),
                    SUM(A.ZZ_VALUE_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PARENT_ID = P.OBJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  P.OBJ_TYPE = '分期';

    UPDATE DWM_DT_VALUE P
    SET    (P.SY_VALUE_DT_ALL, P.SY_VALUE_REMAIN, P.SY_VALUE_HAVED_SALE, P.SY_VALUE_RESERVE, P.SY_VALUE_IN_PROCESS, P.SY_VALUE_ALLOW_SALE, P.SY_VALUE_STOCK, P.SY_VALUE_NOT_PLANNING_PERMIT, P.SY_VALUE_NOT_CONSTRUCTION_PER, P.SY_VALUE_NOT_SALE_PERMIT, P.SY_VALUE_NOT_COMPLETION, P.SY_VALUE_YES_COMPLETION, P.SY_VALUE_YES_SETTLEMENT) =
            (SELECT SUM(A.SY_VALUE_DT_ALL), SUM(A.SY_VALUE_REMAIN), SUM(A.SY_VALUE_HAVED_SALE), SUM(A.SY_VALUE_RESERVE), SUM(A.SY_VALUE_IN_PROCESS), SUM(A.SY_VALUE_ALLOW_SALE), SUM(A.SY_VALUE_STOCK),
                    SUM(A.SY_VALUE_NOT_PLANNING_PERMIT), SUM(A.SY_VALUE_NOT_CONSTRUCTION_PER), SUM(A.SY_VALUE_NOT_SALE_PERMIT), SUM(A.SY_VALUE_NOT_COMPLETION), SUM(A.SY_VALUE_YES_COMPLETION),
                    SUM(A.SY_VALUE_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PARENT_ID = P.OBJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  P.OBJ_TYPE = '分期';

    --动态货量更新
    UPDATE DWM_DT_VALUE B
    SET    (B.AREA_DT_ALL, B.AREA_REMAIN, B.AREA_HAVED_SALE, B.AREA_RESERVE, B.AREA_IN_PROCESS, B.AREA_ALLOW_SALE, B.AREA_STOCK, B.AREA_NOT_PLANNING_PERMIT, B.AREA_NOT_CONSTRUCTION_PERMIT, B.AREA_NOT_SALE_PERMIT, B.AREA_NOT_COMPLETION, B.AREA_YES_COMPLETION, B.AREA_YES_SETTLEMENT) =
            (SELECT SUM(A.AREA_DT_ALL), SUM(A.AREA_REMAIN), SUM(A.AREA_HAVED_SALE), SUM(A.AREA_RESERVE), SUM(A.AREA_IN_PROCESS), SUM(A.AREA_ALLOW_SALE), SUM(A.AREA_STOCK),
                    SUM(A.AREA_NOT_PLANNING_PERMIT), SUM(A.AREA_NOT_CONSTRUCTION_PERMIT), SUM(A.AREA_NOT_SALE_PERMIT), SUM(A.AREA_NOT_COMPLETION), SUM(A.AREA_YES_COMPLETION), SUM(A.AREA_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PARENT_ID = B.OBJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  B.OBJ_TYPE = '分期';

    UPDATE DWM_DT_VALUE P
    SET    (P.CW_AREA_DT_ALL, P.CW_AREA_REMAIN, P.CW_AREA_HAVED_SALE, P.CW_AREA_RESERVE, P.CW_AREA_IN_PROCESS, P.CW_AREA_ALLOW_SALE, P.CW_AREA_STOCK, P.CW_AREA_NOT_PLANNING_PERMIT, P.CW_AREA_NOT_CONSTRUCTION_PER, P.CW_AREA_NOT_SALE_PERMIT, P.CW_AREA_NOT_COMPLETION, P.CW_AREA_YES_COMPLETION, P.CW_AREA_YES_SETTLEMENT) =
            (SELECT SUM(A.CW_AREA_DT_ALL), SUM(A.CW_AREA_REMAIN), SUM(A.CW_AREA_HAVED_SALE), SUM(A.CW_AREA_RESERVE), SUM(A.CW_AREA_IN_PROCESS), SUM(A.CW_AREA_ALLOW_SALE), SUM(A.CW_AREA_STOCK),
                    SUM(A.CW_AREA_NOT_PLANNING_PERMIT), SUM(A.CW_AREA_NOT_CONSTRUCTION_PER), SUM(A.CW_AREA_NOT_SALE_PERMIT), SUM(A.CW_AREA_NOT_COMPLETION), SUM(A.CW_AREA_YES_COMPLETION),
                    SUM(A.CW_AREA_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PARENT_ID = P.OBJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  P.OBJ_TYPE = '分期';

    UPDATE DWM_DT_VALUE P
    SET    (P.ZZ_AREA_DT_ALL, P.ZZ_AREA_REMAIN, P.ZZ_AREA_HAVED_SALE, P.ZZ_AREA_RESERVE, P.ZZ_AREA_IN_PROCESS, P.ZZ_AREA_ALLOW_SALE, P.ZZ_AREA_STOCK, P.ZZ_AREA_NOT_PLANNING_PERMIT, P.ZZ_AREA_NOT_CONSTRUCTION_PER, P.ZZ_AREA_NOT_SALE_PERMIT, P.ZZ_AREA_NOT_COMPLETION, P.ZZ_AREA_YES_COMPLETION, P.ZZ_AREA_YES_SETTLEMENT) =
            (SELECT SUM(A.ZZ_AREA_DT_ALL), SUM(A.ZZ_AREA_REMAIN), SUM(A.ZZ_AREA_HAVED_SALE), SUM(A.ZZ_AREA_RESERVE), SUM(A.ZZ_AREA_IN_PROCESS), SUM(A.ZZ_AREA_ALLOW_SALE), SUM(A.ZZ_AREA_STOCK),
                    SUM(A.ZZ_AREA_NOT_PLANNING_PERMIT), SUM(A.ZZ_AREA_NOT_CONSTRUCTION_PER), SUM(A.ZZ_AREA_NOT_SALE_PERMIT), SUM(A.ZZ_AREA_NOT_COMPLETION), SUM(A.ZZ_AREA_YES_COMPLETION),
                    SUM(A.ZZ_AREA_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PARENT_ID = P.OBJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  P.OBJ_TYPE = '分期';

    UPDATE DWM_DT_VALUE P
    SET    (P.SY_AREA_DT_ALL, P.SY_AREA_REMAIN, P.SY_AREA_HAVED_SALE, P.SY_AREA_RESERVE, P.SY_AREA_IN_PROCESS, P.SY_AREA_ALLOW_SALE, P.SY_AREA_STOCK, P.SY_AREA_NOT_PLANNING_PERMIT, P.SY_AREA_NOT_CONSTRUCTION_PER, P.SY_AREA_NOT_SALE_PERMIT, P.SY_AREA_NOT_COMPLETION, P.SY_AREA_YES_COMPLETION, P.SY_AREA_YES_SETTLEMENT) =
            (SELECT SUM(A.SY_AREA_DT_ALL), SUM(A.SY_AREA_REMAIN), SUM(A.SY_AREA_HAVED_SALE), SUM(A.SY_AREA_RESERVE), SUM(A.SY_AREA_IN_PROCESS), SUM(A.SY_AREA_ALLOW_SALE), SUM(A.SY_AREA_STOCK),
                    SUM(A.SY_AREA_NOT_PLANNING_PERMIT), SUM(A.SY_AREA_NOT_CONSTRUCTION_PER), SUM(A.SY_AREA_NOT_SALE_PERMIT), SUM(A.SY_AREA_NOT_COMPLETION), SUM(A.SY_AREA_YES_COMPLETION),
                    SUM(A.SY_AREA_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PARENT_ID = P.OBJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  P.OBJ_TYPE = '分期';

    /*
    ----------------------------------------------------------------
        更新当前在全盘阶段分期的动态货值、动态货量,动态货值计算公式：当前阶段业态的面积*业态最新均价
    ----------------------------------------------------------------
    */

    OPEN CUR_PERIOD_LIST;
    LOOP

        FETCH CUR_PERIOD_LIST
            INTO ITEM_PERIOD_LIST;
        EXIT WHEN CUR_PERIOD_LIST%NOTFOUND;
        --获取当前业态最新均价
        SELECT A.TARGET_A_ID INTO V_TARGET_WORTH_ID FROM DWM_DT_VALUE A WHERE A.OBJ_ID = ITEM_PERIOD_LIST.PERIOD_ID;

        SELECT COUNT(1)
        INTO   V_COUNT
        FROM   DWM_TARGET_WORTH_DTL A
        WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_ID = ITEM_PERIOD_LIST.PRODUCT_TYPE_ID AND A.OBJ_PARENT_ID = ITEM_PERIOD_LIST.PERIOD_ID;

        IF V_COUNT = 1 THEN
            SELECT NVL(A.AVERAGE_PRICE, 0)
            INTO   V_PRICE
            FROM   DWM_TARGET_WORTH_DTL A
            WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_ID = ITEM_PERIOD_LIST.PRODUCT_TYPE_ID AND A.OBJ_PARENT_ID = ITEM_PERIOD_LIST.PERIOD_ID;
        ELSE
            V_PRICE := 0;
        END IF;

        --获取当前业态所属一级业态

        V_PRODUCT_TYPE := SUBSTR(ITEM_PERIOD_LIST.PRODUCT_TYPE_NAME, 0, INSTR(ITEM_PERIOD_LIST.PRODUCT_TYPE_NAME, '/', 1) - 1);
        V_IS_CARPORT := CASE
                            WHEN ITEM_PERIOD_LIST.PRODUCT_TYPE_JSON = '{"isCarport":1}' THEN
                             1
                            ELSE
                             0
                        END;

        IF V_PRODUCT_TYPE = '住宅' THEN
            /*
            ------------------------------------------
            更新分期ZZ动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --ZZ动态货值
                     A.ZZ_VALUE_DT_ALL, A.ZZ_VALUE_REMAIN, A.ZZ_VALUE_HAVED_SALE, A.ZZ_VALUE_RESERVE, A.ZZ_VALUE_IN_PROCESS, A.ZZ_VALUE_ALLOW_SALE, A.ZZ_VALUE_STOCK, A.ZZ_VALUE_NOT_PLANNING_PERMIT, A.ZZ_VALUE_NOT_CONSTRUCTION_PER, A.ZZ_VALUE_NOT_SALE_PERMIT, A.ZZ_VALUE_NOT_COMPLETION, A.ZZ_VALUE_YES_COMPLETION, A.ZZ_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --ZZ动态货值
                      NVL(A.ZZ_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.ZZ_VALUE_HAVED_SALE, 0), NVL(A.ZZ_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_VALUE_IN_PROCESS, 0), NVL(A.ZZ_VALUE_ALLOW_SALE, 0),
                      NVL(A.ZZ_VALUE_STOCK, 0), NVL(A.ZZ_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.ZZ_VALUE_NOT_SALE_PERMIT, 0), NVL(A.ZZ_VALUE_NOT_COMPLETION, 0), NVL(A.ZZ_VALUE_YES_COMPLETION, 0), NVL(A.ZZ_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.VALUE_HAVED_SALE, 0), NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0),
                      NVL(A.VALUE_STOCK, 0), NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.VALUE_NOT_SALE_PERMIT, 0), NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PERIOD_ID;
            /*
            ------------------------------------------
            更新分期ZZ动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --ZZ动态货量
                     A.ZZ_AREA_DT_ALL, A.ZZ_AREA_REMAIN, A.ZZ_AREA_HAVED_SALE, A.ZZ_AREA_RESERVE, A.ZZ_AREA_IN_PROCESS, A.ZZ_AREA_ALLOW_SALE, A.ZZ_AREA_STOCK, A.ZZ_AREA_NOT_PLANNING_PERMIT, A.ZZ_AREA_NOT_CONSTRUCTION_PER, A.ZZ_AREA_NOT_SALE_PERMIT, A.ZZ_AREA_NOT_COMPLETION, A.ZZ_AREA_YES_COMPLETION, A.ZZ_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --ZZ动态货量
                      NVL(A.ZZ_AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_AREA_HAVED_SALE, 0),
                      NVL(A.ZZ_AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_AREA_IN_PROCESS, 0), NVL(A.ZZ_AREA_ALLOW_SALE, 0), NVL(A.ZZ_AREA_STOCK, 0),
                      NVL(A.ZZ_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_AREA_NOT_CONSTRUCTION_PER, 0), NVL(A.ZZ_AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.ZZ_AREA_NOT_COMPLETION, 0), NVL(A.ZZ_AREA_YES_COMPLETION, 0), NVL(A.ZZ_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_HAVED_SALE, 0),
                      NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0), NVL(A.AREA_STOCK, 0),
                      NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.AREA_NOT_SALE_PERMIT, 0), NVL(A.AREA_NOT_COMPLETION, 0),
                      NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PERIOD_ID;
            /*
            ------------------------------------------
            更新项目ZZ动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --ZZ动态货值
                     A.ZZ_VALUE_DT_ALL, A.ZZ_VALUE_REMAIN, A.ZZ_VALUE_HAVED_SALE, A.ZZ_VALUE_RESERVE, A.ZZ_VALUE_IN_PROCESS, A.ZZ_VALUE_ALLOW_SALE, A.ZZ_VALUE_STOCK, A.ZZ_VALUE_NOT_PLANNING_PERMIT, A.ZZ_VALUE_NOT_CONSTRUCTION_PER, A.ZZ_VALUE_NOT_SALE_PERMIT, A.ZZ_VALUE_NOT_COMPLETION, A.ZZ_VALUE_YES_COMPLETION, A.ZZ_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --ZZ动态货值
                      NVL(A.ZZ_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.ZZ_VALUE_HAVED_SALE, 0), NVL(A.ZZ_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_VALUE_IN_PROCESS, 0), NVL(A.ZZ_VALUE_ALLOW_SALE, 0),
                      NVL(A.ZZ_VALUE_STOCK, 0), NVL(A.ZZ_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.ZZ_VALUE_NOT_SALE_PERMIT, 0), NVL(A.ZZ_VALUE_NOT_COMPLETION, 0), NVL(A.ZZ_VALUE_YES_COMPLETION, 0), NVL(A.ZZ_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.VALUE_HAVED_SALE, 0), NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0),
                      NVL(A.VALUE_STOCK, 0), NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.VALUE_NOT_SALE_PERMIT, 0), NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PROJECT_ID;
            /*
            ------------------------------------------
            更新项目ZZ动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --ZZ动态货量
                     A.ZZ_AREA_DT_ALL, A.ZZ_AREA_REMAIN, A.ZZ_AREA_HAVED_SALE, A.ZZ_AREA_RESERVE, A.ZZ_AREA_IN_PROCESS, A.ZZ_AREA_ALLOW_SALE, A.ZZ_AREA_STOCK, A.ZZ_AREA_NOT_PLANNING_PERMIT, A.ZZ_AREA_NOT_CONSTRUCTION_PER, A.ZZ_AREA_NOT_SALE_PERMIT, A.ZZ_AREA_NOT_COMPLETION, A.ZZ_AREA_YES_COMPLETION, A.ZZ_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --ZZ动态货量
                      NVL(A.ZZ_AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_AREA_HAVED_SALE, 0),
                      NVL(A.ZZ_AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_AREA_IN_PROCESS, 0), NVL(A.ZZ_AREA_ALLOW_SALE, 0), NVL(A.ZZ_AREA_STOCK, 0),
                      NVL(A.ZZ_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_AREA_NOT_CONSTRUCTION_PER, 0), NVL(A.ZZ_AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.ZZ_AREA_NOT_COMPLETION, 0), NVL(A.ZZ_AREA_YES_COMPLETION, 0), NVL(A.ZZ_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_HAVED_SALE, 0),
                      NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0), NVL(A.AREA_STOCK, 0),
                      NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.AREA_NOT_SALE_PERMIT, 0), NVL(A.AREA_NOT_COMPLETION, 0),
                      NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PROJECT_ID;

        ELSIF V_PRODUCT_TYPE = '商办产业' THEN

            /*
            ------------------------------------------
            更新分期ZZ动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --ZZ动态货值
                     A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --ZZ动态货值
                      NVL(A.SY_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.SY_VALUE_HAVED_SALE, 0), NVL(A.SY_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_IN_PROCESS, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0),
                      NVL(A.SY_VALUE_STOCK, 0), NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0), NVL(A.SY_VALUE_NOT_COMPLETION, 0), NVL(A.SY_VALUE_YES_COMPLETION, 0), NVL(A.SY_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.VALUE_HAVED_SALE, 0), NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0),
                      NVL(A.VALUE_STOCK, 0), NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.VALUE_NOT_SALE_PERMIT, 0), NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PERIOD_ID;
            /*
            ------------------------------------------
            更新分期SY动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --ZZ动态货量
                     A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --ZZ动态货量
                      NVL(A.SY_AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_HAVED_SALE, 0),
                      NVL(A.SY_AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_IN_PROCESS, 0), NVL(A.SY_AREA_ALLOW_SALE, 0), NVL(A.SY_AREA_STOCK, 0),
                      NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0), NVL(A.SY_AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.SY_AREA_NOT_COMPLETION, 0), NVL(A.SY_AREA_YES_COMPLETION, 0), NVL(A.SY_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_HAVED_SALE, 0),
                      NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0), NVL(A.AREA_STOCK, 0),
                      NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.AREA_NOT_SALE_PERMIT, 0), NVL(A.AREA_NOT_COMPLETION, 0),
                      NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PERIOD_ID;
            /*
            ------------------------------------------
            更新项目SY动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --ZZ动态货值
                     A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --ZZ动态货值
                      NVL(A.SY_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.SY_VALUE_HAVED_SALE, 0), NVL(A.SY_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_IN_PROCESS, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0),
                      NVL(A.SY_VALUE_STOCK, 0), NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0), NVL(A.SY_VALUE_NOT_COMPLETION, 0), NVL(A.SY_VALUE_YES_COMPLETION, 0), NVL(A.SY_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.VALUE_HAVED_SALE, 0), NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0),
                      NVL(A.VALUE_STOCK, 0), NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.VALUE_NOT_SALE_PERMIT, 0), NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PROJECT_ID;
            /*
            ------------------------------------------
            更新项目ZZ动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --ZZ动态货量
                     A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --ZZ动态货量
                      NVL(A.SY_AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_HAVED_SALE, 0),
                      NVL(A.SY_AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_IN_PROCESS, 0), NVL(A.SY_AREA_ALLOW_SALE, 0), NVL(A.SY_AREA_STOCK, 0),
                      NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0), NVL(A.SY_AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.SY_AREA_NOT_COMPLETION, 0), NVL(A.SY_AREA_YES_COMPLETION, 0), NVL(A.SY_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_HAVED_SALE, 0),
                      NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0), NVL(A.AREA_STOCK, 0),
                      NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.AREA_NOT_SALE_PERMIT, 0), NVL(A.AREA_NOT_COMPLETION, 0),
                      NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PROJECT_ID;

        ELSIF V_PRODUCT_TYPE = '车位仓储' AND V_IS_CARPORT = 1 THEN

            /*
            ------------------------------------------
            更新分期CW动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --CW动态货值
                     A.CW_VALUE_DT_ALL, A.CW_VALUE_REMAIN, A.CW_VALUE_HAVED_SALE, A.CW_VALUE_RESERVE, A.CW_VALUE_IN_PROCESS, A.CW_VALUE_ALLOW_SALE, A.CW_VALUE_STOCK, A.CW_VALUE_NOT_PLANNING_PERMIT, A.CW_VALUE_NOT_CONSTRUCTION_PER, A.CW_VALUE_NOT_SALE_PERMIT, A.CW_VALUE_NOT_COMPLETION, A.CW_VALUE_YES_COMPLETION, A.CW_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --CW动态货值
                      NVL(A.CW_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                      NVL(A.CW_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_VALUE_HAVED_SALE, 0),
                      NVL(A.CW_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_VALUE_IN_PROCESS, 0), NVL(A.CW_VALUE_ALLOW_SALE, 0),
                      NVL(A.CW_VALUE_STOCK, 0), NVL(A.CW_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.CW_VALUE_NOT_SALE_PERMIT, 0), NVL(A.CW_VALUE_NOT_COMPLETION, 0), NVL(A.CW_VALUE_YES_COMPLETION, 0), NVL(A.CW_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                      NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.VALUE_HAVED_SALE, 0),
                      NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0), NVL(A.VALUE_STOCK, 0),
                      NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.VALUE_NOT_SALE_PERMIT, 0),
                      NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PERIOD_ID;
            /*
            ------------------------------------------
            更新分期CW动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --CW动态货量
                     A.CW_AREA_DT_ALL, A.CW_AREA_REMAIN, A.CW_AREA_HAVED_SALE, A.CW_AREA_RESERVE, A.CW_AREA_IN_PROCESS, A.CW_AREA_ALLOW_SALE, A.CW_AREA_STOCK, A.CW_AREA_NOT_PLANNING_PERMIT, A.CW_AREA_NOT_CONSTRUCTION_PER, A.CW_AREA_NOT_SALE_PERMIT, A.CW_AREA_NOT_COMPLETION, A.CW_AREA_YES_COMPLETION, A.CW_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --CW动态货量
                      NVL(A.CW_AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                      NVL(A.CW_AREA_HAVED_SALE, 0), NVL(A.CW_AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_IN_PROCESS, 0), NVL(A.CW_AREA_ALLOW_SALE, 0),
                      NVL(A.CW_AREA_STOCK, 0), NVL(A.CW_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.CW_AREA_NOT_SALE_PERMIT, 0), NVL(A.CW_AREA_NOT_COMPLETION, 0), NVL(A.CW_AREA_YES_COMPLETION, 0), NVL(A.CW_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                      NVL(A.AREA_HAVED_SALE, 0), NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0),
                      NVL(A.AREA_STOCK, 0), NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.AREA_NOT_SALE_PERMIT, 0), NVL(A.AREA_NOT_COMPLETION, 0), NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PERIOD_ID;
            /*
            ------------------------------------------
            更新项目CW动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --CW动态货值
                     A.CW_VALUE_DT_ALL, A.CW_VALUE_REMAIN, A.CW_VALUE_HAVED_SALE, A.CW_VALUE_RESERVE, A.CW_VALUE_IN_PROCESS, A.CW_VALUE_ALLOW_SALE, A.CW_VALUE_STOCK, A.CW_VALUE_NOT_PLANNING_PERMIT, A.CW_VALUE_NOT_CONSTRUCTION_PER, A.CW_VALUE_NOT_SALE_PERMIT, A.CW_VALUE_NOT_COMPLETION, A.CW_VALUE_YES_COMPLETION, A.CW_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --CW动态货值
                      NVL(A.CW_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                      NVL(A.CW_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_VALUE_HAVED_SALE, 0),
                      NVL(A.CW_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_VALUE_IN_PROCESS, 0), NVL(A.CW_VALUE_ALLOW_SALE, 0),
                      NVL(A.CW_VALUE_STOCK, 0), NVL(A.CW_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.CW_VALUE_NOT_SALE_PERMIT, 0), NVL(A.CW_VALUE_NOT_COMPLETION, 0), NVL(A.CW_VALUE_YES_COMPLETION, 0), NVL(A.CW_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                      NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.VALUE_HAVED_SALE, 0),
                      NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0), NVL(A.VALUE_STOCK, 0),
                      NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.VALUE_NOT_SALE_PERMIT, 0),
                      NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PROJECT_ID;
            /*
            ------------------------------------------
            更新项目CW动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --CW动态货量
                     A.CW_AREA_DT_ALL, A.CW_AREA_REMAIN, A.CW_AREA_HAVED_SALE, A.CW_AREA_RESERVE, A.CW_AREA_IN_PROCESS, A.CW_AREA_ALLOW_SALE, A.CW_AREA_STOCK, A.CW_AREA_NOT_PLANNING_PERMIT, A.CW_AREA_NOT_CONSTRUCTION_PER, A.CW_AREA_NOT_SALE_PERMIT, A.CW_AREA_NOT_COMPLETION, A.CW_AREA_YES_COMPLETION, A.CW_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --CW动态货量
                      NVL(A.CW_AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                      NVL(A.CW_AREA_HAVED_SALE, 0), NVL(A.CW_AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_IN_PROCESS, 0), NVL(A.CW_AREA_ALLOW_SALE, 0),
                      NVL(A.CW_AREA_STOCK, 0), NVL(A.CW_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.CW_AREA_NOT_SALE_PERMIT, 0), NVL(A.CW_AREA_NOT_COMPLETION, 0), NVL(A.CW_AREA_YES_COMPLETION, 0), NVL(A.CW_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                      NVL(A.AREA_HAVED_SALE, 0), NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0),
                      NVL(A.AREA_STOCK, 0), NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.AREA_NOT_SALE_PERMIT, 0), NVL(A.AREA_NOT_COMPLETION, 0), NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PROJECT_ID;

        ELSIF V_PRODUCT_TYPE = '车位仓储' AND V_IS_CARPORT = 0 THEN

            /*
            ------------------------------------------
            更新分期SY动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货值
                     A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货值
                      NVL(A.SY_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.SY_VALUE_HAVED_SALE, 0), NVL(A.SY_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_IN_PROCESS, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0),
                      NVL(A.SY_VALUE_STOCK, 0), NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0), NVL(A.SY_VALUE_NOT_COMPLETION, 0), NVL(A.SY_VALUE_YES_COMPLETION, 0), NVL(A.SY_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.VALUE_HAVED_SALE, 0), NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0),
                      NVL(A.VALUE_STOCK, 0), NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.VALUE_NOT_SALE_PERMIT, 0), NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PERIOD_ID;
            /*
            ------------------------------------------
            更新分期SY动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货量
                     A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货量
                      NVL(A.SY_AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_HAVED_SALE, 0),
                      NVL(A.SY_AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_IN_PROCESS, 0), NVL(A.SY_AREA_ALLOW_SALE, 0), NVL(A.SY_AREA_STOCK, 0),
                      NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0), NVL(A.SY_AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.SY_AREA_NOT_COMPLETION, 0), NVL(A.SY_AREA_YES_COMPLETION, 0), NVL(A.SY_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_HAVED_SALE, 0),
                      NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0), NVL(A.AREA_STOCK, 0),
                      NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.AREA_NOT_SALE_PERMIT, 0), NVL(A.AREA_NOT_COMPLETION, 0),
                      NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PERIOD_ID;
            /*
            ------------------------------------------
            更新项目SY动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货值
                     A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货值
                      NVL(A.SY_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.SY_VALUE_HAVED_SALE, 0), NVL(A.SY_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_IN_PROCESS, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0),
                      NVL(A.SY_VALUE_STOCK, 0), NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0), NVL(A.SY_VALUE_NOT_COMPLETION, 0), NVL(A.SY_VALUE_YES_COMPLETION, 0), NVL(A.SY_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.VALUE_HAVED_SALE, 0), NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0),
                      NVL(A.VALUE_STOCK, 0), NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.VALUE_NOT_SALE_PERMIT, 0), NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PROJECT_ID;
            /*
            ------------------------------------------
            更新项目SY动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货量
                     A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货量
                      NVL(A.SY_AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_HAVED_SALE, 0),
                      NVL(A.SY_AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_IN_PROCESS, 0), NVL(A.SY_AREA_ALLOW_SALE, 0), NVL(A.SY_AREA_STOCK, 0),
                      NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0), NVL(A.SY_AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.SY_AREA_NOT_COMPLETION, 0), NVL(A.SY_AREA_YES_COMPLETION, 0), NVL(A.SY_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_HAVED_SALE, 0),
                      NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0), NVL(A.AREA_STOCK, 0),
                      NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.AREA_NOT_SALE_PERMIT, 0), NVL(A.AREA_NOT_COMPLETION, 0),
                      NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PROJECT_ID;
        ELSIF V_PRODUCT_TYPE = '配套设施' THEN

            /*
            ------------------------------------------
            更新分期SY动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货值
                     A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货值
                      NVL(A.SY_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.SY_VALUE_HAVED_SALE, 0), NVL(A.SY_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_IN_PROCESS, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0),
                      NVL(A.SY_VALUE_STOCK, 0), NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0), NVL(A.SY_VALUE_NOT_COMPLETION, 0), NVL(A.SY_VALUE_YES_COMPLETION, 0), NVL(A.SY_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.VALUE_HAVED_SALE, 0), NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0),
                      NVL(A.VALUE_STOCK, 0), NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.VALUE_NOT_SALE_PERMIT, 0), NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PERIOD_ID;
            /*
            ------------------------------------------
            更新分期SY动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货量
                     A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货量
                      NVL(A.SY_AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_HAVED_SALE, 0),
                      NVL(A.SY_AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_IN_PROCESS, 0), NVL(A.SY_AREA_ALLOW_SALE, 0), NVL(A.SY_AREA_STOCK, 0),
                      NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0), NVL(A.SY_AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.SY_AREA_NOT_COMPLETION, 0), NVL(A.SY_AREA_YES_COMPLETION, 0), NVL(A.SY_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_HAVED_SALE, 0),
                      NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0), NVL(A.AREA_STOCK, 0),
                      NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.AREA_NOT_SALE_PERMIT, 0), NVL(A.AREA_NOT_COMPLETION, 0),
                      NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PERIOD_ID;
            /*
            ------------------------------------------
            更新项目SY动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货值
                     A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货值
                      NVL(A.SY_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.SY_VALUE_HAVED_SALE, 0), NVL(A.SY_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_IN_PROCESS, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0),
                      NVL(A.SY_VALUE_STOCK, 0), NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0), NVL(A.SY_VALUE_NOT_COMPLETION, 0), NVL(A.SY_VALUE_YES_COMPLETION, 0), NVL(A.SY_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.VALUE_HAVED_SALE, 0), NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0),
                      NVL(A.VALUE_STOCK, 0), NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.VALUE_NOT_SALE_PERMIT, 0), NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PROJECT_ID;
            /*
            ------------------------------------------
            更新项目SY动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货量
                     A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货量
                      NVL(A.SY_AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_HAVED_SALE, 0),
                      NVL(A.SY_AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_IN_PROCESS, 0), NVL(A.SY_AREA_ALLOW_SALE, 0), NVL(A.SY_AREA_STOCK, 0),
                      NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0), NVL(A.SY_AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.SY_AREA_NOT_COMPLETION, 0), NVL(A.SY_AREA_YES_COMPLETION, 0), NVL(A.SY_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_HAVED_SALE, 0),
                      NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0), NVL(A.AREA_STOCK, 0),
                      NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.AREA_NOT_SALE_PERMIT, 0), NVL(A.AREA_NOT_COMPLETION, 0),
                      NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PROJECT_ID;
        ELSE
            NULL;
        END IF;

    END LOOP;
    CLOSE CUR_PERIOD_LIST;

    /*
    ----------------------------------------------------------------
        更新当前在可研阶段项目的动态货值、动态货量,动态货值计算公式：当前阶段业态的面积*业态最新均价
    ----------------------------------------------------------------
    */

    OPEN CUR_PROJECT_LIST;

    LOOP
      FETCH CUR_PROJECT_LIST
            INTO ITEM_PROJECT_LIST;
        EXIT WHEN CUR_PROJECT_LIST%NOTFOUND;
        --获取一级业态
        V_PRODUCT_TYPE := SUBSTR(ITEM_PROJECT_LIST.PRODUCT_TYPE_NAME, 0, INSTR(ITEM_PROJECT_LIST.PRODUCT_TYPE_NAME, '/', 1) - 1);
        V_IS_CARPORT := CASE
                            WHEN ITEM_PROJECT_LIST.PRODUCT_TYPE_JSON = '{"isCarport":1}' THEN
                             1
                            ELSE
                             0
                        END;
        --获取当前业态均价
        SELECT A.TARGET_A_ID INTO V_TARGET_WORTH_ID FROM DWM_DT_VALUE A WHERE A.OBJ_ID = ITEM_PROJECT_LIST.PROJECT_ID AND A.OBJ_TYPE = '项目';

        SELECT COUNT(1)
        INTO   V_COUNT
        FROM   DWM_TARGET_WORTH_DTL A
        WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_ID = ITEM_PROJECT_LIST.PRODUCT_TYPE_ID AND A.OBJ_PARENT_ID = ITEM_PROJECT_LIST.PROJECT_ID;

        IF V_COUNT = 1 THEN
            SELECT A.AVERAGE_PRICE
            INTO   V_PRICE
            FROM   DWM_TARGET_WORTH_DTL A
            WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_ID = ITEM_PROJECT_LIST.PRODUCT_TYPE_ID AND A.OBJ_PARENT_ID = ITEM_PROJECT_LIST.PROJECT_ID;
        ELSE
            V_PRICE := 0;
        END IF;

        IF V_PRODUCT_TYPE = '住宅' THEN

            /*
            ------------------------------------------
            更新项目ZZ动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --ZZ动态货值
                     A.ZZ_VALUE_DT_ALL, A.ZZ_VALUE_REMAIN, A.ZZ_VALUE_HAVED_SALE, A.ZZ_VALUE_RESERVE, A.ZZ_VALUE_IN_PROCESS, A.ZZ_VALUE_ALLOW_SALE, A.ZZ_VALUE_STOCK, A.ZZ_VALUE_NOT_PLANNING_PERMIT, A.ZZ_VALUE_NOT_CONSTRUCTION_PER, A.ZZ_VALUE_NOT_SALE_PERMIT, A.ZZ_VALUE_NOT_COMPLETION, A.ZZ_VALUE_YES_COMPLETION, A.ZZ_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --ZZ动态货值
                      NVL(A.ZZ_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.ZZ_VALUE_HAVED_SALE, 0), NVL(A.ZZ_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_VALUE_IN_PROCESS, 0), NVL(A.ZZ_VALUE_ALLOW_SALE, 0),
                      NVL(A.ZZ_VALUE_STOCK, 0), NVL(A.ZZ_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.ZZ_VALUE_NOT_SALE_PERMIT, 0), NVL(A.ZZ_VALUE_NOT_COMPLETION, 0), NVL(A.ZZ_VALUE_YES_SETTLEMENT, 0), NVL(A.ZZ_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.VALUE_HAVED_SALE, 0), NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0),
                      NVL(A.VALUE_STOCK, 0), NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.VALUE_NOT_SALE_PERMIT, 0), NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PROJECT_LIST.PROJECT_ID;
            /*
            ------------------------------------------
            更新项目ZZ动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --ZZ动态货量
                     A.ZZ_AREA_DT_ALL, A.ZZ_AREA_REMAIN, A.ZZ_AREA_HAVED_SALE, A.ZZ_AREA_RESERVE, A.ZZ_AREA_IN_PROCESS, A.ZZ_AREA_ALLOW_SALE, A.ZZ_AREA_STOCK, A.ZZ_AREA_NOT_PLANNING_PERMIT, A.ZZ_AREA_NOT_CONSTRUCTION_PER, A.ZZ_AREA_NOT_SALE_PERMIT, A.ZZ_AREA_NOT_COMPLETION, A.ZZ_AREA_YES_COMPLETION, A.ZZ_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --ZZ动态货量
                      NVL(A.ZZ_AREA_DT_ALL, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_AREA_REMAIN, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_AREA_HAVED_SALE, 0),
                      NVL(A.ZZ_AREA_RESERVE, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_AREA_IN_PROCESS, 0), NVL(A.ZZ_AREA_ALLOW_SALE, 0), NVL(A.ZZ_AREA_STOCK, 0),
                      NVL(A.ZZ_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_AREA_NOT_CONSTRUCTION_PER, 0), NVL(A.ZZ_AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.ZZ_AREA_NOT_COMPLETION, 0), NVL(A.ZZ_AREA_YES_COMPLETION, 0), NVL(A.ZZ_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_HAVED_SALE, 0),
                      NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0), NVL(A.AREA_STOCK, 0),
                      NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.AREA_NOT_COMPLETION, 0), NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PROJECT_LIST.PROJECT_ID;
        ELSIF V_PRODUCT_TYPE = '商办产业' THEN
            /*
            ------------------------------------------
            更新项目SY动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货值
                     A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货值
                      NVL(A.SY_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.SY_VALUE_HAVED_SALE, 0), NVL(A.SY_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_IN_PROCESS, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0),
                      NVL(A.SY_VALUE_STOCK, 0), NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0), NVL(A.SY_VALUE_NOT_COMPLETION, 0), NVL(A.SY_VALUE_YES_COMPLETION, 0), NVL(A.SY_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.VALUE_HAVED_SALE, 0), NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0),
                      NVL(A.VALUE_STOCK, 0), NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.VALUE_NOT_SALE_PERMIT, 0), NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PROJECT_LIST.PROJECT_ID;
            /*
            ------------------------------------------
            更新项目SY动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货量
                     A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货量
                      NVL(A.SY_AREA_DT_ALL, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_REMAIN, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_HAVED_SALE, 0),
                      NVL(A.SY_AREA_RESERVE, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_IN_PROCESS, 0), NVL(A.SY_AREA_ALLOW_SALE, 0), NVL(A.SY_AREA_STOCK, 0),
                      NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0), NVL(A.SY_AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.SY_AREA_NOT_COMPLETION, 0), NVL(A.SY_AREA_YES_COMPLETION, 0), NVL(A.SY_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_HAVED_SALE, 0),
                      NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0), NVL(A.AREA_STOCK, 0),
                      NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.AREA_NOT_COMPLETION, 0), NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PROJECT_LIST.PROJECT_ID;
        ELSIF V_PRODUCT_TYPE = '车位仓储' AND V_IS_CARPORT = 1 THEN
            /*
            ------------------------------------------
            更新项目CW动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --CW动态货值
                     A.CW_VALUE_DT_ALL, A.CW_VALUE_REMAIN, A.CW_VALUE_HAVED_SALE, A.CW_VALUE_RESERVE, A.CW_VALUE_IN_PROCESS, A.CW_VALUE_ALLOW_SALE, A.CW_VALUE_STOCK, A.CW_VALUE_NOT_PLANNING_PERMIT, A.CW_VALUE_NOT_CONSTRUCTION_PER, A.CW_VALUE_NOT_SALE_PERMIT, A.CW_VALUE_NOT_COMPLETION, A.CW_VALUE_YES_COMPLETION, A.CW_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --CW动态货值
                      NVL(A.CW_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                      NVL(A.CW_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_VALUE_HAVED_SALE, 0),
                      NVL(A.CW_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_VALUE_IN_PROCESS, 0), NVL(A.CW_VALUE_ALLOW_SALE, 0),
                      NVL(A.CW_VALUE_STOCK, 0), NVL(A.CW_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.CW_VALUE_NOT_SALE_PERMIT, 0), NVL(A.CW_VALUE_NOT_COMPLETION, 0), NVL(A.CW_VALUE_YES_COMPLETION, 0), NVL(A.CW_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                      NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.VALUE_HAVED_SALE, 0),
                      NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0), NVL(A.VALUE_STOCK, 0),
                      NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.VALUE_NOT_SALE_PERMIT, 0),
                      NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PROJECT_LIST.PROJECT_ID;
            /*
            ------------------------------------------
            更新项目CW动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --CW动态货量
                     A.CW_AREA_DT_ALL, A.CW_AREA_REMAIN, A.CW_AREA_HAVED_SALE, A.CW_AREA_RESERVE, A.CW_AREA_IN_PROCESS, A.CW_AREA_ALLOW_SALE, A.CW_AREA_STOCK, A.CW_AREA_NOT_PLANNING_PERMIT, A.CW_AREA_NOT_CONSTRUCTION_PER, A.CW_AREA_NOT_SALE_PERMIT, A.CW_AREA_NOT_COMPLETION, A.CW_AREA_YES_COMPLETION, A.CW_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --CW动态货量
                      NVL(A.CW_AREA_DT_ALL, 0) + NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_REMAIN, 0) + NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                      NVL(A.CW_AREA_HAVED_SALE, 0), NVL(A.CW_AREA_RESERVE, 0) + NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_IN_PROCESS, 0), NVL(A.CW_AREA_ALLOW_SALE, 0),
                      NVL(A.CW_AREA_STOCK, 0), NVL(A.CW_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.CW_AREA_NOT_SALE_PERMIT, 0), NVL(A.CW_AREA_NOT_COMPLETION, 0), NVL(A.CW_AREA_YES_COMPLETION, 0), NVL(A.CW_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                      NVL(A.AREA_HAVED_SALE, 0), NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0),
                      NVL(A.AREA_STOCK, 0), NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.AREA_NOT_SALE_PERMIT, 0), NVL(A.AREA_NOT_COMPLETION, 0), NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PROJECT_LIST.PROJECT_ID;
        ELSIF V_PRODUCT_TYPE = '车位仓储' AND V_IS_CARPORT = 0 THEN
            /*
            ------------------------------------------
            更新项目SY动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货值
                     A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货值
                      NVL(A.SY_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.SY_VALUE_HAVED_SALE, 0), NVL(A.SY_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_IN_PROCESS, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0),
                      NVL(A.SY_VALUE_STOCK, 0), NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0), NVL(A.SY_VALUE_NOT_COMPLETION, 0), NVL(A.SY_VALUE_YES_COMPLETION, 0), NVL(A.SY_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.VALUE_HAVED_SALE, 0), NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0),
                      NVL(A.VALUE_STOCK, 0), NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.VALUE_NOT_SALE_PERMIT, 0), NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PROJECT_LIST.PROJECT_ID;
            /*
            ------------------------------------------
            更新项目SY动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货量
                     A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货量
                      NVL(A.SY_AREA_DT_ALL, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_REMAIN, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_HAVED_SALE, 0),
                      NVL(A.SY_AREA_RESERVE, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_IN_PROCESS, 0), NVL(A.SY_AREA_ALLOW_SALE, 0), NVL(A.SY_AREA_STOCK, 0),
                      NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0), NVL(A.SY_AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.SY_AREA_NOT_COMPLETION, 0), NVL(A.SY_AREA_YES_COMPLETION, 0), NVL(A.SY_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_HAVED_SALE, 0),
                      NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0), NVL(A.AREA_STOCK, 0),
                      NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.AREA_NOT_COMPLETION, 0), NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PROJECT_LIST.PROJECT_ID;
        ELSIF V_PRODUCT_TYPE = '配套设施' THEN
            /*
            ------------------------------------------
            更新项目SY动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货值
                     A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货值
                      NVL(A.SY_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.SY_VALUE_HAVED_SALE, 0), NVL(A.SY_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_IN_PROCESS, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0),
                      NVL(A.SY_VALUE_STOCK, 0), NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0), NVL(A.SY_VALUE_NOT_COMPLETION, 0), NVL(A.SY_VALUE_YES_COMPLETION, 0), NVL(A.SY_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.VALUE_HAVED_SALE, 0), NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0),
                      NVL(A.VALUE_STOCK, 0), NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.VALUE_NOT_SALE_PERMIT, 0), NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PROJECT_LIST.PROJECT_ID;
            /*
            ------------------------------------------
            更新项目SY动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货量
                     A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货量
                      NVL(A.SY_AREA_DT_ALL, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_REMAIN, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_HAVED_SALE, 0),
                      NVL(A.SY_AREA_RESERVE, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_IN_PROCESS, 0), NVL(A.SY_AREA_ALLOW_SALE, 0), NVL(A.SY_AREA_STOCK, 0),
                      NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0), NVL(A.SY_AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.SY_AREA_NOT_COMPLETION, 0), NVL(A.SY_AREA_YES_COMPLETION, 0), NVL(A.SY_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_HAVED_SALE, 0),
                      NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0), NVL(A.AREA_STOCK, 0),
                      NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.AREA_NOT_COMPLETION, 0), NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PROJECT_LIST.PROJECT_ID;
        ELSE
            NULL;
        END IF;

    END LOOP;
    CLOSE CUR_PROJECT_LIST;

    COMMIT;


/*
异常处理部分
*/
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        DBMS_OUTPUT.PUT_LINE('【目标货值取数异常】' || ITEM_BLD_LIST.ID || '事务已回退');
        ROLLBACK;
    WHEN TOO_MANY_ROWS THEN
        DBMS_OUTPUT.PUT_LINE('【返回多行数据】' || ITEM_BLD_LIST.ID || '事务已回退');
        ROLLBACK;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_GET_OBJ_INFO
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_GET_OBJ_INFO" AS
BEGIN
    /*
    ------------------------------------------------------------
    DWM_DT_VALUE数据生成
    */

    INSERT INTO DWM_DT_VALUE
        (ID, OBJ_ID, OBJ_NAME, OBJ_TYPE, OBJ_IS_PARKING, OBJ_IS_SALE, OBJ_IS_HOLD, OBJ_LEVEL, PARENT_ID, PROJ_ID)
        SELECT GET_UUID, A.ID, A.BUILD_NAME, '楼栋', NULL, NULL, NULL, 3, A.PERIOD_ID, A.PROJ_ID
        FROM   MDM_BUILD A
        WHERE  NOT EXISTS (SELECT 1 FROM DWM_DT_VALUE P WHERE A.ID = P.OBJ_ID AND P.OBJ_TYPE = '楼栋') AND A.BUILD_STATE = 10;
    COMMIT;

    INSERT INTO DWM_DT_VALUE
        (ID, OBJ_ID, OBJ_NAME, OBJ_TYPE, OBJ_LEVEL, PARENT_ID, PROJ_ID)
        SELECT GET_UUID, A.ID, A.PROJECT_NAME, '项目', 1, NULL, A.ID
        FROM   MDM_PROJECT A
        WHERE  NOT EXISTS (SELECT 1 FROM DWM_DT_VALUE P WHERE A.ID = P.OBJ_ID AND P.OBJ_TYPE = '项目') AND A.APPROVAL_STATUS = '已审核' AND
               A.PROJECT_VERSION = (SELECT MAX(PROJECT_VERSION) FROM MDM_PROJECT O WHERE O.PROJECT_ORIGINAL_ID = A.PROJECT_ORIGINAL_ID AND O.APPROVAL_STATUS = '已审核');
    COMMIT;

    INSERT INTO DWM_DT_VALUE
        (ID, OBJ_ID, OBJ_NAME, OBJ_TYPE, OBJ_LEVEL, PARENT_ID, PROJ_ID)
        SELECT GET_UUID, C.ID, C.PERIOD_NAME, '分期', 2, A.ID, A.ID
        FROM   MDM_PROJECT A
        INNER  JOIN MDM_PERIOD_VERSION B
        ON     A.ID = B.PROJECT_ID AND B.PERIOD_VERSION = (SELECT MAX(P.PERIOD_VERSION) FROM MDM_PERIOD_VERSION P WHERE B.PROJECT_ID = P.PROJECT_ID AND P.APPROVAL_STATUS = '已审核')
        INNER  JOIN MDM_PERIOD C
        ON     B.ID = C.PERIOD_VERSION_ID
        WHERE  NOT EXISTS (SELECT 1 FROM DWM_DT_VALUE O WHERE O.OBJ_ID = C.ID);

    /*
    ------------------------------------------------------------
    MDM_ROOM表数据生成
    */

    UPDATE MDM_ROOM_BAK A SET A.BUILDING_ID = REPLACE(A.BUILDING_ID, ' ', '');
    COMMIT;

    --删除本次需要更新的房源
    DELETE FROM MDM_ROOM A WHERE EXISTS (SELECT 1 FROM MDM_ROOM_BAK P WHERE P.ID = A.ID);
    --插入本次新同步的房源数据
    INSERT INTO MDM_ROOM
        (ID, ROOM_NAME, ROOM_CODE, PRODUCT_CODE, PRODUCT_NAME, PRODUCT_IS_CW, PROJECT_ID, PROJECT_CODE, PROJECT_NAME, BUILDING_ID, BUILDING_NAME, UNIT_ID, UNIT_NAME, FLOOR_ID, FLOOR_NAME, SALE_STATE,
         PRE_BLD_AREA, PRE_IN_AREA, ACTUAL_BLD_AREA, ACTUAL_IN_AREA, NEW_BLD_AREA, NEW_IN_AREA, PRE_SELL_PERMIT_ID, PRE_SELL_PERMIT_NO, PRE_SELL_PERMIT_DATE, BASE_PRICE, BASE_TOTAL,
         BASE_TOTAL_AREA_TYPE, BZ_PRICE, BZ_TOTAL, BZ_TOTAL_AREA_TYPE, TRADE_PRICE, TRADE_TOTAL, TRADE_TOTAL_AREA_TYPE, TRADE_CONTRACT_DATE, IS_AREA_BC, PRE_AFTER_BC_TOTAL, ACTUAL_AFTER_BC_TOTAL,
         IS_TRANSFER, PRE_TRANSFER_DATE, ACTUAL_TRANSFER_DATE, IS_INDIRECT, ACTUAL_INDIRECT_DATE, ACTUAL_INDIRECT_TOTAL, ACTUAL_INDIRECT_AREA)
        SELECT A.ID, A.ROOM_NAME, A.ROOM_CODE, A.PRODUCT_CODE, A.PRODUCT_NAME, A.PRODUCT_IS_CW, A.PROJECT_ID, A.PROJECT_CODE, A.PROJECT_NAME, B.ID, A.BUILDING_NAME, A.UNIT_ID, A.UNIT_NAME, A.FLOOR_ID,
               A.FLOOR_NAME, A.SALE_STATE, A.PRE_BLD_AREA, A.PRE_IN_AREA, A.ACTUAL_BLD_AREA, A.ACTUAL_IN_AREA, A.NEW_BLD_AREA, A.NEW_IN_AREA, A.PRE_SELL_PERMIT_ID, A.PRE_SELL_PERMIT_NO,
               A.PRE_SELL_PERMIT_DATE, A.BASE_PRICE, A.BASE_TOTAL, A.BASE_TOTAL_AREA_TYPE, A.BZ_PRICE, A.BZ_TOTAL, A.BZ_TOTAL_AREA_TYPE, A.TRADE_PRICE, A.TRADE_TOTAL, A.TRADE_TOTAL_AREA_TYPE,
               A.TRADE_CONTRACT_DATE, A.IS_AREA_BC, A.PRE_AFTER_BC_TOTAL, A.ACTUAL_AFTER_BC_TOTAL, A.IS_TRANSFER, A.PRE_TRANSFER_DATE, A.ACTUAL_TRANSFER_DATE, A.IS_INDIRECT, A.ACTUAL_INDIRECT_DATE,
               A.ACTUAL_INDIRECT_TOTAL, A.ACTUAL_INDIRECT_AREA
        /*    SELECT COUNT(1)*/
        FROM   MDM_ROOM_BAK A
        INNER  JOIN (SELECT ROW_NUMBER() OVER(PARTITION BY LOWER(M.R_BUILD_ID) ORDER BY M.ID) AS NUM, M.ID, M.R_BUILD_ID FROM MDM_BUILD M) B
        ON     LOWER(A.BUILDING_ID) = LOWER(B.R_BUILD_ID) AND B.NUM = 1
        WHERE  NOT EXISTS (SELECT 1 FROM MDM_ROOM P WHERE P.ID = A.ID);

    COMMIT;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_GET_OBJ_TARGET_VALUE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_GET_OBJ_TARGET_VALUE" AS
    /*
      CreateBy:Wangck
      CreateDate:20200406
      Note:更新DWM_DT_VALUE表中“项目、分期、楼栋”的目标货值
    */
    CURSOR CUR_OBJ_LIST IS
        SELECT A.* FROM DWM_DT_VALUE A ;

    ITEM_OBJ_LIST CUR_OBJ_LIST%ROWTYPE;

    V_TARGET_ID VARCHAR(50);
    V_OBJ_TYPE  VARCHAR(100);
    V_TARGET_VALUE NUMBER(20,4);
    V_COUNT     NUMBER(10, 0); -- 记数器

BEGIN

    --更新可研版目标货值

    OPEN CUR_OBJ_LIST;
    LOOP
        FETCH CUR_OBJ_LIST
            INTO ITEM_OBJ_LIST;
        EXIT WHEN CUR_OBJ_LIST%NOTFOUND;
        --DBMS_OUTPUT.PUT_LINE(ITEM_OBJ_LIST.ID);
        IF ITEM_OBJ_LIST.OBJ_TYPE = '项目' THEN
            --处理项目的动态货值相关数据

            --可研目标货值ID更新
            UPDATE DWM_DT_VALUE A
            SET    (A.TARGET_A1_ID, A.TARGET_A1_VALUE) =
                    (SELECT P.ID, P.TARGET_WORTH FROM DWM_TARGET_WORTH P WHERE P.PROJ_ID = A.OBJ_ID AND P.TARGET_WORTH_PHASE = 0 AND P.IS_DELETE = 0 AND P.APPROVAL_STATUS = '已审核')
            WHERE  A.ID = ITEM_OBJ_LIST.ID;

            --全盘目标货值ID更新
            UPDATE DWM_DT_VALUE A
            SET    (A.TARGET_A2_ID, A.TARGET_A2_VALUE) =
                    (SELECT P.ID, P.TARGET_WORTH FROM DWM_TARGET_WORTH P WHERE P.PROJ_ID = A.OBJ_ID AND P.TARGET_WORTH_PHASE = 10 AND P.IS_DELETE = 0 AND P.APPROVAL_STATUS = '已审核')
            WHERE  A.ID = ITEM_OBJ_LIST.ID;

            --动态版目标货值数据更新
            UPDATE DWM_DT_VALUE A
            SET    (A.TARGET_A3_ID, A.TARGET_A3_VALUE) =
                    (SELECT P.ID, P.TARGET_WORTH
                     FROM   DWM_TARGET_WORTH P
                     WHERE  P.PROJ_ID = A.OBJ_ID AND P.TARGET_WORTH_PHASE = 20 AND
                            P.WORTH_V = (SELECT MAX(O.WORTH_V) FROM DWM_TARGET_WORTH O WHERE O.PROJ_ID = P.PROJ_ID AND O.TARGET_WORTH_PHASE = 20 AND O.APPROVAL_STATUS = '已审核' AND O.IS_DELETE = 0) AND P.IS_DELETE = 0)
            WHERE  A.ID = ITEM_OBJ_LIST.ID;



            --最新版目标货值更新
            SELECT NVL(A.TARGET_A3_ID, ''),NVL(A.TARGET_A3_VALUE,0) INTO V_TARGET_ID,V_TARGET_VALUE FROM DWM_DT_VALUE A WHERE A.ID = ITEM_OBJ_LIST.ID;
            IF LENGTH(V_TARGET_ID) <> 0 THEN
                UPDATE DWM_DT_VALUE A SET A.TARGET_NOW_NAME = 20, A.TARGET_A_ID = V_TARGET_ID,A.TARGET_A_VALUE =V_TARGET_VALUE  WHERE A.ID = ITEM_OBJ_LIST.ID;
            ELSE
                SELECT NVL(A.TARGET_A2_ID, ''),NVL(A.TARGET_A2_VALUE,0) INTO V_TARGET_ID,V_TARGET_VALUE FROM DWM_DT_VALUE A WHERE A.ID = ITEM_OBJ_LIST.ID;
                IF LENGTH(V_TARGET_ID) <> 0 THEN
                    UPDATE DWM_DT_VALUE A SET A.TARGET_NOW_NAME = 10, A.TARGET_A_ID = V_TARGET_ID,A.TARGET_A_VALUE = V_TARGET_VALUE WHERE A.ID = ITEM_OBJ_LIST.ID;
                ELSE
                    SELECT NVL(A.TARGET_A1_ID, ''),NVL(A.TARGET_A1_VALUE,0) INTO V_TARGET_ID,V_TARGET_VALUE FROM DWM_DT_VALUE A WHERE A.ID = ITEM_OBJ_LIST.ID;
                    IF LENGTH(V_TARGET_ID) <> 0 THEN
                        UPDATE DWM_DT_VALUE A SET A.TARGET_NOW_NAME = 0, A.TARGET_A_ID = V_TARGET_ID,A.TARGET_A_VALUE=V_TARGET_VALUE WHERE A.ID = ITEM_OBJ_LIST.ID;
                    ELSE
                        UPDATE DWM_DT_VALUE A SET A.TARGET_NOW_NAME = NULL, A.TARGET_A_ID = NULL,A.TARGET_A_VALUE = NULL WHERE A.ID = ITEM_OBJ_LIST.ID;
                    END IF;
                END IF;
            END IF;

        ELSIF ITEM_OBJ_LIST.OBJ_TYPE = '楼栋' THEN
            --处理楼栋的数据
            UPDATE DWM_DT_VALUE A
            SET    (A.TARGET_A_ID, A.TARGET_A1_ID, A.TARGET_A2_ID, TARGET_A3_ID) =
                    (SELECT P.TARGET_A_ID, P.TARGET_A1_ID, P.TARGET_A2_ID, P.TARGET_A3_ID FROM DWM_DT_VALUE P WHERE P.OBJ_ID = A.PROJ_ID AND P.OBJ_TYPE = '项目')
            WHERE  A.ID = ITEM_OBJ_LIST.ID;

            UPDATE DWM_DT_VALUE A
            SET (A.TARGET_A_VALUE) =
            (SELECT P.WORTH
            FROM DWM_TARGET_WORTH_DTL P  WHERE P.TARGET_WORTH_ID = A.TARGET_A_ID AND P.OBJ_ID = A.OBJ_ID AND P.OBJ_TYPE = 30)
            WHERE A.ID = ITEM_OBJ_LIST.ID;

            UPDATE DWM_DT_VALUE A
            SET (A.TARGET_A1_VALUE) =
            (SELECT P.WORTH
            FROM DWM_TARGET_WORTH_DTL P  WHERE P.TARGET_WORTH_ID = A.TARGET_A1_ID AND P.OBJ_ID = A.OBJ_ID AND P.OBJ_TYPE = 30)
            WHERE A.ID = ITEM_OBJ_LIST.ID;

            UPDATE DWM_DT_VALUE A
            SET (A.TARGET_A2_VALUE) =
            (SELECT P.WORTH
            FROM DWM_TARGET_WORTH_DTL P  WHERE P.TARGET_WORTH_ID = A.TARGET_A2_ID AND P.OBJ_ID = A.OBJ_ID AND P.OBJ_TYPE = 30)
            WHERE A.ID = ITEM_OBJ_LIST.ID;

             UPDATE DWM_DT_VALUE A
            SET (A.TARGET_A3_VALUE) =
            (SELECT P.WORTH
            FROM DWM_TARGET_WORTH_DTL P  WHERE P.TARGET_WORTH_ID = A.TARGET_A3_ID AND P.OBJ_ID = A.OBJ_ID AND P.OBJ_TYPE = 30)
            WHERE A.ID = ITEM_OBJ_LIST.ID;


        ELSIF ITEM_OBJ_LIST.OBJ_TYPE = '分期' THEN
            --处理分期的数据
            UPDATE DWM_DT_VALUE A
            SET    (A.TARGET_A_ID, A.TARGET_A1_ID, A.TARGET_A2_ID, TARGET_A3_ID) =
                    (SELECT P.TARGET_A_ID, P.TARGET_A1_ID, P.TARGET_A2_ID, P.TARGET_A3_ID FROM DWM_DT_VALUE P WHERE P.OBJ_ID = A.PROJ_ID AND P.OBJ_TYPE = '项目')
            WHERE  A.ID = ITEM_OBJ_LIST.ID;

            UPDATE DWM_DT_VALUE A
            SET (A.TARGET_A_VALUE) =
            (SELECT P.WORTH
            FROM DWM_TARGET_WORTH_DTL P  WHERE P.TARGET_WORTH_ID = A.TARGET_A_ID AND P.OBJ_ID = A.OBJ_ID AND P.OBJ_TYPE = 20)
            WHERE A.ID = ITEM_OBJ_LIST.ID;

            UPDATE DWM_DT_VALUE A
            SET (A.TARGET_A1_VALUE) =
            (SELECT P.WORTH
            FROM DWM_TARGET_WORTH_DTL P  WHERE P.TARGET_WORTH_ID = A.TARGET_A1_ID AND P.OBJ_ID = A.OBJ_ID AND P.OBJ_TYPE = 20)
            WHERE A.ID = ITEM_OBJ_LIST.ID;

            UPDATE DWM_DT_VALUE A
            SET (A.TARGET_A2_VALUE) =
            (SELECT P.WORTH
            FROM DWM_TARGET_WORTH_DTL P  WHERE P.TARGET_WORTH_ID = A.TARGET_A2_ID AND P.OBJ_ID = A.OBJ_ID AND P.OBJ_TYPE = 20)
            WHERE A.ID = ITEM_OBJ_LIST.ID;

             UPDATE DWM_DT_VALUE A
            SET (A.TARGET_A3_VALUE) =
            (SELECT P.WORTH
            FROM DWM_TARGET_WORTH_DTL P  WHERE P.TARGET_WORTH_ID = A.TARGET_A3_ID AND P.OBJ_ID = A.OBJ_ID AND P.OBJ_TYPE = 20)
            WHERE A.ID = ITEM_OBJ_LIST.ID;

        END IF;

    END LOOP;

    COMMIT;
    CLOSE CUR_OBJ_LIST;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_GLOBAL_WORK_AMOUNT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_GLOBAL_WORK_AMOUNT" (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
     unitid         IN             VARCHAR2, --选择公司id
    projectid      IN             VARCHAR2,--项目id()
    info           OUT            SYS_REFCURSOR
) AS
--动态货值管理-全案动态货值
--作者：陈丽
--日期：2019/12/17
 P_ID VARCHAR2(36) :='3e7507a3-b76a-48c5-bd81-2820958ed919';
BEGIN
--  P_ID :=projectid;
   SELECT t.ID INTO P_ID  FROM  Mdm_Project t WHERE t.project_Name='佛山领秀公馆（南区）' AND t.is_delete=0;
    OPEN info FOR

SELECT
  b.OBJ_ID AS ID,
  null AS PARENT_ID,
  ''  AS WORK_CODE,
  NVL(b.obj_name,'XX项目') AS WORK_NAME,      -- 项目/分期/业态/楼栋
  to_char(b.AREA_DT_ALL,'999,999,999,999,999.99') AS RECENT_FLOORAGE_AREA,              -- 最新建筑面积
  to_char(b.AREA_DT_ALL,'999,999,999,999,999.99') AS RECENT_SALE_AREA,                  -- 最新可售面积
  to_char(c1.target_worth,'999,999,999,999,999.99') AS FIRST_PHASE,                       -- 可研版(A1)
  to_char(c2.target_worth,'999,999,999,999,999.99')  AS NEXT_PHASE,                        -- 全盘版(A2)
  to_char(c3.target_worth,'999,999,999,999,999.99')  AS ACT_PHASE,                         -- 动态版(A3)
  to_char(c9.target_worth,'999,999,999,999,999.99')  AS RECENT_AREA,                       -- 最新版(A)


  to_char(b.VALUE_DT_ALL/10000,'999,999,999,999,999.99') AS TOTAL_GLOBAL_WORK_VALUE,           -- 动态总货值(B)
  to_char((c9.target_worth-b.VALUE_DT_ALL)/10000,'999,999,999,999,999.99') AS TOTAL_WORK_VALUE_MINUS,            -- 总货值差额(B-A)
  to_char(b.VALUE_RESERVE/10000,'999,999,999,999,999.99') AS STORE_VALUE,                       -- 储备货值(B1)
  to_char(b.VALUE_IN_PROCESS/10000,'999,999,999,999,999.99') AS TRANSIT_VALUE,                     -- 在途货值(B2)
  to_char(b.VALUE_STOCK/10000,'999,999,999,999,999.99') AS REPERTORY_VALUE,                   -- 库存货值(B3)
  to_char(b.VALUE_HAVED_SALE/10000,'999,999,999,999,999.99') AS SALE_VALUE,                        -- 已售货值(B4)
  to_char(b.VALUE_REMAIN/10000,'999,999,999,999,999.99') AS REMAIN_VALUE,                      -- 剩余货值(C=B1+B2+B3)
  to_char(b.VALUE_ALLOW_SALE/10000,'999,999,999,999,999.99') AS HOLD_VALUE,                        -- 已领证货值(D=B3+B4)
  to_char((CASE WHEN b.VALUE_ALLOW_SALE=0 THEN 0 ELSE b.VALUE_HAVED_SALE/b.VALUE_ALLOW_SALE*100 END)
                ,'999,999,999,999,999.99') AS RID_RATE,                          -- 去化率(E=B4/D)

  to_char(b.AREA_DT_ALL/10000,'999,999,999,999,999.99') AS NO_PLAN_PERMIT,                    -- F0未取规证
  to_char(b.AREA_DT_ALL/10000,'999,999,999,999,999.99') AS PLAN_PERMIT_PHASE,                 -- F1规划许可证阶段
  to_char(b.AREA_DT_ALL/10000,'999,999,999,999,999.99') AS CONSTRUCTION_PERMIT_PHASE,         -- F2施工许可证阶段
  to_char(b.AREA_DT_ALL/10000,'999,999,999,999,999.99') AS PRE_SALE_PERMIT_PHASE,             -- F3预售许可证阶段
  to_char(b.AREA_DT_ALL/10000,'999,999,999,999,999.99') AS COMPLETED_PERMIT_PHASE,            -- F4竣工备案阶段
  to_char(b.AREA_DT_ALL/10000,'999,999,999,999,999.99') AS CARRY_FORWARD_PHASE                -- F5结转阶段

FROM   dual a
LEFT JOIN dwm_dt_value b ON 1=1 AND b.obj_type='项目' --AND b.obj_id=P_ID --AND b.is_delete=0
LEFT JOIN dwm_target_worth c1 ON b.obj_id=c1.proj_id AND c1.target_worth_phase=0 AND c1.APPROVAL_STATUS = '已审核'
LEFT JOIN dwm_target_worth c2 ON b.obj_id=c2.proj_id AND c2.target_worth_phase=10 AND c2.APPROVAL_STATUS = '已审核'
LEFT JOIN dwm_target_worth c3 ON b.obj_id=c3.proj_id AND c3.target_worth_phase=20 AND c3.APPROVAL_STATUS = '已审核'
LEFT JOIN dwm_target_worth c9 ON b.obj_id=c9.proj_id AND c9.target_worth_phase=20 AND c9.APPROVAL_STATUS = '已审核'
LEFT JOIN MDM_PROJECT d on b.obj_id=d.id and d.is_delete=0

ORDER BY d.PROJECT_CODE
;

END p_dwm_global_work_amount;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_GLOBAL_WORK_VALUE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_GLOBAL_WORK_VALUE" (
  userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    unitid         IN             VARCHAR2, --选择公司id
    projectid      IN             VARCHAR2,--项目id()
    info           OUT            SYS_REFCURSOR) AS
--动态货值管理-全案动态货量
--作者：陈丽
--日期：2019/12/17

/*
SELECT
  '1' AS "编码",
  '1' AS  "分期/业态/楼栋" ,
  '1' AS "最新建筑面积" ,
  '1' AS "最新可售面积" ,
  '1' AS "动态货量" ,
  '1' AS "A1" ,
  '1' AS "A2" ,
  '1' AS "A3" ,
  '1' AS "1_" ,
  '1' AS "2_" ,
  '1' AS "3_" ,
  '1' AS "货量(a)" , A2
  '1' AS "均价(b)" , A2
  '1' AS "货值(c)" , A2
  '1' AS 货量(a) , A3
  '1' AS 均价(b) , A3
  '1' AS 货值(c) , A3
  '1' AS 0未取规证 ,
  '1' AS 1规划许可证阶段 ,
  '1'AS 2施工许可证阶段 ,
  '1' AS 3预售许可证阶段 ,
  '1' AS 4竣工备案阶段 ,
  '1' AS 5结转阶段 ,

FROM
  dual  ;
*/
/*
id  主键
parentId  父
workCode  编码
workName  期/业态/楼栋
recentFloorageArea  最新建筑面积
recentSaleArea  最新可售面积
globalWorkValue 动态货量
noPushValue A1未推货量
noSaleValue A2已推未售货量
saleValue A3已批准已售货量
noPlanPermit  1_未拿规证
holdPlanPermit  2_已拿规证
holdConstructionPermit  3_已经施证
workValueOne  货量(a)
averageValueOne 均价(b)
workAmountOne 货值(c)
workValueTwo  货量(a)
averageValueTwo 均价(b)
workAmountTwo 货值(c)
noSavePlanPermit  0未取规证
planPermitPhase 1规划许可证阶段
constructionPermitPhase 2施工许可证阶段
preSalePermitPhase  3预售许可证阶段
completedPermitPhase  4竣工备案阶段
carryForwardPhase 5结转阶段

*/
 P_ID VARCHAR2(36) :='3e7507a3-b76a-48c5-bd81-2820958ed919';


BEGIN
--  P_ID :=projectid;
SELECT T.ID
INTO   P_ID
FROM   MDM_PROJECT T
WHERE  T.PROJECT_NAME = '佛山领秀公馆（南区）' AND
			 T.IS_DELETE = 0;
OPEN INFO FOR
--  P_ID   :='3e7507a3-b76a-48c5-bd81-2820958ed919';
		SELECT C.PROJECT_CODE AS ID, '' AS PARENT_ID,
					 C.PROJECT_CODE AS WORK_CODE,
            NVL(B.OBJ_NAME, 'XX项目') AS WORK_NAME,

					 TO_CHAR(B.AREA_DT_ALL, '999,999,999,999,999.99') AS RECENT_FLOORAGE_AREA,
						--  最新建筑面积
					 TO_CHAR(B.AREA_DT_ALL, '999,999,999,999,999.99') AS RECENT_SALE_AREA,
						-- 最新可售面积
					 TO_CHAR(B.AREA_REMAIN + B.AREA_HAVED_SALE + B.AREA_STOCK,
										'999,999,999,999,999.99') AS GLOBAL_WORK_VALUE,
						--      动态货量
					 -- to_char(b.AREA_DT_ALL,'999,999,999,999,999.99') AS GLOBAL_WORK_VALUE, --      动态货量
					 TO_CHAR(B.AREA_REMAIN, '999,999,999,999,999.99') AS NO_PUSH_VALUE,
						-- A1未推货量
					 TO_CHAR(B.AREA_HAVED_SALE, '999,999,999,999,999.99') AS NO_SALE_VALUE,
						-- A2已推未售货量
					 TO_CHAR(B.AREA_STOCK, '999,999,999,999,999.99') AS SALE_VALUE,
						-- A3已推已售货量

					 TO_CHAR(B.AREA_NOT_PLANNING_PERMIT, '999,999,999,999,999.99') AS NO_PLAN_PERMIT,
						-- 未推货量分布1_未拿规证
					 TO_CHAR(B.AREA_NOT_CONSTRUCTION_PERMIT, '999,999,999,999,999.99') AS HOLD_PLAN_PERMIT,
						-- 未推货量分布2_已拿规证
					 TO_CHAR(B.AREA_NOT_SALE_PERMIT, '999,999,999,999,999.99') AS HOLD_CONSTRUCTION_PERMIT,
						-- 未推货量分布3_已取施证

					 TO_CHAR(B.AREA_HAVED_SALE, '999,999,999,999,999.99') AS WORK_VALUE_ONE,
						-- 已推已售情况_货量(a)
					 TO_CHAR((CASE
											 WHEN AREA_HAVED_SALE = 0 THEN
												0
											 ELSE
												B.VALUE_HAVED_SALE / B.AREA_HAVED_SALE
									 END), '999,999,999,999,999.99') AS AVERAGE_VALUE_ONE,
						-- 已推已售情况_均价(b)
					 TO_CHAR(B.VALUE_HAVED_SALE / 10000, '999,999,999,999,999.99') AS WORK_AMOUNT_ONE,
						-- 已推已售情况_货值(c)

					 TO_CHAR(B.AREA_STOCK, '999,999,999,999,999.99') AS WORK_VALUE_TWO,
						-- 已推未售情况_货量(a)
					 TO_CHAR((CASE
											 WHEN AREA_STOCK = 0 THEN
												0
											 ELSE
												B.VALUE_STOCK / B.AREA_STOCK
									 END), '999,999,999,999,999.99') AS AVERAGE_VALUE_TWO,
						-- 已推未售情况_均价(b)
					 TO_CHAR(B.VALUE_STOCK / 10000, '999,999,999,999,999.99') AS WORK_AMOUNT_TWO,
						-- 已推未售情况_货值(c)

					 TO_CHAR(B.AREA_NOT_PLANNING_PERMIT, '999,999,999,999,999.99') AS NO_SAVE_PLAN_PERMIT,
						--0未取规证
					 TO_CHAR(B.AREA_NOT_CONSTRUCTION_PERMIT, '999,999,999,999,999.99') AS PLAN_PERMIT_PHASE,
						-- 1规划许可证阶段
					 TO_CHAR(B.AREA_NOT_SALE_PERMIT, '999,999,999,999,999.99') AS CONSTRUCTION_PERMIT_PHASE,
						-- 2施工许可证阶段
					 TO_CHAR(B.AREA_NOT_COMPLETION, '999,999,999,999,999.99') AS PRE_SALE_PERMIT_PHASE,
						-- 3预售许可证阶段
					 TO_CHAR(B.AREA_YES_COMPLETION, '999,999,999,999,999.99') AS COMPLETED_PERMIT_PHASE,
						-- 4竣工备案阶段
					 TO_CHAR(B.AREA_YES_SETTLEMENT, '999,999,999,999,999.99') AS CARRY_FORWARD_PHASE -- 5结转阶段
		FROM   DUAL A
		LEFT   JOIN DWM_DT_VALUE B
		ON     1 = 1 AND
					 B.OBJ_TYPE = '项目' -- AND b.obj_id=P_ID --AND b.is_delete=0
		LEFT   JOIN MDM_PROJECT C
		ON     B.OBJ_ID = C.ID AND
					 C.IS_DELETE = 0
		ORDER  BY C.PROJECT_CODE

		/*

      -- 楼栋
    UNION ALL
    SELECT
      to_char(ROWNUM+1) AS ID,
      '1' AS PARENT_ID,
      to_char(ROWNUM)AS WORK_CODE,
      b.obj_name AS WORK_NAME,

           to_char(b.AREA_DT_ALL,'999,999,999,999,999.99')  AS RECENT_FLOORAGE_AREA,      --  最新建筑面积
           to_char(b.AREA_DT_ALL,'999,999,999,999,999.99') AS RECENT_SALE_AREA, -- 最新可售面积
            to_char(b.AREA_DT_ALL,'999,999,999,999,999.99') AS GLOBAL_WORK_VALUE, --      动态货量
            to_char(b.AREA_RESERVE+b.area_in_process,'999,999,999,999,999.99') AS NO_PUSH_VALUE,  -- A1未推货量
            to_char(b.AREA_STOCK,'999,999,999,999,999.99') AS NO_SALE_VALUE,            -- A2已推未售货量
            to_char(b.AREA_HAVED_SALE,'999,999,999,999,999.99') AS SALE_VALUE,               -- A3已推已售货量

            to_char(b.AREA_NOT_PLANNING_PERMIT,'999,999,999,999,999.99') AS NO_PLAN_PERMIT,           -- 未推货量分布1_未拿规证
            to_char(b.AREA_NOT_CONSTRUCTION_PERMIT,'999,999,999,999,999.99') AS HOLD_PLAN_PERMIT,         -- 未推货量分布2_已拿规证
            to_char(b.AREA_NOT_SALE_PERMIT,'999,999,999,999,999.99') AS HOLD_CONSTRUCTION_PERMIT, -- 未推货量分布3_已取施证

            to_char(b.AREA_HAVED_SALE,'999,999,999,999,999.99') AS WORK_VALUE_ONE,           -- 已推已售情况_货量(a)
            to_char((CASE WHEN AREA_HAVED_SALE=0 THEN 0 ELSE b.VALUE_HAVED_SALE/b.AREA_HAVED_SALE END ),'999,999,999,999,999.99') AS AVERAGE_VALUE_ONE,        -- 已推已售情况_均价(b)
            to_char(b.VALUE_HAVED_SALE/10000,'999,999,999,999,999.99') AS WORK_AMOUNT_ONE,          -- 已推已售情况_货值(c)

            to_char(b.AREA_STOCK,'999,999,999,999,999.99') AS WORK_VALUE_TWO,           -- 已推未售情况_货量(a)
            to_char((CASE WHEN AREA_STOCK=0 THEN 0 ELSE b.VALUE_STOCK/b.AREA_STOCK END ),'999,999,999,999,999.99') AS AVERAGE_VALUE_TWO,        -- 已推未售情况_均价(b)
            to_char(b.VALUE_STOCK/10000,'999,999,999,999,999.99') AS WORK_AMOUNT_TWO,          -- 已推未售情况_货值(c)

            to_char(b.AREA_NOT_PLANNING_PERMIT,'999,999,999,999,999.99') AS NO_SAVE_PLAN_PERMIT,      --0未取规证
            to_char(b.AREA_NOT_CONSTRUCTION_PERMIT,'999,999,999,999,999.99') AS PLAN_PERMIT_PHASE,        -- 1规划许可证阶段
            to_char(b.AREA_NOT_SALE_PERMIT,'999,999,999,999,999.99') AS CONSTRUCTION_PERMIT_PHASE,   -- 2施工许可证阶段
            to_char(b.AREA_NOT_COMPLETION,'999,999,999,999,999.99') AS PRE_SALE_PERMIT_PHASE,       -- 3预售许可证阶段
            to_char(b.AREA_YES_COMPLETION,'999,999,999,999,999.99') AS COMPLETED_PERMIT_PHASE,      -- 4竣工备案阶段
            to_char(b.AREA_YES_SETTLEMENT,'999,999,999,999,999.99') AS CARRY_FORWARD_PHASE          -- 5结转阶段
    FROM   dual a
    LEFT JOIN dwm_dt_value b ON 1=1 AND b.obj_id IN (SELECT t.id FROM mdm_build t WHERE t.proj_id=P_ID) --AND b.is_delete=0
    AND ROWNUM=1
    --ORDER BY b.obj_name
    */

		/*
      UNION ALL
    SELECT
      '3' AS ID,
      '2' AS PARENT_ID,
      '1' AS WORK_CODE,
      '1#' AS WORK_NAME,
      '1' AS RECENT_FLOORAGE_AREA,
      '1' AS RECENT_SALE_AREA,
      '1' AS GLOBAL_WORK_VALUE,
      '1' AS NO_PUSH_VALUE,
      '1' AS NO_SALE_VALUE,
      '1' AS SALE_VALUE,
      '1' AS NO_PLAN_PERMIT,
      '1' AS HOLD_PLAN_PERMIT,
      '1' AS HOLD_CONSTRUCTION_PERMIT,
      '1' AS WORK_VALUE_ONE,
      '1' AS AVERAGE_VALUE_ONE,
      '1' AS WORK_AMOUNT_ONE,
      '1' AS WORK_VALUE_TWO,
      '1' AS AVERAGE_VALUE_TWO,
      '1' AS WORK_AMOUNT_TWO,
      '1' AS NO_SAVE_PLAN_PERMIT,
      '1' AS PLAN_PERMIT_PHASE,
      '1' AS CONSTRUCTION_PERMIT_PHASE,
      '1' AS PRE_SALE_PERMIT_PHASE,
      '1' AS COMPLETED_PERMIT_PHASE,
      '1' AS CARRY_FORWARD_PHASE
      ,'' AS Obj_ID
    FROM
      dual a
    WHERE rownum=1

      UNION ALL
    SELECT
      '4' AS ID,
      '2' AS PARENT_ID,
      '2' AS WORK_CODE,
      '黄伟的楼栋' AS WORK_NAME,
      '1' AS RECENT_FLOORAGE_AREA,
      '1' AS RECENT_SALE_AREA,
      '1' AS GLOBAL_WORK_VALUE,
      '1' AS NO_PUSH_VALUE,
      '1' AS NO_SALE_VALUE,
      '1' AS SALE_VALUE,
      '1' AS NO_PLAN_PERMIT,
      '1' AS HOLD_PLAN_PERMIT,
      '1' AS HOLD_CONSTRUCTION_PERMIT,
      '1' AS WORK_VALUE_ONE,
      '1' AS AVERAGE_VALUE_ONE,
      '1' AS WORK_AMOUNT_ONE,
      '1' AS WORK_VALUE_TWO,
      '1' AS AVERAGE_VALUE_TWO,
      '1' AS WORK_AMOUNT_TWO,
      '1' AS NO_SAVE_PLAN_PERMIT,
      '1' AS PLAN_PERMIT_PHASE,
      '1' AS CONSTRUCTION_PERMIT_PHASE,
      '1' AS PRE_SALE_PERMIT_PHASE,
      '1' AS COMPLETED_PERMIT_PHASE,
      '1' AS CARRY_FORWARD_PHASE
      ,'' AS Obj_ID
    FROM
      dual
       */
		;

END P_DWM_GLOBAL_WORK_VALUE;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_K1DATALIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_K1DATALIST" 
(
rowNum number
,sortField varchar2 default 'foSaleRateByMoney'
,orderBy varchar2 default 'desc'
,k1DataList OUT sys_refcursor
)
AS  
v_sql clob :='';
whereStr varchar2(500):='';
-- 用于返回筛选的列
v_column clob :='';
-- 用于解决排序字段有span标签问题
sortStr varchar2(100):='';
begin
sortStr := sortField;
  if sortStr = 'firstOpenDate' then
    sortStr := 'FIRST_OPEN_DATE';
  elsif sortStr = 'foSaleRateByMoney' then
    sortStr := 'fo_sale_rate_by_money';
  elsif sortStr = 'foSaleMoney' then
    sortStr := 'fo_sale_money'; 
  elsif sortStr = 'foSaleOutMoney' then
    sortStr := 'fo_sale_out_money';
  elsif sortStr = 'foSaleRateByCount' then
    sortStr := 'fo_sale_rate_by_count';
  elsif sortStr = 'foSaleCount' then
    sortStr := 'fo_sale_count';
  elsif sortStr = 'foSaleOutCount' then
    sortStr := 'fo_sale_out_count';
  elsif sortStr = 'foSaleRateByArea' then
    sortStr := 'fo_sale_rate_by_area';
  elsif sortStr = 'foSaleArea' then
    sortStr := 'fo_sale_area';
  elsif sortStr = 'foSaleOutArea' then
    sortStr := 'fo_sale_out_area';
  elsif sortStr = 'projectName' then
    sortStr := 'projectNameCopy';  
  end if;
--execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd''';
v_sql:='
SELECT
    p.FIRST_OPEN_DATE as "FIRST_OPEN_DATE",
    NVL(fo.fo_sale_rate_by_money,0) as "fo_sale_rate_by_money",
    NVL(fo.fo_sale_money,0) as "fo_sale_money",
    NVL(fo.fo_sale_out_money,0) as "fo_sale_out_money",
    NVL(fo.fo_sale_rate_by_count,0) as "fo_sale_rate_by_count",
    NVL(fo.fo_sale_count,0) as "fo_sale_count",
    NVL(fo.fo_sale_out_count,0) as "fo_sale_out_count",
    NVL(fo.fo_sale_rate_by_area,0) as "fo_sale_rate_by_area",
    NVL(fo.fo_sale_area,0) as "fo_sale_area",
    NVL(fo.fo_sale_out_area,0) as "fo_sale_out_area",

    p.PROJECT_NAME as "projectNameCopy",
    case when fo.fo_sale_rate_by_money is not null then
    FN_DWM_DEC_CONVERT_PCT(fo.fo_sale_rate_by_money) else ''0%'' end as "foSaleRateByMoneyCopy",
    case when fo.fo_sale_rate_by_count is not null then
    FN_DWM_DEC_CONVERT_PCT(fo.fo_sale_rate_by_count) else ''0%'' end as "foSaleRateByCountCopy",
    case when fo.fo_sale_rate_by_area is not null then
    FN_DWM_DEC_CONVERT_PCT(fo.fo_sale_rate_by_area) else ''0%'' end as "foSaleRateByAreaCopy",

    p.project_id as "projectId",
    FN_DWM_FONT_COLOR(p.PROJECT_NAME) as "projectName",
    to_char(p.FIRST_OPEN_DATE,''yyyy-mm-dd'')  as "firstOpenDate",
    case when fo.fo_sale_rate_by_money is not null then
    FN_DWM_FONT_COLOR(FN_DWM_DEC_CONVERT_PCT(fo.fo_sale_rate_by_money)) else FN_DWM_FONT_COLOR(''0%'') end as "foSaleRateByMoney",
    FN_DWM_MULTIPLE_AND_UNIT(fo.fo_sale_money, 100000000, ''亿'') as "foSaleMoney",
    FN_DWM_MULTIPLE_AND_UNIT(fo.fo_sale_out_money, 100000000, ''亿'') as "foSaleOutMoney",
    case when fo.fo_sale_rate_by_count is not null then
    FN_DWM_FONT_COLOR(FN_DWM_DEC_CONVERT_PCT(fo.fo_sale_rate_by_count)) else FN_DWM_FONT_COLOR(''0%'') end as "foSaleRateByCount",
    case when fo.fo_sale_count is not null then
    fo.fo_sale_count || ''套'' else ''0套'' end as "foSaleCount",
    case when fo.fo_sale_out_count is not null then
    fo.fo_sale_out_count || ''套'' else ''0套'' end  as "foSaleOutCount",
    case when fo.fo_sale_rate_by_area is not null then
    FN_DWM_FONT_COLOR(FN_DWM_DEC_CONVERT_PCT(fo.fo_sale_rate_by_area)) else FN_DWM_FONT_COLOR(''0%'') end as "foSaleRateByArea",
    FN_DWM_MULTIPLE_AND_UNIT(fo.fo_sale_area, 10000, ''万方'') as "foSaleArea",
    FN_DWM_MULTIPLE_AND_UNIT(fo.fo_sale_out_area, 10000, ''万方'') as "foSaleOutArea"
FROM
    dwm_sale_rate_by_project fo right join 
    DWM_SALE_RATE_PROJECT p on fo.project_id=p.project_id  
    where p.PROJECT_NAME is not null and TO_DATE(trunc(sysdate,''yyyy'')) <= p.FIRST_OPEN_DATE';
v_column := ' "projectId",
      "projectName",
      "firstOpenDate",
      "foSaleRateByMoney",
      "foSaleMoney",
      "foSaleOutMoney",
      "foSaleRateByCount",
      "foSaleCount",
      "foSaleOutCount",
      "foSaleRateByArea",
      "foSaleArea",
      "foSaleOutArea",

      "projectNameCopy",
      "foSaleRateByMoneyCopy",
      "foSaleRateByCountCopy",
      "foSaleRateByAreaCopy"';    
--    if rowNum <> 0 then
--    whereStr:='where rownum<= ' || rowNum;
--    end if;
    if sortStr is not null and orderBy is not null then
        whereStr:=whereStr||' order by tab."'||sortStr|| '"  '||orderBy || ' nulls last ';
    end if;
    if whereStr is not null then
        v_sql:='select ' || v_column || ' from ('||v_sql||') tab '||whereStr;
    else
        v_sql:='select ' || v_column || ' from (' ||v_sql || ' )';
    end if;
    -- 选择前n条数据，rownum必须拼接在排序后面，不然会先运行rownum再运行排序，会导致筛选数据并不准确
    if rowNum <> 0 then
        v_sql := 'select ' || v_column || ' from (' ||v_sql || ' )' || ' where rownum <= ' || rowNum;
    end if; 
    dbms_output.put_line(v_sql);
OPEN k1DataList FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE k1DataList;
END P_DWM_K1DataList;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_PREPARE_DATALIST_K2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_PREPARE_DATALIST_K2" 
(
  sortField IN VARCHAR2
, orderBy IN VARCHAR2 
, rowNumber IN number
, k2PrepareDataList OUT sys_refcursor 
) AS
whereStr varchar2(500):='';
v_sql clob :='';
-- 用于返回筛选的列
v_column clob :='';
-- 用于解决排序字段有span标签问题
sortStr varchar2(100):='';
BEGIN
  sortStr := sortField;
  if sortStr = 'takeLandDate' then
    sortStr := 'TAKE_LAND_DATE';
  elsif sortStr = 'planFirstOpenDate' then
    sortStr := 'PLAN_FIRST_OPEN_DATE';
  elsif sortStr = 'firstOpenDurationByPlan' then
    sortStr := 'FIRST_OPEN_DURATION_BY_PLAN'; 
  elsif sortStr = 'newPlanFirstOpenDate' then
    sortStr := 'NEW_PLAN_FIRST_OPEN_DATE';   
  end if;
  v_sql:='select
        TAKE_LAND_DATE,
        PLAN_FIRST_OPEN_DATE,
        NVL(FIRST_OPEN_DURATION_BY_PLAN,0) as "FIRST_OPEN_DURATION_BY_PLAN",
        NEW_PLAN_FIRST_OPEN_DATE,

        PROJECT_NAME as "projectNameCopy",
        FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_PLAN) as "firstOpenDurationByPlanCopy",
        Fn_DWM_RiskSummaryDeal(PLAN_FIRST_OPEN_DATE,NEW_PLAN_FIRST_OPEN_DATE,''pure'') as "risKAbstractCopy",

        PROJECT_ID as "projectId", 
        FN_DWM_FONT_COLOR(PROJECT_NAME) as "projectName",
        to_char(TAKE_LAND_DATE,''yyyy-mm-dd'') as "takeLandDate",
        to_char(PLAN_FIRST_OPEN_DATE,''yyyy-mm-dd'') as "planFirstOpenDate",  
        FN_DWM_FONT_COLOR(FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_PLAN)) as "firstOpenDurationByPlan",
        to_char(NEW_PLAN_FIRST_OPEN_DATE,''yyyy-mm-dd'') as "newPlanFirstOpenDate",
        Fn_DWM_RiskSummaryDeal(PLAN_FIRST_OPEN_DATE,NEW_PLAN_FIRST_OPEN_DATE,''label'') as "risKAbstract"
    from DWM_SALE_RATE_PROJECT
    where (to_number(to_char(PLAN_FIRST_OPEN_DATE,''yyyy'')) = to_number(to_char(sysdate,''yyyy'')) or to_number(to_char(NEW_PLAN_FIRST_OPEN_DATE,''yyyy'')) = to_number(to_char(sysdate,''yyyy'')))  and FIRST_OPEN_DATE is null';
  v_column := ' "projectId",
      "projectName",
      "projectNameCopy",
      "takeLandDate",
      "planFirstOpenDate",
      "firstOpenDurationByPlan",
      "firstOpenDurationByPlanCopy",
      "newPlanFirstOpenDate",
      "risKAbstract",
      "risKAbstractCopy" ';
--    if rowNumber <> 0 then
--    whereStr:='where rownum<= ' || rowNumber;
--    end if;
    if sortStr is not null and orderBy is not null then
    whereStr:=whereStr||' order by tab."'||sortStr||'"  '||orderBy;
    end if;
    if whereStr is not null then
    v_sql:='select ' || v_column || ' from ('||v_sql||') tab '||whereStr;
    else
    v_sql:='select ' || v_column || ' from (' ||v_sql || ' )';
    end if;
    -- 选择前n条数据，rownum必须拼接在排序后面，不然会先运行rownum再运行排序，会导致筛选数据并不准确
    if rowNumber <> 0 then
        v_sql := 'select ' || v_column || ' from (' ||v_sql || ' )' || ' where rownum <= ' || rowNumber;
    end if;
  dbms_output.put_line(v_sql);  
  OPEN k2PrepareDataList FOR v_sql;
  EXCEPTION
    WHEN OTHERS THEN
  CLOSE k2PrepareDataList;
END P_DWM_PREPARE_DATALIST_K2;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_PROJECTSALERATEDATALIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_PROJECTSALERATEDATALIST" (filter in clob,keyWord in varchar2,rowCnt in number,sortField in varchar,orderby in varchar,items out sys_refcursor,total out number)
as
groupName varchar2(200);
v_sql  clob:='';
v_where clob:='';
v_org_where clob:='';
filterItemStr clob:='';
hasAll number;
ItemStr varchar(1000);
orderbyStr  varchar(1000);
sortFieldStr varchar(1000);
yearStr varchar(1000);
v_count_sql clob:='';
top_str  varchar(100);
RowCount number;
detailstr clob:='';
begin
delete PERSON_ROLE_ANALYSIS_TABLE;
-- 所有项目去化率，Author:吴洋，date:2020/12/11  二期去掉 首开去化率 和  顽固性库存去化率
 if filter is not null then
insert into PERSON_ROLE_ANALYSIS_TABLE (code,detail,type )  SELECT  SYS_GUID(),COLUMN_VALUE ,'filter' FROM table (split (filter,';'));
        for item in ( SELECT code,detail FROM  PERSON_ROLE_ANALYSIS_TABLE where type='filter' ) loop
               if INSTR(item.detail,':')<>0 then
                    groupName:= SUBSTR(item.detail,0,INSTR(item.detail,':')-1);
                    detailstr:=REPLACE(item.detail,groupName||':','');
                    if detailstr is not null then
                        update PERSON_ROLE_ANALYSIS_TABLE set detail= REPLACE(item.detail,groupName||':',''),type=groupName  where code=item.code;
                    end if;
                else
                    delete PERSON_ROLE_ANALYSIS_TABLE where code=item.code;
               end if;
      end loop;    
end if;

select count(1) into  RowCount from PERSON_ROLE_ANALYSIS_TABLE where  type='isStart';
if RowCount<>0 then
    select detail into filterItemStr from PERSON_ROLE_ANALYSIS_TABLE where  type='isStart' and rownum=1;
    if filterItemStr is not null then
        SELECT count(1) into hasAll  FROM table (split (filterItemStr,',')) where COLUMN_VALUE='all' ;
        if hasAll=0 then
            v_where:=' and tab."isConstructionBegan" in ('||filterItemStr||')';
        end if;
    end if;
end if;

select count(1) into  RowCount from PERSON_ROLE_ANALYSIS_TABLE where  type='opening';
if RowCount<>0 then
    select detail into filterItemStr from PERSON_ROLE_ANALYSIS_TABLE where  type='opening' and rownum=1;
    if filterItemStr is not null then
        SELECT count(1) into hasAll  FROM table (split (filterItemStr,',')) where COLUMN_VALUE='all' ;
        if hasAll=0 then
            v_where:=v_where||' and tab."hasFirstOpenDate" in ('||filterItemStr||')';
        end if;
    end if;
end if;

select count(1) into  RowCount from PERSON_ROLE_ANALYSIS_TABLE where  type='isOperate';
if RowCount<>0 then
    select detail into filterItemStr from PERSON_ROLE_ANALYSIS_TABLE where  type='isOperate' and rownum=1;
    if filterItemStr is not null then
        SELECT count(1) into hasAll  FROM table (split (filterItemStr,',')) where COLUMN_VALUE='all' ;
        if hasAll=0 then
            v_where:=v_where||' and tab."isOperate" in ('||filterItemStr||')';
        end if;
    end if;
end if;

select count(1) into  RowCount from PERSON_ROLE_ANALYSIS_TABLE where  type='isHasExistingHouse';
if RowCount<>0 then
    select detail into filterItemStr from PERSON_ROLE_ANALYSIS_TABLE where  type='isHasExistingHouse' and rownum=1;
    if filterItemStr is not null then
        SELECT count(1) into hasAll  FROM table (split (filterItemStr,',')) where COLUMN_VALUE='all' ;
        if hasAll=0 then
            v_where:=v_where||' and tab."isHasExistingHouse" in ('||filterItemStr||')';
        end if;
    end if;
end if;

select count(1) into  RowCount from PERSON_ROLE_ANALYSIS_TABLE where  type='hasFirstPhaseKeyPlan';
if RowCount<>0 then
    select detail into filterItemStr from PERSON_ROLE_ANALYSIS_TABLE where  type='hasFirstPhaseKeyPlan' and rownum=1;
    if filterItemStr is not null then
        SELECT count(1) into hasAll  FROM table (split (filterItemStr,',')) where COLUMN_VALUE='all' ;
        if hasAll=0 then
            v_where:=v_where||' and tab."hasFirstPhaseKeyPlan" in ('||filterItemStr||')';
        end if;
    end if;
end if;

select count(1) into  RowCount from PERSON_ROLE_ANALYSIS_TABLE where  type='openingYear';
if RowCount<>0 then
    select detail into filterItemStr from PERSON_ROLE_ANALYSIS_TABLE where  type='openingYear' and rownum=1;
    if filterItemStr is not null then
        SELECT count(1) into hasAll  FROM table (split (filterItemStr,',')) where COLUMN_VALUE='all' ;
        if hasAll=0 then
             v_where:=v_where||' and ( ';
                 for item in (  SELECT COLUMN_VALUE as detail FROM table (split (filterItemStr)) ) loop
                        if INSTR(item.detail,'<')<>0 then
                                if yearStr is null then 
                                    yearStr:=yearStr||' to_number(to_char(tab."firstOpenDateValue",''yyyy''))<'||REPLACE(item.detail,'<','');
                                else
                                    yearStr:=yearStr||' or to_number(to_char(tab."firstOpenDateValue",''yyyy''))<'||REPLACE(item.detail,'<','');
                                end if;
                        else
                                  if yearStr is null then 
                                    yearStr:=yearStr||' to_number(to_char(tab."firstOpenDateValue",''yyyy''))='||item.detail;
                                else
                                    yearStr:=yearStr||' or to_number(to_char(tab."firstOpenDateValue",''yyyy''))='||item.detail;
                                end if;
                        end if;
                  end loop;   
                  if yearStr is null then
                    yearStr:=' 1=1 ';
                  end if;
               v_where:=v_where||yearStr||')';
        end if;
    end if;
end if;

select count(1) into  RowCount from PERSON_ROLE_ANALYSIS_TABLE where  type='obtainYear';
if RowCount<>0 then
    select detail into filterItemStr from PERSON_ROLE_ANALYSIS_TABLE where  type='obtainYear' and rownum=1;
    if filterItemStr is not null then
        SELECT count(1) into hasAll  FROM table (split (filterItemStr,',')) where COLUMN_VALUE='all' ;
        if hasAll=0 then
             v_where:=v_where||' and ( ';
                 for item in (  SELECT COLUMN_VALUE as detail FROM table (split (filterItemStr)) ) loop
                        if INSTR(item.detail,'<')<>0 then
                                if yearStr is null then 
                                    yearStr:=yearStr||' to_number(to_char(tab."obtainDateValue",''yyyy''))<'||REPLACE(item.detail,'<','');
                                else
                                    yearStr:=yearStr||' or to_number(to_char(tab."obtainDateValue",''yyyy''))<'||REPLACE(item.detail,'<','');
                                end if;
                        else
                                  if yearStr is null then 
                                    yearStr:=yearStr||' to_number(to_char(tab."obtainDateValue",''yyyy''))='||item.detail;
                                else
                                    yearStr:=yearStr||' or to_number(to_char(tab."obtainDateValue",''yyyy''))='||item.detail;
                                end if;
                        end if;
                  end loop;   
                  if yearStr is null then
                    yearStr:=' 1=1 ';
                  end if;
              v_where:=v_where||yearStr||')';
        end if;
    end if;
end if;

select count(1) into  RowCount from PERSON_ROLE_ANALYSIS_TABLE where  type='org';
if RowCount<>0 then
    select detail into filterItemStr from PERSON_ROLE_ANALYSIS_TABLE where  type='org' and rownum=1;
    if filterItemStr is not null then
        SELECT count(1) into hasAll  FROM table (split (filterItemStr,',')) where COLUMN_VALUE='all' ;
        if hasAll=0 then
               v_org_where:=' inner join 
               (select id from SYS_BUSINESS_UNIT m start with m.id in (SELECT COLUMN_VALUE FROM table (split ('''||filterItemStr||''','',''))) 
               connect by m.PARENT_ID=prior m.id) unit
               on unit.id=tab.org_id ';
        end if;
    end if;
end if;

if sortField is null then
sortFieldStr:='obtainDate';
else
sortFieldStr:=sortField||'Value';
end if;
if orderby is null then
orderbyStr:='desc';
else
orderbyStr:=orderby;
end if;

if rowcnt=30 or rowcnt is null  then
    top_str:=' rownum<=30 ';
end if;

if keyWord is not null then
    v_where:=v_where||' and tab."projectName"  like  ''%'||keyWord||'%'' ';
end if;

 dbms_output.put_line(v_where);

v_sql:='select * from(SELECT
    proj.project_id as "project_id", 
    proj.project_name as "projectNameValue",
    case when proj.HAS_FIRST_PHASE_KEY_PLAN is null then 0 else proj.HAS_FIRST_PHASE_KEY_PLAN end  as "hasFirstPhaseKeyPlan",
    FN_DWM_FONT_COLOR(proj.project_name) as "projectName",
    proj.org_id,
    proj.IS_OPERATE as "isOperate",
    case when rate.si_surplus_sale_money is not null and rate.si_surplus_sale_money <> 0 then 1 else 0 end as "isHasExistingHouse",
    case when proj.FIRST_OPEN_DATE is not null then 1 else 0 end as "hasFirstOpenDate",
    proj.IS_CONSTRUCTION_BEGAN as "isConstructionBegan",
    proj.FIRST_OPEN_DURATION_BY_TL as "firstOpenDurationByTlValue",
    FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_TL) as "firstOpenDurationByTlText",
    FN_DWM_FONT_COLOR(FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_TL)) as "firstOpenDurationByTl",
    proj.OBTAIN_DATE as "obtainDateValue",
    to_char(proj.OBTAIN_DATE,''yyyy-mm-dd'') as "obtainDate",
    proj.FIRST_OPEN_DATE  as "firstOpenDateValue",
    to_char(proj.FIRST_OPEN_DATE,''yyyy-mm-dd'')  as "firstOpenDate",


    case when rate.po_sale_rate_by_money is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(rate.po_sale_rate_by_money)) else 
    FN_DWM_FONT_COLOR(''0%'') end as "poSaleRateByMoney",

    case when rate.po_sale_rate_by_money is not null then
   rate.po_sale_rate_by_money*100 else 
    0 end as "poSaleRateByMoneyValue",

     case when rate.po_sale_rate_by_money is not null then
    fn_ConvertDecimalToPercentage(rate.po_sale_rate_by_money) else 
    ''0%'' end as "poSaleRateByMoneyText",

    case when rate.fm_sale_rate_by_money is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(rate.fm_sale_rate_by_money)) else 
    FN_DWM_FONT_COLOR(''0%'') end as "fmSaleRateByMoney",

    case when rate.fm_sale_rate_by_money is not null then
   rate.fm_sale_rate_by_money*100 else 
    0 end as "fmSaleRateByMoneyValue",

    case when rate.fm_sale_rate_by_money is not null then
    fn_ConvertDecimalToPercentage(rate.fm_sale_rate_by_money) else 
    ''0%'' end as "fmSaleRateByMoneyText",

    case when rate.fohy_sale_rate_by_money is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(rate.fohy_sale_rate_by_money)) else 
    FN_DWM_FONT_COLOR(''0%'') end as "fohySaleRateByMoney",

    case when rate.fohy_sale_rate_by_money is not null then
   rate.fohy_sale_rate_by_money*100 else 
    0 end as "fohySaleRateByMoneyValue",

    case when rate.fohy_sale_rate_by_money is not null then
    fn_ConvertDecimalToPercentage(rate.fohy_sale_rate_by_money) else 
    ''0%'' end as "fohySaleRateByMoneyText",

    case when rate.cr_sale_rate_by_money is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(rate.cr_sale_rate_by_money)) else 
    FN_DWM_FONT_COLOR(''0%'') end as "crSaleRateByMoney",

    case when rate.cr_sale_rate_by_money is not null then
   rate.cr_sale_rate_by_money*100 else 
    0 end as "crSaleRateByMoneyValue",

    case when rate.cr_sale_rate_by_money is not null then
    fn_ConvertDecimalToPercentage(rate.cr_sale_rate_by_money) else 
    ''0%'' end as "crSaleRateByMoneyText",

    case when rate.croy_sale_rate_by_money is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(rate.croy_sale_rate_by_money)) else 
    FN_DWM_FONT_COLOR(''0%'') end as "croySaleRateByMoney",

    case when rate.croy_sale_rate_by_money is not null then
   rate.croy_sale_rate_by_money*100 else 
    0 end as "croySaleRateByMoneyValue",

    case when rate.croy_sale_rate_by_money is not null then
    fn_ConvertDecimalToPercentage(rate.croy_sale_rate_by_money) else 
    ''0%'' end as "croySaleRateByMoneyText",

    case when rate.eh_sale_rate_by_money is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(rate.eh_sale_rate_by_money)) else 
    FN_DWM_FONT_COLOR(''0%'') end as "ehSaleRateByMoney",

    case when rate.eh_sale_rate_by_money is not null then
    fn_ConvertDecimalToPercentage(rate.eh_sale_rate_by_money) else 
    ''0%'' end as "ehSaleRateByMoneyText",

    case when rate.eh_sale_rate_by_money is not null then
    rate.eh_sale_rate_by_money*100 else 
    0 end as "ehSaleRateByMoneyValue",


    case when rate.po_surplus_sale_money is not null then
    FN_DWN_AmountToBillionYuan(rate.po_surplus_sale_money) else 
    ''0.00亿'' end as "poSurplusSaleMoney",

    case when rate.eh_surplus_sale_money is not null then
    FN_DWN_AmountToBillionYuan(rate.eh_surplus_sale_money) else 
    ''0.00亿'' end as "ehSurplusSaleMoney",

     case when rate.po_surplus_sale_money is not null then
     rate.po_surplus_sale_money   else 
    0 end as "poSurplusSaleMoneyValue",

      case when rate.eh_surplus_sale_money is not null then
     rate.eh_surplus_sale_money   else 
    0 end as "ehSurplusSaleMoneyValue"


FROM
   DWM_SALE_RATE_PROJECT proj left join dwm_sale_rate_by_project rate on proj.project_id=rate.project_id) tab';
   v_sql:=v_sql||v_org_where||' where 1=1 '|| v_where;
   v_count_sql:='select count(1) FROM ('||v_sql||') tabCount';
   if top_str is not null then
    v_sql:='select * from ('||v_sql||' order by tab."'||sortFieldStr||'" '||orderbyStr||') list where '||top_str ;
   else
    v_sql:=v_sql||' order by tab."'||sortFieldStr||'" '||orderbyStr;
   end if;
 dbms_output.put_line(v_sql);
   execute immediate v_count_sql into total;  
    OPEN items FOR v_sql;
    EXCEPTION
    WHEN OTHERS THEN
      CLOSE items;
 end P_DWM_ProjectSaleRateDataList;
--=================================================================定时任务结束================================================================


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_SALE_RATE_BY_GRANULARITY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_SALE_RATE_BY_GRANULARITY" (
    spid_info   OUT  SYS_REFCURSOR,
    t_room_info   OUT  SYS_REFCURSOR ,
    spid_tree_info   OUT  SYS_REFCURSOR
) AS
		--业态面积段颗粒度去化率；作用=》定时任务拍照
		--作者：陈丽
		--日期：2020-04-10   
        -- 2020/12/17 新增首月、首开半年去化率
  PROJ_BASE_SPID VARCHAR2(2000);
  sys_created date:=sysdate;
  spid VARCHAR2(360); --使用临时表的批次号
  spid_tree VARCHAR2(360); --使用临时表的批次号
  dwm_REMARK VARCHAR2(200):='测试-chenl';
  ----------------------
  v_sql clob;
  v_sql_start VARCHAR2(2000):= ' case ';
  v_sql_content clob:= '';
  v_sql_end VARCHAR2(2000):= '  else ''主数据面积段外'' end  ';
BEGIN
delete TMP_ROOM;
delete TMP_SALE_RATE_BY_GRANULARITY;
---------------------------
--------------------------------------------------------创建临时表批次号
    SELECT
        get_uuid(),get_uuid()
    INTO spid,spid_tree
    FROM
        dual;  
---------------------------------------------计算业态面积段1.拼接查询语句
 FOR item IN (select 
    ' when room.NEW_BLD_AREA'||l.lower_limit_type||l.lower_limit_value||' and room.NEW_BLD_AREA '||l.upper_limit_type||l.upper_limit_value
    ||' and (case when room.PRODUCT_NAME=''车位'' then ''车位仓储'' when room.PRODUCT_NAME=''商办'' then ''商办产业'' else ''住宅'' end)='''||l.顶级业态||''' then ''' ||l.areaStage||''' ' as aa,
    l.upper_limit_type,
    l.lower_limit_type,
    l.upper_limit_value,
    l.areaStage,
    l.顶级业态 as ptype from (select 
    lev.attribute_name as areaStage
    ,lev.order_code
    ,lev.upper_limit_type
    ,lev.LOWER_LIMIT_VALUE
    ,lev.lower_limit_type
    ,lev.upper_limit_value
    ,product_type.id as 顶级业态id
    ,product_type.product_type_short_name as 顶级业态
    from mdm_attribute_area_level lev
    left join mdm_attribute_area_level p on lev.parent_id=p.id 
    ---关联面积段对应业态
    left join MDM_AREA_LEVEL_APPLY_PRODUCT ap on p.id=ap.AREA_LEVEL_ID 
     --关联业态 找到业态顶级
    left join MDM_BUILD_PRODUCT_TYPE PRODUCT_TYPE 
    on substr(ap.product_type_name,1,instr(ap.product_type_name,'/',1,1)-1)=PRODUCT_TYPE.product_type_name
    where product_type.product_type_short_name is not null
    group by product_type.id
    ,product_type.product_type_short_name,lev.attribute_name,lev.order_code ,lev.upper_limit_type
    ,lev.lower_limit_type
    ,lev.upper_limit_value,lev.lower_limit_value
    order by product_type.product_type_short_name,lev.order_code)l
        ) LOOP 
    ---拼接字符串
         v_sql_content := v_sql_content||item.aa;
        END LOOP;
    --规则内容大于0才拼规则语句
        IF length(v_sql_content) > 0 THEN
            v_sql := v_sql_start
                     || v_sql_content
                     || v_sql_end;
        ELSE
            v_sql := '''''';
        END IF;

       v_sql:= 'INSERT INTO TMP_ROOM(id,room_ID,BLD_AREA,ROOM_NAME,PRODUCT_NAME,AREA_LEVEL)
       select '''||spid||''',id,NEW_BLD_AREA,room_name
       ,case when room.PRODUCT_NAME=''车位'' then ''车位仓储'' when room.PRODUCT_NAME=''商办'' then ''商办产业'' else ''住宅'' end,'
       ||v_sql|| ' as NODE_WARNING from mdm_room room';
         dbms_output.put_line(v_sql);
       execute immediate v_sql;

        OPEN t_room_info FOR select * from TMP_ROOM;  
-----------------------------------------------项目基本信息
BEGIN
  P_DWM_SALE_RATE_PROJ(0,
    PROJ_BASE_SPID => PROJ_BASE_SPID
  );
    END;
 ------------------------------------------------------------业态面积段树拼接 spid_tree
 INSERT INTO TMP_SALE_RATE_BY_GRANULARITY (ID---【1】主键
,"SORT"
,GRANULARITY_ID--颗粒度id
,PROJECT_ID---【2】项目ID
,PROJECT_NAME--项目名称
,PARENT_ID---父级id
,DATA_GRANULARITY--颗粒度名称
)
-----业态
select spid_tree
,b.order_code
,proj.PROJECT_ID||b.product_type_short_name as GRANULARITY_ID
,proj.PROJECT_ID as projectId
,proj.PROJECT_NAME
,null as parentId 
,b.product_type_short_name as text   
 from (select * from tmp_proj_base where id = PROJ_BASE_SPID) proj cross join
(
select ptype.*,rownum as order_code FROM(select * from  MDM_BUILD_PRODUCT_TYPE ptype
where parent_code is null order by PRODUCT_TYPE_CODE) ptype ) b
   union all
-----面积段
select spid_tree
,a.order_code
,proj.PROJECT_ID||顶级业态||a.areaStage as GRANULARITY_ID
,proj.PROJECT_ID as projectId
,proj.PROJECT_NAME
,proj.PROJECT_ID||顶级业态 as parentId 
,a.areaStage as text
from  (select * from tmp_proj_base where id = PROJ_BASE_SPID) proj cross join
( select 
    lev.attribute_name as areaStage
    ,lev.order_code
    ,lev.upper_limit_type
    ,lev.LOWER_LIMIT_VALUE
    ,lev.lower_limit_type
    ,lev.upper_limit_value
    ,product_type.id as 顶级业态id
    ,product_type.product_type_short_name as 顶级业态
    from mdm_attribute_area_level lev
    left join mdm_attribute_area_level p on lev.parent_id=p.id 
    ---关联面积段对应业态
    left join MDM_AREA_LEVEL_APPLY_PRODUCT ap on p.id=ap.AREA_LEVEL_ID 
     --关联业态 找到业态顶级
    left join MDM_BUILD_PRODUCT_TYPE PRODUCT_TYPE 
    on substr(ap.product_type_name,1,instr(ap.product_type_name,'/',1,1)-1)=PRODUCT_TYPE.product_type_name
    where product_type.product_type_short_name is not null
    group by product_type.id
    ,product_type.product_type_short_name,lev.attribute_name,lev.order_code ,lev.upper_limit_type
    ,lev.lower_limit_type
    ,lev.upper_limit_value,lev.lower_limit_value
    order by product_type.product_type_short_name,lev.order_code) a;

OPEN spid_tree_info FOR select * from TMP_SALE_RATE_BY_GRANULARITY where id=spid_tree;
------------------------------------------------------面积段数据 spid

 INSERT INTO TMP_SALE_RATE_BY_GRANULARITY (ID---【1】主键
,GRANULARITY_ID
,PROJECT_ID---【2】项目ID
,PROJECT_NAME
,FO_SALE_OUT_COUNT---【3】首开去化套数
,FO_SALE_COUNT---【4】首开推售套数
,FO_SALE_RATE_BY_COUNT---【5】首开去化率(按套数)（3/4）
,FO_SALE_OUT_AREA---【6】首开去化面积
,FO_SALE_AREA---【7】首开推售面积
,FO_SALE_RATE_BY_AREA---【8】首开去化率(按面积)（6/7）
,FO_SALE_OUT_MONEY---【9】首开去化货值
,FO_SALE_MONEY---【10】首开推售货值
,FO_SALE_RATE_BY_MONEY---【11】首开去化率(按货值)（9/10）
,FO_SURPLUS_SALE_MONEY---【12】首开剩余货值(10-9)
,FO_SALE_AVERAGE_MONEY---【13】首开标准均价(10/7)
,FO_SALE_OUT_AVERAGE_MONEY---【14】首开签约均价(9/6)
,PO_SALE_OUT_COUNT---【15】全案去化套数
,PO_SALE_COUNT---【16】全案推售套数
,PO_SALE_RATE_BY_COUNT---【17】全案去化率(按套数)(15/16)
,PO_SALE_OUT_AREA---【18】全案去化面积
,PO_SALE_AREA---【19】全案推售面积
,PO_SALE_RATE_BY_AREA---【20】全案去化率(按面积)(18/19)
,PO_SALE_OUT_MONEY---【21】全案去化货值
,PO_SALE_MONEY---【22】全案推售货值
,PO_SALE_RATE_BY_MONEY---【23】全案去化率(按货值)(21/22)
,PO_SURPLUS_SALE_MONEY---【24】全案剩余货值(22-21)
,PO_SALE_AVERAGE_MONEY---【25】全案标准均价(22/19)
,PO_SALE_OUT_AVERAGE_MONEY---【26】全案签约均价(21/18)
,EH_SALE_OUT_COUNT---【27】现房去化套数
,EH_SALE_COUNT---【28】现房推售套数
,EH_SALE_RATE_BY_COUNT---【29】现房去化率(按套数)(27/28)
,EH_SALE_OUT_AREA---【30】现房去化面积
,EH_SALE_AREA---【31】现房推售面积
,EH_SALE_RATE_BY_AREA---【32】现房去化率(按面积)(30/31)
,EH_SALE_OUT_MONEY---【33】现房去化货值
,EH_SALE_MONEY---【34】现房推售货值
,EH_SALE_RATE_BY_MONEY---【35】现房去化率(按货值)(33/34)
,EH_SURPLUS_SALE_MONEY---【36】现房剩余货值(34-33)
,EH_SALE_AVERAGE_MONEY---【37】现房标准均价(34/31)
,EH_SALE_OUT_AVERAGE_MONEY---【38】现房签约均价(33/30)
,SI_SALE_OUT_COUNT---【39】顽固性库存去化套数
,SI_SALE_COUNT---【40】顽固性库存推售套数
,SI_SALE_RATE_BY_COUNT---【41】顽固性库存去化率(按套数)(39/40)
,SI_SALE_OUT_AREA---【42】顽固性库存去化面积
,SI_SALE_AREA---【43】顽固性库存推售面积
,SI_SALE_RATE_BY_AREA---【44】顽固性库存去化率(按面积)(42/43)
,SI_SALE_OUT_MONEY---【45】顽固性库存去化货值
,SI_SALE_MONEY---【46】顽固性库存推售货值
,SI_SALE_RATE_BY_MONEY---【47】顽固性库存去化率(按货值)(45/46)
,SI_SURPLUS_SALE_MONEY---【48】顽固性库存剩余货值(46-45)
,SI_SALE_AVERAGE_MONEY---【49】顽固性库存标准均价(46/43)
,SI_SALE_OUT_AVERAGE_MONEY---【50】顽固性库存签约均价(45/42)
,PARENT_ID  
,DATA_GRANULARITY
,PRODUCT_NAME
,CREATED---【51】创建日期
,REMARK
,FM_SALE_OUT_COUNT
,FM_SALE_RATE_BY_COUNT
,FM_SALE_OUT_AREA
,FM_SALE_RATE_BY_AREA
,FM_SALE_OUT_MONEY
,FM_SALE_RATE_BY_MONEY
,FM_SURPLUS_SALE_MONEY
,FM_SALE_AVERAGE_MONEY
,FM_SALE_OUT_AVERAGE_MONEY
,FOHY_SALE_OUT_COUNT---首开半年去化套数
,FOHY_SALE_COUNT---首开半年推售套数
,FOHY_SALE_RATE_BY_COUNT---首开半年去化率(按套数)
,FOHY_SALE_OUT_AREA---首开半年去化面积
,FOHY_SALE_AREA---首开半年推售面积
,FOHY_SALE_RATE_BY_AREA---首开半年去化率(按面积)
,FOHY_SALE_OUT_MONEY---首开半年去化货值
,FOHY_SALE_MONEY---首开半年推售货值
,FOHY_SALE_RATE_BY_MONEY---首开半年去化率(按货值)
,FOHY_SURPLUS_SALE_MONEY---首开半年剩余货值
,FOHY_SALE_AVERAGE_MONEY---首开半年标准均价
,FOHY_SALE_OUT_AVERAGE_MONEY---首开半年签约均价
,CR_SALE_OUT_COUNT---竣备去化套数
,CR_SALE_COUNT---已竣备总 套数
,CR_SALE_RATE_BY_COUNT---竣备去化率(按套数)
,CR_SALE_OUT_AREA---竣备去化面积
,CR_SALE_AREA---已竣备总面积
,CR_SALE_RATE_BY_AREA---竣备去化率(按面积)
,CR_SALE_OUT_MONEY---竣备去化货值
,CR_SALE_MONEY---已竣备总货值
,CR_SALE_RATE_BY_MONEY---竣备去化率(按货值)
,CR_SURPLUS_SALE_MONEY---竣工备案剩余货值
,CR_SALE_AVERAGE_MONEY---竣工备案标准均价
,CR_SALE_OUT_AVERAGE_MONEY---竣工备案签约均价
,CROY_SALE_OUT_COUNT ---竣备一年去化套数
,CROY_SALE_COUNT ---竣备一年总套数
,CROY_SALE_RATE_BY_COUNT ---竣备一年去化率(按套数)
,CROY_SALE_OUT_AREA ---竣备一年去化面积
,CROY_SALE_AREA ---竣备一年总面积
,CROY_SALE_RATE_BY_AREA ---竣备一年去化率(按面积)
,CROY_SALE_OUT_MONEY ---竣备一年去化货值
,CROY_SALE_MONEY ---竣备一年总货值
,CROY_SALE_RATE_BY_MONEY ---竣备一年去化率(按货值)
,CROY_SURPLUS_SALE_MONEY---竣工备案一年剩余货值
,CROY_SALE_AVERAGE_MONEY---竣工备案一年标准均价
,CROY_SALE_OUT_AVERAGE_MONEY---竣工备案一年签约均价

)select 
spid as ID---【1】主键
,project_id||PRODUCT_NAME||AREA_LEVEL
,project_id as PROJECT_ID---【2】项目ID
,project_name
-----------------------------------K1、首开去化率开始--------------------
,"首开去化套数" as FO_SALE_OUT_COUNT---【3】首开去化套数
,"首开推售套数" as FO_SALE_COUNT---【4】首开推售套数
,case when 首开推售套数=0 then 0 else round("首开去化套数"/"首开推售套数",4)  end as FO_SALE_RATE_BY_COUNT---【5】首开去化率(按套数)（3/4）
,"首开去化面积" as FO_SALE_OUT_AREA---【6】首开去化面积
,"首开推售面积" as FO_SALE_AREA---【7】首开推售面积
,case when 首开推售面积=0 then 0 else round("首开去化面积"/"首开推售面积",4)  end as FO_SALE_RATE_BY_AREA---【8】首开去化率(按面积)（6/7）
,"首开去化货值" as FO_SALE_OUT_MONEY---【9】首开去化货值
,"首开推售货值" as FO_SALE_MONEY---【10】首开推售货值
,case when 首开推售货值=0 then 0 else round("首开去化货值"/"首开推售货值",4)  end as FO_SALE_RATE_BY_MONEY---【11】首开去化率(按货值)（9/10）
,"首开推售货值"-"首开去化货值" as FO_SURPLUS_SALE_MONEY---【12】首开剩余货值(10-9)
,case when 首开推售面积=0 then 0 else round("首开推售货值"/"首开推售面积",4)  end  as FO_SALE_AVERAGE_MONEY---【13】首开标准均价(10/7)
,case when 首开去化面积=0 then 0 else round("首开去化货值"/"首开去化面积",4)  end as FO_SALE_OUT_AVERAGE_MONEY---【14】首开签约均价(9/6)
-----------------------------------K3、全案去化率 （单位：%）--------------------
,"全案已去化套数" as PO_SALE_OUT_COUNT---【15】全案去化套数
,"全案已领证套数" as PO_SALE_COUNT---【16】全案推售套数
,case when 全案已领证套数=0 then 0 else round("全案已去化套数"/"全案已领证套数",4)  end as PO_SALE_RATE_BY_COUNT---【17】全案去化率(按套数)(15/16)
,"全案已去化面积" as PO_SALE_OUT_AREA---【18】全案去化面积
,"全案已领证面积" as PO_SALE_AREA---【19】全案推售面积
,case when 全案已领证面积=0 then 0 else round("全案已去化面积"/"全案已领证面积",4)  end as PO_SALE_RATE_BY_AREA---【20】全案去化率(按面积)(18/19)
,"全案已去化货值" as PO_SALE_OUT_MONEY---【21】全案去化货值
,"全案已领证货值" as PO_SALE_MONEY---【22】全案推售货值
,case when 全案已领证货值=0 then 0 else round("全案已去化货值"/"全案已领证货值",4)  end  as PO_SALE_RATE_BY_MONEY---【23】全案去化率(按货值)(21/22)
,"全案已领证货值"-"全案已去化货值" as PO_SURPLUS_SALE_MONEY---【24】全案剩余货值(22-21)
,case when 全案已领证面积=0 then 0 else round("全案已领证货值"/"全案已领证面积",4)  end  as PO_SALE_AVERAGE_MONEY---【25】全案标准均价(22/19)
,case when 全案已去化面积=0 then 0 else round("全案已去化货值"/"全案已去化面积",4)  end   PO_SALE_OUT_AVERAGE_MONEY---【26】全案签约均价(21/18)
-----------------------------------K4、现房去化率 （单位：%）--------------------
,"现房去化套数" as EH_SALE_OUT_COUNT---【27】现房去化套数
,"现房推售套数" as EH_SALE_COUNT---【28】现房推售套数
,case when 现房推售套数=0 then 0 else  round("现房去化套数"/"现房推售套数",4) end as EH_SALE_RATE_BY_COUNT---【29】现房去化率(按套数)(27/28)
,"现房去化面积" as EH_SALE_OUT_AREA---【30】现房去化面积
,"现房推售面积" as EH_SALE_AREA---【31】现房推售面积
,case when 现房推售面积=0 then 0 else  round("现房去化面积"/"现房推售面积",4) end as EH_SALE_RATE_BY_AREA---【32】现房去化率(按面积)(30/31)
,"现房去化金额" as EH_SALE_OUT_MONEY---【33】现房去化货值
,"现房推售金额" as EH_SALE_MONEY---【34】现房推售货值
,case when 现房推售金额=0 then 0 else  round("现房去化金额"/"现房推售金额",4) end as EH_SALE_RATE_BY_MONEY---【35】现房去化率(按货值)(33/34)
,"现房推售金额"-"现房去化金额" as EH_SURPLUS_SALE_MONEY---【36】现房剩余货值(34-33)
,case when 现房推售面积=0 then 0 else  round("现房推售金额"/"现房推售面积",4) end  as EH_SALE_AVERAGE_MONEY---【37】现房标准均价(34/31)
,case when 现房去化面积=0 then 0 else  round("现房去化金额"/"现房去化面积",4) end  as EH_SALE_OUT_AVERAGE_MONEY---【38】现房签约均价(33/30)
-----------------------------------K5、顽固性库存去化率 （单位：%）--------------------
,"顽固去化套数" as SI_SALE_OUT_COUNT---【39】顽固性库存去化套数
,"顽固推售套数" as SI_SALE_COUNT---【40】顽固性库存推售套数
,case when 顽固推售套数=0 then 0 else  round("顽固去化套数"/"顽固推售套数",4) end as SI_SALE_RATE_BY_COUNT---【41】顽固性库存去化率(按套数)(39/40)
,"顽固去化面积" as SI_SALE_OUT_AREA---【42】顽固性库存去化面积
,"顽固推售面积" as SI_SALE_AREA---【43】顽固性库存推售面积
,case when 顽固推售面积=0 then 0 else  round("顽固去化面积"/"顽固推售面积",4) end  as SI_SALE_RATE_BY_AREA---【44】顽固性库存去化率(按面积)(42/43)
,"顽固去化金额" as SI_SALE_OUT_MONEY---【45】顽固性库存去化货值
,"顽固推售金额" as SI_SALE_MONEY---【46】顽固性库存推售货值
,case when 顽固推售金额=0 then 0 else  round("顽固去化金额"/"顽固推售金额",4) end as SI_SALE_RATE_BY_MONEY---【47】顽固性库存去化率(按货值)(45/46)
,"顽固推售金额"-"顽固去化金额" SI_SURPLUS_SALE_MONEY---【48】顽固性库存剩余货值(46-45)
,case when 顽固推售面积=0 then 0 else  round("顽固推售金额"/"顽固推售面积",4) end as SI_SALE_AVERAGE_MONEY---【49】顽固性库存标准均价(46/43)
,case when 顽固推售面积=0 then 0 else  round("顽固去化金额"/"顽固推售面积",4) end as SI_SALE_OUT_AVERAGE_MONEY---【50】顽固性库存签约均价(45/42)
-------------------- 业态面积段特有 start
,project_id||PRODUCT_NAME  as PARENT_ID  
,AREA_LEVEL as DATA_GRANULARITY
,PRODUCT_NAME    
,sys_created as CREATED---【51】创建日期
,dwm_REMARK
-------------------------------------------首月去化率----------------------------------------------
,"首月去化套数" as FM_SALE_OUT_COUNT
,case when 首开推售套数=0 then 0 else round("首月去化套数"/"首开推售套数",4)  end as FM_SALE_RATE_BY_COUNT---首月去化率(按套数)
,"首月去化面积" as FM_SALE_OUT_AREA
,case when 首开推售面积=0 then 0 else round("首月去化面积"/"首开推售面积",4) end as FM_SALE_RATE_BY_AREA --首月去化率(按面积)
,"首月去化货值" as FM_SALE_OUT_MONEY
,case when 首开推售货值=0 then 0 else round("首月去化货值"/"首开推售货值",4) end as FM_SALE_RATE_BY_MONEY --首月去化率(按货值)
,"首开推售货值"-"首月去化货值" as FM_SURPLUS_SALE_MONEY---首月剩余货值
,case when 首开推售面积=0 then 0 else round("首开推售货值"/"首开推售面积",4)  end  as FM_SALE_AVERAGE_MONEY---首月标准均价
,case when 首月去化面积=0 then 0 else round("首月去化货值"/"首月去化面积",4)  end as FM_SALE_OUT_AVERAGE_MONEY---首月签约均价
-----------------------------------首开半年去化率开始------------------------------------------
,"首开半年去化套数" as FOHY_SALE_OUT_COUNT---首开半年去化套数
,"首开半年推售套数" as FOHY_SALE_COUNT---首开半年推售套数
,case when 首开半年推售套数=0 then 0 else round("首开半年去化套数"/"首开半年推售套数",4)  end as FOHY_SALE_RATE_BY_COUNT---首开半年去化率(按套数)
,"首开半年去化面积" as FOHY_SALE_OUT_AREA---首开半年去化面积
,"首开半年推售面积" as FOHY_SALE_AREA---首开半年推售面积
,case when 首开半年推售面积=0 then 0 else round("首开半年去化面积"/"首开半年推售面积",4)  end as FOHY_SALE_RATE_BY_AREA---首开半年去化率(按面积)
,"首开半年去化货值" as FOHY_SALE_OUT_MONEY---首开半年去化货值
,"首开半年推售货值" as FOHY_SALE_MONEY---首开半年推售货值
,case when 首开半年推售货值=0 then 0 else round("首开半年去化货值"/"首开半年推售货值",4)  end as FOHY_SALE_RATE_BY_MONEY---首开半年去化率(按货值)
,"首开半年推售货值"-"首开半年去化货值" as FOHY_SURPLUS_SALE_MONEY---首开半年剩余货值
,case when 首开半年推售面积=0 then 0 else round("首开半年推售货值"/"首开半年推售面积",4)  end  as FOHY_SALE_AVERAGE_MONEY---首开半年标准均价
,case when 首开半年去化面积=0 then 0 else round("首开半年去化货值"/"首开半年去化面积",4)  end as FOHY_SALE_OUT_AVERAGE_MONEY---首开半年签约均价
---------------------------------------竣工备案去化率----------------------------------------
,"竣备去化套数" as CR_SALE_OUT_COUNT 
,"已竣备总套数" as CR_SALE_COUNT
,case when 已竣备总套数=0 then 0 else round("竣备去化套数"/"已竣备总套数",4)  end as CR_SALE_RATE_BY_COUNT---竣备去化率(按套数)
,"竣备去化面积" as CR_SALE_OUT_AREA
,"已竣备总面积" as CR_SALE_AREA
,case when 已竣备总面积=0 then 0 else round("竣备去化面积"/"已竣备总面积",4)  end as CR_SALE_RATE_BY_AREA---竣备去化率(按面积)
,"竣备去化货值" as CR_SALE_OUT_MONEY
,"已竣备总货值" as CR_SALE_MONEY
,case when 已竣备总货值=0 then 0 else round("竣备去化货值"/"已竣备总货值",4)  end as CR_SALE_RATE_BY_MONEY---竣备去化率(按货值)
,"已竣备总货值"-"竣备去化货值" as CR_SURPLUS_SALE_MONEY---竣工备案剩余货值
,case when 已竣备总面积=0 then 0 else round("已竣备总货值"/"已竣备总面积",4)  end  as CR_SALE_AVERAGE_MONEY---竣工备案标准均价
,case when 竣备去化面积=0 then 0 else round("竣备去化货值"/"竣备去化面积",4)  end as CR_SALE_OUT_AVERAGE_MONEY---竣备签约均价

-----------------------------------------竣工备案一年去化率-----------------------------------
,"竣备一年去化套数" as CROY_SALE_OUT_COUNT
,"已竣备一年总套数" as CROY_SALE_COUNT
,case when 已竣备一年总套数 =0 then 0 else round("竣备一年去化套数"/"已竣备一年总套数",4) end as CROY_SALE_RATE_BY_COUNT ---竣备一年去化率（按套数）
,"竣备一年去化面积" as CROY_SALE_OUT_AREA
,"已竣备一年总面积" as CROY_SALE_AREA
,case when 已竣备一年总面积 =0 then 0 else round("竣备一年去化面积"/"已竣备一年总面积",4) end as CROY_SALE_RATE_BY_AREA ---竣备一年去化率(按面积)
,"竣备一年去化货值" as CROY_SALE_OUT_MONEY
,"已竣备一年总货值" as CROY_SALE_MONEY 
,case when 已竣备一年总货值 =0 then 0 else round("竣备一年去化货值"/"已竣备一年总货值",4) end as CROY_SALE_RATE_BY_MONEY ---竣备一年去化率（按货值）
,"已竣备一年总货值"-"竣备一年去化套数" as CROY_SURPLUS_SALE_MONEY---竣工备案一年剩余货值
,case when 已竣备一年总面积=0 then 0 else round("已竣备一年总货值"/"已竣备一年总面积",4)  end  as CROY_SALE_AVERAGE_MONEY---竣工备案一年标准均价
,case when 竣备一年去化面积=0 then 0 else round("竣备一年去化货值"/"竣备一年去化面积",4)  end as CROY_SALE_OUT_AVERAGE_MONEY---竣备一年签约均价

----------------------------- 业态面积段特有 end
from 
(select 
--------------------------------------------------基础计算字段开始-----
------首次开盘30天内的签约金额（首开去化货值）: 
---------->房间“合同成交总价”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约
sum(case when room.SALE_STATE='签约' 
-- 首开分期房间
and FIRST_OPEN_PERIOD.id is not null
--and proj.first_open_date<=build.GET_PRE_SALE_PERMIT_DATE
and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30 then room.TRADE_TOTAL else 0 end ) as "首开去化货值"

------首次开盘已取证货值（首开推售货值）：
------调整：楼栋预售许可证日期 = 首开日期 当天

--,sum(case when room.SALE_STATE='签约'
---- 首开分期房间
--and FIRST_OPEN_PERIOD.id is not null
----and build.GET_PRE_SALE_PERMIT_DATE<=proj.first_open_date  
--and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30
--then room.TRADE_TOTAL 
--when build.GET_PRE_SALE_PERMIT_DATE<=proj.first_open_date
---- 首开分期房间
--and FIRST_OPEN_PERIOD.id is not null
--then room.BZ_TOTAL else 0 end )  as "首开推售货值"

,sum(case when build.GET_PRE_SALE_PERMIT_DATE = proj.first_open_date then room.BZ_TOTAL else 0 end) as "首开推售货值"

------首次开盘30天内的签约面积（首开去化面积）:
---------->房间“最新建筑面积”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' 
-- 首开分期房间
and FIRST_OPEN_PERIOD.id is not null
--and proj.first_open_date<=build.GET_PRE_SALE_PERMIT_DATE 
and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30  then room.NEW_BLD_AREA else 0 end ) as "首开去化面积"

------首次开盘的已取证面积（首开推售面积）:
------调整：楼栋预售许可证日期 = 首开日期 当天
,sum(case when build.GET_PRE_SALE_PERMIT_DATE = proj.first_open_date then room.NEW_BLD_AREA else 0 end) as "首开推售面积"


------首次开盘30天内的签约套数（首开去化套数）:
---------->房间“汇总”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约  
--,sum(case when room.SALE_STATE='签约' and proj.first_open_date<=build.GET_PRE_SALE_PERMIT_DATE           and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30 then 1 else 0 end ) as "首开去化套数"
,sum(case when room.SALE_STATE='签约' 
-- 首开分期房间
and FIRST_OPEN_PERIOD.id is not null
          --and proj.first_open_date<=build.GET_PRE_SALE_PERMIT_DATE 
and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30 then 1 else 0 end ) as "首开去化套数"


------首次开盘的已取证套数（首开推售套数）:
------调整：楼栋预售许可证日期 = 首开日期 当天
,sum(case when build.GET_PRE_SALE_PERMIT_DATE = proj.first_open_date then 1 else 0 end) as "首开推售套数"




------全案------全案------全案------全案------全案------全案------全案 
------全案（已去化货值）: 
---------->房间“合同成交总价”
---------->房间“销售状态”=签约
,sum(case when room.SALE_STATE='签约' then room.TRADE_TOTAL else 0 end ) as "全案已去化货值"
------全案（已领证货值）：
---------->房间“面价标准总价”:在计算“货值去化率”时，对已签约房间（有可能出现优惠打折），分子分母均按“签约金额”计算“货值去化率”。
,sum(case when room.SALE_STATE='签约'  then room.TRADE_TOTAL  
when room.SALE_STATE<>'签约' and build.GET_PRE_SALE_PERMIT_DATE is not null then room.BZ_TOTAL else 0 end )  as "全案已领证货值"
------全案（已去化面积）:
---------->房间“最新建筑面积”
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约'  then room.NEW_BLD_AREA else 0 end ) as "全案已去化面积"
------全案（已领证面积）:
---------->房间“最新建筑面积”
,sum(case when room.SALE_STATE='签约' or build.GET_PRE_SALE_PERMIT_DATE is not null then room.NEW_BLD_AREA  else 0 end )  as "全案已领证面积"
------全案（已去化套数):
---------->房间“汇总”
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' then 1 else 0 end ) as "全案已去化套数"
------全案（已领证套数):
---------->房间“汇总”
,sum(case when room.SALE_STATE='签约' or build.GET_PRE_SALE_PERMIT_DATE is not null then 1 else 0 end )  as "全案已领证套数"
------现房------现房------现房------现房------现房------现房------现房------现房------现房
----现房去化面积
,sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE = '签约' and room.TRADE_CONTRACT_DATE>proj.COMPLETION_RECORD_DATE then  room.NEW_BLD_AREA else 0 end) as "现房去化面积" ,
----现房推售面积
sum(case when  proj.COMPLETION_RECORD_DATE is not null and   (room.SALE_STATE <> '签约'
or  (room.SALE_STATE = '签约' and room.TRADE_CONTRACT_DATE>proj.COMPLETION_RECORD_DATE) )   then room.NEW_BLD_AREA else 0 end) as 现房推售面积,
----现房去化金额
sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE = '签约' and room.TRADE_CONTRACT_DATE>proj.COMPLETION_RECORD_DATE then  room.TRADE_TOTAL else 0 end) as  现房去化金额,
--推售金额需要根据房间是否已经签约来判断取签约金额还是标准金额
----现房推售金额
sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE <> '签约'   then room.BZ_TOTAL  
when room.SALE_STATE = '签约' and proj.COMPLETION_RECORD_DATE is not null and  room.TRADE_CONTRACT_DATE>proj.COMPLETION_RECORD_DATE then room.TRADE_TOTAL else 0 end) as 现房推售金额,
----现房去化套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE = '签约' and room.TRADE_CONTRACT_DATE>proj.COMPLETION_RECORD_DATE then  1 else 0 end) as  现房去化套数,
----现房推售套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null and  (room.SALE_STATE <> '签约'
or  (room.SALE_STATE = '签约' and room.TRADE_CONTRACT_DATE>proj.COMPLETION_RECORD_DATE) )  then 1 else 0 end) as 现房推售套数
------顽固性库存------顽固性库存------顽固性库存------顽固性库存------顽固性库存------顽固性库存------顽固性库存
----顽固推售面积
,sum(case when  proj.COMPLETION_RECORD_DATE is not null  and room.SALE_STATE = '签约' and  room.PRODUCT_NAME <> '住宅' 
and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and room.TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd')
and room.TRADE_CONTRACT_DATE<sysdate then  room.NEW_BLD_AREA else 0 end) as 顽固去化面积,
----顽固去化面积
sum(case when  proj.COMPLETION_RECORD_DATE is not null  
and  room.PRODUCT_NAME <> '住宅' 
and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and ((TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and  room.TRADE_CONTRACT_DATE<sysdate  and room.SALE_STATE = '签约') or  room.SALE_STATE <> '签约') then room.NEW_BLD_AREA else 0 end) as 顽固推售面积,
----顽固去化金额
sum(case when  proj.COMPLETION_RECORD_DATE is not null  and room.SALE_STATE = '签约' 
and  room.PRODUCT_NAME <> '住宅' 
and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and room.TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd')
and  room.TRADE_CONTRACT_DATE<sysdate  then  room.TRADE_TOTAL else 0 end) as  顽固去化金额,
--推售金额需要根据房间是否已经签约来判断取签约金额还是标准金额
----顽固推售金额
sum(case  when  proj.COMPLETION_RECORD_DATE is not null  
and  room.PRODUCT_NAME <> '住宅'
and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and (TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and  room.TRADE_CONTRACT_DATE<sysdate  and room.SALE_STATE = '签约') then room.TRADE_TOTAL  --已经在今年签约的算签约金额
 when  proj.COMPLETION_RECORD_DATE is not null  and  room.PRODUCT_NAME <> '住宅' 
 and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
 and  room.SALE_STATE <> '签约' then room.BZ_TOTAL  else 0 end) as 顽固推售金额,  --未签约的算校准总价
----顽固去化套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null 
and room.SALE_STATE = '签约' 
and  room.PRODUCT_NAME <> '住宅' 
and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and room.TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and  room.TRADE_CONTRACT_DATE<sysdate then  1 else 0 end) as  顽固去化套数,
----顽固推售套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null  
and  room.PRODUCT_NAME <> '住宅' 
and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and ((TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and  room.TRADE_CONTRACT_DATE<sysdate  and room.SALE_STATE = '签约') or  room.SALE_STATE <> '签约') then 1 else 0 end) as 顽固推售套数
------------------------------------------首月去化率------------------------------------
-----------首次开盘后一个月内首批供货实际签约额（首月去化货值）
--“合同成交总价” TRADE_TOTAL
--SALE_STATE 房间销售状态“签约”
,sum(case when room.SALE_STATE='签约' 
and proj.first_open_date=build.GET_PRE_SALE_PERMIT_DATE 
and room.TRADE_CONTRACT_DATE >= proj.first_open_date 
and room.TRADE_CONTRACT_DATE<=proj.first_open_date+30 then room.TRADE_TOTAL else 0 end ) as "首月去化货值"

-------------首次开盘后一个月 首次开盘 至 项目首次开盘日期+30天 的签约建筑面积 （首月去化面积）
---------->房间“最新建筑面积”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' 
and proj.first_open_date=build.GET_PRE_SALE_PERMIT_DATE 
and room.TRADE_CONTRACT_DATE >= proj.first_open_date
and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30  then room.NEW_BLD_AREA else 0 end ) as "首月去化面积"

------首次开盘30天内的签约套数（首开去化套数）:
---------->房间“汇总”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约  
--,sum(case when room.SALE_STATE='签约' and proj.first_open_date<=build.GET_PRE_SALE_PERMIT_DATE           and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30 then 1 else 0 end ) as "首开去化套数"
,sum(case when room.SALE_STATE='签约' 
and proj.first_open_date=build.GET_PRE_SALE_PERMIT_DATE 
and room.TRADE_CONTRACT_DATE >=proj.first_open_date
and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30 then 1 else 0 end ) as "首月去化套数",


-------------------------------------------------------------首开半年去化率--------------
------首次开盘180天内的签约金额（首开半年去化货值）: 
---------->房间“合同成交总价”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +180天
---------->房间“销售状态”=签约
sum(case when room.SALE_STATE='签约' 
and room.TRADE_CONTRACT_DATE >= proj.first_open_date
and proj.first_open_date=build.GET_PRE_SALE_PERMIT_DATE
and room.TRADE_CONTRACT_DATE<=proj.first_open_date +180 then room.TRADE_TOTAL else 0 end ) as "首开半年去化货值"

------首次开盘已取证货值（首开半年推售货值）：
---------->房间“面价标准总价”:在计算“货值去化率”时，对已签约房间（有可能出现优惠打折），分子分母均按“签约金额”计算“货值去化率”。
---------->房间所属“楼栋预售许可证获取日期”<"项目开盘"的实际完成日期 
,sum(case when build.GET_PRE_SALE_PERMIT_DATE = proj.first_open_date then room.BZ_TOTAL else 0 end) as "首开半年推售货值"

------首次开盘180天内的签约面积（首开半年去化面积）:
---------->房间“最新建筑面积”
---------->"项目开盘"的实际完成日期 < 合同签约日期< "项目开盘"的实际完成日期 +180天
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' 
and FIRST_OPEN_PERIOD.id is not null
and proj.first_open_date=build.GET_PRE_SALE_PERMIT_DATE
and room.TRADE_CONTRACT_DATE >= proj.first_open_date and room.TRADE_CONTRACT_DATE<=proj.first_open_date +180  then room.NEW_BLD_AREA else 0 end ) as "首开半年去化面积"

------首次开盘的“已取证”面积（首开半年推售面积）:
,sum(case when build.GET_PRE_SALE_PERMIT_DATE = proj.first_open_date then room.NEW_BLD_AREA else 0 end) as "首开半年推售面积"

------首次开盘180天内的签约套数（首开半年去化套数）:
-----------项目首次开盘”至“项目首次开盘日期+180天”的签约套数
---------->房间“汇总”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +180天
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' 
and proj.first_open_date=build.GET_PRE_SALE_PERMIT_DATE
and room.TRADE_CONTRACT_DATE >= proj.first_open_date
and room.TRADE_CONTRACT_DATE<=proj.first_open_date +180 then 1 else 0 end ) as "首开半年去化套数"


------首次开盘的已取证套数（首开半年推售套数）:
,sum(case when build.GET_PRE_SALE_PERMIT_DATE = proj.first_open_date then 1 else 0 end) as "首开半年推售套数"

------------------------------------------------------竣工备案去化率-----------------------------------------
-----------------竣工备案去化套数（竣工备案当天及之前”的“签约套数）
------------> 竣工备案当天及之前”的“签约套数”
------------- 项目竣工备案日期必须有值，为null则未竣工备案
-------------合同签约日期 <= 竣工备案日期
,sum(
    case when room.SALE_STATE='签约' and
--    项目竣工备案日期
    proj.COMPLETION_ON_RECORD_DATE is not null and build.GET_PRE_SALE_PERMIT_DATE is not null
--    合同签约日期 <= 竣工备案日期
    and room.TRADE_CONTRACT_DATE <= proj.COMPLETION_ON_RECORD_DATE  then 1 else 0 end
) as "竣备去化套数"

-----------------已竣备总套数（竣工备案当天及之前”的 已取证的套数）
,sum(case when proj.COMPLETION_ON_RECORD_DATE is not null  then 1 else 0 end) as "已竣备总套数"


------竣工备案当天及之前”的“签约建筑面积:
---------->竣工备案当天及之前”的“签约建筑面积
---------->房间“最新建筑面积”
---------->合同签约日期<"竣工备案"的实际完成日期
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' and proj.COMPLETION_ON_RECORD_DATE is not null and build.GET_PRE_SALE_PERMIT_DATE is not null
----签约合同日期
and room.TRADE_CONTRACT_DATE<=proj.COMPLETION_ON_RECORD_DATE  then room.NEW_BLD_AREA else 0 end ) as "竣备去化面积"

----------------竣工备案已取证面积:
,sum(case when proj.COMPLETION_ON_RECORD_DATE is not null  then room.NEW_BLD_AREA else 0 end) as "已竣备总面积"


------------楼栋竣工备案当天及之前”的“签约金额: 
---------->房间“合同成交总价”
---------->合同签约日期<"竣工备案"完成日期 
---------->房间“销售状态”=签约
,sum(case when proj.COMPLETION_ON_RECORD_DATE is not null and build.GET_PRE_SALE_PERMIT_DATE is not null and  room.SALE_STATE='签约' 
-- 合同签约日期
and room.TRADE_CONTRACT_DATE<=proj.COMPLETION_ON_RECORD_DATE  then room.TRADE_TOTAL else 0 end ) as "竣备去化货值"


------分期楼栋竣工备案楼栋”最新的“动态版目标货值（已竣备总货值）：
,sum(case when proj.COMPLETION_ON_RECORD_DATE is not null then room.BZ_TOTAL else 0 end )as "已竣备总货值"


---------------------------------------------竣工备案后一年去化率----------------------------------------------
-----------竣工备案+1天"至“竣工备案+1年”的“签约套数”（竣备一年去化套数）在竣工备案后签约的
------------> 竣工备案当天及之前”的“签约套数”
------------- 项目竣工备案日期必须有值，为null则未竣工备案
-------------  竣工备案日期 < 合同签约日期 <= 竣工备案日期+360天
------------->  预售许可证日期 
,sum(
    case when room.SALE_STATE='签约' and room.PRE_SELL_PERMIT_DATE is not null
--    项目竣工备案日期
    and proj.COMPLETION_ON_RECORD_DATE is not null and build.GET_PRE_SALE_PERMIT_DATE is not null
--    竣工备案日期 < 合同签约日期 <= 竣工备案日期+360  and 预售许可证日期 <= 竣工备案日期+360
    and proj.COMPLETION_ON_RECORD_DATE < room.TRADE_CONTRACT_DATE and room.TRADE_CONTRACT_DATE <= proj.COMPLETION_ON_RECORD_DATE +360 
    and room.PRE_SELL_PERMIT_DATE<=proj.COMPLETION_ON_RECORD_DATE+360  then 1 else 0 end
) as "竣备一年去化套数"

-----------------已竣备总套数（竣工备案当天及之前”的 已取证的套数）
,sum(case when proj.COMPLETION_ON_RECORD_DATE is not null then 1 else 0 end) as "已竣备一年总套数"

-------->竣工备案+1天"至“竣工备案+1年”的签约建筑面积
---------->房间“最新建筑面积”
---------->竣工备案日期 < 合同签约日期 <= "竣工备案+360
---------->房间“销售状态”=签约  
----------> 有楼栋预售许可证
,sum(case when room.SALE_STATE='签约' and build.GET_PRE_SALE_PERMIT_DATE is not null
----  竣工备案日期 < 签约合同日期 <= 竣工备案日期+360
and proj.COMPLETION_ON_RECORD_DATE < room.TRADE_CONTRACT_DATE and room.TRADE_CONTRACT_DATE<=proj.COMPLETION_ON_RECORD_DATE+360 
and room.PRE_SELL_PERMIT_DATE<=proj.COMPLETION_ON_RECORD_DATE   then room.NEW_BLD_AREA else 0 end ) as "竣备一年去化面积"

----------------竣工备案已取证面积:
,sum(case when proj.COMPLETION_ON_RECORD_DATE is not null  then room.NEW_BLD_AREA else 0 end) as "已竣备一年总面积"

------------竣工备案当天+1天"至“竣工备案+1年”的签约金额
---------->房间“合同成交总价”
----------> 竣工备案日期 < 合同签约日期<"竣工备案日期 +360
---------->房间“销售状态”=签约
,sum(case when room.PRE_SELL_PERMIT_DATE is not null and  room.SALE_STATE='签约' 
-- 合同签约日期
and proj.COMPLETION_ON_RECORD_DATE < room.TRADE_CONTRACT_DATE 
and  room.TRADE_CONTRACT_DATE<=proj.COMPLETION_ON_RECORD_DATE + 360  then room.TRADE_TOTAL else 0 end ) as "竣备一年去化货值"


------分期楼栋竣工备案楼栋”最新的“动态版目标货值（已竣备一年总货值）：
,sum(case when proj.COMPLETION_ON_RECORD_DATE is not null then room.BZ_TOTAL else 0 end )as "已竣备一年总货值"

--------------------------------------------------基础计算字段结束

,proj.project_id,
proj.project_name,
proj.org_id,
proj.org_name,
proj.first_open_date,
proj.obtain_date,
proj.COMPLETION_RECORD_DATE,
proj.take_land_date,
proj.plan_first_open_date,
proj.first_open_duration_by_tl,
proj.first_open_duration_by_plan,
proj.new_plan_first_open_date,
proj.exhibition_area_open_date,
proj.plan_approval_date,
proj.is_operate,
proj.is_construction_began
,t_room.AREA_LEVEL
,t_room.PRODUCT_NAME 
from tmp_proj_base proj
left join MDM_ROOM room  on proj.project_id=room.project_id  and  proj.id = PROJ_BASE_SPID
left join TMP_ROOM t_room on  room.id=t_room.room_id
left join  mdm_build build on room.BUILDING_ID=build.id 
-- chenl 20200613 只取首开楼栋
left join  SYS_PROJECT_STAGE FIRST_OPEN_PERIOD on build.PERIOD_ID=FIRST_OPEN_PERIOD.id  
AND FIRST_OPEN_PERIOD.IS_FIRST_OPEN_PERIOD=1
group by proj.project_id
-------------------- 业态面积段特有 start
    ,t_room.AREA_LEVEL
    ,t_room.PRODUCT_NAME
----------------------业态面积段特有 end
    ,proj.project_name,
    proj.org_id,
    proj.org_name,
    proj.first_open_date,
    proj.obtain_date,
    proj.COMPLETION_RECORD_DATE,
    proj.take_land_date,
    proj.plan_first_open_date,
    proj.first_open_duration_by_tl,
    proj.first_open_duration_by_plan,
    proj.new_plan_first_open_date,
    proj.exhibition_area_open_date,
    proj.plan_approval_date,
    proj.is_operate,
    proj.is_construction_began
    ) result 
-------------------- 业态面积段特有 start
   where  PRODUCT_NAME  is not null
----------------------业态面积段特有 end
;

OPEN spid_info FOR select * from TMP_SALE_RATE_BY_GRANULARITY where id=spid;  
------------------------------------------------------数据移入历史表;
INSERT INTO  dwm_sale_rate_gran_history (
    id,
    project_id,
    fo_sale_out_count,
    fo_sale_count,
    fo_sale_rate_by_count,
    fo_sale_out_area,
    fo_sale_area,
    fo_sale_rate_by_area,
    fo_sale_out_money,
    fo_sale_money,
    fo_sale_rate_by_money,
    fo_surplus_sale_money,
    fo_sale_average_money,
    fo_sale_out_average_money,
    po_sale_out_count,
    po_sale_count,
    po_sale_rate_by_count,
    po_sale_out_area,
    po_sale_area,
    po_sale_rate_by_area,
    po_sale_out_money,
    po_sale_money,
    po_sale_rate_by_money,
    po_surplus_sale_money,
    po_sale_average_money,
    po_sale_out_average_money,
    eh_sale_out_count,
    eh_sale_count,
    eh_sale_rate_by_count,
    eh_sale_out_area,
    eh_sale_area,
    eh_sale_rate_by_area,
    eh_sale_out_money,
    eh_sale_money,
    eh_sale_rate_by_money,
    eh_surplus_sale_money,
    eh_sale_average_money,
    eh_sale_out_average_money,
    si_sale_out_count,
    si_sale_count,
    si_sale_rate_by_count,
    si_sale_out_area,
    si_sale_area,
    si_sale_rate_by_area,
    si_sale_out_money,
    si_sale_money,
    si_sale_rate_by_money,
    si_surplus_sale_money,
    si_sale_average_money,
    si_sale_out_average_money,
    parent_id,
    data_granularity,
    created,
    remark,
    sort,
    fm_sale_out_count,
    fm_sale_rate_by_count,
    fm_sale_out_area,
    fm_sale_rate_by_area,
    fm_sale_out_money,
    fm_sale_rate_by_money,
    fm_surplus_sale_money,
    fm_sale_average_money,
    fm_sale_out_average_money,
    fohy_sale_out_count,
    fohy_sale_count,
    fohy_sale_rate_by_count,
    fohy_sale_out_area,
    fohy_sale_area,
    fohy_sale_rate_by_area,
    fohy_sale_out_money,
    fohy_sale_money,
    fohy_sale_rate_by_money,
    fohy_surplus_sale_money,
    fohy_sale_average_money,
    fohy_sale_out_average_money,
    cr_sale_count,
    cr_sale_rate_by_count,
    cr_sale_out_area,
    cr_sale_area,
    cr_sale_rate_by_area,
    cr_sale_out_money,
    cr_sale_money,
    cr_sale_rate_by_money,
    cr_surplus_sale_money,
    cr_sale_average_money,
    cr_sale_out_average_money,
    croy_sale_out_count,
    croy_sale_count,
    croy_sale_rate_by_count,
    croy_sale_out_area,
    croy_sale_area,
    croy_sale_rate_by_area,
    croy_sale_out_money,
    croy_sale_money,
    croy_sale_rate_by_money,
    croy_surplus_sale_money,
    croy_sale_average_money,
    croy_sale_out_average_money
)
SELECT
    id,
    project_id,
    fo_sale_out_count,
    fo_sale_count,
    fo_sale_rate_by_count,
    fo_sale_out_area,
    fo_sale_area,
    fo_sale_rate_by_area,
    fo_sale_out_money,
    fo_sale_money,
    fo_sale_rate_by_money,
    fo_surplus_sale_money,
    fo_sale_average_money,
    fo_sale_out_average_money,
    po_sale_out_count,
    po_sale_count,
    po_sale_rate_by_count,
    po_sale_out_area,
    po_sale_area,
    po_sale_rate_by_area,
    po_sale_out_money,
    po_sale_money,
    po_sale_rate_by_money,
    po_surplus_sale_money,
    po_sale_average_money,
    po_sale_out_average_money,
    eh_sale_out_count,
    eh_sale_count,
    eh_sale_rate_by_count,
    eh_sale_out_area,
    eh_sale_area,
    eh_sale_rate_by_area,
    eh_sale_out_money,
    eh_sale_money,
    eh_sale_rate_by_money,
    eh_surplus_sale_money,
    eh_sale_average_money,
    eh_sale_out_average_money,
    si_sale_out_count,
    si_sale_count,
    si_sale_rate_by_count,
    si_sale_out_area,
    si_sale_area,
    si_sale_rate_by_area,
    si_sale_out_money,
    si_sale_money,
    si_sale_rate_by_money,
    si_surplus_sale_money,
    si_sale_average_money,
    si_sale_out_average_money,
    parent_id,
    data_granularity,
    created,
    remark,
    sort,
    fm_sale_out_count,
    fm_sale_rate_by_count,
    fm_sale_out_area,
    fm_sale_rate_by_area,
    fm_sale_out_money,
    fm_sale_rate_by_money,
    fm_surplus_sale_money,
    fm_sale_average_money,
    fm_sale_out_average_money,
    fohy_sale_out_count,
    fohy_sale_count,
    fohy_sale_rate_by_count,
    fohy_sale_out_area,
    fohy_sale_area,
    fohy_sale_rate_by_area,
    fohy_sale_out_money,
    fohy_sale_money,
    fohy_sale_rate_by_money,
    fohy_surplus_sale_money,
    fohy_sale_average_money,
    fohy_sale_out_average_money,
    cr_sale_count,
    cr_sale_rate_by_count,
    cr_sale_out_area,
    cr_sale_area,
    cr_sale_rate_by_area,
    cr_sale_out_money,
    cr_sale_money,
    cr_sale_rate_by_money,
    cr_surplus_sale_money,
    cr_sale_average_money,
    cr_sale_out_average_money,
    croy_sale_out_count,
    croy_sale_count,
    croy_sale_rate_by_count,
    croy_sale_out_area,
    croy_sale_area,
    croy_sale_rate_by_area,
    croy_sale_out_money,
    croy_sale_money,
    croy_sale_rate_by_money,
    croy_surplus_sale_money,
    croy_sale_average_money,
    croy_sale_out_average_money
FROM
    dwm_sale_rate_by_granularity;
commit;
------------------------------------------------------删除已移入历史表树；
DELETE FROM DWM_SALE_RATE_BY_GRANULARITY ;--where REMARK=dwm_REMARK;
commit;
--------------------------------------------------------新增拍照数据;
INSERT INTO DWM_SALE_RATE_BY_GRANULARITY (
ID---【1】主键
,sort
,PROJECT_ID---【2】项目ID
,FO_SALE_OUT_COUNT---【3】首开去化套数
,FO_SALE_COUNT---【4】首开推售套数
,FO_SALE_RATE_BY_COUNT---【5】首开去化率(按套数)（3/4）
,FO_SALE_OUT_AREA---【6】首开去化面积
,FO_SALE_AREA---【7】首开推售面积
,FO_SALE_RATE_BY_AREA---【8】首开去化率(按面积)（6/7）
,FO_SALE_OUT_MONEY---【9】首开去化货值
,FO_SALE_MONEY---【10】首开推售货值
,FO_SALE_RATE_BY_MONEY---【11】首开去化率(按货值)（9/10）
,FO_SURPLUS_SALE_MONEY---【12】首开剩余货值(10-9)
,FO_SALE_AVERAGE_MONEY---【13】首开标准均价(10/7)
,FO_SALE_OUT_AVERAGE_MONEY---【14】首开签约均价(9/6)
,PO_SALE_OUT_COUNT---【15】全案去化套数
,PO_SALE_COUNT---【16】全案推售套数
,PO_SALE_RATE_BY_COUNT---【17】全案去化率(按套数)(15/16)
,PO_SALE_OUT_AREA---【18】全案去化面积
,PO_SALE_AREA---【19】全案推售面积
,PO_SALE_RATE_BY_AREA---【20】全案去化率(按面积)(18/19)
,PO_SALE_OUT_MONEY---【21】全案去化货值
,PO_SALE_MONEY---【22】全案推售货值
,PO_SALE_RATE_BY_MONEY---【23】全案去化率(按货值)(21/22)
,PO_SURPLUS_SALE_MONEY---【24】全案剩余货值(22-21)
,PO_SALE_AVERAGE_MONEY---【25】全案标准均价(22/19)
,PO_SALE_OUT_AVERAGE_MONEY---【26】全案签约均价(21/18)
,EH_SALE_OUT_COUNT---【27】现房去化套数
,EH_SALE_COUNT---【28】现房推售套数
,EH_SALE_RATE_BY_COUNT---【29】现房去化率(按套数)(27/28)
,EH_SALE_OUT_AREA---【30】现房去化面积
,EH_SALE_AREA---【31】现房推售面积
,EH_SALE_RATE_BY_AREA---【32】现房去化率(按面积)(30/31)
,EH_SALE_OUT_MONEY---【33】现房去化货值
,EH_SALE_MONEY---【34】现房推售货值
,EH_SALE_RATE_BY_MONEY---【35】现房去化率(按货值)(33/34)
,EH_SURPLUS_SALE_MONEY---【36】现房剩余货值(34-33)
,EH_SALE_AVERAGE_MONEY---【37】现房标准均价(34/31)
,EH_SALE_OUT_AVERAGE_MONEY---【38】现房签约均价(33/30)
,SI_SALE_OUT_COUNT---【39】顽固性库存去化套数
,SI_SALE_COUNT---【40】顽固性库存推售套数
,SI_SALE_RATE_BY_COUNT---【41】顽固性库存去化率(按套数)(39/40)
,SI_SALE_OUT_AREA---【42】顽固性库存去化面积
,SI_SALE_AREA---【43】顽固性库存推售面积
,SI_SALE_RATE_BY_AREA---【44】顽固性库存去化率(按面积)(42/43)
,SI_SALE_OUT_MONEY---【45】顽固性库存去化货值
,SI_SALE_MONEY---【46】顽固性库存推售货值
,SI_SALE_RATE_BY_MONEY---【47】顽固性库存去化率(按货值)(45/46)
,SI_SURPLUS_SALE_MONEY---【48】顽固性库存剩余货值(46-45)
,SI_SALE_AVERAGE_MONEY---【49】顽固性库存标准均价(46/43)
,SI_SALE_OUT_AVERAGE_MONEY---【50】顽固性库存签约均价(45/42)
,PARENT_ID  
,DATA_GRANULARITY 
,CREATED---【51】创建日期
,REMARK---【52】备注信息
,FM_SALE_OUT_COUNT
,FM_SALE_RATE_BY_COUNT
,FM_SALE_OUT_AREA
,FM_SALE_RATE_BY_AREA
,FM_SALE_OUT_MONEY
,FM_SALE_RATE_BY_MONEY
,FM_SURPLUS_SALE_MONEY
,FM_SALE_AVERAGE_MONEY
,FM_SALE_OUT_AVERAGE_MONEY
,FOHY_SALE_OUT_COUNT---首开半年去化套数
,FOHY_SALE_COUNT---首开半年推售套数
,FOHY_SALE_RATE_BY_COUNT---首开半年去化率(按套数)
,FOHY_SALE_OUT_AREA---首开半年去化面积
,FOHY_SALE_AREA---首开半年推售面积
,FOHY_SALE_RATE_BY_AREA---首开半年去化率(按面积)
,FOHY_SALE_OUT_MONEY---首开半年去化货值
,FOHY_SALE_MONEY---首开半年推售货值
,FOHY_SALE_RATE_BY_MONEY---首开半年去化率(按货值)
,FOHY_SURPLUS_SALE_MONEY---首开半年剩余货值
,FOHY_SALE_AVERAGE_MONEY---首开半年标准均价
,FOHY_SALE_OUT_AVERAGE_MONEY---首开半年签约均价
,CR_SALE_OUT_COUNT---竣备去化套数
,CR_SALE_COUNT---已竣备总套数
,CR_SALE_RATE_BY_COUNT---竣备去化率(按套数)
,CR_SALE_OUT_AREA---竣备去化面积
,CR_SALE_AREA---已竣备总面积
,CR_SALE_RATE_BY_AREA---竣备去化率(按面积)
,CR_SALE_OUT_MONEY---竣备去化货值
,CR_SALE_MONEY---已竣备总货值
,CR_SALE_RATE_BY_MONEY---竣备去化率(按货值)
,CR_SURPLUS_SALE_MONEY---竣工备案剩余货值
,CR_SALE_AVERAGE_MONEY---标准均价
,CR_SALE_OUT_AVERAGE_MONEY---签约均价
,CROY_SALE_OUT_COUNT
,CROY_SALE_COUNT
,CROY_SALE_RATE_BY_COUNT
,CROY_SALE_OUT_AREA
,CROY_SALE_AREA
,CROY_SALE_RATE_BY_AREA
,CROY_SALE_OUT_MONEY
,CROY_SALE_MONEY
,CROY_SALE_RATE_BY_MONEY
,CROY_SURPLUS_SALE_MONEY
,CROY_SALE_AVERAGE_MONEY
,CROY_SALE_OUT_AVERAGE_MONEY
        )
   select  tree.GRANULARITY_ID--颗粒度id---【1】主键
   ,tree.sort
,tree.PROJECT_ID,---【2】项目ID
nvl(apdata.fo_sale_out_count,0),
nvl(apdata.fo_sale_count,0),
nvl(apdata.fo_sale_rate_by_count,0),
nvl(apdata.fo_sale_out_area,0),
nvl(apdata.fo_sale_area,0),
nvl(apdata.fo_sale_rate_by_area,0),
nvl(apdata.fo_sale_out_money,0),
nvl(apdata.fo_sale_money,0),
nvl(apdata.fo_sale_rate_by_money,0),
nvl(apdata.fo_surplus_sale_money,0),
nvl(apdata.fo_sale_average_money,0),
nvl(apdata.fo_sale_out_average_money,0),
nvl(apdata.po_sale_out_count,0),
nvl(apdata.po_sale_count,0),
nvl(apdata.po_sale_rate_by_count,0),
nvl(apdata.po_sale_out_area,0),
nvl(apdata.po_sale_area,0),
nvl(apdata.po_sale_rate_by_area,0),
nvl(apdata.po_sale_out_money,0),
nvl(apdata.po_sale_money,0),
nvl(apdata.po_sale_rate_by_money,0),
nvl(apdata.po_surplus_sale_money,0),
nvl(apdata.po_sale_average_money,0),
nvl(apdata.po_sale_out_average_money,0),
nvl(apdata.eh_sale_out_count,0),
nvl(apdata.eh_sale_count,0),
nvl(apdata.eh_sale_rate_by_count,0),
nvl(apdata.eh_sale_out_area,0),
nvl(apdata.eh_sale_area,0),
nvl(apdata.eh_sale_rate_by_area,0),
nvl(apdata.eh_sale_out_money,0),
nvl(apdata.eh_sale_money,0),
nvl(apdata.eh_sale_rate_by_money,0),
nvl(apdata.eh_surplus_sale_money,0),
nvl(apdata.eh_sale_average_money,0),
nvl(apdata.eh_sale_out_average_money,0),
nvl(apdata.si_sale_out_count,0),
nvl(apdata.si_sale_count,0),
nvl(apdata.si_sale_rate_by_count,0),
nvl(apdata.si_sale_out_area,0),
nvl(apdata.si_sale_area,0),
nvl(apdata.si_sale_rate_by_area,0),
nvl(apdata.si_sale_out_money,0),
nvl(apdata.si_sale_money,0),
nvl(apdata.si_sale_rate_by_money,0),
nvl(apdata.si_surplus_sale_money,0),
nvl(apdata.si_sale_average_money,0),
nvl(apdata.si_sale_out_average_money,0)
,tree.PARENT_ID---父级id
,tree.DATA_GRANULARITY--颗粒度名称
,sys_created
,dwm_REMARK,
nvl(apdata.fm_sale_out_count,0),
nvl(apdata.fm_sale_rate_by_count,0),
nvl(apdata.fm_sale_out_area,0),
nvl(apdata.fm_sale_rate_by_area,0),
nvl(apdata.fm_sale_out_money,0),
nvl(apdata.fm_sale_rate_by_money,0),
nvl(apdata.fm_surplus_sale_money,0),
nvl(apdata.fm_sale_average_money,0),
nvl(apdata.fm_sale_out_average_money,0),
nvl(apdata.fohy_sale_out_count,0),
nvl(apdata.fohy_sale_count,0),
nvl(apdata.fohy_sale_rate_by_count,0),
nvl(apdata.fohy_sale_out_area,0),
nvl(apdata.fohy_sale_area,0),
nvl(apdata.fohy_sale_rate_by_area,0),
nvl(apdata.fohy_sale_out_money,0),
nvl(apdata.fohy_sale_money,0),
nvl(apdata.fohy_sale_rate_by_money,0),
nvl(apdata.fohy_surplus_sale_money,0),
nvl(apdata.fohy_sale_average_money,0),
nvl(apdata.fohy_sale_out_average_money,0),
nvl(apdata.cr_sale_out_count,0),
nvl(apdata.cr_sale_count,0),
nvl(apdata.cr_sale_rate_by_count,0),
nvl(apdata.cr_sale_out_area,0),
nvl(apdata.cr_sale_area,0),
nvl(apdata.cr_sale_rate_by_area,0),
nvl(apdata.cr_sale_out_money,0),
nvl(apdata.cr_sale_money,0),
nvl(apdata.cr_sale_rate_by_money,0),
nvl(apdata.cr_surplus_sale_money,0),
nvl(apdata.cr_sale_average_money,0),
nvl(apdata.cr_sale_out_average_money,0),
nvl(apdata.croy_sale_out_count,0),
nvl(apdata.croy_sale_count,0),
nvl(apdata.croy_sale_rate_by_count,0),
nvl(apdata.croy_sale_out_area,0),
nvl(apdata.croy_sale_area,0),
nvl(apdata.croy_sale_rate_by_area,0),
nvl(apdata.croy_sale_out_money,0),
nvl(apdata.croy_sale_money,0),
nvl(apdata.croy_sale_rate_by_money,0),
nvl(apdata.croy_surplus_sale_money,0),
nvl(apdata.croy_sale_average_money,0),
nvl(apdata.croy_sale_out_average_money,0)
from 
( select * from TMP_SALE_RATE_BY_GRANULARITY where id=spid_tree) tree
left join 
( 
    select  parent_id||data_granularity as id,
    project_id,
    fo_sale_out_count,
    fo_sale_count,
    fo_sale_rate_by_count,
    fo_sale_out_area,
    fo_sale_area,
    fo_sale_rate_by_area,
    fo_sale_out_money,
    fo_sale_money,
    fo_sale_rate_by_money,
    fo_surplus_sale_money,
    fo_sale_average_money,
    fo_sale_out_average_money,
    po_sale_out_count,
    po_sale_count,
    po_sale_rate_by_count,
    po_sale_out_area,
    po_sale_area,
    po_sale_rate_by_area,
    po_sale_out_money,
    po_sale_money,
    po_sale_rate_by_money,
    po_surplus_sale_money,
    po_sale_average_money,
    po_sale_out_average_money,
    eh_sale_out_count,
    eh_sale_count,
    eh_sale_rate_by_count,
    eh_sale_out_area,
    eh_sale_area,
    eh_sale_rate_by_area,
    eh_sale_out_money,
    eh_sale_money,
    eh_sale_rate_by_money,
    eh_surplus_sale_money,
    eh_sale_average_money,
    eh_sale_out_average_money,
    si_sale_out_count,
    si_sale_count,
    si_sale_rate_by_count,
    si_sale_out_area,
    si_sale_area,
    si_sale_rate_by_area,
    si_sale_out_money,
    si_sale_money,
    si_sale_rate_by_money,
    si_surplus_sale_money,
    si_sale_average_money,
    si_sale_out_average_money,
    fm_sale_out_count,
    fm_sale_rate_by_count,
    fm_sale_out_area,
    fm_sale_rate_by_area,
    fm_sale_out_money,
    fm_sale_rate_by_money,
    fm_surplus_sale_money,
    fm_sale_average_money,
    fm_sale_out_average_money,
    fohy_sale_out_count,
    fohy_sale_count,
    fohy_sale_rate_by_count,
    fohy_sale_out_area,
    fohy_sale_area,
    fohy_sale_rate_by_area,
    fohy_sale_out_money,
    fohy_sale_money,
    fohy_sale_rate_by_money,
    fohy_surplus_sale_money,
    fohy_sale_average_money,
    fohy_sale_out_average_money,
    cr_sale_out_count,
    cr_sale_count,
    cr_sale_rate_by_count,
    cr_sale_out_area,
    cr_sale_area,
    cr_sale_rate_by_area,
    cr_sale_out_money,
    cr_sale_money,
    cr_sale_rate_by_money,
    cr_surplus_sale_money,
    cr_sale_average_money,
    cr_sale_out_average_money,
    croy_sale_out_count,
    croy_sale_count,
    croy_sale_rate_by_count,
    croy_sale_out_area,
    croy_sale_area,
    croy_sale_rate_by_area,
    croy_sale_out_money,
    croy_sale_money,
    croy_sale_rate_by_money,
    croy_surplus_sale_money,
    croy_sale_average_money,
    croy_sale_out_average_money

 from  TMP_SALE_RATE_BY_GRANULARITY where id=spid
union all 
select  project_id||PRODUCT_NAME
,project_id,
sum(FO_SALE_OUT_COUNT),--【3】首开去化套数
sum(FO_SALE_COUNT),--【4】首开推售套数 
case when sum(FO_SALE_COUNT)=0 then 0 else  round(sum(FO_SALE_OUT_COUNT)/sum(FO_SALE_COUNT),4) end,--【5】首开去化率(按套数)（3/4）
sum(FO_SALE_OUT_AREA),--【6】首开去化面积
sum(FO_SALE_AREA),--【7】首开推售面积
case when sum(FO_SALE_AREA)=0 then 0 else  round(sum(FO_SALE_OUT_AREA)/sum(FO_SALE_AREA),4) end,--【8】首开去化率(按面积)（6/7）
sum(FO_SALE_OUT_MONEY),--【9】首开去化货值
sum(FO_SALE_MONEY),--【10】首开推售货值
case when sum(FO_SALE_MONEY)=0 then 0 else  round(sum(FO_SALE_OUT_MONEY)/sum(FO_SALE_MONEY),4) end,--【11】首开去化率(按货值)（9/10）
sum(FO_SURPLUS_SALE_MONEY),--【12】首开剩余货值(10-9)
case when sum(FO_SALE_AREA)=0 then 0 else  round(sum(FO_SALE_MONEY)/sum(FO_SALE_AREA),4) end,--【13】首开标准均价(10/7)
case when sum(FO_SALE_OUT_AREA)=0 then 0 else  round(sum(FO_SALE_OUT_MONEY)/sum(FO_SALE_OUT_AREA),4) end,--【14】首开签约均价(9/6)
sum(PO_SALE_OUT_COUNT),--【15】全案去化套数
sum(PO_SALE_COUNT),--【16】全案推售套数
case when sum(PO_SALE_COUNT)=0 then 0 else  round(sum(PO_SALE_OUT_COUNT)/sum(PO_SALE_COUNT),4) end,--【17】全案去化率(按套数)(15/16)
sum(PO_SALE_OUT_AREA),--【18】全案去化面积
sum(PO_SALE_AREA),--【19】全案推售面积
case when sum(PO_SALE_AREA)=0 then 0 else  round(sum(PO_SALE_OUT_AREA)/sum(PO_SALE_AREA),4) end,--【20】全案去化率(按面积)(18/19)
sum(PO_SALE_OUT_MONEY),--【21】全案去化货值
sum(PO_SALE_MONEY),--【22】全案推售货值
case when sum(PO_SALE_MONEY)=0 then 0 else  round(sum(PO_SALE_OUT_MONEY)/sum(PO_SALE_MONEY),4) end,--【23】全案去化率(按货值)(21/22)
sum(PO_SURPLUS_SALE_MONEY),--【24】全案剩余货值(22-21)
case when sum(PO_SALE_AREA)=0 then 0 else  round(sum(PO_SALE_MONEY)/sum(PO_SALE_AREA),4) end,--【25】全案标准均价(22/19)
case when sum(PO_SALE_OUT_AREA)=0 then 0 else  round(sum(PO_SALE_OUT_MONEY)/sum(PO_SALE_OUT_AREA),4) end,--【26】全案签约均价(21/18)
sum(EH_SALE_OUT_COUNT),--【27】现房去化套数
sum(EH_SALE_COUNT),--【28】现房推售套数
case when sum(EH_SALE_COUNT)=0 then 0 else  round(sum(EH_SALE_OUT_COUNT)/sum(EH_SALE_COUNT),4) end,--【29】现房去化率(按套数)(27/28)
sum(EH_SALE_OUT_AREA),--【30】现房去化面积
sum(EH_SALE_AREA),--【31】现房推售面积
case when sum(EH_SALE_AREA)=0 then 0 else  round(sum(EH_SALE_OUT_AREA)/sum(EH_SALE_AREA),4) end,--【32】现房去化率(按面积)(30/31)
sum(EH_SALE_OUT_MONEY),--【33】现房去化货值
sum(EH_SALE_MONEY),--【34】现房推售货值
case when sum(EH_SALE_MONEY)=0 then 0 else  round(sum(EH_SALE_OUT_MONEY)/sum(EH_SALE_MONEY),4) end,--【35】现房去化率(按货值)(33/34)
sum(EH_SURPLUS_SALE_MONEY),--【36】现房剩余货值(34-33)
case when sum(EH_SALE_AREA)=0 then 0 else  round(sum(EH_SALE_MONEY)/sum(EH_SALE_AREA),4) end,--【37】现房标准均价(34/31)
case when sum(EH_SALE_OUT_AREA)=0 then 0 else  round(sum(EH_SALE_OUT_MONEY)/sum(EH_SALE_OUT_AREA),4) end,--【38】现房签约均价(33/30)
sum(SI_SALE_OUT_COUNT),--【39】顽固性库存去化套数
sum(SI_SALE_COUNT),--【40】顽固性库存推售套数
case when sum(SI_SALE_COUNT)=0 then 0 else  round(sum(SI_SALE_OUT_COUNT)/sum(SI_SALE_COUNT),4) end,--【41】顽固性库存去化率(按套数)(39/40)
sum(SI_SALE_OUT_AREA),--【42】顽固性库存去化面积
sum(SI_SALE_AREA),--【43】顽固性库存推售面积
case when sum(SI_SALE_AREA)=0 then 0 else  round(sum(SI_SALE_OUT_AREA)/sum(SI_SALE_AREA),4) end,--【44】顽固性库存去化率(按面积)(42/43)
sum(SI_SALE_OUT_MONEY),--【45】顽固性库存去化货值
sum(SI_SALE_MONEY),--【46】顽固性库存推售货值
case when sum(SI_SALE_MONEY)=0 then 0 else  round(sum(SI_SALE_OUT_MONEY)/sum(SI_SALE_MONEY),4) end,--【47】顽固性库存去化率(按货值)(45/46)
sum(SI_SURPLUS_SALE_MONEY),--【48】顽固性库存剩余货值(46-45)
case when sum(SI_SALE_AREA)=0 then 0 else  round(sum(SI_SALE_MONEY)/sum(SI_SALE_AREA),4) end,--【49】顽固性库存标准均价(46/43)
case when sum(SI_SALE_OUT_AREA)=0 then 0 else  round(sum(SI_SALE_OUT_MONEY)/sum(SI_SALE_OUT_AREA),4) end,--【50】顽固性库存签约均价(45/42)
--------------------------------首月去化率--------------------------
sum(FM_SALE_OUT_COUNT),--首月去化套数
case when sum(FO_SALE_COUNT)=0 then 0 else  round(sum(FM_SALE_OUT_COUNT)/sum(FO_SALE_COUNT),4) end,--首月去化率(按套数)
sum(FM_SALE_OUT_AREA),--首月去化面积
case when sum(FO_SALE_AREA)=0 then 0 else  round(sum(FM_SALE_OUT_AREA)/sum(FO_SALE_AREA),4) end,--首月去化率(按面积)
sum(FM_SALE_OUT_MONEY),--首月去化货值
case when sum(FO_SALE_MONEY)=0 then 0 else  round(sum(FM_SALE_OUT_MONEY)/sum(FO_SALE_MONEY),4) end,--首月去化率(按货值)
sum(FM_SURPLUS_SALE_MONEY),--首月剩余货值
case when sum(FO_SALE_AREA)=0 then 0 else  round(sum(FO_SALE_MONEY)/sum(FO_SALE_AREA),4) end,--首月标准均价
case when sum(FM_SALE_OUT_AREA)=0 then 0 else  round(sum(FM_SALE_OUT_MONEY)/sum(FM_SALE_OUT_AREA),4) end,--首月签约均价
-------------------------首开半年去化率------------------------------
sum(FOHY_SALE_OUT_COUNT),--首开半年去化套数
sum(FOHY_SALE_COUNT),--首开半年推售套数 
case when sum(FOHY_SALE_COUNT)=0 then 0 else  round(sum(FOHY_SALE_OUT_COUNT)/sum(FOHY_SALE_COUNT),4) end,--首开半年去化率(按套数)
sum(FOHY_SALE_OUT_AREA),--首开去化面积
sum(FOHY_SALE_AREA),--首开推售面积
case when sum(FOHY_SALE_AREA)=0 then 0 else  round(sum(FOHY_SALE_OUT_AREA)/sum(FOHY_SALE_AREA),4) end,--首开半年去化率(按面积)
sum(FOHY_SALE_OUT_MONEY),--首开去化货值
sum(FOHY_SALE_MONEY),--首开推售货值
case when sum(FOHY_SALE_MONEY)=0 then 0 else  round(sum(FOHY_SALE_OUT_MONEY)/sum(FOHY_SALE_MONEY),4) end,--首开半年去化率(按货值)
sum(FOHY_SURPLUS_SALE_MONEY),--首开半年剩余货值
case when sum(FOHY_SALE_AREA)=0 then 0 else  round(sum(FOHY_SALE_MONEY)/sum(FOHY_SALE_AREA),4) end,--首开半年标准均价
case when sum(FOHY_SALE_OUT_AREA)=0 then 0 else  round(sum(FOHY_SALE_OUT_MONEY)/sum(FOHY_SALE_OUT_AREA),4) end,--首开半年签约均价
-------------------------------竣工备案去化率------------------------
sum(CR_SALE_OUT_COUNT),--竣备去化套数
sum(CR_SALE_COUNT),--已竣备总套数 
case when sum(CR_SALE_COUNT)=0 then 0 else  round(sum(CR_SALE_OUT_COUNT)/sum(CR_SALE_COUNT),4) end,--竣备去化率(按套数)
sum(CR_SALE_OUT_AREA),--竣备去化面积
sum(CR_SALE_AREA),--已竣备总面积
case when sum(CR_SALE_AREA )=0 then 0 else  round(sum(CR_SALE_OUT_AREA)/sum(CR_SALE_AREA),4) end,--竣备去化率(按面积)
sum(CR_SALE_OUT_MONEY),--竣备去化货值
sum(CR_SALE_MONEY),--已竣备总货值
case when sum(CR_SALE_MONEY)=0 then 0 else  round(sum(CR_SALE_OUT_MONEY)/sum(CR_SALE_MONEY),4) end,--竣备去化率(按货值)
sum(CR_SURPLUS_SALE_MONEY),--竣工备案剩余货值
case when sum(CR_SALE_AREA)=0 then 0 else  round(sum(CR_SALE_MONEY)/sum(CR_SALE_AREA),4) end,--竣工备案标准均价
case when sum(CR_SALE_OUT_AREA)=0 then 0 else  round(sum(CR_SALE_OUT_MONEY)/sum(CR_SALE_OUT_AREA),4) end,--竣工备案签约均价

-------------------------------竣工备案一年去化率------------------------
sum(CROY_SALE_OUT_COUNT),--竣备去化套数
sum(CROY_SALE_COUNT),--已竣备总套数 
case when sum(CROY_SALE_COUNT)=0 then 0 else  round(sum(CROY_SALE_OUT_COUNT)/sum(CROY_SALE_COUNT),4) end,--竣备去化率(按套数)
sum(CROY_SALE_OUT_AREA),--竣备去化面积
sum(CROY_SALE_AREA),--已竣备总面积
case when sum(CROY_SALE_AREA )=0 then 0 else  round(sum(CROY_SALE_OUT_AREA)/sum(CROY_SALE_AREA),4) end,--竣备去化率(按面积)
sum(CROY_SALE_OUT_MONEY),--竣备去化货值
sum(CROY_SALE_MONEY),--已竣备总货值
case when sum(CROY_SALE_MONEY)=0 then 0 else  round(sum(CROY_SALE_OUT_MONEY)/sum(CROY_SALE_MONEY),4) end,--竣备去化率(按货值)
sum(CROY_SURPLUS_SALE_MONEY),--竣工备案剩余货值
case when sum(CROY_SALE_AREA)=0 then 0 else  round(sum(CROY_SALE_MONEY)/sum(CROY_SALE_AREA),4) end,--竣工备案标准均价
case when sum(CROY_SALE_OUT_AREA)=0 then 0 else  round(sum(CROY_SALE_OUT_MONEY)/sum(CROY_SALE_OUT_AREA),4) end--竣工备案签约均价

 from  TMP_SALE_RATE_BY_GRANULARITY where id=spid group by project_id,
 parent_id,PRODUCT_NAME) apdata  
on tree.GRANULARITY_ID=apdata.id order by apdata.project_id;
commit;

END P_DWM_SALE_RATE_BY_GRANULARITY;
--=================================================================定时任务结束================================================================


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_SALE_RATE_BY_ORG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_SALE_RATE_BY_ORG" AS
		--公司颗粒度去化率；作用=》定时任务拍照
		--作者：陈丽
		--日期：2020-04-10

    PROJ_SPID NVARCHAR2(200);
    sys_created       DATE := SYSDATE;
    spid_tree              VARCHAR2(360); --使用临时表的批次号
    spid_sum              VARCHAR2(360); --使用临时表的批次号
    spid_result              VARCHAR2(360); --使用临时表的批次号
    dwm_remark        VARCHAR2(200) := '测试-chenl';
    p_X_AXIS_PERIOD  VARCHAR2(200):=to_char(sysdate, 'yyyy') ||'-'||to_char(sysdate, 'MM' );
BEGIN
delete tmp_sale_rate_by_org;
--------创建临时表批次号
    SELECT
        get_uuid(),get_uuid(),get_uuid()
    INTO spid_tree,spid_sum,spid_result
    FROM
        dual;  

------项目基本信息
BEGIN
  P_DWM_SALE_RATE_BY_PROJ(0,
    PROJ_SPID => PROJ_SPID
  );
END;

----组装树
INSERT INTO tmp_sale_rate_by_org (
        id,
        org_id,--【  2】项目ID
        org_name,--【  3】项目名称
        parent_id,
        IS_COMPANY,
        LEVEL_RANK,
        fo_sale_out_count,--【  4】首开去化套数
        fo_sale_count,--【  5】首开推售套数
        fo_sale_out_area,--【  7】首开去化面积
        fo_sale_area,--【  8】首开推售面积
        fo_sale_out_money,--【 10】首开去化货值
        fo_sale_money,--【 11】首开推售货值
        fo_surplus_sale_money,--【 13】首开剩余货值
        po_sale_out_count,--【 14】全案去化套数
        po_sale_count,--【 15】全案推售套数
        po_sale_out_area,--【 17】全案去化面积
        po_sale_area,--【 18】全案推售面积
        po_sale_out_money,--【 20】全案去化货值
        po_sale_money,--【 21】全案推售货值
        po_surplus_sale_money,--【 23】全案剩余货值
        eh_sale_out_count,--【 24】现房去化套数
        eh_sale_count,--【 25】现房推售套数
        eh_sale_out_area,--【 27】现房去化面积
        eh_sale_area,--【 28】现房推售面积
        eh_sale_out_money,--【 30】现房去化货值
        eh_sale_money,--【 31】现房推售货值
        eh_surplus_sale_money,--【 33】现房剩余货值
        si_sale_out_count,--【 34】顽固性库存去化套数
        si_sale_count,--【 35】顽固性库存推售套数
        si_sale_out_area,--【 37】顽固性库存去化面积
        si_sale_area,--【 38】顽固性库存推售面积
        si_sale_out_money,--【 40】顽固性库存去化货值
        si_sale_money,--【 41】顽固性库存推售货值
        si_surplus_sale_money,--【 43】顽固性库存剩余货值
        fm_sale_out_count,
        fm_sale_out_area,
        fm_sale_out_money,
        fm_surplus_sale_money,
        fohy_sale_out_count,--首开半年去化套数
        fohy_sale_count,--首开半年推售套数
        fohy_sale_out_area,--首开半年去化面积
        fohy_sale_area,--首开半年推售面积
        fohy_sale_out_money,--首开半年去化货值
        fohy_sale_money,--首开半年推售货值
        fohy_surplus_sale_money,--首开半年剩余货值
        cr_sale_out_count,
        cr_sale_count,
        cr_sale_out_area,
        cr_sale_area,
        cr_sale_out_money,
        cr_sale_money,
        cr_surplus_sale_money,
        croy_sale_out_count,
        croy_sale_count,
        croy_sale_out_area,
        croy_sale_area,
        croy_sale_out_money,
        croy_sale_money,
        croy_surplus_sale_money

    )
        SELECT
            spid_tree,
            id AS org_id,
            org_name,
            parent_id,
            IS_COMPANY,
            LEVEL_RANK,
            0 AS fo_sale_out_count,--【  4】首开去化套数
            0 AS fo_sale_count,--【  5】首开推售套数
            0 AS fo_sale_out_area,--【  7】首开去化面积
            0 AS fo_sale_area,--【  8】首开推售面积
            0 AS fo_sale_out_money,--【 10】首开去化货值
            0 AS fo_sale_money,--【 11】首开推售货值
            0 AS fo_surplus_sale_money,--【 13】首开剩余货值
            0 AS po_sale_out_count,--【 14】全案去化套数
            0 AS po_sale_count,--【 15】全案推售套数
            0 AS po_sale_out_area,--【 17】全案去化面积
            0 AS po_sale_area,--【 18】全案推售面积
            0 AS po_sale_out_money,--【 20】全案去化货值
            0 AS po_sale_money,--【 21】全案推售货值
            0 AS po_surplus_sale_money,--【 23】全案剩余货值
            0 AS eh_sale_out_count,--【 24】现房去化套数
            0 AS eh_sale_count,--【 25】现房推售套数
            0 AS eh_sale_out_area,--【 27】现房去化面积
            0 AS eh_sale_area,--【 28】现房推售面积
            0 AS eh_sale_out_money,--【 30】现房去化货值
            0 AS eh_sale_money,--【 31】现房推售货值
            0 AS eh_surplus_sale_money,--【 33】现房剩余货值
            0 AS si_sale_out_count,--【 34】顽固性库存去化套数
            0 AS si_sale_count,--【 35】顽固性库存推售套数
            0 AS si_sale_out_area,--【 37】顽固性库存去化面积
            0 AS si_sale_area,--【 38】顽固性库存推售面积
            0 AS si_sale_out_money,--【 40】顽固性库存去化货值
            0 AS si_sale_money,--【 41】顽固性库存推售货值
            0 AS si_surplus_sale_money,--【 43】顽固性库存剩余货值
            0 AS fm_sale_out_count,
            0 AS fm_sale_out_area,
            0 AS fm_sale_out_money,
            0 AS fm_surplus_sale_money,
            0 AS fohy_sale_out_count,
            0 AS fohy_sale_count,
            0 AS fohy_sale_out_area,
            0 AS fohy_sale_area,
            0 AS fohy_sale_out_money,
            0 AS fohy_sale_money,
            0 AS fohy_surplus_sale_money,
            0 AS cr_sale_out_count,
            0 AS cr_sale_count,
            0 AS cr_sale_out_area,
            0 AS cr_sale_area,
            0 AS cr_sale_out_money,
            0 AS cr_sale_money,
            0 AS cr_surplus_sale_money,
            0 AS croy_sale_out_count,
            0 AS croy_sale_count,
            0 AS croy_sale_out_area,
            0 AS croy_sale_area,
            0 AS croy_sale_out_money,
            0 AS croy_sale_money,
            0 AS croy_surplus_sale_money
        FROM
            sys_business_unit where IS_COMPANY=1
        UNION ALL
        SELECT
            spid_tree,
            project_id,
            org_name,
            org_id AS parent_id,
            0,
            null,
            fo_sale_out_count,--【  4】首开去化套数
            fo_sale_count,--【  5】首开推售套数
            fo_sale_out_area,--【  7】首开去化面积
            fo_sale_area,--【  8】首开推售面积
            fo_sale_out_money,--【 10】首开去化货值
            fo_sale_money,--【 11】首开推售货值
            fo_surplus_sale_money,--【 13】首开剩余货值
            po_sale_out_count,--【 14】全案去化套数
            po_sale_count,--【 15】全案推售套数
            po_sale_out_area,--【 17】全案去化面积
            po_sale_area,--【 18】全案推售面积
            po_sale_out_money,--【 20】全案去化货值
            po_sale_money,--【 21】全案推售货值
            po_surplus_sale_money,--【 23】全案剩余货值
            eh_sale_out_count,--【 24】现房去化套数
            eh_sale_count,--【 25】现房推售套数
            eh_sale_out_area,--【 27】现房去化面积
            eh_sale_area,--【 28】现房推售面积
            eh_sale_out_money,--【 30】现房去化货值
            eh_sale_money,--【 31】现房推售货值
            eh_surplus_sale_money,--【 33】现房剩余货值
            si_sale_out_count,--【 34】顽固性库存去化套数
            si_sale_count,--【 35】顽固性库存推售套数
            si_sale_out_area,--【 37】顽固性库存去化面积
            si_sale_area,--【 38】顽固性库存推售面积
            si_sale_out_money,--【 40】顽固性库存去化货值
            si_sale_money,--【 41】顽固性库存推售货值
            si_surplus_sale_money,--【 43】顽固性库存剩余货值
            fm_sale_out_count,
            fm_sale_out_area,
            fm_sale_out_money,
            fm_surplus_sale_money,
            fohy_sale_out_count,
            fohy_sale_count,
            fohy_sale_out_area,
            fohy_sale_area,
            fohy_sale_out_money,
            fohy_sale_money,
            fohy_surplus_sale_money,
            cr_sale_out_count,
            cr_sale_count,
            cr_sale_out_area,
            cr_sale_area,
            cr_sale_out_money,
            cr_sale_money,
            cr_surplus_sale_money,

            croy_sale_out_count,
            croy_sale_count,
            croy_sale_out_area,
            croy_sale_area,
            croy_sale_out_money,
            croy_sale_money,
            croy_surplus_sale_money
        FROM
            tmp_sale_rate_by_project where id=proj_spid;           
----汇总          
INSERT INTO tmp_sale_rate_by_org (
        id,
        org_id,--【  2】项目ID
        org_name,--【  3】项目名称
        parent_id,
        IS_COMPANY,
        LEVEL_RANK,
        fo_sale_out_count,--【  4】首开去化套数
        fo_sale_count,--【  5】首开推售套数
        fo_sale_out_area,--【  7】首开去化面积
        fo_sale_area,--【  8】首开推售面积
        fo_sale_out_money,--【 10】首开去化货值
        fo_sale_money,--【 11】首开推售货值
        fo_surplus_sale_money,--【 13】首开剩余货值
        po_sale_out_count,--【 14】全案去化套数
        po_sale_count,--【 15】全案推售套数
        po_sale_out_area,--【 17】全案去化面积
        po_sale_area,--【 18】全案推售面积
        po_sale_out_money,--【 20】全案去化货值
        po_sale_money,--【 21】全案推售货值
        po_surplus_sale_money,--【 23】全案剩余货值
        eh_sale_out_count,--【 24】现房去化套数
        eh_sale_count,--【 25】现房推售套数
        eh_sale_out_area,--【 27】现房去化面积
        eh_sale_area,--【 28】现房推售面积
        eh_sale_out_money,--【 30】现房去化货值
        eh_sale_money,--【 31】现房推售货值
        eh_surplus_sale_money,--【 33】现房剩余货值
        si_sale_out_count,--【 34】顽固性库存去化套数
        si_sale_count,--【 35】顽固性库存推售套数
        si_sale_out_area,--【 37】顽固性库存去化面积
        si_sale_area,--【 38】顽固性库存推售面积
        si_sale_out_money,--【 40】顽固性库存去化货值
        si_sale_money,--【 41】顽固性库存推售货值
        si_surplus_sale_money,--【 43】顽固性库存剩余货值
        fm_sale_out_count,
        fm_sale_out_area,
        fm_sale_out_money,
        fm_surplus_sale_money,
        fohy_sale_out_count,
        fohy_sale_count,
        fohy_sale_out_area,
        fohy_sale_area,
        fohy_sale_out_money,
        fohy_sale_money,
        fohy_surplus_sale_money,
        cr_sale_out_count,
        cr_sale_count,
        cr_sale_out_area,
        cr_sale_area,
        cr_sale_out_money,
        cr_sale_money,
        cr_surplus_sale_money,
        croy_sale_out_count,
        croy_sale_count,
        croy_sale_out_area,
        croy_sale_area,
        croy_sale_out_money,
        croy_sale_money,
        croy_surplus_sale_money
    )
 select spid_sum,org_id,org_name,parent_id,IS_COMPANY,LEVEL_RANK
,(select sum(FO_SALE_OUT_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FO_SALE_OUT_COUNT
,(select sum(FO_SALE_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FO_SALE_COUNT
,(select sum(FO_SALE_OUT_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FO_SALE_OUT_AREA
,(select sum(FO_SALE_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FO_SALE_AREA
,(select sum(FO_SALE_OUT_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FO_SALE_OUT_MONEY
,(select sum(FO_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FO_SALE_MONEY
,(select sum(FO_SURPLUS_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FO_SURPLUS_SALE_MONEY
,(select sum(PO_SALE_OUT_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) PO_SALE_OUT_COUNT
,(select sum(PO_SALE_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) PO_SALE_COUNT
,(select sum(PO_SALE_OUT_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) PO_SALE_OUT_AREA
,(select sum(PO_SALE_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) PO_SALE_AREA
,(select sum(PO_SALE_OUT_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) PO_SALE_OUT_MONEY
,(select sum(PO_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) PO_SALE_MONEY
,(select sum(PO_SURPLUS_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) PO_SURPLUS_SALE_MONEY
,(select sum(EH_SALE_OUT_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) EH_SALE_OUT_COUNT
,(select sum(EH_SALE_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) EH_SALE_COUNT
,(select sum(EH_SALE_OUT_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) EH_SALE_OUT_AREA
,(select sum(EH_SALE_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) EH_SALE_AREA
,(select sum(EH_SALE_OUT_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) EH_SALE_OUT_MONEY
,(select sum(EH_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) EH_SALE_MONEY
,(select sum(EH_SURPLUS_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) EH_SURPLUS_SALE_MONEY
,(select sum(SI_SALE_OUT_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) SI_SALE_OUT_COUNT
,(select sum(SI_SALE_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) SI_SALE_COUNT
,(select sum(SI_SALE_OUT_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) SI_SALE_OUT_AREA
,(select sum(SI_SALE_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) SI_SALE_AREA
,(select sum(SI_SALE_OUT_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) SI_SALE_OUT_MONEY
,(select sum(SI_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) SI_SALE_MONEY
,(select sum(SI_SURPLUS_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) SI_SURPLUS_SALE_MONEY
,(select sum(FM_SALE_OUT_COUNT) from tmp_sale_rate_by_org start with org_id =s.org_id connect by prior org_id =parent_id and org_id!=parent_id) FM_SALE_OUT_COUNT
,(select sum(FM_SALE_OUT_AREA) from tmp_sale_rate_by_org start with org_id =s.org_id connect by prior org_id =parent_id and org_id!=parent_id) FM_SALE_OUT_AREA
,(select sum(FM_SALE_OUT_MONEY) from tmp_sale_rate_by_org start with org_id =s.org_id connect by prior org_id =parent_id and org_id!=parent_id) FM_SALE_OUT_MONEY
,(select sum(FM_SURPLUS_SALE_MONEY) from tmp_sale_rate_by_org start with org_id =s.org_id connect by prior org_id =parent_id and org_id!=parent_id) FM_SURPLUS_SALE_MONEY
,(select sum(FOHY_SALE_OUT_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FOHY_SALE_OUT_COUNT
,(select sum(FOHY_SALE_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FOHY_SALE_COUNT
,(select sum(FOHY_SALE_OUT_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FOHY_SALE_OUT_AREA
,(select sum(FOHY_SALE_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FOHY_SALE_AREA
,(select sum(FOHY_SALE_OUT_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FOHY_SALE_OUT_MONEY
,(select sum(FOHY_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FOHY_SALE_MONEY
,(select sum(FOHY_SURPLUS_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FOHY_SURPLUS_SALE_MONEY
-------竣工备案
,(select sum(CR_SALE_OUT_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) CR_SALE_OUT_COUNT
,(select sum(CR_SALE_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) CR_SALE_COUNT
,(select sum(CR_SALE_OUT_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) CR_SALE_OUT_AREA
,(select sum(CR_SALE_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) CR_SALE_AREA
,(select sum(CR_SALE_OUT_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) CR_SALE_OUT_MONEY
,(select sum(CR_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) CR_SALE_MONEY
,(select sum(CR_SURPLUS_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) CR_SURPLUS_SALE_MONEY
-------竣工备案后一年
,(select sum(CROY_SALE_OUT_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) CROY_SALE_OUT_COUNT
,(select sum(CROY_SALE_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) CROY_SALE_COUNT
,(select sum(CROY_SALE_OUT_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) CROY_SALE_OUT_AREA
,(select sum(CROY_SALE_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) CROY_SALE_AREA
,(select sum(CROY_SALE_OUT_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) CROY_SALE_OUT_MONEY
,(select sum(CROY_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) CROY_SALE_MONEY
,(select sum(CROY_SURPLUS_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) CROY_SURPLUS_SALE_MONEY

from tmp_sale_rate_by_org s where id=spid_tree
order by org_id  ; 
----计算率
INSERT INTO tmp_sale_rate_by_org (
ID,--【1】主键
ORG_ID,--【2】项目ID
ORG_NAME,--【3】项目名称
LEVEL_RANK,
FO_SALE_OUT_COUNT,--【4】首开去化套数
FO_SALE_COUNT,--【5】首开推售套数
FO_SALE_RATE_BY_COUNT,--【6】首开去化率(按套数)
FO_SALE_OUT_AREA,--【7】首开去化面积
FO_SALE_AREA,--【8】首开推售面积
FO_SALE_RATE_BY_AREA,--【9】首开去化率(按面积)
FO_SALE_OUT_MONEY,--【10】首开去化货值
FO_SALE_MONEY,--【11】首开推售货值
FO_SALE_RATE_BY_MONEY,--【12】首开去化率(按货值)
FO_SURPLUS_SALE_MONEY,--【13】首开剩余货值
PO_SALE_OUT_COUNT,--【14】全案去化套数
PO_SALE_COUNT,--【15】全案推售套数
PO_SALE_RATE_BY_COUNT,--【16】全案去化率(按套数)
PO_SALE_OUT_AREA,--【17】全案去化面积
PO_SALE_AREA,--【18】全案推售面积
PO_SALE_RATE_BY_AREA,--【19】全案去化率(按面积)
PO_SALE_OUT_MONEY,--【20】全案去化货值
PO_SALE_MONEY,--【21】全案推售货值
PO_SALE_RATE_BY_MONEY,--【22】全案去化率(按货值)
PO_SURPLUS_SALE_MONEY,--【23】全案剩余货值
EH_SALE_OUT_COUNT,--【24】现房去化套数
EH_SALE_COUNT,--【25】现房推售套数
EH_SALE_RATE_BY_COUNT,--【26】现房去化率(按套数)
EH_SALE_OUT_AREA,--【27】现房去化面积
EH_SALE_AREA,--【28】现房推售面积
EH_SALE_RATE_BY_AREA,--【29】现房去化率(按面积)
EH_SALE_OUT_MONEY,--【30】现房去化货值
EH_SALE_MONEY,--【31】现房推售货值
EH_SALE_RATE_BY_MONEY,--【32】现房去化率(按货值)
EH_SURPLUS_SALE_MONEY,--【33】现房剩余货值
SI_SALE_OUT_COUNT,--【34】顽固性库存去化套数
SI_SALE_COUNT,--【35】顽固性库存推售套数
SI_SALE_RATE_BY_COUNT,--【36】顽固性库存去化率(按套数)
SI_SALE_OUT_AREA,--【37】顽固性库存去化面积
SI_SALE_AREA,--【38】顽固性库存推售面积
SI_SALE_RATE_BY_AREA,--【39】顽固性库存去化率(按面积)
SI_SALE_OUT_MONEY,--【40】顽固性库存去化货值
SI_SALE_MONEY,--【41】顽固性库存推售货值
SI_SALE_RATE_BY_MONEY,--【42】顽固性库存去化率(按货值)
SI_SURPLUS_SALE_MONEY,--【43】顽固性库存剩余货值
X_AXIS_PERIOD,--【44】时间（横坐标）
CREATED,--【45】创建时间
"REMARK",
FM_SALE_OUT_COUNT,
FM_SALE_RATE_BY_COUNT,
FM_SALE_OUT_AREA,
FM_SALE_RATE_BY_AREA,
FM_SALE_OUT_MONEY,
FM_SALE_RATE_BY_MONEY,
FM_SURPLUS_SALE_MONEY,
FOHY_SALE_OUT_COUNT,
FOHY_SALE_COUNT,
FOHY_SALE_RATE_BY_COUNT,
FOHY_SALE_OUT_AREA,
FOHY_SALE_AREA,
FOHY_SALE_RATE_BY_AREA,
FOHY_SALE_OUT_MONEY,
FOHY_SALE_MONEY,
FOHY_SALE_RATE_BY_MONEY,
FOHY_SURPLUS_SALE_MONEY
,CR_SALE_OUT_COUNT
,CR_SALE_COUNT
,CR_SALE_RATE_BY_COUNT
,CR_SALE_OUT_AREA
,CR_SALE_AREA
,CR_SALE_RATE_BY_AREA
,CR_SALE_OUT_MONEY
,CR_SALE_MONEY
,CR_SALE_RATE_BY_MONEY
,CR_SURPLUS_SALE_MONEY
,CROY_SALE_OUT_COUNT
,CROY_SALE_COUNT
,CROY_SALE_RATE_BY_COUNT
,CROY_SALE_OUT_AREA
,CROY_SALE_AREA
,CROY_SALE_RATE_BY_AREA
,CROY_SALE_OUT_MONEY
,CROY_SALE_MONEY
,CROY_SALE_RATE_BY_MONEY
,CROY_SURPLUS_SALE_MONEY
)
select spid_result,ORG_ID,--【2】项目ID
ORG_NAME,--【3】项目名称
LEVEL_RANK,
FO_SALE_OUT_COUNT,--【4】首开去化套数
FO_SALE_COUNT,--【5】首开推售套数
case when FO_SALE_COUNT=0 then 0 else  round(FO_SALE_OUT_COUNT/FO_SALE_COUNT,4) end as  FO_SALE_RATE_BY_COUNT,--【6】首开去化率(按套数)
FO_SALE_OUT_AREA,--【7】首开去化面积
FO_SALE_AREA,--【8】首开推售面积
case when FO_SALE_AREA=0 then 0 else  round(FO_SALE_OUT_AREA/FO_SALE_AREA,4) end as  FO_SALE_RATE_BY_AREA,--【9】首开去化率(按面积)
FO_SALE_OUT_MONEY,--【10】首开去化货值
FO_SALE_MONEY,--【11】首开推售货值
case when FO_SALE_MONEY=0 then 0 else  round(FO_SALE_OUT_MONEY/FO_SALE_MONEY,4) end as FO_SALE_RATE_BY_MONEY,--【12】首开去化率(按货值)
FO_SALE_MONEY-FO_SALE_OUT_MONEY as FO_SURPLUS_SALE_MONEY,--【13】首开剩余货值
PO_SALE_OUT_COUNT,--【14】全案去化套数
PO_SALE_COUNT,--【15】全案推售套数
case when FO_SALE_MONEY=0 then 0 else  round(PO_SALE_OUT_COUNT/PO_SALE_COUNT,4) end as PO_SALE_RATE_BY_COUNT,--【16】全案去化率(按套数)
PO_SALE_OUT_AREA,--【17】全案去化面积
PO_SALE_AREA,--【18】全案推售面积
case when PO_SALE_AREA=0 then 0 else  round(PO_SALE_OUT_AREA/PO_SALE_AREA,4) end as PO_SALE_RATE_BY_AREA,--【19】全案去化率(按面积)
PO_SALE_OUT_MONEY,--【20】全案去化货值
PO_SALE_MONEY,--【21】全案推售货值
case when PO_SALE_AREA=0 then 0 else  round(PO_SALE_OUT_MONEY/PO_SALE_MONEY,4) end as PO_SALE_RATE_BY_MONEY,--【22】全案去化率(按货值)
PO_SALE_MONEY-PO_SALE_OUT_MONEY as PO_SURPLUS_SALE_MONEY,--【23】全案剩余货值
EH_SALE_OUT_COUNT,--【24】现房去化套数
EH_SALE_COUNT,--【25】现房推售套数
case when EH_SALE_COUNT=0 then 0 else  round(EH_SALE_OUT_COUNT/EH_SALE_COUNT,4) end as EH_SALE_RATE_BY_COUNT,--【26】现房去化率(按套数)
EH_SALE_OUT_AREA,--【27】现房去化面积
EH_SALE_AREA,--【28】现房推售面积
case when EH_SALE_AREA=0 then 0 else  round(EH_SALE_OUT_AREA/EH_SALE_AREA,4) end  as EH_SALE_RATE_BY_AREA,--【29】现房去化率(按面积)
EH_SALE_OUT_MONEY,--【30】现房去化货值
EH_SALE_MONEY,--【31】现房推售货值
case when EH_SALE_MONEY=0 then 0 else  round(EH_SALE_OUT_MONEY/EH_SALE_MONEY,4) end  as EH_SALE_RATE_BY_MONEY,--【32】现房去化率(按货值)
EH_SALE_MONEY-EH_SALE_OUT_MONEY as EH_SURPLUS_SALE_MONEY,--【33】现房剩余货值
SI_SALE_OUT_COUNT,--【34】顽固性库存去化套数
SI_SALE_COUNT,--【35】顽固性库存推售套数
case when SI_SALE_COUNT=0 then 0 else  round(SI_SALE_OUT_COUNT/SI_SALE_COUNT,4) end  as SI_SALE_RATE_BY_COUNT,--【36】顽固性库存去化率(按套数)
SI_SALE_OUT_AREA,--【37】顽固性库存去化面积
SI_SALE_AREA,--【38】顽固性库存推售面积
case when SI_SALE_AREA=0 then 0 else  round(SI_SALE_OUT_AREA/SI_SALE_AREA,4) end  as SI_SALE_RATE_BY_AREA,--【39】顽固性库存去化率(按面积)
SI_SALE_OUT_MONEY,--【40】顽固性库存去化货值
SI_SALE_MONEY,--【41】顽固性库存推售货值
case when SI_SALE_MONEY=0 then 0 else  round(SI_SALE_OUT_MONEY/SI_SALE_MONEY,4) end  as SI_SALE_RATE_BY_MONEY,--【42】顽固性库存去化率(按货值)
SI_SALE_MONEY-SI_SALE_OUT_MONEY as SI_SURPLUS_SALE_MONEY,--【43】顽固性库存剩余货值

p_X_AXIS_PERIOD,--【44】时间（横坐标）
sys_created,--【45】创建时间
dwm_remark,--【46】备注信息
----------------------首月去化率---------------
FM_SALE_OUT_COUNT,
case when FO_SALE_COUNT =0 then 0 else round(FM_SALE_OUT_COUNT/FO_SALE_COUNT,4) end as FM_SALE_RATE_BY_COUNT, --首月去化率(按套数)
FM_SALE_OUT_AREA,
case when FO_SALE_AREA =0 then 0 else round(FM_SALE_OUT_AREA/FO_SALE_AREA,4) end as FM_SALE_RATE_BY_AREA,--首月去化率(按面积)
FM_SALE_OUT_MONEY,
case when FO_SALE_MONEY =0 then 0 else round(FM_SALE_OUT_MONEY/FO_SALE_MONEY,4) end as FM_SALE_RATE_BY_MONEY,--首月去化率(按货值)
FO_SALE_MONEY-FM_SALE_OUT_MONEY as FM_SURPLUS_SALE_MONEY,--【13】首开剩余货值
----首开半年去化率
FOHY_SALE_OUT_COUNT,--首开半年去化套数
FOHY_SALE_COUNT,--首开半年推售套数
case when FOHY_SALE_COUNT=0 then 0 else  round(FOHY_SALE_OUT_COUNT/FOHY_SALE_COUNT,4) end as  FOHY_SALE_RATE_BY_COUNT,--首开半年去化率(按套数)
FOHY_SALE_OUT_AREA,--首开半年去化面积
FOHY_SALE_AREA,--首开半年推售面积
case when FOHY_SALE_AREA=0 then 0 else  round(FOHY_SALE_OUT_AREA/FOHY_SALE_AREA,4) end as  FOHY_SALE_RATE_BY_AREA,--首开半年去化率(按面积)
FOHY_SALE_OUT_MONEY,--首开半年去化货值
FOHY_SALE_MONEY,--首开半年推售货值
case when FOHY_SALE_MONEY=0 then 0 else  round(FOHY_SALE_OUT_MONEY/FOHY_SALE_MONEY,4) end as FOHY_SALE_RATE_BY_MONEY,--首开半年去化率(按货值)
FOHY_SALE_MONEY-FOHY_SALE_OUT_MONEY as FOHY_SURPLUS_SALE_MONEY,--首开半年剩余货值
---------------------------------------竣工备案去化率----------------------------------------
CR_SALE_OUT_COUNT,--竣备去化套数
CR_SALE_COUNT,--已竣备总套数
case when CR_SALE_COUNT=0 then 0 else  round(CR_SALE_OUT_COUNT/CR_SALE_COUNT,4) end as  CR_SALE_RATE_BY_COUNT,--竣备去化率(按套数)
CR_SALE_OUT_AREA,--竣备去化面积
CR_SALE_AREA,--已竣备总面积
case when CR_SALE_AREA=0 then 0 else  round(CR_SALE_OUT_AREA/CR_SALE_AREA,4) end as  CR_SALE_RATE_BY_AREA,--竣备去化率(按面积)
CR_SALE_OUT_MONEY,--竣备去化货值
CR_SALE_MONEY,--已竣备总货值
case when CR_SALE_MONEY=0 then 0 else  round(CR_SALE_OUT_MONEY/CR_SALE_MONEY,4) end as CR_SALE_RATE_BY_MONEY,--竣备去化率(按货值)
CR_SALE_MONEY-CR_SALE_OUT_MONEY as CR_SURPLUS_SALE_MONEY,--竣备剩余货值
-------------------------------竣工备案后一年------------------------------
CROY_SALE_OUT_COUNT,--竣备一年去化套数
CROY_SALE_COUNT,--已竣备一年总套数
case when CROY_SALE_COUNT=0 then 0 else  round(CROY_SALE_OUT_COUNT/CROY_SALE_COUNT,4) end as  CROY_SALE_RATE_BY_COUNT,--竣备一年去化率(按套数)
CROY_SALE_OUT_AREA,--竣备一年去化面积
CROY_SALE_AREA,--竣备一年总面积
case when CROY_SALE_AREA=0 then 0 else  round(CROY_SALE_OUT_AREA/CROY_SALE_AREA,4) end as  CROY_SALE_RATE_BY_AREA,--竣备一年去化率(按面积)
CROY_SALE_OUT_MONEY,--竣备一年去化货值
CROY_SALE_MONEY,--竣备一年总货值
case when CROY_SALE_MONEY=0 then 0 else  round(CROY_SALE_OUT_MONEY/CROY_SALE_MONEY,4) end as CROY_SALE_RATE_BY_MONEY,--竣备一年去化率(按货值)
CROY_SALE_MONEY-CROY_SALE_OUT_MONEY as CROY_SURPLUS_SALE_MONEY--竣备一年剩余货值

from tmp_sale_rate_by_org where IS_COMPANY=1 and id=spid_sum and LEVEL_RANK<=2
;
----插入到目标表

   DELETE FROM dwm_sale_rate_by_org where  X_AXIS_PERIOD=p_X_AXIS_PERIOD;
   --and REMARK=dwm_REMARK;

   INSERT INTO dwm_sale_rate_by_org (
ID,--【1】主键
ORG_ID,--【2】项目ID
ORG_NAME,--【3】项目名称
FO_SALE_OUT_COUNT,--【4】首开去化套数
FO_SALE_COUNT,--【5】首开推售套数
FO_SALE_RATE_BY_COUNT,--【6】首开去化率(按套数)
FO_SALE_OUT_AREA,--【7】首开去化面积
FO_SALE_AREA,--【8】首开推售面积
FO_SALE_RATE_BY_AREA,--【9】首开去化率(按面积)
FO_SALE_OUT_MONEY,--【10】首开去化货值
FO_SALE_MONEY,--【11】首开推售货值
FO_SALE_RATE_BY_MONEY,--【12】首开去化率(按货值)
FO_SURPLUS_SALE_MONEY,--【13】首开剩余货值
PO_SALE_OUT_COUNT,--【14】全案去化套数
PO_SALE_COUNT,--【15】全案推售套数
PO_SALE_RATE_BY_COUNT,--【16】全案去化率(按套数)
PO_SALE_OUT_AREA,--【17】全案去化面积
PO_SALE_AREA,--【18】全案推售面积
PO_SALE_RATE_BY_AREA,--【19】全案去化率(按面积)
PO_SALE_OUT_MONEY,--【20】全案去化货值
PO_SALE_MONEY,--【21】全案推售货值
PO_SALE_RATE_BY_MONEY,--【22】全案去化率(按货值)
PO_SURPLUS_SALE_MONEY,--【23】全案剩余货值
EH_SALE_OUT_COUNT,--【24】现房去化套数
EH_SALE_COUNT,--【25】现房推售套数
EH_SALE_RATE_BY_COUNT,--【26】现房去化率(按套数)
EH_SALE_OUT_AREA,--【27】现房去化面积
EH_SALE_AREA,--【28】现房推售面积
EH_SALE_RATE_BY_AREA,--【29】现房去化率(按面积)
EH_SALE_OUT_MONEY,--【30】现房去化货值
EH_SALE_MONEY,--【31】现房推售货值
EH_SALE_RATE_BY_MONEY,--【32】现房去化率(按货值)
EH_SURPLUS_SALE_MONEY,--【33】现房剩余货值
SI_SALE_OUT_COUNT,--【34】顽固性库存去化套数
SI_SALE_COUNT,--【35】顽固性库存推售套数
SI_SALE_RATE_BY_COUNT,--【36】顽固性库存去化率(按套数)
SI_SALE_OUT_AREA,--【37】顽固性库存去化面积
SI_SALE_AREA,--【38】顽固性库存推售面积
SI_SALE_RATE_BY_AREA,--【39】顽固性库存去化率(按面积)
SI_SALE_OUT_MONEY,--【40】顽固性库存去化货值
SI_SALE_MONEY,--【41】顽固性库存推售货值
SI_SALE_RATE_BY_MONEY,--【42】顽固性库存去化率(按货值)
SI_SURPLUS_SALE_MONEY,--【43】顽固性库存剩余货值
FM_SALE_OUT_COUNT,--首月去化套数
FM_SALE_RATE_BY_COUNT,--首月去化率(按套数)
FM_SALE_OUT_AREA,--首月去化面积
FM_SALE_RATE_BY_AREA,--首月去化率(按面积)
FM_SALE_OUT_MONEY,--首月去化货值
FM_SALE_RATE_BY_MONEY,--首月去化率(按货值)
FM_SURPLUS_SALE_MONEY,--首月剩余货值
FOHY_SALE_OUT_COUNT,--首开半年去化套数
FOHY_SALE_COUNT,--首开半年推售套数
FOHY_SALE_RATE_BY_COUNT,--首开半年去化率(按套数)
FOHY_SALE_OUT_AREA,--首开半年去化面积
FOHY_SALE_AREA,--首开半年推售面积
FOHY_SALE_RATE_BY_AREA,--首开半年去化率(按面积)
FOHY_SALE_OUT_MONEY,--首开半年去化货值
FOHY_SALE_MONEY,--首开半年推售货值
FOHY_SALE_RATE_BY_MONEY,--半年首开去化率(按货值)
FOHY_SURPLUS_SALE_MONEY,--首开半年剩余货值
CR_SALE_OUT_COUNT
,CR_SALE_COUNT
,CR_SALE_RATE_BY_COUNT
,CR_SALE_OUT_AREA
,CR_SALE_AREA
,CR_SALE_RATE_BY_AREA
,CR_SALE_OUT_MONEY
,CR_SALE_MONEY
,CR_SALE_RATE_BY_MONEY
,CR_SURPLUS_SALE_MONEY
,CROY_SALE_OUT_COUNT
,CROY_SALE_COUNT
,CROY_SALE_RATE_BY_COUNT
,CROY_SALE_OUT_AREA
,CROY_SALE_AREA
,CROY_SALE_RATE_BY_AREA
,CROY_SALE_OUT_MONEY
,CROY_SALE_MONEY
,CROY_SALE_RATE_BY_MONEY
,CROY_SURPLUS_SALE_MONEY,
X_AXIS_PERIOD,--【44】时间（横坐标）
CREATED,--【45】创建时间
"REMARK")
select get_uuid,--【1】主键
ORG_ID,--【2】项目ID
ORG_NAME,--【3】项目名称
FO_SALE_OUT_COUNT,--【4】首开去化套数
FO_SALE_COUNT,--【5】首开推售套数
FO_SALE_RATE_BY_COUNT,--【6】首开去化率(按套数)
FO_SALE_OUT_AREA,--【7】首开去化面积
FO_SALE_AREA,--【8】首开推售面积
FO_SALE_RATE_BY_AREA,--【9】首开去化率(按面积)
FO_SALE_OUT_MONEY,--【10】首开去化货值
FO_SALE_MONEY,--【11】首开推售货值
FO_SALE_RATE_BY_MONEY,--【12】首开去化率(按货值)
FO_SURPLUS_SALE_MONEY,--【13】首开剩余货值
PO_SALE_OUT_COUNT,--【14】全案去化套数
PO_SALE_COUNT,--【15】全案推售套数
PO_SALE_RATE_BY_COUNT,--【16】全案去化率(按套数)
PO_SALE_OUT_AREA,--【17】全案去化面积
PO_SALE_AREA,--【18】全案推售面积
PO_SALE_RATE_BY_AREA,--【19】全案去化率(按面积)
PO_SALE_OUT_MONEY,--【20】全案去化货值
PO_SALE_MONEY,--【21】全案推售货值
PO_SALE_RATE_BY_MONEY,--【22】全案去化率(按货值)
PO_SURPLUS_SALE_MONEY,--【23】全案剩余货值
EH_SALE_OUT_COUNT,--【24】现房去化套数
EH_SALE_COUNT,--【25】现房推售套数
EH_SALE_RATE_BY_COUNT,--【26】现房去化率(按套数)
EH_SALE_OUT_AREA,--【27】现房去化面积
EH_SALE_AREA,--【28】现房推售面积
EH_SALE_RATE_BY_AREA,--【29】现房去化率(按面积)
EH_SALE_OUT_MONEY,--【30】现房去化货值
EH_SALE_MONEY,--【31】现房推售货值
EH_SALE_RATE_BY_MONEY,--【32】现房去化率(按货值)
EH_SURPLUS_SALE_MONEY,--【33】现房剩余货值
SI_SALE_OUT_COUNT,--【34】顽固性库存去化套数
SI_SALE_COUNT,--【35】顽固性库存推售套数
SI_SALE_RATE_BY_COUNT,--【36】顽固性库存去化率(按套数)
SI_SALE_OUT_AREA,--【37】顽固性库存去化面积
SI_SALE_AREA,--【38】顽固性库存推售面积
SI_SALE_RATE_BY_AREA,--【39】顽固性库存去化率(按面积)
SI_SALE_OUT_MONEY,--【40】顽固性库存去化货值
SI_SALE_MONEY,--【41】顽固性库存推售货值
SI_SALE_RATE_BY_MONEY,--【42】顽固性库存去化率(按货值)
SI_SURPLUS_SALE_MONEY,--【43】顽固性库存剩余货值
FM_SALE_OUT_COUNT,--首月去化套数
FM_SALE_RATE_BY_COUNT,--首月去化率(按套数)
FM_SALE_OUT_AREA,--首月去化面积
FM_SALE_RATE_BY_AREA,--首月去化率(按面积)
FM_SALE_OUT_MONEY,--首月去化货值
FM_SALE_RATE_BY_MONEY,--首月去化率(按货值)
FM_SURPLUS_SALE_MONEY,--首月剩余货值
FOHY_SALE_OUT_COUNT,--首开半年去化套数
FOHY_SALE_COUNT,--首开半年推售套数
FOHY_SALE_RATE_BY_COUNT,--首开半年去化率(按套数)
FOHY_SALE_OUT_AREA,--首开半年去化面积
FOHY_SALE_AREA,--首开半年推售面积
FOHY_SALE_RATE_BY_AREA,--首开半年去化率(按面积)
FOHY_SALE_OUT_MONEY,--首开半年去化货值
FOHY_SALE_MONEY,--首开半年推售货值
FOHY_SALE_RATE_BY_MONEY,--半年首开去化率(按货值)
FOHY_SURPLUS_SALE_MONEY--首开半年剩余货值
,CR_SALE_OUT_COUNT
,CR_SALE_COUNT
,CR_SALE_RATE_BY_COUNT
,CR_SALE_OUT_AREA
,CR_SALE_AREA
,CR_SALE_RATE_BY_AREA
,CR_SALE_OUT_MONEY
,CR_SALE_MONEY
,CR_SALE_RATE_BY_MONEY
,CR_SURPLUS_SALE_MONEY
,CROY_SALE_OUT_COUNT
,CROY_SALE_COUNT
,CROY_SALE_RATE_BY_COUNT
,CROY_SALE_OUT_AREA
,CROY_SALE_AREA
,CROY_SALE_RATE_BY_AREA
,CROY_SALE_OUT_MONEY
,CROY_SALE_MONEY
,CROY_SALE_RATE_BY_MONEY
,CROY_SURPLUS_SALE_MONEY
,X_AXIS_PERIOD--【44】时间（横坐标）
,CREATED--【45】创建时间
,"REMARK"
from tmp_sale_rate_by_org where id=spid_result;
commit;  
END p_dwm_sale_rate_by_org;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_SALE_RATE_BY_PROJ
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_SALE_RATE_BY_PROJ" (
    IS_PHOTOGRAPH in number:=0,
    proj_SPID  out NVARCHAR2
--    ,SALE_RATE_BY_PROJECT out SYS_REFCURSOR
    
) AS
		--项目颗粒度去化率拍照；作用=》定时拍照
        --调用范围=》P_DWM_SALE_RATE_BY_ORG
		--作者：陈丽
		--日期：2020-04-10
        --调整：首开推售（面积，套数，货值） 楼栋预售许可证 = 首开日期   2020/12/23
  PROJ_BASE_INFO SYS_REFCURSOR;
  PROJ_DATE_INFO SYS_REFCURSOR;
  PROJ_BASE_SPID VARCHAR2(2000);
  sys_created date:=sysdate;
  spid VARCHAR2(360); --使用临时表的批次号
  dwm_REMARK VARCHAR2(200):='测试-chenl';
BEGIN
delete TMP_SALE_RATE_BY_PROJECT;
commit;
--------创建临时表批次号
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;  
proj_SPID:=spid;
------项目基本信息
BEGIN

  P_DWM_SALE_RATE_PROJ(0,
    PROJ_BASE_SPID => PROJ_BASE_SPID
  );
    END;
 ----- 
 INSERT INTO TMP_SALE_RATE_BY_PROJECT (ID---【1】主键
,PROJECT_ID---【2】项目ID
,PROJECT_NAME
,ORG_ID
,ORG_NAME
,FO_SALE_OUT_COUNT---【3】首开去化套数
,FO_SALE_COUNT---【4】首开推售套数
,FO_SALE_RATE_BY_COUNT---【5】首开去化率(按套数)（3/4）
,FO_SALE_OUT_AREA---【6】首开去化面积
,FO_SALE_AREA---【7】首开推售面积
,FO_SALE_RATE_BY_AREA---【8】首开去化率(按面积)（6/7）
,FO_SALE_OUT_MONEY---【9】首开去化货值
,FO_SALE_MONEY---【10】首开推售货值
,FO_SALE_RATE_BY_MONEY---【11】首开去化率(按货值)（9/10）
,FO_SURPLUS_SALE_MONEY---【12】首开剩余货值(10-9)
,FO_SALE_AVERAGE_MONEY---【13】首开标准均价(10/7)
,FO_SALE_OUT_AVERAGE_MONEY---【14】首开签约均价(9/6)
,PO_SALE_OUT_COUNT---【15】全案去化套数
,PO_SALE_COUNT---【16】全案推售套数
,PO_SALE_RATE_BY_COUNT---【17】全案去化率(按套数)(15/16)
,PO_SALE_OUT_AREA---【18】全案去化面积
,PO_SALE_AREA---【19】全案推售面积
,PO_SALE_RATE_BY_AREA---【20】全案去化率(按面积)(18/19)
,PO_SALE_OUT_MONEY---【21】全案去化货值
,PO_SALE_MONEY---【22】全案推售货值
,PO_SALE_RATE_BY_MONEY---【23】全案去化率(按货值)(21/22)
,PO_SURPLUS_SALE_MONEY---【24】全案剩余货值(22-21)
,PO_SALE_AVERAGE_MONEY---【25】全案标准均价(22/19)
,PO_SALE_OUT_AVERAGE_MONEY---【26】全案签约均价(21/18)
,EH_SALE_OUT_COUNT---【27】现房去化套数
,EH_SALE_COUNT---【28】现房推售套数
,EH_SALE_RATE_BY_COUNT---【29】现房去化率(按套数)(27/28)
,EH_SALE_OUT_AREA---【30】现房去化面积
,EH_SALE_AREA---【31】现房推售面积
,EH_SALE_RATE_BY_AREA---【32】现房去化率(按面积)(30/31)
,EH_SALE_OUT_MONEY---【33】现房去化货值
,EH_SALE_MONEY---【34】现房推售货值
,EH_SALE_RATE_BY_MONEY---【35】现房去化率(按货值)(33/34)
,EH_SURPLUS_SALE_MONEY---【36】现房剩余货值(34-33)
,EH_SALE_AVERAGE_MONEY---【37】现房标准均价(34/31)
,EH_SALE_OUT_AVERAGE_MONEY---【38】现房签约均价(33/30)
,SI_SALE_OUT_COUNT---【39】顽固性库存去化套数
,SI_SALE_COUNT---【40】顽固性库存推售套数
,SI_SALE_RATE_BY_COUNT---【41】顽固性库存去化率(按套数)(39/40)
,SI_SALE_OUT_AREA---【42】顽固性库存去化面积
,SI_SALE_AREA---【43】顽固性库存推售面积
,SI_SALE_RATE_BY_AREA---【44】顽固性库存去化率(按面积)(42/43)
,SI_SALE_OUT_MONEY---【45】顽固性库存去化货值
,SI_SALE_MONEY---【46】顽固性库存推售货值
,SI_SALE_RATE_BY_MONEY---【47】顽固性库存去化率(按货值)(45/46)
,SI_SURPLUS_SALE_MONEY---【48】顽固性库存剩余货值(46-45)
,SI_SALE_AVERAGE_MONEY---【49】顽固性库存标准均价(46/43)
,SI_SALE_OUT_AVERAGE_MONEY---【50】顽固性库存签约均价(45/42)
,CREATED---【51】创建日期
,FM_SALE_OUT_COUNT ---【51】首月去化套数
,FM_SALE_RATE_BY_COUNT ---【52】首月去化率(按套数)
,FM_SALE_OUT_AREA ---【53】首月去化面积
,FM_SALE_RATE_BY_AREA ---【54】首月去化率(按面积)
,FM_SALE_OUT_MONEY ---【55】首月去化货值
,FM_SALE_RATE_BY_MONEY ---【56】首月去化率(按货值)
,FM_SURPLUS_SALE_MONEY---首月剩余货值
,FM_SALE_AVERAGE_MONEY---首月标准均价
,FM_SALE_OUT_AVERAGE_MONEY---首月签约均价
,FOHY_SALE_OUT_COUNT---首开半年去化套数
,FOHY_SALE_COUNT---首开半年推售套数
,FOHY_SALE_RATE_BY_COUNT---首开半年去化率(按套数)
,FOHY_SALE_OUT_AREA---首开半年去化面积
,FOHY_SALE_AREA---首开半年推售面积
,FOHY_SALE_RATE_BY_AREA---首开半年去化率(按面积)
,FOHY_SALE_OUT_MONEY---首开半年去化货值
,FOHY_SALE_MONEY---首开半年推售货值
,FOHY_SALE_RATE_BY_MONEY---首开半年去化率(按货值)
,FOHY_SURPLUS_SALE_MONEY---首开半年剩余货值
,FOHY_SALE_AVERAGE_MONEY---首开半年标准均价(10/7)
,FOHY_SALE_OUT_AVERAGE_MONEY---首开半年签约均价(9/6)
,CR_SALE_OUT_COUNT
,CR_SALE_COUNT
,CR_SALE_RATE_BY_COUNT
,CR_SALE_OUT_AREA
,CR_SALE_AREA
,CR_SALE_RATE_BY_AREA
,CR_SALE_OUT_MONEY
,CR_SALE_MONEY
,CR_SALE_RATE_BY_MONEY
,CR_SURPLUS_SALE_MONEY
,CR_SALE_AVERAGE_MONEY
,CR_SALE_OUT_AVERAGE_MONEY
,CROY_SALE_OUT_COUNT ---竣备一年去化套数
,CROY_SALE_COUNT ---竣备一年总套数
,CROY_SALE_RATE_BY_COUNT ---竣备一年去化率(按套数)
,CROY_SALE_OUT_AREA ---竣备一年去化面积
,CROY_SALE_AREA ---竣备一年总面积
,CROY_SALE_RATE_BY_AREA ---竣备一年去化率(按面积)
,CROY_SALE_OUT_MONEY ---竣备一年去化货值
,CROY_SALE_MONEY ---竣备一年总货值
,CROY_SALE_RATE_BY_MONEY ---竣备一年去化率(按货值)
,CROY_SURPLUS_SALE_MONEY---竣工备案一年剩余货值
,CROY_SALE_AVERAGE_MONEY---竣工备案一年标准均价
,CROY_SALE_OUT_AVERAGE_MONEY---竣工备案一年签约均价
)select 
spid as ID---【1】主键
,project_id as PROJECT_ID---【2】项目ID
,project_name
,ORG_ID
,ORG_NAME
-----------------------------------K1、首开去化率开始--------------------
,"首开去化套数" as FO_SALE_OUT_COUNT---【3】首开去化套数
,"首开推售套数" as FO_SALE_COUNT---【4】首开推售套数
,case when 首开推售套数=0 then 0 else round("首开去化套数"/"首开推售套数",4)  end as FO_SALE_RATE_BY_COUNT---【5】首开去化率(按套数)（3/4）
,"首开去化面积" as FO_SALE_OUT_AREA---【6】首开去化面积
,"首开推售面积" as FO_SALE_AREA---【7】首开推售面积
,case when 首开推售面积=0 then 0 else round("首开去化面积"/"首开推售面积",4)  end as FO_SALE_RATE_BY_AREA---【8】首开去化率(按面积)（6/7）
,"首开去化货值" as FO_SALE_OUT_MONEY---【9】首开去化货值
,"首开推售货值" as FO_SALE_MONEY---【10】首开推售货值
,case when 首开推售货值=0 then 0 else round("首开去化货值"/"首开推售货值",4)  end as FO_SALE_RATE_BY_MONEY---【11】首开去化率(按货值)（9/10）
,"首开推售货值"-"首开去化货值" as FO_SURPLUS_SALE_MONEY---【12】首开剩余货值(10-9)
,case when 首开推售面积=0 then 0 else round("首开推售货值"/"首开推售面积",4)  end  as FO_SALE_AVERAGE_MONEY---【13】首开标准均价(10/7)
,case when 首开去化面积=0 then 0 else round("首开去化货值"/"首开去化面积",4)  end as FO_SALE_OUT_AVERAGE_MONEY---【14】首开签约均价(9/6)
-----------------------------------K3、全案去化率 （单位：%）--------------------
,"全案已去化套数" as PO_SALE_OUT_COUNT---【15】全案去化套数
,"全案已领证套数" as PO_SALE_COUNT---【16】全案推售套数
,case when 全案已领证套数=0 then 0 else round("全案已去化套数"/"全案已领证套数",4)  end as PO_SALE_RATE_BY_COUNT---【17】全案去化率(按套数)(15/16)
,"全案已去化面积" as PO_SALE_OUT_AREA---【18】全案去化面积
,"全案已领证面积" as PO_SALE_AREA---【19】全案推售面积
,case when 全案已领证面积=0 then 0 else round("全案已去化面积"/"全案已领证面积",4)  end as PO_SALE_RATE_BY_AREA---【20】全案去化率(按面积)(18/19)
,"全案已去化货值" as PO_SALE_OUT_MONEY---【21】全案去化货值
,"全案已领证货值" as PO_SALE_MONEY---【22】全案推售货值
,case when 全案已领证货值=0 then 0 else round("全案已去化货值"/"全案已领证货值",4)  end  as PO_SALE_RATE_BY_MONEY---【23】全案去化率(按货值)(21/22)
,"全案已领证货值"-"全案已去化货值" as PO_SURPLUS_SALE_MONEY---【24】全案剩余货值(22-21)
,case when 全案已领证面积=0 then 0 else round("全案已领证货值"/"全案已领证面积",4)  end  as PO_SALE_AVERAGE_MONEY---【25】全案标准均价(22/19)
,case when 全案已去化面积=0 then 0 else round("全案已去化货值"/"全案已去化面积",4)  end   PO_SALE_OUT_AVERAGE_MONEY---【26】全案签约均价(21/18)
-----------------------------------K4、现房去化率 （单位：%）--------------------
,"现房去化套数" as EH_SALE_OUT_COUNT---【27】现房去化套数
,"现房推售套数" as EH_SALE_COUNT---【28】现房推售套数
,case when 现房推售套数=0 then 0 else  round("现房去化套数"/"现房推售套数",4) end as EH_SALE_RATE_BY_COUNT---【29】现房去化率(按套数)(27/28)
,"现房去化面积" as EH_SALE_OUT_AREA---【30】现房去化面积
,"现房推售面积" as EH_SALE_AREA---【31】现房推售面积
,case when 现房推售面积=0 then 0 else  round("现房去化面积"/"现房推售面积",4) end as EH_SALE_RATE_BY_AREA---【32】现房去化率(按面积)(30/31)
,"现房去化金额" as EH_SALE_OUT_MONEY---【33】现房去化货值
,"现房推售金额" as EH_SALE_MONEY---【34】现房推售货值
,case when 现房推售金额=0 then 0 else  round("现房去化金额"/"现房推售金额",4) end as EH_SALE_RATE_BY_MONEY---【35】现房去化率(按货值)(33/34)
,"现房推售金额"-"现房去化金额" as EH_SURPLUS_SALE_MONEY---【36】现房剩余货值(34-33)
,case when 现房推售面积=0 then 0 else  round("现房推售金额"/"现房推售面积",4) end  as EH_SALE_AVERAGE_MONEY---【37】现房标准均价(34/31)
,case when 现房去化面积=0 then 0 else  round("现房去化金额"/"现房去化面积",4) end  as EH_SALE_OUT_AVERAGE_MONEY---【38】现房签约均价(33/30)
-----------------------------------K5、顽固性库存去化率 （单位：%）--------------------
,"顽固去化套数" as SI_SALE_OUT_COUNT---【39】顽固性库存去化套数
,"顽固推售套数" as SI_SALE_COUNT---【40】顽固性库存推售套数
,case when 顽固推售套数=0 then 0 else  round("顽固去化套数"/"顽固推售套数",4) end as SI_SALE_RATE_BY_COUNT---【41】顽固性库存去化率(按套数)(39/40)
,"顽固去化面积" as SI_SALE_OUT_AREA---【42】顽固性库存去化面积
,"顽固推售面积" as SI_SALE_AREA---【43】顽固性库存推售面积
,case when 顽固推售面积=0 then 0 else  round("顽固去化面积"/"顽固推售面积",4) end  as SI_SALE_RATE_BY_AREA---【44】顽固性库存去化率(按面积)(42/43)
,"顽固去化金额" as SI_SALE_OUT_MONEY---【45】顽固性库存去化货值
,"顽固推售金额" as SI_SALE_MONEY---【46】顽固性库存推售货值
,case when 顽固推售金额=0 then 0 else  round("顽固去化金额"/"顽固推售金额",4) end as SI_SALE_RATE_BY_MONEY---【47】顽固性库存去化率(按货值)(45/46)
,"顽固推售金额"-"顽固去化金额" SI_SURPLUS_SALE_MONEY---【48】顽固性库存剩余货值(46-45)
,case when 顽固推售面积=0 then 0 else  round("顽固推售金额"/"顽固推售面积",4) end as SI_SALE_AVERAGE_MONEY---【49】顽固性库存标准均价(46/43)
,case when 顽固推售面积=0 then 0 else  round("顽固去化金额"/"顽固推售面积",4) end as SI_SALE_OUT_AVERAGE_MONEY---【50】顽固性库存签约均价(45/42)

,sys_created as CREATED---【51】创建日期
----------------------------------------------首月去化率----------------------------------
,"首月去化套数" as FM_SALE_OUT_COUNT ---首月去化套数
,case when 首开推售套数=0 then 0 else round("首月去化套数"/"首开推售套数",4) end as FM_SALE_RATE_BY_COUNT ---首月去化率（按套数）
,"首月去化面积" as FM_SALE_OUT_AREA ---首月去化面积
,case when 首开推售面积=0 then 0 else round("首月去化面积"/"首开推售面积",4) end as FM_SALE_RATE_BY_AREA ---首月去化率（按面积）
,"首月去化货值" as FM_SALE_OUT_MONEY ---首月去化货值
,case when 首开推售货值=0 then 0 else round("首月去化货值"/"首开推售货值",4) end as FM_SALE_RATE_BY_MONEY ---首月去化率（按货值）
,"首开推售货值"-"首月去化货值" as FM_SURPLUS_SALE_MONEY---首月剩余货值
,case when 首开推售面积=0 then 0 else round("首开推售货值"/"首开推售面积",4)  end  as FM_SALE_AVERAGE_MONEY---首月标准均价
,case when 首月去化面积=0 then 0 else round("首月去化货值"/"首月去化面积",4)  end as FM_SALE_OUT_AVERAGE_MONEY---首月签约均价

-----------------------------------首开半年去化率开始---------------------------------------
,"首开半年去化套数" as FOHY_SALE_OUT_COUNT---首开半年去化套数
,"首开半年推售套数" as FOHY_SALE_COUNT---首开半年推售套数
,case when 首开半年推售套数=0 then 0 else round("首开半年去化套数"/"首开半年推售套数",4)  end as FOHY_SALE_RATE_BY_COUNT---首开半年去化率(按套数)
,"首开半年去化面积" as FOHY_SALE_OUT_AREA---首开半年去化面积
,"首开半年推售面积" as FOHY_SALE_AREA---首开半年推售面积
,case when 首开半年推售面积=0 then 0 else round("首开半年去化面积"/"首开半年推售面积",4)  end as FOHY_SALE_RATE_BY_AREA---首开半年去化率(按面积)
,"首开半年去化货值" as FOHY_SALE_OUT_MONEY---首开半年去化货值
,"首开半年推售货值" as FOHY_SALE_MONEY---首开半年推售货值
,case when 首开半年推售货值=0 then 0 else round("首开半年去化货值"/"首开半年推售货值",4)  end as FOHY_SALE_RATE_BY_MONEY---首开半年去化率(按货值)
,"首开半年推售货值"-"首开半年去化货值" as FOHY_SURPLUS_SALE_MONEY---首开半年剩余货值
,case when 首开半年推售面积=0 then 0 else round("首开半年推售货值"/"首开半年推售面积",4)  end  as FOHY_SALE_AVERAGE_MONEY---首开半年标准均价
,case when 首开半年去化面积=0 then 0 else round("首开半年去化货值"/"首开半年去化面积",4)  end as FOHY_SALE_OUT_AVERAGE_MONEY---首开半年签约均价

---------------------------------------竣工备案去化率----------------------------------------
,"竣备去化套数" as CR_SALE_OUT_COUNT 
,"已竣备总套数" as CR_SALE_COUNT
,case when 已竣备总套数=0 then 0 else round("竣备去化套数"/"已竣备总套数",4)  end as CR_SALE_RATE_BY_COUNT---竣备去化率(按套数)
,"竣备去化面积" as CR_SALE_OUT_AREA
,"已竣备总面积" as CR_SALE_AREA
,case when 已竣备总面积=0 then 0 else round("竣备去化面积"/"已竣备总面积",4)  end as CR_SALE_RATE_BY_AREA---竣备去化率(按面积)
,"竣备去化货值" as CR_SALE_OUT_MONEY
,"已竣备总货值" as CR_SALE_MONEY
,case when 已竣备总货值=0 then 0 else round("竣备去化货值"/"已竣备总货值",4)  end as CR_SALE_RATE_BY_MONEY---竣备去化率(按货值)
,"已竣备总货值"-"竣备去化货值" as CR_SURPLUS_SALE_MONEY---竣工备案剩余货值
,case when 已竣备总面积=0 then 0 else round("已竣备总货值"/"已竣备总面积",4)  end  as CR_SALE_AVERAGE_MONEY---竣工备案标准均价
,case when 竣备去化面积=0 then 0 else round("竣备去化货值"/"竣备去化面积",4)  end as CR_SALE_OUT_AVERAGE_MONEY---竣备签约均价

-----------------------------------------竣工备案一年去化率-----------------------------------
,"竣备一年去化套数" as CROY_SALE_OUT_COUNT
,"已竣备一年总套数" as CROY_SALE_COUNT
,case when 已竣备一年总套数 =0 then 0 else round("竣备一年去化套数"/"已竣备一年总套数",4) end as CROY_SALE_RATE_BY_COUNT ---竣备一年去化率（按套数）
,"竣备一年去化面积" as CROY_SALE_OUT_AREA
,"已竣备一年总面积" as CROY_SALE_AREA
,case when 已竣备一年总面积 =0 then 0 else round("竣备一年去化面积"/"已竣备一年总面积",4) end as CROY_SALE_RATE_BY_AREA ---竣备一年去化率(按面积)
,"竣备一年去化货值" as CROY_SALE_OUT_MONEY
,"已竣备一年总货值" as CROY_SALE_MONEY 
,case when 已竣备一年总货值 =0 then 0 else round("竣备一年去化货值"/"已竣备一年总货值",4) end as CROY_SALE_RATE_BY_MONEY ---竣备一年去化率（按货值）
,"已竣备一年总货值"-"竣备一年去化货值" as CROY_SURPLUS_SALE_MONEY---竣工备案一年剩余货值
,case when 已竣备一年总面积=0 then 0 else round("已竣备一年总货值"/"已竣备一年总面积",4)  end  as CROY_SALE_AVERAGE_MONEY---竣工备案一年标准均价
,case when 竣备一年去化面积=0 then 0 else round("竣备一年去化货值"/"竣备一年去化面积",4)  end as CROY_SALE_OUT_AVERAGE_MONEY---竣备一年签约均价
from 
(select 
--------------------------------------------------基础计算字段开始-----
------首次开盘30天内的签约金额（首开去化货值）: 
---------->房间“合同成交总价”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约
sum(case when room.SALE_STATE='签约' 
-- 首开分期房间
and FIRST_OPEN_PERIOD.id is not null
--and proj.first_open_date<=build.GET_PRE_SALE_PERMIT_DATE
and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30 then room.TRADE_TOTAL else 0 end ) as "首开去化货值"

------首次开盘已取证货值（首开推售货值）：
------调整：楼栋预售许可证日期 = 首开日期 当天

--,sum(case when room.SALE_STATE='签约'
---- 首开分期房间
--and FIRST_OPEN_PERIOD.id is not null
----and build.GET_PRE_SALE_PERMIT_DATE<=proj.first_open_date  
--and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30
--then room.TRADE_TOTAL 
--when build.GET_PRE_SALE_PERMIT_DATE<=proj.first_open_date
---- 首开分期房间
--and FIRST_OPEN_PERIOD.id is not null
--then room.BZ_TOTAL else 0 end )  as "首开推售货值"

,sum(case when build.GET_PRE_SALE_PERMIT_DATE = proj.first_open_date then room.BZ_TOTAL else 0 end) as "首开推售货值"

------首次开盘30天内的签约面积（首开去化面积）:
---------->房间“最新建筑面积”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' 
-- 首开分期房间
and FIRST_OPEN_PERIOD.id is not null
--and proj.first_open_date<=build.GET_PRE_SALE_PERMIT_DATE 
and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30  then room.NEW_BLD_AREA else 0 end ) as "首开去化面积"

------首次开盘的已取证面积（首开推售面积）:
------调整：楼栋预售许可证日期 = 首开日期 当天
,sum(case when build.GET_PRE_SALE_PERMIT_DATE = proj.first_open_date then room.NEW_BLD_AREA else 0 end) as "首开推售面积"


------首次开盘30天内的签约套数（首开去化套数）:
---------->房间“汇总”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约  
--,sum(case when room.SALE_STATE='签约' and proj.first_open_date<=build.GET_PRE_SALE_PERMIT_DATE           and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30 then 1 else 0 end ) as "首开去化套数"
,sum(case when room.SALE_STATE='签约' 
-- 首开分期房间
and FIRST_OPEN_PERIOD.id is not null
          --and proj.first_open_date<=build.GET_PRE_SALE_PERMIT_DATE 
and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30 then 1 else 0 end ) as "首开去化套数"


------首次开盘的已取证套数（首开推售套数）:
------调整：楼栋预售许可证日期 = 首开日期 当天
,sum(case when build.GET_PRE_SALE_PERMIT_DATE = proj.first_open_date then 1 else 0 end) as "首开推售套数"




------全案------全案------全案------全案------全案------全案------全案 
------全案（已去化货值）: 
---------->房间“合同成交总价”
---------->房间“销售状态”=签约
,sum(case when room.SALE_STATE='签约' then room.TRADE_TOTAL else 0 end ) as "全案已去化货值"
------全案（已领证货值）：
---------->房间“面价标准总价”:在计算“货值去化率”时，对已签约房间（有可能出现优惠打折），分子分母均按“签约金额”计算“货值去化率”。
,sum(case when room.SALE_STATE='签约'  then room.TRADE_TOTAL  
when room.SALE_STATE<>'签约' and build.GET_PRE_SALE_PERMIT_DATE is not null then room.BZ_TOTAL else 0 end )  as "全案已领证货值"
------全案（已去化面积）:
---------->房间“最新建筑面积”
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约'  then room.NEW_BLD_AREA else 0 end ) as "全案已去化面积"
------全案（已领证面积）:
---------->房间“最新建筑面积”
,sum(case when room.SALE_STATE='签约' or build.GET_PRE_SALE_PERMIT_DATE is not null then room.NEW_BLD_AREA  else 0 end )  as "全案已领证面积"
------全案（已去化套数):
---------->房间“汇总”
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' then 1 else 0 end ) as "全案已去化套数"
------全案（已领证套数):
---------->房间“汇总”
,sum(case when room.SALE_STATE='签约' or build.GET_PRE_SALE_PERMIT_DATE is not null then 1 else 0 end )  as "全案已领证套数"
------现房------现房------现房------现房------现房------现房------现房------现房------现房
----现房去化面积
,sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE = '签约' and room.TRADE_CONTRACT_DATE>proj.COMPLETION_RECORD_DATE then  room.NEW_BLD_AREA else 0 end) as "现房去化面积" ,
----现房推售面积
sum(case when  proj.COMPLETION_RECORD_DATE is not null and   (room.SALE_STATE <> '签约'
or  (room.SALE_STATE = '签约' and room.TRADE_CONTRACT_DATE>proj.COMPLETION_RECORD_DATE) )   then room.NEW_BLD_AREA else 0 end) as 现房推售面积,
----现房去化金额
sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE = '签约' and room.TRADE_CONTRACT_DATE>proj.COMPLETION_RECORD_DATE then  room.TRADE_TOTAL else 0 end) as  现房去化金额,
--推售金额需要根据房间是否已经签约来判断取签约金额还是标准金额
----现房推售金额
sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE <> '签约'   then room.BZ_TOTAL  
when room.SALE_STATE = '签约' and proj.COMPLETION_RECORD_DATE is not null and  room.TRADE_CONTRACT_DATE>proj.COMPLETION_RECORD_DATE then room.TRADE_TOTAL else 0 end) as 现房推售金额,
----现房去化套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE = '签约' and room.TRADE_CONTRACT_DATE>proj.COMPLETION_RECORD_DATE then  1 else 0 end) as  现房去化套数,
----现房推售套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null and  (room.SALE_STATE <> '签约'
or  (room.SALE_STATE = '签约' and room.TRADE_CONTRACT_DATE>proj.COMPLETION_RECORD_DATE) )  then 1 else 0 end) as 现房推售套数
------顽固性库存------顽固性库存------顽固性库存------顽固性库存------顽固性库存------顽固性库存------顽固性库存
----顽固推售面积
,sum(case when  proj.COMPLETION_RECORD_DATE is not null  and room.SALE_STATE = '签约' and  room.PRODUCT_NAME <> '住宅' 
and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and room.TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd')
and room.TRADE_CONTRACT_DATE<sysdate then  room.NEW_BLD_AREA else 0 end) as 顽固去化面积,
----顽固去化面积
sum(case when  proj.COMPLETION_RECORD_DATE is not null  
and  room.PRODUCT_NAME <> '住宅' 
and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and ((TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and  room.TRADE_CONTRACT_DATE<sysdate  and room.SALE_STATE = '签约') or  room.SALE_STATE <> '签约') then room.NEW_BLD_AREA else 0 end) as 顽固推售面积,
----顽固去化金额
sum(case when  proj.COMPLETION_RECORD_DATE is not null  and room.SALE_STATE = '签约' 
and  room.PRODUCT_NAME <> '住宅' 
and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and room.TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd')
and  room.TRADE_CONTRACT_DATE<sysdate  then  room.TRADE_TOTAL else 0 end) as  顽固去化金额,
--推售金额需要根据房间是否已经签约来判断取签约金额还是标准金额
----顽固推售金额
sum(case  when  proj.COMPLETION_RECORD_DATE is not null  
and  room.PRODUCT_NAME <> '住宅'
and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and (TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and  room.TRADE_CONTRACT_DATE<sysdate  and room.SALE_STATE = '签约') then room.TRADE_TOTAL  --已经在今年签约的算签约金额
 when  proj.COMPLETION_RECORD_DATE is not null  and  room.PRODUCT_NAME <> '住宅' 
 and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
 and  room.SALE_STATE <> '签约' then room.BZ_TOTAL  else 0 end) as 顽固推售金额,  --未签约的算校准总价
----顽固去化套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null 
and room.SALE_STATE = '签约' 
and  room.PRODUCT_NAME <> '住宅' 
and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and room.TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and  room.TRADE_CONTRACT_DATE<sysdate then  1 else 0 end) as  顽固去化套数,
----顽固推售套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null  
and  room.PRODUCT_NAME <> '住宅' 
and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and ((TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and  room.TRADE_CONTRACT_DATE<sysdate  and room.SALE_STATE = '签约') or  room.SALE_STATE <> '签约') then 1 else 0 end) as 顽固推售套数
------------------------------------------首月去化率------------------------------------
-----------首次开盘后一个月内首批供货实际签约额（首月去化货值）
--“合同成交总价” TRADE_TOTAL
--SALE_STATE 房间销售状态“签约”
,sum(case when room.SALE_STATE='签约' 
and proj.first_open_date=build.GET_PRE_SALE_PERMIT_DATE 
and room.TRADE_CONTRACT_DATE >= proj.first_open_date 
and room.TRADE_CONTRACT_DATE<=proj.first_open_date+30 then room.TRADE_TOTAL else 0 end ) as "首月去化货值"

-------------首次开盘后一个月 首次开盘 至 项目首次开盘日期+30天 的签约建筑面积 （首月去化面积）
---------->房间“最新建筑面积”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' 
and proj.first_open_date=build.GET_PRE_SALE_PERMIT_DATE 
and room.TRADE_CONTRACT_DATE >= proj.first_open_date
and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30  then room.NEW_BLD_AREA else 0 end ) as "首月去化面积"

------首次开盘30天内的签约套数（首开去化套数）:
---------->房间“汇总”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约  
--,sum(case when room.SALE_STATE='签约' and proj.first_open_date<=build.GET_PRE_SALE_PERMIT_DATE           and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30 then 1 else 0 end ) as "首开去化套数"
,sum(case when room.SALE_STATE='签约' 
and proj.first_open_date=build.GET_PRE_SALE_PERMIT_DATE 
and room.TRADE_CONTRACT_DATE >=proj.first_open_date
and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30 then 1 else 0 end ) as "首月去化套数",


-------------------------------------------------------------首开半年去化率--------------
------首次开盘180天内的签约金额（首开半年去化货值）: 
---------->房间“合同成交总价”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +180天
---------->房间“销售状态”=签约
sum(case when room.SALE_STATE='签约' 
and room.TRADE_CONTRACT_DATE >= proj.first_open_date
and proj.first_open_date=build.GET_PRE_SALE_PERMIT_DATE
and room.TRADE_CONTRACT_DATE<=proj.first_open_date +180 then room.TRADE_TOTAL else 0 end ) as "首开半年去化货值"

------首次开盘已取证货值（首开半年推售货值）：
---------->房间“面价标准总价”:在计算“货值去化率”时，对已签约房间（有可能出现优惠打折），分子分母均按“签约金额”计算“货值去化率”。
---------->房间所属“楼栋预售许可证获取日期”<"项目开盘"的实际完成日期 
,sum(case when build.GET_PRE_SALE_PERMIT_DATE = proj.first_open_date then room.BZ_TOTAL else 0 end) as "首开半年推售货值"

------首次开盘180天内的签约面积（首开半年去化面积）:
---------->房间“最新建筑面积”
---------->"项目开盘"的实际完成日期 < 合同签约日期< "项目开盘"的实际完成日期 +180天
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' 
and FIRST_OPEN_PERIOD.id is not null
and proj.first_open_date=build.GET_PRE_SALE_PERMIT_DATE
and room.TRADE_CONTRACT_DATE >= proj.first_open_date and room.TRADE_CONTRACT_DATE<=proj.first_open_date +180  then room.NEW_BLD_AREA else 0 end ) as "首开半年去化面积"

------首次开盘的“已取证”面积（首开半年推售面积）:
,sum(case when build.GET_PRE_SALE_PERMIT_DATE = proj.first_open_date then room.NEW_BLD_AREA else 0 end) as "首开半年推售面积"

------首次开盘180天内的签约套数（首开半年去化套数）:
-----------项目首次开盘”至“项目首次开盘日期+180天”的签约套数
---------->房间“汇总”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +180天
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' 
and proj.first_open_date=build.GET_PRE_SALE_PERMIT_DATE
and room.TRADE_CONTRACT_DATE >= proj.first_open_date
and room.TRADE_CONTRACT_DATE<=proj.first_open_date +180 then 1 else 0 end ) as "首开半年去化套数"


------首次开盘的已取证套数（首开半年推售套数）:
,sum(case when build.GET_PRE_SALE_PERMIT_DATE = proj.first_open_date then 1 else 0 end) as "首开半年推售套数"

------------------------------------------------------竣工备案去化率-----------------------------------------
-----------------竣工备案去化套数（竣工备案当天及之前”的“签约套数）
------------> 竣工备案当天及之前”的“签约套数”
------------- 项目竣工备案日期必须有值，为null则未竣工备案
-------------合同签约日期 <= 竣工备案日期
,sum(
    case when room.SALE_STATE='签约' and
--    项目竣工备案日期
    proj.COMPLETION_ON_RECORD_DATE is not null and build.GET_PRE_SALE_PERMIT_DATE is not null
--    合同签约日期 <= 竣工备案日期
    and room.TRADE_CONTRACT_DATE <= proj.COMPLETION_ON_RECORD_DATE  then 1 else 0 end
) as "竣备去化套数"

-----------------已竣备总套数（竣工备案当天及之前”的 已取证的套数）
,sum(case when proj.COMPLETION_ON_RECORD_DATE is not null then 1 else 0 end) as "已竣备总套数"


------竣工备案当天及之前”的“签约建筑面积:
---------->竣工备案当天及之前”的“签约建筑面积
---------->房间“最新建筑面积”
---------->合同签约日期<"竣工备案"的实际完成日期
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' and proj.COMPLETION_ON_RECORD_DATE is not null and build.GET_PRE_SALE_PERMIT_DATE is not null
----签约合同日期
and room.TRADE_CONTRACT_DATE<=proj.COMPLETION_ON_RECORD_DATE  then room.NEW_BLD_AREA else 0 end ) as "竣备去化面积"

----------------竣工备案已取证面积:
,sum(case when proj.COMPLETION_ON_RECORD_DATE is not null  then room.NEW_BLD_AREA else 0 end) as "已竣备总面积"


------------楼栋竣工备案当天及之前”的“签约金额: 
---------->房间“合同成交总价”
---------->合同签约日期<"竣工备案"完成日期 
---------->房间“销售状态”=签约
,sum(case when proj.COMPLETION_ON_RECORD_DATE is not null and build.GET_PRE_SALE_PERMIT_DATE is not null and  room.SALE_STATE='签约' 
-- 合同签约日期
and room.TRADE_CONTRACT_DATE<=proj.COMPLETION_ON_RECORD_DATE  then room.TRADE_TOTAL else 0 end ) as "竣备去化货值"


------分期楼栋竣工备案楼栋”最新的“动态版目标货值（已竣备总货值）：
,sum(case when proj.COMPLETION_ON_RECORD_DATE is not null  then room.BZ_TOTAL else 0 end )as "已竣备总货值"


---------------------------------------------竣工备案后一年去化率----------------------------------------------
-----------竣工备案+1天"至“竣工备案+1年”的“签约套数”（竣备一年去化套数）在竣工备案后签约的
------------> 竣工备案当天及之前”的“签约套数”
------------- 项目竣工备案日期必须有值，为null则未竣工备案
-------------  竣工备案日期 < 合同签约日期 <= 竣工备案日期+360天
------------->  预售许可证日期 
,sum(
    case when room.SALE_STATE='签约' and room.PRE_SELL_PERMIT_DATE is not null
--    项目竣工备案日期
    and proj.COMPLETION_ON_RECORD_DATE is not null and build.GET_PRE_SALE_PERMIT_DATE is not null
--    竣工备案日期 < 合同签约日期 <= 竣工备案日期+360  and 预售许可证日期 <= 竣工备案日期+360
    and proj.COMPLETION_ON_RECORD_DATE < room.TRADE_CONTRACT_DATE and room.TRADE_CONTRACT_DATE <= proj.COMPLETION_ON_RECORD_DATE +360 
    and room.PRE_SELL_PERMIT_DATE<=proj.COMPLETION_ON_RECORD_DATE+360  then 1 else 0 end
) as "竣备一年去化套数"

-----------------已竣备总套数（竣工备案当天及之前”的 已取证的套数）
,sum(case when proj.COMPLETION_ON_RECORD_DATE is not null then 1 else 0 end) as "已竣备一年总套数"

-------->竣工备案+1天"至“竣工备案+1年”的签约建筑面积
---------->房间“最新建筑面积”
---------->竣工备案日期 < 合同签约日期 <= "竣工备案+360
---------->房间“销售状态”=签约  
----------> 有楼栋预售许可证
,sum(case when room.SALE_STATE='签约' and build.GET_PRE_SALE_PERMIT_DATE is not null
----  竣工备案日期 < 签约合同日期 <= 竣工备案日期+360
and proj.COMPLETION_ON_RECORD_DATE < room.TRADE_CONTRACT_DATE and room.TRADE_CONTRACT_DATE<=proj.COMPLETION_ON_RECORD_DATE+360 
and room.PRE_SELL_PERMIT_DATE<=proj.COMPLETION_ON_RECORD_DATE   then room.NEW_BLD_AREA else 0 end ) as "竣备一年去化面积"

----------------竣工备案已取证面积:
,sum(case when proj.COMPLETION_ON_RECORD_DATE is not null  then room.NEW_BLD_AREA else 0 end) as "已竣备一年总面积"

------------竣工备案当天+1天"至“竣工备案+1年”的签约金额
---------->房间“合同成交总价”
----------> 竣工备案日期 < 合同签约日期<"竣工备案日期 +360
---------->房间“销售状态”=签约
,sum(case when room.PRE_SELL_PERMIT_DATE is not null and  room.SALE_STATE='签约' 
-- 合同签约日期
and proj.COMPLETION_ON_RECORD_DATE < room.TRADE_CONTRACT_DATE 
and  room.TRADE_CONTRACT_DATE<=proj.COMPLETION_ON_RECORD_DATE + 360  then room.TRADE_TOTAL else 0 end ) as "竣备一年去化货值"


------分期楼栋竣工备案楼栋”最新的“动态版目标货值（已竣备一年总货值）：
,sum(case when proj.COMPLETION_ON_RECORD_DATE is not null then room.BZ_TOTAL else 0 end )as "已竣备一年总货值"

--------------------------------------------------基础计算字段结束
,proj.project_id,
proj.project_name,
proj.org_id,
proj.org_name,
proj.first_open_date,
proj.obtain_date,
proj.COMPLETION_RECORD_DATE,
proj.take_land_date,
proj.plan_first_open_date,
proj.first_open_duration_by_tl,
proj.first_open_duration_by_plan,
proj.new_plan_first_open_date,
proj.exhibition_area_open_date,
proj.plan_approval_date,
proj.is_operate,
proj.is_construction_began
from tmp_proj_base proj left join  MDM_ROOM room  
on proj.project_id=room.project_id  and  proj.id = PROJ_BASE_SPID
left join  mdm_build build on room.BUILDING_ID=build.id 
-- chenl 20200613 只取首开楼栋
left join  SYS_PROJECT_STAGE FIRST_OPEN_PERIOD on build.PERIOD_ID=FIRST_OPEN_PERIOD.id  
AND FIRST_OPEN_PERIOD.IS_FIRST_OPEN_PERIOD=1
group by proj.project_id
    ,proj.project_name,
    proj.org_id,
    proj.org_name,
    proj.first_open_date,
    proj.obtain_date,
    proj.COMPLETION_RECORD_DATE,
    proj.take_land_date,
    proj.plan_first_open_date,
    proj.first_open_duration_by_tl,
    proj.first_open_duration_by_plan,
    proj.new_plan_first_open_date,
    proj.exhibition_area_open_date,
    proj.plan_approval_date,
    proj.is_operate,
    proj.is_construction_began) result  order by "全案已去化货值" asc
;

-- 
IF is_photograph <> 0 THEN
----先将表数据移入，历史的项目数据，后插入新的数据
------------------------------------------------------数据移入历史表;
INSERT INTO dwm_sale_rate_by_proj_history (
    id,
    project_id,
    fo_sale_out_count,
    fo_sale_count,
    fo_sale_rate_by_count,
    fo_sale_out_area,
    fo_sale_area,
    fo_sale_rate_by_area,
    fo_sale_out_money,
    fo_sale_money,
    fo_sale_rate_by_money,
    fo_surplus_sale_money,
    fo_sale_average_money,
    fo_sale_out_average_money,
    po_sale_out_count,
    po_sale_count,
    po_sale_rate_by_count,
    po_sale_out_area,
    po_sale_area,
    po_sale_rate_by_area,
    po_sale_out_money,
    po_sale_money,
    po_sale_rate_by_money,
    po_surplus_sale_money,
    po_sale_average_money,
    po_sale_out_average_money,
    eh_sale_out_count,
    eh_sale_count,
    eh_sale_rate_by_count,
    eh_sale_out_area,
    eh_sale_area,
    eh_sale_rate_by_area,
    eh_sale_out_money,
    eh_sale_money,
    eh_sale_rate_by_money,
    eh_surplus_sale_money,
    eh_sale_average_money,
    eh_sale_out_average_money,
    si_sale_out_count,
    si_sale_count,
    si_sale_rate_by_count,
    si_sale_out_area,
    si_sale_area,
    si_sale_rate_by_area,
    si_sale_out_money,
    si_sale_money,
    si_sale_rate_by_money,
    si_surplus_sale_money,
    si_sale_average_money,
    si_sale_out_average_money,
    created,
    remark,
    fm_sale_out_count,
    fm_sale_rate_by_count,
    fm_sale_out_area,
    fm_sale_rate_by_area,
    fm_sale_out_money,
    fm_sale_rate_by_money,
    fm_surplus_sale_money,
    fm_sale_average_money,
    fm_sale_out_average_money,
    fohy_sale_out_count,
    fohy_sale_count,
    fohy_sale_rate_by_count,
    fohy_sale_out_area,
    fohy_sale_area,
    fohy_sale_rate_by_area,
    fohy_sale_out_money,
    fohy_sale_money,
    fohy_sale_rate_by_money,
    fohy_surplus_sale_money,
    fohy_sale_average_money,
    fohy_sale_out_average_money,
    cr_sale_out_count,
    cr_sale_count,
    cr_sale_rate_by_count,
    cr_sale_out_area,
    cr_sale_area,
    cr_sale_rate_by_area,
    cr_sale_out_money,
    cr_sale_money,
    cr_sale_rate_by_money,
    cr_surplus_sale_money,
    cr_sale_average_money,
    cr_sale_out_average_money,
    croy_sale_out_count,
    croy_sale_count,
    croy_sale_rate_by_count,
    croy_sale_out_area,
    croy_sale_area,
    croy_sale_rate_by_area,
    croy_sale_out_money,
    croy_sale_money,
    croy_sale_rate_by_money,
    croy_surplus_sale_money,
    croy_sale_average_money,
    croy_sale_out_average_money
)
SELECT
    id,
    project_id,
    fo_sale_out_count,
    fo_sale_count,
    fo_sale_rate_by_count,
    fo_sale_out_area,
    fo_sale_area,
    fo_sale_rate_by_area,
    fo_sale_out_money,
    fo_sale_money,
    fo_sale_rate_by_money,
    fo_surplus_sale_money,
    fo_sale_average_money,
    fo_sale_out_average_money,
    po_sale_out_count,
    po_sale_count,
    po_sale_rate_by_count,
    po_sale_out_area,
    po_sale_area,
    po_sale_rate_by_area,
    po_sale_out_money,
    po_sale_money,
    po_sale_rate_by_money,
    po_surplus_sale_money,
    po_sale_average_money,
    po_sale_out_average_money,
    eh_sale_out_count,
    eh_sale_count,
    eh_sale_rate_by_count,
    eh_sale_out_area,
    eh_sale_area,
    eh_sale_rate_by_area,
    eh_sale_out_money,
    eh_sale_money,
    eh_sale_rate_by_money,
    eh_surplus_sale_money,
    eh_sale_average_money,
    eh_sale_out_average_money,
    si_sale_out_count,
    si_sale_count,
    si_sale_rate_by_count,
    si_sale_out_area,
    si_sale_area,
    si_sale_rate_by_area,
    si_sale_out_money,
    si_sale_money,
    si_sale_rate_by_money,
    si_surplus_sale_money,
    si_sale_average_money,
    si_sale_out_average_money,
    created,
    remark,
    fm_sale_out_count,
    fm_sale_rate_by_count,
    fm_sale_out_area,
    fm_sale_rate_by_area,
    fm_sale_out_money,
    fm_sale_rate_by_money,
    fm_surplus_sale_money,
    fm_sale_average_money,
    fm_sale_out_average_money,
    fohy_sale_out_count,
    fohy_sale_count,
    fohy_sale_rate_by_count,
    fohy_sale_out_area,
    fohy_sale_area,
    fohy_sale_rate_by_area,
    fohy_sale_out_money,
    fohy_sale_money,
    fohy_sale_rate_by_money,
    fohy_surplus_sale_money,
    fohy_sale_average_money,
    fohy_sale_out_average_money,
    cr_sale_out_count,
    cr_sale_count,
    cr_sale_rate_by_count,
    cr_sale_out_area,
    cr_sale_area,
    cr_sale_rate_by_area,
    cr_sale_out_money,
    cr_sale_money,
    cr_sale_rate_by_money,
    cr_surplus_sale_money,
    cr_sale_average_money,
    cr_sale_out_average_money,
    croy_sale_out_count,
    croy_sale_count,
    croy_sale_rate_by_count,
    croy_sale_out_area,
    croy_sale_area,
    croy_sale_rate_by_area,
    croy_sale_out_money,
    croy_sale_money,
    croy_sale_rate_by_money,
    croy_surplus_sale_money,
    croy_sale_average_money,
    croy_sale_out_average_money
FROM
    dwm_sale_rate_by_proj_history;
commit;
------------------------------------------------------删除已移入历史表树；
DELETE FROM DWM_SALE_RATE_BY_PROJECT ;
    --where REMARK=dwm_REMARK;
commit;
--------------------------------------------------------新增拍照数据;
INSERT INTO DWM_SALE_RATE_BY_PROJECT (
ID---【1】主键
,PROJECT_ID---【2】项目ID
,FO_SALE_OUT_COUNT---【3】首开去化套数
,FO_SALE_COUNT---【4】首开推售套数
,FO_SALE_RATE_BY_COUNT---【5】首开去化率(按套数)（3/4）
,FO_SALE_OUT_AREA---【6】首开去化面积
,FO_SALE_AREA---【7】首开推售面积
,FO_SALE_RATE_BY_AREA---【8】首开去化率(按面积)（6/7）
,FO_SALE_OUT_MONEY---【9】首开去化货值
,FO_SALE_MONEY---【10】首开推售货值
,FO_SALE_RATE_BY_MONEY---【11】首开去化率(按货值)（9/10）
,FO_SURPLUS_SALE_MONEY---【12】首开剩余货值(10-9)
,FO_SALE_AVERAGE_MONEY---【13】首开标准均价(10/7)
,FO_SALE_OUT_AVERAGE_MONEY---【14】首开签约均价(9/6)
,PO_SALE_OUT_COUNT---【15】全案去化套数
,PO_SALE_COUNT---【16】全案推售套数
,PO_SALE_RATE_BY_COUNT---【17】全案去化率(按套数)(15/16)
,PO_SALE_OUT_AREA---【18】全案去化面积
,PO_SALE_AREA---【19】全案推售面积
,PO_SALE_RATE_BY_AREA---【20】全案去化率(按面积)(18/19)
,PO_SALE_OUT_MONEY---【21】全案去化货值
,PO_SALE_MONEY---【22】全案推售货值
,PO_SALE_RATE_BY_MONEY---【23】全案去化率(按货值)(21/22)
,PO_SURPLUS_SALE_MONEY---【24】全案剩余货值(22-21)
,PO_SALE_AVERAGE_MONEY---【25】全案标准均价(22/19)
,PO_SALE_OUT_AVERAGE_MONEY---【26】全案签约均价(21/18)
,EH_SALE_OUT_COUNT---【27】现房去化套数
,EH_SALE_COUNT---【28】现房推售套数
,EH_SALE_RATE_BY_COUNT---【29】现房去化率(按套数)(27/28)
,EH_SALE_OUT_AREA---【30】现房去化面积
,EH_SALE_AREA---【31】现房推售面积
,EH_SALE_RATE_BY_AREA---【32】现房去化率(按面积)(30/31)
,EH_SALE_OUT_MONEY---【33】现房去化货值
,EH_SALE_MONEY---【34】现房推售货值
,EH_SALE_RATE_BY_MONEY---【35】现房去化率(按货值)(33/34)
,EH_SURPLUS_SALE_MONEY---【36】现房剩余货值(34-33)
,EH_SALE_AVERAGE_MONEY---【37】现房标准均价(34/31)
,EH_SALE_OUT_AVERAGE_MONEY---【38】现房签约均价(33/30)
,SI_SALE_OUT_COUNT---【39】顽固性库存去化套数
,SI_SALE_COUNT---【40】顽固性库存推售套数
,SI_SALE_RATE_BY_COUNT---【41】顽固性库存去化率(按套数)(39/40)
,SI_SALE_OUT_AREA---【42】顽固性库存去化面积
,SI_SALE_AREA---【43】顽固性库存推售面积
,SI_SALE_RATE_BY_AREA---【44】顽固性库存去化率(按面积)(42/43)
,SI_SALE_OUT_MONEY---【45】顽固性库存去化货值
,SI_SALE_MONEY---【46】顽固性库存推售货值
,SI_SALE_RATE_BY_MONEY---【47】顽固性库存去化率(按货值)(45/46)
,SI_SURPLUS_SALE_MONEY---【48】顽固性库存剩余货值(46-45)
,SI_SALE_AVERAGE_MONEY---【49】顽固性库存标准均价(46/43)
,SI_SALE_OUT_AVERAGE_MONEY---【50】顽固性库存签约均价(45/42)
,CREATED---【51】创建日期
,REMARK---【52】备注信息
,FM_SALE_OUT_COUNT---首月去化套数
,FM_SALE_RATE_BY_COUNT---首月去化率（按套数）
,FM_SALE_OUT_AREA---首月去化面积
,FM_SALE_RATE_BY_AREA---首月去化率（按面积）
,FM_SALE_OUT_MONEY---首月去化货值
,FM_SALE_RATE_BY_MONEY---首月去化率（按货值）
,FM_SURPLUS_SALE_MONEY---首月剩余货值
,FM_SALE_AVERAGE_MONEY---首月标准均价
,FM_SALE_OUT_AVERAGE_MONEY---首月签约均价
,FOHY_SALE_OUT_COUNT ---首开半年去化套数
,FOHY_SALE_COUNT ---首开半年推售套数
,FOHY_SALE_RATE_BY_COUNT ---首开半年去化率(按套数)
,FOHY_SALE_OUT_AREA---首开半年去化面积
,FOHY_SALE_AREA---首开半年推售面积
,FOHY_SALE_RATE_BY_AREA---首开半年去化率(按面积)
,FOHY_SALE_OUT_MONEY---首开半年去化货值
,FOHY_SALE_MONEY---首开半年推售货值
,FOHY_SALE_RATE_BY_MONEY---首开半年去化率(按货值)
,FOHY_SURPLUS_SALE_MONEY---首开半年剩余货值
,FOHY_SALE_AVERAGE_MONEY---首开半年标准均价
,FOHY_SALE_OUT_AVERAGE_MONEY---首开半年签约均价
,CR_SALE_OUT_COUNT
,CR_SALE_COUNT
,CR_SALE_RATE_BY_COUNT
,CR_SALE_OUT_AREA
,CR_SALE_AREA
,CR_SALE_RATE_BY_AREA
,CR_SALE_OUT_MONEY
,CR_SALE_MONEY
,CR_SALE_RATE_BY_MONEY
,CR_SURPLUS_SALE_MONEY
,CR_SALE_AVERAGE_MONEY
,CR_SALE_OUT_AVERAGE_MONEY
,CROY_SALE_OUT_COUNT
,CROY_SALE_COUNT
,CROY_SALE_RATE_BY_COUNT
,CROY_SALE_OUT_AREA
,CROY_SALE_AREA
,CROY_SALE_RATE_BY_AREA
,CROY_SALE_OUT_MONEY
,CROY_SALE_MONEY
,CROY_SALE_RATE_BY_MONEY
,CROY_SURPLUS_SALE_MONEY
,CROY_SALE_AVERAGE_MONEY
,CROY_SALE_OUT_AVERAGE_MONEY
        )
            SELECT
PROJECT_ID      ID---【1】主键
,PROJECT_ID---【2】项目ID
,FO_SALE_OUT_COUNT---【3】首开去化套数
,FO_SALE_COUNT---【4】首开推售套数
,FO_SALE_RATE_BY_COUNT---【5】首开去化率(按套数)（3/4）
,FO_SALE_OUT_AREA---【6】首开去化面积
,FO_SALE_AREA---【7】首开推售面积
,FO_SALE_RATE_BY_AREA---【8】首开去化率(按面积)（6/7）
,FO_SALE_OUT_MONEY---【9】首开去化货值
,FO_SALE_MONEY---【10】首开推售货值
,FO_SALE_RATE_BY_MONEY---【11】首开去化率(按货值)（9/10）
,FO_SURPLUS_SALE_MONEY---【12】首开剩余货值(10-9)
,FO_SALE_AVERAGE_MONEY---【13】首开标准均价(10/7)
,FO_SALE_OUT_AVERAGE_MONEY---【14】首开签约均价(9/6)
,PO_SALE_OUT_COUNT---【15】全案去化套数
,PO_SALE_COUNT---【16】全案推售套数
,PO_SALE_RATE_BY_COUNT---【17】全案去化率(按套数)(15/16)
,PO_SALE_OUT_AREA---【18】全案去化面积
,PO_SALE_AREA---【19】全案推售面积
,PO_SALE_RATE_BY_AREA---【20】全案去化率(按面积)(18/19)
,PO_SALE_OUT_MONEY---【21】全案去化货值
,PO_SALE_MONEY---【22】全案推售货值
,PO_SALE_RATE_BY_MONEY---【23】全案去化率(按货值)(21/22)
,PO_SURPLUS_SALE_MONEY---【24】全案剩余货值(22-21)
,PO_SALE_AVERAGE_MONEY---【25】全案标准均价(22/19)
,PO_SALE_OUT_AVERAGE_MONEY---【26】全案签约均价(21/18)
,EH_SALE_OUT_COUNT---【27】现房去化套数
,EH_SALE_COUNT---【28】现房推售套数
,EH_SALE_RATE_BY_COUNT---【29】现房去化率(按套数)(27/28)
,EH_SALE_OUT_AREA---【30】现房去化面积
,EH_SALE_AREA---【31】现房推售面积
,EH_SALE_RATE_BY_AREA---【32】现房去化率(按面积)(30/31)
,EH_SALE_OUT_MONEY---【33】现房去化货值
,EH_SALE_MONEY---【34】现房推售货值
,EH_SALE_RATE_BY_MONEY---【35】现房去化率(按货值)(33/34)
,EH_SURPLUS_SALE_MONEY---【36】现房剩余货值(34-33)
,EH_SALE_AVERAGE_MONEY---【37】现房标准均价(34/31)
,EH_SALE_OUT_AVERAGE_MONEY---【38】现房签约均价(33/30)
,SI_SALE_OUT_COUNT---【39】顽固性库存去化套数
,SI_SALE_COUNT---【40】顽固性库存推售套数
,SI_SALE_RATE_BY_COUNT---【41】顽固性库存去化率(按套数)(39/40)
,SI_SALE_OUT_AREA---【42】顽固性库存去化面积
,SI_SALE_AREA---【43】顽固性库存推售面积
,SI_SALE_RATE_BY_AREA---【44】顽固性库存去化率(按面积)(42/43)
,SI_SALE_OUT_MONEY---【45】顽固性库存去化货值
,SI_SALE_MONEY---【46】顽固性库存推售货值
,SI_SALE_RATE_BY_MONEY---【47】顽固性库存去化率(按货值)(45/46)
,SI_SURPLUS_SALE_MONEY---【48】顽固性库存剩余货值(46-45)
,SI_SALE_AVERAGE_MONEY---【49】顽固性库存标准均价(46/43)
,SI_SALE_OUT_AVERAGE_MONEY---【50】顽固性库存签约均价(45/42)
,CREATED---【51】创建日期
,dwm_REMARK---【52】备注信息
,FM_SALE_OUT_COUNT---首月去化套数
,FM_SALE_RATE_BY_COUNT---首月去化率（按套数）
,FM_SALE_OUT_AREA---首月去化面积
,FM_SALE_RATE_BY_AREA---首月去化率（按面积）
,FM_SALE_OUT_MONEY---首月去化货值
,FM_SALE_RATE_BY_MONEY---首月去化率（按货值）
,FM_SURPLUS_SALE_MONEY---首月剩余货值
,FM_SALE_AVERAGE_MONEY---首月标准均价
,FM_SALE_OUT_AVERAGE_MONEY---首月签约均价
,FOHY_SALE_OUT_COUNT ---首开半年去化套数
,FOHY_SALE_COUNT ---首开半年推售套数
,FOHY_SALE_RATE_BY_COUNT ---首开半年去化率(按套数)
,FOHY_SALE_OUT_AREA---首开半年去化面积
,FOHY_SALE_AREA---首开半年推售面积
,FOHY_SALE_RATE_BY_AREA---首开半年去化率(按面积)
,FOHY_SALE_OUT_MONEY---首开半年去化货值
,FOHY_SALE_MONEY---首开半年推售货值
,FOHY_SALE_RATE_BY_MONEY---首开半年去化率(按货值)
,FOHY_SURPLUS_SALE_MONEY---首开半年剩余货值
,FOHY_SALE_AVERAGE_MONEY---首开半年标准均价
,FOHY_SALE_OUT_AVERAGE_MONEY---首开半年签约均价
,CR_SALE_OUT_COUNT
,CR_SALE_COUNT
,CR_SALE_RATE_BY_COUNT
,CR_SALE_OUT_AREA
,CR_SALE_AREA
,CR_SALE_RATE_BY_AREA
,CR_SALE_OUT_MONEY
,CR_SALE_MONEY
,CR_SALE_RATE_BY_MONEY
,CR_SURPLUS_SALE_MONEY
,CR_SALE_AVERAGE_MONEY
,CR_SALE_OUT_AVERAGE_MONEY
,CROY_SALE_OUT_COUNT
,CROY_SALE_COUNT
,CROY_SALE_RATE_BY_COUNT
,CROY_SALE_OUT_AREA
,CROY_SALE_AREA
,CROY_SALE_RATE_BY_AREA
,CROY_SALE_OUT_MONEY
,CROY_SALE_MONEY
,CROY_SALE_RATE_BY_MONEY
,CROY_SURPLUS_SALE_MONEY
,CROY_SALE_AVERAGE_MONEY
,CROY_SALE_OUT_AVERAGE_MONEY
            FROM
                TMP_SALE_RATE_BY_PROJECT where id=spid;


commit;
    END IF;

--    open SALE_RATE_BY_PROJECT for
--select * FROM
--                TMP_SALE_RATE_BY_PROJECT where id=spid;
END P_DWM_SALE_RATE_BY_PROJ;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_SALE_RATE_PROJ
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_SALE_RATE_PROJ" (
    is_photograph    IN               NUMBER ,
    proj_base_spid   OUT              VARCHAR2
--    
--        ,proj_base out SYS_REFCURSOR
--         ,proj_plan out SYS_REFCURSOR
) AS
		--去化率项目基础数据刷新;作用=>去化率数据定时更新。
        --调用范围：P_DWM_SALE_RATE_BY_PROJ,P_DWM_SALE_RATE_BY_GRANULARITY,根据proj_base_spid使用tmp_proj_base数据
		--作者：陈丽
		--日期：2020-04-10
    spid VARCHAR2(36); --使用临时表的批次号
plan_stage VARCHAR2(360):= '1期,一期,无分期';
node_exhibit_open_type VARCHAR2(50):='node_exhibit_open';
node_plan_approval_type VARCHAR2(50):='node_plan_approval';
node_get_land_type VARCHAR2(50):='node_get_land';
node_start_work_type VARCHAR2(50):='node_start_work';
node_completed_permit_type VARCHAR2(50):='node_completed_permit';
node_project_open_type VARCHAR2(50):='node_project_open';
proj_completed_permit_type VARCHAR2(50):='proj_completed_permit';

node_exhibit_open VARCHAR2(50):='988e38a7-77ef-77eb-e053-0100007f3dda';	--备注--展示区开放（含售楼部、样板间）
node_plan_approval VARCHAR2(50):='988e38a7-77fa-77eb-e053-0100007f3dda';	--备注--规划方案批复
node_get_land VARCHAR2(50):='988e38a7-77c3-77eb-e053-0100007f3dda';	--备注--土地获取
node_start_work VARCHAR2(50):='988e38a7-7813-77eb-e053-0100007f3dda';	--备注--首开楼栋基础开工
node_completed_permit VARCHAR2(50):='988e38a7-7878-77eb-e053-0100007f3dda';	--备注--竣工备案
node_project_open VARCHAR2(50):='988e38a7-7827-77eb-e053-0100007f3dda';	--备注--项目开盘
dwm_REMARK VARCHAR2(200):='测试-chenl';
COMPLETION_ON_RECORD_DATE date;
sys_created date:=sysdate;
BEGIN
delete tmp_proj_related_date;
delete tmp_proj_base;
commit;
--------创建临时表批次号
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;  
--select * from (select obj_phase.*,row_number() over(partition by obj_id order by PHASE_ORDER desc) as order_num from obj_phase )obj_phase_order where order_num = 1
------------------------------------------------备注------------------------------------------------备注--展示区开放（含售楼部、样板间）
  INSERT INTO tmp_proj_related_date (id,project_id,project_date_type,plan_end_date,actual_end_date,estimate_end_date,remark)
    select spid,project_id,nType,plan_end_date,actual_end_date,estimate_end_date,node_name
    from (select obj.*,row_number() over(partition by project_id order by plan_end_date) as order_num 
    from ( 
    ----project_id分组正序取第一条
    SELECT spid,ps.project_id,node_exhibit_open_type as nType,plan_end_date,actual_end_date,estimate_end_date,nodestartsales.node_name
    FROM   pom_proj_plan plan 
    LEFT JOIN pom_proj_plan_node  nodestartsales ON plan.id = nodestartsales.PROJ_PLAN_ID  AND nodestartsales.standard_node_id = node_exhibit_open                           
    left join sys_project_stage  ps ON ps.id = plan.proj_id  and (ps.IS_FIRST_OPEN_PERIOD=1 or  stage_name IN (SELECT column_value FROM TABLE ( split(plan_stage) ))   )                        
        WHERE   plan.approval_status = '已审核'   AND plan.plan_type = '关键节点计划' and IS_DELETE=0 and IS_DISABLE=0 
        GROUP BY ps.project_id,plan_end_date,actual_end_date,estimate_end_date,node_name
    ---project_id分组正序取第一条
        )obj) where order_num = 1;  ------------------------------------------------备注
------------------------------------------------备注------------------------------------------------备注--规划方案批复
  INSERT INTO tmp_proj_related_date (id,project_id,project_date_type,plan_end_date,actual_end_date,estimate_end_date,remark)

    select spid,project_id,nType,plan_end_date,actual_end_date,estimate_end_date,node_name
    from (select obj.*,row_number() over(partition by project_id order by plan_end_date) as order_num 
    from ( 
    ----project_id分组正序取第一条
    SELECT spid,ps.project_id,node_plan_approval_type as nType,plan_end_date,actual_end_date,estimate_end_date,nodestartsales.node_name
    FROM   pom_proj_plan plan 
    LEFT JOIN pom_proj_plan_node  nodestartsales ON plan.id = nodestartsales.PROJ_PLAN_ID  AND nodestartsales.standard_node_id = node_plan_approval                           
    left join sys_project_stage  ps ON ps.id = plan.proj_id  and (ps.IS_FIRST_OPEN_PERIOD=1 or  stage_name IN (SELECT column_value FROM TABLE ( split(plan_stage) ))  )                         
        WHERE   plan.approval_status = '已审核'   AND plan.plan_type = '关键节点计划' and IS_DELETE=0 and IS_DISABLE=0 
        GROUP BY ps.project_id,plan_end_date,actual_end_date,estimate_end_date,node_name ------------------------------------------------备注
    ---project_id分组正序取第一条
        )obj) where order_num = 1;  

------------------------------------------------备注------------------------------------------------备注--土地获取
  INSERT INTO tmp_proj_related_date (id,project_id,project_date_type,plan_end_date,actual_end_date,estimate_end_date,remark)
     select spid,project_id,nType,plan_end_date,actual_end_date,estimate_end_date,node_name
    from (select obj.*,row_number() over(partition by project_id order by plan_end_date) as order_num 
    from ( 
    ----project_id分组正序取第一条

    SELECT spid,ps.project_id,node_get_land_type as nType,plan_end_date,actual_end_date,estimate_end_date,nodestartsales.node_name
    FROM   pom_proj_plan plan 
    LEFT JOIN pom_proj_plan_node  nodestartsales ON plan.id = nodestartsales.PROJ_PLAN_ID  AND nodestartsales.standard_node_id = node_get_land                           
    left join sys_project_stage  ps ON ps.id = plan.proj_id  and (ps.IS_FIRST_OPEN_PERIOD=1 or  stage_name IN (SELECT column_value FROM TABLE ( split(plan_stage) ))     )                      
        WHERE   plan.approval_status = '已审核'   AND plan.plan_type = '关键节点计划' and IS_DELETE=0 and IS_DISABLE=0 
        GROUP BY ps.project_id,plan_end_date,actual_end_date,estimate_end_date,node_name   ------------------------------------------------备注
    ---project_id分组正序取第一条
        )obj) where order_num = 1;  
------------------------------------------------备注------------------------------------------------备注--首开楼栋基础开工
  INSERT INTO tmp_proj_related_date (id,project_id,project_date_type,plan_end_date,actual_end_date,estimate_end_date,remark)
     select spid,project_id,nType,plan_end_date,actual_end_date,estimate_end_date,node_name
    from (select obj.*,row_number() over(partition by project_id order by plan_end_date) as order_num 
    from ( 
    ----project_id分组正序取第一条

    SELECT spid,ps.project_id,node_start_work_type as nType,plan_end_date,actual_end_date,estimate_end_date,nodestartsales.node_name
    FROM   pom_proj_plan plan 
    LEFT JOIN pom_proj_plan_node  nodestartsales ON plan.id = nodestartsales.PROJ_PLAN_ID  AND nodestartsales.standard_node_id = node_start_work                           
    left join sys_project_stage  ps ON ps.id = plan.proj_id  and (ps.IS_FIRST_OPEN_PERIOD=1 or  stage_name IN (SELECT column_value FROM TABLE ( split(plan_stage) ))  )                         
        WHERE   plan.approval_status = '已审核'   AND plan.plan_type = '关键节点计划' and IS_DELETE=0 and IS_DISABLE=0 
        GROUP BY ps.project_id,plan_end_date,actual_end_date,estimate_end_date,node_name   ------------------------------------------------备注
 ---project_id分组正序取第一条
        )obj) where order_num = 1;  
------------------------------------------------备注------------------------------------------------备注--竣工备案
  INSERT INTO tmp_proj_related_date (id,project_id,project_date_type,plan_end_date,actual_end_date,estimate_end_date,remark)
     select spid,project_id,nType,plan_end_date,actual_end_date,estimate_end_date,node_name
    from (select obj.*,row_number() over(partition by project_id order by plan_end_date) as order_num 
    from ( 
    ----project_id分组正序取第一条

    SELECT spid,ps.project_id,node_completed_permit_type as nType,plan_end_date,actual_end_date,estimate_end_date,nodestartsales.node_name
    FROM   pom_proj_plan plan 
    LEFT JOIN pom_proj_plan_node  nodestartsales ON plan.id = nodestartsales.PROJ_PLAN_ID  AND nodestartsales.standard_node_id = node_completed_permit                           
    left join sys_project_stage  ps ON ps.id = plan.proj_id  and (ps.IS_FIRST_OPEN_PERIOD=1 or  stage_name IN (SELECT column_value FROM TABLE ( split(plan_stage) ))  )                         
        WHERE   plan.approval_status = '已审核'   AND plan.plan_type = '关键节点计划'
        and fission_source_original_id is null  and IS_DELETE=0 and IS_DISABLE=0 
        GROUP BY ps.project_id,plan_end_date,actual_end_date,estimate_end_date,node_name   ------------------------------------------------备注
 ---project_id分组正序取第一条
        )obj) where order_num = 1;  
------------------------------------------------备注------------------------------------------------备注--项目开盘
  INSERT INTO tmp_proj_related_date (id,project_id,project_date_type,plan_end_date,actual_end_date,estimate_end_date,remark)
       select spid,project_id,nType,plan_end_date,actual_end_date,estimate_end_date,node_name
    from (select obj.*,row_number() over(partition by project_id order by plan_end_date) as order_num 
    from ( 
    ----project_id分组正序取第一条

    SELECT spid,ps.project_id,node_project_open_type as nType,plan_end_date,actual_end_date,estimate_end_date,nodestartsales.node_name
    FROM   pom_proj_plan plan 
    LEFT JOIN pom_proj_plan_node  nodestartsales ON plan.id = nodestartsales.PROJ_PLAN_ID  AND nodestartsales.standard_node_id = node_project_open                           
    left join sys_project_stage  ps ON ps.id = plan.proj_id  and (ps.IS_FIRST_OPEN_PERIOD=1 or  stage_name IN (SELECT column_value FROM TABLE ( split(plan_stage) ))  )                         
        WHERE   plan.approval_status = '已审核'   AND plan.plan_type = '关键节点计划'  and IS_DELETE=0 and IS_DISABLE=0 
        GROUP BY ps.project_id,plan_end_date,actual_end_date,estimate_end_date,node_name   ------------------------------------------------备注
 ---project_id分组正序取第一条
        )obj) where order_num = 1;  





    INSERT INTO tmp_proj_base (
        ID,--主键
        PROJECT_ID,--项目ID
        PROJECT_NAME,--项目名称
        ORG_ID,--所属事业部ID
        ORG_NAME,--所属事业部
        FIRST_OPEN_DATE,--首开日期
        OBTAIN_DATE,--项目获得日期
        COMPLETION_RECORD_DATE,--首次竣备日期
        TAKE_LAND_DATE,--拿地日期
        PLAN_FIRST_OPEN_DATE,--计划首开日期
        FIRST_OPEN_DURATION_BY_PLAN,--原计划首开时长(10-9)
        FIRST_OPEN_DURATION_BY_TL,--拿地至首开时长(6-9)
        NEW_PLAN_FIRST_OPEN_DATE,--最新预计首开日期
        EXHIBITION_AREA_OPEN_DATE,--展示区开放日期
        EXHIBITION_AREA_OPEN_BY_PLAN,--展示区开放计划日期
        PLAN_APPROVAL_DATE,--方案批复日期
        PLAN_APPROVAL_DATE_BY_PLAN,--方案批复计划日期
        IS_OPERATE,--是否操盘
        IS_CONSTRUCTION_BEGAN,--是否已开工

        CREATED,--创建日期
        REMARK,--备注信息
        COMPLETION_ON_RECORD_DATE ---竣工备案日期
    )
        SELECT
            spid                          AS id,
            project.project_original_id   AS project_id,--项目ID
            project.project_name          AS project_name,--项目名称
            project.company_id            AS org_id,--所属事业部ID
            project.company_name          AS org_name,--所属事业部
            node_project_open1.actual_end_date     AS first_open_date,--实际首开时间----1
            node_get_land1.actual_end_date      AS obtain_date,--项目获取日期
            node_completed_permit1.actual_end_date     AS first_completion_record_date,--首次竣备日期------2
            node_get_land1.actual_end_date     AS take_land_date,--拿地日期----3
            node_project_open1.plan_end_date     AS plan_first_open_date,--计划首开日期-----4
            node_project_open1.plan_end_date - node_get_land1.actual_end_date AS first_open_duration_by_plan,--原计划首开时长
            node_project_open1.actual_end_date - node_get_land1.actual_end_date AS first_open_duration_by_tl,--拿地至首开时间
            node_project_open1.estimate_end_date      AS new_plan_first_open_date,--最新预计首开日期----5
            node_exhibit_open1.actual_end_date     AS exhibition_area_open_date,--实际展示区开放时间---6
            node_exhibit_open1.plan_end_date ,--计划展示区开放时间----7
            node_plan_approval1.actual_end_date     AS plan_approval_date,--方案批复时间----7
            node_plan_approval1.plan_end_date  ,--计划方案批复时间----7 
            CASE
                WHEN project.proj_cooperate = '操盘' THEN
                    1
                ELSE
                    0
            END AS is_operate,--as project.PROJ_COOPERATE 是否操盘
            CASE
                WHEN node_start_work1.actual_end_date is not null THEN
                    1
                ELSE
                    0
            END     AS is_construction_began,--是否开工----7

            sys_created,
            '测试' AS remark,
            --COMPLETION_ON_RECORD_DATE
            alljungong.completed_permit_date
        FROM
            mdm_project             project  
--备注--展示区开放（含售楼部、样板间）	
LEFT JOIN tmp_proj_related_date   node_exhibit_open1 ON project.project_original_id = node_exhibit_open1.project_id AND node_exhibit_open1.project_date_type = node_exhibit_open_type
--备注--规划方案批复	
LEFT JOIN tmp_proj_related_date   node_plan_approval1 ON project.project_original_id = node_plan_approval1.project_id AND node_plan_approval1.project_date_type = node_plan_approval_type
--备注--土地获取	
LEFT JOIN tmp_proj_related_date   node_get_land1 ON project.project_original_id = node_get_land1.project_id AND node_get_land1.project_date_type = node_get_land_type
--备注--首开楼栋基础开工	
LEFT JOIN tmp_proj_related_date   node_start_work1 ON project.project_original_id = node_start_work1.project_id AND node_start_work1.project_date_type = node_start_work_type
--备注--竣工备案	
LEFT JOIN tmp_proj_related_date   node_completed_permit1 ON project.project_original_id = node_completed_permit1.project_id AND node_completed_permit1.project_date_type = node_completed_permit_type
--备注--项目开盘	
LEFT JOIN tmp_proj_related_date   node_project_open1 ON project.project_original_id = node_project_open1.project_id AND node_project_open1.project_date_type = node_project_open_type
--备注--项目全部竣工
left join (with  base as (
SELECT builld.completed_permit_date,builld.id as builldid,proj.id,proj.project_name,stage.id stageid,stage.stage_name  FROM  sys_project proj
left join SYS_PROJECT_STAGE stage on proj.id=stage.project_id
left join SYS_BUILD builld on stage.id=builld.period_id)

,未竣工项目详情 as(
SELECT * FROM base where id is null or completed_permit_date is null
)
,未竣工项目 as(
SELECT id,project_name FROM 未竣工项目详情 group by id,project_name
)
--select id,project_name from base group by id,project_name;
,已竣工项目 as (select base.* from base 
left join 未竣工项目 on base.id=未竣工项目.id where 未竣工项目.id is  null) 

,项目竣工日期 as (
select max(completed_permit_date) as completed_permit_date,id,project_name from 已竣工项目
group by id,project_name
)

select * from 项目竣工日期)   alljungong
   on project.project_original_id = alljungong.id

WHERE project.approval_status = '已审核';

    IF is_photograph <> 0 THEN
--先删除，历史的项目数据，后插入新的数据
        DELETE FROM dwm_sale_rate_project  where CREATED<sys_created;

        INSERT INTO dwm_sale_rate_project (
            ID,--主键
        PROJECT_ID,--项目ID
        PROJECT_NAME,--项目名称
        ORG_ID,--所属事业部ID
        ORG_NAME,--所属事业部
        FIRST_OPEN_DATE,--首开日期
        OBTAIN_DATE,--项目获得日期
        COMPLETION_RECORD_DATE,--首次竣备日期
        TAKE_LAND_DATE,--拿地日期
        PLAN_FIRST_OPEN_DATE,--计划首开日期
        FIRST_OPEN_DURATION_BY_PLAN,--原计划首开时长(10-9)
        FIRST_OPEN_DURATION_BY_TL,--拿地至首开时长(6-9)
        NEW_PLAN_FIRST_OPEN_DATE,--最新预计首开日期
        EXHIBITION_AREA_OPEN_DATE,--展示区开放日期
        EXHIBITION_AREA_OPEN_BY_PLAN,--展示区开放计划日期
        PLAN_APPROVAL_DATE,--方案批复日期
        PLAN_APPROVAL_DATE_BY_PLAN,--方案批复计划日期
        IS_OPERATE,--是否操盘
        IS_CONSTRUCTION_BEGAN,--是否已开工
        HAS_FIRST_PHASE_KEY_PLAN,--是否已上线关键节点计划
        CREATED,--创建日期
        REMARK,--备注信息
        COMPLETION_ON_RECORD_DATE --竣工备案日期
        )
            SELECT
        get_uuid,
        base.PROJECT_ID,--项目ID
        base.PROJECT_NAME,--项目名称
        base.ORG_ID,--所属事业部ID
        base.ORG_NAME,--所属事业部
        base.FIRST_OPEN_DATE,--首开日期
        base.OBTAIN_DATE,--项目获得日期
        base.COMPLETION_RECORD_DATE,--首次竣备日期
        base.TAKE_LAND_DATE,--拿地日期
        base.PLAN_FIRST_OPEN_DATE,--计划首开日期
        base.FIRST_OPEN_DURATION_BY_PLAN,--原计划首开时长(10-9)
        base.FIRST_OPEN_DURATION_BY_TL,--拿地至首开时长(6-9)
        base.NEW_PLAN_FIRST_OPEN_DATE,--最新预计首开日期
        base.EXHIBITION_AREA_OPEN_DATE,--展示区开放日期
        base.EXHIBITION_AREA_OPEN_BY_PLAN,--展示区开放计划日期
        base.PLAN_APPROVAL_DATE,--方案批复日期
        base.PLAN_APPROVAL_DATE_BY_PLAN,--方案批复计划日期
        base.IS_OPERATE,--是否操盘
        base.IS_CONSTRUCTION_BEGAN,--是否已开工
        CASE
                WHEN FIRST_OPEN.id is not null THEN
                    1
                ELSE
                    0
        END     AS is_FIRST_OPEN,--是否已上关键节点计划 
        base.CREATED,--创建日期
        dwm_REMARK,--备注信息
        base.COMPLETION_ON_RECORD_DATE ---竣工备案日期
    FROM tmp_proj_base base
    left join (SELECT ps.id,ps.project_id
    FROM  sys_project_stage  ps
    left join   pom_proj_plan plan  ON ps.id = plan.proj_id  where  ps.IS_FIRST_OPEN_PERIOD=1
    and  plan.approval_status = '已审核'   AND plan.plan_type = '关键节点计划')
    FIRST_OPEN on  base.PROJECT_ID= FIRST_OPEN.project_id 
            WHERE
                base.id = spid;
    commit;
    END IF;
--open proj_base for
--select * from tmp_proj_base;
--open proj_plan for
--select a.*,p.project_name from (
--select project_id,project_date_type,count(*) from tmp_proj_related_date group by project_id,project_date_type
--order by count(*)) a left join sys_project p on a.project_id=p.id
--where a.project_id='b425a08a-9b71-4ab3-801c-48746ac2e2dd';

    proj_base_spid := spid;
END P_DWM_SALE_RATE_PROJ;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_SALERATEDETAILPROJECT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_SALERATEDETAILPROJECT" (projectId in varchar2,projectName out varchar2,obtainDate out varchar2,firstOpenDate out varchar2,orgName out varchar2)
AS 
begin
execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd''';
select PROJECT_NAME,to_char(OBTAIN_DATE,'yyyy-mm-dd'),to_char(FIRST_OPEN_DATE,'yyyy-mm-dd'),ORG_NAME into projectName,obtainDate,firstOpenDate,orgName  from DWM_SALE_RATE_PROJECT where PROJECT_ID=projectId;
END P_DWM_SaleRateDetailProject;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_SR_BASE_CONFIG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_SR_BASE_CONFIG" (
FM OUT sys_refcursor,
FOHY OUT sys_refcursor,
CR OUT sys_refcursor,
CROY OUT sys_refcursor,
tabitems OUT sys_refcursor,
DataListCounts OUT sys_refcursor
)
AS
fm_1abstract varchar2(4000);
fm_2abstract varchar2(4000);
fohy_1abstract varchar2(4000);
fohy_2abstract varchar2(4000);
cr_1abstract varchar2(4000);
cr_2abstract varchar2(4000);
croy_1abstract varchar2(4000);
croy_2abstract varchar2(4000);

fmDataListCount number;
fohyDataListCount number;
crDataListCount number;
croyDataListCount  number;

begin
SELECT details into fm_1abstract FROM dwm_sale_rate_data_briefing where CODE='fm.1' and rownum=1;
SELECT details into fm_2abstract FROM dwm_sale_rate_data_briefing where CODE='fm.2' and rownum=1;
SELECT details into fohy_1abstract FROM dwm_sale_rate_data_briefing where CODE='fohy.1' and rownum=1;
SELECT details into fohy_2abstract FROM dwm_sale_rate_data_briefing where CODE='fohy.2' and rownum=1;
SELECT details into cr_1abstract  FROM dwm_sale_rate_data_briefing where CODE='cr.1' and rownum=1;
SELECT details into cr_2abstract  FROM dwm_sale_rate_data_briefing where CODE='cr.2' and rownum=1;
SELECT details into croy_1abstract  FROM dwm_sale_rate_data_briefing where CODE='croy.1' and rownum=1;
SELECT details into croy_2abstract  FROM dwm_sale_rate_data_briefing where CODE='croy.2' and rownum=1;

-- 2020/12/14 调整，首月去化率列表获取所有本年已经首开的项目，不判断首月去化率的值是否为空！
--首开半年、竣工备案、竣工备案一年列表需判断对应去化率值是否为空，原型摘要标注“达到”关键字。
select count(1) into fmDataListCount from DWM_SALE_RATE_PROJECT p left join  dwm_sale_rate_by_project fo on fo.project_id=p.project_id where  p.PROJECT_NAME is not null and to_number(to_char(p.FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'));
--2020/12/17 调整，首开半年去化率 取“本年首开达到半年”的项目，取本年首开的
--首开日期年份=系统当前年份
--首开日期+180天<= 当前系统时间（去掉）
select count(1) into fohyDataListCount from DWM_SALE_RATE_PROJECT p left join  dwm_sale_rate_by_project fo on fo.project_id=p.project_id where  p.PROJECT_NAME is not null and to_char(sysdate,'yyyy')=to_char(p.FIRST_OPEN_DATE,'yyyy');
-----竣工备案取“本年”达到的项目 年份获取当前年份
select count(1) into crDataListCount from DWM_SALE_RATE_PROJECT p left join  dwm_sale_rate_by_project fo on fo.project_id=p.project_id where  p.PROJECT_NAME is not null and to_number(to_char(p.COMPLETION_ON_RECORD_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'));
--竣工备案后一年，调整：竣工备案一年，取达到一年数据，当前系统日期 >= 竣工备案日期+360  2020/12/21
select count(1) into croyDataListCount from DWM_SALE_RATE_PROJECT p left join  dwm_sale_rate_by_project fo on fo.project_id=p.project_id where to_number(to_char(p.COMPLETION_ON_RECORD_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) and p.PROJECT_NAME is not null;
-------需要排序的字段
open FM for
SELECT COLUMN_VALUE as "fieldName" FROM table (split ('firstOpenDate,fmSaleOutCount,foSaleCount,fmSaleRateByCount,fmSaleOutArea,foSaleArea,fmSaleRateByArea,fmSaleOutMoney,foSaleMoney,fmSaleRateByMoney'));

open FOHY for
SELECT COLUMN_VALUE as "fieldName" FROM table (split ('firstOpenDate,fohySaleOutCount,fohySaleCount,fohySaleRateByCount,fohySaleOutArea,fohySaleArea,fohySaleRateByArea,fohySaleOutMoney,fohySaleMoney,fohySaleRateByMoney'));

open CR for
SELECT COLUMN_VALUE as "fieldName" FROM table (split ('completionOnRecordDate,crSaleOutCount,crSaleCount,crSaleRateByCount,crSaleOutArea,crSaleArea,crSaleRateByArea,crSaleOutMoney,crSaleMoney,crSaleRateByMoney'));

open CROY for
SELECT COLUMN_VALUE as "fieldName" FROM table (split ('completionOnRecordDate,croySaleOutCount,croySaleCount,croySaleRateByCount,croySaleOutArea,croySaleArea,croySaleRateByArea,croySaleOutMoney,croySaleMoney,croySaleRateByMoney'));

open DataListCounts for
select * from (SELECT 
'FM' as "code",
fmDataListCount as "listCount"
from dual
UNION
select
'FOHY' as "code",
fohyDataListCount as "listCount"
from dual
UNION
select
'CR' as "code",
crDataListCount as "listCount"
from dual
UNION
select
'CROY' as "code",
croyDataListCount as "listCount"
from dual
) tab order by  tab."listCount";

open tabItems for
select * from (SELECT 
'1、本年首月项目去化率排行' as  "title",
fm_1abstract as  "abstract",
'FM' as "code",
11 as "sortNum"
from dual
UNION
select
'2、首月去化率变动趋势图' as  "title",
fm_2abstract as  "abstract",
'FM' as "code",
12 as "sortNum"
from dual
UNION
select
'1、本年首开半年去化率排行' as  "title",
fohy_1abstract as  "abstract",
'FOHY' as "code",
11 as "sortNum"
from dual
UNION
select
'2、首开半年去化率变动趋势' as  "title",
fohy_2abstract as  "abstract",
'FOHY' as "code",
12 as "sortNum"
from dual
UNION
select
'1、本年竣工备案去化率排行' as  "title",
cr_1abstract as  "abstract",
'CR' as "code",
11 as "sortNum"
from dual
UNION
select
'2、竣工备案去化率变动趋势' as  "title",
cr_2abstract as  "abstract",
'CR' as "code",
12 as "sortNum"
from dual
UNION
select
'1、本年竣备一年去化率排行' as  "title",
croy_1abstract as  "abstract",
'CROY' as "code",
11 as "sortNum"
from dual
UNION
select
'2、竣备一年去化率变动趋势' as  "title",
croy_2abstract as  "abstract",
'CROY' as "code",
12 as "sortNum"
from dual) tab order by  tab."sortNum";
END P_DWM_SR_BASE_CONFIG;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_SR_CR
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_SR_CR" 
(
rowNum number
,sortField varchar2 default 'crSaleRateByMoney'
,orderBy varchar2 default 'desc'
,crDataList OUT sys_refcursor
)
AS  
-- Author:吴洋  Date:2020/12/03  竣工备案去化率排行列表
v_sql clob :='';
whereStr varchar2(500):='';
-- 用于返回筛选的列
v_column clob :='';
-- 用于解决排序字段有span标签问题
sortStr varchar2(100):='';
begin
sortStr := sortField;
  if sortStr = 'completionOnRecordDate' then
    sortStr := 'COMPLETION_ON_RECORD_DATE';
  elsif sortStr = 'crSaleRateByMoney' then
    sortStr := 'cr_sale_rate_by_money';
  elsif sortStr = 'crSaleMoney' then
    sortStr := 'cr_sale_money'; 
  elsif sortStr = 'crSaleOutMoney' then
    sortStr := 'cr_sale_out_money';
  elsif sortStr = 'crSaleRateByCount' then
    sortStr := 'cr_sale_rate_by_count';
  elsif sortStr = 'crSaleCount' then
    sortStr := 'cr_sale_count';
  elsif sortStr = 'crSaleOutCount' then
    sortStr := 'cr_sale_out_count';
  elsif sortStr = 'crSaleRateByArea' then
    sortStr := 'cr_sale_rate_by_area';
  elsif sortStr = 'crSaleArea' then
    sortStr := 'cr_sale_area';
  elsif sortStr = 'crSaleOutArea' then
    sortStr := 'cr_sale_out_area';
  elsif sortStr = 'projectName' then
    sortStr := 'projectNameCopy';  
  end if;
--execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd''';
v_sql:='
SELECT
    p.COMPLETION_ON_RECORD_DATE as "COMPLETION_ON_RECORD_DATE",
    NVL(fo.cr_sale_rate_by_money,0) as "cr_sale_rate_by_money",
    NVL(fo.cr_sale_money,0) as "cr_sale_money",
    NVL(fo.cr_sale_out_money,0) as "cr_sale_out_money",
    NVL(fo.cr_sale_rate_by_count,0) as "cr_sale_rate_by_count",
    NVL(fo.cr_sale_count,0) as "cr_sale_count",
    NVL(fo.cr_sale_out_count,0) as "cr_sale_out_count",
    NVL(fo.cr_sale_rate_by_area,0) as "cr_sale_rate_by_area",
    NVL(fo.cr_sale_area,0) as "cr_sale_area",
    NVL(fo.cr_sale_out_area,0) as "cr_sale_out_area",

    p.PROJECT_NAME as "projectNameCopy",
    case when fo.cr_sale_rate_by_money is not null then
    fn_ConvertDecimalToPercentage(fo.cr_sale_rate_by_money) else ''0%'' end as "crSaleRateByMoneyCopy",
    case when fo.cr_sale_rate_by_count is not null then
    fn_ConvertDecimalToPercentage(fo.cr_sale_rate_by_count) else ''0%'' end as "crSaleRateByCountCopy",
    case when fo.cr_sale_rate_by_area is not null then
    fn_ConvertDecimalToPercentage(fo.cr_sale_rate_by_area) else ''0%'' end as "crSaleRateByAreaCopy",

    p.project_id as "projectId",
    FN_DWM_FONT_COLOR(p.PROJECT_NAME) as "projectName",
    to_char(p.COMPLETION_ON_RECORD_DATE,''yyyy-mm-dd'')  as "completionOnRecordDate",
    case when fo.cr_sale_rate_by_money is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo.cr_sale_rate_by_money)) else FN_DWM_FONT_COLOR(''0%'') end as "crSaleRateByMoney",
    FN_DWM_MULTIPLE_AND_UNIT(fo.cr_sale_money, 100000000, ''亿'') as "crSaleMoney",
    FN_DWM_MULTIPLE_AND_UNIT(fo.cr_sale_out_money, 100000000, ''亿'') as "crSaleOutMoney",
    case when fo.cr_sale_rate_by_count is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo.cr_sale_rate_by_count)) else FN_DWM_FONT_COLOR(''0%'') end as "crSaleRateByCount",
    case when fo.cr_sale_count is not null then
    fo.cr_sale_count || ''套'' else ''0套'' end as "crSaleCount",
    case when fo.cr_sale_out_count is not null then
    fo.cr_sale_out_count || ''套'' else ''0套'' end  as "crSaleOutCount",
    case when fo.cr_sale_rate_by_area is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo.cr_sale_rate_by_area)) else FN_DWM_FONT_COLOR(''0%'') end as "crSaleRateByArea",
    FN_DWM_MULTIPLE_AND_UNIT(fo.cr_sale_area, 10000, ''万方'') as "crSaleArea",
    FN_DWM_MULTIPLE_AND_UNIT(fo.cr_sale_out_area, 10000, ''万方'') as "crSaleOutArea"
FROM
    dwm_sale_rate_by_project fo right join 
    DWM_SALE_RATE_PROJECT p on fo.project_id=p.project_id  
    where p.PROJECT_NAME is not null and TO_DATE(trunc(sysdate,''yyyy'')) <= p.COMPLETION_ON_RECORD_DATE and fo.cr_sale_out_money is not null and fo.cr_sale_out_count is not null';
v_column := ' "projectId",
      "projectName",
      "completionOnRecordDate",
      "crSaleRateByMoney",
      "crSaleMoney",
      "crSaleOutMoney",
      "crSaleRateByCount",
      "crSaleCount",
      "crSaleOutCount",
      "crSaleRateByArea",
      "crSaleArea",
      "crSaleOutArea",

      "projectNameCopy",
      "crSaleRateByMoneyCopy",
      "crSaleRateByCountCopy",
      "crSaleRateByAreaCopy"';    
--    if rowNum <> 0 then
--    whereStr:='where rownum<= ' || rowNum;
--    end if;
    if sortStr is not null and orderBy is not null then
        whereStr:=whereStr||' order by tab."'||sortStr|| '"  '||orderBy || ' nulls last ';
    end if;
    if whereStr is not null then
        v_sql:='select ' || v_column || ' from ('||v_sql||') tab '||whereStr;
    else
        v_sql:='select ' || v_column || ' from (' ||v_sql || ' )';
    end if;
    -- 选择前n条数据，rownum必须拼接在排序后面，不然会先运行rownum再运行排序，会导致筛选数据并不准确
    if rowNum <> 0 then
        v_sql := 'select ' || v_column || ' from (' ||v_sql || ' )' || ' where rownum <= ' || rowNum;
    end if; 
    dbms_output.put_line(v_sql);
OPEN crDataList FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE crDataList;
END P_DWM_SR_CR;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_SR_CROY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_SR_CROY" 
(
rowNum number
,sortField varchar2 default 'croySaleRateByMoney'
,orderBy varchar2 default 'desc'
,croyDataList OUT sys_refcursor
)
AS  
-- Author:吴洋  Date:2020/12/03  竣工备案后一年去化率排行列表
v_sql clob :='';
whereStr varchar2(500):='';
-- 用于返回筛选的列
v_column clob :='';
-- 用于解决排序字段有span标签问题
sortStr varchar2(100):='';
begin
sortStr := sortField;
  if sortStr = 'completionOnRecordDate' then
    sortStr := 'COMPLETION_ON_RECORD_DATE';
  elsif sortStr = 'croySaleRateByMoney' then
    sortStr := 'croy_sale_rate_by_money';
  elsif sortStr = 'croySaleMoney' then
    sortStr := 'croy_sale_money'; 
  elsif sortStr = 'croySaleOutMoney' then
    sortStr := 'croy_sale_out_money';
  elsif sortStr = 'croySaleRateByCount' then
    sortStr := 'croy_sale_rate_by_count';
  elsif sortStr = 'croySaleCount' then
    sortStr := 'croy_sale_count';
  elsif sortStr = 'croySaleOutCount' then
    sortStr := 'croy_sale_out_count';
  elsif sortStr = 'croySaleRateByArea' then
    sortStr := 'croy_sale_rate_by_area';
  elsif sortStr = 'croySaleArea' then
    sortStr := 'croy_sale_area';
  elsif sortStr = 'croySaleOutArea' then
    sortStr := 'croy_sale_out_area';
  elsif sortStr = 'projectName' then
    sortStr := 'projectNameCopy';  
  end if;
--execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd''';
v_sql:='
SELECT
    p.COMPLETION_ON_RECORD_DATE as "COMPLETION_ON_RECORD_DATE",
    NVL(fo.croy_sale_rate_by_money,0) as "croy_sale_rate_by_money",
    NVL(fo.croy_sale_money,0) as "croy_sale_money",
    NVL(fo.croy_sale_out_money,0) as "croy_sale_out_money",
    NVL(fo.croy_sale_rate_by_count,0) as "croy_sale_rate_by_count",
    NVL(fo.croy_sale_count,0) as "croy_sale_count",
    NVL(fo.croy_sale_out_count,0) as "croy_sale_out_count",
    NVL(fo.croy_sale_rate_by_area,0) as "croy_sale_rate_by_area",
    NVL(fo.croy_sale_area,0) as "croy_sale_area",
    NVL(fo.croy_sale_out_area,0) as "croy_sale_out_area",

    p.PROJECT_NAME as "projectNameCopy",
    case when fo.croy_sale_rate_by_money is not null then
    fn_ConvertDecimalToPercentage(fo.croy_sale_rate_by_money) else ''0%'' end as "croySaleRateByMoneyCopy",
    case when fo.croy_sale_rate_by_count is not null then
    fn_ConvertDecimalToPercentage(fo.croy_sale_rate_by_count) else ''0%'' end as "croySaleRateByCountCopy",
    case when fo.croy_sale_rate_by_area is not null then
    fn_ConvertDecimalToPercentage(fo.croy_sale_rate_by_area) else ''0%'' end as "croySaleRateByAreaCopy",

    p.project_id as "projectId",
    FN_DWM_FONT_COLOR(p.PROJECT_NAME) as "projectName",
    to_char(p.COMPLETION_ON_RECORD_DATE,''yyyy-mm-dd'')  as "completionOnRecordDate",
    case when fo.croy_sale_rate_by_money is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo.croy_sale_rate_by_money)) else FN_DWM_FONT_COLOR(''0%'') end as "croySaleRateByMoney",
    FN_DWM_MULTIPLE_AND_UNIT(fo.croy_sale_money, 100000000, ''亿'') as "croySaleMoney",
    FN_DWM_MULTIPLE_AND_UNIT(fo.croy_sale_out_money, 100000000, ''亿'') as "croySaleOutMoney",
    case when fo.croy_sale_rate_by_count is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo.croy_sale_rate_by_count)) else FN_DWM_FONT_COLOR(''0%'') end as "croySaleRateByCount",
    case when fo.croy_sale_count is not null then
    fo.croy_sale_count || ''套'' else ''0套'' end as "croySaleCount",
    case when fo.croy_sale_out_count is not null then
    fo.croy_sale_out_count || ''套'' else ''0套'' end  as "croySaleOutCount",
    case when fo.croy_sale_rate_by_area is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo.croy_sale_rate_by_area)) else FN_DWM_FONT_COLOR(''0%'') end as "croySaleRateByArea",
    FN_DWM_MULTIPLE_AND_UNIT(fo.croy_sale_area, 10000, ''万方'') as "croySaleArea",
    FN_DWM_MULTIPLE_AND_UNIT(fo.croy_sale_out_area, 10000, ''万方'') as "croySaleOutArea"
FROM
    dwm_sale_rate_by_project fo right join 
    DWM_SALE_RATE_PROJECT p on fo.project_id=p.project_id  
    where p.PROJECT_NAME is not null and TO_DATE(trunc(sysdate,''yyyy'')) <= p.COMPLETION_ON_RECORD_DATE and fo.croy_sale_out_money is not null and fo.croy_sale_out_count is not null';
--    2020/12/21 竣工备案后一年，条件，当前系统日期年份 = 竣工备案日期
-- trunc(sysdate,'yyyy') 取本年第一天
v_column := ' "projectId",
      "projectName",
      "completionOnRecordDate",
      "croySaleRateByMoney",
      "croySaleMoney",
      "croySaleOutMoney",
      "croySaleRateByCount",
      "croySaleCount",
      "croySaleOutCount",
      "croySaleRateByArea",
      "croySaleArea",
      "croySaleOutArea",

      "projectNameCopy",
      "croySaleRateByMoneyCopy",
      "croySaleRateByCountCopy",
      "croySaleRateByAreaCopy"';    
--    if rowNum <> 0 then
--    whereStr:='where rownum<= ' || rowNum;
--    end if;
    if sortStr is not null and orderBy is not null then
        whereStr:=whereStr||' order by tab."'||sortStr|| '"  '||orderBy || ' nulls last ';
    end if;
    if whereStr is not null then
        v_sql:='select ' || v_column || ' from ('||v_sql||') tab '||whereStr;
    else
        v_sql:='select ' || v_column || ' from (' ||v_sql || ' )';
    end if;
    -- 选择前n条数据，rownum必须拼接在排序后面，不然会先运行rownum再运行排序，会导致筛选数据并不准确
    if rowNum <> 0 then
        v_sql := 'select ' || v_column || ' from (' ||v_sql || ' )' || ' where rownum <= ' || rowNum;
    end if; 
    dbms_output.put_line(v_sql);
OPEN croyDataList FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE croyDataList;
END P_DWM_SR_CROY;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_SR_DETAILRING_CHART
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_SR_DETAILRING_CHART" (
    projectid         IN    VARCHAR2,
    tabname           IN    VARCHAR2,
    ringtitle         OUT   CLOB,
    seriesdataname    OUT   VARCHAR2,
    saleratebycount   OUT   SYS_REFCURSOR,
    saleratebyarea    OUT   SYS_REFCURSOR,
    saleratebymoney   OUT   SYS_REFCURSOR
) AS
-- Author:吴洋
-- Date:2020/11/26
--FM (First Month): 首月
--FOHY(First Open Half Year):首开半年
--CR(Completed Record):竣工备案
--CROY(Completed Record One Year):竣工备案后一年

    sale_out_count       NUMBER(16, 0) := 0;
    sale_count           NUMBER(16, 0) := 0;
    sale_rate_by_count   NUMBER(16, 4) := 0;
    sale_out_area        NUMBER(16, 2) := 0;
    sale_area            NUMBER(16, 2) := 0;
    sale_rate_by_area    NUMBER(16, 4) := 0;
    sale_out_money       NUMBER(16, 2) := 0;
    sale_money           NUMBER(16, 2) := 0;
    sale_rate_by_money   NUMBER(16, 4) := 0;
    surplus_sale_money   NUMBER(16, 2) := 0;
    typename             VARCHAR2(500) := '';
    chartname            VARCHAR2(500) := '';
    rowcount             NUMBER := 0;
BEGIN
    SELECT
        COUNT(1)
    INTO rowcount
    FROM
        dwm_sale_rate_by_project
    WHERE
        project_id = projectid;

    IF tabname = 'FM' THEN
        ringtitle := '<span style="font-weight: bold;color: #333;">一、首月去化率(%)</span><span style="color: #333;margin-left:10px;">注：首月去化率的统计时间区间默认为“首次开盘后30天”。</span>'
        ;
        typename := '首月';
        chartname := '供货';
    ELSIF tabname = 'FOHY' THEN
        ringtitle := '<span style="font-weight: bold;color: #333;">一、首开半年去化率(%)</span><span style="color: #333;margin-left:10px;">注：首开半年去化率的统计时间区间为“首次开盘后180天”。</span>';
        typename := '首开半年';
        chartname := '供货';
    ELSIF tabname = 'CR' THEN
        ringtitle := '<span style="font-weight: bold;color: #333;">一、竣工备案去化率(%) </span><span style="color: #333;margin-left:10px;">注：统计时间区间为 “截止竣工备案当天”。</span>';
        typename := '竣工备案';
        chartname := '供货';
    ELSIF tabname = 'CROY' THEN
        ringtitle := '<span style="font-weight: bold;color: #333;">一、竣工备案后一年去化率(%) </span><span style="color: #333;margin-left:10px;">注：统计时间区间为 “截止竣工备案后1年”。</span>';
        typename := '竣备一年后';
        chartname := '供货';
    END IF;

    IF tabname = 'FM' AND rowcount <> 0 THEN
        SELECT
            fm_sale_out_count,
            fo_sale_count,
            fm_sale_rate_by_count,
            fm_sale_out_area,
            fo_sale_area,
            fm_sale_rate_by_area,
            fm_sale_out_money,
            fo_sale_money,
            fm_sale_rate_by_money,
            fm_surplus_sale_money
        INTO
            sale_out_count,
            sale_count,
            sale_rate_by_count,
            sale_out_area,
            sale_area,
            sale_rate_by_area,
            sale_out_money,
            sale_money,
            sale_rate_by_money,
            surplus_sale_money
        FROM
            dwm_sale_rate_by_project
        WHERE
            project_id = projectid
            AND ROWNUM = 1;

    ELSIF tabname = 'FOHY' AND rowcount <> 0 THEN
        SELECT
            fohy_sale_out_count,
            fohy_sale_count,
            fohy_sale_rate_by_count,
            fohy_sale_out_area,
            fohy_sale_area,
            fohy_sale_rate_by_area,
            fohy_sale_out_money,
            fohy_sale_money,
            fohy_sale_rate_by_money,
            fohy_surplus_sale_money
        INTO
            sale_out_count,
            sale_count,
            sale_rate_by_count,
            sale_out_area,
            sale_area,
            sale_rate_by_area,
            sale_out_money,
            sale_money,
            sale_rate_by_money,
            surplus_sale_money
        FROM
            dwm_sale_rate_by_project
        WHERE
            project_id = projectid
            AND ROWNUM = 1;

    ELSIF tabname = 'CR' AND rowcount <> 0 THEN
        SELECT
            cr_sale_out_count,
            cr_sale_count,
            cr_sale_rate_by_count,
            cr_sale_out_area,
            cr_sale_area,
            cr_sale_rate_by_area,
            cr_sale_out_money,
            cr_sale_money,
            cr_sale_rate_by_money,
            cr_surplus_sale_money
        INTO
            sale_out_count,
            sale_count,
            sale_rate_by_count,
            sale_out_area,
            sale_area,
            sale_rate_by_area,
            sale_out_money,
            sale_money,
            sale_rate_by_money,
            surplus_sale_money
        FROM
            dwm_sale_rate_by_project
        WHERE
            project_id = projectid
            AND ROWNUM = 1;

    ELSIF tabname = 'CROY' AND rowcount <> 0 THEN
        SELECT
            croy_sale_out_count,
            croy_sale_count,
            croy_sale_rate_by_count,
            croy_sale_out_area,
            croy_sale_area,
            croy_sale_rate_by_area,
            croy_sale_out_money,
            croy_sale_money,
            croy_sale_rate_by_money,
            croy_surplus_sale_money
        INTO
            sale_out_count,
            sale_count,
            sale_rate_by_count,
            sale_out_area,
            sale_area,
            sale_rate_by_area,
            sale_out_money,
            sale_money,
            sale_rate_by_money,
            surplus_sale_money
        FROM
            dwm_sale_rate_by_project
        WHERE
            project_id = projectid
            AND ROWNUM = 1;

    END IF;

    seriesdataname := '已签约,未签约';
    OPEN saleratebycount FOR SELECT
                                 typename || '去化率（按套数）' AS "chartTitle",
                                 '' AS "chartDescription",
                                 fn_ConvertDecimalToPercentage(sale_rate_by_count) AS "centerTitle",
                                 chartname
                                 || fn_tochar(sale_count)
                                 || '套' AS "centerDescription",
--                                 解决 NULL 值，不返回，导致前端不显示环形图问题。
                                 fn_tochar(sale_out_count)
                                 || ','
                                 || fn_tochar(sale_count - sale_out_count) AS "seriesdata",
                                 '套' "unit",
                                 1 AS sort
                             FROM
                                 dual;

    OPEN saleratebymoney FOR SELECT
                                typename || '去化率（按货值）' AS "chartTitle",
                                '（货值单位：亿）' AS "chartDescription",
                                fn_ConvertDecimalToPercentage(sale_rate_by_money) AS "centerTitle",
                                chartname || fn_dwn_amounttobillionyuan(sale_money) AS "centerDescription",
                                fn_dwm_multiple_and_unit(sale_out_money, 100000000, '')
                                || ','
                                || fn_dwm_multiple_and_unit(surplus_sale_money, 100000000, '') AS "seriesdata",
                                '亿' "unit",
                                2 AS sort
                            FROM
                                dual;

    OPEN saleratebyarea FOR SELECT
                               typename || '去化率（按面积）' AS "chartTitle",
                               '（面积单位：万方）' AS "chartDescription",
                               fn_ConvertDecimalToPercentage(sale_rate_by_area) AS "centerTitle",
                               chartname || fn_dwn_areato1000square(sale_area) AS "centerDescription",
                               fn_dwm_multiple_and_unit(sale_out_area, 10000, '')
                               || ','
                               || fn_dwm_multiple_and_unit(trunc(sale_area - sale_out_area, 2), 10000, '') AS "seriesdata",
                               '万方' "unit",
                               3 AS sort
                           FROM
                               dual;

EXCEPTION
    WHEN OTHERS THEN
        CLOSE saleratebyarea;
        CLOSE saleratebycount;
        CLOSE saleratebymoney;
END p_dwm_sr_detailring_chart;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_SR_FM
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_SR_FM" 
(
rowNum number
,sortField varchar2 default 'fmSaleRateByMoney'
,orderBy varchar2 default 'desc'
,fmDataList OUT sys_refcursor
)
AS  
-- Author:吴洋  Date:2020/12/01  首月去化率排行列表
--2020/12/9  变更：
--1、默认排序字段为首开日期，降序排序
--2、首月推售变更为首开推售
v_sql clob :='';
whereStr varchar2(500):='';
-- 用于返回筛选的列
v_column clob :='';
-- 用于解决排序字段有span标签问题
sortStr varchar2(100):='';
begin
sortStr := sortField;
  if sortStr = 'firstOpenDate' then
    sortStr := 'FIRST_OPEN_DATE';
  elsif sortStr = 'fmSaleRateByMoney' then
    sortStr := 'fm_sale_rate_by_money';
  elsif sortStr = 'foSaleMoney' then 
    sortStr := 'fo_sale_money'; 
  elsif sortStr = 'fmSaleOutMoney' then
    sortStr := 'fm_sale_out_money';
  elsif sortStr = 'fmSaleRateByCount' then
    sortStr := 'fm_sale_rate_by_count';
  elsif sortStr = 'foSaleCount' then
    sortStr := 'fo_sale_count';
  elsif sortStr = 'fmSaleOutCount' then
    sortStr := 'fm_sale_out_count';
  elsif sortStr = 'fmSaleRateByArea' then
    sortStr := 'fm_sale_rate_by_area';
  elsif sortStr = 'foSaleArea' then
    sortStr := 'fo_sale_area';
  elsif sortStr = 'fmSaleOutArea' then
    sortStr := 'fm_sale_out_area';
  elsif sortStr = 'projectName' then
    sortStr := 'projectNameCopy';  
  end if;
--execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd''';
v_sql:='
SELECT
    p.FIRST_OPEN_DATE as "FIRST_OPEN_DATE",
    NVL(fo.fm_sale_rate_by_money,0) as "fm_sale_rate_by_money",
    NVL(fo.fo_sale_money,0) as "fo_sale_money",
    NVL(fo.fm_sale_out_money,0) as "fm_sale_out_money",
    NVL(fo.fm_sale_rate_by_count,0) as "fm_sale_rate_by_count",
    NVL(fo.fo_sale_count,0) as "fo_sale_count",
    NVL(fo.fm_sale_out_count,0) as "fm_sale_out_count",
    NVL(fo.fm_sale_rate_by_area,0) as "fm_sale_rate_by_area",
    NVL(fo.fo_sale_area,0) as "fo_sale_area",
    NVL(fo.fm_sale_out_area,0) as "fm_sale_out_area",

    p.PROJECT_NAME as "projectNameCopy",
    case when fo.fm_sale_rate_by_money is not null then
    fn_ConvertDecimalToPercentage(fo.fm_sale_rate_by_money) else ''0%'' end as "fmSaleRateByMoneyCopy",
    case when fo.fm_sale_rate_by_count is not null then
    fn_ConvertDecimalToPercentage(fo.fm_sale_rate_by_count) else ''0%'' end as "fmSaleRateByCountCopy",
    case when fo.fm_sale_rate_by_area is not null then
    fn_ConvertDecimalToPercentage(fo.fm_sale_rate_by_area) else ''0%'' end as "fmSaleRateByAreaCopy",

    p.project_id as "projectId",
    FN_DWM_FONT_COLOR(p.PROJECT_NAME) as "projectName",
    to_char(p.FIRST_OPEN_DATE,''yyyy-mm-dd'')  as "firstOpenDate",
    case when fo.fm_sale_rate_by_money is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo.fm_sale_rate_by_money)) else FN_DWM_FONT_COLOR(''0%'') end as "fmSaleRateByMoney",
    FN_DWM_MULTIPLE_AND_UNIT(fo.fo_sale_money, 100000000, ''亿'') as "foSaleMoney",
    FN_DWM_MULTIPLE_AND_UNIT(fo.fm_sale_out_money, 100000000, ''亿'') as "fmSaleOutMoney",
    case when fo.fm_sale_rate_by_count is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo.fm_sale_rate_by_count)) else FN_DWM_FONT_COLOR(''0%'') end as "fmSaleRateByCount",
    case when fo.fo_sale_count is not null then
    fo.fo_sale_count || ''套'' else ''0套'' end as "foSaleCount",
    case when fo.fm_sale_out_count is not null then
    fo.fm_sale_out_count || ''套'' else ''0套'' end  as "fmSaleOutCount",
    case when fo.fm_sale_rate_by_area is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo.fm_sale_rate_by_area)) else FN_DWM_FONT_COLOR(''0%'') end as "fmSaleRateByArea",
    FN_DWM_MULTIPLE_AND_UNIT(fo.fo_sale_area, 10000, ''万方'') as "foSaleArea",
    FN_DWM_MULTIPLE_AND_UNIT(fo.fm_sale_out_area, 10000, ''万方'') as "fmSaleOutArea"
FROM
    dwm_sale_rate_by_project fo right join 
    DWM_SALE_RATE_PROJECT p on fo.project_id=p.project_id  
    where p.PROJECT_NAME is not null and TO_DATE(trunc(sysdate,''yyyy'')) <= p.FIRST_OPEN_DATE ';
-- 2020/12/14 调整，首月去化率列表获取所有本年已经首开的项目，不判断首月去化率的值是否为空！
--首开半年、竣工备案、竣工备案一年列表需判断对应去化率值是否为空，原型摘要标注“达到”关键字。
v_column := ' "projectId",
      "projectName",
      "firstOpenDate",
      "fmSaleRateByMoney",
      "foSaleMoney",
      "fmSaleOutMoney",
      "fmSaleRateByCount",
      "foSaleCount",
      "fmSaleOutCount",
      "fmSaleRateByArea",
      "foSaleArea",
      "fmSaleOutArea",

      "projectNameCopy",
      "fmSaleRateByMoneyCopy",
      "fmSaleRateByCountCopy",
      "fmSaleRateByAreaCopy"';    
--    if rowNum <> 0 then
--    whereStr:='where rownum<= ' || rowNum;
--    end if;
    if sortStr is not null and orderBy is not null then
        whereStr:=whereStr||' order by tab."'||sortStr|| '"  '||orderBy || ' nulls last ';
    end if;
    if whereStr is not null then
        v_sql:='select ' || v_column || ' from ('||v_sql||') tab '||whereStr;
    else
        v_sql:='select ' || v_column || ' from (' ||v_sql || ' )';
    end if;
    -- 选择前n条数据，rownum必须拼接在排序后面，不然会先运行rownum再运行排序，会导致筛选数据并不准确
    if rowNum <> 0 then
        v_sql := 'select ' || v_column || ' from (' ||v_sql || ' )' || ' where rownum <= ' || rowNum;
    end if; 
    dbms_output.put_line(v_sql);
OPEN fmDataList FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE fmDataList;
END P_DWM_SR_FM;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_SR_FOHY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_SR_FOHY" 
(
rowNum number
,sortField varchar2 default 'fohySaleRateByMoney'
,orderBy varchar2 default 'desc'
,fohyDataList OUT sys_refcursor
)
AS  
-- Author:吴洋  Date:2020/12/02  首开半年去化率排行列表
--2020/12/17 调整，首开半年去化率 取“本年首开达到半年”的项目，取本年首开的
--首开日期年份=系统当前年份
v_sql clob :='';
whereStr varchar2(500):='';
-- 用于返回筛选的列
v_column clob :='';
-- 用于解决排序字段有span标签问题
sortStr varchar2(100):='';
begin
sortStr := sortField;
  if sortStr = 'firstOpenDate' then
    sortStr := 'FIRST_OPEN_DATE';
  elsif sortStr = 'fohySaleRateByMoney' then
    sortStr := 'fohy_sale_rate_by_money';
  elsif sortStr = 'fohySaleMoney' then
    sortStr := 'fohy_sale_money'; 
  elsif sortStr = 'fohySaleOutMoney' then
    sortStr := 'fohy_sale_out_money';
  elsif sortStr = 'fohySaleRateByCount' then
    sortStr := 'fohy_sale_rate_by_count';
  elsif sortStr = 'fohySaleCount' then
    sortStr := 'fohy_sale_count';
  elsif sortStr = 'fohySaleOutCount' then
    sortStr := 'fohy_sale_out_count';
  elsif sortStr = 'fohySaleRateByArea' then
    sortStr := 'fohy_sale_rate_by_area';
  elsif sortStr = 'fohySaleArea' then
    sortStr := 'fohy_sale_area';
  elsif sortStr = 'fohySaleOutArea' then
    sortStr := 'fohy_sale_out_area';
  elsif sortStr = 'projectName' then
    sortStr := 'projectNameCopy';  
  end if;
--execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd''';
v_sql:='
SELECT
    p.FIRST_OPEN_DATE as "FIRST_OPEN_DATE",
    NVL(fo.fohy_sale_rate_by_money,0) as "fohy_sale_rate_by_money",
    NVL(fo.fohy_sale_money,0) as "fohy_sale_money",
    NVL(fo.fohy_sale_out_money,0) as "fohy_sale_out_money",
    NVL(fo.fohy_sale_rate_by_count,0) as "fohy_sale_rate_by_count",
    NVL(fo.fohy_sale_count,0) as "fohy_sale_count",
    NVL(fo.fohy_sale_out_count,0) as "fohy_sale_out_count",
    NVL(fo.fohy_sale_rate_by_area,0) as "fohy_sale_rate_by_area",
    NVL(fo.fohy_sale_area,0) as "fohy_sale_area",
    NVL(fo.fohy_sale_out_area,0) as "fohy_sale_out_area",

    p.PROJECT_NAME as "projectNameCopy",
    case when fo.fm_sale_rate_by_money is not null then
    fn_ConvertDecimalToPercentage(fo.fohy_sale_rate_by_money) else ''0%'' end as "fohySaleRateByMoneyCopy",
    case when fo.fohy_sale_rate_by_count is not null then
    fn_ConvertDecimalToPercentage(fo.fohy_sale_rate_by_count) else ''0%'' end as "fohySaleRateByCountCopy",
    case when fo.fohy_sale_rate_by_area is not null then
    fn_ConvertDecimalToPercentage(fo.fohy_sale_rate_by_area) else ''0%'' end as "fohySaleRateByAreaCopy",

    p.project_id as "projectId",
    FN_DWM_FONT_COLOR(p.PROJECT_NAME) as "projectName",
    to_char(p.FIRST_OPEN_DATE,''yyyy-mm-dd'')  as "firstOpenDate",
    case when fo.fohy_sale_rate_by_money is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo.fohy_sale_rate_by_money)) else FN_DWM_FONT_COLOR(''0%'') end as "fohySaleRateByMoney",
    FN_DWM_MULTIPLE_AND_UNIT(fo.fohy_sale_money, 100000000, ''亿'') as "fohySaleMoney",
    FN_DWM_MULTIPLE_AND_UNIT(fo.fohy_sale_out_money, 100000000, ''亿'') as "fohySaleOutMoney",
    case when fo.fohy_sale_rate_by_count is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo.fohy_sale_rate_by_count)) else FN_DWM_FONT_COLOR(''0%'') end as "fohySaleRateByCount",
    case when fo.fohy_sale_count is not null then
    fo.fohy_sale_count || ''套'' else ''0套'' end as "fohySaleCount",
    case when fo.fohy_sale_out_count is not null then
    fo.fohy_sale_out_count || ''套'' else ''0套'' end  as "fohySaleOutCount",
    case when fo.fohy_sale_rate_by_area is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo.fohy_sale_rate_by_area)) else FN_DWM_FONT_COLOR(''0%'') end as "fohySaleRateByArea",
    FN_DWM_MULTIPLE_AND_UNIT(fo.fohy_sale_area, 10000, ''万方'') as "fohySaleArea",
    FN_DWM_MULTIPLE_AND_UNIT(fo.fohy_sale_out_area, 10000, ''万方'') as "fohySaleOutArea"
FROM
    dwm_sale_rate_by_project fo right join 
    DWM_SALE_RATE_PROJECT p on fo.project_id=p.project_id  
    where p.PROJECT_NAME is not null  and to_char(sysdate,''yyyy'')=to_char(p.FIRST_OPEN_DATE,''yyyy'')';
    ----首开半年取本年首开项目
v_column := ' "projectId",
      "projectName",
      "firstOpenDate",
      "fohySaleRateByMoney",
      "fohySaleMoney",
      "fohySaleOutMoney",
      "fohySaleRateByCount",
      "fohySaleCount",
      "fohySaleOutCount",
      "fohySaleRateByArea",
      "fohySaleArea",
      "fohySaleOutArea",

      "projectNameCopy",
      "fohySaleRateByMoneyCopy",
      "fohySaleRateByCountCopy",
      "fohySaleRateByAreaCopy"';    
--    if rowNum <> 0 then
--    whereStr:='where rownum<= ' || rowNum;
--    end if;
    if sortStr is not null and orderBy is not null then
        whereStr:=whereStr||' order by tab."'||sortStr|| '"  '||orderBy || ' nulls last ';
    end if;
    if whereStr is not null then
        v_sql:='select ' || v_column || ' from ('||v_sql||') tab '||whereStr;
    else
        v_sql:='select ' || v_column || ' from (' ||v_sql || ' )';
    end if;
    -- 选择前n条数据，rownum必须拼接在排序后面，不然会先运行rownum再运行排序，会导致筛选数据并不准确
    if rowNum <> 0 then
        v_sql := 'select ' || v_column || ' from (' ||v_sql || ' )' || ' where rownum <= ' || rowNum;
    end if; 
    dbms_output.put_line(v_sql);
OPEN fohyDataList FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE fohyDataList;
END P_DWM_SR_FOHY;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_SR_PROJ_DTL_SALE_RATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_SR_PROJ_DTL_SALE_RATE" (
    projectid           IN    VARCHAR2,
    tabname             IN    VARCHAR2,
    isshowareasection   IN    NUMBER,
    listtitle           OUT   VARCHAR2,
    tabledata           OUT   SYS_REFCURSOR
) AS
    v_sql CLOB := '';
-- 去化率二期，详情页 明细列表  Author:吴洋  Date:2020/11/27
--存储过程 code：detailSaleRatekList
--FM (First Month): 首月 ,推售取首开
--FOHY(First Open Half Year):首开半年
--CR(Completed Record):竣工备案
--CROY(Completed Record One Year):竣工备案后一年
BEGIN
    IF tabname = 'FM' THEN
        listtitle := '<span style="font-weight: bold;color: #333;">二、首月去化明细情况（项目-->业态-->面积段）</span>';
        v_sql := 'SELECT
   dwm_sale_rate_by_project.PROJECT_ID as "id",
   FN_DWM_FONT_COLOR(dwm_sale_rate_project.PROJECT_NAME) as "typeName",
    fm_sale_out_count||''套'' as "saleOutCount",
    fo_sale_count||''套'' as "saleCount",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fm_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(fm_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(fo_sale_area) as "saleArea",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fm_sale_rate_by_area))  as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(fm_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(fo_sale_money) as "saleMoney",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fm_sale_rate_by_money))  as "saleRateByMoney",
    fm_sale_average_money as "standardPrice",
    fm_sale_out_average_money as "signPrice",
    '''' as "parentId",
    0 as "isAreaSection",
    0 as Sort
FROM
    dwm_sale_rate_by_project left join dwm_sale_rate_project on dwm_sale_rate_by_project.PROJECT_ID = dwm_sale_rate_project.PROJECT_ID where  rownum=1 and dwm_sale_rate_by_project.PROJECT_ID='''
                 || projectid
                 || '''
    union 
    SELECT
    id as "id",
    FN_DWM_FONT_COLOR(DATA_GRANULARITY) as "typeName",
    fm_sale_out_count||''套'' as "saleOutCount",
    fo_sale_count||''套'' as "saleCount",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fm_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(fm_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(fo_sale_area) as "saleArea",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fm_sale_rate_by_area))  as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(fm_sale_out_money)  as "saleOutMoney",
   FN_DWN_AmountToBillionYuan( fo_sale_money) as "saleMoney",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fm_sale_rate_by_money))  as "saleRateByMoney",
    fm_sale_average_money as "standardPrice",
    fm_sale_out_average_money as "signPrice",
    case when PARENT_ID is null then PROJECT_ID  else PARENT_ID end as "parentId",
    case when PARENT_ID is null then 0 else 1 end as "isAreaSection",
    Sort
FROM
    DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID='''
                 || projectid
                 || ''' ';
    ELSIF tabname = 'FOHY' THEN
        listtitle := '<span style="font-weight: bold;color: #333;">二、首开半年去化明细情况(项目-->业态-->面积段)</span>';
        v_sql := 'SELECT
   dwm_sale_rate_by_project.PROJECT_ID as "id",
   FN_DWM_FONT_COLOR(dwm_sale_rate_project.PROJECT_NAME) as "typeName",
    fohy_sale_out_count||''套'' as "saleOutCount",
    fohy_sale_count||''套'' as "saleCount",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fohy_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(fohy_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(fohy_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fohy_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(fohy_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(fohy_sale_money) as "saleMoney",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fohy_sale_rate_by_money))  as "saleRateByMoney",
    fohy_sale_average_money as "standardPrice",
    fohy_sale_out_average_money as "signPrice",
    '''' as "parentId",
    0 as "isAreaSection",
    0 as Sort
FROM
    dwm_sale_rate_by_project left join dwm_sale_rate_project on dwm_sale_rate_by_project.PROJECT_ID = dwm_sale_rate_project.PROJECT_ID where  rownum=1 and  dwm_sale_rate_by_project.PROJECT_ID='''
                 || projectid
                 || '''
    union 
    SELECT
    id as "id",
     FN_DWM_FONT_COLOR(DATA_GRANULARITY) as "typeName",
    fohy_sale_out_count||''套'' as "saleOutCount",
    fohy_sale_count||''套'' as "saleCount",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fohy_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(fohy_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(fohy_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fohy_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(fohy_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(fohy_sale_money) as "saleMoney",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fohy_sale_rate_by_money))  as "saleRateByMoney",
    fohy_sale_average_money as "standardPrice",
    fohy_sale_out_average_money as "signPrice",
    case when PARENT_ID is null then PROJECT_ID  else PARENT_ID end as "parentId",
    case when PARENT_ID is null then 0 else 1 end as "isAreaSection",
    sort
FROM
    DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID='''
                 || projectid
                 || ''' ';
    ELSIF tabname = 'CR' THEN
        listtitle := '<span style="font-weight: bold;color: #333;">二、竣工备案去化明细情况(项目-->业态-->面积段)</span>';
        v_sql := 'SELECT
   dwm_sale_rate_by_project.PROJECT_ID as "id",
   FN_DWM_FONT_COLOR(dwm_sale_rate_project.PROJECT_NAME) as "typeName",
    cr_sale_out_count||''套'' as "saleOutCount",
    cr_sale_count||''套'' as "saleCount",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(cr_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(cr_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(cr_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(cr_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(cr_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(cr_sale_money) as "saleMoney",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(cr_sale_rate_by_money))  as "saleRateByMoney",
    cr_sale_average_money as "standardPrice",
    cr_sale_out_average_money as "signPrice",
    '''' as "parentId",
    0 as "isAreaSection",
    0 as sort
FROM
    dwm_sale_rate_by_project left join dwm_sale_rate_project on dwm_sale_rate_by_project.PROJECT_ID = dwm_sale_rate_project.PROJECT_ID where  rownum=1 and  dwm_sale_rate_by_project.PROJECT_ID='''
                 || projectid
                 || '''
    union 
    SELECT
    id as "id",
     FN_DWM_FONT_COLOR(DATA_GRANULARITY) as "typeName",
    cr_sale_out_count||''套'' as "saleOutCount",
    cr_sale_count||''套'' as "saleCount",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(cr_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(cr_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(cr_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(cr_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(cr_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(cr_sale_money) as "saleMoney",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(cr_sale_rate_by_money))  as "saleRateByMoney",
    cr_sale_average_money as "standardPrice",
    cr_sale_out_average_money as "signPrice",
    case when PARENT_ID is null then PROJECT_ID  else PARENT_ID end as "parentId",
    case when PARENT_ID is null then 0 else 1 end as "isAreaSection",
    sort
FROM
    DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID='''
                 || projectid
                 || ''' ';
    ELSIF tabname = 'CROY' THEN
        listtitle := '<span style="font-weight: bold;color: #333;">二、竣备一年后去化明细情况(项目-->业态-->面积段)</span>';
        v_sql := 'SELECT
   dwm_sale_rate_by_project.PROJECT_ID as "id",
   FN_DWM_FONT_COLOR(dwm_sale_rate_project.PROJECT_NAME) as "typeName",
   croy_sale_out_count||''套'' as "saleOutCount",
   croy_sale_count||''套'' as "saleCount",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(croy_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(croy_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(croy_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(croy_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(croy_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(croy_sale_money) as "saleMoney",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(croy_sale_rate_by_money))  as "saleRateByMoney",
    croy_sale_average_money as "standardPrice",
    croy_sale_out_average_money as "signPrice",
    '''' as "parentId",
    0 as "isAreaSection",
    0 as sort
FROM
    dwm_sale_rate_by_project left join dwm_sale_rate_project on dwm_sale_rate_by_project.PROJECT_ID = dwm_sale_rate_project.PROJECT_ID where  rownum=1 and  dwm_sale_rate_by_project.PROJECT_ID='''
                 || projectid
                 || '''
    union 
    SELECT
    id as "id",
    FN_DWM_FONT_COLOR(DATA_GRANULARITY) as "typeName",
    croy_sale_out_count||''套'' as "saleOutCount",
    croy_sale_count||''套'' as "saleCount",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(croy_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(croy_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(croy_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(croy_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(croy_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(croy_sale_money) as "saleMoney",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(croy_sale_rate_by_money))  as "saleRateByMoney",
    croy_sale_average_money as "standardPrice",
    croy_sale_out_average_money as "signPrice",
    case when PARENT_ID is null then PROJECT_ID  else PARENT_ID end as "parentId",
    case when PARENT_ID is null then 0 else 1 end as "isAreaSection",
    Sort
FROM
    DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID='''
                 || projectid
                 || ''' 
    union 
    SELECT
    id as "id",
    FN_DWM_FONT_COLOR(DATA_GRANULARITY) as "typeName",
    croy_sale_out_count||''套'' as "saleOutCount",
    croy_sale_count||''套'' as "saleCount",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(croy_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(croy_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(croy_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(croy_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(croy_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(croy_sale_money) as "saleMoney",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(croy_sale_rate_by_money))  as "saleRateByMoney",
    croy_sale_average_money as "standardPrice",
    croy_sale_out_average_money as "signPrice",
    case when PARENT_ID is null then PROJECT_ID  else PARENT_ID end as "parentId",
    case when PARENT_ID is null then 0 else 1 end as "isAreaSection",
    Sort
FROM
    DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID='''
                 || projectid
                 || ''' and  PARENT_ID is not null and
    PARENT_ID not in (select Id from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID='''
                 || projectid
                 || ''' and DATA_GRANULARITY = ''住宅'' )';

    END IF;

    dbms_output.put_line(v_sql);
    IF isshowareasection = 0 THEN
        v_sql := 'select * from ('
                 || v_sql
                 || ') tab where tab."isAreaSection" = 0 order by sort';
    ELSE
        v_sql := 'select * from ('
                 || v_sql
                 || ') tab  order by sort';
    END IF;

    OPEN tabledata FOR v_sql;

EXCEPTION
    WHEN OTHERS THEN
        CLOSE tabledata;
END p_dwm_sr_proj_dtl_sale_rate;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_SR_TREND_MAP_CR
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_SR_TREND_MAP_CR" 
(
  orgIds IN clob 
, rateTye IN VARCHAR2 default 'count'
, pointsData  OUT sys_refcursor
, numerator  OUT sys_refcursor
, denominator  OUT sys_refcursor
, sellRate  OUT sys_refcursor
) AS 
BEGIN
-- Author：吴洋  Date:2020/12/03  竣工备案去化率 变动趋势图
   if rateTye IS NOT NULL AND rateTye = 'count' then
     open pointsData for 
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.CR_SALE_COUNT is null then 0 else  tab.CR_SALE_COUNT end  as "denominator",
             case when tab.CR_SALE_OUT_COUNT is null then 0 else  tab.CR_SALE_OUT_COUNT end  as "numerator",
             case when tab.CR_SALE_RATE_BY_COUNT is null then 0 else  trunc(tab.CR_SALE_RATE_BY_COUNT*100 ,2)end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, CR_SALE_OUT_COUNT, CR_SALE_COUNT, CR_SALE_RATE_BY_COUNT, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.CR_SALE_COUNT,rateTable.CR_SALE_RATE_BY_COUNT,rateTable.CR_SALE_OUT_COUNT
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '竣备去化套数' as "prefix", '套' as "suffix" from dual;
        open denominator for select '已竣备总套数' as "prefix", '套' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
        ELSIF rateTye IS NOT NULL AND rateTye = 'area' THEN
        open pointsData for 

        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.CR_SALE_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.CR_SALE_AREA, 10000, '') end  as "denominator",
             case when tab.CR_SALE_OUT_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.CR_SALE_OUT_AREA, 10000, '') end  as "numerator",
             case when tab.CR_SALE_RATE_BY_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.CR_SALE_RATE_BY_AREA, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, CR_SALE_OUT_AREA, CR_SALE_AREA, CR_SALE_RATE_BY_AREA, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.CR_SALE_AREA,rateTable.CR_SALE_RATE_BY_AREA,rateTable.CR_SALE_OUT_AREA
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '竣备去化面积' as "prefix", '万方' as "suffix" from dual;
        open denominator for select '已竣备总面积' as "prefix", '万方' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
    ELSIF rateTye IS NOT NULL AND rateTye = 'money' THEN
        open pointsData for 

        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.CR_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.CR_SALE_MONEY, 100000000, '') end  as "denominator",
             case when tab.CR_SALE_OUT_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.CR_SALE_OUT_MONEY, 100000000, '') end  as "numerator",
             case when tab.CR_SALE_RATE_BY_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.CR_SALE_RATE_BY_MONEY, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, CR_SALE_OUT_MONEY, CR_SALE_MONEY, CR_SALE_RATE_BY_MONEY, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.CR_SALE_MONEY,rateTable.CR_SALE_RATE_BY_MONEY,rateTable.CR_SALE_OUT_MONEY
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '竣备去化货值' as "prefix", '亿元' as "suffix" from dual;
        open denominator for select '已竣备总货值' as "prefix", '亿元' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
   end if;

EXCEPTION
WHEN OTHERS THEN
  CLOSE pointsData;
  CLOSE numerator;
  CLOSE denominator;
  CLOSE sellRate;   
END P_DWM_SR_TREND_MAP_CR;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_SR_TREND_MAP_CROY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_SR_TREND_MAP_CROY" 
(
  orgIds IN clob 
, rateTye IN VARCHAR2 default 'count'
, pointsData  OUT sys_refcursor
, numerator  OUT sys_refcursor
, denominator  OUT sys_refcursor
, sellRate  OUT sys_refcursor
) AS 
BEGIN
-- Author：吴洋  Date:2020/12/04  竣工备案后一年去化率 变动趋势图
   if rateTye IS NOT NULL AND rateTye = 'count' then
     open pointsData for 
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.CROY_SALE_COUNT is null then 0 else  tab.CROY_SALE_COUNT end  as "denominator",
             case when tab.CROY_SALE_OUT_COUNT is null then 0 else  tab.CROY_SALE_OUT_COUNT end  as "numerator",
             case when tab.CROY_SALE_RATE_BY_COUNT is null then 0 else  trunc(tab.CROY_SALE_RATE_BY_COUNT*100 ,2)end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, CROY_SALE_OUT_COUNT, CROY_SALE_COUNT, CROY_SALE_RATE_BY_COUNT, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.CROY_SALE_COUNT,rateTable.CROY_SALE_RATE_BY_COUNT,rateTable.CROY_SALE_OUT_COUNT
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '竣备去化套数' as "prefix", '套' as "suffix" from dual;
        open denominator for select '已竣备总套数' as "prefix", '套' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
        ELSIF rateTye IS NOT NULL AND rateTye = 'area' THEN
        open pointsData for 

        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.CROY_SALE_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.CROY_SALE_AREA, 10000, '') end  as "denominator",
             case when tab.CROY_SALE_OUT_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.CROY_SALE_OUT_AREA, 10000, '') end  as "numerator",
             case when tab.CROY_SALE_RATE_BY_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.CROY_SALE_RATE_BY_AREA, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, CROY_SALE_OUT_AREA, CROY_SALE_AREA, CROY_SALE_RATE_BY_AREA, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.CROY_SALE_AREA,rateTable.CROY_SALE_RATE_BY_AREA,rateTable.CROY_SALE_OUT_AREA
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '竣备去化面积' as "prefix", '万方' as "suffix" from dual;
        open denominator for select '已竣备总面积' as "prefix", '万方' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
    ELSIF rateTye IS NOT NULL AND rateTye = 'money' THEN
        open pointsData for 

        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.CROY_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.CROY_SALE_MONEY, 100000000, '') end  as "denominator",
             case when tab.CROY_SALE_OUT_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.CROY_SALE_OUT_MONEY, 100000000, '') end  as "numerator",
             case when tab.CROY_SALE_RATE_BY_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.CROY_SALE_RATE_BY_MONEY, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, CROY_SALE_OUT_MONEY, CROY_SALE_MONEY, CROY_SALE_RATE_BY_MONEY, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.CROY_SALE_MONEY,rateTable.CROY_SALE_RATE_BY_MONEY,rateTable.CROY_SALE_OUT_MONEY
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '竣备去化货值' as "prefix", '亿元' as "suffix" from dual;
        open denominator for select '已竣备总货值' as "prefix", '亿元' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
   end if;

EXCEPTION
WHEN OTHERS THEN
  CLOSE pointsData;
  CLOSE numerator;
  CLOSE denominator;
  CLOSE sellRate;   
END P_DWM_SR_TREND_MAP_CROY;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_SR_TREND_MAP_FM
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_SR_TREND_MAP_FM" 
(
  orgIds IN clob 
, rateTye IN VARCHAR2 default 'count'
, pointsData  OUT sys_refcursor
, numerator  OUT sys_refcursor
, denominator  OUT sys_refcursor
, sellRate  OUT sys_refcursor
) AS 
BEGIN
-- Author：吴洋  Date:2020/12/01  首月去化率 变动趋势图
-- 2020/12/9  变更： 首月推售变更为首开推售
-- 筛选条件：去化率类型 和 二级单位筛选
   if rateTye IS NOT NULL AND rateTye = 'count' then
     open pointsData for 
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.FO_SALE_COUNT is null then 0 else  tab.FO_SALE_COUNT end  as "denominator",
             case when tab.FM_SALE_OUT_COUNT is null then 0 else  tab.FM_SALE_OUT_COUNT end  as "numerator",
             case when tab.FM_SALE_RATE_BY_COUNT is null then 0 else  trunc(tab.FM_SALE_RATE_BY_COUNT*100 ,2)end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, FM_SALE_OUT_COUNT, FO_SALE_COUNT, FM_SALE_RATE_BY_COUNT, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.FO_SALE_COUNT,rateTable.FM_SALE_RATE_BY_COUNT,rateTable.FM_SALE_OUT_COUNT
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '首月去化套数' as "prefix", '套' as "suffix" from dual;
        open denominator for select '首开推售套数' as "prefix", '套' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
        ELSIF rateTye IS NOT NULL AND rateTye = 'area' THEN
        open pointsData for 

        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.FO_SALE_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FO_SALE_AREA, 10000, '') end  as "denominator",
             case when tab.FM_SALE_OUT_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FM_SALE_OUT_AREA, 10000, '') end  as "numerator",
             case when tab.FM_SALE_RATE_BY_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FM_SALE_RATE_BY_AREA, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, FM_SALE_OUT_AREA, FO_SALE_AREA, FM_SALE_RATE_BY_AREA, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.FO_SALE_AREA,rateTable.FM_SALE_RATE_BY_AREA,rateTable.FM_SALE_OUT_AREA
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '首月去化面积' as "prefix", '万方' as "suffix" from dual;
        open denominator for select '首开推售面积' as "prefix", '万方' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
    ELSIF rateTye IS NOT NULL AND rateTye = 'money' THEN
        open pointsData for 

        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.FO_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FO_SALE_MONEY, 100000000, '') end  as "denominator",
             case when tab.FM_SALE_OUT_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FM_SALE_OUT_MONEY, 100000000, '') end  as "numerator",
             case when tab.FM_SALE_RATE_BY_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FM_SALE_RATE_BY_MONEY, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, FM_SALE_OUT_MONEY, FO_SALE_MONEY, FM_SALE_RATE_BY_MONEY, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.FO_SALE_MONEY,rateTable.FM_SALE_RATE_BY_MONEY,rateTable.FM_SALE_OUT_MONEY
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '首月去化货值' as "prefix", '亿元' as "suffix" from dual;
        open denominator for select '首开推售货值' as "prefix", '亿元' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
   end if;

EXCEPTION
WHEN OTHERS THEN
  CLOSE pointsData;
  CLOSE numerator;
  CLOSE denominator;
  CLOSE sellRate;   
END P_DWM_SR_TREND_MAP_FM;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_SR_TREND_MAP_FOHY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_SR_TREND_MAP_FOHY" 
(
  orgIds IN clob 
, rateTye IN VARCHAR2 default 'count'
, pointsData  OUT sys_refcursor
, numerator  OUT sys_refcursor
, denominator  OUT sys_refcursor
, sellRate  OUT sys_refcursor
) AS 
BEGIN
-- Author：吴洋  Date:2020/12/02  首开半年去化率 变动趋势图
   if rateTye IS NOT NULL AND rateTye = 'count' then
     open pointsData for 
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod",
             case when tab.FOHY_SALE_COUNT is null then 0 else  tab.FOHY_SALE_COUNT end  as "denominator",
             case when tab.FOHY_SALE_OUT_COUNT is null then 0 else  tab.FOHY_SALE_OUT_COUNT end  as "numerator",
             case when tab.FOHY_SALE_RATE_BY_COUNT is null then 0 else  trunc(tab.FOHY_SALE_RATE_BY_COUNT*100 ,2)end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, FOHY_SALE_OUT_COUNT, FOHY_SALE_COUNT, FOHY_SALE_RATE_BY_COUNT, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.FOHY_SALE_COUNT,rateTable.FOHY_SALE_RATE_BY_COUNT,rateTable.FOHY_SALE_OUT_COUNT
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '首开半年去化套数' as "prefix", '套' as "suffix" from dual;
        open denominator for select '首开半年推售套数' as "prefix", '套' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
        ELSIF rateTye IS NOT NULL AND rateTye = 'area' THEN
        open pointsData for 

        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.FOHY_SALE_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FOHY_SALE_AREA, 10000, '') end  as "denominator",
             case when tab.FOHY_SALE_OUT_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FOHY_SALE_OUT_AREA, 10000, '') end  as "numerator",
             case when tab.FOHY_SALE_RATE_BY_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FOHY_SALE_RATE_BY_AREA, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, FOHY_SALE_OUT_AREA, FOHY_SALE_AREA, FOHY_SALE_RATE_BY_AREA, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.FOHY_SALE_AREA,rateTable.FOHY_SALE_RATE_BY_AREA,rateTable.FOHY_SALE_OUT_AREA
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '首开半年去化面积' as "prefix", '万方' as "suffix" from dual;
        open denominator for select '首开半年推售面积' as "prefix", '万方' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
    ELSIF rateTye IS NOT NULL AND rateTye = 'money' THEN
        open pointsData for 

        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.FOHY_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FOHY_SALE_MONEY, 100000000, '') end  as "denominator",
             case when tab.FOHY_SALE_OUT_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FOHY_SALE_OUT_MONEY, 100000000, '') end  as "numerator",
             case when tab.FOHY_SALE_RATE_BY_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FOHY_SALE_RATE_BY_MONEY, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, FOHY_SALE_OUT_MONEY, FOHY_SALE_MONEY, FOHY_SALE_RATE_BY_MONEY, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.FOHY_SALE_MONEY,rateTable.FOHY_SALE_RATE_BY_MONEY,rateTable.FOHY_SALE_OUT_MONEY
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '首开半年去化货值' as "prefix", '亿元' as "suffix" from dual;
        open denominator for select '首开半年推售货值' as "prefix", '亿元' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
   end if;

EXCEPTION
WHEN OTHERS THEN
  CLOSE pointsData;
  CLOSE numerator;
  CLOSE denominator;
  CLOSE sellRate;   
END P_DWM_SR_TREND_MAP_FOHY;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_SUPPLY_STATUS_SUMMARY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_SUPPLY_STATUS_SUMMARY" 
(
    USERID IN VARCHAR2,
    STATIONID IN VARCHAR2,
    COMPANYID IN VARCHAR2,
    DEPTID IN VARCHAR2,
    PROJ_IDS IN CLOB :='',
    IS_START_WORK IN VARCHAR2 :='all',
    IS_CONTROL IN VARCHAR2  :='all',
    SUMMARY_LIST OUT SYS_REFCURSOR
)
    IS
    V_COMPANY_TABLE CLOB;
    V_COMPANY_ID CLOB;
    V_PROJIDS CLOB;
    V_WORKING_PROJIDS CLOB;
    V_CONTROL_PROJIDS CLOB;
    V_WORKING_PROCESS_PROJ CLOB;    --经过是否开工项目后的筛选项目
    V_CONTROL_PROCESS_PROJ CLOB;    --经过是否操盘项目后的筛选项目
BEGIN
    --dbms_output.put_line('PROJ_IDS'||PROJ_IDS);
    IF PROJ_IDS = '' OR PROJ_IDS IS NULL THEN
        V_CONTROL_PROJIDS := '('''')';
    ELSE
        --是否开工
        IF IS_START_WORK='all' THEN
            --是否开工为所有
            V_WORKING_PROCESS_PROJ := PROJ_IDS;
        ELSE
            --参数处理
            IF LENGTH(PROJ_IDS) > 36 then
                FOR item IN (
                    SELECT
                        regexp_substr(''
                                          || PROJ_IDS
                                          || '', '[^,]+', 1, ROWNUM) AS id
                    FROM
                        dual
                    CONNECT BY
                            ROWNUM <= length(''
                            || PROJ_IDS
                            || '') - length(regexp_replace(''
                                                               || PROJ_IDS
                                                               || '', ',', '')) + 1
                    ) LOOP IF ( V_PROJIDS IS NULL ) THEN
                    V_PROJIDS := ''''
                        || item.id
                        || '''';
                ELSE
                    V_PROJIDS := V_PROJIDS
                        || ','
                        || ''''
                        || item.id
                        || '''';
                END IF;
                    END LOOP;
                V_PROJIDS := '('
                    || V_PROJIDS
                    || ')';

            END IF;
            IF IS_START_WORK='yes' THEN
                --已开工
                EXECUTE IMMEDIATE '
                SELECT WM_CONCAT(ID) FROM(
                    SELECT PROJ.ID, NVL(TOTAL.NODEs, 0) AS WORKING_NODE FROM
                        SYS_PROJECT PROJ LEFT JOIN (
                        SELECT PROJ.ID, COUNT(PROJ.ID) AS NODEs FROM SYS_PROJECT PROJ
                        LEFT JOIN SYS_PROJECT_STAGE PROJS ON PROJ.ID = PROJS.PROJECT_ID
                        LEFT JOIN POM_PROJ_PLAN PLAN ON PROJS.ID = PLAN.PROJ_ID
                        LEFT JOIN POM_PROJ_PLAN_NODE NODE ON PLAN.ID = NODE.PROJ_PLAN_ID
                        LEFT JOIN POM_NODE_FEEDBACK FB ON NODE.ID = FB.FEEDBACK_NODE_ID
                        WHERE NODE.PERMIT_TYPE = ''施工许可证''
                        AND PLAN.PLAN_TYPE = ''关键节点计划''
                        AND PLAN.APPROVAL_STATUS = ''已审核''
                        AND FB.FEEDBACK_TYPE = ''CARRY_OUT''
                        AND FB.APPROVAL_STATUS = ''已审核'' GROUP BY  PROJ.ID
                    )TOTAL ON PROJ.ID =TOTAL.ID
                    WHERE PROJ.ID IN '||V_PROJIDS||'
                    )
                WHERE WORKING_NODE > 0
                  ' INTO V_WORKING_PROCESS_PROJ;
            ELSIF IS_START_WORK = 'no' THEN
                --未开工
                EXECUTE IMMEDIATE '
                 SELECT WM_CONCAT(ID) FROM(
                    SELECT PROJ.ID, NVL(TOTAL.NODEs, 0) AS WORKING_NODE FROM
                        SYS_PROJECT PROJ LEFT JOIN (
                        SELECT PROJ.ID, COUNT(PROJ.ID) AS NODEs FROM SYS_PROJECT PROJ
                        LEFT JOIN SYS_PROJECT_STAGE PROJS ON PROJ.ID = PROJS.PROJECT_ID
                        LEFT JOIN POM_PROJ_PLAN PLAN ON PROJS.ID = PLAN.PROJ_ID
                        LEFT JOIN POM_PROJ_PLAN_NODE NODE ON PLAN.ID = NODE.PROJ_PLAN_ID
                        LEFT JOIN POM_NODE_FEEDBACK FB ON NODE.ID = FB.FEEDBACK_NODE_ID
                        WHERE NODE.PERMIT_TYPE = ''施工许可证''
                        AND PLAN.PLAN_TYPE = ''关键节点计划''
                        AND PLAN.APPROVAL_STATUS = ''已审核''
                        AND FB.FEEDBACK_TYPE = ''CARRY_OUT''
                        AND FB.APPROVAL_STATUS = ''已审核'' GROUP BY  PROJ.ID
                    )TOTAL ON PROJ.ID =TOTAL.ID
                   WHERE PROJ.ID IN '||V_PROJIDS||'
                    )
                WHERE WORKING_NODE = 0
                ' INTO V_WORKING_PROCESS_PROJ;
            END IF;
        END IF;
        --dbms_output.put_line('V_WORKING_PROCESS_PROJ'||V_WORKING_PROCESS_PROJ);

        --是否操盘
        IF IS_CONTROL = 'all' THEN
            V_CONTROL_PROCESS_PROJ := V_WORKING_PROCESS_PROJ;
        ELSE
            IF LENGTH(V_WORKING_PROCESS_PROJ) > 36 then
                FOR item IN (
                    SELECT
                        regexp_substr(''
                                          || V_WORKING_PROCESS_PROJ
                                          || '', '[^,]+', 1, ROWNUM) AS id
                    FROM
                        dual
                    CONNECT BY
                            ROWNUM <= length(''
                            || V_WORKING_PROCESS_PROJ
                            || '') - length(regexp_replace(''
                                                               || V_WORKING_PROCESS_PROJ
                                                               || '', ',', '')) + 1
                    ) LOOP IF ( V_WORKING_PROJIDS IS NULL ) THEN
                    V_WORKING_PROJIDS := ''''
                        || item.id
                        || '''';
                ELSE
                    V_WORKING_PROJIDS := V_WORKING_PROJIDS
                        || ','
                        || ''''
                        || item.id
                        || '''';
                END IF;
                    END LOOP;
                V_WORKING_PROJIDS := '('
                    || V_WORKING_PROJIDS
                    || ')';

            END IF;
            IF IS_CONTROL = 'yes' THEN
                EXECUTE IMMEDIATE '
                    SELECT WM_CONCAT(ID) FROM SYS_PROJECT
                    WHERE PROJ_COOPERATE = ''操盘''
                     AND ID IN '||V_WORKING_PROJIDS||'
                ' INTO V_CONTROL_PROCESS_PROJ;
            ELSIF IS_CONTROL = 'no' THEN
                EXECUTE IMMEDIATE '
                    SELECT WM_CONCAT(ID) FROM SYS_PROJECT
                    WHERE PROJ_COOPERATE <> ''不操盘''
                    AND ID IN '||V_WORKING_PROJIDS||'
                ' INTO V_CONTROL_PROCESS_PROJ;
            END IF;
        END IF;
        --dbms_output.put_line('V_CONTROL_PROCESS_PROJ'||V_CONTROL_PROCESS_PROJ);
        --处理操盘筛选后的项目节点
        IF LENGTH(V_CONTROL_PROCESS_PROJ) > 36 then
            FOR item IN (
                SELECT
                    regexp_substr(''
                                      || V_CONTROL_PROCESS_PROJ
                                      || '', '[^,]+', 1, ROWNUM) AS id
                FROM
                    dual
                CONNECT BY
                        ROWNUM <= length(''
                        || V_CONTROL_PROCESS_PROJ
                        || '') - length(regexp_replace(''
                                                           || V_CONTROL_PROCESS_PROJ
                                                           || '', ',', '')) + 1
                ) LOOP IF ( V_CONTROL_PROJIDS IS NULL ) THEN
                V_CONTROL_PROJIDS := ''''
                    || item.id
                    || '''';
            ELSE
                V_CONTROL_PROJIDS := V_CONTROL_PROJIDS
                    || ','
                    || ''''
                    || item.id
                    || '''';
            END IF;
                END LOOP;
            V_CONTROL_PROJIDS := '('
                || V_CONTROL_PROJIDS
                || ')';
        ELSE
            V_CONTROL_PROJIDS := '('''
                || V_CONTROL_PROCESS_PROJ
                || ''')';
        END IF;

    END IF;
    dbms_output.put_line('V_CONTROL_PROJIDS'||V_CONTROL_PROJIDS);
    --dbms_output.put_line('V_CONTROL_PROJIDS'||V_CONTROL_PROJIDS);
    OPEN SUMMARY_LIST FOR
            '
                SELECT distinct a.*,level as "level", sys_connect_by_path (a."orderHierarchyCode", ''-->'') as tree from (
                WITH FULL_DATA AS(
                    SELECT * FROM (
                                      SELECT *
                                      FROM (
                                               SELECT ID
                                                    , ORG_NAME
                                                    , PARENT_ID
                                                    , ORDER_HIERARCHY_CODE
                                                    , 0 AS NEWEST_SUPPLY
                                                    , 0 AS TOTAL_DIFERENCE
                                                    , 0 AS DYNAMIC_TOTAL_WORTH
                                                    , 0 AS SAVING_WORTH
                                                    , 0 AS ROAD_WORTH
                                                    , 0 AS STORAGE_WORTH
                                                    , 0 AS SALED_WORTH
                                                    , 0 AS SURPLUS_WORTH
                                                    , 0 AS HAVE_GOT_WORTH
                                                    , 0 AS SAVING_WORTH_VALUE
                                                    , 0 AS SAVING_WORTH_QUATITY
                                                    , 0 AS SAVING_WORTH_CARPORT
                                                    , 0 AS ROAD_WORTH_VALUE
                                                    , 0 AS ROAD_WORTH_QUATITY
                                                    , 0 AS ROAD_WORTH_CARPORT
                                                    , 0 AS STORAGE_WORTH_VALUE
                                                    , 0 AS STORAGE_WORTH_QUATITY
                                                    , 0 AS STORAGE_WORTH_CARPORT
                                                    , 0 AS SALED_WORTH_VALUE
                                                    , 0 AS SALED_WORTH_QUATITY
                                                    , 0 AS SALED_WORTH_CARPORT
                                                    , 0 AS NO_EVIDENCE
                                                    , 0 AS PLANNING_PERMIT
                                                    , 0 AS WORKING_PERMIT
                                                    , 0 AS PRESALE_PERMIT
                                                    , 0 AS COMPLETION_PERMIT
                                                    , 0 AS CARRY_FORWARD_PERMIT
                                                    , ORDER_HIERARCHY_CODE as "orderHierarchyCode"
                                               FROM SYS_BUSINESS_UNIT
                                               WHERE IS_COMPANY = 1
                                               AND ID IN (
                                                    SELECT COMPANY_ID FROM SYS_PROJECT WHERE ID IN (
                                                        SELECT OBJ_ID FROM DWM_DT_VALUE WHERE OBJ_TYPE = ''项目''
                                                        AND OBJ_ID IN '||V_CONTROL_PROJIDS||'
                                            ) GROUP BY COMPANY_ID
                                            UNION
                                             select id from  SYS_BUSINESS_UNIT
                                                    start with id IN (SELECT COMPANY_ID FROM SYS_PROJECT WHERE ID IN (
                                                SELECT OBJ_ID FROM DWM_DT_VALUE WHERE OBJ_TYPE = ''项目''
                                                AND OBJ_ID IN '||V_CONTROL_PROJIDS||'
                                            ))
                                            CONNECT BY PRIOR  PARENT_ID = ID
                                        )
                                       ORDER BY ORDER_HIERARCHY_CODE ASC
                                   )
                              UNION
--货值
                              SELECT *
                              FROM (
                                       SELECT OBJ_ID                                          AS ID
                                            , OBJ_NAME                                        AS ORG_NAME
                                            , PROJ.UNIT_ID                                    AS PARENT_ID
                                            , DT.ORDER_HIERARCHY_CODE
                                            , TARGET_A_VALUE                  AS NEWEST_SUPPLY
                                            , TARGET_A_VALUE_DIFF             AS TOTAL_DIFERENCE
                                            , TRUNC(VALUE_DT_ALL / 10000,2)                   AS DYNAMIC_TOTAL_WORTH
                                            , TRUNC(VALUE_RESERVE / 10000,2)                  AS SAVING_WORTH
                                            , TRUNC(VALUE_IN_PROCESS / 10000,2)               AS ROAD_WORTH
                                            , TRUNC(VALUE_STOCK / 10000,2)                    AS STORAGE_WORTH
                                            , TRUNC(VALUE_HAVED_SALE / 10000,2)               AS SALED_WORTH
                                            , TRUNC(VALUE_REMAIN / 10000,2)                   AS SURPLUS_WORTH
                                            , TRUNC(VALUE_ALLOW_SALE / 10000,2)               AS HAVE_GOT_WORTH
                                            , TRUNC(VALUE_RESERVE / 10000,2)                  AS SAVING_WORTH_VALUE
                                            , (SY_AREA_RESERVE + ZZ_AREA_RESERVE)             AS SAVING_WORTH_QUATITY
                                            , CW_AREA_RESERVE                                 AS SAVING_WORTH_CARPORT
                                            , TRUNC(VALUE_IN_PROCESS / 10000,2)                                AS ROAD_WORTH_VALUE
                                            , (ZZ_AREA_IN_PROCESS + SY_AREA_IN_PROCESS)       AS ROAD_WORTH_QUATITY
                                            , CW_AREA_IN_PROCESS                              AS ROAD_WORTH_CARPORT
                                            , TRUNC(VALUE_STOCK / 10000,2)                                     AS STORAGE_WORTH_VALUE
                                            , (ZZ_AREA_STOCK + SY_AREA_STOCK)                 AS STORAGE_WORTH_QUATITY
                                            , CW_AREA_STOCK                                   AS STORAGE_WORTH_CARPORT
                                            , TRUNC(VALUE_HAVED_SALE / 10000,2)                                AS SALED_WORTH_VALUE
                                            , (ZZ_AREA_HAVED_SALE + SY_AREA_HAVED_SALE)       AS SALED_WORTH_QUATITY
                                            , CW_AREA_HAVED_SALE                              AS SALED_WORTH_CARPORT
                                            , TRUNC(VALUE_NOT_PLANNING_PERMIT / 10000,2)                       AS NO_EVIDENCE
                                            , TRUNC(VALUE_NOT_CONSTRUCTION_PERMIT / 10000,2)                   AS PLANNING_PERMIT
                                            , TRUNC(VALUE_NOT_SALE_PERMIT / 10000,2)                           AS WORKING_PERMIT
                                            , TRUNC(VALUE_NOT_COMPLETION / 10000,2)                            AS PRESALE_PERMIT
                                            , TRUNC(VALUE_YES_COMPLETION / 10000,2)                            AS COMPLETION_PERMIT
                                            , TRUNC(VALUE_YES_SETTLEMENT / 10000,2)                            AS CARRY_FORWARD_PERMIT
                                            ,PROJ.ORDER_HIERARCHY_CODE as "orderHierarchyCode"
                                       FROM DWM_DT_VALUE DT
                                                LEFT JOIN SYS_PROJECT PROJ ON DT.OBJ_ID = PROJ.ID
                                       WHERE OBJ_TYPE = ''项目''
                                         AND OBJ_ID IN '||V_CONTROL_PROJIDS||'
                                   )
                          )
            START WITH ID =''003200000000000000000000000000''
            CONNECT BY PRIOR ID = PARENT_ID
            ORDER BY ORDER_HIERARCHY_CODE
        ), SUMMARIZAION AS (
            select ID,ORG_NAME,PARENT_ID,
                   (select sum(FULL_DATA.NEWEST_SUPPLY) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS NEWEST_SUPPLY,
                   (select sum(FULL_DATA.TOTAL_DIFERENCE) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS TOTAL_DIFERENCE,
                   (select sum(FULL_DATA.DYNAMIC_TOTAL_WORTH) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS DYNAMIC_TOTAL_WORTH,
                   (select sum(FULL_DATA.SAVING_WORTH) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS SAVING_WORTH,
                   (select sum(FULL_DATA.ROAD_WORTH) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS ROAD_WORTH,
                   (select sum(FULL_DATA.STORAGE_WORTH) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS STORAGE_WORTH,
                   (select sum(FULL_DATA.SALED_WORTH) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS SALED_WORTH,
                   (select sum(FULL_DATA.SURPLUS_WORTH) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS SURPLUS_WORTH,
                   (select sum(FULL_DATA.HAVE_GOT_WORTH) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS HAVE_GOT_WORTH,
                   (select sum(FULL_DATA.SAVING_WORTH_VALUE) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS SAVING_WORTH_VALUE,
                   (select sum(FULL_DATA.SAVING_WORTH_QUATITY) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS SAVING_WORTH_QUATITY,
                   (select sum(FULL_DATA.SAVING_WORTH_CARPORT) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS SAVING_WORTH_CARPORT,
                   (select sum(FULL_DATA.ROAD_WORTH_VALUE) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS ROAD_WORTH_VALUE,
                   (select sum(FULL_DATA.ROAD_WORTH_QUATITY) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS ROAD_WORTH_QUATITY,
                   (select sum(FULL_DATA.ROAD_WORTH_CARPORT) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS ROAD_WORTH_CARPORT,
                   (select sum(FULL_DATA.STORAGE_WORTH_VALUE) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS STORAGE_WORTH_VALUE,
                   (select sum(FULL_DATA.STORAGE_WORTH_QUATITY) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS STORAGE_WORTH_QUATITY,
                   (select sum(FULL_DATA.STORAGE_WORTH_CARPORT) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS STORAGE_WORTH_CARPORT,
                   (select sum(FULL_DATA.SALED_WORTH_VALUE) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS SALED_WORTH_VALUE,
                   (select sum(FULL_DATA.SALED_WORTH_QUATITY) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS SALED_WORTH_QUATITY,
                   (select sum(FULL_DATA.SALED_WORTH_CARPORT) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS SALED_WORTH_CARPORT,
                   (select sum(FULL_DATA.NO_EVIDENCE) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS NO_EVIDENCE,
                   (select sum(FULL_DATA.PLANNING_PERMIT) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS PLANNING_PERMIT,
                   (select sum(FULL_DATA.WORKING_PERMIT) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS WORKING_PERMIT,
                   (select sum(FULL_DATA.PRESALE_PERMIT) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS PRESALE_PERMIT,
                   (select sum(FULL_DATA.COMPLETION_PERMIT) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS COMPLETION_PERMIT,
                   (select sum(FULL_DATA.CARRY_FORWARD_PERMIT) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS CARRY_FORWARD_PERMIT,
                   TOTAL."orderHierarchyCode"
            from FULL_DATA TOTAL
        )
        SELECT
           ID,ORG_NAME,PARENT_ID
             ,to_char(NEWEST_SUPPLY,''FM999,999,999,999,990.00'') as NEWEST_SUPPLY
             ,to_char(TOTAL_DIFERENCE,''FM999,999,999,999,990.00'') as TOTAL_DIFERENCE
             ,to_char(DYNAMIC_TOTAL_WORTH,''FM999,999,999,999,990.00'') as DYNAMIC_TOTAL_WORTH
             ,to_char(SAVING_WORTH,''FM999,999,999,999,990.00'') as SAVING_WORTH
             ,to_char(ROAD_WORTH,''FM999,999,999,999,990.00'') as ROAD_WORTH
             ,to_char(STORAGE_WORTH,''FM999,999,999,999,990.00'')as STORAGE_WORTH
             ,to_char(SALED_WORTH,''FM999,999,999,999,990.00'')as SALED_WORTH
             ,to_char(SURPLUS_WORTH,''FM999,999,999,999,990.00'')as SURPLUS_WORTH
             ,to_char(HAVE_GOT_WORTH,''FM999,999,999,999,990.00'')as HAVE_GOT_WORTH
             ,CASE WHEN HAVE_GOT_WORTH = 0 THEN
                       0
                   ELSE round((SALED_WORTH / HAVE_GOT_WORTH),2)* 100 END||''%'' AS HAVE_GOT_RATE
             ,to_char(SAVING_WORTH_VALUE,''FM999,999,999,999,990.00'')as SAVING_WORTH_VALUE
             ,to_char(SAVING_WORTH_QUATITY,''FM999,999,999,999,990.00'')as SAVING_WORTH_QUATITY
             ,to_char(SAVING_WORTH_CARPORT,''FM999,999,999,999,990.00'')as SAVING_WORTH_CARPORT
             ,to_char(ROAD_WORTH_VALUE,''FM999,999,999,999,990.00'')as ROAD_WORTH_VALUE
             ,to_char(ROAD_WORTH_QUATITY,''FM999,999,999,999,990.00'')as ROAD_WORTH_QUATITY
             ,to_char(ROAD_WORTH_CARPORT,''FM999,999,999,999,990.00'')as ROAD_WORTH_CARPORT
             ,to_char(STORAGE_WORTH_VALUE,''FM999,999,999,999,990.00'')as STORAGE_WORTH_VALUE
             ,to_char(STORAGE_WORTH_QUATITY,''FM999,999,999,999,990.00'')as STORAGE_WORTH_QUATITY
             ,to_char(STORAGE_WORTH_CARPORT,''FM999,999,999,999,990.00'')as STORAGE_WORTH_CARPORT
             ,to_char(SALED_WORTH_VALUE,''FM999,999,999,999,990.00'')as SALED_WORTH_VALUE
             ,to_char(SALED_WORTH_QUATITY,''FM999,999,999,999,990.00'')as SALED_WORTH_QUATITY
             ,to_char(SALED_WORTH_CARPORT,''FM999,999,999,999,990.00'')as SALED_WORTH_CARPORT
             ,to_char(NO_EVIDENCE,''FM999,999,999,999,990.00'')as NO_EVIDENCE
             ,to_char(PLANNING_PERMIT,''FM999,999,999,999,990.00'')as PLANNING_PERMIT
             ,to_char(WORKING_PERMIT,''FM999,999,999,999,990.00'')as WORKING_PERMIT
             ,to_char(PRESALE_PERMIT,''FM999,999,999,999,990.00'')as PRESALE_PERMIT
             ,to_char(COMPLETION_PERMIT,''FM999,999,999,999,990.00'')as COMPLETION_PERMIT
             ,to_char(CARRY_FORWARD_PERMIT,''FM999,999,999,999,990.00'')as CARRY_FORWARD_PERMIT
             ,"orderHierarchyCode"
        FROM SUMMARIZAION
        )a start with a.ID = ''003200000000000000000000000000'' connect by prior a.ID = a.PARENT_ID  order  by tree
    '
    ;
END P_DWM_SUPPLY_STATUS_SUMMARY;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_SUPPLY_SUMMARY_BY_EXCEL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_SUPPLY_SUMMARY_BY_EXCEL" 
(
    USERID IN VARCHAR2,
    STATIONID IN VARCHAR2,
    COMPANYID IN VARCHAR2,
    DEPTID IN VARCHAR2,
    PROJ_IDS IN CLOB :='',
    IS_START_WORK IN VARCHAR2 :='all',
    IS_CONTROL IN VARCHAR2  :='all',
    SUMMARY_LIST OUT SYS_REFCURSOR
)
    IS
    V_COMPANY_TABLE CLOB;
    V_COMPANY_ID CLOB;
    V_PROJIDS CLOB;
    V_WORKING_PROJIDS CLOB;
    V_CONTROL_PROJIDS CLOB;
    V_WORKING_PROCESS_PROJ CLOB;    --经过是否开工项目后的筛选项目
    V_CONTROL_PROCESS_PROJ CLOB;    --经过是否操盘项目后的筛选项目
BEGIN
    --dbms_output.put_line('PROJ_IDS'||PROJ_IDS);
    IF PROJ_IDS = '' OR PROJ_IDS IS NULL THEN
        V_CONTROL_PROJIDS := '('''')';
    ELSE
        --是否开工
        IF IS_START_WORK='all' THEN
            --是否开工为所有
            V_WORKING_PROCESS_PROJ := PROJ_IDS;
        ELSE
            --参数处理
            IF LENGTH(PROJ_IDS) > 36 then
                FOR item IN (
                    SELECT
                        regexp_substr(''
                                          || PROJ_IDS
                                          || '', '[^,]+', 1, ROWNUM) AS id
                    FROM
                        dual
                    CONNECT BY
                            ROWNUM <= length(''
                            || PROJ_IDS
                            || '') - length(regexp_replace(''
                                                               || PROJ_IDS
                                                               || '', ',', '')) + 1
                    ) LOOP IF ( V_PROJIDS IS NULL ) THEN
                    V_PROJIDS := ''''
                        || item.id
                        || '''';
                ELSE
                    V_PROJIDS := V_PROJIDS
                        || ','
                        || ''''
                        || item.id
                        || '''';
                END IF;
                    END LOOP;
                V_PROJIDS := '('
                    || V_PROJIDS
                    || ')';

            END IF;
            IF IS_START_WORK='yes' THEN
                --已开工
                EXECUTE IMMEDIATE '
                SELECT WM_CONCAT(ID) FROM(
                    SELECT PROJ.ID, NVL(TOTAL.NODEs, 0) AS WORKING_NODE FROM
                        SYS_PROJECT PROJ LEFT JOIN (
                        SELECT PROJ.ID, COUNT(PROJ.ID) AS NODEs FROM SYS_PROJECT PROJ
                        LEFT JOIN SYS_PROJECT_STAGE PROJS ON PROJ.ID = PROJS.PROJECT_ID
                        LEFT JOIN POM_PROJ_PLAN PLAN ON PROJS.ID = PLAN.PROJ_ID
                        LEFT JOIN POM_PROJ_PLAN_NODE NODE ON PLAN.ID = NODE.PROJ_PLAN_ID
                        LEFT JOIN POM_NODE_FEEDBACK FB ON NODE.ID = FB.FEEDBACK_NODE_ID
                        WHERE NODE.PERMIT_TYPE = ''施工许可证''
                        AND PLAN.PLAN_TYPE = ''关键节点计划''
                        AND PLAN.APPROVAL_STATUS = ''已审核''
                        AND FB.FEEDBACK_TYPE = ''CARRY_OUT''
                        AND FB.APPROVAL_STATUS = ''已审核'' GROUP BY  PROJ.ID
                    )TOTAL ON PROJ.ID =TOTAL.ID
                    WHERE PROJ.ID IN '||V_PROJIDS||'
                    )
                WHERE WORKING_NODE > 0
                  ' INTO V_WORKING_PROCESS_PROJ;
            ELSIF IS_START_WORK = 'no' THEN
                --未开工
                EXECUTE IMMEDIATE '
                 SELECT WM_CONCAT(ID) FROM(
                    SELECT PROJ.ID, NVL(TOTAL.NODEs, 0) AS WORKING_NODE FROM
                        SYS_PROJECT PROJ LEFT JOIN (
                        SELECT PROJ.ID, COUNT(PROJ.ID) AS NODEs FROM SYS_PROJECT PROJ
                        LEFT JOIN SYS_PROJECT_STAGE PROJS ON PROJ.ID = PROJS.PROJECT_ID
                        LEFT JOIN POM_PROJ_PLAN PLAN ON PROJS.ID = PLAN.PROJ_ID
                        LEFT JOIN POM_PROJ_PLAN_NODE NODE ON PLAN.ID = NODE.PROJ_PLAN_ID
                        LEFT JOIN POM_NODE_FEEDBACK FB ON NODE.ID = FB.FEEDBACK_NODE_ID
                        WHERE NODE.PERMIT_TYPE = ''施工许可证''
                        AND PLAN.PLAN_TYPE = ''关键节点计划''
                        AND PLAN.APPROVAL_STATUS = ''已审核''
                        AND FB.FEEDBACK_TYPE = ''CARRY_OUT''
                        AND FB.APPROVAL_STATUS = ''已审核'' GROUP BY  PROJ.ID
                    )TOTAL ON PROJ.ID =TOTAL.ID
                   WHERE PROJ.ID IN '||V_PROJIDS||'
                    )
                WHERE WORKING_NODE = 0
                ' INTO V_WORKING_PROCESS_PROJ;
            END IF;
        END IF;
        --dbms_output.put_line('V_WORKING_PROCESS_PROJ'||V_WORKING_PROCESS_PROJ);

        --是否操盘
        IF IS_CONTROL = 'all' THEN
            V_CONTROL_PROCESS_PROJ := V_WORKING_PROCESS_PROJ;
        ELSE
            IF LENGTH(V_WORKING_PROCESS_PROJ) > 36 then
                FOR item IN (
                    SELECT
                        regexp_substr(''
                                          || V_WORKING_PROCESS_PROJ
                                          || '', '[^,]+', 1, ROWNUM) AS id
                    FROM
                        dual
                    CONNECT BY
                            ROWNUM <= length(''
                            || V_WORKING_PROCESS_PROJ
                            || '') - length(regexp_replace(''
                                                               || V_WORKING_PROCESS_PROJ
                                                               || '', ',', '')) + 1
                    ) LOOP IF ( V_WORKING_PROJIDS IS NULL ) THEN
                    V_WORKING_PROJIDS := ''''
                        || item.id
                        || '''';
                ELSE
                    V_WORKING_PROJIDS := V_WORKING_PROJIDS
                        || ','
                        || ''''
                        || item.id
                        || '''';
                END IF;
                    END LOOP;
                V_WORKING_PROJIDS := '('
                    || V_WORKING_PROJIDS
                    || ')';

            END IF;
            IF IS_CONTROL = 'yes' THEN
                EXECUTE IMMEDIATE '
                    SELECT WM_CONCAT(ID) FROM SYS_PROJECT
                    WHERE PROJ_COOPERATE = ''操盘''
                     AND ID IN '||V_WORKING_PROJIDS||'
                ' INTO V_CONTROL_PROCESS_PROJ;
            ELSIF IS_CONTROL = 'no' THEN
                EXECUTE IMMEDIATE '
                    SELECT WM_CONCAT(ID) FROM SYS_PROJECT
                    WHERE PROJ_COOPERATE <> ''操盘''
                    AND ID IN '||V_WORKING_PROJIDS||'
                ' INTO V_CONTROL_PROCESS_PROJ;
            END IF;
        END IF;
        --dbms_output.put_line('V_CONTROL_PROCESS_PROJ'||V_CONTROL_PROCESS_PROJ);
        --处理操盘筛选后的项目节点
        IF LENGTH(V_CONTROL_PROCESS_PROJ) > 36 then
            FOR item IN (
                SELECT
                    regexp_substr(''
                                      || V_CONTROL_PROCESS_PROJ
                                      || '', '[^,]+', 1, ROWNUM) AS id
                FROM
                    dual
                CONNECT BY
                        ROWNUM <= length(''
                        || V_CONTROL_PROCESS_PROJ
                        || '') - length(regexp_replace(''
                                                           || V_CONTROL_PROCESS_PROJ
                                                           || '', ',', '')) + 1
                ) LOOP IF ( V_CONTROL_PROJIDS IS NULL ) THEN
                V_CONTROL_PROJIDS := ''''
                    || item.id
                    || '''';
            ELSE
                V_CONTROL_PROJIDS := V_CONTROL_PROJIDS
                    || ','
                    || ''''
                    || item.id
                    || '''';
            END IF;
                END LOOP;
            V_CONTROL_PROJIDS := '('
                || V_CONTROL_PROJIDS
                || ')';
        ELSE
            V_CONTROL_PROJIDS := '('''
                || V_CONTROL_PROCESS_PROJ
                || ''')';
        END IF;

    END IF;
    dbms_output.put_line('V_CONTROL_PROJIDS'||V_CONTROL_PROJIDS);
    --dbms_output.put_line('V_CONTROL_PROJIDS'||V_CONTROL_PROJIDS);
    OPEN SUMMARY_LIST FOR
            '
                SELECT distinct a.ID,a.ORG_NAME,a.PARENT_ID
                     ,a.NEWEST_SUPPLY
                     ,a.TOTAL_DIFERENCE
                     ,a.DYNAMIC_TOTAL_WORTH
                     ,a.SAVING_WORTH
                     ,a.ROAD_WORTH
                     ,a.STORAGE_WORTH
                     ,a.SALED_WORTH
                     ,a.SURPLUS_WORTH
                     ,a.HAVE_GOT_WORTH
                     ,a.HAVE_GOT_RATE
                     ,a.SAVING_WORTH_VALUE
                     ,a.SAVING_WORTH_QUATITY
                     ,a.SAVING_WORTH_CARPORT
                     ,a.ROAD_WORTH_VALUE
                     ,a.ROAD_WORTH_QUATITY
                     ,a.ROAD_WORTH_CARPORT
                     ,a.STORAGE_WORTH_VALUE
                     ,a.STORAGE_WORTH_QUATITY
                     ,a.STORAGE_WORTH_CARPORT
                     ,a.SALED_WORTH_VALUE
                     ,a.SALED_WORTH_QUATITY
                     ,a.SALED_WORTH_CARPORT
                     ,a.NO_EVIDENCE
                     ,a.PLANNING_PERMIT
                     ,a.WORKING_PERMIT
                     ,a.PRESALE_PERMIT
                     ,a.COMPLETION_PERMIT
                     ,a.CARRY_FORWARD_PERMIT
                     ,a."orderHierarchyCode"
                ,level as "level", sys_connect_by_path (a."orderHierarchyCode", ''-->'') as tree from (
                WITH FULL_DATA AS(
                    SELECT * FROM (
                                      SELECT *
                                      FROM (
                                               SELECT ID
                                                    , ORG_NAME
                                                    , PARENT_ID
                                                    , ORDER_HIERARCHY_CODE
                                                    , 0 AS NEWEST_SUPPLY
                                                    , 0 AS TOTAL_DIFERENCE
                                                    , 0 AS DYNAMIC_TOTAL_WORTH
                                                    , 0 AS SAVING_WORTH
                                                    , 0 AS ROAD_WORTH
                                                    , 0 AS STORAGE_WORTH
                                                    , 0 AS SALED_WORTH
                                                    , 0 AS SURPLUS_WORTH
                                                    , 0 AS HAVE_GOT_WORTH
                                                    , 0 AS SAVING_WORTH_VALUE
                                                    , 0 AS SAVING_WORTH_QUATITY
                                                    , 0 AS SAVING_WORTH_CARPORT
                                                    , 0 AS ROAD_WORTH_VALUE
                                                    , 0 AS ROAD_WORTH_QUATITY
                                                    , 0 AS ROAD_WORTH_CARPORT
                                                    , 0 AS STORAGE_WORTH_VALUE
                                                    , 0 AS STORAGE_WORTH_QUATITY
                                                    , 0 AS STORAGE_WORTH_CARPORT
                                                    , 0 AS SALED_WORTH_VALUE
                                                    , 0 AS SALED_WORTH_QUATITY
                                                    , 0 AS SALED_WORTH_CARPORT
                                                    , 0 AS NO_EVIDENCE
                                                    , 0 AS PLANNING_PERMIT
                                                    , 0 AS WORKING_PERMIT
                                                    , 0 AS PRESALE_PERMIT
                                                    , 0 AS COMPLETION_PERMIT
                                                    , 0 AS CARRY_FORWARD_PERMIT
                                                    , ORDER_HIERARCHY_CODE as "orderHierarchyCode"
                                               FROM SYS_BUSINESS_UNIT
                                               WHERE IS_COMPANY = 1
                                               AND ID IN (
                                                    SELECT COMPANY_ID FROM SYS_PROJECT WHERE ID IN (
                                                        SELECT OBJ_ID FROM DWM_DT_VALUE WHERE OBJ_TYPE = ''项目''
                                                        AND OBJ_ID IN '||V_CONTROL_PROJIDS||'
                                            ) GROUP BY COMPANY_ID
                                            UNION
                                             select id from  SYS_BUSINESS_UNIT
                                                    start with id IN (SELECT COMPANY_ID FROM SYS_PROJECT WHERE ID IN (
                                                SELECT OBJ_ID FROM DWM_DT_VALUE WHERE OBJ_TYPE = ''项目''
                                                AND OBJ_ID IN '||V_CONTROL_PROJIDS||'
                                            ))
                                            CONNECT BY PRIOR  PARENT_ID = ID
                                        )
                                       ORDER BY ORDER_HIERARCHY_CODE ASC
                                   )
                              UNION
--货值
                              SELECT *
                              FROM (
                                       SELECT OBJ_ID                                          AS ID
                                            , OBJ_NAME                                        AS ORG_NAME
                                            , PROJ.UNIT_ID                                    AS PARENT_ID
                                            , DT.ORDER_HIERARCHY_CODE
                                            , TARGET_A_VALUE                  AS NEWEST_SUPPLY
                                            , TARGET_A_VALUE_DIFF             AS TOTAL_DIFERENCE
                                            , TRUNC(VALUE_DT_ALL / 10000,2)                   AS DYNAMIC_TOTAL_WORTH
                                            , TRUNC(VALUE_RESERVE / 10000,2)                  AS SAVING_WORTH
                                            , TRUNC(VALUE_IN_PROCESS / 10000,2)               AS ROAD_WORTH
                                            , TRUNC(VALUE_STOCK / 10000,2)                    AS STORAGE_WORTH
                                            , TRUNC(VALUE_HAVED_SALE / 10000,2)               AS SALED_WORTH
                                            , TRUNC(VALUE_REMAIN / 10000,2)                   AS SURPLUS_WORTH
                                            , TRUNC(VALUE_ALLOW_SALE / 10000,2)               AS HAVE_GOT_WORTH
                                            , TRUNC(VALUE_RESERVE / 10000,2)                  AS SAVING_WORTH_VALUE
                                            , (SY_AREA_RESERVE + ZZ_AREA_RESERVE)             AS SAVING_WORTH_QUATITY
                                            , CW_AREA_RESERVE                                 AS SAVING_WORTH_CARPORT
                                            , TRUNC(VALUE_IN_PROCESS / 10000,2)                                AS ROAD_WORTH_VALUE
                                            , (ZZ_AREA_IN_PROCESS + SY_AREA_IN_PROCESS)       AS ROAD_WORTH_QUATITY
                                            , CW_AREA_IN_PROCESS                              AS ROAD_WORTH_CARPORT
                                            , TRUNC(VALUE_STOCK / 10000,2)                                     AS STORAGE_WORTH_VALUE
                                            , (ZZ_AREA_STOCK + SY_AREA_STOCK)                 AS STORAGE_WORTH_QUATITY
                                            , CW_AREA_STOCK                                   AS STORAGE_WORTH_CARPORT
                                            , TRUNC(VALUE_HAVED_SALE / 10000,2)                                AS SALED_WORTH_VALUE
                                            , (ZZ_AREA_HAVED_SALE + SY_AREA_HAVED_SALE)       AS SALED_WORTH_QUATITY
                                            , CW_AREA_HAVED_SALE                              AS SALED_WORTH_CARPORT
                                            , TRUNC(VALUE_NOT_PLANNING_PERMIT / 10000,2)                       AS NO_EVIDENCE
                                            , TRUNC(VALUE_NOT_CONSTRUCTION_PERMIT / 10000,2)                   AS PLANNING_PERMIT
                                            , TRUNC(VALUE_NOT_SALE_PERMIT / 10000,2)                           AS WORKING_PERMIT
                                            , TRUNC(VALUE_NOT_COMPLETION / 10000,2)                            AS PRESALE_PERMIT
                                            , TRUNC(VALUE_YES_COMPLETION / 10000,2)                            AS COMPLETION_PERMIT
                                            , TRUNC(VALUE_YES_SETTLEMENT / 10000,2)                            AS CARRY_FORWARD_PERMIT
                                            ,PROJ.ORDER_HIERARCHY_CODE as "orderHierarchyCode"
                                       FROM DWM_DT_VALUE DT
                                                LEFT JOIN SYS_PROJECT PROJ ON DT.OBJ_ID = PROJ.ID
                                       WHERE OBJ_TYPE = ''项目''
                                         AND OBJ_ID IN '||V_CONTROL_PROJIDS||'
                                   )
                          )
            START WITH ID =''003200000000000000000000000000''
            CONNECT BY PRIOR ID = PARENT_ID
            ORDER BY ORDER_HIERARCHY_CODE
        ), SUMMARIZAION AS (
            select ID,ORG_NAME,PARENT_ID,
                   (select sum(FULL_DATA.NEWEST_SUPPLY) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS NEWEST_SUPPLY,
                   (select sum(FULL_DATA.TOTAL_DIFERENCE) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS TOTAL_DIFERENCE,
                   (select sum(FULL_DATA.DYNAMIC_TOTAL_WORTH) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS DYNAMIC_TOTAL_WORTH,
                   (select sum(FULL_DATA.SAVING_WORTH) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS SAVING_WORTH,
                   (select sum(FULL_DATA.ROAD_WORTH) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS ROAD_WORTH,
                   (select sum(FULL_DATA.STORAGE_WORTH) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS STORAGE_WORTH,
                   (select sum(FULL_DATA.SALED_WORTH) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS SALED_WORTH,
                   (select sum(FULL_DATA.SURPLUS_WORTH) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS SURPLUS_WORTH,
                   (select sum(FULL_DATA.HAVE_GOT_WORTH) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS HAVE_GOT_WORTH,
                   (select sum(FULL_DATA.SAVING_WORTH_VALUE) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS SAVING_WORTH_VALUE,
                   (select sum(FULL_DATA.SAVING_WORTH_QUATITY) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS SAVING_WORTH_QUATITY,
                   (select sum(FULL_DATA.SAVING_WORTH_CARPORT) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS SAVING_WORTH_CARPORT,
                   (select sum(FULL_DATA.ROAD_WORTH_VALUE) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS ROAD_WORTH_VALUE,
                   (select sum(FULL_DATA.ROAD_WORTH_QUATITY) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS ROAD_WORTH_QUATITY,
                   (select sum(FULL_DATA.ROAD_WORTH_CARPORT) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS ROAD_WORTH_CARPORT,
                   (select sum(FULL_DATA.STORAGE_WORTH_VALUE) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS STORAGE_WORTH_VALUE,
                   (select sum(FULL_DATA.STORAGE_WORTH_QUATITY) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS STORAGE_WORTH_QUATITY,
                   (select sum(FULL_DATA.STORAGE_WORTH_CARPORT) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS STORAGE_WORTH_CARPORT,
                   (select sum(FULL_DATA.SALED_WORTH_VALUE) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS SALED_WORTH_VALUE,
                   (select sum(FULL_DATA.SALED_WORTH_QUATITY) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS SALED_WORTH_QUATITY,
                   (select sum(FULL_DATA.SALED_WORTH_CARPORT) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS SALED_WORTH_CARPORT,
                   (select sum(FULL_DATA.NO_EVIDENCE) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS NO_EVIDENCE,
                   (select sum(FULL_DATA.PLANNING_PERMIT) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS PLANNING_PERMIT,
                   (select sum(FULL_DATA.WORKING_PERMIT) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS WORKING_PERMIT,
                   (select sum(FULL_DATA.PRESALE_PERMIT) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS PRESALE_PERMIT,
                   (select sum(FULL_DATA.COMPLETION_PERMIT) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS COMPLETION_PERMIT,
                   (select sum(FULL_DATA.CARRY_FORWARD_PERMIT) from FULL_DATA start with id=TOTAL.id connect by prior id=PARENT_ID and id!=PARENT_ID) AS CARRY_FORWARD_PERMIT,
                   TOTAL."orderHierarchyCode"
            from FULL_DATA TOTAL
        )
        SELECT
            ID,ORG_NAME,PARENT_ID
             ,to_char(NEWEST_SUPPLY,''FM999,999,999,999,990.00'') as NEWEST_SUPPLY
             ,to_char(TOTAL_DIFERENCE,''FM999,999,999,999,990.00'') as TOTAL_DIFERENCE
             ,to_char(DYNAMIC_TOTAL_WORTH,''FM999,999,999,999,990.00'') as DYNAMIC_TOTAL_WORTH
             ,to_char(SAVING_WORTH,''FM999,999,999,999,990.00'') as SAVING_WORTH
             ,to_char(ROAD_WORTH,''FM999,999,999,999,990.00'') as ROAD_WORTH
             ,to_char(STORAGE_WORTH,''FM999,999,999,999,990.00'')as STORAGE_WORTH
             ,to_char(SALED_WORTH,''FM999,999,999,999,990.00'')as SALED_WORTH
             ,to_char(SURPLUS_WORTH,''FM999,999,999,999,990.00'')as SURPLUS_WORTH
             ,to_char(HAVE_GOT_WORTH,''FM999,999,999,999,990.00'')as HAVE_GOT_WORTH
             ,CASE WHEN HAVE_GOT_WORTH = 0 THEN
                       0
                   ELSE round((SALED_WORTH / HAVE_GOT_WORTH),2)* 100 END||''%'' AS HAVE_GOT_RATE
             ,to_char(SAVING_WORTH_VALUE,''FM999,999,999,999,990.00'')as SAVING_WORTH_VALUE
             ,to_char(SAVING_WORTH_QUATITY,''FM999,999,999,999,990.00'')as SAVING_WORTH_QUATITY
             ,to_char(SAVING_WORTH_CARPORT,''FM999,999,999,999,990.00'')as SAVING_WORTH_CARPORT
             ,to_char(ROAD_WORTH_VALUE,''FM999,999,999,999,990.00'')as ROAD_WORTH_VALUE
             ,to_char(ROAD_WORTH_QUATITY,''FM999,999,999,999,990.00'')as ROAD_WORTH_QUATITY
             ,to_char(ROAD_WORTH_CARPORT,''FM999,999,999,999,990.00'')as ROAD_WORTH_CARPORT
             ,to_char(STORAGE_WORTH_VALUE,''FM999,999,999,999,990.00'')as STORAGE_WORTH_VALUE
             ,to_char(STORAGE_WORTH_QUATITY,''FM999,999,999,999,990.00'')as STORAGE_WORTH_QUATITY
             ,to_char(STORAGE_WORTH_CARPORT,''FM999,999,999,999,990.00'')as STORAGE_WORTH_CARPORT
             ,to_char(SALED_WORTH_VALUE,''FM999,999,999,999,990.00'')as SALED_WORTH_VALUE
             ,to_char(SALED_WORTH_QUATITY,''FM999,999,999,999,990.00'')as SALED_WORTH_QUATITY
             ,to_char(SALED_WORTH_CARPORT,''FM999,999,999,999,990.00'')as SALED_WORTH_CARPORT
             ,to_char(NO_EVIDENCE,''FM999,999,999,999,990.00'')as NO_EVIDENCE
             ,to_char(PLANNING_PERMIT,''FM999,999,999,999,990.00'')as PLANNING_PERMIT
             ,to_char(WORKING_PERMIT,''FM999,999,999,999,990.00'')as WORKING_PERMIT
             ,to_char(PRESALE_PERMIT,''FM999,999,999,999,990.00'')as PRESALE_PERMIT
             ,to_char(COMPLETION_PERMIT,''FM999,999,999,999,990.00'')as COMPLETION_PERMIT
             ,to_char(CARRY_FORWARD_PERMIT,''FM999,999,999,999,990.00'')as CARRY_FORWARD_PERMIT
             ,"orderHierarchyCode"
        FROM SUMMARIZAION
        )a start with a.ID = ''003200000000000000000000000000'' connect by prior a.ID = a.PARENT_ID  order  by tree
    '
    ;
END P_DWM_SUPPLY_SUMMARY_BY_EXCEL;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_TARGET_VALUE_LIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_TARGET_VALUE_LIST" (
    companyid     IN            VARCHAR2,
    stationid     IN            VARCHAR2,
    deptid        IN            VARCHAR2,
    bizcode       IN            VARCHAR2,
    userid        IN            VARCHAR2,
    projectid   IN              VARCHAR2,
    searchparam   IN            VARCHAR2,
    selectCompanyId IN          VARCHAR2,
    info         OUT            SYS_REFCURSOR
) IS
    v_sql         CLOB;
    v_spid             VARCHAR2(200);
    v_where            VARCHAR2(4000):=' and 1=1 ';
    v_projWhere        VARCHAR2(4000):=' where 1=1';
    v_search           VARCHAR2(4000):=' and 1=1 ';
    v_auth_sql         VARCHAR2(4000) :=' where 1=1';
BEGIN
    P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => stationid,
            DEPTID => deptid,
            COMPANYID => companyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
    v_auth_sql:='inner join (
                  select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||'''
                ) ta on ta.orgid=dtw.PROJ_ID';
    if(selectCompanyId is not null )THEN
        v_where:='  AND mp.UNIT_ID in(  select ID from SYS_BUSINESS_UNIT
start with id= '''||selectCompanyId||''' connect by prior id=parent_id)';
    end if;
    if(projectid is not null)THEN
        v_projWhere:=' WHERE s."projId"='''||projectid||'''';
    END if;
    if(searchParam is not null)THEN
        v_search:=' AND (t."version" like ''%'
            || searchparam
            || '%'' or t."projName" like ''%'
            || searchparam
            || '%'')';
    END IF;
    v_sql := '
    SELECT t.*
    FROM (
        select s.*
        from (
            SELECT
                dtw.ID as "id",
                dtw.PROJ_ID as "projId",
                dtw.PROJ_NAME as "projName",
                dtw.TARGET_WORTH_PHASE as "targetWorthPhase",
                dtw.TARGET_WORTH as "targetWorth",
                dtw.REMARK as "remark",
                dtw.APPROVAL_STATUS as "approvalStatus",
                dtw.APPROVER_ID as "approverId",
                to_char(dtw.APPROVAL_TIME, ''yyyy-mm-dd'') as "approvalTime",
                mp.ORDER_HIERARCHY_CODE as "projectCode",
                dtw.WORTH_V as "worthV",
                dtw.CREATED as "created",
                dtw.PREVIOUS_V_WORTH as "previousVWorth",
                dtw.PREVIOUS_V_INCREMENT "previousVIncrement",
                dtw.FULL_V_WORTH as "fullVWorth",
                dtw.FULL_V_INCREMENT as "fullVIncrement",
                dtw.FEASIBILITY_STUDY_V_WORTH as "feasibilityStudyVWorth",
                dtw.FEASIBILITY_STUDY_V_INCREMENT as "feasibilityStudyVIncrement",
                dtw.IS_DELETE as "isDelete",
                dtw.APPROVER as "approver",
                dtwd.TOTAL_SALES_AREA-nvl(dtwd2.CARPORT_WORTH, 0) AS "totalSalesArea",
                dtwd.TOTAL_CARPORT AS "totalCarport",
                to_char(dtw.MODIFIED, ''yyyy-mm-dd'')  AS "modified",
                CASE WHEN dtw.TARGET_WORTH_PHASE = 0 THEN
                ''可研版目标货值''
                WHEN dtw.TARGET_WORTH_PHASE = 10 THEN
                ''全盘开发计划版目标货值''
                WHEN dtw.TARGET_WORTH_PHASE = 20 THEN
                ''动态版目标货值(V''|| dtw.WORTH_V ||''.0)''
                END "version"
            FROM DWM_TARGET_WORTH dtw
            LEFT JOIN DWM_TARGET_WORTH_DTL dtwd ON dtw.ID = dtwd.TARGET_WORTH_ID AND dtwd.OBJ_TYPE = 0
            left join (
                select item.TARGET_WORTH_ID, sum(item.TOTAL_SALES_AREA) CARPORT_WORTH
                from DWM_TARGET_WORTH_DTL item
                where IS_CARPORT = 1
                group by TARGET_WORTH_ID
            ) dtwd2 on dtw.ID = dtwd2.TARGET_WORTH_ID
            ---chenl 20200728调整，非项目维护本身模块，使用项目数据查询SYS_PROJECT表
            LEFT JOIN SYS_PROJECT mp ON dtw.PROJ_ID = mp.ID
           '||v_auth_sql||'
             where dtw.IS_DELETE = 0
            '||v_where||'
        ) s '||v_projWhere||'
    )t
    WHERE 1= 1 AND t."isDelete" = 0
    '||v_search||'
    ORDER BY t."projectCode" ASC,t."targetWorthPhase",t."worthV"';
    insert into TEST(ID, PROJ_NAME, SQL_STR) values (GET_UUID(), 'targetValue', v_sql);
    insert into TEST(ID, PROJ_NAME, SQL_STR) values (GET_UUID(), 'targetValue-user',
                                                     userid||':'||deptid||':'||stationid||':'||companyid);
    commit;
    OPEN info FOR v_sql;
END P_DWM_TARGET_VALUE_LIST;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_TARGET_WORTH_DTL_M
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_TARGET_WORTH_DTL_M" (
    targetWorthId         IN             VARCHAR2 --目标货值id
) AS
--修正目标货值错误数据存储修正。之前数据逻辑存储错误，保存时修改正。临时处理。
--作者：陈丽
--日期：2020/05/09
BEGIN
---复制OBJ_ID  
  update DWM_TARGET_WORTH_DTL a set a.OLD_OBJ_ID=(select OBJ_ID from DWM_TARGET_WORTH_DTL b where a.id=b.id) where target_Worth_Id=targetWorthId;
  commit;
---修正OBJ_PARENT_ID
   update DWM_TARGET_WORTH_DTL a set a.OBJ_PARENT_ID=(select OBJ_PARENT_ID from (SELECT
        d.ID,
        d.OBJ_NAME,
        d.OBJ_ID,
        d.OPERATE_ATTRIBUTE_ID,
        d.OPERATE_ATTRIBUTE_NAME,
        d.TOTAL_BUILD_AREA,
        d.TOTAL_VOLUME_AREA,
        d.TOTAL_SALES_AREA,
        d.GROUND_CAN_SELL_AREA,
        d.UNDERGROUND_CAN_SELL_AREA,
        d.TOTAL_CARPORT,
        d.GROUND_CARPORT,
        d.UNDERGROUND_CARPORT,
        d.AVERAGE_PRICE,
        d.WORTH,
        d.TARGET_WORTH_ID,
        d.OBJ_TYPE,
        d.CREATOR_ID,
        d.CREATED,
        d.CREATOR,
        d.MODIFIED,
        d.MODIFIER_ID,
        d.MODIFIER,
        d.OBJ_PHASE_ID,
        CASE WHEN d.OBJ_TYPE = 0 THEN
        NULL
        WHEN d.OBJ_TYPE = 10 THEN
        mp2.PROJECT_ID
        WHEN d.OBJ_TYPE = 20 THEN
        mpv.PROJECT_ID
        WHEN d.OBJ_TYPE = 30 THEN
        mb.PERIOD_ID
        ELSE d.OBJ_ID
        END  OBJ_PARENT_ID
        FROM DWM_TARGET_WORTH_DTL d
        LEFT JOIN MDM_PROJECT mp1 ON d.OBJ_ID = mp1.ID
        LEFT JOIN MDM_PARCEL mp2 ON d.OBJ_ID = mp2.ID
        LEFT JOIN MDM_PERIOD mp3 ON d.OBJ_ID = mp3.ID
        LEFT JOIN MDM_PERIOD_VERSION mpv ON mpv.ID = mp3.PERIOD_VERSION_ID
        AND mpv.APPROVAL_STATUS = '已审核'
        LEFT JOIN MDM_BUILD mb ON d.OBJ_ID = mb.ID) b where a.id=b.id) where target_Worth_Id=targetWorthId;
   commit;

---修正OBJ_ID  
  update DWM_TARGET_WORTH_DTL a set a.OBJ_ID=(select id from MDM_BUILD_PRODUCT_TYPE b where a.OBJ_NAME=b.PRODUCT_TYPE_NAME) 
  where target_Worth_Id=targetWorthId and a.OBJ_TYPE=40;
  commit;
END P_DWM_TARGET_WORTH_DTL_M;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_TARGET_WORTH_RECOUNT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_TARGET_WORTH_RECOUNT" (
    targetWorthId         IN             VARCHAR2 --目标货值id
) AS
--目标货值重新计算
--作者：陈丽
--日期：2020/05/09
BEGIN
RETURN;
--with 计算 as(select (case when obj_type=40 then average_price else 0 end) as average_price_temp,
--    (case when obj_type=40 then nvl(average_price*(TOTAL_CARPORT+GROUND_CAN_SELL_AREA),0) else 0 end) as worth_temp,
--    id,target_worth_id,
--    worth_dtl_id,
--    worth_dtl_parent_id from DWM_TARGET_WORTH_DTL)
--
-- , 汇总 as( select s.*
-- ,(SELECT SUM(worth_temp) FROM 计算 START WITH ID=S.ID CONNECT BY PRIOR ID=obj_parent_id ) AS  worth_yuan
-- from 计算 s)
--
--SELECT 汇总.*
--,CASE WHEN (TOTAL_CARPORT+GROUND_CAN_SELL_AREA)=0 THEN 0 ELSE worth_yuan/(TOTAL_CARPORT+GROUND_CAN_SELL_AREA) END AS average_price
--,WORTH_yuan/10000 AS "worth"
--FROM 汇总;

END P_DWM_TARGET_WORTH_RECOUNT;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_TARGET_WORTH_REF
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_TARGET_WORTH_REF" (
    USERID   IN   VARCHAR2,
    STATIONID    IN  VARCHAR2,
    DEPTID   IN   VARCHAR2,
    COMPANYID IN VARCHAR2,
    i_projectId    IN               VARCHAR2,---项目id
    i_target_worth_phase    IN               VARCHAR2:=0 ---货值阶段（0：可研版目标货值，10：全盘开发计划版目标货值，20：动态版目标货值）
    ,o_target_worth out  SYS_REFCURSOR
) AS
		--获取目标货值。可研版本货值,全盘版本目标货值，动态版本目标货值（只是获取，未到数据库）
        --调用范围：货值管理系统目标货值刷新
		--作者：陈丽
		--日期：2020-06-14
l_created date:=sysdate;
l_UUID varchar2(36):=GET_UUID();
BEGIN
open o_TARGET_WORTH for
with 
-------------------------------------------=======对象基本信息，项目，分期，楼栋
obj_base as(
select id as obj_id,PROJECT_NAME as obj_name,UNIT_ID as parent_id,'项目' as objtype from sys_project obj_base where id=i_projectId
union all
select * from(
select id as obj_id,STAGE_NAME as obj_name,project_id  as parent_id,'分期' as objtype from sys_project_stage where project_id=i_projectId order by LPAD(ORDER_CODE,8,'0')
)union all
select id as obj_id,BUILD_NAME as obj_name,period_id  as parent_id,'楼栋' as objtype from sys_build where PROJ_ID=i_projectId
),
-------------------------------------------=======已审核的对象阶段实例 状态（10：激活（未审核）；15：审核中，19：已审核；20：已成完成（即创建了下一个版本）
obj_phase as(
select pp.ID as instance_id,pp.PROJ_ID as obj_id,proj.PROJECT_NAME as obj_name,mp.PHASE_NAME,mp.PHASE_ORDER,'项目' as objtype from MDM_PROJECT_PHASE  pp
left join mdm_phase mp on pp.PHASE_ID=mp.id
left join sys_project proj on pp.PROJ_ID=proj.id
--审核或者已创建下一阶段
where pp.PROJ_ID=i_projectId and (PHASE_STATE=19 or PHASE_STATE=20)
union all
select p.ID as  instance_id,p.PERIOD_ID as obj_id,stage.STAGE_NAME as obj_name,mp.PHASE_NAME,mp.PHASE_ORDER ,'分期' as objtype from MDM_PERIOD_PHASE p
left join sys_project_stage stage on p.PERIOD_ID=stage.id
left join mdm_phase mp on p.PHASE_ID=mp.id
--审核或者已创建下一阶段
where stage.project_id=i_projectId and (PHASE_STATE=19 or PHASE_STATE=20)
union all
select b.ID as instance_id,b.BUILD_ID as obj_id,build.BUILD_NAME as obj_name,mp.PHASE_NAME,mp.PHASE_ORDER ,'楼栋' as objtype from MDM_BUILD_PHASE b
left join sys_build build on b.BUILD_ID=build.id
left join sys_project proj on build.PROJ_ID=proj.id
left join mdm_phase mp on b.PHASE_ID=mp.id
--审核或者已创建下一阶段
where proj.id=i_projectId and (PHASE_STATE=19 or PHASE_STATE=20) 
),
-------------------------------------------=======最新已审核阶段实例
obj_new_phase as
(
select * from (select obj_phase.*,row_number() over(partition by obj_id order by PHASE_ORDER desc) as order_num from obj_phase )obj_phase_order where order_num = 1
),
-------------------------------------------=======最新已审核目标货值--用于新增引入上一个已审核单价
latest_target_worth as
(select * from (select latest_tw.*,row_number() over(partition by OBJ_ID,obj_parent_id order by target_worth_phase,worth_v desc) as order_num from 
(select dtl.OBJ_ID,dtl.AVERAGE_PRICE,dtl.obj_parent_id,worth_v,target_worth_phase,dtl.obj_name 
,dtl.WORTH_DTL_PARENT_ID,dtl.WORTH_DTL_ID
from DWM_TARGET_WORTH_DTL dtl
left join DWM_TARGET_WORTH  w on dtl.TARGET_WORTH_ID=w.id
left join DWM_TARGET_WORTH_DTL parentdtl on dtl.obj_parent_id=parentdtl.obj_id
--已审核并且等于业态的
where  approval_status='已审核' and dtl.OBJ_TYPE=40  and w.proj_id =i_projectId) latest_tw
)obj_phase_order where order_num = 1
),
-------------------------------------------=======查询可研版本---查询可研版本---查询可研版本---查询可研版本---查询可研版本---查询可研版本
可研版本对象 as (
select  obj_base.obj_id||l_UUID as id,
        '可研版本' 类型,
        PHASE_NAME,
        obj_base.obj_name as OBJ_NAME,
        ph.obj_id as OBJ_ID,
        '' as OPERATE_ATTRIBUTE_ID,
        '' as OPERATE_ATTRIBUTE_NAME,
        0 as TOTAL_BUILD_AREA,
        0 as TOTAL_VOLUME_AREA,--'总计容面积'
        0 as TOTAL_SALES_AREA,---'总可售面积';
        0 as GROUND_CAN_SELL_AREA,--GROUND_CAN_SELL_AREA" IS '地上可售面积';
        0 as UNDERGROUND_CAN_SELL_AREA,-- IS '地下可售面积';
        0  as TOTAL_CARPORT,--'总车位数';
        0 as GROUND_CARPORT,-- '地上车位数';
        0 as UNDERGROUND_CARPORT,-- '地下车位数';
        ------0 AVERAGE_PRICE,-- '均价（手动录入）'
        ------0 WORTH,-- '均价（手动录入）'
        l_UUID as TARGET_WORTH_ID,--'货值主键';
       case when ph.objtype='项目' then 0 
        when  ph.objtype='分期' then 20 
        when ph.objtype='楼栋' then 30 end as
        OBJ_TYPE,-- '对象类型（0：项目；20：分期；30：楼栋;40业态）';
        ph.instance_id as OBJ_PHASE_ID,
        obj_base.parent_id||l_UUID as WORTH_DTL_PARENT_ID,obj_base.obj_id  as OBJ_PARENT_ID,
        '' as PRODUCT_TYPE_ID
from obj_base obj_base
--所有阶段
left join obj_phase ph on obj_base.obj_id=ph.obj_id
--阶段指标
--left join MDM_OBJ_PHASE_INDEX pIndex on ph.instance_id =pIndex.OBJ_PHASE_ID
--只查询可研版本计划
where  ph.phase_name='可研版' and obj_base.objtype='项目' 
)

,可研版本业态 as (
---查询项目业态指标
 select 
        pIndex.id id,
         '可研版本' 类型,
         PHASE_NAME,
        pIndex.product_type_name as OBJ_NAME,
        pIndex.product_type_id as OBJ_ID,
        pIndex.OPERATE_ATTRIBUTE_ID as OPERATE_ATTRIBUTE_ID,
        pIndex.OPERATE_ATTRIBUTE_NAME as OPERATE_ATTRIBUTE_NAME,
        pIndex.GROUND_TOTAL_BUILD_AREA+pIndex.UNDERGROUND_TOTAL_BUILD_AREA as TOTAL_BUILD_AREA,
        pIndex.GROUND_CAPACITY_AREA+pIndex.UNDERGROUND_CAPACITY_AREA as TOTAL_VOLUME_AREA,--'总计容面积'
        pIndex.TOTAL_SALE_AREA as TOTAL_SALES_AREA,---'总可售面积';
        pIndex.GROUND_SALE_AREA as GROUND_CAN_SELL_AREA,--GROUND_CAN_SELL_AREA" IS '地上可售面积';
        pIndex.UNDERGROUND_SALE_AREA as UNDERGROUND_CAN_SELL_AREA,-- IS '地下可售面积';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT  as TOTAL_CARPORT,--'总车位数';
        0 as GROUND_CARPORT,-- '地上车位数';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT as UNDERGROUND_CARPORT,-- '地下车位数';
        ------0 AVERAGE_PRICE,-- '均价（手动录入）'
         ------0 WORTH,-- '均价（手动录入）'
        l_UUID as TARGET_WORTH_ID,--'货值主键';
        40 OBJ_TYPE,-- '对象类型（0：项目；20：分期；30：楼栋40业态）';
        可研版本对象.OBJ_PHASE_ID as OBJ_PHASE_ID,
        可研版本对象.id as WORTH_DTL_PARENT_ID,
        可研版本对象.OBJ_ID as OBJ_PARENT_ID,
        pIndex.PRODUCT_TYPE_ID
--业态指标
from MDM_OBJ_PHASE_PT_INDEX pIndex 
left join 可研版本对象 可研版本对象 on pIndex.OBJ_PHASE_ID=可研版本对象.OBJ_PHASE_ID
--只查询可研 分期业态指标。
where (可研版本对象.OBJ_TYPE=0 ) 
--and 可研版本对象.id is not null
--只查询可研阶段 项目的业态指标。
--where  ph.phase_name='可研版' and ph.objtype='项目' 
),


-------------------------------------------=======全盘版本---全盘版本---全盘版本---全盘版本---全盘版本---全盘版本---全盘版本
---项目和分期
全盘版本对象 as (
select  obj_base.obj_id||l_UUID as id,
        '全盘版本' 类型,
        PHASE_NAME,
        obj_base.obj_name as OBJ_NAME,
        obj_base.obj_id as OBJ_ID,
        '' as OPERATE_ATTRIBUTE_ID,
        '' as OPERATE_ATTRIBUTE_NAME,
        0 as TOTAL_BUILD_AREA,
        0 as TOTAL_VOLUME_AREA,--'总计容面积'
        0 as TOTAL_SALES_AREA,---'总可售面积';
        0 as GROUND_CAN_SELL_AREA,--GROUND_CAN_SELL_AREA" IS '地上可售面积';
        0 as UNDERGROUND_CAN_SELL_AREA,-- IS '地下可售面积';
        0  as TOTAL_CARPORT,--'总车位数';
        0 as GROUND_CARPORT,-- '地上车位数';
        0 as UNDERGROUND_CARPORT,-- '地下车位数';
        ------0 AVERAGE_PRICE,-- '均价（手动录入）'
         ------0 WORTH,-- '均价（手动录入）'
        l_UUID as TARGET_WORTH_ID,--'货值主键';
         case when ph.objtype='项目' then 0 
        when  ph.objtype='分期' then 20 
        when  ph.objtype='楼栋' then 30 end as
        OBJ_TYPE,-- '对象类型（0：项目；20：分期；30：楼栋;40业态）';
        ph.instance_id as OBJ_PHASE_ID,
        obj_base.parent_id||l_UUID as WORTH_DTL_PARENT_ID ,obj_base.obj_id as OBJ_PARENT_ID,
       '' as PRODUCT_TYPE_ID
from obj_base obj_base
--所有阶段
left join obj_phase ph on obj_base.obj_id=ph.obj_id
--阶段指标
--left join MDM_OBJ_PHASE_INDEX pIndex on ph.instance_id =pIndex.OBJ_PHASE_ID
--只查询全盘计划版 项目和分期指标。
where  ph.phase_name='全盘计划版' and (ph.objtype='项目' or ph.objtype='分期' ) and obj_base.objtype<>'楼栋' ) 

,全盘版本业态 as (
---查询项目业态指标
 select 
        pIndex.id,
         '全盘版本' 类型,
         PHASE_NAME,
        pIndex.product_type_name as OBJ_NAME,
        pIndex.product_type_id as OBJ_ID,
        pIndex.OPERATE_ATTRIBUTE_ID as OPERATE_ATTRIBUTE_ID,
        pIndex.OPERATE_ATTRIBUTE_NAME as OPERATE_ATTRIBUTE_NAME,
        pIndex.GROUND_TOTAL_BUILD_AREA+pIndex.UNDERGROUND_TOTAL_BUILD_AREA as TOTAL_BUILD_AREA,
        pIndex.GROUND_CAPACITY_AREA+pIndex.UNDERGROUND_CAPACITY_AREA as TOTAL_VOLUME_AREA,--'总计容面积'
        pIndex.TOTAL_SALE_AREA as TOTAL_SALES_AREA,---'总可售面积';
        pIndex.GROUND_SALE_AREA as GROUND_CAN_SELL_AREA,--GROUND_CAN_SELL_AREA" IS '地上可售面积';
        pIndex.UNDERGROUND_SALE_AREA as UNDERGROUND_CAN_SELL_AREA,-- IS '地下可售面积';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT  as TOTAL_CARPORT,--'总车位数';
        0 as GROUND_CARPORT,-- '地上车位数';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT as UNDERGROUND_CARPORT,-- '地下车位数';
        ------0 AVERAGE_PRICE,-- '均价（手动录入）'
         ------0 WORTH,-- '均价（手动录入）'
        l_UUID as TARGET_WORTH_ID,--'货值主键';
        40 OBJ_TYPE,-- '对象类型（0：项目；20：分期；30：楼栋40业态）';
        全盘版本对象.OBJ_PHASE_ID as OBJ_PHASE_ID,
        全盘版本对象.id as WORTH_DTL_PARENT_ID ,
        全盘版本对象.OBJ_ID as OBJ_PARENT_ID,
        pIndex.PRODUCT_TYPE_ID

from  MDM_OBJ_PHASE_PT_INDEX pIndex 
left join 全盘版本对象 全盘版本对象 on pIndex.OBJ_PHASE_ID=全盘版本对象.OBJ_PHASE_ID
--只查询全盘计划版 分期业态指标。
where (全盘版本对象.OBJ_TYPE=20 )
)
,
-------------------------------------------=======动态版本---动态版本---动态版本---动态版本---动态版本---动态版本---动态版本
---项目和分期和楼栋,获取最新已审核阶段的数据
动态版本对象base as (
---查询主数据项目，分期，楼栋最新阶段的指标
select  obj_base.obj_id||l_UUID as id,
        '动态版本' 类型,
        newph.PHASE_NAME,
        obj_base.obj_name as OBJ_NAME,
        obj_base.obj_id as OBJ_ID,
        '' as OPERATE_ATTRIBUTE_ID,
        '' as OPERATE_ATTRIBUTE_NAME,
        0 as TOTAL_BUILD_AREA,
        0 as TOTAL_VOLUME_AREA,--'总计容面积'
        0 as TOTAL_SALES_AREA,---'总可售面积';
        0 as GROUND_CAN_SELL_AREA,--GROUND_CAN_SELL_AREA" IS '地上可售面积';
        0 as UNDERGROUND_CAN_SELL_AREA,-- IS '地下可售面积';
        0  as TOTAL_CARPORT,--'总车位数';
        0 as GROUND_CARPORT,-- '地上车位数';
        0 as UNDERGROUND_CARPORT,-- '地下车位数';
        ------0 AVERAGE_PRICE,-- '均价（手动录入）'
         ------0 WORTH,-- '均价（手动录入）'
        l_UUID as TARGET_WORTH_ID,--'货值主键';
        case when newph.objtype='项目' then 0 
        when  newph.objtype='分期' then 20 
        when  newph.objtype='楼栋' then 30 end as
        OBJ_TYPE,-- '对象类型（0：项目；20：分期；30：楼栋;40业态）';
        newph.instance_id as OBJ_PHASE_ID,
        obj_base.parent_id||l_UUID as WORTH_DTL_PARENT_ID ,
        obj_base.obj_id as OBJ_PARENT_ID,
       '' as PRODUCT_TYPE_ID
from obj_base obj_base
--最新阶段
left join obj_new_phase newph on obj_base.obj_id=newph.obj_id
--最新阶段指标
--left join MDM_OBJ_PHASE_INDEX pIndex on newph.instance_id =pIndex.OBJ_PHASE_ID
)
--动态可研或全盘阶段 项目和分期
,动态可研或全盘阶段 as (select * from 动态版本对象base where (obj_type=20 and PHASE_NAME='全盘计划版') 
or (obj_type=0 and PHASE_NAME='可研版') )
--去掉可研全盘版基础对象的子级（分期或楼栋）
,动态版本对象 as (select base.* from 动态版本对象base base
left join 动态可研或全盘阶段 d on base.WORTH_DTL_PARENT_ID=d.id
where d.id is null
)

,动态版本业态 as (
---查询项目业态指标
 select 
        pIndex.id,
        '动态版本' 类型,
        动态版本对象.PHASE_NAME,
        pIndex.product_type_name as OBJ_NAME,
        pIndex.product_type_id as OBJ_ID,
        pIndex.OPERATE_ATTRIBUTE_ID as OPERATE_ATTRIBUTE_ID,
        pIndex.OPERATE_ATTRIBUTE_NAME as OPERATE_ATTRIBUTE_NAME,
        pIndex.GROUND_TOTAL_BUILD_AREA+pIndex.UNDERGROUND_TOTAL_BUILD_AREA as TOTAL_BUILD_AREA,--总建筑面积
        pIndex.GROUND_CAPACITY_AREA+pIndex.UNDERGROUND_CAPACITY_AREA as TOTAL_VOLUME_AREA,--'总计容面积'
        pIndex.TOTAL_SALE_AREA as TOTAL_SALES_AREA,---'总可售面积';
        pIndex.GROUND_SALE_AREA as GROUND_CAN_SELL_AREA,--GROUND_CAN_SELL_AREA" IS '地上可售面积';
        pIndex.UNDERGROUND_SALE_AREA as UNDERGROUND_CAN_SELL_AREA,-- IS '地下可售面积';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT  as TOTAL_CARPORT,--'总车位数';
        0 as GROUND_CARPORT,-- '地上车位数';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT as UNDERGROUND_CARPORT,-- '地下车位数';
        ------0 AVERAGE_PRICE,-- '均价（手动录入）'
        ------0 WORTH,-- '均价（手动录入）'
        l_UUID as TARGET_WORTH_ID,--'货值主键';
        40 OBJ_TYPE,-- '对象类型（0：项目；20：分期；30：楼栋40业态）';
        动态版本对象.OBJ_PHASE_ID as OBJ_PHASE_ID,
        动态版本对象.id as WORTH_DTL_PARENT_ID, 
        动态版本对象.OBJ_ID as OBJ_PARENT_ID,
        pIndex.PRODUCT_TYPE_ID
        from MDM_OBJ_PHASE_PT_INDEX pIndex
        left join 动态版本对象 动态版本对象  on pIndex.OBJ_PHASE_ID=动态版本对象.OBJ_PHASE_ID
        where (动态版本对象.OBJ_TYPE=30 or
        pindex.OBJ_PHASE_ID in (select OBJ_PHASE_ID from 动态可研或全盘阶段) )
)


,基础对象 as ( -----可研
        -----可研
        select * from 可研版本对象 where 1=case when i_target_worth_phase=0 then 1 else 0 end
        -----全盘
        union all
        select * from 全盘版本对象 where 1=case when i_target_worth_phase=10 then 1 else 0 end
        ---动态
        union all
        select * from 动态版本对象 where 1=case when i_target_worth_phase=20 then 1 else 0 end
       )

,基础业态 as ( select pv.*,nvl(lw.AVERAGE_PRICE,0) as AVERAGE_PRICE_temp
,nvl(lw.AVERAGE_PRICE*(pv.TOTAL_CARPORT+pv.GROUND_CAN_SELL_AREA),0) as WORTH_temp
from (     
        -----可研
        select * from 可研版本业态 where 1=case when i_target_worth_phase=0 then 1 else 0 end
        -----全盘
        union all
        select * from 全盘版本业态 where 1=case when i_target_worth_phase=10 then 1 else 0 end
        ---动态
        union all
        select * from 动态版本业态 where 1=case when i_target_worth_phase=20 then 1 else 0 end

        ) pv left join latest_target_worth lw 
        on pv.OBJ_ID=lw.OBJ_ID and pv.obj_parent_id=lw.obj_parent_id)
        
,树结构 as(
select  基础对象.*,0 as AVERAGE_PRICE_temp, 0 as WORTH_temp from  基础对象 
union all
select * from 基础业态)


,汇总数据 as (
select GET_UUID() AS "id"
,TARGET_WORTH_ID AS "targetWorthId"
,PHASE_NAME AS "phaseName"
,类型 AS "类型"
,id as "worthDtlId"---【WORTH_DTL_ID】树id
,WORTH_DTL_PARENT_ID AS "worthDtlParentId"----【WORTH_DTL_PARENT_ID】 树父级id
,OBJ_PHASE_ID AS "objPhaseId"----"DWM_TARGET_WORTH_DTL"."OBJ_PHASE_ID" IS '对象阶段id';
,OBJ_PARENT_ID AS "objParentId"--"DWM_TARGET_WORTH_DTL"."OBJ_PARENT_ID" IS '对象父级id';
,OPERATE_ATTRIBUTE_NAME AS "operateAttributeName"---"DWM_TARGET_WORTH_DTL"."OPERATE_ATTRIBUTE_NAME" IS '经营属性名称';
,OBJ_NAME AS "objName"----"DWM_TARGET_WORTH_DTL"."OBJ_NAME" IS '对象名称（项目名称、分期名称、业态名称）';
,OBJ_ID AS "objId"----"DWM_TARGET_WORTH_DTL"."OBJ_ID" IS '对象id';
,OBJ_TYPE AS "objType"---."DWM_TARGET_WORTH_DTL"."OBJ_TYPE" IS '对象类型（0：项目；20：分期；30：楼栋40业态）';
,OPERATE_ATTRIBUTE_ID AS "operateAttributeId"---."DWM_TARGET_WORTH_DTL"."OPERATE_ATTRIBUTE_ID" IS '经营属性Id';
,(
SELECT SUM(TOTAL_BUILD_AREA) FROM 树结构
START WITH ID=S.ID CONNECT BY PRIOR ID=WORTH_DTL_PARENT_ID) "totalBuildArea"
,(SELECT sum(TOTAL_VOLUME_AREA) FROM 树结构
START WITH ID=S.ID CONNECT BY PRIOR ID=WORTH_DTL_PARENT_ID) AS "totalVolumeArea"----"DWM_TARGET_WORTH_DTL"."TOTAL_VOLUME_AREA" IS '总计容面积';
,(SELECT sum(GROUND_CAN_SELL_AREA) FROM 树结构
START WITH ID=S.ID CONNECT BY PRIOR ID=WORTH_DTL_PARENT_ID) AS "groundCanSellArea"--"DWM_TARGET_WORTH_DTL"."GROUND_CAN_SELL_AREA" IS '地上可售面积';
,(SELECT sum(GROUND_CARPORT)  FROM 树结构
START WITH ID=S.ID CONNECT BY PRIOR ID=WORTH_DTL_PARENT_ID) "groundCarport"---"DWM_TARGET_WORTH_DTL"."GROUND_CARPORT" IS '地上车位数';
,(SELECT sum(UNDERGROUND_CARPORT) FROM 树结构
START WITH ID=S.ID CONNECT BY PRIOR ID=WORTH_DTL_PARENT_ID) AS "undergroundCarport"---"DWM_TARGET_WORTH_DTL"."UNDERGROUND_CARPORT" IS '地下车位数';
,(SELECT sum(TOTAL_CARPORT) FROM 树结构
START WITH ID=S.ID CONNECT BY PRIOR ID=WORTH_DTL_PARENT_ID) AS "totalCarport"---"DWM_TARGET_WORTH_DTL"."TOTAL_CARPORT" IS '总车位数';
,(SELECT sum(TOTAL_SALES_AREA) FROM 树结构
START WITH ID=S.ID CONNECT BY PRIOR ID=WORTH_DTL_PARENT_ID) AS "totalSalesArea"----."DWM_TARGET_WORTH_DTL"."TOTAL_SALES_AREA" IS '总可售面积';
,(SELECT sum(UNDERGROUND_CAN_SELL_AREA) FROM 树结构
START WITH ID=S.ID CONNECT BY PRIOR ID=WORTH_DTL_PARENT_ID) AS "undergroundCanSellArea"--"DWM_TARGET_WORTH_DTL"."UNDERGROUND_CAN_SELL_AREA" IS '地下可售面积';
,(SELECT sum(WORTH_temp) FROM 树结构
START WITH ID=S.ID CONNECT BY PRIOR ID=WORTH_DTL_PARENT_ID) AS WORTH_yuan
,AVERAGE_PRICE_temp,WORTH_temp
--,CASE WHEN (TOTAL_CARPORT+GROUND_CAN_SELL_AREA)=0 THEN 0 ELSE WORTH_yuan/(TOTAL_CARPORT+GROUND_CAN_SELL_AREA) END AS "averagePrice"---"DWM_TARGET_WORTH_DTL"."AVERAGE_PRICE" IS '均价（手动录入）';
--,WORTH_yuan/10000 AS "worth"----"DWM_TARGET_WORTH_DTL"."WORTH" IS '货值';
--,pt.is_carport as "isCarport"---"DWM_TARGET_WORTH_DTL"."IS_CARPORT" IS '是否车位,1:是,0:否';
from 树结构 s)

select 汇总数据.*,CASE WHEN ("totalCarport"+"groundCanSellArea")=0 THEN 0 ELSE WORTH_yuan/("totalCarport"+"groundCanSellArea") END
AS "averagePrice"---"DWM_TARGET_WORTH_DTL"."AVERAGE_PRICE" IS '均价（手动录入）';
,WORTH_yuan/10000 AS "worth"----"DWM_TARGET_WORTH_DTL"."WORTH" IS '货值';
,pt.is_carport as "isCarport"---"DWM_TARGET_WORTH_DTL"."IS_CARPORT" IS '是否车位,1:是,0:否';
,WORTH_yuan
FROM 汇总数据
left join MDM_BUILD_PRODUCT_TYPE pt on 汇总数据."objId"=pt.id
;
--left join MDM_BUILD_PRODUCT_TYPE pt on 汇总.PRODUCT_TYPE_ID=pt.id
 
END P_DWM_TARGET_WORTH_REF;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_TARGET_WORTH_REF1
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_TARGET_WORTH_REF1" (
    USERID   IN   VARCHAR2,
    STATIONID    IN  VARCHAR2,
    DEPTID   IN   VARCHAR2,
    COMPANYID IN VARCHAR2,
    i_projectId    IN               VARCHAR2,---项目id
    i_target_worth_phase    IN               VARCHAR2:=0 ---货值阶段（0：可研版目标货值，10：全盘开发计划版目标货值，20：动态版目标货值）
    ,o_target_worth out  SYS_REFCURSOR
) AS
		--获取目标货值。可研版本货值,全盘版本目标货值，动态版本目标货值（只是获取，未到数据库）
        --调用范围：货值管理系统目标货值刷新
		--作者：陈丽
		--日期：2020-06-14
l_created date:=sysdate;
l_UUID varchar2(36):=GET_UUID();
BEGIN
open o_TARGET_WORTH for
with 
-------------------------------------------=======对象基本信息，项目，分期，楼栋
obj_base as(
select id as obj_id,PROJECT_NAME as obj_name,UNIT_ID as parent_id,'项目' as objtype from sys_project obj_base where id=i_projectId
union all
select id as obj_id,STAGE_NAME as obj_name,project_id  as parent_id,'分期' as objtype from sys_project_stage where project_id=i_projectId
union all
select id as obj_id,BUILD_NAME as obj_name,period_id  as parent_id,'楼栋' as objtype from sys_build where PROJ_ID=i_projectId
),
-------------------------------------------=======已审核的对象阶段实例 状态（10：激活（未审核）；15：审核中，19：已审核；20：已成完成（即创建了下一个版本）
obj_phase as(
select pp.ID as instance_id,pp.PROJ_ID as obj_id,proj.PROJECT_NAME as obj_name,mp.PHASE_NAME,mp.PHASE_ORDER,'项目' as objtype from MDM_PROJECT_PHASE  pp
left join mdm_phase mp on pp.PHASE_ID=mp.id
left join sys_project proj on pp.PROJ_ID=proj.id
--审核或者已创建下一阶段
where pp.PROJ_ID=i_projectId and (PHASE_STATE=19 or PHASE_STATE=20)
union all
select p.ID as  instance_id,p.PERIOD_ID as obj_id,stage.STAGE_NAME as obj_name,mp.PHASE_NAME,mp.PHASE_ORDER ,'分期' as objtype from MDM_PERIOD_PHASE p
left join sys_project_stage stage on p.PERIOD_ID=stage.id
left join mdm_phase mp on p.PHASE_ID=mp.id
--审核或者已创建下一阶段
where stage.project_id=i_projectId and (PHASE_STATE=19 or PHASE_STATE=20)
union all
select b.ID as instance_id,b.BUILD_ID as obj_id,build.BUILD_NAME as obj_name,mp.PHASE_NAME,mp.PHASE_ORDER ,'楼栋' as objtype from MDM_BUILD_PHASE b
left join sys_build build on b.BUILD_ID=build.id
left join sys_project proj on build.PROJ_ID=proj.id
left join mdm_phase mp on b.PHASE_ID=mp.id
--审核或者已创建下一阶段
where proj.id=i_projectId and (PHASE_STATE=19 or PHASE_STATE=20) 
),
-------------------------------------------=======最新已审核阶段实例
obj_new_phase as
(
select * from (select obj_phase.*,row_number() over(partition by obj_id order by PHASE_ORDER desc) as order_num from obj_phase )obj_phase_order where order_num = 1
),
-------------------------------------------=======最新已审核目标货值--用于新增引入上一个已审核单价
latest_target_worth as
(select * from (select latest_tw.*,row_number() over(partition by OBJ_ID,obj_parent_id order by target_worth_phase,worth_v desc) as order_num from 
(select dtl.OBJ_ID,dtl.AVERAGE_PRICE,dtl.obj_parent_id,worth_v,target_worth_phase,dtl.obj_name 
,dtl.WORTH_DTL_PARENT_ID,dtl.WORTH_DTL_ID
from DWM_TARGET_WORTH_DTL dtl
left join DWM_TARGET_WORTH  w on dtl.TARGET_WORTH_ID=w.id
left join DWM_TARGET_WORTH_DTL parentdtl on dtl.obj_parent_id=parentdtl.obj_id
--已审核并且等于业态的
where  approval_status='已审核' and dtl.OBJ_TYPE=40  and w.proj_id =i_projectId) latest_tw
)obj_phase_order where order_num = 1
),
-------------------------------------------=======查询可研版本---查询可研版本---查询可研版本---查询可研版本---查询可研版本---查询可研版本
可研版本对象 as (
select  obj_base.obj_id||l_UUID as id,
        '可研版本' 类型,
        PHASE_NAME,
        obj_base.obj_name as OBJ_NAME,
        ph.obj_id as OBJ_ID,
        '' as OPERATE_ATTRIBUTE_ID,
        '' as OPERATE_ATTRIBUTE_NAME,
        0 as TOTAL_BUILD_AREA,
        0 as TOTAL_VOLUME_AREA,--'总计容面积'
        0 as TOTAL_SALES_AREA,---'总可售面积';
        0 as GROUND_CAN_SELL_AREA,--GROUND_CAN_SELL_AREA" IS '地上可售面积';
        0 as UNDERGROUND_CAN_SELL_AREA,-- IS '地下可售面积';
        0  as TOTAL_CARPORT,--'总车位数';
        0 as GROUND_CARPORT,-- '地上车位数';
        0 as UNDERGROUND_CARPORT,-- '地下车位数';
        ------0 AVERAGE_PRICE,-- '均价（手动录入）'
        ------0 WORTH,-- '均价（手动录入）'
        l_UUID as TARGET_WORTH_ID,--'货值主键';
       case when ph.objtype='项目' then 0 
        when  ph.objtype='分期' then 20 
        when ph.objtype='楼栋' then 30 end as
        OBJ_TYPE,-- '对象类型（0：项目；20：分期；30：楼栋;40业态）';
        ph.instance_id as OBJ_PHASE_ID,
        obj_base.parent_id||l_UUID as WORTH_DTL_PARENT_ID,obj_base.obj_id  as OBJ_PARENT_ID,
        '' as PRODUCT_TYPE_ID
from obj_base obj_base
--所有阶段
left join obj_phase ph on obj_base.obj_id=ph.obj_id
--阶段指标
--left join MDM_OBJ_PHASE_INDEX pIndex on ph.instance_id =pIndex.OBJ_PHASE_ID
--只查询可研版本计划
where  ph.phase_name='可研版' and obj_base.objtype='项目' 
)

,可研版本业态 as (
---查询项目业态指标
 select 
        pIndex.id id,
         '可研版本' 类型,
         PHASE_NAME,
        pIndex.product_type_name as OBJ_NAME,
        pIndex.product_type_id as OBJ_ID,
        pIndex.OPERATE_ATTRIBUTE_ID as OPERATE_ATTRIBUTE_ID,
        pIndex.OPERATE_ATTRIBUTE_NAME as OPERATE_ATTRIBUTE_NAME,
        pIndex.GROUND_TOTAL_BUILD_AREA+pIndex.UNDERGROUND_TOTAL_BUILD_AREA as TOTAL_BUILD_AREA,
        pIndex.GROUND_CAPACITY_AREA+pIndex.UNDERGROUND_CAPACITY_AREA as TOTAL_VOLUME_AREA,--'总计容面积'
        pIndex.TOTAL_SALE_AREA as TOTAL_SALES_AREA,---'总可售面积';
        pIndex.GROUND_SALE_AREA as GROUND_CAN_SELL_AREA,--GROUND_CAN_SELL_AREA" IS '地上可售面积';
        pIndex.UNDERGROUND_SALE_AREA as UNDERGROUND_CAN_SELL_AREA,-- IS '地下可售面积';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT  as TOTAL_CARPORT,--'总车位数';
        0 as GROUND_CARPORT,-- '地上车位数';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT as UNDERGROUND_CARPORT,-- '地下车位数';
        ------0 AVERAGE_PRICE,-- '均价（手动录入）'
         ------0 WORTH,-- '均价（手动录入）'
        l_UUID as TARGET_WORTH_ID,--'货值主键';
        40 OBJ_TYPE,-- '对象类型（0：项目；20：分期；30：楼栋40业态）';
        可研版本对象.OBJ_PHASE_ID as OBJ_PHASE_ID,
        可研版本对象.id as WORTH_DTL_PARENT_ID,
        可研版本对象.OBJ_ID as OBJ_PARENT_ID,
        pIndex.PRODUCT_TYPE_ID
--业态指标
from MDM_OBJ_PHASE_PT_INDEX pIndex 
left join 可研版本对象 可研版本对象 on pIndex.OBJ_PHASE_ID=可研版本对象.OBJ_PHASE_ID
--只查询可研 分期业态指标。
where (可研版本对象.OBJ_TYPE=0 ) 
--and 可研版本对象.id is not null
--只查询可研阶段 项目的业态指标。
--where  ph.phase_name='可研版' and ph.objtype='项目' 
),


-------------------------------------------=======全盘版本---全盘版本---全盘版本---全盘版本---全盘版本---全盘版本---全盘版本
---项目和分期
全盘版本对象 as (
select  obj_base.obj_id||l_UUID as id,
        '全盘版本' 类型,
        PHASE_NAME,
        obj_base.obj_name as OBJ_NAME,
        obj_base.obj_id as OBJ_ID,
        '' as OPERATE_ATTRIBUTE_ID,
        '' as OPERATE_ATTRIBUTE_NAME,
        0 as TOTAL_BUILD_AREA,
        0 as TOTAL_VOLUME_AREA,--'总计容面积'
        0 as TOTAL_SALES_AREA,---'总可售面积';
        0 as GROUND_CAN_SELL_AREA,--GROUND_CAN_SELL_AREA" IS '地上可售面积';
        0 as UNDERGROUND_CAN_SELL_AREA,-- IS '地下可售面积';
        0  as TOTAL_CARPORT,--'总车位数';
        0 as GROUND_CARPORT,-- '地上车位数';
        0 as UNDERGROUND_CARPORT,-- '地下车位数';
        ------0 AVERAGE_PRICE,-- '均价（手动录入）'
         ------0 WORTH,-- '均价（手动录入）'
        l_UUID as TARGET_WORTH_ID,--'货值主键';
         case when ph.objtype='项目' then 0 
        when  ph.objtype='分期' then 20 
        when  ph.objtype='楼栋' then 30 end as
        OBJ_TYPE,-- '对象类型（0：项目；20：分期；30：楼栋;40业态）';
        ph.instance_id as OBJ_PHASE_ID,
        obj_base.parent_id||l_UUID as WORTH_DTL_PARENT_ID ,obj_base.obj_id as OBJ_PARENT_ID,
       '' as PRODUCT_TYPE_ID
from obj_base obj_base
--所有阶段
left join obj_phase ph on obj_base.obj_id=ph.obj_id
--阶段指标
--left join MDM_OBJ_PHASE_INDEX pIndex on ph.instance_id =pIndex.OBJ_PHASE_ID
--只查询全盘计划版 项目和分期指标。
where  ph.phase_name='全盘计划版' and (ph.objtype='项目' or ph.objtype='分期' ) and obj_base.objtype<>'楼栋' ) 

,全盘版本业态 as (
---查询项目业态指标
 select 
        pIndex.id,
         '全盘版本' 类型,
         PHASE_NAME,
        pIndex.product_type_name as OBJ_NAME,
        pIndex.product_type_id as OBJ_ID,
        pIndex.OPERATE_ATTRIBUTE_ID as OPERATE_ATTRIBUTE_ID,
        pIndex.OPERATE_ATTRIBUTE_NAME as OPERATE_ATTRIBUTE_NAME,
        pIndex.GROUND_TOTAL_BUILD_AREA+pIndex.UNDERGROUND_TOTAL_BUILD_AREA as TOTAL_BUILD_AREA,
        pIndex.GROUND_CAPACITY_AREA+pIndex.UNDERGROUND_CAPACITY_AREA as TOTAL_VOLUME_AREA,--'总计容面积'
        pIndex.TOTAL_SALE_AREA as TOTAL_SALES_AREA,---'总可售面积';
        pIndex.GROUND_SALE_AREA as GROUND_CAN_SELL_AREA,--GROUND_CAN_SELL_AREA" IS '地上可售面积';
        pIndex.UNDERGROUND_SALE_AREA as UNDERGROUND_CAN_SELL_AREA,-- IS '地下可售面积';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT  as TOTAL_CARPORT,--'总车位数';
        0 as GROUND_CARPORT,-- '地上车位数';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT as UNDERGROUND_CARPORT,-- '地下车位数';
        ------0 AVERAGE_PRICE,-- '均价（手动录入）'
         ------0 WORTH,-- '均价（手动录入）'
        l_UUID as TARGET_WORTH_ID,--'货值主键';
        40 OBJ_TYPE,-- '对象类型（0：项目；20：分期；30：楼栋40业态）';
        全盘版本对象.OBJ_PHASE_ID as OBJ_PHASE_ID,
        全盘版本对象.id as WORTH_DTL_PARENT_ID ,
        全盘版本对象.OBJ_ID as OBJ_PARENT_ID,
        pIndex.PRODUCT_TYPE_ID

from  MDM_OBJ_PHASE_PT_INDEX pIndex 
left join 全盘版本对象 全盘版本对象 on pIndex.OBJ_PHASE_ID=全盘版本对象.OBJ_PHASE_ID
--只查询全盘计划版 分期业态指标。
where (全盘版本对象.OBJ_TYPE=20 )
)
,
-------------------------------------------=======动态版本---动态版本---动态版本---动态版本---动态版本---动态版本---动态版本
---项目和分期和楼栋,获取最新已审核阶段的数据
动态版本对象base as (
---查询主数据项目，分期，楼栋最新阶段的指标
select  obj_base.obj_id||l_UUID as id,
        '动态版本' 类型,
        newph.PHASE_NAME,
        obj_base.obj_name as OBJ_NAME,
        obj_base.obj_id as OBJ_ID,
        '' as OPERATE_ATTRIBUTE_ID,
        '' as OPERATE_ATTRIBUTE_NAME,
        0 as TOTAL_BUILD_AREA,
        0 as TOTAL_VOLUME_AREA,--'总计容面积'
        0 as TOTAL_SALES_AREA,---'总可售面积';
        0 as GROUND_CAN_SELL_AREA,--GROUND_CAN_SELL_AREA" IS '地上可售面积';
        0 as UNDERGROUND_CAN_SELL_AREA,-- IS '地下可售面积';
        0  as TOTAL_CARPORT,--'总车位数';
        0 as GROUND_CARPORT,-- '地上车位数';
        0 as UNDERGROUND_CARPORT,-- '地下车位数';
        ------0 AVERAGE_PRICE,-- '均价（手动录入）'
         ------0 WORTH,-- '均价（手动录入）'
        l_UUID as TARGET_WORTH_ID,--'货值主键';
        case when newph.objtype='项目' then 0 
        when  newph.objtype='分期' then 20 
        when  newph.objtype='楼栋' then 30 end as
        OBJ_TYPE,-- '对象类型（0：项目；20：分期；30：楼栋;40业态）';
        newph.instance_id as OBJ_PHASE_ID,
        obj_base.parent_id||l_UUID as WORTH_DTL_PARENT_ID ,
        obj_base.obj_id as OBJ_PARENT_ID,
       '' as PRODUCT_TYPE_ID
from obj_base obj_base
--最新阶段
left join obj_new_phase newph on obj_base.obj_id=newph.obj_id
--最新阶段指标
--left join MDM_OBJ_PHASE_INDEX pIndex on newph.instance_id =pIndex.OBJ_PHASE_ID
)
--动态可研或全盘阶段 项目和分期
,动态可研或全盘阶段 as (select * from 动态版本对象base where (obj_type=20 and PHASE_NAME='全盘计划版') 
or (obj_type=0 and PHASE_NAME='可研版') )
--去掉可研全盘版基础对象的子级（分期或楼栋）
,动态版本对象 as (select base.* from 动态版本对象base base
left join 动态可研或全盘阶段 d on base.WORTH_DTL_PARENT_ID=d.id
where d.id is null
)

,动态版本业态 as (
---查询项目业态指标
 select 
        pIndex.id,
        '动态版本' 类型,
        动态版本对象.PHASE_NAME,
        pIndex.product_type_name as OBJ_NAME,
        pIndex.product_type_id as OBJ_ID,
        pIndex.OPERATE_ATTRIBUTE_ID as OPERATE_ATTRIBUTE_ID,
        pIndex.OPERATE_ATTRIBUTE_NAME as OPERATE_ATTRIBUTE_NAME,
        pIndex.GROUND_TOTAL_BUILD_AREA+pIndex.UNDERGROUND_TOTAL_BUILD_AREA as TOTAL_BUILD_AREA,--总建筑面积
        pIndex.GROUND_CAPACITY_AREA+pIndex.UNDERGROUND_CAPACITY_AREA as TOTAL_VOLUME_AREA,--'总计容面积'
        pIndex.TOTAL_SALE_AREA as TOTAL_SALES_AREA,---'总可售面积';
        pIndex.GROUND_SALE_AREA as GROUND_CAN_SELL_AREA,--GROUND_CAN_SELL_AREA" IS '地上可售面积';
        pIndex.UNDERGROUND_SALE_AREA as UNDERGROUND_CAN_SELL_AREA,-- IS '地下可售面积';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT  as TOTAL_CARPORT,--'总车位数';
        0 as GROUND_CARPORT,-- '地上车位数';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT as UNDERGROUND_CARPORT,-- '地下车位数';
        ------0 AVERAGE_PRICE,-- '均价（手动录入）'
         ------0 WORTH,-- '均价（手动录入）'
        l_UUID as TARGET_WORTH_ID,--'货值主键';
        40 OBJ_TYPE,-- '对象类型（0：项目；20：分期；30：楼栋40业态）';
        动态版本对象.OBJ_PHASE_ID as OBJ_PHASE_ID,
        动态版本对象.id as WORTH_DTL_PARENT_ID, 
        动态版本对象.OBJ_ID as OBJ_PARENT_ID,
        pIndex.PRODUCT_TYPE_ID
        from MDM_OBJ_PHASE_PT_INDEX pIndex
        left join 动态版本对象 动态版本对象  on pIndex.OBJ_PHASE_ID=动态版本对象.OBJ_PHASE_ID
        where (动态版本对象.OBJ_TYPE=30 or
        pindex.OBJ_PHASE_ID in (select OBJ_PHASE_ID from 动态可研或全盘阶段) )
)


,基础对象 as ( -----可研
        -----可研
        select * from 可研版本对象 where 1=case when i_target_worth_phase=0 then 1 else 0 end
        -----全盘
        union all
        select * from 全盘版本对象 where 1=case when i_target_worth_phase=10 then 1 else 0 end
        ---动态
        union all
        select * from 动态版本对象 where 1=case when i_target_worth_phase=20 then 1 else 0 end
       )

,基础业态 as ( select pv.*,nvl(lw.AVERAGE_PRICE,0) as AVERAGE_PRICE_temp
,nvl(lw.AVERAGE_PRICE*(pv.TOTAL_CARPORT+pv.GROUND_CAN_SELL_AREA),0) as WORTH_temp
from (     
        -----可研
        select * from 可研版本业态 where 1=case when i_target_worth_phase=0 then 1 else 0 end
        -----全盘
        union all
        select * from 全盘版本业态 where 1=case when i_target_worth_phase=10 then 1 else 0 end
        ---动态
        union all
        select * from 动态版本业态 where 1=case when i_target_worth_phase=20 then 1 else 0 end

        ) pv left join latest_target_worth lw 
        on pv.OBJ_ID=lw.OBJ_ID and pv.obj_parent_id=lw.obj_parent_id)

, 汇总 (
PHASE_NAME  
,类型
,id 
,WORTH_DTL_PARENT_ID 

)as( 
    select PHASE_NAME  
,类型
,id 
,WORTH_DTL_PARENT_ID 
from 基础业态 a1
UNION all select 
a1.PHASE_NAME  
,a1.类型
,a1.id 
,a1.WORTH_DTL_PARENT_ID 
 from  汇总 a1 INNER join 基础对象 a2 on a1.WORTH_DTL_PARENT_ID=a2.id 
)



select * from 汇总;
END P_DWM_TARGET_WORTH_REF1;
----------------------------------------------chenl20200621结束------从主数据刷新目标货值存储过程


----------------------------------------------chenl20200621开始------从主数据刷新目标货值存储过程注册

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_TRENDMAP_K1
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_TRENDMAP_K1" 
(
  orgIds IN clob 
, rateTye IN VARCHAR2 default 'count'
, pointsData  OUT sys_refcursor
, numerator  OUT sys_refcursor
, denominator  OUT sys_refcursor
, sellRate  OUT sys_refcursor
) AS 
BEGIN
   if rateTye IS NOT NULL AND rateTye = 'count' then
     open pointsData for 
--     SELECT 
--        ORG_NAME as "orgName",
--        FO_SALE_OUT_COUNT as "numerator",
--        FO_SALE_COUNT as "denominator",
--        FN_DWM_MULTIPLE_AND_UNIT(FO_SALE_RATE_BY_COUNT, 0.01, '') as "sellRate",
--        to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--        ORG_ID as "orgId",
--        RN as "rn"
--        FROM(
--            SELECT ORG_NAME, FO_SALE_OUT_COUNT, FO_SALE_COUNT, FO_SALE_RATE_BY_COUNT, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--            ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, FO_SALE_OUT_COUNT, FO_SALE_COUNT, FO_SALE_RATE_BY_COUNT, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--            ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--            (SELECT COLUMN_VALUE FROM table (split (orgIds))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--   WHERE RN <= 12);
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.FO_SALE_COUNT is null then 0 else  tab.FO_SALE_COUNT end  as "denominator",
             case when tab.FO_SALE_OUT_COUNT is null then 0 else  tab.FO_SALE_OUT_COUNT end  as "numerator",
             case when tab.FO_SALE_RATE_BY_COUNT is null then 0 else  trunc(tab.FO_SALE_RATE_BY_COUNT*100 ,2)end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, FO_SALE_OUT_COUNT, FO_SALE_COUNT, FO_SALE_RATE_BY_COUNT, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.FO_SALE_COUNT,rateTable.FO_SALE_RATE_BY_COUNT,rateTable.FO_SALE_OUT_COUNT
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '首开去化套数' as "prefix", '套' as "suffix" from dual;
        open denominator for select '首开推售套数' as "prefix", '套' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
        ELSIF rateTye IS NOT NULL AND rateTye = 'area' THEN
        open pointsData for 
--        SELECT 
--            ORG_NAME as "orgName",
--            FN_DWM_MULTIPLE_AND_UNIT(FO_SALE_OUT_AREA, 10000, '') as "numerator",
--            FN_DWM_MULTIPLE_AND_UNIT(FO_SALE_AREA, 10000, '') as "denominator",
--            FN_DWM_MULTIPLE_AND_UNIT(FO_SALE_RATE_BY_AREA, 0.01, '') as "sellRate",
--            to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--            ORG_ID as "orgId",
--            RN as "rn"
--        FROM(
--            SELECT ORG_NAME, FO_SALE_OUT_AREA, FO_SALE_AREA, FO_SALE_RATE_BY_AREA, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--            ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, FO_SALE_OUT_AREA, FO_SALE_AREA, FO_SALE_RATE_BY_AREA, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--            ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--            (SELECT COLUMN_VALUE FROM table (split (orgIds))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--   WHERE RN <= 12);
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.FO_SALE_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FO_SALE_AREA, 10000, '') end  as "denominator",
             case when tab.FO_SALE_OUT_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FO_SALE_OUT_AREA, 10000, '') end  as "numerator",
             case when tab.FO_SALE_RATE_BY_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FO_SALE_RATE_BY_AREA, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, FO_SALE_OUT_AREA, FO_SALE_AREA, FO_SALE_RATE_BY_AREA, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.FO_SALE_AREA,rateTable.FO_SALE_RATE_BY_AREA,rateTable.FO_SALE_OUT_AREA
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '首开去化面积' as "prefix", '万方' as "suffix" from dual;
        open denominator for select '首开推售面积' as "prefix", '万方' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
    ELSIF rateTye IS NOT NULL AND rateTye = 'money' THEN
        open pointsData for 
--        SELECT 
--            ORG_NAME as "orgName",
--            FN_DWM_MULTIPLE_AND_UNIT(FO_SALE_OUT_MONEY, 100000000, '') as "numerator",
--            FN_DWM_MULTIPLE_AND_UNIT(FO_SALE_MONEY, 100000000, '') as "denominator",
--            FN_DWM_MULTIPLE_AND_UNIT(FO_SALE_RATE_BY_MONEY, 0.01, '') as "sellRate",
--            to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--            ORG_ID as "orgId",
--            RN as "rn"
--        FROM(
--            SELECT ORG_NAME, FO_SALE_OUT_MONEY, FO_SALE_MONEY, FO_SALE_RATE_BY_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--            ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, FO_SALE_OUT_MONEY, FO_SALE_MONEY, FO_SALE_RATE_BY_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--            ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--            (SELECT COLUMN_VALUE FROM table (split (orgIds))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--   WHERE RN <= 12);
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.FO_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FO_SALE_MONEY, 100000000, '') end  as "denominator",
             case when tab.FO_SALE_OUT_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FO_SALE_OUT_MONEY, 100000000, '') end  as "numerator",
             case when tab.FO_SALE_RATE_BY_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FO_SALE_RATE_BY_MONEY, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, FO_SALE_OUT_MONEY, FO_SALE_MONEY, FO_SALE_RATE_BY_MONEY, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.FO_SALE_MONEY,rateTable.FO_SALE_RATE_BY_MONEY,rateTable.FO_SALE_OUT_MONEY
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '首开去化货值' as "prefix", '亿元' as "suffix" from dual;
        open denominator for select '首开推售货值' as "prefix", '亿元' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
   end if;

EXCEPTION
WHEN OTHERS THEN
  CLOSE pointsData;
  CLOSE numerator;
  CLOSE denominator;
  CLOSE sellRate;   
END P_DWM_TRENDMAP_K1;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_TRENDMAP_K2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_TRENDMAP_K2" (orgIds in clob,pointsData out sys_refcursor,numerator out sys_refcursor,denominator out sys_refcursor,sellRate out sys_refcursor)
as
numeratorVlue number :=200;
sellRateValue number :=10;
orgIdsStr clob :='';
indexNum number:=0;
begin
delete DWM_RATE_TRENDMAP;
if orgIds is not null then 
orgIdsStr:=orgIds;
    for item in ( SELECT id,org_name FROM
    sys_business_unit where id in (SELECT COLUMN_VALUE FROM table (split (orgIdsStr)))) loop
            insert into DWM_RATE_TRENDMAP(x_xAxisPeriod,denominator,numerator,sellRate,orgId,orgName,sort)
            select 
            mm as "x_xAxisPeriod", 
            case when "denominator" is null then 0 else "denominator" end as "denominator" ,
            case when "numerator" is null then 0 else "numerator" end as "numerator",
            case when "sellRate" is null then 0 else "sellRate" end as "sellRate",
            item.id,
            item.org_name,
            months."index"
           from (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab) months
            left join (
            select tab1."denominator",trunc(tab1."numerator"/31,1) as "numerator",tab1."month", trunc(tab1."numerator"/tab1."denominator"/31,1) as "sellRate"
            from (
            select count(1) as "denominator",sum(FIRST_OPEN_DURATION_BY_TL) as "numerator","month" from
            (select proj.*,to_char(proj.first_open_date,'yyyy-mm') as "month" from DWM_SALE_RATE_PROJECT proj inner join
            (select * from SYS_BUSINESS_UNIT m start with m.id =item.id connect by m.parent_id=prior m.id) orgs
            on proj.org_id=orgs.id where proj.first_open_date is not null ) tab 
            group by tab."month") tab1 ) tab2
            on months.mm=tab2."month";
      end loop;    
      OPEN pointsData FOR select  to_char(to_date(x_xAxisPeriod||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"')  as "xAxisPeriod",denominator as "denominator",numerator as "numerator",sellRate as "sellRate",
      orgId as "orgId",orgName as "orgName",sort as "rn"
      from DWM_RATE_TRENDMAP order by sort;
end if;
  open numerator for select 
  '总计拿地至首开时长' as "prefix",
  '月' as "suffix"
  from  dual;
   open denominator for select 
  '首开项目数量' as "prefix",
  '个' as "suffix"
  from  dual;
   open sellRate for select 
  '平均拿地至首开时长' as "prefix",
  '月' as "suffix"
  from  dual;

EXCEPTION
WHEN OTHERS THEN
  CLOSE pointsData;
  CLOSE numerator;
  CLOSE denominator;
  CLOSE sellRate;
end P_DWM_TRENDMAP_K2;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_TRENDMAP_K3
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_TRENDMAP_K3" 
(
  rateTye IN VARCHAR2 default 'count'
, orgIds IN clob 
, pointsData OUT sys_refcursor
, numerator OUT sys_refcursor 
, denominator OUT sys_refcursor
, sellRate OUT sys_refcursor 
) AS 
BEGIN
  if rateTye IS NOT NULL AND rateTye = 'count' then
     open pointsData for 
--     SELECT 
--        ORG_NAME as "orgName",
--        PO_SALE_OUT_COUNT as "numerator",
--        PO_SALE_COUNT as "denominator",
--        FN_DWM_MULTIPLE_AND_UNIT(PO_SALE_RATE_BY_COUNT, 0.01, '') as "sellRate",
--        to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--        ORG_ID as "orgId",
--        RN as "rn"
--        FROM(
--            SELECT ORG_NAME, PO_SALE_OUT_COUNT, PO_SALE_COUNT, PO_SALE_RATE_BY_COUNT, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, PO_SALE_OUT_COUNT, PO_SALE_COUNT, PO_SALE_RATE_BY_COUNT, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--                (SELECT COLUMN_VALUE FROM table (split (orgIds))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--       WHERE RN <= 12
--        );
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.PO_SALE_COUNT is null then 0 else  tab.PO_SALE_COUNT end  as "denominator",
             case when tab.PO_SALE_OUT_COUNT is null then 0 else  tab.PO_SALE_OUT_COUNT end  as "numerator",
             case when tab.PO_SALE_RATE_BY_COUNT is null then '0' else  FN_DWM_MULTIPLE_AND_UNIT(tab.PO_SALE_RATE_BY_COUNT, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, PO_SALE_OUT_COUNT, PO_SALE_COUNT, PO_SALE_RATE_BY_COUNT, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.PO_SALE_COUNT,rateTable.PO_SALE_RATE_BY_COUNT,rateTable.PO_SALE_OUT_COUNT
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '全案去化套数' as "prefix", '套' as "suffix" from dual;
        open denominator for select '全案推售套数' as "prefix", '套' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
   ELSIF rateTye IS NOT NULL AND rateTye = 'area' THEN
        open pointsData for 
--        SELECT 
--            ORG_NAME as "orgName",
--            FN_DWM_MULTIPLE_AND_UNIT(PO_SALE_OUT_AREA, 10000, '') as "numerator",
--            FN_DWM_MULTIPLE_AND_UNIT(PO_SALE_AREA, 10000, '') as "denominator",
--            FN_DWM_MULTIPLE_AND_UNIT(PO_SALE_RATE_BY_AREA, 0.01, '') as "sellRate",
--            to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--            ORG_ID as "orgId",
--            RN as "rn"
--        FROM(
--            SELECT ORG_NAME, PO_SALE_OUT_AREA, PO_SALE_AREA, PO_SALE_RATE_BY_AREA, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, PO_SALE_OUT_AREA, PO_SALE_AREA, PO_SALE_RATE_BY_AREA, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--                (SELECT COLUMN_VALUE FROM table (split (orgIds))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--       WHERE RN <= 12
--        );
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.PO_SALE_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.PO_SALE_AREA, 10000, '') end  as "denominator",
             case when tab.PO_SALE_OUT_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.PO_SALE_OUT_AREA, 10000, '') end  as "numerator",
             case when tab.PO_SALE_RATE_BY_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.PO_SALE_RATE_BY_AREA, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, PO_SALE_OUT_AREA, PO_SALE_AREA, PO_SALE_RATE_BY_AREA, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.PO_SALE_AREA,rateTable.PO_SALE_RATE_BY_AREA,rateTable.PO_SALE_OUT_AREA
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '全案去化面积' as "prefix", '万方' as "suffix" from dual;
        open denominator for select '全案推售面积' as "prefix", '万方' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
    ELSIF rateTye IS NOT NULL AND rateTye = 'money' THEN
        open pointsData for 
--        SELECT 
--            ORG_NAME as "orgName",
--            FN_DWM_MULTIPLE_AND_UNIT(PO_SALE_OUT_MONEY, 100000000, '') as "numerator",
--            FN_DWM_MULTIPLE_AND_UNIT(PO_SALE_MONEY, 100000000, '') as "denominator",
--            FN_DWM_MULTIPLE_AND_UNIT(PO_SALE_RATE_BY_MONEY, 0.01, '') as "sellRate",
--            to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--            ORG_ID as "orgId",
--            RN as "rn"
--        FROM(
--            SELECT ORG_NAME, PO_SALE_OUT_MONEY, PO_SALE_MONEY, PO_SALE_RATE_BY_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, PO_SALE_OUT_MONEY, PO_SALE_MONEY, PO_SALE_RATE_BY_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--                (SELECT COLUMN_VALUE FROM table (split (orgIds))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--       WHERE RN <= 12
--        );
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.PO_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.PO_SALE_MONEY, 100000000, '') end  as "denominator",
             case when tab.PO_SALE_OUT_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.PO_SALE_OUT_MONEY, 100000000, '') end  as "numerator",
             case when tab.PO_SALE_RATE_BY_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.PO_SALE_RATE_BY_MONEY, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, PO_SALE_OUT_MONEY, PO_SALE_MONEY, PO_SALE_RATE_BY_MONEY, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.PO_SALE_MONEY,rateTable.PO_SALE_RATE_BY_MONEY,rateTable.PO_SALE_OUT_MONEY
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '全案去化货值' as "prefix", '亿元' as "suffix" from dual;
        open denominator for select '全案推售货值' as "prefix", '亿元' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;     
   end if;
   EXCEPTION
WHEN OTHERS THEN
  CLOSE pointsData;
  CLOSE numerator;
  CLOSE denominator;
 CLOSE sellRate;
END P_DWM_TRENDMAP_K3;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_TRENDMAP_K4_2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_TRENDMAP_K4_2" 
(
  orgId IN clob 
, pointsData OUT sys_refcursor
, numerator OUT sys_refcursor 
, denominator OUT sys_refcursor
, sellRate OUT sys_refcursor
, abscissa OUT sys_refcursor
) AS 
BEGIN
open pointsData for 
--SELECT 
--        ORG_NAME as "orgName",
--        FN_DWM_MULTIPLE_AND_UNIT(EH_SALE_OUT_MONEY, 100000000, '') as "numerator",
--        FN_DWM_MULTIPLE_AND_UNIT(EH_SALE_MONEY, 100000000, '') as "denominator",
--        FN_DWM_MULTIPLE_AND_UNIT(EH_SALE_RATE_BY_MONEY, 0.01, '') as "sellRate",
--        to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--        ORG_ID as "orgId",
--        RN as "rn"
--        FROM(
--            SELECT ORG_NAME, EH_SALE_OUT_MONEY, EH_SALE_MONEY, EH_SALE_RATE_BY_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, EH_SALE_OUT_MONEY, EH_SALE_MONEY, EH_SALE_RATE_BY_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--                (SELECT COLUMN_VALUE FROM table (split (orgId))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--       WHERE RN <= 12
--        );
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.EH_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.EH_SALE_MONEY, 100000000, '') end  as "denominator",
             case when tab.EH_SALE_OUT_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.EH_SALE_OUT_MONEY, 100000000, '') end  as "numerator",
             case when tab.EH_SALE_RATE_BY_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.EH_SALE_RATE_BY_MONEY, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, EH_SALE_OUT_MONEY, EH_SALE_MONEY, EH_SALE_RATE_BY_MONEY, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.EH_SALE_MONEY,rateTable.EH_SALE_RATE_BY_MONEY,rateTable.EH_SALE_OUT_MONEY
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgId)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= TO_NUMBER(TO_CHAR(sysdate,'mm'))) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= TO_NUMBER(TO_CHAR(sysdate,'mm'))) tab;  
        open abscissa for select to_char(TO_DATE(TO_CHAR(ADD_MONTHS(trunc(sysdate,'yyyy'), (ROWNUM-1)), 'yyyy-mm'),'yyyy-mm'),'yyyy"年"mm"月"') as "date" from DUAL connect by ROWNUM <= 12;    
        open numerator for select '竣备后签约货值' as "prefix", '亿元' as "suffix" from dual;
        open denominator for select '竣备时未签约货值' as "prefix", '亿元' as "suffix" from dual;
        open sellRate for select '现房去化率' as "prefix", '%' as "suffix" from dual;
EXCEPTION
WHEN OTHERS THEN
  CLOSE pointsData;
  CLOSE numerator;
  CLOSE denominator;
 CLOSE sellRate;
 CLOSE abscissa;
END P_DWM_TRENDMAP_K4_2;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_TRENDMAP_K4_3
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_TRENDMAP_K4_3" 
(
  orgId IN clob 
, pointsData OUT sys_refcursor
, numerator OUT sys_refcursor 
, denominator OUT sys_refcursor
, sellRate OUT sys_refcursor
, abscissa OUT sys_refcursor
) AS 
BEGIN
 open pointsData for 
-- SELECT 
--        ORG_NAME as "orgName",
--        FN_DWM_MULTIPLE_AND_UNIT(EH_SALE_OUT_MONEY, 100000000, '') as "numerator",
--        FN_DWM_MULTIPLE_AND_UNIT(EH_SALE_MONEY, 100000000, '') as "denominator",
--        FN_DWM_MULTIPLE_AND_UNIT(EH_SURPLUS_SALE_MONEY, 100000000, '') as "sellRate",
--        to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--        ORG_ID as "orgId",
--        RN as "rn"
--        FROM(
--            SELECT ORG_NAME, EH_SALE_OUT_MONEY, EH_SALE_MONEY, EH_SURPLUS_SALE_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, EH_SALE_OUT_MONEY, EH_SALE_MONEY, EH_SURPLUS_SALE_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--                (SELECT COLUMN_VALUE FROM table (split (orgId))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--       WHERE RN <= 12
--        );
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.EH_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.EH_SALE_MONEY, 100000000, '') end  as "denominator",
             case when tab.EH_SALE_OUT_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.EH_SALE_OUT_MONEY, 100000000, '') end  as "numerator",
             case when tab.EH_SURPLUS_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.EH_SURPLUS_SALE_MONEY, 100000000, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, EH_SALE_OUT_MONEY, EH_SALE_MONEY, EH_SURPLUS_SALE_MONEY, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.EH_SALE_MONEY,rateTable.EH_SURPLUS_SALE_MONEY,rateTable.EH_SALE_OUT_MONEY
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgId)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= TO_NUMBER(TO_CHAR(sysdate,'mm'))) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= TO_NUMBER(TO_CHAR(sysdate,'mm'))) tab;
        open abscissa for select to_char(TO_DATE(TO_CHAR(ADD_MONTHS(trunc(sysdate,'yyyy'), (ROWNUM-1)), 'yyyy-mm'),'yyyy-mm'),'yyyy"年"mm"月"') as "date" from DUAL connect by ROWNUM <= 12;
        open numerator for select '竣备后签约货值' as "prefix", '亿元' as "suffix" from dual;
        open denominator for select '竣备时未签约货值' as "prefix", '亿元' as "suffix" from dual;
        open sellRate for select '剩余现房货值' as "prefix", '亿元' as "suffix" from dual;
EXCEPTION
WHEN OTHERS THEN
  CLOSE pointsData;
  CLOSE numerator;
  CLOSE denominator;
 CLOSE sellRate;
 CLOSE abscissa;        
END P_DWM_TRENDMAP_K4_3;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_TRENDMAP_K5_2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_TRENDMAP_K5_2" 
(
  orgId IN clob 
, pointsData OUT sys_refcursor
, numerator OUT sys_refcursor 
, denominator OUT sys_refcursor
, sellRate OUT sys_refcursor
, abscissa OUT sys_refcursor
) AS 
BEGIN
open pointsData for 
--SELECT 
--        ORG_NAME as "orgName",
--        FN_DWM_MULTIPLE_AND_UNIT(SI_SALE_OUT_MONEY, 100000000, '') as "numerator",
--        FN_DWM_MULTIPLE_AND_UNIT(SI_SALE_MONEY, 100000000, '') as "denominator",
--        FN_DWM_MULTIPLE_AND_UNIT(SI_SALE_RATE_BY_MONEY, 0.01, '') as "sellRate",
--        to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--        ORG_ID as "orgId",
--        RN as "rn"
--        FROM(
--             SELECT ORG_NAME, SI_SALE_OUT_MONEY, SI_SALE_MONEY, SI_SALE_RATE_BY_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, SI_SALE_OUT_MONEY, SI_SALE_MONEY, SI_SALE_RATE_BY_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--                (SELECT COLUMN_VALUE FROM table (split (orgId))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--       WHERE RN <= 12
--        );
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.SI_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.SI_SALE_MONEY, 100000000, '') end  as "denominator",
             case when tab.SI_SALE_OUT_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.SI_SALE_OUT_MONEY, 100000000, '')  end  as "numerator",
             case when tab.SI_SALE_RATE_BY_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.SI_SALE_RATE_BY_MONEY, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, SI_SALE_OUT_MONEY, SI_SALE_MONEY, SI_SALE_RATE_BY_MONEY, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.SI_SALE_MONEY,rateTable.SI_SALE_RATE_BY_MONEY,rateTable.SI_SALE_OUT_MONEY
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgId)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= TO_NUMBER(TO_CHAR(sysdate,'mm'))) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= TO_NUMBER(TO_CHAR(sysdate,'mm'))) tab;
        open abscissa for select to_char(TO_DATE(TO_CHAR(ADD_MONTHS(trunc(sysdate,'yyyy'), (ROWNUM-1)), 'yyyy-mm'),'yyyy-mm'),'yyyy"年"mm"月"') as "date" from DUAL connect by ROWNUM <= 12;
        open numerator for select '本年已去化货值' as "prefix", '亿元' as "suffix" from dual;
        open denominator for select '年初顽固性库存货值' as "prefix", '亿元' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
EXCEPTION
WHEN OTHERS THEN
  CLOSE pointsData;
  CLOSE numerator;
  CLOSE denominator;
 CLOSE sellRate;
 CLOSE abscissa;
END P_DWM_TRENDMAP_K5_2;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_TRENDMAP_K5_3
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_TRENDMAP_K5_3" 
(
  orgId IN clob 
, pointsData OUT sys_refcursor
, numerator OUT sys_refcursor 
, denominator OUT sys_refcursor
, sellRate OUT sys_refcursor 
, abscissa OUT sys_refcursor
) AS 
BEGIN
open pointsData for 
--SELECT 
--        ORG_NAME as "orgName",
--        FN_DWM_MULTIPLE_AND_UNIT(SI_SALE_OUT_MONEY, 100000000, '') as "numerator",
--        FN_DWM_MULTIPLE_AND_UNIT(SI_SALE_MONEY, 100000000, '') as "denominator",
--        FN_DWM_MULTIPLE_AND_UNIT(SI_SURPLUS_SALE_MONEY, 100000000, '') as "sellRate",
--        to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--        ORG_ID as "orgId",
--        RN as "rn"
--        FROM(
--            SELECT ORG_NAME, SI_SALE_OUT_MONEY, SI_SALE_MONEY, SI_SURPLUS_SALE_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, SI_SALE_OUT_MONEY, SI_SALE_MONEY, SI_SURPLUS_SALE_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--                (SELECT COLUMN_VALUE FROM table (split (orgId))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--       WHERE RN <= 12
--        );
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.SI_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.SI_SALE_MONEY, 100000000, '')  end  as "denominator",
             case when tab.SI_SALE_OUT_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.SI_SALE_OUT_MONEY, 100000000, '')  end  as "numerator",
             case when tab.SI_SURPLUS_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.SI_SURPLUS_SALE_MONEY, 100000000, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, SI_SALE_OUT_MONEY, SI_SALE_MONEY, SI_SURPLUS_SALE_MONEY, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.SI_SALE_MONEY,rateTable.SI_SURPLUS_SALE_MONEY,rateTable.SI_SALE_OUT_MONEY
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgId)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= TO_NUMBER(TO_CHAR(sysdate,'mm'))) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= TO_NUMBER(TO_CHAR(sysdate,'mm'))) tab;
        open abscissa for select to_char(TO_DATE(TO_CHAR(ADD_MONTHS(trunc(sysdate,'yyyy'), (ROWNUM-1)), 'yyyy-mm'),'yyyy-mm'),'yyyy"年"mm"月"') as "date" from DUAL connect by ROWNUM <= 12;
        open numerator for select '本年已去化货值' as "prefix", '亿元' as "suffix" from dual;
        open denominator for select '年初顽固性库存货值' as "prefix", '亿元' as "suffix" from dual;
        open sellRate for select '剩余顽固性库存货值' as "prefix", '亿元' as "suffix" from dual;
EXCEPTION
WHEN OTHERS THEN
  CLOSE pointsData;
  CLOSE numerator;
  CLOSE denominator;
 CLOSE sellRate;
 CLOSE abscissa;
END P_DWM_TRENDMAP_K5_3;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_UPDATEEXPLANATION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_UPDATEEXPLANATION" AS 
fm_explanation clob;
fohy_explanation clob;
cr_explanation clob;
croy_explanation clob;
Isfm number;
Isfohy number;
Iscr number;
Iscroy number;
BEGIN
    fm_explanation:='
        <div style="padding: 10px;color: #666;  height: 80vh;display: flex;-webkit-box-orient: vertical;-webkit-box-direction: normal;flex-direction: column;">
		    <h2 style="text-align: center;">数据说明</h2>
		    <div style="overflow-y: auto;overflow-x: hidden;">
		      <div>
		        <h4 style="font-size: 16px;font-weight: 700;">一、数据来源</h4>
		        <p style="font-size: 14px;text-indent: 0;color: #666;">根据《计划管理系统》数据和《项目主数据系统》数据整理而成。</p>
		      </div>
		      <div>
		        <h4 style="font-size: 16px;margin-top: 10px;font-weight: 700;">二、更新时间</h4>
		        <p style="font-size: 14px;text-indent: 0;">每天凌晨3点，数据统一进行更新，如果发现数据未及时更新请与我们联系。</p>
		      </div>
		      <div>
		        <h4 style="margin-top: 10px;font-size: 16px;font-weight: 700;">三、数据统计逻辑</h4>
		        <div style="font-size: 14px; margin-top: -14px;">
		          <div style="font-size: 14px;font-weight: 700;text-indent: 0;margin-top: 20px;">
		            1、首月去化率排行榜
		          </div>
		          <div style="text-indent:0;margin-top: 5px;">
		            项目首次开盘后一个月内，首批供货实 际签约额与首批供货量之比(含首次开盘当日)
		          </div>
		          <div style="text-indent:0;">
		            首开时间：《计划管理系统》项目首期的关键节点计划中项目开盘节点的实际完成时间
		          </div>
		          <div>
		            <div style="text-indent:0;">
		             a)	首月去化率（按货值）
		            </div>
		            <span style="text-indent:0;margin-left: 100px;padding: 5px 0;display: inline-block;text-align: center;">
		              <div style="color:#555">首月去化货值(b)</div>
		              <hr style="width: 100%;margin:2px 0px;">
		              <div style="color:#555">首开推售货值(c)</div>
		            </span>
		            <div style="text-indent:0;">
		              b) 首月去化货值：“项目首次开盘”至“项目首次开盘日期+30天”的签约金额总和
		            </div>
		            <div style="text-indent:0;">
		              c) 首开推售货值：首开时间30天内已经取预售许可证“房间”标准总价金额总和
		            </div>
		          </div>
		          <div>
		            <div style="text-indent:0;">
		              d) 首月去化率（按面积）
		            </div>
		            <span style="text-indent:0;margin-left: 100px;padding: 5px 0;display: inline-block;text-align: center;">
		              <div style="color:#555">首月去化面积(e)</div>
		              <hr style="width: 100%;margin:2px 0px;">
		              <div style="color:#555">首开推售面积(f)</div>
		            </span>
		            <div style="text-indent:0;">
		              e) 首月去化面积：”项目首次开盘”至“项目首次开盘日期+30天”的签约建筑面积总和。
		            </div>
		            <div style="text-indent:0;">
		              f) 首开推售面积：首开时间30天内已经取预售许可证“房间”最新建筑面积总和
		            </div>
		          </div>
		          <div>
		            <div style="text-indent:0;">
		             g)	首月去化率（按套装）
		            </div>
		            <span style="text-indent:0;margin-left: 100px;padding: 5px 0;display: inline-block;text-align: center;">
		              <div style="color:#555">首月去化套数(h)</div>
		              <hr style="width: 100%;margin:2px 0px;">
		              <div style="color:#555">首开推售套数(i)</div>
		            </span>
		            <div style="text-indent:0;">
		              h) 首月去化套数：“项目首次开盘”至“项目首次开盘日期+30天”的签约套数总和
		            </div>
		            <div style="text-indent:0;">
		              i) 首开推售套数：首开时间30天内已经取预售许可证“房间”总套数
		            </div>
		          </div>
		        </div>
		        <div style="font-size: 14px;margin-top: 10px;">
		          <div style="font-size: 14px;font-weight: 700;text-indent: 0;">
		            2、首月去化率趋势图
		          </div>
		          <div style="margin-top: 5px;">
					<div style="text-indent:0;">项目条件：首开时间等于横坐标时间的项目并且所属组织为选中的二级单位</div>
		            <div style="text-indent:0;">首月去化率(按货值)：</div>
		            <span style="padding-left: 60px;margin-top: 5px;display: inline-block;text-align: center;">
		              <div style="text-indent:0;color: #555;">二级单位下所有本年首月项目的首月去化货值总和</div>
		              <hr style="width: 100%;margin: 2px 0 2px 0px;border-top: 1px solid #999;">
		              <div style="text-indent:0;color: #555">
		                二级单位下所有本年首月项目的首开推售货值总和
		              </div>
		            </span>
		          </div>
		          <div style="margin-top: 10px;">
		            <div style="text-indent:0;">首月去化率(按面积)：</div>
		            <span style="padding-left: 60px;margin-top: 5px;display: inline-block;text-align: center;">
		              <div style="text-indent:0;color: #555">二级单位下所有本年首月项目的首月去化面积总和</div>
		              <hr style="width: 100%;margin: 2px 0 2px 0px;border-top: 1px solid #999;">
		              <div style="text-indent:0;color: #555">
		                二级单位下所有本年首月项目的首开推售面积总和
		              </div>
		            </span>
		          </div>
		          <div style="margin-top: 10px;">
		            <div style="text-indent:0;">首月去化率(按套数)：</div>
		            <span style="padding-left: 60px;margin-top: 5px;display: inline-block;text-align: center;">
		              <div style="text-indent:0;color: #555">二级单位下所有本年首月项目的首月去化套数总和</div>
		              <hr style="width: 100%;margin: 2px 0 2px 0px;border-top: 1px solid #999;">
		              <div style="text-indent:0;color: #555">
		                二级单位下所有本年首月项目的首开推售套数总和
		              </div>
		            </span>
		          </div>
		        </div>
		        <div style="font-size: 14px;margin-top: 10px;">
		          <div style="font-size: 14px;font-weight: 700;text-indent: 0;">
		            3、大数据简报
		          </div>
		          <div style="margin-top: 10px;">
		            <div style="">
		              <div style="">
		                1)	K1首月去化率：
		              </div>
		              <span style="margin-left: 10px;padding: 5px;display: inline-block;text-align: center;">
		                <div style="text-indent:0;color: #555">所有本年首月项目的首月去化货值总和</div>
		                <hr style="width: 100%; margin:2px 0px;border-top: 1px solid #999;">
		                <div style="text-indent:0;color: #555">所有本年首月项目的首开推售货值总和</div>
		              </span>
		              <div>
		                2)	本年实际首开项目：首开日期“年份=系统时间的年的项目个数”
		              </div>
					  <div style="">
					    3)	首月去化率均值均值
					  </div>
					  <span style="margin-left: 10px;padding: 5px;display: inline-block;text-align: center;">
					    <div style="text-indent:0;color: #555">所有本年首月项目的首月去化货值总和</div>
					    <hr style="width: 100%; margin:2px 0px;border-top: 1px solid #999;">
					    <div style="text-indent:0;color: #555">所有本年首月项目的首开推售货值总和</div>
					  </span>
		              <div>
		                4)	同比上升：不显示
		              </div>
		              <div>
		                5)	环比上升：不显示
		              </div>
		              <div>
		                6)	最高值：本年“首月去化率”的最大值
		              </div>
					  <div>
						  7)	最低值：本年“首月去化率”的最低值
					  </div>
		              <div style="">
		               8)	近3个月实际首开项目个数：展示”首开日期“在系统时间的月份-3个月”内的项目个数
		              </div>
					  <div>
						  9)	首月去化率均值：”首开日期“在系统时间的月份-3个月”内的项目的首月去化率平均值
					  </div>
		            </div>
		          </div>
		        </div>
		      </div>
		      <div style="font-size: 14px;margin-top: 10px;">
		        <h4 style="font-size: 16px;font-weight: 700;">四、功能说明</h4>
		        <div style="text-indent: 0;font-weight: 700;font-size: 14px;margin-top: 5px">
		          1、K1首月去化率排行榜列表
		        </div>
		        <div style="text-indent:0;margin-top: 5px;">
		          排序：默认按照首开日期降序排序。
		        </div>
		        <div style="text-indent:0;">
		          单位：金额单位亿，展示小数点后面两位；面积单位万方，展示小数点后两位。
		        </div>
		        <div style="text-indent: 0;font-weight: 700;font-size: 14px;margin-top: 5px">
		          2、趋势图数据说明
		        </div>
		        <div style="text-indent:0;margin-top: 5px">
		          默认选中去化率类型按套数，二级单位选项可复选。
		        </div>
		        <div style="text-indent: 0;font-weight: 700;font-size: 14px;margin-top: 5px">
		          3、导出excel说明
		        </div>
		        <div style="text-indent:0;margin-top: 5px">
		          条数：默认导出列表所有数据，导出排序与展示排序一致。
		        </div>
		      </div>
		    </div>
		  </div>
    ';

    fohy_explanation :='
        <div style="padding: 10px;color: #666;  height: 80vh;display: flex;-webkit-box-orient: vertical;-webkit-box-direction: normal;flex-direction: column;">
		    <h2 style="text-align: center;">数据说明</h2>
		    <div style="overflow-y: auto;overflow-x: hidden;">
		      <div>
		        <h4 style="font-size: 16px;font-weight: 700;">一、数据来源</h4>
		        <p style="font-size: 14px;text-indent: 0;color: #666;">根据《计划管理系统》数据和《项目主数据系统》数据整理而成。</p>
		      </div>
		      <div>
		        <h4 style="font-size: 16px;margin-top: 10px;font-weight: 700;">二、更新时间</h4>
		        <p style="font-size: 14px;text-indent: 0;">每天凌晨3点，数据统一进行更新，如果发现数据未及时更新请与我们联系。</p>
		      </div>
		      <div>
		        <h4 style="margin-top: 10px;font-size: 16px;font-weight: 700;">三、数据统计逻辑</h4>
		        <div style="font-size: 14px; margin-top: -14px;">
		          <div style="font-size: 14px;font-weight: 700;text-indent: 0;margin-top: 20px;">
		            1、首开半年去化率排行榜
		          </div>
		          <div style="text-indent:0;margin-top: 5px;">
		            项目首次开盘后半年内，实际签约额与首开半年供货量之比(含首次开盘当日)。取数 周期为首开至首开当天+180 天。
		          </div>
		          <div style="text-indent:0;">
		            首开时间：《计划管理系统》项目首期的关键节点计划中项目开盘节点的实际完成时间
		          </div>
		          <div>
		            <div style="text-indent:0;">
		             a)	首开半年去化率（按货值）
		            </div>
		            <span style="text-indent:0;margin-left: 100px;padding: 5px 0;display: inline-block;text-align: center;">
		              <div style="color:#555">首开半年去化货值(b)</div>
		              <hr style="width: 100%;margin:2px 0px;">
		              <!-- <div style="width: 110px;height: 1px;background-color: #999;margin-left: 50px;"></div> -->
		              <div style="color:#555">首开半年供货货值(c)</div>
		            </span>
		            <div style="text-indent:0;">
		              b) 首开半年去化货值：“项目首次开盘”至“项目首次开盘日期+180天”的签约金额总和
		            </div>
		            <div style="text-indent:0;">
		              c) 首开半年供货货值：“项目首次开盘”至“项目首次开盘+180天”内取得预售证楼栋的标准总价和
		            </div>
		          </div>
		          <div>
		            <div style="text-indent:0;">
		              d) 首开半年去化率（按面积）
		            </div>
		            <span style="text-indent:0;margin-left: 100px;padding: 5px 0;display: inline-block;text-align: center;">
		              <div style="color:#555">首开半年去化面积(e)</div>
		              <hr style="width: 100%;margin:2px 0px;">
		              <div style="color:#555">首开半年推售面积(f)</div>
		            </span>
		            <div style="text-indent:0;">
		              e) 首开半年去化面积：“项目首次开盘”至“项目首次开盘日期+180天”的签约建筑面积总和
		            </div>
		            <div style="text-indent:0;">
		              f) 首开半年供货面积：“项目首次开盘”至“首次开盘+180天”内取得预售证楼栋的建筑面积总和
		            </div>
		          </div>
		          <div>
		            <div style="text-indent:0;">
		             g)	首开半年去化率（按套装）
		            </div>
		            <span style="text-indent:0;margin-left: 100px;padding: 5px 0;display: inline-block;text-align: center;">
		              <div style="color:#555">首开半年去化套数(h)</div>
		              <hr style="width: 100%;margin:2px 0px;">
		              <div style="color:#555">首开半年推售套数(i)</div>
		            </span>
		            <div style="text-indent:0;">
		              h) 首开半年去化套数：“项目首次开盘”至“项目首次开盘日期+180天”的签约套数总和
		            </div>
		            <div style="text-indent:0;">
		              i) 首开半年供货套数：“首次开盘”至“首次开盘+180天”内取得预售证楼栋的取证套数总和
		            </div>
		          </div>
		        </div>
		        <div style="font-size: 14px;margin-top: 10px;">
		          <div style="font-size: 14px;font-weight: 700;text-indent: 0;">
		            2、首开半年去化率趋势图
		          </div>
		          <div style="margin-top: 5px;">
					<div style="text-indent:0;">项目条件：首开时间等于横坐标时间的项目并且所属组织为选中的二级单位</div>
		            <div style="text-indent:0;">首开半年去化率(按货值)：</div>
		            <span style="padding-left: 60px;margin-top: 5px;display: inline-block;text-align: center;">
		              <div style="text-indent:0;color: #555;">二级单位下所有本年首开项目的首开半年去化货值总和</div>
		              <hr style="width: 100%;margin: 2px 0 2px 0px;border-top: 1px solid #999;">
		              <div style="text-indent:0;color: #555">
		                二级单位下所有本年首开项目的首开半年推售货值总和
		              </div>
		            </span>
		          </div>
		          <div style="margin-top: 10px;">
		            <div style="text-indent:0;">首开半年去化率(按面积)：</div>
		            <span style="padding-left: 60px;margin-top: 5px;display: inline-block;text-align: center;">
		              <div style="text-indent:0;color: #555">二级单位下所有本年首开项目的首开半年去化面积总和</div>
		              <hr style="width: 100%;margin: 2px 0 2px 0px;border-top: 1px solid #999;">
		              <div style="text-indent:0;color: #555">
		                二级单位下所有本年首开项目的首开半年推售面积总和
		              </div>
		            </span>
		          </div>
		          <div style="margin-top: 10px;">
		            <div style="text-indent:0;">首开半年去化率(按套数)：</div>
		            <span style="padding-left: 60px;margin-top: 5px;display: inline-block;text-align: center;">
		              <div style="text-indent:0;color: #555">二级单位下所有本年首开项目的首开半年去化套数总和</div>
		              <hr style="width: 100%;margin: 2px 0 2px 0px;border-top: 1px solid #999;">
		              <div style="text-indent:0;color: #555">
		                二级单位下所有本年首开项目的首开半年推售套数总和
		              </div>
		            </span>
		          </div>
		        </div>
		        <div style="font-size: 14px;margin-top: 10px;">
		          <div style="font-size: 14px;font-weight: 700;text-indent: 0;">
		            3、大数据简报
		          </div>
		          <div style="margin-top: 10px;">
		            <div style="">
		              <div style="">
		                1)	K2首开半年去化率：
		              </div>
		              <span style="margin-left: 10px;padding: 5px;display: inline-block;text-align: center;">
		                <div style="text-indent:0;color: #555">所有首开半年去化货值总和</div>
		                <hr style="width: 100%; margin:2px 0px;border-top: 1px solid #999;">
		                <div style="text-indent:0;color: #555">所有首开半年供货货值总和</div>
		              </span>
		              <div>
		                2)	首开半年去化率均值
		              </div>
					  <span style="margin-left: 10px;padding: 5px;display: inline-block;text-align: center;">
					    <div style="text-indent:0;color: #555">所有首开半年去化货值总和</div>
					    <hr style="width: 100%; margin:2px 0px;border-top: 1px solid #999;">
					    <div style="text-indent:0;color: #555">所有首开半年供货货值总和</div>
					  </span>
		              <div>
		                3)	同比上升：昨年的这个半年值 C 当前首开半年去化率
		              </div>
		              <div>
		                4)	环比上升：上一个半年值 C 当前所属半年值
		              </div>
		              <div>
		               5)	最高值：首开半年去化率最高值
		              </div>
					  <div>
						6)	最低值：首开半年去化率最低值
					  </div>
		            </div>
		          </div>
		        </div>
		      </div>
		      <div style="font-size: 14px;margin-top: 10px;">
		        <h4 style="font-size: 16px;font-weight: 700;">四、功能说明</h4>
		        <div style="text-indent: 0;font-weight: 700;font-size: 14px;margin-top: 5px">
		          1、k2首开半年去化率排行榜列表
		        </div>
				<div style="text-indent:0;margin-top: 5px;">
				  排序：默认按照首开日期降序排序。
				</div>
		        <div style="text-indent:0;">
		          单位：金额单位亿，展示小数点后面两位；面积单位万方，展示小数点后两位。
		        </div>
		        <div style="text-indent: 0;font-weight: 700;font-size: 14px;margin-top: 5px">
		          2、趋势图数据说明
		        </div>
		        <div style="text-indent:0;margin-top: 5px">
		          默认选中去化率类型按套数，二级单位选项可复选。
		        </div>
		        <div style="text-indent: 0;font-weight: 700;font-size: 14px;margin-top: 5px">
		          3、导出excel说明
		        </div>
		        <div style="text-indent:0;margin-top: 5px">
		          条数：默认导出列表所有数据，导出排序与展示排序一致。
		        </div>
		      </div>
		    </div>
		  </div>
    ';

    cr_explanation:='
        <div style="padding: 10px;color: #666;  height: 80vh;
		  display: flex;
		  -webkit-box-orient: vertical;
		  -webkit-box-direction: normal;
		  flex-direction: column;">
		    <h2 style="text-align: center;">数据说明</h2>
		    <div style="overflow-y: auto;overflow-x: hidden;">
		      <div>
		        <h4 style="font-size: 16px;font-weight: 700;">一、数据来源</h4>
		        <p style="font-size: 14px;text-indent: 0;color: #666;">根据《计划管理系统》数据和《项目主数据系统》数据整理而成。</p>
		      </div>
		      <div>
		        <h4 style="font-size: 16px;margin-top: 10px;font-weight: 700;">二、更新时间</h4>
		        <p style="font-size: 14px;text-indent: 0;">每天凌晨3点，数据统一进行更新，如果发现数据未及时更新请与我们联系。</p>
		      </div>
		      <div>
		        <h4 style="margin-top: 10px;font-size: 16px;font-weight: 700;">三、数据统计逻辑</h4>
		        <div style="font-size: 14px; margin-top: -14px;">
		          <div style="font-size: 14px;font-weight: 700;text-indent: 0;margin-top: 20px;">
		            1、竣工备案去化率排行榜
		          </div>
		          <div style="text-indent:0;margin-top: 5px;">
						项目分期竣工时，该分期住宅实际签约额与分期住宅总货值之比。(取分期最晚楼栋竣工备 案当天的实际签约额与该分期动态目标货值之比。)
		          </div>
		          <div style="text-indent:0;">
		            首开时间：《计划管理系统》项目首期的关键节点计划中项目开盘节点的实际完成时间
		          </div>
		          <div>
		            <div style="text-indent:0;">
		             a)	竣工备案去化率（按货值）
		            </div>
		            <span style="text-indent:0;margin-left: 100px;padding: 5px 0;display: inline-block;text-align: center;">
		              <div style="color:#555">竣备去化货值(b)</div>
		              <hr style="width: 100%;margin:2px 0px;">
		              <div style="color:#555">已竣备总货值(c)</div>
		            </span>
		            <div style="text-indent:0;">
		              b) 竣备去化货值：“分期最晚楼栋竣工备案当天及之前的”签约金额总和
		            </div>
		            <div style="text-indent:0;">
		             c)	已竣备总货值：“分期楼栋竣工备案楼栋”最新的“动态版目标货值总和”
		            </div>
		          </div>
		          <div>
		            <div style="text-indent:0;">
		              d) 竣工备案去化率（按面积）
		            </div>
		            <span style="text-indent:0;margin-left: 100px;padding: 5px 0;display: inline-block;text-align: center;">
		              <div style="color:#555">竣备去化面积(e)</div>
		              <hr style="width: 100%;margin:2px 0px;">
		              <div style="color:#555">已竣备总面积(f)</div>
		            </span>
		            <div style="text-indent:0;">
		              e) 竣备去化面积：分期最晚楼栋竣工备案当天及之前的“签约建筑面积”总和
		            </div>
		            <div style="text-indent:0;">
		             f)	已竣备总面积：分期竣工备案楼栋的“建筑面积”总和
		            </div>
		          </div>
		          <div>
		            <div style="text-indent:0;">
		             g)	竣工备案去化率（按套装）
		            </div>
		            <span style="text-indent:0;margin-left: 100px;padding: 5px 0;display: inline-block;text-align: center;">
		              <div style="color:#555">竣备去化套数(h)</div>
		              <hr style="width: 100%;margin:2px 0px;">
		              <div style="color:#555">已竣备总套数(i)</div>
		            </span>
		            <div style="text-indent:0;">
		             h)	竣备去化套数：“分期最晚楼栋竣工备案当天及之前”的“签约套数”总和
		            </div>
		            <div style="text-indent:0;">
		              i) 已竣备总套数：分期竣工备案楼栋的“套数”总和
		            </div>
		          </div>
		        </div>
		        <div style="font-size: 14px;margin-top: 10px;">
		          <div style="font-size: 14px;font-weight: 700;text-indent: 0;">
		            2、竣工备案去化率趋势图
		          </div>
		          <div style="margin-top: 5px;">
					<div style="text-indent:0;">项目条件：首开时间等于横坐标时间的项目并且所属组织为选中的二级单位</div>
		            <div style="text-indent:0;">竣工备案去化率(按货值)：</div>
		            <span style="padding-left: 60px;margin-top: 5px;display: inline-block;text-align: center;">
		              <div style="text-indent:0;color: #555;">二级单位下所有本年竣工备案项目的去化货值总和</div>
		              <hr style="width: 100%;margin: 2px 0 2px 0px;border-top: 1px solid #999;">
		              <div style="text-indent:0;color: #555">
		                二级单位下所有本年竣工备案项目的推售货值总和
		              </div>
		            </span>
		          </div>
		          <div style="margin-top: 10px;">
		            <div style="text-indent:0;">竣工备案去化率(按面积)：</div>
		            <span style="padding-left: 60px;margin-top: 5px;display: inline-block;text-align: center;">
		              <div style="text-indent:0;color: #555">二级单位下所有本年竣工备案项目的去化面积总和</div>
		              <hr style="width: 100%;margin: 2px 0 2px 0px;border-top: 1px solid #999;">
		              <div style="text-indent:0;color: #555">
		                二级单位下所有本年竣工备案项目的推售面积总和
		              </div>
		            </span>
		          </div>
		          <div style="margin-top: 10px;">
		            <div style="text-indent:0;">竣工备案去化率(按套数)：</div>
		            <span style="padding-left: 60px;margin-top: 5px;display: inline-block;text-align: center;">
		              <div style="text-indent:0;color: #555">二级单位下所有本年竣工备案项目的去化套数总和</div>
		              <hr style="width: 100%;margin: 2px 0 2px 0px;border-top: 1px solid #999;">
		              <div style="text-indent:0;color: #555">
		                二级单位下所有本年竣工备案项目的推售套数总和
		              </div>
		            </span>
		          </div>
		        </div>
		        <div style="font-size: 14px;margin-top: 10px;">
		          <div style="font-size: 14px;font-weight: 700;text-indent: 0;">
		            3、大数据简报
		          </div>
		          <div style="margin-top: 10px;">
		            <div style="">
		              <div style="">
		                1)	竣工备案去化率：
		              </div>
		              <span style="margin-left: 10px;padding: 5px;display: inline-block;text-align: center;">
		                <div style="text-indent:0;color: #555">所有竣工备案去化总货值</div>
		                <hr style="width: 100%; margin:2px 0px;border-top: 1px solid #999;">
		                <div style="text-indent:0;color: #555">所有竣工备案已竣备总货值</div>
		              </span>
		              <div>
		                2)	竣工备案去化率均值
		              </div>
					  <span style="margin-left: 10px;padding: 5px;display: inline-block;text-align: center;">
					    <div style="text-indent:0;color: #555">所有竣工备案去化总货值</div>
					    <hr style="width: 100%; margin:2px 0px;border-top: 1px solid #999;">
					    <div style="text-indent:0;color: #555">所有竣工备案已竣备总货值</div>
					  </span>
		              <div>
		                3)	同比上升：不显示
		              </div>
		              <div>
		                4)	环比上升：不显示
		              </div>
		              <div>
		               5)	最高值：竣工备案去化率最大值
		              </div>
					  <div>
						6)	最低值：竣工备案去化率最小值
					  </div>
		            </div>
		          </div>
		        </div>
		      </div>
		      <div style="font-size: 14px;margin-top: 10px;">
		        <h4 style="font-size: 16px;font-weight: 700;">四、功能说明</h4>
		        <div style="text-indent: 0;font-weight: 700;font-size: 14px;margin-top: 5px">
		          1、k3竣工备案去化率排行榜列表
		        </div>
				<div style="text-indent:0;margin-top: 5px;">
				  排序：默认按照首开日期降序排序。
				</div>
		        <div style="text-indent:0;">
		          单位：金额单位亿，展示小数点后面两位；面积单位万方，展示小数点后两位。
		        </div>
		        <div style="text-indent: 0;font-weight: 700;font-size: 14px;margin-top: 5px">
		          2、趋势图数据说明
		        </div>
		        <div style="text-indent:0;margin-top: 5px">
		          默认选中去化率类型按套数，二级单位选项可复选。
		        </div>
		        <div style="text-indent: 0;font-weight: 700;font-size: 14px;margin-top: 5px">
		          3、导出excel说明
		        </div>
		        <div style="text-indent:0;margin-top: 5px">
		          条数：默认导出列表所有数据，导出排序与展示排序一致。
		        </div>
		      </div>
		    </div>
		  </div>
    ';

    croy_explanation:='
        <div style="padding: 10px;color: #666;  height: 80vh;display: flex;-webkit-box-orient: vertical;-webkit-box-direction: normal;flex-direction: column;">
		    <h2 style="text-align: center;">数据说明</h2>
		    <div style="overflow-y: auto;overflow-x: hidden;">
		      <div>
		        <h4 style="font-size: 16px;font-weight: 700;">一、数据来源</h4>
		        <p style="font-size: 14px;text-indent: 0;color: #666;">根据《计划管理系统》数据和《项目主数据系统》数据整理而成。</p>
		      </div>
		      <div>
		        <h4 style="font-size: 16px;margin-top: 10px;font-weight: 700;">二、更新时间</h4>
		        <p style="font-size: 14px;text-indent: 0;">每天凌晨3点，数据统一进行更新，如果发现数据未及时更新请与我们联系。</p>
		      </div>
		      <div>
		        <h4 style="margin-top: 10px;font-size: 16px;font-weight: 700;">三、数据统计逻辑</h4>
		        <div style="font-size: 14px; margin-top: -14px;">
		          <div style="font-size: 14px;font-weight: 700;text-indent: 0;margin-top: 20px;">
		            1、竣工备案后一年去化率排行榜
		          </div>
		          <div style="text-indent:0;margin-top: 5px;">
					项目分期竣工时，该分期住 宅实际签约额与分期住宅总货值之比。(取分期最晚楼栋竣工备 案一年后的实际签约额与该分期动态目标货值之比。)
		          </div>
		          <div style="text-indent:0;">
		            首开时间：《计划管理系统》项目首期的关键节点计划中项目开盘节点的实际完成时间
		          </div>
		          <div>
		            <div style="text-indent:0;">
		             a)	竣工备案后一年去化率（按货值）
		            </div>
		            <span style="text-indent:0;margin-left: 100px;padding: 5px 0;display: inline-block;text-align: center;">
		              <div style="color:#555">竣备去化货值(b)</div>
		              <hr style="width: 100%;margin:2px 0px;">
		              <div style="color:#555">已竣备总货值(c)</div>
		            </span>
		            <div style="text-indent:0;">
		             b)	竣备去化货值：“分期最晚楼栋竣工备案当天+1天”至“分期最晚楼栋竣工备案+1年”的签约金额总和
		            </div>
		            <div style="text-indent:0;">
		             c)	已竣备总货值：“分期楼栋竣工备案楼栋”最新的“动态版目标货值”总和
		            </div>
		          </div>
		          <div>
		            <div style="text-indent:0;">
		              d) 竣工备案后一年去化率（按面积）
		            </div>
		            <span style="text-indent:0;margin-left: 100px;padding: 5px 0;display: inline-block;text-align: center;">
		              <div style="color:#555">竣备去化面积(e)</div>
		              <hr style="width: 100%;margin:2px 0px;">
		              <div style="color:#555">已竣备总面积(f)</div>
		            </span>
		            <div style="text-indent:0;">
		              e) 竣备去化面积：“分期最晚楼栋竣工备案+1天”至“最晚楼栋竣工备案+1年”的签约建筑面积总和
		            </div>
		            <div style="text-indent:0;">
		             f)	已竣备总面积：“分期竣工备案楼栋”的建筑面积总和
		            </div>
		          </div>
		          <div>
		            <div style="text-indent:0;">
		             g)	竣工备案后一年去化率（按套装）
		            </div>
		            <span style="text-indent:0;margin-left: 100px;padding: 5px 0;display: inline-block;text-align: center;">
		              <div style="color:#555">竣备去化套数(h)</div>
		              <hr style="width: 100%;margin:2px 0px;">
		              <div style="color:#555">已竣备总套数(i)</div>
		            </span>
		            <div style="text-indent:0;">
		             h)	竣备去化套数：“最晚楼栋竣工备案+1天”至“最晚楼栋竣工备案+1年的签约套数”总和
		            </div>
		            <div style="text-indent:0;">
		              i) 已竣备总套数：“分期竣工备案楼栋”的套数总和
		            </div>
		          </div>
		        </div>
		        <div style="font-size: 14px;margin-top: 10px;">
		          <div style="font-size: 14px;font-weight: 700;text-indent: 0;">
		            2、竣工备案后一年去化率趋势图
		          </div>
		          <div style="margin-top: 5px;">
					<div style="text-indent:0;">项目条件：首开时间等于横坐标时间的项目并且所属组织为选中的二级单位</div>
		            <div style="text-indent:0;">竣工备案去化率(按货值)：</div>
		            <span style="padding-left: 60px;margin-top: 5px;display: inline-block;text-align: center;">
		              <div style="text-indent:0;color: #555;">二级单位下所有本年竣工备案一年项目的去化货值总和</div>
		              <hr style="width: 100%;margin: 2px 0 2px 0px;border-top: 1px solid #999;">
		              <div style="text-indent:0;color: #555">
		                二级单位下所有本年竣工备案一年项目的推售货值总和
		              </div>
		            </span>
		          </div>
		          <div style="margin-top: 10px;">
		            <div style="text-indent:0;">竣工备案后一年去化率(按面积)：</div>
		            <span style="padding-left: 60px;margin-top: 5px;display: inline-block;text-align: center;">
		              <div style="text-indent:0;color: #555">二级单位下所有本年竣工备案一年项目的去化面积总和</div>
		              <hr style="width: 100%;margin: 2px 0 2px 0px;border-top: 1px solid #999;">
		              <div style="text-indent:0;color: #555">
		                二级单位下所有本年竣工备案一年项目的推售面积总和
		              </div>
		            </span>
		          </div>
		          <div style="margin-top: 10px;">
		            <div style="text-indent:0;">竣工备案后一年去化率(按套数)：</div>
		            <span style="padding-left: 60px;margin-top: 5px;display: inline-block;text-align: center;">
		              <div style="text-indent:0;color: #555">二级单位下所有本年竣工备案一年项目的去化套数总和</div>
		              <hr style="width: 100%;margin: 2px 0 2px 0px;border-top: 1px solid #999;">
		              <div style="text-indent:0;color: #555">
		                二级单位下所有本年竣工备案一年项目的推售套数总和
		              </div>
		            </span>
		          </div>
		        </div>
		        <div style="font-size: 14px;margin-top: 10px;">
		          <div style="font-size: 14px;font-weight: 700;text-indent: 0;">
		            3、大数据简报
		          </div>
		          <div style="margin-top: 10px;">
		            <div style="">
		              <div style="">
		                1)	竣工备案后一年去化率：
		              </div>
		              <span style="margin-left: 10px;padding: 5px;display: inline-block;text-align: center;">
		                <div style="text-indent:0;color: #555">所有竣工备案后一年竣备去化货值总和</div>
		                <hr style="width: 100%; margin:2px 0px;border-top: 1px solid #999;">
		                <div style="text-indent:0;color: #555">所有竣工备案后一年已竣备货值总和</div>
		              </span>
		              <div>
		                2)	竣工备案去化率均值
		              </div>
					  <span style="margin-left: 10px;padding: 5px;display: inline-block;text-align: center;">
					    <div style="text-indent:0;color: #555">所有竣工备案后一年竣备去化货值总和</div>
					    <hr style="width: 100%; margin:2px 0px;border-top: 1px solid #999;">
					    <div style="text-indent:0;color: #555">所有竣工备案后一年已竣备货值总和</div>
					  </span>
		              <div>
		                3)	同比上升：不显示
		              </div>
		              <div>
		                4)	环比上升：不显示
		              </div>
		              <div>
		               5)	最高值：竣工备案后一年去化率最大值
		              </div>
					  <div>
						6)	最低值：竣工备案后一年去化率最小值
					  </div>
		            </div>
		          </div>
		        </div>
		      </div>
		      <div style="font-size: 14px;margin-top: 10px;">
		        <h4 style="font-size: 16px;font-weight: 700;">四、功能说明</h4>
		        <div style="text-indent: 0;font-weight: 700;font-size: 14px;margin-top: 5px">
		          1、k3竣工备案去化率排行榜
		        </div>
				<div style="text-indent:0;margin-top: 5px;">
				  排序：默认按照首开日期降序排序。
				</div>
		        <div style="text-indent:0;">
		          单位：金额单位亿，展示小数点后面两位；面积单位万方，展示小数点后两位。
		        </div>
		        <div style="text-indent: 0;font-weight: 700;font-size: 14px;margin-top: 5px">
		          2、趋势图数据说明
		        </div>
		        <div style="text-indent:0;margin-top: 5px">
		          默认选中去化率类型按套数，二级单位选项可复选。
		        </div>
		        <div style="text-indent: 0;font-weight: 700;font-size: 14px;margin-top: 5px">
		          3、导出excel说明
		        </div>
		        <div style="text-indent:0;margin-top: 5px">
		          条数：默认导出列表所有数据，导出排序与展示排序一致。
		        </div>
		      </div>
		    </div>
		  </div>
    ';
    select count(1) into Isfm from DWM_SALE_RATE_DATA_BRIEFING where code='fm.explanation';
    select count(1) into Isfohy from DWM_SALE_RATE_DATA_BRIEFING where code='fohy.explanation';
    select count(1) into Iscr from DWM_SALE_RATE_DATA_BRIEFING where code='cr.explanation';
    select count(1) into Iscroy from DWM_SALE_RATE_DATA_BRIEFING where code='croy.explanation';
    if Isfm = 0 then 
        insert into DWM_SALE_RATE_DATA_BRIEFING values(GET_UUID(),'fm.explanation',fm_explanation,null,'explanation',sysdate);
    end if;
    if Isfohy = 0 then
        insert into DWM_SALE_RATE_DATA_BRIEFING values(GET_UUID(),'fohy.explanation',fohy_explanation,null,'explanation',sysdate);
    end if;
    if Iscr = 0 then
        insert into DWM_SALE_RATE_DATA_BRIEFING values(GET_UUID(),'cr.explanation',cr_explanation,null,'explanation',sysdate);
    end if;
    if Iscroy = 0 then
        insert into DWM_SALE_RATE_DATA_BRIEFING values(GET_UUID(),'croy_explanation',croy_explanation,null,'explanation',sysdate);
    end if;
  commit;
END P_DWM_UPDATEEXPLANATION;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_VALUE_DTL_CONDITIONS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_VALUE_DTL_CONDITIONS" (
    USERID IN VARCHAR2,
    STATIONID IN VARCHAR2,
    COMPANYID IN VARCHAR2,
    DEPTID IN VARCHAR2,
    o_second_company out  SYS_REFCURSOR,---二级单位
    o_product_type out  SYS_REFCURSOR,---业态
    o_start_work out  SYS_REFCURSOR,---是否已开工
    o_operation_board out  SYS_REFCURSOR,---是否超盘
    o_start_board out  SYS_REFCURSOR---是否开盘
) IS
v_spid              VARCHAR2(200);--数据权限验证spid
v_biz_code           VARCHAR2(200);--数据权限验证编码
	--供货汇总表初始化条件
	--作者：陈丽
    --修改者：谢松宏 //添加二级单位数据权限
	--日期：2020-07-21
    --修改日期：2020-07-30
BEGIN
v_biz_code := 'DWM.DTHZGL.05';

--调用数据权限验证存储过程
 P_SYS_AUTH_DATA_RULE_SPID(
            USERID => USERID,
            STATIONID => STATIONID,
            DEPTID => DEPTID,
            COMPANYID => COMPANYID,
            BIZCODE => v_biz_code,
            DATA_AUTH_SPID => v_spid
        );

---二级单位
open o_second_company for
select  'org-'||tab."value" as id,tab."value",tab."label",ROWNUM as "sort",tab."isChecked" from (select id "value" ,org_name  "label",'org' as "ParentId",ORDER_HIERARCHY_CODE as "sort",1 as "isChecked"  from (select ID,org_name,order_hierarchy_code from (select ORG_ID from DWM_SALE_RATE_PROJECT group by ORG_ID) tab left join  SYS_BUSINESS_UNIT on tab.ORG_ID=SYS_BUSINESS_UNIT.ID where SYS_BUSINESS_UNIT.LEVEL_RANK=2
        union
        select ID,org_name,order_hierarchy_code from  (select parent_id  from (select ORG_ID from DWM_SALE_RATE_PROJECT group by ORG_ID) tab left join  SYS_BUSINESS_UNIT on tab.ORG_ID=SYS_BUSINESS_UNIT.ID where SYS_BUSINESS_UNIT.LEVEL_RANK=3) orgids
        left join SYS_BUSINESS_UNIT on orgids.parent_id=SYS_BUSINESS_UNIT.id
        union
        select ID,org_name,order_hierarchy_code from(select * from SYS_BUSINESS_UNIT m start with m.id in (
        select sys_business_unit.ID from (select ORG_ID from DWM_SALE_RATE_PROJECT group by ORG_ID) tab left join  SYS_BUSINESS_UNIT on tab.ORG_ID=SYS_BUSINESS_UNIT.ID where SYS_BUSINESS_UNIT.LEVEL_RANK>3
        ) connect by prior m.parent_id=m.id)tab where tab.LEVEL_RANK=2 ) orgs order by orgs.order_hierarchy_code)tab
        LEFT JOIN
          (
              select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = v_spid
        )  tal
          on tal.orgid=tab."value"
        ;
open o_product_type for--业态
select a.* from (
select   '住宅' as "value",'住宅' as "label",1 as "sort",1 as "isChecked"  from dual
UNION
select   '商办' as "value",'商办' as "label",2 as "sort",1 as "isChecked"  from dual) a order by "sort";
open   o_start_work for---是否已开工
select a.* from (
select  '已开工' as "value",'已开工' as "label",1 as "sort",1 as "isChecked"  from dual
UNION
select  '未开工' as "value",'未开工' as "label",2 as "sort",1 as "isChecked"  from dual) a order by "sort";

open   o_operation_board for---是否超盘
select a.* from (
select   '操盘项目' as "value",'操盘项目' as "label",1 as "sort",1 as "isChecked"  from dual
UNION
select   '非操盘项目' as "value",'非操盘项目' as "label",2 as "sort",1 as "isChecked"  from dual) a order by "sort";

open   o_start_board for---是否开盘
select a.* from (
select   '已开盘' as "value",'已开盘' as "label",1 as "sort",1 as "isChecked"  from dual
UNION
select   '未开盘' as "value",'未开盘' as "label",2 as "sort",1 as "isChecked"  from dual) a order by "sort";
END P_dwm_value_dtl_conditions;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_VALUE_PROJECT_SCOPE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_VALUE_PROJECT_SCOPE" (
    userid         IN             VARCHAR2 --当前用户id
    ,
    stationid      IN             VARCHAR2 --当前用户岗位id
    ,
    departmentid   IN             VARCHAR2 --当前用户部门id
    ,
    companyid      IN             VARCHAR2 --当前用户公司id
    ,
    projtreeinfo   OUT            SYS_REFCURSOR--项目树
) AS 
--货值数据项目树
--作者：鲜晓勇
--日期：2020/01/13
--输入变量：用户ID
    data_auth_spid   VARCHAR2(200);
    bizcode          VARCHAR2(200);
BEGIN
    bizcode := 'DWM.DTHZGL.01';
    p_sys_get_company_tree_spid(userid => userid, stationid => stationid, deptid => departmentid, companyid => companyid, bizcode
    => bizcode, data_auth_spid => data_auth_spid);

    OPEN projtreeinfo FOR SELECT
                             orgid      "orgId",
                             orgname    AS "orgName",
                             parentid   AS "parentId",
                             userid  as userid,
                             stationid as stationid,
                             departmentid as departmentid,
                             companyid as companyid,
                             orgtype    AS "orgType"
                         FROM
                             (
                                 SELECT DISTINCT
                                     org_id       AS orgid,
                                     org_name     AS orgname,
                                     order_code   AS ordercode,
                                     parent_id    AS parentid,
                                     org_type     AS orgtype
                                     
                                 FROM
                                     tmp_company_tree
                                 WHERE
                                     id = data_auth_spid
                                     AND org_id IN (
                                         SELECT DISTINCT
                                             id
                                         FROM
                                             sys_business_unit
                                         START WITH
                                             id IN (
                                                 SELECT
                                                     id
                                                 FROM
                                                     (
                                                         SELECT
                                                             unit_id AS id
                                                         FROM
                                                             sys_project
                                                         UNION
                                                         SELECT
                                                             subordinate_company_id AS id
                                                         FROM
                                                             cdb_feasible_project_config
                                                     ) ds
                                             )
                                         CONNECT BY
                                             PRIOR parent_id = id
                                     )
                                 UNION ALL
                                 SELECT
                                     id             AS projid,
                                     project_name   AS projname,
                                     project_code   AS ordercode,
                                     unit_id        AS parentid,
                                     '10' AS orgtype
                                 FROM
                                     sys_project
                             ) t
                         ORDER BY
                             ordercode;

END p_dwm_value_project_scope;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_VALUEMONITORING_COUNT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_VALUEMONITORING_COUNT" (
    daterange             IN           VARCHAR2,
    authcode              IN           VARCHAR2,--鉴权CODE
    currentuserid         IN	       VARCHAR2,--用户ID 鉴权使用
    currentcompanyid      IN           VARCHAR2,--用户公司ID  鉴权使用
    currentdeptid         IN           VARCHAR2,--用户部门ID  鉴权使用
    currentstationid      IN           VARCHAR2,--用户岗位ID  鉴权使用
    valuecount            OUT          VARCHAR2,
    projadjustcount       OUT          VARCHAR2
)
AS
    v_beginDate    date;
    v_endDate      date;
    v_spid         VARCHAR2(50);

BEGIN
    --1、根据日期参数取日期范围
    IF daterange='thisMonth' THEN
        select trunc(sysdate, 'mm') INTO v_beginDate from dual;
        select last_day(trunc(sysdate)) INTO v_endDate from dual;
    ELSIF daterange='thisQuarter' THEN
        select trunc(sysdate, 'Q') INTO v_beginDate from dual;
        select add_months(trunc(sysdate, 'Q'), 3) - 1 INTO v_endDate from dual;
    ELSIF daterange='thisYear' THEN
        select trunc(sysdate,'y') INTO v_beginDate from dual;
        select last_day(add_months(trunc(SYSDATE,'y'),11)) INTO v_endDate from dual;
    END IF;
    --2、数据鉴权
    P_SYS_AUTH_DATA_RULE_SPID(
            USERID => currentuserid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => authcode,
            DATA_AUTH_SPID => v_spid
        );
    --3、查询调整数量
    select count(*) INTO projadjustcount from (
        select DISTINCT proj_id from DWM_TARGET_WORTH worth
        left join (
            select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = v_spid
        ) tal on worth.proj_id=tal.orgid
        where APPROVAL_STATUS='已审核' and approval_time< v_endDate and approval_time> v_begindate
    );
    --4、获取货值
    select
        TO_CHAR(
                    SUM(case when TARGET_WORTH_PHASE = 0 then TARGET_WORTH
                             when TARGET_WORTH_PHASE=10 then FEASIBILITY_STUDY_V_INCREMENT
                             when TARGET_WORTH_PHASE=20 AND WORTH_V=1 then FULL_V_INCREMENT
                             when TARGET_WORTH_PHASE=20 AND WORTH_V>1 then PREVIOUS_V_INCREMENT END
                        )/10000, 'FM999990.00'
            ) INTO valuecount
    from DWM_TARGET_WORTH worth
    left join (
        select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = v_spid
    ) tal on worth.proj_id=tal.orgid
    where APPROVAL_STATUS='已审核' and approval_time<v_endDate and approval_time>v_beginDate;
END P_DWM_VALUEMONITORING_COUNT;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_VALUEMONITORING_LIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_VALUEMONITORING_LIST" (
daterange             IN           VARCHAR2,--时间范围
authcode              IN           VARCHAR2,--鉴权CODE
currentuserid         IN	       VARCHAR2,--用户ID 鉴权使用
currentcompanyid      IN           VARCHAR2,--用户公司ID  鉴权使用
currentdeptid         IN           VARCHAR2,--用户部门ID  鉴权使用
currentstationid      IN           VARCHAR2,--用户岗位ID  鉴权使用
pageindex             IN           VARCHAR2,
pagesizes             IN           VARCHAR2,
items                 OUT          SYS_REFCURSOR
)
AS
v_beginDate    date;
v_endDate      date;
v_spid         VARCHAR2(50);
v_pageindex    NUMBER;
v_pagesizes    NUMBER;
BEGIN
    execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd hh24:mi:ss''';
    v_pageindex:=TO_NUMBER(pageindex);
     v_pagesizes:=TO_NUMBER(pagesizes);
--1、根据日期参数取日期范围
    IF daterange='thisMonth' THEN
        select trunc(sysdate, 'mm') INTO v_beginDate from dual;
        select last_day(trunc(sysdate)) INTO v_endDate from dual;
    ELSIF daterange='thisQuarter' THEN
         select trunc(sysdate, 'Q') INTO v_beginDate from dual;
        select add_months(trunc(sysdate, 'Q'), 3) - 1 INTO v_endDate from dual;
    ELSIF daterange='thisYear' THEN
        select trunc(sysdate,'y') INTO v_beginDate from dual;
        select last_day(add_months(trunc(SYSDATE,'y'),11)) INTO v_endDate from dual;
    END IF;
--2、数据鉴权
        P_SYS_AUTH_DATA_RULE_SPID(
                USERID => currentuserid,
                STATIONID => currentstationid,
                DEPTID => currentdeptid,
                COMPANYID => currentcompanyid,
                BIZCODE => authcode,
                DATA_AUTH_SPID => v_spid
            );
           -- OPEN items FOR select 1 AS "Id" FROM DUAL;
    OPEN items FOR select a.* from ( SELECT  rownum as "rowno","userName", "executionTime","executionContent", "executionType","orgid","projid","stageid","deptid","ncompanyid","pcompanyid","openUrl","worthId" from
    (select "userName","executionTime","executionContent","executionType","orgid","projid","stageid","deptid","ncompanyid","pcompanyid","openUrl","worthId" from (
    SELECT
        CREATOR AS "userName",
        APPROVAL_TIME AS "executionTime",
        CASE WHEN TARGET_WORTH_PHASE= 0 THEN
            '<span style="color:#A2A2A2">创建了</span>'||'<span style="color:#058CFF">【'||PROJ_NAME||'-可研版目标货值V'||WORTH_V||'】</span>，当前最新版本目标货值'||TRUNC(TARGET_WORTH/10000,2)||'亿'
        WHEN TARGET_WORTH_PHASE= 10 THEN
            '<span style="color:#A2A2A2">创建了</span>'||'<span style="color:#058CFF">【'||PROJ_NAME||'-全盘开发计划版目标货值V'||WORTH_V||'】</span>，当前最新版本目标货值'||TRUNC(TARGET_WORTH/10000,2)||'亿'
        WHEN TARGET_WORTH_PHASE= 20 THEN
            '<span style="color:#A2A2A2">创建了</span>'||'<span style="color:#058CFF">【'||PROJ_NAME||'-动态版目标货值V'||WORTH_V||'】</span>，当前最新版本目标货值'||TRUNC(TARGET_WORTH/10000,2)||'亿'
        END AS "executionContent",

        'shixinyuanxing' AS "executionType",
         null AS "orgid",
         proj_id AS "projid",
         null AS "stageid",
         null AS "deptid",
         null AS "ncompanyid",
         null AS "pcompanyid",
         '/pom/exection-dynamic-detail'  AS"openUrl",
         id AS "worthId"
        FROM
        DWM_TARGET_WORTH worth
        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = v_spid) tal
        on worth.proj_id=tal.orgid
--        tal.orgid is not null
        WHERE  APPROVAL_STATUS='已审核' AND APPROVAL_TIME is not null
        AND approval_time< v_endDate AND approval_time> v_begindate
        UNION ALL
        select
        '' AS "userName",
        to_date(  to_char("executionTime",'yyyy-MM-dd')||' 23:59:59' ) AS "executionTime",
        ''  AS "executionContent",
        to_char("executionTime",'mm"月"dd"日"') "executionType",
         null AS "orgid",
         null AS "projid",
         null AS "stageid",
         null AS "deptid",
         null AS "ncompanyid",
         null AS "pcompanyid",
         null AS"openUrl" ,
         null AS "worthId" from (
         SELECT
        CREATOR AS "userName",
        APPROVAL_TIME AS "executionTime",
        null AS "executionContent",
        'shixinyuanxing' AS "executionType",
         null AS "orgid",
         proj_id AS "projid",
         null AS "stageid",
         null AS "deptid",
         null AS "ncompanyid",
         null AS "pcompanyid",
         null AS"openUrl",
         worth.id AS "worthId"
        FROM
        DWM_TARGET_WORTH worth
        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = v_spid) tal
        on worth.proj_id=tal.orgid
--        tal.orgid is not null
        WHERE  APPROVAL_STATUS='已审核' AND APPROVAL_TIME is not null
        AND approval_time< v_endDate AND approval_time> v_begindate )a
        group by to_char("executionTime",'mm"月"dd"日"')
        , to_date(to_char("executionTime",'yyyy-MM-dd')||' 23:59:59' )) order BY "executionTime" DESC)
        where rownum <= v_pageindex * v_pagesizes ) a where a."rowno" > v_pagesizes * ( v_pageindex - 1 );


END P_DWM_VALUEMONITORING_LIST;


/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_COMPANY_WORTH
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_W_COMPANY_WORTH" (title out VARCHAR2, wacthinfo OUT sys_refcursor)
AS
 --动态货值监控-7公司可售货值货量监控（树列表）
--作者：陈丽
--日期：2019/11/13
-- 黄伟20191222：【动态货值监控】第1个Tab页的右下方树列表。问题：展示不出多个区域公司。
-- 韩金明20200507: 更改查询逻辑 支持查询带项目的所有公司
BEGIN
    open wacthinfo FOR
        with t1 as(
            select sbu.ID, sbu.ORG_NAME, sum(ddv.area_dt_all) salesArea,
                    SUM(NVL(ddv.ZZ_Value_Dt_All,0)) + SUM(NVL(ddv.SY_Value_Dt_All,0)) +
                    SUM(NVL(ddv.CW_Value_Dt_All,0)) as salesWorth, nvl(count(*), 0) cnt
            from SYS_BUSINESS_UNIT sbu
                     left join  MDM_PROJECT mp on sbu.ID = mp.COMPANY_ID
                     left join (select * from DWM_DT_VALUE where OBJ_TYPE = '项目') ddv on ddv.OBJ_ID = mp.ID
            where mp.IS_DELETE = 0 and APPROVAL_STATUS='已审核'
            group by sbu.ID, sbu.ORG_NAME
        ), t2 as (
            select tt.ID, tt.PARENT_ID, rootId, tt.ORG_NAME, salesArea, salesWorth,
                   ORDER_HIERARCHY_CODE, cnt
            from (
                select sbu.ID, sbu.PARENT_ID, sbu.ORG_NAME, connect_by_root(sbu.ID) rootId,
                       ORDER_HIERARCHY_CODE
                from SYS_BUSINESS_UNIT sbu
                start with id in (select id from t1 where id = sbu.id)
                connect by prior sbu.PARENT_ID = sbu.ID
            ) tt left join t1 on tt.rootId = t1.ID
        )select
             id,
             PARENT_ID "parentsId",
             ORG_NAME "companyName",
                 sum(cnt)||'' "projTotal",
             round(sum(nvl(salesArea, 0))/10000,2) "salesArea",
             round(sum(nvl(salesWorth,0))/100000000,2) "salesWorth",
             ORDER_HIERARCHY_CODE||'' "orderCode"
        from t2 group by id, PARENT_ID, ORG_NAME, ORDER_HIERARCHY_CODE
        order by ORDER_HIERARCHY_CODE;
    title:='货值排行榜（面积单位：万平方   货值单位：亿元）';
END p_dwm_w_company_worth;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_PHASE_LAYOUT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_W_PHASE_LAYOUT" (
    orgid          IN             VARCHAR2 --组织id 公司id，项目id
    ,
    orgtype        IN             VARCHAR2 ---组织类型 公司，项目
    ,
    wdescription   OUT            VARCHAR2 -------描述
    ,
    title          OUT            VARCHAR2 --显示标题
    ,
    unit           OUT            VARCHAR2---单位
    ,
    unitcolor      OUT            VARCHAR2   ---单位颜色
    ,
    wacthinfo      OUT            SYS_REFCURSOR --监控信息（根据页面图
) AS
		--动态货值监控-货值阶段分布tab
		--作者：陈丽
		--日期：2019/12/07

    color_wqz    VARCHAR2(100); -- 未取证
    color_gz     VARCHAR2(100); --规证阶段
    color_sgz    VARCHAR2(100); --施工证阶段
    color_ysz    VARCHAR2(100); --预售许可证
    color_jgba   VARCHAR2(100); --竣工备案证
    color_jz     VARCHAR2(100); --结转阶段
BEGIN
    unit := '亿元';
    unitcolor := '#333333';
    title := '可售货值阶段分布';
		/*WDESCRIPTION := '说明：可再穿透至项目';*/
		/*
    SELECT COLOR_FIRST, COLOR_SECOND, COLOR_THIRD
    INTO   COLOR_ZZ, COLOR_CW, COLOR_SY
    FROM   SYS_COLOR_SET SAMPLE(80)
    WHERE  GROUP_NAME IN ('轻快、华丽、动感', '回味、女性化、优雅', '运动型、轻快') AND
           COLOR_FIRST NOT LIKE '#FFFF%' AND
           COLOR_SECOND NOT LIKE '#FFFF%' AND
           COLOR_THIRD NOT LIKE '#FFFF%' AND
           ROWNUM = 1;*/
    OPEN wacthinfo FOR WITH tmp_proj_value (
                           org_id,
                           orgname,
                           parent_id,
                           order_hierarchy_code,
                           zz_value_allow_sale,
                           cw_value_allow_sale,
                           sy_value_allow_sale,
                           value_not_planning_permit,
                           value_not_construction_permit,
                           value_not_sale_permit,
                           value_not_completion,
                           value_yes_completion,
                           value_yes_settlement,
                           proj_con,
                           orgtype
                       ) AS (
					--子集
                           SELECT
                               a1.id             AS org_id,
                               a1.project_name   AS orgname,
                               a1.unit_id        AS parent_id,
                               a1.order_hierarchy_code,
                               nvl(b1.zz_value_allow_sale, 0) zz_value_allow_sale,
                               nvl(b1.cw_value_allow_sale, 0) cw_value_allow_sale,
                               nvl(b1.sy_value_allow_sale, 0) sy_value_allow_sale,
                               nvl(b1.value_not_planning_permit, 0) AS value_not_planning_permit,
                               nvl(b1.value_not_construction_permit, 0) AS value_not_construction_permit,
                               nvl(b1.value_not_sale_permit, 0) value_not_sale_permit,
                               nvl(b1.value_not_completion, 0) AS value_not_completion,
                               nvl(b1.value_yes_completion, 0) AS value_yes_completion,
                               nvl(b1.value_yes_settlement, 0) AS value_yes_settlement,
                               1 AS proj_con,
                               '1' AS orgtype
                           FROM
                               sys_project    a1
                               INNER JOIN dwm_dt_value   b1 ON a1.id = b1.obj_id
                                                             AND b1.obj_type = '项目'
					--父级
                           UNION ALL
                           SELECT
                               b2.id,
                               b2.org_name,
                               b2.parent_id,
                               b2.order_hierarchy_code,
                               nvl(a2.zz_value_allow_sale, 0),
                               nvl(a2.cw_value_allow_sale, 0),
                               nvl(a2.sy_value_allow_sale, 0),
                               nvl(a2.value_not_planning_permit, 0) AS value_not_planning_permit,
                               nvl(a2.value_not_construction_permit, 0) AS value_not_construction_permit,
                               nvl(a2.value_not_sale_permit, 0) value_not_sale_permit,
                               nvl(a2.value_not_completion, 0) AS value_not_completion,
                               nvl(a2.value_yes_completion, 0) AS value_yes_completion,
                               nvl(a2.value_yes_settlement, 0) AS value_yes_settlement,
                               a2.proj_con,
                               '0' AS orgtype
                           FROM
                               tmp_proj_value      a2
                               INNER JOIN sys_business_unit   b2 ON a2.parent_id = b2.id
                       )
				--/dwm/value-manage/dynamic-value/value-phase?orgid={组织id}&orgtype=0 
                       SELECT
                           1 AS "groupId",
                           '未取证 单位（亿元）' AS "groupName",
                           '#83b5ea' AS "groupColor",
                           300 AS "groupHigh",
                           p.orgname AS "itemName",
                           CASE
                               WHEN p.orgtype = 1 THEN
                                   ''
                               ELSE
                                   '/dwm/value-manage/dynamic-value/value-phase?orgid='
                                   || TO_CHAR(nvl(p.org_id, ''))
                                   || CHR(38)
                                   || 'orgtype=0'
                           END AS "itemOpenUrl",
                           round(SUM(p.value_not_planning_permit) / 100000000, 2) AS "statistics",
                           p.order_hierarchy_code
                       FROM
                           tmp_proj_value p
                       WHERE
                           p.parent_id = orgid
                       GROUP BY
                           p.orgname,
                           p.orgtype,
                           p.org_id,
                           p.order_hierarchy_code
                       UNION ALL
                       SELECT
                           2 AS "groupId",
                           '已取规划许可证 单位（亿元）' AS "groupName",
                           '#666699' AS "groupColor",
                           300 AS "groupHigh",
                           p.orgname AS "itemName",
                           CASE
                               WHEN p.orgtype = 1 THEN
                                   ''
                               ELSE
                                   '/dwm/value-manage/dynamic-value/value-phase?orgid='
                                   || TO_CHAR(nvl(p.org_id, ''))
                                   || CHR(38)
                                   || 'orgtype=0'
                           END AS "itemOpenUrl",
                           round(SUM(p.value_not_construction_permit) / 100000000, 2) AS "statistics",
                           p.order_hierarchy_code
                       FROM
                           tmp_proj_value p
                       WHERE
                           p.parent_id = orgid
                       GROUP BY
                           p.orgname,
                           p.orgtype,
                           p.org_id,
                           p.order_hierarchy_code
                       UNION ALL
                       SELECT
                           3 AS "groupId",
                           '已取施工许可证 单位（亿元）' AS "groupName",
                           '#663300' AS "groupColor",
                           300 AS "groupHigh",
                           p.orgname AS "itemName",
                           CASE
                               WHEN p.orgtype = 1 THEN
                                   ''
                               ELSE
                                   '/dwm/value-manage/dynamic-value/value-phase?orgid='
                                   || TO_CHAR(nvl(p.org_id, ''))
                                   || CHR(38)
                                   || 'orgtype=0'
                           END AS "itemOpenUrl",
                           round(SUM(p.value_not_sale_permit) / 100000000, 2) AS "statistics",
                           p.order_hierarchy_code
                       FROM
                           tmp_proj_value p
                       WHERE
                           p.parent_id = orgid
                       GROUP BY
                           p.orgname,
                           p.orgtype,
                           p.org_id,
                           p.order_hierarchy_code
                       UNION ALL
                       SELECT
                           4 AS "groupId",
                           '已取预售许可证 单位（亿元）' AS "groupName",
                           '#006633' AS "groupColor",
                           300 AS "groupHigh",
                           p.orgname AS "itemName",
                           CASE
                               WHEN p.orgtype = 1 THEN
                                   ''
                               ELSE
                                   '/dwm/value-manage/dynamic-value/value-phase?orgid='
                                   || TO_CHAR(nvl(p.org_id, ''))
                                   || CHR(38)
                                   || 'orgtype=0'
                           END AS "itemOpenUrl",
                           round(SUM(p.value_not_completion) / 100000000, 2) AS "statistics",
                           p.order_hierarchy_code
                       FROM
                           tmp_proj_value p
                       WHERE
                           p.parent_id = orgid
                       GROUP BY
                           p.orgname,
                           p.orgtype,
                           p.org_id,
                           p.order_hierarchy_code
                       UNION ALL
                       SELECT
                           5 AS "groupId",
                           '已取竣工备案证 单位（亿元）' AS "groupName",
                           '#CC9900' AS "groupColor",
                           300 AS "groupHigh",
                           p.orgname AS "itemName",
                           CASE
                               WHEN p.orgtype = 1 THEN
                                   ''
                               ELSE
                                   '/dwm/value-manage/dynamic-value/value-phase?orgid='
                                   || TO_CHAR(nvl(p.org_id, ''))
                                   || CHR(38)
                                   || 'orgtype=0'
                           END AS "itemOpenUrl",
                           round(SUM(p.value_yes_completion) / 100000000, 2) AS "statistics",
                           p.order_hierarchy_code
                       FROM
                           tmp_proj_value p
                       WHERE
                           p.parent_id = orgid
                       GROUP BY
                           p.orgname,
                           p.orgtype,
                           p.org_id,
                           p.order_hierarchy_code
                       UNION ALL
                       SELECT
                           6 AS "groupId",
                           '已结转 单位（亿元）' AS "groupName",
                           '#CC3366' AS "groupColor",
                           300 AS "groupHigh",
                           p.orgname AS "itemName",
                           CASE
                               WHEN p.orgtype = 1 THEN
                                   ''
                               ELSE
                                   '/dwm/value-manage/dynamic-value/value-phase?orgid='
                                   || TO_CHAR(nvl(p.org_id, ''))
                                   || CHR(38)
                                   || 'orgtype=0'
                           END AS "itemOpenUrl",
                           round(SUM(p.value_yes_settlement) / 100000000, 2) AS "statistics",
                           p.order_hierarchy_code
                       FROM
                           tmp_proj_value p
                       WHERE
                           p.parent_id = orgid
                       GROUP BY
                           p.orgname,
                           p.orgtype,
                           p.org_id,
                           p.order_hierarchy_code
                       ORDER BY
                           1,
                           8;

END p_dwm_w_phase_layout;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_PRESALE_PERMIT_WORTH
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_W_PRESALE_PERMIT_WORTH" 
(
		TITLE     OUT VARCHAR2
	 ,BARTYPE   OUT VARCHAR2
	 ,UNIT      OUT VARCHAR2
	 ,WACTHINFO OUT SYS_REFCURSOR
) AS
		--动态货值监控-4已取预售证的货值情况
		--作者：陈丽
		--日期：2019/11/13
BEGIN
		OPEN WACTHINFO FOR
				SELECT '已售货值' AS NAME, round(SUM(A.VALUE_HAVED_SALE)/100000000,2) AS TOTAL,
							 '#37cd69' AS "color"
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '未售货值' AS NAME, round(SUM(A.VALUE_STOCK)/100000000,2) AS TOTAL,
							 '#E68CB2' AS "color"
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目';
		TITLE   := '已领预售证的货值情况';
		UNIT    := '亿元';
		BARTYPE := 'column';
END P_DWM_W_PRESALE_PERMIT_WORTH;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_PRODUCT_TYPE_LAYOUT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_W_PRODUCT_TYPE_LAYOUT" 
(
		ORGID        IN VARCHAR2 --组织id 公司id，项目id
	 ,ORGTYPE      IN VARCHAR2 ---组织类型 公司，项目
	 ,WDESCRIPTION OUT VARCHAR2 -------描述
	 ,TITLE        OUT VARCHAR2 --显示标题
      ,unit          OUT VARCHAR2 ---单位
    ,unitcolor    OUT VARCHAR2   ---单位颜色
	 ,WACTHINFO    OUT SYS_REFCURSOR --监控信息（根据页面图
) AS
		--动态货值监控-货值业态分布tab
		--作者：陈丽
		--日期：2019/12/07

		COLOR_ZZ VARCHAR2(100);
		COLOR_CW VARCHAR2(100);
		COLOR_SY VARCHAR2(100);

BEGIN
		TITLE := '各项目可售货值业态分布';
		/*WDESCRIPTION := '说明：可再穿透至项目';*/
  unit := '亿元';
    unitcolor := '#333333';
		SELECT COLOR_FIRST, COLOR_SECOND, COLOR_THIRD
		INTO   COLOR_ZZ, COLOR_CW, COLOR_SY
		FROM   SYS_COLOR_SET SAMPLE(80)
		WHERE  GROUP_NAME IN ('轻快、华丽、动感','回味、女性化、优雅','运动型、轻快') AND
					 COLOR_FIRST NOT LIKE '#FFFF%' AND
					 COLOR_SECOND NOT LIKE '#FFFF%' AND
					 COLOR_THIRD NOT LIKE '#FFFF%' AND
					 ROWNUM = 1;

		OPEN WACTHINFO FOR
		
				WITH TMP_PROJ_VALUE(ORG_ID,
				ORGNAME,
				PARENT_ID,
				ORDER_HIERARCHY_CODE,
				ZZ_VALUE_ALLOW_SALE,
				CW_VALUE_ALLOW_SALE,
				SY_VALUE_ALLOW_SALE,
				PROJ_CON,
				ORGTYPE) AS
				 (
					--子集
					SELECT A1.ID AS ORG_ID, A1.PROJECT_NAME AS ORGNAME,
									A1.UNIT_ID AS PARENT_ID, A1.ORDER_HIERARCHY_CODE,
									NVL(B1.ZZ_VALUE_ALLOW_SALE, 0) ZZ_VALUE_ALLOW_SALE,
									NVL(B1.CW_VALUE_ALLOW_SALE, 0) CW_VALUE_ALLOW_SALE,
									NVL(B1.SY_VALUE_ALLOW_SALE, 0) SY_VALUE_ALLOW_SALE,
									1 AS PROJ_CON, '1' AS ORGTYPE
					FROM   SYS_PROJECT A1
					INNER  JOIN DWM_DT_VALUE B1
					ON     A1.ID = B1.OBJ_ID AND
								 B1.OBJ_TYPE = '项目'
					--父级
					UNION ALL
					SELECT B2.ID, B2.ORG_NAME, B2.PARENT_ID, B2.ORDER_HIERARCHY_CODE,
									NVL(A2.ZZ_VALUE_ALLOW_SALE, 0),
									NVL(A2.CW_VALUE_ALLOW_SALE, 0),
									NVL(A2.SY_VALUE_ALLOW_SALE, 0), A2.PROJ_CON, '0' AS ORGTYPE
					FROM   TMP_PROJ_VALUE A2
					INNER  JOIN SYS_BUSINESS_UNIT B2
					ON     A2.PARENT_ID = B2.ID)
				--/dwm/plan-worth/distribution-format?orgid=003200000000000000000000000000&orgtype=0
				SELECT 1 AS "groupId", '住宅 单位（亿元）' AS "groupName",
							 COLOR_ZZ AS "groupColor", 300 AS "groupHigh",
							 P.ORGNAME AS "itemName",
							 CASE
									 WHEN P.ORGTYPE = 1 THEN
										''
									 ELSE
										'/dwm/value-manage/dynamic-value/distributed?orgid=' ||
										TO_CHAR(NVL(P.ORG_ID, '')) || CHR(38) || 'orgtype=0'
							 END AS "itemOpenUrl",
							 ROUND(SUM(P.ZZ_VALUE_ALLOW_SALE) / 100000000, 2) AS "statistics",
							 P.ORDER_HIERARCHY_CODE
				FROM   TMP_PROJ_VALUE P
				WHERE  P.PARENT_ID = ORGID
				GROUP  BY P.ORGNAME, P.ORG_ID, P.ORGTYPE, P.ORDER_HIERARCHY_CODE
				UNION ALL
				SELECT 2 AS "groupId", '车位 单位（亿元）' AS "groupName",
								COLOR_CW AS "groupColor", 300 AS "groupHigh",
								P.ORGNAME AS "itemName",
								CASE
										 WHEN P.ORGTYPE = 1 THEN
											''
										 ELSE
											'/dwm/value-manage/dynamic-value/distributed?orgid=' ||
											TO_CHAR(NVL(P.ORG_ID, '')) || CHR(38) || 'orgtype=0'
								 END AS "itemOpenUrl",
								ROUND(SUM(P.CW_VALUE_ALLOW_SALE) / 100000000, 2) AS "statistics",
								P.ORDER_HIERARCHY_CODE
				FROM   TMP_PROJ_VALUE P
				WHERE  P.PARENT_ID = ORGID
				GROUP  BY P.ORGNAME, P.ORG_ID, P.ORGTYPE, P.ORDER_HIERARCHY_CODE
				UNION ALL
				SELECT 3 AS "groupId", '商业 单位（亿元）' AS "groupName",
								 COLOR_SY AS "groupColor", 300 AS "groupHigh",
								 P.ORGNAME AS "itemName",
								 CASE
											WHEN P.ORGTYPE = 1 THEN
											 ''
											ELSE
											 '/dwm/value-manage/dynamic-value/distributed?orgid=' ||
											 TO_CHAR(NVL(P.ORG_ID, '')) || CHR(38) || 'orgtype=0'
									END AS "itemOpenUrl",
								 ROUND(SUM(P.SY_VALUE_ALLOW_SALE) / 100000000, 2) AS "statistics",
								 P.ORDER_HIERARCHY_CODE
				FROM   TMP_PROJ_VALUE P
				WHERE  P.PARENT_ID = ORGID
				GROUP  BY P.ORGNAME, P.ORG_ID, P.ORGTYPE, P.ORDER_HIERARCHY_CODE
				ORDER  BY 8;

END P_DWM_W_PRODUCT_TYPE_LAYOUT;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_PRODUCT_TYPE_WORTH
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_W_PRODUCT_TYPE_WORTH" (title out VARCHAR2,bartype out VARCHAR2,unit out VARCHAR2,carport out INT,wacthinfo OUT sys_refcursor,classificationRatio out sys_refcursor)
AS  
--动态货值监控-6各产品类型可售货值的业态分布图
--作者：陈丽
--日期：2019/11/13
-- 黄伟2020-01-02修改过
BEGIN
open wacthinfo for
select
'住宅' as  "name",
round(SUM(NVL(a.Zz_Value_Dt_All,0))/100000000,2) as "total" ,
'#37cd69' as "color"
from Dwm_Dt_Value a
WHERE a.obj_type='项目'
UNION

/*select
'住宅(库存)' as  "name",
round(SUM(NVL(a.zz_value_stock,0))/100000000,2) as "total" ,
'#37cd69' as "color"
from Dwm_Dt_Value a
WHERE a.obj_type='项目'
UNION*/

select
'商业' as  "name",
round(SUM(NVL(a.SY_Value_Dt_All,0))/100000000,2) as "total" ,
'#37cd69' as "color"
from Dwm_Dt_Value a
WHERE a.obj_type='项目'

/*UNION
select
'商业(库存)' as  "name",
round(SUM(NVL(a.SY_Value_STOCK,0))/100000000,2) as "total" ,
'#37cd69' as "color"
from Dwm_Dt_Value a
WHERE a.obj_type='项目'*/

union
select
'车位' as  "name",
round(SUM(NVL(a.CW_Value_Dt_All,0))/100000000,2) as "total" ,
'#37cd69' as "color"
from Dwm_Dt_Value a
WHERE a.obj_type='项目'

/*union
select
'车位(库存)' as  "name",
round(SUM(NVL(a.CW_Value_STOCK,0))/100000000,2) as "total" ,
'#37cd69' as "color"
from Dwm_Dt_Value a
WHERE a.obj_type='项目'*/
;
title:='各产品类型总可售货值的业态分布图';
unit:='亿元';
bartype:='column';
carport:=10000;
SELECT SUM(NVL(a.CW_AREA_Dt_All,0)) INTO carport from Dwm_Dt_Value a
WHERE a.obj_type='项目'
;


open classificationRatio for
select
'住宅' as  "name",
to_Char(round(SUM(NVL(a.ZZ_Value_Dt_All,0))/(SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))*100,2),'99.99')||'%' as "total" 
from Dwm_Dt_Value a
WHERE a.obj_type='项目'
union
select
'商业' as  "name",
to_Char(round(SUM(NVL(a.SY_Value_Dt_All,0))/(SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))*100,2),'99.99')||'%' as "total" 
from Dwm_Dt_Value a
WHERE a.obj_type='项目'
union
select
'车位' as  "name",
to_Char(round(SUM(NVL(a.CW_Value_Dt_All,0))/(SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))*100,2),'99.99')||'%' as "total" 
from Dwm_Dt_Value a
WHERE a.obj_type='项目'

;

END p_dwm_w_product_type_worth;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_REPERTORY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_W_REPERTORY" 
(
		USERID        IN VARCHAR2 --当前用户id
	 ,STATIONID     IN VARCHAR2 --当前用户岗位id
	 ,DEPARTMENTID  IN VARCHAR2 --当前用户部门id
	 ,COMPANYID     IN VARCHAR2 --当前用户公司id
	 ,ORGID         IN VARCHAR2 --组织id 公司id，项目id
	 ,ORGTYPE       IN VARCHAR2 ---组织类型 0:公司，1:项目
	 ,SCOPEYEAR     IN VARCHAR2 --监控范围段 年
	 ,SCOPEMONTH    IN VARCHAR2 --监控范围 月
	 ,REPERTORYTYPE IN VARCHAR2 --库存类型 各区域库存业态分析图：productType ，各区域库存货龄分析图：age
      ,UNIT          OUT VARCHAR2 ---- 单位
     ,UNITCOLOR     OUT VARCHAR2 --单位颜色
	 ,TITLE         OUT VARCHAR2 --显示标题
	 ,ISSHOWVALUE   OUT INT --是否显示数字 1显示，0不显示
	 ,WACTHINFO     OUT SYS_REFCURSOR --监控信息（根据页面图）
) AS
		--动态货值监控-库存监控tab
		--作者：陈丽
		--日期：2019/12/07
BEGIN
  unit := '亿元';
    unitcolor := '#333333';
		IF REPERTORYTYPE = 'productType' THEN
				TITLE := '区域库存业态分析图';
		ELSE
				TITLE := '区域库存货龄分析图';
		END IF;
		ISSHOWVALUE := 1;
		IF REPERTORYTYPE = 'productType' THEN
				OPEN WACTHINFO FOR
						WITH TMP_PROJ_VALUE(ORG_ID,
						ORGNAME,
						PARENT_ID,
						ORDER_HIERARCHY_CODE,
						ZZ_VALUE_ALLOW_SALE,
						CW_VALUE_ALLOW_SALE,
						SY_VALUE_ALLOW_SALE,
						VALUE_NOT_PLANNING_PERMIT,
						VALUE_NOT_CONSTRUCTION_PERMIT,
						VALUE_NOT_SALE_PERMIT,
						VALUE_NOT_COMPLETION,
						VALUE_YES_COMPLETION,
						VALUE_YES_SETTLEMENT,
						ZZ_VALUE_STOCK,
						CW_VALUE_STOCK,
						SY_VALUE_STOCK,
						PROJ_CON,
						ORGTYPE) AS
						 (
							--子集
							SELECT A1.ID AS ORG_ID, A1.PROJECT_NAME AS ORGNAME, A1.UNIT_ID AS PARENT_ID, A1.ORDER_HIERARCHY_CODE, NVL(B1.ZZ_VALUE_ALLOW_SALE, 0) ZZ_VALUE_ALLOW_SALE,
											NVL(B1.CW_VALUE_ALLOW_SALE, 0) CW_VALUE_ALLOW_SALE, NVL(B1.SY_VALUE_ALLOW_SALE, 0) SY_VALUE_ALLOW_SALE, NVL(B1.VALUE_NOT_PLANNING_PERMIT, 0) AS VALUE_NOT_PLANNING_PERMIT,
											NVL(B1.VALUE_NOT_CONSTRUCTION_PERMIT, 0) AS VALUE_NOT_CONSTRUCTION_PERMIT, NVL(B1.VALUE_NOT_SALE_PERMIT, 0) VALUE_NOT_SALE_PERMIT,
											NVL(B1.VALUE_NOT_COMPLETION, 0) AS VALUE_NOT_COMPLETION, NVL(B1.VALUE_YES_COMPLETION, 0) AS VALUE_YES_COMPLETION, NVL(B1.VALUE_YES_SETTLEMENT, 0) AS VALUE_YES_SETTLEMENT,
											NVL(B1.ZZ_VALUE_STOCK, 0) ZZ_VALUE_STOCK, NVL(B1.CW_VALUE_STOCK, 0) CW_VALUE_STOCK, NVL(B1.SY_VALUE_STOCK, 0) AS SY_VALUE_STOCK, 1 AS PROJ_CON, '1' AS ORGTYPE
							FROM   SYS_PROJECT A1
							INNER  JOIN DWM_DT_VALUE B1
							ON     A1.ID = B1.OBJ_ID AND
										 B1.OBJ_TYPE = '项目'
							--父级
							UNION ALL
							SELECT B2.ID, B2.ORG_NAME, B2.PARENT_ID, B2.ORDER_HIERARCHY_CODE, NVL(A2.ZZ_VALUE_ALLOW_SALE, 0), NVL(A2.CW_VALUE_ALLOW_SALE, 0), NVL(A2.SY_VALUE_ALLOW_SALE, 0),
											NVL(A2.VALUE_NOT_PLANNING_PERMIT, 0) AS VALUE_NOT_PLANNING_PERMIT, NVL(A2.VALUE_NOT_CONSTRUCTION_PERMIT, 0) AS VALUE_NOT_CONSTRUCTION_PERMIT,
											NVL(A2.VALUE_NOT_SALE_PERMIT, 0) VALUE_NOT_SALE_PERMIT, NVL(A2.VALUE_NOT_COMPLETION, 0) AS VALUE_NOT_COMPLETION, NVL(A2.VALUE_YES_COMPLETION, 0) AS VALUE_YES_COMPLETION,
											NVL(A2.VALUE_YES_SETTLEMENT, 0) AS VALUE_YES_SETTLEMENT, NVL(A2.ZZ_VALUE_STOCK, 0) ZZ_VALUE_STOCK, NVL(A2.CW_VALUE_STOCK, 0) CW_VALUE_STOCK,
											NVL(A2.SY_VALUE_STOCK, 0) AS SY_VALUE_STOCK, A2.PROJ_CON, '0' AS ORGTYPE
							FROM   TMP_PROJ_VALUE A2
							INNER  JOIN SYS_BUSINESS_UNIT B2
							ON     A2.PARENT_ID = B2.ID)
						
						SELECT '1' AS "repertoryTypeId", '住宅' AS "repertoryTypeName", A.ORGNAME AS "orgName", ROUND(SUM(A.ZZ_VALUE_STOCK) / 100000000, 2) AS "statistics", 1 AS "orderId",
									 CASE
												WHEN A.ORGTYPE = 1 THEN
												 ''
												ELSE
												 '/dwm/value-manage/dynamic-value/monitorStock?orgid=' || TO_CHAR(NVL(A.ORG_ID, '')) || CHR(38) || 'orgtype=0'
										END AS "openUrl", A.ORDER_HIERARCHY_CODE
						FROM   TMP_PROJ_VALUE A
						WHERE  A.PARENT_ID = ORGID
						GROUP  BY A.ORGNAME, A.ORG_ID, A.ORGTYPE, A.ORDER_HIERARCHY_CODE
						UNION ALL
						SELECT '2' AS "repertoryTypeId", '车位' AS "repertoryTypeName", A.ORGNAME AS "orgName", ROUND(SUM(A.CW_VALUE_STOCK) / 100000000, 2) AS "statistics", 1 AS "orderId",
										CASE
												 WHEN A.ORGTYPE = 1 THEN
													''
												 ELSE
													'/dwm/value-manage/dynamic-value/monitorStock?orgid=' || TO_CHAR(NVL(A.ORG_ID, '')) || CHR(38) || 'orgtype=0'
										 END AS "openUrl", A.ORDER_HIERARCHY_CODE
						FROM   TMP_PROJ_VALUE A
						WHERE  A.PARENT_ID = ORGID
						GROUP  BY A.ORGNAME, A.ORG_ID, A.ORGTYPE, A.ORDER_HIERARCHY_CODE
						UNION ALL
						SELECT '3' AS "repertoryTypeId", '商业' AS "repertoryTypeName", A.ORGNAME AS "orgName", ROUND(SUM(A.SY_VALUE_STOCK) / 100000000, 2) AS "statistics", 1 AS "orderId",
										 CASE
													WHEN A.ORGTYPE = 1 THEN
													 ''
													ELSE
													 '/dwm/value-manage/dynamic-value/monitorStock?orgid=' || TO_CHAR(NVL(A.ORG_ID, '')) || CHR(38) || 'orgtype=0'
											END AS "openUrl", A.ORDER_HIERARCHY_CODE
						FROM   TMP_PROJ_VALUE A
						WHERE  A.PARENT_ID = ORGID
						GROUP  BY A.ORGNAME, A.ORG_ID, A.ORGTYPE, A.ORDER_HIERARCHY_CODE
						ORDER  BY 7;
		
		ELSIF REPERTORYTYPE = 'age' THEN
				OPEN WACTHINFO FOR
						WITH TMP_STOCK_VALUE(ORG_ID,
						ORGNAME,
						PARENTID,
						ORDER_HIERARCHY_CODE,
						ORGTYPE,
						SIX_MONTH_IN,
						SIX_TO_TWELVE_MONTH,
						TWELVE_TO_EIGHTEEN_MONTH,
						EIGHTEEN_MONTH_ABOVE,
						TOTAL) AS
						 (
							--子集
							SELECT A1.ID AS ORG_ID, A1.PROJECT_NAME AS ORGNAME, A1.UNIT_ID AS PARENT_ID, A1.ORDER_HIERARCHY_CODE, '1' AS ORGTYPE,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) <= 5 THEN
																B1.BZ_PRICE * B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS SIX_MONTH_IN,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) BETWEEN 6 AND 12 THEN
																B1.BZ_PRICE * B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS SIX_TO_TWELVE_MONTH,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) BETWEEN 12 AND 18 THEN
																B1.BZ_PRICE * B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS TWELVE_TO_EIGHTEEN_MONTH,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) > 18 OR C1.GET_PRE_SALE_PERMIT_DATE IS NULL THEN
																B1.BZ_PRICE * B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS EIGHTEEN_MONTH_ABOVE, SUM(B1.BZ_PRICE * B1.PRE_BLD_AREA) AS TOTAL
							FROM   SYS_PROJECT A1
							LEFT   JOIN MDM_ROOM B1
							ON     A1.ID = B1.PROJECT_ID AND
										 B1.SALE_STATE <> '签约'
							LEFT   JOIN MDM_BUILD C1
							ON     B1.BUILDING_ID = C1.ID
							GROUP  BY A1.ID, A1.PROJECT_NAME, A1.UNIT_ID, A1.ORDER_HIERARCHY_CODE
							--父级
							UNION ALL
							SELECT B2.ID, B2.ORG_NAME, B2.PARENT_ID, B2.ORDER_HIERARCHY_CODE, '0' AS ORGTYPE, SIX_MONTH_IN, SIX_TO_TWELVE_MONTH, TWELVE_TO_EIGHTEEN_MONTH, EIGHTEEN_MONTH_ABOVE, TOTAL
							FROM   TMP_STOCK_VALUE A2
							INNER  JOIN SYS_BUSINESS_UNIT B2
							ON     A2.PARENTID = B2.ID)
						
						SELECT 1 AS "repertoryTypeId", '6个月以内' AS "repertoryTypeName", P.ORGNAME AS "orgName", ROUND(SUM(P.SIX_MONTH_IN) / 100000000, 2) AS "statistics", 1 AS ORDERID,
									 CASE
												WHEN P.ORGTYPE = 1 THEN
												 ''
												ELSE
												 '/dwm/value-manage/dynamic-value/monitorStock?orgid=' || TO_CHAR(NVL(P.ORG_ID, '')) || CHR(38) || 'orgtype=0'
										END AS "openUrl", P.ORDER_HIERARCHY_CODE
						FROM   TMP_STOCK_VALUE P
						WHERE  P.PARENTID = ORGID
						GROUP  BY P.ORGNAME, P.ORGTYPE, P.ORG_ID, P.ORDER_HIERARCHY_CODE
						UNION ALL
						SELECT 2 AS "repertoryTypeId", '6-12个月' AS "repertoryTypeName", P.ORGNAME AS "orgName", ROUND(SUM(P.SIX_TO_TWELVE_MONTH) / 100000000, 2) AS "statistics", 2 AS ORDERID,
										CASE
												 WHEN P.ORGTYPE = 1 THEN
													''
												 ELSE
													'/dwm/value-manage/dynamic-value/monitorStock?orgid=' || TO_CHAR(NVL(P.ORG_ID, '')) || CHR(38) || 'orgtype=0'
										 END AS "openUrl", P.ORDER_HIERARCHY_CODE
						FROM   TMP_STOCK_VALUE P
						WHERE  P.PARENTID = ORGID
						GROUP  BY P.ORGNAME, P.ORGTYPE, P.ORG_ID, P.ORDER_HIERARCHY_CODE
						UNION ALL
						SELECT 3 AS "repertoryTypeId", '12-18个月' AS "repertoryTypeName", P.ORGNAME AS "orgName", ROUND(SUM(P.TWELVE_TO_EIGHTEEN_MONTH) / 100000000, 2) AS "statistics", 3 AS ORDERID,
										 CASE
													WHEN P.ORGTYPE = 1 THEN
													 ''
													ELSE
													 '/dwm/value-manage/dynamic-value/monitorStock?orgid=' || TO_CHAR(NVL(P.ORG_ID, '')) || CHR(38) || 'orgtype=0'
											END AS "openUrl", P.ORDER_HIERARCHY_CODE
						FROM   TMP_STOCK_VALUE P
						WHERE  P.PARENTID = ORGID
						GROUP  BY P.ORGNAME, P.ORGTYPE, P.ORG_ID, P.ORDER_HIERARCHY_CODE
						UNION ALL
						SELECT 4 AS "repertoryTypeId", '18个月以上' AS "repertoryTypeName", P.ORGNAME AS "orgName", ROUND(SUM(P.EIGHTEEN_MONTH_ABOVE) / 100000000, 2) AS "statistics", 4 AS ORDERID,
											CASE
													 WHEN P.ORGTYPE = 1 THEN
														''
													 ELSE
														'/dwm/value-manage/dynamic-value/monitorStock?orgid=' || TO_CHAR(NVL(P.ORG_ID, '')) || CHR(38) || 'orgtype=0'
											 END AS "openUrl", P.ORDER_HIERARCHY_CODE
						FROM   TMP_STOCK_VALUE P
						WHERE  P.PARENTID = ORGID
						GROUP  BY P.ORGNAME, P.ORGTYPE, P.ORG_ID, P.ORDER_HIERARCHY_CODE
						ORDER  BY 7;
		END IF;

END P_DWM_W_REPERTORY;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_SALES_RATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_W_SALES_RATE" 
(
		SCOPEYEAR  IN VARCHAR2 --监控时间段 年
	 ,SCOPEMONTH IN VARCHAR2 --监控时间段 月
	 ,ORGID      IN VARCHAR2 --组织id 公司id，项目id
	 ,ORGTYPE    IN VARCHAR2 ---组织类型 0:公司，1:项目
      ,unit          OUT VARCHAR2 ---- 单位
     ,unitcolor     OUT VARCHAR2 --单位颜色
	 ,TITLE      OUT VARCHAR2 --显示标题
	 ,WACTHINFO  OUT SYS_REFCURSOR --监控信息（根据页面图
) AS
		--动态货值监控-货值去化率监控tab
		--作者：陈丽
		--日期：2019/12/07
BEGIN
		TITLE := '可售货值去化率';
         unit := '亿元';
    unitcolor := '#333333';
		OPEN WACTHINFO FOR
				WITH TMP_SALERATE(ORG_ID,
				ORGNAME,
				PARENTID,
				ORDER_HIERARCHY_CODE,
				CONTRACTAMOUNT,
				SALEWORTH,
				ORGTYPE) AS
				 (SELECT A1.ID AS ORG_ID, A1.PROJECT_NAME AS ORGNAME, A1.UNIT_ID AS PARENTID, A1.ORDER_HIERARCHY_CODE, NVL(B1.VALUE_HAVED_SALE, 0) AS CONTRACTAMOUNT,
								 NVL(B1.VALUE_STOCK, 0) + NVL(B1.VALUE_HAVED_SALE, 0) AS SALEWORTH, 1 AS ORGTYPE
					FROM   SYS_PROJECT A1
					INNER  JOIN DWM_DT_VALUE B1
					ON     A1.ID = B1.OBJ_ID AND
								 B1.OBJ_TYPE = '项目'
					UNION ALL
					
					SELECT B2.ID, B2.ORG_NAME, B2.PARENT_ID, B2.ORDER_HIERARCHY_CODE, A2.CONTRACTAMOUNT, A2.SALEWORTH, 0
					FROM   TMP_SALERATE A2
					INNER  JOIN SYS_BUSINESS_UNIT B2
					ON     A2.PARENTID = B2.ID
					
					)
				
				SELECT P.ORGNAME AS "orgName", ROUND(SUM(P.SALEWORTH) / 100000000, 2) AS "salesWorth", ROUND(SUM(P.CONTRACTAMOUNT) / 100000000, 2) AS "contractAmount",
							 CASE
									 WHEN P.ORGTYPE = 1 THEN
										''
									 ELSE
										'/dwm/value-manage/dynamic-value/sales-value?orgid=' || P.ORG_ID || CHR(38) || 'orgtype=0'
							 END AS "openUrl",
							 CASE
									 WHEN SUM(P.SALEWORTH) = 0 THEN
										0
									 ELSE
										ROUND(SUM(P.CONTRACTAMOUNT) / SUM(P.SALEWORTH) * 100, 2)
							 END AS "salesRate"
				FROM   TMP_SALERATE P
				WHERE  P.PARENTID = ORGID
				GROUP  BY P.ORGNAME, P.ORGTYPE, P.ORG_ID, P.ORDER_HIERARCHY_CODE
				ORDER  BY P.ORDER_HIERARCHY_CODE
				
				;

END P_DWM_W_SALES_RATE;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_SALES_WORTH_AREA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_W_SALES_WORTH_AREA" (title out VARCHAR2,wacthinfo OUT sys_refcursor)
IS
--动态货值监控-5可售货值区域分布(中国地图）
--作者：陈丽
--日期：2019/11/13
--黄伟20191222：【动态货值监控】第1个Tab页的底部。
--2020/07/06KangWJ修改
v_total number(20,2);

begin 

   select round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2) into v_total from dwm_dt_value a where a.obj_type='项目';
   
open wacthinfo FOR

-- 1 华南区域:广州市
-- 2 北方区域：北京
-- 3 华东区域：上海市
-- 4 西南区域：成都市
-- 5 华中公司：西安市
-- 6 中南区域：武汉市
-- 7 东北区域：沈阳市

select a."place",a."totalworth",a."proportion",b."salesArea",b."projName",b."salesWorth" from (
-- 1 华南区域:广州市
select
    '1' as "indexid",
    '广州市' as "place",
    to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2))  as  "totalworth",
    to_char(
    round( ((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000)/v_total,4)*100
    )||'%' as "proportion"
    from dwm_dt_value a
    inner JOIN mdm_project b ON a.obj_id=b.id
    INNER JOIN SYS_BUSINESS_UNIT c
        ON b.COMPANY_ID = c.ID 
        and c.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('华南公司','南沙公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
    WHERE a.obj_type='项目' 

-- 2 北方区域：北京
union all
select
'2' as "indexid",
'北京' as "place",
to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2))  as  "totalworth",
    to_char(
    round( ((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000)/v_total,4)*100
    )||'%' as "proportion"
    from dwm_dt_value a
    inner JOIN mdm_project b ON a.obj_id=b.id
    INNER JOIN SYS_BUSINESS_UNIT c
        ON b.COMPANY_ID = c.ID 
        and c.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('北方公司','集团总部','公寓管理公司','创新公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
    WHERE a.obj_type='项目' 

-- 3 华东区域：上海市
union all
select
'3' as "indexid",
'上海' as "place",
to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2))  as  "totalworth",
    to_char(
    round( ((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000)/v_total,4)*100
    )||'%' as "proportion"
    from dwm_dt_value a
    inner JOIN mdm_project b ON a.obj_id=b.id
    INNER JOIN SYS_BUSINESS_UNIT c
        ON b.COMPANY_ID = c.ID 
        and c.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('华东公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
    WHERE a.obj_type='项目' 

-- 4 西南区域：成都市
union all
select
'4' as "indexid",
'成都市' as "place",
to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2))  as  "totalworth",
    to_char(
    round( ((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000)/v_total,4)*100
    )||'%' as "proportion"
    from dwm_dt_value a
    inner JOIN mdm_project b ON a.obj_id=b.id
    INNER JOIN SYS_BUSINESS_UNIT c
        ON b.COMPANY_ID = c.ID 
        and c.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('西南公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
    WHERE a.obj_type='项目' 

-- 5 华中公司：西安市
union all
select
'5' as "indexid",
'西安市' as "place",
to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2))  as  "totalworth",
    to_char(
    round( ((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000)/v_total,4)*100
    )||'%' as "proportion"
    from dwm_dt_value a
    inner JOIN mdm_project b ON a.obj_id=b.id
    INNER JOIN SYS_BUSINESS_UNIT c
        ON b.COMPANY_ID = c.ID 
        and c.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('华中公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
    WHERE a.obj_type='项目' 

-- 6 中南区域：武汉市
union all
select
'6' as "indexid",
'武汉市' as "place",
to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2))  as  "totalworth",
    to_char(
    round( ((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000)/v_total,4)*100
    )||'%' as "proportion"
    from dwm_dt_value a
    inner JOIN mdm_project b ON a.obj_id=b.id
    INNER JOIN SYS_BUSINESS_UNIT c
        ON b.COMPANY_ID = c.ID 
        and c.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('中南公司','商业公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
    WHERE a.obj_type='项目' 

-- 7 东北区域：沈阳市
union all
select
'7' as "indexid",
'沈阳市' as "place",
to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2))  as  "totalworth",
    to_char(
    round( ((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000)/v_total,4)*100
    )||'%' as "proportion"
    from dwm_dt_value a
    inner JOIN mdm_project b ON a.obj_id=b.id
    INNER JOIN SYS_BUSINESS_UNIT c
        ON b.COMPANY_ID = c.ID 
        and c.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('东北公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
    WHERE a.obj_type='项目' 

--  8 贵州公司、文旅公司：贵阳市
union all
select
'8' as "indexid",
'贵阳市' as "place",
to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2))  as  "totalworth",
    to_char(
    round( ((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000)/v_total,4)*100
    )||'%' as "proportion"
    from dwm_dt_value a
    inner JOIN mdm_project b ON a.obj_id=b.id
    INNER JOIN SYS_BUSINESS_UNIT c
        ON b.COMPANY_ID = c.ID 
        and c.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('文旅公司','贵州公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
    WHERE a.obj_type='项目' 


) a

left join
(
-- 1 华南区域:广州市
      SELECT 
        '1' as "indexid",
        c.org_name as  "projName",
        to_char(round(SUM(nvl(a.area_dt_all,0))/10000,2)) as "salesArea",
        to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2)) as "salesWorth"
        from dwm_dt_value a
        inner JOIN mdm_project b ON a.obj_id=b.id
        inner JOIN sys_business_unit c ON b.company_id=c.id
         INNER JOIN SYS_BUSINESS_UNIT d
        ON b.COMPANY_ID = d.ID 
        and d.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('华南公司','南沙公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
        WHERE a.obj_type='项目'
        GROUP BY C.ORDER_HIERARCHY_CODE,c.org_name

-- 2 北方区域：北京
union all
select
'2' as "indexid",
 c.org_name as  "projName",
        to_char(round(SUM(nvl(a.area_dt_all,0))/10000,2)) as "salesArea",
        to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2)) as "salesWorth"
        from dwm_dt_value a
        inner JOIN mdm_project b ON a.obj_id=b.id
        inner JOIN sys_business_unit c ON b.company_id=c.id
         INNER JOIN SYS_BUSINESS_UNIT d
        ON b.COMPANY_ID = d.ID 
        and d.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('北方公司','集团总部','公寓管理公司','创新公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
        WHERE a.obj_type='项目'
        GROUP BY C.ORDER_HIERARCHY_CODE,c.org_name


-- 3 华东区域：上海
union all
select
'3' as "indexid",
 c.org_name as  "projName",
        to_char(round(SUM(nvl(a.area_dt_all,0))/10000,2)) as "salesArea",
        to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2)) as "salesWorth"
        from dwm_dt_value a
        inner JOIN mdm_project b ON a.obj_id=b.id
        inner JOIN sys_business_unit c ON b.company_id=c.id
         INNER JOIN SYS_BUSINESS_UNIT d
        ON b.COMPANY_ID = d.ID 
        and d.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('华东公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
        WHERE a.obj_type='项目'
        GROUP BY C.ORDER_HIERARCHY_CODE,c.org_name



-- 4 西南区域：成都市
union all
select
'4' as "indexid",
 c.org_name as  "projName",
        to_char(round(SUM(nvl(a.area_dt_all,0))/10000,2)) as "salesArea",
        to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2)) as "salesWorth"
        from dwm_dt_value a
        inner JOIN mdm_project b ON a.obj_id=b.id
        inner JOIN sys_business_unit c ON b.company_id=c.id
         INNER JOIN SYS_BUSINESS_UNIT d
        ON b.COMPANY_ID = d.ID 
        and d.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('西南公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
        WHERE a.obj_type='项目'
        GROUP BY C.ORDER_HIERARCHY_CODE,c.org_name

-- 5 华中公司：西安市
union all
select
'5' as "indexid",
 c.org_name as  "projName",
        to_char(round(SUM(nvl(a.area_dt_all,0))/10000,2)) as "salesArea",
        to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2)) as "salesWorth"
        from dwm_dt_value a
        inner JOIN mdm_project b ON a.obj_id=b.id
        inner JOIN sys_business_unit c ON b.company_id=c.id
         INNER JOIN SYS_BUSINESS_UNIT d
        ON b.COMPANY_ID = d.ID 
        and d.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('华中公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
        WHERE a.obj_type='项目'
        GROUP BY C.ORDER_HIERARCHY_CODE,c.org_name


-- 6 中南区域：武汉市
union all
select
'6' as "indexid",
 c.org_name as  "projName",
        to_char(round(SUM(nvl(a.area_dt_all,0))/10000,2)) as "salesArea",
        to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2)) as "salesWorth"
        from dwm_dt_value a
        inner JOIN mdm_project b ON a.obj_id=b.id
        inner JOIN sys_business_unit c ON b.company_id=c.id
         INNER JOIN SYS_BUSINESS_UNIT d
        ON b.COMPANY_ID = d.ID 
        and d.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('中南公司','商业公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
        WHERE a.obj_type='项目'
        GROUP BY C.ORDER_HIERARCHY_CODE,c.org_name


-- 7 东北区域：沈阳市
union all
SELECT
'7' as "indexid",
 c.org_name as  "projName",
        to_char(round(SUM(nvl(a.area_dt_all,0))/10000,2)) as "salesArea",
        to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2)) as "salesWorth"
        from dwm_dt_value a
        inner JOIN mdm_project b ON a.obj_id=b.id
        inner JOIN sys_business_unit c ON b.company_id=c.id
         INNER JOIN SYS_BUSINESS_UNIT d
        ON b.COMPANY_ID = d.ID 
        and d.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('东北公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
        WHERE a.obj_type='项目'
        GROUP BY C.ORDER_HIERARCHY_CODE,c.org_name
--  8 贵州公司、文旅公司：贵阳
    union all
SELECT
'8' as "indexid",
 c.org_name as  "projName",
        to_char(round(SUM(nvl(a.area_dt_all,0))/10000,2)) as "salesArea",
        to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2)) as "salesWorth"
        from dwm_dt_value a
        inner JOIN mdm_project b ON a.obj_id=b.id
        inner JOIN sys_business_unit c ON b.company_id=c.id
         INNER JOIN SYS_BUSINESS_UNIT d
        ON b.COMPANY_ID = d.ID 
        and d.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('文旅公司','贵州公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
        WHERE a.obj_type='项目'
        GROUP BY C.ORDER_HIERARCHY_CODE,c.org_name

)b on a."indexid"=b."indexid";


title:='可售货值区域分布';
END p_dwm_w_sales_worth_area;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_TOTAL_WORTH
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_W_TOTAL_WORTH" 
(
		TITLE     OUT VARCHAR2
	 ,BARTYPE   OUT VARCHAR2
	 ,UNIT      OUT VARCHAR2
	 ,WACTHINFO OUT SYS_REFCURSOR
) AS
		--动态货值监控-2总货值情况：目标货值 vs 动态货值
		--作者：陈丽
		--日期：2019/11/13

		V_KY_TARGET_VALUE  NUMBER(18, 2); --可研版
		V_QP_TARGET_VALUE  NUMBER(18, 2);
		V_DT_TARGET_VALUE  NUMBER(18, 2);
		V_NOW_TARGET_VALUE NUMBER(18, 2);
		V_DT_VALUE         NUMBER(18, 2);

BEGIN
		/*
    SELECT ROUND(SUM(B.TMP_1KY_VALUE) / 10000, 2)
    INTO   V_KY_TARGET_VALUE
    FROM   SYS_PROJECT A
    INNER  JOIN DWM_DT_VALUE B
    ON     A.ID = B.PROJ_ID AND b.OBJ_TYPE = '项目'
    \*WHERE  B.APPROVAL_STATUS = '已审核' AND
           B.TARGET_WORTH_PHASE = 0*\;
    
    SELECT ROUND(SUM(B.TMP_2QP_VALUE) / 10000, 2)
    INTO   V_QP_TARGET_VALUE
    FROM   SYS_PROJECT A
    INNER  JOIN DWM_DT_VALUE B
    ON     A.ID = B.PROJ_ID AND b.OBJ_TYPE = '项目'
    \*WHERE  B.APPROVAL_STATUS = '已审核' AND
           B.TARGET_WORTH_PHASE = 10*\;
    
    SELECT ROUND(SUM(B.TMP_3DT_TARGETVALUE) / 10000, 2)
    INTO   V_DT_TARGET_VALUE
    FROM   SYS_PROJECT A
    INNER  JOIN DWM_DT_VALUE B
    ON     A.ID = B.PROJ_ID  AND b.OBJ_TYPE = '项目';
    
    
    SELECT ROUND((SUM(NVL(B.VALUE_RESERVE,0))+SUM(NVL(B.VALUE_IN_PROCESS,0))+SUM(NVL(B.VALUE_STOCK,0))+SUM(NVL(B.VALUE_HAVED_SALE,0)))  / 100000000, 2)
    INTO   V_DT_VALUE
    FROM   SYS_PROJECT A
    INNER  JOIN DWM_DT_VALUE B
    ON     A.ID = B.OBJ_ID AND
           B.OBJ_TYPE = '项目';*/
		SELECT ROUND(SUM(DDV.TARGET_A1_VALUE) / 10000, 2)
    INTO   V_KY_TARGET_VALUE
    FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = '003200000000000000000000000000' CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
    LEFT   JOIN SYS_PROJECT SP
    ON     PP.ID = SP.UNIT_ID
    LEFT   JOIN DWM_DT_VALUE DDV
    ON     DDV.OBJ_ID = SP.ID;
    
    
    SELECT ROUND(SUM(A.VALUE_DT_ALL) / 100000000, 2) INTO V_DT_VALUE FROM DWM_DT_VALUE A WHERE A.OBJ_TYPE = '项目';
    
    
		SELECT ROUND(SUM(DDV.TARGET_A2_VALUE) / 10000, 2)
    INTO   V_QP_TARGET_VALUE
    FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = '003200000000000000000000000000' CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
    LEFT   JOIN SYS_PROJECT SP
    ON     PP.ID = SP.UNIT_ID
    LEFT   JOIN DWM_DT_VALUE DDV
    ON     DDV.OBJ_ID = SP.ID;
    SELECT ROUND(SUM(A.VALUE_DT_ALL) / 100000000, 2) INTO V_DT_VALUE FROM DWM_DT_VALUE A WHERE A.OBJ_TYPE = '项目';

		SELECT ROUND(SUM(DDV.TARGET_A3_VALUE) / 10000, 2)
    INTO   V_DT_TARGET_VALUE
    FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = '003200000000000000000000000000' CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
    LEFT   JOIN SYS_PROJECT SP
    ON     PP.ID = SP.UNIT_ID
    LEFT   JOIN DWM_DT_VALUE DDV
    ON     DDV.OBJ_ID = SP.ID;
    SELECT ROUND(SUM(A.VALUE_DT_ALL) / 100000000, 2) INTO V_DT_VALUE FROM DWM_DT_VALUE A WHERE A.OBJ_TYPE = '项目';
    
    
    
		SELECT ROUND(SUM(DDV.TARGET_A_VALUE) / 10000, 2)
		INTO   V_NOW_TARGET_VALUE
		FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = '003200000000000000000000000000' CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
		LEFT   JOIN SYS_PROJECT SP
		ON     PP.ID = SP.UNIT_ID
		LEFT   JOIN DWM_DT_VALUE DDV
		ON     DDV.OBJ_ID = SP.ID;
		SELECT ROUND(SUM(A.VALUE_DT_ALL) / 100000000, 2) INTO V_DT_VALUE FROM DWM_DT_VALUE A WHERE A.OBJ_TYPE = '项目';

		OPEN WACTHINFO FOR
				SELECT '可研版目标货值' AS "name", V_KY_TARGET_VALUE AS "total", '#33CCCC' AS "color", '1'
				FROM   DUAL
				UNION
				SELECT '全盘版目标货值' AS "name", V_QP_TARGET_VALUE AS "total", '#33CCCC' AS "color", '2'
				FROM   DUAL
				UNION
				SELECT '动态版目标货值' AS "name", V_DT_TARGET_VALUE AS "total", '#33CCCC' AS "color", '3'
				FROM   DUAL
				UNION
				SELECT '最新版目标货值' AS "name", V_NOW_TARGET_VALUE AS "total", '#00b2df' AS "color", '4'
				FROM   DUAL
				UNION
				SELECT '动态货值' AS "name", V_DT_VALUE AS "total", '#37cd71' AS "color", '4'
				FROM   DUAL
				ORDER  BY 4 DESC;
		TITLE   := '总货值情况：目标货值 vs 动态货值';
		UNIT    := '亿元';
		BARTYPE := 'column';
END P_DWM_W_TOTAL_WORTH;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_VISUAL_LAYOUT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_W_VISUAL_LAYOUT" 
(
		PROJID     IN VARCHAR2
	 , --项目分期id
		VISUALTYPE IN VARCHAR2
	 , --类别，1：动态货量，2：动态货值
		DATEPOINT  IN DATE
	 , ---数据点,选中时间
		WACTHINFO  OUT SYS_REFCURSOR --监控信息（根据页面图
) AS
		--动态货值-可视化分析
		--作者：陈丽
		--日期：2019/12/07
BEGIN
		IF VISUALTYPE = 2 THEN
		
				OPEN WACTHINFO FOR
						WITH TMP_PROJ_VALUE(ORG_ID,
						ORGNAME,
						PARENT_ID,
						ORDER_HIERARCHY_CODE,
						ZZ_VALUE_ALLOW_SALE,
						CW_VALUE_ALLOW_SALE,
						SY_VALUE_ALLOW_SALE,
						VALUE_NOT_PLANNING_PERMIT,
						VALUE_NOT_CONSTRUCTION_PERMIT,
						VALUE_NOT_SALE_PERMIT,
						VALUE_NOT_COMPLETION,
						VALUE_YES_COMPLETION,
						VALUE_YES_SETTLEMENT,
						ZZ_VALUE_STOCK,
						SY_VALUE_STOCK,
						CW_VALUE_STOCK,
						PROJ_CON,
						ORGTYPE) AS
						 (
							--子集
							SELECT A1.ID AS ORG_ID, A1.PROJECT_NAME AS ORGNAME, A1.UNIT_ID AS PARENT_ID, A1.ORDER_HIERARCHY_CODE, NVL(B1.ZZ_VALUE_ALLOW_SALE, 0) ZZ_VALUE_ALLOW_SALE,
											NVL(B1.CW_VALUE_ALLOW_SALE, 0) CW_VALUE_ALLOW_SALE, NVL(B1.SY_VALUE_ALLOW_SALE, 0) SY_VALUE_ALLOW_SALE, NVL(B1.VALUE_NOT_PLANNING_PERMIT, 0) AS VALUE_NOT_PLANNING_PERMIT,
											NVL(B1.VALUE_NOT_CONSTRUCTION_PERMIT, 0) AS VALUE_NOT_CONSTRUCTION_PERMIT, NVL(B1.VALUE_NOT_SALE_PERMIT, 0) VALUE_NOT_SALE_PERMIT,
											NVL(B1.VALUE_NOT_COMPLETION, 0) AS VALUE_NOT_COMPLETION, NVL(B1.VALUE_YES_COMPLETION, 0) AS VALUE_YES_COMPLETION, NVL(B1.VALUE_YES_SETTLEMENT, 0) AS VALUE_YES_SETTLEMENT,
											NVL(B1.ZZ_VALUE_STOCK, 0) ZZ_VALUE_STOCK, NVL(B1.SY_VALUE_STOCK, 0) SY_VALUE_STOCK, NVL(B1.CW_VALUE_STOCK, 0) CW_VALUE_STOCK, 1 AS PROJ_CON, '1' AS ORGTYPE
							FROM   SYS_PROJECT A1
							INNER  JOIN DWM_DT_VALUE B1
							ON     A1.ID = B1.OBJ_ID AND
										 B1.OBJ_TYPE = '项目'
							--父级
							UNION ALL
							SELECT B2.ID, B2.ORG_NAME, B2.PARENT_ID, B2.ORDER_HIERARCHY_CODE, NVL(A2.ZZ_VALUE_ALLOW_SALE, 0), NVL(A2.CW_VALUE_ALLOW_SALE, 0), NVL(A2.SY_VALUE_ALLOW_SALE, 0),
											NVL(A2.VALUE_NOT_PLANNING_PERMIT, 0) AS VALUE_NOT_PLANNING_PERMIT, NVL(A2.VALUE_NOT_CONSTRUCTION_PERMIT, 0) AS VALUE_NOT_CONSTRUCTION_PERMIT,
											NVL(A2.VALUE_NOT_SALE_PERMIT, 0) VALUE_NOT_SALE_PERMIT, NVL(A2.VALUE_NOT_COMPLETION, 0) AS VALUE_NOT_COMPLETION, NVL(A2.VALUE_YES_COMPLETION, 0) AS VALUE_YES_COMPLETION,
											NVL(A2.VALUE_YES_SETTLEMENT, 0) AS VALUE_YES_SETTLEMENT, NVL(A2.ZZ_VALUE_STOCK, 0), NVL(A2.SY_VALUE_STOCK, 0), NVL(A2.CW_VALUE_STOCK, 0), A2.PROJ_CON, '0' AS ORGTYPE
							FROM   TMP_PROJ_VALUE A2
							INNER  JOIN SYS_BUSINESS_UNIT B2
							ON     A2.PARENT_ID = B2.ID),
						TMP_STOCK_VALUE(ORG_ID,
						ORGNAME,
						PARENTID,
						ORDER_HIERARCHY_CODE,
						ORGTYPE,
						SIX_MONTH_IN,
						SIX_TO_TWELVE_MONTH,
						TWELVE_TO_EIGHTEEN_MONTH,
						EIGHTEEN_MONTH_ABOVE,
						TOTAL) AS
						 (
							--子集
							SELECT A1.ID AS ORG_ID, A1.PROJECT_NAME AS ORGNAME, A1.UNIT_ID AS PARENT_ID, A1.ORDER_HIERARCHY_CODE, '1' AS ORGTYPE,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) <= 5 THEN
																B1.BZ_PRICE * B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS SIX_MONTH_IN,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) BETWEEN 6 AND 12 THEN
																B1.BZ_PRICE * B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS SIX_TO_TWELVE_MONTH,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) BETWEEN 12 AND 18 THEN
																B1.BZ_PRICE * B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS TWELVE_TO_EIGHTEEN_MONTH,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) > 18 OR C1.GET_PRE_SALE_PERMIT_DATE IS NULL THEN
																B1.BZ_PRICE * B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS EIGHTEEN_MONTH_ABOVE, SUM(B1.BZ_PRICE * B1.PRE_BLD_AREA) AS TOTAL
							FROM   SYS_PROJECT A1
							LEFT   JOIN MDM_ROOM B1
							ON     A1.ID = B1.PROJECT_ID AND
										 B1.SALE_STATE <> '签约'
							LEFT   JOIN MDM_BUILD C1
							ON     B1.BUILDING_ID = C1.ID
							GROUP  BY A1.ID, A1.PROJECT_NAME, A1.UNIT_ID, A1.ORDER_HIERARCHY_CODE
							--父级
							UNION ALL
							SELECT B2.ID, B2.ORG_NAME, B2.PARENT_ID, B2.ORDER_HIERARCHY_CODE, '0' AS ORGTYPE, SIX_MONTH_IN, SIX_TO_TWELVE_MONTH, TWELVE_TO_EIGHTEEN_MONTH, EIGHTEEN_MONTH_ABOVE, TOTAL
							FROM   TMP_STOCK_VALUE A2
							INNER  JOIN SYS_BUSINESS_UNIT B2
							ON     A2.PARENTID = B2.ID)
						
						SELECT *
						FROM   (SELECT 1 AS "groupId", '1:各阶段货值分布' AS "groupName", '#4472C4' AS "itemColor", '未取证' AS "itemName", ROUND(P.VALUE_NOT_PLANNING_PERMIT / 100000000, 2) AS "statistics"
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 1 AS "groupId", '1:各阶段货值分布', '#ED7D31' AS "itemColor", '已取规划许可证' AS "itemName", ROUND(P.VALUE_NOT_CONSTRUCTION_PERMIT / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 1 AS "groupId", '1:各阶段货值分布', '#A5A5A5' AS "itemColor", '已取施工许可证' AS "itemName", ROUND(P.VALUE_NOT_SALE_PERMIT / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 1 AS "groupId", '1:各阶段货值分布', '#FFC000' AS "itemColor", '已取预售许可证' AS "itemName", ROUND(P.VALUE_NOT_COMPLETION / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 1 AS "groupId", '1:各阶段货值分布', '#5B9BD5' AS "itemColor", '已取竣工备案证' AS "itemName", ROUND(P.VALUE_YES_COMPLETION / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 1 AS "groupId", '1:各阶段货值分布', '#00CED1' AS "itemColor", '已结转' AS "itemName", ROUND(P.VALUE_YES_SETTLEMENT / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 2, '2:各业态货值分布', '#5B9BD5', '住宅', ROUND(P.ZZ_VALUE_ALLOW_SALE / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 2, '2:各业态货值分布', '#4472C4', '车位', ROUND(P.CW_VALUE_ALLOW_SALE / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 2, '2:各业态货值分布', '#FFC000', '商业', ROUND(P.SY_VALUE_ALLOW_SALE / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 3, '3:已推未售货值分布', '#5B9BD5', '住宅', ROUND(P.ZZ_VALUE_STOCK / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 3, '3:已推未售货值分布', '#FFC000', '商业', ROUND(P.SY_VALUE_STOCK / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 3, '3:已推未售货值分布', '#4472C4', '车位', ROUND(P.CW_VALUE_STOCK / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 4, '4:库存货龄分布', '#4472C4', '6个月以内', ROUND(SUM(P.SIX_MONTH_IN) / 100000000, 2)
										 FROM   TMP_STOCK_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 4, '4:库存货龄分布', '#FFC000', '6-12个月', ROUND(SUM(P.SIX_TO_TWELVE_MONTH) / 100000000, 2)
										 FROM   TMP_STOCK_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 4, '4:库存货龄分布', '#5B9BD5', '12-18个月', ROUND(SUM(P.TWELVE_TO_EIGHTEEN_MONTH) / 100000000, 2)
										 FROM   TMP_STOCK_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 4, '4:库存货龄分布', '#A5A5A5', '18个月以上', ROUND(SUM(P.EIGHTEEN_MONTH_ABOVE) / 100000000, 2)
										 FROM   TMP_STOCK_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 
										 ) M
						WHERE  m."statistics" <> 0;
		
		END IF;

		IF VISUALTYPE = 1 THEN
				--- 货量
				OPEN WACTHINFO FOR
						WITH TMP_PROJ_AREA(ORG_ID,
						ORGNAME,
						PARENT_ID,
						ORDER_HIERARCHY_CODE,
						ZZ_AREA_ALLOW_SALE,
						CW_AREA_ALLOW_SALE,
						SY_AREA_ALLOW_SALE,
						AREA_NOT_PLANNING_PERMIT,
						AREA_NOT_CONSTRUCTION_PERMIT,
						AREA_NOT_SALE_PERMIT,
						AREA_NOT_COMPLETION,
						AREA_YES_COMPLETION,
						AREA_YES_SETTLEMENT,
						ZZ_AREA_STOCK,
						SY_AREA_STOCK,
						CW_AREA_STOCK,
						PROJ_CON,
						ORGTYPE) AS
						 (
							--子集
							SELECT A1.ID AS ORG_ID, A1.PROJECT_NAME AS ORGNAME, A1.UNIT_ID AS PARENT_ID, A1.ORDER_HIERARCHY_CODE, NVL(B1.ZZ_AREA_ALLOW_SALE, 0) ZZ_AREA_ALLOW_SALE,
											NVL(B1.CW_AREA_ALLOW_SALE, 0) CW_AREA_ALLOW_SALE, NVL(B1.SY_AREA_ALLOW_SALE, 0) SY_AREA_ALLOW_SALE,
											NVL(B1.ZZ_AREA_NOT_PLANNING_PERMIT, 0) + NVL(B1.SY_AREA_NOT_PLANNING_PERMIT, 0) AS AREA_NOT_PLANNING_PERMIT,
											NVL(B1.ZZ_AREA_NOT_CONSTRUCTION_PER, 0) + NVL(B1.SY_AREA_NOT_CONSTRUCTION_PER, 0) AS AREA_NOT_CONSTRUCTION_PERMIT,
											NVL(B1.ZZ_AREA_NOT_SALE_PERMIT, 0) + NVL(B1.SY_AREA_NOT_SALE_PERMIT, 0) AREA_NOT_SALE_PERMIT,
											NVL(B1.ZZ_AREA_NOT_COMPLETION, 0) + NVL(B1.SY_AREA_NOT_COMPLETION, 0) AS AREA_NOT_COMPLETION,
											NVL(B1.ZZ_AREA_YES_COMPLETION, 0) + NVL(B1.SY_AREA_YES_COMPLETION, 0) AS AREA_YES_COMPLETION,
											NVL(B1.ZZ_AREA_YES_SETTLEMENT, 0) + NVL(B1.SY_AREA_YES_SETTLEMENT, 0) AS AREA_YES_SETTLEMENT, NVL(B1.ZZ_AREA_STOCK, 0) ZZ_AREA_STOCK, NVL(B1.SY_AREA_STOCK, 0) SY_AREA_STOCK,
											NVL(B1.CW_AREA_STOCK, 0) CW_AREA_STOCK, 1 AS PROJ_CON, '1' AS ORGTYPE
							FROM   SYS_PROJECT A1
							INNER  JOIN DWM_DT_VALUE B1
							ON     A1.ID = B1.OBJ_ID AND
										 B1.OBJ_TYPE = '项目'
							--父级
							UNION ALL
							SELECT B2.ID, B2.ORG_NAME, B2.PARENT_ID, B2.ORDER_HIERARCHY_CODE, NVL(A2.ZZ_AREA_ALLOW_SALE, 0), NVL(A2.CW_AREA_ALLOW_SALE, 0), NVL(A2.SY_AREA_ALLOW_SALE, 0),
											NVL(A2.AREA_NOT_PLANNING_PERMIT, 0) AS AREA_NOT_PLANNING_PERMIT, NVL(A2.AREA_NOT_CONSTRUCTION_PERMIT, 0) AS AREA_NOT_CONSTRUCTION_PERMIT,
											NVL(A2.AREA_NOT_SALE_PERMIT, 0) AREA_NOT_SALE_PERMIT, NVL(A2.AREA_NOT_COMPLETION, 0) AS AREA_NOT_COMPLETION, NVL(A2.AREA_YES_COMPLETION, 0) AS AREA_YES_COMPLETION,
											NVL(A2.AREA_YES_SETTLEMENT, 0) AS AREA_YES_SETTLEMENT, NVL(A2.ZZ_AREA_STOCK, 0), NVL(A2.SY_AREA_STOCK, 0), NVL(A2.CW_AREA_STOCK, 0), A2.PROJ_CON, '0' AS ORGTYPE
							FROM   TMP_PROJ_AREA A2
							INNER  JOIN SYS_BUSINESS_UNIT B2
							ON     A2.PARENT_ID = B2.ID),
						
						--库存
						TMP_STOCK_VALUE(ORG_ID,
						ORGNAME,
						PARENTID,
						ORDER_HIERARCHY_CODE,
						ORGTYPE,
						SIX_MONTH_IN,
						SIX_TO_TWELVE_MONTH,
						TWELVE_TO_EIGHTEEN_MONTH,
						EIGHTEEN_MONTH_ABOVE,
						TOTAL) AS
						 (
							--子集
							SELECT A1.ID AS ORG_ID, A1.PROJECT_NAME AS ORGNAME, A1.UNIT_ID AS PARENT_ID, A1.ORDER_HIERARCHY_CODE, '1' AS ORGTYPE,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) <= 5 THEN
																B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS SIX_MONTH_IN,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) BETWEEN 6 AND 12 THEN
																B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS SIX_TO_TWELVE_MONTH,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) BETWEEN 12 AND 18 THEN
																B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS TWELVE_TO_EIGHTEEN_MONTH,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) > 18 OR C1.GET_PRE_SALE_PERMIT_DATE IS NULL THEN
																B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS EIGHTEEN_MONTH_ABOVE, SUM( B1.PRE_BLD_AREA) AS TOTAL
							FROM   SYS_PROJECT A1
							LEFT   JOIN MDM_ROOM B1
							ON     A1.ID = B1.PROJECT_ID AND
										 B1.SALE_STATE <> '签约'
							LEFT   JOIN MDM_BUILD C1
							ON     B1.BUILDING_ID = C1.ID
							GROUP  BY A1.ID, A1.PROJECT_NAME, A1.UNIT_ID, A1.ORDER_HIERARCHY_CODE
							--父级
							UNION ALL
							SELECT B2.ID, B2.ORG_NAME, B2.PARENT_ID, B2.ORDER_HIERARCHY_CODE, '0' AS ORGTYPE, SIX_MONTH_IN, SIX_TO_TWELVE_MONTH, TWELVE_TO_EIGHTEEN_MONTH, EIGHTEEN_MONTH_ABOVE, TOTAL
							FROM   TMP_STOCK_VALUE A2
							INNER  JOIN SYS_BUSINESS_UNIT B2
							ON     A2.PARENTID = B2.ID)
						
						SELECT *
						FROM   (SELECT 11 AS "groupId", '1:各阶段货量分布' AS "groupName", '#4472C4' AS "itemColor", '未取证' AS "itemName", P.AREA_NOT_PLANNING_PERMIT AS "statistics"
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 11 AS "groupId", '1:各阶段货量分布', '#ED7D31' AS "itemColor", '已取规划许可证' AS "itemName", P.AREA_NOT_CONSTRUCTION_PERMIT
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 11 AS "groupId", '1:各阶段货量分布', '#A5A5A5' AS "itemColor", '已取施工许可证' AS "itemName", P.AREA_NOT_SALE_PERMIT
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 11 AS "groupId", '1:各阶段货量分布', '#FFC000' AS "itemColor", '已取预售许可证' AS "itemName", P.AREA_NOT_COMPLETION
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 11 AS "groupId", '1:各阶段货量分布', '#5B9BD5' AS "itemColor", '已取竣工备案证' AS "itemName", P.AREA_YES_COMPLETION
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 11 AS "groupId", '1:各阶段货量分布', '#00CED1' AS "itemColor", '已结转' AS "itemName", P.AREA_YES_SETTLEMENT
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 12, '2:各业态货量分布', '#5B9BD5', '住宅', P.ZZ_AREA_ALLOW_SALE
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										  UNION ALL
                     SELECT 12, '2:各业态货量分布', '#4472C4', '车位', P.CW_AREA_ALLOW_SALE
                     FROM   TMP_PROJ_AREA P
                     WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 12, '2:各业态货量分布', '#FFC000', '商业', P.SY_AREA_ALLOW_SALE
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 13, '3:已推未售货量分布', '#5B9BD5', '住宅', P.ZZ_AREA_STOCK
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 13, '3:已推未售货量分布', '#FFC000', '商业', P.SY_AREA_STOCK
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
                     SELECT 13, '3:已推未售货量分布', '#4472C4', '车位', p.CW_AREA_STOCK
                     FROM   TMP_PROJ_AREA P
                     WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 14, '4:库存货龄分布', '#4472C4', '6个月以内', SUM(P.SIX_MONTH_IN)
										 FROM   TMP_STOCK_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 14, '4:库存货龄分布', '#FFC000', '6-12个月', SUM(P.SIX_TO_TWELVE_MONTH)
										 FROM   TMP_STOCK_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 14, '4:库存货龄分布', '#5B9BD5', '12-18个月', SUM(P.TWELVE_TO_EIGHTEEN_MONTH) 
										 FROM   TMP_STOCK_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 14, '4:库存货龄分布', '#FA8072', '18个月以上', SUM(P.EIGHTEEN_MONTH_ABOVE) 
										 FROM   TMP_STOCK_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 
										 ) M
						WHERE  m."statistics" <> 0;
				
		
		END IF;

END P_DWM_W_VISUAL_LAYOUT;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_WORTH_BIG_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_W_WORTH_BIG_DATA" 
(
	  ORGID         IN VARCHAR2---查询货值的组织
	 ,ORGTYPE       IN VARCHAR2---查询货值的类型 
     ,i_source      IN VARCHAR2---请求数据源 OA、DWM
     ,userid           IN               VARCHAR2---当前登录人
     ,stationid        IN               VARCHAR2---当前登录人岗位
     ,deptid           IN               VARCHAR2---当前登录人部门
     ,companyid        IN               VARCHAR2---当前登录人公司
	 ,TARGETWORTH  OUT SYS_REFCURSOR---目标货值
	 ,DYNAMICWORTH OUT SYS_REFCURSOR---动态货值
     ,O_SOURCECONFIG OUT SYS_REFCURSOR---配置
	 ,DESCRIPTION  OUT CLOB--货值下方描述
) AS
		--动态货值监控-tab货值大数据
		--作者：陈丽
		--修改者：谢松宏
        --修改者：陈丽 20200626 于政要求，动态货值监控-货值数据，库存货值和剩余货值需要对齐。调整后按固定宽度计算。要求 '目标总货值'和'动态总货值' id 不能改变。
		--修改者：陈丽 20200809 chenl 动态货值监控中货值数据tab页，货值阶段图中结转阶段删除。 
        --日期：2020-03-31
		V_DT_VALUE_ALL      NUMBER(18, 2); --动态总货值
		V_DT_SYHZ_VALUE_ALL NUMBER(18, 2); --剩余货值
		V_DT_YSHZ_VALUE     NUMBER(18, 2); --已售货值
		V_DT_CBHZ_VALUE     NUMBER(18, 2); --储备货值
		V_DT_ZTHZ_VALUE     NUMBER(18, 2); --在途货值
		V_DT_YQZHZ_VALUE    NUMBER(18, 2); --已取证货值
		V_DT_KCHZ_VALUE     NUMBER(18, 2); --库存货值
		V_DT_WQGZHZ_VALUE   NUMBER(18, 2); --未取规证货值
		V_DT_GHXKZHZ_VALUE  NUMBER(18, 2); --规划许可证货值
		V_DT_SGXKZHZ_VALUE  NUMBER(18, 2); --施工许可证货值
		V_DT_YSXKZHZ_VALUE  NUMBER(18, 2); --预售许可证货值
		V_DT_JGBAHZ_VALUE   NUMBER(18, 2); --竣工备案货值
		V_DT_JZHZ_VALUE     NUMBER(18, 2); --结转货值
        page_source VARCHAR2(10):=UPPER(nvl(i_source,'dwm'));
        oa_page_source_val VARCHAR2(10):=UPPER('OA');
        min_base_width VARCHAR2(10):=(case when page_source=oa_page_source_val then '75' else '85' end);
        base_width NUMBER(18, 2):=(case when page_source=oa_page_source_val then 170 else 430 end);
        未取规证	 VARCHAR2(10):=min_base_width;
        规划许可证阶段 VARCHAR2(10):=	min_base_width;
        施工许可证阶段 VARCHAR2(10):=	min_base_width;
        预售许可证阶段	 VARCHAR2(10):=min_base_width;
        竣工备案阶段	 VARCHAR2(10):=min_base_width;
        结转阶段	 VARCHAR2(10):=min_base_width;

        储备货值	 VARCHAR2(10):=min_base_width;
        在途货值 VARCHAR2(10):=to_char(2*min_base_width,'99,990.0');
        已取证货值 VARCHAR2(10):=to_char(2*min_base_width,'99,990.0');
        库存货值	 VARCHAR2(10):=min_base_width;
        已售货值1	 VARCHAR2(10):=to_char(1*min_base_width,'99,990.0');

        剩余货值	 VARCHAR2(10):=to_char(储备货值+在途货值+库存货值,'99,990.0');
        已售货值	 VARCHAR2(10):=已售货值1;

        base_row_width  NUMBER(18, 2):=base_width+剩余货值+已售货值; --总宽度
        jumpurl VARCHAR2(500);
        domain VARCHAR2(500):=GET_JUMP_URL_DOMAIN('pc','dwm');
        oaj   VARCHAR2(500):=domain||'/dwm/value-manage/dynamic-value/value-monitor?companyId=003200000000000000000000000000&orgtype=0&projectId=003200000000000000000000000000&tabType=5';--门户

        mj   VARCHAR2(500):=domain||'/dwm/value-manage/value-project/list?code=value_list&companyId=003200000000000000000000000000&projectId=003200000000000000000000000000';--计划系统
				


BEGIN
-------------------------20200701 集团栗亚鹏和于政提出  门户网站货值数据页面,区域较小 所以根据源设置高度和字体

				IF ORGTYPE=10 THEN  --李小聪
				mj  :='';
				SELECT  		'dwm/value-manage/value-project/detail?code=value_dtl&isOperate='||PROJ_COOPERATE||'&projectId='||id||'&projectName='||PROJECT_NAME||'&projectDate='||TO_CHAR(PROJECT_GET_TIME,'YYYY-MM-DD')||'&tabIndex=1&pageTitle='||PROJECT_NAME  INTO mj  FROM SYS_PROJECT WHERE ID=ORGID;
				mj  :=domain||mj;
		 ELSE 
		 
		 mj  := '/dwm/value-manage/value-project/list?code=value_list&companyId='||ORGID||'&projectId=003200000000000000000000000000';
		  mj   :=domain||mj;
				END IF;
		
				
   BEGIN   
    OPEN o_sourceConfig FOR select (case when page_source=oa_page_source_val then 42 else 60 end) as rowHeight
         ,(case when page_source=oa_page_source_val then 12 else 18 end) as valueFontSize
         ,(case when page_source=oa_page_source_val then 42 else 60 end) as  leftWidth
         ,(case when page_source=oa_page_source_val then 2 else 10 end) as  spacing
         ,(case when page_source=oa_page_source_val then 8 else 12 end) as descriptionFontSize
           from dual;
         jumpurl:=(case when page_source=oa_page_source_val then oaj else mj end);
           EXCEPTION
        WHEN OTHERS THEN 
           jumpurl:=mj;
        OPEN o_sourceConfig FOR select 60 as rowHeight
         ,18 as valueFontSize
         ,60 as  leftWidth
         ,10 as  spacing
         ,12 as descriptionFontSize
          from dual;
    END; 
		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_DT_ALL) / 100000000, 2)
						FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
						LEFT   JOIN SYS_PROJECT SP
						ON     PP.ID = SP.UNIT_ID
						LEFT   JOIN DWM_DT_VALUE DDV
						ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_DT_ALL / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_VALUE_ALL
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;



		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_REMAIN) / 100000000, 2)
						FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
						LEFT   JOIN SYS_PROJECT SP
						ON     PP.ID = SP.UNIT_ID
						LEFT   JOIN DWM_DT_VALUE DDV
						ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_REMAIN / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_SYHZ_VALUE_ALL
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_HAVED_SALE) / 100000000, 2)
						FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
						LEFT   JOIN SYS_PROJECT SP
						ON     PP.ID = SP.UNIT_ID
						LEFT   JOIN DWM_DT_VALUE DDV
						ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_HAVED_SALE / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_YSHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_RESERVE) / 100000000, 2)
						FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
						LEFT   JOIN SYS_PROJECT SP
						ON     PP.ID = SP.UNIT_ID
						LEFT   JOIN DWM_DT_VALUE DDV
						ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_RESERVE / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_CBHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_IN_PROCESS) / 100000000, 2)
						FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
						LEFT   JOIN SYS_PROJECT SP
						ON     PP.ID = SP.UNIT_ID
						LEFT   JOIN DWM_DT_VALUE DDV
						ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_IN_PROCESS / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_ZTHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;


		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_NOT_CONSTRUCTION_PERMIT) / 100000000, 2)
						FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
						LEFT   JOIN SYS_PROJECT SP
						ON     PP.ID = SP.UNIT_ID
						LEFT   JOIN DWM_DT_VALUE DDV
						ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_NOT_CONSTRUCTION_PERMIT / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_GHXKZHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_STOCK) / 100000000, 2)
						FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
						LEFT   JOIN SYS_PROJECT SP
						ON     PP.ID = SP.UNIT_ID
						LEFT   JOIN DWM_DT_VALUE DDV
						ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_STOCK / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_KCHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		V_DT_YQZHZ_VALUE := V_DT_YSHZ_VALUE + V_DT_KCHZ_VALUE;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_NOT_PLANNING_PERMIT) / 100000000, 2)
						FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
						LEFT   JOIN SYS_PROJECT SP
						ON     PP.ID = SP.UNIT_ID
						LEFT   JOIN DWM_DT_VALUE DDV
						ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_NOT_PLANNING_PERMIT / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_WQGZHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_NOT_SALE_PERMIT) / 100000000, 2)
						FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
						LEFT   JOIN SYS_PROJECT SP
						ON     PP.ID = SP.UNIT_ID
						LEFT   JOIN DWM_DT_VALUE DDV
						ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_NOT_SALE_PERMIT / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_SGXKZHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_NOT_COMPLETION) / 100000000, 2)
						FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
						LEFT   JOIN SYS_PROJECT SP
						ON     PP.ID = SP.UNIT_ID
						LEFT   JOIN DWM_DT_VALUE DDV
						ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_NOT_COMPLETION / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_YSXKZHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_YES_COMPLETION) / 100000000, 2)
						FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
						LEFT   JOIN SYS_PROJECT SP
						ON     PP.ID = SP.UNIT_ID
						LEFT   JOIN DWM_DT_VALUE DDV
						ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_YES_COMPLETION / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_JGBAHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_YES_SETTLEMENT) / 100000000, 2)
						FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
						LEFT   JOIN SYS_PROJECT SP
						ON     PP.ID = SP.UNIT_ID
						LEFT   JOIN DWM_DT_VALUE DDV
						ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_YES_SETTLEMENT / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_JZHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;
----20200809 chenl 动态货值监控中货值数据tab页，货值阶段图中结转阶段删除。 
        V_DT_JZHZ_VALUE:=0;
		OPEN TARGETWORTH FOR 
				SELECT (case 
 when "id"='未取规证' then 未取规证 
 when "id"='规划许可证阶段' then 规划许可证阶段 
 when "id"='施工许可证阶段' then 施工许可证阶段 
 when "id"='预售许可证阶段' then 预售许可证阶段 
 when "id"='竣工备案阶段' then 竣工备案阶段 
 --when "id"='结转阶段' then 结转阶段 
 when "id"='储备货值（c=b0）' then 储备货值 
 when "id"='在途货值（d）' then 在途货值 
 when "id"='已取证货值' then 已取证货值 
 when "id"='库存货值' then 库存货值 
 when "id"='已售货值1' then 已售货值1 
 when "id"='剩余货值' then 剩余货值 
 when "id"='已售货值（E2）' then 已售货值
 else '6' end  ) AS "minPercentage"
 ,base_row_width as "baseRowWidth"
 ,to_char(base_width/(case when V_DT_VALUE_ALL=0 then 1 else V_DT_VALUE_ALL end),'fm990.000000000000000000000000000') as "singleWidth"
 ,jumpurl as "jumpUrl"
 , RESULT.*
				FROM   (SELECT '目标总货值' AS "id", NULL AS "parentsId", ' 目标 总货值' AS "name", NULL AS "value", '#009900' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
								 FROM   SYS_BUSINESS_UNIT AA
								 WHERE  AA.IS_COMPANY = 1 AND AA.ID = '003200000000000000000000000000'
--								 UNION ALL
--								 SELECT AA.ID AS "id", '目标总货值' AS "parentsId", 'A1可研版目标货值' AS "name",
--												NVL((SELECT ROUND(SUM(DDV.TARGET_A1_VALUE) / 10000, 2)
--														 FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
--														 LEFT   JOIN SYS_PROJECT SP
--														 ON     PP.ID = SP.UNIT_ID
--														 LEFT   JOIN DWM_DT_VALUE DDV
--														 ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.TARGET_A1_VALUE / 10000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0) AS "value",
--												'#009900' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
--								 FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
--								 WHERE  AA.ID = ORGID
--								 UNION ALL
--								 SELECT AA.ID, '目标总货值', 'A2全盘版目标货值',
--												NVL((SELECT ROUND(SUM(DDV.TARGET_A2_VALUE) / 10000, 2)
--														 FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
--														 LEFT   JOIN SYS_PROJECT SP
--														 ON     PP.ID = SP.UNIT_ID
--														 LEFT   JOIN DWM_DT_VALUE DDV
--														 ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.TARGET_A2_VALUE / 10000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0),
--												'#009900' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
--								 FROM   ((SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP)) AA
--								 WHERE  AA.ID = ORGID
--								 UNION ALL
--								 SELECT AA.ID, '目标总货值', 'A3动态版目标货值',
--												NVL((SELECT ROUND(SUM(DDV.TARGET_A3_VALUE) / 10000, 2)
--														 FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
--														 LEFT   JOIN SYS_PROJECT SP
--														 ON     PP.ID = SP.UNIT_ID
--														 LEFT   JOIN DWM_DT_VALUE DDV
--														 ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.TARGET_A3_VALUE / 10000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0),
--												'#009900' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
--								 FROM   ((SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP)) AA
--								 WHERE  AA.ID = ORGID
								 UNION ALL
								 SELECT AA.ID, '目标总货值', '最新版目标货值',
												NVL((SELECT ROUND(SUM(DDV.TARGET_A_VALUE) / 10000, 2)
														 FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
														 LEFT   JOIN SYS_PROJECT SP
														 ON     PP.ID = SP.UNIT_ID
														 LEFT   JOIN DWM_DT_VALUE DDV
														 ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.TARGET_A_VALUE / 10000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0),
												'#FFA500' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
								 FROM   ((SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP)) AA
								 WHERE  AA.ID = ORGID) RESULT;

		OPEN DYNAMICWORTH FOR
				SELECT (case 
 when "id"='未取规证' then 未取规证 
 when "id"='规划许可证阶段' then 规划许可证阶段 
 when "id"='施工许可证阶段' then 施工许可证阶段 
 when "id"='预售许可证阶段' then 预售许可证阶段 
 when "id"='竣工备案阶段' then 竣工备案阶段 
 --when "id"='结转阶段' then 结转阶段 
 when "id"='储备货值（c=b0）' then 储备货值 
 when "id"='在途货值（d）' then 在途货值 
 when "id"='已取证货值' then 已取证货值 
 when "id"='库存货值' then 库存货值 
 when "id"='已售货值1' then 已售货值1 
 when "id"='剩余货值' then 剩余货值 
 when "id"='已售货值（E2）' then 已售货值
 else '6' end  ) AS "minPercentage"
 ,base_row_width as "baseRowWidth"
 ,to_char(base_width/(case when V_DT_VALUE_ALL=0 then 1 else V_DT_VALUE_ALL end),'fm990.000000000000000000000000000') as "singleWidth"
 ,jumpurl as "jumpUrl"
 ,"id", "parentsId", "name", "value", "color" AS "color", "bgColor" AS "bgColor", "nameColor" AS "nameColor",
							 CASE WHEN "name"=
										'已取证货值' THEN
										 1
										ELSE
										 0
								END AS "isNesting", 0 "layout"
				FROM   (SELECT '动态总货值' AS "id", '' AS "parentsId", ' 动态 总货值' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_VALUE_ALL, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 --- 动态总货值
								 UNION ALL
								 SELECT '0' AS "id", '动态总货值' AS "parentsId", '动态总货值' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_VALUE_ALL, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '1' AS "id", '动态总货值' AS "parentsId", '' AS "name", '#ffffff' AS "color", '#00BFFF' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_VALUE_ALL, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '剩余货值' AS "id", '1' AS "parentsId", '剩余货值' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_SYHZ_VALUE_ALL, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
--                                 --------------------chenl
--                                  UNION ALL
--								 SELECT '储备货值（c=b0）old' AS "id", '剩余货值' AS "parentsId", '储备货值（c=b0）' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
--												RTRIM(TO_CHAR(V_DT_CBHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
--								 FROM   DUAL
--								 UNION ALL
--								 SELECT '在途货值（d）old' AS "id", '剩余货值' AS "parentsId", '在途货值（d）' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
--												RTRIM(TO_CHAR(V_DT_ZTHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
--								 FROM   DUAL
--                                  UNION ALL
--								 SELECT '库存货值old' AS "id", '剩余货值' AS "parentsId", '库存货值' AS "name", '#ffffff' AS "color", '#e46c0a' AS "bgColor", '#666666' AS "nameColor",
--												RTRIM(TO_CHAR(V_DT_KCHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
--								 FROM   DUAL
--                                 ---------------------chenl
								 UNION ALL
								 SELECT '已售货值（E2）' AS "id", '1' AS "parentsId", '已售货值（E2）' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_YSHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 ------2
								 UNION ALL
								 SELECT '2' AS "id", '动态总货值' AS "parentsId", '' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_VALUE_ALL, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '储备货值（c=b0）' AS "id", '2' AS "parentsId", '储备货值（c=b0）' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_CBHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '在途货值（d）' AS "id", '2' AS "parentsId", '在途货值（d）' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_ZTHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '已取证货值' AS "id", '2' AS "parentsId", '已取证货值' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_YQZHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '库存货值' AS "id", '已取证货值' AS "parentsId", '库存货值' AS "name", '#ffffff' AS "color", '#e46c0a' AS "bgColor", '#666666' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_KCHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '已售货值1' AS "id", '已取证货值' AS "parentsId", '已售货值' AS "name", '#ffffff' AS "color", '#00b050' AS "bgColor", '#d7d7d7' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_YSHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 --------------------3
								 UNION ALL
								 SELECT '3' AS "id", '动态总货值' AS "parentsId", '' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#666666' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_VALUE_ALL, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '未取规证' AS "id", '3' AS "parentsId", '未取规证' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_WQGZHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '规划许可证阶段' AS "id", '3' AS "parentsId", '规划许可证阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor",
												RTRIM(TO_CHAR(NVL(V_DT_GHXKZHZ_VALUE, 0), 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '施工许可证阶段' AS "id", '3' AS "parentsId", '施工许可证阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_SGXKZHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '预售许可证阶段' AS "id", '3' AS "parentsId", '预售许可证阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_YSXKZHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '竣工备案阶段' AS "id", '3' AS "parentsId", '竣工备案阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_JGBAHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
--								 UNION ALL
--								 SELECT '结转阶段' AS "id", '3' AS "parentsId", '结转阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor",
--												RTRIM(TO_CHAR(V_DT_JZHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
--								 FROM   DUAL
                                 ) A;

		DESCRIPTION := '<span style="font-size:14px;color:#333333"><span style="font-weight:bold">最新版目标总货值： </span>若有"动态版目标货值"，则取"动态版目标货值"；若无"动态版目标货值"，则取"全盘版目标货值"；若无"全盘版目标货值"，则取"可研版目标货值。</span></br>
<span style="font-size:14px;color:#333333"><span style="font-weight:bold">动态总货值</span> =剩余货值+已售货值=储备货值+在途货值+库存货值+已售货值。</span></br>
<span style="font-size:14px;color:#333333"><span style="font-weight:bold">剩余货值</span> =储备货值+在途货值+库存货值。</span></br>
<span style="font-size:14px;color:#333333"><span style="font-weight:bold">已售货值：</span> 已拿预售许可证且已签约的货值，取《销售系统》中的签约金额。</span></br>
<span style="font-size:14px;color:#333333"><span style="font-weight:bold">储备货值(即未取规证货值)： </span>面积取主数据中“未取规证的面积”，价格按业态取最新的目标均价。</span></br>
<span style="font-size:14px;color:#333333"><span style="font-weight:bold">在途货值： </span>面积取主数据中“已取规证未取预售许可证的面积”，价格按业态取最新的目标均价。</span></br>
<span style="font-size:14px;color:#333333"><span style="font-weight:bold">已取证货值： </span>已拿预售许可证货值，包括“未签约、已签约”。</span></br>
<span style="font-size:14px;color:#333333"><span style="font-weight:bold">库存货值： </span>已拿预售许可证但未签约的货值，取《销售系统》中的价格。</span>';
END P_DWM_W_WORTH_BIG_DATA;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_WORTH_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_W_WORTH_DATA" 
(
		ORGID        IN VARCHAR2
	 ,ORGTYPE      IN VARCHAR2
	 ,TARGETWORTH  OUT SYS_REFCURSOR
	 ,DYNAMICWORTH OUT SYS_REFCURSOR
) AS
		--动态货值监控-tab货值大数据
		--作者：陈丽
		--日期：2019/11/13
		V_DT_VALUE_ALL      NUMBER(18, 2); --动态总货值
		V_DT_SYHZ_VALUE_ALL NUMBER(18, 2); --剩余货值
		V_DT_YSHZ_VALUE     NUMBER(18, 2); --已售货值
		V_DT_CBHZ_VALUE     NUMBER(18, 2); --储备货值
		V_DT_ZTHZ_VALUE     NUMBER(18, 2); --在途货值
		V_DT_YQZHZ_VALUE    NUMBER(18, 2); --已取证货值
		V_DT_KCHZ_VALUE     NUMBER(18, 2); --库存货值
		V_DT_WQGZHZ_VALUE   NUMBER(18, 2); --未取规证货值
		V_DT_GHXKZHZ_VALUE  NUMBER(18, 2); --规划许可证货值
		V_DT_SGXKZHZ_VALUE  NUMBER(18, 2); --施工许可证货值
		V_DT_YSXKZHZ_VALUE  NUMBER(18, 2); --预售许可证货值
		V_DT_JGBAHZ_VALUE   NUMBER(18, 2); --竣工备案货值
		V_DT_JZHZ_VALUE     NUMBER(18, 2); --结转货值
BEGIN
		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_DT_ALL) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_DT_ALL/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_VALUE_ALL
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_REMAIN) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_REMAIN/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_SYHZ_VALUE_ALL
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_REMAIN) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_REMAIN/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_SYHZ_VALUE_ALL
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_HAVED_SALE) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_HAVED_SALE/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_YSHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_RESERVE) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_RESERVE/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_CBHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_IN_PROCESS) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_IN_PROCESS/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_ZTHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_STOCK) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_STOCK/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_YQZHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_STOCK) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_STOCK/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_KCHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE 
					 AA.ID = ORGID;

		V_DT_YQZHZ_VALUE := V_DT_YSHZ_VALUE + V_DT_KCHZ_VALUE;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_NOT_PLANNING_PERMIT) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_NOT_PLANNING_PERMIT/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_WQGZHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_NOT_SALE_PERMIT) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_NOT_SALE_PERMIT/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_SGXKZHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_NOT_COMPLETION) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_NOT_COMPLETION/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_YSXKZHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_YES_COMPLETION) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_YES_COMPLETION/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_JGBAHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_YES_SETTLEMENT) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_YES_SETTLEMENT/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_JZHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		OPEN TARGETWORTH FOR
				SELECT '目标总货值' AS "id", NULL AS "parentsId", '目标总货值' AS "name", NULL AS "value", '#009900' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
				FROM   SYS_BUSINESS_UNIT AA
				WHERE  AA.IS_COMPANY = 1 AND
							 AA.ID = '003200000000000000000000000000'
				UNION ALL
				SELECT AA.ID AS "id", '目标总货值' AS "parentsId", 'A1可研版目标货值' AS "name",
							 NVL((SELECT ROUND(SUM(DDV.TARGET_A1_VALUE) / 10000, 2)
								 FROM   SYS_BUSINESS_UNIT SBU
								 LEFT   JOIN SYS_PROJECT SP
								 ON     SBU.ID = SP.UNIT_ID
								 LEFT   JOIN DWM_DT_VALUE DDV
								 ON     DDV.OBJ_ID = SP.ID
								 WHERE  SBU.IS_COMPANY = 1
								 START  WITH SBU.ID = AA.ID
								 CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),0)+NVL((SELECT round(P.TARGET_A1_VALUE/10000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0) AS "value", '#009900' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
				FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
				WHERE  
							 AA.ID = ORGID
				UNION ALL
				SELECT AA.ID, '目标总货值', 'A2全盘版目标货值',
							 NVL((SELECT ROUND(SUM(DDV.TARGET_A2_VALUE) / 10000, 2)
								 FROM   SYS_BUSINESS_UNIT SBU
								 LEFT   JOIN SYS_PROJECT SP
								 ON     SBU.ID = SP.UNIT_ID
								 LEFT   JOIN DWM_DT_VALUE DDV
								 ON     DDV.OBJ_ID = SP.ID
								 WHERE  SBU.IS_COMPANY = 1
								 START  WITH SBU.ID = AA.ID
								 CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),0)+NVL((SELECT round(P.TARGET_A2_VALUE/10000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0), '#009900' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
				FROM   ((SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP)) AA
				WHERE  
							 AA.ID = ORGID
				UNION ALL
				SELECT AA.ID, '目标总货值', 'A3动态版目标货值',
							 NVL((SELECT ROUND(SUM(DDV.TARGET_A3_VALUE) / 10000, 2)
								 FROM   SYS_BUSINESS_UNIT SBU
								 LEFT   JOIN SYS_PROJECT SP
								 ON     SBU.ID = SP.UNIT_ID
								 LEFT   JOIN DWM_DT_VALUE DDV
								 ON     DDV.OBJ_ID = SP.ID
								 WHERE  SBU.IS_COMPANY = 1
								 START  WITH SBU.ID = AA.ID
								 CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),0)+NVL((SELECT round(P.TARGET_A3_VALUE/10000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0), '#009900' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
				FROM   ((SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP)) AA
				WHERE  
							 AA.ID = ORGID
				UNION ALL
				SELECT AA.ID, '目标总货值', '最新版目标货值' AS FLAG,
							 NVL((SELECT ROUND(SUM(DDV.TARGET_WORTH) / 10000, 2)
								 FROM   SYS_BUSINESS_UNIT SBU
								 LEFT   JOIN SYS_PROJECT SP
								 ON     SBU.ID = SP.UNIT_ID
								 LEFT   JOIN V_DWM_TARGET_WORTH_NOW DDV
								 ON     DDV.PROJ_ID = SP.ID
								 WHERE  SBU.IS_COMPANY = 1
								 START  WITH SBU.ID = AA.ID
								 CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),0)+NVL((SELECT round(P.TARGET_WORTH/10000,2)
												 FROM   V_DWM_TARGET_WORTH_NOW P
												 WHERE  P.proj_id = AA.ID ),
												 0), '#FFA500' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
				FROM   ((SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP)) AA
				WHERE 
							 AA.ID = ORGID;

		OPEN DYNAMICWORTH FOR
				SELECT "id", "parentsId", "name", "value", "color" AS "color", "bgColor" AS "bgColor", "nameColor" AS "nameColor",
							 CASE "name"
										WHEN '已取证货值' THEN
										 1
										ELSE
										 0
								END AS "isNesting", 1 "layout"
				FROM   (SELECT '动态总货值' AS "id", '' AS "parentsId", '动态总货值' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_VALUE_ALL AS "value"
								 FROM   DUAL
								 --- 动态总货值
								 UNION ALL
								 SELECT '0' AS "id", '动态总货值' AS "parentsId", '动态总货值' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_VALUE_ALL AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '1' AS "id", '动态总货值' AS "parentsId", '' AS "name", '#ffffff' AS "color", '#00BFFF' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_VALUE_ALL AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '剩余货值' AS "id", '1' AS "parentsId", '剩余货值' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_SYHZ_VALUE_ALL AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '已售货值（E2）' AS "id", '1' AS "parentsId", '已售货值（E2）' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_YSHZ_VALUE AS "value"
								 FROM   DUAL
								 ------2
								 UNION ALL
								 SELECT '2' AS "id", '动态总货值' AS "parentsId", '' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_VALUE_ALL AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '储备货值（c=b0）' AS "id", '2' AS "parentsId", '储备货值（c=b0）' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_CBHZ_VALUE AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '在途货值（d）' AS "id", '2' AS "parentsId", '在途货值（d）' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_ZTHZ_VALUE AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '已取证货值' AS "id", '2' AS "parentsId", '已取证货值' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_YQZHZ_VALUE AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '库存货值' AS "id", '已取证货值' AS "parentsId", '库存货值' AS "name", '#ffffff' AS "color", '#e46c0a' AS "bgColor", '#666666' AS "nameColor", V_DT_KCHZ_VALUE AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '已售货值1' AS "id", '已取证货值' AS "parentsId", '已售货值' AS "name", '#ffffff' AS "color", '#00b050' AS "bgColor", '#d7d7d7' AS "nameColor", V_DT_YSHZ_VALUE AS "value"
								 FROM   DUAL
								 --------------------3
								 UNION ALL
								 SELECT '3' AS "id", '动态总货值' AS "parentsId", '' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#666666' AS "nameColor", V_DT_VALUE_ALL AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '未取规证' AS "id", '3' AS "parentsId", '未取规证' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor", V_DT_WQGZHZ_VALUE AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '规划许可证阶段' AS "id", '3' AS "parentsId", '规划许可证阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor", NVL(V_DT_GHXKZHZ_VALUE, 0) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '施工许可证阶段' AS "id", '3' AS "parentsId", '施工许可证阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor", V_DT_SGXKZHZ_VALUE AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '预售许可证阶段' AS "id", '3' AS "parentsId", '预售许可证阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor", V_DT_YSXKZHZ_VALUE AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '竣工备案阶段' AS "id", '3' AS "parentsId", '竣工备案阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor", V_DT_JGBAHZ_VALUE AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '结转阶段' AS "id", '3' AS "parentsId", '结转阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor", V_DT_JZHZ_VALUE AS "value"
								 FROM   DUAL) A;

END P_DWM_W_WORTH_DATA;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_WORTH_LAYOUT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_W_WORTH_LAYOUT" 
(
    TITLE     OUT VARCHAR2
   ,WACTHINFO OUT SYS_REFCURSOR
) AS
    --动态货值监控-1布局动态
    --作者：陈丽
    --日期：2019/11/13
    V_PROJECT_TOTAL  NUMBER(5, 0) := 20;
    V_CITY_TOTAL     NUMBER(5, 0) := 4;
    V_BUSINESS_TOTAL NUMBER(5, 0) := 3;
    V_REGION_TOTAL   NUMBER(5, 0) := 1;
BEGIN
SELECT COUNT(1) INTO V_PROJECT_TOTAL FROM SYS_PROJECT;

SELECT COUNT(1) INTO V_BUSINESS_TOTAL FROM (SELECT COUNT(*) FROM SYS_PROJECT GROUP BY UNIT_ID);

SELECT COUNT(1)
INTO   V_REGION_TOTAL
FROM   (SELECT DISTINCT (SELECT O.ORG_NAME FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH A.UNIT_ID = O.ID CONNECT BY PRIOR O.PARENT_ID = O.ID) ORG_NAME --,A.ID,A.PROJECT_NAME
         FROM   SYS_PROJECT A);

SELECT COUNT(1) INTO V_CITY_TOTAL FROM (SELECT COUNT(1) FROM SYS_PROJECT GROUP BY CITY_NAME);

OPEN WACTHINFO FOR
    SELECT '区域总数' AS "name", V_REGION_TOTAL AS "value", '/dwm/icon/format-master-data@1x.png' AS "icon"
    FROM   DUAL
    UNION
    SELECT '事业部总数' AS "name", V_BUSINESS_TOTAL AS "value", '/dwm/icon/company@2x.png' AS "icon"
    FROM   DUAL
    UNION
    SELECT '城市总数' AS "name", V_CITY_TOTAL AS "value", '/dwm/icon/business-management-report@2x.png' AS "icon"
    FROM   DUAL
    UNION
    SELECT '项目总数' AS "name", V_PROJECT_TOTAL AS "value", '/dwm/icon/project-master-data@2x.png' AS "icon"
    FROM   DUAL;
TITLE := '布局动态';
END P_DWM_W_WORTH_LAYOUT;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_WORTH_PHASE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_W_WORTH_PHASE" 
(
		TITLE     OUT VARCHAR2
	 ,MOREURL   OUT VARCHAR2
	 ,WACTHINFO OUT SYS_REFCURSOR
) AS
		--动态货值监控-3动态货值所处阶段
		--作者：陈丽
		--日期：2019/11/13
BEGIN
		OPEN WACTHINFO FOR
    SELECT * FROM (
				SELECT ' 未取规证' AS "NAME", 'B0' AS TOPLEFTCORNER,
							 '#C8CFD8' AS "color", '可售面积' AS TOTALNAME,
							 ROUND(SUM(NVL(A.AREA_NOT_PLANNING_PERMIT,0)) / 10000, 2) AS TOTALVALUE,
							 '万方' AS UNIT, 1 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT ' 未取规证' AS "NAME", 'B0' AS TOPLEFTCORNER,
							 '#C8CFD8' AS "color", '可售车位' AS TOTALNAME,
							 ROUND(CEIL(SUM(NVL(A.Cw_Area_Not_Planning_Permit,0))),0) AS TOTALVALUE,
                '个' AS UNIT,
							 2 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
        SELECT ' 未取规证' AS "NAME", 'B0' AS TOPLEFTCORNER,
               '#C8CFD8' AS "color", '可售货值' AS TOTALNAME,
               ROUND(SUM(NVL(A.VALUE_NOT_PLANNING_PERMIT,0)) / 100000000, 2) AS TOTALVALUE,
               '亿元' AS UNIT, 3 AS ORDER_CODE
        FROM   DWM_DT_VALUE A
        WHERE  A.OBJ_TYPE = '项目'
        UNION ALL

				SELECT '已取规证未取施证' AS "NAME", 'B1' AS TOPLEFTCORNER,
							 '#1D88C0' AS "color", '可售面积' AS TOTALNAME,
							 ROUND(SUM(NVL(A.AREA_NOT_CONSTRUCTION_PERMIT,0)) / 10000, 2) AS TOTALVALUE,
							 '万方' AS UNIT, 1 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已取规证未取施证' AS "NAME", 'B1' AS TOPLEFTCORNER,
							 '#1D88C0' AS "color", '可售车位' AS TOTALNAME,
							 ROUND(CEIL(SUM(NVL(A.CW_AREA_NOT_CONSTRUCTION_PER,0))),0) AS TOTALVALUE,
							 '个' AS UNIT, 2 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
        SELECT '已取规证未取施证' AS "NAME", 'B1' AS TOPLEFTCORNER,
               '#1D88C0' AS "color", '可售货值' AS TOTALNAME,
               ROUND(SUM(NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT,0)) / 100000000, 2) AS TOTALVALUE,
               '亿元' AS UNIT, 3 AS ORDER_CODE
        FROM   DWM_DT_VALUE A
        WHERE  A.OBJ_TYPE = '项目'
        UNION ALL
				SELECT '已取施证未取预售证' AS "NAME", 'B2' AS TOPLEFTCORNER,
							 '#1D88C0' AS "color", '可售货值' AS TOTALNAME,
							 ROUND(SUM(NVL(A.VALUE_NOT_SALE_PERMIT,0)) / 100000000, 2) AS TOTALVALUE,
							 '亿元' AS UNIT, 3 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已取施证未取预售证' AS "NAME", 'B2' AS TOPLEFTCORNER,
							 '#1D88C0' AS "color", '可售面积' AS TOTALNAME,
							 ROUND(SUM(NVL(A.AREA_NOT_SALE_PERMIT,0)) / 10000, 2) AS TOTALVALUE,
							 '万方' AS UNIT, 1 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已取施证未取预售证' AS "NAME", 'B2' AS TOPLEFTCORNER,
							 '#1D88C0' AS "color", '可售车位' AS TOTALNAME,
							 ROUND(CEIL(SUM(NVL(A.CW_AREA_NOT_SALE_PERMIT,0))),0) AS TOTALVALUE,
                '个' AS UNIT,
							 2 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已取预售证未售' AS "NAME", 'B3' AS TOPLEFTCORNER,
							 '#E68CB2' AS "color", '可售货值' AS TOTALNAME,
							 ROUND(SUM(NVL(A.VALUE_STOCK,0)) / 100000000, 2) AS TOTALVALUE,
							 '亿元' AS UNIT, 3 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已取预售证未售' AS "NAME", 'B3' AS TOPLEFTCORNER,
							 '#E68CB2' AS "color", '可售面积' AS TOTALNAME,
							 ROUND(SUM(NVL(A.AREA_STOCK,0)) / 10000, 2) AS TOTALVALUE,
							 '万方' AS UNIT, 1 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已取预售证未售' AS "NAME", 'B3' AS TOPLEFTCORNER,
							 '#E68CB2' AS "color", '可售车位' AS TOTALNAME,
							 ROUND(CEIL(SUM(NVL(A.CW_AREA_STOCK,0))),0) AS TOTALVALUE,
                '个' AS UNIT,
							 2 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
        UNION ALL
        SELECT ' 已售未竣备' AS "NAME", 'B4' AS TOPLEFTCORNER,
               '#00CC66' AS "color", '可售货值' AS TOTALNAME,
               ROUND((SUM(NVL(A.VALUE_NOT_COMPLETION,0))) / 100000000, 2) AS TOTALVALUE,
               '亿元' AS UNIT, 3 AS ORDER_CODE
        FROM   DWM_DT_VALUE A
        WHERE  A.OBJ_TYPE = '项目'
        UNION ALL
        SELECT ' 已售未竣备' AS "NAME", 'B4' AS TOPLEFTCORNER,
               '#00CC66' AS "color", '可售面积' AS TOTALNAME,
               ROUND((SUM(NVL(A.AREA_NOT_COMPLETION,0))) / 10000, 2) AS TOTALVALUE,
               '万方' AS UNIT, 1 AS ORDER_CODE
        FROM   DWM_DT_VALUE A
        WHERE  A.OBJ_TYPE = '项目'
        UNION ALL
        SELECT ' 已售未竣备' AS "NAME", 'B4' AS TOPLEFTCORNER,
               '#00CC66' AS "color", '可售车位' AS TOTALNAME,
               ROUND(CEIL(SUM(NVL(A.CW_AREA_NOT_COMPLETION,0))),0) AS TOTALVALUE,
                '个' AS UNIT,
               2 AS ORDER_CODE
        FROM   DWM_DT_VALUE A
        WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已售已竣备' AS "NAME", 'B5' AS TOPLEFTCORNER,
							 '#00CC66' AS "color", '可售货值' AS TOTALNAME,
							 ROUND(SUM(NVL(A.VALUE_YES_COMPLETION,0)) / 100000000, 2) AS TOTALVALUE,
							 '亿元' AS UNIT, 3 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已售已竣备' AS "NAME", 'B5' AS TOPLEFTCORNER,
							 '#00CC66' AS "color", '可售面积' AS TOTALNAME,
							 ROUND(SUM(NVL(A.AREA_YES_COMPLETION,0)) / 10000, 2) AS TOTALVALUE,
							 '万方' AS UNIT, 1 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已售已竣备' AS "NAME", 'B5' AS TOPLEFTCORNER,
							 '#00CC66' AS "color", '可售车位' AS TOTALNAME,
							 ROUND(CEIL(SUM(NVL(A.CW_AREA_YES_COMPLETION,0))),0) AS TOTALVALUE,
                '个' AS UNIT,
							 2 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
/*				UNION ALL
				SELECT '结转阶段' AS "NAME", '05' AS TOPLEFTCORNER, '#37cd69' AS "color",
							 '可售货值' AS TOTALNAME,
							 ROUND(SUM(A.VALUE_YES_SETTLEMENT) / 100000000, 2) AS TOTALVALUE,
							 '亿元' AS UNIT, 3 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '结转阶段' AS "NAME", '05' AS TOPLEFTCORNER, '#37cd69' AS "color",
							 '可售面积' AS TOTALNAME,
							 ROUND(SUM(A.AREA_YES_SETTLEMENT) / 100000000, 2) AS TOTALVALUE,
							 '万方' AS UNIT, 1 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '结转阶段' AS "NAME", '05' AS TOPLEFTCORNER, '#37cd69' AS "color",
							 '可售车位' AS TOTALNAME,
							 SUM(A.CW_AREA_YES_SETTLEMENT) AS TOTALVALUE, '个' AS UNIT,
							 2 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'*/
        ) t
        ORDER  BY TOPLEFTCORNER,ORDER_CODE
        ;

		MOREURL := '';

		TITLE := '动态货值阶段分布';
END P_DWM_W_WORTH_PHASE;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_云徙联合项目组
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_DWM_云徙联合项目组" 
(
INFO OUT SYS_REFCURSOR
) AS
BEGIN

   OPEN INFO FOR 
      WITH basedata AS(
    ---末级业态，关联得到顶级业态。及末级业态所属对象关联(楼栋/项目/分期)
    select 
    proj.id  as 项目id
    ,proj.PROJECT_NAME as 项目名称
    ,w.TARGET_WORTH_PHASE as 阶段类型
    ,case when proj_stage.id is null then build_proj_stage.id else proj_stage.id end as 分期id
    ,case when proj_stage.id is null then build_proj_stage.STAGE_NAME else proj_stage.STAGE_NAME end as 分期名称
    ,build.id as 楼栋id
    ,build.BUILD_NAME as 楼栋名称
    ,objtype.OBJ_TYPE as 业态对象父级类型
    ,dtl.obj_id||GET_UUID() as 末级业态id
    ,dtl.obj_name as 末级业态全路径
    ,dtl.TOTAL_SALES_AREA as 总可售面积
    ,dtl.WORTH as 总货值
    ,product_type.id as 顶级业态id
    ,product_type.product_type_short_name as 顶级业态
    ,dtl.obj_parent_id as 业态对象父级id
    from (select * from DWM_TARGET_WORTH_DTL where OBJ_TYPE=40) dtl
    --关联业态 找到业态顶级
    left join MDM_BUILD_PRODUCT_TYPE PRODUCT_TYPE 
    on substr(dtl.obj_name,1,instr(dtl.obj_name,'/',1,1)-1)=PRODUCT_TYPE.product_type_name
    --关联自身找到业态的父级对象 类型
    left join DWM_TARGET_WORTH_DTL objtype on dtl.obj_parent_id=objtype.obj_id
    --关联主表建立用于与项目建立关联
    left join DWM_TARGET_WORTH w on dtl.TARGET_WORTH_ID=w.id
    --关联项目获得项目id
    left join sys_project proj on w.PROJ_ID=proj.id
    --关联楼栋获取业态的父级对象为楼栋的楼栋数据
    left join mdm_build build on dtl.obj_parent_id=build.id
    left join SYS_PROJECT_STAGE build_proj_stage on build.PERIOD_ID=build_proj_stage.id
    --关联分期获取业态的父级对象为分期的分期数据
    left join SYS_PROJECT_STAGE proj_stage on dtl.obj_parent_id=proj_stage.id
    --只获取已审核的目标货值
    where w.APPROVAL_STATUS='已审核' and w.is_delete=0
    order by objtype.OBJ_TYPE )

   ,可研 as(
    --可研:项目-业态顶级-末级业态 
    select ID,NAME,PARENT_ID,0 as 套,0 as 面积,0 as 金额,0 as 均价  from (
    select id||'|可研' id,project_name name,'可研' PARENT_ID  from SYS_PROJECT
    union all
    --业态顶级id：项目id|分期id|业态顶级id
    select proj.id||'|'||PRODUCT_TYPE.id as  id
    ,proj.project_NAME||'-'||PRODUCT_TYPE.PRODUCT_TYPE_NAME as name
    ,proj.ID||'|可研' as parent_id 
    from  SYS_PROJECT proj cross join (select * from
    MDM_BUILD_PRODUCT_TYPE where product_type_level=1) PRODUCT_TYPE)  
    union all 
    select 项目id||'|'||顶级业态id||'|'||末级业态id as id
    ,末级业态全路径
    ,项目id||'|'||顶级业态id as parent_id
    ,0 as 套
    ,总可售面积 as 面积
    ,总货值 as 金额
    ,0 as 均价 from basedata 
    where 阶段类型=0)

    ,全盘 as(
    --全盘:项目-分期-业态顶级-末级业态 
    select ID,NAME,PARENT_ID,0 as 套,10 as 面积,0 as 金额,0 as 均价  from (
    select id||'|全盘' as id,project_name name,'全盘' PARENT_ID  from SYS_PROJECT
    union all
    select proj_stage.PROJECT_ID||'|'||proj_stage.id  as Id
    ,proj_stage.STAGE_FULL_NAME as NAME
    ,proj_stage.PROJECT_ID||'|全盘' as PARENT_ID
    from SYS_PROJECT_STAGE PROJ_STAGE
    union all
    --业态顶级id：项目id|分期id|业态顶级id
    select proj_stage.PROJECT_ID||'|'||proj_stage.id||'|'||PRODUCT_TYPE.id as  id
    ,proj_stage.STAGE_FULL_NAME||'-'||PRODUCT_TYPE.PRODUCT_TYPE_NAME as name
    ,proj_stage.PROJECT_ID||'|'||proj_stage.id as parent_id 
    from  SYS_PROJECT_STAGE proj_stage cross join (select * from
    MDM_BUILD_PRODUCT_TYPE where product_type_level=1) PRODUCT_TYPE)  
    union all 
    select 项目id||'|'||分期id||'|'||顶级业态id||'|'||末级业态id as id
    ,末级业态全路径
    ,项目id||'|'||分期id||'|'||顶级业态id as parent_id
    ,0 as 套
    ,总可售面积 as 面积
    ,总货值 as 金额
    ,0 as 均价 from basedata 
    where 阶段类型=10)

     ,动态 as(
    --全盘:项目-分期-业态顶级-楼栋-末级业态
    select ID,NAME,PARENT_ID,20 as 套,0 as 面积,0 as 金额,0 as 均价  from (
    select id||'|动态' as id,project_name name,'动态' PARENT_ID  from SYS_PROJECT
    union all
    select proj_stage.PROJECT_ID||'|'||proj_stage.id||'|动态'  as Id
    ,proj_stage.STAGE_FULL_NAME as NAME
    ,proj_stage.PROJECT_ID||'|动态' as PARENT_ID
    from SYS_PROJECT_STAGE PROJ_STAGE
    union all
    --业态顶级id：项目id|分期id|业态顶级id
    select proj_stage.PROJECT_ID||'|'||proj_stage.id||'|'||PRODUCT_TYPE.id||'|动态' as  id
    ,proj_stage.STAGE_FULL_NAME||'-'||PRODUCT_TYPE.PRODUCT_TYPE_NAME as name
    ,proj_stage.PROJECT_ID||'|'||proj_stage.id||'|动态' as parent_id 
    from  SYS_PROJECT_STAGE proj_stage cross join (select * from
    MDM_BUILD_PRODUCT_TYPE where product_type_level=1) PRODUCT_TYPE)  
    --楼栋级：
    union all
    select 项目id||'|'||分期id||'|'||顶级业态id||'|'||楼栋id as id
    ,楼栋名称
    ,项目id||'|'||分期id||'|'||顶级业态id||'|动态' as parent_id
    ,0 as 套
    ,0 as 面积
    ,0 as 金额
    ,0 as 均价 from basedata 
    where 阶段类型=20 group by 楼栋id,项目id,分期id,顶级业态id,楼栋名称
    union all 
    select 项目id||'|'||分期id||'|'||顶级业态id||'|'||楼栋id||'|'||末级业态id as id
    ,末级业态全路径
    ,项目id||'|'||分期id||'|'||顶级业态id||'|'||楼栋id as parent_id
    ,0 as 套
    ,总可售面积 as 面积
    ,总货值 as 金额
    ,0 as 均价 from basedata 
    where 阶段类型=20)

   ,结果 as ( 
   select '可研' as id, '可研' as NAME,null PARENT_ID
    ,0 as 套,0 as 面积,0 as 金额,0 as 均价 from dual
    union all
   select '全盘' as id,'全盘' as NAME,null PARENT_ID
    ,0 as 套,0 as 面积,0 as 金额,0 as 均价 from dual
   union all
   select '动态' as id,'动态' as NAME,null PARENT_ID
    ,0 as 套,0 as 面积,0 as 金额,0 as 均价 from dual
   union all
   select ID,NAME,PARENT_ID,套,面积,金额,均价 from 可研
   union all
   select ID,NAME,PARENT_ID,套,面积,金额,均价 from 全盘
   union all 
   select  ID,NAME,PARENT_ID,套,面积,金额,均价 from 动态
   )

select ID,NAME,PARENT_ID,套,面积,金额
--,(select sum(面积) from 结果 m start with m.id=s.id connect by prior m.id=m.parent_id ) 面积
--,(select sum(金额) from 结果 start with id=s.id connect by prior id=parent_id  ) 金额
 from 结果 s ;

END P_DWM_云徙联合项目组;



/
--------------------------------------------------------
--  DDL for Procedure P_GET_COMPANY_TREE_PROJ_SPID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_GET_COMPANY_TREE_PROJ_SPID" (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    data_auth_spid  OUT                VARCHAR2         
) AS
--获取有项目的公司树
--作者：谷国斌
--日期：2019/12/13
    rulevalue   VARCHAR2(50);
    authcount   INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    spid        VARCHAR2(36);--使用临时表的批次号
BEGIN
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;
--插入集团作为根节点
    INSERT INTO tmp_company_tree (id, org_id, org_name, org_type, parent_id, is_company, order_code)
        SELECT spid, id, org_name, org_type, parent_id, is_company, order_hierarchy_code
        FROM sys_business_unit
        WHERE id = '003200000000000000000000000000';
--获取隔离规则：

    SELECT isolation_rule_value INTO rulevalue
    FROM sys_data_auth_biz
    WHERE biz_obj_code = bizcode;

    IF rulevalue = '全集团' THEN
        INSERT INTO tmp_company_tree (id, org_id, org_name, org_type, parent_id, is_company, order_code)
            SELECT spid, id, org_name, org_type, parent_id, is_company, order_hierarchy_code
            FROM sys_business_unit
            WHERE is_company = 1;
    ELSE
--插入本公司及其父级
        INSERT INTO tmp_company_tree (id, org_id, org_name, org_type, parent_id, is_company, order_code)
            SELECT spid, id, org_name, org_type, parent_id, is_company, order_hierarchy_code
            FROM sys_business_unit
            WHERE is_company = 1
            START WITH id = companyid
            CONNECT BY PRIOR parent_id = id;

--插入数据授权的数据：
        DECLARE
            ownerid     VARCHAR2(36);
            oenertype   NVARCHAR2(50);
            CURSOR cursor_company IS
                SELECT DISTINCT auth_owner_id, auth_owner_type
                FROM sys_data_auth
                WHERE auth_biz_code = bizcode AND is_disabled = 0;
        BEGIN
            --打开游标
            OPEN cursor_company;
            LOOP
                FETCH cursor_company INTO ownerid, oenertype;
                EXIT WHEN cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                IF oenertype = '公司' OR oenertype = '集团' THEN
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司
                    SELECT COUNT(*) INTO authcount
                    FROM sys_business_unit
                    WHERE is_company = 1 AND id = companyid
                    START WITH id = ownerid
                    CONNECT BY PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (id, auth_owner_id, auth_owner_type)
                        VALUES (spid, ownerid, oenertype);
                    END IF;
                END IF;

                IF oenertype = '部门' THEN
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门
                    SELECT COUNT(*) INTO authcount
                    FROM sys_business_unit
                    WHERE is_company = 0 AND id = deptid
                    START WITH id = ownerid
                    CONNECT BY PRIOR id = parent_id;
                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (id, auth_owner_id, auth_owner_type)
                        VALUES (spid, ownerid, oenertype);
                    END IF;
                END IF;

                IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                    INSERT INTO tmp_auth_owner (id, auth_owner_id, auth_owner_type)
                        VALUES (spid,ownerid,oenertype);
                END IF;
            END LOOP;
            CLOSE cursor_company;
        END;
        --获取有权限的公司及其父级：
        DECLARE
            ownerid2 VARCHAR2(36);
            CURSOR cursor_auth IS SELECT auth_owner_id FROM tmp_auth_owner WHERE id = spid;
        BEGIN
        --打开游标
        OPEN cursor_auth;
        LOOP
        FETCH cursor_auth INTO ownerid2;
        EXIT WHEN cursor_auth%notfound;
        --授权对象为公司：
        --取授权公司的子级：
        INSERT INTO tmp_company_tree (id, org_id, org_name, org_type, parent_id, is_company, order_code )
            SELECT spid, id, org_name, org_type, parent_id, is_company, order_hierarchy_code
            FROM sys_business_unit
            WHERE is_company = 1
            START WITH id IN (
                SELECT DISTINCT auth_scope_id
                FROM sys_data_auth
                WHERE auth_biz_code = bizcode
                    AND is_disabled = 0
                    AND auth_owner_id = ownerid2
                    AND auth_scope_type IN ('公司',  '集团')
            ) CONNECT BY PRIOR id = parent_id;
        INSERT INTO tmp_company_tree ( id, org_id, org_name, org_type, parent_id, is_company, order_code)
            SELECT spid, id, org_name, org_type, parent_id, is_company, order_hierarchy_code
                FROM sys_business_unit
                WHERE is_company = 1
                START WITH id IN (
                    SELECT DISTINCT auth_scope_id
                    FROM sys_data_auth
                    WHERE auth_biz_code = bizcode
                        AND is_disabled = 0
                        AND auth_owner_id = ownerid2
                        AND auth_scope_type IN ( '公司', '集团')
                ) CONNECT BY PRIOR parent_id = id;

                   --授权对应为部门：
                   --取授权部门的父级：


            INSERT INTO tmp_company_tree ( id, org_id, org_name, org_type, parent_id, is_company, order_code)
                    SELECT spid, id, org_name, org_type, parent_id, is_company, order_hierarchy_code
                    FROM sys_business_unit
                    WHERE is_company = 1
                    START WITH id IN (
                        SELECT DISTINCT auth_scope_id
                        FROM sys_data_auth
                        WHERE auth_biz_code = bizcode
                            AND is_disabled = 0
                            AND auth_owner_id = ownerid2
                            AND auth_scope_type = '部门'
                    ) CONNECT BY PRIOR parent_id = id;
                   --授权对应为项目：

            INSERT INTO tmp_company_tree ( id, org_id, org_name, org_type, parent_id, is_company, order_code)
                SELECT spid, id, org_name,  org_type, parent_id, is_company, order_hierarchy_code
                FROM sys_business_unit
                WHERE is_company = 1
                START WITH id IN (
                    SELECT unit_id
                    FROM sys_project
                    WHERE id IN (
                        SELECT DISTINCT auth_scope_id
                        FROM sys_data_auth
                        WHERE auth_biz_code = bizcode
                            AND is_disabled = 0
                            AND auth_owner_id = ownerid2
                            AND auth_scope_type = '项目'
                    )
                ) CONNECT BY PRIOR parent_id = id;
            END LOOP;
            CLOSE cursor_auth;
        END;
    END IF;
--    OPEN data_auth_info FOR
--        SELECT DISTINCT
--            org_id       AS orgid,
--            org_name     AS orgname,
--            org_type     AS orgtype,
--            parent_id    AS parentid,
--            1 AS iscompany,
--            order_code   AS ordercode
--        FROM tmp_company_tree
--        WHERE id = spid
--            AND org_id IN (
--               SELECT DISTINCT id
--               FROM sys_business_unit
--               START WITH id IN (
--                   SELECT id
--                   FROM (
--                       SELECT unit_id AS id
--                       FROM sys_project
--                       UNION
--                       SELECT subordinate_company_id AS id
--                       FROM cdb_feasible_project_config
--                   ) ds
--               ) CONNECT BY PRIOR parent_id = id
--            ) ORDER BY order_code;

             data_auth_spid:=SPID;
END P_GET_COMPANY_TREE_PROJ_SPID;

/
--------------------------------------------------------
--  DDL for Procedure P_JUDGE_OBJ_MAINTAIN_CONDT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_JUDGE_OBJ_MAINTAIN_CONDT" (
    phaseId   IN VARCHAR2,--阶段ID
    projectID IN VARCHAR2,--项目原始ID
    isSatisfied OUT INT --是否满足
)
as
BEGIN
    select COUNT(id) INTO isSatisfied FROM MDM_OBJ_PHASE_VERSION WHERE obj_id=''||projectID||''
                                                                   AND PHASE_STATE='10';
END P_JUDGE_OBJ_MAINTAIN_Condt;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_BLD_PERMIT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_BLD_PERMIT" (
    companyid     IN            VARCHAR2,--当前用户公司
    stationid     IN            VARCHAR2,---当前用户的岗位
    deptid        IN            VARCHAR2,---当前用户的部门
    bizcode       IN            VARCHAR2,---权限code
    userid        IN            VARCHAR2,---当前用户id
    projectids   IN            VARCHAR2,---项目名称
    searchparam   IN            VARCHAR2,--筛选条件
    selectCompanyId  IN           VARCHAR2,---当前选中的公司
    licenseType   IN            VARCHAR2, --证照类型
    info         OUT           SYS_REFCURSOR,
    pageindex     IN            INT,
    pagesizes     IN            INT,
    total         OUT           INT
) IS
    --证照办理一栏
    --作者：鲜晓勇
    --日期：2020/2/09
    v_sql_exec         CLOB;
    v_sql        CLOB;
    v_spid             VARCHAR2(200);---数据验证spid
    v_where            VARCHAR2(4000):=' and 1=1 ';
    v_search           VARCHAR2(4000):=' and 1=1 ';  ---搜素sql
    v_project          VARCHAR2(4000);
    v_auth_sql         VARCHAR2(4000) :=' where 1=1';
    v_pageIndex integer:=pageindex;
    limit_start integer := greatest((pageindex-1)*pagesizes, 0); --开始记录
    mdmRemote varchar(200); --主数据域名
    pomRemote varchar(200); --计划域名
BEGIN
    BEGIN
        --获取域名
        select APPLICATION_URL into mdmRemote
        from SYS_APPLICATION_TERMINAL
        where APPLICATION_CODE = 'mdm' and APPLICATION_TERMINAL_CODE='PC';
        select APPLICATION_URL into pomRemote
        from SYS_APPLICATION_TERMINAL
        where APPLICATION_CODE = 'pom' and APPLICATION_TERMINAL_CODE='PC';
        --执行数据权限存储过程。拿到零时表id 用户连临时表鉴权
        --调用查询数据权限的存储过程,返回spid
        P_AUTH_BLOCK_PROJ_COMPANY(
                USERID => userid,
                STATIONID => stationid,
                DEPTID => deptid,
                COMPANYID => companyid,
                BIZCODE => bizcode,
                DATA_SPID_ID => v_spid
            );
        if(selectCompanyId is not null and projectids is null)
        THEN
            v_where:=' AND MB.PROJ_ID IN(' ||
                     'select ID from sys_project WHERE UNIT_ID IN (' ||
                     'select ID from SYS_BUSINESS_UNIT sbu where IS_COMPANY = 1 ' ||
                     'start with sbu.id='''||selectCompanyId||'''' ||
                     'connect by prior sbu.ID = sbu.PARENT_ID)' ||
                     ')';
        END IF;
        if (projectids is not null) THEN
            FOR item IN (
                SELECT
                    regexp_substr('' || projectids || '', '[^,]+', 1, ROWNUM) AS id
                FROM dual
                CONNECT BY ROWNUM <= length('' || projectids || '')
                                         - length(regexp_replace('' || projectids || '', ',', '')) + 1
                ) LOOP v_project:=v_project||''''||item.id||''',';
                END LOOP;
            v_project:=substr(v_project,1,length(v_project) -1 );
            v_where:=' AND MB.PROJ_ID IN('||v_project||')';
        END if;

        if(searchParam is not null)THEN
            v_search := 'AND INSTR(MPAR.PARCEL_NAME||''$#''||MB.CON_PLAN_PERMIT_NO||''$#''||' ||
                        'MB.CONSTRUCTION_PERMIT_NO||''$#''||MB.GET_COMPLETED_PERMIT_NO||''$#''||' ||
                        'MP.PROJECT_NAME, '''||searchparam||''') > 0';
        END IF;
        v_sql := 'SELECT
             MB.ID AS "bldId", MB.ORDER_HIERARCHY_CODE AS "orderCode",
             MB.PROJ_ID AS "projectId", MP.PROJECT_NAME AS "projectName",
             MP.PROJECT_CODE AS "projectCode",
			 MPAR.PARCEL_NAME AS "parcelName", MB.PARCEL_ID AS "parcelId",
			 MB.PERIOD_ID AS "stageId", MB.PERIOD_NAME AS "stageName",
			 MB.BUILD_NAME AS "bldName",MB.BUILD_NAME AS "bldCode",
			 "productFullName", "managementType",
              to_char(MB.GET_CON_PLAN_PERMIT_DATE,''yyyy-MM-dd'') as "planPermitDate",
			 MB.CON_PLAN_PERMIT_ID AS "planPermitId",
			 MB.CON_PLAN_PERMIT_NO AS "planPermitNo",
             nvl2(MB.CON_PLAN_PERMIT_ID,case when mpt.feedback_id is null
                 then ''' || mdmRemote ||'/mdm/license-handle/license-handle/registration-detil?permitType=规划许可证&id=''||MB.CON_PLAN_PERMIT_ID||''&cancelType=0&action=mdm_licensehandle_insert&companyId=''||mp.unit_id||''''
                 else '''|| pomRemote || '/pom/licence-feedback/licence-detail?cancelType=0&permitType=规划许可证&product=''||mp.project_name||''&permitNumber=''||mb.CON_PLAN_PERMIT_NO||''&id=''||MB.CON_PLAN_PERMIT_ID||''''
             end, null) AS "planPermitUrl",
              to_char(MB.GET_CONSTRCUTION_PERMIT_DATE,''yyyy-MM-dd'') as "constructionPermitDate",
			 MB.CONSTRACUTION_PERMIT_ID AS "constructionPermitId",
			 MB.CONSTRUCTION_PERMIT_NO AS "constructionPermitNo",
             nvl2(CONSTRACUTION_PERMIT_ID, case  when mpt.feedback_id is null
                 then ''' || mdmRemote ||'/mdm/license-handle/license-handle/registration-detil?permitType=施工许可证&id=''||MB.CONSTRACUTION_PERMIT_ID||''&cancelType=0&action=mdm_licensehandle_insert&companyId=''||mp.unit_id||''''
                 else '''|| pomRemote || '/pom/licence-feedback/licence-detail?cancelType=0&permitType=施工许可证&product=''||mp.project_name||''&permitNumber=''||mb.CONSTRUCTION_PERMIT_NO||''&id=''||MB.CONSTRACUTION_PERMIT_ID||''''
             end, null)AS "constructionPermitUrl",
             to_char(MB.GET_PRE_SALE_PERMIT_DATE,''yyyy-MM-dd'') as "preSalePermitDate",
			 MB.PRE_SALE_PERMIT_ID AS "perSalePermitId",
			 MB.PRE_SALE_PERMIT_NO AS "preSalePermitNo",
			 nvl2(MB.PRE_SALE_PERMIT_ID,case  when mpt.feedback_id is null
                 then ''' || mdmRemote ||'/mdm/license-handle/license-handle/registration-detil?permitType=预售许可证&id=''||MB.PRE_SALE_PERMIT_ID||''&cancelType=0&action=mdm_licensehandle_insert&companyId=''||mp.unit_id||''''
                 else ''' || pomRemote ||'/pom/licence-feedback/licence-detail?cancelType=0&permitType=预售许可证&product=''||mp.project_name||''&permitNumber=''||mb.PRE_SALE_PERMIT_NO||''&id=''||MB.PRE_SALE_PERMIT_ID||''''
             end,null) AS "perSalePermitUrl",
             to_char(MB.GET_COMPLETED_PERMIT_DATE,''yyyy-MM-dd'') as "completedPermitDate",
			 MB.COMPLETED_PERMIT_ID AS "complatedPerimtId",
			 MB.GET_COMPLETED_PERMIT_NO AS "completedPermitNo",
			 nvl2(MB.COMPLETED_PERMIT_ID,case  when mpt.feedback_id is null
                 then ''' || mdmRemote ||'/mdm/license-handle/license-handle/registration-detil?permitType=竣工许可证&id=''||MB.COMPLETED_PERMIT_ID||''&cancelType=0&action=mdm_licensehandle_insert&companyId=''||mp.unit_id||''''
                 else ''' || pomRemote ||'/pom/licence-feedback/licence-detail?cancelType=0&permitType=竣工许可证&product=''||mp.project_name||''&permitNumber=''||mb.GET_COMPLETED_PERMIT_NO||''&id=''||mb.COMPLETED_PERMIT_ID||''''
             end, null) AS "complatedPerimtUrl"
            FROM   MDM_BUILD MB
            INNER  JOIN SYS_PROJECT MP ON MB.PROJ_ID = MP.id
            INNER  JOIN SYS_PROJECT_STAGE MPER ON MPER.ID = MB.PERIOD_ID
            left join (
                select mb.ID BUILD_ID, FEEDBACK_ID
                FROM MDM_BUILD mb
                left join MDM_PERMIT mpt
                on instr(MB.CON_PLAN_PERMIT_ID || MB.CONSTRACUTION_PERMIT_ID || MB.PRE_SALE_PERMIT_ID
                 || MB.COMPLETED_PERMIT_ID, mpt.ID) > 0
               group by mb.id, FEEDBACK_ID
            ) mpt on mpt.BUILD_ID = mb.ID
            INNER  JOIN (select distinct p.parcel_name,p.PARCEL_ORIGINAL_ID from mdm_project m1 inner join MDM_PARCEL  p on m1.id=p.project_id and m1.approval_status=''已审核'' )MPAR
            on mb.Parcel_id=MPAR.PARCEL_ORIGINAL_ID
            left join (select BUILD_ID, wm_concat(PRODUCT_TYPE_NAME) "productFullName", wm_concat(OPERATE_ATTRIBUTE_NAME) "managementType"
                from MDM_OBJ_PHASE_PT_INDEX mopi left join MDM_BUILD_PHASE mbp on mbp.ID = mopi.OBJ_PHASE_ID where OBJ_TYPE=''30'' group by mbp.BUILD_ID) opi on opi.BUILD_ID = mb.ID
            '||v_auth_sql||' and 1=1
             '||v_where||' '||v_search||'';
        v_sql := v_sql || ' and (1=0';
        if instr(licenseType, '规划许可证') > 0 then
            v_sql := v_sql || ' or GET_CON_PLAN_PERMIT_DATE is not null';
        end if;
        if instr(licenseType, '施工许可证') > 0 then
            v_sql := v_sql || ' or GET_CONSTRCUTION_PERMIT_DATE is not null';
        end if;
        if instr(licenseType, '预售许可证') > 0 then
            v_sql := v_sql || ' or GET_PRE_SALE_PERMIT_DATE is not null';
        end if;
        if instr(licenseType, '竣工备案证') > 0 then
            v_sql := v_sql || ' or GET_COMPLETED_PERMIT_DATE is not null';
        end if;
        v_sql := v_sql || ')';
        begin
            EXECUTE IMMEDIATE 'SELECT count(1) from('|| v_sql || ')' into total;
        exception when others then
            total := 10;
        end;
        sys.dbms_output.put_line(v_sql_exec);
        if total <= limit_start then
            v_pageIndex := 1;
        end if;
        if pagesizes != 0 and pageindex != 0 then
            v_sql_exec := 'select * from ( select a.*, rownum rowno from ( '
                || v_sql || ' order by "projectCode", mp.PROJECT_NAME, ' ||
                          'nvl(FN_CN_NUMBER_CHAR_TO_NUMBER(regexp_replace(STAGE_NAME, ''分?期'', '''')),99) asc'
                ||') a where  rownum <= ' || v_pageIndex * pagesizes
                || ' ) a where  a.rowno > ' || pagesizes * ( v_pageIndex - 1 );
        else
            v_sql_exec := v_sql;
        end if;
        OPEN info FOR v_sql_exec;
    END;
END P_MDM_BLD_PERMIT;


/
--------------------------------------------------------
--  DDL for Procedure P_MDM_BUILDING_RELEASE_CB
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_BUILDING_RELEASE_CB" (
    id IN VARCHAR--楼栋表MDM_BUILD 主键id
) 
	--分期楼栋发布回调，1、创建动态货值相关版本数据//王传科实现 20191208
	--作者：陈丽
	--日期：2019/12/08	
 AS
  b_status   VARCHAR2(50);
  i_id varchar2(50):=id;
BEGIN
   BEGIN
    -- 查询是否是审批通过
        SELECT
            build_state 
            into b_status
        FROM
            mdm_build
        WHERE
            id = i_id;

        IF b_status = 10 THEN
            BEGIN
                P_SYS_BUILD_SYNCHRONIZATION();
                dbms_output.put_line('执行了同步');
            END;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            dbms_output.put_line('失败咯!'||sqlcode || sqlerrm);
    END;
END p_mdm_building_release_cb;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_BUILDLIST_TO_ROOM
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_BUILDLIST_TO_ROOM" (
    items OUT SYS_REFCURSOR
) IS
BEGIN
    ----因为当前数据库中的楼栋 在集团提供的查询房间的接口中无法查出房间,所以就使用了接口文档中提供的示例楼栋id用来测试
    OPEN items FOR SELECT
                       ID
                   FROM
                       mdm_build union select 'e7836cbbe38245cd9ebd0c2e91d4ff75' from dual;

END p_mdm_buildlist_to_room;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_COMPANY_PROJ_SITUATION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_COMPANY_PROJ_SITUATION" 
(
    USERID    IN VARCHAR2
   ,STATIONID IN VARCHAR2
   ,DEPTID    IN VARCHAR2
   ,COMPANYID IN VARCHAR2
   ,BIZCODE   IN VARCHAR2
   ,WACTHINFO OUT SYS_REFCURSOR
) AS
    --公司主数据项目情况-主数据首页
    --作者：陈丽
    --日期：2019/11/13
    RULEVALUE VARCHAR2(50);
    AUTHCOUNT INT; --用于判断当前公司、部门是否与数据授权的主体有关系
    SPID      VARCHAR2(36); --使用临时表的批次号
BEGIN
    -- select get_uuid() into SPID from dual;
    -- --插入集团作为根节点
    -- insert into TMP_COMPANY_TREE(ID,ORG_ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE)
    -- select SPID,ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE FROM sys_business_unit where id='003200000000000000000000000000';
    --
    -- --获取隔离规则：
    -- select isolation_rule_value into RULEVALUE from SYS_DATA_AUTH_BIZ where biz_obj_code=BIZCODE;
    -- if RULEVALUE='全集团' then
    -- insert into TMP_COMPANY_TREE(ID,ORG_ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE)
    -- select SPID,ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE FROM sys_business_unit where is_company=1;
    --
    -- insert into TMP_COMPANY_TREE(ID,ORG_ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE)
    --                             select SPID,ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE FROM
    --                             sys_business_unit where is_company=1
    --                                 START WITH ID in (
    --                                 select unit_id from sys_project where id in (select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code='CDB002'
    --                                  and is_disabled=0  and auth_scope_type='项目')
    --                                 )  CONNECT BY PRIOR  parent_id=ID;
    -- else
    -- --插入本公司及其父级
    -- insert into TMP_COMPANY_TREE(ID,ORG_ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE)
    -- select SPID,ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE FROM
    --     sys_business_unit where is_company=1 START WITH ID=COMPANYID  CONNECT BY PRIOR  parent_id=ID;
    --
    -- --插入数据授权的数据：
    --
    --         DECLARE
    --                 OWNERID  VARCHAR2(36);
    --                 OENERTYPE NVARCHAR2(50);
    --                 CURSOR cursor_company IS
    --                 select distinct auth_owner_id,auth_owner_type from SYS_DATA_AUTH where auth_biz_code=BIZCODE and is_disabled=0;
    --
    --             BEGIN
    --
    --             --打开游标
    --                 OPEN cursor_company;
    --                 loop
    --                     fetch cursor_company into OWNERID,OENERTYPE;
    --                     exit when cursor_company%notfound;
    --
    --                 --过滤当前用户有权限的授权对象：
    --                 if OENERTYPE='公司' or OENERTYPE='集团'
    --                 then
    --                    --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司
    --                      SELECT count(*) into AUTHCOUNT FROM sys_business_unit where is_company=1 and id=COMPANYID
    --                     START WITH ID=OWNERID CONNECT BY PRIOR  ID=parent_id;
    --                     if AUTHCOUNT<>0
    --                     then
    --                         insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
    --                         values(SPID,OWNERID,OENERTYPE);
    --
    --                     end if;
    --
    --                 end if;
    --
    --                  if OENERTYPE='部门'
    --                 then
    --                    --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门
    --                      SELECT count(*) into AUTHCOUNT FROM sys_business_unit where is_company=0 and id=DEPTID
    --                     START WITH ID=OWNERID CONNECT BY PRIOR  ID=parent_id;
    --                     if AUTHCOUNT<>0
    --                     then
    --                         insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
    --                         values(SPID,OWNERID,OENERTYPE);
    --
    --                     end if;
    --
    --                 end if;
    --
    --                  if (OENERTYPE='岗位' and OWNERID=STATIONID) or (OENERTYPE='人员' and OWNERID=USERID)
    --                 then
    --
    --                        insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
    --                         values(SPID,OWNERID,OENERTYPE);
    --                 end if;
    --
    --                 end loop;
    --
    --                 close cursor_company;
    --
    --             END;
    --
    --           --获取有权限的公司及其父级：
    --                 DECLARE
    --                         OWNERID2  VARCHAR2(36);
    --                         CURSOR cursor_auth IS
    --                         select auth_owner_id from TMP_AUTH_OWNER where ID=SPID;
    --
    --                     BEGIN
    --
    --                     --打开游标
    --                         OPEN cursor_auth;
    --                         loop
    --                             fetch cursor_auth into OWNERID2;
    --                             exit when cursor_auth%notfound;
    --
    --
    --                             --授权对象为公司：
    --                             --取授权公司的子级：
    --                             insert into TMP_COMPANY_TREE(ID,ORG_ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE)
    --                             select SPID,ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE FROM
    --                             sys_business_unit where is_company=1
    --                                 START WITH ID in (
    --                                 select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE
    --                                  and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type in ('公司','集团')
    --                                 )  CONNECT BY PRIOR  ID=parent_id;
    --
    --
    --                             --取授权公司的父级：
    --                             insert into TMP_COMPANY_TREE(ID,ORG_ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE)
    --                             select SPID,ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE FROM
    --                             sys_business_unit where is_company=1
    --                                 START WITH ID in (
    --                                 select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE
    --                                  and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type in ('公司','集团')
    --                                 )  CONNECT BY PRIOR  parent_id=ID;
    --
    --                              --授权对应为部门：
    --                                --取授权部门的父级：
    --
    --                                  insert into TMP_COMPANY_TREE(ID,ORG_ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE)
    --                             select SPID,ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE FROM
    --                             sys_business_unit where is_company=1
    --                                 START WITH ID in  (select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE
    --                                  and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type='部门'
    --                                 )  CONNECT BY PRIOR  parent_id=ID;
    --                                --授权对应为项目：
    --
    --                             insert into TMP_COMPANY_TREE(ID,ORG_ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE)
    --                             select SPID,ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE FROM
    --                             sys_business_unit where is_company=1
    --                                 START WITH ID in (
    --                                 select unit_id from sys_project where id in (select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE
    --                                  and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type='项目')
    --                                 )  CONNECT BY PRIOR  parent_id=ID;
    --
    --                               end loop;
    --                            close  cursor_auth;
    --                         end;
    --
    --
    --     end if;

    --  SELECT
    --  A.orgId AS id,
    --  A.parentId AS parentsId,
    --  A.orgName AS orgName,
    --  CASE
    --  WHEN A.orgType = 10 THEN
    --    1
    --  ELSE
    --    0
    -- END projTotal,
    --  CASE
    --  WHEN B.PROJ_ID IS NOT NULL THEN
    --    B.TARGET_WORTH
    --  ELSE
    --    0
    -- END dynamicWorth,
    -- '0' AS reserveWorth,
    -- '0' AS wayWorth,
    -- '0' AS inventoryWorth,
    -- '/dwm/value-manage/dynamic-value/value-monitor' AS jumpUrl FROM
    -- (select distinct ORG_ID as orgId,org_name as orgName,org_type as orgType,parent_id as parentId,1 as isCompany,order_code as orderCode
    -- from TMP_COMPANY_TREE WHERE ID=SPID AND
    -- ORG_ID in(
    --                     SELECT distinct id FROM sys_business_unit START WITH ID in (select id from (
    --                     select unit_id as id from sys_project
    --                     union
    --                     SELECT SUBORDINATE_COMPANY_ID as id FROM CDB_FEASIBLE_PROJECT_CONFIG
    --                     ) ds) CONNECT BY PRIOR parent_id = ID))A
    --  LEFT JOIN (
    -- SELECT T1.PROJ_ID,T1.PROJ_NAME,
    -- CASE WHEN T2.PROJ_ID IS NOT NULL
    -- THEN T2.TARGET_WORTH
    --  ELSE
    --    T1.TARGET_WORTH
    -- END TARGET_WORTH FROM
    -- (SELECT D.PROJ_ID,D.PROJ_NAME,D.TARGET_WORTH,MAX(D.APPROVAL_TIME)
    -- FROM DWM_TARGET_WORTH D
    --  WHERE D.IS_DELETE = 0 AND D.APPROVAL_STATUS = '已审核'
    --  GROUP BY D.PROJ_ID,D.PROJ_NAME,D.TARGET_WORTH) T1
    --  LEFT JOIN
    --  (
    --  SELECT D.PROJ_ID,D.PROJ_NAME,D.TARGET_WORTH,MAX(D.APPROVAL_TIME)
    -- FROM DWM_TARGET_WORTH D
    --  WHERE D.IS_DELETE = 0 AND D.APPROVAL_STATUS = '已审核' AND D.TARGET_WORTH_PHASE = 20
    --  GROUP BY D.PROJ_ID,D.PROJ_NAME,D.TARGET_WORTH
    --  )T2 ON T1.PROJ_ID = T2.PROJ_ID)B ON A.orgId = B.PROJ_ID;
    --
    --
    OPEN WACTHINFO FOR
        SELECT A.ORGID AS ID,
                --组织id
               A.ORGNAME || 'tt' AS ORGNAME,
                --组织名称名称
               LOWER(A.PARENTID) AS PARENTSID,
                --父级id

               CASE
                   WHEN A.ORGTYPE = 1 THEN
                    1
                   ELSE
                    0
               END PROJTOTAL,
               CASE
                   WHEN X.PROJ_ID IS NOT NULL AND NVL(X.TARGET_WORTH, 0) > 0 THEN
                    X.TARGET_WORTH
                   WHEN Y.PROJ_ID IS NOT NULL AND NVL(Y.TARGET_WORTH, 0) > 0 THEN
                    Y.TARGET_WORTH
                   WHEN Z.PROJ_ID IS NOT NULL AND NVL(Z.TARGET_WORTH, 0) > 0 THEN
                    Z.TARGET_WORTH
                   ELSE
                    0
               END NEWESTWORTH, '0' AS DYNAMICWORTH, '0' AS RESERVEWORTH,
               '0' AS INTRANSITWORTH, '0' AS INVENTORYWORTH,
               '0' AS EXPLAINATION,
               '/dwm/value-manage/dynamic-value/value-monitor' AS JUMPURL

        FROM   (SELECT ORDER_CODE,
                         --用于树形的排序
                        T.PROJECT_ORIGINAL_ID ORGID,
                         --组织id
                        T.PROJECT_NAME AS ORGNAME,
                         --组织名称名称

                        T.ORG_TYPE AS ORGTYPE,
                         --组织类型 0公司，1项目
                        LOWER(T.PARENT_ID) AS PARENTID --父级id

                 FROM   (SELECT MDM_PROJECT.PROJECT_ORIGINAL_ID,
                                 ORG.PARENT_ID || '-' ||
                                  SUBSTR('000' || ORG.ORDER_CODE, -3) ||
                                  ORG.ORDER_CODE AS ORDER_CODE,
                                  --用于树形的排序
                                 PROJECT_NAME,
                                 MDM_PHASE.PHASE_NAME AS PROJ_PHASE,
                                 PHASE.PHASE_ID, PHASE.ID AS PROJ_PHASE_ID,
                                 10 AS ORG_TYPE,
                                 CASE
                                     WHEN PHASE.PHASE_ID IS NULL THEN
                                      0
                                     ELSE
                                      1
                                 END AS IS_EXIST_PROJ_PHASE,
                                 MDM_PROJECT.COMPANY_ID AS PARENT_ID,
                                 MDM_OBJ_PHASE_INDEX.TOTAL_SITE_AREA,
                                 MDM_OBJ_PHASE_INDEX.OVERALL_FLOORAGE_AREA,
                                 MDM_OBJ_PHASE_INDEX.TOTAL_SALE_AREA,
                                 MDM_OBJ_PHASE_INDEX.TOTAL_CAPACITY_AREA
                          FROM   MDM_PROJECT
                          LEFT   JOIN (SELECT T1.ID, T1.PHASE_ID, T1.PROJ_ID,
                                             T2.PHASE_ORDER
                                      FROM   MDM_PROJECT_PHASE T1
                                      LEFT   JOIN (SELECT PROJ_ID,
                                                         MAX(PHASE_ORDER) AS PHASE_ORDER
                                                  FROM   MDM_PROJECT_PHASE
                                                  GROUP  BY PROJ_ID) T2
                                      ON     T1.PROJ_ID = T2.PROJ_ID AND
                                             T1.PHASE_ORDER = T2.PHASE_ORDER
                                      WHERE  T2.PHASE_ORDER IS NOT NULL) PHASE
                          ON     MDM_PROJECT.PROJECT_ORIGINAL_ID =
                                 PHASE.PROJ_ID
                          LEFT   JOIN MDM_PHASE
                          ON     PHASE.PHASE_ID = MDM_PHASE.ID
                          LEFT   JOIN MDM_OBJ_PHASE_INDEX
                          ON     PHASE.ID = MDM_OBJ_PHASE_INDEX.OBJ_PHASE_ID AND
                                 MDM_OBJ_PHASE_INDEX.OBJ_TYPE = 0
                          LEFT   JOIN SYS_BUSINESS_UNIT ORG
                          ON     MDM_PROJECT.COMPANY_ID = ORG.ID
                          WHERE  APPROVAL_STATUS = '已审核'
                          UNION ALL
                          SELECT ID,
                                 PARENT_ID || '-' ||
                                  SUBSTR('000' || ORDER_CODE, -3) AS ORDER_CODE,
                                  --用于树形的排序
                                 ORG_NAME, '' AS PROJ_PHASE, '' AS PHASE_ID,
                                 '' AS PROJ_PHASE_ID, 0 ORG_TYPE,
                                 NULL IS_EXIST_PROJ_PHASE, PARENT_ID,
                                 0 AS "totalSiteArea",
                                 0 AS "overallFloorageArea",
                                 0 AS "totalSalableArea",
                                 0 AS "totalCapacityArea"
                          FROM   SYS_BUSINESS_UNIT
                          WHERE  ORG_TYPE = 0 AND
                                 (ID != '000100000000000000000000000000' AND
                                 ID != '000200000000000000000000000000')) T) A
        LEFT   JOIN (SELECT A.PROJ_ID, A.TARGET_WORTH
                     FROM   DWM_TARGET_WORTH A
                     RIGHT  JOIN (SELECT D.PROJ_ID, D.TARGET_WORTH_PHASE,
                                        MAX(WORTH_V) AS WORTH_V
                                 FROM   DWM_TARGET_WORTH D
                                 WHERE  D.IS_DELETE = 0 AND
                                        D.APPROVAL_STATUS IN ('已审核', '审核中') AND
                                        D.TARGET_WORTH_PHASE = 20
                                 GROUP  BY D.PROJ_ID, D.TARGET_WORTH_PHASE) A1
                     ON     A.PROJ_ID = A1.PROJ_ID AND
                            A.WORTH_V = A1.WORTH_V AND
                            A.TARGET_WORTH_PHASE = A1.TARGET_WORTH_PHASE) X
        ON     A.ORGID = X.PROJ_ID
        LEFT   JOIN (SELECT B.PROJ_ID, B.TARGET_WORTH
                     FROM   DWM_TARGET_WORTH B
                     RIGHT  JOIN (SELECT D.ID, D.PROJ_ID, MAX(APPROVAL_TIME)
                                 FROM   DWM_TARGET_WORTH D
                                 WHERE  D.IS_DELETE = 0 AND
                                        D.APPROVAL_STATUS IN ('已审核', '审核中') AND
                                        D.TARGET_WORTH_PHASE = 10
                                 GROUP  BY D.ID, D.PROJ_ID) B1
                     ON     B.ID = B1.ID) Y
        ON     A.ORGID = Y.PROJ_ID
        LEFT   JOIN (SELECT C.PROJ_ID, C.TARGET_WORTH
                     FROM   DWM_TARGET_WORTH C
                     RIGHT  JOIN (SELECT ID, D.PROJ_ID, MAX(APPROVAL_TIME)
                                 FROM   DWM_TARGET_WORTH D
                                 WHERE  D.IS_DELETE = 0 AND
                                        D.APPROVAL_STATUS IN ('已审核', '审核中') AND
                                        D.TARGET_WORTH_PHASE = 0
                                 GROUP  BY D.ID, D.PROJ_ID) C1
                     ON     C.ID = C1.ID) Z
        ON     A.ORGID = Z.PROJ_ID
        WHERE  ROWNUM = 1
        ORDER  BY ORDER_CODE;

END P_MDM_COMPANY_PROJ_SITUATION;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_DATA_DETAIL_INFO
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_DATA_DETAIL_INFO" (
    productTypes in  VARCHAR2,
    projectIds in  VARCHAR2,
    info out sys_refcursor
)
    is
    vProductTypes varchar(30) := '所有';
begin
    if productTypes is not null or length(productTypes) > 5 then
        vProductTypes := productTypes;
    end if;
    open info for
        with
            T_RROJECT_NODE as (
                -- 不直接取项目的数据
                select sp.ID, sp.PROJECT_NAME ORG_NAME, null PARENT_ID, PHASE_ORDER PHASE_ORDER, '0' ORDER_CODE,
                       mpp.ID OBJ_PHASE_ID, 0 IS_LEAF
                from SYS_PROJECT sp
                     left join MDM_PROJECT_PHASE mpp on mpp.PROJ_ID = sp.ID
                where sp.ID = projectIds and mpp.PHASE_ORDER = 1
            ),
            T_PARCEL_NODE as (
                select mp.ID, mp.PARCEL_NAME ORG_NAME, mp.PROJECT_ID PARENT_ID, mpp.PHASE_ORDER, ORDER_CODE,
                       mpp.ID OBJ_PHASE_ID, 1 IS_LEAF
                from MDM_PARCEL mp
                     inner join T_RROJECT_NODE tpn on tpn.ID = mp.PROJECT_ORIGINAL_ID
                     inner join MDM_PARCEL_PHASE mpp on mpp.PAECEL_ID = mp.ID and mpp.PHASE_ORDER = 1
            ),
            T_PERIOD_NODE as (
                select  ID, tmp.STAGE_NAME ORG_NAME,
                        PROJECT_ID PARENT_ID, PHASE_ORDER, ORDER_CODE, OBJ_PHASE_ID,
                        (case when cnt = 1 and TO_CHAR(cName)='无分期' then 1 else 0 end) IS_NO_PERIOD,
                        decode(PHASE_ORDER, 2, 1, 0) IS_LEAF
                from (
                         SELECT sps.*,ph.phase_order, ph.id as OBJ_PHASE_ID,count(*) over () cnt,
                                wm_concat(sps.STAGE_NAME) over() cName
                         FROM T_RROJECT_NODE tpn
                              INNER JOIN SYS_PROJECT_STAGE sps on tpn.id=sps.project_id
                              INNER JOIN (
                             select mpp1.*
                             from MDM_PERIOD_PHASE mpp1
                                  inner join (
                                 select PERIOD_ID, max(PHASE_ORDER)as PHASE_ORDER
                                 from MDM_PERIOD_PHASE
                                 where PHASE_STATE =19 or PHASE_STATE=20
                                 group by PERIOD_ID
                             ) mpp2 on mpp1.PERIOD_ID = mpp2.PERIOD_ID
                                 and mpp1.PHASE_ORDER = mpp2.PHASE_ORDER
                         )ph on sps.id=ph.period_id
                     ) tmp
            ),
            T_BUILD_NODE as (
                select mb.ID, mb.BUILD_NAME ORG_NAME, decode(IS_NO_PERIOD, 1, PROJ_ID, PERIOD_ID) PARENT_ID, mbp.PHASE_ORDER,
                       ORDER_CODE, mbp.ID OBJ_PHASE_ID, 1 IS_LEAF
                from T_PERIOD_NODE tpp
                     inner join MDM_BUILD mb on mb.PERIOD_ID = tpp.ID
                     inner join MDM_BUILD_PHASE mbp on mbp.BUILD_ID = mb.ID and mbp.PHASE_ORDER = tpp.PHASE_ORDER
            ),
            T_NODE_TREE as (
                select *
                from (
                         select t1.*, max(PHASE_ORDER) over() maxPhaseOrder
                         from (
                                  select ID, ORG_NAME, PARENT_ID, PHASE_ORDER, ORDER_CODE, OBJ_PHASE_ID,
                                         IS_LEAF, 0 NODE_TYPE, 0 IS_NO_PERIOD
                                  from T_RROJECT_NODE
                                  union all select ID, ORG_NAME, PARENT_ID, PHASE_ORDER, ORDER_CODE, OBJ_PHASE_ID,
                                                   IS_LEAF, 10 NODE_TYPE,  0 IS_NO_PERIOD
                                  from T_PARCEL_NODE
                                  union all select ID, ORG_NAME, PARENT_ID, PHASE_ORDER, ORDER_CODE, OBJ_PHASE_ID,
                                                   IS_LEAF, 20 NODE_TYPE, IS_NO_PERIOD
                                  from T_PERIOD_NODE
                                  union all select ID, ORG_NAME, PARENT_ID, PHASE_ORDER, ORDER_CODE, OBJ_PHASE_ID,
                                                   IS_LEAF, 30 NODE_TYPE, 0 IS_NO_PERIOD
                                  from T_BUILD_NODE
                              ) t1
                     ) t2 where (NODE_TYPE != 10 or maxPhaseOrder = 1)
            ),
            T_NODE_LEAF_INDEX_PT as (
                -- 叶子节点数据
                select
                    mopi.ID, decode(OBJ_TYPE, 40, tnt.ID, GET_UUID()) ORG_ID, decode(OBJ_TYPE, 40, tnt.ORG_NAME,
                                                                                     PRODUCT_TYPE_NAME) ORG_NAME, 40 NODE_TYPE,
                    (case when OBJ_TYPE = 10 then tnt.PARENT_ID
                          when OBJ_TYPE = 20 and IS_NO_PERIOD = 1 then tnt.PARENT_ID else tnt.ID end) PARENT_ID,
                    OPERATE_ATTRIBUTE_NAME, BUILD_AREA, UNDERGROUND_TOTAL_BUILD_AREA, GROUND_CAPACITY_AREA, UNDERGROUND_CAPACITY_AREA,
                    GROUND_UNCAPACITY_AREA, UNDERGROUND_UNCAPACITY_AREA, UNDERGROUND_GARAGE_AREA, TOTAL_SALE_AREA, GROUND_SALE_AREA,
                    UNDERGROUND_SALE_AREA, TOTAL_GIVE_AREA, GROUND_GIVE_AREA, UNDERGROUND_GIVE_AREA, CARPORT_TOTAL,
                    GROUND_TOTAL_CARPORT,GROUND_CARPORT, RESIDENCE_BOTTOM_CARPORT,PARKING_GARAGE_CARPORT,
                    UNDERGROUND_TOTAL_RJ_CARPORT, UNDERGROUND_RFJ_CARPORT, UNDERGROUND_RJ_CARPORT, GROUND_TOTAL_BUILD_AREA,
                    UNDERGROUND_TOTAL_FRJ_CARPORT, UNDERGROUND_FRFJ_CARPORT, UNDERGROUND_FRJ_CARPORT,
                    UNDERGROUND_TOTAL_SALE_CARPORT, UNDERGROUND_R_SALE_CARPORT, UNDERGROUND_FRFJ_SALE_CARPORT,
                    UNDERGROUND_FRJ_SALE_CARPORT, '-' TOTAL_SITE_AREA, '-' CONSTRUCTION_LAND_AREA, '-' CONFISCATED_AREA,
                    '-' OVERALL_FLOORAGE_AREA, '-' TOTAL_CAPACITY_AREA, '-' GROUND_ENGINE_CARPORT, '-' SALE_RATIO,
                    '-' CARPORT_RATIO, '-' TOTAL_HOUSEHOLDS, '-' PLOT_RATIO, '-' BUILD_DENSITY, '-' GREENING_RATE,
                    '-' CONSTRUCTION_PLOT_RATIO, '-' CONSTRUCTION_BUILD_DENSITY, '-' CONSTRUCTION_GREENING_RATE,
                    '-' GROUND_SALE_CARPORT, mopi.OBJ_PHASE_ID, mopi.OBJ_TYPE, ORDER_CODE,PHASE_ORDER
                from MDM_OBJ_PHASE_PT_INDEX mopi
                     inner join T_NODE_TREE tnt on mopi.OBJ_PHASE_ID = tnt.OBJ_PHASE_ID
                where tnt.IS_LEAF = 1 and (vProductTypes='所有' or instr(vProductTypes,mopi.PRODUCT_TYPE_ID)>0)
            ),
            T_NODE_UNLEAF_PT as (
                select tnt.OBJ_PHASE_ID, TO_CHAR(TOTAL_SITE_AREA) TOTAL_SITE_AREA,
                       TO_CHAR(CONSTRUCTION_LAND_AREA) CONSTRUCTION_LAND_AREA,
                       TO_CHAR(CONFISCATED_AREA) CONFISCATED_AREA, TO_CHAR(OVERALL_FLOORAGE_AREA) OVERALL_FLOORAGE_AREA,
                       TO_CHAR(TOTAL_CAPACITY_AREA) TOTAL_CAPACITY_AREA,
                       TO_CHAR(GROUND_ENGINE_CARPORT) GROUND_ENGINE_CARPORT, TO_CHAR(SALE_RATIO) SALE_RATIO,
                       TO_CHAR(CARPORT_RATIO) CARPORT_RATIO,  TO_CHAR(TOTAL_HOUSEHOLDS) TOTAL_HOUSEHOLDS,
                       TO_CHAR(PLOT_RATIO) PLOT_RATIO, TO_CHAR(BUILD_DENSITY) BUILD_DENSITY,
                       TO_CHAR(GREENING_RATE) GREENING_RATE, TO_CHAR(CONSTRUCTION_PLOT_RATIO) CONSTRUCTION_PLOT_RATIO,
                       TO_CHAR(CONSTRUCTION_BUILD_DENSITY) CONSTRUCTION_BUILD_DENSITY, OBJ_TYPE,
                       TO_CHAR(CONSTRUCTION_GREENING_RATE) CONSTRUCTION_GREENING_RATE, '0' GROUND_SALE_CARPORT
                from MDM_OBJ_PHASE_INDEX mopi
                     inner join T_PERIOD_NODE tnt on tnt.OBJ_PHASE_ID = mopi.OBJ_PHASE_ID
                where OBJ_TYPE = 20
                union
                select tParent.OBJ_PHASE_ID, TO_CHAR(SUM(TOTAL_SITE_AREA)) TOTAL_SITE_AREA,
                       TO_CHAR(SUM(CONSTRUCTION_LAND_AREA)) CONSTRUCTION_LAND_AREA,
                       TO_CHAR(SUM(CONFISCATED_AREA)) CONFISCATED_AREA, TO_CHAR(SUM(OVERALL_FLOORAGE_AREA)) OVERALL_FLOORAGE_AREA,
                       TO_CHAR(SUM(TOTAL_CAPACITY_AREA)) TOTAL_CAPACITY_AREA,
                       TO_CHAR(SUM(GROUND_ENGINE_CARPORT)) GROUND_ENGINE_CARPORT, TO_CHAR(SUM(SALE_RATIO)) SALE_RATIO,
                       TO_CHAR(SUM(CARPORT_RATIO)) CARPORT_RATIO,  TO_CHAR(SUM(TOTAL_HOUSEHOLDS)) TOTAL_HOUSEHOLDS,
                       TO_CHAR(SUM(PLOT_RATIO)) PLOT_RATIO, TO_CHAR(SUM(BUILD_DENSITY)) BUILD_DENSITY,
                       TO_CHAR(SUM(GREENING_RATE)) GREENING_RATE, TO_CHAR(SUM(CONSTRUCTION_PLOT_RATIO)) CONSTRUCTION_PLOT_RATIO,
                       TO_CHAR(SUM(CONSTRUCTION_BUILD_DENSITY)) CONSTRUCTION_BUILD_DENSITY, 0 OBJ_TYPE,
                       TO_CHAR(SUM(CONSTRUCTION_GREENING_RATE)) CONSTRUCTION_GREENING_RATE, '0' GROUND_SALE_CARPORT
                from MDM_OBJ_PHASE_INDEX mopi
                     inner join T_NODE_TREE tnt on tnt.OBJ_PHASE_ID = mopi.OBJ_PHASE_ID
                     inner join T_NODE_TREE tParent on tParent.ID = tnt.PARENT_ID
                where OBJ_TYPE = 20
                group by tnt.PARENT_ID, tParent.OBJ_PHASE_ID
            ),
            T_NODE_TREE_PT as (
                select t.ID, ORG_ID, ORG_NAME, NODE_TYPE, PARENT_ID, '' OPERATE_ATTRIBUTE_NAME,
                       BUILD_AREA, UNDERGROUND_TOTAL_BUILD_AREA, GROUND_CAPACITY_AREA, UNDERGROUND_CAPACITY_AREA,
                       GROUND_UNCAPACITY_AREA, UNDERGROUND_UNCAPACITY_AREA, UNDERGROUND_GARAGE_AREA, TOTAL_SALE_AREA, GROUND_SALE_AREA,
                       UNDERGROUND_SALE_AREA, TOTAL_GIVE_AREA, GROUND_GIVE_AREA, UNDERGROUND_GIVE_AREA, CARPORT_TOTAL,
                       GROUND_TOTAL_CARPORT,GROUND_CARPORT, RESIDENCE_BOTTOM_CARPORT,PARKING_GARAGE_CARPORT,
                       UNDERGROUND_TOTAL_RJ_CARPORT, UNDERGROUND_RFJ_CARPORT, UNDERGROUND_RJ_CARPORT, GROUND_TOTAL_BUILD_AREA,
                       UNDERGROUND_TOTAL_FRJ_CARPORT, UNDERGROUND_FRFJ_CARPORT, UNDERGROUND_FRJ_CARPORT,
                       UNDERGROUND_TOTAL_SALE_CARPORT, UNDERGROUND_R_SALE_CARPORT, UNDERGROUND_FRFJ_SALE_CARPORT,
                       UNDERGROUND_FRJ_SALE_CARPORT, TOTAL_SITE_AREA, CONSTRUCTION_LAND_AREA,  CONFISCATED_AREA,
                       OVERALL_FLOORAGE_AREA,  TOTAL_CAPACITY_AREA,  GROUND_ENGINE_CARPORT,  SALE_RATIO,
                       CARPORT_RATIO,  TOTAL_HOUSEHOLDS,  PLOT_RATIO,  BUILD_DENSITY,  GREENING_RATE,
                       CONSTRUCTION_PLOT_RATIO,  CONSTRUCTION_BUILD_DENSITY,  CONSTRUCTION_GREENING_RATE,
                       GROUND_SALE_CARPORT, tnt2.OBJ_PHASE_ID, OBJ_TYPE, ORDER_CODE, PHASE_ORDER
                from (
                         select
                             GET_UUID() ID,
                             null as IS_SALE,
                             tnt.ID as ORG_ID,
                             SUM(nvl(tnp.BUILD_AREA, 0))AS BUILD_AREA,--建筑占地面积
                             ----面积指标
                             SUM(nvl(tnp.GROUND_TOTAL_BUILD_AREA, 0))AS GROUND_TOTAL_BUILD_AREA,--地上总建筑面积
                             SUM(nvl(tnp.UNDERGROUND_TOTAL_BUILD_AREA, 0))AS UNDERGROUND_TOTAL_BUILD_AREA,--地下总建筑面积
                             SUM(nvl(tnp.GROUND_CAPACITY_AREA, 0))AS GROUND_CAPACITY_AREA,--地上计容面积
                             SUM(nvl(tnp.UNDERGROUND_CAPACITY_AREA, 0))AS UNDERGROUND_CAPACITY_AREA,--地下计容面积
                             SUM(nvl(tnp.GROUND_UNCAPACITY_AREA, 0))AS GROUND_UNCAPACITY_AREA,--地上非计容面积
                             SUM(nvl(tnp.UNDERGROUND_UNCAPACITY_AREA, 0))AS UNDERGROUND_UNCAPACITY_AREA,--地下非计容面积
                             SUM(nvl(tnp.UNDERGROUND_GARAGE_AREA, 0))AS UNDERGROUND_GARAGE_AREA,--地下车库面积
                             --销售面积指标
                             SUM(nvl(tnp.TOTAL_SALE_AREA, 0))AS TOTAL_SALE_AREA,--总可售面积
                             SUM(nvl(tnp.GROUND_SALE_AREA, 0))AS GROUND_SALE_AREA,--地上可售面积
                             SUM(nvl(tnp.UNDERGROUND_SALE_AREA, 0))AS UNDERGROUND_SALE_AREA,--地下可售面积
                             SUM(nvl(tnp.TOTAL_GIVE_AREA, 0))AS TOTAL_GIVE_AREA,--总赠送面积
                             SUM(nvl(tnp.GROUND_GIVE_AREA, 0))AS GROUND_GIVE_AREA,--地上总赠送面积
                             SUM(nvl(tnp.UNDERGROUND_GIVE_AREA, 0))AS UNDERGROUND_GIVE_AREA,--地上总赠送面积
                             --车位指标
                             SUM(nvl(tnp.CARPORT_TOTAL, 0))AS CARPORT_TOTAL,--总车位数
                             SUM(nvl(tnp.GROUND_TOTAL_CARPORT, 0))AS GROUND_TOTAL_CARPORT,--地上车位数
                             SUM(nvl(tnp.GROUND_CARPORT, 0))AS GROUND_CARPORT,--地面车位数
                             SUM(nvl(tnp.RESIDENCE_BOTTOM_CARPORT, 0))AS RESIDENCE_BOTTOM_CARPORT,--住宅底层车位数
                             SUM(nvl(tnp.PARKING_GARAGE_CARPORT, 0))AS PARKING_GARAGE_CARPORT,--停车楼车位数
                             SUM(nvl(tnp.UNDERGROUND_TOTAL_RJ_CARPORT, 0))AS UNDERGROUND_TOTAL_RJ_CARPORT,--地下总人防车位数（计算=UNDERGROUND_RFJ_CARPORT+UNDERGROUND_RJ_CARPORT―)
                             SUM(nvl(tnp.UNDERGROUND_RFJ_CARPORT, 0))AS UNDERGROUND_RFJ_CARPORT,--地下人防非机械车位数
                             SUM(nvl(tnp.UNDERGROUND_RJ_CARPORT, 0))AS UNDERGROUND_RJ_CARPORT,--地下人防机械车位数
                             SUM(nvl(tnp.UNDERGROUND_TOTAL_FRJ_CARPORT, 0))AS UNDERGROUND_TOTAL_FRJ_CARPORT,--地下非人防车位数
                             SUM(nvl(tnp.UNDERGROUND_FRFJ_CARPORT, 0))AS UNDERGROUND_FRFJ_CARPORT,--地下非人防非机械车位数
                             SUM(nvl(tnp.UNDERGROUND_FRJ_CARPORT, 0))AS UNDERGROUND_FRJ_CARPORT,--地下非人防机械车位数
                             SUM(nvl(tnp.UNDERGROUND_TOTAL_SALE_CARPORT, 0))AS UNDERGROUND_TOTAL_SALE_CARPORT,--总可售车位数
                             SUM(nvl(tnp.UNDERGROUND_R_SALE_CARPORT, 0))AS UNDERGROUND_R_SALE_CARPORT,--地下人防可售车位数
                             SUM(nvl(tnp.UNDERGROUND_FRFJ_SALE_CARPORT, 0))AS UNDERGROUND_FRFJ_SALE_CARPORT,--地下非人防非机械可售车位数
                             SUM(nvl(tnp.UNDERGROUND_FRJ_SALE_CARPORT, 0))AS UNDERGROUND_FRJ_SALE_CARPORT--地下非人防机械可售车位数
                         from(
                                 SELECT ID CHILD_ID, CONNECT_BY_ROOT ID AS ID
                                 FROM T_NODE_TREE
                                 CONNECT BY PRIOR ID=PARENT_ID
                             ) tnt left join T_NODE_LEAF_INDEX_PT tnp on tnt.CHILD_ID = tnp.PARENT_ID
                         group by tnt.ID
                     ) t left join T_NODE_TREE tnt2 on tnt2.ID = t.ORG_ID
                         left join T_NODE_UNLEAF_PT mopi on mopi.OBJ_PHASE_ID = tnt2.OBJ_PHASE_ID
                where OBJ_TYPE != 20 or IS_NO_PERIOD = 0
            ),
            T_RESULT as (
                select
                    tnp.ID "id",
                    operate_attribute_name as "isSale",
                    tnp.NODE_TYPE AS "objType",
                    tnp.ORG_ID as "orgId",
                    OBJ_PHASE_ID "objPhaseId",
                    tnp.ORG_NAME as "orgName",
                    tnp.PARENT_ID as "ptId",
                    tnp.BUILD_AREA AS "buildArea",--建筑占地面积
                    ----面积指标
                    tnp.GROUND_TOTAL_BUILD_AREA AS "groundTotalBuildArea",--地上总建筑面积
                    tnp.UNDERGROUND_TOTAL_BUILD_AREA AS "undergroundTotalBuildArea",--地下总建筑面积
                    tnp.GROUND_CAPACITY_AREA AS "groundCapacityArea",--地上计容面积
                    tnp.UNDERGROUND_CAPACITY_AREA AS "undergroundCapacityArea",--地下计容面积
                    tnp.GROUND_UNCAPACITY_AREA AS "groundUncapacityArea",--地上非计容面积
                    tnp.UNDERGROUND_UNCAPACITY_AREA AS "undergroundUncapacityArea",--地下非计容面积
                    tnp.UNDERGROUND_GARAGE_AREA AS "undergroundGarageArea",--地下车库面积
                    --销售面积指标
                    tnp.TOTAL_SALE_AREA AS "totalSaleArea",--总可售面积
                    tnp.GROUND_SALE_AREA AS "groundSaleArea",--地上可售面积
                    tnp.UNDERGROUND_SALE_AREA AS "undergroundSaleArea",--地下可售面积
                    tnp.TOTAL_GIVE_AREA AS "totalGiveArea",--总赠送面积
                    tnp.GROUND_GIVE_AREA AS "groundGiveArea",--地上总赠送面积
                    tnp.UNDERGROUND_GIVE_AREA AS "undergroundGiveArea",--地上总赠送面积
                    --车位指标
                    tnp.CARPORT_TOTAL AS "carportTotal",--总车位数
                    tnp.GROUND_TOTAL_CARPORT AS "groundTotalCarport",--地上车位数
                    tnp.GROUND_CARPORT AS "groundCarport",--地面车位数
                    tnp.RESIDENCE_BOTTOM_CARPORT AS "residenceBottomCarport",--住宅底层车位数
                    tnp.PARKING_GARAGE_CARPORT AS "parkingGarageCarport",--停车楼车位数
                    tnp.UNDERGROUND_TOTAL_RJ_CARPORT AS "undergroundTotalRjCarport",--地下总人防车位数（计算=UNDERGROUND_RFJ_CARPORT+UNDERGROUND_RJ_CARPORT―)
                    tnp.UNDERGROUND_RFJ_CARPORT AS "undergroundRfjCarport",--地下人防非机械车位数
                    tnp.UNDERGROUND_RJ_CARPORT AS "undergroundRjCarport",--地下人防机械车位数
                    tnp.UNDERGROUND_TOTAL_FRJ_CARPORT AS "undergroundTotalFrjCarport",--地下非人防车位数
                    tnp.UNDERGROUND_FRFJ_CARPORT AS "undergroundFrfjCarport",--地下非人防非机械车位数
                    tnp.UNDERGROUND_FRJ_CARPORT AS "undergroundFrjCarport",--地下非人防机械车位数
                    tnp.UNDERGROUND_TOTAL_SALE_CARPORT AS "undergroundTotalSaleCarport",--总可售车位数
                    tnp.UNDERGROUND_R_SALE_CARPORT AS "undergroundRSaleCarport",--地下人防可售车位数
                    tnp.UNDERGROUND_FRFJ_SALE_CARPORT AS "undergroundFrfjSaleCarport",--地下非人防非机械可售车位数
                    tnp.UNDERGROUND_FRJ_SALE_CARPORT AS "undergroundFrjSaleCarport",--地下非人防机械可售车位数
                    -- 指标独有数据
                    tnp.TOTAL_SITE_AREA AS "totalSiteArea",
                    tnp.CONSTRUCTION_LAND_AREA AS "constructionLandArea",
                    tnp.CONFISCATED_AREA AS "confiscatedArea",
                    tnp.OVERALL_FLOORAGE_AREA AS "overallFloorageArea",
                    tnp.TOTAL_CAPACITY_AREA AS "totalCapacityArea",
                    tnp.GROUND_ENGINE_CARPORT AS "groundEngineCarport",
                    tnp.SALE_RATIO AS "saleRatio",
                    tnp.CARPORT_RATIO AS "carportRatio",
                    tnp.TOTAL_HOUSEHOLDS AS "totalHouseholds",
                    tnp.PLOT_RATIO AS "plotRatio",
                    tnp.BUILD_DENSITY AS "buildDensity",
                    tnp.GREENING_RATE AS "greeningRate",
                    tnp.CONSTRUCTION_PLOT_RATIO AS "constructionPlotRatio",
                    tnp.CONSTRUCTION_BUILD_DENSITY AS "constructionBuildDensity",
                    tnp.CONSTRUCTION_GREENING_RATE AS "constructionGreeningRate",
                    tnp.GROUND_SALE_CARPORT AS "groundSaleCarport",
                    ORDER_CODE "orderCode", PHASE_ORDER "phaseOrder"
                from (
                         select * from T_NODE_LEAF_INDEX_PT
                         union select * from T_NODE_TREE_PT
                     ) tnp
            )
        select * from T_RESULT
        where "objType" != 10
        order by "orderCode";
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_DATA_INDEX_TO_SUPPLAN
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_DATA_INDEX_TO_SUPPLAN" (
    projectId in varchar2, --项目ID
    item out SYS_REFCURSOR
)
    is
    v_max_order int:=0;
begin
    -- 获取项目id
        SELECT A.* INTO v_max_order FROM (
            SELECT PHASE_ORDER  FROM MDM_PROJECT_PHASE 
            WHERE PROJ_ID=projectId AND PHASE_STATE IN (19,20) ORDER BY PHASE_ORDER DESC
        )A WHERE ROWNUM=1;

        IF v_max_order=1 THEN
       OPEN item FOR
        WITH PROJ_DATA AS (
                SELECT 
                    id as "bizId",
                    id as "objId",
                    Project_Name as "objName",
                    '' AS "bizParentId",
                    '项目' as "objType",
                    '' as "buildProductTypeName",
                    '' as "ownBuildProductTypeId",
                    '' as "buildProductTypeId",
                    NULL as "supplyTotalAmount",
                    NULL as "supplyTotalNumber",
                    NULL as "supplyTotalArea",
                    0 AS "obtainPlanningPermit",
                    lpad(1,6,'0') AS "orderCode"
                    FROM SYS_PROJECT 
                        WHERE ID=projectId
            ),
            TARGET_WORTH AS (
               SELECT a.* from (
                     SELECT * FROM DWM_TARGET_WORTH 
                        WHERE proj_id=projectId
                        AND approval_status='已审核' 
                        ORDER BY WORTH_V DESC,target_worth_phase DESC
               )a where rownum=1
            ),
            PARCEL_DATA AS (
                SELECT A.*
                    ,lpad(ROWNUM,6,'0') AS "orderCode"
                    FROM (
                        SELECT  pd."bizId"||'_'||sp.id as "bizId",
                                sp.id as "objId",
                                sp.PARCEL_NAME AS "objName",
                                pd."bizId" AS "bizParentId",
                                '宗地' as "objType",
                                '' as "buildProductTypeName",
                                '' as "ownBuildProductTypeId",
                                '' as "buildProductTypeId",
                                NULL as "supplyTotalAmount",
                                NULL as "supplyTotalNumber",
                                NULL as "supplyTotalArea",
                                0 AS "obtainPlanningPermit"
                                FROM SYS_PARCEL sp
                                INNER JOIN PROJ_DATA pd on pd."objId" =sp.PROJECT_ID
                                ORDER BY CREATED_TIME asc
                )A
            ),
            PT_PARCEL_DATA AS (
                select sp."bizId" as "bizId",
                        sp."objId" as "parcelId",
                        mbpt2.PRODUCT_TYPE_SHORT_NAME as "buildProductTypeName",
                        mbpt1.id as "buildProductTypeId",
                        projectId as "projectId",
                        mbpt2.id as "ownBuildProductTypeId",
                        CASE WHEN mbpt1.IS_CARPORT=1 THEN moppi.UNDERGROUND_TOTAL_SALE_CARPORT ELSE (moppi.TOTAL_RESIDENCE+moppi.TOTAL_BUSINESS) END as "supplyTotalNumber",
                        moppi.TOTAL_SALE_AREA as "supplyTotalArea"
                        from MDM_BUILD_PRODUCT_TYPE mbpt1
                        inner join MDM_BUILD_PRODUCT_TYPE mbpt2 on mbpt2.PRODUCT_TYPE_CODE = substr(mbpt1.PRODUCT_TYPE_CODE, 0, 1)
                        inner join MDM_OBJ_PHASE_PT_INDEX moppi on moppi.PRODUCT_TYPE_ID = mbpt1.ID
                        inner JOIN MDM_PARCEL_PHASE mpp on moppi.OBJ_PHASE_ID=mpp.id
                        inner join PARCEL_DATA sp on sp."objId"=mpp.PAECEL_ID
                        where mpp.phase_state in (19,20)
            ),
            PARCEL_PT_DATA AS (
                SELECT b.* from (
                    SELECT 
                        distinct a.*,lpad(row_number() over(partition by a."bizParentId" order by bpt.product_type_code),6,'0') AS "orderCode"
                        FROM (
                            SELECT 
                                distinct
                                pd."bizId"||'_'||pd."ownBuildProductTypeId" as "bizId",
                                pd."ownBuildProductTypeId" as "objId",
                                pd."buildProductTypeName" as "objName",
                                pd."bizId" as "bizParentId",
                                '业态' as "objType",
                                pd."buildProductTypeName",
                                pd."ownBuildProductTypeId",
                                pd."ownBuildProductTypeId" as "buildProductTypeId",
                                SUM(twd.WORTH)over(PARTITION by pd."bizId",pd."ownBuildProductTypeId") AS "supplyTotalAmount",
                                SUM(pd."supplyTotalNumber")over(PARTITION by pd."bizId",pd."ownBuildProductTypeId") AS "supplyTotalNumber",
                                SUM(pd."supplyTotalArea")over(PARTITION by pd."bizId",pd."ownBuildProductTypeId") AS "supplyTotalArea",
                                0 as "obtainPlanningPermit"
                                FROM PT_PARCEL_DATA pd 
                                LEFT JOIN TARGET_WORTH tw on pd."projectId"=tw.PROJ_ID
                                LEFT JOIN DWM_TARGET_WORTH_DTL twd on tw.id=twd.TARGET_WORTH_ID    
                                AND twd.OBJ_ID=pd."buildProductTypeId" and twd.OBJ_PARENT_ID=pd."parcelId"
                        )a  inner join MDM_BUILD_PRODUCT_TYPE bpt on a."ownBuildProductTypeId"=bpt.id
                )b order by b."orderCode"
            )
        SELECT * FROM PROJ_DATA
        UNION ALL 
        SELECT * FROM PARCEL_DATA
        UNION ALL
        SELECT * FROM PARCEL_PT_DATA;

        ELSIF v_max_order=2 THEN
        OPEN item FOR
         WITH PROJ_DATA AS (
                SELECT 
                    id as "bizId",
                    id as "objId",
                    Project_Name as "objName",
                    '' AS "bizParentId",
                    '项目' as "objType",
                    '' as "buildProductTypeName",
                    '' as "ownBuildProductTypeId",
                    '' as "buildProductTypeId",
                    NULL as "supplyTotalAmount",
                    NULL as "supplyTotalNumber",
                    NULL as "supplyTotalArea",
                    0 AS "obtainPlanningPermit",
                    lpad(1,6,'0') AS "orderCode"
                    FROM SYS_PROJECT 
                        WHERE ID=projectId
            ),
            TARGET_WORTH AS (
               SELECT a.* from (
                     SELECT * FROM DWM_TARGET_WORTH 
                        WHERE proj_id=projectId
                        AND approval_status='已审核' 
                        ORDER BY WORTH_V DESC,target_worth_phase DESC
               )a where rownum=1
            ),
            PERIOD_DATA AS (
                SELECT A.*,lpad(ROWNUM,6,'0') AS "orderCode" FROM (
                    SELECT  pd."bizId"||'_'||sps.id as "bizId",
                            sps.id as "objId",
                            sps.STAGE_NAME AS "objName",
                            pd."bizId" AS "bizParentId",
                            case when COUNT(*) OVER(
                                PARTITION BY pd."objId"
                            )=1 and sps.STAGE_NAME='无分期' then '无分期' else '分期' end as "objType",
                            '' as "buildProductTypeName",
                            '' as "ownBuildProductTypeId",
                            '' as "buildProductTypeId",
                            NULL as "supplyTotalAmount",
                            NULL as "supplyTotalNumber",
                            NULL as "supplyTotalArea",
                            0 as "obtainPlanningPermit"
                            FROM SYS_PROJECT_STAGE sps
                            INNER JOIN PROJ_DATA pd
                            on sps.PROJECT_ID=pd."objId"
                            ORDER BY ORDER_CODE
                )A
            ),
            PT_PERIOD_DATA AS (
                select sp."bizId" ,
                    sp."objId" as "periodId",
                    sp."obtainPlanningPermit",
                    mbpt2.PRODUCT_TYPE_SHORT_NAME as "buildProductTypeName",
                    mbpt1.id as "buildProductTypeId",
                    projectId as "projectId",
                    mbpt2.PRODUCT_TYPE_SHORT_NAME AS "ownBuildProductTypeName",
                    mbpt2.id as "ownBuildProductTypeId",
                     CASE WHEN mbpt1.IS_CARPORT=1 THEN moppi.UNDERGROUND_TOTAL_SALE_CARPORT ELSE (moppi.TOTAL_RESIDENCE+moppi.TOTAL_BUSINESS) END as "supplyTotalNumber",
                    moppi.TOTAL_SALE_AREA as "supplyTotalArea",
                    lpad(row_number() over(partition by sp."objId" order by mbpt1.product_type_code),6,'0') AS "orderCode"
                    from MDM_BUILD_PRODUCT_TYPE mbpt1
                    inner join MDM_BUILD_PRODUCT_TYPE mbpt2 on mbpt2.PRODUCT_TYPE_CODE = substr(mbpt1.PRODUCT_TYPE_CODE, 0, 1)
                    inner join MDM_OBJ_PHASE_PT_INDEX moppi on moppi.PRODUCT_TYPE_ID = mbpt1.ID
                    inner JOIN MDM_PERIOD_PHASE mpp on moppi.OBJ_PHASE_ID=mpp.id
                    inner join PERIOD_DATA sp on sp."objId"=mpp.PERIOD_ID
                    where mpp.phase_state in (19,20)
            ),
            PERIOD_INDEX_DATA AS (
                SELECT b.* from (
                    SELECT a.*,
                    lpad(row_number() over(partition by a."bizParentId" order by bpt.product_type_code),6,'0') AS "orderCode" from (
                        SELECT 
                            distinct
                            pd."bizId"||'_'||pd."ownBuildProductTypeId" as "bizId",
                            pd."ownBuildProductTypeId" as "objId",
                            pd."ownBuildProductTypeName" as "objName",
                            pd."bizId" as "bizParentId",
                             '业态' as "objType",
                            pd."buildProductTypeName",
                            pd."ownBuildProductTypeId",
                            pd."ownBuildProductTypeId" as "buildProductTypeId",
                            SUM(twd.WORTH)over(PARTITION by pd."bizId",pd."ownBuildProductTypeId") AS "supplyTotalAmount",
                            SUM(pd."supplyTotalNumber")over(PARTITION by pd."bizId",pd."ownBuildProductTypeId") AS "supplyTotalNumber",
                            SUM(pd."supplyTotalArea")over(PARTITION by pd."bizId",pd."ownBuildProductTypeId") AS "supplyTotalArea",
                            pd."obtainPlanningPermit"
                            FROM PT_PERIOD_DATA pd 
                            LEFT JOIN TARGET_WORTH tw on pd."projectId"=tw.PROJ_ID
                            LEFT JOIN DWM_TARGET_WORTH_DTL twd on tw.id=twd.TARGET_WORTH_ID    
                            AND twd.OBJ_ID=pd."buildProductTypeId" AND twd.OBJ_PARENT_ID=pd."periodId"
                    )a inner join MDM_BUILD_PRODUCT_TYPE bpt on a."ownBuildProductTypeId"=bpt.id
                )b order by b."orderCode"
            )
            SELECT * FROM PROJ_DATA
            UNION ALL 
            SELECT * FROM PERIOD_DATA
            UNION ALL
            SELECT * FROM PERIOD_INDEX_DATA;
        ELSIF v_max_order>2 THEN
        OPEN item FOR
           WITH PROJ_DATA AS (
                        SELECT 
                            id as "bizId",
                            id as "objId",
                            Project_Name as "objName",
                            '' AS "bizParentId",
                            '项目' as "objType",
                            '' as "buildProductTypeName",
                            '' as "ownBuildProductTypeId",
                            '' as "buildProductTypeId",
                            NULL as "supplyTotalAmount",
                            NULL as "supplyTotalNumber",
                            NULL as "supplyTotalArea",
                            0 AS "obtainPlanningPermit",
                            lpad(1,6,'0') as "orderCode"
                            FROM SYS_PROJECT 
                                WHERE ID=projectId
                    ),
                    TARGET_WORTH AS (
                       SELECT a.* from (
                             SELECT * FROM DWM_TARGET_WORTH 
                                WHERE proj_id=projectId
                                AND approval_status='已审核' 
                                ORDER BY WORTH_V DESC,target_worth_phase DESC
                       )a where rownum=1
                    ),
                    PERIOD_PHASE_DATA AS (
                        SELECT * FROM MDM_PERIOD_PHASE mpp1 
                        inner join(
                            SELECT sps.id as "period_id",max(phase_order)as "max_order" FROM SYS_PROJECT_STAGE sps
                                LEFT JOIN MDM_PERIOD_PHASE mpp on sps.id=mpp.period_id
                            WHERE PROJECT_ID=projectId and mpp.phase_state in (19,20) GROUP BY sps.id
                        )a on mpp1.period_id=a."period_id" and mpp1.phase_order=a."max_order"            
                    ),
                    PERIOD_DATA AS (
                        SELECT A.*,
                        lpad(ROWNUM,6,'0') as "orderCode" FROM (
                            SELECT  pd."bizId"||'_'||sps.id as "bizId",
                                    sps.id as "objId",
                                    STAGE_NAME AS "objName",
                                    pd."bizId" AS "bizParentId",
                                    case when COUNT(*) OVER(
                                        PARTITION BY pd."objId"
                                    )=1 and sps.STAGE_NAME='无分期' then '无分期' else '分期' end as "objType",
                                    '' as "buildProductTypeName",
                                    '' as "ownBuildProductTypeId",
                                    '' as "buildProductTypeId",
                                    NULL as "supplyTotalAmount",
                                    NULL as "supplyTotalNumber",
                                    NULL as "supplyTotalArea",
                                    case when period_phase."max_order" >=3 then 1 else 0 end "obtainPlanningPermit"
                                    FROM SYS_PROJECT_STAGE sps
                                    INNER JOIN (
                                        SELECT PERIOD_ID as "period_Id" ,MAX(PHASE_ORDER) as "max_order" FROM MDM_PERIOD_PHASE 
                                            WHERE phase_state in (19,20) 
                                        GROUP BY period_id
                                    )period_phase on sps.id=period_phase."period_Id"
                                    INNER JOIN PROJ_DATA pd
                                    on sps.PROJECT_ID=pd."objId"
                                    ORDER BY ORDER_CODE
                        )A
                    ),
                    BUILD_DATA AS (
                        SELECT  pd."bizId"||'_'||sb.id as "bizId",
                                sb.id as "objId",
                                BUILD_NAME AS "objName",
                                pd."bizId" AS "bizParentId",
                                '楼栋' as "objType",
                                '' as "buildProductTypeName",
                                '' as "ownBuildProductTypeId",
                                '' as "buildProductTypeId",
                                NULL as "supplyTotalAmount",
                                NULL as "supplyTotalNumber",
                                NULL as "supplyTotalArea",
                                pd."obtainPlanningPermit",
                                lpad(row_number() over(partition by pd."bizId" order by nvl(regexp_replace(sb.BUILD_NAME, '[^0-9]', ''),'0')*1),6,'0') AS "orderCode"
                        from PERIOD_DATA pd
                            INNER JOIN 
                        SYS_BUILD sb on pd."objId"=sb.period_id 
                        order by nvl(regexp_replace(sb.BUILD_NAME, '[^0-9]', ''),'0')*1
                    ),
                    BUILD_PHASE_DATA AS (
                        SELECT * FROM MDM_BUILD_PHASE mpp1 
                        inner join(
                            SELECT sb."objId" as "build_id",max(phase_order)as "max_order" FROM BUILD_DATA sb
                                LEFT JOIN MDM_BUILD_PHASE mbp on sb."objId"=mbp.build_id
                            WHERE  mbp.phase_state in (19,20) GROUP BY sb."objId"
                        )a on mpp1.build_id=a."build_id" and mpp1.phase_order=a."max_order"            
                    ),
                    PT_BUILD_DATA AS (
                        select 
                            sb."bizId",
                            sb."objId" as "buildId",
                            sb."obtainPlanningPermit",
                            mbpt2.PRODUCT_TYPE_SHORT_NAME as "buildProductTypeName",
                            mbpt1.id as "buildProductTypeId",
                            mbpt2.PRODUCT_TYPE_SHORT_NAME AS "ownBuildProductTypeName",
                            mbpt2.id as "ownBuildProductTypeId",
                            projectId as "projectId",
                             CASE WHEN mbpt1.IS_CARPORT=1 THEN moppi.UNDERGROUND_TOTAL_SALE_CARPORT ELSE (moppi.TOTAL_RESIDENCE+moppi.TOTAL_BUSINESS) END as "supplyTotalNumber",
                            moppi.TOTAL_SALE_AREA as "supplyTotalArea",
                            mpp.phase_order,
                            lpad(row_number() over(partition by sb."objId" order by mbpt1.product_type_code),6,'0') "orderCode",
                            mbpt2.product_type_code AS "productTypeCode"
                            from MDM_BUILD_PRODUCT_TYPE mbpt1
                            inner join MDM_BUILD_PRODUCT_TYPE mbpt2 on mbpt2.PRODUCT_TYPE_CODE = substr(mbpt1.PRODUCT_TYPE_CODE, 0, 1)
                            inner join MDM_OBJ_PHASE_PT_INDEX moppi on moppi.PRODUCT_TYPE_ID = mbpt1.ID
                            inner JOIN BUILD_PHASE_DATA mpp on moppi.OBJ_PHASE_ID=mpp.id
                            INNER JOIN BUILD_DATA sb on mpp.build_id=sb."objId"
                    ),
                    PT_PERIOD_DATA AS (
                        select sp."bizId",
                            sp."objId" as "periodId",
                            sp."obtainPlanningPermit",
                            mbpt2.PRODUCT_TYPE_SHORT_NAME as "buildProductTypeName",
                            mbpt1.id as "buildProductTypeId",
                            projectId as "projectId",
                            mbpt2.PRODUCT_TYPE_SHORT_NAME AS "ownBuildProductTypeName",
                            mbpt2.id as "ownBuildProductTypeId",
                             CASE WHEN mbpt1.IS_CARPORT=1 THEN moppi.UNDERGROUND_TOTAL_SALE_CARPORT ELSE (moppi.TOTAL_RESIDENCE+moppi.TOTAL_BUSINESS) END as "supplyTotalNumber",
                            moppi.TOTAL_SALE_AREA as "supplyTotalArea",
                            mpp.phase_order,
                            lpad(row_number() over(partition by sp."objId" order by mbpt1.product_type_code),6,'0') "orderCode"
                            from MDM_BUILD_PRODUCT_TYPE mbpt1
                            inner join MDM_BUILD_PRODUCT_TYPE mbpt2 on mbpt2.PRODUCT_TYPE_CODE = substr(mbpt1.PRODUCT_TYPE_CODE, 0, 1)
                            inner join MDM_OBJ_PHASE_PT_INDEX moppi on moppi.PRODUCT_TYPE_ID = mbpt1.ID
                            inner JOIN PERIOD_PHASE_DATA mpp on moppi.OBJ_PHASE_ID=mpp.id
                            inner join PERIOD_DATA sp on sp."objId"=mpp.PERIOD_ID
                            LEFT  JOIN SYS_BUILD sb on sp."objId"=sb.period_id 
                            WHERE sb.id is null AND mpp."max_order"=2
                    ),
                    BUILD_INDEX_DATA AS (
                        SELECT 
                            DISTINCT
                            pd."ownBuildProductTypeId" as "objId",
                            pd."ownBuildProductTypeName" as "objName",
                            pd."bizId" as "bizParentId",
                            pd."buildProductTypeName",
                            pd."ownBuildProductTypeId",
                            pd."ownBuildProductTypeId" as "buildProductTypeId",
                            SUM(twd.WORTH)over(PARTITION by pd."bizId",pd."ownBuildProductTypeId") AS "supplyTotalAmount",
                            SUM(pd."supplyTotalNumber")over(PARTITION by pd."bizId",pd."ownBuildProductTypeId") AS "supplyTotalNumber",
                            SUM(pd."supplyTotalArea")over(PARTITION by pd."bizId",pd."ownBuildProductTypeId") AS "supplyTotalArea",
                            pd."obtainPlanningPermit",
                            pd."productTypeCode"
                            FROM PT_BUILD_DATA pd 
                            LEFT JOIN TARGET_WORTH tw on pd."projectId"=tw.PROJ_ID
                            LEFT JOIN DWM_TARGET_WORTH_DTL twd on tw.id=twd.TARGET_WORTH_ID    
                            AND twd.OBJ_ID=pd."buildProductTypeId" and twd.OBJ_PARENT_ID=pd."buildId"
                    ),
                    BUILD_PI_DATA AS(
                        SELECT bd."bizId"||'_'||bid."ownBuildProductTypeId",
                        bd."objId",
                        bd."objName",
                        bd."bizParentId",
                        bd."objType",
                        bid."buildProductTypeName",
                        bid."ownBuildProductTypeId",
                        bid."buildProductTypeId",
                        bid."supplyTotalAmount",
                        bid."supplyTotalNumber",
                        bid."supplyTotalArea",
                        bd."obtainPlanningPermit",
                        bd."orderCode"||'.'||bid."productTypeCode"
                        FROM BUILD_DATA bd
                        LEFT JOIN BUILD_INDEX_DATA bid on bd."bizId"=bid."bizParentId"
                    ),
                    PERIOD_INDEX_DATA AS (
                        SELECT b.* from (
                            SELECT a.*,
                            lpad(row_number() over(partition by a."bizParentId" order by bpt.product_type_code),6,'0') AS "orderCode" from (
                                SELECT 
                                    distinct
                                    pd."bizId"||'_'||pd."ownBuildProductTypeId" as "bizId",
                                    pd."ownBuildProductTypeId" as "objId",
                                    pd."ownBuildProductTypeName" as "objName",
                                    pd."bizId" as "bizParentId",
                                     '业态' as "objType",
                                    pd."buildProductTypeName",
                                    pd."ownBuildProductTypeId",
                                    pd."ownBuildProductTypeId" as "buildProductTypeId",
                                    SUM(twd.WORTH)over(PARTITION by pd."bizId",pd."ownBuildProductTypeId") AS "supplyTotalAmount",
                                    SUM(pd."supplyTotalNumber")over(PARTITION by pd."bizId",pd."ownBuildProductTypeId") AS "supplyTotalNumber",
                                    SUM(pd."supplyTotalArea")over(PARTITION by pd."bizId",pd."ownBuildProductTypeId") AS "supplyTotalArea",
                                    pd."obtainPlanningPermit"
                                    FROM PT_PERIOD_DATA pd 
                                    LEFT JOIN TARGET_WORTH tw on pd."projectId"=tw.PROJ_ID
                                    LEFT JOIN DWM_TARGET_WORTH_DTL twd on tw.id=twd.TARGET_WORTH_ID    
                                    AND twd.OBJ_ID=pd."buildProductTypeId" AND twd.OBJ_PARENT_ID=pd."periodId"
                            )a inner join MDM_BUILD_PRODUCT_TYPE bpt on a."ownBuildProductTypeId"=bpt.id
                        )b order by b."orderCode"
                    )
                    SELECT * FROM PROJ_DATA
                    UNION ALL 
                    SELECT * FROM PERIOD_DATA
                    UNION ALL
                    SELECT * FROM BUILD_PI_DATA
                    UNION ALL 
                    SELECT * FROM PERIOD_INDEX_DATA;
        END IF;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_DATA_INFO
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_DATA_INFO" (
    startWorks in   VARCHAR2,--开工
    productTypes in  CLOB,
    projectIds in  CLOB,
    projCooperate in  VARCHAR2,
    info out sys_refcursor
)
    is
    domain_mdm VARCHAR2(500):=GET_JUMP_URL_DOMAIN('pc','mdm');
begin
    open info for
with startWrok as (
     SELECT s.id as PROJECT_ID,nvl(s1.cnt,0)as cnt from
        (SELECT * FROM SYS_PROJECT
            where instr(projectIds, id)>0)s
        LEFT JOIN (
             SELECT c.* from  (
                     SELECT sps.PROJECT_ID, count(*) cnt FROM (
                        SELECT pp.*,ppn.id as node_id FROM POM_PROJ_PLAN pp
                        LEFT JOIN POM_PROJ_PLAN_NODE ppn on pp.id=ppn.proj_plan_id
                            where pp.APPROVAL_STATUS='已审核' and pp.plan_type='关键节点计划' and ppn.IS_CONTAINS_PERMIT=1 AND ppn.PERMIT_TYPE='施工许可证'
                    )a LEFT JOIN POM_NODE_FEEDBACK nf on a.node_id=nf.FEEDBACK_NODE_ID
                    LEFT JOIN SYS_PROJECT_STAGE sps on sps.ID=a.proj_id
                    WHERE nf.APPROVAL_STATUS='已审核' and nf.FEEDBACK_TYPE='CARRY_OUT'
                    GROUP BY sps.PROJECT_ID
            )c where  instr(projectIds, c.project_id)>0
    )s1 on s.id=s1.PROJECT_ID
),
projPi as (
    SELECT b.id as org_id,b.project_name as org_name,b.id as parent_id,b.example_id,mi.* from (
        SELECT sp.*,ph.phase_order,ph.id as example_Id FROM SYS_PROJECT sp
            LEFT JOIN (
                 select mpp1.*
                    from MDM_PROJECT_PHASE mpp1
                    inner join (
                        select PROJ_ID, max(PHASE_ORDER)as PHASE_ORDER
                        from MDM_PROJECT_PHASE
                        where PHASE_STATE =19 or PHASE_STATE=20
                        group by PROJ_ID
                 ) mpp2 on mpp1.PROJ_ID = mpp2.PROJ_ID
                        and mpp1.PHASE_ORDER = mpp2.PHASE_ORDER
            )ph on sp.id=ph.proj_id where ph.id is not null and ph.phase_order=1
            and (
                   (startWorks='所有' and (instr(projectIds, sp.id)>0))
                or (startWorks = '开工' and sp.id in (select PROJECT_ID from startWrok WHERE cnt>0))
                or (startWorks='未开工' and sp.id in (select PROJECT_ID from startWrok WHERE cnt<1))
            )
            AND (projCooperate='所有' or projCooperate=sp.PROJ_COOPERATE)
    )b
    LEFT JOIN MDM_OBJ_PHASE_INDEX mi on b.example_Id=mi.OBJ_PHASE_ID
),
projPt as (
    SELECT pi2.org_id as org_id,pi2.org_name as org_name,pi2.parent_id as parent_id,mpi.* from projPi pi2
    LEFT JOIN MDM_OBJ_PHASE_PT_INDEX mpi on mpi.OBJ_PHASE_ID=pi2.example_id
    where (instr(productTypes,mpi.PRODUCT_TYPE_ID)>0)
),
periodPi as (
    SELECT a.id as org_id,a.stage_name as org_Name,a.project_id as parent_id,a.example_Id,mi.* from (
        SELECT sps.*,ph.phase_order,ph.id as example_Id FROM SYS_PROJECT sp
        LEFT JOIN SYS_PROJECT_STAGE sps on sp.id=sps.project_id
        LEFT JOIN (
            select mpp1.*
                from MDM_PERIOD_PHASE mpp1
                inner join (
                    select PERIOD_ID, max(PHASE_ORDER)as PHASE_ORDER
                    from MDM_PERIOD_PHASE
                    where PHASE_STATE =19 or PHASE_STATE=20
                    group by PERIOD_ID
                ) mpp2 on mpp1.PERIOD_ID = mpp2.PERIOD_ID
                    and mpp1.PHASE_ORDER = mpp2.PHASE_ORDER
        )ph on sps.id=ph.period_id where  ph.id is not null
         and (
                   (startWorks='所有' and (instr(projectIds, sp.id)>0))
                or (startWorks = '开工' and sp.id in (select PROJECT_ID from startWrok WHERE cnt>0))
                or (startWorks='未开工' and sp.id in (select PROJECT_ID from startWrok WHERE cnt<1))
            )
          AND (projCooperate='所有' or projCooperate=sp.PROJ_COOPERATE)
    )a
    LEFT JOIN MDM_OBJ_PHASE_INDEX mi on a.example_Id=mi.OBJ_PHASE_ID
),
periodPt as(
    SELECT pi.id as org_id,pi.org_Name as org_Name,pi.parent_id as parent_id,mpi.* FROM periodPi pi
    LEFT JOIN MDM_OBJ_PHASE_PT_INDEX mpi on mpi.OBJ_PHASE_ID=pi.example_id
    where (instr(productTypes,mpi.PRODUCT_TYPE_ID)>0)
),
top as (
    select ID, PRODUCT_TYPE_NAME, PRODUCT_TYPE_LEVEL, connect_BY_ROOT(ID) as topId, connect_BY_ROOT(PRODUCT_TYPE_NAME) as topName
    from MDM_BUILD_PRODUCT_TYPE mbpt
    start with mbpt.ID in (select PRODUCT_TYPE_ID from periodPt UNION ALL select PRODUCT_TYPE_ID from projPt)
    CONNECT BY PRIOR mbpt.PARENT_CODE = mbpt.PRODUCT_TYPE_CODE
),
prodcut as (
        SELECT
            '' as "orderHierarchyCode",
            40 as "objType",
            '' as "operateAttribute",--操盘属性
            get_uuid() as "orgId",x.* from (
            SELECT
            distinct
            sa2.parent_id as "ptId",
            sa2.product_top_name as "orgName",
            SUM(sa2.BUILD_AREA)over(PARTITION by sa2.PRODUCT_TOP_ID) AS "buildArea",--建筑占地面积
    --        --面积指标
            SUM(sa2.GROUND_TOTAL_BUILD_AREA)over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "groundTotalBuildArea",--地上总建筑面积
            SUM(sa2.UNDERGROUND_TOTAL_BUILD_AREA)over(PARTITION by sa2.parent_id, sa2.PRODUCT_TOP_ID) AS "undergroundTotalBuildArea",--地下总建筑面积
            SUM(sa2.GROUND_CAPACITY_AREA)over(PARTITION by  sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "groundCapacityArea",--地上计容面积
            SUM(sa2.UNDERGROUND_CAPACITY_AREA)over(PARTITION by sa2.parent_id, sa2.PRODUCT_TOP_ID) AS "undergroundCapacityArea",--地下计容面积
            SUM(sa2.GROUND_UNCAPACITY_AREA)over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "groundUncapacityArea",--地上非计容面积
            SUM(sa2.UNDERGROUND_UNCAPACITY_AREA)over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundUncapacityArea",--地下非计容面积
            SUM(sa2.UNDERGROUND_GARAGE_AREA)over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundGarageArea",--地下车库面积
            --销售面积指标
            SUM(sa2.TOTAL_SALE_AREA)over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "totalSaleArea",--总可售面积
            SUM(sa2.GROUND_SALE_AREA)over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "groundSaleArea",--地上可售面积
            SUM(sa2.UNDERGROUND_SALE_AREA)over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundSaleArea",--地下可售面积
            SUM(sa2.TOTAL_GIVE_AREA)over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "totalGiveArea",--总赠送面积
            SUM(sa2.GROUND_GIVE_AREA)over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "groundGiveArea",--地上总赠送面积
            SUM(sa2.UNDERGROUND_GIVE_AREA)over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundGiveArea",--地上总赠送面积
            --车位指标
            SUM(sa2.CARPORT_TOTAL)over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "carportTotal",--总车位数
            SUM(sa2.GROUND_TOTAL_CARPORT)over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "groundTotalCarport",--地上车位数
            SUM(sa2.GROUND_CARPORT)over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "groundCarport",--地面车位数
            SUM(sa2.RESIDENCE_BOTTOM_CARPORT)over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "residenceBottomCarport",--住宅底层车位数
            SUM(sa2.PARKING_GARAGE_CARPORT)over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "parkingGarageCarport",--停车楼车位数
            SUM(sa2.UNDERGROUND_TOTAL_RJ_CARPORT)over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundTotalRjCarport",--地下总人防车位数（计算=UNDERGROUND_RFJ_CARPORT+UNDERGROUND_RJ_CARPORT―)
            SUM(sa2.UNDERGROUND_RFJ_CARPORT)over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundRfjCarport",--地下人防非机械车位数
            SUM(sa2.UNDERGROUND_RJ_CARPORT)over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundRjCarport",--地下人防机械车位数
            SUM(sa2.UNDERGROUND_TOTAL_FRJ_CARPORT)over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundTotalFrjCarport",--地下非人防车位数
            SUM(sa2.UNDERGROUND_FRFJ_CARPORT)over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundFrfjCarport",--地下非人防非机械车位数
            SUM(sa2.UNDERGROUND_FRJ_CARPORT)over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundFrjCarport",--地下非人防机械车位数
            SUM(sa2.UNDERGROUND_TOTAL_SALE_CARPORT)over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundTotalSaleCarport",--总可售车位数
            SUM(sa2.UNDERGROUND_R_SALE_CARPORT)over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundRSaleCarport",--地下人防可售车位数
            SUM(sa2.UNDERGROUND_FRFJ_SALE_CARPORT)over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundFrfjSaleCarport",--地下非人防非机械可售车位数
            SUM(sa2.UNDERGROUND_FRJ_SALE_CARPORT)over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundFrjSaleCarport",--地下非人防机械可售车位数
            0.00 as "totalSiteArea",
            0.00 AS "constructionLandArea",
            0.00 AS "confiscatedArea",
            0.00 AS "overallFloorageArea",
            0.00 AS "totalCapacityArea",
            0.00 AS "groundEngineCarport",
            0.00 AS "saleRatio",
            0.00 AS "carportRatio",
            0.00 AS "totalHouseholds",
            0.00 AS "plotRatio",
            0.00 AS "buildDensity",
            0.00 AS "greeningRate",
            0.00 AS "constructionPlotRatio",
            0.00 AS "constructionBuildDensity",
            0.00 AS "constructionGreeningRate",
            0.00 as "groundSaleCarport"---地上可售车位数
            from (
                SELECT sa.*
                ,top.id as product_Top_ID
                ,top.PRODUCT_TYPE_NAME as product_top_name
                from (
                        select pe.* FROM SYS_PROJECT sp INNER JOIN periodPt pe on sp.id=pe.parent_ID where (projCooperate='所有' or projCooperate=sp.PROJ_COOPERATE)
                        union select pt.* from SYS_PROJECT sp1 INNER JOIN projPt pt on sp1.id=pt.org_id where (projCooperate='所有' or projCooperate=sp1.PROJ_COOPERATE)
                )sa
                    LEFT JOIN top on top.TOPID=sa.PRODUCT_TYPE_ID where top.PRODUCT_TYPE_LEVEL=1
            )sa2
        )x
),
projTotal as(
    SELECT sx.*,
    pi2."totalSiteArea",  --总用地面积
    pi2."constructionLandArea", --建设用地面积
    pi2."confiscatedArea",--代征用地面积
    pi2."overallFloorageArea",--总建筑面积
    pi2."totalCapacityArea",--总计容面积 TOTAL_CAPACITY_AREA
    pi2."groundEngineCarport", --GROUND_ENGINE_CARPORT 地下机动车位数
    --附加指标
    pi2."saleRatio",--可售比(总可售面积/总建筑面积)
    pi2."carportRatio",--车位配比(总车位数/总户数)
    pi2."totalHouseholds", --总户数(住宅+商铺)
    --规划指标
    pi2."plotRatio",--容积率<br/>(土地出让)
    pi2."buildDensity",--建筑密度<br/>(土地出让)
    pi2."greeningRate",--绿地率<br/>(土地出让)
    pi2."constructionPlotRatio",--实际容积率<br/>(按建设用地面积)
    pi2."constructionBuildDensity",--实际建筑密度<br/>(按建设用地面积)
    pi2."constructionGreeningRate",--实际绿地率<br/>(按建设用地面积)
    pi2."groundSaleCarport"--地上可售车位数
    from (
         SELECT
            DISTINCT
            '' as "orderHierarchyCode",
            10 as "objType",
            case spt.PROJ_COOPERATE
            when '操盘' then '操盘'
            when '不操盘' then '非操盘'
            ELSE spt.PROJ_COOPERATE END
            as "operateAttribute",--操盘属性
            spt.id as "orgId" ,
            spt.unit_ID AS "ptId",
            '<a href='||domain_mdm||'/mdm/query-master-detail/detail?componentId=ad0a91ca-1123-3bb0-e053-0100007fcbb9&projectIds='||spt.id ||'>'||spt.project_name||'</a>' as "orgName",
            --spt.project_name "orgName",
            SUM(pd."buildArea")over(PARTITION by pd."ptId") AS "buildArea",--建筑占地面积
            --面积指标
            SUM(pd."groundTotalBuildArea")over(PARTITION by pd."ptId") AS "groundTotalBuildArea",--地上总建筑面积
            SUM(pd."undergroundTotalBuildArea")over(PARTITION by pd."ptId") AS "undergroundTotalBuildArea",--地下总建筑面积
            SUM(pd."groundCapacityArea")over(PARTITION by pd."ptId") AS "groundCapacityArea",--地上计容面积
            SUM(pd."undergroundCapacityArea")over(PARTITION by pd."ptId") AS "undergroundCapacityArea",--地上计容面积
            SUM(pd."groundUncapacityArea")over(PARTITION by pd."ptId") AS "groundUncapacityArea",--地上非计容面积
            SUM(pd."undergroundUncapacityArea")over(PARTITION by pd."ptId") AS "undergroundUncapacityArea",--地下非计容面积
            SUM(pd."undergroundGarageArea")over(PARTITION by pd."ptId") AS "undergroundGarageArea",--地下车库面积
            --销售面积指标
            SUM(pd."totalSaleArea")over(PARTITION by pd."ptId") AS "totalSaleArea",--总可售面积
            SUM(pd."groundSaleArea")over(PARTITION by pd."ptId") AS "groundSaleArea",--地上可售面积
            SUM(pd."undergroundSaleArea")over(PARTITION by pd."ptId") AS "undergroundSaleArea",--地下可售面积
            SUM(pd."totalGiveArea")over(PARTITION by pd."ptId") AS "totalGiveArea",--总赠送面积
            SUM(pd."groundGiveArea")over(PARTITION by pd."ptId") AS "groundGiveArea",--地上总赠送面积
            SUM(pd."undergroundGiveArea")over(PARTITION by pd."ptId") AS "undergroundGiveArea",--地上总赠送面积
            --车位指标
            SUM(pd."carportTotal")over(PARTITION by pd."ptId")AS "carportTotal" ,--总车位数
            SUM(pd."groundTotalCarport")over(PARTITION by pd."ptId")AS "groundTotalCarport" ,--地上车位数
            SUM(pd."groundCarport")over(PARTITION by pd."ptId") AS "groundCarport",--地面车位数
            SUM(pd."residenceBottomCarport")over(PARTITION by pd."ptId") AS "residenceBottomCarport",--住宅底层车位数
            SUM(pd."parkingGarageCarport")over(PARTITION by pd."ptId") AS "parkingGarageCarport",--停车楼车位数
            SUM(pd."undergroundTotalRjCarport")over(PARTITION by pd."ptId") AS "undergroundTotalRjCarport",--地下总人防车位数（计算=UNDERGROUND_RFJ_CARPORT+UNDERGROUND_RJ_CARPORT―)
            SUM(pd."undergroundRfjCarport")over(PARTITION by pd."ptId") AS "undergroundRfjCarport",--地下人防非机械车位数
            SUM(pd."undergroundRjCarport")over(PARTITION by pd."ptId") AS "undergroundRjCarport",--地下人防机械车位数
            SUM(pd."undergroundTotalFrjCarport")over(PARTITION by pd."ptId") AS "undergroundTotalFrjCarport",--地下非人防车位数
            SUM(pd."undergroundFrfjCarport")over(PARTITION by pd."ptId") AS "undergroundFrfjCarport",--地下非人防非机械车位数
            SUM(pd."undergroundFrjCarport")over(PARTITION by pd."ptId") AS "undergroundFrjCarport",--地下非人防机械车位数
            SUM(pd."undergroundTotalSaleCarport")over(PARTITION by pd."ptId") AS "undergroundTotalSaleCarport",--总可售车位数
            SUM(pd."undergroundRSaleCarport")over(PARTITION by pd."ptId") AS "undergroundRSaleCarport",--地下人防可售车位数
            SUM(pd."undergroundFrfjSaleCarport")over(PARTITION by pd."ptId") AS "undergroundFrfjSaleCarport",--地下非人防非机械可售车位数
            SUM(pd."undergroundFrjSaleCarport")over(PARTITION by pd."ptId") AS "undergroundFrjSaleCarport"--地下非人防机械可售车位数
        from  SYS_PROJECT spt INNER JOIN prodcut pd on spt.id=pd."ptId"  where (projCooperate='所有' or projCooperate=spt.PROJ_COOPERATE)
    )sx INNER JOIN (
    SELECT
        distinct
        SUM(pi.TOTAL_SITE_AREA)over(PARTITION by PARENT_ID) as "totalSiteArea",
        SUM(pi.CONSTRUCTION_LAND_AREA)over(PARTITION BY PARENT_ID) AS "constructionLandArea",
        SUM(pi.CONFISCATED_AREA)over(PARTITION BY PARENT_ID) AS "confiscatedArea",
        SUM(pi.OVERALL_FLOORAGE_AREA)over(PARTITION BY PARENT_ID) AS "overallFloorageArea",
        SUM(pi.TOTAL_CAPACITY_AREA)over(PARTITION BY PARENT_ID) AS "totalCapacityArea",
        SUM(pi.GROUND_ENGINE_CARPORT)over(PARTITION BY PARENT_ID) AS "groundEngineCarport",
        SUM(pi.SALE_RATIO)over(PARTITION BY PARENT_ID) AS "saleRatio",
        SUM(pi.CARPORT_RATIO)over(PARTITION BY PARENT_ID) AS "carportRatio",
        SUM(pi.TOTAL_HOUSEHOLDS)over(PARTITION BY PARENT_ID) AS "totalHouseholds",
        SUM(pi.PLOT_RATIO)over(PARTITION BY PARENT_ID) AS "plotRatio",
        SUM(pi.BUILD_DENSITY)over(PARTITION BY PARENT_ID) AS "buildDensity",
        SUM(pi.GREENING_RATE)over(PARTITION BY PARENT_ID) AS "greeningRate",
        SUM(pi.CONSTRUCTION_PLOT_RATIO)over(PARTITION BY PARENT_ID) AS "constructionPlotRatio",
        SUM(pi.CONSTRUCTION_BUILD_DENSITY)over(PARTITION BY PARENT_ID) AS "constructionBuildDensity",
        SUM(pi.CONSTRUCTION_GREENING_RATE)over(PARTITION BY PARENT_ID) AS "constructionGreeningRate",
        0 as "groundSaleCarport",---地上可售车位数
        pi.PARENT_ID as "ptId"
    FROM periodPi pi
    )pi2 on pi2."ptId"=sx."orgId"
),
 unit as(
    SELECT ut4.* from (
        select ut2.*,SYS_CONNECT_BY_PATH(ut2."orgId",'/')||'/' path from (
            SELECT distinct ut1.* from (
                SELECT
                    order_hierarchy_code as "orderHierarchyCode",
                    0 as "objType",
                    '' as "operateAttribute",
                    id as "orgId",
                    parent_id as "ptId",
                    org_name as "orgName",
                    0.00 AS "buildArea",--建筑占地面积
                    --面积指标
                    0.00 AS "groundTotalBuildArea",--地上总建筑面积
                    0.00 AS "undergroundTotalBuildArea",--地下总建筑面积
                    0.00 AS "groundCapacityArea",--地上计容面积
                    0.00 AS "undergroundCapacityArea",--地上计容面积
                    0.00 AS "groundUncapacityArea",--地上非计容面积
                    0.00 AS "undergroundUncapacityArea",--地下非计容面积
                    0.00 AS "undergroundGarageArea",--地下车库面积
                    --销售面积指标
                    0.00 AS "totalSaleArea",--总可售面积
                    0.00 AS "groundSaleArea",--地上可售面积
                    0.00 AS "undergroundSaleArea",--地下可售面积
                    0.00 AS "totalGiveArea",--总赠送面积
                    0.00 AS "groundGiveArea",--地上总赠送面积
                    0.00 AS "undergroundGiveArea",--地上总赠送面积
                    --车位指标
                    0.00 AS "carportTotal" ,--总车位数
                    0.00 AS "groundTotalCarport" ,--地上车位数
                    0.00 AS "groundCarport",--地面车位数
                    0.00 AS "residenceBottomCarport",--住宅底层车位数
                    0.00 AS "parkingGarageCarport",--停车楼车位数
                    0.00 AS "undergroundTotalRjCarport",--地下总人防车位数（计算=UNDERGROUND_RFJ_CARPORT+UNDERGROUND_RJ_CARPORT―)
                    0.00 AS "undergroundRfjCarport",--地下人防非机械车位数
                    0.00 AS "undergroundRjCarport",--地下人防机械车位数
                    0.00 AS "undergroundTotalFrjCarport",--地下非人防车位数
                    0.00 AS "undergroundFrfjCarport",--地下非人防非机械车位数
                    0.00 AS "undergroundFrjCarport",--地下非人防机械车位数
                    0.00 AS "undergroundTotalSaleCarport",--总可售车位数
                    0.00 AS "undergroundRSaleCarport",--地下人防可售车位数
                    0.00 AS "undergroundFrfjSaleCarport",--地下非人防非机械可售车位数
                    0.00 AS "undergroundFrjSaleCarport",--地下非人防机械可售车位数
                    0.00 as "totalSiteArea",
                    0.00 AS "constructionLandArea",
                    0.00 AS "confiscatedArea",
                    0.00 AS "overallFloorageArea",
                    0.00 AS "totalCapacityArea",
                    0.00 AS "groundEngineCarport",
                    0.00 AS "saleRatio",
                    0.00 AS "carportRatio",
                    0.00 AS "totalHouseholds",
                    0.00 AS "plotRatio",
                    0.00 AS "buildDensity",
                    0.00 AS "greeningRate",
                    0.00 AS "constructionPlotRatio",
                    0.00 AS "constructionBuildDensity",
                    0.00 AS "constructionGreeningRate",
                    0.00 as "groundSaleCarport"---地上可售车位数
                from SYS_BUSINESS_UNIT start with ID IN (
                    SELECT bu.id FROM SYS_BUSINESS_UNIT bu LEFT JOIN SYS_PROJECT sp on bu.id=sp.unit_id
                            where (
                                   (startWorks='所有' and (instr(projectIds, sp.id)>0))
                                or (startWorks = '开工' and sp.id in (select PROJECT_ID from startWrok WHERE cnt>0))
                                or (startWorks='未开工' and sp.id in (select PROJECT_ID from startWrok WHERE cnt<1))
                            )
                            and (projCooperate='所有' or projCooperate=sp.PROJ_COOPERATE)
                            and sp.id is not null
                            and bu.is_Company=1
                ) connect by nocycle prior PARENT_ID = ID   ORDER BY ORDER_HIERARCHY_CODE
            )ut1
            --where ut1."orgId"!='26f9c063-1193-47ea-9c0c-2fd4ae9c0a0a'
            UNION ALL
            SELECT * FROM projTotal
        )ut2
        start with ut2."orgId"=(SELECT ID from SYS_BUSINESS_UNIT where level_rank=1) connect by prior ut2."orgId"=ut2."ptId"
    )ut4
),
unitPt as (
    SELECT
           t1."orderHierarchyCode",
           t1."objType",
           t1."operateAttribute",
           t1."orgId",
           t1."ptId",
           t1."orgName",
          (SELECT SUM(t2."buildArea") FROM unit t2 WHERE t2.path like t1.path || '%') as "buildArea",
          (SELECT SUM(t2."groundTotalBuildArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "groundTotalBuildArea",
          (SELECT SUM(t2."undergroundTotalBuildArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundTotalBuildArea",
          (SELECT SUM(t2."groundCapacityArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "groundCapacityArea",
          (SELECT SUM(t2."undergroundCapacityArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundCapacityArea",
          (SELECT SUM(t2."groundUncapacityArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "groundUncapacityArea",
          (SELECT SUM(t2."undergroundUncapacityArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundUncapacityArea",
          (SELECT SUM(t2."undergroundGarageArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundGarageArea",
          (SELECT SUM(t2."totalSaleArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "totalSaleArea",
          (SELECT SUM(t2."groundSaleArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "groundSaleArea",
          (SELECT SUM(t2."undergroundSaleArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundSaleArea",
          (SELECT SUM(t2."totalGiveArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "totalGiveArea",
          (SELECT SUM(t2."groundGiveArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "groundGiveArea",
          (SELECT SUM(t2."undergroundGiveArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundGiveArea",
          (SELECT SUM(t2."carportTotal" ) FROM unit t2 WHERE t2.path like t1.path || '%')as "carportTotal" ,
          (SELECT SUM(t2."groundTotalCarport" ) FROM unit t2 WHERE t2.path like t1.path || '%')as "groundTotalCarport" ,
          (SELECT SUM(t2."groundCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "groundCarport",
          (SELECT SUM(t2."residenceBottomCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "residenceBottomCarport",
          (SELECT SUM(t2."parkingGarageCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "parkingGarageCarport",
          (SELECT SUM(t2."undergroundTotalRjCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundTotalRjCarport",
          (SELECT SUM(t2."undergroundRfjCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundRfjCarport",
          (SELECT SUM(t2."undergroundRjCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundRjCarport",
          (SELECT SUM(t2."undergroundTotalFrjCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundTotalFrjCarport",
          (SELECT SUM(t2."undergroundFrfjCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundFrfjCarport",
          (SELECT SUM(t2."undergroundFrjCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundFrjCarport",
          (SELECT SUM(t2."undergroundTotalSaleCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundTotalSaleCarport",
          (SELECT SUM(t2."undergroundRSaleCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundRSaleCarport",
          (SELECT SUM(t2."undergroundFrfjSaleCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundFrfjSaleCarport",
		  (SELECT SUM(t2."undergroundFrjSaleCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundFrjSaleCarport",
          (SELECT SUM(t2."totalSiteArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "totalSiteArea",
          (SELECT SUM(t2."constructionLandArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "constructionLandArea",
          (SELECT SUM(t2."confiscatedArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "confiscatedArea",
          (SELECT SUM(t2."overallFloorageArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "overallFloorageArea",
          (SELECT SUM(t2."totalCapacityArea") FROM unit  t2 WHERE t2.path like t1.path || '%')as "totalCapacityArea",
          (SELECT SUM(t2."groundEngineCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "groundEngineCarport",
          (SELECT SUM(t2."saleRatio") FROM unit t2 WHERE t2.path like t1.path || '%')as "saleRatio",
          (SELECT SUM(t2."carportRatio") FROM unit t2 WHERE t2.path like t1.path || '%')as "carportRatio",
          (SELECT SUM(t2."totalHouseholds") FROM unit t2 WHERE t2.path like t1.path || '%')as "totalHouseholds",
          (SELECT SUM(t2."plotRatio") FROM unit t2 WHERE t2.path like t1.path || '%')as "plotRatio",
          (SELECT SUM(t2."buildDensity") FROM unit t2 WHERE t2.path like t1.path || '%')as "buildDensity",
          (SELECT SUM(t2."greeningRate") FROM unit t2 WHERE t2.path like t1.path || '%')as "greeningRate",
		  (SELECT SUM(t2."constructionPlotRatio") FROM unit t2 WHERE t2.path like t1.path || '%')as "constructionPlotRatio",
          (SELECT SUM(t2."constructionBuildDensity") FROM unit t2 WHERE t2.path like t1.path || '%')as "constructionBuildDensity",
          (SELECT SUM(t2."constructionGreeningRate") FROM unit t2 WHERE t2.path like t1.path || '%')as "constructionGreeningRate",
          (SELECT SUM(t2."groundSaleCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "groundSaleCarport"
      FROM unit t1
)
select
        g."operateAttribute",
        g."orgId",
        g."ptId",
        g."orgName",
        trim(to_char(g."buildArea", '9999999990.00'))as "buildArea" ,--建筑占地面积
        ----面积指标
        trim(to_char(g."groundTotalBuildArea", '9999999990.00')) as "groundTotalBuildArea",--地上总建筑面积
        trim(to_char(g."undergroundTotalBuildArea", '9999999990.00')) as "undergroundTotalBuildArea",--地下总建筑面积
        trim(to_char(g."groundCapacityArea", '9999999990.00')) as "groundCapacityArea",--地上计容面积
        trim(to_char(g."undergroundCapacityArea", '9999999990.00')) as "undergroundCapacityArea",--地下计容面积
        trim(to_char(g."groundUncapacityArea", '9999999990.00')) as "groundUncapacityArea",--地上非计容面积
        trim(to_char(g."undergroundUncapacityArea", '9999999990.00')) as "undergroundUncapacityArea",--地下非计容面积
        trim(to_char(g."undergroundGarageArea", '9999999990.00')) as "undergroundGarageArea",--地下车库面积
        --销售面积指标
        trim(to_char(g."totalSaleArea", '9999999990.00')) as "totalSaleArea",--总可售面积
        trim(to_char(g."groundSaleArea", '9999999990.00')) as "groundSaleArea",--地上可售面积
        trim(to_char(g."undergroundSaleArea", '9999999990.00')) as "undergroundSaleArea",--地下可售面积
        trim(to_char(g."totalGiveArea", '9999999990.00')) as "totalGiveArea",--总赠送面积
        trim(to_char(g."groundGiveArea", '9999999990.00')) as "groundGiveArea",--地上总赠送面积
        trim(to_char(g."undergroundGiveArea", '9999999990.00')) as "undergroundGiveArea",--地上总赠送面积
        --车位指标
        trim(to_char(g."carportTotal", '9999999990')) as "carportTotal",--总车位数
        trim(to_char(g."groundTotalCarport", '9999999990')) as "groundTotalCarport",--地上车位数
        trim(to_char(g."groundCarport", '9999999990')) as "groundCarport",--地面车位数
        trim(to_char(g."residenceBottomCarport", '9999999990')) as "residenceBottomCarport",--住宅底层车位数
        trim(to_char(g."parkingGarageCarport", '9999999990')) as "parkingGarageCarport",--停车楼车位数
        trim(to_char(g."undergroundTotalRjCarport", '9999999990')) as "undergroundTotalRjCarport",--地下总人防车位数（计算=UNDERGROUND_RFJ_CARPORT+UNDERGROUND_RJ_CARPORT―)
        trim(to_char(g."undergroundRfjCarport", '9999999990')) as "undergroundRfjCarport",--地下人防非机械车位数
        trim(to_char(g."undergroundRjCarport", '9999999990')) as "undergroundRjCarport",--地下人防机械车位数
        trim(to_char(g."undergroundTotalFrjCarport", '9999999990')) as "undergroundTotalFrjCarport",--地下非人防车位数
        trim(to_char(g."undergroundFrfjCarport", '9999999990')) as "undergroundFrfjCarport",--地下非人防非机械车位数
        trim(to_char(g."undergroundFrjCarport", '9999999990')) as "undergroundFrjCarport",--地下非人防机械车位数
        trim(to_char(g."undergroundTotalSaleCarport", '9999999990')) as "undergroundTotalSaleCarport",--总可售车位数
        trim(to_char(g."undergroundRSaleCarport", '9999999990')) as "undergroundRSaleCarport",--地下人防可售车位数
        trim(to_char(g."undergroundFrfjSaleCarport", '9999999990')) as "undergroundFrfjSaleCarport",--地下非人防非机械可售车位数
        trim(to_char(g."undergroundFrjSaleCarport", '9999999990')) as "undergroundFrjSaleCarport",--地下非人防机械可售车位

        CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."totalSiteArea", '9999999990.00')))  end as "totalSiteArea",
        CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."constructionLandArea", '9999999990.00'))) end as "constructionLandArea",
        CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."confiscatedArea", '9999999990.00'))) end as "confiscatedArea",
        CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."overallFloorageArea", '9999999990.00'))) end as "overallFloorageArea",
        CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."totalCapacityArea", '9999999990.00'))) end as "totalCapacityArea",
        CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."groundEngineCarport", '9999999990.00'))) end as "groundEngineCarport",
        CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."carportRatio", '9999999990.00'))) end as "carportRatio",
        CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."totalHouseholds", '9999999990'))) end as "totalHouseholds",
        CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."plotRatio", '9999999990.00'))) end as "plotRatio",
        CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."buildDensity", '9999999990.00'))) end as "buildDensity",
        CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."greeningRate", '9999999990.00'))) end as "greeningRate",
        CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."constructionPlotRatio", '9999999990.00'))) end as "constructionPlotRatio",
        CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."constructionBuildDensity", '9999999990.00'))) end as "constructionBuildDensity",
        CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."constructionGreeningRate", '9999999990.00'))) end as "constructionGreeningRate",
        CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."groundSaleCarport", '9999999990.00'))) end as "groundSaleCarport"
from (
        select distinct dt.*,level as "level", sys_connect_by_path (dt."orgName", '-->') as tree  from (
        select * from unitPt
            union all
        select * from projTotal
            union all
        select * from prodcut
    ) dt start with dt."orgId" = '003200000000000000000000000000' connect by prior dt."orgId" = dt."ptId"  order  by tree
)g order by g."orderHierarchyCode";
end;



/
--------------------------------------------------------
--  DDL for Procedure P_MDM_DATA_INFO_BY_EXCEL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_DATA_INFO_BY_EXCEL" (
    startWorks in   VARCHAR2,--开工
    productTypes in  CLOB,
    projectIds in  CLOB,
    projCooperate in  VARCHAR2,
    info out sys_refcursor
)
    is
begin
    open info for
        with
            startWrok as (
                SELECT s.id as PROJECT_ID,nvl(s1.cnt,0)as cnt
                from(
                      SELECT * FROM SYS_PROJECT
                      where instr(projectIds, id)>0
                )s LEFT JOIN (
                    SELECT c.*
                    from  (
                              SELECT sps.PROJECT_ID, count(*) cnt
                              FROM (
                                       SELECT pp.*,ppn.id as node_id
                                       FROM POM_PROJ_PLAN pp
                                                LEFT JOIN POM_PROJ_PLAN_NODE ppn on pp.id=ppn.proj_plan_id
                                       where pp.APPROVAL_STATUS='已审核' and pp.plan_type='关键节点计划'
                                         and ppn.IS_CONTAINS_PERMIT=1 AND ppn.PERMIT_TYPE='施工许可证'
                                   )a LEFT JOIN POM_NODE_FEEDBACK nf on a.node_id=nf.FEEDBACK_NODE_ID
                                      LEFT JOIN SYS_PROJECT_STAGE sps on sps.ID=a.proj_id
                              WHERE nf.APPROVAL_STATUS='已审核' and nf.FEEDBACK_TYPE='CARRY_OUT'
                              GROUP BY sps.PROJECT_ID
                          )c where  instr(projectIds, c.project_id)>0
                )s1 on s.id=s1.PROJECT_ID
            ),
            projPi as (
                SELECT b.id as org_id,b.project_name as org_name,b.id as parent_id,b.example_id,mi.*
                from (
                         SELECT sp.*,ph.phase_order,ph.id as example_Id
                         FROM SYS_PROJECT sp
                                  INNER JOIN (
                             select mpp1.*
                             from MDM_PROJECT_PHASE mpp1
                                      inner join (
                                 select PROJ_ID, max(PHASE_ORDER)as PHASE_ORDER
                                 from MDM_PROJECT_PHASE
                                 where PHASE_STATE =19 or PHASE_STATE=20
                                 group by PROJ_ID
                             ) mpp2 on mpp1.PROJ_ID = mpp2.PROJ_ID
                                 and mpp1.PHASE_ORDER = mpp2.PHASE_ORDER
                         )ph on sp.id=ph.proj_id
                                  inner join startWrok on sp.id = startWrok.PROJECT_ID
                         where 
--                         ph.phase_order=1 and
                         (
                                     startWorks='所有'
                                 or (startWorks='开工' and startWrok.cnt > 0)
                                 or (startWorks='未开工' and startWrok.cnt > 0)
                             ) AND (projCooperate='所有' or projCooperate=sp.PROJ_COOPERATE)
                     )b LEFT JOIN MDM_OBJ_PHASE_INDEX mi on b.example_Id=mi.OBJ_PHASE_ID
            ),
            projPt as (
                SELECT pi2.org_id as org_id,pi2.org_name as org_name,pi2.parent_id as parent_id,mpi.*
                from projPi pi2 LEFT JOIN MDM_OBJ_PHASE_PT_INDEX mpi on mpi.OBJ_PHASE_ID=pi2.example_id
                where (instr(productTypes,mpi.PRODUCT_TYPE_ID)>0)
            ),
            periodPi as (
                SELECT a.id as org_id,a.stage_name as org_Name,a.project_id as parent_id,a.example_Id,mi.*
                from (
                         SELECT sps.*,ph.phase_order,ph.id as example_Id
                         FROM SYS_PROJECT sp
                                  LEFT JOIN SYS_PROJECT_STAGE sps on sp.id=sps.project_id
                                  INNER JOIN (
                             select mpp1.ID, mpp1.PERIOD_ID, mpp2.PHASE_ORDER
                             from MDM_PERIOD_PHASE mpp1
                                      inner join (
                                 select PERIOD_ID, max(PHASE_ORDER)as PHASE_ORDER
                                 from MDM_PERIOD_PHASE
                                 where PHASE_STATE =19 or PHASE_STATE=20
                                 group by PERIOD_ID
                             ) mpp2 on mpp1.PERIOD_ID = mpp2.PERIOD_ID and mpp1.PHASE_ORDER = mpp2.PHASE_ORDER
--                                  -- 为第一阶段创建临时数据
--                             union all
--                             select null ID, isps.ID period_id, 1
--                             from startWrok
--                             left join SYS_PROJECT_STAGE isps on isps.PROJECT_ID = startWrok.PROJECT_ID
                         )ph on sps.id=ph.period_id
                                  inner join startWrok on sp.id = startWrok.PROJECT_ID
                         where ( startWorks='所有'
                             or (startWorks='开工' and startWrok.cnt > 0)
                             or (startWorks='未开工' and startWrok.cnt > 0)
                             ) AND (projCooperate='所有' or projCooperate=sp.PROJ_COOPERATE)
                     )a LEFT JOIN MDM_OBJ_PHASE_INDEX mi on a.example_Id=mi.OBJ_PHASE_ID
            ),
            periodPt as(
                SELECT pi.id as org_id,pi.org_Name as org_Name,pi.parent_id as parent_id,mpi.*
                FROM periodPi pi LEFT JOIN MDM_OBJ_PHASE_PT_INDEX mpi on mpi.OBJ_PHASE_ID=pi.example_id
                where (instr(productTypes,mpi.PRODUCT_TYPE_ID)>0)
            ),
            top as (
                select ID, PRODUCT_TYPE_NAME, PRODUCT_TYPE_LEVEL, connect_BY_ROOT(ID) as topId,
                       connect_BY_ROOT(PRODUCT_TYPE_NAME) as topName
                from MDM_BUILD_PRODUCT_TYPE mbpt
                start with mbpt.ID in (
                    select PRODUCT_TYPE_ID from periodPt
                    UNION ALL select PRODUCT_TYPE_ID from projPt
                ) CONNECT BY PRIOR mbpt.PARENT_CODE = mbpt.PRODUCT_TYPE_CODE
            ),
            prodcut as (
                SELECT
                    '' as "orderHierarchyCode",
                    40 as "objType",
                    '' as "operateAttribute",--操盘属性
                    get_uuid() as "orgId",x.*
                from (
                         SELECT
                             distinct
                             sa2.parent_id as "ptId",
                             sa2.product_top_name as "orgName",
                             SUM(nvl(sa2.BUILD_AREA, 0))over(PARTITION by sa2.parent_id, sa2.PRODUCT_TOP_ID) AS "buildArea",--建筑占地面积
                             --        --面积指标
                             SUM(nvl(sa2.GROUND_TOTAL_BUILD_AREA, 0))over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "groundTotalBuildArea",--地上总建筑面积
                             SUM(nvl(sa2.UNDERGROUND_TOTAL_BUILD_AREA, 0))over(PARTITION by sa2.parent_id, sa2.PRODUCT_TOP_ID) AS "undergroundTotalBuildArea",--地下总建筑面积
                             SUM(nvl(sa2.GROUND_CAPACITY_AREA, 0))over(PARTITION by  sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "groundCapacityArea",--地上计容面积
                             SUM(nvl(sa2.UNDERGROUND_CAPACITY_AREA, 0))over(PARTITION by sa2.parent_id, sa2.PRODUCT_TOP_ID) AS "undergroundCapacityArea",--地下计容面积
                             SUM(nvl(sa2.GROUND_UNCAPACITY_AREA, 0))over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "groundUncapacityArea",--地上非计容面积
                             SUM(nvl(sa2.UNDERGROUND_UNCAPACITY_AREA, 0))over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundUncapacityArea",--地下非计容面积
                             SUM(nvl(sa2.UNDERGROUND_GARAGE_AREA, 0))over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundGarageArea",--地下车库面积
                             --销售面积指标
                             SUM(nvl(sa2.TOTAL_SALE_AREA, 0))over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "totalSaleArea",--总可售面积
                             SUM(nvl(sa2.GROUND_SALE_AREA, 0))over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "groundSaleArea",--地上可售面积
                             SUM(nvl(sa2.UNDERGROUND_SALE_AREA, 0))over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundSaleArea",--地下可售面积
                             SUM(nvl(sa2.TOTAL_GIVE_AREA, 0))over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "totalGiveArea",--总赠送面积
                             SUM(nvl(sa2.GROUND_GIVE_AREA, 0))over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "groundGiveArea",--地上总赠送面积
                             SUM(nvl(sa2.UNDERGROUND_GIVE_AREA, 0))over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundGiveArea",--地上总赠送面积
                             --车位指标
                             SUM(nvl(sa2.CARPORT_TOTAL, 0))over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "carportTotal",--总车位数
                             SUM(nvl(sa2.GROUND_TOTAL_CARPORT, 0))over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "groundTotalCarport",--地上车位数
                             SUM(nvl(sa2.GROUND_CARPORT, 0))over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "groundCarport",--地面车位数
                             SUM(nvl(sa2.RESIDENCE_BOTTOM_CARPORT, 0))over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "residenceBottomCarport",--住宅底层车位数
                             SUM(nvl(sa2.PARKING_GARAGE_CARPORT, 0))over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "parkingGarageCarport",--停车楼车位数
                             SUM(nvl(sa2.UNDERGROUND_TOTAL_RJ_CARPORT, 0))over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundTotalRjCarport",--地下总人防车位数（计算=UNDERGROUND_RFJ_CARPORT+UNDERGROUND_RJ_CARPORT―)
                             SUM(nvl(sa2.UNDERGROUND_RFJ_CARPORT, 0))over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundRfjCarport",--地下人防非机械车位数
                             SUM(nvl(sa2.UNDERGROUND_RJ_CARPORT, 0))over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundRjCarport",--地下人防机械车位数
                             SUM(nvl(sa2.UNDERGROUND_TOTAL_FRJ_CARPORT, 0))over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundTotalFrjCarport",--地下非人防车位数
                             SUM(nvl(sa2.UNDERGROUND_FRFJ_CARPORT, 0))over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundFrfjCarport",--地下非人防非机械车位数
                             SUM(nvl(sa2.UNDERGROUND_FRJ_CARPORT, 0))over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundFrjCarport",--地下非人防机械车位数
                             SUM(nvl(sa2.UNDERGROUND_TOTAL_SALE_CARPORT, 0))over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundTotalSaleCarport",--总可售车位数
                             SUM(nvl(sa2.UNDERGROUND_R_SALE_CARPORT, 0))over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundRSaleCarport",--地下人防可售车位数
                             SUM(nvl(sa2.UNDERGROUND_FRFJ_SALE_CARPORT, 0))over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundFrfjSaleCarport",--地下非人防非机械可售车位数
                             SUM(nvl(sa2.UNDERGROUND_FRJ_SALE_CARPORT, 0))over(PARTITION by sa2.parent_id,sa2.PRODUCT_TOP_ID) AS "undergroundFrjSaleCarport",--地下非人防机械可售车位数
                             0.00 as "totalSiteArea",
                             0.00 AS "constructionLandArea",
                             0.00 AS "confiscatedArea",
                             0.00 AS "overallFloorageArea",
                             0.00 AS "totalCapacityArea",
                             0.00 AS "groundEngineCarport",
                             0.00 AS "saleRatio",
                             0.00 AS "carportRatio",
                             0.00 AS "totalHouseholds",
                             0.00 AS "plotRatio",
                             0.00 AS "buildDensity",
                             0.00 AS "greeningRate",
                             0.00 AS "constructionPlotRatio",
                             0.00 AS "constructionBuildDensity",
                             0.00 AS "constructionGreeningRate",
                             0.00 as "groundSaleCarport"---地上可售车位数
                         from (
                                  SELECT sa.*
                                       ,top.id as product_Top_ID
                                       ,top.PRODUCT_TYPE_NAME as product_top_name
                                  from (
                                           select pe.*
                                           FROM SYS_PROJECT sp
                                                    INNER JOIN periodPt pe on sp.id=pe.parent_ID
                                           where (projCooperate='所有' or projCooperate=sp.PROJ_COOPERATE)
                                           union select pt.*
                                           from SYS_PROJECT sp1
                                                    INNER JOIN projPt pt on sp1.id=pt.org_id
                                           where (projCooperate='所有' or projCooperate=sp1.PROJ_COOPERATE)
                                       )sa LEFT JOIN top on top.TOPID=sa.PRODUCT_TYPE_ID where top.PRODUCT_TYPE_LEVEL=1
                              )sa2
                     )x
            ),
            projTotal as(
                SELECT sx.*,
                       pi2."totalSiteArea",  --总用地面积
                       pi2."constructionLandArea", --建设用地面积
                       pi2."confiscatedArea",--代征用地面积
                       pi2."overallFloorageArea",--总建筑面积
                       pi2."totalCapacityArea",--总计容面积 TOTAL_CAPACITY_AREA
                       pi2."groundEngineCarport", --GROUND_ENGINE_CARPORT 地下机动车位数
                       --附加指标
                       pi2."saleRatio",--可售比(总可售面积/总建筑面积)
                       pi2."carportRatio",--车位配比(总车位数/总户数)
                       pi2."totalHouseholds", --总户数(住宅+商铺)
                       --规划指标
                       pi2."plotRatio",--容积率<br/>(土地出让)
                       pi2."buildDensity",--建筑密度<br/>(土地出让)
                       pi2."greeningRate",--绿地率<br/>(土地出让)
                       pi2."constructionPlotRatio",--实际容积率<br/>(按建设用地面积)
                       pi2."constructionBuildDensity",--实际建筑密度<br/>(按建设用地面积)
                       pi2."constructionGreeningRate",--实际绿地率<br/>(按建设用地面积)
                       pi2."groundSaleCarport"--地上可售车位数
                from (
                         SELECT
                             DISTINCT
                             spt.ORDER_HIERARCHY_CODE as "orderHierarchyCode",
                             10 as "objType",
                             case spt.PROJ_COOPERATE
                                 when '操盘' then '操盘'
                                 when '不操盘' then '非操盘'
                                 ELSE spt.PROJ_COOPERATE END as "operateAttribute",--操盘属性
                             spt.id as "orgId" ,
                             spt.unit_ID AS "ptId",
                             spt.project_name "orgName",
                             SUM(pd."buildArea")over(PARTITION by pd."ptId") AS "buildArea",--建筑占地面积
                             --面积指标
                             SUM(pd."groundTotalBuildArea")over(PARTITION by pd."ptId") AS "groundTotalBuildArea",--地上总建筑面积
                             SUM(pd."undergroundTotalBuildArea")over(PARTITION by pd."ptId") AS "undergroundTotalBuildArea",--地下总建筑面积
                             SUM(pd."groundCapacityArea")over(PARTITION by pd."ptId") AS "groundCapacityArea",--地上计容面积
                             SUM(pd."undergroundCapacityArea")over(PARTITION by pd."ptId") AS "undergroundCapacityArea",--地上计容面积
                             SUM(pd."groundUncapacityArea")over(PARTITION by pd."ptId") AS "groundUncapacityArea",--地上非计容面积
                             SUM(pd."undergroundUncapacityArea")over(PARTITION by pd."ptId") AS "undergroundUncapacityArea",--地下非计容面积
                             SUM(pd."undergroundGarageArea")over(PARTITION by pd."ptId") AS "undergroundGarageArea",--地下车库面积
                             --销售面积指标
                             SUM(pd."totalSaleArea")over(PARTITION by pd."ptId") AS "totalSaleArea",--总可售面积
                             SUM(pd."groundSaleArea")over(PARTITION by pd."ptId") AS "groundSaleArea",--地上可售面积
                             SUM(pd."undergroundSaleArea")over(PARTITION by pd."ptId") AS "undergroundSaleArea",--地下可售面积
                             SUM(pd."totalGiveArea")over(PARTITION by pd."ptId") AS "totalGiveArea",--总赠送面积
                             SUM(pd."groundGiveArea")over(PARTITION by pd."ptId") AS "groundGiveArea",--地上总赠送面积
                             SUM(pd."undergroundGiveArea")over(PARTITION by pd."ptId") AS "undergroundGiveArea",--地上总赠送面积
                             --车位指标
                             SUM(pd."carportTotal")over(PARTITION by pd."ptId")AS "carportTotal" ,--总车位数
                             SUM(pd."groundTotalCarport")over(PARTITION by pd."ptId")AS "groundTotalCarport" ,--地上车位数
                             SUM(pd."groundCarport")over(PARTITION by pd."ptId") AS "groundCarport",--地面车位数
                             SUM(pd."residenceBottomCarport")over(PARTITION by pd."ptId") AS "residenceBottomCarport",--住宅底层车位数
                             SUM(pd."parkingGarageCarport")over(PARTITION by pd."ptId") AS "parkingGarageCarport",--停车楼车位数
                             SUM(pd."undergroundTotalRjCarport")over(PARTITION by pd."ptId") AS "undergroundTotalRjCarport",--地下总人防车位数（计算=UNDERGROUND_RFJ_CARPORT+UNDERGROUND_RJ_CARPORT―)
                             SUM(pd."undergroundRfjCarport")over(PARTITION by pd."ptId") AS "undergroundRfjCarport",--地下人防非机械车位数
                             SUM(pd."undergroundRjCarport")over(PARTITION by pd."ptId") AS "undergroundRjCarport",--地下人防机械车位数
                             SUM(pd."undergroundTotalFrjCarport")over(PARTITION by pd."ptId") AS "undergroundTotalFrjCarport",--地下非人防车位数
                             SUM(pd."undergroundFrfjCarport")over(PARTITION by pd."ptId") AS "undergroundFrfjCarport",--地下非人防非机械车位数
                             SUM(pd."undergroundFrjCarport")over(PARTITION by pd."ptId") AS "undergroundFrjCarport",--地下非人防机械车位数
                             SUM(pd."undergroundTotalSaleCarport")over(PARTITION by pd."ptId") AS "undergroundTotalSaleCarport",--总可售车位数
                             SUM(pd."undergroundRSaleCarport")over(PARTITION by pd."ptId") AS "undergroundRSaleCarport",--地下人防可售车位数
                             SUM(pd."undergroundFrfjSaleCarport")over(PARTITION by pd."ptId") AS "undergroundFrfjSaleCarport",--地下非人防非机械可售车位数
                             SUM(pd."undergroundFrjSaleCarport")over(PARTITION by pd."ptId") AS "undergroundFrjSaleCarport"--地下非人防机械可售车位数
                         from  SYS_PROJECT spt INNER JOIN prodcut pd on spt.id=pd."ptId"  where (projCooperate='所有' or projCooperate=spt.PROJ_COOPERATE)
                     )sx LEFT JOIN (
                    SELECT
                        distinct
                        SUM(pi.TOTAL_SITE_AREA)over(PARTITION by PARENT_ID) as "totalSiteArea",
                        SUM(pi.CONSTRUCTION_LAND_AREA)over(PARTITION BY PARENT_ID) AS "constructionLandArea",
                        SUM(pi.CONFISCATED_AREA)over(PARTITION BY PARENT_ID) AS "confiscatedArea",
                        SUM(pi.OVERALL_FLOORAGE_AREA)over(PARTITION BY PARENT_ID) AS "overallFloorageArea",
                        SUM(pi.TOTAL_CAPACITY_AREA)over(PARTITION BY PARENT_ID) AS "totalCapacityArea",
                        SUM(pi.GROUND_ENGINE_CARPORT)over(PARTITION BY PARENT_ID) AS "groundEngineCarport",
                        SUM(pi.SALE_RATIO)over(PARTITION BY PARENT_ID) AS "saleRatio",
                        SUM(pi.CARPORT_RATIO)over(PARTITION BY PARENT_ID) AS "carportRatio",
                        SUM(pi.TOTAL_HOUSEHOLDS)over(PARTITION BY PARENT_ID) AS "totalHouseholds",
                        SUM(pi.PLOT_RATIO)over(PARTITION BY PARENT_ID) AS "plotRatio",
                        SUM(pi.BUILD_DENSITY)over(PARTITION BY PARENT_ID) AS "buildDensity",
                        SUM(pi.GREENING_RATE)over(PARTITION BY PARENT_ID) AS "greeningRate",
                        SUM(pi.CONSTRUCTION_PLOT_RATIO)over(PARTITION BY PARENT_ID) AS "constructionPlotRatio",
                        SUM(pi.CONSTRUCTION_BUILD_DENSITY)over(PARTITION BY PARENT_ID) AS "constructionBuildDensity",
                        SUM(pi.CONSTRUCTION_GREENING_RATE)over(PARTITION BY PARENT_ID) AS "constructionGreeningRate",
                        0 as "groundSaleCarport",---地上可售车位数
                        pi.PARENT_ID as "ptId"
                    FROM projPi pi
                )pi2 on pi2."ptId"=sx."orgId"
            ),
            unit as(
                SELECT ut4.*
                from (
                         select ut2.*,SYS_CONNECT_BY_PATH(ut2."orgId",'/')||'/' path
                         from (
                                  SELECT distinct ut1.*
                                  from (
                                           SELECT
                                               order_hierarchy_code as "orderHierarchyCode",
                                               0 as "objType",
                                               '' as "operateAttribute",
                                               id as "orgId",
                                               parent_id as "ptId",
                                               org_name as "orgName",
                                               0.00 AS "buildArea",--建筑占地面积
                                               --面积指标
                                               0.00 AS "groundTotalBuildArea",--地上总建筑面积
                                               0.00 AS "undergroundTotalBuildArea",--地下总建筑面积
                                               0.00 AS "groundCapacityArea",--地上计容面积
                                               0.00 AS "undergroundCapacityArea",--地上计容面积
                                               0.00 AS "groundUncapacityArea",--地上非计容面积
                                               0.00 AS "undergroundUncapacityArea",--地下非计容面积
                                               0.00 AS "undergroundGarageArea",--地下车库面积
                                               --销售面积指标
                                               0.00 AS "totalSaleArea",--总可售面积
                                               0.00 AS "groundSaleArea",--地上可售面积
                                               0.00 AS "undergroundSaleArea",--地下可售面积
                                               0.00 AS "totalGiveArea",--总赠送面积
                                               0.00 AS "groundGiveArea",--地上总赠送面积
                                               0.00 AS "undergroundGiveArea",--地上总赠送面积
                                               --车位指标
                                               0.00 AS "carportTotal" ,--总车位数
                                               0.00 AS "groundTotalCarport" ,--地上车位数
                                               0.00 AS "groundCarport",--地面车位数
                                               0.00 AS "residenceBottomCarport",--住宅底层车位数
                                               0.00 AS "parkingGarageCarport",--停车楼车位数
                                               0.00 AS "undergroundTotalRjCarport",--地下总人防车位数（计算=UNDERGROUND_RFJ_CARPORT+UNDERGROUND_RJ_CARPORT―)
                                               0.00 AS "undergroundRfjCarport",--地下人防非机械车位数
                                               0.00 AS "undergroundRjCarport",--地下人防机械车位数
                                               0.00 AS "undergroundTotalFrjCarport",--地下非人防车位数
                                               0.00 AS "undergroundFrfjCarport",--地下非人防非机械车位数
                                               0.00 AS "undergroundFrjCarport",--地下非人防机械车位数
                                               0.00 AS "undergroundTotalSaleCarport",--总可售车位数
                                               0.00 AS "undergroundRSaleCarport",--地下人防可售车位数
                                               0.00 AS "undergroundFrfjSaleCarport",--地下非人防非机械可售车位数
                                               0.00 AS "undergroundFrjSaleCarport",--地下非人防机械可售车位数
                                               0.00 as "totalSiteArea",
                                               0.00 AS "constructionLandArea",
                                               0.00 AS "confiscatedArea",
                                               0.00 AS "overallFloorageArea",
                                               0.00 AS "totalCapacityArea",
                                               0.00 AS "groundEngineCarport",
                                               0.00 AS "saleRatio",
                                               0.00 AS "carportRatio",
                                               0.00 AS "totalHouseholds",
                                               0.00 AS "plotRatio",
                                               0.00 AS "buildDensity",
                                               0.00 AS "greeningRate",
                                               0.00 AS "constructionPlotRatio",
                                               0.00 AS "constructionBuildDensity",
                                               0.00 AS "constructionGreeningRate",
                                               0.00 as "groundSaleCarport"---地上可售车位数
                                           from SYS_BUSINESS_UNIT start with ID IN (
                                               SELECT bu.id FROM SYS_BUSINESS_UNIT bu LEFT JOIN SYS_PROJECT sp on bu.id=sp.unit_id
                                               where (
                                                       (startWorks='所有' and (instr(projectIds, sp.id)>0))
                                                       or (startWorks = '开工' and sp.id in (select PROJECT_ID from startWrok WHERE cnt>0))
                                                       or (startWorks='未开工' and sp.id in (select PROJECT_ID from startWrok WHERE cnt<1))
                                                   )
                                                 and (projCooperate='所有' or projCooperate=sp.PROJ_COOPERATE)
                                                 and sp.id is not null
                                                 and bu.is_Company=1
                                           ) connect by nocycle prior PARENT_ID = ID   ORDER BY ORDER_HIERARCHY_CODE
                                       )ut1
                                       --where ut1."orgId"!='26f9c063-1193-47ea-9c0c-2fd4ae9c0a0a'
                                  UNION ALL
                                  SELECT * FROM projTotal
                              )ut2
                         start with ut2."orgId"=(
                             SELECT ID from SYS_BUSINESS_UNIT where level_rank=1
                         ) connect by prior ut2."orgId"=ut2."ptId"
                     )ut4
            ),
            unitPt as (
                SELECT
                    t1."orderHierarchyCode",
                    t1."objType",
                    t1."operateAttribute",
                    t1."orgId",
                    t1."ptId",
                    t1."orgName",
                    (SELECT SUM(t2."buildArea") FROM unit t2 WHERE t2.path like t1.path || '%') as "buildArea",
                    (SELECT SUM(t2."groundTotalBuildArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "groundTotalBuildArea",
                    (SELECT SUM(t2."undergroundTotalBuildArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundTotalBuildArea",
                    (SELECT SUM(t2."groundCapacityArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "groundCapacityArea",
                    (SELECT SUM(t2."undergroundCapacityArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundCapacityArea",
                    (SELECT SUM(t2."groundUncapacityArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "groundUncapacityArea",
                    (SELECT SUM(t2."undergroundUncapacityArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundUncapacityArea",
                    (SELECT SUM(t2."undergroundGarageArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundGarageArea",
                    (SELECT SUM(t2."totalSaleArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "totalSaleArea",
                    (SELECT SUM(t2."groundSaleArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "groundSaleArea",
                    (SELECT SUM(t2."undergroundSaleArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundSaleArea",
                    (SELECT SUM(t2."totalGiveArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "totalGiveArea",
                    (SELECT SUM(t2."groundGiveArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "groundGiveArea",
                    (SELECT SUM(t2."undergroundGiveArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundGiveArea",
                    (SELECT SUM(t2."carportTotal" ) FROM unit t2 WHERE t2.path like t1.path || '%')as "carportTotal" ,
                    (SELECT SUM(t2."groundTotalCarport" ) FROM unit t2 WHERE t2.path like t1.path || '%')as "groundTotalCarport" ,
                    (SELECT SUM(t2."groundCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "groundCarport",
                    (SELECT SUM(t2."residenceBottomCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "residenceBottomCarport",
                    (SELECT SUM(t2."parkingGarageCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "parkingGarageCarport",
                    (SELECT SUM(t2."undergroundTotalRjCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundTotalRjCarport",
                    (SELECT SUM(t2."undergroundRfjCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundRfjCarport",
                    (SELECT SUM(t2."undergroundRjCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundRjCarport",
                    (SELECT SUM(t2."undergroundTotalFrjCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundTotalFrjCarport",
                    (SELECT SUM(t2."undergroundFrfjCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundFrfjCarport",
                    (SELECT SUM(t2."undergroundFrjCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundFrjCarport",
                    (SELECT SUM(t2."undergroundTotalSaleCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundTotalSaleCarport",
                    (SELECT SUM(t2."undergroundRSaleCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundRSaleCarport",
                    (SELECT SUM(t2."undergroundFrfjSaleCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundFrfjSaleCarport",
                    (SELECT SUM(t2."undergroundFrjSaleCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "undergroundFrjSaleCarport",
                    (SELECT SUM(t2."totalSiteArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "totalSiteArea",
                    (SELECT SUM(t2."constructionLandArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "constructionLandArea",
                    (SELECT SUM(t2."confiscatedArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "confiscatedArea",
                    (SELECT SUM(t2."overallFloorageArea") FROM unit t2 WHERE t2.path like t1.path || '%')as "overallFloorageArea",
                    (SELECT SUM(t2."totalCapacityArea") FROM unit  t2 WHERE t2.path like t1.path || '%')as "totalCapacityArea",
                    (SELECT SUM(t2."groundEngineCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "groundEngineCarport",
                    (SELECT SUM(t2."saleRatio") FROM unit t2 WHERE t2.path like t1.path || '%')as "saleRatio",
                    (SELECT SUM(t2."carportRatio") FROM unit t2 WHERE t2.path like t1.path || '%')as "carportRatio",
                    (SELECT SUM(t2."totalHouseholds") FROM unit t2 WHERE t2.path like t1.path || '%')as "totalHouseholds",
                    (SELECT SUM(t2."plotRatio") FROM unit t2 WHERE t2.path like t1.path || '%')as "plotRatio",
                    (SELECT SUM(t2."buildDensity") FROM unit t2 WHERE t2.path like t1.path || '%')as "buildDensity",
                    (SELECT SUM(t2."greeningRate") FROM unit t2 WHERE t2.path like t1.path || '%')as "greeningRate",
                    (SELECT SUM(t2."constructionPlotRatio") FROM unit t2 WHERE t2.path like t1.path || '%')as "constructionPlotRatio",
                    (SELECT SUM(t2."constructionBuildDensity") FROM unit t2 WHERE t2.path like t1.path || '%')as "constructionBuildDensity",
                    (SELECT SUM(t2."constructionGreeningRate") FROM unit t2 WHERE t2.path like t1.path || '%')as "constructionGreeningRate",
                    (SELECT SUM(t2."groundSaleCarport") FROM unit t2 WHERE t2.path like t1.path || '%')as "groundSaleCarport"
                FROM unit t1
            )
        select
            g."operateAttribute",
            g."orgId",
            g."ptId",
            rpad(' ',4*"level"-1,'      ') || g."orgName" "orgName",
            trim(to_char(g."buildArea", '9999999990.00'))as "buildArea" ,--建筑占地面积
            ----面积指标
            trim(to_char(g."groundTotalBuildArea", '9999999990.00')) as "groundTotalBuildArea",--地上总建筑面积
            trim(to_char(g."undergroundTotalBuildArea", '9999999990.00')) as "undergroundTotalBuildArea",--地下总建筑面积
            trim(to_char(g."groundCapacityArea", '9999999990.00')) as "groundCapacityArea",--地上计容面积
            trim(to_char(g."undergroundCapacityArea", '9999999990.00')) as "undergroundCapacityArea",--地下计容面积
            trim(to_char(g."groundUncapacityArea", '9999999990.00')) as "groundUncapacityArea",--地上非计容面积
            trim(to_char(g."undergroundUncapacityArea", '9999999990.00')) as "undergroundUncapacityArea",--地下非计容面积
            trim(to_char(g."undergroundGarageArea", '9999999990.00')) as "undergroundGarageArea",--地下车库面积
            --销售面积指标
            trim(to_char(g."totalSaleArea", '9999999990.00')) as "totalSaleArea",--总可售面积
            trim(to_char(g."groundSaleArea", '9999999990.00')) as "groundSaleArea",--地上可售面积
            trim(to_char(g."undergroundSaleArea", '9999999990.00')) as "undergroundSaleArea",--地下可售面积
            trim(to_char(g."totalGiveArea", '9999999990.00')) as "totalGiveArea",--总赠送面积
            trim(to_char(g."groundGiveArea", '9999999990.00')) as "groundGiveArea",--地上总赠送面积
            trim(to_char(g."undergroundGiveArea", '9999999990.00')) as "undergroundGiveArea",--地上总赠送面积
            --车位指标
            trim(to_char(g."carportTotal", '9999999990')) as "carportTotal",--总车位数
            trim(to_char(g."groundTotalCarport", '9999999990')) as "groundTotalCarport",--地上车位数
            trim(to_char(g."groundCarport", '9999999990')) as "groundCarport",--地面车位数
            trim(to_char(g."residenceBottomCarport", '9999999990')) as "residenceBottomCarport",--住宅底层车位数
            trim(to_char(g."parkingGarageCarport", '9999999990')) as "parkingGarageCarport",--停车楼车位数
            trim(to_char(g."undergroundTotalRjCarport", '9999999990')) as "undergroundTotalRjCarport",--地下总人防车位数（计算=UNDERGROUND_RFJ_CARPORT+UNDERGROUND_RJ_CARPORT―)
            trim(to_char(g."undergroundRfjCarport", '9999999990')) as "undergroundRfjCarport",--地下人防非机械车位数
            trim(to_char(g."undergroundRjCarport", '9999999990')) as "undergroundRjCarport",--地下人防机械车位数
            trim(to_char(g."undergroundTotalFrjCarport", '9999999990')) as "undergroundTotalFrjCarport",--地下非人防车位数
            trim(to_char(g."undergroundFrfjCarport", '9999999990')) as "undergroundFrfjCarport",--地下非人防非机械车位数
            trim(to_char(g."undergroundFrjCarport", '9999999990')) as "undergroundFrjCarport",--地下非人防机械车位数
            trim(to_char(g."undergroundTotalSaleCarport", '9999999990')) as "undergroundTotalSaleCarport",--总可售车位数
            trim(to_char(g."undergroundRSaleCarport", '9999999990')) as "undergroundRSaleCarport",--地下人防可售车位数
            trim(to_char(g."undergroundFrfjSaleCarport", '9999999990')) as "undergroundFrfjSaleCarport",--地下非人防非机械可售车位数
            trim(to_char(g."undergroundFrjSaleCarport", '9999999990')) as "undergroundFrjSaleCarport",--地下非人防机械可售车位

            CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."totalSiteArea", '9999999990.00')))  end as "totalSiteArea",
            CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."constructionLandArea", '9999999990.00'))) end as "constructionLandArea",
            CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."confiscatedArea", '9999999990.00'))) end as "confiscatedArea",
            CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."overallFloorageArea", '9999999990.00'))) end as "overallFloorageArea",
            CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."totalCapacityArea", '9999999990.00'))) end as "totalCapacityArea",
            CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."groundEngineCarport", '9999999990.00'))) end as "groundEngineCarport",
            CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."carportRatio", '9999999990.00'))) end as "carportRatio",
            CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."totalHouseholds", '9999999990'))) end as "totalHouseholds",
            CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."plotRatio", '9999999990.00'))) end as "plotRatio",
            CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."buildDensity", '9999999990.00'))) end as "buildDensity",
            CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."greeningRate", '9999999990.00'))) end as "greeningRate",
            CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."constructionPlotRatio", '9999999990.00'))) end as "constructionPlotRatio",
            CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."constructionBuildDensity", '9999999990.00'))) end as "constructionBuildDensity",
            CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."constructionGreeningRate", '9999999990.00'))) end as "constructionGreeningRate",
            CASE WHEN g."objType"=40 then '-' else to_char(trim(to_char(g."groundSaleCarport", '9999999990.00'))) end as "groundSaleCarport"
        from (
                 select distinct dt.*,level as "level", sys_connect_by_path (dt."orderHierarchyCode", '-->') as tree
                 from (
                          select * from unitPt
                          union all
                          select * from projTotal
                          union all
                          select * from prodcut
                      ) dt start with dt."orgId" = '003200000000000000000000000000'
                 connect by prior dt."orgId" = dt."ptId"
                 order by tree
             )g order by tree,g."orderHierarchyCode";
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_DATA_INFO_CONDICTION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_DATA_INFO_CONDICTION" (
    operate out sys_refcursor,
    startProject out sys_refcursor
)
    is
begin
    open operate for
         select '操盘项目' as "lebel",
                2 as "sort",
                '操盘' as "value",
                0 as "isChecked" from dual
         union
         select '非操盘项目' as "lebel",
                3 as "sort",
                '不操盘' as "value",
                0 as "isChecked" from dual;

    open startProject for

         select '开工' as "lebel",
                2 as "sort",
                '开工' as "value",
                0 as "isChecked" from dual
         union
         select '未开工' as "lebel",
                3 as "sort",
                '未开工' as "value",
                0 as "isChecked" from dual;
end;


/
--------------------------------------------------------
--  DDL for Procedure P_MDM_DELETE_DATA_MAINTAIN
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_DELETE_DATA_MAINTAIN" (
    objPhaseVersionId  IN VARCHAR2, --项目id
    msg     OUT  VARCHAR2--消息
)
as
    v_obj_version  varchar2(50):='';
    v_projectId   varchar2(50):='';
    v_phaseId     varchar2(50):='';
    v_error_count  INT :=0;
BEGIN
    -- 查询项目id
    select COUNT(id) INTO v_error_count FROM MDM_OBJ_PHASE_VERSION WHERE
            id = objPhaseVersionId and (PHASE_STATE=19 or PHASE_STATE=20);
    IF v_error_count > 0 THEN
        msg:='审核中或已审核的数据不允许删除，若需要删除请先作废流程';
        return;
    END IF;

    --查询版本
    select OBJ_PHASE_VERSION,obj_id,phase_id into v_obj_version,v_projectId,v_phaseId
    from MDM_OBJ_PHASE_VERSION where id=objPhaseVersionId;

    --删除面积指标表
    delete from MDM_OBJ_PHASE_AL_V where OBJ_PHASE_PT_INDEX_ID in (
        with t1 as (
            SELECT ID from MDM_PROJECT_PHASE
            where PROJ_ID = v_projectId
              and PHASE_ID = v_phaseId
            union
            select mpp1.ID
            from MDM_PERIOD_PHASE mpp1
                     left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                     left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
            where mpv.PROJECT_ID = v_projectId
              and PHASE_ID = v_phaseId
              and APPROVAL_STATUS='已审核'
            union
            select mpp1.ID
            from MDM_PARCEL_PHASE mpp1
                     left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
            where mp1.PROJECT_ORIGINAL_ID = v_projectId
              and PHASE_ID = v_phaseId
            union
            select mbp1.ID
            from MDM_BUILD_PHASE mbp1
                     left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
            where mb1.PROJ_ID = v_projectId
              and PHASE_ID = v_phaseId
        ) select mopvpi.ID
        from t1
                 left join MDM_OBJ_PHASE_VERSION mopv on OBJ_PHASE_ID = t1.ID
                 left join MDM_OBJ_PHASE_VERSION_PT_INDEX mopvpi on mopvpi.OBJ_PHASE_ID = mopv.ID
        where mopv.PHASE_ID = v_phaseId and mopv.OBJ_PHASE_VERSION=v_obj_version
    );


    --删除业态信息表
    delete from MDM_OBJ_PHASE_VERSION_PT_INDEX where OBJ_PHASE_VERSION_ID in (
        with t1 as (
            SELECT ID from MDM_PROJECT_PHASE
            where PROJ_ID = v_projectId
              and PHASE_ID = v_phaseId
            union
            select mpp1.ID
            from MDM_PERIOD_PHASE mpp1
                     left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                     left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
            where mpv.PROJECT_ID = v_projectId
              and PHASE_ID = v_phaseId
              and APPROVAL_STATUS='已审核'
            union
            select mpp1.ID
            from MDM_PARCEL_PHASE mpp1
                     left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
            where mp1.PROJECT_ORIGINAL_ID = v_projectId
              and PHASE_ID = v_phaseId
            union
            select mbp1.ID
            from MDM_BUILD_PHASE mbp1
                     left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
            where mb1.PROJ_ID = v_projectId
              and PHASE_ID = v_phaseId
        ) select mopv.ID from t1
                                  left join MDM_OBJ_PHASE_VERSION mopv on OBJ_PHASE_ID = t1.ID
        where mopv.PHASE_ID = v_phaseId and mopv.OBJ_PHASE_VERSION=v_obj_version
    );

    --删除指标表
    delete from MDM_OBJ_PHASE_VERSION_INDEX where OBJ_PHASE_VERSION_ID in (
        with t1 as (
            SELECT ID from MDM_PROJECT_PHASE
            where PROJ_ID = v_projectId
              and PHASE_ID = v_phaseId
            union
            select mpp1.ID
            from MDM_PERIOD_PHASE mpp1
                     left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                     left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
            where mpv.PROJECT_ID = v_projectId
              and PHASE_ID = v_phaseId
              and APPROVAL_STATUS='已审核'
            union
            select mpp1.ID
            from MDM_PARCEL_PHASE mpp1
                     left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
            where mp1.PROJECT_ORIGINAL_ID = v_projectId
              and PHASE_ID = v_phaseId
            union
            select mbp1.ID
            from MDM_BUILD_PHASE mbp1
                     left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
            where mb1.PROJ_ID = v_projectId
              and PHASE_ID = v_phaseId
        ) select mopv.ID from t1
                                  left join MDM_OBJ_PHASE_VERSION mopv on OBJ_PHASE_ID = t1.ID
        where mopv.PHASE_ID = v_phaseId and mopv.OBJ_PHASE_VERSION=v_obj_version
    );

    --删除阶段版本表
    delete from MDM_OBJ_PHASE_VERSION mopv where mopv.OBJ_PHASE_VERSION=v_obj_version and OBJ_PHASE_ID in (
        SELECT ID from MDM_PROJECT_PHASE
        where PROJ_ID = v_projectId
          and PHASE_ID = v_phaseId
        union
        select mpp1.ID
        from MDM_PERIOD_PHASE mpp1
                 left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                 left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
        where mpv.PROJECT_ID = v_projectId
          and PHASE_ID = v_phaseId
          and APPROVAL_STATUS='已审核'
        union
        select mpp1.ID
        from MDM_PARCEL_PHASE mpp1
                 left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
        where mp1.PROJECT_ORIGINAL_ID = v_projectId
          and PHASE_ID = v_phaseId
        union
        select mbp1.ID
        from MDM_BUILD_PHASE mbp1
                 left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
        where mb1.PROJ_ID = v_projectId
          and PHASE_ID = v_phaseId
    );

    msg:='删除成功';
END P_MDM_DELETE_DATA_MAINTAIN;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_DOCKING_SALE_GET_PERMIT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_DOCKING_SALE_GET_PERMIT" (
    info out sys_refcursor
)
as
--销售系统获取预售/备案许可证信息
begin
    open info for
    select
        mpt.PROJECT_ID "Projectid",
        decode(sp.PROJ_COOPERATE, '操盘', 1, 0) "IsTjcp",
        mpt.STAGE_ID "FqID",
        decode(sp.PROJ_COOPERATE, '操盘', sb.ID, null) "BudingID",
        decode(mpt.PERMIT_TYPE, '预售许可证', 1, '竣工备案证', 2, null) "QzType",
        mpt.PERMIT_NO "QzNo",
        mpt.PERMIT_GET_DATE "QzDate",
        sysdate "PushTime",
        1 "tag"
    from MDM_PERMIT mpt
    inner join SYS_PROJECT sp on mpt.PROJECT_ID = sp.ID
    inner join (select PERMIT_ID, BLD_ID from MDM_PERMIT_BLD group by PERMIT_ID, BLD_ID) mpb
                   on mpb.PERMIT_ID = mpt.ID
    inner join SYS_BUILD sb on sb.ID = mpb.BLD_ID
    where mpt.APPROVAL_STATUS='已审核'
      and mpt.PERMIT_TYPE in ('预售许可证', '竣工备案证')
      and TO_CHAR(sysdate, 'yyyy-mm-dd') = TO_CHAR(mpt.APPROVAL_TIME, 'yyyy-mm-dd');
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_DOCKING_SALE_PROJ_EQUITY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_DOCKING_SALE_PROJ_EQUITY" (
    info out sys_refcursor
)
as
--获取项目股权
--@auther <a href="mailto:hanjm@Highzap.com"></a>
begin
    open info for
    select
        id "ProjectId",
        decode(sp.PROJ_COOPERATE, '操盘', 1, 0) "IsTjcp",
        sp.REAL_ESTATE_SHARE_RATIO "Qybl",
        TO_CHAR(sysdate, 'yyyy-MM-DD HH24:MI:SS') "PushTime"
    from SYS_PROJECT sp
    where to_char(APPROVAL_TIME, 'yyyy-mm-dd') = to_char(sysdate, 'yyyy-mm-dd')
    ;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_EXT_ALL_PT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_EXT_ALL_PT" (
    info out sys_refcursor
)
as
    -- 19.获取全部业态	/api/listAllPT
    -- @auth hanjm
begin
    open info for
        select
            mbpt1.ID "id",
            mbpt1.PRODUCT_TYPE_SHORT_NAME "name",
            mbpt2.ID "pId"
        from MDM_BUILD_PRODUCT_TYPE mbpt1
        left join MDM_BUILD_PRODUCT_TYPE mbpt2 on mbpt1.PARENT_CODE = mbpt2.PRODUCT_TYPE_CODE
            and mbpt1.IS_DISABLE = mbpt2.IS_DISABLE
        where mbpt1.IS_DISABLE = 0;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_EXT_BUILDING_BY_STAGE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_EXT_BUILDING_BY_STAGE" (
    stageId in varchar,
    info out sys_refcursor
)
as
    --23.根据分期id获取楼栋信息	/api/getBuildingByStage P_MDM_EXT_BUILDING_BY_STAGE
begin
    open info for
        select
            mb.BUILD_NAME "buildingName", -- 楼栋名称
            mpm.R_PROJ_ID "projectId", -- 项目ID
            mb.ID "buildingId", -- 楼栋ID
            mb.PERIOD_ID "stageId" --分期ID
        from MDM_BUILD mb
        left join MDM_PROJ_MAPPING mpm on mpm.PROJECT_ORIGINAL_ID = mb.PROJ_ID
        where PERIOD_ID = stageId and BUILD_STATE='10';
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_EXT_BUILDING_LIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_EXT_BUILDING_LIST" (
    projectId in varchar,
    info out sys_refcursor
)
--     20.获取楼栋列表 /api/loadBuildingList
as
    vProjectId varchar(36) := FN_GET_PROJECT_ORIGINAL_ID(projectId);
begin
    open info for
        select
            mb.BUILD_NAME "buildingName", -- 楼栋名称
            mpm.R_PROJ_ID "projectId", -- 项目ID
            mb.ID "buildingId", -- 楼栋ID
            mb.PERIOD_ID "stageId" --分期ID
        from MDM_BUILD mb
        left join MDM_PROJ_MAPPING mpm on mpm.PROJECT_ORIGINAL_ID = mb.PROJ_ID
        where (vProjectId is null or PROJ_ID = vProjectId)
          and BUILD_STATE='10'
        order by ORDER_HIERARCHY_CODE;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_EXT_BUILDING_ROOM
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_EXT_BUILDING_ROOM" (
    bldguid in varchar, -- 房间id
    buildingInfo out sys_refcursor, --楼栋信息
    floors out sys_refcursor, --楼层信息
    rooms out sys_refcursor, -- 房间信息
    units out sys_refcursor --单元信息
)
as
    --25.获取楼栋所有房间的信息（新） /api/saleReportViewByBldguid
    -- 获取所有业态
    -- @auth hanjm
begin
    -- 获取楼栋所有房间信息 单个
    open buildingInfo for
        select
            decode("XSJE_SHANGYE"+"XSJE_ZHUZHAI", 0, 0.00,
                   TO_CHAR(("XSJE_SHANGYE" + "XSJE_ZHUZHAI")/("XSMJ_SHANGYE"+"XSMJ_ZHUZHAI"), 'FM9999990.99')) "JJ_TOTAL", --均价总计(Double)
            "FYTS_ZHUZHAI", --房源套数住宅(Integer)
            "XSJE_SHANGYE", --销售金额商业(Double)
            "FYMJ_ZHUZHAI", --房源面积住宅(Double)
            decode("FYMJ_ZHUZHAI", 0, 0.00, TO_CHAR("XSJE_ZHUZHAI"/"FYMJ_ZHUZHAI",
                                                    'FM99999990.99')) "JJ_ZHUZHAI", --均价住宅(Double)
            "XSMJ_SHANGYE"+"XSMJ_ZHUZHAI" "XSMJ_TOTAL", --销售面积总计(Double)
            "XSMJ_SHANGYE", --销售面积商业(Double)
            "XSJE_ZHUZHAI", --销售金额住宅(Double)
            "FYTS_SHANGYE", --房源商业总计(Double)
            "XSJE_SHANGYE"+"XSJE_ZHUZHAI" "XSJE_TOTAL", --销售金额总计(Double)
            "XSZT_RENGOU", --销售状态认购(Integer)
            "XSZT_QIANYUE", --销售状态签约(Integer)
            "XSZT_DAISHOU", --销售状态待售(Integer)
            "FYMJ_SHANGYE", --房源面积商业(Integer)
            "XSMJ_ZHUZHAI", --销售面积住宅(Double)
            "FYMJ_TOTAL", --房源面积总计(Double)
            decode("FYMJ_SHANGYE", 0, 0.00,
                   TO_CHAR("XSJE_SHANGYE"/"FYMJ_SHANGYE", 'FM999990.99')) "JJ_SHANGYE", -- 均价商业(Integer)
            "FYTS_TOTAL" -- 房源套数合计(Integer),
        from (
            select
                sum(case when SALE_STATE = '待售' then 1 else 0 end) "XSZT_DAISHOU", --销售状态待售(Integer)
                sum(case when SALE_STATE = '签约' then 1 else 0 end) "XSZT_QIANYUE", --销售状态签约(Integer)
                sum(case when SALE_STATE = '认购' then 1 else 0 end) "XSZT_RENGOU", --销售状态认购(Integer)
                count(1) "FYTS_TOTAL", --房源套数合计(String)
                sum(case when PRODUCT_NAME = '住宅' then 1 else 0 end) "FYTS_ZHUZHAI", --房源套数住宅(Integer)
                sum(case when PRODUCT_NAME = '商办' then 1 else 0 end) "FYTS_SHANGYE", --房源商业套数(String)
                sum(NEW_BLD_AREA) "FYMJ_TOTAL", --房源面积合计(String)
                sum(case when PRODUCT_NAME = '住宅' then NEW_BLD_AREA else 0 end) "FYMJ_ZHUZHAI",-- 房源住宅面积
                sum(case when PRODUCT_NAME = '商办' then NEW_BLD_AREA else 0 end) "FYMJ_SHANGYE",-- 房源面积商业
                sum(case when PRODUCT_NAME = '住宅' then NEW_BLD_AREA else 0 end) "XSMJ_ZHUZHAI",-- 销售面积住宅
                sum(case when PRODUCT_NAME = '商办' then NEW_BLD_AREA else 0 end) "XSMJ_SHANGYE",-- 销售面积商业
                sum(case when PRODUCT_NAME = '住宅' then nvl(TRADE_TOTAL, BZ_TOTAL) else 0 end) "XSJE_ZHUZHAI",-- 销售金额住宅
                sum(case when PRODUCT_NAME = '商办' then nvl(TRADE_TOTAL, BZ_TOTAL) else 0 end) "XSJE_SHANGYE"-- 销售金额商业
            from MDM_ROOM
--                  where BUILDING_ID=bldguid
            where BUILDING_ID='0245fc247e7544df9c6b3ddb3288d3d9'
            group by BUILDING_ID
        );
    -- 获取楼栋楼层
    open floors for
        select
            distinct FLOOR_NAME "FLOORNAME" --楼层名称(String)
        from MDM_ROOM where BUILDING_ID = bldguid;
    -- 获取房间楼层
    open rooms for
        select
            mr.ID ROOMGUID,
            mr.BZ_TOTAL "TOTAL", --标准总价(Double)
            mr.PRODUCT_NAME "HXNAME", --户型名称(String)
            mr.BASE_PRICE PRICE,   --建筑单价(Double)
            mr.FLOOR_NAME FLOOR_NAME,   --楼层名称(String)
            mr.NEW_IN_AREA TNAREA,   --套内面积（户型）(Double)
            mr.TRADE_TOTAL CONTRACTTOTAL,   --合同金额(Integer)
            nvl(mr.SALE_STATE, '出售') SALESTATUS,   --销售状态("出售")(String)
            mr.NEW_BLD_AREA BLDAREA,   --建筑面积（户型）(Double)
            mr.ROOM_CODE ROOMCODE,   --房间编码(String)
            1 STATUS,   --状态(Integer)
            mr.TRADE_PRICE CONTRACTPRICE,   --合同单价(Double)
            mr.UNIT_NAME UNIT_NAME,   --单元名称(String)
            mr.ROOM_NAME ROOMNAME,   --房间名称(String)
            mr.PRODUCT_CODE BPRODUCTTYPECODE,   --业态编码(String)
            mr.SALE_STATE SALETYPE,   --销售类型(String)
            mr.BZ_PRICE TNPRICE -- 套内单价
        from MDM_ROOM mr
        left join MDM_BUILD mb on mr.BUILDING_ID = mb.ID
        where mb.id = bldguid;
    -- 获取单元信息
    open units for
        select
            UNIT_NAME "UNITNAME", -- 单元名称(String)
            ROOM_CODE "DOORNUM" --房间数(String)
        from MDM_ROOM where BUILDING_ID = bldguid;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_EXT_BUILDING_ROOM_OLD
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_EXT_BUILDING_ROOM_OLD" (
    info out sys_refcursor,
    buildingId in varchar -- 房间id
)
as
    -- 28.获取楼栋所有房间信息	/REST/listRoomByBuildingId
    -- 获取楼栋所有房间信息
    -- @author hanjm
begin
    open info for
        select
            mr.id "roomGuid", -- 房间ID(String)
            mr.UNIT_ID "unitNo", -- 单元号(String)
            mr.ROOM_CODE "roomNo", -- 房间编号(String)
            mr.UNIT_NAME "unitName", -- 单元名称(String)
            mr.NEW_BLD_AREA "bldArea", -- 建筑面积（户型）(Double)
            mr.PRODUCT_NAME "ptName", -- 业态名称(String)
            mr.SALE_STATE "saleStatus", -- 销售状态(String)
            mr.ROOM_CODE "roomCode", -- 房间编号(String)
            mr.PRODUCT_CODE "ptId", -- 业态ID(String)
            null "hxName", -- 户型名称(String)
            mr.ROOM_NAME "roomName", -- 房间名称(String)
            UPPER(mr.BUILDING_ID) "buildingId", -- 楼栋ID(String)
            mr.NEW_IN_AREA "tnArea", -- 套内面积（户型）(Double)
            mr.FLOOR_ID "floorNo", -- 楼层号(String)
            mr.FLOOR_NAME "floor", -- 楼层(String)
            mpm.R_PROJ_ID "projectId", -- 项目ID(String)
            mr.PRODUCT_NAME "productType", --业态名称
            nvl('', '出售') "roomType", --房间类型（默认："出售"）
            mb.PERIOD_ID "stageId" --分期Id
        from MDM_ROOM mr left join MDM_BUILD mb on mb.ID = mr.BUILDING_ID
        left join MDM_PROJ_MAPPING mpm on mpm.PROJECT_ORIGINAL_ID = mb.PROJ_ID
        where UPPER(mr.BUILDING_ID)=UPPER(buildingId);
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_EXT_GET_PROJECT_INFO
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_EXT_GET_PROJECT_INFO" (
    projectId in varchar,
    info out sys_refcursor
)
as
    -- @date 2020-11-16
-- @author 韩金明
-- @note【设计规划系统】根据项目ID从【主数据系统】获对应项目信//可研版主数
begin
    open info for
        select
            TO_CHAR(pro.PROJECT_GET_TIME, 'YYYY-MM-DD') "getTime", -- 取得时间
            nvl(mopi.CONFISCATED_AREA, 0) "landAcquisitionArea", -- 代征地面积(O)
            null "buildingHeightControl", -- 建筑控高
            TO_CHAR(sysdate, 'YYYY-MM-DD HH24:MI:SS') "updateDate", -- 项目基本信息更新时间
            pro.PROJECT_CODE "code", -- 项目编码
            pro.COMPANY_NAME "unitName", -- 公司名称
            pro.LEGAL_PERSON_COMPANY_ID "corpId", -- 法人组织ID
            pro.MODIFIER_ID "updateUserId", -- 项目信息修改人ID
            null "cityCode", -- 城市ID
            pro.VICE_PM_NAME "vicePMName", -- 项目经理名称
            pro.MODIFIER "updateUser", -- 项目信息修改人名称
            pro.LEGAL_PERSON_COMPANY "corpName", -- 法人组织名称
            nvl(mopi.OVERALL_FLOORAGE_AREA, 0) "zjzmj", -- 总建筑面积
            pro.VICE_PM_ID "vicePMId", -- 项目经理ID
            replace(replace(mr.MER_NAME, '中国,', ''),',','-') "cityName", -- 城市名称
            pro.PROJECT_NAME "name", -- 项目名称
            pro.COMPANY_ID "unitId", -- 公司ID
            pro.ID "Id", -- 项目ID
            (select REPLACE(wmsys.WM_CONCAT(sp1.ID), ',', ';') from SYS_PARCEL sp1 where sp1.PROJECT_ID=pro.ID) "itemLmsIds" --关联土地地块ID
        from SYS_PROJECT pro
                 left join  MDM_PROJECT_PHASE mpp on mpp.PROJ_ID = pro.ID and mpp.PHASE_ORDER = 1 and mpp.PHASE_STATE >=19
                 left join MDM_OBJ_PHASE_INDEX mopi on mopi.OBJ_PHASE_ID = mpp.ID
                 left join MDM_REGION mr on mr.ID = pro.PLACE_ID
        where pro.ID = projectId;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_EXT_PRODUCT_INFO
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_EXT_PRODUCT_INFO" (
    info out sys_refcursor
) as
begin
    open info for
        select
            mbpt.ID "id", --业态的id
            mbpt.PRODUCT_TYPE_SHORT_NAME "name", --业态的名称
            mbpt.PRODUCT_TYPE_CODE "code", --业态的编码
            mbpt.PARENT_CODE "parentCode" --上一级业态的code
        from MDM_BUILD_PRODUCT_TYPE mbpt;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_EXT_PROJ_DETAIL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_EXT_PROJ_DETAIL" (
    projectId in varchar,
    info out sys_refcursor
)
as
    -- @date 2020-11-16
-- @author 韩金明
-- @note 【设计规划系统】根据项目ID从【主数据系统】获取项目下地块对应的面积指标信息。//可研版主数
begin
    open info for
        select
            st.ID "landId",-- 地块id
            st.PARCEL_NAME "landName",-- 地块名称
            st.LAND_USEAGE "landNature",-- 用地性质
            nvl(st.CONSTRUCTION_LAND_AREA, 0) "constructionLandArea",-- 建设用地面积
            nvl(st.OVERALL_FLOORAGE_AREA, 0) "totalConstructionArea",-- 总建筑面积
            nvl(st.GROUND_CAPACITY_AREA, 0) "buildingAreaAboveGround",-- 地上计容面积
            nvl(st.UNDERGROUND_CAPACITY_AREA, 0) "undergroundCapacityArea",-- 地下计容面积
            nvl(st.UNDERGROUND_UNCAPACITY_AREA, 0) "undergroundUnCapacityArea",-- 地下非计容面积 标识符过长
            -- 接口层做映射 undergroundUnCapacityArea => undergroundBuildingAreaNoCalculation
            nvl(st.CONSTRUCTION_PLOT_RATIO, 0) "volumeRate",-- 容积率(土地出让) 实际容积率(按建设用地面积)
            nvl(st.CONSTRUCTION_BUILD_DENSITY, 0) "buildingDensity",-- 建筑密度(土地出让) 实际建筑密度(按建设用地面积)
            nvl(st.CONSTRUCTION_GREENING_RATE, 0) "greenSpaceRate", -- 绿地率(土地出让) 实际绿地率(按建设用地面积)
            nvl(st.TOTAL_HOUSEHOLDS, 0) "households", -- 总户数(住宅+商铺)
            nvl(sd.townhouse, 0) "townhouse", -- 联排别墅建筑面积
            nvl(sd.singleFamilyVillas, 0) "singleFamilyVillas", -- 独栋别墅建筑面积
            nvl(sd.courtyardVilla, 0) "courtyardVilla", -- 合院别墅建筑面积
            nvl(sd.stackedTownhouse, 0) "stackedTownhouse", -- 叠拼别墅建筑面积
            nvl(sd.multiStoreyHouse, 0) "multiStoreyHouse", -- 多层I 建筑面积
            nvl(sd.mediumHighRiseResidence, 0) "mediumHighRiseResidence", -- 多层II建筑面积
            nvl(sd.hightRiseHouseFirst, 0) "hightRiseHouseFirst", -- 高层I建筑面积
            nvl(sd.hightRiseHouseSecond, 0) "hightRiseHouseSecond", -- 高层II建筑面积
            nvl(sd.hightRiseHouseThird, 0) "hightRiseHouseThird", -- 高层III建筑面积
            nvl(sd.hightRiseHouseFourth, 0) "hightRiseHouseFourth", -- 超高层建筑面积
            nvl(sd.townhouse, 0) + nvl(sd.singleFamilyVillas, 0) + nvl(sd.courtyardVilla, 0) + nvl(sd.multiStoreyHouse, 0)
                + nvl(sd.mediumHighRiseResidence, 0) + nvl(sd.stackedTownhouse, 0) + nvl(sd.hightRiseHouseFirst, 0) + nvl(sd.hightRiseHouseSecond, 0)
                + nvl(sd.hightRiseHouseThird, 0) + nvl(hightRiseHouseFourth, 0) "commodityHousingSubtotal",
            -- 商品房总建筑面积=联排别墅建筑面积+独栋别墅建筑面积+合院别墅建筑面积+叠拼别墅建筑面积+多层I建筑面积
            -- +多层II建筑面积+高层I建筑面积+高层II建筑面积+高层III建筑面积+超高层建筑面积
            nvl(sd.priceFixedHousing, 0) "priceFixedHousing",  --限价房建筑面积
            nvl(sd.directionalResettlementHousing, 0) "directionalResettlementHousing",  -- 定向安置房建筑面积
            nvl(sd.policyBasedRentalHousing, 0) "policyBasedRentalHousing",  -- 政策性租赁房建筑面积
            nvl(sd.priceFixedHousing, 0) + nvl(sd.directionalResettlementHousing, 0) + nvl(sd.policyBasedRentalHousing, 0) "policyHousingSubtotal",
            --政策性住房总面积=限价房+定向安置房+政策性租赁房
            nvl(st.GROUND_UNCAPACITY_AREA, 0) "totalBuildingAreaAboveGround", --地上不计容建筑面积
            nvl(st.UNDERGROUND_CAPACITY_AREA, 0) + nvl(st.UNDERGROUND_UNCAPACITY_AREA, 0) "undergroundBuildingArea ", --地下建筑面积
            nvl(st.GROUND_TOTAL_CARPORT, 0) "parkingSpacesOnGround", --地上车位数
            nvl(st.UNDERGROUND_TOTAL_CARPORT, 0) "parkingSpacesOnUnderground", --地下机动车位数
            nvl(st.UNDERGROUND_FRJ_CARPORT, 0) + nvl(st.UNDERGROUND_FRFJ_CARPORT, 0) "nonAirDefenseParkingSpace", --地下非人防车位数
            nvl(st.UNDERGROUND_FRFJ_CARPORT, 0) "undergroundFrfjCarport", --地下非人防非机械车位数 标识符过长
            -- 使用  undergroundFrfjCarport=>nonAirSelfPropelledParkingSpace
            nvl(st.UNDERGROUND_FRJ_CARPORT, 0) "nonAirMechanicalParkingSpace", --地下非人防机械车位数
            nvl(st.UNDERGROUND_RJ_CARPORT, 0) + nvl(st.UNDERGROUND_RFJ_CARPORT, 0) "civilAirDefenseParkingSpace", -- 地下人防车位数
            nvl(st.UNDERGROUND_RFJ_CARPORT, 0) "undergroundFrjCarport", --地下人防非机械车位数 标识符过长
            -- 使用  undergroundFrjCarport=>civilAirSelfPropelledParkingSpace
            nvl(st.UNDERGROUND_RJ_CARPORT, 0) "civilAirMechanicalParkingSpace", --地下人防机械车位数
            nvl(st.CARPORT_TOTAL, 0) "totalMotorParkingSpaces" -- 总车位数
        from (
                 select par.ID, mopi.OBJ_PHASE_ID, par.PARCEL_NAME, par.LAND_USEAGE, mopi.CONSTRUCTION_LAND_AREA,
                        mopi.OVERALL_FLOORAGE_AREA, mopi.GROUND_CAPACITY_AREA, mopi.UNDERGROUND_CAPACITY_AREA,
                        mopi.UNDERGROUND_UNCAPACITY_AREA, mopi.CONSTRUCTION_PLOT_RATIO, mopi.CONSTRUCTION_BUILD_DENSITY,
                        mopi.CONSTRUCTION_GREENING_RATE, mopi.TOTAL_HOUSEHOLDS, mopi.UNDERGROUND_TOTAL_CARPORT,
                        mopi.GROUND_TOTAL_CARPORT, mopi.UNDERGROUND_RFJ_CARPORT,mopi.UNDERGROUND_RJ_CARPORT,
                        mopi.UNDERGROUND_FRJ_CARPORT, mopi.UNDERGROUND_FRFJ_CARPORT, par.PROJECT_ID, mopi.CARPORT_TOTAL,
                        mopi.GROUND_UNCAPACITY_AREA
                 from SYS_PROJECT pro
                          left join SYS_PARCEL par on pro.ID = par.PROJECT_ID
                          left join MDM_PARCEL_PHASE mpp on mpp.PAECEL_ID = par.ID
                          left join MDM_OBJ_PHASE_INDEX mopi on mopi.OBJ_PHASE_ID = mpp.ID
                 where mpp.PHASE_ORDER = 1 and mpp.PHASE_STATE >= 19
             ) st left join (
            select
                moppi.OBJ_PHASE_ID,
                sum(decode(mbpt.PRODUCT_TYPE_SHORT_NAME, '联排别墅', moppi.BUILD_AREA, 0)) townhouse,
                sum(decode(mbpt.PRODUCT_TYPE_SHORT_NAME, '独栋别墅', moppi.BUILD_AREA, 0)) singleFamilyVillas,
                sum(decode(mbpt.PRODUCT_TYPE_SHORT_NAME, '合院别墅', moppi.BUILD_AREA, 0)) courtyardVilla,
                sum(decode(mbpt.PRODUCT_TYPE_SHORT_NAME, '叠拼别墅', moppi.BUILD_AREA, 0)) stackedTownhouse,
                sum(decode(mbpt.PRODUCT_TYPE_SHORT_NAME, '多层I',moppi.BUILD_AREA, 0)) multiStoreyHouse,
                sum(decode(mbpt.PRODUCT_TYPE_SHORT_NAME, '多层II',moppi.BUILD_AREA, 0)) mediumHighRiseResidence,
                sum(decode(mbpt.PRODUCT_TYPE_SHORT_NAME, '高层I',moppi.BUILD_AREA, 0)) hightRiseHouseFirst,
                sum(decode(mbpt.PRODUCT_TYPE_SHORT_NAME, '高层II',moppi.BUILD_AREA, 0)) hightRiseHouseSecond,
                sum(decode(mbpt.PRODUCT_TYPE_SHORT_NAME, '高层III',moppi.BUILD_AREA, 0)) hightRiseHouseThird,
                sum(decode(mbpt.PRODUCT_TYPE_SHORT_NAME, '超高层',moppi.BUILD_AREA, 0)) hightRiseHouseFourth,
                sum(decode(mbpt.PRODUCT_TYPE_SHORT_NAME, '限价房',moppi.BUILD_AREA, 0)) priceFixedHousing,
                sum(decode(mbpt.PRODUCT_TYPE_SHORT_NAME, '定向安置房',moppi.BUILD_AREA, 0)) directionalResettlementHousing,
                sum(decode(mbpt.PRODUCT_TYPE_SHORT_NAME, '政策性租赁房',moppi.BUILD_AREA, 0)) policyBasedRentalHousing
            from MDM_OBJ_PHASE_PT_INDEX moppi
                     left join MDM_BUILD_PRODUCT_TYPE mbpt on mbpt.ID = moppi.PRODUCT_TYPE_ID
            group by moppi.OBJ_PHASE_ID
        ) sd on sd.OBJ_PHASE_ID = st.OBJ_PHASE_ID
        where PROJECT_ID = projectId;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_EXT_PROJECT_CAP_BUILD
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_EXT_PROJECT_CAP_BUILD" (
    info out sys_refcursor,
    projectGuid in varchar -- 项目id
)
    -- 26.获取项目下的车位&楼栋信息
    -- notes: 存在多条数据，也只会返回第一条数据
    -- @auth hanjm
as
    vProjectGuid varchar(36) := FN_GET_PROJECT_ORIGINAL_ID(projectGuid);
begin
    open info for
        select
            sp.PROJECT_NAME "title", --项目名称(String)
            TO_CHAR(count(*)) "count", --合计（默认返回“0”）(String)
            TO_CHAR(SUM("totalArea")) as "totalArea", --房源面积合计(String)
            TO_CHAR(SUM("totalPt1Area")) as"totalPt1Area", --房源住宅面积(String)
            TO_CHAR(SUM("totalPt2Area")) as "totalPt2Area", --房源公寓面积(String)
            TO_CHAR(SUM("totalPt3Area")) as "totalPt3Area", --房源商业面积(String)
            TO_CHAR(SUM("totalPt4Area")) as "totalPt4Area", --房源车位面积(String)
            TO_CHAR(SUM("totalCount")) as "totalCount", --房源套数合计(String)
            TO_CHAR(SUM("totalPt1Count")) as "totalPt1Count", --房源住宅套数(String)
            TO_CHAR(SUM("totalPt2Count")) as "totalPt2Count", --房源公寓套数(String)
            TO_CHAR(SUM("totalPt3Count")) as "totalPt3Count", --房源商业套数(String)
            TO_CHAR(SUM("totalPt4Count")) as "totalPt4Count", --房源车位套数(String)
            TO_CHAR(SUM("forSaleCount")) as "forSaleCount", --待售套数(String)
            TO_CHAR(SUM("forSalePt1Count")) as "forSalePt1Count", --住宅待售套数(String)
            TO_CHAR(SUM("forSalePt2Count")) as "forSalePt2Count", --公寓待售套数(String)
            TO_CHAR(SUM("forSalePt3Count")) as "forSalePt3Count", --商业待售套数(String)
            TO_CHAR(SUM("forSalePt4Count")) as "forSalePt4Count", --车位待售套数(String)
            TO_CHAR(SUM("qyArea")) as "qyArea", --签约面积(String)
            TO_CHAR(SUM("qyPt1Area")) as "qyPt1Area", --住宅签约面积(String)
            TO_CHAR(SUM("qyPt2Area")) as "qyPt2Area", --公寓签约面积(String)
            TO_CHAR(SUM("qyPt3Area")) as "qyPt3Area", --商业签约面积(String)
            TO_CHAR(SUM("qyPt4Area")) as "qyPt4Area", --车位签约面积(String)
            TO_CHAR(SUM("qyCount")) as "qyCount", --签约套数(String)
            TO_CHAR(SUM("qyPt1Count")) as "qyPt1Count", --住宅签约套数(String)
            TO_CHAR(SUM("qyPt2Count")) as "qyPt2Count", --公寓签约套数(String)
            TO_CHAR(SUM("qyPt3Count")) as "qyPt3Count", --商业签约套数(String)
            TO_CHAR(SUM("qyPt4Count")) as "qyPt4Count", --车位签约套数(String)
            TO_CHAR(SUM("rgCount")) as "rgCount", --认购套数(String)
            TO_CHAR(SUM("rgPt1Count")) as "rgPt1Count", --住宅认购套数(String)
            TO_CHAR(SUM("rgPt2Count")) as "rgPt2Count", --公寓认购套数(String)
            TO_CHAR(SUM("rgPt3Count")) as "rgPt3Count", --商业认购套数(String)
            TO_CHAR(SUM("rgPt4Count")) as "rgPt4Count", --车位认购套数(String)
            TO_CHAR(SUM("rgNoQyCount")) as "rgNoQyCount", --认购未签约套数(String)
            TO_CHAR(SUM("rgNoQyPt1Count")) as "rgNoQyPt1Count", --住宅认购未签约套数(String)
            TO_CHAR(SUM("rgNoQyPt2Count")) as "rgNoQyPt2Count", --公寓认购未签约套数(String)
            TO_CHAR(SUM("rgNoQyPt3Count")) as "rgNoQyPt3Count", --商业认购未签约套数(String)
            TO_CHAR(SUM("rgNoQyPt4Count")) as "rgNoQyPt4Count", --车位认购未签约套数(String)
            TO_CHAR(SUM("ylCount")) as "ylCount", --预留套数(String)
            TO_CHAR(SUM("ylPt1Count")) as "ylPt1Count", --住宅预留套数(String)
            TO_CHAR(SUM("ylPt2Count")) as "ylPt2Count", --公寓预留套数(String)
            TO_CHAR(SUM("ylPt3Count")) as "ylPt3Count", --商业预留套数(String)
            TO_CHAR(SUM("ylPt4Count")) as "ylPt4Count" --车位预留套数(String)
        from MDM_BUILD mb
        inner join (
            select
                sum(case when SALE_STATE = '待售' then 1 else 0 end) "forSaleCount", --待售套数
                sum(case when PRODUCT_NAME = '住宅' and SALE_STATE = '待售' then 1 else 0 end) "forSalePt1Count",-- 住宅待售套数
                sum(case when PRODUCT_NAME = '公寓' and SALE_STATE = '待售' then 1 else 0 end) "forSalePt2Count",-- 公寓待售套数
                sum(case when PRODUCT_NAME = '商办' and SALE_STATE = '待售' then 1 else 0 end) "forSalePt3Count",-- 商业待售套数
                sum(case when PRODUCT_NAME = '车位' and SALE_STATE = '待售' then 1 else 0 end) "forSalePt4Count",-- 车位待售套数
                sum(case when SALE_STATE = '签约' then 1 else 0 end) "qyCount", --签约套数(String)
                sum(case when PRODUCT_NAME = '住宅' and SALE_STATE = '签约' then 1 else 0 end) "qyPt1Count",-- 住宅签约套数
                sum(case when PRODUCT_NAME = '公寓' and SALE_STATE = '签约' then 1 else 0 end) "qyPt2Count",-- 公寓签约套数
                sum(case when PRODUCT_NAME = '商办' and SALE_STATE = '签约' then 1 else 0 end) "qyPt3Count",-- 商办签约套数
                sum(case when PRODUCT_NAME = '车位' and SALE_STATE = '签约' then 1 else 0 end) "qyPt4Count",-- 车位签约套数
                sum(case when SALE_STATE = '认购' or SALE_STATE = '签约' then 1 else 0 end) "rgCount", --认购套数(String)
                sum(case when PRODUCT_NAME = '住宅' and (SALE_STATE = '认购' or SALE_STATE = '签约') then 1 else 0 end) "rgPt1Count",-- 住宅认购套数
                sum(case when PRODUCT_NAME = '公寓' and (SALE_STATE = '认购' or SALE_STATE = '签约') then 1 else 0 end) "rgPt2Count",-- 公寓认购套数
                sum(case when PRODUCT_NAME = '商办' and (SALE_STATE = '认购' or SALE_STATE = '签约') then 1 else 0 end) "rgPt3Count",-- 商办认购套数
                sum(case when PRODUCT_NAME = '车位' and (SALE_STATE = '认购' or SALE_STATE = '签约') then 1 else 0 end) "rgPt4Count",-- 车位认购套数
                sum(case when SALE_STATE = '认购' then 1 else 0 end) "rgNoQyCount", --认购未签约套数(String)
                sum(case when PRODUCT_NAME = '住宅' and SALE_STATE = '认购' then 1 else 0 end) "rgNoQyPt1Count",-- 住宅认购未签约套数
                sum(case when PRODUCT_NAME = '公寓' and SALE_STATE = '认购' then 1 else 0 end) "rgNoQyPt2Count",-- 公寓认购未签约套数
                sum(case when PRODUCT_NAME = '商办' and SALE_STATE = '认购' then 1 else 0 end) "rgNoQyPt3Count",-- 商办认购未签约套数
                sum(case when PRODUCT_NAME = '车位' and SALE_STATE = '认购' then 1 else 0 end) "rgNoQyPt4Count",-- 车位认购未签约套数
                sum(case when SALE_STATE = '销控' then 1 else 0 end) "ylCount", --预留套数(String)
                sum(case when PRODUCT_NAME = '住宅' and SALE_STATE = '销控' then 1 else 0 end) "ylPt1Count",-- 住宅预留套数
                sum(case when PRODUCT_NAME = '公寓' and SALE_STATE = '销控' then 1 else 0 end) "ylPt2Count",-- 公寓预留套数
                sum(case when PRODUCT_NAME = '商办' and SALE_STATE = '销控' then 1 else 0 end) "ylPt3Count",-- 商办预留套数
                sum(case when PRODUCT_NAME = '车位' and SALE_STATE = '销控' then 1 else 0 end) "ylPt4Count",-- 车位预留套数
                count(1) "totalCount", --房源套数合计(String)
                sum(case when PRODUCT_NAME = '住宅' then 1 else 0 end) "totalPt1Count", --房源住宅套数(String)
                sum(case when PRODUCT_NAME = '公寓' then 1 else 0 end) "totalPt2Count", --房源公寓套数(String)
                sum(case when PRODUCT_NAME = '商办' then 1 else 0 end) "totalPt3Count", --房源商业套数(String)
                sum(case when PRODUCT_NAME = '车位' then 1 else 0 end) "totalPt4Count", --房源车位套数(String)
                sum(NEW_BLD_AREA) "totalArea", --房源面积合计(String)
                sum(case when PRODUCT_NAME = '住宅' then NEW_BLD_AREA else 0 end) "totalPt1Area",-- 房源住宅面积
                sum(case when PRODUCT_NAME = '公寓' then NEW_BLD_AREA else 0 end) "totalPt2Area",-- 房源公寓面积
                sum(case when PRODUCT_NAME = '商办' then NEW_BLD_AREA else 0 end) "totalPt3Area",-- 房源商业面积
                sum(case when PRODUCT_NAME = '车位' then NEW_BLD_AREA else 0 end) "totalPt4Area",-- 房源车位面积
                sum(case when SALE_STATE = '签约' then NEW_BLD_AREA else 0 end) "qyArea", --签约面积(String)
                sum(case when PRODUCT_NAME = '住宅' and SALE_STATE = '签约' then NEW_BLD_AREA else 0 end) "qyPt1Area", --住宅签约面积(String)
                sum(case when PRODUCT_NAME = '公寓' and SALE_STATE = '签约' then NEW_BLD_AREA else 0 end) "qyPt2Area", --公寓签约面积(String)
                sum(case when PRODUCT_NAME = '商办' and SALE_STATE = '签约' then NEW_BLD_AREA else 0 end) "qyPt3Area", --商业签约面积(String)
                sum(case when PRODUCT_NAME = '车位' and SALE_STATE = '签约' then NEW_BLD_AREA else 0 end) "qyPt4Area", --车位签约面积(String)
                BUILDING_ID
            from MDM_ROOM tmr
            group by BUILDING_ID
        ) mr on mb.ID = mr.BUILDING_ID
        inner join SYS_PROJECT  sp on mb.PROJ_ID = sp.ID
        where sp.id = vProjectGuid
        group by PROJECT_NAME, PROJ_ID;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_EXT_STAGE_BUILDING
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_EXT_STAGE_BUILDING" (
    info out sys_refcursor
)
    --18. 获取项目、分期、楼栋	/REST/http-listProjectStageBuilding.ac
    -- 注意isParent的值为字符串 避免java接收到BigDecimal
    is
begin
    open info for
        -- 公司
        with unit as (
            select
                '1' as "isParent",
                sbu.ORG_NAME as "name",
                sbu.PARENT_ID as "pId",
                null as "unitName",
                null as "cityCode",
                null as "cityName",
                null as "unitId",
                null as "parentType",
                null as "stageId",
                null as "sn",
                sbu.ID as "id",
                'unit' as "nodeType"
            from SYS_BUSINESS_UNIT sbu
            where IS_COMPANY=1
        ),
             -- 项目
             project as (
                 select
                     '1' as "isParent",
                     sp.PROJECT_NAME as "name",
                     UPPER(sp.UNIT_ID) as "pId",
                     sp.UNIT_NAME as "unitName",
                     sp.CITY_CODE as "cityCode",
                     sp.CITY_NAME as "cityName",
                     UPPER(sp.UNIT_ID) as "unitId",
                     null as "parentType",
                     null as "stageId",
                     sp.SN*1 as "sn",
                     sp.ID as "id",
                     'project' as "nodeType"
                 from SYS_PROJECT sp
                 inner join unit on sp.UNIT_ID = unit."id"
             ),
             -- 分期
             stage as (
                 select
                     '1' as "isParent",
                     sps.STAGE_NAME as "name",
                     mpm.R_PROJ_ID as "pId",
                     null as "unitName",
                     null as "cityCode",
                     null as "cityName",
                     null as "unitId",
                     null as "parentType",
                     null as "stageId",
                     sps.SN as "sn",
                     sps.ID as "id",
                     'stage' as "nodeType"
                 from SYS_PROJECT_STAGE sps
                 left join MDM_PROJ_MAPPING mpm on mpm.PROJECT_ORIGINAL_ID = sps.PROJECT_ID
                 inner join project on sps.PROJECT_ID = project."id"
             ),
             --楼栋
             building as (
                 select
                     '0' as "isParent",
                     BUILD_NAME as "name",
                     sb.PERIOD_ID as "pId",
                     null as "unitName",
                     null as "cityCode",
                     null as "cityName",
                     null as "unitId",
                     'stage' as "parentType",
                     stage."id" as  "stageId",
                     null as sn,
                     sb.ID as "id",
                     'building' as "nodeType"
                 from SYS_BUILD sb
                 inner join stage on sb.PERIOD_ID = stage."id"
             )
        select "isParent", "name", "pId", "unitName", "cityCode", "cityName", "unitId", "parentType", "stageId",
               "sn", R_PROJ_ID "id", "nodeType" from project
        left join MDM_PROJ_MAPPING mpm on mpm.PROJECT_ORIGINAL_ID = project."id"
        union select * from stage
        union select * from building;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_EXT_STAGE_BUILDING_TREE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_EXT_STAGE_BUILDING_TREE" (
    info out sys_refcursor
)
-- 注意isParent的值为字符串 避免java接收到BigDecimal
    is
begin
    open info for
        -- 公司
        with unit as (
            select
                '1' as "isParent",
                sbu.ORG_NAME as "name",
                UPPER(sbu.PARENT_ID) as "pId",
                null as "unitName",
                null as "cityCode",
                null as "cityName",
                null as "unitId",
                null as "parentType",
                null as "stageId",
                null as "sn",
                UPPER(sbu.ID) as "id",
                'unit' as "nodeType"
            from SYS_BUSINESS_UNIT sbu
            where IS_COMPANY=1
        ),
             -- 项目
             project as (
                 select
                     '1' as "isParent",
                     sp.PROJECT_NAME as "name",
                     UPPER(sp.UNIT_ID) as "pId",
                     sp.UNIT_NAME as "unitName",
                     sp.CITY_CODE as "cityCode",
                     sp.CITY_NAME as "cityName",
                     UPPER(sp.UNIT_ID) as "unitId",
                     null as "parentType",
                     null as "stageId",
                     sp.SN*1 as "sn",
                     mpm.R_PROJ_ID as "id",
                     'project' as "nodeType"
                 from SYS_PROJECT sp
                 left join MDM_PROJ_MAPPING mpm on mpm.PROJECT_ORIGINAL_ID = sp.ID
                 inner join unit on UPPER(sp.UNIT_ID) = unit."id"
             ),
             -- 分期
             stage as (
                 select
                     '1' as "isParent",
                     sps.STAGE_NAME as "name",
                     mpm.R_PROJ_ID as "pId",
                     null as "unitName",
                     null as "cityCode",
                     null as "cityName",
                     null as "unitId",
                     null as "parentType",
                     null as "stageId",
                     sps.SN as "sn",
                     sps.ID as "id",
                     'stage' as "nodeType"
                 from SYS_PROJECT_STAGE sps
                 left join MDM_PROJ_MAPPING mpm on mpm.PROJECT_ORIGINAL_ID = sps.PROJECT_ID
                 inner join project on sps.PROJECT_ID = project."id"
             ),
             --楼栋
             building as (
                 select
                     '0' as "isParent",
                     BUILD_NAME as "name",
                     sb.PERIOD_ID as "pId",
                     null as "unitName",
                     null as "cityCode",
                     null as "cityName",
                     null as "unitId",
                     'stage' as "parentType",
                     stage."id" as  "stageId",
                     null as sn,
                     sb.ID as "id",
                     'building' as "nodeType"
                 from SYS_BUILD sb
                 inner join stage on sb.PERIOD_ID = stage."id"
             )
        select * from unit
        union select * from project
        union select * from stage
        union select * from building;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_EXT_STAGE_CAP_BUILD
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_EXT_STAGE_CAP_BUILD" (
    info out sys_refcursor,
    stageGuid in varchar -- 项目id
)
as
    -- 27.获取项目下的车位&楼栋信息 /REST/getStageInfoByStageId
    -- notes: 存在多条数据，也只会返回第一条数据
    -- @auth hanjm
begin
    open info for
        select
            sp.PROJECT_NAME as "title", --项目名称(String)
            TO_CHAR(count(*)) as "count", --合计（默认返回“0”）(String)
            TO_CHAR(SUM("totalArea")) as "totalArea", --房源面积合计(String)
            TO_CHAR(SUM("totalPt1Area")) as "totalPt1Area", --房源住宅面积(String)
            TO_CHAR(SUM("totalPt2Area")) as "totalPt2Area", --房源公寓面积(String)
            TO_CHAR(SUM("totalPt3Area")) as "totalPt3Area", --房源商业面积(String)
            TO_CHAR(SUM("totalPt4Area")) as "totalPt4Area", --房源车位面积(String)
            TO_CHAR(SUM("totalCount")) as "totalCount", --房源套数合计(String)
            TO_CHAR(SUM("totalPt1Count")) as "totalPt1Count", --房源住宅套数(String)
            TO_CHAR(SUM("totalPt2Count")) as "totalPt2Count", --房源公寓套数(String)
            TO_CHAR(SUM("totalPt3Count")) as "totalPt3Count", --房源商业套数(String)
            TO_CHAR(SUM("totalPt4Count")) as "totalPt4Count", --房源车位套数(String)
            TO_CHAR(SUM("forSaleCount")) as "forSaleCount", --待售套数(String)
            TO_CHAR(SUM("forSalePt1Count")) as "forSalePt1Count", --住宅待售套数(String)
            TO_CHAR(SUM("forSalePt2Count")) as "forSalePt2Count", --公寓待售套数(String)
            TO_CHAR(SUM("forSalePt3Count")) as "forSalePt3Count", --商业待售套数(String)
            TO_CHAR(SUM("forSalePt4Count")) as "forSalePt4Count", --车位待售套数(String)
            TO_CHAR(SUM("qyArea")) as "qyArea", --签约面积(String)
            TO_CHAR(SUM("qyPt1Area")) as "qyPt1Area", --住宅签约面积(String)
            TO_CHAR(SUM("qyPt2Area")) as "qyPt2Area", --公寓签约面积(String)
            TO_CHAR(SUM("qyPt3Area")) as "qyPt3Area", --商业签约面积(String)
            TO_CHAR(SUM("qyPt4Area")) as "qyPt4Area", --车位签约面积(String)
            TO_CHAR(SUM("qyCount")) as "qyCount", --签约套数(String)
            TO_CHAR(SUM("qyPt1Count")) as "qyPt1Count", --住宅签约套数(String)
            TO_CHAR(SUM("qyPt2Count")) as "qyPt2Count", --公寓签约套数(String)
            TO_CHAR(SUM("qyPt3Count")) as "qyPt3Count", --商业签约套数(String)
            TO_CHAR(SUM("qyPt4Count")) as "qyPt4Count", --车位签约套数(String)
            TO_CHAR(SUM("rgCount")) as "rgCount", --认购套数(String)
            TO_CHAR(SUM("rgPt1Count")) as "rgPt1Count", --住宅认购套数(String)
            TO_CHAR(SUM("rgPt2Count")) as "rgPt2Count", --公寓认购套数(String)
            TO_CHAR(SUM("rgPt3Count")) as "rgPt3Count", --商业认购套数(String)
            TO_CHAR(SUM("rgPt4Count")) as "rgPt4Count", --车位认购套数(String)
            TO_CHAR(SUM("rgNoQyCount")) as "rgNoQyCount", --认购未签约套数(String)
            TO_CHAR(SUM("rgNoQyPt1Count")) as "rgNoQyPt1Count", --住宅认购未签约套数(String)
            TO_CHAR(SUM("rgNoQyPt2Count")) as "rgNoQyPt2Count", --公寓认购未签约套数(String)
            TO_CHAR(SUM("rgNoQyPt3Count")) as "rgNoQyPt3Count", --商业认购未签约套数(String)
            TO_CHAR(SUM("rgNoQyPt4Count")) as "rgNoQyPt4Count", --车位认购未签约套数(String)
            TO_CHAR(SUM("ylCount")) as "ylCount", --预留套数(String)
            TO_CHAR(SUM("ylPt1Count")) as "ylPt1Count", --住宅预留套数(String)
            TO_CHAR(SUM("ylPt2Count")) as "ylPt2Count", --公寓预留套数(String)
            TO_CHAR(SUM("ylPt3Count")) as "ylPt3Count", --商业预留套数(String)
            TO_CHAR(SUM("ylPt4Count")) as "ylPt4Count" --车位预留套数(String)
        from MDM_BUILD mb
        inner join (
            select
                sum(case when SALE_STATE = '待售' then 1 else 0 end) "forSaleCount", --待售套数
                sum(case when PRODUCT_NAME = '住宅' and SALE_STATE = '待售' then 1 else 0 end) "forSalePt1Count",-- 住宅待售套数
                sum(case when PRODUCT_NAME = '公寓' and SALE_STATE = '待售' then 1 else 0 end) "forSalePt2Count",-- 公寓待售套数
                sum(case when PRODUCT_NAME = '商办' and SALE_STATE = '待售' then 1 else 0 end) "forSalePt3Count",-- 商业待售套数
                sum(case when PRODUCT_NAME = '车位' and SALE_STATE = '待售' then 1 else 0 end) "forSalePt4Count",-- 车位待售套数
                sum(case when SALE_STATE = '签约' then 1 else 0 end) "qyCount", --签约套数(String)
                sum(case when PRODUCT_NAME = '住宅' and SALE_STATE = '签约' then 1 else 0 end) "qyPt1Count",-- 住宅签约套数
                sum(case when PRODUCT_NAME = '公寓' and SALE_STATE = '签约' then 1 else 0 end) "qyPt2Count",-- 公寓签约套数
                sum(case when PRODUCT_NAME = '商办' and SALE_STATE = '签约' then 1 else 0 end) "qyPt3Count",-- 商办签约套数
                sum(case when PRODUCT_NAME = '车位' and SALE_STATE = '签约' then 1 else 0 end) "qyPt4Count",-- 车位签约套数
                sum(case when SALE_STATE = '认购' or SALE_STATE = '签约' then 1 else 0 end) "rgCount", --认购套数(String)
                sum(case when PRODUCT_NAME = '住宅' and (SALE_STATE = '认购' or SALE_STATE = '签约') then 1 else 0 end) "rgPt1Count",-- 住宅认购套数
                sum(case when PRODUCT_NAME = '公寓' and (SALE_STATE = '认购' or SALE_STATE = '签约') then 1 else 0 end) "rgPt2Count",-- 公寓认购套数
                sum(case when PRODUCT_NAME = '商办' and (SALE_STATE = '认购' or SALE_STATE = '签约') then 1 else 0 end) "rgPt3Count",-- 商办认购套数
                sum(case when PRODUCT_NAME = '车位' and (SALE_STATE = '认购' or SALE_STATE = '签约') then 1 else 0 end) "rgPt4Count",-- 车位认购套数
                sum(case when SALE_STATE = '认购' then 1 else 0 end) "rgNoQyCount", --认购未签约套数(String)
                sum(case when PRODUCT_NAME = '住宅' and SALE_STATE = '认购' then 1 else 0 end) "rgNoQyPt1Count",-- 住宅认购未签约套数
                sum(case when PRODUCT_NAME = '公寓' and SALE_STATE = '认购' then 1 else 0 end) "rgNoQyPt2Count",-- 公寓认购未签约套数
                sum(case when PRODUCT_NAME = '商办' and SALE_STATE = '认购' then 1 else 0 end) "rgNoQyPt3Count",-- 商办认购未签约套数
                sum(case when PRODUCT_NAME = '车位' and SALE_STATE = '认购' then 1 else 0 end) "rgNoQyPt4Count",-- 车位认购未签约套数
                sum(case when SALE_STATE = '销控' then 1 else 0 end) "ylCount", --预留套数(String)
                sum(case when PRODUCT_NAME = '住宅' and SALE_STATE = '销控' then 1 else 0 end) "ylPt1Count",-- 住宅预留套数
                sum(case when PRODUCT_NAME = '公寓' and SALE_STATE = '销控' then 1 else 0 end) "ylPt2Count",-- 公寓预留套数
                sum(case when PRODUCT_NAME = '商办' and SALE_STATE = '销控' then 1 else 0 end) "ylPt3Count",-- 商办预留套数
                sum(case when PRODUCT_NAME = '车位' and SALE_STATE = '销控' then 1 else 0 end) "ylPt4Count",-- 车位预留套数
                count(1) "totalCount", --房源套数合计(String)
                sum(case when PRODUCT_NAME = '住宅' then 1 else 0 end) "totalPt1Count", --房源住宅套数(String)
                sum(case when PRODUCT_NAME = '公寓' then 1 else 0 end) "totalPt2Count", --房源公寓套数(String)
                sum(case when PRODUCT_NAME = '商办' then 1 else 0 end) "totalPt3Count", --房源商业套数(String)
                sum(case when PRODUCT_NAME = '车位' then 1 else 0 end) "totalPt4Count", --房源车位套数(String)
                sum(NEW_BLD_AREA) "totalArea", --房源面积合计(String)
                sum(case when PRODUCT_NAME = '住宅' then NEW_BLD_AREA else 0 end) "totalPt1Area",-- 房源住宅面积
                sum(case when PRODUCT_NAME = '公寓' then NEW_BLD_AREA else 0 end) "totalPt2Area",-- 房源公寓面积
                sum(case when PRODUCT_NAME = '商办' then NEW_BLD_AREA else 0 end) "totalPt3Area",-- 房源商业面积
                sum(case when PRODUCT_NAME = '车位' then NEW_BLD_AREA else 0 end) "totalPt4Area",-- 房源车位面积
                sum(case when SALE_STATE = '签约' then NEW_BLD_AREA else 0 end) "qyArea", --签约面积(String)
                sum(case when PRODUCT_NAME = '住宅' and SALE_STATE = '签约' then NEW_BLD_AREA else 0 end) "qyPt1Area", --住宅签约面积(String)
                sum(case when PRODUCT_NAME = '公寓' and SALE_STATE = '签约' then NEW_BLD_AREA else 0 end) "qyPt2Area", --公寓签约面积(String)
                sum(case when PRODUCT_NAME = '商办' and SALE_STATE = '签约' then NEW_BLD_AREA else 0 end) "qyPt3Area", --商业签约面积(String)
                sum(case when PRODUCT_NAME = '车位' and SALE_STATE = '签约' then NEW_BLD_AREA else 0 end) "qyPt4Area", --车位签约面积(String)
                BUILDING_ID
            from MDM_ROOM tmr
            group by BUILDING_ID
        ) mr on mb.ID = mr.BUILDING_ID
        inner join SYS_PROJECT_STAGE  sps on mb.PERIOD_ID = sps.ID
        inner join SYS_PROJECT sp on sp.ID = sps.PROJECT_ID
        where sps.id = stageGuid
        group by PROJECT_ID, PROJECT_NAME;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_GENERA_AUDIT_PERIOD
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_GENERA_AUDIT_PERIOD" (
    projectId in varchar
)
as
    v_existsPeriod number;
    v_projectId varchar(36) := projectId;
    v_creator varchar(32) := 'by system generated"';
    v_creatorId varchar(32) := 'generator';
    v_projectOriginalId varchar(36);
    v_periodVersionId varchar(36) := GET_UUID();
    v_periodId varchar(36) := GET_UUID();
begin
    -- 获取项目原始id
    select PROJECT_ORIGINAL_ID into v_projectOriginalId
    from MDM_PROJECT where id = v_projectId;

    select count(1) into v_existsPeriod from MDM_PERIOD where PROJECT_ORIGINAL_ID = v_projectOriginalId;
    -- 如果存在分期 退出
    if v_existsPeriod > 0 then
        return;
    end if;

    -- 插入分期版本
    insert into MDM_PERIOD_VERSION(ID, PROJECT_ID, PROJECT_ORIGINAL_ID, APPROVAL_STATUS, APPROVAL_TIME, APPROVER_ID,
                                   APPROVER, PERIOD_VERSION, CREATED, CREATOR_ID, CREATOR, MODIFIED, MODIFIER_ID,
                                   MODIFIER, PROJECT_VERSION)
    values (v_periodVersionId, v_projectId, v_projectOriginalId, '已审核', sysdate, v_creatorId, v_creator, 1,
            sysdate,v_creator, v_creatorId, null, null, null, 1);

    -- 插入无分期项目
    insert into MDM_PERIOD(ID, PERIOD_NAME, REMARKS, PERIOD_VERSION_ID, CREATED, CREATOR_ID, CREATOR, MODIFIED,
                           MODIFIER_ID, MODIFIER, IS_DELETE, PERIOD_ORIGINAL_ID, PERIOD_CODE, IS_FIRST_OPEN_PERIOD,
                           PROJECT_ORIGINAL_ID)
    values(v_periodId, '无分期', '维护分期时请将"无分期"调整为"1期"即可', v_periodVersionId, sysdate, v_creatorId,
           v_creator, null, null, null, 0, v_periodId, '01', 1, v_projectOriginalId);

    -- 添加宗地信息
    insert into MDM_OBJ_PARCEL_R(ID, OBJ_ID, OBJ_TYPE, PARCEL_ID, PARCEL_ORIGINAL_ID, BIND_OBJ_ID)
    select ID, OBJ_ID, OBJ_TYPE, PARCEL_ID, PARCEL_ORIGINAL_ID, BIND_OBJ_ID
    from (
          SELECT GET_UUID() id, v_periodId OBJ_ID, 20 OBJ_TYPE, mp1.ID PARCEL_ID, mp1.PARCEL_ORIGINAL_ID,
                 v_periodId BIND_OBJ_ID
          from MDM_PARCEL mp1
                   left join MDM_PROJECT mp2 on mp1.PROJECT_ID = mp2.ID
          where mp2.ID = v_projectId order by PARCEL_NAME
    ) where rownum < 2;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_GET_BLD_DATA_BY_PLATFORM
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_GET_BLD_DATA_BY_PLATFORM" (
    PROJ_PERIOD_ID IN NVARCHAR2, --分期ID
    PERMIT_TYPE    IN NVARCHAR2, --证照类型
    BLD_ID_TABLE   OUT SYS_REFCURSOR --返回值
) AS
BEGIN
    OPEN BLD_ID_TABLE FOR
        select
            mb.ID "bldId", mb.BUILD_NAME "bldName", null "bldCode", mb.PERIOD_NAME AS "projectName",
            SUBSTR(mopi.PRODUCT_TYPE_NAME, 1, INSTR(mopi.PRODUCT_TYPE_NAME, '/', 1, 1) - 1) "firstProductName",
            SUBSTR(mopi.PRODUCT_TYPE_NAME, INSTR(mopi.PRODUCT_TYPE_NAME, '/', 1, 1) + 1,
                   INSTR(mopi.PRODUCT_TYPE_NAME, '/', 1, 2) - INSTR(mopi.PRODUCT_TYPE_NAME, '/', 1, 1) - 1) AS "secondProductName",
            SUBSTR(mopi.PRODUCT_TYPE_NAME, DECODE(INSTR(mopi.PRODUCT_TYPE_NAME, '/', 1, 2), 0, 100,
                                                  INSTR(mopi.PRODUCT_TYPE_NAME, '/', 1, 2)) + 1) AS "thirdProductName",
            mopi.PRODUCT_TYPE_NAME AS "productFullName", mopi.PRODUCT_TYPE_ID AS "productId",
            decode(decode(PERMIT_TYPE,
                          '规划许可证', mb.IS_GET_CON_PLAN_PERMIT,
                          '施工许可证', mb.IS_GET_CONSTRCUTION_PERMIT,
                          '竣工备案证', mb.IS_GET_COMPLETED_PERMIT,
                          '预售许可证', mb.IS_GET_PRE_SALE_PERMIT,
                          ''), '1', '是','否') "isGetSalePermit",
            mopi.GROUND_TOTAL_BUILD_AREA+mopi.UNDERGROUND_TOTAL_BUILD_AREA "bldArea",
            mopi.GROUND_TOTAL_BUILD_AREA AS "bldAreaOn", mopi.UNDERGROUND_TOTAL_BUILD_AREA AS "bldAreaUnder",
            mopi.TOTAL_SALE_AREA AS "saleArea", mopi.GROUND_SALE_AREA AS "saleAreaOn",
            mopi.UNDERGROUND_SALE_AREA AS "saleAreaUnder", mr.PRE_SALE_BLD_AREA AS "preSaleBldArea",
            mr.PRE_SALE_BLD_AREA_ON AS "preSaleBldAreaOn", mr.PRE_SALE_BLD_AREA_UNDER AS "preSaleBldAreaUbder",
            mr.PRE_SALE_IN_AREA AS "preSaleInArea", mr.PRE_SALE_IN_AREA_ON AS "preSaleInAreaOn",
            mr.PRE_SALE_IN_AREA_UNDER AS "preSaleInAreaUnder", mr.ACTUAL_SALE_BLD_AREA AS "actualSaleBldArea",
            mr.ACTUAL_SALE_BLD_AREA_ON AS "actualSaleBldAreaOn",
            mr.ACTUAL_SALE_BLD_AREA_UNDER AS "actualSaleBldAreaUnber", mb.IS_GET_CON_PLAN_PERMIT,
            mb.IS_GET_CONSTRCUTION_PERMIT,mb.IS_GET_PRE_SALE_PERMIT,mb.IS_GET_COMPLETED_PERMIT
        from MDM_BUILD mb
        left join (
            select mbp1.*, max(PHASE_ORDER) over (partition by BUILD_ID) maxPhaseOrder
            from MDM_BUILD_PHASE mbp1
            where mbp1.PHASE_STATE = 19 or mbp1.PHASE_STATE=20
        ) mbp on mbp.BUILD_ID = mb.ID and maxPhaseOrder = PHASE_ORDER
        left join (
            SELECT mbpt.PRODUCT_TYPE_CODE, moppi.*
            FROM MDM_OBJ_PHASE_PT_INDEX moppi
            INNER JOIN MDM_BUILD_PRODUCT_TYPE mbpt ON moppi.PRODUCT_TYPE_ID = mbpt.ID
        ) mopi on mopi.OBJ_PHASE_ID = mbp.ID
        left join (
            SELECT mr1.BUILDING_ID,
                   mr1.BUILDING_NAME,
                   mr1.PRODUCT_CODE,
                   SUM(mr1.PRE_BLD_AREA)                                                   AS PRE_SALE_BLD_AREA,
                   SUM(CASE WHEN PRODUCT_IS_CW = 0 THEN mr1.PRE_BLD_AREA ELSE 0 END)       AS PRE_SALE_BLD_AREA_ON,
                   SUM(CASE WHEN PRODUCT_IS_CW = 1 THEN mr1.PRE_BLD_AREA ELSE 0 END)       AS PRE_SALE_BLD_AREA_UNDER,
                   SUM(mr1.PRE_IN_AREA)                                                    AS PRE_SALE_IN_AREA,
                   SUM(mr1.ACTUAL_BLD_AREA)                                                AS ACTUAL_SALE_BLD_AREA,
                   SUM(CASE WHEN PRODUCT_IS_CW = 0 THEN mr1.PRE_IN_AREA ELSE 0 END)        AS PRE_SALE_IN_AREA_ON,
                   SUM(CASE WHEN mr1.PRODUCT_IS_CW = 1 THEN mr1.PRE_IN_AREA ELSE 0 END)     AS PRE_SALE_IN_AREA_UNDER,
                   SUM(CASE WHEN mr1.PRODUCT_IS_CW = 0 THEN mr1.ACTUAL_BLD_AREA ELSE 0 END) AS ACTUAL_SALE_BLD_AREA_ON,
                   SUM(CASE WHEN mr1.PRODUCT_IS_CW = 1 THEN mr1.ACTUAL_BLD_AREA ELSE 0 END) AS ACTUAL_SALE_BLD_AREA_UNDER
            FROM MDM_ROOM mr1
            GROUP BY mr1.BUILDING_ID, mr1.BUILDING_NAME, mr1.PRODUCT_CODE
        ) mr ON mr.BUILDING_ID = mb.ID AND mr.PRODUCT_CODE = mopi.PRODUCT_TYPE_CODE
        where mb.BUILD_STATE = 10 and
            (mb.PERIOD_ID=PROJ_PERIOD_ID or mb.PROJ_ID=PROJ_PERIOD_ID)
        order by nvl(regexp_replace(substr(nvl(mb.BUILD_NAME, '0'), 0, 1) || mb.BUILD_NAME, '[^0-9]', ''), '999')*1;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_GET_BUILDS_BY_PROJECT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_GET_BUILDS_BY_PROJECT" 
(
    PROJECTID IN VARCHAR2
   ,ITEMS     OUT SYS_REFCURSOR
) IS
    --从销售系统抓取房间数据 创建根据项目ID获取楼栋数据存储过程
    --作者：鲜晓勇
    --日期：2020/01/13
BEGIN
OPEN ITEMS FOR
WITH  builds as(select id from(
                                --------------------小写
                                SELECT lower(Translate(r_build_id USING CHAR_CS)) as id FROM MDM_BUILD
                                /*union all
                                SELECT lower(Translate(id USING CHAR_CS)) as id FROM MDM_BUILD
                                union all
                                ----------------------大写
                                SELECT Translate(r_build_id USING CHAR_CS) as id FROM MDM_BUILD
                                union all
                                SELECT Translate(id USING CHAR_CS) as id FROM MDM_BUILD*/
                                )group by id order by id)
,base as (select* from (select id,rownum rowsn  from builds)),

第一批次 AS (
select id from base where rowsn<=1000

    )
,第二批次 as (
select id from base  where rowsn>1000 and rowsn<=2000
    )
,第三批次 as (
select id from base where rowsn>2000 and rowsn<=3000
     )
,第四批次 as (
select id from base where rowsn>3000 and rowsn<=4000
    )
,第五批次 as (
select id from base  where rowsn>4000 and rowsn<=5000
    )
,其他 as (select 'c7603a8392f24b93adee1ff02583f5fb' as id  from  dual)

select a.id as id from (
select * from 第一批次 where 1=1
union all
select * from 第二批次 where 1=1
union all
select * from 第三批次 where 1=1
union all
select * from 第四批次 where 1=1
union all
select * from 第五批次 where 1=1
union all
select * from 其他  where 1=1) a 
where a.id is not null
;

    --select '3c9f8ee72ab84ba9be19b7ea92e49e8f' as "id" from dual;
END P_MDM_GET_BUILDS_BY_PROJECT;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_GET_INVOLVE_PERMIT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_GET_INVOLVE_PERMIT" (
   permitType  IN NVARCHAR2 --证照类型
   ,planNodeId  IN NVARCHAR2 ---节点id
   ,items        OUT          SYS_REFCURSOR --返回值
) AS
BEGIN
    OPEN items FOR  select mp.id as "id" 
           from mdm_permit mp
           inner join(select ci.* from (select nf.*,n.id as nodeId,n.fission_source_original_id
               from POM_NODE_FEEDBACK nf
               inner join (select id, fission_source_original_id
                   from pom_proj_plan_node a
                   start with a.id = ''||planNodeId||''
                   CONNECT BY PRIOR a.fission_source_original_id = a.id
               ) n on nf.FEEDBACK_NODE_ID = n.id and n.id is not null and nf.APPROVAL_STATUS='已审核')s left join POM_CURRENT_EVIDENCE_INFO ci on ci.feedback_id=s.id
           ) f on mp.id = f.PERMIT_ID where mp.PERMIT_TYPE=''||permitType||'';
END;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_GET_PEMIT_BY_PROJECT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_GET_PEMIT_BY_PROJECT" (
    PROJECT_ID    IN           NVARCHAR2 , --项目or 分期id
    PERMIT_TYPE  IN NVARCHAR2 ,--证照类型
    items        OUT          SYS_REFCURSOR --返回值
) AS
    v_sql_exec         CLOB;
BEGIN
    v_sql_exec:='SELECT
                           id                AS "id",
                           permit_no         AS "permitNo",
                          to_char(permit_get_date,''yyyy-MM-dd'') as "permitGetDate",
                          to_char(created,''yyyy-MM-dd'') as "created",
                           creator           AS "creator",
                           bld_scope         AS "bldScope",
                           project_id        AS "projectId",
                           SALE_AREA         as "saleArea",
                           BLD_AREA          as   "bldArea",
                          APPROVAL_STATUS    as "approvalStatus"
                       FROM
                           mdm_permit
                       WHERE
                           1=1 AND permit_type='''||PERMIT_TYPE||'''';
	 IF ( PROJECT_ID IS NOT NULL ) THEN
    v_sql_exec:=v_sql_exec||'AND ( project_id = '''|| PROJECT_ID||'''
                                 OR stage_id = '''
                                               || PROJECT_ID
                                               || ''' ) ORDER BY created DESC';

    ELSE
        v_sql_exec:=v_sql_exec||'AND project_id = ''11111111111111111111''';
    END IF;
     dbms_output.put_line(v_sql_exec);
    OPEN items FOR v_sql_exec;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_GET_PERMIT_BLD_REF_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_GET_PERMIT_BLD_REF_DATA" 
(
    PROJ_PERIOD_ID      IN NVARCHAR2  --分期ID
   ,PERMIT_TYPE  IN NVARCHAR2 --证照类型
   ,BLD_ID_TABLE OUT SYS_REFCURSOR --返回值
) AS

BEGIN
    /*    OPEN BLD_ID_TABLE FOR
    SELECT '75948F49-61C3-E711-AC26-000C293C2531' AS BLD_ID
         , '一号楼' AS BLD_NAME, 'Q1.001' AS BLD_CODE, '一期' AS PROJECT_NAME
         , '住宅' AS FIRST_PRODUCT_NAME, '商品住宅' AS SECOND_PRODUCT_NAME
         , '高层I' AS THIRD_PRODUCT_NAME
         , '住宅-商品住宅-高层I' AS PRODUCT_FULL_NAME
         , GET_UUID( ) AS PRODUCT_ID, '否' AS IS_GET_SALE_PERMIT
         , 100.00 AS BLD_AREA, 90.00 AS BLD_AREA_ON, 10.00 AS BLD_AREA_UNDER
         , 90.00 AS SALE_AREA, 90.00 AS SALE_AREA_ON, 0.00 AS SALE_AREA_UNDER
         , 90.00 AS PRE_SALE_BLD_AREA, 90.00 AS PRE_SALE_BLD_AREA_ON
         , 0.00 AS PRE_SALE_BLD_AREA_UBDER, 79.00 AS PRE_SALE_IN_AREA
         , 79.00 AS PRE_SALE_IN_AREA_ON, 0.00 AS PRE_SALE_IN_AREA_UNDER
         , NULL AS ACTUAL_SALE_BLD_AREA, NULL AS ACTUAL_SALE_BLD_AREA_ON
         , NULL AS ACTUAL_SALE_BLD_AREA_UNBER, NULL AS ACTUAL_BLD_AREA
         , NULL AS ACTUAL_BLD_AREA_ON, NULL AS ACTUAL_BLD_AREA_UNDER
         , 10 AS BLD_ROOM_TOTAL, 10 AS CHOOSED_ROOM_TOTAL
      FROM DUAL;*/
    OPEN BLD_ID_TABLE FOR
        SELECT A.ID AS BLD_ID, A.BUILD_NAME AS BLD_NAME, NULL AS BLD_CODE,
               A.PERIOD_NAME AS PROJECT_NAME,
               SUBSTR(D.PRODUCT_TYPE_NAME, 1,
                       INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 1) - 1) AS FIRST_PRODUCT_NAME,
               SUBSTR(D.PRODUCT_TYPE_NAME,
                       INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 1) + 1,
                       INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 2) -
                        INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 1) - 1) AS SECOND_PRODUCT_NAME,
               SUBSTR(D.PRODUCT_TYPE_NAME,
                       DECODE(INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 2), 0, 100,
                               INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 2)) + 1) AS THIRD_PRODUCT_NAME,
               D.PRODUCT_TYPE_NAME AS PRODUCT_FULL_NAME,
               D.PRODUCT_TYPE_ID AS PRODUCT_ID, '否' AS IS_GET_SALE_NAME,
               D.BUILD_AREA AS BLD_AREA,
               D.GROUND_TOTAL_BUILD_AREA AS BLD_AREA_ON,
               D.UNDERGROUND_TOTAL_BUILD_AREA AS BLD_AREA_UNDER,
               D.TOTAL_SALE_AREA AS SALE_AREA,
               D.GROUND_SALE_AREA AS SALE_AREA_ON,
               D.UNDERGROUND_SALE_AREA AS SALE_AREA_UNDER,
               E.PRE_SALE_BLD_AREA, E.PRE_SALE_BLD_AREA_ON,
               E.PRE_SALE_BLD_AREA_UNDER, E.PRE_SALE_IN_AREA,
               E.PRE_SALE_IN_AREA_ON, E.PRE_SALE_IN_AREA_UNDER,
               E.ACTUAL_SALE_BLD_AREA, E.ACTUAL_SALE_BLD_AREA_ON,
               E.ACTUAL_SALE_BLD_AREA_UNDER

        FROM   MDM_BUILD A
        INNER  JOIN MDM_BUILD_PHASE B
        ON     A.ID = B.BUILD_ID
        INNER  JOIN MDM_OBJ_PHASE_INDEX C
        ON     C.OBJ_PHASE_ID = B.ID
        INNER  JOIN (SELECT B1.PRODUCT_TYPE_CODE, A1.*
                     FROM   MDM_OBJ_PHASE_PT_INDEX A1
                     INNER  JOIN MDM_BUILD_PRODUCT_TYPE B1
                     ON     A1.PRODUCT_TYPE_ID = B1.ID) D
        ON     D.OBJ_PHASE_ID = B.ID
        LEFT   JOIN (SELECT A2.BUILDING_ID, A2.BUILDING_NAME, A2.PRODUCT_CODE, SUM(A2.PRE_BLD_AREA) AS PRE_SALE_BLD_AREA,
										SUM(CASE
														WHEN PRODUCT_IS_CW = 0 THEN
														 A2.PRE_BLD_AREA
														ELSE
														 0
												END) AS PRE_SALE_BLD_AREA_ON,
										SUM(CASE
														WHEN PRODUCT_IS_CW = 1 THEN
														 A2.PRE_BLD_AREA
														ELSE
														 0
												END) AS PRE_SALE_BLD_AREA_UNDER, SUM(A2.PRE_IN_AREA) AS PRE_SALE_IN_AREA,
										SUM(CASE
														WHEN PRODUCT_IS_CW = 0 THEN
														 A2.PRE_IN_AREA
														ELSE
														 0
												END) AS PRE_SALE_IN_AREA_ON,
										SUM(CASE
														WHEN A2.PRODUCT_IS_CW = 1 THEN
														 A2.PRE_IN_AREA
														ELSE
														 0
												END) AS PRE_SALE_IN_AREA_UNDER, SUM(A2.ACTUAL_BLD_AREA) AS ACTUAL_SALE_BLD_AREA,
										SUM(CASE
														WHEN A2.PRODUCT_IS_CW = 0 THEN
														 A2.ACTUAL_BLD_AREA
														ELSE
														 0
												END) AS ACTUAL_SALE_BLD_AREA_ON,
										SUM(CASE
														WHEN A2.PRODUCT_IS_CW = 1 THEN
														 A2.ACTUAL_BLD_AREA
														ELSE
														 0
												END) AS ACTUAL_SALE_BLD_AREA_UNDER

                     FROM   MDM_ROOM A2
                     GROUP  BY A2.BUILDING_ID, A2.BUILDING_NAME,
                               A2.PRODUCT_CODE) E
        ON     E.BUILDING_ID = A.ID AND
               E.PRODUCT_CODE = D.PRODUCT_TYPE_CODE
        LEFT   JOIN (SELECT B3.BUILD_ID, B3.ID AS OBJ_PHASE_ID, A3.BUILD_AREA,
                            A3.GROUND_TOTAL_BUILD_AREA,
                            A3.UNDERGROUND_TOTAL_BUILD_AREA
                     FROM   MDM_OBJ_PHASE_PT_INDEX A3
                     INNER  JOIN MDM_BUILD_PHASE B3
                     ON     A3.OBJ_PHASE_ID = B3.ID AND
                            B3.PHASE_NAME = '竣工备案证阶段') F
        ON     F.BUILD_ID = A.ID AND
               F.OBJ_PHASE_ID = B.ID
        WHERE  EXISTS (SELECT 1
                FROM   (SELECT ROW_NUMBER() OVER(PARTITION BY A.ID ORDER BY C.PHASE_ORDER DESC) AS PRANK,
                                A.ID BUILDID, C.PHASE_ORDER PHASEORDER,
                                C.PHASE_NAME PHASENAME, C.ID PHASEID
                         FROM   MDM_BUILD A
                         INNER  JOIN MDM_BUILD_PHASE B
                         ON     A.ID = B.BUILD_ID
                         INNER  JOIN MDM_PHASE C
                         ON     B.PHASE_ID = C.ID) P
                WHERE  P.PRANK = 1 AND
                       P.PHASEID = B.PHASE_ID AND
                       P.BUILDID = A.ID) AND A.BUILD_STATE = 10
                       AND
               (A.PERIOD_ID =''||PROJ_PERIOD_ID||''  OR A.PROJ_ID=''||PROJ_PERIOD_ID||'')
        ORDER  BY BUILD_NAME;


END;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_GET_PERMIT_BUILD
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_GET_PERMIT_BUILD" (PROJ_PERIOD_ID IN NVARCHAR2 --分期ID
                                         , PERMIT_TYPE IN NVARCHAR2 --证照类型
                                         , FEEDBACK_NODE_ID IN NVARCHAR2-- 反馈ID
                                         , BLD_ID_TABLE OUT SYS_REFCURSOR --返回值
) AS
    permitType varchar(36) := PERMIT_TYPE;
    projPeriodId varchar(100):=PROJ_PERIOD_ID;
    feedbackNodeId varchar(100):=FEEDBACK_NODE_ID;
BEGIN
    OPEN BLD_ID_TABLE FOR
      SELECT DISTINCT a.id AS "bldId",BUILD_NAME AS "bldName",a.period_name AS "projectName"
,''AS "firstProductName"

,'' AS "secondProductName"
,''AS "thirdProductName"
,'' AS "productFullName",'' AS "productId",CASE WHEN case when a2.id is null then 0 else 1 end =1 THEN '是'  else  '否' end as "isGetSalePermit"
,0 AS "bldArea"
,0 AS "bldAreaOn"
,0 AS "bldAreaUnder"
,
                0 AS "saleArea",
                0 AS "saleAreaOn",
                0 AS "saleAreaUnder",
                0 AS "preSaleBldArea",
                0 AS "preSaleBldAreaOn",
                0 AS "preSaleBldAreaUbder",
                0 AS "preSaleInArea",
                0 AS "preSaleInAreaOn",
                0 AS "preSaleInAreaUnder",
                0 AS "actualSaleBldArea",
                0 AS "actualSaleBldAreaOn",
                0 AS "actualSaleBldAreaUnber",
                case when a2.id is null then 0 else 1 end  as is_get_con_plan_permit,
                case when a2.id is null then 0 else 1 end  as is_get_constrcution_permit,
                case when a2.id is null then 0 else 1 end  as is_get_pre_sale_permit,
                case when a2.id is null then 0 else 1 end   as is_get_completed_permit
								,  case when a2.id is null then 0 else 1 end "isDisabled"
								
										,   permit_id AS "permitId"
								, permit_no AS "permitNO"
								, permit_type
FROM MDM_BUILD a 
LEFT JOIN SYS_PROJECT b on a.PROJ_ID=  b.id
LEFT JOIN

(
 
SELECT  *  FROM (
SELECT a.id
--,BUILD_NAME,IS_GET_CON_PLAN_PERMIT ,GET_CON_PLAN_PERMIT_DATE
,'规划许可证'  as "PERMIT_TYPE" ,C.id as permit_id,permit_no as permit_no FROM MDM_BUILD  a  LEFT  JOIN MDM_PERMIT_BLD b on a.id=bld_id 
LEFT JOIN  MDM_PERMIT c on c.id=PERMIT_ID  AND C.APPROVAL_STATUS<>'未审核'   AND  PERMIT_TYPE=''||permitType||''
where (PROJ_ID=''||projPeriodId||'' or PERIOD_ID= ''||projPeriodId||'') and nvl(IS_GET_CON_PLAN_PERMIT,0)=1

UNION ALL 
--是否取施工许可证
SELECT a.id
--,BUILD_NAME,IS_GET_CONSTRCUTION_PERMIT,GET_CONSTRCUTION_PERMIT_DATE
,'施工许可证',C.id as permit_id,permit_no as permit_no FROM MDM_BUILD  a  LEFT  JOIN MDM_PERMIT_BLD b on a.id=bld_id 
LEFT JOIN  MDM_PERMIT c on c.id=PERMIT_ID  AND C.APPROVAL_STATUS<>'未审核'    
AND  PERMIT_TYPE=''||permitType||''
where (PROJ_ID=''||projPeriodId||'' or PERIOD_ID= ''||projPeriodId||'')
and nvl(IS_GET_CONSTRCUTION_PERMIT,0)=1 

 UNION ALL 
--是否取预售许可证
SELECT a.id
--,BUILD_NAME,IS_GET_PRE_SALE_PERMIT,GET_PRE_SALE_PERMIT_DATE
,'预售许可证',C.id as permit_id,permit_no as permit_no FROM MDM_BUILD  a  LEFT  JOIN MDM_PERMIT_BLD b on a.id=bld_id 
LEFT  JOIN  MDM_PERMIT c on c.id=PERMIT_ID AND C.APPROVAL_STATUS<>'未审核'    AND  PERMIT_TYPE=''||permitType||''
where (PROJ_ID=''||projPeriodId||'' or PERIOD_ID= ''||projPeriodId||'')
AND C.APPROVAL_STATUS<>'未审核' 
and nvl(IS_GET_PRE_SALE_PERMIT,0)=1 
AND  PERMIT_TYPE=(
 SELECT PERMIT_TYPE  FROM POM_PROJ_PLAN_NODE  a   where a.id =''||FEEDBACK_NODE_ID||'' )
UNION ALL 
--是否竣工备案证
SELECT a.id
--,BUILD_NAME,IS_GET_COMPLETED_PERMIT,GET_COMPLETED_PERMIT_DATE
,'竣工备案证',C.id as permit_id,permit_no as permit_no FROM MDM_BUILD  a  LEFT  JOIN MDM_PERMIT_BLD b on a.id=bld_id 
LEFT  JOIN  MDM_PERMIT c on c.id=PERMIT_ID  
 AND C.APPROVAL_STATUS<>'未审核'   AND  PERMIT_TYPE=''||permitType||''
where (PROJ_ID=''||projPeriodId||'' or PERIOD_ID= ''||projPeriodId||'')
and nvl(IS_GET_COMPLETED_PERMIT,0)=1 


) a1  where    PERMIT_TYPE=(
 SELECT PERMIT_TYPE  FROM POM_PROJ_PLAN_NODE  a   where a.id =''||FEEDBACK_NODE_ID||'' )
 
 
UNION ALL 
 /*本次取证楼栋*/
SELECT c.BLD_ID,PERMIT_TYPE, b.id as permit_id,permit_no as permit_no  FROM POM_CURRENT_EVIDENCE_INFO a INNER JOIN  MDM_PERMIT b  on a.PERMIT_ID=b.id and PERMIT_TYPE=''||permitType||''
INNER JOIN MDM_PERMIT_BLD c on c.PERMIT_ID=b.id
INNER JOIN MDM_BUILD d on d.id=bld_id
WHERE b.APPROVAL_STATUS<>'未审核'
and (PROJ_ID=''||projPeriodId||'' or PERIOD_ID= ''||projPeriodId||'')
 
AND PERMIT_TYPE=(
 SELECT PERMIT_TYPE  FROM POM_PROJ_PLAN_NODE  a   where a.id =''||FEEDBACK_NODE_ID||'' )
 
 
 ) a2   on  a2.id=a.id

where (PROJ_ID=''||projPeriodId||''  or PERIOD_ID= ''||projPeriodId||'' )   
ORDER BY 2
;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_GET_PROJ_TJ
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_GET_PROJ_TJ" (
info   OUT         SYS_REFCURSOR
) AS
BEGIN
  OPEN info FOR 
  SELECT 
A.ID,
A.COMPANY_NAME AS COMPANY_NAME,--公司名
A.PROJECT_NAME AS PROJECT_NAME,--项目名
CASE 
  WHEN BUI.BUI_NUM IS NOT NULL AND BUI67.BUI67_NUM IS NOT NULL AND BUI.BUI_NUM = BUI67.BUI67_NUM THEN
    '竣工'
  WHEN PROJ.PROJ_NUM IS NULL THEN 
    '待建'
  WHEN BUI5.BUI5_NUM IS NOT NULL THEN 
    '在售'
  WHEN BUI5.BUI5_NUM IS NULL AND BUI34.BUI34_NUM IS NOT NULL THEN 
    '在建'
  ELSE
    '待建'
END STATUS,--项目状态
A.PROJ_COOPERATE AS PROJ_COOPERATE,--是否操盘
to_char(nvl(PAL.LAND_GET_DATE,A.PROJECT_GET_TIME),'YYYY-MM-DD') AS LAND_GET_DATE --拿地时间
FROM MDM_PROJECT A
LEFT JOIN (
SELECT B.PROJ_ID,COUNT(1) AS PROJ_NUM FROM MDM_PROJECT_PHASE B
WHERE B.PHASE_ORDER > 2
GROUP BY B.PROJ_ID
)PROJ ON A.PROJECT_ORIGINAL_ID = PROJ.PROJ_ID

LEFT JOIN (
SELECT D.PROJ_ID,COUNT(1) AS BUI5_NUM FROM MDM_BUILD_PHASE C
LEFT JOIN MDM_BUILD D ON C.BUILD_ID = D.ID AND D.BUILD_STATE = 10
WHERE C.PHASE_ORDER = 5
GROUP BY D.PROJ_ID)BUI5 ON A.PROJECT_ORIGINAL_ID = BUI5.PROJ_ID

LEFT JOIN (
SELECT D.PROJ_ID,COUNT(1) AS BUI34_NUM FROM MDM_BUILD_PHASE C
LEFT JOIN MDM_BUILD D ON C.BUILD_ID = D.ID AND D.BUILD_STATE = 10
WHERE C.PHASE_ORDER IN (3,4)
GROUP BY D.PROJ_ID)BUI34 ON A.PROJECT_ORIGINAL_ID = BUI34.PROJ_ID

LEFT JOIN (
SELECT E.PROJ_ID,COUNT(1) AS BUI67_NUM FROM （
SELECT D.PROJ_ID,C.BUILD_ID,COUNT(1) AS BUI67_NUM FROM MDM_BUILD_PHASE C
LEFT JOIN MDM_BUILD D ON C.BUILD_ID = D.ID AND D.BUILD_STATE = 10
WHERE C.PHASE_ORDER IN (6,7)
GROUP BY D.PROJ_ID,C.BUILD_ID
)E GROUP BY E.PROJ_ID)BUI67 ON A.PROJECT_ORIGINAL_ID = BUI67.PROJ_ID

LEFT JOIN (
SELECT M.PROJ_ID,COUNT(1) AS BUI_NUM  FROM MDM_BUILD M
GROUP BY M.PROJ_ID
)BUI ON A.PROJECT_ORIGINAL_ID = BUI.PROJ_ID

LEFT JOIN (
SELECT B.PROJECT_ID,B.PROJECT_ORIGINAL_ID,MIN(LAND_GET_DATE) AS LAND_GET_DATE FROM (
SELECT A.ID,A.PROJECT_ID,A.PROJECT_ORIGINAL_ID,MIN(LAND_GET_DATE) AS LAND_GET_DATE FROM MDM_PARCEL A
WHERE A.IS_DELETE = 0 
GROUP BY A.ID,A.PROJECT_ID,A.PROJECT_ORIGINAL_ID
)B GROUP BY B.PROJECT_ID,B.PROJECT_ORIGINAL_ID)PAL ON A.PROJECT_ORIGINAL_ID = PAL.PROJECT_ORIGINAL_ID AND A.ID = PAL.PROJECT_ID
WHERE A.APPROVAL_STATUS = '已审核' order by COMPANY_NAME,PROJECT_CODE;

END P_MDM_GET_PROJ_tj;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_HIT_DATA_MAINTAIN
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_HIT_DATA_MAINTAIN" (
    objId  IN VARCHAR2, --项目id
    phaseId IN VARCHAR2,--阶段ID
    items  OUT SYS_REFCURSOR --解析后阶段
)
--获取项目主数据维护历史版本列表
--作者：鲜晓勇
--日期：2020/6/23
AS
BEGIN
    open items FOR
            select 
            pv.id as "id",
            pv.obj_phase_version        AS "objPhaseVersion",
            pv.phase_name               AS "phaseName",
            pv.phase_id                 AS "phaseId",
            pv.version as "version",
            to_char(pvi.overall_floorage_area,'99999999999990.99')   AS "overallFloorageAreaAfter",
            to_char(pvi.TOTAL_SALE_AREA,'999999999999990.99') as "totalSaleAreaAfter",
            pvi.UNDERGROUND_TOTAL_SALE_CARPORT as "ungroundTotalSaleCarportAfter",
            to_char(lag(pvi.overall_floorage_area,1,null) over(order by pv.version asc),'99999999999990.99') as "overallFloorageAreaBefore",
            to_char(lag(pvi.TOTAL_SALE_AREA,1,null) over(order by pv.version asc),'99999999999990.99') as "totalSaleAreaBefore",
            lag(pvi.UNDERGROUND_TOTAL_SALE_CARPORT,1,null) over(order by pv.version asc) as "ungroundTotalSaleCarportBefore",
            to_char(pv.created,'yyyy-MM-dd') as "created",
            pv.creator as "creator",
            pv.phase_state as "phaseState"
                from (
                                 SELECT
                                        id ,
                                        obj_phase_version,     
                                        phase_name,       
                                        phase_id,        
                                        case when to_number(replace(obj_phase_version,'V',''))>0
                                            then to_number(replace(obj_phase_version,'V',''))
                                            else to_number(obj_phase_version) end as version,
                                        created,
                                        creator,
                                        OBJ_ID,
                                        obj_type,
                                        phase_state 
                                    FROM
                                        mdm_obj_phase_version 
                            ) pv
                                LEFT JOIN mdm_obj_phase_version_index   pvi ON pv.id = pvi.obj_phase_version_id
                                     WHERE
                                        pv.obj_type = 0 and PV.OBJ_ID=objId
                                    and  pv.phase_id=phaseId
                                    order BY pv.obj_phase_version  asc;
        END P_MDM_HIT_DATA_MAINTAIN;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_LICENSE_REGISTRATION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_LICENSE_REGISTRATION" (
    companyid     IN            VARCHAR2,--当前用户公司
    stationid     IN            VARCHAR2,---当前用户的岗位
    deptid        IN            VARCHAR2,---当前用户的部门
    bizcode       IN            VARCHAR2,---权限code
    userid        IN            VARCHAR2,---当前用户id
    projectids   IN            VARCHAR2,---项目名称
    searchparam   IN            VARCHAR2,--筛选条件
    licenseType   IN            VARCHAR2, --证照类型
    selectCompanyId IN          VARCHAR2,--当前选中的公司
    info         OUT           SYS_REFCURSOR,
    pageindex     IN            INT,
    pagesizes     IN            INT,
    total         OUT           INT
) IS
    --证照办理登记
    --作者：鲜晓勇
    -- change
    -- @date 2020-07-28 @note 修复分页
    --日期：2020/2/09
    v_sql_exec         CLOB;
    v_sql         CLOB;
    v_spid             VARCHAR2(200);---数据验证spid
    v_where            VARCHAR2(4000):=' where ';
    v_search           VARCHAR2(4000):='';  ---搜素sql
    v_license          VARCHAR2(4000):='';
    v_project          VARCHAR2(4000);
    v_type             VARCHAR2(4000);
    v_auth_sql         VARCHAR2(4000) :=' where';
    limit_start integer := greatest((pageindex-1) * pagesizes, 0);
    mdmRemote varchar(200);
    pomRemote varchar(200);
    v_stageIds varchar(4000);
BEGIN
    BEGIN
        --执行数据权限存储过程。拿到零时表id 用户连临时表鉴权
        --调用查询数据权限的存储过程,返回spid
        P_AUTH_BLOCK_PROJ_COMPANY(
                USERID => userid,
                STATIONID => stationid,
                DEPTID => deptid,
                COMPANYID => companyid,
                BIZCODE => bizcode,
                DATA_SPID_ID => v_spid
            );
        pomRemote := GET_JUMP_URL_DOMAIN('PC', 'POM');
        mdmRemote := GET_JUMP_URL_DOMAIN('PC', 'MDM');
        v_auth_sql:=' left join SYS_PROJECT_STAGE projs on mp.STAGE_ID=projs.id
                            --关联权限表结果
                            inner join (
                            select DISTINCT org_id AS orgid from TMP_AUTH_LIST where id = '''||v_spid||'''
                            ) org
                            on (case when projs.id is not null then projs.PROJECT_ID else mp.PROJECT_ID end)=org.orgId
                            or ps.ID = org.orgid';
        if(selectCompanyId is not null and projectids is null)THEN
            v_where:= '(case when ps.id  is null then mp.project_id else ps.project_id end) IN (' ||
                      'select id from  sys_project where UNIT_ID IN (' ||
                      'select ID from SYS_BUSINESS_UNIT sbu where IS_COMPANY = 1 ' ||
                      'start with sbu.id='''||selectCompanyId||'''' ||
                      'connect by prior sbu.ID = sbu.PARENT_ID)' ||
                      ')';
        elsif(projectids is not null)THEN
            FOR item IN (
                SELECT
                    regexp_substr('' || projectids || '', '[^,]+', 1, ROWNUM) AS id
                FROM
                    dual
                CONNECT BY
                        ROWNUM <= length(''
                        || projectids
                        || '') - length(regexp_replace(''
                                                           || projectids
                                                           || '', ',', '')) + 1
                ) LOOP
                    v_project:=v_project||''''||item.id||''',';
                END LOOP;
            v_project:=substr(v_project,1,length(v_project) -1 );
            begin
                select ''''||replace(wmsys.wm_concat(ID), ',', ''',''')||'''' into v_stageIds from SYS_PROJECT_STAGE
                where instr(projectids, PROJECT_ID) > 0;
                v_project := v_project || ',' || v_stageIds;
            exception when others then
                v_stageIds := null;
            end;
            v_where:=' (case when ps.id  is null then mp.project_id else ps.project_id end) IN('||v_project||')';
        elsif(projectids is null and selectCompanyId is null) THEN
            --           v_where:=' IN (''aaaaaaa'')';
            v_where:='';
        END if;
        if(licenseType <>'默认')
        THEN
            FOR item IN (
                SELECT
                    regexp_substr(''|| licenseType || '', '[^,]+', 1, ROWNUM) AS "type"
                FROM
                    dual
                CONNECT BY
                        ROWNUM <= length(''
                        || licenseType
                        || '') - length(regexp_replace(''
                                                           || licenseType
                                                           || '', ',', '')) + 1
                ) LOOP
                    v_type:=v_type||''''||item."type"||''',';
                END LOOP;
            v_type:=substr(v_type,1,length(v_type) -1 );
            v_license:=' PERMIT_TYPE IN('||v_type||')';
            --       v_license:=' AND PERMIT_TYPE IN ('||licenseType||')';
        elsif licenseType='默认' THEN
            v_license:='';
        END IF;
        if(searchParam is not null)THEN
            v_search:='(mp.PROJECT_NAME like ''%'
                || searchparam
                || '%'' or mp.PERMIT_TYPE like ''%'
                || searchparam
                || '%'' or mp.PERMIT_NO like ''%'
                || searchparam
                || '%'')';
        END IF;
        v_sql := '
select distinct *
from (
    SELECT mp.ID as "id",
    mp.PROJECT_ID as "projectId",
    mp.PROJECT_NAME  as "projectName",
    mp.PERMIT_TYPE as "permitType",
    mp.PERMIT_NO as "permitNo",
    mp.PERMIT_GET_DATE as "permitGetDate",
    mp.CREATOR_ID as "creatorId",
    mp.CREATOR as "creator",
    mp.CREATED as "created",
    mp.APPROVAL_STATUS as "approvalStatus",
    mp.APPROVER_ID as "approverId",
    mp.APPROVER as "approver",
    mp.APPROVAL_TIME as "approvalTime",
    mp.REMARK as "remark",
    mp.BID_SECTIONG as "bidSectiong",
    mp.CONSTRUCTION_UNTI as "constructionUnti",
    mp.CON_PLAN_PERMIT_NO as "conPlanPermitNo",
    mp.CONSTRUCTION_PERMIT_NO as "constructionPermitNo",
    mp.MODIFIER_ID as "modifierId",
    mp.MODIFIER as "modifier",
    mp.MODIFIED as "modified",
    mp.STAGE_NAME as "stageName",
    mp.BLD_SCOPE as "bldScope",
    mp.BLD_AREA as "bldArea",
    mp.SALE_AREA as "saleArea",
    mp.STAGE_ID as "stageId",
    case when mp.SYSTEM_ID = ''534e2b6a0d5bb4fec7d55f551f8930ab''
    then ''' || mdmRemote ||'/mdm/license-handle/license-handle/registration-detil?permitType=''||mp.permit_type||''&id=''||mp.id||''&cancelType=0&action=mdm_licensehandle_insert&companyId=''||sp.unit_id||''''
    else ''' || pomRemote ||'/pom/licence-feedback/licence-detail?cancelType=0&permitType=''||mp.permit_type||''&product=''||mp.project_name||''&permitNumber=''||mp.permit_no||''&id=''||mp.id||''''
    end as "openUrl",
    nvl(sa.cnt, 0) as "annex"
    FROM MDM_PERMIT mp
    left join POM_NODE_FEEDBACK feedback on mp.id=feedback.PERMIT_ID
    left join (
        select BIZ_ID, count(*) as cnt
        from SYS_ATTACHMENT sa1 inner join SYS_ATTACHMENT_GROUP sag1 on sa1.ATTACHMENT_GROUP_ID = sag1.ID
        group by BIZ_ID
    ) sa on sa.BIZ_ID = mp.id
    left join sys_project_stage ps on mp.stage_id=ps.id
    left join SYS_PROJECT sp on (case when ps.id is null then mp.project_id else ps.project_id end)=sp.id' ||
                 v_auth_sql || (case when (v_where||v_license||v_search) is null then '' else' where ' end) ||
                 v_where||(case when v_license is not null and v_where is not null then ' and ' else '' end) ||v_license||
                 (case when v_search is not null and v_license is not null then ' and ' else '' end) ||v_search ||'';
        v_sql := v_sql || ' order by sp.PROJECT_CODE, sp.PROJECT_NAME, ps.ORDER_CODE, mp.PERMIT_NO)';
        --获取总条数
        insert into TEST(ID, PROJ_NAME, SQL_STR) values(GET_UUID(), 'reg', v_sql);
        commit;
        EXECUTE IMMEDIATE 'SELECT count(1) from('
            || v_sql
            || ') a '
            INTO total;
        if pageindex != 0 and pagesizes != 0 then
            v_sql_exec := 'select * from (select a.*, rownum as rowno from ( ' || v_sql
                || ') a where '||total||' <= ' || limit_start||' or ROWNUM <= ' || (limit_start + pagesizes) ||
                          ')  where '||total||' < '||limit_start||' or rowno > ' || limit_start || '';
        else
            v_sql_exec := v_sql;
        end if;
        OPEN info FOR v_sql_exec;
    END;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_MAINTAIN_TO_VERSION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_MAINTAIN_TO_VERSION" (
    objPhaseId in varchar2, -- 对象id
    objPhaseType in varchar2, -- 对象类型
    version in varchar2, -- 版本
    userId in varchar2, -- 用户id
    username in varchar2, -- 用户名
    info out varchar2, -- 执行结果
    code out number
)
    -- 生成新的主数据版本数据
-- @note 脚本初始化
-- @date 2020-06-30 17:39:18
-- @author 韩金明
as
    tmpObjType varchar(36) := objPhaseType;
    projectId varchar2(36); --项目id
    phaseId varchar2(36); -- 项目阶段id
    isLatestVersion number(1); -- 是否为最新版本
    latestVersion varchar2(36); -- 对象最新版本
    existsRow number(8); -- 验证数据是否已添加
    isAudited number(1) := 1; --是否未审核 传入参数如果version以U1D开头 则创建未审核数据
    vVersion varchar(8) := version;
begin
    code := 200;
    info := '执行成功';
    -- 获取项目id
    begin
        if vVersion like 'U1D%' then
            vVersion := replace(vVersion, 'U1D', 'V');
            isAudited := 0;
        end if;
        begin
            if tmpObjType = '0' then
                select mpp.PROJ_ID, mpp.PHASE_ID into projectId, phaseId from MDM_PROJECT_PHASE mpp
                where id = objPhaseId;
            end if;
        exception when others then
            tmpObjType := '20';
        end;
        if tmpObjType = '20' then
            select mpv.PROJECT_ORIGINAL_ID, mpp.PHASE_ID into projectId, phaseId
            from MDM_PERIOD_VERSION mpv
                     left join MDM_PERIOD mp on mp.PERIOD_VERSION_ID = mpv.ID
                     left join MDM_PERIOD_PHASE mpp on mpp.PERIOD_ID = mp.PERIOD_ORIGINAL_ID
            where mpp.ID = objPhaseId and mpv.APPROVAL_STATUS='已审核';
        end if;
    exception when others then
        info := '未获取到项目信息';
        code := 501;
        return;
    end;
    -- 获取是否是最新版本
    begin
        select max(OBJ_PHASE_VERSION) into latestVersion  from MDM_OBJ_PHASE_VERSION where OBJ_ID = projectId;
        isLatestVersion := case when latestVersion = vVersion then 1 else 0 end;
    exception when others then
        isLatestVersion := 1;
    end;
    -- 判断数据是否已添加
    select count(1) into existsRow from MDM_OBJ_PHASE_VERSION
    where OBJ_ID = projectId and PHASE_ID = phaseId and OBJ_PHASE_VERSION = vVersion;
    if existsRow != 0 then
        code := 502;
        info := '数据已存在';
        return;
    end if;
    ------------------------------------------MDM_OBJ_PHASE_VERSION----------------------------------------------------
    -- 项目阶段向MDM_OBJ_PHASE_VERSION添加数据
    insert into MDM_OBJ_PHASE_VERSION(
        ID, OBJ_PHASE_ID, OBJ_ID, OBJ_TYPE, PHASE_ID, PHASE_NAME, PHASE_ORDER, CREATED, CREATOR_ID, CREATOR, PHASE_STATE,
        OBJ_PHASE_VERSION, IS_NEWEST, PLANE_FIGURE)
    select GET_UUID(), mpp1.ID, mpp1.PROJ_ID, '0', mpp1.PHASE_ID, mp1.PHASE_NAME, mpp1.PHASE_ORDER,
           SYSDATE, userId, username,
           (case when mpp1.PHASE_STATE=20 then 19 else mpp1.PHASE_STATE end) PHASE_STATE, vVersion,
           isLatestVersion, PLANE_FIGURE from MDM_PROJECT_PHASE mpp1
                                                  left join MDM_PHASE mp1 on mp1.ID = mpp1.PHASE_ID
    where PROJ_ID = projectId and PHASE_ID = phaseId;

    if isAudited = 0 then
        update MDM_OBJ_PHASE_VERSION set PHASE_STATE = 10
        where  PHASE_ID = phaseId and OBJ_PHASE_VERSION = vVersion
          and OBJ_ID in (
            select np.ID
            from MDM_OBJ_PHASE_VERSION mobv
                     left join (
                select sp.ID, sp.ID PROJECT_ID, '项目' oType from SYS_PROJECT sp
                union all select sb.ID, sb.PROJ_ID, '楼栋' oType from SYS_BUILD sb
                union all select sps.ID, sps.PROJECT_ID, '分期' oType from SYS_PROJECT_STAGE sps
                union all select sp.ID, sp.PROJECT_ID, '宗地' oType from SYS_PARCEL sp
            ) np on np.PROJECT_ID = mobv.OBJ_ID
            where OBJ_ID=projectId
        );
    end if;

    -- 分期阶段向MDM_OBJ_PHASE_VERSION添加数据
    insert into MDM_OBJ_PHASE_VERSION(
        ID, OBJ_PHASE_ID, OBJ_ID, OBJ_TYPE, PHASE_ID, PHASE_NAME, PHASE_ORDER, CREATED, CREATOR_ID, CREATOR, PHASE_STATE,
        OBJ_PHASE_VERSION, IS_NEWEST, PLANE_FIGURE)
    select GET_UUID(), mpp.ID,  PERIOD_ID, '20', PHASE_ID, mp2.PHASE_NAME, mpp.PHASE_ORDER, SYSDATE,
           userId, username, (case when mpp.PHASE_STATE=20 then 19 else mpp.PHASE_STATE end) PHASE_STATE,
           vVersion, isLatestVersion, null
    from MDM_PERIOD_PHASE mpp
             inner join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp.PERIOD_ID
             inner join MDM_PERIOD_VERSION mpv on mpv.ID = mp1.PERIOD_VERSION_ID
             left join MDM_PHASE mp2 on mp2.ID = mpp.PHASE_ID
    where mpv.PROJECT_ID = projectId and mpp.PHASE_ID = phaseId and mpv.APPROVAL_STATUS='已审核';

    -- 楼栋阶段向MDM_OBJ_PHASE_VERSION添加数据
    insert into MDM_OBJ_PHASE_VERSION(
        ID, OBJ_PHASE_ID, OBJ_ID, OBJ_TYPE, PHASE_ID, PHASE_NAME, PHASE_ORDER, CREATED, CREATOR_ID,
        CREATOR, PHASE_STATE,OBJ_PHASE_VERSION, IS_NEWEST, PLANE_FIGURE)
    select GET_UUID(), mbp.ID,  BUILD_ID, '30', PHASE_ID, mp2.PHASE_NAME, mbp.PHASE_ORDER, SYSDATE,
           userId, username, (case when mbp.PHASE_STATE=20 then 19 else mbp.PHASE_STATE end) PHASE_STATE,
           vVersion, isLatestVersion, null
    from MDM_BUILD_PHASE mbp
             inner join MDM_BUILD mb on mbp.BUILD_ID = mb.ID
             left join MDM_PHASE mp2 on mp2.ID = mbp.PHASE_ID
    where mb.PROJ_ID = projectId and mbp.PHASE_ID = phaseId;

    -- 宗地阶段向MDM_OBJ_PHASE_VERSION添加数据
    insert into MDM_OBJ_PHASE_VERSION(
        ID, OBJ_PHASE_ID, OBJ_ID, OBJ_TYPE, PHASE_ID, PHASE_NAME, PHASE_ORDER, CREATED, CREATOR_ID, CREATOR, PHASE_STATE,
        OBJ_PHASE_VERSION, IS_NEWEST, PLANE_FIGURE)
    select distinct GET_UUID(), mpp.ID, PAECEL_ID, '10', PHASE_ID, mp2.PHASE_NAME, mpp.PHASE_ORDER,
                    sysdate, userId, username,
                    (case when mpp.PHASE_STATE=20 then 19 else mpp.PHASE_STATE end) PHASE_STATE, vVersion,
                    isLatestVersion, null
    from MDM_PARCEL_PHASE mpp
             inner join MDM_PARCEL mp on mpp.PAECEL_ID = mp.PARCEL_ORIGINAL_ID
             left join MDM_PROJECT mp2 on mp2.ID = mp.PROJECT_ID
             left join MDM_PHASE mp2 on mp2.ID = mpp.PHASE_ID
    where mp.PROJECT_ORIGINAL_ID = projectId
      and mpp.PHASE_ID = phaseId and APPROVAL_STATUS='已审核';
    ------------------------------------------业态数据复制----------------------------------------------------
    -- 项目阶段向MDM_OBJ_PHASE_VERSION_PT_INDEX添加数据
    insert into MDM_OBJ_PHASE_VERSION_PT_INDEX(
        ID, OBJ_PHASE_VERSION_ID, PRODUCT_TYPE_ID, OPERATE_ATTRIBUTE_ID, OPERATE_ATTRIBUTE_NAME, BUILD_AREA,
        GROUND_CAPACITY_AREA, UNDERGROUND_CAPACITY_AREA, GROUND_UNCAPACITY_AREA, UNDERGROUND_UNCAPACITY_AREA,
        GROUND_TOTAL_BUILD_AREA, UNDERGROUND_TOTAL_BUILD_AREA, REFUGE_STOREY_AREA, MECHANICAL_FLOOR_AREA,
        EMPTY_SPACE_AREA, TOWER_BASEMENT_AREA, UNDERGROUND_GARAGE_AREA, STORAGE_AREA, STORAGE_TOTAL, TOTAL_SALE_AREA,
        GROUND_SALE_AREA, UNDERGROUND_SALE_AREA, TOTAL_GIVE_AREA, GROUND_GIVE_AREA, UNDERGROUND_GIVE_AREA,
        TOTAL_RESIDENCE, TOTAL_BUSINESS, GROUND_CARPORT, RESIDENCE_BOTTOM_CARPORT, PARKING_GARAGE_CARPORT,
        UNDERGROUND_RFJ_CARPORT, UNDERGROUND_RJ_CARPORT, UNDERGROUND_FRFJ_CARPORT, UNDERGROUND_FRJ_CARPORT,
        UNDERGROUND_R_SALE_CARPORT, UNDERGROUND_FRFJ_SALE_CARPORT, UNDERGROUND_FRJ_SALE_CARPORT, CARPORT_TOTAL,
        GROUND_TOTAL_CARPORT, UNDERGROUND_TOTAL_CARPORT, UNDERGROUND_TOTAL_RJ_CARPORT, UNDERGROUND_TOTAL_FRJ_CARPORT,
        UNDERGROUND_TOTAL_SALE_CARPORT, OBJ_PHASE_ID, OBJ_TYPE, PRODUCT_TYPE_NAME, PRODUCT_TYPE_JSON
    )with t1 as (
        SELECT ID, '0' pType from MDM_PROJECT_PHASE
        where PROJ_ID = projectId and PHASE_ID = phaseId
        union
        select mpp1.ID, '20' pType  from MDM_PERIOD_PHASE mpp1
                                             left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                                             left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
        where mpv.PROJECT_ID = projectId and mpp1.PHASE_ID = phaseId and APPROVAL_STATUS='已审核'
        union
        select mpp1.ID, '10' pType from MDM_PARCEL_PHASE mpp1
                                            left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
        where mp1.PROJECT_ORIGINAL_ID = projectId and mpp1.PHASE_ID = phaseId
        union
        select mbp1.ID, '30' pType  from MDM_BUILD_PHASE mbp1
                                             left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
        where mb1.PROJ_ID = projectId and mbp1.PHASE_ID = phaseId
    )SELECT
         GET_UUID(), mopv.ID, PRODUCT_TYPE_ID, OPERATE_ATTRIBUTE_ID, OPERATE_ATTRIBUTE_NAME, BUILD_AREA,
         GROUND_CAPACITY_AREA, UNDERGROUND_CAPACITY_AREA, GROUND_UNCAPACITY_AREA, UNDERGROUND_UNCAPACITY_AREA,
         GROUND_TOTAL_BUILD_AREA, UNDERGROUND_TOTAL_BUILD_AREA, REFUGE_STOREY_AREA, MECHANICAL_FLOOR_AREA,
         EMPTY_SPACE_AREA, TOWER_BASEMENT_AREA, UNDERGROUND_GARAGE_AREA, STORAGE_AREA, STORAGE_TOTAL, TOTAL_SALE_AREA,
         GROUND_SALE_AREA, UNDERGROUND_SALE_AREA, TOTAL_GIVE_AREA, GROUND_GIVE_AREA, UNDERGROUND_GIVE_AREA,
         TOTAL_RESIDENCE, TOTAL_BUSINESS, GROUND_CARPORT, RESIDENCE_BOTTOM_CARPORT, PARKING_GARAGE_CARPORT,
         UNDERGROUND_RFJ_CARPORT, UNDERGROUND_RJ_CARPORT, UNDERGROUND_FRFJ_CARPORT, UNDERGROUND_FRJ_CARPORT,
         UNDERGROUND_R_SALE_CARPORT, UNDERGROUND_FRFJ_SALE_CARPORT, UNDERGROUND_FRJ_SALE_CARPORT, CARPORT_TOTAL,
         GROUND_TOTAL_CARPORT, UNDERGROUND_TOTAL_CARPORT, UNDERGROUND_TOTAL_RJ_CARPORT, UNDERGROUND_TOTAL_FRJ_CARPORT,
         UNDERGROUND_TOTAL_SALE_CARPORT, moppi.OBJ_PHASE_ID, t1.pType, PRODUCT_TYPE_NAME, PRODUCT_TYPE_JSON
    from MDM_OBJ_PHASE_VERSION mopv
             inner join t1 on t1.ID = mopv.OBJ_PHASE_ID
             inner join MDM_OBJ_PHASE_PT_INDEX moppi on moppi.OBJ_PHASE_ID = mopv.OBJ_PHASE_ID
    where mopv.OBJ_PHASE_VERSION = vVersion;

    -- 复制阶段数据
    insert into MDM_OBJ_PHASE_VERSION_INDEX(
        ID, BUILD_AREA, GROUND_CAPACITY_AREA, UNDERGROUND_CAPACITY_AREA, GROUND_UNCAPACITY_AREA,
        UNDERGROUND_UNCAPACITY_AREA, GROUND_TOTAL_BUILD_AREA, UNDERGROUND_TOTAL_BUILD_AREA, REFUGE_STOREY_AREA,
        MECHANICAL_FLOOR_AREA, EMPTY_SPACE_AREA, TOWER_BASEMENT_AREA, UNDERGROUND_GARAGE_AREA, STORAGE_AREA, STORAGE_TOTAL,
        TOTAL_SALE_AREA, GROUND_SALE_AREA, UNDERGROUND_SALE_AREA, TOTAL_GIVE_AREA, GROUND_GIVE_AREA, UNDERGROUND_GIVE_AREA,
        TOTAL_RESIDENCE, TOTAL_BUSINESS, GROUND_CARPORT, RESIDENCE_BOTTOM_CARPORT, PARKING_GARAGE_CARPORT,
        UNDERGROUND_RFJ_CARPORT, UNDERGROUND_RJ_CARPORT, UNDERGROUND_FRFJ_CARPORT, UNDERGROUND_FRJ_CARPORT,
        UNDERGROUND_R_SALE_CARPORT, UNDERGROUND_FRFJ_SALE_CARPORT, UNDERGROUND_FRJ_SALE_CARPORT, CARPORT_TOTAL,
        GROUND_TOTAL_CARPORT, UNDERGROUND_TOTAL_CARPORT, UNDERGROUND_TOTAL_RJ_CARPORT, UNDERGROUND_TOTAL_FRJ_CARPORT,
        UNDERGROUND_TOTAL_SALE_CARPORT, CONSTRUCTION_LAND_AREA, EXPROPRIATION_GREEN_SPACE_AREA, EXPROPRIATION_ROAD_AREA,
        OTHER_EXPROPRIATION_AREA, TOTAL_ROAD_AREA, TOTAL_GREEN_LAND_AREA, DEMONSTRATION_AREA, PLOT_RATIO, BUILD_DENSITY,
        GREENING_RATE, SALE_RATIO, GROUND_ENGINE_CARPORT, TOTAL_SITE_AREA, CONFISCATED_AREA, OVERALL_FLOORAGE_AREA,
        TOTAL_CAPACITY_AREA, CONSTRUCTION_PLOT_RATIO, TOTAL_SITE_AREA_PLOT_RATIO, CONSTRUCTION_BUILD_DENSITY,
        TOTAL_SITE_AREA_BUILD_DENSITY, CONSTRUCTION_GREENING_RATE, TOTAL_SITE_AREA_GREENING_RATE, CARPORT_RATIO,
        TOTAL_HOUSEHOLDS, OBJ_PHASE_ID, OBJ_TYPE, JBS_AREA, OBJ_PHASE_VERSION_ID
    ) with t1 as (
        SELECT ID, '0' pType from MDM_PROJECT_PHASE
        where PROJ_ID = projectId and PHASE_ID = phaseId
        union
        select mpp1.ID, '20' pType  from MDM_PERIOD_PHASE mpp1
                                             left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                                             left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
        where mpv.PROJECT_ID = projectId and mpp1.PHASE_ID = phaseId and APPROVAL_STATUS='已审核'
        union
        select mpp1.ID, '10' pType from MDM_PARCEL_PHASE mpp1
                                            left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
        where mp1.PROJECT_ORIGINAL_ID = projectId and mpp1.PHASE_ID = phaseId
        union
        select mbp1.ID, '30' pType  from MDM_BUILD_PHASE mbp1
                                             left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
        where mb1.PROJ_ID = projectId and mbp1.PHASE_ID = phaseId
    )SELECT
         GET_UUID(), BUILD_AREA, GROUND_CAPACITY_AREA, UNDERGROUND_CAPACITY_AREA, GROUND_UNCAPACITY_AREA,
         UNDERGROUND_UNCAPACITY_AREA, GROUND_TOTAL_BUILD_AREA, UNDERGROUND_TOTAL_BUILD_AREA, REFUGE_STOREY_AREA,
         MECHANICAL_FLOOR_AREA, EMPTY_SPACE_AREA, TOWER_BASEMENT_AREA, UNDERGROUND_GARAGE_AREA, STORAGE_AREA, STORAGE_TOTAL,
         TOTAL_SALE_AREA, GROUND_SALE_AREA, UNDERGROUND_SALE_AREA, TOTAL_GIVE_AREA, GROUND_GIVE_AREA, UNDERGROUND_GIVE_AREA,
         TOTAL_RESIDENCE, TOTAL_BUSINESS, GROUND_CARPORT, RESIDENCE_BOTTOM_CARPORT, PARKING_GARAGE_CARPORT,
         UNDERGROUND_RFJ_CARPORT, UNDERGROUND_RJ_CARPORT, UNDERGROUND_FRFJ_CARPORT, UNDERGROUND_FRJ_CARPORT,
         UNDERGROUND_R_SALE_CARPORT, UNDERGROUND_FRFJ_SALE_CARPORT, UNDERGROUND_FRJ_SALE_CARPORT, CARPORT_TOTAL,
         GROUND_TOTAL_CARPORT, UNDERGROUND_TOTAL_CARPORT, UNDERGROUND_TOTAL_RJ_CARPORT, UNDERGROUND_TOTAL_FRJ_CARPORT,
         UNDERGROUND_TOTAL_SALE_CARPORT, CONSTRUCTION_LAND_AREA, EXPROPRIATION_GREEN_SPACE_AREA, EXPROPRIATION_ROAD_AREA,
         OTHER_EXPROPRIATION_AREA, TOTAL_ROAD_AREA, TOTAL_GREEN_LAND_AREA, DEMONSTRATION_AREA, PLOT_RATIO, BUILD_DENSITY,
         GREENING_RATE, SALE_RATIO, GROUND_ENGINE_CARPORT, TOTAL_SITE_AREA, CONFISCATED_AREA, OVERALL_FLOORAGE_AREA,
         TOTAL_CAPACITY_AREA, CONSTRUCTION_PLOT_RATIO, TOTAL_SITE_AREA_PLOT_RATIO, CONSTRUCTION_BUILD_DENSITY,
         TOTAL_SITE_AREA_BUILD_DENSITY, CONSTRUCTION_GREENING_RATE, TOTAL_SITE_AREA_GREENING_RATE, CARPORT_RATIO,
         TOTAL_HOUSEHOLDS, moppi.OBJ_PHASE_ID, t1.pType OBJ_TYPE, JBS_AREA, mopv.ID
    from MDM_OBJ_PHASE_VERSION mopv
             inner join t1 on t1.ID = mopv.OBJ_PHASE_ID
             inner join MDM_OBJ_PHASE_INDEX moppi on moppi.OBJ_PHASE_ID = mopv.OBJ_PHASE_ID
    where mopv.OBJ_PHASE_VERSION = vVersion;
    ------------------------------------------业态面积复制----------------------------------------------------
    -- 复制业态对象面积分布表MDM_OBJ_PHASE_AL_V
    insert into MDM_OBJ_PHASE_AL_V(
        ID, ATTRIBUTE_AREA_LEVEL_ID, ATTRIBUTE_AREA_LEVEL_NAME, ROOM_NUMBER, OBJ_PHASE_PT_INDEX_ID, OBJ_PHASE_VERSION_ID
    )with t1 as (
        SELECT ID, '0' pType from MDM_PROJECT_PHASE
        where PROJ_ID = projectId and PHASE_ID = phaseId
        union
        select mpp1.ID, '20' pType from MDM_PERIOD_PHASE mpp1
                                            left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                                            left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
        where mpv.PROJECT_ID = projectId and mpp1.PHASE_ID = phaseId and APPROVAL_STATUS='已审核'
        union
        select mpp1.ID, '10' pType from MDM_PARCEL_PHASE mpp1
                                            left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
        where mpp1.PHASE_ID = phaseId and mp1.PROJECT_ORIGINAL_ID = projectId
        union
        select mbp1.ID, '30' pType from MDM_BUILD_PHASE mbp1
                                            left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
        where mb1.PROJ_ID = projectId and mbp1.PHASE_ID = phaseId
    )select
         GET_UUID(), ATTRIBUTE_AREA_LEVEL_ID, ATTRIBUTE_AREA_LEVEL_NAME, ROOM_NUMBER, movpi.ID, mopv.ID
    from t1
             left join MDM_OBJ_PHASE_VERSION mopv on t1.ID = mopv.OBJ_PHASE_ID
             left join MDM_OBJ_PHASE_PT_INDEX mopi on mopi.OBJ_PHASE_ID = t1.ID
             inner join MDM_OBJ_PHASE_AREA_LEVEL mopav on mopav.OBJ_PHASE_PT_INDEX_ID = mopi.ID
             left join MDM_OBJ_PHASE_VERSION_PT_INDEX movpi on mopv.ID = movpi.OBJ_PHASE_VERSION_ID
        and mopi.PRODUCT_TYPE_ID = movpi.PRODUCT_TYPE_ID
    where mopv.OBJ_PHASE_VERSION = vVersion;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_MASTER_DATA_SUM
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_MASTER_DATA_SUM" 
(
    PHASEID           IN VARCHAR2 , --阶段id
    OBJTPYE           IN VARCHAR2 , --对象类型（项目、宗地、分期、楼栋）
    OBJID             IN OUT VARCHAR2 , --对象id
    PROJCOLLECTSOURCE IN VARCHAR2 --项目数据汇总来源
) AS
    -- 项目主数据汇总-- 作者：杨明-- 日期:2019/11/20
    -- change @author 韩金明 @date 2020-3-30
    periodPhaseId varchar2(36);
    phaseOrder number;
    projectPhaseId varchar(36);
BEGIN
    IF PROJCOLLECTSOURCE = '10' THEN
        --项目汇总数据来源为宗地
        IF OBJTPYE = '10' THEN
            -- 对象为宗地 需要汇总项目数据--汇总对象阶段业态指标表
            begin
                SELECT mpp.ID into projectPhaseId
                FROM MDM_PARCEL mp1
                    LEFT JOIN MDM_PROJECT mp2 ON mp2.PROJECT_ORIGINAL_ID = mp1.PROJECT_ORIGINAL_ID
                    LEFT JOIN MDM_PROJECT_PHASE mpp ON mpp.PROJ_ID = mp2.PROJECT_ORIGINAL_ID AND mp2.APPROVAL_STATUS = '已审核'
                WHERE mp1.PARCEL_ORIGINAL_ID = OBJID AND mpp.PHASE_ID = PHASEID and ROWNUM < 2;
            exception when others then
                projectPhaseId := GET_UUID();
                DBMS_OUTPUT.PUT_LINE('未获取到项目阶段id: [10:10],[' || OBJID || ',' || PHASEID || ']');
            end;
            -- 删除需要修改的业态指标数据
            DELETE FROM MDM_OBJ_PHASE_PT_INDEX B WHERE B.OBJ_PHASE_ID = projectPhaseId AND B.OBJ_TYPE = 0;
            -- 添加新的业态指标数据(全部宗地的)
            insert into MDM_OBJ_PHASE_PT_INDEX
            select
                GET_UUID() AS ID,
                M1.PRODUCT_TYPE_ID AS PRODUCT_TYPE_ID,
                M1.OPERATE_ATTRIBUTE_ID AS OPERATE_ATTRIBUTE_ID,
                M1.OPERATE_ATTRIBUTE_NAME AS OPERATE_ATTRIBUTE_NAME,
                SUM(M1.BUILD_AREA) AS BUILD_AREA,
                SUM(M1.GROUND_CAPACITY_AREA) AS GROUND_CAPACITY_AREA,
                SUM(M1.UNDERGROUND_CAPACITY_AREA) AS UNDERGROUND_CAPACITY_AREA,
                SUM(M1.GROUND_UNCAPACITY_AREA) AS GROUND_UNCAPACITY_AREA,
                SUM(M1.UNDERGROUND_UNCAPACITY_AREA) AS UNDERGROUND_UNCAPACITY_AREA,
                SUM(M1.GROUND_TOTAL_BUILD_AREA) AS GROUND_TOTAL_BUILD_AREA,
                SUM(M1.UNDERGROUND_TOTAL_BUILD_AREA) AS UNDERGROUND_TOTAL_BUILD_AREA,
                SUM(M1.REFUGE_STOREY_AREA) AS REFUGE_STOREY_AREA,
                SUM(M1.MECHANICAL_FLOOR_AREA) AS MECHANICAL_FLOOR_AREA,
                SUM(M1.EMPTY_SPACE_AREA) AS EMPTY_SPACE_AREA,
                SUM(M1.TOWER_BASEMENT_AREA) AS TOWER_BASEMENT_AREA,
                SUM(M1.UNDERGROUND_GARAGE_AREA) AS UNDERGROUND_GARAGE_AREA,
                SUM(M1.STORAGE_AREA) AS STORAGE_AREA,
                SUM(M1.STORAGE_TOTAL) AS STORAGE_TOTAL,
                SUM(M1.TOTAL_SALE_AREA) AS TOTAL_SALE_AREA,
                SUM(M1.GROUND_SALE_AREA) AS GROUND_SALE_AREA,
                SUM(M1.UNDERGROUND_SALE_AREA) AS UNDERGROUND_SALE_AREA,
                SUM(M1.TOTAL_GIVE_AREA) AS TOTAL_GIVE_AREA,
                SUM(M1.GROUND_GIVE_AREA) AS GROUND_GIVE_AREA,
                SUM(M1.UNDERGROUND_GIVE_AREA) AS UNDERGROUND_GIVE_AREA,
                SUM(M1.TOTAL_RESIDENCE) AS TOTAL_RESIDENCE,
                SUM(M1.TOTAL_BUSINESS) AS TOTAL_BUSINESS,
                SUM(M1.GROUND_CARPORT) AS GROUND_CARPORT,
                SUM(M1.RESIDENCE_BOTTOM_CARPORT) AS RESIDENCE_BOTTOM_CARPORT,
                SUM(M1.PARKING_GARAGE_CARPORT) AS PARKING_GARAGE_CARPORT,
                SUM(M1.UNDERGROUND_RFJ_CARPORT) AS UNDERGROUND_RFJ_CARPORT,
                SUM(M1.UNDERGROUND_RJ_CARPORT) AS UNDERGROUND_RJ_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_CARPORT) AS UNDERGROUND_FRFJ_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_CARPORT) AS UNDERGROUND_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_R_SALE_CARPORT) AS UNDERGROUND_R_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_SALE_CARPORT) AS UNDERGROUND_FRFJ_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_SALE_CARPORT) AS UNDERGROUND_FRJ_SALE_CARPORT,
                SUM(M1.CARPORT_TOTAL) AS CARPORT_TOTAL,
                SUM(M1.GROUND_TOTAL_CARPORT) AS GROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_CARPORT) AS UNDERGROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_RJ_CARPORT) AS UNDERGROUND_TOTAL_RJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_FRJ_CARPORT) AS UNDERGROUND_TOTAL_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_SALE_CARPORT) AS UNDERGROUND_TOTAL_SALE_CARPORT,
                aId AS OBJ_PHASE_ID, 0 AS OBJ_TYPE,
                M1.PRODUCT_TYPE_NAME AS PRODUCT_TYPE_NAME,
                M1.PRODUCT_TYPE_JSON AS PRODUCT_TYPE_JSON
            from (
                select
                    distinct moppi.id,
                    moppi.product_type_id,
                    moppi.operate_attribute_id,
                    moppi.operate_attribute_name,
                    moppi.build_area,
                    moppi.ground_capacity_area,
                    moppi.underground_capacity_area,
                    moppi.ground_uncapacity_area,
                    moppi.underground_uncapacity_area,
                    moppi.ground_total_build_area,
                    moppi.underground_total_build_area,
                    moppi.refuge_storey_area,
                    moppi.mechanical_floor_area,
                    moppi.empty_space_area,
                    moppi.tower_basement_area,
                    moppi.underground_garage_area,
                    moppi.storage_area,
                    moppi.storage_total,
                    moppi.total_sale_area,
                    moppi.ground_sale_area,
                    moppi.underground_sale_area,
                    moppi.total_give_area,
                    moppi.ground_give_area,
                    moppi.underground_give_area,
                    moppi.total_residence,
                    moppi.total_business,
                    moppi.ground_carport,
                    moppi.residence_bottom_carport,
                    moppi.parking_garage_carport,
                    moppi.underground_rfj_carport,
                    moppi.underground_rj_carport,
                    moppi.underground_frfj_carport,
                    moppi.underground_frj_carport,
                    moppi.underground_r_sale_carport,
                    moppi.underground_frfj_sale_carport,
                    moppi.underground_frj_sale_carport,
                    moppi.carport_total,
                    moppi.ground_total_carport,
                    moppi.underground_total_carport,
                    moppi.underground_total_rj_carport,
                    moppi.underground_total_frj_carport,
                    moppi.underground_total_sale_carport,
                    moppi.product_type_name,
                    moppi.product_type_json,
                    projectPhaseId as aId
                from MDM_PROJECT_PHASE mpp1
                    left join MDM_PARCEL mp1 on mp1.PROJECT_ORIGINAL_ID = mpp1.PROJ_ID
                    left join MDM_PARCEL_PHASE mpp2 on mpp2.PHASE_ID = mpp1.PHASE_ID
                    and mpp2.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
                    left join MDM_OBJ_PHASE_PT_INDEX moppi on moppi.OBJ_PHASE_ID = mpp2.ID
                where mpp1.ID=projectPhaseId and OBJ_PHASE_ID is not null
            ) M1 GROUP BY PRODUCT_TYPE_ID, OPERATE_ATTRIBUTE_ID,
                     OPERATE_ATTRIBUTE_NAME,PRODUCT_TYPE_NAME,
                     PRODUCT_TYPE_JSON, aId;
            -- 删除需要修改的业态指标数据
            DELETE FROM MDM_OBJ_PHASE_INDEX B WHERE B.OBJ_PHASE_ID = projectPhaseId AND B.OBJ_TYPE = 0;
            -- 插入汇总后的对象阶段指标表数据
            insert into MDM_OBJ_PHASE_INDEX
            select
                GET_UUID()       AS ID,
                SUM(M1.BUILD_AREA)                     AS BUILD_AREA,
                SUM(M1.GROUND_CAPACITY_AREA)           AS GROUND_CAPACITY_AREA,
                SUM(M1.UNDERGROUND_CAPACITY_AREA)      AS UNDERGROUND_CAPACITY_AREA,
                SUM(M1.GROUND_UNCAPACITY_AREA)         AS GROUND_UNCAPACITY_AREA,
                SUM(M1.UNDERGROUND_UNCAPACITY_AREA)    AS UNDERGROUND_UNCAPACITY_AREA,
                SUM(M1.GROUND_TOTAL_BUILD_AREA)        AS GROUND_TOTAL_BUILD_AREA,
                SUM(M1.UNDERGROUND_TOTAL_BUILD_AREA)   AS UNDERGROUND_TOTAL_BUILD_AREA,
                SUM(M1.REFUGE_STOREY_AREA)             AS REFUGE_STOREY_AREA,
                SUM(M1.MECHANICAL_FLOOR_AREA)          AS MECHANICAL_FLOOR_AREA,
                SUM(M1.EMPTY_SPACE_AREA)               AS EMPTY_SPACE_AREA,
                SUM(M1.TOWER_BASEMENT_AREA)            AS TOWER_BASEMENT_AREA,
                SUM(M1.UNDERGROUND_GARAGE_AREA)        AS UNDERGROUND_GARAGE_AREA,
                SUM(M1.STORAGE_AREA)                   AS STORAGE_AREA,
                SUM(M1.STORAGE_TOTAL)                  AS STORAGE_TOTAL,
                SUM(M1.TOTAL_SALE_AREA)                AS TOTAL_SALE_AREA,
                SUM(M1.GROUND_SALE_AREA)               AS GROUND_SALE_AREA,
                SUM(M1.UNDERGROUND_SALE_AREA)          AS UNDERGROUND_SALE_AREA,
                SUM(M1.TOTAL_GIVE_AREA)                AS TOTAL_GIVE_AREA,
                SUM(M1.GROUND_GIVE_AREA)               AS GROUND_GIVE_AREA,
                SUM(M1.UNDERGROUND_GIVE_AREA)          AS UNDERGROUND_GIVE_AREA,
                SUM(M1.TOTAL_RESIDENCE)                AS TOTAL_RESIDENCE,
                SUM(M1.TOTAL_BUSINESS)                 AS TOTAL_BUSINESS,
                SUM(M1.GROUND_CARPORT)                 AS GROUND_CARPORT,
                SUM(M1.RESIDENCE_BOTTOM_CARPORT)       AS RESIDENCE_BOTTOM_CARPORT,
                SUM(M1.PARKING_GARAGE_CARPORT)         AS PARKING_GARAGE_CARPORT,
                SUM(M1.UNDERGROUND_RFJ_CARPORT)        AS UNDERGROUND_RFJ_CARPORT,
                SUM(M1.UNDERGROUND_RJ_CARPORT)         AS UNDERGROUND_RJ_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_CARPORT)       AS UNDERGROUND_FRFJ_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_CARPORT)        AS UNDERGROUND_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_R_SALE_CARPORT)     AS UNDERGROUND_R_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_SALE_CARPORT)  AS UNDERGROUND_FRFJ_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_SALE_CARPORT)   AS UNDERGROUND_FRJ_SALE_CARPORT,
                SUM(M1.CARPORT_TOTAL)                  AS CARPORT_TOTAL,
                SUM(M1.GROUND_TOTAL_CARPORT)           AS GROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_CARPORT)      AS UNDERGROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_RJ_CARPORT)   AS UNDERGROUND_TOTAL_RJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_FRJ_CARPORT)  AS UNDERGROUND_TOTAL_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_SALE_CARPORT) AS UNDERGROUND_TOTAL_SALE_CARPORT,
                SUM(M1.CONSTRUCTION_LAND_AREA)         AS CONSTRUCTION_LAND_AREA,
                SUM(M1.EXPROPRIATION_GREEN_SPACE_AREA) AS EXPROPRIATION_GREEN_SPACE_AREA,
                SUM(M1.EXPROPRIATION_ROAD_AREA)        AS EXPROPRIATION_ROAD_AREA,
                SUM(M1.OTHER_EXPROPRIATION_AREA)       AS OTHER_EXPROPRIATION_AREA,
                SUM(M1.TOTAL_ROAD_AREA)                AS TOTAL_ROAD_AREA,
                SUM(M1.TOTAL_GREEN_LAND_AREA)          AS TOTAL_GREEN_LAND_AREA,
                SUM(M1.DEMONSTRATION_AREA)             AS DEMONSTRATION_AREA,
                SUM(M1.PLOT_RATIO)                     AS PLOT_RATIO,
                SUM(M1.BUILD_DENSITY)                  AS BUILD_DENSITY,
                SUM(M1.GREENING_RATE)                  AS GREENING_RATE,
                SUM(M1.SALE_RATIO)                     AS SALE_RATIO,
                SUM(M1.GROUND_ENGINE_CARPORT)          AS GROUND_ENGINE_CARPORT,
                SUM(M1.TOTAL_SITE_AREA)                AS TOTAL_SITE_AREA,
                SUM(M1.CONFISCATED_AREA)               AS CONFISCATED_AREA,
                SUM(M1.OVERALL_FLOORAGE_AREA)          AS OVERALL_FLOORAGE_AREA,
                SUM(M1.TOTAL_CAPACITY_AREA)            AS TOTAL_CAPACITY_AREA,
                SUM(M1.CONSTRUCTION_PLOT_RATIO)        AS CONSTRUCTION_PLOT_RATIO,
                SUM(M1.TOTAL_SITE_AREA_PLOT_RATIO)     AS TOTAL_SITE_AREA_PLOT_RATIO,
                SUM(M1.CONSTRUCTION_BUILD_DENSITY)     AS CONSTRUCTION_BUILD_DENSITY,
                SUM(M1.TOTAL_SITE_AREA_BUILD_DENSITY)  AS TOTAL_SITE_AREA_BUILD_DENSITY,
                SUM(M1.CONSTRUCTION_GREENING_RATE)     AS CONSTRUCTION_GREENING_RATE,
                SUM(M1.TOTAL_SITE_AREA_GREENING_RATE)  AS TOTAL_SITE_AREA_GREENING_RATE,
                SUM(M1.CARPORT_RATIO)                  AS CARPORT_RATIO,
                SUM(M1.TOTAL_HOUSEHOLDS)               AS TOTAL_HOUSEHOLDS,
                objPhaseId                             AS OBJ_PHASE_ID,
                '0'                                    AS OBJ_TYPE,
                SUM(M1.JBS_AREA)                       AS JBS_AREA
            from (
                select distinct mopi.*, mpp1.ID objPhaseId
                from MDM_PROJECT_PHASE mpp1
                    left join MDM_PARCEL mp1 on mp1.PROJECT_ORIGINAL_ID = mpp1.PROJ_ID
                    left join MDM_PARCEL_PHASE mpp2 on mpp2.PHASE_ID = mpp1.PHASE_ID
                    and mpp2.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
                    left join MDM_OBJ_PHASE_INDEX mopi on mopi.OBJ_PHASE_ID = mpp2.ID
                where mpp1.ID = projectPhaseId and OBJ_PHASE_ID is not null
            ) M1
            GROUP BY objPhaseId;
        END IF;
    END IF;
    IF PROJCOLLECTSOURCE = '20' THEN
        --项目汇总数据来源为分期
        IF OBJTPYE = '20' THEN
            begin
                select mpp.ID into projectPhaseId
                from MDM_PERIOD mp
                    left join MDM_PERIOD_VERSION mpv on mp.PERIOD_VERSION_ID = mpv.id
                    left join MDM_PROJECT_PHASE mpp on mpp.PROJ_ID = mpv.PROJECT_ORIGINAL_ID
                where mp.period_original_id=OBJID and mpp.phase_id=PHASEID and ROWNUM < 2;
            exception when others then
                projectPhaseId := GET_UUID();
                DBMS_OUTPUT.PUT_LINE('未获取到项目阶段id: [20:20],[' || OBJID || ',' || PHASEID || ']');
            end;
            -- 分期 需要汇总项目数据--需要删除项目户数表 项目业态表
            -- 删除业态数据表
            DELETE FROM MDM_OBJ_PHASE_PT_INDEX B  WHERE B.OBJ_PHASE_ID = projectPhaseId;
            -- 汇总业态数据
            insert into MDM_OBJ_PHASE_PT_INDEX
            select
                GET_UUID() AS ID,
                M1.PRODUCT_TYPE_ID AS PRODUCT_TYPE_ID,
                M1.OPERATE_ATTRIBUTE_ID AS OPERATE_ATTRIBUTE_ID,
                M1.OPERATE_ATTRIBUTE_NAME  AS OPERATE_ATTRIBUTE_NAME,
                SUM(M1.BUILD_AREA) AS BUILD_AREA,
                SUM(M1.GROUND_CAPACITY_AREA) AS GROUND_CAPACITY_AREA,
                SUM(M1.UNDERGROUND_CAPACITY_AREA) AS UNDERGROUND_CAPACITY_AREA,
                SUM(M1.GROUND_UNCAPACITY_AREA) AS GROUND_UNCAPACITY_AREA,
                SUM(M1.UNDERGROUND_UNCAPACITY_AREA) AS UNDERGROUND_UNCAPACITY_AREA,
                SUM(M1.GROUND_TOTAL_BUILD_AREA) AS GROUND_TOTAL_BUILD_AREA,
                SUM(M1.UNDERGROUND_TOTAL_BUILD_AREA) AS UNDERGROUND_TOTAL_BUILD_AREA,
                SUM(M1.REFUGE_STOREY_AREA) AS REFUGE_STOREY_AREA,
                SUM(M1.MECHANICAL_FLOOR_AREA) AS MECHANICAL_FLOOR_AREA,
                SUM(M1.EMPTY_SPACE_AREA) AS EMPTY_SPACE_AREA,
                SUM(M1.TOWER_BASEMENT_AREA) AS TOWER_BASEMENT_AREA,
                SUM(M1.UNDERGROUND_GARAGE_AREA) AS UNDERGROUND_GARAGE_AREA,
                SUM(M1.STORAGE_AREA) AS STORAGE_AREA,
                SUM(M1.STORAGE_TOTAL) AS STORAGE_TOTAL,
                SUM(M1.TOTAL_SALE_AREA) AS TOTAL_SALE_AREA,
                SUM(M1.GROUND_SALE_AREA) AS GROUND_SALE_AREA,
                SUM(M1.UNDERGROUND_SALE_AREA) AS UNDERGROUND_SALE_AREA,
                SUM(M1.TOTAL_GIVE_AREA) AS TOTAL_GIVE_AREA,
                SUM(M1.GROUND_GIVE_AREA) AS GROUND_GIVE_AREA,
                SUM(M1.UNDERGROUND_GIVE_AREA) AS UNDERGROUND_GIVE_AREA,
                SUM(M1.TOTAL_RESIDENCE) AS TOTAL_RESIDENCE,
                SUM(M1.TOTAL_BUSINESS) AS TOTAL_BUSINESS,
                SUM(M1.GROUND_CARPORT) AS GROUND_CARPORT,
                SUM(M1.RESIDENCE_BOTTOM_CARPORT) AS RESIDENCE_BOTTOM_CARPORT,
                SUM(M1.PARKING_GARAGE_CARPORT) AS PARKING_GARAGE_CARPORT,
                SUM(M1.UNDERGROUND_RFJ_CARPORT) AS UNDERGROUND_RFJ_CARPORT,
                SUM(M1.UNDERGROUND_RJ_CARPORT) AS UNDERGROUND_RJ_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_CARPORT) AS UNDERGROUND_FRFJ_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_CARPORT) AS UNDERGROUND_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_R_SALE_CARPORT) AS UNDERGROUND_R_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_SALE_CARPORT) AS UNDERGROUND_FRFJ_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_SALE_CARPORT) AS UNDERGROUND_FRJ_SALE_CARPORT,
                SUM(M1.CARPORT_TOTAL) AS CARPORT_TOTAL,
                SUM(M1.GROUND_TOTAL_CARPORT) AS GROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_CARPORT) AS UNDERGROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_RJ_CARPORT) AS UNDERGROUND_TOTAL_RJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_FRJ_CARPORT) AS UNDERGROUND_TOTAL_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_SALE_CARPORT) AS UNDERGROUND_TOTAL_SALE_CARPORT,
                hid AS OBJ_PHASE_ID,
                0 AS OBJ_TYPE,
                M1.PRODUCT_TYPE_NAME AS PRODUCT_TYPE_NAME,
                M1.PRODUCT_TYPE_JSON AS PRODUCT_TYPE_JSON
            from (
                select
                    distinct moppi.ID,
                    mpp.id as hid,
                    PRODUCT_TYPE_ID,
                    OPERATE_ATTRIBUTE_ID,
                    OPERATE_ATTRIBUTE_NAME,
                    BUILD_AREA,
                    GROUND_CAPACITY_AREA,
                    UNDERGROUND_CAPACITY_AREA,
                    GROUND_UNCAPACITY_AREA,
                    UNDERGROUND_UNCAPACITY_AREA,
                    GROUND_TOTAL_BUILD_AREA,
                    UNDERGROUND_TOTAL_BUILD_AREA,
                    REFUGE_STOREY_AREA,
                    MECHANICAL_FLOOR_AREA,
                    EMPTY_SPACE_AREA,
                    TOWER_BASEMENT_AREA,
                    UNDERGROUND_GARAGE_AREA,
                    STORAGE_AREA,
                    STORAGE_TOTAL,
                    TOTAL_SALE_AREA,
                    GROUND_SALE_AREA,
                    UNDERGROUND_SALE_AREA,
                    TOTAL_GIVE_AREA,
                    GROUND_GIVE_AREA,
                    UNDERGROUND_GIVE_AREA,
                    TOTAL_RESIDENCE,
                    TOTAL_BUSINESS,
                    GROUND_CARPORT,
                    RESIDENCE_BOTTOM_CARPORT,
                    PARKING_GARAGE_CARPORT,
                    UNDERGROUND_RFJ_CARPORT,
                    UNDERGROUND_RJ_CARPORT,
                    UNDERGROUND_FRFJ_CARPORT,
                    UNDERGROUND_FRJ_CARPORT,
                    UNDERGROUND_R_SALE_CARPORT,
                    UNDERGROUND_FRFJ_SALE_CARPORT,
                    UNDERGROUND_FRJ_SALE_CARPORT,
                    CARPORT_TOTAL,
                    GROUND_TOTAL_CARPORT,
                    UNDERGROUND_TOTAL_CARPORT,
                    UNDERGROUND_TOTAL_RJ_CARPORT,
                    UNDERGROUND_TOTAL_FRJ_CARPORT,
                    UNDERGROUND_TOTAL_SALE_CARPORT,
                    PRODUCT_TYPE_NAME, PRODUCT_TYPE_JSON
                from MDM_PROJECT_PHASE mpp
                    left join MDM_PERIOD_VERSION mpv on mpp.PROJ_ID = mpv.PROJECT_ORIGINAL_ID
                    left join MDM_PERIOD mp on mp.PERIOD_VERSION_ID = mpv.ID
                    left join MDM_PERIOD_PHASE mpp2 on mpp2.PERIOD_ID = mp.PERIOD_ORIGINAL_ID
                    and mpp.PHASE_ID = mpp2.PHASE_ID
                    left join MDM_OBJ_PHASE_PT_INDEX moppi on moppi.OBJ_PHASE_ID = mpp2.id
                where mpp.id = projectPhaseId and mpp.PHASE_ID = PHASEID and OBJ_PHASE_ID is not null
            ) M1 group by M1.PRODUCT_TYPE_ID, M1.OPERATE_ATTRIBUTE_ID, M1.OPERATE_ATTRIBUTE_NAME,
                     M1.PRODUCT_TYPE_NAME, M1.PRODUCT_TYPE_JSON, hid;
            -- 删除指标数据
            delete from MDM_OBJ_PHASE_INDEX where OBJ_PHASE_ID = projectPhaseId;
            --汇总指标数据
            insert into MDM_OBJ_PHASE_INDEX(
                ID,
                BUILD_AREA,
                GROUND_CAPACITY_AREA,
                UNDERGROUND_CAPACITY_AREA,
                GROUND_UNCAPACITY_AREA,
                UNDERGROUND_UNCAPACITY_AREA,
                GROUND_TOTAL_BUILD_AREA,
                UNDERGROUND_TOTAL_BUILD_AREA,
                REFUGE_STOREY_AREA,
                MECHANICAL_FLOOR_AREA,
                EMPTY_SPACE_AREA,
                TOWER_BASEMENT_AREA,
                UNDERGROUND_GARAGE_AREA,
                STORAGE_AREA,
                STORAGE_TOTAL,
                TOTAL_SALE_AREA,
                GROUND_SALE_AREA,
                UNDERGROUND_SALE_AREA,
                TOTAL_GIVE_AREA,
                GROUND_GIVE_AREA,
                UNDERGROUND_GIVE_AREA,
                TOTAL_RESIDENCE,
                TOTAL_BUSINESS,
                GROUND_CARPORT,
                RESIDENCE_BOTTOM_CARPORT,
                PARKING_GARAGE_CARPORT,
                UNDERGROUND_RFJ_CARPORT,
                UNDERGROUND_RJ_CARPORT,
                UNDERGROUND_FRFJ_CARPORT,
                UNDERGROUND_FRJ_CARPORT,
                UNDERGROUND_R_SALE_CARPORT,
                UNDERGROUND_FRFJ_SALE_CARPORT,
                UNDERGROUND_FRJ_SALE_CARPORT,
                CARPORT_TOTAL,
                GROUND_TOTAL_CARPORT,
                UNDERGROUND_TOTAL_CARPORT,
                UNDERGROUND_TOTAL_RJ_CARPORT,
                UNDERGROUND_TOTAL_FRJ_CARPORT,
                UNDERGROUND_TOTAL_SALE_CARPORT,
                CONSTRUCTION_LAND_AREA,
                EXPROPRIATION_GREEN_SPACE_AREA,
                EXPROPRIATION_ROAD_AREA,
                OTHER_EXPROPRIATION_AREA,
                TOTAL_ROAD_AREA,
                TOTAL_GREEN_LAND_AREA,
                DEMONSTRATION_AREA,
                PLOT_RATIO,
                BUILD_DENSITY,
                GREENING_RATE,
                SALE_RATIO,
                GROUND_ENGINE_CARPORT,
                TOTAL_SITE_AREA,
                CONFISCATED_AREA,
                OVERALL_FLOORAGE_AREA,
                TOTAL_CAPACITY_AREA,
                CONSTRUCTION_PLOT_RATIO,
                TOTAL_SITE_AREA_PLOT_RATIO,
                CONSTRUCTION_BUILD_DENSITY,
                TOTAL_SITE_AREA_BUILD_DENSITY,
                CONSTRUCTION_GREENING_RATE,
                TOTAL_SITE_AREA_GREENING_RATE,
                CARPORT_RATIO,
                TOTAL_HOUSEHOLDS,
                JBS_AREA,
                OBJ_TYPE,
                OBJ_PHASE_ID
            )
            select
                GET_UUID() AS ID,
                SUM(M1.BUILD_AREA) AS BUILD_AREA,
                SUM(M1.GROUND_CAPACITY_AREA) AS GROUND_CAPACITY_AREA,
                SUM(M1.UNDERGROUND_CAPACITY_AREA) AS UNDERGROUND_CAPACITY_AREA,
                SUM(M1.GROUND_UNCAPACITY_AREA) AS GROUND_UNCAPACITY_AREA,
                SUM(M1.UNDERGROUND_UNCAPACITY_AREA) AS UNDERGROUND_UNCAPACITY_AREA,
                SUM(M1.GROUND_TOTAL_BUILD_AREA) AS GROUND_TOTAL_BUILD_AREA,
                SUM(M1.UNDERGROUND_TOTAL_BUILD_AREA) AS UNDERGROUND_TOTAL_BUILD_AREA,
                SUM(M1.REFUGE_STOREY_AREA) AS REFUGE_STOREY_AREA,
                SUM(M1.MECHANICAL_FLOOR_AREA) AS MECHANICAL_FLOOR_AREA,
                SUM(M1.EMPTY_SPACE_AREA) AS EMPTY_SPACE_AREA,
                SUM(M1.TOWER_BASEMENT_AREA) AS TOWER_BASEMENT_AREA,
                SUM(M1.UNDERGROUND_GARAGE_AREA) AS UNDERGROUND_GARAGE_AREA,
                SUM(M1.STORAGE_AREA) AS STORAGE_AREA,
                SUM(M1.STORAGE_TOTAL) AS STORAGE_TOTAL,
                SUM(M1.TOTAL_SALE_AREA) AS TOTAL_SALE_AREA,
                SUM(M1.GROUND_SALE_AREA) AS GROUND_SALE_AREA,
                SUM(M1.UNDERGROUND_SALE_AREA) AS UNDERGROUND_SALE_AREA,
                SUM(M1.TOTAL_GIVE_AREA) AS TOTAL_GIVE_AREA,
                SUM(M1.GROUND_GIVE_AREA) AS GROUND_GIVE_AREA,
                SUM(M1.UNDERGROUND_GIVE_AREA) AS UNDERGROUND_GIVE_AREA,
                SUM(M1.TOTAL_RESIDENCE) AS TOTAL_RESIDENCE,
                SUM(M1.TOTAL_BUSINESS) AS TOTAL_BUSINESS,
                SUM(M1.GROUND_CARPORT) AS GROUND_CARPORT,
                SUM(M1.RESIDENCE_BOTTOM_CARPORT) AS RESIDENCE_BOTTOM_CARPORT,
                SUM(M1.PARKING_GARAGE_CARPORT) AS PARKING_GARAGE_CARPORT,
                SUM(M1.UNDERGROUND_RFJ_CARPORT) AS UNDERGROUND_RFJ_CARPORT,
                SUM(M1.UNDERGROUND_RJ_CARPORT) AS UNDERGROUND_RJ_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_CARPORT) AS UNDERGROUND_FRFJ_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_CARPORT) AS UNDERGROUND_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_R_SALE_CARPORT) AS UNDERGROUND_R_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_SALE_CARPORT) AS UNDERGROUND_FRFJ_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_SALE_CARPORT) AS UNDERGROUND_FRJ_SALE_CARPORT,
                SUM(M1.CARPORT_TOTAL) AS CARPORT_TOTAL,
                SUM(M1.GROUND_TOTAL_CARPORT) AS GROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_CARPORT) AS UNDERGROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_RJ_CARPORT) AS UNDERGROUND_TOTAL_RJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_FRJ_CARPORT) AS UNDERGROUND_TOTAL_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_SALE_CARPORT) AS UNDERGROUND_TOTAL_SALE_CARPORT,
                SUM(M1.CONSTRUCTION_LAND_AREA) AS CONSTRUCTION_LAND_AREA,
                SUM(M1.EXPROPRIATION_GREEN_SPACE_AREA) AS EXPROPRIATION_GREEN_SPACE_AREA,
                SUM(M1.EXPROPRIATION_ROAD_AREA) AS EXPROPRIATION_ROAD_AREA,
                SUM(M1.OTHER_EXPROPRIATION_AREA) AS OTHER_EXPROPRIATION_AREA,
                SUM(M1.TOTAL_ROAD_AREA) AS TOTAL_ROAD_AREA,
                SUM(M1.TOTAL_GREEN_LAND_AREA) AS TOTAL_GREEN_LAND_AREA,
                SUM(M1.DEMONSTRATION_AREA) AS DEMONSTRATION_AREA,
                SUM(M1.PLOT_RATIO) AS PLOT_RATIO,
                SUM(M1.BUILD_DENSITY) AS BUILD_DENSITY,
                SUM(M1.GREENING_RATE) AS GREENING_RATE,
                SUM(M1.SALE_RATIO) AS SALE_RATIO,
                SUM(M1.GROUND_ENGINE_CARPORT) AS GROUND_ENGINE_CARPORT,
                SUM(M1.TOTAL_SITE_AREA) AS TOTAL_SITE_AREA,
                SUM(M1.CONFISCATED_AREA) AS CONFISCATED_AREA,
                SUM(M1.OVERALL_FLOORAGE_AREA) AS OVERALL_FLOORAGE_AREA,
                SUM(M1.TOTAL_CAPACITY_AREA) AS TOTAL_CAPACITY_AREA,
                SUM(M1.CONSTRUCTION_PLOT_RATIO) AS CONSTRUCTION_PLOT_RATIO,
                SUM(M1.TOTAL_SITE_AREA_PLOT_RATIO) AS TOTAL_SITE_AREA_PLOT_RATIO,
                SUM(M1.CONSTRUCTION_BUILD_DENSITY) AS CONSTRUCTION_BUILD_DENSITY,
                SUM(M1.TOTAL_SITE_AREA_BUILD_DENSITY) AS TOTAL_SITE_AREA_BUILD_DENSITY,
                SUM(M1.CONSTRUCTION_GREENING_RATE) AS CONSTRUCTION_GREENING_RATE,
                SUM(M1.TOTAL_SITE_AREA_GREENING_RATE) AS TOTAL_SITE_AREA_GREENING_RATE,
                SUM(M1.CARPORT_RATIO) AS CARPORT_RATIO,
                SUM(M1.TOTAL_HOUSEHOLDS) AS TOTAL_HOUSEHOLDS,
                SUM(M1.JBS_AREA) AS JBS_AREA,
                0 AS OBJ_TYPE,
                hid AS OBJ_PHASE_ID
            from (
                select
                    distinct mopi.*,
                    mpp.id as hid
                from MDM_PROJECT_PHASE mpp
                    left join MDM_PERIOD_VERSION mpv on mpp.PROJ_ID = mpv.PROJECT_ORIGINAL_ID
                    left join MDM_PERIOD mp on mp.PERIOD_VERSION_ID = mpv.ID
                    left join MDM_PERIOD_PHASE mpp2 on mpp2.PERIOD_ID = mp.PERIOD_ORIGINAL_ID
                    and mpp.PHASE_ID = mpp2.PHASE_ID
                    left join MDM_OBJ_PHASE_INDEX mopi on mopi.OBJ_PHASE_ID = mpp2.id
                where mpp.id = projectPhaseId and mpp.PHASE_ID = PHASEID and OBJ_PHASE_ID is not null
            ) M1 group by hid;
        END IF;
        --项目汇总数据来源为宗地
        IF OBJTPYE = '30' THEN
            -- 获取分期阶段ID, 阶段号
            begin
                select mpp2.ID, mpp2.PHASE_ORDER into periodPhaseId, phaseOrder
                from MDM_BUILD_PHASE mbp
                    left join MDM_BUILD mb on mb.ID = mbp.BUILD_ID
                    left join MDM_PERIOD mp on mp.PERIOD_ORIGINAL_ID = mb.PERIOD_ID
                    left join MDM_PERIOD_PHASE mpp2 on mpp2.PERIOD_ID = mp.PERIOD_ORIGINAL_ID
                    and mpp2.PHASE_ORDER = mbp.PHASE_ORDER
                where mb.PERIOD_ID = (
                    select  PERIOD_ID from MDM_BUILD where ID =  OBJID
                ) and mbp.PHASE_ID = PHASEID and ROWNUM < 2;
            exception when others then
                DBMS_OUTPUT.PUT_LINE('未获取到分期阶段信息, [20:30], ['||OBJID || ',' || PHASEID || ']');
                periodPhaseId := GET_UUID();
                phaseOrder := -1;
            end;
            -- 删除当前分期业态数据
            DELETE FROM MDM_OBJ_PHASE_PT_INDEX B WHERE B.OBJ_PHASE_ID = periodPhaseId;
            -- 汇总数据到分期
            insert into MDM_OBJ_PHASE_PT_INDEX
            select
                GET_UUID() AS ID,
                M1.PRODUCT_TYPE_ID AS PRODUCT_TYPE_ID,
                M1.OPERATE_ATTRIBUTE_ID AS OPERATE_ATTRIBUTE_ID,
                M1.OPERATE_ATTRIBUTE_NAME AS OPERATE_ATTRIBUTE_NAME,
                SUM(M1.BUILD_AREA) AS BUILD_AREA,
                SUM(M1.GROUND_CAPACITY_AREA) AS GROUND_CAPACITY_AREA,
                SUM(M1.UNDERGROUND_CAPACITY_AREA) AS UNDERGROUND_CAPACITY_AREA,
                SUM(M1.GROUND_UNCAPACITY_AREA) AS GROUND_UNCAPACITY_AREA,
                SUM(M1.UNDERGROUND_UNCAPACITY_AREA) AS UNDERGROUND_UNCAPACITY_AREA,
                SUM(M1.GROUND_TOTAL_BUILD_AREA) AS GROUND_TOTAL_BUILD_AREA,
                SUM(M1.UNDERGROUND_TOTAL_BUILD_AREA) AS UNDERGROUND_TOTAL_BUILD_AREA,
                SUM(M1.REFUGE_STOREY_AREA) AS REFUGE_STOREY_AREA,
                SUM(M1.MECHANICAL_FLOOR_AREA) AS MECHANICAL_FLOOR_AREA,
                SUM(M1.EMPTY_SPACE_AREA) AS EMPTY_SPACE_AREA,
                SUM(M1.TOWER_BASEMENT_AREA) AS TOWER_BASEMENT_AREA,
                SUM(M1.UNDERGROUND_GARAGE_AREA) AS UNDERGROUND_GARAGE_AREA,
                SUM(M1.STORAGE_AREA) AS STORAGE_AREA,
                SUM(M1.STORAGE_TOTAL) AS STORAGE_TOTAL,
                SUM(M1.TOTAL_SALE_AREA) AS TOTAL_SALE_AREA,
                SUM(M1.GROUND_SALE_AREA) AS GROUND_SALE_AREA,
                SUM(M1.UNDERGROUND_SALE_AREA) AS UNDERGROUND_SALE_AREA,
                SUM(M1.TOTAL_GIVE_AREA) AS TOTAL_GIVE_AREA,
                SUM(M1.GROUND_GIVE_AREA) AS GROUND_GIVE_AREA,
                SUM(M1.UNDERGROUND_GIVE_AREA) AS UNDERGROUND_GIVE_AREA,
                SUM(M1.TOTAL_RESIDENCE) AS TOTAL_RESIDENCE,
                SUM(M1.TOTAL_BUSINESS) AS TOTAL_BUSINESS,
                SUM(M1.GROUND_CARPORT) AS GROUND_CARPORT,
                SUM(M1.RESIDENCE_BOTTOM_CARPORT) AS RESIDENCE_BOTTOM_CARPORT,
                SUM(M1.PARKING_GARAGE_CARPORT) AS PARKING_GARAGE_CARPORT,
                SUM(M1.UNDERGROUND_RFJ_CARPORT) AS UNDERGROUND_RFJ_CARPORT,
                SUM(M1.UNDERGROUND_RJ_CARPORT) AS UNDERGROUND_RJ_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_CARPORT) AS UNDERGROUND_FRFJ_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_CARPORT) AS UNDERGROUND_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_R_SALE_CARPORT) AS UNDERGROUND_R_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_SALE_CARPORT) AS UNDERGROUND_FRFJ_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_SALE_CARPORT) AS UNDERGROUND_FRJ_SALE_CARPORT,
                SUM(M1.CARPORT_TOTAL) AS CARPORT_TOTAL,
                SUM(M1.GROUND_TOTAL_CARPORT) AS GROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_CARPORT) AS UNDERGROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_RJ_CARPORT) AS UNDERGROUND_TOTAL_RJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_FRJ_CARPORT) AS UNDERGROUND_TOTAL_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_SALE_CARPORT) AS UNDERGROUND_TOTAL_SALE_CARPORT,
                periodPhaseId AS OBJ_PHASE_ID, 20 AS OBJ_TYPE,
                M1.PRODUCT_TYPE_NAME AS PRODUCT_TYPE_NAME,
                M1.PRODUCT_TYPE_JSON AS PRODUCT_TYPE_JSON
            from (
                select  moppi.*
                from MDM_OBJ_PHASE_PT_INDEX moppi
                    left join MDM_BUILD_PHASE mbp on moppi.OBJ_PHASE_ID = mbp.ID
                    left join MDM_BUILD mb on mb.ID = mbp.BUILD_ID
                where mb.PERIOD_ID = (
                    select distinct PERIOD_ID from MDM_BUILD where ID = OBJID
                ) and mbp.PHASE_ID = PHASEID and OBJ_PHASE_ID is not null
            ) M1 GROUP  BY M1.PRODUCT_TYPE_ID, M1.OPERATE_ATTRIBUTE_ID,
                     M1.OPERATE_ATTRIBUTE_NAME, M1.PRODUCT_TYPE_NAME,
                     M1.PRODUCT_TYPE_JSON, periodPhaseId;
            -- 删除当前(分期)阶段指标数据
            DELETE FROM MDM_OBJ_PHASE_INDEX B WHERE B.OBJ_PHASE_ID = periodPhaseId;
            --汇总对象(到当前分期)阶段指标表
            insert into MDM_OBJ_PHASE_INDEX(
                ID, BUILD_AREA,GROUND_CAPACITY_AREA,UNDERGROUND_CAPACITY_AREA,GROUND_UNCAPACITY_AREA,
                UNDERGROUND_UNCAPACITY_AREA,GROUND_TOTAL_BUILD_AREA,UNDERGROUND_TOTAL_BUILD_AREA, REFUGE_STOREY_AREA,
                MECHANICAL_FLOOR_AREA,EMPTY_SPACE_AREA,TOWER_BASEMENT_AREA,UNDERGROUND_GARAGE_AREA,STORAGE_AREA,
                STORAGE_TOTAL,TOTAL_SALE_AREA,GROUND_SALE_AREA,UNDERGROUND_SALE_AREA,TOTAL_GIVE_AREA,GROUND_GIVE_AREA,
                UNDERGROUND_GIVE_AREA,TOTAL_RESIDENCE,TOTAL_BUSINESS,GROUND_CARPORT,RESIDENCE_BOTTOM_CARPORT,
                PARKING_GARAGE_CARPORT,UNDERGROUND_RFJ_CARPORT,UNDERGROUND_RJ_CARPORT,UNDERGROUND_FRFJ_CARPORT,
                UNDERGROUND_FRJ_CARPORT,UNDERGROUND_R_SALE_CARPORT,UNDERGROUND_FRFJ_SALE_CARPORT,
                UNDERGROUND_FRJ_SALE_CARPORT,CARPORT_TOTAL,GROUND_TOTAL_CARPORT,UNDERGROUND_TOTAL_CARPORT,
                UNDERGROUND_TOTAL_RJ_CARPORT,UNDERGROUND_TOTAL_FRJ_CARPORT,UNDERGROUND_TOTAL_SALE_CARPORT,SALE_RATIO,
                GROUND_ENGINE_CARPORT,OVERALL_FLOORAGE_AREA,TOTAL_CAPACITY_AREA,CARPORT_RATIO,TOTAL_HOUSEHOLDS,
                OBJ_PHASE_ID,OBJ_TYPE,JBS_AREA
            )
            SELECT
                GET_UUID() AS ID,
                SUM(M1.BUILD_AREA) AS BUILD_AREA,
                SUM(M1.GROUND_CAPACITY_AREA) AS GROUND_CAPACITY_AREA,
                SUM(M1.UNDERGROUND_CAPACITY_AREA) AS UNDERGROUND_CAPACITY_AREA,
                SUM(M1.GROUND_UNCAPACITY_AREA) AS GROUND_UNCAPACITY_AREA,
                SUM(M1.UNDERGROUND_UNCAPACITY_AREA) AS UNDERGROUND_UNCAPACITY_AREA,
                SUM(M1.GROUND_TOTAL_BUILD_AREA) AS GROUND_TOTAL_BUILD_AREA,
                SUM(M1.UNDERGROUND_TOTAL_BUILD_AREA) AS UNDERGROUND_TOTAL_BUILD_AREA,
                SUM(M1.REFUGE_STOREY_AREA) AS REFUGE_STOREY_AREA,
                SUM(M1.MECHANICAL_FLOOR_AREA) AS MECHANICAL_FLOOR_AREA,
                SUM(M1.EMPTY_SPACE_AREA) AS EMPTY_SPACE_AREA,
                SUM(M1.TOWER_BASEMENT_AREA) AS TOWER_BASEMENT_AREA,
                SUM(M1.UNDERGROUND_GARAGE_AREA) AS UNDERGROUND_GARAGE_AREA,
                SUM(M1.STORAGE_AREA) AS STORAGE_AREA,
                SUM(M1.STORAGE_TOTAL) AS STORAGE_TOTAL,
                SUM(M1.TOTAL_SALE_AREA) AS TOTAL_SALE_AREA,
                SUM(M1.GROUND_SALE_AREA) AS GROUND_SALE_AREA,
                SUM(M1.UNDERGROUND_SALE_AREA) AS UNDERGROUND_SALE_AREA,
                SUM(M1.TOTAL_GIVE_AREA) AS TOTAL_GIVE_AREA,
                SUM(M1.GROUND_GIVE_AREA) AS GROUND_GIVE_AREA,
                SUM(M1.UNDERGROUND_GIVE_AREA) AS UNDERGROUND_GIVE_AREA,
                SUM(M1.TOTAL_RESIDENCE) AS TOTAL_RESIDENCE,
                SUM(M1.TOTAL_BUSINESS) AS TOTAL_BUSINESS,
                SUM(M1.GROUND_CARPORT) AS GROUND_CARPORT,
                SUM(M1.RESIDENCE_BOTTOM_CARPORT) AS RESIDENCE_BOTTOM_CARPORT,
                SUM(M1.PARKING_GARAGE_CARPORT) AS PARKING_GARAGE_CARPORT,
                SUM(M1.UNDERGROUND_RFJ_CARPORT) AS UNDERGROUND_RFJ_CARPORT,
                SUM(M1.UNDERGROUND_RJ_CARPORT) AS UNDERGROUND_RJ_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_CARPORT) AS UNDERGROUND_FRFJ_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_CARPORT) AS UNDERGROUND_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_R_SALE_CARPORT) AS UNDERGROUND_R_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_SALE_CARPORT) AS UNDERGROUND_FRFJ_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_SALE_CARPORT) AS UNDERGROUND_FRJ_SALE_CARPORT,
                SUM(M1.CARPORT_TOTAL) AS CARPORT_TOTAL,
                SUM(M1.GROUND_TOTAL_CARPORT) AS GROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_CARPORT) AS UNDERGROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_RJ_CARPORT) AS UNDERGROUND_TOTAL_RJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_FRJ_CARPORT) AS UNDERGROUND_TOTAL_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_SALE_CARPORT) AS UNDERGROUND_TOTAL_SALE_CARPORT,
                SUM(M1.SALE_RATIO) AS SALE_RATIO,
                SUM(M1.GROUND_ENGINE_CARPORT) AS GROUND_ENGINE_CARPORT,
                SUM(M1.OVERALL_FLOORAGE_AREA) AS OVERALL_FLOORAGE_AREA,
                SUM(M1.TOTAL_CAPACITY_AREA) AS TOTAL_CAPACITY_AREA,
                SUM(M1.CARPORT_RATIO) AS CARPORT_RATIO,
                SUM(M1.TOTAL_HOUSEHOLDS) AS TOTAL_HOUSEHOLDS,
                objPhaseId AS OBJ_PHASE_ID,
                20 AS OBJ_TYPE,
                SUM(M1.JBS_AREA) AS JBS_AREA
            from (
                select  mopi.*, periodPhaseId objPhaseId
                from MDM_OBJ_PHASE_INDEX mopi
                    left join MDM_BUILD_PHASE mbp on mopi.OBJ_PHASE_ID = mbp.ID
                    left join MDM_BUILD mb on mb.ID = mbp.BUILD_ID
                where mb.PERIOD_ID = (
                    select distinct PERIOD_ID from MDM_BUILD where ID = OBJID
                ) and mbp.PHASE_ID = PHASEID and OBJ_PHASE_ID is not null
            ) M1 GROUP BY objPhaseId;
            -- 获取项目ID;
            begin
                select mpp3.ID into projectPhaseId
                from MDM_PERIOD_PHASE mpp1
                    left join MDM_PERIOD mp1 on mp1.ID = mpp1.PERIOD_ID
                    left join MDM_PERIOD mp2 on mp2.PERIOD_VERSION_ID = mp1.PERIOD_VERSION_ID
                    left join MDM_PERIOD_PHASE mpp2 on mpp2.PERIOD_ID = mp2.ID
                    and mpp1.PHASE_ORDER = mpp2.PHASE_ORDER
                    left join MDM_PERIOD_VERSION mpv on mpv.ID = mp2.PERIOD_VERSION_ID
                    left join MDM_PROJECT_PHASE mpp3 on mpp3.PROJ_ID = mpv.PROJECT_ORIGINAL_ID
                where mpp1.ID = periodPhaseId and mpp3.PHASE_ORDER = phaseOrder and ROWNUM < 2;
            exception when others then
                DBMS_OUTPUT.PUT_LINE('未获取到项目阶段信息, [20:30], [' || OBJID || ',' || PHASEID || ']');
                projectPhaseId := GET_UUID();
            end;
            -- 删除项目业态指标数据
            DELETE FROM MDM_OBJ_PHASE_PT_INDEX where OBJ_PHASE_ID = projectPhaseId;
            -- 添加业态指标数据(从分期合并到项目)
            insert into MDM_OBJ_PHASE_PT_INDEX
            select
                GET_UUID() AS ID,
                M1.PRODUCT_TYPE_ID AS PRODUCT_TYPE_ID,
                M1.OPERATE_ATTRIBUTE_ID AS OPERATE_ATTRIBUTE_ID,
                M1.OPERATE_ATTRIBUTE_NAME AS OPERATE_ATTRIBUTE_NAME,
                SUM(M1.BUILD_AREA) AS BUILD_AREA,
                SUM(M1.GROUND_CAPACITY_AREA) AS GROUND_CAPACITY_AREA,
                SUM(M1.UNDERGROUND_CAPACITY_AREA) AS UNDERGROUND_CAPACITY_AREA,
                SUM(M1.GROUND_UNCAPACITY_AREA) AS GROUND_UNCAPACITY_AREA,
                SUM(M1.UNDERGROUND_UNCAPACITY_AREA) AS UNDERGROUND_UNCAPACITY_AREA,
                SUM(M1.GROUND_TOTAL_BUILD_AREA) AS GROUND_TOTAL_BUILD_AREA,
                SUM(M1.UNDERGROUND_TOTAL_BUILD_AREA) AS UNDERGROUND_TOTAL_BUILD_AREA,
                SUM(M1.REFUGE_STOREY_AREA) AS REFUGE_STOREY_AREA,
                SUM(M1.MECHANICAL_FLOOR_AREA) AS MECHANICAL_FLOOR_AREA,
                SUM(M1.EMPTY_SPACE_AREA) AS EMPTY_SPACE_AREA,
                SUM(M1.TOWER_BASEMENT_AREA) AS TOWER_BASEMENT_AREA,
                SUM(M1.UNDERGROUND_GARAGE_AREA) AS UNDERGROUND_GARAGE_AREA,
                SUM(M1.STORAGE_AREA) AS STORAGE_AREA,
                SUM(M1.STORAGE_TOTAL) AS STORAGE_TOTAL,
                SUM(M1.TOTAL_SALE_AREA) AS TOTAL_SALE_AREA,
                SUM(M1.GROUND_SALE_AREA) AS GROUND_SALE_AREA,
                SUM(M1.UNDERGROUND_SALE_AREA) AS UNDERGROUND_SALE_AREA,
                SUM(M1.TOTAL_GIVE_AREA) AS TOTAL_GIVE_AREA,
                SUM(M1.GROUND_GIVE_AREA) AS GROUND_GIVE_AREA,
                SUM(M1.UNDERGROUND_GIVE_AREA) AS UNDERGROUND_GIVE_AREA,
                SUM(M1.TOTAL_RESIDENCE) AS TOTAL_RESIDENCE,
                SUM(M1.TOTAL_BUSINESS) AS TOTAL_BUSINESS,
                SUM(M1.GROUND_CARPORT) AS GROUND_CARPORT,
                SUM(M1.RESIDENCE_BOTTOM_CARPORT) AS RESIDENCE_BOTTOM_CARPORT,
                SUM(M1.PARKING_GARAGE_CARPORT) AS PARKING_GARAGE_CARPORT,
                SUM(M1.UNDERGROUND_RFJ_CARPORT) AS UNDERGROUND_RFJ_CARPORT,
                SUM(M1.UNDERGROUND_RJ_CARPORT) AS UNDERGROUND_RJ_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_CARPORT) AS UNDERGROUND_FRFJ_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_CARPORT) AS UNDERGROUND_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_R_SALE_CARPORT) AS UNDERGROUND_R_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_SALE_CARPORT) AS UNDERGROUND_FRFJ_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_SALE_CARPORT) AS UNDERGROUND_FRJ_SALE_CARPORT,
                SUM(M1.CARPORT_TOTAL) AS CARPORT_TOTAL,
                SUM(M1.GROUND_TOTAL_CARPORT) AS GROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_CARPORT) AS UNDERGROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_RJ_CARPORT) AS UNDERGROUND_TOTAL_RJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_FRJ_CARPORT) AS UNDERGROUND_TOTAL_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_SALE_CARPORT) AS UNDERGROUND_TOTAL_SALE_CARPORT,
                objPhaseId AS OBJ_PHASE_ID, 0 AS OBJ_TYPE,
                M1.PRODUCT_TYPE_NAME AS PRODUCT_TYPE_NAME,
                M1.PRODUCT_TYPE_JSON AS PRODUCT_TYPE_JSON
            from (
                select moppi.*, projectPhaseId objPhaseId
                from MDM_PERIOD_PHASE mpp1
                    left join MDM_PERIOD mp1 on mp1.ID = mpp1.PERIOD_ID
                    left join MDM_PERIOD mp2 on mp2.PERIOD_VERSION_ID = mp1.PERIOD_VERSION_ID
                    left join MDM_PERIOD_PHASE mpp2 on mpp2.PERIOD_ID = mp2.ID
                    and mpp1.PHASE_ORDER = mpp2.PHASE_ORDER
                    left join MDM_OBJ_PHASE_PT_INDEX moppi on moppi.OBJ_PHASE_ID = mpp2.ID
                where mpp1.ID = periodPhaseId and OBJ_PHASE_ID is not null
            )M1 group by M1.PRODUCT_TYPE_ID, M1.OPERATE_ATTRIBUTE_ID,
                    M1.OPERATE_ATTRIBUTE_NAME, M1.PRODUCT_TYPE_NAME,
                    M1.PRODUCT_TYPE_JSON, objPhaseId;
            -- 删除项目阶段指标表
            DELETE FROM MDM_OBJ_PHASE_INDEX where OBJ_PHASE_ID = projectPhaseId;
            -- 添加阶段指标表(从分期到项目)
            insert into MDM_OBJ_PHASE_INDEX(
                ID, BUILD_AREA,GROUND_CAPACITY_AREA,UNDERGROUND_CAPACITY_AREA,GROUND_UNCAPACITY_AREA,
                UNDERGROUND_UNCAPACITY_AREA,GROUND_TOTAL_BUILD_AREA,UNDERGROUND_TOTAL_BUILD_AREA, REFUGE_STOREY_AREA,
                MECHANICAL_FLOOR_AREA,EMPTY_SPACE_AREA,TOWER_BASEMENT_AREA,UNDERGROUND_GARAGE_AREA,STORAGE_AREA,
                STORAGE_TOTAL,TOTAL_SALE_AREA,GROUND_SALE_AREA,UNDERGROUND_SALE_AREA,TOTAL_GIVE_AREA,GROUND_GIVE_AREA,
                UNDERGROUND_GIVE_AREA,TOTAL_RESIDENCE,TOTAL_BUSINESS,GROUND_CARPORT,RESIDENCE_BOTTOM_CARPORT,
                PARKING_GARAGE_CARPORT,UNDERGROUND_RFJ_CARPORT,UNDERGROUND_RJ_CARPORT,UNDERGROUND_FRFJ_CARPORT,
                UNDERGROUND_FRJ_CARPORT,UNDERGROUND_R_SALE_CARPORT,UNDERGROUND_FRFJ_SALE_CARPORT,
                UNDERGROUND_FRJ_SALE_CARPORT,CARPORT_TOTAL,GROUND_TOTAL_CARPORT,UNDERGROUND_TOTAL_CARPORT,
                UNDERGROUND_TOTAL_RJ_CARPORT,UNDERGROUND_TOTAL_FRJ_CARPORT,UNDERGROUND_TOTAL_SALE_CARPORT,SALE_RATIO,
                GROUND_ENGINE_CARPORT,OVERALL_FLOORAGE_AREA,TOTAL_CAPACITY_AREA,CARPORT_RATIO,TOTAL_HOUSEHOLDS,
                OBJ_PHASE_ID,OBJ_TYPE,JBS_AREA
            )
            SELECT
                GET_UUID() AS ID,
                SUM(M1.BUILD_AREA) AS BUILD_AREA,
                SUM(M1.GROUND_CAPACITY_AREA) AS GROUND_CAPACITY_AREA,
                SUM(M1.UNDERGROUND_CAPACITY_AREA) AS UNDERGROUND_CAPACITY_AREA,
                SUM(M1.GROUND_UNCAPACITY_AREA) AS GROUND_UNCAPACITY_AREA,
                SUM(M1.UNDERGROUND_UNCAPACITY_AREA) AS UNDERGROUND_UNCAPACITY_AREA,
                SUM(M1.GROUND_TOTAL_BUILD_AREA) AS GROUND_TOTAL_BUILD_AREA,
                SUM(M1.UNDERGROUND_TOTAL_BUILD_AREA) AS UNDERGROUND_TOTAL_BUILD_AREA,
                SUM(M1.REFUGE_STOREY_AREA) AS REFUGE_STOREY_AREA,
                SUM(M1.MECHANICAL_FLOOR_AREA) AS MECHANICAL_FLOOR_AREA,
                SUM(M1.EMPTY_SPACE_AREA) AS EMPTY_SPACE_AREA,
                SUM(M1.TOWER_BASEMENT_AREA) AS TOWER_BASEMENT_AREA,
                SUM(M1.UNDERGROUND_GARAGE_AREA) AS UNDERGROUND_GARAGE_AREA,
                SUM(M1.STORAGE_AREA) AS STORAGE_AREA,
                SUM(M1.STORAGE_TOTAL) AS STORAGE_TOTAL,
                SUM(M1.TOTAL_SALE_AREA) AS TOTAL_SALE_AREA,
                SUM(M1.GROUND_SALE_AREA) AS GROUND_SALE_AREA,
                SUM(M1.UNDERGROUND_SALE_AREA) AS UNDERGROUND_SALE_AREA,
                SUM(M1.TOTAL_GIVE_AREA) AS TOTAL_GIVE_AREA,
                SUM(M1.GROUND_GIVE_AREA) AS GROUND_GIVE_AREA,
                SUM(M1.UNDERGROUND_GIVE_AREA) AS UNDERGROUND_GIVE_AREA,
                SUM(M1.TOTAL_RESIDENCE) AS TOTAL_RESIDENCE,
                SUM(M1.TOTAL_BUSINESS) AS TOTAL_BUSINESS,
                SUM(M1.GROUND_CARPORT) AS GROUND_CARPORT,
                SUM(M1.RESIDENCE_BOTTOM_CARPORT) AS RESIDENCE_BOTTOM_CARPORT,
                SUM(M1.PARKING_GARAGE_CARPORT) AS PARKING_GARAGE_CARPORT,
                SUM(M1.UNDERGROUND_RFJ_CARPORT) AS UNDERGROUND_RFJ_CARPORT,
                SUM(M1.UNDERGROUND_RJ_CARPORT) AS UNDERGROUND_RJ_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_CARPORT) AS UNDERGROUND_FRFJ_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_CARPORT) AS UNDERGROUND_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_R_SALE_CARPORT) AS UNDERGROUND_R_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_SALE_CARPORT) AS UNDERGROUND_FRFJ_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_SALE_CARPORT) AS UNDERGROUND_FRJ_SALE_CARPORT,
                SUM(M1.CARPORT_TOTAL) AS CARPORT_TOTAL,
                SUM(M1.GROUND_TOTAL_CARPORT) AS GROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_CARPORT) AS UNDERGROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_RJ_CARPORT) AS UNDERGROUND_TOTAL_RJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_FRJ_CARPORT) AS UNDERGROUND_TOTAL_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_SALE_CARPORT) AS UNDERGROUND_TOTAL_SALE_CARPORT,
                SUM(M1.SALE_RATIO) AS SALE_RATIO,
                SUM(M1.GROUND_ENGINE_CARPORT) AS GROUND_ENGINE_CARPORT,
                SUM(M1.OVERALL_FLOORAGE_AREA) AS OVERALL_FLOORAGE_AREA,
                SUM(M1.TOTAL_CAPACITY_AREA) AS TOTAL_CAPACITY_AREA,
                SUM(M1.CARPORT_RATIO) AS CARPORT_RATIO,
                SUM(M1.TOTAL_HOUSEHOLDS) AS TOTAL_HOUSEHOLDS,
                objPhaseId AS OBJ_PHASE_ID,
                0 AS OBJ_TYPE,
                SUM(M1.JBS_AREA) AS JBS_AREA
            from (
                select moppi.*, projectPhaseId objPhaseId
                from MDM_PERIOD_PHASE mpp1
                    left join MDM_PERIOD mp1 on mp1.ID = mpp1.PERIOD_ID
                    left join MDM_PERIOD mp2 on mp2.PERIOD_VERSION_ID = mp1.PERIOD_VERSION_ID
                    left join MDM_PERIOD_PHASE mpp2 on mpp2.PERIOD_ID = mp2.ID
                    and mpp1.PHASE_ORDER = mpp2.PHASE_ORDER
                    left join MDM_OBJ_PHASE_INDEX moppi on moppi.OBJ_PHASE_ID = mpp2.ID
                where mpp1.ID = periodPhaseId and OBJ_PHASE_ID is not null
            ) M1 GROUP BY objPhaseId;
        END IF;
    END IF;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_MASTER_DATA_SUM_V2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_MASTER_DATA_SUM_V2" (
    phaseId           IN VARCHAR2 , --阶段id
    objType           IN VARCHAR2 , --对象类型（项目、宗地、分期、楼栋）
    objId             IN VARCHAR2 , --对象id
    code              OUT INTEGER, -- 状态码
    errMsg            OUT VARCHAR2 -- 错误信息
) AS
    -- 项目主数据汇总-- 作者：杨明-- 日期:2019/11/20
    -- change @author 韩金明 @date 2020-3-30
    periodPhaseId varchar(36) := '';
    tempObjId varchar(36) := objId;
    tempObjPhaseId varchar(36);
    tempObjType varchar(36) := objType;
    precision varchar(36):='FM999999990.00';
BEGIN
    code := 0;
    errMsg := '执行成功';
    -- 从宗地汇总到项目
    if tempObjType = 10 then
        -- 获取项目id和项目阶段id
        begin
            SELECT mpp.ID, mpp.PROJ_ID into tempObjPhaseId, tempObjId
            FROM MDM_PARCEL mp1
                     LEFT JOIN MDM_PROJECT mp2 ON mp2.ID = mp1.PROJECT_ID
                     LEFT JOIN MDM_PROJECT_PHASE mpp ON mpp.PROJ_ID = mp2.PROJECT_ORIGINAL_ID
                AND mp2.APPROVAL_STATUS = '已审核'
            WHERE mp1.PARCEL_ORIGINAL_ID = OBJID AND mpp.PHASE_ID = PHASEID;
        exception when others then
            code := 10400;
            errMsg := '未找到对应项目信息';
            return;
        end;
        -- 删除项目业态信息
        DELETE FROM MDM_OBJ_PHASE_PT_INDEX moppi WHERE moppi.OBJ_PHASE_ID = tempObjPhaseId AND moppi.OBJ_TYPE = 0;
        -- 添加项目业态信息
        insert into MDM_OBJ_PHASE_PT_INDEX(
            id,  product_type_id, operate_attribute_id,
            operate_attribute_name, build_area, ground_capacity_area, underground_capacity_area,
            ground_uncapacity_area, underground_uncapacity_area, ground_total_build_area,
            underground_total_build_area, refuge_storey_area, mechanical_floor_area, empty_space_area,
            tower_basement_area, underground_garage_area, storage_area, storage_total, total_sale_area,
            ground_sale_area, underground_sale_area, total_give_area, ground_give_area, underground_give_area,
            total_residence, total_business, ground_carport, residence_bottom_carport, parking_garage_carport,
            underground_rfj_carport, underground_rj_carport, underground_frfj_carport, underground_frj_carport,
            underground_r_sale_carport, underground_frfj_sale_carport, underground_frj_sale_carport, carport_total,
            ground_total_carport, underground_total_carport, underground_total_rj_carport,
            underground_total_frj_carport, underground_total_sale_carport, obj_phase_id, obj_type,
            product_type_name, product_type_json)
        select GET_UUID(), product_type_id, operate_attribute_id,
               operate_attribute_name, sum(build_area) build_area, sum(ground_capacity_area) ground_capacity_area,
               sum(underground_capacity_area) underground_capacity_area,
               sum(ground_uncapacity_area) ground_uncapacity_area,
               sum(underground_uncapacity_area) underground_uncapacity_area,
               sum(ground_total_build_area) ground_total_build_area,
               sum(underground_total_build_area) underground_total_build_area, sum(refuge_storey_area) refuge_storey_area,
               sum(mechanical_floor_area) mechanical_floor_area, sum(empty_space_area) empty_space_area,
               sum(tower_basement_area) tower_basement_area, sum(underground_garage_area) underground_garage_area,
               sum(storage_area) storage_area, sum(storage_total) storage_total, sum(total_sale_area) total_sale_area,
               sum(ground_sale_area) ground_sale_area, sum(underground_sale_area) underground_sale_area,
               sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
               sum(underground_give_area) underground_give_area, sum(total_residence) total_residence,
               sum(total_business) total_business,sum(ground_carport) ground_carport,
               sum(residence_bottom_carport) residence_bottom_carport, sum(parking_garage_carport) parking_garage_carport,
               sum(underground_rfj_carport) underground_rfj_carport, sum(underground_rj_carport) underground_rj_carport,
               sum(underground_frfj_carport) underground_frfj_carport, sum(underground_frj_carport) underground_frj_carport,
               sum(underground_r_sale_carport) underground_r_sale_carport,
               sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
               sum(underground_frj_sale_carport) underground_frj_sale_carport, sum(carport_total) carport_total,
               sum(ground_total_carport) ground_total_carport, sum(underground_total_carport) underground_total_carport,
               sum(underground_total_rj_carport) underground_total_rj_carport,
               sum(underground_total_frj_carport) underground_total_frj_carport,
               sum(underground_total_sale_carport) underground_total_sale_carport, tempObjPhaseId obj_phase_id,
               '0' objType, product_type_name, product_type_json
        from SYS_PARCEL mp1
                 left join MDM_PARCEL_PHASE mpp1 on mpp1.PAECEL_ID = mp1.ID
                 left join MDM_PROJECT mp2 on mp1.PROJECT_ID = mp2.PROJECT_ORIGINAL_ID
                 left join MDM_OBJ_PHASE_PT_INDEX moppi on moppi.OBJ_PHASE_ID = mpp1.ID
        where mp1.PROJECT_ID = tempObjId AND mpp1.PHASE_ID = phaseId and mp2.APPROVAL_STATUS='已审核'
        group by tempObjPhaseId, product_type_id, product_type_name, operate_attribute_id,
                 product_type_json, operate_attribute_name;
        -- 删除项目阶段信息
        DELETE FROM MDM_OBJ_PHASE_INDEX moppi WHERE moppi.OBJ_PHASE_ID = tempObjPhaseId AND moppi.OBJ_TYPE = 0;
        -- 添加项目阶段信息
        insert into MDM_OBJ_PHASE_INDEX(
            id, build_area, ground_capacity_area, underground_capacity_area, ground_uncapacity_area,
            underground_uncapacity_area, ground_total_build_area, underground_total_build_area, refuge_storey_area,
            mechanical_floor_area, empty_space_area, tower_basement_area, underground_garage_area, storage_area,
            storage_total, total_sale_area, ground_sale_area, underground_sale_area, total_give_area, ground_give_area,
            underground_give_area, total_residence, total_business, ground_carport, residence_bottom_carport,
            parking_garage_carport, underground_rfj_carport, underground_rj_carport, underground_frfj_carport,
            underground_frj_carport, underground_r_sale_carport, underground_frfj_sale_carport, underground_frj_sale_carport,
            carport_total, ground_total_carport, underground_total_carport, underground_total_rj_carport,
            underground_total_frj_carport, underground_total_sale_carport, construction_land_area,
            expropriation_green_space_area, expropriation_road_area, other_expropriation_area, total_road_area,
            total_green_land_area, demonstration_area, plot_ratio, build_density, greening_rate, sale_ratio,
            ground_engine_carport, total_site_area, confiscated_area, overall_floorage_area, total_capacity_area,
            construction_plot_ratio, total_site_area_plot_ratio, construction_build_density, total_site_area_build_density,
            construction_greening_rate, total_site_area_greening_rate, carport_ratio, total_households, obj_phase_id,
            obj_type, jbs_area
        )
        select
            GET_UUID(), sum(build_area) build_area, sum(ground_capacity_area) ground_capacity_area,
            sum(underground_capacity_area) underground_capacity_area,sum(ground_uncapacity_area) ground_uncapacity_area,
            sum(underground_uncapacity_area) underground_uncapacity_area, sum(ground_total_build_area) ground_total_build_area,
            sum(underground_total_build_area) underground_total_build_area, sum(refuge_storey_area) refuge_storey_area,
            sum(mechanical_floor_area) mechanical_floor_area, sum(empty_space_area) empty_space_area,
            sum(tower_basement_area) tower_basement_area,sum(underground_garage_area) underground_garage_area,
            sum(storage_area) storage_area, sum(storage_total) storage_total,sum(total_sale_area) total_sale_area,
            sum(ground_sale_area) ground_sale_area,sum(underground_sale_area) underground_sale_area,
            sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
            sum(underground_give_area) underground_give_area, sum(total_residence) total_residence,
            sum(total_business) total_business, sum(ground_carport) ground_carport,
            sum(residence_bottom_carport) residence_bottom_carport, sum(parking_garage_carport) parking_garage_carport,
            sum(underground_rfj_carport) underground_rfj_carport, sum(underground_rj_carport) underground_rj_carport,
            sum(underground_frfj_carport) underground_frfj_carport,
            sum(underground_frj_carport) underground_frj_carport,
            sum(underground_r_sale_carport) underground_r_sale_carport,
            sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
            sum(underground_frj_sale_carport) underground_frj_sale_carport, sum(carport_total) carport_total,
            sum(ground_total_carport) ground_total_carport, sum(underground_total_carport) underground_total_carport,
            sum(underground_total_rj_carport) underground_total_rj_carport,
            sum(underground_total_frj_carport) underground_total_frj_carport,
            sum(underground_total_sale_carport) underground_total_sale_carport,
            sum(construction_land_area) construction_land_area,
            sum(expropriation_green_space_area) expropriation_green_space_area,
            sum(expropriation_road_area) expropriation_road_area, sum(other_expropriation_area) other_expropriation_area,
            sum(total_road_area) total_road_area, sum(total_green_land_area) total_green_land_area,
            sum(demonstration_area) demonstration_area, sum(plot_ratio) plot_ratio, sum(build_density) build_density,
            sum(greening_rate) greening_rate, sum(sale_ratio) sale_ratio, sum(ground_engine_carport) ground_engine_carport,
            sum(total_site_area) total_site_area, sum(confiscated_area) confiscated_area,
            sum(overall_floorage_area) overall_floorage_area, sum(total_capacity_area) total_capacity_area,
            sum(construction_plot_ratio) construction_plot_ratio, sum(total_site_area_plot_ratio) total_site_area_plot_ratio,
            sum(construction_build_density) construction_build_density,
            sum(total_site_area_build_density) total_site_area_build_density,
            sum(construction_greening_rate) construction_greening_rate,
            sum(total_site_area_greening_rate) total_site_area_greening_rate, sum(carport_ratio) carport_ratio,
            sum(total_households) total_households, tempObjPhaseId objPhaseId,
            '0' obj_type, sum(jbs_area) jbs_area
        from SYS_PARCEL mp1
                 left join MDM_PARCEL_PHASE mpp1 on mpp1.PAECEL_ID = mp1.ID
                 left join MDM_PROJECT mp2 on mp1.PROJECT_ID = mp2.PROJECT_ORIGINAL_ID
                 left join MDM_OBJ_PHASE_INDEX moppi on moppi.OBJ_PHASE_ID = mpp1.ID
        where mp1.PROJECT_ID = tempObjId AND mpp1.PHASE_ID = phaseId and mp2.APPROVAL_STATUS='已审核'
        group by tempObjPhaseId;
    end if;
    -- 从楼栋上汇总到分期，最后会修改tempObjType和tempObjId的值 触发从分期汇总到项目
    if tempObjType = 30 then
        -- 获取分期原始ID和分期阶段ID
        begin
            select mpp.ID, mp.PERIOD_ORIGINAL_ID into tempObjPhaseId, tempObjId
            from MDM_BUILD mb
                     left join MDM_PERIOD mp on mb.PERIOD_ID = mp.PERIOD_ORIGINAL_ID
                     inner join MDM_PERIOD_VERSION mpv on mpv.ID = mp.PERIOD_VERSION_ID
                     left join MDM_PERIOD_PHASE mpp on mpp.PERIOD_ID = mp.PERIOD_ORIGINAL_ID
            where mb.id = tempObjId and mpp.PHASE_ID=phaseId and mpv.APPROVAL_STATUS='已审核';
        exception when others then
            code := 10400;
            errMsg := '未找到对应项目信息';
            return;
        end;
        -- 删除分期业态信息
        DELETE FROM MDM_OBJ_PHASE_PT_INDEX moppi WHERE moppi.OBJ_PHASE_ID = tempObjPhaseId AND moppi.OBJ_TYPE = 20;
        -- 添加分期业态信息
        insert into MDM_OBJ_PHASE_PT_INDEX(
            id,  product_type_id, operate_attribute_id,
            operate_attribute_name, build_area, ground_capacity_area, underground_capacity_area,
            ground_uncapacity_area, underground_uncapacity_area, ground_total_build_area,
            underground_total_build_area, refuge_storey_area, mechanical_floor_area, empty_space_area,
            tower_basement_area, underground_garage_area, storage_area, storage_total, total_sale_area,
            ground_sale_area, underground_sale_area, total_give_area, ground_give_area, underground_give_area,
            total_residence, total_business, ground_carport, residence_bottom_carport, parking_garage_carport,
            underground_rfj_carport, underground_rj_carport, underground_frfj_carport, underground_frj_carport,
            underground_r_sale_carport, underground_frfj_sale_carport, underground_frj_sale_carport, carport_total,
            ground_total_carport, underground_total_carport, underground_total_rj_carport,
            underground_total_frj_carport, underground_total_sale_carport, obj_phase_id, obj_type,
            product_type_name, product_type_json)
        select GET_UUID(), product_type_id, operate_attribute_id,
               operate_attribute_name, sum(build_area) build_area, sum(ground_capacity_area) ground_capacity_area,
               sum(underground_capacity_area) underground_capacity_area,
               sum(ground_uncapacity_area) ground_uncapacity_area,
               sum(underground_uncapacity_area) underground_uncapacity_area,
               sum(ground_total_build_area) ground_total_build_area,
               sum(underground_total_build_area) underground_total_build_area, sum(refuge_storey_area) refuge_storey_area,
               sum(mechanical_floor_area) mechanical_floor_area, sum(empty_space_area) empty_space_area,
               sum(tower_basement_area) tower_basement_area, sum(underground_garage_area) underground_garage_area,
               sum(storage_area) storage_area, sum(storage_total) storage_total, sum(total_sale_area) total_sale_area,
               sum(ground_sale_area) ground_sale_area, sum(underground_sale_area) underground_sale_area,
               sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
               sum(underground_give_area) underground_give_area, sum(total_residence) total_residence,
               sum(total_business) total_business,sum(ground_carport) ground_carport,
               sum(residence_bottom_carport) residence_bottom_carport, sum(parking_garage_carport) parking_garage_carport,
               sum(underground_rfj_carport) underground_rfj_carport, sum(underground_rj_carport) underground_rj_carport,
               sum(underground_frfj_carport) underground_frfj_carport, sum(underground_frj_carport) underground_frj_carport,
               sum(underground_r_sale_carport) underground_r_sale_carport,
               sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
               sum(underground_frj_sale_carport) underground_frj_sale_carport, sum(carport_total) carport_total,
               sum(ground_total_carport) ground_total_carport, sum(underground_total_carport) underground_total_carport,
               sum(underground_total_rj_carport) underground_total_rj_carport,
               sum(underground_total_frj_carport) underground_total_frj_carport,
               sum(underground_total_sale_carport) underground_total_sale_carport, tempObjPhaseId obj_phase_id,
               '20' objType, product_type_name, product_type_json
        from MDM_BUILD mb
                 left join MDM_BUILD_PHASE mbp on mbp.BUILD_ID = mb.ID
                 inner join MDM_OBJ_PHASE_PT_INDEX moppi on moppi.OBJ_PHASE_ID = mbp.ID
        where mb.PERIOD_ID = tempObjId and mbp.PHASE_ID= phaseId
        group by tempObjPhaseId, product_type_id, product_type_name, operate_attribute_id,
                 product_type_json, operate_attribute_name;
        -- 更新业态objPhaseId 用户更新可修改的字段
        update MDM_OBJ_PHASE_INDEX set OBJ_PHASE_ID= 'temp' || regexp_replace(tempObjPhaseId, '-', '')
        where OBJ_PHASE_ID = tempObjPhaseId;
        -- 删除分期阶段信息
        DELETE FROM MDM_OBJ_PHASE_INDEX moppi WHERE moppi.OBJ_PHASE_ID = tempObjPhaseId AND moppi.OBJ_TYPE = 20;
        -- 添加分期阶段信息
        insert into MDM_OBJ_PHASE_INDEX(
            id, build_area, ground_capacity_area, underground_capacity_area, ground_uncapacity_area,
            underground_uncapacity_area, ground_total_build_area, underground_total_build_area, refuge_storey_area,
            mechanical_floor_area, empty_space_area, tower_basement_area, underground_garage_area, storage_area,
            storage_total, total_sale_area, ground_sale_area, underground_sale_area, total_give_area, ground_give_area,
            underground_give_area, total_residence, total_business, ground_carport, residence_bottom_carport,
            parking_garage_carport, underground_rfj_carport, underground_rj_carport, underground_frfj_carport,
            underground_frj_carport, underground_r_sale_carport, underground_frfj_sale_carport, underground_frj_sale_carport,
            carport_total, ground_total_carport, underground_total_carport, underground_total_rj_carport,
            underground_total_frj_carport, underground_total_sale_carport, construction_land_area,
            expropriation_green_space_area, expropriation_road_area, other_expropriation_area, total_road_area,
            total_green_land_area, demonstration_area, plot_ratio, build_density, greening_rate, sale_ratio,
            ground_engine_carport, total_site_area, confiscated_area, overall_floorage_area, total_capacity_area,
            construction_plot_ratio, total_site_area_plot_ratio, construction_build_density, total_site_area_build_density,
            construction_greening_rate, total_site_area_greening_rate, carport_ratio, total_households, obj_phase_id,
            obj_type, jbs_area
        )
        select ID, build_area, ground_capacity_area, underground_capacity_area, ground_uncapacity_area,
               underground_uncapacity_area, ground_total_build_area, underground_total_build_area, refuge_storey_area,
               mechanical_floor_area, empty_space_area, tower_basement_area, underground_garage_area, storage_area,
               storage_total, total_sale_area, ground_sale_area, underground_sale_area, total_give_area,
               ground_give_area, underground_give_area, total_residence, total_business, ground_carport,
               residence_bottom_carport, parking_garage_carport, underground_rfj_carport, underground_rj_carport,
               underground_frfj_carport, underground_frj_carport, underground_r_sale_carport,
               underground_frfj_sale_carport, underground_frj_sale_carport, carport_total, ground_total_carport,
               underground_total_carport, underground_total_rj_carport, underground_total_frj_carport,
               underground_total_sale_carport, mopi2.construction_land_area, mopi2.expropriation_green_space_area,
               mopi2.expropriation_road_area, mopi2.other_expropriation_area, mopi2.total_road_area,
               mopi2.total_green_land_area, mopi2.demonstration_area, mopi2.plot_ratio, mopi2.build_density,
               mopi2.greening_rate, sale_ratio, ground_engine_carport, total_site_area, confiscated_area,
               overall_floorage_area, total_capacity_area, construction_plot_ratio, total_site_area_plot_ratio,
               construction_build_density, total_site_area_build_density, construction_greening_rate,
               total_site_area_greening_rate, carport_ratio, total_households, objPhaseId, obj_type, jbs_area
        from(
                select
                    GET_UUID() ID, sum(build_area) build_area, sum(ground_capacity_area) ground_capacity_area,
                    sum(underground_capacity_area) underground_capacity_area,sum(ground_uncapacity_area) ground_uncapacity_area,
                    sum(underground_uncapacity_area) underground_uncapacity_area, sum(ground_total_build_area) ground_total_build_area,
                    sum(underground_total_build_area) underground_total_build_area, sum(refuge_storey_area) refuge_storey_area,
                    sum(mechanical_floor_area) mechanical_floor_area, sum(empty_space_area) empty_space_area,
                    sum(tower_basement_area) tower_basement_area,sum(underground_garage_area) underground_garage_area,
                    sum(storage_area) storage_area, sum(storage_total) storage_total,sum(total_sale_area) total_sale_area,
                    sum(ground_sale_area) ground_sale_area,sum(underground_sale_area) underground_sale_area,
                    sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
                    sum(underground_give_area) underground_give_area, sum(total_residence) total_residence,
                    sum(total_business) total_business, sum(ground_carport) ground_carport,
                    sum(residence_bottom_carport) residence_bottom_carport, sum(parking_garage_carport) parking_garage_carport,
                    sum(underground_rfj_carport) underground_rfj_carport, sum(underground_rj_carport) underground_rj_carport,
                    sum(underground_frfj_carport) underground_frfj_carport,
                    sum(underground_frj_carport) underground_frj_carport,
                    sum(underground_r_sale_carport) underground_r_sale_carport,
                    sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
                    sum(underground_frj_sale_carport) underground_frj_sale_carport, sum(carport_total) carport_total,
                    sum(ground_total_carport) ground_total_carport, sum(underground_total_carport) underground_total_carport,
                    sum(underground_total_rj_carport) underground_total_rj_carport,
                    sum(underground_total_frj_carport) underground_total_frj_carport,
                    sum(underground_total_sale_carport) underground_total_sale_carport,
                    sum(construction_land_area) construction_land_area,
                    sum(expropriation_green_space_area) expropriation_green_space_area,
                    sum(expropriation_road_area) expropriation_road_area, sum(other_expropriation_area) other_expropriation_area,
                    sum(total_road_area) total_road_area, sum(total_green_land_area) total_green_land_area,
                    sum(demonstration_area) demonstration_area, sum(plot_ratio) plot_ratio, sum(build_density) build_density,
                    sum(greening_rate) greening_rate, sum(sale_ratio) sale_ratio, sum(ground_engine_carport) ground_engine_carport,
                    sum(total_site_area) total_site_area, sum(confiscated_area) confiscated_area,
                    sum(overall_floorage_area) overall_floorage_area, sum(total_capacity_area) total_capacity_area,
                    sum(construction_plot_ratio) construction_plot_ratio, sum(total_site_area_plot_ratio) total_site_area_plot_ratio,
                    sum(construction_build_density) construction_build_density,
                    sum(total_site_area_build_density) total_site_area_build_density,
                    sum(construction_greening_rate) construction_greening_rate,
                    sum(total_site_area_greening_rate) total_site_area_greening_rate, sum(carport_ratio) carport_ratio,
                    sum(total_households) total_households, tempObjPhaseId objPhaseId,
                    '20' obj_type, sum(jbs_area) jbs_area
                from MDM_BUILD mb
                         left join MDM_BUILD_PHASE mbp on mbp.BUILD_ID = mb.ID
                         left join MDM_OBJ_PHASE_INDEX moppi on moppi.OBJ_PHASE_ID = mbp.ID
                where mb.PERIOD_ID = tempObjId and mbp.PHASE_ID= phaseId
                group by tempObjPhaseId
            ) mopi left join (
            select OBJ_PHASE_ID, EXPROPRIATION_GREEN_SPACE_AREA, CONSTRUCTION_LAND_AREA,EXPROPRIATION_ROAD_AREA,
                   OTHER_EXPROPRIATION_AREA,TOTAL_ROAD_AREA,TOTAL_GREEN_LAND_AREA,DEMONSTRATION_AREA,PLOT_RATIO,
                   BUILD_DENSITY,GREENING_RATE
            from MDM_OBJ_PHASE_INDEX
        ) mopi2 on mopi2.OBJ_PHASE_ID='temp'||regexp_replace(mopi.objPhaseId,'-','');
        -- 删除老记录 用的是tempObjPhseId而不是OBJ_PHASE_ID 避免多线程冲突 苏然在事务控制下不会出现
        delete from MDM_OBJ_PHASE_INDEX moppi
        where moppi.OBJ_PHASE_ID = 'temp'||regexp_replace(tempObjPhaseId, '-', '');
        -- 更新tempObjType 触发汇总到项目
        tempObjType := 20;
        periodPhaseId := tempObjPhaseId;
    end if;
    -- 从分期上汇总到项目
    if tempObjType = 20 then
        -- 获取项目阶段id和项目原始id
        begin
            select mpp.ID, mpp.PROJ_ID into tempObjPhaseId, tempObjId
            from MDM_PERIOD mp1
                     inner join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
                     left join MDM_PROJECT_PHASE mpp on mpp.PROJ_ID = mpv.PROJECT_ORIGINAL_ID
            where mp1.PERIOD_ORIGINAL_ID=tempObjId
              and mpp.PHASE_ID=phaseId
              and mpv.APPROVAL_STATUS='已审核';
        exception when others then
            code := 0;
            errMsg := '获取分期信息失败';
            return;
        end;
        -- 添加项目业态信息
        DELETE FROM MDM_OBJ_PHASE_PT_INDEX moppi WHERE moppi.OBJ_PHASE_ID = tempObjPhaseId AND moppi.OBJ_TYPE = 0;
        -- 添加分期业态信息
        insert into MDM_OBJ_PHASE_PT_INDEX(
            id,  product_type_id, operate_attribute_id,
            operate_attribute_name, build_area, ground_capacity_area, underground_capacity_area,
            ground_uncapacity_area, underground_uncapacity_area, ground_total_build_area,
            underground_total_build_area, refuge_storey_area, mechanical_floor_area, empty_space_area,
            tower_basement_area, underground_garage_area, storage_area, storage_total, total_sale_area,
            ground_sale_area, underground_sale_area, total_give_area, ground_give_area, underground_give_area,
            total_residence, total_business, ground_carport, residence_bottom_carport, parking_garage_carport,
            underground_rfj_carport, underground_rj_carport, underground_frfj_carport, underground_frj_carport,
            underground_r_sale_carport, underground_frfj_sale_carport, underground_frj_sale_carport, carport_total,
            ground_total_carport, underground_total_carport, underground_total_rj_carport,
            underground_total_frj_carport, underground_total_sale_carport, obj_phase_id, obj_type,
            product_type_name, product_type_json)
        select GET_UUID(), product_type_id, operate_attribute_id,
               operate_attribute_name, sum(build_area) build_area, sum(ground_capacity_area) ground_capacity_area,
               sum(underground_capacity_area) underground_capacity_area,
               sum(ground_uncapacity_area) ground_uncapacity_area,
               sum(underground_uncapacity_area) underground_uncapacity_area,
               sum(ground_total_build_area) ground_total_build_area,
               sum(underground_total_build_area) underground_total_build_area, sum(refuge_storey_area) refuge_storey_area,
               sum(mechanical_floor_area) mechanical_floor_area, sum(empty_space_area) empty_space_area,
               sum(tower_basement_area) tower_basement_area, sum(underground_garage_area) underground_garage_area,
               sum(storage_area) storage_area, sum(storage_total) storage_total, sum(total_sale_area) total_sale_area,
               sum(ground_sale_area) ground_sale_area, sum(underground_sale_area) underground_sale_area,
               sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
               sum(underground_give_area) underground_give_area, sum(total_residence) total_residence,
               sum(total_business) total_business,sum(ground_carport) ground_carport,
               sum(residence_bottom_carport) residence_bottom_carport, sum(parking_garage_carport) parking_garage_carport,
               sum(underground_rfj_carport) underground_rfj_carport, sum(underground_rj_carport) underground_rj_carport,
               sum(underground_frfj_carport) underground_frfj_carport, sum(underground_frj_carport) underground_frj_carport,
               sum(underground_r_sale_carport) underground_r_sale_carport,
               sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
               sum(underground_frj_sale_carport) underground_frj_sale_carport, sum(carport_total) carport_total,
               sum(ground_total_carport) ground_total_carport, sum(underground_total_carport) underground_total_carport,
               sum(underground_total_rj_carport) underground_total_rj_carport,
               sum(underground_total_frj_carport) underground_total_frj_carport,
               sum(underground_total_sale_carport) underground_total_sale_carport, tempObjPhaseId obj_phase_id,
               '0' objType, product_type_name, product_type_json
        from MDM_PERIOD_VERSION mpv
                 left join MDM_PERIOD mp on mp.PERIOD_VERSION_ID = mpv.ID
                 left join MDM_PERIOD_PHASE mpp on mpp.PERIOD_ID = mp.PERIOD_ORIGINAL_ID
                 left join MDM_OBJ_PHASE_PT_INDEX moppi on moppi.OBJ_PHASE_ID = mpp.ID
        where mpv.PROJECT_ORIGINAL_ID=tempObjId and mpp.PHASE_ID=phaseId and mpv.APPROVAL_STATUS='已审核'
        group by product_type_id, operate_attribute_id, operate_attribute_name, tempObjPhaseId,
                 product_type_name, product_type_json;
        -- 删除分期阶段信息
        DELETE FROM MDM_OBJ_PHASE_INDEX moppi WHERE moppi.OBJ_PHASE_ID = tempObjPhaseId AND moppi.OBJ_TYPE = 0;
        -- 添加分期阶段信息
        insert into MDM_OBJ_PHASE_INDEX(
            id, build_area, ground_capacity_area, underground_capacity_area, ground_uncapacity_area,
            underground_uncapacity_area, ground_total_build_area, underground_total_build_area, refuge_storey_area,
            mechanical_floor_area, empty_space_area, tower_basement_area, underground_garage_area, storage_area,
            storage_total, total_sale_area, ground_sale_area, underground_sale_area, total_give_area, ground_give_area,
            underground_give_area, total_residence, total_business, ground_carport, residence_bottom_carport,
            parking_garage_carport, underground_rfj_carport, underground_rj_carport, underground_frfj_carport,
            underground_frj_carport, underground_r_sale_carport, underground_frfj_sale_carport, underground_frj_sale_carport,
            carport_total, ground_total_carport, underground_total_carport, underground_total_rj_carport,
            underground_total_frj_carport, underground_total_sale_carport, construction_land_area,
            expropriation_green_space_area, expropriation_road_area, other_expropriation_area, total_road_area,
            total_green_land_area, demonstration_area, plot_ratio, build_density, greening_rate, sale_ratio,
            ground_engine_carport, total_site_area, confiscated_area, overall_floorage_area, total_capacity_area,
            construction_plot_ratio, total_site_area_plot_ratio, construction_build_density, total_site_area_build_density,
            construction_greening_rate, total_site_area_greening_rate, carport_ratio, total_households, obj_phase_id,
            obj_type, jbs_area
        )
        select
            GET_UUID(), sum(build_area) build_area, sum(ground_capacity_area) ground_capacity_area,
            sum(underground_capacity_area) underground_capacity_area,sum(ground_uncapacity_area) ground_uncapacity_area,
            sum(underground_uncapacity_area) underground_uncapacity_area, sum(ground_total_build_area) ground_total_build_area,
            sum(underground_total_build_area) underground_total_build_area, sum(refuge_storey_area) refuge_storey_area,
            sum(mechanical_floor_area) mechanical_floor_area, sum(empty_space_area) empty_space_area,
            sum(tower_basement_area) tower_basement_area,sum(underground_garage_area) underground_garage_area,
            sum(storage_area) storage_area, sum(storage_total) storage_total,sum(total_sale_area) total_sale_area,
            sum(ground_sale_area) ground_sale_area,sum(underground_sale_area) underground_sale_area,
            sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
            sum(underground_give_area) underground_give_area, sum(total_residence) total_residence,
            sum(total_business) total_business, sum(ground_carport) ground_carport,
            sum(residence_bottom_carport) residence_bottom_carport, sum(parking_garage_carport) parking_garage_carport,
            sum(underground_rfj_carport) underground_rfj_carport, sum(underground_rj_carport) underground_rj_carport,
            sum(underground_frfj_carport) underground_frfj_carport,
            sum(underground_frj_carport) underground_frj_carport,
            sum(underground_r_sale_carport) underground_r_sale_carport,
            sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
            sum(underground_frj_sale_carport) underground_frj_sale_carport, sum(carport_total) carport_total,
            sum(ground_total_carport) ground_total_carport, sum(underground_total_carport) underground_total_carport,
            sum(underground_total_rj_carport) underground_total_rj_carport,
            sum(underground_total_frj_carport) underground_total_frj_carport,
            sum(underground_total_sale_carport) underground_total_sale_carport,
            sum(construction_land_area) construction_land_area,
            sum(expropriation_green_space_area) expropriation_green_space_area,
            sum(expropriation_road_area) expropriation_road_area, sum(other_expropriation_area) other_expropriation_area,
            sum(total_road_area) total_road_area, sum(total_green_land_area) total_green_land_area,
            sum(demonstration_area) demonstration_area, sum(plot_ratio) plot_ratio, sum(build_density) build_density,
            sum(greening_rate) greening_rate, sum(sale_ratio) sale_ratio, sum(ground_engine_carport) ground_engine_carport,
            sum(total_site_area) total_site_area, sum(confiscated_area) confiscated_area,
            sum(overall_floorage_area) overall_floorage_area, sum(total_capacity_area) total_capacity_area,
            sum(construction_plot_ratio) construction_plot_ratio, sum(total_site_area_plot_ratio) total_site_area_plot_ratio,
            sum(construction_build_density) construction_build_density,
            sum(total_site_area_build_density) total_site_area_build_density,
            sum(construction_greening_rate) construction_greening_rate,
            sum(total_site_area_greening_rate) total_site_area_greening_rate, sum(carport_ratio) carport_ratio,
            sum(total_households) total_households, tempObjPhaseId objPhaseId,
            '0' obj_type, sum(jbs_area) jbs_area
        from MDM_PERIOD_VERSION mpv
                 left join MDM_PERIOD mp on mp.PERIOD_VERSION_ID = mpv.ID
                 left join MDM_PERIOD_PHASE mpp on mpp.PERIOD_ID = mp.PERIOD_ORIGINAL_ID
                 left join MDM_OBJ_PHASE_INDEX moppi on moppi.OBJ_PHASE_ID = mpp.ID
        where mpv.PROJECT_ORIGINAL_ID=tempObjId and mpp.PHASE_ID=phaseId and mpv.APPROVAL_STATUS='已审核'
        group by tempObjPhaseId;
    end if;
    -- 指标重新计算
    begin
        insert into TEST(ID, PROJ_NAME, SQL_STR) values (GET_UUID(), 'sum0', tempObjPhaseId||':'||periodPhaseId);
        commit;
        update MDM_OBJ_PHASE_INDEX
            -- 车位配比=总车位数/总户数)
        set CARPORT_RATIO = decode(nvl(TOTAL_HOUSEHOLDS, 0), 0, 0, TO_CHAR(CARPORT_TOTAL/TOTAL_HOUSEHOLDS, precision)),
            -- 可售比=总可售面积/总建筑面积
            SALE_RATIO = decode(nvl(OVERALL_FLOORAGE_AREA, 0), 0, 0, TO_CHAR(TOTAL_SALE_AREA/OVERALL_FLOORAGE_AREA*100, precision)),
            --实际容积率(按建设用地面积)=总建筑面积(G)/建设用地面积(B)
            CONSTRUCTION_PLOT_RATIO=decode(nvl(CONSTRUCTION_LAND_AREA,0), 0, 0, OVERALL_FLOORAGE_AREA/CONSTRUCTION_LAND_AREA),
            -- 实际容积率(按总用地面积)=总建筑面积(G)/总用地面积(A)
            TOTAL_SITE_AREA_PLOT_RATIO=decode(nvl(TOTAL_SITE_AREA, 0), 0, 0, OVERALL_FLOORAGE_AREA/TOTAL_SITE_AREA),
            -- 实际建筑密度(按建设用地面积）= 建筑占地面积(ZD)/建设用地面积(B)
            CONSTRUCTION_BUILD_DENSITY=decode(nvl(CONSTRUCTION_LAND_AREA, 0), 0, 0,TO_CHAR(BUILD_AREA/CONSTRUCTION_LAND_AREA*100, precision)),
            -- 实际建筑密度（按总用地面积=建筑占地面积(ZD)/总用地面积(A)
            TOTAL_SITE_AREA_BUILD_DENSITY=decode(nvl(TOTAL_SITE_AREA, 0), 0, 0, TO_CHAR(BUILD_AREA/TOTAL_SITE_AREA*100,precision)),
            -- 实际绿地率(按建设用地面积）= 代征绿地面积(DL)/建设用地面积(B)
            CONSTRUCTION_GREENING_RATE = decode(nvl(CONSTRUCTION_LAND_AREA, 0), 0, 0,
                                                TO_CHAR(EXPROPRIATION_GREEN_SPACE_AREA/CONSTRUCTION_LAND_AREA*100, precision)),
            -- 检查实际绿地率（按总用地面积）= 代征绿地面积(DL)/总用地面积(A)
            TOTAL_SITE_AREA_GREENING_RATE = decode(nvl(TOTAL_SITE_AREA, 0), 0, 0,
                                                   TO_CHAR(EXPROPRIATION_GREEN_SPACE_AREA/TOTAL_SITE_AREA*100, precision))
        where OBJ_PHASE_ID = tempObjPhaseId or OBJ_PHASE_ID=periodPhaseId;
    exception when others then
        code := 1;
        errMsg := '更新指标数据失败';
    end;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_OBJ_MAINTAIN_BUILD_TOTAL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_OBJ_MAINTAIN_BUILD_TOTAL" (
    phaseId  IN VARCHAR2, --阶段ID
    objId    IN VARCHAR2,--项目原始ID
    version IN VARCHAR2, --版本号
    items     OUT  SYS_REFCURSOR--消息,
)
as
--项目主数据项目楼栋指标信息列表
BEGIN
    open items FOR
        select mb.ID as "buildId", mb.BUILD_NAME as "buildName",
               wmsys.WM_CONCAT(mopvpi.PRODUCT_TYPE_NAME) AS "productTypeName",
               nvl(mopvi.SALE_RATIO, 0) AS "saleRatio", nvl(mopvi.TOTAL_SALE_AREA, 0) as "totalSaleArea",
               nvl(mopvi.OVERALL_FLOORAGE_AREA, 0) as "overallFloorageArea", mb.PERIOD_NAME "periodName",
               nvl(mopvi.TOTAL_CAPACITY_AREA, 0)  "totalCapacityArea"
        from MDM_BUILD mb
             inner join MDM_OBJ_PHASE_VERSION mobv on mobv.OBJ_ID = mb.ID
             left join MDM_OBJ_PHASE_VERSION_PT_INDEX mopvpi on mopvpi.OBJ_PHASE_VERSION_ID = mobv.ID
             left join MDM_OBJ_PHASE_VERSION_INDEX mopvi on mopvi.OBJ_PHASE_VERSION_ID = mobv.ID
        where mb.PROJ_ID = objId and mobv.PHASE_ID = phaseId
          and mobv.OBJ_PHASE_VERSION = version and (mb.IS_DELETE is null or mb.IS_DELETE = 0)
        group by mb.ID, mb.BUILD_NAME, mopvi.SALE_RATIO,mopvi.TOTAL_SALE_AREA, mopvi.OVERALL_FLOORAGE_AREA,
                 mb.PERIOD_NAME,mopvi.TOTAL_CAPACITY_AREA
        order by PERIOD_NAME, nvl(regexp_replace(mb.BUILD_NAME, '[^0-9]', ''),'0')*1;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PERIOD_APPROVAL_CB
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_PERIOD_APPROVAL_CB" (
    id IN VARCHAR2--分期版本表MDM_PERIOD_VERSION 主键id
) 
	--分期审批回调，1、创建动态货值相关版本数据//王传科实现 20191208
	--作者：陈丽
	--日期：2019/12/08	
    --日期：2020/06/22 chenl 更新，审批通过后同步项目到sys_project_stage
 AS
     approvalstatus   VARCHAR2(50);
    i_v_id        VARCHAR2(200) := id;
BEGIN
     BEGIN
    -- 查询是否是审批通过
        SELECT
            APPROVAL_STATUS 
            into approvalstatus
        FROM
              mdm_period_version 
        WHERE
            id = i_v_id;

        IF approvalstatus = '已审核' THEN
            BEGIN
                P_SYS_PERIOD_SYNCHRONIZATION();
            END;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            dbms_output.put_line('失败咯!');
    END;
END p_mdm_period_approval_cb;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PERMIT_APPROVAL_CB
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_PERMIT_APPROVAL_CB" (
    permitId IN VARCHAR2
) AS
    --证照审批回调，1、更新证照涉及楼栋数据到楼栋表
--作者：鲜晓勇
-- change
--   -@author 韩金明  @notes 修改更新逻辑
--日期：2020/04/13
    permitType VARCHAR2(200);--证照类型
    permitNo   VARCHAR(200);--证照编号
    permitGetDate   DATE;--证照取证日期
BEGIN
    --查询证照类型和证照编号
    select permit_type, permit_no, PERMIT_GET_DATE into permitType,permitNo, permitGetDate
    from mdm_permit where id=permitId;
    if permitType = '施工许可证' then
        update mdm_build
        set IS_GET_CONSTRCUTION_PERMIT = 1,
            GET_CONSTRCUTION_PERMIT_DATE = permitGetDate,
            CONSTRUCTION_PERMIT_NO=permitNo,
            CONSTRACUTION_PERMIT_ID=permitId
        where id in(
            select pb.bld_id from mdm_permit_bld pb
                                      inner join mdm_permit pt on pb.permit_id=pt.id
            where pt.id=permitid and pt.APPROVAL_STATUS='已审核'
        );
    end if;
    if permitType = '规划许可证' then
        update mdm_build
        set IS_GET_CON_PLAN_PERMIT = 1,
            GET_CON_PLAN_PERMIT_DATE = permitGetDate,
            CON_PLAN_PERMIT_NO=permitNo,
            CON_PLAN_PERMIT_ID=permitId
        where id in(
            select pb.bld_id
            from mdm_permit_bld pb
                     inner join mdm_permit pt on pb.permit_id=pt.id
            where pt.id=permitid and pt.APPROVAL_STATUS='已审核'
        );
    end if;
    if permitType = '预售许可证' then
        update mdm_build
        set IS_GET_PRE_SALE_PERMIT = 1,
            GET_PRE_SALE_PERMIT_DATE = permitGetDate,
            PRE_SALE_PERMIT_NO=permitNo,
            PRE_SALE_PERMIT_ID=permitId
        where id in(
            select pb.bld_id
            from mdm_permit_bld pb
                     inner join mdm_permit pt on pb.permit_id=pt.id
            where pt.id=permitid and pt.APPROVAL_STATUS='已审核'
        );
    end if;
    if permitType = '竣工备案证' then
        update mdm_build
        set IS_GET_COMPLETED_PERMIT = 1,
            GET_COMPLETED_PERMIT_DATE=permitGetDate,
            GET_COMPLETED_PERMIT_NO=permitNo,
            COMPLETED_PERMIT_ID=permitId
        where id in(
            select pb.bld_id
            from mdm_permit_bld pb
                     inner join mdm_permit pt on pb.permit_id=pt.id
            where pt.id=permitid and pt.APPROVAL_STATUS='已审核'
        );
    end if;
END p_mdm_permit_approval_cb;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PHASE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_PHASE" (
    projId  IN VARCHAR2, --项目id
    phaseinfo  OUT SYS_REFCURSOR --解析后阶段
)
--阶段解析
--作者：陈丽
--日期：2019/12/07
AS
    CREATE_PHASE_APPROVAL_OBJ_sql          clob;
    CREATE_PHASE_OBJ_sql          clob;
    FORM_TYPE_NAME_sql            clob;
    FORM_GROUP_CODE_sql           clob;
    MAINTAIN_BUILDING_OBJ_sql       clob;  ---楼栋维护 sql
    exec_sql          clob;
BEGIN
    --1.拼接查询语句
    FOR item IN (
        select id,CREATE_PHASE_OBJ,CREATE_PHASE_APPROVAL_OBJ,FORM_TYPE_NAME,FORM_GROUP_CODE,MAINTAIN_BUILDING_OBJ
        from MDM_PHASE)
        LOOP
            CREATE_PHASE_OBJ_sql:=CREATE_PHASE_OBJ_sql||'select a.*,'''||item.id||''' as id from ('||item.CREATE_PHASE_OBJ||') a   union all ';
            CREATE_PHASE_APPROVAL_OBJ_sql:=CREATE_PHASE_APPROVAL_OBJ_sql||'select a.*,'''||item.id||''' as id from ('||item.CREATE_PHASE_APPROVAL_OBJ||') a   union all ';
            FORM_TYPE_NAME_sql:=FORM_TYPE_NAME_sql||'select a.*,'''||item.id||''' as id from ('||item.FORM_TYPE_NAME||') a   union all ';
            FORM_GROUP_CODE_sql:=FORM_GROUP_CODE_sql||'select a.*,'''||item.id||''' as id from ('||item.FORM_GROUP_CODE||') a   union all ';
            MAINTAIN_BUILDING_OBJ_sql:=MAINTAIN_BUILDING_OBJ_sql||'select a.*,'''||item.id||''' as id from ('||item.MAINTAIN_BUILDING_OBJ||') a   union all ';
        END LOOP;
    --2.解析 替换关键字
    CREATE_PHASE_OBJ_sql:= rtrim(replace(CREATE_PHASE_OBJ_sql, '{项目ID}', ''||projId||''),'union all ');
    CREATE_PHASE_APPROVAL_OBJ_sql:= rtrim(replace(CREATE_PHASE_APPROVAL_OBJ_sql, '{项目ID}', ''||projId||''),'union all ');
    FORM_TYPE_NAME_sql:= rtrim(replace(FORM_TYPE_NAME_sql, '{项目ID}', ''||projId||''),'union all ');
    FORM_GROUP_CODE_sql:= rtrim(replace(FORM_GROUP_CODE_sql, '{项目ID}', ''||projId||''),'union all ');
    MAINTAIN_BUILDING_OBJ_sql:= rtrim(replace(MAINTAIN_BUILDING_OBJ_sql, '{项目ID}', ''||projId||''),'union all ');
    exec_sql:='
select MDM_PHASE.id as "id",
    phase_name as "phaseName",
    phase_code as "phaseCode",
    phase_order as "phaseOrder",
    phase_end_obj as "phaseEndObj",
    proj_collect_source as "projCollectSource",
    is_maintain_building as "isMaintainBuilding",
    CREATE_PHASE."objType" as "createPhaseObj",
    CREATE_PHASE_APPROVAL."objType" as "createPhaseApprovalObj",
    FORM_TYPE_NAME."objType" as "formTypeName",
    FORM_GROUP_CODE."objType" as "formGroupCode",
    MAINTAIN_BUILDING."objType" as "maintainBuildingObj"
    from MDM_PHASE
    left join('||CREATE_PHASE_OBJ_sql||' a) CREATE_PHASE
    on MDM_PHASE.id=CREATE_PHASE.id
    left join ('||CREATE_PHASE_APPROVAL_OBJ_sql||' a)CREATE_PHASE_APPROVAL
    on MDM_PHASE.id=CREATE_PHASE_APPROVAL.id
    left join('||FORM_TYPE_NAME_sql||' a) FORM_TYPE_NAME
    on MDM_PHASE.id=FORM_TYPE_NAME.id
    left join('||FORM_GROUP_CODE_sql||' a) FORM_GROUP_CODE
    on MDM_PHASE.id=FORM_GROUP_CODE.id
     left join('||MAINTAIN_BUILDING_OBJ_sql||' a) MAINTAIN_BUILDING
    on MDM_PHASE.id=MAINTAIN_BUILDING.id
    order by phase_code'
    ;
    DBMS_OUTPUT.PUT_LINE('INFO = ' || exec_sql);
    open phaseinfo FOR exec_sql;
END P_MDM_PHASE;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PHASE_APPROVAL_CB
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_PHASE_APPROVAL_CB" (
    id IN VARCHAR2--主数据各阶段对象实例表 MDM_PROJECT_PHASE，MDM_PARCEL_PHASE，MDM_PERIOD_PHASE，MDM_BUILD_PHASE 表 主键id
) 
	--阶段审批接口回调，1、创建动态货值相关版本数据//王传科实现 20191208
	--作者：陈丽
	--日期：2019/12/08	
 AS
BEGIN
    NULL;
END p_mdm_phase_approval_cb;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PHASE_ORDER_CHECK
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_PHASE_ORDER_CHECK" (
    projectPhaseId in varchar2, --项目阶段id
    info out sys_refcursor --是否全部到达
)
-- 根据项目阶段id判断其下分期是否都到达该阶段 1是 0否
as
    ret integer := 0;
begin
    select
        (case when sum(
                           case when periodPhaseOrder >= projectPhaseOrder then 1 else 0 end
                       ) = count(1) then 1 else 0 end) into ret
    from (
             select mp1.PERIOD_NAME, max(mpp2.PHASE_ORDER) periodPhaseOrder, mpp1.PHASE_ORDER projectPhaseOrder
             from MDM_PROJECT_PHASE mpp1
                      left join MDM_PERIOD mp1 on mp1.PROJECT_ORIGINAL_ID = mpp1.PROJ_ID
                      left join MDM_PERIOD_PHASE mpp2 on mpp2.PERIOD_ID = mp1.PERIOD_ORIGINAL_ID
             where mpp1.ID = ''||projectPhaseId||''
             group by PERIOD_NAME, mpp1.PHASE_ORDER
         );
    open info for select ret as "isAllArrive" from dual;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PHASE_VERSION_DATA_SUM
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_PHASE_VERSION_DATA_SUM" (
    objId in VARCHAR2, -- 阶段对象id
    objType in INTEGER, -- 阶段类型（项目0、宗地10、分期20、楼栋30）
    phaseId in VARCHAR2, -- 阶段id
    version in varchar2, -- 版本
    errCode out INTEGER,  --错误码
    errMsg out VARCHAR2 -- 错误信息
)
    -- 主数据版本数据汇总
-- @note 脚本初始化
-- @date 2020-06-30 17:39:18
-- @author 韩金明
    is
    objectPhaseId varchar2(36); --项目阶段id
    objectVersionId varchar2(36); --项目版本id
    objectId varchar2(36); -- 项目id
    periodVersionId varchar2(36); -- 分期阶段id
    tempOrgType varchar2(36) := objType;
    tempObjId varchar2(36) := objId;
begin
    insert into TEST(ID,REMARK) values (GET_UUID(), objId);
    insert into TEST(ID,REMARK) values (GET_UUID(), objType);
    insert into TEST(ID,REMARK) values (GET_UUID(), phaseId);
    errCode := 0;
    if objType = 0 then
        errMsg := '汇总来源为项目，跳过';
    end if;
    -- 从宗地汇总
    if objType = 10 then
        -- 查询项目id和阶段id
        select distinct mpp.OBJ_ID, mpp.ID, mpp2.ID into objectId, objectVersionId, objectPhaseId
        from MDM_PARCEL mp1
                 LEFT JOIN MDM_PROJECT mp2 ON mp2.PROJECT_ORIGINAL_ID = mp1.PROJECT_ORIGINAL_ID
                 LEFT JOIN MDM_OBJ_PHASE_VERSION mpp ON mpp.OBJ_ID = mp2.PROJECT_ORIGINAL_ID
            AND mp2.APPROVAL_STATUS = '已审核'
                 LEFT JOIN MDM_PROJECT_PHASE mpp2 ON mpp2.PROJ_ID = mp2.PROJECT_ORIGINAL_ID and mpp2.PHASE_ID = mpp.PHASE_ID
        where mp1.PARCEL_ORIGINAL_ID = objId and mpp.OBJ_PHASE_VERSION = version and mpp.PHASE_ID = phaseId;

        --删除项目业态数据
        delete from MDM_OBJ_PHASE_VERSION_PT_INDEX
        where OBJ_PHASE_ID = objectPhaseId and OBJ_PHASE_VERSION_ID = objectVersionId;
        -- 插入项目业态数据
        insert into MDM_OBJ_PHASE_VERSION_PT_INDEX(
            id, obj_phase_version_id, product_type_id, operate_attribute_id,
            operate_attribute_name, build_area, ground_capacity_area, underground_capacity_area,
            ground_uncapacity_area, underground_uncapacity_area, ground_total_build_area,
            underground_total_build_area, refuge_storey_area, mechanical_floor_area, empty_space_area,
            tower_basement_area, underground_garage_area, storage_area, storage_total, total_sale_area,
            ground_sale_area, underground_sale_area, total_give_area, ground_give_area, underground_give_area,
            total_residence, total_business, ground_carport, residence_bottom_carport, parking_garage_carport,
            underground_rfj_carport, underground_rj_carport, underground_frfj_carport, underground_frj_carport,
            underground_r_sale_carport, underground_frfj_sale_carport, underground_frj_sale_carport, carport_total,
            ground_total_carport, underground_total_carport, underground_total_rj_carport,
            underground_total_frj_carport, underground_total_sale_carport, obj_phase_id, obj_type,
            product_type_name, product_type_json)
        select GET_UUID(), objectVersionId obj_phase_version_id, product_type_id, operate_attribute_id,
               operate_attribute_name, sum(build_area) build_area, sum(ground_capacity_area) ground_capacity_area,
               sum(underground_capacity_area) underground_capacity_area, sum(ground_uncapacity_area) ground_uncapacity_area,
               sum(underground_uncapacity_area) underground_uncapacity_area,
               sum(ground_total_build_area) ground_total_build_area,
               sum(underground_total_build_area) underground_total_build_area, sum(refuge_storey_area) refuge_storey_area,
               sum(mechanical_floor_area) mechanical_floor_area, sum(empty_space_area) empty_space_area,
               sum(tower_basement_area) tower_basement_area, sum(underground_garage_area) underground_garage_area,
               sum(storage_area) storage_area, sum(storage_total) storage_total, sum(total_sale_area) total_sale_area,
               sum(ground_sale_area) ground_sale_area, sum(underground_sale_area) underground_sale_area,
               sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
               sum(underground_give_area) underground_give_area, sum(total_residence) total_residence,
               sum(total_business) total_business,sum(ground_carport) ground_carport,
               sum(residence_bottom_carport) residence_bottom_carport, sum(parking_garage_carport) parking_garage_carport,
               sum(underground_rfj_carport) underground_rfj_carport, sum(underground_rj_carport) underground_rj_carport,
               sum(underground_frfj_carport) underground_frfj_carport, sum(underground_frj_carport) underground_frj_carport,
               sum(underground_r_sale_carport) underground_r_sale_carport,
               sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
               sum(underground_frj_sale_carport) underground_frj_sale_carport, sum(carport_total) carport_total,
               sum(ground_total_carport) ground_total_carport, sum(underground_total_carport) underground_total_carport,
               sum(underground_total_rj_carport) underground_total_rj_carport,
               sum(underground_total_frj_carport) underground_total_frj_carport,
               sum(underground_total_sale_carport) underground_total_sale_carport, objectPhaseId obj_phase_id,
               '0' objType, product_type_name, product_type_json
        from SYS_PARCEL mp1
                 left join MDM_PARCEL_PHASE mpp on mpp.PAECEL_ID = mp1.ID
                 left join MDM_OBJ_PHASE_VERSION_PT_INDEX mopvpi on mopvpi.OBJ_PHASE_ID = mpp.ID
                 left join MDM_OBJ_PHASE_VERSION mopv on mopv.ID = mopvpi.OBJ_PHASE_VERSION_ID
        where mp1.PROJECT_ID = objectId and mpp.PHASE_ID=phaseId
          and mopv.OBJ_PHASE_VERSION = version
        group by PRODUCT_TYPE_ID, OPERATE_ATTRIBUTE_ID,
                 OPERATE_ATTRIBUTE_NAME,PRODUCT_TYPE_NAME,
                 PRODUCT_TYPE_JSON, objectPhaseId, objectVersionId;

        --删除项目阶段数据
        delete from MDM_OBJ_PHASE_VERSION_INDEX
        where OBJ_PHASE_ID = objectPhaseId and OBJ_PHASE_VERSION_ID = objectVersionId;
        --添加项目业态阶段数据
        insert into MDM_OBJ_PHASE_VERSION_INDEX(
            id, build_area, ground_capacity_area, underground_capacity_area, ground_uncapacity_area,
            underground_uncapacity_area, ground_total_build_area, underground_total_build_area, refuge_storey_area,
            mechanical_floor_area, empty_space_area, tower_basement_area, underground_garage_area, storage_area,
            storage_total, total_sale_area, ground_sale_area, underground_sale_area, total_give_area, ground_give_area,
            underground_give_area, total_residence, total_business, ground_carport, residence_bottom_carport,
            parking_garage_carport, underground_rfj_carport, underground_rj_carport, underground_frfj_carport,
            underground_frj_carport, underground_r_sale_carport, underground_frfj_sale_carport, underground_frj_sale_carport,
            carport_total, ground_total_carport, underground_total_carport, underground_total_rj_carport,
            underground_total_frj_carport, underground_total_sale_carport, construction_land_area,
            expropriation_green_space_area, expropriation_road_area, other_expropriation_area, total_road_area,
            total_green_land_area, demonstration_area, plot_ratio, build_density, greening_rate, sale_ratio,
            ground_engine_carport, total_site_area, confiscated_area, overall_floorage_area, total_capacity_area,
            construction_plot_ratio, total_site_area_plot_ratio, construction_build_density, total_site_area_build_density,
            construction_greening_rate, total_site_area_greening_rate, carport_ratio, total_households, obj_phase_id,
            obj_type, jbs_area, OBJ_PHASE_VERSION_ID
        )
        select
            GET_UUID(), sum(build_area) build_area, sum(ground_capacity_area) ground_capacity_area,
            sum(underground_capacity_area) underground_capacity_area,sum(ground_uncapacity_area) ground_uncapacity_area,
            sum(underground_uncapacity_area) underground_uncapacity_area, sum(ground_total_build_area) ground_total_build_area,
            sum(underground_total_build_area) underground_total_build_area, sum(refuge_storey_area) refuge_storey_area,
            sum(mechanical_floor_area) mechanical_floor_area, sum(empty_space_area) empty_space_area,
            sum(tower_basement_area) tower_basement_area,sum(underground_garage_area) underground_garage_area,
            sum(storage_area) storage_area, sum(storage_total) storage_total,sum(total_sale_area) total_sale_area,
            sum(ground_sale_area) ground_sale_area,sum(underground_sale_area) underground_sale_area,
            sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
            sum(underground_give_area) underground_give_area, sum(total_residence) total_residence,
            sum(total_business) total_business, sum(ground_carport) ground_carport,
            sum(residence_bottom_carport) residence_bottom_carport, sum(parking_garage_carport) parking_garage_carport,
            sum(underground_rfj_carport) underground_rfj_carport, sum(underground_rj_carport) underground_rj_carport,
            sum(underground_frfj_carport) underground_frfj_carport,
            sum(underground_frj_carport) underground_frj_carport,
            sum(underground_r_sale_carport) underground_r_sale_carport,
            sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
            sum(underground_frj_sale_carport) underground_frj_sale_carport, sum(carport_total) carport_total,
            sum(ground_total_carport) ground_total_carport, sum(underground_total_carport) underground_total_carport,
            sum(underground_total_rj_carport) underground_total_rj_carport,
            sum(underground_total_frj_carport) underground_total_frj_carport,
            sum(underground_total_sale_carport) underground_total_sale_carport,
            sum(construction_land_area) construction_land_area,
            sum(expropriation_green_space_area) expropriation_green_space_area,
            sum(expropriation_road_area) expropriation_road_area, sum(other_expropriation_area) other_expropriation_area,
            sum(total_road_area) total_road_area, sum(total_green_land_area) total_green_land_area,
            sum(demonstration_area) demonstration_area, sum(plot_ratio) plot_ratio, sum(build_density) build_density,
            sum(greening_rate) greening_rate, sum(sale_ratio) sale_ratio, sum(ground_engine_carport) ground_engine_carport,
            sum(total_site_area) total_site_area, sum(confiscated_area) confiscated_area,
            sum(overall_floorage_area) overall_floorage_area, sum(total_capacity_area) total_capacity_area,
            sum(construction_plot_ratio) construction_plot_ratio, sum(total_site_area_plot_ratio) total_site_area_plot_ratio,
            sum(construction_build_density) construction_build_density,
            sum(total_site_area_build_density) total_site_area_build_density,
            sum(construction_greening_rate) construction_greening_rate,
            sum(total_site_area_greening_rate) total_site_area_greening_rate, sum(carport_ratio) carport_ratio,
            sum(total_households) total_households, objectPhaseId objPhaseId,
            '0' obj_type, sum(jbs_area) jbs_area, objectVersionId OBJ_PHASE_VERSION_ID
        from SYS_PARCEL mp1
                 left join MDM_PARCEL_PHASE mpp on mpp.PAECEL_ID = mp1.ID
                 left join MDM_OBJ_PHASE_VERSION_INDEX mopvpi on mopvpi.OBJ_PHASE_ID = mpp.ID
                 left join MDM_OBJ_PHASE_VERSION mopv on mopv.ID = mopvpi.OBJ_PHASE_VERSION_ID
        where mp1.PROJECT_ID = objectId
          and mpp.PHASE_ID = phaseId
          and mopv.OBJ_PHASE_VERSION = version
        group by objectPhaseId, objectVersionId;
    end if;

    -- 从楼栋汇总
    if objType = 30 then
        -- 获取分期id和分期阶段id
        begin
            select mopv.ID, mp1.PERIOD_ORIGINAL_ID, mpp.ID into objectVersionId, objectId, objectPhaseId
            from MDM_BUILD mb
                     inner join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mb.PERIOD_ID
                     inner join MDM_PERIOD_PHASE mpp on mpp.PERIOD_ID = mp1.PERIOD_ORIGINAL_ID
                     inner join MDM_PERIOD_VERSION mpv on mpv.ID = mp1.PERIOD_VERSION_ID
                     inner join MDM_OBJ_PHASE_VERSION mopv on mopv.OBJ_ID = mb.PERIOD_ID
                and mpp.PHASE_ID = mopv.PHASE_ID
            where mb.id = objId and mpp.PHASE_ID = phaseId and mpv.APPROVAL_STATUS='已审核'
              and mopv.OBJ_PHASE_VERSION = version;
        exception when others then
            errMsg := '楼栋版本阶段存在多条数据';
            errCode := 501;
            return;
        end;


        -- 删除分期业态数据
        delete from MDM_OBJ_PHASE_VERSION_PT_INDEX
        where OBJ_PHASE_ID = objectPhaseId and OBJ_PHASE_VERSION_ID = objectVersionId;
        -- 添加分期业态数据
        insert into MDM_OBJ_PHASE_VERSION_PT_INDEX(
            id, obj_phase_version_id, product_type_id, operate_attribute_id,
            operate_attribute_name, build_area, ground_capacity_area, underground_capacity_area,
            ground_uncapacity_area, underground_uncapacity_area, ground_total_build_area,
            underground_total_build_area, refuge_storey_area, mechanical_floor_area, empty_space_area,
            tower_basement_area, underground_garage_area, storage_area, storage_total, total_sale_area,
            ground_sale_area, underground_sale_area, total_give_area, ground_give_area, underground_give_area,
            total_residence, total_business, ground_carport, residence_bottom_carport, parking_garage_carport,
            underground_rfj_carport, underground_rj_carport, underground_frfj_carport, underground_frj_carport,
            underground_r_sale_carport, underground_frfj_sale_carport, underground_frj_sale_carport, carport_total,
            ground_total_carport, underground_total_carport, underground_total_rj_carport,
            underground_total_frj_carport, underground_total_sale_carport, obj_phase_id, obj_type,
            product_type_name, product_type_json)
        select GET_UUID(), objectVersionId obj_phase_version_id, product_type_id, operate_attribute_id,
               operate_attribute_name, sum(build_area) build_area, sum(ground_capacity_area) ground_capacity_area,
               sum(underground_capacity_area) underground_capacity_area, sum(ground_uncapacity_area) ground_uncapacity_area,
               sum(underground_uncapacity_area) underground_uncapacity_area,
               sum(ground_total_build_area) ground_total_build_area,
               sum(underground_total_build_area) underground_total_build_area, sum(refuge_storey_area) refuge_storey_area,
               sum(mechanical_floor_area) mechanical_floor_area, sum(empty_space_area) empty_space_area,
               sum(tower_basement_area) tower_basement_area, sum(underground_garage_area) underground_garage_area,
               sum(storage_area) storage_area, sum(storage_total) storage_total, sum(total_sale_area) total_sale_area,
               sum(ground_sale_area) ground_sale_area, sum(underground_sale_area) underground_sale_area,
               sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
               sum(underground_give_area) underground_give_area, sum(total_residence) total_residence,
               sum(total_business) total_business,sum(ground_carport) ground_carport,
               sum(residence_bottom_carport) residence_bottom_carport, sum(parking_garage_carport) parking_garage_carport,
               sum(underground_rfj_carport) underground_rfj_carport, sum(underground_rj_carport) underground_rj_carport,
               sum(underground_frfj_carport) underground_frfj_carport, sum(underground_frj_carport) underground_frj_carport,
               sum(underground_r_sale_carport) underground_r_sale_carport,
               sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
               sum(underground_frj_sale_carport) underground_frj_sale_carport, sum(carport_total) carport_total,
               sum(ground_total_carport) ground_total_carport, sum(underground_total_carport) underground_total_carport,
               sum(underground_total_rj_carport) underground_total_rj_carport,
               sum(underground_total_frj_carport) underground_total_frj_carport,
               sum(underground_total_sale_carport) underground_total_sale_carport, objectPhaseId obj_phase_id,
               '20' objType, product_type_name, product_type_json
        from MDM_BUILD mb1
                 left join MDM_BUILD_PHASE mbp on mbp.BUILD_ID = mb1.ID
                 left join MDM_OBJ_PHASE_VERSION_PT_INDEX mopvpi on mopvpi.OBJ_PHASE_ID = mbp.ID
                 left join MDM_OBJ_PHASE_VERSION mopv on mopv.ID = mopvpi.OBJ_PHASE_VERSION_ID
        where mb1.PERIOD_ID = objectId and mbp.PHASE_ID=phaseId
          and mopv.OBJ_PHASE_VERSION = version and mb1.BUILD_STATE = 10
        group by PRODUCT_TYPE_ID, OPERATE_ATTRIBUTE_ID,
                 OPERATE_ATTRIBUTE_NAME,PRODUCT_TYPE_NAME,
                 PRODUCT_TYPE_JSON, objectPhaseId, objectVersionId;



        merge into  MDM_OBJ_PHASE_VERSION_INDEX mpi1
        USING(
            select
                GET_UUID(), sum(build_area) build_area, sum(ground_capacity_area) ground_capacity_area,
                sum(underground_capacity_area) underground_capacity_area,sum(ground_uncapacity_area) ground_uncapacity_area,
                sum(underground_uncapacity_area) underground_uncapacity_area, sum(ground_total_build_area) ground_total_build_area,
                sum(underground_total_build_area) underground_total_build_area, sum(refuge_storey_area) refuge_storey_area,
                sum(mechanical_floor_area) mechanical_floor_area, sum(empty_space_area) empty_space_area,
                sum(tower_basement_area) tower_basement_area,sum(underground_garage_area) underground_garage_area,
                sum(storage_area) storage_area, sum(storage_total) storage_total,sum(total_sale_area) total_sale_area,
                sum(ground_sale_area) ground_sale_area,sum(underground_sale_area) underground_sale_area,
                sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
                sum(underground_give_area) underground_give_area, sum(total_residence) total_residence,
                sum(total_business) total_business, sum(ground_carport) ground_carport,
                sum(residence_bottom_carport) residence_bottom_carport, sum(parking_garage_carport) parking_garage_carport,
                sum(underground_rfj_carport) underground_rfj_carport, sum(underground_rj_carport) underground_rj_carport,
                sum(underground_frfj_carport) underground_frfj_carport,
                sum(underground_frj_carport) underground_frj_carport,
                sum(underground_r_sale_carport) underground_r_sale_carport,
                sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
                sum(underground_frj_sale_carport) underground_frj_sale_carport, sum(carport_total) carport_total,
                sum(ground_total_carport) ground_total_carport, sum(underground_total_carport) underground_total_carport,
                sum(underground_total_rj_carport) underground_total_rj_carport,
                sum(underground_total_frj_carport) underground_total_frj_carport,
                sum(underground_total_sale_carport) underground_total_sale_carport,
                sum(construction_land_area) construction_land_area,
                sum(expropriation_green_space_area) expropriation_green_space_area,
                sum(expropriation_road_area) expropriation_road_area, sum(other_expropriation_area) other_expropriation_area,
                sum(total_road_area) total_road_area, sum(total_green_land_area) total_green_land_area,
                sum(demonstration_area) demonstration_area, sum(plot_ratio) plot_ratio, sum(build_density) build_density,
                sum(greening_rate) greening_rate, sum(sale_ratio) sale_ratio, sum(ground_engine_carport) ground_engine_carport,
                sum(total_site_area) total_site_area, sum(confiscated_area) confiscated_area,
                sum(overall_floorage_area) overall_floorage_area, sum(total_capacity_area) total_capacity_area,
                sum(construction_plot_ratio) construction_plot_ratio, sum(total_site_area_plot_ratio) total_site_area_plot_ratio,
                sum(construction_build_density) construction_build_density,
                sum(total_site_area_build_density) total_site_area_build_density,
                sum(construction_greening_rate) construction_greening_rate,
                sum(total_site_area_greening_rate) total_site_area_greening_rate, sum(carport_ratio) carport_ratio,
                sum(total_households) total_households, objectPhaseId objPhaseId,
                '20' obj_type, sum(jbs_area) jbs_area, objectVersionId OBJ_PHASE_VERSION_ID
            from MDM_BUILD mb1
                     left join MDM_BUILD_PHASE mbp on mbp.BUILD_ID = mb1.ID
                     left join MDM_OBJ_PHASE_VERSION_INDEX mopvpi on mopvpi.OBJ_PHASE_ID = mbp.ID
                     left join MDM_OBJ_PHASE_VERSION mopv on mopv.ID = mopvpi.OBJ_PHASE_VERSION_ID
            where mb1.PERIOD_ID = objectId
              and mbp.PHASE_ID=phaseId
              and mopv.OBJ_PHASE_VERSION = version and mb1.BUILD_STATE = 10
            group by objectVersionId, objectPhaseId
        )mpi2 on (mpi1.OBJ_PHASE_ID=objectPhaseId and mpi1.OBJ_PHASE_VERSION_ID=mpi2.OBJ_PHASE_VERSION_ID)
        WHEN MATCHED THEN
            update set
                       mpi1.build_area=mpi2.build_area,
                       mpi1.ground_capacity_area=mpi2.ground_capacity_area,
                       mpi1.underground_capacity_area=mpi2.underground_capacity_area,
                       mpi1.ground_uncapacity_area=mpi2.ground_uncapacity_area,
                       mpi1.underground_uncapacity_area=mpi2.underground_uncapacity_area,
                       mpi1.ground_total_build_area=mpi2.ground_total_build_area,
                       mpi1.underground_total_build_area=mpi2.underground_total_build_area,
                       mpi1.refuge_storey_area=mpi2.refuge_storey_area,
                       mpi1.mechanical_floor_area=mpi2.mechanical_floor_area,
                       mpi1.empty_space_area=mpi2.empty_space_area,
                       mpi1.tower_basement_area=mpi2.tower_basement_area,
                       mpi1.underground_garage_area=mpi2.underground_garage_area,
                       mpi1.storage_area=mpi2.storage_area,
                       mpi1.storage_total=mpi2.storage_total,
                       mpi1.total_sale_area=mpi2.total_sale_area,
                       mpi1.ground_sale_area=mpi2.ground_sale_area,
                       mpi1.underground_sale_area=mpi2.underground_sale_area,
                       mpi1.total_give_area=mpi2.total_give_area,
                       mpi1.ground_give_area=mpi2.ground_give_area,
                       mpi1.underground_give_area=mpi2.underground_give_area,
                       mpi1.total_residence=mpi2.total_residence,
                       mpi1.total_business=mpi2.total_business,
                       mpi1.ground_carport=mpi2.ground_carport,
                       mpi1.residence_bottom_carport=mpi2.residence_bottom_carport,
                       mpi1.parking_garage_carport=mpi2.parking_garage_carport,
                       mpi1.underground_rfj_carport=mpi2.underground_rfj_carport,
                       mpi1.underground_rj_carport=mpi2.underground_rj_carport,
                       mpi1.underground_frfj_carport=mpi2.underground_frfj_carport,
                       mpi1.underground_frj_carport=mpi2.underground_frj_carport,
                       mpi1.underground_r_sale_carport=mpi2.underground_r_sale_carport,
                       mpi1.underground_frfj_sale_carport=mpi2.underground_frfj_sale_carport,
                       mpi1.underground_frj_sale_carport=mpi2.underground_frj_sale_carport,
                       mpi1.carport_total=mpi2.carport_total,
                       mpi1.ground_total_carport=mpi2.ground_total_carport,
                       mpi1.underground_total_carport=mpi2.underground_total_carport,
                       mpi1.underground_total_rj_carport=mpi2.underground_total_rj_carport,
                       mpi1.underground_total_frj_carport=mpi2.underground_total_frj_carport,
                       mpi1.underground_total_sale_carport=mpi2.underground_total_sale_carport,
                       mpi1.sale_ratio=mpi2.sale_ratio,
                       mpi1.ground_engine_carport=mpi2.ground_engine_carport,
                       mpi1.overall_floorage_area=mpi2.overall_floorage_area,
                       mpi1.total_capacity_area=mpi2.total_capacity_area,
                       mpi1.construction_plot_ratio=mpi2.construction_plot_ratio,
                       mpi1.total_site_area_plot_ratio=mpi2.total_site_area_plot_ratio,
                       mpi1.construction_build_density=mpi2.construction_build_density,
                       mpi1.total_site_area_build_density=mpi2.total_site_area_build_density,
                       mpi1.construction_greening_rate=mpi2.construction_greening_rate,
                       mpi1.total_site_area_greening_rate=mpi2.total_site_area_greening_rate,
                       mpi1.carport_ratio=mpi2.carport_ratio,
                       mpi1.total_households=mpi2.total_households,
                       mpi1.jbs_area=mpi2.jbs_area;
        commit;
        --        -- 删除分期阶段数据
--        delete from MDM_OBJ_PHASE_VERSION_INDEX
--        where OBJ_PHASE_ID = objectPhaseId and OBJ_PHASE_VERSION_ID = objectVersionId;
--        -- 添加分期阶段数据
--        insert into MDM_OBJ_PHASE_VERSION_INDEX(
--            id, build_area, ground_capacity_area, underground_capacity_area, ground_uncapacity_area,
--            underground_uncapacity_area, ground_total_build_area, underground_total_build_area, refuge_storey_area,
--            mechanical_floor_area, empty_space_area, tower_basement_area, underground_garage_area, storage_area,
--            storage_total, total_sale_area, ground_sale_area, underground_sale_area, total_give_area, ground_give_area,
--            underground_give_area, total_residence, total_business, ground_carport, residence_bottom_carport,
--            parking_garage_carport, underground_rfj_carport, underground_rj_carport, underground_frfj_carport,
--            underground_frj_carport, underground_r_sale_carport, underground_frfj_sale_carport, underground_frj_sale_carport,
--            carport_total, ground_total_carport, underground_total_carport, underground_total_rj_carport,
--            underground_total_frj_carport, underground_total_sale_carport, construction_land_area,
--            expropriation_green_space_area, expropriation_road_area, other_expropriation_area, total_road_area,
--            total_green_land_area, demonstration_area, plot_ratio, build_density, greening_rate, sale_ratio,
--            ground_engine_carport, total_site_area, confiscated_area, overall_floorage_area, total_capacity_area,
--            construction_plot_ratio, total_site_area_plot_ratio, construction_build_density, total_site_area_build_density,
--            construction_greening_rate, total_site_area_greening_rate, carport_ratio, total_households, obj_phase_id,
--            obj_type, jbs_area, OBJ_PHASE_VERSION_ID
--        )
--        select
--            GET_UUID(), sum(build_area) build_area, sum(ground_capacity_area) ground_capacity_area,
--            sum(underground_capacity_area) underground_capacity_area,sum(ground_uncapacity_area) ground_uncapacity_area,
--            sum(underground_uncapacity_area) underground_uncapacity_area, sum(ground_total_build_area) ground_total_build_area,
--            sum(underground_total_build_area) underground_total_build_area, sum(refuge_storey_area) refuge_storey_area,
--            sum(mechanical_floor_area) mechanical_floor_area, sum(empty_space_area) empty_space_area,
--            sum(tower_basement_area) tower_basement_area,sum(underground_garage_area) underground_garage_area,
--            sum(storage_area) storage_area, sum(storage_total) storage_total,sum(total_sale_area) total_sale_area,
--            sum(ground_sale_area) ground_sale_area,sum(underground_sale_area) underground_sale_area,
--            sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
--            sum(underground_give_area) underground_give_area, sum(total_residence) total_residence,
--            sum(total_business) total_business, sum(ground_carport) ground_carport,
--            sum(residence_bottom_carport) residence_bottom_carport, sum(parking_garage_carport) parking_garage_carport,
--            sum(underground_rfj_carport) underground_rfj_carport, sum(underground_rj_carport) underground_rj_carport,
--            sum(underground_frfj_carport) underground_frfj_carport,
--            sum(underground_frj_carport) underground_frj_carport,
--            sum(underground_r_sale_carport) underground_r_sale_carport,
--            sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
--            sum(underground_frj_sale_carport) underground_frj_sale_carport, sum(carport_total) carport_total,
--            sum(ground_total_carport) ground_total_carport, sum(underground_total_carport) underground_total_carport,
--            sum(underground_total_rj_carport) underground_total_rj_carport,
--            sum(underground_total_frj_carport) underground_total_frj_carport,
--            sum(underground_total_sale_carport) underground_total_sale_carport,
--            sum(construction_land_area) construction_land_area,
--            sum(expropriation_green_space_area) expropriation_green_space_area,
--            sum(expropriation_road_area) expropriation_road_area, sum(other_expropriation_area) other_expropriation_area,
--            sum(total_road_area) total_road_area, sum(total_green_land_area) total_green_land_area,
--            sum(demonstration_area) demonstration_area, sum(plot_ratio) plot_ratio, sum(build_density) build_density,
--            sum(greening_rate) greening_rate, sum(sale_ratio) sale_ratio, sum(ground_engine_carport) ground_engine_carport,
--            sum(total_site_area) total_site_area, sum(confiscated_area) confiscated_area,
--            sum(overall_floorage_area) overall_floorage_area, sum(total_capacity_area) total_capacity_area,
--            sum(construction_plot_ratio) construction_plot_ratio, sum(total_site_area_plot_ratio) total_site_area_plot_ratio,
--            sum(construction_build_density) construction_build_density,
--            sum(total_site_area_build_density) total_site_area_build_density,
--            sum(construction_greening_rate) construction_greening_rate,
--            sum(total_site_area_greening_rate) total_site_area_greening_rate, sum(carport_ratio) carport_ratio,
--            sum(total_households) total_households, objectPhaseId objPhaseId,
--            '20' obj_type, sum(jbs_area) jbs_area, objectVersionId OBJ_PHASE_VERSION_ID
--        from MDM_BUILD mb1
--                 left join MDM_BUILD_PHASE mbp on mbp.BUILD_ID = mb1.ID
--                 left join MDM_OBJ_PHASE_VERSION_INDEX mopvpi on mopvpi.OBJ_PHASE_ID = mbp.ID
--                 left join MDM_OBJ_PHASE_VERSION mopv on mopv.ID = mopvpi.OBJ_PHASE_VERSION_ID
--        where mb1.PERIOD_ID = objectId
--          and mbp.PHASE_ID=phaseId
--          and mopv.OBJ_PHASE_VERSION = version
--        group by objectVersionId, objectPhaseId;

        --更新tempOrgType和tempOrgId 进行分期向项目汇总
        tempOrgType := 20;
        tempObjId := objectId;
    end if;

    -- 从分期汇总
    if tempOrgType = 20 then
        -- 获取项目id,项目版本id和项目阶段id
        begin
            select mpp2.ID, mpv.PROJECT_ORIGINAL_ID, mpp1.ID, mpv.ID
            into objectVersionId, objectId, objectPhaseId, periodVersionId
            from MDM_PERIOD mp1
                     left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
                     left join MDM_PROJECT_PHASE mpp1 on mpp1.PROJ_ID = mpv.PROJECT_ORIGINAL_ID
                     left join MDM_OBJ_PHASE_VERSION mpp2 on mpp2.OBJ_ID = mpp1.PROJ_ID and mpp1.PHASE_ID = mpp2.PHASE_ID
            where mp1.PERIOD_ORIGINAL_ID = tempObjId
              and mpp1.PHASE_ID=phaseId
              and mpv.APPROVAL_STATUS='已审核' and OBJ_PHASE_VERSION=version;
        exception when others then
            errMsg := '分期阶段版本存在多条数据';
            errCode := 0;
            return;
        end;

        -- 删除项目业态数据
        delete from MDM_OBJ_PHASE_VERSION_PT_INDEX
        where OBJ_PHASE_ID = objectPhaseId and OBJ_PHASE_VERSION_ID = objectVersionId;
        -- 添加项目业态数据
        insert into MDM_OBJ_PHASE_VERSION_PT_INDEX(
            id, obj_phase_version_id, product_type_id, operate_attribute_id,
            operate_attribute_name, build_area, ground_capacity_area, underground_capacity_area,
            ground_uncapacity_area, underground_uncapacity_area, ground_total_build_area,
            underground_total_build_area, refuge_storey_area, mechanical_floor_area, empty_space_area,
            tower_basement_area, underground_garage_area, storage_area, storage_total, total_sale_area,
            ground_sale_area, underground_sale_area, total_give_area, ground_give_area, underground_give_area,
            total_residence, total_business, ground_carport, residence_bottom_carport, parking_garage_carport,
            underground_rfj_carport, underground_rj_carport, underground_frfj_carport, underground_frj_carport,
            underground_r_sale_carport, underground_frfj_sale_carport, underground_frj_sale_carport, carport_total,
            ground_total_carport, underground_total_carport, underground_total_rj_carport,
            underground_total_frj_carport, underground_total_sale_carport, obj_phase_id, obj_type,
            product_type_name, product_type_json)
        select GET_UUID(), objectVersionId obj_phase_version_id, product_type_id, operate_attribute_id,
               operate_attribute_name, sum(build_area) build_area, sum(ground_capacity_area) ground_capacity_area,
               sum(underground_capacity_area) underground_capacity_area, sum(ground_uncapacity_area) ground_uncapacity_area,
               sum(underground_uncapacity_area) underground_uncapacity_area,
               sum(ground_total_build_area) ground_total_build_area,
               sum(underground_total_build_area) underground_total_build_area, sum(refuge_storey_area) refuge_storey_area,
               sum(mechanical_floor_area) mechanical_floor_area, sum(empty_space_area) empty_space_area,
               sum(tower_basement_area) tower_basement_area, sum(underground_garage_area) underground_garage_area,
               sum(storage_area) storage_area, sum(storage_total) storage_total, sum(total_sale_area) total_sale_area,
               sum(ground_sale_area) ground_sale_area, sum(underground_sale_area) underground_sale_area,
               sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
               sum(underground_give_area) underground_give_area, sum(total_residence) total_residence,
               sum(total_business) total_business,sum(ground_carport) ground_carport,
               sum(residence_bottom_carport) residence_bottom_carport, sum(parking_garage_carport) parking_garage_carport,
               sum(underground_rfj_carport) underground_rfj_carport, sum(underground_rj_carport) underground_rj_carport,
               sum(underground_frfj_carport) underground_frfj_carport, sum(underground_frj_carport) underground_frj_carport,
               sum(underground_r_sale_carport) underground_r_sale_carport,
               sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
               sum(underground_frj_sale_carport) underground_frj_sale_carport, sum(carport_total) carport_total,
               sum(ground_total_carport) ground_total_carport, sum(underground_total_carport) underground_total_carport,
               sum(underground_total_rj_carport) underground_total_rj_carport,
               sum(underground_total_frj_carport) underground_total_frj_carport,
               sum(underground_total_sale_carport) underground_total_sale_carport, objectPhaseId obj_phase_id,
               '0' objType, product_type_name, product_type_json
        from MDM_OBJ_PHASE_VERSION_PT_INDEX mopvpi
                 inner join MDM_OBJ_PHASE_VERSION mopv on mopv.ID = OBJ_PHASE_VERSION_ID
                 left join MDM_PERIOD mp on mp.PERIOD_ORIGINAL_ID = mopv.OBJ_ID
                 left join MDM_PERIOD_PHASE mpp1 on mpp1.ID = mopv.OBJ_PHASE_ID
        where mopv.OBJ_PHASE_VERSION=version
          and mp.PERIOD_VERSION_ID = periodVersionId
          and mopv.PHASE_ID = phaseId
        group by PRODUCT_TYPE_ID, OPERATE_ATTRIBUTE_ID,
                 OPERATE_ATTRIBUTE_NAME,PRODUCT_TYPE_NAME,
                 PRODUCT_TYPE_JSON, objectPhaseId, objectVersionId;

        -- 删除项目阶段数据
        delete from MDM_OBJ_PHASE_VERSION_INDEX
        where OBJ_PHASE_ID = objectPhaseId and OBJ_PHASE_VERSION_ID = objectVersionId;
        -- 添加项目业态数据
        insert into MDM_OBJ_PHASE_VERSION_INDEX(
            id, build_area, ground_capacity_area, underground_capacity_area, ground_uncapacity_area,
            underground_uncapacity_area, ground_total_build_area, underground_total_build_area, refuge_storey_area,
            mechanical_floor_area, empty_space_area, tower_basement_area, underground_garage_area, storage_area,
            storage_total, total_sale_area, ground_sale_area, underground_sale_area, total_give_area, ground_give_area,
            underground_give_area, total_residence, total_business, ground_carport, residence_bottom_carport,
            parking_garage_carport, underground_rfj_carport, underground_rj_carport, underground_frfj_carport,
            underground_frj_carport, underground_r_sale_carport, underground_frfj_sale_carport, underground_frj_sale_carport,
            carport_total, ground_total_carport, underground_total_carport, underground_total_rj_carport,
            underground_total_frj_carport, underground_total_sale_carport, construction_land_area,
            expropriation_green_space_area, expropriation_road_area, other_expropriation_area, total_road_area,
            total_green_land_area, demonstration_area, plot_ratio, build_density, greening_rate, sale_ratio,
            ground_engine_carport, total_site_area, confiscated_area, overall_floorage_area, total_capacity_area,
            construction_plot_ratio, total_site_area_plot_ratio, construction_build_density, total_site_area_build_density,
            construction_greening_rate, total_site_area_greening_rate, carport_ratio, total_households, obj_phase_id,
            obj_type, jbs_area, OBJ_PHASE_VERSION_ID
        )
        select
            GET_UUID(), sum(build_area) build_area, sum(ground_capacity_area) ground_capacity_area,
            sum(underground_capacity_area) underground_capacity_area,sum(ground_uncapacity_area) ground_uncapacity_area,
            sum(underground_uncapacity_area) underground_uncapacity_area, sum(ground_total_build_area) ground_total_build_area,
            sum(underground_total_build_area) underground_total_build_area, sum(refuge_storey_area) refuge_storey_area,
            sum(mechanical_floor_area) mechanical_floor_area, sum(empty_space_area) empty_space_area,
            sum(tower_basement_area) tower_basement_area,sum(underground_garage_area) underground_garage_area,
            sum(storage_area) storage_area, sum(storage_total) storage_total,sum(total_sale_area) total_sale_area,
            sum(ground_sale_area) ground_sale_area,sum(underground_sale_area) underground_sale_area,
            sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
            sum(underground_give_area) underground_give_area, sum(total_residence) total_residence,
            sum(total_business) total_business, sum(ground_carport) ground_carport,
            sum(residence_bottom_carport) residence_bottom_carport, sum(parking_garage_carport) parking_garage_carport,
            sum(underground_rfj_carport) underground_rfj_carport, sum(underground_rj_carport) underground_rj_carport,
            sum(underground_frfj_carport) underground_frfj_carport,
            sum(underground_frj_carport) underground_frj_carport,
            sum(underground_r_sale_carport) underground_r_sale_carport,
            sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
            sum(underground_frj_sale_carport) underground_frj_sale_carport, sum(carport_total) carport_total,
            sum(ground_total_carport) ground_total_carport, sum(underground_total_carport) underground_total_carport,
            sum(underground_total_rj_carport) underground_total_rj_carport,
            sum(underground_total_frj_carport) underground_total_frj_carport,
            sum(underground_total_sale_carport) underground_total_sale_carport,
            sum(construction_land_area) construction_land_area,
            sum(expropriation_green_space_area) expropriation_green_space_area,
            sum(expropriation_road_area) expropriation_road_area, sum(other_expropriation_area) other_expropriation_area,
            sum(total_road_area) total_road_area, sum(total_green_land_area) total_green_land_area,
            sum(demonstration_area) demonstration_area, sum(plot_ratio) plot_ratio, sum(build_density) build_density,
            sum(greening_rate) greening_rate, sum(sale_ratio) sale_ratio, sum(ground_engine_carport) ground_engine_carport,
            sum(total_site_area) total_site_area, sum(confiscated_area) confiscated_area,
            sum(overall_floorage_area) overall_floorage_area, sum(total_capacity_area) total_capacity_area,
            sum(construction_plot_ratio) construction_plot_ratio, sum(total_site_area_plot_ratio) total_site_area_plot_ratio,
            sum(construction_build_density) construction_build_density,
            sum(total_site_area_build_density) total_site_area_build_density,
            sum(construction_greening_rate) construction_greening_rate,
            sum(total_site_area_greening_rate) total_site_area_greening_rate, sum(carport_ratio) carport_ratio,
            sum(total_households) total_households, objectPhaseId objPhaseId,
            '0' obj_type, sum(jbs_area) jbs_area, objectVersionId OBJ_PHASE_VERSION_ID
        from MDM_OBJ_PHASE_VERSION_INDEX mopvpi
                 inner join MDM_OBJ_PHASE_VERSION mopv on mopv.ID = OBJ_PHASE_VERSION_ID
                 left join MDM_PERIOD mp on mp.PERIOD_ORIGINAL_ID = mopv.OBJ_ID
                 left join MDM_PERIOD_PHASE mpp1 on mpp1.ID = mopv.OBJ_PHASE_ID
        where mopv.OBJ_PHASE_VERSION=version
          and mp.PERIOD_VERSION_ID = periodVersionId
          and mopv.PHASE_ID = phaseId
        group by objectPhaseId, objectVersionId;
    end if;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PLANNING_VERSION_DSUM
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_PLANNING_VERSION_DSUM" (
    objId in VARCHAR2, -- 阶段对象id
    objType in INTEGER, -- 阶段类型（项目0、宗地10、分期20、楼栋30）
    phaseId in VARCHAR2, -- 阶段id
    version in varchar2, -- 版本
    errCode out INTEGER,  --错误码
    errMsg out VARCHAR2 -- 错误信息
)
    -- 主数据版本数据汇总
-- @note 脚本初始化
-- @date 2020-06-30 17:39:18
-- @author 韩金明
    is
    objectPhaseId varchar2(36); --项目阶段id
    objectVersionId varchar2(36); --项目版本id
    objectId varchar2(36); -- 项目id
    periodVersionId varchar2(36); -- 分期阶段id
    tempOrgType varchar2(36) := objType;
    tempObjId varchar2(36) := objId;
begin
    insert into TEST(ID,REMARK) values (GET_UUID(), objId);
    insert into TEST(ID,REMARK) values (GET_UUID(), objType);
    insert into TEST(ID,REMARK) values (GET_UUID(), phaseId);
    errCode := 0;
    if objType = 0 then
        errMsg := '汇总来源为项目，跳过';
    end if;
    -- 从宗地汇总
    if objType = 10 then
        -- 查询项目id和阶段id
        select distinct mpp.OBJ_ID, mpp.ID, mpp2.ID into objectId, objectVersionId, objectPhaseId
        from MDM_PARCEL mp1
                 LEFT JOIN MDM_PROJECT mp2 ON mp2.PROJECT_ORIGINAL_ID = mp1.PROJECT_ORIGINAL_ID
                 LEFT JOIN MDM_OBJ_PHASE_VERSION mpp ON mpp.OBJ_ID = mp2.PROJECT_ORIGINAL_ID
            AND mp2.APPROVAL_STATUS = '已审核'
                 LEFT JOIN MDM_PROJECT_PHASE mpp2 ON mpp2.PROJ_ID = mp2.PROJECT_ORIGINAL_ID and mpp2.PHASE_ID = mpp.PHASE_ID
        where mp1.PARCEL_ORIGINAL_ID = objId and mpp.OBJ_PHASE_VERSION = version and mpp.PHASE_ID = phaseId;

        -- 业态数据更新
        merge into MDM_OBJ_PHASE_VERSION_PT_INDEX m1
        using (
            select objectVersionId obj_phase_version_id, product_type_id,sum(total_sale_area) total_sale_area,
                   sum(ground_sale_area) ground_sale_area, sum(underground_sale_area) underground_sale_area,
                   sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
                   sum(underground_r_sale_carport) underground_r_sale_carport,
                   sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
                   sum(underground_frj_sale_carport) underground_frj_sale_carport,
                   sum(underground_total_sale_carport) underground_total_sale_carport,
                   objectPhaseId obj_phase_id
            from SYS_PARCEL mp1
                     left join MDM_PARCEL_PHASE mpp on mpp.PAECEL_ID = mp1.ID
                     left join MDM_OBJ_PHASE_VERSION_PT_INDEX mopvpi on mopvpi.OBJ_PHASE_ID = mpp.ID
                     left join MDM_OBJ_PHASE_VERSION mopv on mopv.ID = mopvpi.OBJ_PHASE_VERSION_ID
            where mp1.PROJECT_ID = objectId and mpp.PHASE_ID=phaseId
              and mopv.OBJ_PHASE_VERSION = version
            group by PRODUCT_TYPE_ID, OPERATE_ATTRIBUTE_ID,
                     OPERATE_ATTRIBUTE_NAME,PRODUCT_TYPE_NAME,
                     PRODUCT_TYPE_JSON
        ) m2 on(m1.OBJ_PHASE_VERSION_ID = m2.obj_phase_version_id and m1.PRODUCT_TYPE_ID = m2.PRODUCT_TYPE_ID)
        when matched then
            update set m1.TOTAL_SALE_AREA = m2.total_sale_area,
                       m1.UNDERGROUND_TOTAL_SALE_CARPORT = m2.underground_total_sale_carport,
                       m1.TOTAL_GIVE_AREA = m2.total_give_area,
                       m1.GROUND_GIVE_AREA = m2.ground_give_area,
                       m1.UNDERGROUND_FRFJ_SALE_CARPORT = m2.underground_frfj_sale_carport,
                       m1.UNDERGROUND_FRJ_SALE_CARPORT = m2.underground_frj_sale_carport,
                       m1.UNDERGROUND_SALE_AREA = m2.underground_sale_area,
                       m1.UNDERGROUND_R_SALE_CARPORT = m2.underground_r_sale_carport,
                       m1.GROUND_SALE_AREA = m2.ground_sale_area;
        -- 阶段数据更新
        merge into MDM_OBJ_PHASE_VERSION_INDEX m1
        using (
            select objectVersionId obj_phase_version_id,sum(total_sale_area) total_sale_area,
                   sum(ground_sale_area) ground_sale_area, sum(underground_sale_area) underground_sale_area,
                   sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
                   sum(underground_r_sale_carport) underground_r_sale_carport,
                   sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
                   sum(underground_frj_sale_carport) underground_frj_sale_carport,
                   sum(underground_total_sale_carport) underground_total_sale_carport,
                   sum(UNDERGROUND_GIVE_AREA) underground_give_area,
                   objectPhaseId obj_phase_id
            from SYS_PARCEL mp1
                     left join MDM_PARCEL_PHASE mpp on mpp.PAECEL_ID = mp1.ID
                     left join MDM_OBJ_PHASE_VERSION_INDEX mopvpi on mopvpi.OBJ_PHASE_ID = mpp.ID
                     left join MDM_OBJ_PHASE_VERSION mopv on mopv.ID = mopvpi.OBJ_PHASE_VERSION_ID
            where mp1.PROJECT_ID = objectId
              and mpp.PHASE_ID = phaseId
              and mopv.OBJ_PHASE_VERSION = version
            group by objectVersionId, objectPhaseId
        ) m2 on(m1.OBJ_PHASE_VERSION_ID = m2.obj_phase_version_id)
        when matched then
            update set m1.TOTAL_SALE_AREA = m2.total_sale_area,
                       m1.UNDERGROUND_TOTAL_SALE_CARPORT = m2.underground_total_sale_carport,
                       m1.TOTAL_GIVE_AREA = m2.total_give_area,
                       m1.GROUND_GIVE_AREA = m2.ground_give_area,
                       m1.UNDERGROUND_FRFJ_SALE_CARPORT = m2.underground_frfj_sale_carport,
                       m1.UNDERGROUND_FRJ_SALE_CARPORT = m2.underground_frj_sale_carport,
                       m1.UNDERGROUND_SALE_AREA = m2.underground_sale_area,
                       m1.UNDERGROUND_R_SALE_CARPORT = m2.underground_r_sale_carport,
                       m1.GROUND_SALE_AREA = m2.ground_sale_area,
                       m1.UNDERGROUND_GIVE_AREA = m2.UNDERGROUND_GIVE_AREA,
                       m1.SALE_RATIO = (case when m1.OVERALL_FLOORAGE_AREA = 0 then 0
                                             else m1.TOTAL_SALE_AREA/m1.OVERALL_FLOORAGE_AREA end);
    end if;

    -- 从楼栋汇总
    if objType = 30 then
        -- 获取分期id和分期阶段id
        begin
            select mopv.ID, mp1.PERIOD_ORIGINAL_ID, mpp.ID into objectVersionId, objectId, objectPhaseId
            from MDM_BUILD mb
                     inner join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mb.PERIOD_ID
                     inner join MDM_PERIOD_PHASE mpp on mpp.PERIOD_ID = mp1.PERIOD_ORIGINAL_ID
                     inner join MDM_PERIOD_VERSION mpv on mpv.ID = mp1.PERIOD_VERSION_ID
                     inner join MDM_OBJ_PHASE_VERSION mopv on mopv.OBJ_ID = mb.PERIOD_ID
                and mpp.PHASE_ID = mopv.PHASE_ID
            where mb.id = objId and mpp.PHASE_ID = phaseId and mpv.APPROVAL_STATUS='已审核'
              and mopv.OBJ_PHASE_VERSION = version;
        exception when others then
            errMsg := '楼栋版本阶段存在多条数据';
            errCode := 501;
            return;
        end;

        -- 业态数据更新
        merge into MDM_OBJ_PHASE_VERSION_PT_INDEX m1
        using (
            select objectVersionId obj_phase_version_id, product_type_id,sum(total_sale_area) total_sale_area,
                   sum(ground_sale_area) ground_sale_area, sum(underground_sale_area) underground_sale_area,
                   sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
                   sum(underground_r_sale_carport) underground_r_sale_carport,
                   sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
                   sum(underground_frj_sale_carport) underground_frj_sale_carport,
                   sum(underground_total_sale_carport) underground_total_sale_carport,
                   objectPhaseId obj_phase_id
            from MDM_BUILD mb1
                     left join MDM_BUILD_PHASE mbp on mbp.BUILD_ID = mb1.ID
                     left join MDM_OBJ_PHASE_VERSION_PT_INDEX mopvpi on mopvpi.OBJ_PHASE_ID = mbp.ID
                     left join MDM_OBJ_PHASE_VERSION mopv on mopv.ID = mopvpi.OBJ_PHASE_VERSION_ID
            where mb1.PERIOD_ID = objectId and mbp.PHASE_ID=phaseId
              and mopv.OBJ_PHASE_VERSION = version
            group by PRODUCT_TYPE_ID, OPERATE_ATTRIBUTE_ID,
                     OPERATE_ATTRIBUTE_NAME,PRODUCT_TYPE_NAME,
                     PRODUCT_TYPE_JSON
        ) m2 on(m1.OBJ_PHASE_VERSION_ID = m2.obj_phase_version_id and m1.PRODUCT_TYPE_ID = m2.PRODUCT_TYPE_ID)
        when matched then
            update set m1.TOTAL_SALE_AREA = m2.total_sale_area,
                       m1.UNDERGROUND_TOTAL_SALE_CARPORT = m2.underground_total_sale_carport,
                       m1.TOTAL_GIVE_AREA = m2.total_give_area,
                       m1.GROUND_GIVE_AREA = m2.ground_give_area,
                       m1.UNDERGROUND_FRFJ_SALE_CARPORT = m2.underground_frfj_sale_carport,
                       m1.UNDERGROUND_FRJ_SALE_CARPORT = m2.underground_frj_sale_carport,
                       m1.UNDERGROUND_SALE_AREA = m2.underground_sale_area,
                       m1.UNDERGROUND_R_SALE_CARPORT = m2.underground_r_sale_carport,
                       m1.GROUND_SALE_AREA = m2.ground_sale_area;
        -- 阶段数据更新
        merge into MDM_OBJ_PHASE_VERSION_INDEX m1
        using (
            select objectVersionId obj_phase_version_id,sum(total_sale_area) total_sale_area,
                   sum(ground_sale_area) ground_sale_area, sum(underground_sale_area) underground_sale_area,
                   sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
                   sum(underground_r_sale_carport) underground_r_sale_carport,
                   sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
                   sum(underground_frj_sale_carport) underground_frj_sale_carport,
                   sum(underground_total_sale_carport) underground_total_sale_carport,
                   sum(UNDERGROUND_GIVE_AREA) underground_give_area,
                   objectPhaseId obj_phase_id
            from MDM_BUILD mb1
                     left join MDM_BUILD_PHASE mbp on mbp.BUILD_ID = mb1.ID
                     left join MDM_OBJ_PHASE_VERSION_INDEX mopvpi on mopvpi.OBJ_PHASE_ID = mbp.ID
                     left join MDM_OBJ_PHASE_VERSION mopv on mopv.ID = mopvpi.OBJ_PHASE_VERSION_ID
            where mb1.PERIOD_ID = objectId
              and mbp.PHASE_ID=phaseId
              and mopv.OBJ_PHASE_VERSION = version
            group by objectVersionId, objectPhaseId
        ) m2 on(m1.OBJ_PHASE_VERSION_ID = m2.obj_phase_version_id)
        when matched then
            update set m1.TOTAL_SALE_AREA = m2.total_sale_area,
                       m1.UNDERGROUND_TOTAL_SALE_CARPORT = m2.underground_total_sale_carport,
                       m1.TOTAL_GIVE_AREA = m2.total_give_area,
                       m1.GROUND_GIVE_AREA = m2.ground_give_area,
                       m1.UNDERGROUND_FRFJ_SALE_CARPORT = m2.underground_frfj_sale_carport,
                       m1.UNDERGROUND_FRJ_SALE_CARPORT = m2.underground_frj_sale_carport,
                       m1.UNDERGROUND_SALE_AREA = m2.underground_sale_area,
                       m1.UNDERGROUND_R_SALE_CARPORT = m2.underground_r_sale_carport,
                       m1.GROUND_SALE_AREA = m2.ground_sale_area,
                       m1.underground_give_area = m2.underground_give_area,
                       m1.SALE_RATIO = (case when m1.OVERALL_FLOORAGE_AREA = 0 then 0
                                             else m1.TOTAL_SALE_AREA/m1.OVERALL_FLOORAGE_AREA end);

        --更新tempOrgType和tempOrgId 进行分期向项目汇总
        tempOrgType := 20;
        tempObjId := objectId;
    end if;

    -- 从分期汇总
    if tempOrgType = 20 then
        -- 获取项目id,项目版本id和项目阶段id
        begin
            select mpp2.ID, mpv.PROJECT_ORIGINAL_ID, mpp1.ID, mpv.ID
            into objectVersionId, objectId, objectPhaseId, periodVersionId
            from MDM_PERIOD mp1
                     left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
                     left join MDM_PROJECT_PHASE mpp1 on mpp1.PROJ_ID = mpv.PROJECT_ORIGINAL_ID
                     left join MDM_OBJ_PHASE_VERSION mpp2 on mpp2.OBJ_ID = mpp1.PROJ_ID and mpp1.PHASE_ID = mpp2.PHASE_ID
            where mp1.PERIOD_ORIGINAL_ID = tempObjId
              and mpp1.PHASE_ID=phaseId
              and mpv.APPROVAL_STATUS='已审核' and OBJ_PHASE_VERSION=version;
        exception when others then
            errMsg := '分期阶段版本存在多条数据';
            errCode := 0;
            return;
        end;

        -- 业态数据更新
        merge into MDM_OBJ_PHASE_VERSION_PT_INDEX m1
        using (
            select objectVersionId obj_phase_version_id, product_type_id,sum(total_sale_area) total_sale_area,
                   sum(ground_sale_area) ground_sale_area, sum(underground_sale_area) underground_sale_area,
                   sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
                   sum(underground_r_sale_carport) underground_r_sale_carport,
                   sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
                   sum(underground_frj_sale_carport) underground_frj_sale_carport,
                   sum(underground_total_sale_carport) underground_total_sale_carport,
                   objectPhaseId obj_phase_id
            from MDM_OBJ_PHASE_VERSION_PT_INDEX mopvpi
                     inner join MDM_OBJ_PHASE_VERSION mopv on mopv.ID = OBJ_PHASE_VERSION_ID
                     left join MDM_PERIOD mp on mp.PERIOD_ORIGINAL_ID = mopv.OBJ_ID
                     left join MDM_PERIOD_PHASE mpp1 on mpp1.ID = mopv.OBJ_PHASE_ID
            where mopv.OBJ_PHASE_VERSION='V2'
              and mp.PERIOD_VERSION_ID = periodVersionId
              and mopv.PHASE_ID = phaseId
              and mopv.OBJ_PHASE_VERSION = version
            group by PRODUCT_TYPE_ID, OPERATE_ATTRIBUTE_ID,
                     OPERATE_ATTRIBUTE_NAME,PRODUCT_TYPE_NAME,
                     PRODUCT_TYPE_JSON
        ) m2 on(m1.OBJ_PHASE_VERSION_ID = m2.obj_phase_version_id and m1.PRODUCT_TYPE_ID = m2.PRODUCT_TYPE_ID)
        when matched then
            update set m1.TOTAL_SALE_AREA = m2.total_sale_area,
                       m1.UNDERGROUND_TOTAL_SALE_CARPORT = m2.underground_total_sale_carport,
                       m1.TOTAL_GIVE_AREA = m2.total_give_area,
                       m1.GROUND_GIVE_AREA = m2.ground_give_area,
                       m1.UNDERGROUND_FRFJ_SALE_CARPORT = m2.underground_frfj_sale_carport,
                       m1.UNDERGROUND_FRJ_SALE_CARPORT = m2.underground_frj_sale_carport,
                       m1.UNDERGROUND_SALE_AREA = m2.underground_sale_area,
                       m1.UNDERGROUND_R_SALE_CARPORT = m2.underground_r_sale_carport,
                       m1.GROUND_SALE_AREA = m2.ground_sale_area;
        -- 阶段数据更新
        merge into MDM_OBJ_PHASE_VERSION_INDEX m1
        using (
            select objectVersionId obj_phase_version_id,sum(total_sale_area) total_sale_area,
                   sum(ground_sale_area) ground_sale_area, sum(underground_sale_area) underground_sale_area,
                   sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
                   sum(underground_r_sale_carport) underground_r_sale_carport,
                   sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
                   sum(underground_frj_sale_carport) underground_frj_sale_carport,
                   sum(underground_total_sale_carport) underground_total_sale_carport,
                   sum(UNDERGROUND_GIVE_AREA) underground_give_area,
                   objectPhaseId obj_phase_id
            from MDM_OBJ_PHASE_VERSION_INDEX mopvpi
                     inner join MDM_OBJ_PHASE_VERSION mopv on mopv.ID = OBJ_PHASE_VERSION_ID
                     left join MDM_PERIOD mp on mp.PERIOD_ORIGINAL_ID = mopv.OBJ_ID
                     left join MDM_PERIOD_PHASE mpp1 on mpp1.ID = mopv.OBJ_PHASE_ID
            where mopv.OBJ_PHASE_VERSION='V2'
              and mp.PERIOD_VERSION_ID = periodVersionId
              and mopv.PHASE_ID = phaseId
              and mopv.OBJ_PHASE_VERSION = version
        ) m2 on(m1.OBJ_PHASE_VERSION_ID = m2.obj_phase_version_id)
        when matched then
            update set m1.TOTAL_SALE_AREA = m2.total_sale_area,
                       m1.UNDERGROUND_TOTAL_SALE_CARPORT = m2.underground_total_sale_carport,
                       m1.TOTAL_GIVE_AREA = m2.total_give_area,
                       m1.GROUND_GIVE_AREA = m2.ground_give_area,
                       m1.UNDERGROUND_FRFJ_SALE_CARPORT = m2.underground_frfj_sale_carport,
                       m1.UNDERGROUND_FRJ_SALE_CARPORT = m2.underground_frj_sale_carport,
                       m1.UNDERGROUND_SALE_AREA = m2.underground_sale_area,
                       m1.UNDERGROUND_R_SALE_CARPORT = m2.underground_r_sale_carport,
                       m1.UNDERGROUND_GIVE_AREA = m2.underground_give_area,
                       m1.GROUND_SALE_AREA = m2.ground_sale_area,
                       m1.SALE_RATIO = (case when m1.OVERALL_FLOORAGE_AREA = 0 then 0
                                             else m1.TOTAL_SALE_AREA/m1.OVERALL_FLOORAGE_AREA end);
    end if;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PRODUCTTYPELIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_PRODUCTTYPELIST" (
    info out sys_refcursor
)
    is
begin
    ---查询未禁用的所有业态
    open info for
    select PRODUCT_TYPE_NAME as "productTypeName",
       ID as "id",
       PARENT_CODE as "parentCode",
       PRODUCT_TYPE_CODE as "productTypeCode"
    from MDM_BUILD_PRODUCT_TYPE where IS_DISABLE=0 order by PRODUCT_TYPE_CODE;
end;


/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PROJ_MAINTENANCE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_PROJ_MAINTENANCE" (
    userid         IN             VARCHAR2 --当前用户id
    ,
    stationid      IN             VARCHAR2 --当前用户岗位id
    ,
    departmentid   IN             VARCHAR2 --当前用户部门id
    ,
    companyid      IN             VARCHAR2 --当前用户公司id
    ,
    projtreeinfo   OUT            SYS_REFCURSOR--项目树
) AS
--项目维护与分期维护数据源
--作者：陈丽
--日期：2019/11/13
--输入变量：用户ID
    data_auth_spid   VARCHAR2(200);
    bizcode          VARCHAR2(200);
BEGIN
    bizcode := 'MDM.XMZSJ.01';
    p_sys_get_company_tree_spid(userid => userid, stationid => stationid, deptid => departmentid, companyid => companyid, bizcode
    => bizcode, data_auth_spid => data_auth_spid);

    OPEN projtreeinfo FOR SELECT
                             orgid      "orgId",
                             orgname    AS "orgName",
                             projcode   AS "projCodeas",
                             orgtype    AS "orgType",
                             parentid   AS "parentId",
                             1 AS "levelRank",
                             cityname   AS "cityName"
                         FROM
                             (
                                 SELECT DISTINCT
                                     org_id       AS orgid,
                                     org_name     AS orgname,
                                     REPLACE(order_code, '.' ,'') AS projcode,
                                     org_type     AS orgtype,
                                     parent_id    AS parentid,
                                     is_company   AS iscompany,
                                     '' AS cityname,
                                     order_code   AS ordercode
                                 FROM
                                                tmp_company_tree
                                 WHERE
                                     id = data_auth_spid
                                 UNION ALL
                                 SELECT
                                     project_original_id   AS projid,
                                     project_name          AS projname,
                                     project_code          AS projcode,
                                     '10' AS datatype,
                                     company_id            AS parentid,
                                     1 AS levelrank,
                                     city_name             AS cityname,
                                     project_code          AS ordercode
                                 FROM
                                     mdm_project  left
                                     JOIN (
                                         SELECT
                                             MIN(project_version) AS v,
                                             project_original_id AS o
                                         FROM
                                             mdm_project
                                         GROUP BY
                                             project_original_id 
                                     ) vv ON mdm_project.project_version = vv.v
                                             AND mdm_project.project_original_id = vv.o AND mdm_project.company_id IN(
                                              SELECT DISTINCT
                                     org_id       AS orgid
                                 FROM
                                                tmp_company_tree
                                 WHERE
                                     id = data_auth_spid
                                             )
                                 WHERE
                                     vv.v IS NOT NULL 
                             ) t 
                         ORDER BY
                             projcode;

END p_mdm_proj_maintenance;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PROJ_MAINTENANCE_PHASE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_PROJ_MAINTENANCE_PHASE" (
    userid         IN             VARCHAR2 --当前用户id
    ,
    stationid      IN             VARCHAR2 --当前用户岗位id
    ,
    departmentid   IN             VARCHAR2 --当前用户部门id
    ,
    companyid      IN             VARCHAR2 --当前用户公司id
    ,
    projtreeinfo   OUT            SYS_REFCURSOR--项目树
) AS
--项目维护阶段维护数据源。
--作者：陈丽
--日期：2019/11/13
    data_auth_spid   VARCHAR2(200);
    bizcode          VARCHAR2(200);
BEGIN
    bizcode := 'MDM.XMZSJ.02';
    p_sys_get_company_tree_spid(userid => userid, stationid => stationid, deptid => departmentid, companyid => companyid, bizcode
    => bizcode, data_auth_spid => data_auth_spid);

    OPEN projtreeinfo FOR SELECT
                             id   "orgId",--组织id
                             project_name          AS "orgName",--组织名称名称
                             proj_phase            AS "projPhase",--项目阶段
                             phase_id              AS "phaseId",--阶段id
                             proj_phase_id         AS "projPhaseId",--项目阶段id
                             org_type              AS "orgType",--组织类型 0公司，1项目
                             lower(parent_id) AS "parentId",--父级id
                             nvl(total_site_area, 0) AS "totalSiteArea",--总用地面积
                             nvl(overall_floorage_area, 0) AS "overallFloorageArea",--总建组面积
                             nvl(total_sale_area, 0) AS "totalSalableArea",--总可售面积
                             nvl(total_capacity_area, 0) AS "totalCapacityArea",--计容面积
                             is_exist_proj_phase   AS "isExistProjPhase",--存在项目阶段
                             "ordercode"
                         FROM
                             (
                                 SELECT
                                     sys_project.id,
                                     project_name,
                                     mdm_phase.phase_name   AS proj_phase,
                                     phase.phase_id,
                                     phase.id               AS proj_phase_id,
                                     10 AS org_type,
                                     CASE
                                         WHEN phase.phase_id IS NULL THEN
                                             0
                                         ELSE
                                             1
                                     END AS is_exist_proj_phase,
                                     UNIT_ID             AS parent_id,
                                     mdm_obj_phase_index.total_site_area,
                                     mdm_obj_phase_index.overall_floorage_area,
                                     mdm_obj_phase_index.total_sale_area,
                                     mdm_obj_phase_index.total_capacity_area,
                                    project_code as "ordercode"
                                 FROM
                                     sys_project left
                                     JOIN (
                                         SELECT
                                             t1.id,
                                             t1.phase_id,
                                             t1.proj_id,
                                             t2.phase_order
                                         FROM
                                             mdm_project_phase t1
                                             LEFT JOIN (
                                                 SELECT
                                                     proj_id,
                                                     MAX(phase_order) AS phase_order
                                                 FROM
                                                     mdm_project_phase
                                                 GROUP BY
                                                     proj_id
                                             ) t2 ON t1.proj_id = t2.proj_id
                                                     AND t1.phase_order = t2.phase_order
                                         WHERE
                                             t2.phase_order IS NOT NULL
                                     ) phase ON sys_project.id = phase.proj_id
                                     LEFT JOIN mdm_phase ON phase.phase_id = mdm_phase.id
                                     LEFT JOIN mdm_obj_phase_index ON phase.id = mdm_obj_phase_index.obj_phase_id
                                                                      AND mdm_obj_phase_index.obj_type = 0
                                 WHERE
                                       sys_project.UNIT_ID in
                                     (
                                     SELECT DISTINCT
                                    org_id   
                                FROM

                                              tmp_company_tree
                                 WHERE
                                     id = data_auth_spid
--                                     SELECT DISTINCT
--                                     org_id   
--                                 FROM
--                                              tmp_company_tree
--                                 WHERE
--                                     id = data_auth_spid
--                                     AND org_id IN (
--                                         SELECT DISTINCT
--                                             id
--                                         FROM
--                                             sys_business_unit
--                                         START WITH
--                                             id IN (
--                                                 SELECT
--                                                     id
--                                                 FROM
--                                                     (
--                                                         SELECT
--                                                             unit_id AS id
--                                                         FROM
--                                                             sys_project
--                                                         UNION
--                                                         SELECT
--                                                             subordinate_company_id AS id
--                                                         FROM
--                                                             cdb_feasible_project_config
--                                                     ) ds
--                                             )
--                                         CONNECT BY
--                                             PRIOR parent_id = id
--                                     )
                                     )
                                 UNION ALL

                                  SELECT DISTINCT
                                     org_id       AS orgid,
                                     org_name     AS orgname,
                                    -- order_code AS projcode,
                                      '' AS proj_phase,
                                     '' AS phase_id,
                                     '' AS proj_phase_id,
                                     0     AS orgtype,
                                     NULL is_exist_proj_phase,
                                     parent_id,
                                     0 AS "totalSiteArea",
                                     0 AS "overallFloorageArea",
                                     0 AS "totalSalableArea",
                                     0 AS "totalCapacityArea",
                                   order_code as "ordercode"
                                 FROM
                                              tmp_company_tree
                                 WHERE
                                     id = data_auth_spid
--                                     AND org_id IN (
--                                         SELECT DISTINCT
--                                             id
--                                         FROM
--                                             sys_business_unit
--                                         START WITH
--                                             id IN (
--                                                 SELECT
--                                                     id
--                                                 FROM
--                                                     (
--                                                         SELECT
--                                                             unit_id AS id
--                                                         FROM
--                                                             sys_project
--                                                         UNION
--                                                         SELECT
--                                                             subordinate_company_id AS id
--                                                         FROM
--                                                             cdb_feasible_project_config
--                                                     ) ds
--                                             )
--                                         CONNECT BY
--                                             PRIOR parent_id = id
--                                     )
                             ) t order by "ordercode";

END p_mdm_proj_maintenance_phase;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PROJ_SITUATION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_PROJ_SITUATION" (
   userid         IN             VARCHAR2 --当前用户id
    ,
    stationid      IN             VARCHAR2 --当前用户岗位id
    ,
    departmentid   IN             VARCHAR2 --当前用户部门id
    ,
    companyid      IN             VARCHAR2 --当前用户公司id
    ,
projtreeinfo   OUT            SYS_REFCURSOR)
AS
--主数据首页，主数据概况。
--作者：陈丽
--日期：2019/11/13
    data_auth_spid   VARCHAR2(200);
    bizcode          VARCHAR2(200);
BEGIN
    --权限查询
    bizcode := 'MDM.XMZSJ.01';
    p_sys_get_company_tree_spid(userid => userid, stationid => stationid, deptid => departmentid, companyid => companyid, bizcode
    => bizcode, data_auth_spid => data_auth_spid);
OPEN projtreeinfo FOR
with base as(

SELECT DISTINCT
                                     org_id       AS id,
                                     org_name     AS orgName,
                                     tt.parent_id as parentsId,
                                     tt.ORDER_CODE as "orderCode",
                                      b.nums       as projTotal,
                                      nvl(c.salesArea,0) salesArea,
                                      nvl(c.salesCarport,0) salesCarport
                                 FROM
                                              tmp_company_tree tt left join(
                                              SELECT
                                                      count( b.company_id ) nums,
                                                      b.company_id
                                                    FROM
                                                      mdm_project b
                                                    WHERE
                                                      b.APPROVAL_STATUS = '已审核'
                                                    GROUP BY
                                                      b.company_id
                                                      ) b ON tt.org_id = b.company_id
                                                    left join (SELECT
                                                      company_id,
                                                      sum(mdm_obj_phase_index.total_sale_area) salesArea,
                                                      sum(mdm_obj_phase_index.underground_total_sale_carport) salesCarport
                                                    FROM
                                                      mdm_project
                                                        LEFT JOIN (
                                                    SELECT
                                                      t1.id,
                                                      t1.phase_id,
                                                      t1.proj_id,
                                                      t2.phase_order
                                                    FROM
                                                      mdm_project_phase t1
                                                      LEFT JOIN ( SELECT proj_id, MAX( phase_order ) AS phase_order FROM mdm_project_phase GROUP BY proj_id ) t2 ON t1.proj_id = t2.proj_id
                                                      AND t1.phase_order = t2.phase_order
                                                    WHERE
                                                      t2.phase_order IS NOT NULL
                                                      ) phase ON mdm_project.project_original_id = phase.proj_id
                                                        LEFT JOIN mdm_phase ON phase.phase_id = mdm_phase.id
                                                        LEFT JOIN mdm_obj_phase_index ON phase.id = mdm_obj_phase_index.obj_phase_id
                                                          AND mdm_obj_phase_index.obj_type = 0
                                                        WHERE
                                                          approval_status = '已审核'
                                                          GROUP BY company_id) c on c.company_id = tt.org_id
                                                        WHERE
                                                          tt.org_type = 0
                                                          AND ( tt.org_id != '000100000000000000000000000000' AND tt.org_id != '000200000000000000000000000000' ) 
                                     AND
                                     tt.id = data_auth_spid
                                     AND tt.org_id IN (
                                         SELECT DISTINCT
                                             id
                                         FROM
                                             sys_business_unit
                                         START WITH
                                             id IN (
                                                 SELECT
                                                     id
                                                 FROM
                                                     (
                                                         SELECT
                                                             unit_id AS id
                                                         FROM
                                                             sys_project
                                                         UNION
                                                         SELECT
                                                             subordinate_company_id AS id
                                                         FROM
                                                             cdb_feasible_project_config
                                                     ) ds
                                             )
                                         CONNECT BY
                                             PRIOR parent_id = id
                                     ))
                                    select * from base ORDER BY  "orderCode"  ;
END p_mdm_proj_situation;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PROJECT_ALL_LIST_GROUP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_PROJECT_ALL_LIST_GROUP" (
    info out sys_refcursor
)
    -- 8.获得所有项目列表(前置项目+非前置项目)	/REST/http-loadListAllProject.ac
    is
begin
    --获取所有项目 前置+非前置项目
    open info for
        select
            DISTINCT
            project_code as "code",
            unit_name as "unitName",
            address as "address",
            UPPER(copr_id) as "coprId",
            update_user_id as "updateUserId",
            sp.city_code as "cityCode",
            sp.corp_name as "coprName",
            NVL2(regexp_replace(sn, '[^0-9]*', ''), regexp_replace(sn, '[^0-9]*', '')*1, null) as "sn",
            sp.city_name as "cityName",
            sp.project_name as "name",
            UPPER(unit_id) as "unitId",
            sp.R_PROJ_ID as "id",
            '1' as "frontType",
            to_char(take_date,'yyyy-MM-dd') as "takeDate"
        from SYS_PROJECT sp
            left join MDM_PROJ_MAPPING mpm on mpm.PROJECT_ORIGINAL_ID = sp.ID;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PROJECT_APPROVAL_CB
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_PROJECT_APPROVAL_CB" (
    id IN VARCHAR2--项目表MDM_PROJECT 主键id
)
    --项目审批回调，1、创建动态货值相关版本数据//王传科实现 20191208
    --作者：陈丽
    --日期：2019/12/08
    --日期：2020/06/22 chenl 更新，审批通过后同步项目到sys_project
 AS
    approvalstatus   VARCHAR2(50);
    i_proj_id        VARCHAR2(200) := id;
BEGIN
    BEGIN
    -- 查询是否是审批通过
        SELECT
            approval_status 
            into approvalstatus
        FROM
            mdm_project
        WHERE
            id = i_proj_id;

        IF approvalstatus = '已审核' THEN
            BEGIN
                p_sys_proj_synchronization();
            END;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            dbms_output.put_line('失败咯!');
    END;
END p_mdm_project_approval_cb;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PROJECT_FROM_SERIES
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_PROJECT_FROM_SERIES" is
begin
    update MDM_PROJECT mp
    set mp.SERIES_RATIO=(
        select t.seriesRatio from T_MDM_PROJECT_SERIES_RATIO t
        where t.projectId = mp.ID
    ) where EXISTS(select 1 from T_MDM_PROJECT_SERIES_RATIO t where t.projectId = mp.ID);
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PROJECT_INFO_GROUP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_PROJECT_INFO_GROUP" (
    projectId IN VARCHAR2,
    info out sys_refcursor
)
    is
    org_projectId VARCHAR2(360); --原始id
-- 工程项目管理系统  根据ID获得项目信息  /REST/http-loadProject.ac
-- @date 2021年1月28日补充注释
-- @author hanjm
--陈丽 2021年1月28日 调整映射集团项目id
begin
    org_projectId:=projectId;
    org_projectId:=FN_GET_PROJECT_ORIGINAL_ID(projectId);
    open info for
        with base as(  select t.* from (
            select
                to_char(sp.update_date,'yyyy-MM-dd hh:mm:ss') as "updateDate",
                sp.project_code as "code",
                sp.unit_Name as "unitName",
                UPPER(sp.copr_id) as "coprId",
                sp.update_user_id as "updateUserId",
                sp.city_code as "cityCode",
                sp.vice_pm_name as "vicePMName",
                sp.update_user as "updateUser",
                sp.corp_name as "corpName",
                '' as "vicePMId",
                sp.city_name as "cityName",
                sp.project_name as "name",
                UPPER(sp.unit_id) as "unitId",
                sp.id as "id",
                replace(wmsys.wm_concat(mpr.id) over(partition by sp.id),',',';')  as "itemLmsIds",
                mpi.OVERALL_FLOORAGE_AREA as "zjmj"
--        mpr.id as parcelId,
--        mpr.parcel_name
            from SYS_PROJECT sp
            LEFT JOIN MDM_PARCEL mpr on sp.id=mpr.project_id
            LEFT JOIN (SELECT * FROM MDM_PROJECT_PHASE
                       WHERE PROJ_ID=org_projectId
                         AND ROWNUM=1
                       ORDER BY PHASE_ORDER desc
            ) pp on pp.proj_id=sp.id
            LEFT JOIN MDM_OBJ_PHASE_INDEX mpi on mpi.OBJ_PHASE_ID=pp.id
            where sp.id=org_projectId
        )t where rownum=1)
             ---20210128调整
        select
            base."updateDate",
            base."code",
            base."unitName",
            base."coprId",
            base."updateUserId",
            base."cityCode",
            base."vicePMName",
            base."updateUser",
            base."corpName",
            base."vicePMId",
            base."cityName",
            base."name",
            base."unitId",
            mp.R_PROJ_ID as "id",
            base."itemLmsIds",
            base."zjmj"
        from base
        left join MDM_PROJ_MAPPING mp on base."id"=mp.PROJECT_ORIGINAL_ID
    ;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PROJECT_LIST_GROUP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_PROJECT_LIST_GROUP" (
    info out sys_refcursor
)
    is
begin
    open info for
        select
            DISTINCT
            to_char(mp1.update_date,'yyyy-MM-dd hh-mm-ss') as "updateDate",
            mp1.project_code as "code",
            mp1.unit_name as "unitName",
            mp1.address as "address",
            UPPER(mp1.COPR_ID) as "coprId",
            UPPER(mp1.CORP_ID) as "corpId",
            mp1.update_user_id as "updateUserId",
            mp1.city_code as "cityCode",
            mp1.vice_pm_name as "vicePmName",
            mp1.update_user as "updateUser",
            mp1.COPR_NAME as "coprName",
            mp1.CORP_NAME as "corpName",
            NVL2(regexp_replace(mp1.sn, '[^0-9]*', ''), regexp_replace(mp1.sn, '[^0-9]*', '')*1, null) as "sn",
            UPPER(mp1.vice_pm_id) as "vicePmId",
            mp1.city_name as "cityName",
            mp1.project_name as "name",
            UPPER(mp1.unit_id) as "unitId",
            mpm.R_PROJ_ID as "id",
            to_char(mp1.take_date,'yyyy-MM-dd') as "takeDate",
            (case when completeTotal = total
                      then '03' else (
                case when constrcutionTotal = 0 or constrcutionTotal is null then '01' else '02' end
                )
                end) "state",
            (CASE WHEN b.cnt = 1 and stage_name = '无分期' THEN '04' else  '02'END) AS "structType"
        from SYS_PROJECT mp1
        left join (
            select
                count(*) over(partition by PROJ_ID) total,  --总楼栋数
                sum(mb.IS_GET_CONSTRCUTION_PERMIT) over(partition by PROJ_ID) constrcutionTotal, --领取施工许可证楼栋树
                sum(mb.IS_GET_COMPLETED_PERMIT) over(partition by PROJ_ID) completeTotal, --领取竣工备案证楼栋树
                mb.*
            from MDM_BUILD mb where BUILD_STATE=10
        ) mb1 on mp1.ID = mb1.PROJ_ID
        INNER JOIN (
            SELECT
                sp.id,
                sps.stage_name,
                COUNT(*) OVER(PARTITION BY sp.id) AS cnt
            FROM sys_project sp
            LEFT JOIN sys_project_stage   sps ON sp.id = sps.project_id
            UNION
            SELECT '' id, '' stage_name, 0 cnt
            FROM dual
        ) b on mp1.id=b.id
        left join MDM_PROJ_MAPPING MPM on mp1.ID = mpm.PROJECT_ORIGINAL_ID;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PROJECT_LIST_GROUP_SALE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_PROJECT_LIST_GROUP_SALE" (
    unitId IN VARCHAR2,
    info out sys_refcursor
)
    -- 22.获取项目列表	/api/loadProjectList P_MDM_PROJECT_LIST_GROUP_SALE
    is
begin
    open info for
        SELECT sp.unit_name as "unitName",
               sp.project_code as "projectCode",
               sp.unit_id as "unitId",
               sp.project_name as "projectName",
               mpm.R_PROJ_ID as "projectId"
        FROM SYS_PROJECT sp
        left join MDM_PROJ_MAPPING mpm on mpm.PROJECT_ORIGINAL_ID = sp.ID
        WHERE unitId is null or unit_id=unitId
        order by PROJECT_CODE;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PROJECT_LIST_PAGE_GROUP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_PROJECT_LIST_PAGE_GROUP" (
    pageIndex in VARCHAR2,
    pageSizes in VARCHAR2,
    unitId in VARCHAR2,
    projectCode IN varchar2,
    projectName IN VARCHAR2,
    address IN VARCHAR2,
    unitName IN VARCHAR2,
    projectState IN VARCHAR2,
    structType IN VARCHAR2,
    info out sys_refcursor
)
  --15.以分页形式返回项目列表	/REST/http-loadPageProject.ac
AS
    v_unitId varchar2(200);
    v_code varchar2(200);
    v_name varchar2(200);
    v_address varchar2(200);
    v_unitName varchar2(200);
    v_state varchar2(200);
    v_structType varchar2(200);
begin
    v_unitId:=unitId;
    v_code:=projectCode;
    v_name:=projectName;
    v_address:=address;
    v_unitName:=unitName;
    v_state:=projectState;
    v_structType:=structType;
    open info for
        select
            DISTINCT
            s2."code",
            s2."unitName",
            s2."address",
            s2."corpId",
            s2."cityCode",
            s2."corpName",
            s2."name",
            s2."id",
            s2."unitId",
            s2."state",
            s2."structTypeText",
            s2."structType",
            s2."records",
            s2."rowsTotal"
        from (
            select s1.*,rownum as "rowno",count(*)over() as "rowsTotal"
            from (
                select f.*, decode(f."structType", '04', '项目-楼栋', '项目-分期-楼栋')  as "structTypeText"
                from (
                    select s.*,count(*) over() as "records"
                    from (
                        select
                            DISTINCT
                            mp1.project_code as "code",
                            mp1.unit_name as "unitName",
                            mp1.address as "address",
                            UPPER(mp1.CORP_ID) as "corpId",
                            mp1.city_code as "cityCode",
                            mp1.corp_name as "corpName",
                            mp1.project_name as "name",
                            UPPER(mp1.unit_id) as "unitId",
                            mpm.R_PROJ_ID as "id",
                            (case when completeTotal = total
                                      then '03' else
                                      (case when constrcutionTotal = 0 or constrcutionTotal is null then '01' else '02' end)
                                end) "state",
                            ( CASE
                                  WHEN b.cnt > 1 THEN '02'
                                  ELSE (
                                      CASE WHEN b.cnt != 1 THEN '02'
                                           ELSE (
                                               CASE WHEN stage_name = '无分期' or stage_name is null THEN '04'
                                                    ELSE '02' END
                                               ) END
                                      ) END
                                ) AS "structType"
                        from SYS_PROJECT mp1
                        left join MDM_PROJ_MAPPING mpm on mpm.PROJECT_ORIGINAL_ID = mp1.ID
                        left join (
                            select
                                count(*) over(partition by PROJ_ID) total,  --总楼栋数
                                sum(mb.IS_GET_CONSTRCUTION_PERMIT) over(partition by PROJ_ID) constrcutionTotal, --领取施工许可证楼栋树
                                sum(mb.IS_GET_COMPLETED_PERMIT) over(partition by PROJ_ID) completeTotal, --领取竣工备案证楼栋树
                                mb.*
                            from MDM_BUILD mb where BUILD_STATE=10
                        ) mb1 on mp1.ID = mb1.PROJ_ID
                        LEFT JOIN (
                            SELECT sp.id, sps.stage_name, COUNT(*) OVER( PARTITION BY sp.id ) AS cnt
                            FROM sys_project sp
                            LEFT JOIN sys_project_stage sps ON sp.id = sps.project_id
                            UNION
                            SELECT '' id, '' stage_name, 0 cnt FROM dual
                        ) b on mp1.id=b.id
                    )s where (v_code is null or s."code" like '%'||v_code||'%')
                         and (v_unitname is null or s."unitName" like '%'||v_unitname||'%' )
                         and (v_address is null or s."address" like '%'||v_address||'%')
                         and (v_name is null or s."name" like '%'||v_name||'%')
                         and (v_unitid is null or s."unitId" like '%'||v_unitid||'%')
                         and (v_state is null or s."state" like '%'||v_state||'%')
                         and (v_structtype is null or s."structType" like '%'||v_structtype||'%')
                )f
            )s1 where rownum <= ( pageIndex*1) * (pageSizes*1)
        )s2  where s2."rowno" > (pageSizes*1) * ( (pageIndex*1) - 1 );
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PROJECT_STAGE_BY_BIZID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_PROJECT_STAGE_BY_BIZID" (   
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    bizId   IN     VARCHAR2,
    orgType  IN   VARCHAR2,
    dataList  out SYS_REFCURSOR
) AS
auth_spid varchar2(50);
rowcount number;
projectNmae varchar(100);
begin
if orgType ='10' then
select PROJECT_NAME into projectNmae from sys_project where id=bizId;
open dataList for
select * from (select  id as "id",projectNmae||'_'||STAGE_NAME "text",'' as "parentId",to_char(SN) as sort from sys_project_stage where PROJECT_ID=bizId
union 
select  mdm_build.id as "id",mdm_build.BUILD_NAME "text",mdm_build.PERIOD_ID as "parentId",replace(lpad(mdm_build.BUILD_NAME,5),' ','0')  as sort from sys_project_stage left join mdm_build on sys_project_stage.id=mdm_build.PERIOD_ID  
where PROJECT_ID=bizId ) tab where tab."id" is not null order by tab.sort;
else
P_SYS_GET_PROJ_TREE_SPID(
    USERID => USERID,
    STATIONID => STATIONID,
    DEPTID => DEPTID,
    COMPANYID => COMPANYID,
    BIZCODE => BIZCODE,
    AUTH_SPID => AUTH_SPID
  );
  select count(1) into rowcount from tmp_company_tree;
  if bizId ='003200000000000000000000000000' then
            open dataList for
            select * from
           (SELECT 
                 tmp_proj_tree.org_id       AS "id",
                 sys_project.PROJECT_NAME||'_'||tmp_proj_tree.org_name     AS "text",
                 ''   AS "parentId",
                 tmp_proj_tree.order_code as sort
             FROM
                  tmp_proj_tree
                  left join 
                  sys_project on
                  tmp_proj_tree.parent_id=sys_project.id
             WHERE
                 tmp_proj_tree.id = auth_spid and tmp_proj_tree.org_type='11'
                 union
                 select 
                mdm_build.id as "id",
                mdm_build.BUILD_NAME "text",
                mdm_build.PERIOD_ID as "parentId",
                replace(lpad(mdm_build.BUILD_NAME,5),' ','0') as sort 
                 from
                 mdm_build 
                inner join  (select tmp_proj_tree.ORG_ID from tmp_proj_tree inner join
                (select tmp_proj_tree.ORG_ID,tmp_proj_tree.org_name as PROJECT_NAME from tmp_proj_tree inner join (select ID  from(select * from SYS_BUSINESS_UNIT m start with m.id=bizId connect by m.parent_id=prior m.id) tab where tab.level_rank<=4) orgs
                on tmp_proj_tree.parent_id=orgs.id where tmp_proj_tree.org_type='10' and  tmp_proj_tree.id = auth_spid ) projects
                on  projects.ORG_ID=tmp_proj_tree.parent_id) stage

                on stage.ORG_ID=mdm_build.PERIOD_ID
                 )tab 
                 order by tab.sort;
else
            open dataList for
             select * from 
             (SELECT 
                 tmp_proj_tree.org_id       AS "id",
                 projects.PROJECT_NAME||'_'||tmp_proj_tree.org_name     AS "text",
                 ''   AS "parentId",
                  tmp_proj_tree.order_code as sort
             FROM
              tmp_proj_tree 
               inner join 
            (select tmp_proj_tree.ORG_ID,tmp_proj_tree.org_name as PROJECT_NAME from tmp_proj_tree inner join (select ID  from(select * from SYS_BUSINESS_UNIT m start with m.id=bizId connect by m.PARENT_ID=prior m.id) tab where tab.level_rank<=4) orgs
            on tmp_proj_tree.parent_id=orgs.id where tmp_proj_tree.org_type='10' and  tmp_proj_tree.id = auth_spid ) projects
            on projects.ORG_ID=tmp_proj_tree.parent_id where  tmp_proj_tree.id = auth_spid and tmp_proj_tree.org_type='11' 
            union
            select  mdm_build.id as "id",
            mdm_build.BUILD_NAME "text",
            mdm_build.PERIOD_ID as "parentId",
            replace(lpad(mdm_build.BUILD_NAME,5),' ','0') as sort 
            from mdm_build    inner join  

            (select tmp_proj_tree.ORG_ID from tmp_proj_tree inner join
            (select tmp_proj_tree.ORG_ID,tmp_proj_tree.org_name as PROJECT_NAME from tmp_proj_tree inner join (select ID  from(select * from SYS_BUSINESS_UNIT m start with m.id=bizId connect by m.parent_id=prior m.id) tab where tab.level_rank<=4) orgs
            on tmp_proj_tree.parent_id=orgs.id where tmp_proj_tree.org_type='10' and  tmp_proj_tree.id = auth_spid ) projects
            on  projects.ORG_ID=tmp_proj_tree.parent_id) stage

             on stage.ORG_ID=mdm_build.PERIOD_ID) tab 
             order by tab.sort
            ;
  end if;
end if;
end p_mdm_project_stage_by_bizId;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PROJECT_STAGE_LIST_GROUP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_PROJECT_STAGE_LIST_GROUP" (
    projectId IN VARCHAR2,
    info out sys_refcursor
)
    --10.根据项目ID获取分期列表	/REST/http-loadListProjectStage.ac
    is
    vProjectId varchar2(36) := FN_GET_PROJECT_ORIGINAL_ID(projectId);
begin
    open info for
        select    d.id as "id",
                  d.stage_name as "name",
                  d.state as "state",
                  d.order_code as "code",
                  nvl(TO_CHAR(d.sn), 'null') as "sn"
        from (
            SELECT    *
            from (
                SELECT DISTINCT sps.*,a.cnt,
                                (case when completeTotal = total
                                          then '03' else
                                          (case when constrcutionTotal = 0 or constrcutionTotal is null then '01' else '02' end) end) state
                FROM SYS_PROJECT_STAGE sps
                left join (
                    select
                        count(*) over(partition by PERIOD_ID) total,  --总楼栋数
                        sum(mb.IS_GET_CONSTRCUTION_PERMIT) over(partition by PERIOD_ID) constrcutionTotal, --领取施工许可证楼栋树
                        sum(mb.IS_GET_COMPLETED_PERMIT) over(partition by PERIOD_ID) completeTotal, --领取竣工备案证楼栋树
                        mb.*
                    from MDM_BUILD mb where BUILD_STATE=10
                ) mb1
                              on sps.ID = mb1.PERIOD_ID
                INNER JOIN (
                    SELECT DISTINCT
                        spg.id,
                        spg.stage_name,
                        COUNT(*) OVER(
                            PARTITION BY sp.id
                            ) AS cnt
                    FROM
                        sys_project         sp
                        LEFT JOIN sys_project_stage   spg ON spg.project_id = sp.id
                    UNION
                    SELECT
                        '' id,
                        '' stage_name,
                        0 cnt
                    FROM
                        dual
                )a on sps.id=a.id
                where  a.cnt!=1
                   or (a.cnt=1 and a.stage_name != '无分期' and a.stage_name is not null) ORDER BY sps.SN
            )s where s.project_id=vProjectId
        )d order by d.sn;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PROJECT_STAGE_SALE_GROUP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_PROJECT_STAGE_SALE_GROUP" (
    projectId IN VARCHAR2,
    info out sys_refcursor
)
--     24.根据项目id获取项目和分期信息(提供给销售系统)
    is
    vProjectId varchar(36) := FN_GET_PROJECT_ORIGINAL_ID(projectId);
begin
    open info  for
        with
            stage as (
                select distinct *
                from (
                    SELECT
                        sps.stage_name as "stageName",
                        sp.project_code as "projectCode",
                        sp.project_name as "projectName",
                        to_char(pp.plan_end_date,'yyyy-MM-dd') as "planEndDate",
                        to_char(pp.plan_start_date,'yyyy-MM-dd') as "planStartDate",
                        to_char(pp.actual_end_date,'yyyy-MM-dd')  as "actualEndDate",
                        sp.id as "projectId",
                        sps.id as "stageId",
                        sps.sn as "sn",
                        sps.order_Code as "stageCode",
                        '分期' as "type",
                        bt.bltTotal as "bldNum",
                        (case when mb1.completeTotal = mb1.total
                                  then '03' else
                                  (case when mb1.constrcutionTotal = 0 or mb1.constrcutionTotal is null then '01' else '02' end) end) "state"
                    FROM SYS_PROJECT sp
                    LEFT JOIN SYS_PROJECT_STAGE sps on sp.id=sps.project_id
                    LEFT JOIN (
                        select period_id,count(*) as bltTotal from mdm_build
                        --where IS_DELETE <> 1
                        group by period_id
                    ) bt on sps.id=bt.period_id
                    LEFT JOIN (
                        select
                            count(*) over(partition by PERIOD_ID) total,  --总楼栋数
                            sum(mb.IS_GET_CONSTRCUTION_PERMIT) over(partition by PERIOD_ID) constrcutionTotal, --领取施工许可证楼栋树
                            sum(mb.IS_GET_COMPLETED_PERMIT) over(partition by PERIOD_ID) completeTotal, --领取竣工备案证楼栋树
                            mb.*
                        from MDM_BUILD mb where BUILD_STATE=10 --and IS_DELETE<> 1
                    ) mb1 on sps.ID = mb1.PERIOD_ID
                    LEFT JOIN (
                        SELECT distinct pp.*,pn.plan_end_date,pn.plan_start_date,pn.actual_end_date
                        FROM POM_PROJ_PLAN pp
                        LEFT JOIN (
                            select tt2.*
                            from (
                                select ta.*, max(id) over(PARTITION BY PROJ_PLAN_ID) maxId
                                from (
                                    SELECT  MAX(actual_end_date) over(PARTITION BY PROJ_PLAN_ID) as max_actual_end_date, tt.*
                                    FROM POM_PROJ_PLAN_NODE tt where actual_end_date is not null
                                ) ta where ta.actual_end_date = max_actual_end_date
                            ) tt2 where tt2.id = maxId
                        )pn on pp.id=pn.proj_plan_id where pp.plan_type='关键节点计划' and pp.approval_status='已审核'
                    )  pp on sps.id=pp.proj_id
                    where sp.id=vProjectId order by sps.sn
                )s order by s."sn"
            ),
            project as (
                select
                    null as "stageName",
                    ss."projectCode",
                    ss."projectName",
                    ss."planEndDate",
                    ss."planStartDate",
                    ss.max_actual_end_date as "actualEndDate",
                    ss."projectId",
                    null as "stageId",
                    null as "sn",
                    null as "stageCode",
                    '项目' as "type",
                    ss."totalBld" as"bldNum",
                    (case when ss.completeTotal = ss.total
                              then '03' else
                              (case when ss.constrcutionTotal = 0 or ss.constrcutionTotal is null then '01' else '02' end) end) "state"
                from (
                    select bt.*,mb1.constrcutionTotal,mb1.total,mb1.completeTotal
                    from (
                        select  SUM("bldNum")over (PARTITION BY "projectId") as "totalBld", ff.*
                        from (
                            SELECT  MAX("actualEndDate") over(PARTITION BY "projectId") as max_actual_end_date,tt.*
                            FROM stage tt
                        )ff
                    )bt left join (
                        select
                            count(*) over(partition by PERIOD_ID) total,  --总楼栋数
                            sum(mb.IS_GET_CONSTRCUTION_PERMIT) over(partition by PERIOD_ID) constrcutionTotal, --领取施工许可证楼栋树
                            sum(mb.IS_GET_COMPLETED_PERMIT) over(partition by PERIOD_ID) completeTotal, --领取竣工备案证楼栋树
                            mb.*
                        from MDM_BUILD mb where BUILD_STATE=10 --and IS_DELETE <> 1
                    )mb1 on mb1.proj_id=bt."projectId"
                    where bt.max_actual_end_date=bt."actualEndDate" or bt.max_actual_end_date is null
                    order by bt.max_actual_end_date
                )ss
            )
        select ls."stageName",
               ls."projectCode",
               ls."projectName",
               ls."planEndDate",
               ls."planStartDate",
               ls."actualEndDate",
               mpm.R_PROJ_ID as "projectId",
               ls."stageId",
               ls."sn",
               ls."stageCode",
               ls."type",
               ls."bldNum",
               ls."state"
        from (
            select * from project where ROWNUM = 1
            union all
            select * from stage
        ) ls left join MDM_PROJ_MAPPING mpm on mpm.PROJECT_ORIGINAL_ID = ls."projectId";
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PROJECT_STAGE_TREE_GROUP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_PROJECT_STAGE_TREE_GROUP" (
    info out sys_refcursor
)
    is
begin
    ----获取项目分期数据 （包含组织） 处理了是否无分期的项目。需在程序中过滤   【主数据集团接口使用】
    open info for
        -- 公司
        with
            unit as (
                SELECT
                    1 as "isStageProject",
                    '1' as "isParent",
                    ORG_NAME AS "name",
                    UPPER(PARENT_ID) AS "pId",
                    UPPER(ID) AS "id",
                    'unit' as "nodeType",
                    '0'||ORDER_HIERARCHY_CODE as "orderCode"
                FROM SYS_BUSINESS_UNIT
                where IS_COMPANY=1
                START WITH  ID='003200000000000000000000000000'
                CONNECT BY PRIOR ID=PARENT_ID
            ),
            -- 项目
            project as (
                select
                    DISTINCT
                    (CASE  WHEN a."cnt" > 1 THEN 1
                           ELSE (
                               CASE WHEN a."cnt" != 1 THEN 1
                                    ELSE (
                                        CASE WHEN stage_name = '无分期' or stage_name is null  THEN 0
                                             ELSE 1
                                            END)
                                   END)
                        END) AS "isStageProject",
                    a."isParent",a."name",a."pId",a."id",a."nodeType", a."orderCode"
                from (
                    select  DISTINCT
                        '1' as "isParent",
                        sp.PROJECT_NAME as "name",
                        UPPER(sp.UNIT_ID) as "pId",
                        sp.ID as "id",
                        'project' as "nodeType",
                        '1' || sp.ORDER_HIERARCHY_CODE as "orderCode",
                        spg.stage_name as "stageName",
                        COUNT(*) OVER( PARTITION BY sp.id) AS "cnt"
                    from SYS_PROJECT sp
                    inner join unit on UPPER(sp.UNIT_ID) = unit."id"
                    LEFT JOIN sys_project_stage spg ON spg.project_id = sp.id
                    UNION
                    SELECT
                        '1' as "isParent",
                        '' as "name",
                        '' as "pId",
                        '' as "id",
                        'project' as "nodeType",
                        '1' as "orderCode",
                        '' as "stageName",
                        0 AS "cnt"
                    FROM dual
                )a  LEFT JOIN sys_project_stage spg ON spg.project_id = a."id" where a."id" is not null
            ),
            -- 分期
            stage as (
                select
                    project."isStageProject",
                    '0' as "isParent",
                    sps.STAGE_NAME as "name",
                    mpm.R_PROJ_ID as "pId",
                    sps.ID as "id",
                    'stage' as "nodeType",
                    '3'||sps.ORDER_CODE as "orderCode"
                from SYS_PROJECT_STAGE sps
                    left join MDM_PROJ_MAPPING mpm on mpm.PROJECT_ORIGINAL_ID = sps.PROJECT_ID
                inner join project on sps.PROJECT_ID = project."id"
            )
        SELECT a.*
        from (
            select * from unit
            UNION ALL
            select "isStageProject", "isParent", "name", "pId", r_proj_id as "id", "nodeType", "orderCode"
            from project
                left join MDM_PROJ_MAPPING mpm on mpm.PROJECT_ORIGINAL_ID = project."id"
            UNION ALL select * from stage
        )a order by a."orderCode";
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PUBLISH_VERSION_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_PUBLISH_VERSION_DATA" (
    phaseVersionId in varchar2, --阶段版本id
    code out INTEGER,
    info out varchar2
)
    -- 发布版本数据
-- @note 脚本初始化
-- @date 2020-06-30 17:39:18
-- @author 韩金明
    is
    projectId varchar2(36);
    phaseId varchar2(36);
    phaseVersion varchar2(36);
begin
    -- 获取项目id
    begin
        select OBJ_ID, PHASE_ID, OBJ_PHASE_VERSION into projectId, phaseId, phaseVersion
        from MDM_OBJ_PHASE_VERSION mopv
        where id = phaseVersionId and OBJ_TYPE = 0;
    exception when others then
        info := '未获取到项目信息';
        code := 501;
        return;
    end;
    -- 更新所有阶段的审核状态为已审核
    merge into MDM_OBJ_PHASE_VERSION mopv using (
        SELECT ID, '0' pType
        from MDM_PROJECT_PHASE
        where PROJ_ID = projectId
          and PHASE_ID = phaseId
        union
        select mpp1.ID, '20' pType
        from MDM_PERIOD_PHASE mpp1
                 left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                 left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
        where mpv.PROJECT_ID = projectId
          and mpp1.PHASE_ID = phaseId
          and APPROVAL_STATUS = '已审核'
        union
        select mpp1.ID, '10' pType
        from MDM_PARCEL_PHASE mpp1
                 left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
        where mp1.PROJECT_ORIGINAL_ID = projectId
          and mpp1.PHASE_ID = phaseId
        union
        select mbp1.ID, '30' pType
        from MDM_BUILD_PHASE mbp1
                 left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
        where mb1.PROJ_ID = projectId
          and mbp1.PHASE_ID = phaseId
    ) t1 on (t1.ID = mopv.OBJ_PHASE_ID)
    when matched then update
                      set mopv.PHASE_STATE = (case when mopv.OBJ_PHASE_VERSION=phaseVersion then '20' else mopv.PHASE_STATE end),
                          mopv.IS_NEWEST = (case when mopv.OBJ_PHASE_VERSION = phaseVersion then 1 else 0 end)
                      where mopv.OBJ_PHASE_VERSION = phaseVersion and mopv.PHASE_ID = phaseId;

    -- 还原项目阶段数据
    merge into MDM_PROJECT_PHASE mpp
    using (
        select * from MDM_OBJ_PHASE_VERSION
        where OBJ_ID = projectId and OBJ_TYPE = 0 and OBJ_PHASE_VERSION = phaseVersion 
          and PHASE_ID=phaseId
    ) mopv
    on (mpp.ID = mopv.OBJ_PHASE_ID and  mpp.PROJ_ID = mopv.OBJ_ID and mpp.PHASE_ID = mpp.PHASE_ID)
    when matched then
        update set mpp.PLANE_FIGURE = mopv.PLANE_FIGURE;
    -- 暂时只需要更新项目阶段 其他暂时无更新字段
--     -- 还原分期阶段数据
--     merge into MDM_PERIOD_PHASE mpp
--     using (
--         select * from MDM_OBJ_PHASE_VERSION
--         where OBJ_ID = projectId and OBJ_TYPE = 20 and OBJ_PHASE_VERSION = phaseVersion
--     ) mopv
--     on (mpp.ID = mopv.OBJ_PHASE_ID and  mpp.PERIOD_ID = mopv.OBJ_ID and mpp.PHASE_ID = mpp.PHASE_ID)
--     when matched then
--         update
--         set mpp.PHASE_STATE = mopv.PHASE_STATE;
--     -- 还原宗地阶段数据
--     merge into MDM_PARCEL_PHASE mpp
--     using (
--         select * from MDM_OBJ_PHASE_VERSION
--         where OBJ_ID = projectId and OBJ_TYPE = 20 and OBJ_PHASE_VERSION = phaseVersion
--     ) mopv
--     on (mpp.ID = mopv.OBJ_PHASE_ID and  mpp.PAECEL_ID = mopv.OBJ_ID and mpp.PHASE_ID = mpp.PHASE_ID)
--     when matched then
--         update
--         set mpp.PHASE_STATE = mopv.PHASE_STATE;
--     -- 还原楼栋阶段数据
--     merge into MDM_BUILD_PHASE mpp
--     using (
--         select * from MDM_OBJ_PHASE_VERSION
--         where OBJ_ID = projectId and OBJ_TYPE = 20 and OBJ_PHASE_VERSION = phaseVersion
--     ) mopv
--     on (mpp.ID = mopv.OBJ_PHASE_ID and  mpp.BUILD_ID = mopv.OBJ_ID and mpp.PHASE_ID = mpp.PHASE_ID)
--     when matched then
--         update
--         set mpp.PHASE_STATE = mopv.PHASE_STATE;

    -- 删除业态数据
    delete from MDM_OBJ_PHASE_PT_INDEX moppi
    where OBJ_PHASE_ID in (
        with t1 as (
            SELECT ID, '0' pType from MDM_PROJECT_PHASE
            where PROJ_ID = projectId and PHASE_ID = phaseId
            union
            select mpp1.ID, '20' pType  from MDM_PERIOD_PHASE mpp1
                                                 left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                                                 left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
            where mpv.PROJECT_ID = projectId and mpp1.PHASE_ID = phaseId and APPROVAL_STATUS='已审核'
            union
            select mpp1.ID, '10' pType from MDM_PARCEL_PHASE mpp1
                                                left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
            where mp1.PROJECT_ORIGINAL_ID = projectId and mpp1.PHASE_ID = phaseId
            union
            select mbp1.ID, '30' pType  from MDM_BUILD_PHASE mbp1
                                                 left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
            where mb1.PROJ_ID = projectId and mbp1.PHASE_ID = phaseId
        ) select t1.ID from t1
    );
    -- 添加业态数据
    insert into MDM_OBJ_PHASE_PT_INDEX(
        ID, PRODUCT_TYPE_ID, OPERATE_ATTRIBUTE_ID, OPERATE_ATTRIBUTE_NAME, BUILD_AREA, GROUND_CAPACITY_AREA,
        UNDERGROUND_CAPACITY_AREA, GROUND_UNCAPACITY_AREA, UNDERGROUND_UNCAPACITY_AREA, GROUND_TOTAL_BUILD_AREA,
        UNDERGROUND_TOTAL_BUILD_AREA, REFUGE_STOREY_AREA, MECHANICAL_FLOOR_AREA, EMPTY_SPACE_AREA, TOWER_BASEMENT_AREA,
        UNDERGROUND_GARAGE_AREA, STORAGE_AREA, STORAGE_TOTAL, TOTAL_SALE_AREA, GROUND_SALE_AREA, UNDERGROUND_SALE_AREA,
        TOTAL_GIVE_AREA, GROUND_GIVE_AREA, UNDERGROUND_GIVE_AREA, TOTAL_RESIDENCE, TOTAL_BUSINESS, GROUND_CARPORT,
        RESIDENCE_BOTTOM_CARPORT, PARKING_GARAGE_CARPORT, UNDERGROUND_RFJ_CARPORT, UNDERGROUND_RJ_CARPORT,
        UNDERGROUND_FRFJ_CARPORT, UNDERGROUND_FRJ_CARPORT, UNDERGROUND_R_SALE_CARPORT, UNDERGROUND_FRFJ_SALE_CARPORT,
        UNDERGROUND_FRJ_SALE_CARPORT, CARPORT_TOTAL, GROUND_TOTAL_CARPORT, UNDERGROUND_TOTAL_CARPORT,
        UNDERGROUND_TOTAL_RJ_CARPORT, UNDERGROUND_TOTAL_FRJ_CARPORT, UNDERGROUND_TOTAL_SALE_CARPORT, OBJ_PHASE_ID,
        OBJ_TYPE, PRODUCT_TYPE_NAME, PRODUCT_TYPE_JSON)
    with t1 as (
        SELECT ID, '0' pType from MDM_PROJECT_PHASE
        where PROJ_ID = projectId and PHASE_ID = phaseId
        union
        select mpp1.ID, '20' pType  from MDM_PERIOD_PHASE mpp1
                                             left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                                             left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
        where mpv.PROJECT_ID = projectId and mpp1.PHASE_ID = phaseId and APPROVAL_STATUS='已审核'
        union
        select mpp1.ID, '10' pType from MDM_PARCEL_PHASE mpp1
                                            left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
        where mp1.PROJECT_ORIGINAL_ID = projectId and mpp1.PHASE_ID = phaseId
        union
        select mbp1.ID, '30' pType  from MDM_BUILD_PHASE mbp1
                                             left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
        where mb1.PROJ_ID = projectId and mbp1.PHASE_ID = phaseId
    ) select
          GET_UUID(), PRODUCT_TYPE_ID, OPERATE_ATTRIBUTE_ID, OPERATE_ATTRIBUTE_NAME, BUILD_AREA, GROUND_CAPACITY_AREA,
          UNDERGROUND_CAPACITY_AREA, GROUND_UNCAPACITY_AREA, UNDERGROUND_UNCAPACITY_AREA, GROUND_TOTAL_BUILD_AREA,
          UNDERGROUND_TOTAL_BUILD_AREA, REFUGE_STOREY_AREA, MECHANICAL_FLOOR_AREA, EMPTY_SPACE_AREA, TOWER_BASEMENT_AREA,
          UNDERGROUND_GARAGE_AREA, STORAGE_AREA, STORAGE_TOTAL, TOTAL_SALE_AREA, GROUND_SALE_AREA, UNDERGROUND_SALE_AREA,
          TOTAL_GIVE_AREA, GROUND_GIVE_AREA, UNDERGROUND_GIVE_AREA, TOTAL_RESIDENCE, TOTAL_BUSINESS, GROUND_CARPORT,
          RESIDENCE_BOTTOM_CARPORT, PARKING_GARAGE_CARPORT, UNDERGROUND_RFJ_CARPORT, UNDERGROUND_RJ_CARPORT,
          UNDERGROUND_FRFJ_CARPORT, UNDERGROUND_FRJ_CARPORT, UNDERGROUND_R_SALE_CARPORT, UNDERGROUND_FRFJ_SALE_CARPORT,
          UNDERGROUND_FRJ_SALE_CARPORT, CARPORT_TOTAL, GROUND_TOTAL_CARPORT, UNDERGROUND_TOTAL_CARPORT,
          UNDERGROUND_TOTAL_RJ_CARPORT, UNDERGROUND_TOTAL_FRJ_CARPORT, UNDERGROUND_TOTAL_SALE_CARPORT,
          mopvpi.OBJ_PHASE_ID,mopvpi.OBJ_TYPE, PRODUCT_TYPE_NAME, PRODUCT_TYPE_JSON
    from  MDM_OBJ_PHASE_VERSION mopv
              inner join t1 on t1.ID = mopv.OBJ_PHASE_ID
              inner join MDM_OBJ_PHASE_VERSION_PT_INDEX mopvpi on mopv.ID = mopvpi.OBJ_PHASE_VERSION_ID
    where OBJ_PHASE_VERSION = phaseVersion and (mopv.PHASE_STATE = '20' or mopv.PHASE_STATE='19')
      and mopv.PHASE_ID=phaseId;

    -- 删除业态阶段数据
    delete from MDM_OBJ_PHASE_INDEX moppi
    where OBJ_PHASE_ID in (
        with t1 as (
            SELECT ID, '0' pType, PROJ_ID, PHASE_ORDER, PHASE_ID
            from MDM_PROJECT_PHASE
            union
            select mpp1.ID, '20' pType, mpv.PROJECT_ID, mpp1.PHASE_ORDER, PHASE_ID
            from MDM_PERIOD_PHASE mpp1
                     left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                     left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
            where APPROVAL_STATUS='已审核' and (mp1.IS_DELETE = 0 or mp1.IS_DELETE is null)
            union
            select mpp1.ID, '10' pType, mp1.PROJECT_ORIGINAL_ID,mpp1.PHASE_ORDER, PHASE_ID
            from MDM_PARCEL_PHASE mpp1
                     left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
            where mp1.IS_DELETE is null or mp1.IS_DELETE = 0
            union
            select mbp1.ID, '30' pType, mb1.PROJ_ID, mbp1.PHASE_ORDER, PHASE_ID
            from MDM_BUILD_PHASE mbp1
                     left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
            where mb1.IS_DELETE = 0 or mb1.IS_DELETE is null
        ) select t1.ID from t1
        where PROJ_ID = projectId and PHASE_ID = phaseId
    );
    -- 添加业态阶段数据
    insert into MDM_OBJ_PHASE_INDEX(
        ID, BUILD_AREA, GROUND_CAPACITY_AREA, UNDERGROUND_CAPACITY_AREA, GROUND_UNCAPACITY_AREA,
        UNDERGROUND_UNCAPACITY_AREA, GROUND_TOTAL_BUILD_AREA, UNDERGROUND_TOTAL_BUILD_AREA, REFUGE_STOREY_AREA,
        MECHANICAL_FLOOR_AREA, EMPTY_SPACE_AREA, TOWER_BASEMENT_AREA, UNDERGROUND_GARAGE_AREA, STORAGE_AREA,
        STORAGE_TOTAL, TOTAL_SALE_AREA, GROUND_SALE_AREA, UNDERGROUND_SALE_AREA, TOTAL_GIVE_AREA, GROUND_GIVE_AREA,
        UNDERGROUND_GIVE_AREA, TOTAL_RESIDENCE, TOTAL_BUSINESS, GROUND_CARPORT, RESIDENCE_BOTTOM_CARPORT,
        PARKING_GARAGE_CARPORT, UNDERGROUND_RFJ_CARPORT, UNDERGROUND_RJ_CARPORT, UNDERGROUND_FRFJ_CARPORT,
        UNDERGROUND_FRJ_CARPORT, UNDERGROUND_R_SALE_CARPORT, UNDERGROUND_FRFJ_SALE_CARPORT,
        UNDERGROUND_FRJ_SALE_CARPORT, CARPORT_TOTAL, GROUND_TOTAL_CARPORT, UNDERGROUND_TOTAL_CARPORT,
        UNDERGROUND_TOTAL_RJ_CARPORT, UNDERGROUND_TOTAL_FRJ_CARPORT, UNDERGROUND_TOTAL_SALE_CARPORT,
        CONSTRUCTION_LAND_AREA, EXPROPRIATION_GREEN_SPACE_AREA, EXPROPRIATION_ROAD_AREA, OTHER_EXPROPRIATION_AREA,
        TOTAL_ROAD_AREA, TOTAL_GREEN_LAND_AREA, DEMONSTRATION_AREA, PLOT_RATIO, BUILD_DENSITY, GREENING_RATE,
        SALE_RATIO, GROUND_ENGINE_CARPORT, TOTAL_SITE_AREA, CONFISCATED_AREA, OVERALL_FLOORAGE_AREA,
        TOTAL_CAPACITY_AREA, CONSTRUCTION_PLOT_RATIO, TOTAL_SITE_AREA_PLOT_RATIO, CONSTRUCTION_BUILD_DENSITY,
        TOTAL_SITE_AREA_BUILD_DENSITY, CONSTRUCTION_GREENING_RATE, TOTAL_SITE_AREA_GREENING_RATE, CARPORT_RATIO,
        TOTAL_HOUSEHOLDS, OBJ_PHASE_ID, OBJ_TYPE, JBS_AREA
    )
    with t1 as (
        SELECT ID, '0' pType from MDM_PROJECT_PHASE
        where PROJ_ID = projectId and PHASE_ID = phaseId
        union
        select mpp1.ID, '20' pType  from MDM_PERIOD_PHASE mpp1
                                             left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                                             left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
        where mpv.PROJECT_ID = projectId and mpp1.PHASE_ID = phaseId and APPROVAL_STATUS='已审核'
        union
        select mpp1.ID, '10' pType from MDM_PARCEL_PHASE mpp1
                                            left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
        where mpp1.PHASE_ID = phaseId and mp1.PROJECT_ORIGINAL_ID = projectId
        union
        select mbp1.ID, '30' pType  from MDM_BUILD_PHASE mbp1
                                             left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
        where mb1.PROJ_ID = projectId and mbp1.PHASE_ID = phaseId
    ) select
          GET_UUID(), BUILD_AREA, GROUND_CAPACITY_AREA, UNDERGROUND_CAPACITY_AREA, GROUND_UNCAPACITY_AREA,
          UNDERGROUND_UNCAPACITY_AREA, GROUND_TOTAL_BUILD_AREA, UNDERGROUND_TOTAL_BUILD_AREA, REFUGE_STOREY_AREA,
          MECHANICAL_FLOOR_AREA, EMPTY_SPACE_AREA, TOWER_BASEMENT_AREA, UNDERGROUND_GARAGE_AREA, STORAGE_AREA,
          STORAGE_TOTAL, TOTAL_SALE_AREA, GROUND_SALE_AREA, UNDERGROUND_SALE_AREA, TOTAL_GIVE_AREA, GROUND_GIVE_AREA,
          UNDERGROUND_GIVE_AREA, TOTAL_RESIDENCE, TOTAL_BUSINESS, GROUND_CARPORT, RESIDENCE_BOTTOM_CARPORT,
          PARKING_GARAGE_CARPORT, UNDERGROUND_RFJ_CARPORT, UNDERGROUND_RJ_CARPORT, UNDERGROUND_FRFJ_CARPORT,
          UNDERGROUND_FRJ_CARPORT, UNDERGROUND_R_SALE_CARPORT, UNDERGROUND_FRFJ_SALE_CARPORT,
          UNDERGROUND_FRJ_SALE_CARPORT, CARPORT_TOTAL, GROUND_TOTAL_CARPORT, UNDERGROUND_TOTAL_CARPORT,
          UNDERGROUND_TOTAL_RJ_CARPORT, UNDERGROUND_TOTAL_FRJ_CARPORT, UNDERGROUND_TOTAL_SALE_CARPORT,
          CONSTRUCTION_LAND_AREA, EXPROPRIATION_GREEN_SPACE_AREA, EXPROPRIATION_ROAD_AREA, OTHER_EXPROPRIATION_AREA,
          TOTAL_ROAD_AREA, TOTAL_GREEN_LAND_AREA, DEMONSTRATION_AREA, PLOT_RATIO, BUILD_DENSITY, GREENING_RATE,
          SALE_RATIO, GROUND_ENGINE_CARPORT, TOTAL_SITE_AREA, CONFISCATED_AREA, OVERALL_FLOORAGE_AREA,
          TOTAL_CAPACITY_AREA, CONSTRUCTION_PLOT_RATIO, TOTAL_SITE_AREA_PLOT_RATIO, CONSTRUCTION_BUILD_DENSITY,
          TOTAL_SITE_AREA_BUILD_DENSITY, CONSTRUCTION_GREENING_RATE, TOTAL_SITE_AREA_GREENING_RATE, CARPORT_RATIO,
          TOTAL_HOUSEHOLDS, mopvpi.OBJ_PHASE_ID, mopvpi.OBJ_TYPE, JBS_AREA
    from MDM_OBJ_PHASE_VERSION mopv
             inner join t1 on t1.ID = mopv.OBJ_PHASE_ID
             inner join MDM_OBJ_PHASE_VERSION_INDEX mopvpi on mopv.ID = mopvpi.OBJ_PHASE_VERSION_ID
    where OBJ_PHASE_VERSION = phaseVersion and (mopv.PHASE_STATE = '20' or mopv.PHASE_STATE='19')
      and mopv.PHASE_ID=phaseId;

    delete from MDM_OBJ_PHASE_AREA_LEVEL
    where OBJ_PHASE_PT_INDEX_ID in (
        with t1 as (
            SELECT ID, '0' pType
            from MDM_PROJECT_PHASE
            where PROJ_ID = projectId and PHASE_ID = phaseId
            union
            select mpp1.ID, '20' pType
            from MDM_PERIOD_PHASE mpp1
                     left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                     left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
            where mpv.PROJECT_ID = projectId and mpp1.PHASE_ID = phaseId and APPROVAL_STATUS='已审核'
            union
            select mpp1.ID, '10' pType
            from MDM_PARCEL_PHASE mpp1
                     left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
            where mpp1.PHASE_ID = phaseId and mp1.PROJECT_ORIGINAL_ID = projectId
            union
            select mbp1.ID, '30' pType
            from MDM_BUILD_PHASE mbp1
                     left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
            where mb1.PROJ_ID = projectId and mbp1.PHASE_ID = phaseId
        )select
            mopi.ID
        from MDM_OBJ_PHASE_VERSION mopv
                 -- inner join 排出到未到达阶段的数据
                 inner join t1 on t1.ID = mopv.OBJ_PHASE_ID
                 inner join MDM_OBJ_PHASE_PT_INDEX mopi on mopi.OBJ_PHASE_ID = mopv.OBJ_PHASE_ID
        where OBJ_PHASE_VERSION = phaseVersion
    );
    --发布住户类型信息
    insert into MDM_OBJ_PHASE_AREA_LEVEL(
        ID, ATTRIBUTE_AREA_LEVEL_ID, ATTRIBUTE_AREA_LEVEL_NAME, ROOM_NUMBER, OBJ_PHASE_PT_INDEX_ID
    ) with t1 as (
        SELECT ID, '0' pType from MDM_PROJECT_PHASE
        where PROJ_ID = projectId and PHASE_ID = phaseId
        union
        select mpp1.ID, '20' pType  from MDM_PERIOD_PHASE mpp1
                                             left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                                             left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
        where mpv.PROJECT_ID = projectId and mpp1.PHASE_ID = phaseId and APPROVAL_STATUS='已审核'
        union
        select mpp1.ID, '10' pType from MDM_PARCEL_PHASE mpp1
                                            left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
        where mpp1.PHASE_ID = phaseId and mp1.PROJECT_ORIGINAL_ID = projectId
        union
        select mbp1.ID, '30' pType  from MDM_BUILD_PHASE mbp1
                                             left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
        where mb1.PROJ_ID = projectId and mbp1.PHASE_ID = phaseId
    )select
         GET_UUID(), ATTRIBUTE_AREA_LEVEL_ID, ATTRIBUTE_AREA_LEVEL_NAME, ROOM_NUMBER, ppi.ID
    from t1
             left join MDM_OBJ_PHASE_VERSION_PT_INDEX pi on t1.ID = pi.OBJ_PHASE_ID
             left join MDM_OBJ_PHASE_PT_INDEX ppi on ppi.OBJ_PHASE_ID = t1.ID
        and ppi.PRODUCT_TYPE_ID = pi.PRODUCT_TYPE_ID
             inner join MDM_OBJ_PHASE_AL_V mopav on mopav.OBJ_PHASE_PT_INDEX_ID = pi.ID
             left join MDM_OBJ_PHASE_VERSION mopv on mopv.ID = mopav.OBJ_PHASE_VERSION_ID
    where mopv.OBJ_PHASE_VERSION = phaseVersion and (mopv.PHASE_STATE = '20' or mopv.PHASE_STATE='19')
      and mopv.PHASE_ID=phaseId;
    info := '成功';
    code := 0;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_ROOM_BY_BUILDID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_ROOM_BY_BUILDID" (
    buildId in varchar2,
    roomNums out SYS_REFCURSOR,
    unintNums out SYS_REFCURSOR,
    floorNum out SYS_REFCURSOR,
    rooms out SYS_REFCURSOR,
    categoryRateData out SYS_REFCURSOR
) AS
total number;
ds_total number;
qy_total number;
rg_total number;
xd_total number;
xk_total number;

yl_total number;
yy_total number;

--chenl 20200701 调整验收，根据集团于政要求，销控图颜色按照销售系统来
--预留 #FDFF00
yl_color varchar2(50):='#FDFF00';
--预约 #00FF00 
yy_color varchar2(50):='#00FF00';

--待售 #FCFCFC 
---待售
ds_color varchar2(50):='#FCFCFC';
--签约 #CD00FE  
--签约
qy_color varchar2(50):='#CD00FE';
--认购  #FD0200 
--认购
rg_color varchar2(50):='#FD0200';
--小订 #FFA303
--小订
xd_color varchar2(50):='#FFA303';
--销控
--销控 #BBCFE4
xk_color varchar2(50):='#BBCFE4';
begin
select count(1) into total from MDM_ROOM where BUILDING_ID=buildId;
--select count(1) into ds_total from MDM_ROOM where BUILDING_ID=buildId and SALE_STATE='待售'  ;
--select count(1) into qy_total from MDM_ROOM where BUILDING_ID=buildId and SALE_STATE='签约'  ;
--select count(1) into rg_total from MDM_ROOM where BUILDING_ID=buildId and SALE_STATE='认购'  ;
--select count(1) into xd_total from MDM_ROOM where BUILDING_ID=buildId and SALE_STATE='小订'  ;
--select count(1) into xk_total from MDM_ROOM where BUILDING_ID=buildId and SALE_STATE='销控'  ;
---chenl 20200701 优化
select sum(case when SALE_STATE='待售' then 1 else 0 end) ds,
sum(case when SALE_STATE='签约' then 1 else 0 end) yy,
sum(case when SALE_STATE='认购' then 1 else 0 end) rg,
sum(case when SALE_STATE='小订' then 1 else 0 end) xd,
sum(case when SALE_STATE='销控' then 1 else 0 end) xk,
sum(case when SALE_STATE='预留' then 1 else 0 end) yl,
sum(case when SALE_STATE='预约' then 1 else 0 end) yy
into ds_total,qy_total,rg_total,xd_total,xk_total,yl_total,yy_total
from MDM_ROOM where BUILDING_ID=buildId;

if total <> 0 then 
open floorNum for
select FLOOR_NAME as "name",replace(lpad(tab.FLOOR_NAME,5),' ','0')  as sort from (select FLOOR_NAME from MDM_ROOM where BUILDING_ID=buildId group by  FLOOR_NAME)tab
order by sort desc;

open unintNums for
select UNIT_ID as "name",replace(lpad(tab.UNIT_ID,5),' ','0')  as sort from (select UNIT_ID from MDM_ROOM where BUILDING_ID=buildId group by  UNIT_ID)tab
order by sort;

open roomNums for
select 号码 as "room_num",UNIT_ID "unitId" from (
select UNIT_ID,substr(room_code,length(floor_name)+1) as 号码 from mdm_room where building_id=buildId )tab  group by 号码,UNIT_ID order by UNIT_ID,号码;

open categoryRateData for
select * from
(select xk_total as "categoryCount",
xk_color as "categoryColor",
'销控' as "categoryName",
fn_ConvertDecimalToPercentage(xk_total/total) as "categoryRate",
1 as sort
from dual
union
select ds_total as "categoryCount",
ds_color as "categoryColor",
'待售' as "categoryName",
fn_ConvertDecimalToPercentage(ds_total/total) as "categoryRate",
2 as sort
from dual
union
select xd_total as "categoryCount",
yy_color as "categoryColor",
'预约' as "categoryName",
fn_ConvertDecimalToPercentage(yy_total/total) as "categoryRate",
3 as sort
from dual
union
select xd_total as "categoryCount",
yl_color as "categoryColor",
'预留' as "categoryName",
fn_ConvertDecimalToPercentage(yl_total/total) as "categoryRate",
4 as sort
from dual
union
select xd_total as "categoryCount",
xd_color as "categoryColor",
'小订' as "categoryName",
fn_ConvertDecimalToPercentage(xd_total/total) as "categoryRate",
5 as sort
from dual
union
select rg_total as "categoryCount",
rg_color as "categoryColor",
'认购' as "categoryName",
fn_ConvertDecimalToPercentage(rg_total/total) as "categoryRate",
6 as sort
from dual
union
select qy_total as "categoryCount",
qy_color as "categoryColor",
'签约' as "categoryName",
fn_ConvertDecimalToPercentage(qy_total/total) as "categoryRate",
7 as sort
from dual) tab order by tab.sort;

open rooms for
select 
substr(room_code,length(floor_name)+1) as "room_num",
ROOM_NAME,ROOM_CODE,BUILDING_ID,BUILDING_NAME,UNIT_ID "unitId",UNIT_NAME,FLOOR_ID,FLOOR_NAME,SALE_STATE,PRE_BLD_AREA,
PRE_IN_AREA,ACTUAL_BLD_AREA,ACTUAL_IN_AREA,NEW_BLD_AREA,NEW_IN_AREA,PRODUCT_NAME,BASE_PRICE,BASE_TOTAL,BZ_PRICE,BZ_TOTAL,BZ_TOTAL_AREA_TYPE,
TRADE_PRICE,
TRADE_TOTAL,
TRADE_TOTAL_AREA_TYPE,
case when TRADE_CONTRACT_DATE is not null then to_char( TRADE_CONTRACT_DATE,'yyyy-mm-dd' ) else '' end TRADE_CONTRACT_DATE,
case when IS_AREA_BC =1 then '是' else '否' end IS_AREA_BC,
PRE_AFTER_BC_TOTAL,
ACTUAL_AFTER_BC_TOTAL,
IS_TRANSFER,
PRE_TRANSFER_DATE,
ACTUAL_TRANSFER_DATE,
IS_INDIRECT,
ACTUAL_INDIRECT_DATE,
ACTUAL_INDIRECT_TOTAL,
case when SALE_STATE='待售' then ds_color
when SALE_STATE='签约' then qy_color
when SALE_STATE='认购' then rg_color
when SALE_STATE='小订' then xd_color
when SALE_STATE='销控' then xk_color
when SALE_STATE='预约' then yy_color
when SALE_STATE='预留' then yl_color end color,
ACTUAL_INDIRECT_AREA from MDM_ROOM where BUILDING_ID=buildId order by LPAD(unit_id,10,'0'),LPAD(floor_name,10,'0'),LPAD(room_code,10,'0') ;
end if;
end p_mdm_room_by_buildId;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_ROOM_FROM_SMS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_ROOM_FROM_SMS" IS
   synchDate Date ;
BEGIN
--从销售系统抓取房间数据 mdm_room_from_sms 中间表数据转换到mdm_room_bak 目标表的存储过程
--作者：鲜晓勇
--日期：2020/01/13
	---初始化同步时间 
    synchDate:=sysdate();
    INSERT INTO mdm_room_from_sms 
    select * from api_room_from_sms;
    
    MERGE INTO mdm_room_bak USING (
       --数据处理  中间表中出现 多条相同数据时，去重，默认去id最大的哪条，可修改
	     -- mdm_room_from_sms 从销售系统接口抓取房间数据中间表中，存在字段 返回“无”的情况，和mdm_room_bak 目标表的数据类型无法对应。先将处理为将“无”的数据转换为 null 可修改
--                                    SELECT
--                                        *
--                                    FROM
--                                        mdm_room_from_sms x
--                                    WHERE
--                                        x.rowId = (
--                                            SELECT
--                                                MAX(y.rowId)
--                                            FROM
--                                                mdm_room_from_sms y
--                                            WHERE  
--                                                x.room_id = y.room_id
--                                        )
                  select * from 
                 (select mdm_room_from_sms.*,row_number() over(partition by room_id order by TRADE_CONTRACT_DATE desc) as order_num 
                 from mdm_room_from_sms )rfs where order_num = 1
                                )
        mdm_room_from_sms ON ( mdm_room_bak.id = mdm_room_from_sms.room_id )
        WHEN MATCHED THEN
        --修改 将中间表数据update 到 room_bak 表
        UPDATE SET
            mdm_room_bak.room_name = mdm_room_from_sms.room_name,  mdm_room_bak.room_code = CASE mdm_room_from_sms.room_code  WHEN '无' THEN  NULL  ELSE  mdm_room_from_sms.room_code END,
            mdm_room_bak.product_code=case mdm_room_from_sms.pt_code when '无' THEN  NULL ELSE mdm_room_from_sms.pt_code END,
            mdm_room_bak.product_name=case mdm_room_from_sms.pt_name when '无' THEN  NULL ELSE mdm_room_from_sms.pt_name END,
            mdm_room_bak.product_is_cw= CASE WHEN mdm_room_from_sms.pt_is_cw = '无' OR mdm_room_from_sms.pt_is_cw = '否' THEN 0 ELSE 1 END,
            mdm_room_bak.project_id=case mdm_room_from_sms.project_id when '无' THEN  NULL ELSE mdm_room_from_sms.project_id END,
            mdm_room_bak.project_code=case mdm_room_from_sms.project_code when '无' THEN  NULL ELSE mdm_room_from_sms.project_code END,
            mdm_room_bak.project_name=case mdm_room_from_sms.project_name when '无' THEN  NULL ELSE mdm_room_from_sms.project_name END,
            mdm_room_bak.building_id=case mdm_room_from_sms.building_id when '无' THEN  NULL ELSE mdm_room_from_sms.building_id END,
            mdm_room_bak.building_name=case mdm_room_from_sms.building_name when '无' THEN  NULL ELSE mdm_room_from_sms.building_name END,
            mdm_room_bak.unit_id=case mdm_room_from_sms.unit_id when '无' THEN  NULL ELSE mdm_room_from_sms.unit_id END,
            mdm_room_bak.unit_name=case mdm_room_from_sms.unit_name when '无' THEN  NULL ELSE mdm_room_from_sms.unit_name END,
            mdm_room_bak.floor_id=case mdm_room_from_sms.floor_id when '无' THEN  NULL ELSE mdm_room_from_sms.floor_id END,
            mdm_room_bak.floor_name=case mdm_room_from_sms.floor_name when '无' THEN  NULL ELSE mdm_room_from_sms.floor_name END,
            mdm_room_bak.sale_state=case mdm_room_from_sms.sale_state when '无' THEN  NULL ELSE mdm_room_from_sms.sale_state END,
            mdm_room_bak.pre_bld_area=case mdm_room_from_sms.build_area_yc when '无' THEN  NULL ELSE mdm_room_from_sms.build_area_yc END,
            mdm_room_bak.pre_in_area=case mdm_room_from_sms.inside_area_yc when '无' THEN  NULL ELSE mdm_room_from_sms.inside_area_yc END,
            mdm_room_bak.actual_bld_area=case mdm_room_from_sms.build_area_sc when '无' THEN  NULL ELSE mdm_room_from_sms.build_area_sc END,
            mdm_room_bak.actual_in_area=case mdm_room_from_sms.inside_area_sc when '无' THEN  NULL ELSE mdm_room_from_sms.inside_area_sc END,
            mdm_room_bak.new_bld_area=case mdm_room_from_sms.build_area_new when '无' THEN  NULL ELSE mdm_room_from_sms.build_area_new END,
            mdm_room_bak.new_in_area=case mdm_room_from_sms.inside_area_new when '无' THEN  NULL ELSE mdm_room_from_sms.inside_area_new END,
            mdm_room_bak.pre_sell_permit_id=case mdm_room_from_sms.preselling_card_id when '无' THEN  NULL ELSE mdm_room_from_sms.preselling_card_id END,
            mdm_room_bak.pre_sell_permit_no=case mdm_room_from_sms.preselling_card_code when '无' THEN  NULL ELSE mdm_room_from_sms.preselling_card_code END,
            mdm_room_bak.pre_sell_permit_date=case when (select is_date(''||mdm_room_from_sms.preselling_card_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.preselling_card_date, 'yyyy-MM-dd')END,
            mdm_room_bak.base_price=case mdm_room_from_sms.base_price when '无' THEN  NULL ELSE mdm_room_from_sms.base_price END,
            mdm_room_bak.base_total=case mdm_room_from_sms.base_total when '无' THEN  NULL ELSE mdm_room_from_sms.base_total END,
            mdm_room_bak.base_total_area_type=case mdm_room_from_sms.base_total_area_type when '无' THEN  NULL ELSE mdm_room_from_sms.base_total_area_type END,
            mdm_room_bak.bz_price=case mdm_room_from_sms.bz_price when '无' THEN  NULL ELSE mdm_room_from_sms.bz_price END,
            mdm_room_bak.bz_total=case mdm_room_from_sms.bz_total when '无' THEN  NULL ELSE mdm_room_from_sms.bz_total END,
            mdm_room_bak.bz_total_area_type=case mdm_room_from_sms.bz_total_area_type when '无' THEN  NULL ELSE mdm_room_from_sms.bz_total_area_type END,
            mdm_room_bak.trade_price=case mdm_room_from_sms.trade_price when '无' THEN  NULL ELSE mdm_room_from_sms.trade_price END,
            mdm_room_bak.trade_total=case mdm_room_from_sms.trade_total when '无' THEN  NULL ELSE mdm_room_from_sms.trade_total END,
            mdm_room_bak.trade_total_area_type=case mdm_room_from_sms.trade_total_area_type when '无' THEN  NULL ELSE mdm_room_from_sms.trade_total_area_type END,
            mdm_room_bak.trade_contract_date=case when (select is_date(''||mdm_room_from_sms.trade_contract_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.trade_contract_date, 'yyyy-MM-dd')END,
            mdm_room_bak.is_area_bc= CASE WHEN mdm_room_from_sms.is_area_bc = '无' OR mdm_room_from_sms.is_area_bc = '否' THEN 0 ELSE 1 END,
            mdm_room_bak.pre_after_bc_total=case mdm_room_from_sms.pre_after_bc_total when '无' THEN  NULL ELSE mdm_room_from_sms.pre_after_bc_total END,
            mdm_room_bak.actual_after_bc_total=case mdm_room_from_sms.fact_after_bc_total when '无' THEN  NULL ELSE mdm_room_from_sms.fact_after_bc_total END,
            mdm_room_bak.is_transfer= CASE WHEN mdm_room_from_sms.is_transfer = '无' OR mdm_room_from_sms.is_transfer = '否' THEN 0 ELSE 1 END,
            mdm_room_bak.pre_transfer_date=case when (select is_date(''||mdm_room_from_sms.pre_transfer_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.pre_transfer_date, 'yyyy-MM-dd')END,
            mdm_room_bak.actual_transfer_date=case when (select is_date(''||mdm_room_from_sms.fact_transfer_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.fact_transfer_date, 'yyyy-MM-dd')END,
            mdm_room_bak.is_indirect=CASE WHEN mdm_room_from_sms.is_indirect = '无' OR mdm_room_from_sms.is_indirect = '否' THEN 0 ELSE 1 END,
            mdm_room_bak.actual_indirect_date=case when (select is_date(''||mdm_room_from_sms.fact_indirect_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.fact_indirect_date, 'yyyy-MM-dd')END,
            mdm_room_bak.actual_indirect_total=case mdm_room_from_sms.fact_indirect_area when '无' THEN  NULL ELSE mdm_room_from_sms.fact_indirect_area END,
            mdm_room_bak.actual_indirect_area=case mdm_room_from_sms.fact_indirect_area when '无' THEN  NULL ELSE mdm_room_from_sms.fact_indirect_area END,
            mdm_room_bak.SYNCH_DATE=''||synchDate||''            
            WHEN NOT MATCHED THEN 
            --新增 将中间表数据 insert 到room_bak 表
       INSERT ( mdm_room_bak.id, mdm_room_bak.room_name, mdm_room_bak.room_code, mdm_room_bak.product_code,
        mdm_room_bak.product_name,
        mdm_room_bak.product_is_cw,
        mdm_room_bak.project_id,
        mdm_room_bak.project_code,
        mdm_room_bak.project_name,
        mdm_room_bak.building_id,
        mdm_room_bak.building_name,
        mdm_room_bak.unit_id,
        mdm_room_bak.unit_name,
        mdm_room_bak.floor_id,
        mdm_room_bak.floor_name,
        mdm_room_bak.sale_state,
        mdm_room_bak.pre_bld_area,
        mdm_room_bak.pre_in_area,
        mdm_room_bak.actual_bld_area,
        mdm_room_bak.actual_in_area,
        mdm_room_bak.new_bld_area,
        mdm_room_bak.new_in_area,
        mdm_room_bak.pre_sell_permit_id,
        mdm_room_bak.pre_sell_permit_no,
        mdm_room_bak.pre_sell_permit_date,
        mdm_room_bak.base_price,
        mdm_room_bak.base_total,
        mdm_room_bak.base_total_area_type,
        mdm_room_bak.bz_price,
        mdm_room_bak.bz_total,
        mdm_room_bak.bz_total_area_type,
        mdm_room_bak.trade_price,
        mdm_room_bak.trade_total,
        mdm_room_bak.trade_total_area_type,
        mdm_room_bak.trade_contract_date,
        mdm_room_bak.is_area_bc,
        mdm_room_bak.pre_after_bc_total,
        mdm_room_bak.actual_after_bc_total,
        mdm_room_bak.is_transfer,
        mdm_room_bak.pre_transfer_date,
        mdm_room_bak.actual_transfer_date,
        mdm_room_bak.is_indirect,
        mdm_room_bak.actual_indirect_date,
        mdm_room_bak.actual_indirect_total,
        mdm_room_bak.actual_indirect_area,
        mdm_room_bak.SYNCH_DATE
    ) values (mdm_room_from_sms.room_id,
       case mdm_room_from_sms.room_name when '无' THEN NULL ELSE mdm_room_from_sms.room_name END,
       case mdm_room_from_sms.room_code when '无' THEN NULL ELSE mdm_room_from_sms.room_code END,
       case mdm_room_from_sms.pt_code when '无' THEN NULL ELSE mdm_room_from_sms.pt_code END,
       case mdm_room_from_sms.pt_name when '无' THEN NULL ELSE mdm_room_from_sms.pt_name END,
       case WHEN mdm_room_from_sms.pt_is_cw='无' OR mdm_room_from_sms.pt_is_cw = '否' THEN 0 ELSE 1 END,
       case mdm_room_from_sms.project_id when '无' THEN NULL ELSE mdm_room_from_sms.project_id END,
       case mdm_room_from_sms.project_code when '无' THEN NULL ELSE mdm_room_from_sms.project_code END,
       case mdm_room_from_sms.project_name when '无' THEN NULL ELSE mdm_room_from_sms.project_name END,
       case mdm_room_from_sms.building_id when '无' THEN NULL ELSE mdm_room_from_sms.building_id END,
       case mdm_room_from_sms.building_name when '无' THEN NULL ELSE mdm_room_from_sms.building_name END,
       case mdm_room_from_sms.unit_id when '无' THEN NULL ELSE mdm_room_from_sms.unit_id END,
       case mdm_room_from_sms.unit_name when '无' THEN NULL ELSE mdm_room_from_sms.unit_name END,
       case mdm_room_from_sms.floor_id when '无' THEN NULL ELSE mdm_room_from_sms.floor_id END,
       case mdm_room_from_sms.floor_name when '无' THEN NULL ELSE mdm_room_from_sms.floor_name END,
       case mdm_room_from_sms.sale_state when '无' THEN NULL ELSE mdm_room_from_sms.sale_state END,
       case mdm_room_from_sms.build_area_yc when '无' THEN NULL ELSE mdm_room_from_sms.build_area_yc END,
       case mdm_room_from_sms.inside_area_yc when '无' THEN NULL ELSE mdm_room_from_sms.inside_area_yc END,
       case mdm_room_from_sms.build_area_sc when '无' THEN NULL ELSE mdm_room_from_sms.build_area_sc END,
       case mdm_room_from_sms.inside_area_sc when '无' THEN NULL ELSE mdm_room_from_sms.inside_area_sc END,
       case mdm_room_from_sms.build_area_new when '无' THEN NULL ELSE mdm_room_from_sms.build_area_new END,
       case mdm_room_from_sms.inside_area_new when '无' THEN NULL ELSE mdm_room_from_sms.inside_area_new END,
       case mdm_room_from_sms.preselling_card_id when '无' THEN NULL ELSE mdm_room_from_sms.preselling_card_id END,
       case mdm_room_from_sms.preselling_card_code when '无' THEN NULL ELSE mdm_room_from_sms.preselling_card_code END,
       case when (select is_date(''||mdm_room_from_sms.preselling_card_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.preselling_card_date, 'yyyy-MM-dd')END,  
       case mdm_room_from_sms.base_price when '无' THEN NULL ELSE mdm_room_from_sms.base_price END,
       case mdm_room_from_sms.base_total when '无' THEN NULL ELSE mdm_room_from_sms.base_total END,
       case mdm_room_from_sms.base_total_area_type when '无' THEN NULL ELSE mdm_room_from_sms.base_total_area_type END,
       case mdm_room_from_sms.bz_price when '无' THEN NULL ELSE mdm_room_from_sms.bz_price END,
       case mdm_room_from_sms.bz_total when '无' THEN NULL ELSE mdm_room_from_sms.bz_total END,
       case mdm_room_from_sms.bz_total_area_type when '无' THEN NULL ELSE mdm_room_from_sms.bz_total_area_type END,
       case mdm_room_from_sms.trade_price when '无' THEN NULL ELSE mdm_room_from_sms.trade_price END,
       case mdm_room_from_sms.trade_total when '无' THEN NULL ELSE mdm_room_from_sms.trade_total END,
       case mdm_room_from_sms.trade_total_area_type when '无' THEN NULL ELSE mdm_room_from_sms.trade_total_area_type END,
        case when (select is_date(''||mdm_room_from_sms.trade_contract_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.trade_contract_date, 'yyyy-MM-dd')END,  
       case WHEN mdm_room_from_sms.is_area_bc='无' OR mdm_room_from_sms.is_area_bc = '否' THEN 0 ELSE 1 END,
       case mdm_room_from_sms.pre_after_bc_total when '无' THEN NULL ELSE mdm_room_from_sms.pre_after_bc_total END,
       case mdm_room_from_sms.fact_after_bc_total when '无' THEN NULL ELSE mdm_room_from_sms.fact_after_bc_total END,
       case WHEN mdm_room_from_sms.is_transfer='无' OR mdm_room_from_sms.is_transfer = '否' THEN 0 ELSE 1 END,    
       case when (select is_date(''||mdm_room_from_sms.pre_transfer_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.pre_transfer_date, 'yyyy-MM-dd')END,  
       case when (select is_date(''||mdm_room_from_sms.fact_transfer_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.fact_transfer_date, 'yyyy-MM-dd')END,
       case WHEN mdm_room_from_sms.is_indirect='无' OR mdm_room_from_sms.is_indirect = '否' THEN 0 ELSE 1 END,
       case when (select is_date(''||mdm_room_from_sms.fact_indirect_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.fact_indirect_date, 'yyyy-MM-dd')END,
       case mdm_room_from_sms.fact_indirect_total when '无' THEN NULL ELSE mdm_room_from_sms.fact_indirect_total END,
       case mdm_room_from_sms.fact_indirect_area when '无' THEN NULL ELSE mdm_room_from_sms.fact_indirect_area END,
       synchDate
    );
    COMMIT;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_SALE_PROJECTIDS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_SALE_PROJECTIDS" (IDS OUT SYS_REFCURSOR)
AS
BEGIN
	open IDS for 
	SELECT id from SYS_PROJECT;
END P_MDM_SALE_PROJECTIDS;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_STAGE_INFO_BI_GROUP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_STAGE_INFO_BI_GROUP" (
    projectId IN VARCHAR2,
    info out sys_refcursor
)
    --13.通过项目id获取项目信息（BI）	/REST/http-loadProjectInfo.ac
is
    vProjectId varchar2(36):=FN_GET_PROJECT_ORIGINAL_ID(projectId);
begin
    open info for
        select DISTINCT f.* from (
            select  t.GROUND_TOTAL_BUILD_AREA as "stageGroundArea",
                    t.UNDERGROUND_TOTAL_BUILD_AREA as "stageUndergroundArea",
                    t.sn as "sn",
                    t.STAGE_NAME AS "stageName",
                    t.id as "stageId",
                    t."nodeName" as "stageNode",
                    t.order_code as "stageCode",
                    '' as "url",
                    t.OVERALL_FLOORAGE_AREA as "stageZjzmj",
                    (case when mb1.completeTotal = mb1.total
                              then '03' else
                              (case when mb1.constrcutionTotal = 0 or mb1.constrcutionTotal is null then '01' else '02' end) end) "stageState"
            from (
                SELECT ppn.node_name as "nodeName",stg.* from (
                    select sps.*,
                           mpp.phase_order,
                           obi.GROUND_TOTAL_BUILD_AREA,--地上总建筑面积
                           obi.UNDERGROUND_TOTAL_BUILD_AREA,--地下总建筑面积
                           obi.OVERALL_FLOORAGE_AREA--总建筑面积
                    from SYS_PROJECT_STAGE sps
                    inner join (
                        select mpp1.*
                        from MDM_PERIOD_PHASE mpp1
                        inner join (
                            select PERIOD_ID, max(PHASE_ORDER)as PHASE_ORDER
                            from MDM_PERIOD_PHASE
                            where PHASE_STATE =19 or PHASE_STATE=20
                            group by PERIOD_ID
                        ) mpp2 on mpp1.PERIOD_ID = mpp2.PERIOD_ID
                            and mpp1.PHASE_ORDER = mpp2.PHASE_ORDER
                    ) mpp on sps.ID = mpp.PERIOD_ID
                    LEFT JOIN MDM_OBJ_PHASE_INDEX obi on mpp.id=obi.OBJ_PHASE_ID
                    where sps.project_id=vProjectId
                ) stg
                LEFT JOIN (
                    SELECT distinct pp1.*,pn.plan_end_date,pn.plan_start_date,pn.node_name FROM POM_PROJ_PLAN pp1
                    LEFT JOIN (
                        select tt2.* from (
                            select ta.*, max(id) over(PARTITION BY PROJ_PLAN_ID) maxId from (
                                SELECT  MAX(actual_end_date) over(PARTITION BY PROJ_PLAN_ID) as max_actual_end_date, tt.*
                                FROM POM_PROJ_PLAN_NODE tt where actual_end_date is not null
                            ) ta where ta.actual_end_date = max_actual_end_date
                        ) tt2 where tt2.id = maxId
                    )pn on pp1.id=pn.proj_plan_id where pp1.plan_type='关键节点计划' and pp1.approval_status='已审核'
                )  ppn on stg.id=ppn.proj_id
            )t
            left join (
                select
                    count(*) over(partition by PERIOD_ID) total,  --总楼栋数
                    sum(mb.IS_GET_CONSTRCUTION_PERMIT) over(partition by PERIOD_ID) constrcutionTotal, --领取施工许可证楼栋树
                    sum(mb.IS_GET_COMPLETED_PERMIT) over(partition by PERIOD_ID) completeTotal, --领取竣工备案证楼栋树
                    mb.*
                from MDM_BUILD mb where BUILD_STATE=10
            ) mb1
                          on t.ID = mb1.PERIOD_ID
            INNER JOIN (
                SELECT DISTINCT
                    spg.id,
                    spg.stage_name,
                    COUNT(*) OVER(
                        PARTITION BY sp.id
                        ) AS cnt
                FROM
                    sys_project         sp
                    LEFT JOIN sys_project_stage   spg ON spg.project_id = sp.id
                UNION
                SELECT
                    '' id,
                    '' stage_name,
                    0 cnt
                FROM
                    dual
            )a  on t.id=a.id
            where  a.cnt!=1
               or (a.cnt=1 and a.stage_name != '无分期' and a.stage_name is not null) ORDER BY t.SN
        )f order by f."sn";
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_STAGE_LIST_GROUP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_STAGE_LIST_GROUP" (
    info out sys_refcursor
)
    --9.获得所有分期列表	/REST/http-loadListStage.ac
    is
begin
    open info for
        SELECT  s.id as "id",
                s.stage_name as "name",
                s.state as "stage",
                s.state as "state",
                mpm.R_PROJ_ID as "projectId",
                s.sn as "sn"
        from (
            SELECT DISTINCT sps.*,a.cnt,
                            (case when completeTotal = total
                                      then '03' else
                                      (case when constrcutionTotal = 0 or constrcutionTotal is null then '01' else '02' end) end) state
            FROM SYS_PROJECT_STAGE sps
            left join (
                select
                    count(*) over(partition by PERIOD_ID) total,  --总楼栋数
                    sum(mb.IS_GET_CONSTRCUTION_PERMIT) over(partition by PERIOD_ID) constrcutionTotal, --领取施工许可证楼栋树
                    sum(mb.IS_GET_COMPLETED_PERMIT) over(partition by PERIOD_ID) completeTotal, --领取竣工备案证楼栋树
                    mb.*
                from MDM_BUILD mb where BUILD_STATE=10
            ) mb1 on sps.ID = mb1.PERIOD_ID
            INNER JOIN (
                SELECT DISTINCT
                    spg.id,
                    spg.stage_name,
                    COUNT(*) OVER(
                        PARTITION BY sp.id
                        ) AS cnt
                FROM
                    sys_project         sp
                    LEFT JOIN sys_project_stage   spg ON spg.project_id = sp.id
                UNION
                SELECT
                    '' id,
                    '' stage_name,
                    0 cnt
                FROM
                    dual
            )a on sps.id=a.id
            where  a.cnt!=1
               or (a.cnt=1 and a.stage_name != '无分期' and a.stage_name is not null) ORDER BY sps.SN
        )s left join MDM_PROJ_MAPPING mpm on mpm.PROJECT_ORIGINAL_ID = s.PROJECT_ID;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_STAGE_LIST_SALE_GROUP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_STAGE_LIST_SALE_GROUP" (
    projectId in varchar2,
    info out sys_refcursor
)
    --21.获取分期列表	/api/loadStageList
is
    vProjectId varchar(36) := FN_GET_PROJECT_ORIGINAL_ID(projectId);
begin
    open info for
        select distinct * from (
            SELECT
                sps.stage_name as "stageName",
                sp.project_code as "projectCode",
                sp.project_name as "projectName",
                to_char(pp.plan_end_date,'yyyy-MM-dd') as "planEndDate",
                to_char(pp.plan_start_date,'yyyy-MM-dd') as "planStartDate",
                sp.R_PROJ_ID as "projectId",
                sps.id as "stageId",
                sps.sn as "sn",
                (case when mb1.completeTotal = mb1.total
                          then '03' else
                          (case when mb1.constrcutionTotal = 0 or mb1.constrcutionTotal is null then '01' else '02' end) end) "state"
            FROM SYS_PROJECT sp
            LEFT JOIN SYS_PROJECT_STAGE sps on sp.id=sps.project_id
            LEFT JOIN (
                select
                    count(*) over(partition by PERIOD_ID) total,  --总楼栋数
                    sum(mb.IS_GET_CONSTRCUTION_PERMIT) over(partition by PERIOD_ID) constrcutionTotal, --领取施工许可证楼栋树
                    sum(mb.IS_GET_COMPLETED_PERMIT) over(partition by PERIOD_ID) completeTotal, --领取竣工备案证楼栋树
                    mb.*
                from MDM_BUILD mb where BUILD_STATE=10
            ) mb1
                          on sps.ID = mb1.PERIOD_ID
            LEFT JOIN (
                SELECT distinct pp.*,pn.plan_end_date,pn.plan_start_date FROM POM_PROJ_PLAN pp
                LEFT JOIN (
                    select tt2.* from (
                        select ta.*, max(id) over(PARTITION BY PROJ_PLAN_ID) maxId from (
                            SELECT  MAX(actual_end_date) over(PARTITION BY PROJ_PLAN_ID) as max_actual_end_date, tt.*
                            FROM POM_PROJ_PLAN_NODE tt where actual_end_date is not null
                        ) ta where ta.actual_end_date = max_actual_end_date
                    ) tt2 where tt2.id = maxId
                )pn on pp.id=pn.proj_plan_id where pp.plan_type='关键节点计划' and pp.approval_status='已审核'
            )  pp on sps.id=pp.proj_id
            where vProjectId is null or sp.id=vProjectId
            order by sps.sn
        )s order by s."sn";
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_UNIT_PROJECT_LIST_GROUP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_UNIT_PROJECT_LIST_GROUP" (
    unitId IN VARCHAR2,
    info out sys_refcursor
)
    -- 11.根据公司ID获取项目列表	/REST/http-loadListUnitProject.ac P_MDM_UNIT_PROJECT_LIST_GROUP
    is
begin
    --根据公司获取项目列表
    open info for
        select
            sp.project_code as "code",
            sp.unit_name as "unitName",
            sp.project_name as "name",
            UPPER(sp.unit_id) as "unitId",
            mpm.R_PROJ_ID as "id"
        from sys_project sp
        left join MDM_PROJ_MAPPING mpm on mpm.PROJECT_ORIGINAL_ID = sp.ID
        where LOWER(unit_id)=LOWER(unitId);
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_VERIFY_ATTR_AREA_USE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_VERIFY_ATTR_AREA_USE" (
    attrid     IN         VARCHAR2_LIST,--输入变量：单位面积等级id集合
    attrtype   IN         INT,--0单位面积等级,10项目合作属性,20经营属性
    message    OUT        VARCHAR2,--提示消息
    isuse      OUT        INT--0未使用，1已使用
) IS
    --验证业态是否被使用
--作者：陈丽
--日期：2019/11/17
    idStr varchar2(300);
    typeName varchar(50);
BEGIN
    BEGIN
        for i in 1..attrid.count loop
                idStr:= idStr || ',$' || attrid(i) || '#';
        end loop;
        isuse := -1;
        message := '验证通过';
        --查看是否在指标表使用---先单个后期调整
        if attrtype = 0 then
            SELECT COUNT(1) INTO isuse
            FROM mdm_obj_phase_area_level
            WHERE instr(idStr, '$'||id||'#') > 0;
            typeName := '单位面积等级';
        end if;
        if attrtype = 10 then
            SELECT COUNT(1) INTO isuse
            FROM MDM_PROJECT where instr(idStr, '$'||PROJ_COOPERATE_ID||'#') > 0;
            typeName := '项目合作属性';
        end if;
        if attrtype = 20 then
            select COUNT(1) into isuse
            from MDM_OBJ_PHASE_PT_INDEX
            where instr(idStr, '$'||OPERATE_ATTRIBUTE_ID||'#') > 0;
            typeName := '经营属性类别';
        end if;
        if isuse = -1 then
            message := '属性类别未找到';
        end if;
        IF isuse > 0 THEN
            isuse := 1;
            message := typeName || '已被使用不允许删除';
        end if;
    END;
END P_MDM_VERIFY_ATTR_AREA_USE;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_VERIFY_PERIOD_USE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_VERIFY_PERIOD_USE" (
    periodoriginalid   IN                 VARCHAR2_LIST,--输入变量：分期原始id,多个逗号分隔
message OUT VARCHAR2,--提示消息
isuse OUT INT--0未使用，1已使用
) IS--验证分期是否被使用
--作者：陈丽
--日期：2019/11/17
--分期删除验证计划（全盘、关键节点、项目主项计划）是否使用，目标货值是否使用，证照是否使用，主数据维护是否使用）
BEGIN
    BEGIN
        isuse := 0;
        FOR I IN 1 .. periodoriginalid.COUNT
            LOOP
                SELECT
                        COUNT(period_id)+isuse
                INTO isuse
                FROM
                    mdm_period_phase
                WHERE period_id = periodoriginalid(I);
            END LOOP;
        IF isuse > 0 THEN
            isuse := 1;
            message := '分期已存在指标数据不允许删除';
        END IF;
    END;
    
--分期删除验证计划（关键节点、项目主项计划）是否使用
--SELECT COUNT(id) INTO PLAN_USE FROM POM_PROJ_PLAN WHERE PROJ_ID IN (SELECT column_value FROM TABLE ( split(periodoriginalid) ))   ; 
----分期删除验证,目标货值是否使用
--SELECT COUNT(id) INTO TARGET_WORTH_Use FROM DWM_TARGET_WORTH_DTL WHERE OBJ_ID IN (SELECT column_value FROM TABLE ( split(periodoriginalid) ))   ; 
----证照是否使用
--SELECT COUNT(id) INTO PERMIT_USE FROM MDM_PERMIT WHERE PROJECT_ID IN (SELECT column_value FROM TABLE ( split(periodoriginalid) ))   ;  
----主数据维护是否使用
--SELECT COUNT(period_id) INTO PHASE_USE FROM mdm_period_phase WHERE period_id IN (SELECT column_value FROM TABLE ( split(periodoriginalid) ))   ;  

    
END p_mdm_verify_period_use;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_VERIFY_PRODUCT_TYPE_USE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_MDM_VERIFY_PRODUCT_TYPE_USE" (
    ptid   IN           VARCHAR2,--输入变量：业态id。多个逗号分隔，
    message      OUT          VARCHAR2,--提示消息
    isuse        OUT          INT--0未使用，1已使用
) IS
    -- 复制于P_MDM_VERIFY_PRODUCT_TYPE_USE
--验证业态是否被使用
--作者：韩金明
--日期：2020/03/23
    nodeName varchar(50);
    projectName varchar(50);
BEGIN
    isuse := 0;
    --查看分期是否在指标表使用
    select count(*) into isuse from MDM_OBJ_PHASE_PT_INDEX
    where PRODUCT_TYPE_ID = ptid;
    IF isuse > 0 THEN
        declare
            -- 定义游标
            cursor list is
                select OBJ_PHASE_ID, OBJ_TYPE from MDM_OBJ_PHASE_PT_INDEX
                where PRODUCT_TYPE_ID = ptid;
        begin
            -- 打开游标循环遍历数据
            for item in list loop
                    begin
                        -- 为项目关联业态
                        if item.OBJ_TYPE = 0 then
                            select PROJECT_NAME into projectName from MDM_PROJECT a
                            where a.id = item.OBJ_PHASE_ID and ROWNUM < 2;
                        end if;
                        -- 为宗地关联业态
                        if item.OBJ_TYPE = 10 then
                            select a.PROJECT_NAME into projectName  from MDM_PARCEL a
                            where a.id = item.OBJ_PHASE_ID and ROWNUM < 2;
                        end if;
                        -- 为分期关联业态
                        if item.OBJ_TYPE = 20 then
                            select a.PROJECT_NAME into projectName
                            from MDM_PROJECT a
                                     left join MDM_PERIOD_VERSION b on a.PROJECT_ORIGINAL_ID = b.PROJECT_ID
                                     left join MDM_PERIOD c on b.id = c.PERIOD_VERSION_ID
                            where c.PERIOD_ORIGINAL_ID = item.OBJ_PHASE_ID and ROWNUM < 2;
                        end if;
                        -- 为楼栋关联业态
                        if item.OBJ_TYPE = 30 then
                            select a.PROJECT_NAME into projectName
                            from MDM_PROJECT a
                                     left join MDM_PERIOD_VERSION b on a.id = b.PROJECT_ID
                                     left join MDM_PERIOD c on b.id = c.PERIOD_VERSION_ID
                                     left join MDM_BUILD d on c.PERIOD_ORIGINAL_ID = d.PERIOD_ID
                                     left join MDM_BUILD_PHASE e on d.id = e.BUILD_ID
                            where e.id = item.OBJ_PHASE_ID and ROWNUM < 2;
                        end if;
                    EXCEPTION
                        -- 未找到数据 置为空
                        when OTHERS then
                            projectName := null;
                    end;
                    -- 找到关联项目, 退出循环
                    if projectName is not null then
                        -- 获取节点名称
                        select PRODUCT_TYPE_SHORT_NAME into nodeName from MDM_BUILD_PRODUCT_TYPE
                        where id = ptid;
                        isuse := 1;
                        message := '验证失败提示：节点' || nodeName ||'已被项目' || projectName || '使用, 不允许删除。';
                        exit;
                    end if;
                end loop;
        end;
    END IF;
    if message is null then
        isuse := 0;
        message := '验证通过';
    end if;
END P_MDM_VERIFY_PRODUCT_TYPE_USE;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_APP_WORTH_MONITOR
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_APP_WORTH_MONITOR" (
    ORGID in varchar,
    info out sys_refcursor,
    dtTotalValueAll out varchar,
    dtNewTotalValue out varchar,
    errCode out number,
    errMsg out varchar
) as
    rowExists number;
    V_DT_VALUE_ALL      NUMBER(18, 2); --动态总货值
    V_DT_SYHZ_VALUE_ALL NUMBER(18, 2); --剩余货值
    V_DT_YSHZ_VALUE     NUMBER(18, 2); --已售货值
    V_DT_CBHZ_VALUE     NUMBER(18, 2); --储备货值
    V_DT_ZTHZ_VALUE     NUMBER(18, 2); --在途货值
    V_DT_YQZHZ_VALUE    NUMBER(18, 2); --已取证货值
    V_DT_KCHZ_VALUE     NUMBER(18, 2); --库存货值
    V_DT_WQGZHZ_VALUE   NUMBER(18, 2); --未取规证货值
    V_DT_GHXKZHZ_VALUE  NUMBER(18, 2); --规划许可证货值
    V_DT_SGXKZHZ_VALUE  NUMBER(18, 2); --施工许可证货值
    V_DT_YSXKZHZ_VALUE  NUMBER(18, 2); --预售许可证货值
    V_DT_JGBAHZ_VALUE   NUMBER(18, 2); --竣工备案货值
    V_DT_JZHZ_VALUE     NUMBER(18, 2); --结转货值
begin
    select count(*) into rowExists
    from (
             SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1
             UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP
         ) where id = ORGID;
    if rowExists = 0 then
        errCode := 514;
        errMsg := '未找到数据';
        return;
    end if;

    SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_DT_ALL) / 100000000, 2)
                FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
                           LEFT   JOIN SYS_PROJECT SP
                                       ON     PP.ID = SP.UNIT_ID
                           LEFT   JOIN DWM_DT_VALUE DDV
                                       ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_DT_ALL / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
    INTO   V_DT_VALUE_ALL
    FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
    WHERE  AA.ID = ORGID;

    SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_REMAIN) / 100000000, 2)
                FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
                           LEFT   JOIN SYS_PROJECT SP
                                       ON     PP.ID = SP.UNIT_ID
                           LEFT   JOIN DWM_DT_VALUE DDV
                                       ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_REMAIN / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
    INTO   V_DT_SYHZ_VALUE_ALL
    FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
    WHERE  AA.ID = ORGID;

    SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_HAVED_SALE) / 100000000, 2)
                FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
                           LEFT   JOIN SYS_PROJECT SP
                                       ON     PP.ID = SP.UNIT_ID
                           LEFT   JOIN DWM_DT_VALUE DDV
                                       ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_HAVED_SALE / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
    INTO   V_DT_YSHZ_VALUE
    FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
    WHERE  AA.ID = ORGID;

    SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_RESERVE) / 100000000, 2)
                FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
                           LEFT   JOIN SYS_PROJECT SP
                                       ON     PP.ID = SP.UNIT_ID
                           LEFT   JOIN DWM_DT_VALUE DDV
                                       ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_RESERVE / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
    INTO   V_DT_CBHZ_VALUE
    FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
    WHERE  AA.ID = ORGID;

    SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_IN_PROCESS) / 100000000, 2)
                FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
                           LEFT   JOIN SYS_PROJECT SP
                                       ON     PP.ID = SP.UNIT_ID
                           LEFT   JOIN DWM_DT_VALUE DDV
                                       ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_IN_PROCESS / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
    INTO   V_DT_ZTHZ_VALUE
    FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
    WHERE  AA.ID = ORGID;

    SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_NOT_CONSTRUCTION_PERMIT) / 100000000, 2)
                FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
                           LEFT   JOIN SYS_PROJECT SP
                                       ON     PP.ID = SP.UNIT_ID
                           LEFT   JOIN DWM_DT_VALUE DDV
                                       ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_NOT_CONSTRUCTION_PERMIT / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
    INTO   V_DT_GHXKZHZ_VALUE
    FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
    WHERE  AA.ID = ORGID;

    SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_STOCK) / 100000000, 2)
                FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
                           LEFT   JOIN SYS_PROJECT SP
                                       ON     PP.ID = SP.UNIT_ID
                           LEFT   JOIN DWM_DT_VALUE DDV
                                       ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_STOCK / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
    INTO   V_DT_KCHZ_VALUE
    FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
    WHERE  AA.ID = ORGID;

    V_DT_YQZHZ_VALUE := V_DT_YSHZ_VALUE + V_DT_KCHZ_VALUE;

    SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_NOT_PLANNING_PERMIT) / 100000000, 2)
                FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
                           LEFT   JOIN SYS_PROJECT SP
                                       ON     PP.ID = SP.UNIT_ID
                           LEFT   JOIN DWM_DT_VALUE DDV
                                       ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_NOT_PLANNING_PERMIT / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
    INTO   V_DT_WQGZHZ_VALUE
    FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
    WHERE  AA.ID = ORGID;

    SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_NOT_SALE_PERMIT) / 100000000, 2)
                FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
                           LEFT   JOIN SYS_PROJECT SP
                                       ON     PP.ID = SP.UNIT_ID
                           LEFT   JOIN DWM_DT_VALUE DDV
                                       ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_NOT_SALE_PERMIT / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
    INTO   V_DT_SGXKZHZ_VALUE
    FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
    WHERE  AA.ID = ORGID;

    SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_NOT_COMPLETION) / 100000000, 2)
                FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
                           LEFT   JOIN SYS_PROJECT SP
                                       ON     PP.ID = SP.UNIT_ID
                           LEFT   JOIN DWM_DT_VALUE DDV
                                       ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_NOT_COMPLETION / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
    INTO   V_DT_YSXKZHZ_VALUE
    FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
    WHERE  AA.ID = ORGID;

    SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_YES_COMPLETION) / 100000000, 2)
                FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
                           LEFT   JOIN SYS_PROJECT SP
                                       ON     PP.ID = SP.UNIT_ID
                           LEFT   JOIN DWM_DT_VALUE DDV
                                       ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_YES_COMPLETION / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
    INTO   V_DT_JGBAHZ_VALUE
    FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
    WHERE  AA.ID = ORGID;

    SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_YES_SETTLEMENT) / 100000000, 2)
                FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
                           LEFT   JOIN SYS_PROJECT SP
                                       ON     PP.ID = SP.UNIT_ID
                           LEFT   JOIN DWM_DT_VALUE DDV
                                       ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_YES_SETTLEMENT / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
    INTO   V_DT_JZHZ_VALUE
    FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
    WHERE  AA.ID = ORGID;
----20200809 chenl 动态货值监控中货值数据tab页，货值阶段图中结转阶段删除。
    V_DT_JZHZ_VALUE:=0;
    select RTRIM(TO_CHAR(V_DT_VALUE_ALL, 'FM999990D99'), TO_CHAR(0, 'D'))  into dtTotalValueAll from dual;
    SELECT
        TO_CHAR(NVL(
                        (
                            SELECT ROUND(SUM(DDV.TARGET_A_VALUE) / 10000, 2)
                            FROM(
                                    SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1
                                    START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
                                    LEFT JOIN SYS_PROJECT SP ON PP.ID = SP.UNIT_ID
                                    LEFT JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = SP.ID
                        ), 0
                    ) + NVL(
                        (
                            SELECT ROUND(P.TARGET_A_VALUE / 10000, 2)
                            FROM DWM_DT_VALUE P
                            WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'
                        ), 0
                    ), 'FM99999990.99') into dtNewTotalValue
    FROM(
            SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP
        ) AA
    WHERE  AA.ID = ORGID;
    open info for
        select "id", "name", RTRIM(TO_CHAR("value", 'FM999990D99')) "value"
        from(
                select GET_UUID() "id", '剩余货值' "name", V_DT_SYHZ_VALUE_ALL "value" from dual --o
                union all select GET_UUID() "id", '已售货值' "name", V_DT_YSHZ_VALUE "value" from dual
                union all select GET_UUID() "id", '储备货值(c=b0)' "name", V_DT_CBHZ_VALUE "value" from dual
                union all select GET_UUID() "id", '在途货值(d)' "name", V_DT_ZTHZ_VALUE "value" from dual
                union all select GET_UUID() "id", '已取证货值(e=e1+e2)' "name", V_DT_YQZHZ_VALUE  "value" from dual
                union all select GET_UUID() "id", '库存货值(e1)' "name", V_DT_KCHZ_VALUE "value" from dual
                union all select GET_UUID() "id", '已售货值(e2)' "name", V_DT_YSHZ_VALUE "value" from dual
                union all select GET_UUID() "id", '未取规证货值(b0)' "name", V_DT_WQGZHZ_VALUE "value" from dual
                union all select GET_UUID() "id", '规划许可证货值(b1)' "name", V_DT_GHXKZHZ_VALUE "value" from dual
                union all select GET_UUID() "id", '施工许可证货值(b2)' "name", V_DT_SGXKZHZ_VALUE "value" from dual
                union all select GET_UUID() "id", '预售许可证货值(b3)' "name", V_DT_YSXKZHZ_VALUE "value" from dual
                union all select GET_UUID() "id", '竣工备案货值(b4)' "name", V_DT_JGBAHZ_VALUE "value" from dual
--         union all select GET_UUID() "id", '结转货值' "name", V_DT_JZHZ_VALUE "value" from dual
            )
    ;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_AUTH_ORG_PROJ_TREE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_AUTH_ORG_PROJ_TREE" (
    userId         IN             VARCHAR2, --当前用户id
    stationId      IN             VARCHAR2, --当前用户岗位id
    departmentId   IN             VARCHAR2, --当前用户部门id
    companyId      IN             VARCHAR2, --当前用户公司id
    bizCode in varchar,  --权限code
    info out sys_refcursor
)
as
    needAuth number(1) := 0;
    spId varchar(36);
begin
    if bizCode is not null then
        P_AUTH_BLOCK_PROJ_COMPANY(userId,
                                  stationId,
                                  departmentId,
                                  companyId,
                                  bizCode,
                                  spId);
        needAuth := 1;
    end if;
    open info for
        with T_PROJECT as (
        select sp.ID, sp.PROJECT_NAME name, sp.COMPANY_ID parentId, sp.PROJECT_CODE code
        from SYS_PROJECT sp
    ), T_ORG as (
        select distinct sbu.ID, sbu.ORG_NAME name, sbu.PARENT_ID parentId, sbu.ORDER_HIERARCHY_CODE code
        from SYS_BUSINESS_UNIT sbu
        where IS_COMPANY = 1
        start with sbu.ID in (select parentId from T_PROJECT)
        connect by sbu.ID = prior sbu.PARENT_ID
    ) select op.ID "id", op.name "text", op.parentId "parentId", op.code "code", isProject "isProject"
        from(
              select T_PROJECT.*, 1 isProject from T_PROJECT
              union all select T_ORG.*, 0 isProject from T_ORG
          ) op left join (select ID, ORG_ID from TMP_AUTH_LIST where id = spid) tal on tal.ORG_ID = op.ID
        where (needAuth=0 or tal.ID is not null)
        order by code;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_CURRENT_DELAY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_CURRENT_DELAY" (planType in VARCHAR2
,dataScope in VARCHAR2
,searchKey in VARCHAR2
,orgId  in VARCHAR2
,currentDelay OUT sys_refcursor)
AS
BEGIN
open currentDelay for
SELECT
    p.company_name as  "orgName",
    proj_name as "projName",
    node_name as "nodeName",
    '' as "projOpenUrl",
    '' as "nodeOpenUrl",
    ROUND(TO_NUMBER(plan_end_date-sysdate)) as "delayDays"
FROM
    pom_proj_plan_node n
    left join
    pom_proj_plan p on  n.proj_plan_id=p.id where proj_name is not null;

END p_pom_current_delay;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_DELAY_NODE_CURRENT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_DELAY_NODE_CURRENT" 
(
		PLANTYPE     IN VARCHAR2
	 ,DATASCOPE    IN VARCHAR2
	 ,SEARCHKEY    IN VARCHAR2
	 ,ORGID        IN VARCHAR2
	 ,CURRENTDELAY OUT SYS_REFCURSOR
) AS --关键节点计划监控-当前延误节点
		--作者：陈丽
		--日期：2019/11/13
BEGIN

		IF DATASCOPE = 'thisMonth' THEN
				OPEN CURRENTDELAY FOR
						SELECT DISTINCT A.ORG_NAME AS "orgName",
														B2.PROJECTSTAGE_NAME AS "projName",
														B2.NODE_NAME AS "nodeName",
														'/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||
														 NVL(B2.COMPANY_ID, '003200000000000000000000000000') ||
														 '&ppid=' || B2.PPID || '&planType=关键节点计划' AS "projOpenUrl",
														'/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' ||
														 B2.PLANID || '&feedbackNodeId=' || NODE_ID ||
														 '&feedbackNodeOriginalId=' || ORIGINAL_NODE_ID ||
														 '&nodeSourcePlanType=0' AS "nodeOpenUrl",
														TRUNC(SYSDATE, 'dd') -
														 TRUNC(PLAN_END_DATE, 'dd') AS "delayDays"
						FROM   SYS_BUSINESS_UNIT A
						LEFT   JOIN (SELECT LEVEL, ORG_NAME, CONNECT_BY_ROOT ID AS ID,
																CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
																B.UNIT_ID, B.NODE_NAME, B.NODE_ID,
																B.ACTUAL_END_DATE, B.PLAN_END_DATE,
																B.PROJECTSTAGE_NAME, B.PPID, B.PID,
																'TYPE_ORG' AS CTYPE, B.ESTIMATE_END_DATE,
																B.PLANID, ORIGINAL_NODE_ID,B.COMPANY_ID
												 FROM   SYS_BUSINESS_UNIT A
												 LEFT   JOIN (SELECT B1.UNIT_ID, A.ID AS PLANID,A.COMPANY_ID,
																						A.PROJ_ID AS PPID, B1.ID AS PID,
																						A1.ORIGINAL_NODE_ID,
																				
																						 A.PROJ_NAME AS PROJECTSTAGE_NAME,
																						A1.NODE_NAME, A1.ID AS NODE_ID,
																						A1.ACTUAL_END_DATE,
																						A1.PLAN_END_DATE,
																						A1.ESTIMATE_END_DATE
																		 FROM   POM_PROJ_PLAN A
																		 INNER  JOIN POM_PROJ_PLAN_NODE A1
																		 ON     A.ID = A1.PROJ_PLAN_ID
																		 INNER  JOIN SYS_PROJECT_STAGE C1
																		 ON     A.PROJ_ID = C1.ID
																		 INNER  JOIN SYS_PROJECT B1
																		 ON     C1.PROJECT_ID = B1.ID
																		 WHERE  A.PLAN_TYPE = '关键节点计划' AND
																						A.APPROVAL_STATUS = '已审核' 	AND
																						A1.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||'-'||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else'12' end ||'-'||'26'  FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')  AND
 TO_DATE ((SELECT    A.铁建_本年||'-'||铁建_本月||'-'||'25' FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')  AND   
																						TRUNC(SYSDATE, 'dd') -TRUNC(PLAN_END_DATE, 'dd') > 0 AND
																						ACTUAL_END_DATE IS NULL) B
												 ON     A.ID = B.UNIT_ID
												 WHERE  ORG_TYPE = 0
												 START  WITH ID = '' || ORGID || ''
												 CONNECT BY PRIOR A.ID = A.PARENT_ID) B2
						ON     A.ID = B2.ID
						WHERE  NODE_NAME IS NOT NULL AND
									 ACTUAL_END_DATE IS NULL AND
									 TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 --分期
						UNION ALL
						SELECT DISTINCT '' AS "orgName",
													 A.PROJ_NAME AS "projName",
														A1.NODE_NAME AS "nodeName",
														'/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||
														 NVL(A.COMPANY_ID,
																 '003200000000000000000000000001') ||
														 '&ppid=' || a.PROJ_ID || '&planType=关键节点计划' AS "projOpenUrl",
														'/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || A.ID ||
														 '&feedbackNodeId=' || A1.ID ||
														 '&feedbackNodeOriginalId=' ||
														 A1.ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
														TRUNC(SYSDATE, 'dd') -
														 TRUNC(PLAN_END_DATE, 'dd') AS "delayDays"
						FROM   POM_PROJ_PLAN A
						INNER  JOIN POM_PROJ_PLAN_NODE A1
						ON     A.ID = A1.PROJ_PLAN_ID
						INNER  JOIN SYS_PROJECT_STAGE C1
						ON     A.PROJ_ID = C1.ID
						INNER  JOIN SYS_PROJECT B1
						ON     C1.PROJECT_ID = B1.ID
						WHERE  A.PLAN_TYPE = '关键节点计划' AND
									 A.APPROVAL_STATUS = '已审核'   AND
							A1.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||'-'||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else'12' end ||'-'||'26'  FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')  AND
 TO_DATE ((SELECT    A.铁建_本年||'-'||铁建_本月||'-'||'25' FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')   AND
									 TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 AND
									 ACTUAL_END_DATE IS NULL AND
									 C1.PROJECT_ID = '' || ORGID || ''
						ORDER  BY 6 DESC;
		
		ELSIF DATASCOPE = 'thisQuarter' THEN
				OPEN CURRENTDELAY FOR
						SELECT DISTINCT A.ORG_NAME AS "orgName",
														B2.PROJECTSTAGE_NAME AS "projName",
														B2.NODE_NAME AS "nodeName",
														'/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||
														 NVL(B2.COMPANY_ID,
																 '003200000000000000000000000002') ||
														 '&ppid=' || B2.PPID || '&planType=关键节点计划' AS "projOpenUrl",
														'/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' ||
														 B2.PLANID || '&feedbackNodeId=' || NODE_ID ||
														 '&feedbackNodeOriginalId=' || ORIGINAL_NODE_ID ||
														 '&nodeSourcePlanType=0' AS "nodeOpenUrl",
														TRUNC(SYSDATE, 'dd') -
														 TRUNC(PLAN_END_DATE, 'dd') AS "delayDays"
						FROM   SYS_BUSINESS_UNIT A
						LEFT   JOIN (SELECT LEVEL, ORG_NAME, CONNECT_BY_ROOT ID AS ID,
																CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
																B.UNIT_ID, B.NODE_NAME, B.NODE_ID,
																B.ACTUAL_END_DATE, B.PLAN_END_DATE,
																B.PROJECTSTAGE_NAME, B.PPID, B.PID,
																'TYPE_ORG' AS CTYPE, B.ESTIMATE_END_DATE,
																B.PLANID, ORIGINAL_NODE_ID,B.COMPANY_ID
												 FROM   SYS_BUSINESS_UNIT A
												 LEFT   JOIN (SELECT B1.UNIT_ID, A.ID AS PLANID,A.COMPANY_ID,
																						A.PROJ_ID AS PPID, B1.ID AS PID,
																						A1.ORIGINAL_NODE_ID,
																						
																						 A.PROJ_NAME AS PROJECTSTAGE_NAME,
																						A1.NODE_NAME, A1.ID AS NODE_ID,
																						A1.ACTUAL_END_DATE,
																						A1.PLAN_END_DATE,
																						A1.ESTIMATE_END_DATE
																		 FROM   POM_PROJ_PLAN A
																		 INNER  JOIN POM_PROJ_PLAN_NODE A1
																		 ON     A.ID = A1.PROJ_PLAN_ID
																		 INNER  JOIN SYS_PROJECT_STAGE C1
																		 ON     A.PROJ_ID = C1.ID
																		 INNER  JOIN SYS_PROJECT B1
																		 ON     C1.PROJECT_ID = B1.ID
																		 WHERE  A.PLAN_TYPE = '关键节点计划' AND
																						A.APPROVAL_STATUS = '已审核' --判断季度
																					 --判断季度
																					 
																						AND
																					A1.PLAN_END_DATE BETWEEN
																		 TO_DATE( 			(	SELECT A.开始年度||'-'||A.开始月份||'-26'   FROM V_POM_GETEXAMINE_QUARTER A),'YYYY-MM-DD')  AND
 TO_DATE((	SELECT A.结束年度||'-'||A.结束月份||'-25' FROM V_POM_GETEXAMINE_QUARTER A),'YYYY-MM-DD')
							AND
																						TRUNC(SYSDATE, 'dd') -
																						TRUNC(PLAN_END_DATE, 'dd') > 0 AND
																						ACTUAL_END_DATE IS NULL) B
												 ON     A.ID = B.UNIT_ID
												 WHERE  ORG_TYPE = 0
												 START  WITH ID = '' || ORGID || ''
												 CONNECT BY PRIOR A.ID = A.PARENT_ID) B2
						ON     A.ID = B2.ID
						WHERE  NODE_NAME IS NOT NULL AND
									 ACTUAL_END_DATE IS NULL AND
									 TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 --分期
						UNION ALL
						SELECT DISTINCT '' AS "orgName",
														 A.PROJ_NAME AS "projName",
														A1.NODE_NAME AS "nodeName",
														'/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||
														 NVL(A.COMPANY_ID,
																 '003200000000000000000000000000') ||
														 '&ppid=' || C1.ID || '&planType=关键节点计划' AS "projOpenUrl",
														'/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || A.ID ||
														 '&feedbackNodeId=' || A1.ID ||
														 '&feedbackNodeOriginalId=' ||
														 A1.ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
														TRUNC(SYSDATE, 'dd') -
														 TRUNC(PLAN_END_DATE, 'dd') AS "delayDays"
						FROM   POM_PROJ_PLAN A
						INNER  JOIN POM_PROJ_PLAN_NODE A1
						ON     A.ID = A1.PROJ_PLAN_ID
						INNER  JOIN SYS_PROJECT_STAGE C1
						ON     A.PROJ_ID = C1.ID
						INNER  JOIN SYS_PROJECT B1
						ON     C1.PROJECT_ID = B1.ID
						WHERE  A.PLAN_TYPE = '关键节点计划' AND
									 A.APPROVAL_STATUS = '已审核' --判断季度
									
									 AND
									 A1.PLAN_END_DATE  BETWEEN
																										 TO_DATE( 			(	SELECT A.开始年度||'-'||A.开始月份||'-26'   FROM V_POM_GETEXAMINE_QUARTER A),'YYYY-MM-DD')  AND
 TO_DATE((	SELECT A.结束年度||'-'||A.结束月份||'-25' FROM V_POM_GETEXAMINE_QUARTER A),'YYYY-MM-DD') AND
									 TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 AND
									 ACTUAL_END_DATE IS NULL AND
									 C1.PROJECT_ID = '' || ORGID || ''
						ORDER  BY 6 DESC;
		ELSIF DATASCOPE = 'thisYear' THEN
				OPEN CURRENTDELAY FOR
						SELECT DISTINCT A.ORG_NAME AS "orgName",
														B2.PROJECTSTAGE_NAME AS "projName",
														B2.NODE_NAME AS "nodeName",
														'/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||
														 NVL(B2.COMPANY_ID,
																 '003200000000000000000000000000') ||
														 '&ppid=' || B2.PPID || '&planType=关键节点计划' AS "projOpenUrl",
														'/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' ||
														 B2.PLANID || '&feedbackNodeId=' || NODE_ID ||
														 '&feedbackNodeOriginalId=' || ORIGINAL_NODE_ID ||
														 '&nodeSourcePlanType=0' AS "nodeOpenUrl",
														TRUNC(SYSDATE, 'dd') -
														 TRUNC(PLAN_END_DATE, 'dd') AS "delayDays"
						FROM   SYS_BUSINESS_UNIT A
						LEFT   JOIN (SELECT LEVEL, ORG_NAME, CONNECT_BY_ROOT ID AS ID,
																CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
																B.UNIT_ID, B.NODE_NAME, B.NODE_ID,
																B.ACTUAL_END_DATE, B.PLAN_END_DATE,
																B.PROJECTSTAGE_NAME, B.PPID, B.PID,
																'TYPE_ORG' AS CTYPE, B.ESTIMATE_END_DATE,
																B.PLANID, ORIGINAL_NODE_ID,B.COMPANY_ID
												 FROM   SYS_BUSINESS_UNIT A
												 LEFT   JOIN (SELECT B1.UNIT_ID, A.ID AS PLANID,A.COMPANY_ID,
																						A.PROJ_ID AS PPID, B1.ID AS PID,
																						A1.ORIGINAL_NODE_ID,
																						
																						 A.PROJ_NAME AS PROJECTSTAGE_NAME,
																						A1.NODE_NAME, A1.ID AS NODE_ID,
																						A1.ACTUAL_END_DATE,
																						A1.PLAN_END_DATE,
																						A1.ESTIMATE_END_DATE
																		 FROM   POM_PROJ_PLAN A
																		 INNER  JOIN POM_PROJ_PLAN_NODE A1
																		 ON     A.ID = A1.PROJ_PLAN_ID
																		 INNER  JOIN SYS_PROJECT_STAGE C1
																		 ON     A.PROJ_ID = C1.ID
																		 INNER  JOIN SYS_PROJECT B1
																		 ON     C1.PROJECT_ID = B1.ID
																		 WHERE  A.PLAN_TYPE = '关键节点计划' AND
																						A.APPROVAL_STATUS = '已审核' AND
																						PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||'-12'||'-26','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||'-12'||'-25','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH)  AND
																						TRUNC(SYSDATE, 'dd') -
																						TRUNC(PLAN_END_DATE, 'dd') > 0 AND
																						ACTUAL_END_DATE IS NULL) B
												 ON     A.ID = B.UNIT_ID
												 WHERE  ORG_TYPE = 0
												 START  WITH ID = '' || ORGID || ''
												 CONNECT BY PRIOR A.ID = A.PARENT_ID) B2
						ON     A.ID = B2.ID
						WHERE  NODE_NAME IS NOT NULL AND
									 ACTUAL_END_DATE IS NULL AND
									 TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 --分期
						UNION ALL
						SELECT DISTINCT '' AS "orgName",
														A.PROJ_NAME AS "projName",
														A1.NODE_NAME AS "nodeName",
														'/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||
														 NVL(A.COMPANY_ID,
																 '003200000000000000000000000000') ||
														 '&ppid=' || C1.ID || '&planType=关键节点计划' AS "projOpenUrl",
														'/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || A.ID ||
														 '&feedbackNodeId=' || A1.ID ||
														 '&feedbackNodeOriginalId=' ||
														 A1.ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
														TRUNC(SYSDATE, 'dd') -
														 TRUNC(PLAN_END_DATE, 'dd') AS "delayDays"
						FROM   POM_PROJ_PLAN A
						INNER  JOIN POM_PROJ_PLAN_NODE A1
						ON     A.ID = A1.PROJ_PLAN_ID
						INNER  JOIN SYS_PROJECT_STAGE C1
						ON     A.PROJ_ID = C1.ID
						INNER  JOIN SYS_PROJECT B1
						ON     C1.PROJECT_ID = B1.ID
						WHERE  A.PLAN_TYPE = '关键节点计划' AND
									 A.APPROVAL_STATUS = '已审核' AND
									PLAN_END_DATE  BETWEEN (SELECT TO_DATE( "铁建_本年"-1||'-12'||'-26','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||'-12'||'-25','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH)
										AND
									 TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 AND
									 ACTUAL_END_DATE IS NULL AND
									 C1.PROJECT_ID = '' || ORGID || ''
						ORDER  BY 6 DESC;
		END IF;

END P_POM_DELAY_NODE_CURRENT;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_DELAY_NODE_PREDICT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_DELAY_NODE_PREDICT" (
    planType IN VARCHAR2,
    dataScope IN VARCHAR2,
    searchKey IN VARCHAR2,
    orgId IN VARCHAR2,
    currentDelay OUT sys_refcursor 
  ) AS --关键节点计划监控-预计延误节点
--作者：陈丽
--日期：2019/11/13
BEGIN
  IF
    DATASCOPE = 'thisMonth' THEN
      open currentDelay FOR
      SELECT DISTINCT
      A.ORG_NAME AS "orgName",
      B2.PROJECTSTAGE_NAME AS "projName",
      B2.NODE_NAME AS "nodeName",
      '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' || A.id || '&ppid=' || B2.PPID || '&planType=关键节点计划' AS "projOpenUrl",
      '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || B2.PLANID || '&feedbackNodeId=' || NODE_ID || '&feedbackNodeOriginalId=' || ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
      TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) AS "delayDays" 
    FROM
      SYS_BUSINESS_UNIT a
      LEFT JOIN (
      SELECT LEVEL
        ,
        ORG_NAME,
        CONNECT_BY_ROOT ID AS ID,
        CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
        B.UNIT_ID,
        B.NODE_NAME,
        B.NODE_ID,
        B.ACTUAL_END_DATE,
        B.PLAN_END_DATE,
        B.PROJECTSTAGE_NAME,
        B.PPID,
        B.PID,
        'TYPE_ORG' AS CTYPE,
        B.ESTIMATE_END_DATE,
        PLANID,
        ORIGINAL_NODE_ID 
      FROM
        SYS_BUSINESS_UNIT A
        LEFT JOIN (
        SELECT
          B1.UNIT_ID,
          A.ID AS PLANID,
          A1.ORIGINAL_NODE_ID,
          A.PROJ_ID AS PPID,
          B1.ID AS PID,
           A.PROJ_NAME AS PROJECTSTAGE_NAME,
          A1.NODE_NAME,
          A1.ID AS NODE_ID,
          A1.ACTUAL_END_DATE,
          A1.PLAN_END_DATE,
          A1.ESTIMATE_END_DATE 
        FROM
          POM_PROJ_PLAN A
          INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
          INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
          INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
        WHERE
          A.PLAN_TYPE = '关键节点计划' 
          AND A.APPROVAL_STATUS = '已审核' 
          AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5)
          AND ACTUAL_END_DATE IS NULL 
          AND TO_CHAR( A1.PLAN_END_DATE, 'YYYY-MM-DD' ) BETWEEN (
          SELECT
            A.铁建_本年 || '-' || TO_CHAR( TO_NUMBER( 铁建_本月 ) - 1 ) || '-' || '26' 
          FROM
            V_POM_GETEXAMINE_MOTH A 
          ) 
          AND (
          SELECT
            A.铁建_本年 || '-' ||铁建_本月 || '-' || '25' 
          FROM
            V_POM_GETEXAMINE_MOTH A 
          ) 
        ) B ON A.ID = B.UNIT_ID 
      WHERE
        ORG_TYPE = 0 START WITH ID = '' || orgId || '' CONNECT BY PRIOR A.ID = A.PARENT_ID 
      ) B2 ON A.ID = B2.ID 
    WHERE
      NODE_NAME IS NOT NULL 
      AND ACTUAL_END_DATE IS NULL 
			--判断条件
    AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5 --5天内到期
				)
				
			--分期
    UNION ALL
    SELECT DISTINCT
      '' AS "orgName",
       A.PROJ_NAME AS "projName",
      A1.NODE_NAME AS "nodeName",
      '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||A.COMPANY_ID || '&ppid=' || A.PROJ_ID || '&planType=关键节点计划' AS "projOpenUrl",
      '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || A.ID || '&feedbackNodeId=' || A1.ID || '&feedbackNodeOriginalId=' || A1.ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
      TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) AS "delayDays" 
    FROM
      POM_PROJ_PLAN A
      INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
      INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
      INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
    WHERE
      A.PLAN_TYPE = '关键节点计划' 
      AND A.APPROVAL_STATUS = '已审核' 
      AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5)
      AND ACTUAL_END_DATE IS NULL 
      AND TO_CHAR( A1.PLAN_END_DATE, 'YYYY-MM-DD' ) BETWEEN (
      SELECT
        A.铁建_本年 || '-' || TO_CHAR( TO_NUMBER( 铁建_本月 ) - 1 ) || '-' || '26' 
      FROM
        V_POM_GETEXAMINE_MOTH A 
      ) 
      AND (
      SELECT
        A.铁建_本年 || '-' ||铁建_本月 || '-' || '25' 
      FROM
        V_POM_GETEXAMINE_MOTH A 
      ) 
      AND C1.PROJECT_ID = '' || orgId || '' 
    ORDER BY
      6 DESC;
    ELSIF
      DATASCOPE = 'thisQuarter' THEN
        open currentDelay FOR 
				SELECT DISTINCT
        A.ORG_NAME AS "orgName",
        B2.PROJECTSTAGE_NAME AS "projName",
        B2.NODE_NAME AS "nodeName",
        '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' || A.COMPANY_ID ||  '&ppid=' || B2.PPID || '&planType=关键节点计划' AS "projOpenUrl",
        '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || B2.PLANID || '&feedbackNodeId=' || NODE_ID || '&feedbackNodeOriginalId=' || ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
        TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) AS "delayDays" 
      FROM
        SYS_BUSINESS_UNIT a
        LEFT JOIN (
        SELECT LEVEL
          ,
          ORG_NAME,
          CONNECT_BY_ROOT ID AS ID,
          CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
          B.UNIT_ID,
          B.NODE_NAME,
          B.NODE_ID,
          B.ACTUAL_END_DATE,
          B.PLAN_END_DATE,
          B.PROJECTSTAGE_NAME,
          B.PPID,
          B.PID,
          'TYPE_ORG' AS CTYPE,
          B.ESTIMATE_END_DATE,
          PLANID,
          ORIGINAL_NODE_ID 
        FROM
          SYS_BUSINESS_UNIT A
          LEFT JOIN (
          SELECT
            B1.UNIT_ID,
            A.ID AS PLANID,
            A1.ORIGINAL_NODE_ID,
            A.PROJ_ID AS PPID,
            B1.ID AS PID,
            A.PROJ_NAME AS PROJECTSTAGE_NAME,
            A1.NODE_NAME,
            A1.ID AS NODE_ID,
            A1.ACTUAL_END_DATE,
            A1.PLAN_END_DATE,
            A1.ESTIMATE_END_DATE 
          FROM
            POM_PROJ_PLAN A
            INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
            INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
            INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
          WHERE
            A.PLAN_TYPE = '关键节点计划' 
            AND A.APPROVAL_STATUS = '已审核' 
           AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5)
            AND ACTUAL_END_DATE IS NULL 
            AND TO_CHAR( A1.PLAN_END_DATE, 'YYYY-MM-DD' ) BETWEEN (
            SELECT
              A.开始年度 || '-' || A.开始月份 || '-26' 
            FROM
              V_POM_GETEXAMINE_QUARTER A 
            ) 
            AND (
            SELECT
              A.结束年度 || '-' || A.结束月份 || '-25' 
            FROM
              V_POM_GETEXAMINE_QUARTER A 
            ) 
          ) B ON A.ID = B.UNIT_ID 
        WHERE
          ORG_TYPE = 0 START WITH ID = '' || orgId || '' CONNECT BY PRIOR A.ID = A.PARENT_ID 
        ) B2 ON A.ID = B2.ID 
      WHERE
        NODE_NAME IS NOT NULL 
        AND ACTUAL_END_DATE IS NULL 
        AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5)
      UNION ALL
      SELECT DISTINCT
        '' AS "orgName",
         A.PROJ_NAME AS "projName",
        A1.NODE_NAME AS "nodeName",
        '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' || A.COMPANY_ID|| '&ppid=' || C1.ID || '&planType=关键节点计划' AS "projOpenUrl",
        '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || A.ID || '&feedbackNodeId=' || A1.ID || '&feedbackNodeOriginalId=' || A1.ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
        TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) AS "delayDays" 
      FROM
        POM_PROJ_PLAN A
        INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
        INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
        INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
      WHERE
        A.PLAN_TYPE = '关键节点计划' 
        AND A.APPROVAL_STATUS = '已审核' 
        AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5)
        AND ACTUAL_END_DATE IS NULL 
        AND TO_CHAR( A1.PLAN_END_DATE, 'YYYY-MM-DD' ) BETWEEN (
        SELECT
          A.开始年度 || '-' || A.开始月份 || '-26' 
        FROM
          V_POM_GETEXAMINE_QUARTER A 
        ) 
        AND (
        SELECT
          A.结束年度 || '-' || A.结束月份 || '-25' 
        FROM
          V_POM_GETEXAMINE_QUARTER A 
        ) 
        AND C1.PROJECT_ID = '' || orgId || '' 
      ORDER BY
        6 DESC;
      ELSIF
        DATASCOPE = 'thisYear' THEN
          open currentDelay FOR SELECT DISTINCT
          A.ORG_NAME AS "orgName",
          B2.PROJECTSTAGE_NAME AS "projName",
          B2.NODE_NAME AS "nodeName",
          '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' || A.COMPANY_ID || '&ppid=' || B2.PPID || '&planType=关键节点计划' AS "projOpenUrl",
          '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || B2.PLANID || '&feedbackNodeId=' || NODE_ID || '&feedbackNodeOriginalId=' || ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
          TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) AS "delayDays" 
        FROM
          SYS_BUSINESS_UNIT a
          LEFT JOIN (
          SELECT LEVEL
            ,
            ORG_NAME,
            CONNECT_BY_ROOT ID AS ID,
            CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
            B.UNIT_ID,
            B.NODE_NAME,
            B.NODE_ID,
            B.ACTUAL_END_DATE,
            B.PLAN_END_DATE,
            B.PROJECTSTAGE_NAME,
            B.PPID,
            B.PID,
            'TYPE_ORG' AS CTYPE,
            B.ESTIMATE_END_DATE,
            PLANID,
            ORIGINAL_NODE_ID 
          FROM
            SYS_BUSINESS_UNIT A
            LEFT JOIN (
            SELECT
              B1.UNIT_ID,
              A.ID AS PLANID,
              A1.ORIGINAL_NODE_ID,
              A.PROJ_ID AS PPID,
              B1.ID AS PID,
              A.PROJ_NAME AS PROJECTSTAGE_NAME,
              A1.NODE_NAME,
              A1.ID AS NODE_ID,
              A1.ACTUAL_END_DATE,
              A1.PLAN_END_DATE,
              A1.ESTIMATE_END_DATE 
            FROM
              POM_PROJ_PLAN A
              INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
              INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
              INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
            WHERE
              A.PLAN_TYPE = '关键节点计划' 
              AND A.APPROVAL_STATUS = '已审核' 
              AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5) 
              AND ACTUAL_END_DATE IS NULL 
              AND TO_CHAR( A1.PLAN_END_DATE, 'YYYY' ) = TO_CHAR( SYSDATE, 'YYYY' ) 
            ) B ON A.ID = B.UNIT_ID 
          WHERE
            ORG_TYPE = 0 START WITH ID = '' || orgId || '' CONNECT BY PRIOR A.ID = A.PARENT_ID 
          ) B2 ON A.ID = B2.ID 
        WHERE
          NODE_NAME IS NOT NULL 
          AND ACTUAL_END_DATE IS NULL 
          AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5) --分期
        UNION ALL
        SELECT DISTINCT
          '' AS "orgName",
          A.PROJ_NAME AS "projName",
          A1.NODE_NAME AS "nodeName",
          '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' || A.COMPANY_ID || '&ppid=' || C1.ID || '&planType=关键节点计划' AS "projOpenUrl",
          '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || A.ID || '&feedbackNodeId=' || A1.ID || '&feedbackNodeOriginalId=' || A1.ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
          TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) AS "delayDays" 
        FROM
          POM_PROJ_PLAN A
          INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
          INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
          INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
        WHERE
          A.PLAN_TYPE = '关键节点计划' 
          AND A.APPROVAL_STATUS = '已审核' 
          AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5)
          AND ACTUAL_END_DATE IS NULL 
          AND TO_CHAR( A1.PLAN_END_DATE, 'YYYY' ) = TO_CHAR( SYSDATE, 'YYYY' ) 
          AND C1.PROJECT_ID = '' || orgId || '' 
        ORDER BY
          6 DESC;
      END IF;
END p_pom_delay_node_predict;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_DEPT_MONTHLY_PLAN
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_DEPT_MONTHLY_PLAN" (
    currentcompanyid     IN            VARCHAR2,--当前用户公司
    currentstationid     IN            VARCHAR2,---当前用户的岗位
    currentdeptid        IN            VARCHAR2,---当前用户的部门
    currentuserid        IN            VARCHAR2,---当前用户id
    companyid     IN            VARCHAR2,---当前选择的公司
    deptid     IN            VARCHAR2,---当前选择的部门
    bizcode       IN            VARCHAR2,---权限code
    listtype      IN            int,---类型
    planname      IN            VARCHAR2,
    items          OUT           SYS_REFCURSOR
) IS
    v_sql_exec         CLOB;            --sql
    v_spid             VARCHAR2(200);--数据权限验证spid
    v_sheet            VARCHAR2(200);--是否查询历史数据表
    v_where            VARCHAR2(4000):=' 1=1 ';
    v_search           VARCHAR2(4000):=' 1=1 ';  ---搜素sql
BEGIN
    --调用数据权限验证存储过程
    P_AUTH_BLOCK_PROJ_COMPANY(
            USERID => currentuserid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_SPID_ID => v_spid
        );
    --根据type来确定联查哪张表
    IF listtype =0
    then v_sheet:='POM_DEPT_MONTHLY_PLAN A LEFT JOIN POM_DEPT_MONTHLY_PLAN_NODE B ON A.ID = B.DEPT_MONTHLY_PLAN_ID ';
    elsif listtype =1
    then v_sheet:='POM_DEPT_MONTHLY_PLAN_HISTORY A LEFT JOIN POM_DEPT_MONTHLY_NODE_HISTORY B ON A.ID = B.DEPT_MONTHLY_PLAN_HISTORY_ID';
    END IF;

    --添加搜索条件
    v_search:=' 1=1 ';
    IF (companyid is not null) then
        v_search:= v_search ||' And TOTAL."companyId" = '''||companyid||'''';
    end if;
    IF (deptid is not null) then
        v_search:= v_search ||' And TOTAL."deptId" = '''||deptid||'''';
    end if;
    IF (planname is not null) then
        v_search:= v_search ||' And TOTAL."planName" LIKE ''%'||planname||'%''';
    end if;

    IF listtype = 0 THEN
        v_sql_exec:= '
        SELECT DISTINCT "id"
    ,"planName"
    ,"originalPlanId"
    ,"deptId"
    ,"deptName"
    ,"companyId"
    ,"companyName"
    ,"planVersion"
    ,"bizYear"
    ,"bizMonth"
    ,"planType"
    ,"creator"
    ,"creatorId"
    ,TO_CHAR("createTime", ''YYYY-MM-DD'') "createTime"
    ,"approveStatus"
    ,TO_CHAR("approveTime", ''YYYY-MM-DD'') "approveTime"
    ,"approverId"
    ,"approver"
    ,"remarks"
    ,"modifier"
    ,"modifierId"
    ,TO_CHAR("modifiedTime", ''YYYY-MM-DD'') "modifiedTime"
    ,"alterSubject"
    ,"alterReason"
    ,"adjustSourceId"
    ,"totalNode"
    ,"finishedNode"
    ,"notFinishedNode"
    FROM
    (
        SELECT TOTAL.*, TOTAL."notFinishedNode"+TOTAL."finishedNode" as "totalNode" FROM(
        SELECT
               PLAN.ID               AS "id"
             , PLAN.PLAN_NAME        as "planName"
             , PLAN.ORIGINAL_PLAN_ID as "originalPlanId"
             , PLAN.DEPT_ID          as "deptId"
             , PLAN.DEPT_NAME        as "deptName"
             , PLAN.COMPANY_ID       as "companyId"
             , PLAN.COMPANY_NAME     as "companyName"
             , PLAN.PLAN_VERSION     as "planVersion"
             , PLAN.BIZ_YEAR         as "bizYear"
             , PLAN.BIZ_MONTH        as "bizMonth"
             , PLAN.PLAN_TYPE        as "planType"
             , PLAN.CREATOR          as "creator"
             , PLAN.CREATOR_ID       as "creatorId"
             , PLAN.CREATED as "createTime"
             , PLAN.APPROVE_STATUS   as "approveStatus"
             , PLAN.APPROVE_TIME as "approveTime"
             , PLAN.APPROVER_ID      as "approverId"
             , PLAN.APPROVER         as "approver"
             , PLAN.REMARKS          as "remarks"
             , PLAN.MODIFIER         as "modifier"
             , PLAN.MODIFIER_ID      as "modifierId"
             , PLAN.MODIFIED as "modifiedTime"
             , PLAN.ALTER_SUBJECT    as "alterSubject"
             , PLAN.ALTER_REASON     as "alterReason"
             , PLAN.ADJUST_SOURCE_ID as "adjustSourceId"
             , (
            SELECT COUNT(INDEX_NODE.ACTUAL_END_DATE)
            FROM POM_DEPT_MONTHLY_PLAN_NODE INDEX_NODE
                     LEFT JOIN POM_DEPT_MONTHLY_PLAN INDEX_PLAN
                               ON INDEX_NODE.DEPT_MONTHLY_PLAN_ID = INDEX_PLAN.ID
            WHERE INDEX_PLAN.ID = PLAN.ID
              AND INDEX_NODE.ACTUAL_END_DATE IS NOT NULL
        )                            AS "finishedNode"
             , (
            SELECT COUNT(*)
            FROM POM_DEPT_MONTHLY_PLAN_NODE INDEX_NODE
                     LEFT JOIN POM_DEPT_MONTHLY_PLAN INDEX_PLAN
                               ON INDEX_NODE.DEPT_MONTHLY_PLAN_ID = INDEX_PLAN.ID
            WHERE INDEX_PLAN.ID = PLAN.ID
              AND INDEX_NODE.ACTUAL_END_DATE IS NULL
        )                            AS "notFinishedNode"
        FROM POM_DEPT_MONTHLY_PLAN PLAN
                 LEFT JOIN POM_DEPT_MONTHLY_PLAN_NODE NODE
                           ON PLAN.ID = NODE.DEPT_MONTHLY_PLAN_ID
                               AND PLAN.PLAN_VERSION = NODE.PLAN_VERSION
       GROUP BY PLAN.ID,
                 PLAN.PLAN_NAME,
                 PLAN.ORIGINAL_PLAN_ID,
                 PLAN.DEPT_ID,
                 PLAN.DEPT_NAME,
                 PLAN.COMPANY_ID,
                 PLAN.COMPANY_NAME,
                 PLAN.PLAN_VERSION,
                 PLAN.BIZ_YEAR,
                 PLAN.BIZ_MONTH,
                 PLAN.PLAN_TYPE,
                 PLAN.CREATOR,
                 PLAN.CREATOR_ID,
                 PLAN.CREATED,
                 PLAN.APPROVE_STATUS,
                 PLAN.APPROVE_TIME,
                 PLAN.APPROVER_ID,
                 PLAN.APPROVER,
                 PLAN.REMARKS,
                 PLAN.MODIFIER,
                 PLAN.MODIFIER_ID,
                 PLAN.MODIFIED,
                 PLAN.ALTER_SUBJECT,
                 PLAN.ALTER_REASON,
                 PLAN.ADJUST_SOURCE_ID
    )TOTAL
        LEFT JOIN (SELECT DISTINCT ORG_ID AS "orgid" FROM TMP_AUTH_LIST WHERE ID = '''||v_spid||''')  TAL on TAL."orgid"=TOTAL."deptId"
WHERE '||v_search||' AND (
        (TOTAL."approveStatus" =''已审核'' AND TOTAL."planVersion" > 1) OR (TOTAL."planVersion" =1)
    ) AND TAL."orgid" IS NOT NULL
       UNION ALL
       SELECT TOTAL.*, TOTAL."notFinishedNode"+TOTAL."finishedNode" as "totalNode"
    FROM
    (
        SELECT
               PLAN.ID               AS "id"
             , PLAN.PLAN_NAME        as "planName"
             , PLAN.ORIGINAL_PLAN_ID as "originalPlanId"
             , PLAN.DEPT_ID          as "deptId"
             , PLAN.DEPT_NAME        as "deptName"
             , PLAN.COMPANY_ID       as "companyId"
             , PLAN.COMPANY_NAME     as "companyName"
             , PLAN.PLAN_VERSION     as "planVersion"
             , PLAN.BIZ_YEAR         as "bizYear"
             , PLAN.BIZ_MONTH        as "bizMonth"
             , PLAN.PLAN_TYPE        as "planType"
             , PLAN.CREATOR          as "creator"
             , PLAN.CREATOR_ID       as "creatorId"
             , PLAN.CREATED          as "createTime"
             , PLAN.APPROVE_STATUS   as "approveStatus"
             , PLAN.APPROVE_TIME     as "approveTime"
             , PLAN.APPROVER_ID      as "approverId"
             , PLAN.APPROVER         as "approver"
             , PLAN.REMARKS          as "remarks"
             , PLAN.MODIFIER         as "modifier"
             , PLAN.MODIFIER_ID      as "modifierId"
             , PLAN.MODIFIED         as "modifiedTime"
             , PLAN.ALTER_SUBJECT    as "alterSubject"
             , PLAN.ALTER_REASON     as "alterReason"
             , PLAN.ADJUST_SOURCE_ID as "adjustSourceId"
             , (
            SELECT COUNT(INDEX_NODE.ACTUAL_END_DATE)
            FROM POM_DEPT_MONTHLY_PLAN_NODE INDEX_NODE
                     LEFT JOIN POM_DEPT_MONTHLY_PLAN INDEX_PLAN
                               ON INDEX_NODE.DEPT_MONTHLY_PLAN_ID = INDEX_PLAN.ID
            WHERE INDEX_PLAN.ID = PLAN.ID
              AND INDEX_NODE.ACTUAL_END_DATE IS NOT NULL
        )                            AS "finishedNode"
             , (
            SELECT COUNT(*)
            FROM POM_DEPT_MONTHLY_PLAN_NODE INDEX_NODE
                     LEFT JOIN POM_DEPT_MONTHLY_PLAN INDEX_PLAN
                               ON INDEX_NODE.DEPT_MONTHLY_PLAN_ID = INDEX_PLAN.ID
            WHERE INDEX_PLAN.ID = PLAN.ID
              AND INDEX_NODE.ACTUAL_END_DATE IS NULL
        )                            AS "notFinishedNode"
        FROM POM_DEPT_MONTHLY_PLAN PLAN
                 LEFT JOIN POM_DEPT_MONTHLY_PLAN_NODE NODE
                           ON PLAN.ID = NODE.DEPT_MONTHLY_PLAN_ID
                               AND PLAN.PLAN_VERSION = NODE.PLAN_VERSION
        GROUP BY PLAN.ID,
                 PLAN.PLAN_NAME,
                 PLAN.ORIGINAL_PLAN_ID,
                 PLAN.DEPT_ID,
                 PLAN.DEPT_NAME,
                 PLAN.COMPANY_ID,
                 PLAN.COMPANY_NAME,
                 PLAN.PLAN_VERSION,
                 PLAN.BIZ_YEAR,
                 PLAN.BIZ_MONTH,
                 PLAN.PLAN_TYPE,
                 PLAN.CREATOR,
                 PLAN.CREATOR_ID,
                 PLAN.CREATED,
                 PLAN.APPROVE_STATUS,
                 PLAN.APPROVE_TIME,
                 PLAN.APPROVER_ID,
                 PLAN.APPROVER,
                 PLAN.REMARKS,
                 PLAN.MODIFIER,
                 PLAN.MODIFIER_ID,
                 PLAN.MODIFIED,
                 PLAN.ALTER_SUBJECT,
                 PLAN.ALTER_REASON,
                 PLAN.ADJUST_SOURCE_ID
    )TOTAL
        LEFT JOIN (SELECT DISTINCT ORG_ID AS "orgid" FROM TMP_AUTH_LIST WHERE ID = '''||v_spid||''')  TAL on TAL."orgid"=TOTAL."companyId"
WHERE '||v_search||' AND (
        (TOTAL."approveStatus" =''已审核'' AND TOTAL."planVersion" > 1) OR (TOTAL."planVersion" =1)
    ) AND TAL."orgid" IS NOT NULL
)GROUP BY
    "id"
       ,"planName"
       ,"originalPlanId"
       ,"deptId"
       ,"deptName"
       ,"companyId"
       ,"companyName"
       ,"planVersion"
       ,"bizYear"
       ,"bizMonth"
       ,"planType"
       ,"creator"
       ,"creatorId"
       ,"createTime"
       ,"approveStatus"
       ,"approveTime"
       ,"approverId"
       ,"approver"
       ,"remarks"
       ,"modifier"
       ,"modifierId"
       ,"modifiedTime"
       ,"alterSubject"
       ,"alterReason"
       ,"adjustSourceId"
       ,"totalNode"
       ,"finishedNode"
       ,"notFinishedNode"
        ';
    ELSIF listtype = 1 THEN
        --查询历史版本的部门月度计划表
        v_sql_exec:='SELECT
    "id"
    ,"planName"
    ,"originalPlanId"
    ,"deptId"
    ,"deptName"
    ,"companyId"
    ,"companyName"
    ,"planVersion"
    ,"bizYear"
    ,"bizMonth"
    ,"planType"
    ,"creator"
    ,"creatorId"
    ,"createTime"
    ,"approveStatus"
    ,"approveTime"
    ,"approverId"
    ,"approver"
    ,"remarks"
    ,"modifier"
    ,"modifierId"
    ,"modifiedTime"
    ,"alterSubject"
    ,"alterReason"
    ,"adjustSourceId"
    ,"totalNode"
    ,"previousNode"
    FROM
    (
        SELECT * FROM(
                SELECT
                        PLAN.ID               AS "id"
                      , PLAN.PLAN_NAME        as "planName"
                      , PLAN.ORIGINAL_PLAN_ID as "originalPlanId"
                      , PLAN.DEPT_ID          as "deptId"
                      , PLAN.DEPT_NAME        as "deptName"
                      , PLAN.COMPANY_ID       as "companyId"
                      , PLAN.COMPANY_NAME     as "companyName"
                      , PLAN.PLAN_VERSION     as "planVersion"
                      , PLAN.BIZ_YEAR         as "bizYear"
                      , PLAN.BIZ_MONTH        as "bizMonth"
                      , PLAN.PLAN_TYPE        as "planType"
                      , PLAN.CREATOR          as "creator"
                      , PLAN.CREATOR_ID       as "creatorId"
                      , PLAN.CREATED          as "createTime"
                      , PLAN.APPROVE_STATUS   as "approveStatus"
                      , PLAN.APPROVE_TIME     as "approveTime"
                      , PLAN.APPROVER_ID      as "approverId"
                      , PLAN.APPROVER         as "approver"
                      , PLAN.REMARKS          as "remarks"
                      , PLAN.MODIFIER         as "modifier"
                      , PLAN.MODIFIER_ID      as "modifierId"
                      , PLAN.MODIFIED         as "modifiedTime"
                      , PLAN.ALTER_SUBJECT    as "alterSubject"
                      , PLAN.ALTER_REASON     as "alterReason"
                      , PLAN.ADJUST_SOURCE_ID as "adjustSourceId"
                      , COUNT(NODE.ID)        AS "totalNode"
                      , (
            SELECT
                COUNT( INDEX_NODE.id )
            FROM
                POM_DEPT_MONTHLY_NODE_HISTORY INDEX_NODE
                    LEFT JOIN POM_DEPT_MONTHLY_PLAN_HISTORY INDEX_PLAN ON INDEX_PLAN.ID = INDEX_NODE.DEPT_MONTHLY_PLAN_HISTORY_ID
            WHERE
                    INDEX_PLAN.PLAN_VERSION = (
                    SELECT
                            PLAN_VERSION - 1
                    FROM
                        POM_DEPT_MONTHLY_PLAN_HISTORY
                    WHERE
                            ORIGINAL_PLAN_ID = INDEX_PLAN.ORIGINAL_PLAN_ID
                )
        ) AS "previousNode"
        FROM POM_DEPT_MONTHLY_PLAN_HISTORY PLAN
                 LEFT JOIN POM_DEPT_MONTHLY_NODE_HISTORY NODE
                           ON PLAN.ID = NODE.DEPT_MONTHLY_PLAN_HISTORY_ID
                               AND PLAN.PLAN_VERSION = NODE.PLAN_VERSION
        GROUP BY PLAN.ID,
                 PLAN.PLAN_NAME,
                 PLAN.ORIGINAL_PLAN_ID,
                 PLAN.DEPT_ID,
                 PLAN.DEPT_NAME,
                 PLAN.COMPANY_ID,
                 PLAN.COMPANY_NAME,
                 PLAN.PLAN_VERSION,
                 PLAN.BIZ_YEAR,
                 PLAN.BIZ_MONTH,
                 PLAN.PLAN_TYPE,
                 PLAN.CREATOR,
                 PLAN.CREATOR_ID,
                 PLAN.CREATED,
                 PLAN.APPROVE_STATUS,
                 PLAN.APPROVE_TIME,
                 PLAN.APPROVER_ID,
                 PLAN.APPROVER,
                 PLAN.REMARKS,
                 PLAN.MODIFIER,
                 PLAN.MODIFIER_ID,
                 PLAN.MODIFIED,
                 PLAN.ALTER_SUBJECT,
                 PLAN.ALTER_REASON,
                 PLAN.ADJUST_SOURCE_ID
    )TOTAL
        LEFT JOIN (SELECT DISTINCT ORG_ID AS "orgid" FROM TMP_AUTH_LIST WHERE ID = '''||v_spid||''')  TAL on TAL."orgid"=TOTAL."deptId"
WHERE '||v_search||' AND TAL."orgid" IS NOT NULL
    UNION ALL
    SELECT *
    FROM
    (
        SELECT DISTINCT
                        PLAN.ID               AS "id"
                      , PLAN.PLAN_NAME        as "planName"
                      , PLAN.ORIGINAL_PLAN_ID as "originalPlanId"
                      , PLAN.DEPT_ID          as "deptId"
                      , PLAN.DEPT_NAME        as "deptName"
                      , PLAN.COMPANY_ID       as "companyId"
                      , PLAN.COMPANY_NAME     as "companyName"
                      , PLAN.PLAN_VERSION     as "planVersion"
                      , PLAN.BIZ_YEAR         as "bizYear"
                      , PLAN.BIZ_MONTH        as "bizMonth"
                      , PLAN.PLAN_TYPE        as "planType"
                      , PLAN.CREATOR          as "creator"
                      , PLAN.CREATOR_ID       as "creatorId"
                      , PLAN.CREATED          as "createTime"
                      , PLAN.APPROVE_STATUS   as "approveStatus"
                      , PLAN.APPROVE_TIME     as "approveTime"
                      , PLAN.APPROVER_ID      as "approverId"
                      , PLAN.APPROVER         as "approver"
                      , PLAN.REMARKS          as "remarks"
                      , PLAN.MODIFIER         as "modifier"
                      , PLAN.MODIFIER_ID      as "modifierId"
                      , PLAN.MODIFIED         as "modifiedTime"
                      , PLAN.ALTER_SUBJECT    as "alterSubject"
                      , PLAN.ALTER_REASON     as "alterReason"
                      , PLAN.ADJUST_SOURCE_ID as "adjustSourceId"
                      , COUNT(NODE.ID)        AS "totalNode"
                      , (
            SELECT
                COUNT( INDEX_NODE.id )
            FROM
                POM_DEPT_MONTHLY_NODE_HISTORY INDEX_NODE
                    LEFT JOIN POM_DEPT_MONTHLY_PLAN_HISTORY INDEX_PLAN ON INDEX_PLAN.ID = INDEX_NODE.DEPT_MONTHLY_PLAN_HISTORY_ID
            WHERE
                    INDEX_PLAN.PLAN_VERSION = (
                    SELECT
                            PLAN_VERSION - 1
                    FROM
                        POM_DEPT_MONTHLY_PLAN_HISTORY
                    WHERE
                            ORIGINAL_PLAN_ID = INDEX_PLAN.ORIGINAL_PLAN_ID
                )
        ) AS "previousNode"
        FROM POM_DEPT_MONTHLY_PLAN_HISTORY PLAN
                 LEFT JOIN POM_DEPT_MONTHLY_NODE_HISTORY NODE
                           ON PLAN.ID = NODE.DEPT_MONTHLY_PLAN_HISTORY_ID
                               AND PLAN.PLAN_VERSION = NODE.PLAN_VERSION
        GROUP BY PLAN.ID,
                 PLAN.PLAN_NAME,
                 PLAN.ORIGINAL_PLAN_ID,
                 PLAN.DEPT_ID,
                 PLAN.DEPT_NAME,
                 PLAN.COMPANY_ID,
                 PLAN.COMPANY_NAME,
                 PLAN.PLAN_VERSION,
                 PLAN.BIZ_YEAR,
                 PLAN.BIZ_MONTH,
                 PLAN.PLAN_TYPE,
                 PLAN.CREATOR,
                 PLAN.CREATOR_ID,
                 PLAN.CREATED,
                 PLAN.APPROVE_STATUS,
                 PLAN.APPROVE_TIME,
                 PLAN.APPROVER_ID,
                 PLAN.APPROVER,
                 PLAN.REMARKS,
                 PLAN.MODIFIER,
                 PLAN.MODIFIER_ID,
                 PLAN.MODIFIED,
                 PLAN.ALTER_SUBJECT,
                 PLAN.ALTER_REASON,
                 PLAN.ADJUST_SOURCE_ID
    )TOTAL
        LEFT JOIN (SELECT DISTINCT ORG_ID AS "orgid" FROM TMP_AUTH_LIST WHERE ID = '''||v_spid||''')  TAL on TAL."orgid"=TOTAL."companyId"
WHERE '||v_search||' AND TAL."orgid" IS NOT NULL
)
GROUP BY
    "id"
       ,"planName"
       ,"originalPlanId"
       ,"deptId"
       ,"deptName"
       ,"companyId"
       ,"companyName"
       ,"planVersion"
       ,"bizYear"
       ,"bizMonth"
       ,"planType"
       ,"creator"
       ,"creatorId"
       ,"createTime"
       ,"approveStatus"
       ,"approveTime"
       ,"approverId"
       ,"approver"
       ,"remarks"
       ,"modifier"
       ,"modifierId"
       ,"modifiedTime"
       ,"alterSubject"
       ,"alterReason"
       ,"adjustSourceId"
       ,"totalNode"
       ,"previousNode"
    ';
    END IF;
    sys.dbms_output.put_line(v_sql_exec);
    OPEN items FOR v_sql_exec;
END p_pom_dept_monthly_plan;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_DEPT_PLAN_GET_PROJ_NODE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_DEPT_PLAN_GET_PROJ_NODE" (
    I_DEPT_ID              IN VARCHAR2 := NULL,
    I_DEPT_MONTHLY_PLAN_ID IN VARCHAR2 := NULL, --传入参数_部门月度计划ID
    I_BIZ_YEAR             IN NUMBER := NULL, --传入参数 _年份
    I_BIZ_MONTH            IN NUMBER := NULL, --传入参数_月份
    O_FLAG                 OUT NUMBER --更新成功的条数
) AS
    V_CON          NUMBER(8, 0) := 0;
    V_PLAN_VERSION NUMBER(8, 0);
    V_BIZ_MONTH    NVARCHAR2(2);
    V_DEPT_NAME    NVARCHAR2(100);
    MAX_SIZE       NUMBER(3, 0) := 0;
BEGIN
    IF I_BIZ_MONTH < 10 THEN
        V_BIZ_MONTH := '0'||I_BIZ_MONTH;
    elsif I_BIZ_MONTH >= 10 THEN
        V_BIZ_MONTH := ''||I_BIZ_MONTH;
    end if;
    BEGIN
        SELECT COUNT(1), NVL(A.PLAN_VERSION, ''),  NVL(A.DEPT_NAME, '')
        INTO   V_CON, V_PLAN_VERSION, V_DEPT_NAME
        FROM   POM_DEPT_MONTHLY_PLAN A, POM_DEPT_MONTHLY_PLAN_NODE B
        WHERE  A.ID = B.DEPT_MONTHLY_PLAN_ID AND
                B.NODE_SOURCE = '项目主项计划' AND
          --A.APPROVE_STATUS = '已审核' AND
                B.DUTY_DEPT_ID = I_DEPT_ID AND
                A.BIZ_YEAR = TO_CHAR(I_BIZ_YEAR) AND
                A.BIZ_MONTH = TO_CHAR(I_BIZ_MONTH)
        GROUP  BY A.PLAN_VERSION, A.DEPT_NAME;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            O_FLAG := 0;
    END;

    IF V_CON <> 0 THEN
        DELETE FROM POM_DEPT_MONTHLY_PLAN_NODE A
        WHERE EXISTS (
                      SELECT 1
                      FROM POM_DEPT_MONTHLY_PLAN B
                               LEFT JOIN POM_DEPT_MONTHLY_PLAN_NODE C ON B.ID=C.DEPT_MONTHLY_PLAN_ID
                      WHERE  A.DEPT_MONTHLY_PLAN_ID = B.ID AND C.DUTY_DEPT_ID = I_DEPT_ID AND
                              B.BIZ_MONTH = V_BIZ_MONTH AND B.BIZ_YEAR = I_BIZ_YEAR AND
                              B.ID = I_DEPT_MONTHLY_PLAN_ID  and A.SOURCE_PLAN_ID is not null
                  );
    END IF;
    --添加引入节点
    INSERT INTO POM_DEPT_MONTHLY_PLAN_NODE(
        ID, ORIGINAL_NODE_ID, DEPT_MONTHLY_PLAN_ID, PLAN_VERSION,
        NODE_NAME, NODE_CODE, NODE_SOURCE, NODE_TYPE, STAND_SCORE,
        PLAN_START_DATE, PLAN_END_DATE, ACTUAL_START_DATE, ACTUAL_END_DATE,
        ESTIMATE_START_DATE, ESTIMATE_END_DATE, RELATED_DEPT_ID,
        RELATED_DEPT, DUTY_DEPT_ID, DUTY_DEPT_NAME, SOURCE_PLAN_ID,
        SOUCE_NODE_ID, SOUCE_NODE_LEVEL, SOUCE_NODE_SCORE,
        COMPLETION_RESULTS_REMARK, COMPLETION_STANDARD, REMARKS
    ) SELECT
        NODE_ID
           ,NODE_ID
           ,DEPT_MONTHLY_PLAN_ID
           ,PLAN_VERSION
           ,NODE_NAME
           ,TO_CHAR(ROWNUM, 'FM99900')
           ,NODE_SOURCE
           ,'项目主项计划'
           ,STANDARD_SCORE
           ,PLAN_START_DATE
           ,PLAN_END_DATE
           ,ACTUAL_START_DATE
           ,ACTUAL_END_DATE
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,DUTY_DEPT_ID
           ,DUTY_DEPARTMENT
           ,SOURCE_PLAN_ID
           ,SOURCE_NODE_ID
           ,NODE_LEVEL
           ,STANDARD_SCORE
           ,COMPLETION_RESULTS_REMARK
           ,COMPLETION_STANDARD
           ,NULL
    FROM (
             SELECT
                 GET_UUID() AS NODE_ID
                  ,I_DEPT_MONTHLY_PLAN_ID AS DEPT_MONTHLY_PLAN_ID
                  ,A.plan_version
                  ,B.NODE_NAME
                  ,'项目主项计划' AS NODE_SOURCE
                  ,B.PLAN_START_DATE
                  ,B.PLAN_END_DATE
                  ,B.ACTUAL_START_DATE
                  ,B.ACTUAL_END_DATE
                  ,B.STANDARD_SCORE
                  ,I_DEPT_ID AS DUTY_DEPT_ID
                  ,b.duty_department
                  ,A.ID AS SOURCE_PLAN_ID
                  ,B.ID AS SOURCE_NODE_ID
                  ,B.NODE_LEVEL
                  ,B.COMPLETION_RESULTS_REMARK
                  ,B.COMPLETION_STANDARD
             FROM POM_PROJ_PLAN A
                      LEFT JOIN POM_PROJ_PLAN_NODE B ON A.ID = B.PROJ_PLAN_ID
             WHERE  A.APPROVAL_STATUS = '已审核'
               AND B.DUTY_DEPARTMENT_ID = I_DEPT_ID
               AND TO_CHAR(B.PLAN_END_DATE, 'MM') = V_BIZ_MONTH
               AND TO_CHAR(B.PLAN_END_DATE, 'YYYY') = I_BIZ_YEAR
               AND B.IS_DISABLE = 0
               AND B.IS_DELETE = 0
         );
    O_FLAG := SQL%ROWCOUNT;
    -- MAX_CODE为空时 赋值为0
    MAX_SIZE := O_FLAG;
    -- 更新NodeCode
    update POM_DEPT_MONTHLY_PLAN_NODE pn1 set NODE_CODE = (
        select TO_CHAR(rownum+MAX_SIZE, 'FM99900') NODE_CODE from POM_DEPT_MONTHLY_PLAN_NODE pn2
        where pn2.DEPT_MONTHLY_PLAN_ID = I_DEPT_MONTHLY_PLAN_ID
          and pn2.ID = pn1.ID
    )
    where pn1.ID = I_DEPT_MONTHLY_PLAN_ID and SOURCE_PLAN_ID is null;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_DM_PERFORM_DYNAMIC
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_DM_PERFORM_DYNAMIC" 
(
    IN_ORG_ID    IN VARCHAR2
,DATASCOPE    IN VARCHAR2
,IN_PLAN_TYPE IN VARCHAR2
,IN_PROJID  IN VARCHAR2
,PAGEINDEX    IN INT
,PAGESIZES    IN INT
,P_PAGETYPE  IN INT
,ITEMS        OUT SYS_REFCURSOR
,TOTAL        OUT INT
) AS
    --传入的参数有三个，1：IN_ORG_ID（公司ID）
    --，2：DATASCOPE（统计期间，3个值“THIS_MONTH、THIS_QUARTER、THIS_YEAR"）
    --，3：PLAN_TYPE（计划类型，预留，估计后面会用的到）
    --，4：P_PAGETYPE（页面类型：1：已延误 2：已完成 3：应完成）//alterby 李小聪
    --关键节点计划-执行动态查询（wangck需要）
    --作者：陈丽
    --日期：2019/12/07

    CURSOR CUR_COMPANY_LIST(V_ORG_ID SYS_BUSINESS_UNIT.ID%TYPE) IS
        SELECT P.ID, P.PARENT_ID, P.ORG_NAME FROM SYS_BUSINESS_UNIT P WHERE P.IS_COMPANY = 1 START WITH P.ID = V_ORG_ID CONNECT BY PRIOR P.ID = P.PARENT_ID;
    V_SQL_TOTAL     CLOB := ' ';
    V_SQL           CLOB := ' ';
    V_SQL_DATASCOPE CLOB := ' ';
    V_COMPANY_LIST  CLOB := ' ';
BEGIN

    dbms_output.put_line('开始');
    --月度
--已延误
    IF DATASCOPE = 'thisMonth' AND P_PAGETYPE=1  THEN
        V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL   AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';
        --月度
--已完成
    ELSIF DATASCOPE = 'thisMonth' AND P_PAGETYPE=2  THEN
        V_SQL_DATASCOPE := ' AND  PN.ACTUAL_END_DATE IS  NOT NULL  AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';

        --月度
--应完成

    ELSIF DATASCOPE = 'thisMonth' AND P_PAGETYPE=3  THEN
        V_SQL_DATASCOPE := 'AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';

        --季度
--已延误
    ELSIF DATASCOPE = 'thisQuarter' AND P_PAGETYPE=1 THEN
        V_SQL_DATASCOPE := ' AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL    AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((	SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((	SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
        --季度
--已完成
    ELSIF DATASCOPE = 'thisQuarter' AND P_PAGETYPE=2 THEN
        V_SQL_DATASCOPE := 'AND  PN.ACTUAL_END_DATE IS  NOT NULL AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((	SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((	SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
        --季度
--季度应完成
    ELSIF DATASCOPE = 'thisQuarter' AND P_PAGETYPE=3 THEN
        V_SQL_DATASCOPE := '  AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((	SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((	SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
        --年度
--已延误
    ELSIF DATASCOPE = 'thisYear'AND P_PAGETYPE=1 THEN
        V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL
			 AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) ';
        --年度
--已完成
    ELSIF DATASCOPE = 'thisYear'AND P_PAGETYPE=2 THEN
        V_SQL_DATASCOPE := 'AND  PN.ACTUAL_END_DATE IS  NOT NULL
				 AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH)  ';
        --年度
--应完成
    ELSIF DATASCOPE = 'thisYear' AND P_PAGETYPE=3 THEN
        V_SQL_DATASCOPE := ' AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) ';
        --全部，没有时间限
--已延误
    ELSIF DATASCOPE = 'thisAll' AND P_PAGETYPE=1 THEN
        V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL ';
--计划所有节点
    ELSIF DATASCOPE = 'thisAll' AND P_PAGETYPE=2 THEN
        V_SQL_DATASCOPE := ' AND   1=1 ';



    END IF;

    FOR ITEM_COMPANY_LIST IN CUR_COMPANY_LIST(IN_ORG_ID)
        LOOP
            V_COMPANY_LIST := V_COMPANY_LIST || '''' || ITEM_COMPANY_LIST.ID || '''' || ',';
        END LOOP;
    V_COMPANY_LIST := '('  || SUBSTR(V_COMPANY_LIST, 1, LENGTH(V_COMPANY_LIST) - 1) || ')';
    IF  V_COMPANY_LIST='()'
    THEN  V_COMPANY_LIST := '('''||IN_ORG_ID||''')';
    END  IF;
    V_SQL := V_SQL ||
             'SELECT PP.COMPANY_ID, PP.COMPANY_NAME AS COMPANY_NAME,PP.PROJ_name AS PROJ_NAME,PP.PLAN_NAME AS PLAN_NAME, PN.ID,PN.PROJ_PLAN_ID,PN.ORIGINAL_NODE_ID,CASE WHEN PN.IS_DISABLE = 0 THEN	PN.NODE_NAME ELSE	''【禁用】'' || PN.NODE_NAME END AS NODE_NAME, PN.NODE_CODE, PN.NODE_LEVEL, PN.PROJ_STAGE, PN.MAIN_RESPONSIBILITY, PN.DUTY_DEPARTMENT, TO_CHAR(PN.PLAN_START_DATE, ''yyyy-MM-dd'') AS PLAN_START_DATE, TO_CHAR(PN.PLAN_END_DATE, ''yyyy-MM-dd'') AS PLAN_END_DATE, PN.IS_DISABLE, PN.COMPLETION_STANDARD, PN.COMPLETION_RESULTS_REMARK, TO_CHAR(PN.ACTUAL_END_DATE, ''yyyy-MM-dd'') AS ACTUAL_END_DATE
, case
--未到期不亮灯
WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
--到期当天内完成反馈
when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
--到期1-5天内完成反馈
when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
--到期未反馈黄灯
WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE)) >0
THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
--到期超过5天未反馈红灯
WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(PLAN_END_DATE)) >5) THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END
AS PLAN_STATUS,PN.ESTIMATE_END_DATE,	nps.CHARGE_PERSON
FROM  pom_proj_plan_node pn
LEFT JOIN pom_proj_plan pp ON pn.proj_plan_id = pp.id
LEFT JOIN  SYS_PROJECT_STAGE ps on  ps.id=pp.proj_id
LEFT JOIN SYS_PROJECT pj on  ps.PROJECT_ID =pj.id
LEFT JOIN(	SELECT  NODE_ID, listagg(CHARGE_PERSON,'','') WITHIN GROUP (ORDER BY CHARGE_PERSON )  as CHARGE_PERSON
FROM POM_NODE_CHARGE_PERSON
GROUP BY NODE_ID) nps on  nps.NODE_ID=pn.id
WHERE  PP.PLAN_TYPE = ''部门月度计划''  AND PP.APPROVAL_STATUS = ''已审核'' AND 1=1
and  ((pp.proj_id ='''||IN_PROJID||''' or pn.proj_plan_id='''||IN_PROJID||'''  OR  pj.id='''||IN_PROJID||''' )
	OR PP.COMPANY_ID IN ' || V_COMPANY_LIST ||' ) '|| V_SQL_DATASCOPE || '  ORDER BY PN.PROJ_PLAN_ID,  PN.NODE_CODE';

    V_SQL_TOTAL := V_SQL_TOTAL|| 				 'SELECT  TO_CHAR(COUNT(pn.ID))
	FROM  pom_proj_plan_node pn
LEFT JOIN pom_proj_plan pp ON pn.proj_plan_id = pp.id
LEFT JOIN  SYS_PROJECT_STAGE ps on  ps.id=pp.proj_id
LEFT JOIN SYS_PROJECT pj on  ps.PROJECT_ID =pj.id
LEFT JOIN(	SELECT  NODE_ID, listagg(CHARGE_PERSON,'','') WITHIN GROUP (ORDER BY CHARGE_PERSON )  as CHARGE_PERSON
	FROM POM_NODE_CHARGE_PERSON
	GROUP BY NODE_ID) nps on  nps.NODE_ID=pn.id
	WHERE  PP.PLAN_TYPE = ''部门月度计划''  AND PP.APPROVAL_STATUS = ''已审核'' AND 1=1
	and  ((pp.proj_id ='''||IN_PROJID||''' or pn.proj_plan_id='''||IN_PROJID||'''  OR  pj.id='''||IN_PROJID||''' )
	OR PP.COMPANY_ID IN ' || V_COMPANY_LIST ||' ) '|| V_SQL_DATASCOPE || '  ORDER BY PN.PROJ_PLAN_ID,  PN.NODE_CODE';

    execute immediate V_SQL_TOTAL into TOTAL;
    OPEN ITEMS FOR V_SQL;
END P_POM_DM_PERFORM_DYNAMIC;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_EXAMELATE_NODE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_EXAMELATE_NODE" 
(
    examelateNodeId in varchar2,
    bizId in varchar2
)
IS
    v_node_sql clob;
    v_node_exist clob;
    isProjectOpenNode INT;
    isOnTime number;
    node_self_id varchar2(36);
    node_plan_id varchar2(36);
    node_plan_type varchar2(20);
    node_self_type varchar2(20);
    node_self_plan_end_date varchar2(50);
    node_expression_exist number;
    node_expression varchar2(2000);
    user_expression varchar2(2000);
    node_is_exist number;
    expression_is_default number;
BEGIN
    node_expression := NULL;
    --查询节点是否为项目开盘节点
    select
    case when standard_node_id = bizId then
        1
    else 0 end,
    plan.id,
    plan.plan_type,
    node.node_level,
    to_char(node.plan_end_date, 'YYYY-MM-DD'),
    node.id
    INTO isProjectOpenNode, node_plan_id, node_plan_type, node_self_type, node_self_plan_end_date, node_self_id
    from pom_proj_plan_node node
    left join pom_proj_plan plan on node.proj_plan_id = plan.id
    left join pom_node_feedback fb on node.id = fb.feedback_node_id
    where fb.id = examelateNodeId;

    --判断是否为项目开盘节点
    IF isProjectOpenNode = 1 THEN
        --是项目开盘节点，则判断是否按时完成
         EXECUTE IMMEDIATE 'select
            case when to_char(plan_end_date, ''YYYY-MM-DD'') <= to_char((sysdate, ''YYYY-MM-DD'') then
                1
            else 0 end
            from pom_proj_plan_node where id = '''||node_self_id||'''' INTO isOnTime;
    ELSE
        --不是项目开盘计划
        isOnTime := 0;
    END IF;

    --项目开盘节点计划且按时完成
    IF isProjectOpenNode = 1 AND isOnTime = 1 THEN
        --找出所有计划完成时间在项目开盘节点之前的节点ID
       EXECUTE IMMEDIATE 'SELECT WM_CONCAT(ID) FROM POM_PROJ_PLAN_NODE  WHERE PROJ_PLAN_ID = (
                            SELECT PLAN.ID FROM POM_PROJ_PLAN_NODE NODE LEFT JOIN POM_PROJ_PLAN PLAN ON NODE.PROJ_PLAN_ID = PLAN.ID
                            WHERE PLAN.APPROVAL_STATUS = ''已审核'' AND
                            NODE.STANDARD_NODE_ID = '''||bizId||''' AND
                            PLAN.ID = '''||node_plan_id||''' AND
                            PLAN_END_DATE IS NOT NULL AND
                            TO_CHAR(PLAN_END_DATE ,''YYYY-MM-DD'') <= '''||node_self_plan_end_date||''')'
       INTO v_node_exist;
       --修改所有在计划考核表中已经存在的节点的最新考核分数
       EXECUTE IMMEDIATE 'UPDATE POM_NODE_EXAMINATION SET NEW_EXAMINATION_SCORE = STANDARD_SCORE WHERE NODE_ID IN (
            SELECT REGEXP_SUBSTR ('''||v_node_exist||''', ''[^,]+'', 1,rownum) from dual connect by rownum<=LENGTH ('''||v_node_exist||''') - LENGTH (regexp_replace('''||v_node_exist||''', '','', ''''))+1
       )';

       --插入计划考核表原本不存在的项目开盘节点数据
       EXECUTE IMMEDIATE 'INSERT INTO POM_NODE_EXAMINATION(
                            ID,
                            NODE_ID,
                            ORIGINAL_NODE_ID,
                            NODE_LEVEL,
                            STANDARD_SCORE,
                            DUTY_DEPT_ID,
                            DUTY_DEPT,
                            COMPLETE_FEEDBACK_ID,
                            ORIGINAL_PLAN_ID,
                            PLAN_ID,
                            PLAN_TYPE,
                            EXAMINATION_SCORE,
                            NEW_EXAMINATION_SCORE,
                            PLAN_START_DATE,
                            ACTUAL_START_DATE,
                            ACTUAL_END_DATE,
                            EXAMINATION_DATE,
                            COMPLETE_FEEDBACK_APPROVE_TIME,
                            CHARGE_PERSON_ID,
                            CHARGE_PERSON,
                            NODE_NAME
                        )
                        SELECT
                            GET_UUID(),
                            NODE.ID,
                            NODE.ORIGINAL_NODE_ID,
                            NODE.NODE_LEVEL,
                            NODE.STANDARD_SCORE,
                            NODE.DUTY_DEPARTMENT_ID,
                            NODE.DUTY_DEPARTMENT,
                            FB.ID,
                            NODE.ORIGINAL_PLAN_ID,
                            PLAN.ID,
                            PLAN.PLAN_TYPE,
                            NODE.STANDARD_SCORE,
                            NODE.STANDARD_SCORE,
                            NODE.PLAN_START_DATE,
                            NODE.ACTUAL_START_DATE,
                            NODE.ACTUAL_END_DATE,
                            SYSDATE,
                            FB.APPROVAL_TIME,
                            (SELECT WM_CONCAT(CHARGE_PERSON_ID) FROM POM_NODE_CHARGE_PERSON WHERE NODE_ID = '''||node_self_id||'''),
                            (SELECT WM_CONCAT(CHARGE_PERSON) FROM POM_NODE_CHARGE_PERSON WHERE NODE_ID = '''||node_self_id||'''),
                            NODE.NODE_NAME
                        FROM POM_PROJ_PLAN_NODE NODE
                                 LEFT JOIN POM_PROJ_PLAN PLAN ON NODE.PROJ_PLAN_ID = PLAN.ID
                                 LEFT JOIN POM_NODE_FEEDBACK FB ON NODE.ID = FB.FEEDBACK_NODE_ID
                        WHERE NODE.ID  = '''||node_self_id||''' 
                          AND FB.FEEDBACK_TYPE = ''CARRY_OUT'' 
                          AND IS_DISABLED = 0
                          AND IS_DELETE = 0';
    ELSIF isProjectOpenNode = 0 OR (isProjectOpenNode = 1 AND isOnTime = 0) THEN
        --非项目开盘节点 / 未按时完成的项目开盘节点，则向上查询对应计划所对应公司的计划的节点的考核规则(非未启用、默认)
        EXECUTE IMMEDIATE 'SELECT COUNT(*) FROM POM_RULE_EXAMINATION WHERE APPLY_COMPANY_ID = (
                                SELECT PLAN.COMPANY_ID FROM POM_PROJ_PLAN_NODE NODE LEFT JOIN
                                    POM_PROJ_PLAN PLAN ON NODE.PROJ_PLAN_ID = PLAN.ID
                                    WHERE NODE.ID = '''||node_self_id||'''
                            )  AND IS_ACTIVE = 1' INTO node_expression_exist;
        IF node_expression_exist = 0 THEN
            --先查询是否拥有非未启用、默认的规则
            EXECUTE IMMEDIATE 'SELECT COUNT(*) FROM POM_RULE_EXAMINATION RULE
                                LEFT JOIN POM_RULE_SET_PLAN_TYPE PRULE ON RULE.ID = PRULE.RULE_ID
                                WHERE PRULE.PLAN_TYPE = '''||node_plan_type||''' 
                                      AND RULE.NODE_TYPE = '''||node_self_type||'''
                                      AND RULE.IS_DEFAULT = 1
                                      AND RULE.IS_ACTIVE = 1
                                      ' INTO expression_is_default;
            IF expression_is_default != 0 THEN
                --若未查到对应的公司考核规则，则按照默认的计划及节点规则进行考核分值计算
                EXECUTE IMMEDIATE 'SELECT RULE.EXPRESSION FROM POM_RULE_EXAMINATION RULE
                                    LEFT JOIN POM_RULE_SET_PLAN_TYPE PRULE ON RULE.ID = PRULE.RULE_ID
                                    WHERE PRULE.PLAN_TYPE = '''||node_plan_type||''' 
                                          AND RULE.NODE_TYPE = '''||node_self_type||'''
                                          AND RULE.IS_DEFAULT = 1
                                          AND RULE.IS_ACTIVE = 1
                                          ' INTO node_expression;
            END IF;
        ELSE
            EXECUTE IMMEDIATE 'SELECT EXPRESSION FROM POM_RULE_EXAMINATION WHERE APPLY_COMPANY_ID = (
                                SELECT PLAN.COMPANY_ID FROM POM_PROJ_PLAN_NODE NODE LEFT JOIN
                                    POM_PROJ_PLAN PLAN ON NODE.PROJ_PLAN_ID = PLAN.ID
                                    WHERE NODE.ID = '''||node_self_id||'''
                            ) AND IS_ACTIVE = 1' INTO node_expression;
        END IF;
        --DBMS_OUTPUT.put_line('查询考核规则完毕');
        --DBMS_OUTPUT.put_line('node_self_id：'||node_self_id);
        --DBMS_OUTPUT.put_line('node_expression：'||node_expression);
        IF node_expression IS NOT NULL THEN
        --解析关键字
        user_expression :=REPLACE( REPLACE(
                REPLACE(
                    REPLACE(
                        REPLACE(
                            REPLACE(
                                REPLACE(
                                    REPLACE(
                                        REPLACE(REPLACE(node_expression, '{所属公司}', 'COMPANY_ID'),'{计划类型}','PLAN_TYPE'),
                                        '{任务级别}', 'NODE_LEVEL'
                                    ),  '{审批时间}', 'APPROVAL_TIME'
                                ), '{计划开始时间}','PLAN_START_DATE'
                            ),'{计划完成时间}','PLAN_END_DATE'
                        ),'{实际开始时间}','ACTUAL_START_DATE'
                    ),'{实际完成时间}', 'ACTUAL_END_DATE'
                ), '{标准分值}','STANDARD_SCORE'
            ), '{当前日期}','SYSDATE');
        DBMS_OUTPUT.put_line('user_expression：'||user_expression);
        DBMS_OUTPUT.put_line('node_self_id：'||node_self_id);

        EXECUTE IMMEDIATE 'INSERT INTO POM_NODE_EXAMINATION(
                        ID,
                        NODE_ID,
                        ORIGINAL_NODE_ID,
                        NODE_LEVEL,
                        STANDARD_SCORE,
                        DUTY_DEPT_ID,
                        DUTY_DEPT,
                        COMPLETE_FEEDBACK_ID,
                        ORIGINAL_PLAN_ID,
                        PLAN_ID,
                        PLAN_TYPE,
                        EXAMINATION_SCORE,
                        NEW_EXAMINATION_SCORE,
                        PLAN_START_DATE,
                        PLAN_END_DATE,
                        ACTUAL_START_DATE,
                        ACTUAL_END_DATE,
                        EXAMINATION_DATE,
                        COMPLETE_FEEDBACK_APPROVE_TIME,
                        CHARGE_PERSON_ID,
                        CHARGE_PERSON,
                        NODE_NAME
                    )
                    SELECT
                        ID,
                        NODE_ID,
                        ORIGINAL_NODE_ID,
                        NODE_LEVEL,
                        STANDARD_SCORE,
                        DUTY_DEPARTMENT_ID,
                        DUTY_DEPARTMENT,
                        BASE.FEEDBACK_ID,
                        ORIGINAL_PLAN_ID,
                        PLAN_ID,
                        PLAN_TYPE,
                        (SELECT '||user_expression||' FROM POM_PROJ_PLAN_NODE WHERE ID = NODE_ID),
                        (SELECT '||user_expression||' FROM POM_PROJ_PLAN_NODE WHERE ID = NODE_ID),
                        PLAN_START_DATE,
                        PLAN_END_DATE,
                        ACTUAL_START_DATE,
                        ACTUAL_END_DATE,
                        CURRENT_DATE,
                        APPROVAL_TIME,
                        PERSONIDs,
                        PERSONs,
                        NODE_NAME
                    FROM(
                           SELECT GET_UUID() AS ID,
                           NODE.ID AS NODE_ID,
                           NODE.ORIGINAL_NODE_ID,
                           NODE.NODE_LEVEL,
                           NODE.STANDARD_SCORE,
                           NODE.DUTY_DEPARTMENT_ID,
                           NODE.DUTY_DEPARTMENT,
                           FB.ID AS FEEDBACK_ID,
                           NODE.ORIGINAL_PLAN_ID,
                           PLAN.ID AS PLAN_ID,
                           PLAN.PLAN_TYPE,
                           PLAN.COMPANY_ID,
                           NODE.PLAN_START_DATE,
                           NODE.PLAN_END_DATE,
                           NODE.ACTUAL_START_DATE,
                           NODE.ACTUAL_END_DATE,
                           SYSDATE AS CURRENT_DATE,
                           FB.APPROVAL_TIME,
                           (SELECT WM_CONCAT(CHARGE_PERSON_ID)
                            FROM POM_NODE_CHARGE_PERSON
                            WHERE NODE_ID = NODE.ID) AS PERSONIDs,
                           (SELECT WM_CONCAT(CHARGE_PERSON) FROM POM_NODE_CHARGE_PERSON WHERE NODE_ID = NODE.ID) AS PERSONs,
                           NODE.NODE_NAME
                    FROM POM_PROJ_PLAN_NODE NODE
                             LEFT JOIN POM_PROJ_PLAN PLAN ON NODE.PROJ_PLAN_ID = PLAN.ID
                             LEFT JOIN POM_NODE_FEEDBACK FB ON NODE.ID = FB.FEEDBACK_NODE_ID
                    WHERE NODE.ID = '''||node_self_id||'''
                      AND FB.FEEDBACK_TYPE = ''CARRY_OUT''
                      AND IS_DISABLE = 0
                      AND IS_DELETE = 0
                      )BASE';
                END IF;
    END IF;
    COMMIT;
END P_POM_EXAMELATE_NODE;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_EXPORT_COMPANY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_EXPORT_COMPANY" ( 
    companyid     IN            VARCHAR2,--输入变量：公司id
    currentcompanyid     IN     VARCHAR2,--当前用户的公司
	userid        IN            VARCHAR2,--用户id用于过滤关注的任务
    currentstationid     IN            VARCHAR2,---当前用户的岗位
    currentdeptid        IN            VARCHAR2,---当前用户的部门
    bizcode       IN            VARCHAR2,---权限code
--    pageindex     IN            INT,
--    pagesizes     IN            INT,
    currenttype   IN            VARCHAR2,--完成节点类型(本月任务,超期未完成任务,所有未完成任务,所有已完成任务,所有任务,次月任务,本季度任务,本年任务)
    searchcondition IN          VARCHAR2,--模糊查询条件
    items         OUT           SYS_REFCURSOR,
    total         OUT           INT
--  spiditems         OUT           SYS_REFCURSOR
) IS
--本部门负责的任务
--作者：陈丽
--日期：2019/11/15
--李小聪20200909修改
    v_sql_start          CLOB;
    v_sql_end            CLOB;
    v_sql_content       CLOB;
    v_sql               CLOB;
    v_sql_exec          CLOB;
    v_sql_exec_paging   CLOB;
    v_where              CLOB;
    v_spid              VARCHAR2(200);--数据权限验证spid
    testmsg             CLOB;
    wwhere          CLOB;
    v_where_like       CLOB;
BEGIN
----------------------------------------------------统一解析
    wwhere := companyid;
    --wwhere := ''' or ''1''=''1';
    testmsg := 'companyid:'
               || companyid
--               || '；pageindex:'
--               || pageindex
--               || '；pagesizes:'
--               || pagesizes
               || '；currenttype:'
               || currenttype;

    BEGIN
        total := 1000;
        v_sql_start := ' case ';
        v_sql_content := '';
        v_sql_end := '  else '''' end  ';
--调用数据权限验证存储过程
 P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );

-- open  spiditems   for select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = v_spid;
--1.拼接查询语句
        FOR item IN (
            SELECT
                s.expression,
                vv.node_level,
                vv.plan_type
            FROM
                pom_rule_set s
                LEFT JOIN (
                    SELECT
                        MAX(s.created_time) AS t,
                        node_level,
                        plan_type
                    FROM
                        pom_rule_set             s
                        LEFT JOIN pom_rule_set_plan_type   pt ON s.id = pt.rule_id
                    WHERE
                        rule_type = '亮灯规则'
                        --AND plan_type = '关键节点计划'
                        AND s.is_disable = 0
                    GROUP BY
                        node_level,
                        plan_type
                ) vv ON s.created_time = vv.t
                        AND s.node_level = vv.node_level
            WHERE
                vv.t IS NOT NULL
        ) LOOP
    ---拼接字符串
         v_sql_content := v_sql_content
                                || '  when plan_type='''
                                ||
            CASE item.plan_type
                WHEN '项目全景计划' THEN
                    '项目主项计划'
                ELSE item.plan_type
            END
                                || ''' and node_level='''
                                || item.node_level
                                || ''' then ('
                                || item.expression
                                || ')';
        END LOOP;

    --dbms_output.put_line('123333');
    --dbms_output.put_line(v_sql_content);
    --规则内容大于0才拼规则语句

        IF length(v_sql_content) > 0 THEN
            v_sql := v_sql_start
                     || v_sql_content
                     || v_sql_end;
        ELSE
    --无规则亮灯显示空
            v_sql := '''''';
        END IF;

-------------------------------------------------------------------------------------------内容

            IF currenttype = '本月任务' THEN
            v_where := ' and ACTUAL_END_DATE is null and (PLAN_END_DATE>=trunc(sysdate, ''month'') and PLAN_END_DATE<=trunc(last_day(sysdate))) ';
        ELSIF currenttype = '超期未完成任务' THEN
            v_where := ' and TRUNC(sysdate)>PLAN_END_DATE  and ACTUAL_END_DATE is null';
        ELSIF currenttype = '所有未完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is null ';
        ELSIF currenttype = '所有已完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is not null ';
        ELSIF currenttype = '所有任务' THEN
            v_where := ' ';
        ELSIF currenttype = '次月任务' THEN
            v_where := ' and (PLAN_END_DATE  BETWEEN last_day(trunc(sysdate))+1 and  last_day(last_day(trunc(sysdate))+1))';
        ELSIF currenttype = '本季度任务' THEN
            v_where := ' and (PLAN_END_DATE>trunc(sysdate, ''Q'') and PLAN_END_DATE<=add_months(trunc(sysdate, ''Q''), 3) - 1) ';
        ELSIF currenttype = '本年任务' THEN
            v_where := ' and (PLAN_END_DATE>=trunc(sysdate, ''yyyy'') and PLAN_END_DATE<=add_months(trunc(sysdate, ''yyyy''), 12) - 1)  ';
        ELSE
            v_where := ' and 1=2';
        END IF;

 --当输入条件部位空时
        IF searchcondition is not null THEN
          v_where_like := 'WHERE (instr(n.NODE_NAME,'''||searchcondition||''')>0 OR instr(n.PLAN_NAME,'''||searchcondition||''')>0
              OR instr(n.PROJ_NAME,'''||searchcondition||''')>0 OR instr(n.DUTY_DEPARTMENT,'''||searchcondition||''')>0
              OR instr(charge_person,'''||searchcondition||''')>0 )';
        ELSE
          v_where_like := '';
        END IF;
--3.拼接完整语句
IF companyid <> '333' THEN
        v_sql_exec := ' select   row_number() over(ORDER BY PROJ_PLAN_ID,PLAN_END_DATE ) as ROWNO,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
		CHARGE_PERSON,
    NODE_LEVEL,
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE is null then ''催办''
else null end as HASTEN

                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    n.ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门
		person.CHARGE_PERSON,
    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n
		LEFT JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
		LEFT JOIN (	SELECT  listagg (CHARGE_PERSON,'','') within GROUP ( ORDER by CHARGE_PERSON)  AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID
		
		)  person ON n.ID=person.NODE_ID
        left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id
        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
        on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
        WHERE tal.orgid is not null
        AND p.PLAN_TYPE in (''项目主项计划'' ,''关键节点计划'') and APPROVAL_STATUS=''已审核''
		AND	n.IS_DISABLE=0
    and n.COMPANY_ID='''
                      || wwhere
                      || ''' '
                      || v_where
                      || '
UNION ALL
SELECT
    n.ID   AS id,
     p.id as ORIGINAL_PLAN_ID,
    n.ID   AS ORIGINAL_NODE_ID,
    PLAN_ID,
    2 AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    PREDICT_END_DATE,
    ''所属项目'' AS E,
    ''专项计划'' AS F,
    DUTY_DEPARTMENT,
		person.CHARGE_PERSON,
    ''专项计划级'' AS M,
    0 AS N
FROM
    POM_SPECIAL_PLAN_NODE n
		LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID
		LEFT JOIN (SELECT  listagg (CHARGE_PERSON,'','') within GROUP ( ORDER by CHARGE_PERSON)  AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON n.ID=person.NODE_ID
        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on  n.DUTY_DEPARTMENT_ID in tal.orgid or n.COMPANY_ID in tal.orgid or p.COMPANY_ID in tal.orgid
        WHERE tal.orgid is not null
        AND APPROVAL_STATUS=''已审核''  AND n.IS_DELETE=0 and n.COMPANY_ID='''
                      || wwhere
                      || ''' '
                      || v_where
                      || '
UNION ALL
    SELECT    n.id,
    p.ORIGINAL_PLAN_ID,
    n.original_node_id,
    dept_monthly_plan_id,
    4 as  PLAN_TYPE_INT,

    node_name,
    p.PLAN_NAME,
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    ''无'' as PROJ_NAME,          --所属项目
    ''部门月度计划'' as  PLAN_TYPE,        --计划类型显示名
    p.DEPT_NAME,          --主责部门
		person.CHARGE_PERSON,
    node_Type,           --任务等级
    stand_SCORE          --标准分值
FROM
    pom_dept_monthly_plan_node n
    left join pom_dept_monthly_plan p on n.dept_monthly_plan_id=p.id
    LEFT JOIN (SELECT  listagg (CHARGE_PERSON,'','') within GROUP ( ORDER by CHARGE_PERSON)  AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON n.ID=person.NODE_ID
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on p.DEPT_ID in tal.orgid or p.COMPANY_ID in tal.orgid
    WHERE tal.orgid is not null
    AND  node_source is null AND (IS_DEL=0 OR IS_DEL=null) and APPROVE_STATUS=''已审核'' and p.COMPANY_ID='''
                      || companyid
                      || ''' '
                      || v_where
                      || ')n
    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID WHERE (n.NODE_NAME LIKE ''%'||searchcondition||'%'' OR  n.PLAN_NAME LIKE ''%'||searchcondition||'%'' 
    OR n.PROJ_NAME LIKE ''%'||searchcondition||'%'' OR n. DUTY_DEPARTMENT LIKE ''%'||searchcondition||'%'' OR n.CHARGE_PERSON LIKE ''%'||searchcondition||'%'') ORDER BY n.PLAN_END_DATE) a ';
ELSE
v_sql_exec := ' select  row_number() over(ORDER BY PROJ_PLAN_ID,PLAN_END_DATE ) as ROWNO,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
		CHARGE_PERSON,
    NODE_LEVEL,
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE is null then ''催办''
else null end as HASTEN
                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    n.ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门
		person.CHARGE_PERSON,
    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n
		LEFT JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
		LEFT JOIN (SELECT  listagg (CHARGE_PERSON,'','') within GROUP ( ORDER by CHARGE_PERSON)  AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID )  person ON n.ID=person.NODE_ID
        left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id
        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
        on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
        WHERE tal.orgid is not null
        AND (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and APPROVAL_STATUS=''已审核''
		AND	n.IS_DISABLE=0
         '|| v_where || '
UNION ALL
SELECT
    n.ID   AS id,
     p.id as ORIGINAL_PLAN_ID,
    n.ID   AS ORIGINAL_NODE_ID,
    PLAN_ID,
    2 AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    PREDICT_END_DATE,
    ''所属项目'' AS E,
    ''专项计划'' AS F,
    DUTY_DEPARTMENT,
		cp.CHARGE_PERSON,
    ''专项计划级'' AS M,
    0 AS N
FROM
    POM_SPECIAL_PLAN_NODE n
		LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID
		left join (SELECT node_id,LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
        FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID
        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal
        on n.DUTY_DEPARTMENT_ID in tal.orgid or n.COMPANY_ID in tal.orgid or  p.COMPANY_ID in tal.orgid
        WHERE tal.orgid is not null AND APPROVAL_STATUS=''已审核''  AND n.IS_DELETE=0 '|| v_where || '
UNION ALL
    SELECT    n.id,
    p.ORIGINAL_PLAN_ID,
    n.original_node_id,
    dept_monthly_plan_id,
    3 as  PLAN_TYPE_INT,

    node_name,
    p.PLAN_NAME,
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    ''无'' as PROJ_NAME,          --所属项目
    ''部门月度计划'' as  PLAN_TYPE,        --计划类型显示名
    p.DEPT_NAME,          --主责部门
		cp.CHARGE_PERSON,
    node_Type,           --任务等级
    stand_SCORE          --标准分值
FROM
    pom_dept_monthly_plan_node n
    left join pom_dept_monthly_plan p on n.dept_monthly_plan_id=p.id
    left join (SELECT node_id,LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
    FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal
    on p.DEPT_ID in tal.orgid or p.COMPANY_ID in tal.orgid
    WHERE tal.orgid is not null AND (IS_DEL=0 OR IS_DEL=null) and APPROVE_STATUS=''已审核'' ' || v_where|| ')n
    left join （SELECT * FROM SYS_BIZ_WATCH w WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID '||v_where_like||' ORDER BY n.PLAN_END_DATE) a  ';
END IF;
-------------------------------------------------------------------------------------------内容

        v_sql_exec_paging := '
select a.* from ( '
                             || v_sql_exec
--                             || ' where rownum <= '
--                             || pageindex * pagesizes
--                             || ' ) a where a.rowno >= '
--                             || pagesizes * ( pageindex - 1 )
                             || ')a';

       -- dbms_output.put_line(v_sql_exec_paging);

				dbms_output.put_line(v_sql_exec_paging);
----获取总条数
--        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
--                          || v_sql_exec
--                          || ') a '
--        INTO total;

-- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN items FOR v_sql_exec_paging;
--SELECT '' A FROM DUAL;

    EXCEPTION
        WHEN OTHERS THEN
        testmsg:=sqlerrm||testmsg;
            OPEN items FOR SELECT
                               '失败咯' || testmsg plan_name
                           FROM
                               dual;

           -- dbms_output.put_line(sqlerrm);
    END;

END p_pom_export_company;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_EXPORT_DEPT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_EXPORT_DEPT" ( 
    userid        IN            VARCHAR,--用户id，用于过滤关注的任务
    deptid        IN            VARCHAR2,--输入变量：部门
    currentcompanyid     IN            VARCHAR2,--当前用户公司
    currentdeptid        IN            VARCHAR2,--当前用户部门
    currentstationid     IN            VARCHAR2,---当前用户的岗位
    bizcode       IN            VARCHAR2,---权限code
--    pageindex     IN            INT,
--    pagesizes     IN            INT,
    currenttype   IN            VARCHAR2,--完成节点类型(本月任务,超期未完成任务,所有未完成任务,所有已完成任务,所有任务,次月任务,本季度任务,本年任务)
    searchcondition IN          VARCHAR2,
    items         OUT           SYS_REFCURSOR,
    total         OUT           INT
) IS
--本部门负责的任务
--作者：陈丽
--日期：2019/11/15

    v_sql_start          CLOB;
    v_sql_end            CLOB;
    v_sql_content        CLOB;
    v_sql               CLOB;
    v_sql_exec          CLOB;
    v_sql_exec_paging   CLOB;
    v_spid              CLOB;            
    deptidwhere         CLOB;
    v_where              CLOB;
    testmsg             CLOB;
BEGIN
----------------------------------------------------统一解析
--    IF (deptid <> '444') THEN
       deptidwhere := deptid;
--    ELSE
--        deptidwhere := '';
--    END IF;
    --deptidwhere := ''' or ''1''=''1';
    testmsg := 'deptid:'
               || deptid
--               || '；pageindex:'
--               || pageindex
--               || '；pagesizes:'
--               || pagesizes
               || '；currenttype:'
               || currenttype;

    BEGIN
        total := 1000;
        v_sql_start := ' case ';
        v_sql_content := '';
        v_sql_end := '  else '''' end  ';

--调用数据权限验证存储过程
 P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
--        test_sql:=' select n.*,orgid  FROM POM_SPECIAL_PLAN_NODE n
--        LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID
--        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=n.DUTY_DEPARTMENT_ID or tal.orgid=n.COMPANY_ID
--
--        WHERE  APPROVAL_STATUS=''已审核'' and n.IS_DELETE=0';
--
--
--        open auth for test_sql;
--1.拼接查询语句
        FOR item IN (
            SELECT
                s.expression,
                vv.node_level,
                vv.plan_type
            FROM
                pom_rule_set s
                LEFT JOIN (
                    SELECT
                        MAX(s.created_time) AS t,
                        node_level,
                        plan_type
                    FROM
                        pom_rule_set             s
                        LEFT JOIN pom_rule_set_plan_type   pt ON s.id = pt.rule_id
                    WHERE
                        rule_type = '亮灯规则'
                       -- AND plan_type != '关键节点计划'
                        AND s.is_disable = 0
                    GROUP BY
                        node_level,
                        plan_type
                ) vv ON s.created_time = vv.t
                        AND s.node_level = vv.node_level
            WHERE
                vv.t IS NOT NULL
        ) LOOP
    ---拼接字符串
         v_sql_content := v_sql_content
                                || '  when plan_type='''
                                ||
            CASE item.plan_type
                WHEN '项目全景计划' THEN
                    '项目主项计划'
                ELSE item.plan_type
            END
                                || ''' and node_level='''
                                || item.node_level
                                || ''' then ('
                                || item.expression
                                || ')';
        END LOOP;

    --dbms_output.put_line('123333');
    --dbms_output.put_line(v_sql_content);
    --规则内容大于0才拼规则语句

        IF length(v_sql_content) > 0 THEN
            v_sql := v_sql_start
                     || v_sql_content
                     || v_sql_end;
        ELSE
    --无规则亮灯显示空
            v_sql := '''''';
        END IF;

-------------------------------------------------------------------------------------------内容

       IF currenttype = '本月任务' THEN
            v_where := ' and ACTUAL_END_DATE is null  and (PLAN_END_DATE>=trunc(sysdate, ''month'') and PLAN_END_DATE<=trunc(last_day(sysdate))) ';
        ELSIF currenttype = '超期未完成任务' THEN
            v_where := ' and sysdate>PLAN_END_DATE and ACTUAL_END_DATE is null';
        ELSIF currenttype = '所有未完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is null ';
        ELSIF currenttype = '所有已完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is not null ';
        ELSIF currenttype = '所有任务' THEN
            v_where := ' ';
        ELSIF currenttype = '次月任务' THEN
            v_where := ' and (PLAN_END_DATE>=last_day(trunc(sysdate))+1 and PLAN_END_DATE<=last_day(last_day(trunc(sysdate))+1))';
        ELSIF currenttype = '本季度任务' THEN
            v_where := ' and (PLAN_END_DATE>=trunc(sysdate, ''Q'') and PLAN_END_DATE<=add_months(trunc(sysdate, ''Q''), 3) - 1) ';
        ELSIF currenttype = '本年任务' THEN
            v_where := ' and (PLAN_END_DATE>=trunc(sysdate, ''yyyy'') and PLAN_END_DATE<=add_months(trunc(sysdate, ''yyyy''), 12) - 1)  ';
        ELSE
            v_where := ' and 1=2';
        END IF;
--3.拼接完整语句
IF (deptid <> '444') THEN
        v_sql_exec := ' select  row_number() over(ORDER BY PROJ_PLAN_ID,PLAN_END_DATE ) as ROWNO,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
    NODE_LEVEL,
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,charge_person,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,charge_person,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE is null then ''催办''
else null end as HASTEN

                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门

    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n LEFT
    JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
   left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id
    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
    WHERE  (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and APPROVAL_STATUS=''已审核''  AND	n.IS_DISABLE=0  and DUTY_DEPARTMENT_ID='''
                      || deptidwhere
                      || ''' '
                      || v_where
                      || '
UNION ALL
SELECT
    n.ID   AS id,
     p.id as ORIGINAL_PLAN_ID,
    n.ID   AS ORIGINAL_NODE_ID,
    PLAN_ID,
    2 AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    PREDICT_END_DATE,
    ''所属项目'' AS E,
    ''专项计划'' AS F,
    DUTY_DEPARTMENT,

    ''专项计划级'' AS M,
    0 AS N
FROM
    POM_SPECIAL_PLAN_NODE n
    LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID
     LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=n.DUTY_DEPARTMENT_ID or tal.orgid=n.COMPANY_ID
     WHERE  p.APPROVAL_STATUS=''已审核'' and n.IS_DELETE=0  and n.DUTY_DEPARTMENT_ID='''
                      || deptidwhere
                      || ''' '
                      || v_where
                      || '
UNION ALL
    SELECT    n.id,
    p.ORIGINAL_PLAN_ID,
    original_node_id,
    dept_monthly_plan_id,
    3 as  PLAN_TYPE_INT,

    node_name,
    p.PLAN_NAME,
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    ''无'' as PROJ_NAME,          --所属项目
    ''部门月度计划'' as  PLAN_TYPE,        --计划类型显示名
    p.DEPT_NAME,          --主责部门

    node_Type,           --任务等级
    stand_SCORE          --标准分值
FROM
    pom_dept_monthly_plan_node n
    left join pom_dept_monthly_plan p on n.dept_monthly_plan_id=p.id
     LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=p.DEPT_ID or tal.orgid=p.COMPANY_ID
     WHERE APPROVE_STATUS=''已审核''   AND n.IS_DEL=0 and DUTY_DEPT_ID='''
                      || deptidwhere
                      || ''' '
                      || v_where
                      || ')n
    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID
    left join (SELECT node_id,
     LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
      FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID WHERE (n.NODE_NAME LIKE ''%'||searchcondition||'%'' OR  n.PLAN_NAME LIKE ''%'||searchcondition||'%''
    OR n.PROJ_NAME LIKE ''%'||searchcondition||'%'' OR n. DUTY_DEPARTMENT LIKE ''%'||searchcondition||'%'' OR cp.charge_person like ''%'||searchcondition||'%'' )  ORDER BY n.PLAN_END_DATE) a ';
else
     v_sql_exec := ' select  row_number() over(ORDER BY PROJ_PLAN_ID,PLAN_END_DATE ) as ROWNO,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
    NODE_LEVEL,
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,charge_person,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,charge_person,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE is null then ''催办''
else null end as HASTEN

                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门

    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n LEFT
    JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
    left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id
    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
    WHERE (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and APPROVAL_STATUS=''已审核''  AND	n.IS_DISABLE=0 '
                      || v_where
                      || '
UNION ALL
SELECT
    n.ID   AS id,
     p.id as ORIGINAL_PLAN_ID,
    n.ID   AS ORIGINAL_NODE_ID,
    PLAN_ID,
    2 AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    PREDICT_END_DATE,
    ''所属项目'' AS E,
    ''专项计划'' AS F,
    DUTY_DEPARTMENT,

    ''专项计划级'' AS M,
    0 AS N
FROM
    POM_SPECIAL_PLAN_NODE n
    LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID
     LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=n.DUTY_DEPARTMENT_ID or tal.orgid=n.COMPANY_ID
     WHERE  APPROVAL_STATUS=''已审核'' and n.IS_DELETE=0  '
                      || v_where
                      || '
UNION ALL
    SELECT    n.id,
    p.ORIGINAL_PLAN_ID,
    original_node_id,
    dept_monthly_plan_id,
    3 as  PLAN_TYPE_INT,

    node_name,
    p.PLAN_NAME,
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    ''无'' as PROJ_NAME,          --所属项目
    ''部门月度计划'' as  PLAN_TYPE,        --计划类型显示名
    p.DEPT_NAME,          --主责部门

    node_Type,           --任务等级
    stand_SCORE          --标准分值
FROM
    pom_dept_monthly_plan_node n
    left join pom_dept_monthly_plan p on n.dept_monthly_plan_id=p.id
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=p.DEPT_ID or tal.orgid=p.COMPANY_ID
    WHERE APPROVE_STATUS=''已审核''   AND n.IS_DEL=0  '
                      || v_where
                      || ')n
    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID
    left join (SELECT node_id,
    LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
    FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID WHERE (n.NODE_NAME LIKE ''%'||searchcondition||'%'' OR  n.PLAN_NAME LIKE ''%'||searchcondition||'%''
    OR n.PROJ_NAME LIKE ''%'||searchcondition||'%'' OR n.DUTY_DEPARTMENT LIKE ''%'||searchcondition||'%'' OR cp.charge_person like ''%'||searchcondition||'%'' )  ORDER BY n.PLAN_END_DATE) a ';
end if;
-------------------------------------------------------------------------------------------内容

       v_sql_exec_paging := '
select a.* from ( '
                             || v_sql_exec
                             --|| ' where rownum <= '
--                             || pageindex * pagesizes
--                             || ' ) a where a.rowno >= '
--                             || pagesizes * ( pageindex - 1 )
                            || ') a';

        dbms_output.put_line(v_sql_exec_paging);
------获取总条数
--        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
--                          || v_sql_exec
--                          || ') a '
--        INTO total;

-- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN items FOR v_sql_exec_paging;
--SELECT '' A FROM DUAL;

    EXCEPTION
        WHEN OTHERS THEN
            testmsg := sqlerrm || testmsg;
            OPEN items FOR SELECT
                               '失败咯' || testmsg plan_name
                           FROM
                               dual;

            dbms_output.put_line(sqlerrm);
    END;

END p_pom_export_dept;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_EXPORT_PERSONAL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_EXPORT_PERSONAL" ( 
    userid        IN            VARCHAR2,--输入变量：用户ID
    currenttype   IN            VARCHAR2,--完成节点类型（所有未完成，超期未完成，所有已完成）
    searchcondition IN          VARCHAR2,
    items         OUT           SYS_REFCURSOR
--    total         OUT           INT
) IS

    v_sql_start          CLOB;
    v_sql_end           CLOB;
    v_sql_content        CLOB;
    v_sql               CLOB;
    v_sql_exec          CLOB;
    v_sql_exec_paging   CLOB;
    v_where              CLOB;
    testmsg             CLOB;
BEGIN
    --total := 1000;
    v_sql_start := ' case ';
    v_sql_content := '';
    v_sql_end := '  else '''' end  ';
    BEGIN

--1.拼接查询语句
        FOR item IN (
            SELECT
                s.expression,
                vv.node_level,
                vv.plan_type
            FROM
                pom_rule_set s
                LEFT JOIN (
                    SELECT
                        MAX(s.created_time) AS t,
                        node_level,
                        plan_type
                    FROM
                        pom_rule_set             s
                        LEFT JOIN pom_rule_set_plan_type   pt ON s.id = pt.rule_id
                    WHERE
                        rule_type = '亮灯规则'
                        --AND plan_type != '关键节点计划'
                        AND s.is_disable = 0
                    GROUP BY
                        node_level,
                        plan_type
                ) vv ON s.created_time = vv.t
                        AND s.node_level = vv.node_level
            WHERE
                vv.t IS NOT NULL
        ) LOOP 
    ---拼接字符串
         v_sql_content := v_sql_content
                                || '  when plan_type='''
                                ||
            CASE item.plan_type
                WHEN '项目全景计划' THEN
                    '项目主项计划'
                ELSE item.plan_type
            END
                                || ''' and node_level='''
                                || item.node_level
                                || ''' then ('
                                || item.expression
                                || ')';
        END LOOP;

    --dbms_output.put_line('123333');
    --dbms_output.put_line(v_sql_content);
    --规则内容大于0才拼规则语句

        IF length(v_sql_content) > 0 THEN
            v_sql := v_sql_start
                     || v_sql_content
                     || v_sql_end;
        ELSE
    --无规则亮灯显示空
            v_sql := '''''';
        END IF;
-------------------------------------------------------------------------------------------内容

        IF currenttype = '所有未完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is null';
        ELSIF currenttype = '超期未完成任务' THEN
            v_where := ' and sysdate>PLAN_END_DATE  and ACTUAL_END_DATE is null';
        ELSIF currenttype = '所有已完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is not null ';
        ELSE
            v_where := '';
        END IF;
--3.拼接完整语句

        v_sql_exec := ' select  row_number() over(ORDER BY PROJ_PLAN_ID,PLAN_END_DATE ) as ROWNO,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,         
    PLAN_TYPE,       
    DUTY_DEPARTMENT,         
    NODE_LEVEL,  
		CHARGE_PERSON,
    STANDARD_SCORE ,WACTH,HASTEN,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,''关注'' as WACTH,''催办'' as HASTEN from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    n.ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    n.NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门
		person.CHARGE_PERSON,
    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n 
		LEFT JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
		LEFT JOIN POM_NODE_CHARGE_PERSON person ON n.ID=person.NODE_ID	
		WHERE (p.PLAN_TYPE=''项目主项计划'' OR p.PLAN_TYPE=''关键节点计划'')  AND n.IS_DISABLE=0  and APPROVAL_STATUS=''已审核'' 
		AND CHARGE_PERSON_ID='''||userid||'''  '
                      || v_where
                      || '
UNION ALL
SELECT
    n.ID   AS id,
     p.id as ORIGINAL_PLAN_ID,
    n.ID   AS ORIGINAL_NODE_ID,
    PLAN_ID,
    2 AS PLAN_TYPE_INT,

    n.NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    PREDICT_END_DATE,
    ''所属项目'' AS E,
    ''专项计划'' AS F,
    DUTY_DEPARTMENT,
		person.CHARGE_PERSON,
    ''专项计划级'' AS M,
    0 AS N
FROM
    POM_SPECIAL_PLAN_NODE n 
		LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID 
		LEFT JOIN POM_NODE_CHARGE_PERSON person ON n.ID=person.NODE_ID
		where n.IS_DELETE=0 AND APPROVAL_STATUS=''已审核'' 
		AND CHARGE_PERSON_ID='''||userid||'''  '
                      || v_where
                      || '
UNION ALL
    SELECT    n.id,
    p.ORIGINAL_PLAN_ID,
    n.original_node_id,
    dept_monthly_plan_id,
    10 as  PLAN_TYPE_INT,

    n.node_name,
    p.PLAN_NAME,
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    ''无'' as PROJ_NAME,          --所属项目
    ''部门月度计划'' as  PLAN_TYPE,        --计划类型显示名
    p.DEPT_NAME,          --主责部门
		person.CHARGE_PERSON,
    node_Type,           --任务等级
    stand_SCORE          --标准分值
FROM
    pom_dept_monthly_plan_node n
    left join pom_dept_monthly_plan p on n.dept_monthly_plan_id=p.id
		LEFT JOIN POM_NODE_CHARGE_PERSON person ON n.ID=person.NODE_ID
    where node_source is null AND n.IS_DEL=0 and APPROVE_STATUS=''已审核''
		AND CHARGE_PERSON_ID='''||userid||'''  '
                      || v_where
                      || ')n  
  WHERE (n.NODE_NAME LIKE ''%'||searchcondition||'%'' OR  n.PLAN_NAME LIKE ''%'||searchcondition||'%'' 
    OR n.PROJ_NAME LIKE ''%'||searchcondition||'%'' OR n. DUTY_DEPARTMENT LIKE ''%'||searchcondition||'%'' )  ORDER BY n.PLAN_END_DATE  ) a  ';-- left join POM_NODE_CHARGE_PERSON cp on n.id=cp.NODE_ID where CHARGE_PERSON_ID='''||userid||'''  
-------------------------------------------------------------------------------------------内容


       v_sql_exec_paging := '
select a.* from ( '
                             || v_sql_exec
                             --|| ' where rownum <= '
--                             || pageindex * pagesizes
--                             || ' ) a where a.rowno >= '
--                             || pagesizes * ( pageindex - 1 )
                            || ') a';

        --dbms_output.put_line(v_sql_exec_paging);
----获取总条数

--        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
--                          || v_sql_exec
--                          || ') a '
--        INTO total;
        dbms_output.put_line(v_sql_exec_paging);
-- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN items FOR v_sql_exec;
--SELECT '' A FROM DUAL;

    EXCEPTION
        WHEN OTHERS THEN
            OPEN items FOR SELECT
                               '失败咯' || testmsg plan_name
                           FROM
                               dual;

            dbms_output.put_line(sqlerrm);
    END;

END p_pom_export_personal;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_EXPORT_PROJECT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_EXPORT_PROJECT" ( 
    projid        IN            VARCHAR2,--输入变量：项目
    userid        IN 			VARCHAR2,--用户id，用于过滤关注的任务
    currentcompanyid     IN            VARCHAR2,--当前用户公司
    currentdeptid        IN            VARCHAR2,--当前用户部门
    currentstationid     IN            VARCHAR2,---当前用户的岗位
    bizcode       IN            VARCHAR2,---权限code
--    pageindex     IN            INT,
--    pagesizes     IN            INT,
    currenttype   IN            VARCHAR2,--完成节点类型(本月任务,超期未完成任务,所有未完成任务,所有已完成任务,所有任务,次月任务,本季度任务,本年任务)
    searchcondition IN          VARCHAR2,--模糊查询条件
    items         OUT           SYS_REFCURSOR,
    total         OUT           INT
) IS
--本部门负责的任务
--作者：陈丽
--日期：2019/11/15

    v_sql_start          CLOB;
    v_sql_end            CLOB;
    v_sql_content        CLOB;
    v_sql               CLOB;
    v_sql_exec          CLOB;
    v_sql_exec_paging   CLOB;
    v_where              CLOB;
    v_spid              CLOB; 
    testmsg              CLOB;
BEGIN
----------------------------------------------------统一解析
    testmsg := 'projid:'
               || projid
--               || '；pageindex:'
--               || pageindex
--               || '；pagesizes:'
--               || pagesizes
--               || '；currenttype:'
               || currenttype;

    BEGIN
        total := 1000;
        v_sql_start := ' case ';
        v_sql_content := '';
        v_sql_end := '  else '''' end  ';

--调用数据权限验证存储过程
 P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
--1.拼接查询语句
        FOR item IN (
            SELECT
                s.expression,
                vv.node_level,
                vv.plan_type
            FROM
                pom_rule_set s
                LEFT JOIN (
                    SELECT
                        MAX(s.created_time) AS t,
                        node_level,
                        plan_type
                    FROM
                        pom_rule_set             s
                        LEFT JOIN pom_rule_set_plan_type   pt ON s.id = pt.rule_id
                    WHERE
                        rule_type = '亮灯规则'
                       -- AND plan_type != '关键节点计划'
                        AND s.is_disable = 0
                    GROUP BY
                        node_level,
                        plan_type
                ) vv ON s.created_time = vv.t
                        AND s.node_level = vv.node_level
            WHERE
                vv.t IS NOT NULL
        ) LOOP 
    ---拼接字符串
         v_sql_content := v_sql_content
                                || '  when plan_type='''
                                ||
            CASE item.plan_type
                WHEN '项目全景计划' THEN
                    '项目主项计划'
                ELSE item.plan_type
            END
                                || ''' and node_level='''
                                || item.node_level
                                || ''' then ('
                                || item.expression
                                || ')';
        END LOOP;

    --dbms_output.put_line('123333');
    --dbms_output.put_line(v_sql_content);
    --规则内容大于0才拼规则语句

        IF length(v_sql_content) > 0 THEN
            v_sql := v_sql_start
                     || v_sql_content
                     || v_sql_end;
        ELSE
    --无规则亮灯显示空
            v_sql := '''''';
        END IF;

-------------------------------------------------------------------------------------------内容


       IF currenttype = '本月任务' THEN
            v_where := ' and ACTUAL_END_DATE is null and (PLAN_END_DATE>=trunc(sysdate, ''month'') and PLAN_END_DATE<=trunc(last_day(sysdate))) ';
        ELSIF currenttype = '超期未完成任务' THEN
            v_where := ' and sysdate>PLAN_END_DATE and ACTUAL_END_DATE is null';
        ELSIF currenttype = '所有未完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is null ';
        ELSIF currenttype = '所有已完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is not null ';
        ELSIF currenttype = '所有任务' THEN
            v_where := ' ';
        ELSIF currenttype = '次月任务' THEN
            v_where := ' and (PLAN_END_DATE>=last_day(trunc(sysdate))+1 and PLAN_END_DATE<=last_day(last_day(trunc(sysdate))+1))';
        ELSIF currenttype = '本季度任务' THEN
            v_where := ' and (PLAN_END_DATE>=trunc(sysdate, ''Q'') and PLAN_END_DATE<=add_months(trunc(sysdate, ''Q''), 3) - 1) ';
        ELSIF currenttype = '本年任务' THEN
            v_where := ' and (PLAN_END_DATE>=trunc(sysdate, ''yyyy'') and PLAN_END_DATE<=add_months(trunc(sysdate, ''yyyy''), 12) - 1)  ';
        ELSE
            v_where := ' and 1=2';
        END IF;

--3.拼接完整语句
if projid <> '111' then
        v_sql_exec := ' select row_number() over(ORDER BY PROJ_PLAN_ID,PLAN_END_DATE ) as ROWNO,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,         
    PLAN_TYPE,       
    DUTY_DEPARTMENT,      
		CHARGE_PERSON,
    NODE_LEVEL,      
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE is null then ''催办''
else null end as HASTEN

                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    n.ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门
    person.CHARGE_PERSON,
    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n 
		LEFT JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID 
		LEFT JOIN (SELECT   listagg (CHARGE_PERSON,'','') within GROUP ( ORDER by CHARGE_PERSON)  AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID) person ON n.ID=person.NODE_ID
        left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id 
        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal 
        on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
        WHERE tal.orgid is not null 
        AND (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and APPROVAL_STATUS=''已审核'' 
		AND n.IS_DISABLE=0 
		AND (p.PROJ_ID='''||projid||''' OR p.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID='''||projid||'''))  '||v_where||'
)n 
    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID  WHERE (n.NODE_NAME LIKE ''%'||searchcondition||'%'' OR  n.PLAN_NAME LIKE ''%'||searchcondition||'%'' 
    OR n.PROJ_NAME LIKE ''%'||searchcondition||'%'' OR n. DUTY_DEPARTMENT LIKE ''%'||searchcondition||'%'' OR n.CHARGE_PERSON LIKE ''%'||searchcondition||'%'')  ORDER BY n.PLAN_END_DATE) a ';
else 
    v_sql_exec := ' select row_number() over(ORDER BY PROJ_PLAN_ID,PLAN_END_DATE ) as ROWNO,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,         
    PLAN_TYPE,       
    DUTY_DEPARTMENT,      
		CHARGE_PERSON,
    NODE_LEVEL,      
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,''催办'' as HASTEN

                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    n.ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门
    person.CHARGE_PERSON,
    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n 
		LEFT JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID 
		LEFT JOIN (SELECT  listagg (CHARGE_PERSON,'','') within GROUP ( ORDER by CHARGE_PERSON)  AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID ) person ON n.ID=person.NODE_ID
		left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id 
        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal 
        on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
        WHERE tal.orgid is not null 
        AND (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and APPROVAL_STATUS=''已审核'' 
		AND n.IS_DISABLE=0 
		  '||v_where||'
)n 
    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID   WHERE (n.NODE_NAME LIKE ''%'||searchcondition||'%'' OR  n.PLAN_NAME LIKE ''%'||searchcondition||'%'' 
    OR n.PROJ_NAME LIKE ''%'||searchcondition||'%'' OR n. DUTY_DEPARTMENT LIKE ''%'||searchcondition||'%'' OR n.CHARGE_PERSON LIKE ''%'||searchcondition||'%'')  ORDER BY n.PLAN_END_DATE) a ';
end if;
-------------------------------------------------------------------------------------------内容

        v_sql_exec_paging := '
select a.* from ( '
                             || v_sql_exec
--                             || ' where rownum <= '
--                             || pageindex * pagesizes
--                             || ' ) a where a.rowno >= '
--                             || pagesizes * ( pageindex - 1 )
                             || ')a';

        dbms_output.put_line(v_sql_exec_paging);
----获取总条数
--        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
--                          || v_sql_exec
--                          || ') a '
--        INTO total;

-- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN items FOR v_sql_exec_paging;
--SELECT '' A FROM DUAL;

    EXCEPTION
        WHEN OTHERS THEN
        testmsg:=sqlerrm||testmsg;
            OPEN items FOR SELECT
                               '失败咯' || testmsg plan_name
                           FROM
                               dual;

            dbms_output.put_line(sqlerrm);
    END;

END p_pom_export_project;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_FEEDBACK_APPROVAL_CB
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_FEEDBACK_APPROVAL_CB" (
    feedbackid IN VARCHAR2 --反馈id
) AS
    --反馈审批回调，只有审批通过才执行操作
--作者：陈丽
--日期：2019/11/13
    approvalstatus           NVARCHAR2(100);--审核状态
    feedbacktype             NVARCHAR2(100);--反馈类型（0：过程反馈，1：完成反馈，2：到期未完成反馈）
    feedbacknodeoriginalid   NVARCHAR2(100); --反馈节点原始id
    plantype                 NVARCHAR2(100);--节点所属计划类型(0：关键节点计划，1：项目主项计划、2：专项计划、3：部门月度计划）
    actualstarttime          DATE;--实际开始时间
    actualendtime            DATE;--实际结束时间
    estimatestarttime        DATE;--预计开始时间
    estimateendtime          DATE;--预计结束时间
BEGIN
    --o、获取反馈信息
    SELECT
        approval_status, node_source_plan_type, feedback_type, feedback_node_original_id, actual_start_time,
        actual_end_time, estimate_start_time, estimate_end_time
    INTO
        approvalstatus, plantype, feedbacktype, feedbacknodeoriginalid,  actualstarttime,
        actualendtime, estimatestarttime, estimateendtime
    FROM pom_node_feedback
    WHERE id = feedbackid;
    if approvalstatus != '已审核' then
        return;
    end if;

    --KEY_NODE：关键节点计划，MAIN_ITEM：项目主项计划、SPECIAL：专项计划、DEPARTMENT:部门月度计划
    --PROCESS：过程反馈，CARRY_OUT：完成反馈，EXPIRED：到期未完成反馈
    --1、更新反馈对应节点，【完成反馈】更新节点实际开始时间和实际完成时间，【未完成反馈】【过程反馈】更新节点预计开始时间和预计完成时间。
    IF feedbacktype = 'PROCESS' OR feedbacktype = 'EXPIRED' THEN--过程反馈，到期未完成反馈
        DBMS_OUTPUT.PUT('反馈类型:'||feedbacktype);
        --0：关键节点计划，1：项目主项计划,【未完成反馈】【过程反馈】更新节点预计开始时间和预计完成时间
        IF plantype = 'KEY_NODE' OR plantype = 'MAIN_ITEM'  THEN
            UPDATE pom_proj_plan_node
            SET
                estimate_start_date = estimatestarttime,
                estimate_end_date = estimateendtime,
                feedback_id = feedbackid
            WHERE original_node_id = feedbacknodeoriginalid;
        END IF;
        --2：专项计划
        IF plantype = 'SPECIAL'  THEN
            UPDATE pom_special_plan_node
            SET
                PREDICT_BEGIN_DATE = estimatestarttime,
                predict_end_date = estimateendtime,
                feedback_id = feedbackid
            WHERE original_node_id = feedbacknodeoriginalid;
        END IF;
        --3：部门月度计划
        IF plantype = 'DEPARTMENT' and approvalstatus='已审核'  THEN
            UPDATE pom_dept_monthly_plan_node
            SET
                estimate_start_date = estimatestarttime,
                estimate_end_date = estimateendtime,
                feedback_id = feedbackid
            WHERE original_node_id = feedbacknodeoriginalid;
        END IF;
    END IF;
    --完成反馈，【完成反馈】更新节点实际开始时间和实际完成时间
    IF feedbacktype = 'CARRY_OUT' THEN
        --0：关键节点计划，1：项目主项计划,【未完成反馈】【过程反馈】更新节点预计开始时间和预计完成时间。
        IF plantype = 'KEY_NODE' OR plantype = 'MAIN_ITEM' THEN
            UPDATE pom_proj_plan_node
            SET
                actual_start_date = actualstarttime,
                actual_end_date = actualendtime,
                feedback_id = feedbackid
            WHERE original_node_id = feedbacknodeoriginalid;
        END IF;
        --2：专项计划
        IF plantype = 'SPECIAL' THEN
            UPDATE pom_special_plan_node
            SET
                ACTUAL_BEGIN_DATE = actualstarttime,
                actual_end_date = actualendtime,
                feedback_id = feedbackid
            WHERE original_node_id = feedbacknodeoriginalid;
        END IF;
        --3：部门月度计划
        IF plantype = 'DEPARTMENT' THEN
            UPDATE pom_dept_monthly_plan_node
            SET
                actual_start_date = actualstarttime,
                actual_end_date = actualendtime,
                feedback_id = feedbackid
            WHERE original_node_id = feedbacknodeoriginalid;
        END IF;
    END IF;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_FEEDBACK_APPROVAL_CODE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_FEEDBACK_APPROVAL_CODE" 
(
    FEEDBACKID    IN VARCHAR2 --反馈id
,FORMCODE      OUT VARCHAR2 --表单编码
,FORMGROUPCODE OUT VARCHAR2 --表单分组编码
) AS
    --反馈工作流审批时获取审批需要的表单编码和分组编码
    --作者：陈丽
    --日期：2019/11/13
    V_NODE_TYPE VARCHAR2(100);
BEGIN
    SELECT A.NODE_SOURCE_PLAN_TYPE INTO V_NODE_TYPE FROM POM_NODE_FEEDBACK A WHERE A.ID = FEEDBACKID;

    IF V_NODE_TYPE = 'KEY_NODE' THEN
        FORMCODE := 'pom_feedback_key_nodes';
    ELSIF V_NODE_TYPE = 'MAIN_ITEM' THEN
        FORMCODE := 'pom_feedback_main_nodes';
    -- 专项计划反馈实现  韩金明 2020年10月28日
    ELSIF V_NODE_TYPE = 'SPECIAL' THEN
        FORMCODE := 'pom_feedback_special';
    ELSE
        FORMCODE := 'pom_feedback_key_nodes';
    END IF;
/*		FORMCODE := 'pom_feedback_key_nodes';*/
    FORMGROUPCODE := '';
END P_POM_FEEDBACK_APPROVAL_CODE;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_FISSION_NODE_UPDATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_FISSION_NODE_UPDATE" (
    feedbackId in varchar2
) as
    oldId varchar2(36);
    newId varchar2(36);
    nodeName varchar(200);
begin
    begin
        select pn.ID into oldId
        from POM_NODE_FEEDBACK pnf
                 left join POM_PROJ_PLAN_NODE pn on pnf.feedback_node_id = pn.id
        where pnf.ID = feedbackId;
        select NODE_NAME into nodeName
        from (
                 select *
                 from POM_PROJ_PLAN_NODE pn
                 start with pn.ID = oldId
                 connect by prior pn.FISSION_SOURCE_ORIGINAL_ID = pn.ORIGINAL_NODE_ID
             ) where FISSION_SOURCE_ORIGINAL_ID is null and rownum = 1;
    exception when others then
        oldId := null;
        sys.DBMS_OUTPUT.PUT_LINE('未获取到节点数据');
    end;
    if oldId is not null then
        newId := GET_UUID();
        -- 添加新数据
        insert into POM_PROJ_PLAN_NODE(
            ID, PROJ_PLAN_ID, ORIGINAL_NODE_ID, TEMPLATE_NODE_ID, STANDARD_NODE_ID,
            NODE_GRADE, NODE_NAME, NODE_CODE, NODE_LEVEL, PROJ_STAGE, MAIN_RESPONSIBILITY,
            CONTROL_TYPE, DUTY_DEPARTMENT_ID, DUTY_DEPARTMENT, PLAN_START_DATE, PLAN_END_DATE,
            IS_DISABLE, DISABLE_TIME, DISABLE_REASON_ID, STANDARD_SCORE, REFERENCE_DATE_NODE_ID,
            REFERENCE_DAY, PRECONDITION_REMARK, IS_CONTAINS_PERMIT, PERMIT_TYPE,
            COMPLETION_STANDARD, COMPLETION_RESULTS_REMARK, INPUT_CONDITION, OTHER_REMARK,
            CREATED, CREATOR_ID, CREATOR, MODIFIED, MODIFIER_ID, MODIFIER, PLAN_VERSION,
            IS_DELETE, DISABLE_REASON, ORIGINAL_PLAN_ID, COMPANY_NAME, COMPANY_ID,
            ACTUAL_END_DATE, ACTUAL_START_DATE, FEEDBACK_ID,
            FISSION_SOURCE_ORIGINAL_ID)
        select
            newId ID, PROJ_PLAN_ID, newId ORIGINAL_NODE_ID, TEMPLATE_NODE_ID, STANDARD_NODE_ID, NODE_GRADE,
            nodeName || '(' || neb.BUILD_NAME || ')' NODE_NAME, NODE_CODE NODE_CODE, NODE_LEVEL, PROJ_STAGE,
            MAIN_RESPONSIBILITY,CONTROL_TYPE, DUTY_DEPARTMENT_ID, DUTY_DEPARTMENT, neb.PLAN_START_DATE PLAN_START_DATE,
            neb.PLAN_END_DATE PLAN_END_DATE, IS_DISABLE, DISABLE_TIME, DISABLE_REASON_ID, STANDARD_SCORE,
            REFERENCE_DATE_NODE_ID, REFERENCE_DAY, PRECONDITION_REMARK, IS_CONTAINS_PERMIT, pn.PERMIT_TYPE,
            COMPLETION_STANDARD, COMPLETION_RESULTS_REMARK, INPUT_CONDITION, pn.OTHER_REMARK, sysdate CREATED,
            pn.CREATOR_ID, pn.CREATOR, pn.MODIFIED, pn.MODIFIER_ID, pn.MODIFIER, pn.PLAN_VERSION, pn.IS_DELETE,
            DISABLE_REASON, pn.ORIGINAL_PLAN_ID, pn.COMPANY_NAME, pn.COMPANY_ID, null ACTUAL_END_DATE,
            null ACTUAL_START_DATE, null FEEDBACK_ID,  pn.ORIGINAL_NODE_ID FISSION_SOURCE_ORIGINAL_ID
        from POM_PROJ_PLAN_NODE pn
                 inner join (
            select neb1.NODE_ID, neb1.PLAN_START_DATE, neb1.PLAN_END_DATE,
                   wm_concat(neb1.BUILD_NAME) BUILD_NAME
            from (
                     select mb.BUILD_NAME, neb1.NODE_ID, neb1.PLAN_START_DATE, neb1.PLAN_END_DATE
                     from POM_NEXT_EVIDENCE_BUILD neb1
                              left join MDM_BUILD mb on mb.ID = neb1.BUILD_ID
                     order by NODE_ID, mb.BUILD_NAME
                 ) neb1
            group by neb1.NODE_ID, neb1.PLAN_START_DATE, neb1.PLAN_END_DATE
        ) neb on neb.NODE_ID = pn.ID
        where pn.id = oldId and pn.IS_CONTAINS_PERMIT = 1 and neb.PLAN_END_DATE is not null;
    end if;
end;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_GET_BUSINESS_TREE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_GET_BUSINESS_TREE" (
    IS_NEED_AUTHENTICATE IN VARCHAR2,
    BIZ_CODE IN VARCHAR2,
    CURRENT_USER_ID IN VARCHAR2,
    CURRENT_STATION_ID IN VARCHAR2,
    CURRENT_DEPARTMENT_ID IN VARCHAR2,
    CURRENT_COMPANY_ID IN VARCHAR2,
    TOP_ORG_ID IN VARCHAR2,
    BUSINESS_TREE OUT SYS_REFCURSOR
)
IS
    DATA_AUTH_SPID VARCHAR2(200);
    START_ORG_ID VARCHAR2(36);
BEGIN
    IF TOP_ORG_ID IS NULL THEN
        START_ORG_ID:= '003200000000000000000000000000';
    ELSE
        START_ORG_ID := TOP_ORG_ID;
    END IF;
    IF IS_NEED_AUTHENTICATE = '1' THEN
        P_SYS_GET_COMPANY_PROJ_SPID(
            USERID => CURRENT_USER_ID,
            STATIONID => CURRENT_STATION_ID,
            DEPTID => CURRENT_DEPARTMENT_ID,
            COMPANYID => CURRENT_COMPANY_ID,
            BIZCODE => BIZ_CODE,
            DATA_AUTH_SPID => DATA_AUTH_SPID
          );
        OPEN BUSINESS_TREE FOR 
            SELECT 
                ID,
                ORG_NAME,
                PARENT_ID,
                IS_COMPANY,
                ORG_TYPE
            FROM SYS_BUSINESS_UNIT UNIT
            LEFT JOIN (SELECT DISTINCT ORG_ID AS ORGID FROM  TMP_AUTH_LIST WHERE ID = DATA_AUTH_SPID) TAL ON UNIT.ID = TAL.ORGID
            WHERE TAL.ORGID IS NOT NULL
            START WITH UNIT.ID= START_ORG_ID
            CONNECT BY PRIOR UNIT.ID=UNIT.PARENT_ID ORDER BY ORDER_HIERARCHY_CODE ASC;
    ELSE 
    OPEN BUSINESS_TREE FOR 
        SELECT 
            ID,
            ORG_NAME,
            PARENT_ID,
            IS_COMPANY,
            ORG_TYPE
        FROM SYS_BUSINESS_UNIT start with id=START_ORG_ID  connect by prior id=parent_id ORDER BY ORDER_HIERARCHY_CODE ASC;
    END IF;
END P_POM_GET_BUSINESS_TREE;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_GET_COMPANY_BYUNIT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_GET_COMPANY_BYUNIT" (
    unitids    IN         CLOB,
    authcode   IN         VARCHAR2,
    currentuserid         IN	       VARCHAR2,--用户ID 鉴权使用
    currentcompanyid      IN           VARCHAR2,--用户公司ID  鉴权使用
    currentdeptid         IN           VARCHAR2,--用户部门ID  鉴权使用
    currentstationid      IN           VARCHAR2,--用户岗位ID  鉴权使用
    items      OUT        SYS_REFCURSOR
) AS
    V_SPID      VARCHAR2(200);
BEGIN
    P_AUTH_BLOCK_PROJ_COMPANY(
            USERID => currentuserid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => authcode,
            DATA_SPID_ID => v_spid
        );
    open items for
        select sbu.ORG_NAME "label", sbu.id "value", PARENT_ID AS "parentId", nvl(sp.cnt, 0) "cnt"
        from SYS_BUSINESS_UNIT sbu
        inner join TMP_AUTH_LIST tal on tal.ORG_ID = sbu.ID
        left join (
            select topId, sum(nvl(cnt, 0)) cnt
            from (
                select ID, connect_by_root (ID) topId, ORDER_HIERARCHY_CODE orderCode
                from (
                    select sbu1.*, min(LEVEL_RANK) over () minLevelRank
                    from SYS_BUSINESS_UNIT sbu1
                    where sbu1.IS_COMPANY = 1
                      and LEVEL_RANK > 2
                ) sbu2
                start with LEVEL_RANK = sbu2.minLevelRank
                connect by prior sbu2.ID = sbu2.PARENT_ID
                order by orderCode
            ) sb left join (
                select UNIT_ID, count(*) cnt
                from SYS_PROJECT
                group by UNIT_ID
            ) cp on sb.ID = cp.UNIT_ID
            group by topId
        ) sp on sp.topId = sbu.ID
        where tal.ID = V_SPID and IS_COMPANY = 1 and LEVEL_RANK = 3
          and instr(unitids, sbu.PARENT_ID) > 0 and cnt > 0;
END p_pom_get_company_byunit;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_GET_DEPARTMENT_TREE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_GET_DEPARTMENT_TREE" 
(
    TOP_DEPARTMENT_ID IN VARCHAR2,
    IS_NEED_AUTHENTICATE IN VARCHAR2,
    BIZ_CODE IN VARCHAR2,
    CURRENT_USER_ID IN VARCHAR2,
    CURRENT_STATION_ID IN VARCHAR2,
    CURRENT_DEPARTMENT_ID IN VARCHAR2,
    CURRENT_COMPANY_ID IN VARCHAR2,
    DEPARTMENT_TREE OUT SYS_REFCURSOR
)
IS
DATA_AUTH_SPID VARCHAR2(200);
BEGIN
    IF IS_NEED_AUTHENTICATE = '1' THEN
        P_SYS_GET_COMPANY_PROJ_SPID(
            USERID => CURRENT_USER_ID,
            STATIONID => CURRENT_STATION_ID,
            DEPTID => CURRENT_DEPARTMENT_ID,
            COMPANYID => CURRENT_COMPANY_ID,
            BIZCODE => BIZ_CODE,
            DATA_AUTH_SPID => DATA_AUTH_SPID
          );
        OPEN DEPARTMENT_TREE FOR
            SELECT
                ID AS "orgId",
                ORG_NAME AS "orgName",
                PARENT_ID AS "parentId",
                IS_COMPANY AS "isCompany",
                ORG_TYPE AS "orgType",
                ID AS "id",
                ORDER_HIERARCHY_CODE
            FROM SYS_BUSINESS_UNIT UNIT
            LEFT JOIN (SELECT DISTINCT ORG_ID AS ORGID FROM  TMP_AUTH_LIST WHERE ID = DATA_AUTH_SPID) TAL ON UNIT.ID = TAL.ORGID
            WHERE TAL.ORGID IS NOT NULL AND IS_COMPANY = 0 AND  PARENT_ID = TOP_DEPARTMENT_ID
            START WITH UNIT.ID= TOP_DEPARTMENT_ID
            CONNECT BY PRIOR UNIT.ID=UNIT.PARENT_ID ORDER BY ORDER_HIERARCHY_CODE ASC;
    ELSE
        OPEN DEPARTMENT_TREE FOR
            SELECT
                ID AS "orgId",
                ORG_NAME AS "orgName",
                PARENT_ID AS "parentId",
                IS_COMPANY AS "isCompany",
                ORG_TYPE AS "orgType",
                ID as "id",
                ORDER_HIERARCHY_CODE
            FROM SYS_BUSINESS_UNIT UNIT
            WHERE  IS_COMPANY = 0 AND  PARENT_ID = TOP_DEPARTMENT_ID
            START WITH UNIT.ID= TOP_DEPARTMENT_ID
            CONNECT BY PRIOR UNIT.ID=UNIT.PARENT_ID ORDER BY ORDER_HIERARCHY_CODE ASC;
    END IF;

END P_POM_GET_DEPARTMENT_TREE;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_GET_MY_WATCHLIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_GET_MY_WATCHLIST" 
(
    watcherID IN VARCHAR2,
    planType in VARCHAR2,
    completeStatus IN VARCHAR2,
    nodeLevel IN VARCHAR2,
    pageSize IN INT,
    pageIndex IN INT,
    items OUT SYS_REFCURSOR
)
    IS
    v_begin int;
    v_end   int;
BEGIN
    v_begin := pageSize * (pageIndex - 1) + 1;
    v_end := pageSize * pageIndex;



    open items for
        SELECT * FROM
            (
                SELECT ROWNUM AS rn,X.* FROM (
                                                 select * from (
                                                                   SELECT A.PLAN_TYPE       as "planType",
                                                                          B.ID                     AS "id",
                                                                          TO_CHAR(B.PLAN_END_DATE, 'YYYY-MM-DD')          AS "planEndDate",
                                                                          B.ORIGINAL_NODE_ID       AS "originalNodeId",
                                                                          B.NODE_NAME              AS "nodeName",
                                                                          TO_CHAR(D.CHARGE_PERSON) AS "chargePerson",
                                                                          TO_CHAR(E.MODIFIED, 'YYYY-MM-DD')     as "finalFeedBack",
                                                                          A.APPROVAL_STATUS        AS APPROVAL_STATUS,
                                                                          C.WATCHER_ID,
                                                                          case when
                                                                                           B.NODE_LEVEL = '里程碑' or
                                                                                           B.NODE_LEVEL = '一级节点' or
                                                                                           B.NODE_LEVEL = '二级节点' or
                                                                                           B.NODE_LEVEL = '三级节点' then
                                                                                   B.NODE_LEVEL
                                                                               else '其他' end as NODE_LEVEL,
                                                                          CASE
                                                                              WHEN B.ACTUAL_END_DATE IS NOT NULL THEN
                                                                                  '已完成'
                                                                              WHEN TO_DATE(TO_CHAR(SYSDATE, 'YYYY-MM-DD'), 'YYYY-MM-DD') -
                                                                                   TO_DATE(TO_CHAR(B.PLAN_END_DATE, 'YYYY-MM-DD'), 'YYYY-MM-DD') > 0 AND
                                                                                   B.ACTUAL_END_DATE IS NULL THEN
                                                                                  '已超期'
                                                                              ELSE
                                                                                  '未完成'
                                                                              END                  AS "completeStatus"
                                                                   FROM POM_PROJ_PLAN_NODE B
                                                                            LEFT JOIN POM_PROJ_PLAN A ON A.ID = B.PROJ_PLAN_ID
                                                                            LEFT JOIN SYS_BIZ_WATCH C
                                                                                      ON B.ORIGINAL_NODE_ID = C.BIZ_ID
                                                                            LEFT JOIN (SELECT M.NODE_ID, WM_CONCAT(M.CHARGE_PERSON) AS CHARGE_PERSON
                                                                                       FROM POM_NODE_CHARGE_PERSON M
                                                                                       GROUP BY M.NODE_ID) D
                                                                                      ON D.NODE_ID = B.ID
                                                                            LEFT JOIN (SELECT FEEDBACK_NODE_ID, MAX(MODIFIED) AS MODIFIED
                                                                                       FROM POM_NODE_FEEDBACK
                                                                                       GROUP BY FEEDBACK_NODE_ID) E
                                                                                      ON E.FEEDBACK_NODE_ID = B.ID
                                                                   where APPROVAL_STATUS = '已审核' and C.IS_UN_WATCH = 0 and C.WATCHER_ID = watcherID
                                                                   union
                                                                   SELECT '专项计划'                   AS "planType",
                                                                          B.ID                     AS "id",
                                                                          TO_CHAR(B.PLAN_END_DATE, 'YYYY-MM-DD')          AS "planEndDate",
                                                                          B.ORIGINAL_NODE_ID       AS "originalNodeId",
                                                                          B.NODE_NAME              AS "nodeName",
                                                                          TO_CHAR(D.CHARGE_PERSON) AS "chargePerson",
                                                                          TO_CHAR(E.MODIFIED, 'YYYY-MM-DD')     as "finalFeedBack",
                                                                          A.APPROVAL_STATUS        AS APPROVAL_STATUS,
                                                                          C.WATCHER_ID,
                                                                          '其他'                       AS NODE_LEVEL,
                                                                          CASE
                                                                              WHEN B.ACTUAL_END_DATE IS NOT NULL THEN
                                                                                  '已完成'
                                                                              WHEN TO_DATE(TO_CHAR(SYSDATE, 'YYYY-MM-DD'), 'YYYY-MM-DD') -
                                                                                   TO_DATE(TO_CHAR(B.PLAN_END_DATE, 'YYYY-MM-DD'), 'YYYY-MM-DD') > 0 AND
                                                                                   B.ACTUAL_END_DATE IS NULL THEN
                                                                                  '已超期'
                                                                              ELSE
                                                                                  '未完成'
                                                                              END                  AS "completeStatus"
                                                                   FROM POM_SPECIAL_PLAN_NODE B
                                                                            LEFT JOIN POM_SPECIAL_PLAN A ON B.PLAN_ID = A.ID
                                                                            LEFT JOIN SYS_BIZ_WATCH C
                                                                                      ON B.ORIGINAL_NODE_ID = C.BIZ_ID
                                                                            LEFT JOIN (SELECT M.NODE_ID, WM_CONCAT(M.CHARGE_PERSON) AS CHARGE_PERSON
                                                                                       FROM POM_NODE_CHARGE_PERSON M
                                                                                       GROUP BY M.NODE_ID) D
                                                                                      ON D.NODE_ID = B.ID
                                                                            LEFT JOIN (SELECT FEEDBACK_NODE_ID, MAX(MODIFIED) AS MODIFIED
                                                                                       FROM POM_NODE_FEEDBACK
                                                                                       GROUP BY FEEDBACK_NODE_ID) E
                                                                                      ON E.FEEDBACK_NODE_ID = B.ID
                                                                   where APPROVAL_STATUS = '已审核' and C.IS_UN_WATCH = 0 and C.WATCHER_ID = watcherID
                                                                   union
                                                                   SELECT '部门月度计划'                 AS "planType",
                                                                          B.ID                     AS "id",
                                                                          TO_CHAR(B.PLAN_END_DATE, 'YYYY-MM-DD')          AS "planEndDate",
                                                                          B.ORIGINAL_NODE_ID       AS "originalNodeId",
                                                                          B.NODE_NAME              AS "nodeName",
                                                                          TO_CHAR(D.CHARGE_PERSON) AS "chargePerson",
                                                                          TO_CHAR(E.MODIFIED, 'YYYY-MM-DD')     as "finalFeedBack",
                                                                          A.APPROVE_STATUS         AS APPROVAL_STATUS,
                                                                          C.WATCHER_ID,
                                                                          case when
                                                                                           B.SOUCE_NODE_LEVEL = '里程碑' or
                                                                                           B.SOUCE_NODE_LEVEL = '一级节点' or
                                                                                           B.SOUCE_NODE_LEVEL = '二级节点' or
                                                                                           B.SOUCE_NODE_LEVEL = '三级节点' then
                                                                                   B.SOUCE_NODE_LEVEL
                                                                               else '其他' end as NODE_LEVEL,
                                                                          CASE
                                                                              WHEN B.ACTUAL_END_DATE IS NOT NULL THEN
                                                                                  '已完成'
                                                                              WHEN TO_DATE(TO_CHAR(SYSDATE, 'YYYY-MM-DD'), 'YYYY-MM-DD') -
                                                                                   TO_DATE(TO_CHAR(B.PLAN_END_DATE, 'YYYY-MM-DD'), 'YYYY-MM-DD') > 0 AND
                                                                                   B.ACTUAL_END_DATE IS NULL THEN
                                                                                  '已超期'
                                                                              ELSE
                                                                                  '未完成'
                                                                              END                  AS "completeStatus"
                                                                   FROM POM_DEPT_MONTHLY_PLAN_NODE B
                                                                            LEFT JOIN POM_DEPT_MONTHLY_PLAN A ON A.ID = B.DEPT_MONTHLY_PLAN_ID
                                                                            LEFT JOIN SYS_BIZ_WATCH C
                                                                                      ON B.ORIGINAL_NODE_ID = C.BIZ_ID
                                                                            LEFT JOIN (SELECT M.NODE_ID, WM_CONCAT(M.CHARGE_PERSON) AS CHARGE_PERSON
                                                                                       FROM POM_NODE_CHARGE_PERSON M
                                                                                       GROUP BY M.NODE_ID) D
                                                                                      ON D.NODE_ID = B.ID
                                                                            LEFT JOIN (SELECT FEEDBACK_NODE_ID, MAX(MODIFIED) AS MODIFIED
                                                                                       FROM POM_NODE_FEEDBACK
                                                                                       GROUP BY FEEDBACK_NODE_ID) E
                                                                                      ON E.FEEDBACK_NODE_ID = B.ID
                                                                   where APPROVE_STATUS = '已审核' and C.IS_UN_WATCH = 0 and C.WATCHER_ID = watcherID
                                                               )total
                                                 where instr(nodeLevel, total.NODE_LEVEL)<>0
                                                  and instr(planType, total."planType")<>0
                                                  and instr(completeStatus, total."completeStatus")<>0
                                                 ORDER BY total."planEndDate" DESC
                                             )X
            )Y where Y.rn >= v_begin  AND Y.rn <= v_end;


END P_POM_GET_MY_WATCHLIST;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_GET_PLAN_ALLINFO
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_GET_PLAN_ALLINFO" (

    projids               IN           CLOB,--所属项目

    isstocktrade          IN           VARCHAR2,--是否操盘

    plantype              IN           VARCHAR2,--计划类型

    nodelevel             IN           VARCHAR2,--任务级别

    finishstatus          IN           VARCHAR2,--完成状态

    isoverdue             IN           VARCHAR2,--是否超期

    planfinishdatebegin   IN           VARCHAR2,--计划完成日期

    planfinishdateend     IN           VARCHAR2,

    actualfinishdatebegin IN           VARCHAR2,--实际完成日期

    actualfinishdateend   IN           VARCHAR2,

    licensetype           IN           VARCHAR2,--证照类型

    licensenode           IN           VARCHAR2,--证照节点

    authcode              IN           VARCHAR2,--鉴权CODE

    currentuserid         IN	       VARCHAR2,--用户ID 鉴权使用

    currentcompanyid      IN           VARCHAR2,--用户公司ID  鉴权使用

    currentdeptid         IN           VARCHAR2,--用户部门ID  鉴权使用

    currentstationid      IN           VARCHAR2,--用户岗位ID  鉴权使用

    searchcondition       IN           VARCHAR2,--搜索条件


    pageindex             IN           INT,

    pagesizes             IN           INT,

    total                OUT           INT,

    items  OUT SYS_REFCURSOR

)

AS

    v_projid clob;

    v_projids clob;

    v_isstocktrade varchar(200) := isstocktrade;

    v_plantype CLOB;

    v_nodelevel CLOB;

    v_licensetype  CLOB;

    v_sql      CLOB;

    v_sql_exec_paging   CLOB;

    v_spid     VARCHAR2(200);--数据权限验证spid

    v_where     CLOB;

    traderSql   varchar(500);

BEGIN

    execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd hh24:mi:ss''';

    --1、调用鉴权的存储过程

    P_SYS_AUTH_DATA_RULE_SPID(

            USERID => currentuserid,

            STATIONID => currentstationid,

            DEPTID => currentdeptid,

            COMPANYID => currentcompanyid,

            BIZCODE => authcode,

            DATA_AUTH_SPID => v_spid

        );

    if projids is not null then

        FOR item IN (

            SELECT regexp_substr('' || projids || '', '[^,]+', 1, ROWNUM) AS id

            FROM dual

            CONNECT BY ROWNUM <= length('' || projids || '')

                                     - length(regexp_replace('' || projids || '', ',', '')) + 1

            )

            LOOP

                IF ( v_projids IS NULL ) THEN

                    v_projids := ''''|| item.id || '''';

                ELSE

                    v_projids := v_projids || ',' || '''' || item.id || '''';

                END IF;

            END LOOP;

        v_projid := '(' || v_projids || ')';

        v_where :=v_where||' AND stage.project_id IN'|| v_projid||' ';

    end if;

    IF plantype is not null then

        FOR item IN (

            SELECT

                regexp_substr(''

                                  || plantype

                                  || '', '[^,]+', 1, ROWNUM) AS type

            FROM

                dual

            CONNECT BY

                    ROWNUM <= length(''

                    || plantype

                    || '') - length(regexp_replace(''

                                                       || plantype

                                                       || '', ',', '')) + 1

            ) LOOP IF ( v_plantype IS NULL ) THEN

            v_plantype := ''''

                || item.type

                || '''';

        ELSE

            v_plantype := v_plantype

                || ','

                || ''''

                || item.type

                || '''';

        END IF;

            END LOOP;

        IF v_where is null then

            v_where :=' AND plan.plan_type IN ('|| v_plantype||') ';

        ELSE

            v_where :=v_where||' AND plan.plan_type IN ('|| v_plantype||') ';

        END IF;

    END IF;

    IF nodelevel is not null then

        FOR item IN (

            SELECT

                regexp_substr(''

                                  || nodelevel

                                  || '', '[^,]+', 1, ROWNUM) AS type

            FROM

                dual

            CONNECT BY

                    ROWNUM <= length(''

                    || nodelevel

                    || '') - length(regexp_replace(''

                                                       || nodelevel

                                                       || '', ',', '')) + 1

            ) LOOP IF ( v_nodelevel IS NULL ) THEN

            v_nodelevel := ''''

                || item.type

                || '''';

        ELSE

            v_nodelevel := v_nodelevel

                || ','

                || ''''

                || item.type

                || '''';

        END IF;

            END LOOP;

        IF v_where is null then

            v_where :=' AND node.node_level IN ('|| v_nodelevel||') ';

        ELSE

            v_where :=v_where||' AND node.node_level IN ('|| v_nodelevel||') ';

        END IF;

    END IF;

    IF licensetype is not null then

        FOR item IN (

            SELECT

                regexp_substr(''

                                  || licensetype

                                  || '', '[^,]+', 1, ROWNUM) AS type

            FROM

                dual

            CONNECT BY

                    ROWNUM <= length(''

                    || licensetype

                    || '') - length(regexp_replace(''

                                                       || licensetype

                                                       || '', ',', '')) + 1

            ) LOOP IF ( v_licensetype IS NULL ) THEN

            v_licensetype := ''''

                || item.type

                || '''';

        ELSE

            v_licensetype := v_licensetype

                || ','

                || ''''

                || item.type

                || '''';

        END IF;

            END LOOP;

        IF v_where is null then

            v_where :=' AND node.PERMIT_TYPE IN ('|| v_licensetype||') ';

        ELSE

            v_where :=v_where||' AND node.PERMIT_TYPE IN ('|| v_licensetype||') ';

        END IF;

    END IF;

    --3、条件拼接

    --是否操盘

    if v_isstocktrade is not null then

        traderSql := ' and (1 = 0';

        v_isstocktrade := replace(v_isstocktrade, '不操盘', 'S1');

        -- 替换"不操盘", 避免错误判断

        IF instr(v_isstocktrade, '操盘') > 0 then

            traderSql := traderSql||' OR proj.PROJ_COOPERATE =''操盘''';

        end if;

        IF instr(v_isstocktrade, 'S1') > 0 THEN

            traderSql := traderSql||' OR proj.PROJ_COOPERATE =''不操盘''';

        end if;

        IF instr(v_isstocktrade, '其他') > 0 THEN

            traderSql := traderSql||' OR (proj.PROJ_COOPERATE <> ''操盘'' AND proj.PROJ_COOPERATE <> ''不操盘'')';

        END IF;

        traderSql := traderSql || ')';

        v_where := v_where || traderSql;

    end if;

    --是否超期

    IF isoverdue = '是' then

        IF v_where is null then

            v_where :=' AND sysdate > node.plan_end_date

                       and (node.ACTUAL_END_DATE is null or node.ACTUAL_END_DATE > node.plan_end_date)';

        ELSE

            v_where :=v_where||' AND sysdate > node.plan_end_date

                       and (node.ACTUAL_END_DATE is null or node.ACTUAL_END_DATE > node.plan_end_date)';

        END IF;

    ELSIF isoverdue = '否' THEN

        IF v_where is null then

            v_where :=' AND sysdate < node.plan_end_date and

                        (node.ACTUAL_END_DATE is null or node.ACTUAL_END_DATE <= node.plan_end_date)';

        ELSE

            v_where :=v_where||' AND sysdate < node.plan_end_date

                        (node.ACTUAL_END_DATE is null or node.ACTUAL_END_DATE <= node.plan_end_date)';

        END IF;

    END IF;

    --完成状态

    IF finishstatus ='已完成' then

        IF v_where is null then

            v_where :=' AND node.actual_end_date IS NOT NULL ';

        ELSE

            v_where :=v_where||' AND node.actual_end_date IS NOT NULL ';

        END IF;

    ELSIF finishstatus ='未完成' THEN

        IF v_where is null then

            v_where :=' AND node.actual_end_date IS  NULL ';

        ELSE

            v_where :=v_where||' AND node.actual_end_date IS  NULL ';

        END IF;

    END IF;

    IF planfinishdatebegin is not null then

        IF v_where is null then

            v_where :=' AND node.plan_end_date > to_date('''||planfinishdatebegin||''',''yyyy-mm-dd hh24:mi:ss'') AND node.plan_end_date < to_date('''||planfinishdateend||''',''yyyy-mm-dd hh24:mi:ss'') ';

        ELSE

            v_where :=v_where||' AND node.plan_end_date >to_date('''||planfinishdatebegin||''',''yyyy-mm-dd hh24:mi:ss'') AND node.plan_end_date < to_date('''||planfinishdateend||''',''yyyy-mm-dd hh24:mi:ss'') ';

        END IF;

    END IF;

    IF actualfinishdatebegin is not null then

        IF v_where is null then

            v_where :=' AND node.actual_end_date >=to_date( '''||actualfinishdatebegin||''',''yyyy-mm-dd hh24:mi:ss'') AND node.actual_end_date <=to_date('''||actualfinishdateend||''',''yyyy-mm-dd hh24:mi:ss'') ';

        ELSE

            v_where :=v_where||' AND node.actual_end_date >=to_date('''||actualfinishdatebegin||''',''yyyy-mm-dd hh24:mi:ss'') AND node.actual_end_date <=to_date('''||actualfinishdateend||''',''yyyy-mm-dd hh24:mi:ss'') ';

        END IF;

    END IF;

    IF licensenode = 1 then

        IF v_where is null then

            v_where :=' AND node.FISSION_SOURCE_ORIGINAL_ID IS  NULL AND node.IS_CONTAINS_PERMIT=1 ';

        ELSE

            v_where :=v_where||' AND node.FISSION_SOURCE_ORIGINAL_ID IS  NULL AND node.IS_CONTAINS_PERMIT=1 ';

        END IF;

    ELSIF licensenode = 2 then

        IF v_where is null then

            v_where :=' AND node.FISSION_SOURCE_ORIGINAL_ID IS NOT NULL ';

        ELSE

            v_where :=v_where||' AND node.FISSION_SOURCE_ORIGINAL_ID IS NOT NULL ';

        END IF;

    ELSIF licensenode = 3 then

        IF v_where is null then

            v_where :=' AND( node.IS_CONTAINS_PERMIT=1 OR node.FISSION_SOURCE_ORIGINAL_ID IS NOT NULL) ';

        ELSE

            v_where :=v_where||' AND ( node.IS_CONTAINS_PERMIT=1 OR node.FISSION_SOURCE_ORIGINAL_ID IS NOT NULL) ';

        END IF;
    ELSIF licensenode = 4 then
       IF v_where is null then

            v_where :=' AND node.FISSION_SOURCE_ORIGINAL_ID IS  NULL ';

        ELSE

            v_where :=v_where||' AND node.FISSION_SOURCE_ORIGINAL_ID IS NULL ';

        END IF;
    END IF;

    IF searchcondition is not null  THEN
--20201221李小聪调整，筛选条件支持空格拆分
        IF v_where is null then
  v_where :=' AND (node.node_name like ''%'
						||REPLACE(searchcondition,' ','%'' OR node.node_name like  ''%')||'%'''  
						||'OR plan.plan_name like ''%'||REPLACE(searchcondition,' ','%'' OR plan.plan_name like  ''%')||'%'''  
						||'OR biz.org_name  like ''%'||REPLACE(searchcondition,' ','%'' OR biz.org_name like  ''%')||'%'''  
						||' OR business.org_name  like ''%'||REPLACE(searchcondition,' ','%'' OR biz.org_name like  ''%')||'%'' ) ';
						sys.dbms_output.put_line(v_where);
        ELSE
            v_where :=v_where
						||'  AND (node.node_name like ''%'||REPLACE(searchcondition,' ','%'' OR node.node_name like  ''%')||'%''' 
						||'OR plan.plan_name like ''%'||REPLACE(searchcondition,' ','%'' OR plan.plan_name like  ''%')||'%''' 
						||'OR biz.org_name  like ''%'||REPLACE(searchcondition,' ','%'' OR biz.org_name like  ''%')||'%'''
						||'OR business.org_name  like ''%'||REPLACE(searchcondition,' ','%'' OR biz.org_name like  ''%')||'%'') ';
							sys.dbms_output.put_line(v_where);
        END IF;

    END IF;

    --4、sql拼接

    v_sql:='SELECT rownum as rowno, ta.* FROM(

    SELECT

    CASE

 --未到期不亮灯

                WHEN node.actual_end_date IS NULL

                     AND trunc(SYSDATE) - trunc(node.plan_end_date) <= 0 THEN

                    ''''

 --到期当天内完成反馈

                WHEN node.actual_end_date IS NOT NULL

                     AND ( trunc(node.actual_end_date) - trunc(node.plan_end_date) ) <= 0 THEN

                    ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''

  --到期1-5天内完成反馈

                WHEN node.actual_end_date IS NOT NULL

                     AND ( trunc(node.actual_end_date) - trunc(node.plan_end_date) ) BETWEEN 1 AND 5 THEN

                    ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''

 --到期未反馈黄灯

                WHEN node.actual_end_date IS NULL

                     AND ( trunc(SYSDATE) - trunc(node.plan_end_date) ) BETWEEN 1 AND 5 THEN

                    ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''

  --到期超过5天未反馈红灯

                WHEN node.actual_end_date IS NULL

                     AND ( ( trunc(SYSDATE) - trunc(node.plan_end_date) ) > 5 ) THEN

                    ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''

                ELSE

                    ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''

      END as "warning",--预警状态

      CASE

 --未到期不亮灯

                WHEN node.actual_end_date IS NULL

                     AND trunc(SYSDATE) - trunc(node.plan_end_date) <= 0 THEN

                    ''''

 --到期当天内完成反馈

                WHEN node.actual_end_date IS NOT NULL

                     AND ( trunc(node.actual_end_date) - trunc(node.plan_end_date) ) <= 0 THEN

                    ''绿灯''

  --到期1-5天内完成反馈

                WHEN node.actual_end_date IS NOT NULL

                     AND ( trunc(node.actual_end_date) - trunc(node.plan_end_date) ) BETWEEN 1 AND 5 THEN

                    ''黄灯''

 --到期未反馈黄灯

                WHEN node.actual_end_date IS NULL

                     AND ( trunc(SYSDATE) - trunc(node.plan_end_date) ) BETWEEN 1 AND 5 THEN

                    ''黄灯''

  --到期超过5天未反馈红灯

                WHEN node.actual_end_date IS NULL

                     AND ( ( trunc(SYSDATE) - trunc(node.plan_end_date) ) > 5 ) THEN

                    ''红灯''

                ELSE

                    ''红灯''

      END as "warningText",--预警状态文本

     plan.plan_name AS   "planName",--计划名称

     ''/pom/pom-proj-plan/research-plan/plan?planType=''||plan.plan_type||''&id=''||plan.id||''&cancelType=0'' as "planNameOpenUrl",

     plan.plan_type AS   "planType",--计划类型

    node.node_name as "nodeName",--任务名称

    case when plan.plan_type=''关键节点计划'' then

        ''/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id=''||plan.id||''&feedbackNodeId=''||node.id||''&feedbackNodeOriginalId=''||node.ORIGINAL_NODE_ID||''&nodeSourcePlanType=0''

        when plan.plan_type=''项目主项计划'' then

        ''/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id=''||plan.id||''&feedbackNodeId=''||node.id||''&feedbackNodeOriginalId=''||node.ORIGINAL_NODE_ID||''&nodeSourcePlanType=1''

        END

        as "nodeNameOpenUrl",

    node.node_code as "nodeCode",

    case when node.ACTUAL_END_DATE is null then ''未完成'' else ''已完成'' end as "nodeState",--完成 状态

    to_char(node.plan_end_date,''yyyy-MM-dd'') as "planEndDate",--计划完成日期

    to_char(back.estimate_end_time,''yyyy-MM-dd'') AS   "estimateEndTime",--预计完成日期

    to_char(node.actual_end_date,''yyyy-MM-dd'') AS   "actualEndDate",--实际完成日期

    node.NODE_LEVEL AS "nodeLevel",--任务级别

    (select count(id) from pom_node_feedback where feedback_node_id=node.id AND feedback_type=''PROCESS'') AS   "processCount",--过程反馈次数

    (select count(id) from pom_node_feedback where feedback_node_id=node.id AND feedback_type=''CARRY_OUT'') AS   "carryOutCount",--完成反馈次数

    (select count(id) from pom_node_feedback where feedback_node_id=node.id AND feedback_type=''EXPIRED'') AS   "expiredCount",--超期未完成反馈次数

     node.duty_department_id as   "dutyDeptId",--主责部门

     node.duty_department AS   "dutyDept",

     person.CHARGE_PERSON AS    "chargePerson",--主责人

     --person.CHARGE_PERSON_id AS    "chargePersonId",lixc20201102修改

     node.standard_score AS   "standardScore",--标准分值

     exam.examination_score AS   "actualScore",--实际得分

     node.completion_standard AS   "completionStandard",--完成要求

     node.completion_results_remark AS   "completionResultsRemark",--完成成果说明

     plan.company_id AS   "areaCompanyId",

     plan.company_name AS "areaCompanyName",

     biz.order_hierarchy_code AS "areaOrderCode",

     business.order_hierarchy_code AS "companyOrderCode",--

     case when biz.level_rank=1 then

          plan.company_id

     when biz.level_rank <>1 then

          biz.id end AS   "companyId",

      case when biz.level_rank=1 then

          plan.company_name

      when biz.level_rank <>1  then

          biz.org_name end AS   "companyName"

FROM

    pom_proj_plan plan inner join pom_proj_plan_node node on plan.id=node.proj_plan_id

    LEFT JOIN (

        select FEEDBACK_NODE_ID, max(estimate_end_time) estimate_end_time

        from POM_NODE_FEEDBACK

        group by FEEDBACK_NODE_ID) back on node.id=back.feedback_node_id

    LEFT JOIN pom_node_examination   exam ON exam.node_id = node.id

    LEFT JOIN SYS_PROJECT_STAGE stage on plan.proj_id=stage.id

    INNER JOIN SYS_PROJECT proj on stage.project_id = proj.id

  --主责人查询 lixc20201102修改

LEFT   JOIN

(SELECT M.NODE_ID,listagg(M.CHARGE_PERSON,'','') WITHIN  GROUP (ORDER BY CHARGE_PERSON) AS CHARGE_PERSON

						 FROM   POM_NODE_CHARGE_PERSON M GROUP  BY M.NODE_ID) person  on person.NODE_ID=node.id

    LEFT JOIN sys_business_unit      business ON plan.company_id = business.id

    LEFT JOIN sys_business_unit      biz ON business.parent_id = biz.id

    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal

    on (case when stage.id is not null then stage.PROJECT_ID else plan.proj_id end)=tal.orgId

    WHERE tal.orgId is not null and plan.approval_status=''已审核'' and node.IS_DISABLE = 0 '||v_where||' order by "companyOrderCode", "planName","nodeCode")';

    sys.dbms_output.put_line(v_sql);

    --dbms_output.put_line(v_where);

    EXECUTE IMMEDIATE 'SELECT count(1) from('

        || v_sql

        || ' ta )  '

        INTO total;

    v_sql_exec_paging := '

     select a.* from ( '

        || v_sql

        || ' ta WHERE rownum <= '

        || pageindex * pagesizes

        || ' ) a where a.rowno > '

        || pagesizes * ( pageindex - 1 )

        || '';

    OPEN items FOR  v_sql_exec_paging;

END P_POM_GET_PLAN_ALLINFO;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_GET_PORTAL_COMPLETE_MSG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_GET_PORTAL_COMPLETE_MSG" (
    bizid   IN      VARCHAR2,--业务id-即反馈id
    info    OUT     SYS_REFCURSOR--消息集合
) IS
--已办/已阅/取关消息获取，即（0：待办，10：待阅，20：关注）的已处理数据
--作者：陈丽
--日期：2020/01/09

    nodeid           VARCHAR2(36);
    nodeoriginalid   VARCHAR2(36);
    feedbackerid     VARCHAR2(36);
    ownercode        VARCHAR2(50);
BEGIN

--查询节点id 推送已办消息

  --要和传科沟通调整为原始id，不容易出错
    SELECT
        feedback_node_id,
        feedbacker_id,
        feedback_node_original_id
    INTO
        nodeid,
        feedbackerid,
        nodeoriginalid
    FROM
        pom_node_feedback
    WHERE
        id = bizid;

    dbms_output.put_line('打印' || nodeoriginalid);
    OPEN info FOR SELECT
                      '0' "msgType",--任务类型（0：待办，10：待阅，20：关注）
                      nodeid            AS "taskId",--任务ID
                      b1.user_account   AS "ownerName",--拥有人
                      'v-xufeng' AS "creatorName",--创建人
                      'http://pom.crccre.cn/pom/pom/middle?originalUrl='
                      || url_encode('http://pom.crccre.cn/pom/pom/mission-center-feedback/my-responsible-task?cancelType=0'
                                    || CHR(38)
                                    || 'id='
                                    || a.proj_plan_id
                                    || CHR(38)
                                    || 'feedbackNodeId='
                                    || a.id
                                    || CHR(38)
                                    || 'feedbackNodeOriginalId='
                                    || a.original_node_id
                                    || CHR(38)
                                    || 'nodeSourcePlanType = '
                                    || case when a.plan_type = '关键节点计划' then 0 else 1 end
                                    || '') AS "pcUrl",--应用系统的url地址
                      'https://www.baidu.com' AS "mobileUrl",--应用系统的手机端url地址
                      SYSDATE           AS "created",--创建时间
                      SYSDATE           AS "expireTime",--创建时间
                      SYSDATE           AS "completeTime",--完成时间
                      trunc(SYSDATE) + 1 AS "expireTime",
                      '【节点超期预警】【'
                      || a.proj_name
                      || '-'
                      || a.plan_type
                      || '-'
                      || a.node_name
                      || '】超期'
                      || TO_CHAR(trunc(SYSDATE) - a.plan_end_date)
                      || '天预警' AS "taskName",--任务名称
                      '计划运营' AS "typeName",--任务类型
                      '1' AS "priority",--优先级
                      '测试计划运营推送已办到门户' AS "remark",--备注
                      'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "sourceAppId"--应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段
                  FROM
                      v_pom_node_dt                   a
                      LEFT JOIN sys_role_user_relation_result   b1 ON b1.dept_id = a.duty_department_id
                                                                    AND b1.virtual_group_name = '部门计划专员'
                  WHERE
                      original_node_id = ''
                                         || nodeoriginalid
                                         || '' ;

--    OPEN info FOR SELECT
--                     '0' "msgType",--任务类型（0：待办，10：待阅，20：关注）
--                     '32' AS "taskId",--任务ID
--                     'yuzheng1' AS "ownerName",--拥有人
--                     'v-xufeng' AS "creatorName",--创建人
--                     'https://www.baidu.com' AS "pcUrl",--应用系统的url地址
--                     'https://www.baidu.com' AS "mobileUrl",--应用系统的手机端url地址
--                     SYSDATE   AS "created",--创建时间
--                     SYSDATE   AS "expireTime",--创建时间
--                     SYSDATE   AS "completeTime",--完成时间
--                     trunc(SYSDATE) + 1 AS "expireTime",
--                     '计划运营-测试' AS "taskName",--任务名称
--                     '计划运营' AS "typeName",--任务类型
--                     '1' AS "priority",--优先级
--                     '测试计划运营推送已办到门户' AS "remark",--备注
--                     'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "sourceAppId"--应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段
--                 FROM
--                     dual;

END p_pom_get_portal_complete_msg;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_GET_PROJ_BYSECONDARYUNIT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_GET_PROJ_BYSECONDARYUNIT" (
    companyids    IN         CLOB,
    authcode   IN         VARCHAR2,
    currentuserid         IN         VARCHAR2,--用户ID 鉴权使用
    currentcompanyid      IN           VARCHAR2,--用户公司ID  鉴权使用
    currentdeptid         IN           VARCHAR2,--用户部门ID  鉴权使用
    currentstationid      IN           VARCHAR2,--用户岗位ID  鉴权使用
    items      OUT        SYS_REFCURSOR
) AS
    v_spid      VARCHAR2(200);
BEGIN
    --1、调用鉴权的存储过程
    P_AUTH_BLOCK_PROJ_COMPANY(
            USERID => currentuserid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => authcode,
            DATA_SPID_ID => v_spid
        );
    IF companyids is null then
        open items for
            select *
            from (
                SELECT DISTINCT
                    unit.org_name   AS "label",
                    unit.id AS "value",
                    null AS "parentId",
                    unit.ORDER_HIERARCHY_CODE AS "orderCode"
                from sys_business_unit unit
                inner join sys_project b on unit.id=b.unit_id
                where unit.is_company = 1
                UNION ALL
                SELECT DISTINCT
                    decode(unit.level_rank, 2, unit.org_name||'_'|| a.project_name, a.project_name) "label",
                    a.id AS "value",
                    case
                        when unit.level_rank<4  then a.unit_id
                        when unit.level_rank>=4 AND partunit.level_rank=4  then partunit.parent_id
                        when unit.level_rank>=4 AND partunit.level_rank=3 then partunit.id END  AS "parentId",
                    unit.ORDER_HIERARCHY_CODE AS "orderCode"
                FROM sys_project a
                left join sys_business_unit unit on a.unit_id=unit.id
                left join sys_business_unit partunit on unit.parent_id=partunit.id
                left JOIN (
                    select DISTINCT id AS orgid from sys_business_unit sbu
                    START WITH id in (select DISTINCT org_id AS orgId from TMP_AUTH_LIST where id =v_spid)
                    connect by prior id =parent_id
                )  tal on a.UNIT_ID=tal.orgId
                where tal.orgId is not null
            ) ORDER BY  "orderCode";
    else
        open items for
            select *
            from (
                select
                    ORG_NAME "label",
                    ID "value",
                    case when instr(companyids, ID) > 0 then null else topId end "parentId",
                    orderCode AS "orderCode", topName "topName", topCode "topCode",
                    (sum(pSize) over (partition by topId))-1 cnt, pSize
                from (
                    select ID, ORG_NAME, connect_by_root(ID) topId, connect_by_root(ORG_NAME) topName,
                           connect_by_root(orderCode) topCode, orderCode, 0, pSize
                    from (
                        select ID, ORG_NAME, PARENT_ID, ORDER_HIERARCHY_CODE orderCode, 0 pSize
                        from SYS_BUSINESS_UNIT
                        where IS_COMPANY = 1 and LEVEL_RANK > 2
                        union all select ID, PROJECT_NAME ORG_NAME, UNIT_ID PARENT_ID, PROJECT_CODE orderCode,
                                         1 pSize
                        from SYS_PROJECT
                    ) sbu
                    start with instr(companyids, sbu.ID) > 0
                    connect by prior sbu.ID = sbu.PARENT_ID
                    union (
                        select tn.ID, ORG_NAME, topId, topName, topCode, orderCode,
                               (sum(pSize) over (partition by topId))-1 cnt, pSize
                        from (
                            select ID, ORG_NAME, connect_by_root(ID) topId, connect_by_root(ORG_NAME) topName,
                                   connect_by_root(orderCode) topCode, orderCode, pSize
                            from (
                                select ID, ORG_NAME, PARENT_ID, ORDER_HIERARCHY_CODE orderCode, pSize
                                from SYS_BUSINESS_UNIT sbu
                                inner join (
                                    select unit_id, count(*) pSize from SYS_PROJECT group by unit_id
                                ) on sbu.ID = UNIT_ID
                                where IS_COMPANY = 1 and LEVEL_RANK = 2
                                union all select ID, PROJECT_NAME ORG_NAME, UNIT_ID PARENT_ID, PROJECT_CODE orderCode,
                                                 1 pSize
                                from SYS_PROJECT
                            ) sbu
                            start with instr(companyids, sbu.ID) > 0
                            connect by prior sbu.ID = sbu.PARENT_ID
                        ) tn
                    )
                )
                -- 移除掉三级公司下的四级公司
            )  where "parentId" is null or pSize != 0 order by "topCode","orderCode";
    END IF;
END p_pom_get_proj_bysecondaryunit;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_GET_PROJ_STATUS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_GET_PROJ_STATUS" (IN_PROJ_ID      IN VARCHAR2,
                                                  OUT_PROJ_STATUS OUT VARCHAR2) IS

  V_GGZ_END_DATE VARCHAR2(100);
  V_KG_END_DATE  VARCHAR2(100);
  V_YSZ_END_DATE VARCHAR2(100);
  V_JG_END_DATE  VARCHAR2(100);
  V_JF_END_DATE  VARCHAR2(100);

BEGIN
  SELECT D1.ACTUAL_END_DATE AS GGZ_END_DATE,
         D2.ACTUAL_END_DATE AS KG_END_DATE,
         D3.ACTUAL_END_DATE AS YSZ_END_DATE,
         D4.ACTUAL_END_DATE AS JG_END_DATE,
         D5.ACTUAL_END_DATE AS JF_END_DATE
  INTO V_GGZ_END_DATE, V_KG_END_DATE, V_YSZ_END_DATE, V_JG_END_DATE,
       V_JF_END_DATE
  FROM SYS_PROJECT A
  INNER JOIN SYS_PROJECT_STAGE B
  ON A.ID = B.PROJECT_ID
  INNER JOIN POM_PROJ_PLAN C
  ON C.PROJ_ID = B.ID AND C.PLAN_TYPE = '关键节点计划'
  LEFT JOIN POM_PROJ_PLAN_NODE D1
  ON C.ID = D1.PROJ_PLAN_ID AND D1.IS_DELETE = 0 AND
     D1.NODE_NAME = '建设工程规划许可证' AND D1.FISSION_SOURCE_ORIGINAL_ID IS NULL
  LEFT JOIN POM_PROJ_PLAN_NODE D2
  ON C.ID = D2.PROJ_PLAN_ID AND D2.IS_DELETE = 0 AND
     D2.NODE_NAME = '首开楼栋基础开工' AND D2.FISSION_SOURCE_ORIGINAL_ID IS NULL
  LEFT JOIN POM_PROJ_PLAN_NODE D3
  ON C.ID = D3.PROJ_PLAN_ID AND D3.IS_DELETE = 0 AND
     D3.NODE_NAME = '取得预售许可证' AND D3.FISSION_SOURCE_ORIGINAL_ID IS NULL
  LEFT JOIN POM_PROJ_PLAN_NODE D4
  ON C.ID = D4.PROJ_PLAN_ID AND D4.IS_DELETE = 0 AND D4.NODE_NAME = '竣工备案' AND
     D4.FISSION_SOURCE_ORIGINAL_ID IS NULL
  LEFT JOIN POM_PROJ_PLAN_NODE D5
  ON C.ID = D5.PROJ_PLAN_ID AND D5.IS_DELETE = 0 AND D5.NODE_NAME = '项目交付' AND
     D5.FISSION_SOURCE_ORIGINAL_ID IS NULL
  --('建设工程规划许可证','首开楼栋基础开工','竣工备案','取得预售许可证','项目交付')
  WHERE A.ID = IN_PROJ_ID;

  IF V_JF_END_DATE IS NOT NULL THEN
    OUT_PROJ_STATUS := '已交付';
  ELSE
    IF V_JG_END_DATE IS NOT NULL THEN
      OUT_PROJ_STATUS := '已竣工未交付';
    ELSE
      IF V_YSZ_END_DATE IS NOT NULL THEN
        OUT_PROJ_STATUS := '已取预售证未交付';
      ELSE
        IF V_KG_END_DATE IS NOT NULL THEN
          OUT_PROJ_STATUS := '已开工未取预售证';
        ELSE
          IF V_GGZ_END_DATE IS NOT NULL THEN
            OUT_PROJ_STATUS := '已取得工程规划证未开工';
          ELSE
            OUT_PROJ_STATUS := '未取得工程规证';
          END IF;
        END IF;
      END IF;
    END IF;
  END IF;

END;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_GET_PROJ_TREE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_GET_PROJ_TREE" (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    data_auth_info   OUT              SYS_REFCURSOR
) AS
--获取有权限的项目树
--作者：陈丽
--日期：2020/06/14
      data_auth_spid   VARCHAR2(200);
   
BEGIN

    p_sys_get_company_tree_spid(userid => userid, stationid => stationid, deptid => deptid, companyid => companyid, bizcode
    => bizcode, data_auth_spid => data_auth_spid);

    OPEN data_auth_info FOR SELECT
                             orgid      orgId,
                             orgname    AS orgName,
                             parentid   AS parentId,
                             orgtype    AS orgType
                         FROM
                             (
                                 SELECT DISTINCT
                                     org_id       AS orgid,
                                     org_name     AS orgname,
                                     order_code   AS ordercode,
                                     parent_id    AS parentid,
                                     org_type     AS orgtype
                                     
                                 FROM
                                     tmp_company_tree
                                 WHERE
                                     id = data_auth_spid
                                     AND org_id IN (
                                         SELECT DISTINCT
                                             id
                                         FROM
                                             sys_business_unit
                                         START WITH
                                             id IN (
                                                 SELECT
                                                     id
                                                 FROM
                                                     (
                                                         SELECT
                                                             unit_id AS id
                                                         FROM
                                                             sys_project
                                                         UNION
                                                         SELECT
                                                             subordinate_company_id AS id
                                                         FROM
                                                             cdb_feasible_project_config
                                                     ) ds
                                             )
                                         CONNECT BY
                                             PRIOR parent_id = id
                                     )
                                 UNION ALL
                                 SELECT
                                     id             AS projid,
                                     project_name   AS projname,
                                     project_code   AS ordercode,
                                     unit_id        AS parentid,
                                     '10' AS orgtype
                                 FROM
                                     sys_project
                             ) t
                         ORDER BY
                             ordercode;

    

END p_pom_get_proj_tree;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_GET_PROJECT_BYCOMPANY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_GET_PROJECT_BYCOMPANY" (
    conmpanyid   IN           VARCHAR,
    items        OUT          SYS_REFCURSOR
) AS
BEGIN
    OPEN items FOR SELECT
                       project_name   AS "projName",
                       id             AS "projId"
                   FROM sys_project where unit_id in(
                           SELECT
                               id
                           FROM
                               sys_business_unit where is_company=1
                           START WITH
                               parent_id = conmpanyid
                           CONNECT BY
                               PRIOR id = parent_id) OR unit_id = conmpanyid;


END p_pom_get_project_bycompany;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_GET_PUSH_PORTAL_MSG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_GET_PUSH_PORTAL_MSG" (INFO OUT SYS_REFCURSOR --消息集合
																											) IS
		--待办/待阅/关注消息获取 废弃使用【p_pom_portal_msg】
		--作者：陈丽
		--日期：2020/01/09
BEGIN
		OPEN INFO FOR
		
		--超期任务提醒
				SELECT 0 AS "msgType", A.ORIGINAL_NODE_ID AS "taskId", B1.USER_ACCOUNT AS "ownerName", 'v-xufeng' AS "creatorName",
							 'http://pom.crccre.cn/pom/pom/middle?originalUrl=' ||
								URL_ENCODE('http://pom.crccre.cn/pom/pom/mission-center-feedback/my-responsible-task?cancelType=0' || CHR(38) || 'id=' || A.PROJ_PLAN_ID || CHR(38) || 'feedbackNodeId=' || A.ID ||
													 CHR(38) || 'feedbackNodeOriginalId=' || A.ORIGINAL_NODE_ID || CHR(38) || 'nodeSourcePlanType=1') AS "pcUrl", '' AS "mobileUrl", SYSDATE AS "created",
							 TRUNC(SYSDATE) + 1 AS "expireTime", '【节点超期预警】【' || A.PROJ_NAME || '-' || A.PLAN_TYPE || '-' || A.NODE_NAME || '】超期' || TO_CHAR(TRUNC(SYSDATE) - A.PLAN_END_DATE) || '天预警' AS "taskName",
							 '计划运营' AS "typeName",1 AS "priority", '' AS "remark"
, 'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "sourceAppId",meg.MESSAGE_MSG_TYPE AS "messageMsgType"
				FROM   V_POM_NODE_DT A
				LEFT   JOIN SYS_ROLE_USER_RELATION_RESULT B1
				ON     B1.DEPT_ID = A.DUTY_DEPARTMENT_ID AND
							 B1.VIRTUAL_GROUP_NAME = '部门计划专员'
				LEFT JOIN SYS_MESSAGE_CENTER meg
				ON meg.TASK_ID=A.id AND meg.CREATED-SYSDATE=0
				WHERE  A.FINISH_NO_STATUS_TYPE = '超期未完成' AND
							 NOT EXISTS (SELECT 1
								FROM   SYS_MESSAGE_CENTER_PUSH_RECORD P
								WHERE  P.RESPONSE_RESULTS LIKE '%{"errcode":0%' AND
											 TRUNC(SYSDATE) - TRUNC(P.REQUEST_TIME) = 0 AND
											 A.ID = P.TASK_ID AND
											 B1.USER_ACCOUNT = P.OWNER_NAME) AND
							 B1.USER_ACCOUNT IS NOT NULL AND b1.USER_ACCOUNT = 'zhangzhuohan';


/*		SELECT '0' "msgType",
            --任务类型（0：待办，10：待阅，20：关注）
           '32' AS "taskId",
            --任务ID
           'yuzheng1' AS "ownerName",
            --拥有人
           'v-xufeng' AS "creatorName",
            --创建人
           'http://pom.crccre.cn/pom/pom/middle?originalUrl='||url_encode('http://pom.crccre.cn/pom/pom/mission-center-feedback/my-responsible-task?cancelType=0&id=d209390c-3471-4b98-a719-219f6da5c609&feedbackNodeId=00c63db3-6bca-494f-b74a-e62e6b540f3a&feedbackNodeOriginalId=00c63db3-6bca-494f-b74a-e62e6b540f3a&nodeSourcePlanType=1') AS "pcUrl",
            --应用系统的url地址 不用改变这串字符（http://pom.crccre.cn/pom//pom/middle?originalUrl=），注意只能打开计划系统，如要打开其他系统需要开发  
           'https://www.baidu.com' AS "mobileUrl",
            --应用系统的手机端url地址
           SYSDATE AS "created",
            --创建时间
           SYSDATE AS "expireTime",
            --过期时间
           'huangw衡泽-测试-待办' || TO_CHAR(SYSDATE, 'yyyy-mm-ddhh24:mi:ss') AS "taskName",
            --任务名称
           '计划运营' AS "typeName",
            --任务类型
           '1' AS "priority",
            --优先级
           '测试计划运营推送待办到门户' AS "remark",
            --备注
           'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "sourceAppId" --应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段
    FROM   DUAL;*/

END P_POM_GET_PUSH_PORTAL_MSG;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_GETPJPLAN_EXM_SOCRE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_GETPJPLAN_EXM_SOCRE" 

AS

BEGIN 
DELETE FROM POM_PJPLAN_EXM_SOCRE_TABLE;
INSERT  into POM_PJPLAN_EXM_SOCRE_TABLE
SELECT * FROM V_POM_PJPLAN_EXM_SOCRE;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_GETPJPLAN_STATISTICS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_GETPJPLAN_STATISTICS" 

AS
--关键节点计划监控
BEGIN 
DELETE FROM POM_PJMOTHPLAN_STATISTICS;
INSERT  into POM_PJMOTHPLAN_STATISTICS
SELECT * FROM V_POM_PJMOTHPLAN_STATISTICS;

DELETE FROM POM_PJQUARTERPLAN_STATISTICS;
INSERT  into POM_PJQUARTERPLAN_STATISTICS
SELECT * FROM V_POM_PJQUARTERPLAN_STATISTICS;

DELETE FROM POM_PJYEARPLAN_STATISTICS;
INSERT  into POM_PJYEARPLAN_STATISTICS
SELECT * FROM V_POM_PJYEARPLAN_STATISTICS;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_JUDGE_FISSION_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_JUDGE_FISSION_DATA" 
(
    projectId      IN NVARCHAR2  --项目or 分期id
   ,planNodeId  IN NVARCHAR2 ---节点id
   ,data OUT SYS_REFCURSOR --返回值
) AS
BEGIN
---OPEN data FOR select 1 id from dual where 1=2;
OPEN data FOR

SELECT id,BUILD_NAME  FROM MDM_BUILD a where (PROJ_ID=''||projectId||''  or PERIOD_ID= ''||projectId||'' )  and  id not in (
SELECT id FROM(
SELECT *  FROM (
SELECT id
--,BUILD_NAME,IS_GET_CON_PLAN_PERMIT ,GET_CON_PLAN_PERMIT_DATE
,'规划许可证'  as "PERMIT_TYPE" FROM MDM_BUILD  a 
where (PROJ_ID=''||projectId||''  or PERIOD_ID= ''||projectId||'' ) and nvl(IS_GET_CON_PLAN_PERMIT,0)=1
UNION ALL 
--是否取规划许可证
SELECT id
--,BUILD_NAME,IS_GET_CONSTRCUTION_PERMIT,GET_CONSTRCUTION_PERMIT_DATE
,'施工许可证' FROM MDM_BUILD  a where (PROJ_ID=''||projectId||''  or PERIOD_ID= ''||projectId||'' )
and nvl(IS_GET_CONSTRCUTION_PERMIT,0)=1
 UNION ALL 
--是否取规划许可证
SELECT id
--,BUILD_NAME,IS_GET_PRE_SALE_PERMIT,GET_PRE_SALE_PERMIT_DATE
,'预售许可证' FROM MDM_BUILD  a where (PROJ_ID=''||projectId||''  or PERIOD_ID= ''||projectId||'' )
and nvl(IS_GET_PRE_SALE_PERMIT,0)=1
UNION ALL 
--是否取规划许可证
SELECT id
--,BUILD_NAME,IS_GET_COMPLETED_PERMIT,GET_COMPLETED_PERMIT_DATE
,'竣工备案证' FROM MDM_BUILD  a where (PROJ_ID=''||projectId||''  or PERIOD_ID= ''||projectId||'' )
and nvl(IS_GET_COMPLETED_PERMIT,0)=1
) a1  where    PERMIT_TYPE=(
 SELECT PERMIT_TYPE  FROM POM_PROJ_PLAN_NODE  a   where a.id =''||planNodeId||'' )
 
 
UNION ALL 
 /*本次取证楼栋*/
SELECT c.BLD_ID,PERMIT_TYPE FROM POM_CURRENT_EVIDENCE_INFO a INNER JOIN  MDM_PERMIT b  on a.PERMIT_ID=b.id
INNER JOIN MDM_PERMIT_BLD c on c.PERMIT_ID=b.id
INNER JOIN MDM_BUILD d on d.id=bld_id
WHERE b.APPROVAL_STATUS<>'未审核'
 and (PROJ_ID=''||projectId||''  or PERIOD_ID= ''||projectId||'' )
 
 
AND PERMIT_TYPE=(
 SELECT PERMIT_TYPE  FROM POM_PROJ_PLAN_NODE  a   where a.id =''||planNodeId||'' )
 
 ) a2 ) ;

end;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_JUDGE_FISSION_RESULT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_JUDGE_FISSION_RESULT" 
(
    projectId      IN NVARCHAR2  --项目or 分期id
   ,permitType  IN NVARCHAR2 --证照类型
   ,planNodeId  IN NVARCHAR2 ---节点id
   ,result OUT INT --返回值
) AS
BEGIN
   DECLARE  
    v_count INT :=0;
    BEGIN
    select count(*) INTO result
from mdm_permit_bld mb
inner join (select *
   from mdm_permit mp
   inner join(select *
       from POM_NODE_FEEDBACK nf
       inner join (select id, fission_source_original_id
           from pom_proj_plan_node a
           start with a.id = ''||planNodeId||''
           CONNECT BY PRIOR a.fission_source_original_id = a.id
       ) n on nf.FEEDBACK_NODE_ID = n.id and n.id is not null
   ) f on mp.id = f.PERMIT_ID and mp.approval_status='已审核'
) m on mb.permit_id = m.id and mb.id is not null
right join (
        SELECT A.id 
        FROM   MDM_BUILD A
        INNER  JOIN MDM_BUILD_PHASE B
        ON     A.ID = B.BUILD_ID
        INNER  JOIN MDM_OBJ_PHASE_INDEX C
        ON     C.OBJ_PHASE_ID = B.ID
        INNER  JOIN (SELECT B1.PRODUCT_TYPE_CODE, A1.*
                     FROM   MDM_OBJ_PHASE_PT_INDEX A1
                     INNER  JOIN MDM_BUILD_PRODUCT_TYPE B1
                     ON     A1.PRODUCT_TYPE_ID = B1.ID) D
        ON     D.OBJ_PHASE_ID = B.ID
        LEFT   JOIN (SELECT B3.BUILD_ID, B3.ID AS OBJ_PHASE_ID, A3.BUILD_AREA,
                            A3.GROUND_TOTAL_BUILD_AREA,
                            A3.UNDERGROUND_TOTAL_BUILD_AREA
                     FROM   MDM_OBJ_PHASE_PT_INDEX A3
                     INNER  JOIN MDM_BUILD_PHASE B3
                     ON     A3.OBJ_PHASE_ID = B3.ID AND
                            B3.PHASE_NAME = '竣工备案证阶段') F
        ON     F.BUILD_ID = A.ID AND
               F.OBJ_PHASE_ID = B.ID
        WHERE  EXISTS (SELECT 1
                FROM   (SELECT ROW_NUMBER() OVER(PARTITION BY A.ID ORDER BY C.PHASE_ORDER DESC) AS PRANK,
                                A.ID BUILDID, C.PHASE_ORDER PHASEORDER,
                                C.PHASE_NAME PHASENAME, C.ID PHASEID
                         FROM   MDM_BUILD A
                         INNER  JOIN MDM_BUILD_PHASE B
                         ON     A.ID = B.BUILD_ID
                         INNER  JOIN MDM_PHASE C
                         ON     B.PHASE_ID = C.ID) P
                WHERE  P.PRANK = 1 AND
                       P.PHASEID = B.PHASE_ID AND
                       P.BUILDID = A.ID) AND A.BUILD_STATE = 10
                      AND   A.PERIOD_ID =''||projectId||''  OR A.PROJ_ID=''||projectId||''
        ORDER  BY BUILD_NAME
) t on mb.bld_id = t.id
where mb.bld_id is null;
    END;
end;
--==========================项目主项计划监控解析计划专员===================

/
--------------------------------------------------------
--  DDL for Procedure P_POM_JUDGE_NODE_ISSINGLE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_JUDGE_NODE_ISSINGLE" (
    NODELIST IN VARCHAR2,
    judgeType IN VARCHAR2 ,   --0为执行反馈，1为查看任务
    errmsg OUT VARCHAR2, --提示消息
    errcode OUT INT --0成功，1失败
)
AS
BEGIN

    IF length(NODELIST) < 36 THEN
        IF judgeType = '0' THEN
            errcode := 1;
            errmsg := '请选择要执行反馈的任务项';
        ELSIF judgeType = '1' THEN
            errcode := 1;
            errmsg := '请选择要查看的任务项';
        END IF;
    ELSIF length(NODELIST) > 36 THEN
        IF judgeType = '0' THEN
            errcode := 1;
            errmsg := '只可选择单个任务执行反馈';
        ELSIF judgeType = '1' THEN
            errcode := 1;
            errmsg := '只可选择单个任务查看';
        END IF;
    ELSE
        errcode := 0;
    END IF;

END P_POM_JUDGE_NODE_ISSINGLE;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_KEY_NODE_ALREADY_DELAY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_KEY_NODE_ALREADY_DELAY" (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    orgid          IN             VARCHAR2,--组织id(）
    title          OUT            VARCHAR2,
    info           OUT            SYS_REFCURSOR--需要程序组装树,并汇总子级数据
) AS
--关键节点计划监控-当前一出现延误项目
--作者：陈丽
--日期：2019/11/13
BEGIN
    OPEN info FOR SELECT
                      '西南公司' AS "orgName",--组织名
                      '1' AS "orgId",---组织id
                      '' AS "parentId",--父级id
                      '100' AS "projDelay",--已延误项目数量
                      '1' AS "periodDelay",--已延误分期数量
                      '1' AS "nodeDelay",--已延误节点数量
                      '1' AS "startWorkDelay",--开工节点延误数量
                      '10' AS "openPlateDelay",--开盘节点延误数量
                      '' AS "openUrl"--打开地址，无数据不打开
                  FROM
                      dual
                  UNION ALL
                  SELECT
                      '华南公司' AS "orgName",--组织名
                      '2' AS "orgId",---组织id
                      '' AS "parentId",--父级id
                      '100' AS "projDelay",--已延误项目数量
                      '1' AS "periodDelay",--已延误分期数量
                      '1' AS "nodeDelay",--已延误节点数量
                      '1' AS "startWorkDelay",--开工节点延误数量
                      '10' AS "openPlateDelay",--开盘节点延误数量
                      '' AS "openUrl"--打开地址
                  FROM
                      dual
                  UNION ALL
                  SELECT
                      '华东公司' AS "orgName",--组织名
                      '3' AS "orgId",---组织id
                      '' AS "parentId",--父级id
                      '100' AS "projDelay",--已延误项目数量
                      '1' AS "periodDelay",--已延误分期数量
                      '1' AS "nodeDelay",--已延误节点数量
                      '1' AS "startWorkDelay",--开工节点延误数量
                      '10' AS "openPlateDelay",--开盘节点延误数量
                      '' AS "openUrl"--打开地址
                  FROM
                      dual
                  UNION ALL
                  SELECT
                      '北方公司' AS "orgName",--组织名
                      '4' AS "orgId",---组织id
                      '' AS "parentId",--父级id
                      '100' AS "projDelay",--已延误项目数量
                      '1' AS "periodDelay",--已延误分期数量
                      '1' AS "nodeDelay",--已延误节点数量
                      '1' AS "startWorkDelay",--开工节点延误数量
                      '10' AS "openPlateDelay",--开盘节点延误数量
                      '' AS "openUrl"--打开地址
                  FROM
                      dual
                  UNION ALL
                  SELECT
                      '事业部1' AS "orgName",--组织名
                      '5' AS "orgId",---组织id
                      '1' AS "parentId",--父级id
                      '100' AS "projDelay",--已延误项目数量
                      '1' AS "periodDelay",--已延误分期数量
                      '1' AS "nodeDelay",--已延误节点数量
                      '1' AS "startWorkDelay",--开工节点延误数量
                      '10' AS "openPlateDelay",--开盘节点延误数量
                      '' AS "openUrl"--打开地址
                  FROM
                      dual
                  UNION ALL
                  SELECT
                      '事业部1' AS "orgName",--组织名
                      '6' AS "orgId",---组织id
                      '5' AS "parentId",--父级id
                      '100' AS "projDelay",--已延误项目数量
                      '1' AS "periodDelay",--已延误分期数量
                      '1' AS "nodeDelay",--已延误节点数量
                      '1' AS "startWorkDelay",--开工节点延误数量
                      '10' AS "openPlateDelay",--开盘节点延误数量
                      '' AS "openUrl"--打开地址
                  FROM
                      dual;

END p_pom_key_node_already_delay;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_KEY_NODE_COMPLETION_RATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_KEY_NODE_COMPLETION_RATE" (
    ORGID          IN VARCHAR2,
    DATASCOPE      IN VARCHAR2,
    PLANTYPE       IN VARCHAR2,
    SEARCHKEY      IN VARCHAR2,
    COMPLETIONRATE OUT SYS_REFCURSOR
) AS
    --关键节点计划监控-关键节点完成率查询
    --作者：陈丽
    --日期：2019/11/13
    --查询2级单位SELECT * from  SYS_BUSINESS_UNIT A WHERE  A.COMPANY_TYPE='5' AND  PARENT_ID='003200000000000000000000000000'
BEGIN
    IF DATASCOPE = 'thisMonth' THEN
        OPEN COMPLETIONRATE FOR
            --月份
            SELECT
                CASE WHEN A.LEVEL_RANK=1 THEN '集团'  WHEN A.LEVEL_RANK=2 THEN '二级'  WHEN A.LEVEL_RANK=3 THEN '三级'  WHEN A.LEVEL_RANK=4 THEN '项目'  ELSE '项目'   END  AS "rightLable",--角标
                ISDELAY AS "delayedTotal",--已延误
                TO_CHAR(ISFINISHTOTAL)||'/'||	TO_CHAR(NODESUM) AS "completionRateDescription",
                ISFINISHTOTAL AS "completedTotal",--已完成
                NODESUM AS "shouldComplete",--应完成
                CASE
                    WHEN A.CTYPE = 'TYPE_PROJLAST'
                        THEN 	'/smart/dialog/page?height=75%25&width=1220&title=本月已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=1&planType=XXX'
                    WHEN CTYPE='TYPE_ORG'
                        THEN '/smart/dialog/page?height=75%25&width=1220&title=本月已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=1&planType=XXX'
                    ELSE	 '/smart/dialog/page?height=75%25&width=1220&title=本月已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=1&planType=XXX'
                    END  AS "delayedTotalUrl",--已延误 跳转地址为空前端不做跳转，只需要调整项目id
                CASE WHEN A.CTYPE = 'TYPE_PROJLAST'
                         THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本月已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=2&planType=XXX'
                     WHEN CTYPE='TYPE_ORG' THEN   '/smart/dialog/page?height=75%25&width=1220&title=本月已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=2&planType=XXX'
                     ELSE'/smart/dialog/page?height=75%25&width=1220&title=本月已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=2&planType=XXX'
                    END  AS "completedTotalUrl",--已完成 跳转地址为空前端不做跳转
                CASE WHEN A.CTYPE = 'TYPE_PROJLAST'
                         THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本月应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=3&planType=XXX'  						 WHEN CTYPE='TYPE_ORG'
                         THEN '/smart/dialog/page?height=75%25&width=1220&title=本月应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=3&planType=XXX'
                     ELSE '/smart/dialog/page?height=75%25&width=1220&title=本月应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=3&planType=XXX'
                    END   AS "shouldCompleteUrl",--应完成 跳转地址为空前端不做跳转
                --右上角显示排序
                NVL(A.ID, ORGID) AS "orgId",
                --ID
                A.ORG_NAME AS "orgName",
                --显示名称
                A.FINLISHRATE AS "completionRate",
                --完成率
                A.DELAYFINISHTOTAL AS "delayCompleteTotal",
                --延迟完成
                A.ADVANCEFINISHTOTAL AS "advanceCompleteTotal",
                --提前完成
                CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN
                             '/pom/plan-assess/node-monitoring/plan-nodes?companyid='||COMPANY_ID||'&ppid='||a.ID||'&planType=关键节点计划'
                     ELSE
                             '' || ORGID || ''
                    END  AS "clickOperationTypeContent",
                --穿透ID
                '#00e18f' AS "completionRateColor",
                --颜色
                CASE
                    WHEN  A.CTYPE = 'TYPE_PROJLAST' THEN
                        '2'
                    ELSE
                        '1'
                    END AS "clickOperationType",
                --穿透类型
                0 AS "isRoot", '' || ORGID || '' AS "parentId"
                --父级ID
                    , 'ThisMoth' AS "dataScope" --范围
                --A表项目计划主表计划类别通过TYPE判断
            FROM   POM_PJMOTHPLAN_STATISTICS A
            WHERE  PARENT_ID = '' || ORGID || '' AND
                    NODESUM > 0 /*AND a.ORG_NAME NOT LIKE '%无分期%'*/
              --AND  dataScope='thisMonth'
-- 						AND  a.ORG_NAME  ='西南公司'
            UNION ALL
            SELECT  CASE WHEN A.LEVEL_RANK=1 THEN '集团'  WHEN A.LEVEL_RANK=2 THEN '二级'  WHEN A.LEVEL_RANK=3 THEN '三级'  WHEN A.LEVEL_RANK=4 THEN '项目'  ELSE '项目'   END AS "rightLable",
                    ISDELAY AS "delayedTotal",--已延误
                    TO_CHAR(ISFINISHTOTAL)||'/'||	TO_CHAR(NODESUM) AS "completionRateDescription",
                    ISFINISHTOTAL AS "completedTotal",--已完成
                    NODESUM AS "shouldComplete",--应完成
                    CASE
                        WHEN A.CTYPE = 'TYPE_PROJLAST'
                            THEN 	'/smart/dialog/page?height=75%25&width=1220&title=本月已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=1&planType=XXX'
                        WHEN CTYPE='TYPE_ORG'
                            THEN '/smart/dialog/page?height=75%25&width=1220&title=本月已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=1&planType=XXX'
                        ELSE	'/smart/dialog/page?height=75%25&width=1220&title=本月已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=1&planType=XXX'   END  AS "delayedTotalUrl",--已延误 跳转地址为空前端不做跳转，只需要调整项目id
                    CASE WHEN A.CTYPE = 'TYPE_PROJLAST'
                             THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本月已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=2&planType=XXX'
                         WHEN CTYPE='TYPE_ORG'
                             THEN  '/smart/dialog/page?height=75%25&width=1220&title=本月已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=2&planType=XXX'
                         ELSE '/smart/dialog/page?height=75%25&width=1220&title=本月已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=2&planType=XXX'
                        END  AS "completedTotalUrl",--已完成 跳转地址为空前端不做跳转
                    CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本月应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=3&planType=XXX'
                         WHEN CTYPE='TYPE_ORG' THEN  '/smart/dialog/page?height=75%25&width=1220&title=本月应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=3&planType=XXX'
                         ELSE 	 '/smart/dialog/page?height=75%25&width=1220&title=本月应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=3&planType=XXX'
                        END   AS "shouldCompleteUrl",--应完成 跳转地址为空前端不做跳转
                    NVL(A.ID, ORGID) AS "orgId",
                    A.ORG_NAME AS "orgName",
                    A.FINLISHRATE AS "completionRate",
                    A.DELAYFINISHTOTAL AS "delayCompleteTotal",
                    A.ADVANCEFINISHTOTAL AS "advanceCompleteTotal",
                    -------------------chenl集团点击时还是加载集团下的数据
                    CASE
                        WHEN ID = '003200000000000000000000000000' THEN
                            '003200000000000000000000000000'
                        ELSE
                            A.PARENT_ID
                        END AS "clickOperationTypeContent",
                    -------------------chenl集团点击时还是加载集团下的数据
                    '#00e18f' AS "completionRateColor",
                    '1' AS "clickOperationType", 1 AS "isRoot",
                    CASE
                        WHEN ID = '003200000000000000000000000000' THEN
                            NULL
                        ELSE
                            PARENT_ID
                        END AS "parentId", 'ThisMoth' AS "dataScope"
            FROM   POM_PJMOTHPLAN_STATISTICS A
            WHERE  ID = '' || ORGID || '' AND
                    NODESUM > 0
            ORDER BY 11  desc
        /*AND a.ORG_NAME NOT LIKE '%无分期%'*/; --AND  dataScope='thisMonth';

    ELSIF DATASCOPE = 'thisQuarter' THEN
        OPEN COMPLETIONRATE FOR
            --季度
            SELECT --TO_CHAR(RANK)
                   CASE WHEN A.LEVEL_RANK=1 THEN '集团'  WHEN A.LEVEL_RANK=2 THEN '二级'  WHEN A.LEVEL_RANK=3 THEN '三级'  WHEN A.LEVEL_RANK=4 THEN '项目'  ELSE '项目'   END  	AS "rightLable",
                   --右上角显示排序
                   ISDELAY AS "delayedTotal",--已延误
                   TO_CHAR(ISFINISHTOTAL)||'/'||	TO_CHAR(NODESUM) AS "completionRateDescription",
                   ISFINISHTOTAL AS "completedTotal",--已完成
                   NODESUM AS "shouldComplete",--应完成
                   CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	'/smart/dialog/page?height=75%25&width=1220&title=本季度已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=1&planType=XXX'   WHEN CTYPE='TYPE_ORG' THEN '/smart/dialog/page?height=75%25&width=1220&title=本季度已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=1&planType=XXX'
                        ELSE	'/smart/dialog/page?height=75%25&width=1220&title=本季度已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=1&planType=XXX'
                       END  AS "delayedTotalUrl",--已延误 跳转地址为空前端不做跳转，只需要调整项目id
                   CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本季度已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=2&planType=XXX'  WHEN CTYPE='TYPE_ORG' THEN   '/smart/dialog/page?height=75%25&width=1220&title=本季度已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=2&planType=XXX'
                        else	 	'/smart/dialog/page?height=75%25&width=1220&title=本季度已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=2&planType=XXX'

                       END  AS "completedTotalUrl",--已完成 跳转地址为空前端不做跳转
                   CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本季度应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=3&planType=XXX'   WHEN CTYPE='TYPE_ORG' THEN '/smart/dialog/page?height=75%25&width=1220&title=本季度应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=3&planType=XXX'
                        else		'/smart/dialog/page?height=75%25&width=1220&title=本季度应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=3&planType=XXX'
                       END   AS "shouldCompleteUrl",--应完成 跳转地址为空前端不做跳转
                   --右上角显示排序
                   NVL(A.ID, ORGID) AS "orgId",
                   --ID
                   A.ORG_NAME AS "orgName",
                   --显示名称
                   A.FINLISHRATE AS "completionRate",
                   --完成率
                   A.DELAYFINISHTOTAL AS "delayCompleteTotal",
                   --延迟完成
                   A.ADVANCEFINISHTOTAL AS "advanceCompleteTotal",
                   --提前完成
                   CASE WHEN ID = '003200000000000000000000000000' OR A.CTYPE = 'TYPE_PROJLAST' THEN
                                '/pom/plan-assess/node-monitoring/plan-nodes?companyid='||COMPANY_ID||'&ppid='||a.ID||'&planType=关键节点计划'
                        ELSE
                                '' || ORGID || ''
                       END  AS "clickOperationTypeContent",
                   --穿透ID
                   '#00e18f' AS "completionRateColor",
                   --颜色
                   CASE
                       WHEN ID = '003200000000000000000000000000' OR A.CTYPE = 'TYPE_PROJLAST' THEN
                           '2'
                       ELSE
                           '1'
                       END AS "clickOperationType",
                   --穿透类型
                   0 AS "isRoot", '' || ORGID || '' AS "parentId"
                   --父级ID
                    , 'ThisQuarter' AS "dataScope" --范围
                --A表项目计划主表计划类别通过TYPE判断

            FROM   POM_PJQUARTERPLAN_STATISTICS A
            WHERE  PARENT_ID = '' || ORGID || '' AND
                    NODESUM > 0 /*AND a.ORG_NAME NOT LIKE '%无分期%'*/ --AND  dataScope='thisQuarter'

            UNION ALL
            SELECT  CASE WHEN A.LEVEL_RANK=1 THEN '集团'  WHEN A.LEVEL_RANK=2 THEN '二级'  WHEN A.LEVEL_RANK=3 THEN '三级'  WHEN A.LEVEL_RANK=4 THEN '项目'  ELSE '项目'   END   AS "rightLable",
                    ISDELAY AS "delayedTotal",--已延误
                    TO_CHAR(ISFINISHTOTAL)||'/'||	TO_CHAR(NODESUM) AS "completionRateDescription",
                    ISFINISHTOTAL AS "completedTotal",--已完成
                    NODESUM AS "shouldComplete",--应完成
                    CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	'/smart/dialog/page?height=75%25&width=1220&title=本季度已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=1&planType=XXX' WHEN CTYPE='TYPE_ORG' THEN  '/smart/dialog/page?height=75%25&width=1220&title=本季度已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=1&planType=XXX'
                         ELSE 	'/smart/dialog/page?height=75%25&width=1220&title=本季度已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=1&planType=XXX'
                        END  AS "delayedTotalUrl",--已延误 跳转地址为空前端不做跳转，只需要调整项目id
                    CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本季度已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=2&planType=XXX'  WHEN CTYPE='TYPE_ORG' THEN  '/smart/dialog/page?height=75%25&width=1220&title=本季度已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=2&planType=XXX'  ELSE  '/smart/dialog/page?height=75%25&width=1220&title=本季度已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=2&planType=XXX'  END  AS "completedTotalUrl",--已完成 跳转地址为空前端不做跳转
                    CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本季度应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=3&planType=XXX' WHEN CTYPE='TYPE_ORG' THEN  '/smart/dialog/page?height=75%25&width=1220&title=本季度应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=3&planType=XXX'  ELSE '/smart/dialog/page?height=75%25&width=1220&title=本季度应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=3&planType=XXX'  END   AS "shouldCompleteUrl",--应完成 跳转地址为空前端不做跳转
                    NVL(A.ID, ORGID) AS "orgId",
                    A.ORG_NAME AS "orgName",
                    A.FINLISHRATE AS "completionRate",
                    A.DELAYFINISHTOTAL AS "delayCompleteTotal",
                    A.ADVANCEFINISHTOTAL AS "advanceCompleteTotal",
                    -------------------chenl集团点击时还是加载集团下的数据
                    CASE
                        WHEN ID = '003200000000000000000000000000' THEN
                            '003200000000000000000000000000'
                        ELSE
                            A.PARENT_ID
                        END AS "clickOperationTypeContent",
                    -------------------chenl集团点击时还是加载集团下的数据
                    '#00e18f' AS "completionRateColor",
                    CASE
                        WHEN ID = '003200000000000000000000000000' OR A.CTYPE = 'TYPE_PROJLAST' THEN
                            '2'
                        ELSE
                            '1'
                        END AS "clickOperationType", 1 AS "isRoot",
                    CASE
                        WHEN ID = '003200000000000000000000000000' THEN
                            NULL
                        ELSE
                            PARENT_ID
                        END AS "parentId", 'ThisQuarter' AS "dataScope"
            FROM   POM_PJQUARTERPLAN_STATISTICS A
            WHERE  ID = '' || ORGID || '' AND
                    NODESUM > 0
            ORDER BY 11 desc
        /*AND a.ORG_NAME NOT LIKE '%无分期%'*/; --AND  dataScope='thisQuarter';
    ELSIF DATASCOPE = 'thisYear' THEN
        OPEN COMPLETIONRATE FOR
            --年度
            SELECT
                CASE WHEN A.LEVEL_RANK=1 THEN '集团'  WHEN A.LEVEL_RANK=2 THEN '二级'  WHEN A.LEVEL_RANK=3 THEN '三级'  WHEN A.LEVEL_RANK=4 THEN '项目'  ELSE '项目'   END   AS "rightLable",
                --右上角显示排序
                ISDELAY AS "delayedTotal",--已延误
                TO_CHAR(ISFINISHTOTAL)||'/'||	TO_CHAR(NODESUM) AS "completionRateDescription",
                ISFINISHTOTAL AS "completedTotal",--已完成
                NODESUM AS "shouldComplete",--应完成
                CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	'/smart/dialog/page?height=75%25&width=1220&title=本年已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=1&planType=XXX'  WHEN CTYPE='TYPE_ORG' THEN '/smart/dialog/page?height=75%25&width=1220&title=本年已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=1&planType=XXX'
                     ELSE 	 '/smart/dialog/page?height=75%25&width=1220&title=本年已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=1&planType=XXX'
                    END  AS "delayedTotalUrl",--已延误 跳转地址为空前端不做跳转，只需要调整项目id
                CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本年已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=2&planType=XXX'  WHEN CTYPE='TYPE_ORG' THEN   '/smart/dialog/page?height=75%25&width=1220&title=本年已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=2&planType=XXX'   ELSE '/smart/dialog/page?height=75%25&width=1220&title=本年已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=2&planType=XXX'   END  AS "completedTotalUrl",--已完成 跳转地址为空前端不做跳转
                CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本年应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=3&planType=XXX'  WHEN CTYPE='TYPE_ORG' THEN '/smart/dialog/page?height=75%25&width=1220&title=本年应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=3&planType=XXX' ELSE '/smart/dialog/page?height=75%25&width=1220&title=本年应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=3&planType=XXX' END   AS "shouldCompleteUrl",--应完成 跳转地址为空前端不做跳转
                --右上角显示排序
                NVL(A.ID, ORGID) AS "orgId",
                --ID
                A.ORG_NAME AS "orgName",
                --显示名称
                A.FINLISHRATE AS "completionRate",
                --完成率
                A.DELAYFINISHTOTAL AS "delayCompleteTotal",
                --延迟完成
                A.ADVANCEFINISHTOTAL AS "advanceCompleteTotal",
                --提前完成
                CASE WHEN ID = '003200000000000000000000000000' OR A.CTYPE = 'TYPE_PROJLAST' THEN
                             '/pom/plan-assess/node-monitoring/plan-nodes?companyid='||COMPANY_ID||'&ppid='||a.ID||'&planType=关键节点计划'
                     ELSE
                             '' || ORGID || ''
                    END  AS "clickOperationTypeContent",
                --穿透ID
                '#00e18f' AS "completionRateColor",
                --颜色
                CASE
                    WHEN ID = '003200000000000000000000000000' OR A.CTYPE = 'TYPE_PROJLAST' THEN
                        '2'
                    ELSE
                        '1'
                    END AS "clickOperationType",
                --穿透类型
                0 AS "isRoot", '' || ORGID || '' AS "parentId"
                --父级ID
                    , 'ThisYear' AS "dataScope" --范围
                --A表项目计划主表计划类别通过TYPE判断

            FROM   POM_PJYEARPLAN_STATISTICS A
            WHERE  PARENT_ID = '' || ORGID || '' AND
                    NODESUM > 0 /*AND a.ORG_NAME NOT LIKE '%无分期%'*/ --AND  dataScope='thisYear'

            UNION ALL
            SELECT CASE WHEN A.LEVEL_RANK=1 THEN '集团'  WHEN A.LEVEL_RANK=2 THEN '二级'  WHEN A.LEVEL_RANK=3 THEN '三级'  WHEN A.LEVEL_RANK=4 THEN '项目'  ELSE '项目'   END   AS "rightLable",
                   ISDELAY AS "delayedTotal",--已延误
                   TO_CHAR(ISFINISHTOTAL)||'/'||	TO_CHAR(NODESUM) AS "completionRateDescription",
                   ISFINISHTOTAL AS "completedTotal",--已完成
                   NODESUM AS "shouldComplete",--应完成
                   CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	'/smart/dialog/page?height=75%25&width=1220&title=本年已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=1&planType=XXX'  WHEN CTYPE='TYPE_ORG' THEN  '/smart/dialog/page?height=75%25&width=1220&title=本年已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=1&planType=XXX'  ELSE'/smart/dialog/page?height=75%25&width=1220&title=本年已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=1&planType=XXX' END  AS "delayedTotalUrl",--已延误 跳转地址为空前端不做跳转，只需要调整项目id
                   CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本年已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=2&planType=XXX'  WHEN CTYPE='TYPE_ORG' THEN  '/smart/dialog/page?height=75%25&width=1220&title=本年已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=2&planType=XXX' ELSE '/smart/dialog/page?height=75%25&width=1220&title=本年已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=2&planType=XXX'   END  AS "completedTotalUrl",--已完成 跳转地址为空前端不做跳转
                   CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本年应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=3&planType=XXX'  WHEN CTYPE='TYPE_ORG' THEN  '/smart/dialog/page?height=75%25&width=1220&title=本年应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=3&planType=XXX' else '/smart/dialog/page?height=75%25&width=1220&title=本年应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=3&planType=XXX'END   AS "shouldCompleteUrl",--应完成 跳转地址为空前端不做跳转
                   NVL(A.ID, ORGID) AS "orgId",
                   A.ORG_NAME AS "orgName",
                   A.FINLISHRATE AS "completionRate",
                   A.DELAYFINISHTOTAL AS "delayCompleteTotal",
                   A.ADVANCEFINISHTOTAL AS "advanceCompleteTotal",
                   -------------------chenl集团点击时还是加载集团下的数据
                   CASE
                       WHEN ID = '003200000000000000000000000000' THEN
                           '003200000000000000000000000000'
                       ELSE
                           A.PARENT_ID
                       END AS "clickOperationTypeContent",
                   -------------------chenl集团点击时还是加载集团下的数据
                   '#00e18f' AS "completionRateColor",
                   CASE
                       WHEN ID = '003200000000000000000000000000' OR A.CTYPE = 'TYPE_PROJLAST' THEN
                           '2'
                       ELSE
                           '1'
                       END AS "clickOperationType", 1 AS "isRoot",
                   CASE
                       WHEN ID = '003200000000000000000000000000' THEN
                           NULL
                       ELSE
                           PARENT_ID
                       END AS "parentId", 'ThisYear' AS "dataScope"
            FROM   POM_PJYEARPLAN_STATISTICS A
            WHERE  ID = '' || ORGID || '' AND
                    NODESUM > 0
            ORDER BY 11 desc
        /*AND a.ORG_NAME NOT LIKE '%无分期%'*/;
    END IF;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_KEY_NODE_CONDITIONS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_KEY_NODE_CONDITIONS" (planType in VARCHAR2
,searchText out VARCHAR2
,promptInfo out VARCHAR2
,description  out VARCHAR2
,dateScope OUT sys_refcursor)
AS  
--关键节点计划监控-关键节点计划条件
--作者：陈丽
--日期：2019/11/13
BEGIN
open dateScope for
select 'thisMonth' as "id",'本月' as "name" from dual
union all
select 'thisQuarter' as "id",'本季' as "name" from dual
union all
select 'thisYear' as "id",'本年' as "name" from dual;
description:= '项目计划按时完成率排名榜';
searchText:='';
promptInfo:='请输入公司名称';
END p_pom_key_node_conditions;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_KEY_NODE_CONDITIONS1
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_KEY_NODE_CONDITIONS1" (planType in VARCHAR2
,searchText out VARCHAR2
,promptInfo out VARCHAR2
,description  out VARCHAR2
,dateScope OUT sys_refcursor)
AS  
--关键节点计划监控-关键节点计划条件
--作者：陈丽
--日期：2019/11/13
BEGIN
open dateScope for
select 'thisMonth' as "id",'本月' as "name" from dual
union all
select 'thisQuarter' as "id",'本季' as "name" from dual
union all
select 'thisYear' as "id",'本年' as "name" from dual;
description:= '项目计划按时完成率排名榜';
searchText:='';
promptInfo:='请输入公司名称';
END p_pom_key_node_conditions1;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_KEY_NODE_DELAY_PROJ
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_KEY_NODE_DELAY_PROJ" 
(
		USERID       IN VARCHAR2
	 , --当前用户id
		STATIONID    IN VARCHAR2
	 , --当前用户岗位id
		DEPARTMENTID IN VARCHAR2
	 , --当前用户部门id
		COMPANYID    IN VARCHAR2
	 , --当前用户公司id
		ORGID        IN VARCHAR2
	 , --组织id(）
		TITLE        OUT VARCHAR2
	 ,INFO         OUT SYS_REFCURSOR --需要程序组装树,并汇总子级数据
) AS
		--关键节点计划监控-当前已出现延误项目
		--作者：陈丽
		--日期：2019/11/13
BEGIN
		OPEN INFO FOR
		WITH TMP_PRO_NODE(ORG_ID,COMPANY_ID,ORGCODE,ORGNAME,PARENTID,ORDER_HIERARCHY_CODE,not_finish_node,NO_FINISH_KG_NODE,NO_FINISH_KP_NODE,orgtype,period_delay,project_delay) 
		AS (
	 
			SELECT a.id AS org_id
 		,b.COMPANY_ID as COMPANY_ID
		,LPAD(A.SN,4,'0') AS ORGCODE
			,a.STAGE_NAME AS orgname,a.PROJECT_ID AS parentid,NULL AS ORDER_HIERARCHY_CODE
			,SUM(CASE WHEN (TRUNC(SYSDATE) >= c.PLAN_END_DATE AND c.ACTUAL_END_DATE IS NULL)  or (ACTUAL_END_TIME- c.PLAN_END_DATE>5)  THEN 1 ELSE 0 END) AS not_finish_node
			,SUM(CASE WHEN TRUNC(SYSDATE) >= c.PLAN_END_DATE AND c.ACTUAL_END_DATE IS NULL AND C.NODE_NAME = '首开楼栋基础开工' THEN 1 ELSE 0 END) AS NO_FINISH_KG_NODE
			,SUM(CASE WHEN TRUNC(SYSDATE) >= c.PLAN_END_DATE AND c.ACTUAL_END_DATE IS NULL AND C.NODE_NAME = '首开楼栋达到预售条件' THEN 1 ELSE 0 END) AS NO_FINISH_KP_NODE
			,'2' AS orgtype
			,CASE WHEN SUM(CASE WHEN (TRUNC(SYSDATE) >= c.PLAN_END_DATE AND c.ACTUAL_END_DATE IS NULL)  or (ACTUAL_END_TIME- c.PLAN_END_DATE>5)  THEN 1 ELSE 0 END) <> 0 THEN 1 ELSE 0 END AS period_delay,0 AS project_delay
				FROM SYS_PROJECT_STAGE a
				INNER JOIN POM_PROJ_PLAN b ON a.ID = b.PROJ_ID AND b.APPROVAL_STATUS = '已审核' AND b.PLAN_TYPE = '关键节点计划'
				INNER JOIN POM_PROJ_PLAN_NODE c ON b.id = c.PROJ_PLAN_ID
				LEFT JOIN  POM_NODE_FEEDBACK d on  d.FEEDBACK_NODE_ID=c.id and  d.APPROVAL_STATUS='已审核' and   FEEDBACK_TYPE='CARRY_OUT'
				
				
				
				
				
				where  c.IS_DISABLE=0  and ACTUAL_END_DATE is null--20200326lxc调整 
				GROUP BY a.id,a.STAGE_NAME,a.PROJECT_ID,b.COMPANY_ID,A.SN
			UNION ALL
			SELECT A2.ORG_ID,A2.COMPANY_ID,A2.ORGCODE  ,A2.ORGNAME,A2.PARENT_ID,A2.ORDER_HIERARCHY_CODE,A1.not_finish_node,A1.NO_FINISH_KG_NODE,A1.NO_FINISH_KP_NODE,a2.orgtype,a1.period_delay,CASE WHEN/* a1.orgtype<>'2' AND*/ a1.period_delay <> 0 THEN 1 ELSE 0 END  AS project_delay
				FROM TMP_PRO_NODE A1
				INNER JOIN (
	SELECT DISTINCT a.id AS ORG_ID
 				,a.UNIT_ID as COMPANY_ID
				,LPAD(A.SN,4,'0') AS ORGCODE
				,A.PROJECT_NAME AS ORGNAME,A.UNIT_ID AS PARENT_ID,A.ORDER_HIERARCHY_CODE
				,CASE WHEN  listagg(STAGE_NAME,',')  WITHIN GROUP (ORDER BY a.id ) like '无分期' THEN '3' ELSE '1' END   AS orgtype
				FROM SYS_PROJECT A
 				left JOIN SYS_PROJECT_STAGE b on a.id=b.PROJECT_ID 
			GROUP BY a.id  
 				,a.UNIT_ID  
				,A.PROJECT_NAME ,A.UNIT_ID  ,A.ORDER_HIERARCHY_CODE,A.SN
		 
				UNION ALL 
				SELECT A.ID,A.ID,a.ORDER_HIERARCHY_CODE AS ORGCODE,A.ORG_NAME,A.PARENT_ID,A.ORDER_HIERARCHY_CODE,'0' AS orgtype
				FROM SYS_BUSINESS_UNIT A
				WHERE A.IS_COMPANY = 1 
				
				) A2 ON A1.PARENTID = A2.ORG_ID
			 
		)
SELECT *
FROM (		
		SELECT  P.ORGNAME AS "orgName",ORDER_HIERARCHY_CODE,p.org_id AS "orgId",p.parentid AS "parentId",SUM(p.project_delay) AS "projDelay",SUM(p.period_delay) AS "periodDelay",SUM(p.not_finish_node) AS "nodeDelay",SUM(p.NO_FINISH_KG_NODE) AS "startWorkDelay",SUM(p.NO_FINISH_KP_NODE) AS "openPlateDelay"
		,CASE WHEN p.orgtype = '1' 
		THEN '/smart/dialog/page?functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||p.ORG_ID||'&companyId='||p.COMPANY_ID||'&title=节点延误明细&dataScope=thisProjAll&planType=XXX&pageType=1'
		

		WHEN p.orgtype='0' 
			THEN '/smart/dialog/page?functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&companyId='||p.COMPANY_ID||'&title=节点延误明细&dataScope=thisCompanyAll&planType=XXX&pageType=1'
else  		'/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||NVL(p.COMPANY_ID,'003200000000000000000000000002')||'&ppid='||
	p.ORG_ID ||'&planType=关键节点计划' 
	
	END "openUrl"
		FROM TMP_PRO_NODE P
		WHERE p.orgname <> '无分期'
		GROUP BY p.orgname,p.parentid,p.orgtype,p.org_id,p.COMPANY_ID,ORDER_HIERARCHY_CODE
		HAVING SUM(p.not_finish_node) > 0
		) aa
		START WITH aa."orgId"=ORGID
		CONNECT BY PRIOR aa."orgId"=aa."parentId"
ORDER BY ORDER_HIERARCHY_CODE
				;
				

END P_POM_KEY_NODE_DELAY_PROJ;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_KEY_NODE_ORBITAL_WACTH
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_KEY_NODE_ORBITAL_WACTH" (
    PROJECTID       IN VARCHAR2
    ,PROJECTPERIODID IN VARCHAR2
    ,PLANTYPE        IN VARCHAR2_LIST
    ,DESCRIPTION     OUT VARCHAR2
    ,STATES          OUT SYS_REFCURSOR
    ,ORBITALNODE     OUT SYS_REFCURSOR
) AS
    --关键节点计划监控-轨道图
    --作者：陈丽
    --日期：2019/11/13

    V_SQL CLOB := ''; --拼接SQL字符串
    /*    V_CON    NUMBER(2, 0);*/
    V_PROJECTID VARCHAR2(36);
    V_FLAG      VARCHAR2(10);
    V_PERIODID  VARCHAR2(36);

BEGIN
    OPEN STATES FOR
        SELECT '按时完成' AS "stateDescription", '#60955a' AS "stateColor", 'punctualityComplete' AS "state"
        FROM   DUAL
        UNION ALL
        SELECT '超期5天内完成' AS "stateDescription", '#ff9933' AS "stateColor", 'beyondComplete' AS "state"
        FROM   DUAL
        UNION ALL
        SELECT '超期5天' AS "stateDescription", '#f00' AS "stateColor", 'beyonduncomplete' AS "state"
        FROM   DUAL
        UNION ALL
        SELECT '未开始' AS "stateDescription", '#ccc' AS "stateColor", 'uncomplete' AS "state"
        FROM   DUAL;

    /*  OPEN ORBITALNODE FOR
SELECT CASE
         WHEN PLAN_END_DATE < SYSDATE THEN
          'punctualityComplete'
         WHEN PLAN_END_DATE > SYSDATE THEN
          'beyondComplete'
         ELSE
          'uncomplete'
       END AS "nodeState", NODE_NAME AS "nodeName",
       NODE_CODE AS "nodeContent",
       PLAN_END_DATE || '<br/>' || PLAN_END_DATE AS "nodeTime",
       '计划完成日期' || PLAN_END_DATE || '<br/>实际完成日期' || ACTUAL_END_DATE ||
        '<br/>相差天数0' AS "nodeDescription",
       '/basic-settings/standard-node/standard-node?action=Create' "nodeUrl"
FROM   POM_PROJ_PLAN_NODE;*/

    /*
    遍历PLANTYPE数组
*/
    SELECT P.FLAG INTO V_FLAG FROM (SELECT '项目' AS FLAG FROM SYS_PROJECT_STAGE A WHERE A.PROJECT_ID = PROJECTPERIODID UNION ALL SELECT DISTINCT '分期' FROM SYS_PROJECT_STAGE B WHERE B.ID = PROJECTPERIODID) P;

    IF V_FLAG = '项目' THEN
        begin
            select ID into V_PERIODID from SYS_PROJECT_STAGE
            where PROJECT_ID=PROJECTPERIODID;
        exception when others then
            DESCRIPTION := '获取分期时出错';
        end;
    ELSIF V_FLAG = '分期' THEN
        V_PERIODID := PROJECTPERIODID;
    END IF;

    IF V_FLAG = '项目' THEN
        V_PROJECTID := PROJECTPERIODID;
    ELSIF V_FLAG = '分期' THEN
        begin
            select PROJECT_ID into V_PROJECTID
            from SYS_PROJECT_STAGE where id = PROJECTPERIODID;
        exception when others then
            DESCRIPTION := '获取项目时发生错误';
        end;
    END IF;

    FOR I IN 1 .. PLANTYPE.COUNT
        LOOP
            IF PLANTYPE(I) = '可研计划' THEN
                V_SQL := V_SQL || '
SELECT CASE
 WHEN B.ACTUAL_END_DATE IS NOT NULL THEN
(CASE
WHEN B.ACTUAL_END_DATE - B.PLAN_END_DATE > 5 THEN
 ''beyonduncomplete''
 WHEN  B.ACTUAL_END_DATE - B.PLAN_END_DATE <= 5 and B.ACTUAL_END_DATE - B.PLAN_END_DATE > 0 THEN
 '' beyondComplete''
ELSE
 ''punctualityComplete''
END)
 WHEN B.ACTUAL_END_DATE IS NULL THEN
(CASE
WHEN SYSDATE - B.PLAN_END_DATE > 5 THEN
 ''beyonduncomplete''
ELSE
 ''uncomplete''
END)
 END AS "nodeState", B.NODE_NAME AS "nodeName",
 B.NODE_CODE AS "nodeContent",
 ''<div style="
    color: #696969;
">计划完成日期''||''    ''||TO_CHAR(B.PLAN_END_DATE,''YYYY-MM-DD'') || ''<br/>'' ||''实际完成日期''||''    ''||TO_CHAR(NVL(B.ACTUAL_END_DATE, ''''),''YYYY-MM-DD'')|| ''<br/>'' || NVL(''审核完成日期''||''    ''||TO_CHAR(nvl(C.APPROVAL_TIME,B.ACTUAL_END_DATE),''YYYY-MM-DD''), '''')||''</div>'' AS "nodeTime",
 ''计划完成日期'' ||TO_CHAR( NVL(B.PLAN_END_DATE, SYSDATE),''YYYY-MM-DD'') || ''<br/>实际完成日期'' ||
NVL(B.ACTUAL_END_DATE, '''') || ''<br/>相差天数'' ||
NVL(TO_DATE(B.PLAN_END_DATE) - TO_DATE(B.ACTUAL_END_DATE), '''') AS "nodeDescription",
 ''/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0''||CHR(38)||''id='' || A.ID ||
CHR(38) || ''feedbackNodeid=''||B.ID||CHR(38)||''feedbackNodeOriginalId=''||B.ORIGINAL_NODE_ID||CHR(38)||''nodeSourcePlanType=0''  AS "nodeUrl", B.ID AS "nodeId",
 B.ORIGINAL_NODE_ID AS "originalNodeId"
FROM   POM_PROJ_PLAN A, POM_PROJ_PLAN_NODE B
WHERE  A.ID = B.PROJ_PLAN_ID AND B.FISSION_SOURCE_ORIGINAL_ID IS NULL AND  
 A.PROJ_ID = ''' || PROJECTID || '''AND a.APPROVAL_STATUS = ''已审核'' and 
 A.PLAN_TYPE = ''' || PLANTYPE(I) || ''' UNION ALL ';
            ELSE
                V_SQL := V_SQL || 'SELECT CASE
 WHEN B.ACTUAL_END_DATE IS NOT NULL THEN
(CASE
WHEN B.ACTUAL_END_DATE - B.PLAN_END_DATE > 5 THEN
 ''beyonduncomplete''
 WHEN  B.ACTUAL_END_DATE - B.PLAN_END_DATE <= 5 and B.ACTUAL_END_DATE - B.PLAN_END_DATE > 0 THEN
 ''beyondComplete''
ELSE
 ''punctualityComplete''
END)
 WHEN B.ACTUAL_END_DATE IS NULL THEN
(CASE
WHEN SYSDATE - B.PLAN_END_DATE > 5 THEN
 ''beyonduncomplete''
 WHEN SYSDATE - B.PLAN_END_DATE <= 5 and SYSDATE - B.PLAN_END_DATE >0  THEN
 ''beyondComplete''
ELSE
 ''uncomplete''
END)
 END AS "nodeState", B.NODE_NAME AS "nodeName",
 B.NODE_CODE AS "nodeContent",
 ''<div style="
    color: #696969;
">计划完成日期''||''    ''||TO_CHAR(B.PLAN_END_DATE,''YYYY-MM-DD'') || ''<br/>'' || NVL(''实际完成日期''||''    ''||TO_CHAR(B.ACTUAL_END_DATE,''YYYY-MM-DD''), '''')|| ''<br/>'' || NVL(''审核完成日期''||''    ''||TO_CHAR(nvl(C.APPROVAL_TIME,B.ACTUAL_END_DATE),''YYYY-MM-DD''), '''')||''</div>'' AS "nodeTime",
 ''计划完成日期'' || to_char(NVL(B.PLAN_END_DATE, SYSDATE),''yyyy-mm-dd'') || ''<br/>实际完成日期'' ||
to_char(NVL(B.ACTUAL_END_DATE, ''''),''yyyy-mm-dd'') || ''<br/>相差天数'' ||
NVL(TO_DATE(B.PLAN_END_DATE) - TO_DATE(B.ACTUAL_END_DATE), '''') AS "nodeDescription",
 ''/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0''||CHR(38)||''id='' || A.ID ||
CHR(38) || ''feedbackNodeId=''||B.ID||CHR(38)||''feedbackNodeOriginalId=''||B.ORIGINAL_NODE_ID||CHR(38)||''nodeSourcePlanType=0'' AS "nodeUrl", B.ID AS "nodeId",
 B.ORIGINAL_NODE_ID AS "originalNodeId"
FROM   POM_PROJ_PLAN A
INNER JOIN POM_PROJ_PLAN_NODE B ON A.ID = B.PROJ_PLAN_ID 
LEFT JOIN POM_NODE_FEEDBACK c ON b.ID = c.FEEDBACK_NODE_ID AND c.FEEDBACK_TYPE = ''CARRY_OUT'' AND c.APPROVAL_STATUS = ''已审核''
        WHERE  b.is_disable = 0 and a.APPROVAL_STATUS = ''已审核'' and 
 A.PROJ_ID = ''' || V_PERIODID || '''AND B.FISSION_SOURCE_ORIGINAL_ID IS NULL AND
 A.PLAN_TYPE = ''' || PLANTYPE(I) || ''' UNION ALL ';
            END IF;
        END LOOP;

    V_SQL := RTRIM(V_SQL, 'UNION ALL') || ' ORDER BY 3';

    DBMS_OUTPUT.PUT_LINE(V_SQL);

    OPEN ORBITALNODE FOR V_SQL;

    DESCRIPTION := '';
END P_POM_KEY_NODE_ORBITAL_WACTH;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_KEY_NODE_SCHEDULE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_KEY_NODE_SCHEDULE" (
    COMPANYGUID IN VARCHAR2,
    USERID VARCHAR2,
    STATIONID VARCHAR2,
    DEPTID VARCHAR2,
    COMPANYID VARCHAR2,
    YEARS NUMBER,
    MONTHS NUMBER,
    ITEMS OUT SYS_REFCURSOR
)
    IS V_SQL CLOB; V_ID VARCHAR2 (100); BIZCODE VARCHAR2 (200) :='POM.JHJKYKHPH.01'; DATA_AUTH_SPID VARCHAR2 (200); datebase DATE; NOW_DATE DATE; O_M_BEGIN DATE; O_M_END DATE; O_QUARTER_BEGIN DATE; O_QUARTER_END DATE; O_YEAR_BEGIN DATE; O_YEAR_END DATE; BEGIN IF COMPANYGUID IS NULL THEN V_ID :='003200000000000000000000000000'; ELSE V_ID :=COMPANYGUID; END IF; datebase :=TO_DATE('' || YEARS || '-' || MONTHS || '-01','YYYY-MM-DD');-----chenl 20200730 获取指定时间年月日
BEGIN NOW_DATE :=datebase; P_POM_MONTH_QUARTER_YEAR (NOW_DATE=> NOW_DATE,O_M_BEGIN=> O_M_BEGIN,O_M_END=> O_M_END,O_QUARTER_BEGIN=> O_QUARTER_BEGIN,O_QUARTER_END=> O_QUARTER_END,O_YEAR_BEGIN=> O_YEAR_BEGIN,O_YEAR_END=> O_YEAR_END); END;
BEGIN P_SYS_GET_COMPANY_PROJ_SPID (USERID=> USERID,STATIONID=> STATIONID,DEPTID=> DEPTID,COMPANYID=> COMPANYID,BIZCODE=> BIZCODE,DATA_AUTH_SPID=> DATA_AUTH_SPID); END;-- 轨道图地址
--/pom/plan-assess/node-monitoring/plan-nodes?companyid=''|| sp.unit_id ||''&ppid=''|| sp.id ||''&planType=关键节点计划''
OPEN ITEMS FOR WITH 分期 AS (
    SELECT CASE WHEN 总分期数量 =0 THEN GET_UUID ELSE PS.ID END AS ID,PS.STAGE_NAME,PS.PROJECT_ID,PROJ.PROJECT_NAME,UNIT_ID,TO_CHAR(PS.SN,'0.0') AS SN,CASE WHEN 无分期数量 =1 AND 总分期数量 =1 THEN 1 ELSE 0 END 是无分期 FROM SYS_PROJECT_STAGE PS LEFT JOIN SYS_PROJECT PROJ ON PS.PROJECT_ID=PROJ.ID LEFT JOIN (
        SELECT PROJECT_ID,SUM(CASE WHEN STAGE_NAME='无分期' THEN 1 ELSE 0 END) AS 无分期数量,COUNT(PROJECT_ID) AS 总分期数量 FROM SYS_PROJECT_STAGE GROUP BY PROJECT_ID) PCOUNT ON PROJ.ID=PCOUNT.PROJECT_ID),/*
         basedata
        */
                    BASEDATA AS (---查询已审核的分期 关键节点计划 基础信息
                        SELECT PLAN.PROJ_ID,COUNT(NODE.ID) AS 有效节点数-- 所有未删除，未禁用的节点
                             ,SUM(CASE WHEN NODE.PLAN_END_DATE<=TRUNC(SYSDATE) THEN NODE.STANDARD_SCORE ELSE 0 END) AS 应得总分,SUM(NVL(NODEE.NEW_EXAMINATION_SCORE,0)) AS 实际得分,--              SUM(CASE WHEN TRUNC(NODE.PLAN_END_DATE ,'MM') = TRUNC(SYSDATE,'MM') THEN NODE.STANDARD_SCORE ELSE 0 END) AS 应得总分本月,

                            SUM(CASE WHEN NODE.PLAN_END_DATE> O_M_BEGIN AND NODE.PLAN_END_DATE< O_M_END THEN NODE.STANDARD_SCORE ELSE 0 END) AS 应得总分本月,SUM(CASE WHEN NODE.PLAN_END_DATE> O_M_BEGIN AND NODE.PLAN_END_DATE< O_M_END THEN 1 ELSE 0 END) AS 应完成数量本月,SUM(CASE WHEN NODEE.COMPLETE_FEEDBACK_APPROVE_TIME> O_M_BEGIN AND NODEE.COMPLETE_FEEDBACK_APPROVE_TIME< O_M_END THEN NODEE.NEW_EXAMINATION_SCORE ELSE 0 END) AS 实际得分本月,SUM(CASE WHEN NODEE.COMPLETE_FEEDBACK_APPROVE_TIME> O_M_BEGIN AND NODEE.COMPLETE_FEEDBACK_APPROVE_TIME< O_M_END THEN 1 ELSE 0 END) AS 已完成数量本月,SUM(CASE WHEN NODE.PLAN_END_DATE> O_QUARTER_BEGIN AND NODE.PLAN_END_DATE< O_QUARTER_END THEN NODE.STANDARD_SCORE ELSE 0 END) AS 应得总分本季度,SUM(CASE WHEN NODE.PLAN_END_DATE> O_QUARTER_BEGIN AND NODE.PLAN_END_DATE< O_QUARTER_END THEN 1 ELSE 0 END) AS 应完成数量本季度,SUM(CASE WHEN NODEE.NEW_EXAMINATION_SCORE IS NOT NULL AND NODEE.COMPLETE_FEEDBACK_APPROVE_TIME> O_QUARTER_BEGIN AND NODEE.COMPLETE_FEEDBACK_APPROVE_TIME< O_QUARTER_END THEN NODEE.NEW_EXAMINATION_SCORE ELSE 0 END) AS 实际得分本季度,SUM(CASE WHEN NODEE.NEW_EXAMINATION_SCORE IS NOT NULL AND NODEE.COMPLETE_FEEDBACK_APPROVE_TIME> O_QUARTER_BEGIN AND NODEE.COMPLETE_FEEDBACK_APPROVE_TIME< O_QUARTER_END THEN 1 ELSE 0 END) AS 已完成数量本季度,SUM(CASE WHEN NODE.PLAN_END_DATE> O_YEAR_BEGIN AND NODE.PLAN_END_DATE< O_YEAR_END THEN NODE.STANDARD_SCORE ELSE 0 END) AS 应得总分本年度,SUM(CASE WHEN NODE.PLAN_END_DATE> O_YEAR_BEGIN AND NODE.PLAN_END_DATE< O_YEAR_END THEN 1 ELSE 0 END) AS 应完成数量本年度,SUM(CASE WHEN NODEE.NEW_EXAMINATION_SCORE IS NOT NULL AND NODEE.COMPLETE_FEEDBACK_APPROVE_TIME> O_YEAR_BEGIN AND NODEE.COMPLETE_FEEDBACK_APPROVE_TIME< O_YEAR_END THEN NODEE.NEW_EXAMINATION_SCORE ELSE 0 END) AS 实际得分本年度,SUM(CASE WHEN NODEE.NEW_EXAMINATION_SCORE IS NOT NULL AND NODEE.COMPLETE_FEEDBACK_APPROVE_TIME> O_YEAR_BEGIN AND NODEE.COMPLETE_FEEDBACK_APPROVE_TIME< O_YEAR_END THEN 1 ELSE 0 END) AS 已完成数量本年度,--    case
--绿灯：到期当天内完成反馈；红灯：①到期超过5天未反馈②超期反馈
                            SUM(CASE--未到期不亮灯
                                    WHEN NODE.ACTUAL_END_DATE IS NULL AND TRUNC(SYSDATE)-TRUNC(NODE.PLAN_END_DATE)<=0 THEN 0--到期当天内完成反馈
                                    WHEN NODE.ACTUAL_END_DATE IS NOT NULL AND (TRUNC(NODE.ACTUAL_END_DATE)-TRUNC(NODE.PLAN_END_DATE))<=0 THEN 1 ELSE 0 END) AS 绿灯--1-5天内反馈 黄灯：①到期1-5天内完成反馈、②到期15天内未反馈；
                             ,SUM(CASE--未到期不亮灯
                                      WHEN NODE.ACTUAL_END_DATE IS NOT NULL AND (TRUNC(NODE.ACTUAL_END_DATE)-TRUNC(NODE.PLAN_END_DATE)) BETWEEN 1 AND 5 THEN 1--到期未反馈黄灯
                                      WHEN NODE.ACTUAL_END_DATE IS NULL AND (TRUNC(SYSDATE)-TRUNC(NODE.PLAN_END_DATE)) BETWEEN 1 AND 5 THEN 1 ELSE 0 END) AS 黄灯-- 超期五天反馈，或超期五天未反馈
                             ,SUM(CASE--未到期不亮灯
                                      WHEN (NODE.ACTUAL_END_DATE IS NULL AND (TRUNC(SYSDATE)-TRUNC(NODE.PLAN_END_DATE))> 5) OR ((TRUNC(NODE.ACTUAL_END_DATE)-TRUNC(NODE.PLAN_END_DATE))> 5) THEN 1 ELSE 0 END) AS 红灯,SUM(CASE WHEN NODE.NODE_LEVEL='里程碑' AND NODE.PLAN_END_DATE<=TRUNC(SYSDATE) THEN 1 ELSE 0 END) AS 里程碑应完成-- 里程碑节点、计划完成时间<=当天年月日 如 2020-05-25
                             ,SUM(CASE WHEN NODE.NODE_LEVEL='里程碑' AND NODE.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END) AS 里程碑已完成-- 里程碑节点、实际完成时间不为空
                             ,SUM(CASE WHEN NODE.NODE_LEVEL='里程碑' AND NODE.PLAN_END_DATE<=TRUNC(SYSDATE) AND NODE.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END) AS 里程碑未完成-- 里程碑节点 and 计划完成时间<=当天年月日 and 实际完成时间为空
                             ,SUM(CASE WHEN NODE.NODE_LEVEL='一级节点' AND NODE.PLAN_END_DATE<=TRUNC(SYSDATE) THEN 1 ELSE 0 END) AS 一级应完成,SUM(CASE WHEN NODE.NODE_LEVEL='一级节点' AND NODE.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END) AS 一级已完成,SUM(CASE WHEN NODE.NODE_LEVEL='一级节点' AND NODE.PLAN_END_DATE<=TRUNC(SYSDATE) AND NODE.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END) AS 一级未完成 FROM POM_PROJ_PLAN_NODE NODE LEFT JOIN POM_PROJ_PLAN PLAN ON NODE.PROJ_PLAN_ID=PLAN.ID LEFT JOIN POM_NODE_EXAMINATION NODEE ON NODE.ORIGINAL_NODE_ID=NODEE.ORIGINAL_NODE_ID--- 未考虑一个节点重复考核情况
---已审核、关键节点计划、未禁用节点
                        WHERE PLAN.APPROVAL_STATUS='已审核' AND PLAN.PLAN_TYPE='关键节点计划' AND NODE.ID IS NOT NULL AND NODE.IS_DISABLE=0 AND NODE.IS_DELETE=0 GROUP BY PLAN.PROJ_ID),/*
             项目_分期
       */
                    项目分期 AS (
                        SELECT 分期.ID,CASE WHEN 分期.是无分期=1 THEN 分期.PROJECT_NAME ELSE 分期.PROJECT_NAME || '-' || 分期.STAGE_NAME END AS NAME--统计的父级字段处理，无分期项目父级是公司，有分期项目父级是项目
                                ,CASE WHEN 分期.是无分期=1 THEN 分期.UNIT_ID ELSE PROJECT_ID END PARENT_ID,
                               有效节点数,
                               应得总分,
                               实际得分,
                               应得总分本月,
                               应完成数量本月,
                               实际得分本月,
                               已完成数量本月,
                               应得总分本季度,
                               应完成数量本季度,
                               实际得分本季度,
                               已完成数量本季度,
                               应得总分本年度,
                               应完成数量本年度,
                               实际得分本年度,
                               已完成数量本年度,
                               绿灯,
                               黄灯,
                               红灯,
                               里程碑应完成,
                               里程碑已完成,
                               里程碑未完成,
                               一级应完成,
                               一级已完成,
                               一级未完成,'/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||
                                     分期.UNIT_ID || '&ppid=' || CASE WHEN 分期.是无分期=1 THEN PROJECT_ID ELSE 分期.ID END || '&planType=关键节点计划' AS URL,
                               分期.UNIT_ID,
                               分期.SN,CASE WHEN (CASE WHEN (里程碑应完成 + 一级应完成)=0 THEN 0 ELSE ROUND((里程碑已完成 + 一级已完成)/(里程碑应完成 + 一级应完成),4)*100 END)< 90 THEN 1 ELSE 0 END AS "isWarning" FROM BASEDATA LEFT JOIN 分期 ON BASEDATA.PROJ_ID= 分期.ID UNION ALL
                        SELECT PROJ.ID,PROJ.PROJECT_NAME AS NAME,PROJ.UNIT_ID AS PARENT_ID,0 有效节点数,0 应得总分,0 应得总分本月,0 应完成数量本月,0 实际得分本月,0 已完成数量本月,0 应得总分本季度,0 应完成数量本季度,0 实际得分本季度,0 已完成数量本季度,0 应得总分本年度,0 应完成数量本年度,0 实际得分本年度,0 已完成数量本年度,0 绿灯,0 黄灯,0 红灯,0 里程碑应完成,0 里程碑已完成,0 里程碑未完成,0 一级应完成,0 一级已完成,0 一级未完成,0 实际得分,'' AS URL,PROJ.UNIT_ID,PROJ.SN,0 "isWarning" FROM SYS_PROJECT PROJ LEFT JOIN (
                            SELECT*FROM 分期 WHERE 是无分期 =1) S ON PROJ.ID=S.PROJECT_ID WHERE S.ID IS NULL),/*
             拼接项目公司树
       */
                    拼接项目公司树 AS (
                        SELECT*FROM (
                                        SELECT DISTINCT ORG_ID AS ID,ORG_NAME AS NAME,PARENT_ID AS PARENT_ID,0 有效节点数,0 应得总分,0 绿灯,0 黄灯,0 红灯,0 里程碑应完成,0 里程碑已完成,0 里程碑未完成,0 一级应完成,0 一级已完成,0 一级未完成,0 实际得分,0 应得总分本月,0 应完成数量本月,0 实际得分本月,0 已完成数量本月,0 应得总分本季度,0 应完成数量本季度,0 实际得分本季度,0 已完成数量本季度,0 应得总分本年度,0 应完成数量本年度,0 实际得分本年度,0 已完成数量本年度,'' URL,ORDER_CODE AS SN,0 "isWarning" FROM TMP_COMPANY_TREE WHERE ID=DATA_AUTH_SPID AND ORG_ID IN (
                                            SELECT DISTINCT ID FROM SYS_BUSINESS_UNIT
                                            START WITH ID IN (
                                                SELECT ID FROM (
                                                                   SELECT UNIT_ID AS ID FROM SYS_PROJECT UNION
                                                                   SELECT SUBORDINATE_COMPANY_ID AS ID FROM CDB_FEASIBLE_PROJECT_CONFIG) DS) CONNECT BY PRIOR PARENT_ID=ID)--                               )   start with id=v_id connect by prior id=parent_id
                                        UNION ALL
                                        SELECT ID,NAME,PARENT_ID,
                                               有效节点数,
                                               应得总分,
                                               绿灯,
                                               黄灯,
                                               红灯,
                                               里程碑应完成,
                                               里程碑已完成,
                                               里程碑未完成,
                                               一级应完成,
                                               一级已完成,
                                               一级未完成,
                                               实际得分,
                                               应得总分本月,
                                               应完成数量本月,
                                               实际得分本月,
                                               已完成数量本月,
                                               应得总分本季度,
                                               应完成数量本季度,
                                               实际得分本季度,
                                               已完成数量本季度,
                                               应得总分本年度,
                                               应完成数量本年度,
                                               实际得分本年度,
                                               已完成数量本年度,URL,SN,"isWarning" FROM 项目分期)
                        START WITH ID=V_ID CONNECT BY PRIOR ID=PARENT_ID)--
                       ,/*
        汇总
       */
                    汇总 AS (
                        SELECT ID,NAME,PARENT_ID,URL,SN-- ,有效节点数,应得总分
                             ,(
                            SELECT SUM(有效节点数) FROM 拼接项目公司树
                            START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 有效节点数,(
                            SELECT SUM(应得总分) FROM 拼接项目公司树
                            START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 应得总分--,绿灯,黄灯,红灯
                             ,(
                            SELECT SUM(绿灯) FROM 拼接项目公司树
                            START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 绿灯,(
                            SELECT SUM(黄灯) FROM 拼接项目公司树
                            START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 黄灯,(
                            SELECT SUM(红灯) FROM 拼接项目公司树
                            START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 红灯--,里程碑应完成,里程碑已完成,里程碑未完成
                             ,(
                            SELECT SUM(里程碑应完成) FROM 拼接项目公司树
                            START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 里程碑应完成,(
                            SELECT SUM(里程碑已完成) FROM 拼接项目公司树
                            START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 里程碑已完成,(
                            SELECT SUM(里程碑未完成) FROM 拼接项目公司树
                            START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 里程碑未完成--,一级应完成,一级已完成,一级未完成
                             ,(SELECT SUM(一级应完成) FROM 拼接项目公司树
                               START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 一级应完成,(
                            SELECT SUM(一级已完成) FROM 拼接项目公司树
                            START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 一级已完成,(
                            SELECT SUM(一级未完成) FROM 拼接项目公司树
                            START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 一级未完成,(
                            SELECT SUM(实际得分) FROM 拼接项目公司树
                            START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 实际得分,(
                            SELECT SUM(应得总分本月) FROM 拼接项目公司树
                            START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 应得总分本月,(
                            SELECT SUM(应完成数量本月) FROM 拼接项目公司树
                            START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 应完成数量本月,(
                            SELECT SUM(实际得分本月) FROM 拼接项目公司树
                            START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 实际得分本月,(
                            SELECT SUM(已完成数量本月) FROM 拼接项目公司树
                            START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 已完成数量本月,(
                            SELECT SUM(应得总分本季度) FROM 拼接项目公司树
                            START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 应得总分本季度,(
                            SELECT SUM(应完成数量本季度) FROM 拼接项目公司树
                            START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 应完成数量本季度,(
                            SELECT SUM(实际得分本季度) FROM 拼接项目公司树
                            START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 实际得分本季度,(
                            SELECT SUM(已完成数量本季度) FROM 拼接项目公司树
                            START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 已完成数量本季度,(
                            SELECT SUM(应得总分本年度) FROM 拼接项目公司树
                            START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 应得总分本年度,(
                            SELECT SUM(应完成数量本年度) FROM 拼接项目公司树
                            START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 应完成数量本年度,(
                            SELECT SUM(实际得分本年度) FROM 拼接项目公司树
                            START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 实际得分本年度,(
                            SELECT SUM(已完成数量本年度) FROM 拼接项目公司树
                            START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 已完成数量本年度,(
                            SELECT SUM("isWarning") FROM 拼接项目公司树
                            START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) AS "isWarning" FROM 拼接项目公司树 S)--
/*
    查询
    */
               SELECT ID AS "id",SN,
                      nvl2(URL, '<span style="color:#409eff">' || NAME || '</span>', NAME) "company",
                      NAME "companyName",
                      URL AS "jumpUrl",
                      PARENT_ID AS "parentId",
                      CASE WHEN (里程碑应完成 + 一级应完成)=0 THEN 0 ELSE ROUND((里程碑已完成 + 一级已完成)/(里程碑应完成 + 一级应完成),4)*100 END || '%' AS "completionRate",
                      有效节点数 AS "validTasks",
                      里程碑应完成 + 一级应完成 AS "completeNum",
                      里程碑已完成 + 一级已完成 AS "completed",
                      里程碑未完成 + 一级未完成 AS "unfinished",
                      应得总分 AS "needResult",CASE WHEN (应得总分)=0 THEN 0 ELSE ROUND((实际得分)/(应得总分),4)*100 END "dynamicResult",
                      实际得分 "realResult",
                      应得总分本月 AS "needResultMonth",
                      应完成数量本月 AS "needResultCountMonth",CASE WHEN (应得总分本月)=0 THEN 0 ELSE round(实际得分本月/应得总分本月,4)*100 END AS "dynamicResultMonth",
                      实际得分本月 AS "realResultMonth",
                      已完成数量本月 AS "realResultCountMonth",
                      应得总分本季度 AS "needResultQuarter",
                      应完成数量本季度 AS "needResultCountQuarter",CASE WHEN (应得总分本季度)=0 THEN 0 ELSE round(实际得分本季度/应得总分本季度,4)*100 END AS "dynamicResultQuarter",
                      实际得分本季度 AS "realResultQuarter",
                      已完成数量本季度 AS "realResultCountQuarter",
                      应得总分本年度 AS "needResultYear",
                      应完成数量本年度 AS "needResultCountYear",CASE WHEN (应得总分本年度)=0 THEN 0 ELSE round(实际得分本年度/应得总分本年度,4)*100 END AS "dynamicResultYear",
                      实际得分本年度 AS "realResultYear",
                      已完成数量本年度 AS "realResultCountYear",
                      绿灯 AS "greenLight",
                      黄灯 AS "yellowLight",
                      红灯 AS "redLight",
                      里程碑应完成 AS "miCompleteNum",
                      里程碑已完成 AS "miCompleted",
                      里程碑未完成 AS "miUnfinished",
                      一级应完成 AS "olCompleteNum",
                      一级已完成 AS "olCompleted",
                      一级未完成 AS "olUnfinished",'<span style="font-size:14px">预警说明：公司存在项目完成率低于90%，显示预警图标</span>' AS "remark",CASE WHEN ("isWarning">=1 AND ID<> '003200000000000000000000000000') THEN 1 ELSE "isWarning" END AS "isWarning"--,"isWarning"
               FROM 汇总 WHERE 1=1 AND 有效节点数 > 0 ORDER BY LPAD(SN,10,'0'); END P_POM_KEY_NODE_SCHEDULE;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_KEYNODE_TASK_LIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_KEYNODE_TASK_LIST" (
     tabType VARCHAR2,
     planType VARCHAR2,
     businessId VARCHAR2,
     currentcompanyid   IN                 VARCHAR2,--当前用户的公司
     userid             IN                 VARCHAR2,--用户id用于过滤关注的任务
     currentstationid   IN                 VARCHAR2,---当前用户的岗位
     currentdeptid      IN                 VARCHAR2,---当前用户的部门
     bizcode            IN                 VARCHAR2,---权限code
     pageRows INTEGER,
     pageIndex INTEGER,
     taskList  OUT SYS_REFCURSOR
) IS 
--项目主项计划监控项目完成率前排行榜详情列表
--作者：谢松宏
--修改：叶丁荣//数据权限过滤
--日期：2020/03/20
v_condition varchar2(4000);
v_sql clob;
v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN 
v_condition:= ' AND 1=1';
IF(tabType is not null) THEN
    IF(tabType='超期任务')
        then  v_condition:=' and  to_char(node.plan_end_date, ''yyyy-MM-dd'') <  to_char(sysdate, ''yyyy-MM-dd'') and node.actual_end_date is null order by node.plan_end_date desc'; 
    ELSIF(tabType='今日完成')
        then  v_condition:=' and  to_char(node.plan_end_date, ''yyyy-MM-dd'') = to_char(sysdate, ''yyyy-MM-dd'') and node.actual_end_date is not null  order by node.actual_end_date desc'; 
    ELSIF(tabType='今日待办')
        then  v_condition:=' and  to_char(node.plan_end_date, ''yyyy-MM-dd'') = to_char(sysdate, ''yyyy-MM-dd'') and node.actual_end_date is null order by node.plan_end_date desc'; 
    END IF;
END IF;

--调用数据权限验证存储过程
    p_sys_auth_data_rule_spid(userid => userid, stationid => currentstationid, deptid => currentdeptid, companyid => currentcompanyid
    , bizcode => bizcode, data_auth_spid => v_spid);

v_sql:='SELECT *
  FROM (SELECT tt.*, ROWNUM AS rowno
    FROM (  
        select 
        node.id as "nodeId", 
        node.original_node_id as "nodeOriginalId",
        node.node_name as "nodeName",
        plan.plan_type as "nodePlanType",
        case 
            when '''||tabType||'''=''超期任务'' then to_char(node.plan_end_date, ''yyyy-MM-dd'')
            when '''||tabType||'''=''今日完成'' then to_char(node.actual_end_date, ''yyyy-MM-dd'')
            when '''||tabType||'''=''今日待办'' then to_char(node.plan_end_date, ''yyyy-MM-dd'')
        end  as "nodeTime",
        case 
            when (to_char(node.plan_end_date, ''yyyy-MM-dd'') < to_char(sysdate, ''yyyy-MM-dd'') and node.actual_end_date is null) then ''已超期''
            when (to_char(node.plan_end_date, ''yyyy-MM-dd'') = to_char(sysdate, ''yyyy-MM-dd'') and node.actual_end_date is not null) then ''已完成''
            when (to_char(node.plan_end_date, ''yyyy-MM-dd'') = to_char(sysdate, ''yyyy-MM-dd'') and node.actual_end_date is null) then ''未完成''
        end as "nodeStatus"
        from pom_proj_plan_node node 
        left join pom_proj_plan plan on node.proj_plan_id = plan.id 
        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
        on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
        where tal.orgid is not null AND node.is_disable = 0 and plan_type='''||planType||''' and plan.proj_id = '''||businessId||''' and plan.approval_status = ''已审核'''||v_condition||') tt
    WHERE ROWNUM <= '||pageRows||' * '||pageIndex||') table_alias
 WHERE table_alias.rowno >= '||pageRows||' * ('||pageIndex||'-1) + 1';
 dbms_output.put_line(v_sql);
open taskList for v_sql;
END P_POM_KEYNODE_TASK_LIST;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_KN_PERFORM_DYNAMIC
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_KN_PERFORM_DYNAMIC" 
(
		IN_ORG_ID    IN VARCHAR2
	 ,DATASCOPE    IN VARCHAR2
	 ,IN_PLAN_TYPE IN VARCHAR2
	 ,IN_PROJID  IN VARCHAR2 
	 ,PAGEINDEX    IN INT
	 ,PAGESIZES    IN INT
	 ,P_PAGETYPE  IN INT
	 ,ITEMS        OUT SYS_REFCURSOR
	 ,TOTAL        OUT INT
) AS
		--传入的参数有三个，1：IN_ORG_ID（公司ID）
		--，2：DATASCOPE（统计期间，3个值“THIS_MONTH、THIS_QUARTER、THIS_YEAR"）
		--，3：PLAN_TYPE（计划类型，预留，估计后面会用的到）
		--，4：P_PAGETYPE（页面类型：1：已延误 2：已完成 3：应完成）//alterby 李小聪
		--关键节点计划-执行动态查询（wangck需要）
		--作者：陈丽
		--日期：2019/12/07
-- 20200326:晓聪修订

		CURSOR CUR_COMPANY_LIST(V_ORG_ID SYS_BUSINESS_UNIT.ID%TYPE) IS
				SELECT P.ID, P.PARENT_ID, P.ORG_NAME FROM SYS_BUSINESS_UNIT P WHERE P.IS_COMPANY = 1 START WITH P.ID = V_ORG_ID CONNECT BY PRIOR P.ID = P.PARENT_ID;
		V_SQL_TOTAL     CLOB := ' ';
		V_SQL           CLOB := ' ';
		V_SQL_DATASCOPE CLOB := ' ';
		V_COMPANY_LIST  CLOB := ' ';

BEGIN

  dbms_output.put_line('开始');
--月度
--已延误
		IF DATASCOPE = 'thisMonth' AND P_PAGETYPE=1  THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL   AND PN.PLAN_END_DATE BETWEEN 
		 (	SELECT   m_begin  FROM v_pom_month_quarter_year )  AND
 (	SELECT m_end  FROM v_pom_month_quarter_year) ';
--月度
--已完成--当前已延误项目
	ELSIF DATASCOPE = 'thisProjAll' AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := ' AND   1=1 AND pj.id='''||IN_PROJID||'''AND ((TRUNC(SYSDATE) >= pn.PLAN_END_DATE AND pn.ACTUAL_END_DATE IS NULL)  or (PLAN_END_DATE- pn.PLAN_END_DATE>0)) ';
	---当前已延误项目
	ELSIF DATASCOPE = 'thisCompanyAll' AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := ' AND   1=1 AND ((TRUNC(SYSDATE) >= pn.PLAN_END_DATE AND pn.ACTUAL_END_DATE IS NULL)  or (pn.ACTUAL_END_DATE- pn.PLAN_END_DATE>0)  AND pn.ACTUAL_END_DATE IS NULL ) ';
				
		ELSIF DATASCOPE = 'thisMonth' AND P_PAGETYPE=2  THEN
				V_SQL_DATASCOPE := ' AND  PN.ACTUAL_END_DATE IS  NOT NULL  AND PN.PLAN_END_DATE BETWEEN 
		 (	SELECT   m_begin  FROM v_pom_month_quarter_year )  AND
 (	SELECT m_end  FROM v_pom_month_quarter_year)';

--月度
--应完成

		ELSIF DATASCOPE = 'thisMonth' AND P_PAGETYPE=3  THEN
				V_SQL_DATASCOPE := 'AND PN.PLAN_END_DATE BETWEEN 
		 (	SELECT   m_begin  FROM v_pom_month_quarter_year )  AND
 (	SELECT m_end  FROM v_pom_month_quarter_year) ';

--季度
--已延误
	ELSIF DATASCOPE = 'thisQuarter' AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := ' AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL    AND PN.PLAN_END_DATE BETWEEN
	 (	SELECT   year_begin  FROM v_pom_month_quarter_year )  AND
 (	SELECT year_end  FROM v_pom_month_quarter_year)';
--季度
--已完成
	ELSIF DATASCOPE = 'thisQuarter' AND P_PAGETYPE=2 THEN
				V_SQL_DATASCOPE := 'AND  PN.ACTUAL_END_DATE IS  NOT NULL AND PN.PLAN_END_DATE BETWEEN
	 (	SELECT   year_begin  FROM v_pom_month_quarter_year )  AND
 (	SELECT year_end  FROM v_pom_month_quarter_year)';
--季度
--季度应完成
	ELSIF DATASCOPE = 'thisQuarter' AND P_PAGETYPE=3 THEN
				V_SQL_DATASCOPE := '  AND PN.PLAN_END_DATE BETWEEN
	 (	SELECT   year_begin  FROM v_pom_month_quarter_year )  AND
 (	SELECT year_end  FROM v_pom_month_quarter_year)';
--年度
--已延误
		ELSIF DATASCOPE = 'thisYear'AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL  
			 AND  PN.PLAN_END_DATE BETWEEN  		 (	SELECT   year_begin  FROM v_pom_month_quarter_year )  AND
 (	SELECT year_end  FROM v_pom_month_quarter_year) ';
--年度
--已完成
		ELSIF DATASCOPE = 'thisYear'AND P_PAGETYPE=2 THEN
				V_SQL_DATASCOPE := 'AND  PN.ACTUAL_END_DATE IS  NOT NULL  
				 AND  PN.PLAN_END_DATE BETWEEN  		 (	SELECT   year_begin  FROM v_pom_month_quarter_year )  AND
 (	SELECT year_end  FROM v_pom_month_quarter_year) ';
--年度
--应完成
		ELSIF DATASCOPE = 'thisYear' AND P_PAGETYPE=3 THEN
				V_SQL_DATASCOPE := ' AND  PN.PLAN_END_DATE BETWEEN  		 (	SELECT   year_begin  FROM v_pom_month_quarter_year )  AND
 (	SELECT year_end  FROM v_pom_month_quarter_year)  ';
--全部，没有时间限
--已延误
	ELSIF DATASCOPE = 'thisAll' AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL ';
--计划所有节点
	ELSIF DATASCOPE = 'thisAll' AND P_PAGETYPE=2 THEN
				V_SQL_DATASCOPE := ' AND   1=1 ';
	ELSIF DATASCOPE = 'thisAll' AND P_PAGETYPE=3 THEN
				V_SQL_DATASCOPE := '1=2 ';
	
				
			

		END IF;
		
		FOR ITEM_COMPANY_LIST IN CUR_COMPANY_LIST(IN_ORG_ID)
		LOOP
				/*DBMS_OUTPUT.PUT_LINE(ITEM_COMPANY_LIST.ORG_NAME || ',PARENT_ID' ||
        ITEM_COMPANY_LIST.PARENT_ID || ',ID:' ||
        ITEM_COMPANY_LIST.ID);*/
				V_COMPANY_LIST := V_COMPANY_LIST || '''' || ITEM_COMPANY_LIST.ID || '''' || ',';
		END LOOP;
-- 	dbms_output.put_line(V_COMPANY_LIST);
		V_COMPANY_LIST := '('  || SUBSTR(V_COMPANY_LIST, 1, LENGTH(V_COMPANY_LIST) - 1) || ')';
-- 		dbms_output.put_line(V_COMPANY_LIST);
IF  V_COMPANY_LIST='()'
	 THEN  V_COMPANY_LIST := '('''||IN_ORG_ID||''')';
END  IF;
-- 	dbms_output.put_line(V_COMPANY_LIST);
		V_SQL := V_SQL ||
						 'SELECT ROW_NUMBER() OVER( ORDER BY  PN.PROJ_PLAN_ID,  PN.NODE_CODE) as ROW_CODE,PP.COMPANY_ID, PP.COMPANY_NAME AS COMPANY_NAME,PP.PROJ_name AS PROJ_NAME,PP.PLAN_NAME AS PLAN_NAME, PN.ID,PN.PROJ_PLAN_ID,PN.ORIGINAL_NODE_ID
						 ,CASE WHEN fb.id IS NULL THEN
            pn.NODE_NAME
         WHEN fb.id IS NOT NULL AND fb.FEEDBACK_TYPE <> ''CARRY_OUT'' THEN
            pn.NODE_NAME||''【预计完成日期:''||to_char(fb.ESTIMATE_END_TIME,''yyyy-MM-dd'')||''】''
        WHEN fb.id IS NOT NULL AND fb.FEEDBACK_TYPE = ''CARRY_OUT'' AND fb.APPROVAL_STATUS=''未审核'' THEN
            pn.NODE_NAME||''【完成反馈未发起】''
        WHEN fb.id IS NOT NULL AND fb.FEEDBACK_TYPE = ''CARRY_OUT'' AND fb.APPROVAL_STATUS=''审核中'' THEN
            pn.NODE_NAME||''【完成反馈审核中】''
        WHEN fb.id IS NOT NULL AND fb.FEEDBACK_TYPE = ''CARRY_OUT'' AND fb.APPROVAL_STATUS=''已审核'' THEN
            pn.NODE_NAME||''【实际完成日期:''||to_char(fb.ACTUAL_END_TIME,''yyyy-MM-dd'')||''】''
     END AS NODE_NAME
						 , PN.NODE_CODE, PN.NODE_LEVEL, PN.PROJ_STAGE, PN.MAIN_RESPONSIBILITY, PN.DUTY_DEPARTMENT, TO_CHAR(PN.PLAN_START_DATE, ''yyyy-MM-dd'') AS PLAN_START_DATE, TO_CHAR(PN.PLAN_END_DATE, ''yyyy-MM-dd'') AS PLAN_END_DATE, PN.IS_DISABLE, PN.COMPLETION_STANDARD, PN.COMPLETION_RESULTS_REMARK, TO_CHAR(PN.ACTUAL_END_DATE, ''yyyy-MM-dd'') AS ACTUAL_END_DATE
	, case 
 --未到期不亮灯
 WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
 --到期当天内完成反馈
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
 then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
  --到期1-5天内完成反馈
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
 then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
 --到期未反馈黄灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 1 and 4
 THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>'' 
  --到期超过5天未反馈红灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(PLAN_END_DATE)) >5) THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' 
 ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END
  AS PLAN_STATUS, TO_CHAR(PN.ESTIMATE_END_DATE,''YYYY-MM-DD'') AS "ESTIMATE_END_DATE" ,	nps.CHARGE_PERSON
	FROM  pom_proj_plan_node pn 
LEFT JOIN pom_proj_plan pp ON pn.proj_plan_id = pp.id 
LEFT JOIN  POM_NODE_FEEDBACK d on  d.FEEDBACK_NODE_ID=pn.id  and  d.APPROVAL_STATUS=''已审核'' and   FEEDBACK_TYPE=''CARRY_OUT''
LEFT JOIN  SYS_PROJECT_STAGE ps on  ps.id=pp.proj_id
LEFT JOIN SYS_PROJECT pj on  ps.PROJECT_ID =pj.id
LEFT JOIN(	SELECT  NODE_ID, listagg(CHARGE_PERSON,'','') WITHIN GROUP (ORDER BY CHARGE_PERSON )  as CHARGE_PERSON
	FROM POM_NODE_CHARGE_PERSON 
	GROUP BY NODE_ID) nps on  nps.NODE_ID=pn.id
	LEFT JOIN (SELECT B.*
  FROM (SELECT A.*,
               ROW_NUMBER() OVER(partition by a.feedback_node_id order by A.CREATED desc nulls last) rn
          FROM POM_NODE_FEEDBACK A) B
 WHERE RN = 1) fb on fb.feedback_node_id=pn.id
	WHERE   PP.PLAN_TYPE = ''关键节点计划'' AND PN.IS_DISABLE=0  AND pp.APPROVAL_STATUS = ''已审核'' AND 1=1 
	and  ((pp.proj_id ='''||IN_PROJID||''' or pn.proj_plan_id='''||IN_PROJID||'''  OR  pj.id='''||IN_PROJID||''' )
	OR PP.COMPANY_ID IN ' || V_COMPANY_LIST ||' ) '|| V_SQL_DATASCOPE || '  ORDER BY PN.PROJ_PLAN_ID,  PN.NODE_CODE';

		DBMS_OUTPUT.PUT_LINE(V_SQL);
			V_SQL_TOTAL := V_SQL_TOTAL|| 				 'SELECT  TO_CHAR(COUNT(pn.ID))
	FROM  pom_proj_plan_node pn 
LEFT JOIN pom_proj_plan pp ON pn.proj_plan_id = pp.id 
LEFT JOIN  POM_NODE_FEEDBACK d on  d.FEEDBACK_NODE_ID=pn.id  and  d.APPROVAL_STATUS=''已审核'' and   FEEDBACK_TYPE=''CARRY_OUT''
LEFT JOIN  SYS_PROJECT_STAGE ps on  ps.id=pp.proj_id
LEFT JOIN SYS_PROJECT pj on  ps.PROJECT_ID =pj.id
LEFT JOIN(	SELECT  NODE_ID, listagg(CHARGE_PERSON,'','') WITHIN GROUP (ORDER BY CHARGE_PERSON )  as CHARGE_PERSON
	FROM POM_NODE_CHARGE_PERSON 
	GROUP BY NODE_ID) nps on  nps.NODE_ID=pn.id
         
 
	WHERE  PP.PLAN_TYPE = ''关键节点计划''     AND pp.APPROVAL_STATUS = ''已审核'' AND 1=1  AND PN.IS_DISABLE=0 
	and  ((pp.proj_id ='''||IN_PROJID||''' or pn.proj_plan_id='''||IN_PROJID||'''  OR  pj.id='''||IN_PROJID||''' )
	OR PP.COMPANY_ID IN ' || V_COMPANY_LIST ||' ) '|| V_SQL_DATASCOPE || '  ORDER BY PN.PROJ_PLAN_ID,  PN.NODE_CODE';

		--DBMS_OUTPUT.PUT_LINE(V_SQL_TOTAL);
		 execute immediate V_SQL_TOTAL into TOTAL; 
	--	 DBMS_OUTPUT.PUT_LINE(TOTAL);

		OPEN ITEMS FOR V_SQL;

END P_POM_KN_PERFORM_DYNAMIC;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_KN_PERFORM_DYNAMIC_OUT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_KN_PERFORM_DYNAMIC_OUT" 
(
		IN_ORG_ID    IN VARCHAR2
	 ,DATASCOPE    IN VARCHAR2

	 ,IN_PROJID  IN VARCHAR2 
	 ,P_PAGETYPE  IN INT

	 ,ITEMS        OUT SYS_REFCURSOR
	 ,TOTAL        OUT INT
) AS
		--传入的参数有三个，1：IN_ORG_ID（公司ID）
		--，2：DATASCOPE（统计期间，3个值“THIS_MONTH、THIS_QUARTER、THIS_YEAR"）
		--，3：PLAN_TYPE（计划类型，预留，估计后面会用的到）
		--，4：P_PAGETYPE（页面类型：1：已延误 2：已完成 3：应完成）//alterby 李小聪
		--关键节点计划-执行动态查询（wangck需要）
		--作者：陈丽
		--日期：2019/12/07
-- 20200326:晓聪修订

		CURSOR CUR_COMPANY_LIST(V_ORG_ID SYS_BUSINESS_UNIT.ID%TYPE) IS
				SELECT P.ID, P.PARENT_ID, P.ORG_NAME FROM SYS_BUSINESS_UNIT P WHERE P.IS_COMPANY = 1 START WITH P.ID = V_ORG_ID CONNECT BY PRIOR P.ID = P.PARENT_ID;
		V_SQL_TOTAL     CLOB := ' ';
		V_SQL           CLOB := ' ';
		V_SQL_DATASCOPE CLOB := ' ';
		V_COMPANY_LIST  CLOB := ' ';

BEGIN

  dbms_output.put_line('开始');
--月度
--已延误

		IF DATASCOPE = 'thisMonth' AND P_PAGETYPE=1  THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL   AND PN.PLAN_END_DATE BETWEEN 
		 (	SELECT   m_begin  FROM v_pom_month_quarter_year )  AND
 (	SELECT m_end  FROM v_pom_month_quarter_year) ';
--月度
--已完成--当前已延误项目
	ELSIF DATASCOPE = 'thisProjAll' AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := ' AND   1=1 AND pj.id='''||IN_PROJID||'''AND ((TRUNC(SYSDATE) >= pn.PLAN_END_DATE AND pn.ACTUAL_END_DATE IS NULL)  or (ACTUAL_END_TIME- pn.PLAN_END_DATE>0)) ';
	--已完成--当前已延误项目
	ELSIF DATASCOPE = 'thisCompanyAll' AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := ' AND   1=1 AND pj.id='''||IN_PROJID||'''AND ((TRUNC(SYSDATE) >= pn.PLAN_END_DATE AND pn.ACTUAL_END_DATE IS NULL)  or (ACTUAL_END_TIME- pn.PLAN_END_DATE>0)) ';
				
		ELSIF DATASCOPE = 'thisMonth' AND P_PAGETYPE=2  THEN
				V_SQL_DATASCOPE := ' AND  PN.ACTUAL_END_DATE IS  NOT NULL  AND PN.PLAN_END_DATE BETWEEN 
		 (	SELECT   m_begin  FROM v_pom_month_quarter_year )  AND
 (	SELECT m_end  FROM v_pom_month_quarter_year)';

--月度
--应完成

		ELSIF DATASCOPE = 'thisMonth' AND P_PAGETYPE=3  THEN
				V_SQL_DATASCOPE := 'AND PN.PLAN_END_DATE BETWEEN 
		 (	SELECT   m_begin  FROM v_pom_month_quarter_year )  AND
 (	SELECT m_end  FROM v_pom_month_quarter_year) ';

--季度
--已延误
	ELSIF DATASCOPE = 'thisQuarter' AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := ' AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL    AND PN.PLAN_END_DATE BETWEEN
	 (	SELECT   year_begin  FROM v_pom_month_quarter_year )  AND
 (	SELECT year_end  FROM v_pom_month_quarter_year)';
--季度
--已完成
	ELSIF DATASCOPE = 'thisQuarter' AND P_PAGETYPE=2 THEN
				V_SQL_DATASCOPE := 'AND  PN.ACTUAL_END_DATE IS  NOT NULL AND PN.PLAN_END_DATE BETWEEN
	 (	SELECT   year_begin  FROM v_pom_month_quarter_year )  AND
 (	SELECT year_end  FROM v_pom_month_quarter_year)';
--季度
--季度应完成
	ELSIF DATASCOPE = 'thisQuarter' AND P_PAGETYPE=3 THEN
				V_SQL_DATASCOPE := '  AND PN.PLAN_END_DATE BETWEEN
	 (	SELECT   year_begin  FROM v_pom_month_quarter_year )  AND
 (	SELECT year_end  FROM v_pom_month_quarter_year)';
--年度
--已延误
		ELSIF DATASCOPE = 'thisYear'AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL  
			 AND  PN.PLAN_END_DATE BETWEEN  		 (	SELECT   year_begin  FROM v_pom_month_quarter_year )  AND
 (	SELECT year_end  FROM v_pom_month_quarter_year) ';
--年度
--已完成
		ELSIF DATASCOPE = 'thisYear'AND P_PAGETYPE=2 THEN
				V_SQL_DATASCOPE := 'AND  PN.ACTUAL_END_DATE IS  NOT NULL  
				 AND  PN.PLAN_END_DATE BETWEEN  		 (	SELECT   year_begin  FROM v_pom_month_quarter_year )  AND
 (	SELECT year_end  FROM v_pom_month_quarter_year) ';
--年度
--应完成
		ELSIF DATASCOPE = 'thisYear' AND P_PAGETYPE=3 THEN
				V_SQL_DATASCOPE := ' AND  PN.PLAN_END_DATE BETWEEN  		 (	SELECT   year_begin  FROM v_pom_month_quarter_year )  AND
 (	SELECT year_end  FROM v_pom_month_quarter_year)  ';
--全部，没有时间限
--已延误
	ELSIF DATASCOPE = 'thisAll' AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL ';
--计划所有节点
	ELSIF DATASCOPE = 'thisAll' AND P_PAGETYPE=2 THEN
				V_SQL_DATASCOPE := ' AND   1=1 ';
	ELSIF DATASCOPE = 'thisAll' AND P_PAGETYPE=3 THEN
				V_SQL_DATASCOPE := '1=2 ';
	
				
			

		END IF;
		
		FOR ITEM_COMPANY_LIST IN CUR_COMPANY_LIST(IN_ORG_ID)
		LOOP
				/*DBMS_OUTPUT.PUT_LINE(ITEM_COMPANY_LIST.ORG_NAME || ',PARENT_ID' ||
        ITEM_COMPANY_LIST.PARENT_ID || ',ID:' ||
        ITEM_COMPANY_LIST.ID);*/
				V_COMPANY_LIST := V_COMPANY_LIST || '''' || ITEM_COMPANY_LIST.ID || '''' || ',';
		END LOOP;
-- 	dbms_output.put_line(V_COMPANY_LIST);
		V_COMPANY_LIST := '('  || SUBSTR(V_COMPANY_LIST, 1, LENGTH(V_COMPANY_LIST) - 1) || ')';
-- 		dbms_output.put_line(V_COMPANY_LIST);
IF  V_COMPANY_LIST='()'
	 THEN  V_COMPANY_LIST := '('''||IN_ORG_ID||''')';
END  IF;
-- 	dbms_output.put_line(V_COMPANY_LIST);
		V_SQL := V_SQL ||
						 'SELECT ROW_NUMBER() OVER( ORDER BY  PN.PROJ_PLAN_ID,  PN.NODE_CODE) as ROW_CODE,PP.COMPANY_ID, PP.COMPANY_NAME AS COMPANY_NAME,PP.PROJ_name AS PROJ_NAME,PP.PLAN_NAME AS PLAN_NAME, PN.ID,PN.PROJ_PLAN_ID,PN.ORIGINAL_NODE_ID,CASE WHEN PN.IS_DISABLE = 0 THEN	PN.NODE_NAME ELSE	''【禁用】'' || PN.NODE_NAME END AS NODE_NAME, PN.NODE_CODE, PN.NODE_LEVEL, PN.PROJ_STAGE, PN.MAIN_RESPONSIBILITY, PN.DUTY_DEPARTMENT, TO_CHAR(PN.PLAN_START_DATE, ''yyyy-MM-dd'') AS PLAN_START_DATE, TO_CHAR(PN.PLAN_END_DATE, ''yyyy-MM-dd'') AS PLAN_END_DATE, PN.IS_DISABLE, PN.COMPLETION_STANDARD,PN.STANDARD_SCORE, PN.COMPLETION_RESULTS_REMARK, TO_CHAR(PN.ACTUAL_END_DATE,
 ''yyyy-MM-dd'') AS ACTUAL_END_DATE
	, case 
 --未到期不亮灯
 WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
 --到期当天内完成反馈
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
 then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
  --到期1-5天内完成反馈
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
 then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
 --到期未反馈黄灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 1 and 4
 THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>'' 
  --到期超过5天未反馈红灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(PLAN_END_DATE)) >5) THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' 
 ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END
  AS PLAN_STATUS, TO_CHAR(PN.ESTIMATE_END_DATE,''YYYY-MM-DD'') AS "ESTIMATE_END_DATE" ,	nps.CHARGE_PERSON
	FROM  pom_proj_plan_node pn 
LEFT JOIN pom_proj_plan pp ON pn.proj_plan_id = pp.id 
LEFT JOIN  POM_NODE_FEEDBACK d on  d.FEEDBACK_NODE_ID=pn.id  and  d.APPROVAL_STATUS=''已审核'' and   FEEDBACK_TYPE=''CARRY_OUT''
LEFT JOIN  SYS_PROJECT_STAGE ps on  ps.id=pp.proj_id
LEFT JOIN SYS_PROJECT pj on  ps.PROJECT_ID =pj.id
LEFT JOIN(	SELECT  NODE_ID, listagg(CHARGE_PERSON,'','') WITHIN GROUP (ORDER BY CHARGE_PERSON )  as CHARGE_PERSON
	FROM POM_NODE_CHARGE_PERSON 
	GROUP BY NODE_ID) nps on  nps.NODE_ID=pn.id
	WHERE   PP.PLAN_TYPE = ''关键节点计划'' AND PN.IS_DISABLE=0  AND pp.APPROVAL_STATUS = ''已审核'' AND 1=1 
	and  ((pp.proj_id ='''||IN_PROJID||''' or pn.proj_plan_id='''||IN_PROJID||'''  OR  pj.id='''||IN_PROJID||''' )
	OR PP.COMPANY_ID IN ' || V_COMPANY_LIST ||' ) '|| V_SQL_DATASCOPE || '  ORDER BY PN.PROJ_PLAN_ID,  PN.NODE_CODE';

		DBMS_OUTPUT.PUT_LINE(V_SQL);
			V_SQL_TOTAL := V_SQL_TOTAL|| 				 'SELECT  TO_CHAR(COUNT(pn.ID))
	FROM  pom_proj_plan_node pn 
LEFT JOIN pom_proj_plan pp ON pn.proj_plan_id = pp.id 
LEFT JOIN  POM_NODE_FEEDBACK d on  d.FEEDBACK_NODE_ID=pn.id  and  d.APPROVAL_STATUS=''已审核'' and   FEEDBACK_TYPE=''CARRY_OUT''
LEFT JOIN  SYS_PROJECT_STAGE ps on  ps.id=pp.proj_id
LEFT JOIN SYS_PROJECT pj on  ps.PROJECT_ID =pj.id
LEFT JOIN(	SELECT  NODE_ID, listagg(CHARGE_PERSON,'','') WITHIN GROUP (ORDER BY CHARGE_PERSON )  as CHARGE_PERSON
	FROM POM_NODE_CHARGE_PERSON 
	GROUP BY NODE_ID) nps on  nps.NODE_ID=pn.id
	WHERE  PP.PLAN_TYPE = ''关键节点计划''     AND pp.APPROVAL_STATUS = ''已审核'' AND 1=1  AND PN.IS_DISABLE=0 
	and  ((pp.proj_id ='''||IN_PROJID||''' or pn.proj_plan_id='''||IN_PROJID||'''  OR  pj.id='''||IN_PROJID||''' )
	OR PP.COMPANY_ID IN ' || V_COMPANY_LIST ||' ) '|| V_SQL_DATASCOPE || '  ORDER BY PN.PROJ_PLAN_ID,  PN.NODE_CODE';

		--DBMS_OUTPUT.PUT_LINE(V_SQL_TOTAL);
		 execute immediate V_SQL_TOTAL into TOTAL; 
	--	 DBMS_OUTPUT.PUT_LINE(TOTAL);

		OPEN ITEMS FOR V_SQL;

END P_POM_KN_Perform_dynamic_Out;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MAIN_PLAN_MONITOR
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_MAIN_PLAN_MONITOR" (
    userid                 IN                     VARCHAR2,--用户id
    planid                 IN                     VARCHAR2,--计划id
    timeout_info           OUT                    SYS_REFCURSOR,--超期未完成任务 
    timeout_title          OUT                    VARCHAR2,--标题 超期未完成任务：共0项
    expect_timeout_info    OUT                    SYS_REFCURSOR,--四、预计超期任务 
    expect_timeout_title   OUT                    VARCHAR2,--标题预计超期任务：共0项
    completion_level_rate_title   OUT                    VARCHAR2,---一、按任务级别统计完成率 (%)
    pandect_info           out SYS_REFCURSOR,       --计划明细一览表
    completion_level_rate  out SYS_REFCURSOR---按任务等级统计完成率
) AS
--项目主项计划监控，详情页 ：超期未完成任务,预计超期任务
--作者：陈丽定义，李小聪实现
--日期：2020/02/26
  v_timeout_count VARCHAR2(20):='';
  v_expect_timeout_count VARCHAR2(20):='';
BEGIN
completion_level_rate_title:='一、按任务级别统计完成率 (%)';
 OPEN timeout_info FOR
      SELECT   a.*,nvl(b.IS_UN_WATCH,1)  as  IS_UN_WATCH ,b.UN_WATCH_TIME  ,b.WATCH_TIME  
      FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' --and   b.WATCH_TIME is  not   null
      WHERE     a.PLAN_ID=''||planid||''
      AND  TRUNC( a.PLAN_END_DATE)-TRUNC(SYSDATE)<0  and  a.ACTUAL_END_DATE  is null   ;
 OPEN expect_timeout_info FOR 
          SELECT   a.*,nvl(b.IS_UN_WATCH,1)  as  IS_UN_WATCH ,b.UN_WATCH_TIME  ,b.WATCH_TIME  
      FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND   TRUNC( a.ESTIMATE_END_DATE)-TRUNC(SYSDATE)<0   and  a.ACTUAL_END_DATE  is null ;


SELECT  (SELECT  TO_CHAR(COUNT(NODE_ID))        FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND  TRUNC( PLAN_END_DATE)-TRUNC(SYSDATE)<0  and  ACTUAL_END_DATE  is null   )  
INTO v_timeout_count  FROM  DUAL;
SELECT  (SELECT  TO_CHAR(COUNT(NODE_ID))        FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND   TRUNC( ESTIMATE_END_DATE)-TRUNC(SYSDATE)<0  and  ACTUAL_END_DATE  is null ) 
INTO v_expect_timeout_count  FROM  DUAL;
    timeout_title := '超期未完成任务：共'||v_timeout_count||'项';
    expect_timeout_title := '预计超期任务：共'||v_expect_timeout_count||'项';

    ----计划明细一览表
    OPEN pandect_info FOR
         SELECT   a.*,nvl(b.IS_UN_WATCH,1)  as  IS_UN_WATCH ,b.UN_WATCH_TIME  ,b.WATCH_TIME  
      FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' --and   b.WATCH_TIME is  not   null
      WHERE     a.PLAN_ID=''||planid||'' ORDER BY NODE_CODE asc ;
     
    --按任务等级统计完成率
    OPEN Completion_level_rate FOR
--      SELECT  '里程碑' as "nodeName",1 as "percentage" from dual
--      UNION all 
--      SELECT  '一级节点' as "nodeName",1 as "percentage" from dual
--     UNION all 
--      SELECT  '二级节点' as "nodeName",1 as "percentage" from dual;
		SELECT   NODE_LEVEL  as "nodeName",	ROUND(SUM( CASE WHEN   B.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END) /COUNT(b.id),2)  AS "percentage" 
			FROM POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE B ON A.ID=B.PROJ_PLAN_ID
			INNER JOIN SYS_PROJECT_STAGE C ON C.ID=PROJ_ID
			INNER JOIN SYS_PROJECT D ON D.ID=C.PROJECT_ID
			WHERE     A.PLAN_TYPE='项目主项计划' AND A.APPROVAL_STATUS='已审核' AND B.IS_DISABLE=0  AND B.PLAN_END_DATE<=SYSDATE and  a.id=''||planid||''
			GROUP BY NODE_LEVEL    ORDER BY   CASE  WHEN   NODE_LEVEL='里程碑' THEN  0 WHEN   NODE_LEVEL='一级节点' THEN  1 WHEN   NODE_LEVEL='二级节点' THEN  3   WHEN   NODE_LEVEL='三级节点' THEN  4  WHEN   NODE_LEVEL='四级节点' THEN  5 else 6 END asc;
		 
		 
		 
		 

END p_pom_main_plan_monitor;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MAIN_PLAN_W_OVERDUE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_MAIN_PLAN_W_OVERDUE" (
    userid                 IN                     VARCHAR2,--用户id
    planid                 IN                     VARCHAR2,--计划id
    timeout_info           OUT                    SYS_REFCURSOR,--三、超期未完成任务 
    timeout_title          OUT                    VARCHAR2,--标题 超期未完成任务：共0项
    expect_timeout_info    OUT                    SYS_REFCURSOR,--四、预计超期任务 
    expect_timeout_title   OUT                    VARCHAR2--标题预计超期任务：共0项
) AS
--项目主项计划监控，详情页 ：超期未完成任务,预计超期任务
--作者：陈丽定义，李小聪实现
--日期：2020/02/26
  v_timeout_count VARCHAR2(20):='';
  v_expect_timeout_count VARCHAR2(20):='';
BEGIN
 OPEN timeout_info FOR
      SELECT   a.*,nvl(b.IS_UN_WATCH,1)  as  IS_UN_WATCH ,b.UN_WATCH_TIME  ,b.WATCH_TIME  
      FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' --and   b.WATCH_TIME is  not   null
      WHERE     a.PLAN_ID=''||planid||''
      AND  TRUNC( a.PLAN_END_DATE)-TRUNC(SYSDATE)<0  and  a.ACTUAL_END_DATE  is null   ;
 OPEN expect_timeout_info FOR 
          SELECT   a.*,nvl(b.IS_UN_WATCH,1)  as  IS_UN_WATCH ,b.UN_WATCH_TIME  ,b.WATCH_TIME  
      FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND   TRUNC( a.ESTIMATE_END_DATE)-TRUNC(SYSDATE)<0   and  a.ACTUAL_END_DATE  is null ;


SELECT  (SELECT  TO_CHAR(COUNT(NODE_ID))        FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND  TRUNC( PLAN_END_DATE)-TRUNC(SYSDATE)<0  and  ACTUAL_END_DATE  is null   )  
INTO v_timeout_count  FROM  DUAL;
SELECT  (SELECT  TO_CHAR(COUNT(NODE_ID))        FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND   TRUNC( ESTIMATE_END_DATE)-TRUNC(SYSDATE)<0  and  ACTUAL_END_DATE  is null ) 
INTO v_expect_timeout_count  FROM  DUAL;
    timeout_title := '超期未完成任务：共'||v_timeout_count||'项';
    expect_timeout_title := '预计超期任务：共'||v_expect_timeout_count||'项';



END p_pom_main_plan_w_overdue;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_MD_SITUATION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_MD_SITUATION" (
    projtreeinfo OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN projtreeinfo FOR SELECT
                              a.id,
                              a.parent_id   parentsid,
                              a.org_name    orgname,
                              b.nums        projtotal,
                              nvl(c.salesarea, 0) salesarea,
                              nvl(c.salescarport, 0) salescarport
                          FROM
                              sys_business_unit a
                              INNER JOIN (
                                  SELECT
                                      COUNT(b.company_id) nums,
                                      b.company_id
                                  FROM
                                      mdm_project b
                                  WHERE
                                      b.approval_status = '已审核'
                                  GROUP BY
                                      b.company_id
                              ) b ON a.id = b.company_id
                              LEFT JOIN (
                                  SELECT
                                      company_id,
                                      SUM(mdm_obj_phase_index.total_sale_area) salesarea,
                                      SUM(mdm_obj_phase_index.underground_total_sale_carport) salescarport
                                  FROM
                                      mdm_project left
                                      JOIN (
                                          SELECT
                                              t1.id,
                                              t1.phase_id,
                                              t1.proj_id,
                                              t2.phase_order
                                          FROM
                                              mdm_project_phase                                                                  t1
                                              LEFT JOIN (
                                                  SELECT
                                                      proj_id,
                                                      MAX(phase_order) AS phase_order
                                                  FROM
                                                      mdm_project_phase
                                                  GROUP BY
                                                      proj_id
                                              ) t2 ON t1.proj_id = t2.proj_id
                                                      AND t1.phase_order = t2.phase_order
                                          WHERE
                                              t2.phase_order IS NOT NULL
                                      ) phase ON mdm_project.project_original_id = phase.proj_id
                                      LEFT JOIN mdm_phase ON phase.phase_id = mdm_phase.id
                                      LEFT JOIN mdm_obj_phase_index ON phase.id = mdm_obj_phase_index.obj_phase_id
                                                                       AND mdm_obj_phase_index.obj_type = 0
                                  WHERE
                                      approval_status = '已审核'
                                  GROUP BY
                                      company_id
                              ) c ON c.company_id = a.id
                          WHERE
                              a.org_type = 0
                              AND ( a.id != '000100000000000000000000000000'
                                    AND a.id != '000200000000000000000000000000' );

END p_pom_md_situation;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MD_SITUATION_ODL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_MD_SITUATION_ODL" (
    projtreeinfo OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN projtreeinfo FOR SELECT
                              a.id,
                              a.parent_id   parentsid,
                              a.org_name    orgname,
                              b.nums        projtotal,
                              nvl(c.salesarea, 0) salesarea,
                              nvl(c.salescarport, 0) salescarport
                          FROM
                              sys_business_unit a
                              INNER JOIN (
                                  SELECT
                                      COUNT(b.company_id) nums,
                                      b.company_id
                                  FROM
                                      mdm_project b
                                  WHERE
                                      b.approval_status = '已审核'
                                  GROUP BY
                                      b.company_id
                              ) b ON a.id = b.company_id
                              LEFT JOIN (
                                  SELECT
                                      company_id,
                                      SUM(mdm_obj_phase_index.total_sale_area) salesarea,
                                      SUM(mdm_obj_phase_index.underground_total_sale_carport) salescarport
                                  FROM
                                      mdm_project left
                                      JOIN (
                                          SELECT
                                              t1.id,
                                              t1.phase_id,
                                              t1.proj_id,
                                              t2.phase_order
                                          FROM
                                              mdm_project_phase                                                                  t1
                                              LEFT JOIN (
                                                  SELECT
                                                      proj_id,
                                                      MAX(phase_order) AS phase_order
                                                  FROM
                                                      mdm_project_phase
                                                  GROUP BY
                                                      proj_id
                                              ) t2 ON t1.proj_id = t2.proj_id
                                                      AND t1.phase_order = t2.phase_order
                                          WHERE
                                              t2.phase_order IS NOT NULL
                                      ) phase ON mdm_project.project_original_id = phase.proj_id
                                      LEFT JOIN mdm_phase ON phase.phase_id = mdm_phase.id
                                      LEFT JOIN mdm_obj_phase_index ON phase.id = mdm_obj_phase_index.obj_phase_id
                                                                       AND mdm_obj_phase_index.obj_type = 0
                                  WHERE
                                      approval_status = '已审核'
                                  GROUP BY
                                      company_id
                              ) c ON c.company_id = a.id
                          WHERE
                              a.org_type = 0
                              AND ( a.id != '000100000000000000000000000000'
                                    AND a.id != '000200000000000000000000000000' );

END p_pom_md_situation_odl;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MESSAGE_TYPE_LIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_MESSAGE_TYPE_LIST" (
     systemId VARCHAR2,
     userId VARCHAR2,
     MESSAGETYPEINFO  OUT SYS_REFCURSOR
) AS
 v_sys_code VARCHAR2 (50);
 is_exist_person number;
 v_get_code_sql VARCHAR2 (2000);
 v_sql Clob;
BEGIN 
        --判断登录人是否在组织架构中存在
        EXECUTE IMMEDIATE 'select count(*) from sys_user where id='''||userId||'''' INTO is_exist_person;
        IF is_exist_person > 0 THEN
            v_get_code_sql := 'select user_code from sys_user where id=:sys_code';
            EXECUTE IMMEDIATE v_get_code_sql INTO v_sys_code  using userId;
        ELSE
            v_sys_code := '';
        END IF;

        v_sql := 'SELECT 
            BASE.M_TYPE as "msgType",
            S_RESULT.TOTAL  as "msgTypeUnreadCount",
            S_RESULT.TITLE as "fristMsg",
            S_RESULT.ID as "id"
        FROM (
        (SELECT ''预警消息'' as "M_TYPE" FROM dual UNION ALL SELECT ''提醒消息'' as "M_TYPE" FROM dual UNION ALL SELECT ''催办消息'' as "M_TYPE" FROM dual) BASE
        LEFT JOIN (
        SELECT A.BIZ_MSG_CATEGORY,TOTAL,TITLE,A.ID FROM (
            (select SMRB.CREATED_TIME, SMRB.BIZ_MSG_CATEGORY, SMRB.ID
              from (
                SELECT CREATED_TIME,  
                           BIZ_MSG_CATEGORY,  
                           biz.ID,
                           dense_rank() over(partition by BIZ_MSG_CATEGORY order by CREATED_TIME desc) rank  
                      FROM SYS_MSG_RECORD_BIZ biz
                      LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
                      LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID  
                      WHERE BIZ.SYSTEM_ID='''||systemId||''' AND
                      ((sms.receiver_id = '''||v_sys_code||''') or (wechat.receiver_id = '''||v_sys_code||''' and sms.receiver_id is not null))
              )SMRB 
             where SMRB.rank = 1)A 
             LEFT JOIN 
             (
                select count(*) AS "TOTAL",BIZ_MSG_CATEGORY from SYS_MSG_RECORD_BIZ smrb 
                LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON smrb.ID = wechat.MSG_RECORD_BIZ_ID
                 LEFT JOIN SYS_MSG_RECORD_SMS sms ON smrb.ID = sms.MSG_RECORD_BIZ_ID
                left join SYS_MSG_READ_RECORD smrr on smrb.ID  = smrr.MSG_RECORD_BIZ_GUID --未阅读条数及分
                where SMRB.SYSTEM_ID='''||systemId||'''
                    and smrb.BIZ_MSG_CATEGORY is not null
                    and smrr.ID is null
                    AND ((sms.receiver_id = '''||v_sys_code||''') or (wechat.receiver_id = '''||v_sys_code||''' and smrr.reader_id is not null))
                GROUP BY BIZ_MSG_CATEGORY 
             )B ON A.BIZ_MSG_CATEGORY = B.BIZ_MSG_CATEGORY
             LEFT JOIN 
             (
               SELECT  WECHAT_MSG_TYPE,TITLE,MSG_RECORD_BIZ_ID FROM SYS_MSG_RECORD_WECHAT
             )C ON C.MSG_RECORD_BIZ_ID = A.ID
            )) S_RESULT ON BASE.M_TYPE = S_RESULT.BIZ_MSG_CATEGORY )';

                   DBMS_OUTPUT.PUT_LINE(v_sql);  
            OPEN MESSAGETYPEINFO FOR v_sql;

END P_POM_MESSAGE_TYPE_LIST;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MOBILE_CENTER_MESSAGE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_MOBILE_CENTER_MESSAGE" (
    MESSAGEINFO  OUT SYS_REFCURSOR
)
IS
a clob;
b clob;
c clob;
BEGIN
 a:='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAF62lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDIgNzkuMTYwOTI0LCAyMDE3LzA3LzEzLTAxOjA2OjM5ICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgKFdpbmRvd3MpIiB4bXA6Q3JlYXRlRGF0ZT0iMjAyMC0wMi0xMVQxMDoyMToyMCswODowMCIgeG1wOk1ldGFkYXRhRGF0ZT0iMjAyMC0wMi0xMVQxMDoyMToyMCswODowMCIgeG1wOk1vZGlmeURhdGU9IjIwMjAtMDItMTFUMTA6MjE6MjArMDg6MDAiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MDQ0MDI1MzItZTc0NS0yOTQzLTkzODEtM2Y1NDJkYTAyNWFmIiB4bXBNTTpEb2N1bWVudElEPSJhZG9iZTpkb2NpZDpwaG90b3Nob3A6MzljMTUyZmUtY2FmZi05YzRjLTkwZjgtNjU3YTFkMDM1ZjdjIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YjQ5Y2FjYzctZWY2Yy02NDRjLTk3NjctMTVlMjFhMjQzODdhIiBkYzpmb3JtYXQ9ImltYWdlL3BuZyIgcGhvdG9zaG9wOkNvbG9yTW9kZT0iMyIgcGhvdG9zaG9wOklDQ1Byb2ZpbGU9InNSR0IgSUVDNjE5NjYtMi4xIj4gPHhtcE1NOkhpc3Rvcnk+IDxyZGY6U2VxPiA8cmRmOmxpIHN0RXZ0OmFjdGlvbj0iY3JlYXRlZCIgc3RFdnQ6aW5zdGFuY2VJRD0ieG1wLmlpZDpiNDljYWNjNy1lZjZjLTY0NGMtOTc2Ny0xNWUyMWEyNDM4N2EiIHN0RXZ0OndoZW49IjIwMjAtMDItMTFUMTA6MjE6MjArMDg6MDAiIHN0RXZ0OnNvZnR3YXJlQWdlbnQ9IkFkb2JlIFBob3Rvc2hvcCBDQyAoV2luZG93cykiLz4gPHJkZjpsaSBzdEV2dDphY3Rpb249InNhdmVkIiBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOjA0NDAyNTMyLWU3NDUtMjk0My05MzgxLTNmNTQyZGEwMjVhZiIgc3RFdnQ6d2hlbj0iMjAyMC0wMi0xMVQxMDoyMToyMCswODowMCIgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWRvYmUgUGhvdG9zaG9wIENDIChXaW5kb3dzKSIgc3RFdnQ6Y2hhbmdlZD0iLyIvPiA8L3JkZjpTZXE+IDwveG1wTU06SGlzdG9yeT4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7KrSW+AAAL8ElEQVR42u1daWwU5xken3uADw7b4BpIisvV/nCTBpo6Tbn8Iw6kIa3VBqlRkdI/KZQiNUp6h9I2OEpLRIKbVk2AOCUSBX4UpYGEVCKHGyVFKWpsRG0otSvbsWzjYK+9xsbu80zmRaPNzto7O7Mzs8wrvZpjd2e+73ve+/tmNmtyclLxyT2U7Q+BD4hPPiA+ID75gPiA+OQD4gPikw+ID4hPPiA++YD4gPjkA5IBlGv0wc6dO1O68LVr15Tx8XGlrq5O6e3tVbq7u5VAIKBMTEwoUvLnNicnR4lEIsro6OjckpKSqrGxsc9nZ2fPxmfkPHxtAHwF+61ZWVnvYnsBn0/w9zhWr8dtXl6eMjIyol6PJOcLCgoUfF9xcpphw4YNqQOSJvocgLs3FAqtDwaDKwFGSMDkYOpJO57E9iK2r4BPgf/CczeEhthMNeAdGNy7ZLDJIsWxYOhxAS/G97ZiuxXbNvBeaEADfnPN9yFJkDbIn8EAHsX2VfBd8hmBMGlSKsF78dtmmMc6H5ApSHwEbThs+jdgiv6J0/dZDTTusxSAHMZ9DmasyaJTTNWpExD4BV7r59h/LA0a+AB4Oe5F7evLKEAkWkllgMLhsNLa2kobvy0/Pz9dfboN/A64GtyTMYCUlZWZNlM0UQQD21/BlGzjcQJHbYe20Le8Cb4F+5GM8CES+Zjl3Nzcb4J/RE1LJxg6WgI+7rVlToYawmTNDDH5Q15RgYH4U6p+yAJnv2Z4ePinSA53OZ0cpgxIbW2tqQt2dXUply5dasSAZLthABBc/CIajb6I9vzH04AsXbrUrGTWtLS0rKamOE2SbAKQp6EhGxQPkCEgR48eNeXQIZGPFxcXu6aDGih3w5etACgtbtcSQ0B6enqSBiMvL+8WRFe30pG7reOI9nYAkO94FpBkTQ47ilxjixvB0KrCLK1sg9BE3QyKISAzZ85MutOs3Lq1sxCwov7+/hrwcZbqb4TSyWcBRoWbzQGE5iswW8cZAnsOEBOS/gU3gzE6Oqog2KgqLy9XPGmykqllaTb65ngTS24h9mdsbKzy/Pnz2WjnRDrbacmMoQmTVe5WMHRUBnNVCA0ZcKvZsnLGsMjNSNBMQWDyFi5cWITtgOdMlsPXss2vQ/Nd3U5LGqdlw8MeAGR8ZGRk0JNOnQ46GXMAm3zZzT6EPgPZeqSjo+MKlyd5zockI0XaIoV2NwPCIAUg/G/BggVRT5qs3NykrdkHHihv/9vNWXpCQEyo9N9h5sbd6typvTBV79FcuVmTDQePDU8yrPwIHX0LvNqtYS+E7FXPakiyU7i00cFg8BB4tZNTt4nMFYTlfbu0I3b1peMaQkJIeQgNeioMSiZKS4d25OTkPGvn1MDVq1ft1ZB169aZuV6ks7Nz38WLFx8OhUJu8h+cA3nWjJBNwwyqzOKlVg2wB5AlS5aYbeSvm5ubvwdAAi4CZBfaNWIVCEZBkK2AHDlyxNQFYaoGZs2a9X3s/s4leHRSSKzIY6zyE6YAGRoaMnVB2mnaa9jU+7CtYT7jVH5CqY1Go3Vg05m5BCiMzrgcNtUltqYBKSpKrXiLDnwN2tKGDpWmO+6nAFAQAoHAw2hDEx3udAGRtjIoIfM6BELCZbuFyxCQjRs3pnrtwZaWlrVNTU3/ArhZ6QSDPDg4uLe7u/tJ7scmg5T6eKG5mCMCgfBdmTNnjrrYg+fSFcpbWTr5BKEzzZCs1YhAXoGqhylldksYBxUCsK+1tXV7R0eHOrCiHRxUPh7BQY4XAotT5rqy2bNnq5qhfybSUUBOnz4dz2Grq1H4IKU8/8EO0EbPnz9fKS0tVaVRQl6Cis/eqKysXAVQXobULrQrF5BnUebNm/fY8uXLd547d069vyz2Zns5wAg4lMLCQoVz6/rcQR4gZV8ECCdyKUNADh8+/IlzjLUrKiqURYsWqftsNDvMjs2YMUPtyOXLl5WqqipVyvr7+1XbW1ZW9kFfX9/Knp6ePwCse6wufWuJXyfaw+juzxxI3oP31mvl4sWL1WMIhhKrrWKuCCr741S9yxAQSnu8bJR2lRLGfUmMpCMst1BDLly4oO4zMKDmIFHk5x+ik1/FoP0Eg7fLSi3BdVswwFwT1grglTNnzqiCA225PrAUHmo2hUSkX68BAojTZZ9cCyVU1RACw4d1JEyUMgy4BuZuE7671mqThcEsgalpxHWP4XAfhCVC3yF5g64NitvJ9lI5Bud+SN12aNIqu6QPQJQQFPAqHG7H9incqxEa0K3XEC9QtsUDc90uA4CvQyLfh685hMFYlcY+laMNT1Aj9X7AirKG5zSEHQYQn8buHvA9+kQrzYnhk7hvo95ceeXRNssA0cLdBxDjN8BUzHCwT7vAP9OH6qId+sRP71+cEhzbTBYjLTj1BuwexL6TYNQLGJJ7SFGQhIDjfuQmv0dw8SXRGuF0J4C2aQg6UYYOH0FH73CyQ7g3wXhUJF9CWgEDgvIIANnN6A/7tchFbqICxYa9TmtLqoDwefC/oSMLHBYsFQy9A4/xbY9gs1tnsvjqJ8bkI7G/cdp0pQLITWh8E7YlToOBwZwSjJjfRHDelV7erA8pBL/lNjDiRH3xwPBmlBVv0p71Ky1COYHDT7kJDDE1OtOTCAx+KeopQOLVskgFBQVPI0K53SHHrVZwwfWIilQHrr1tKFYzfozNL9PVLiv9jiEgLMzFDgYilHXo/FYOghPOj2AgOmoYGBh4lPtsh5TTdcnfdMAoRvtfYyQMTmVONo8LBGE19mF7yoooc1pLSbUwMhdm7CWnIhEWL9GG/3Z1dX23vb1dBYdzGixk6szUjmlqBiOs9VZpLYT0XrRnEQ7bbQMkTha7x0knzjmMZcuWNVZXV6smihpx9uzZ634NNAf8Wyfapr396FZs7QNEr34YAL49dKuTMbrWnkvUFJkJpMkiINoChDG7V4RM3UQbTRanMmWeA1zvdMLEyaW2trZiTs1Kx3lOZ7KugDdj/5BDWmLJABkCMnfuXBWMoaGhmyORSK0Vix5SIZqp/Pz8uwOBwG+k73HGgD4uDFD+mG7thQU5YysgNAeac/+Bi+YR1qDztRCUvyYwsc+hvRM4fj7BdZhkvWEmytJPW/PN22jLRxCWBgQ8ljxBZggIbTMcaQg325KO5TtJ0DG05U4Myrv6+lPMu3/3szQC2m9wjQF8VmO2AbGFS/FdVgBiWDrh2wdWrFixaXh4OOSyyZ0AIqw3ISgr9QMgy310bT2A4y125EJcKEGBFTNu5WykoYacPHmSoeXmZN8KlCYHmk9QMCBfFk2RAETmNrQ86oAG0v44ghhMtnwik1uhUOg2WI0f4vgdHD+hSolFb9AzBKSvry+Im6xxcrF0sqCIphAM3XtX4oESNJtv4Dq5hYWFxwB6Be6xSfn4ffT1VvXL0GRBCu7g8k83z0ULKGK+pK3i83TrrgjKt3U/7cXxKH8jACZTLtHmU2QaeLdWyLRXQ9DQaje/3Wcq80VQZFWlRgfx3Tb0qQaafwI8KRm/LPqbZl+JOh/ADOvOyeRXvW2AoLHLvLBsxggUSj0Lj3xtrZgynH8bu29LpETHLIvnLOirJaAk0tUqxUMkoGBAbteHwfpHEWTBgyx7lap1kmBEFeM/kUnZfCUCpEjxHhGUJvBaASXegMv8iU3vO0kJlET1EM7GHfSYlqggwCe8Dh/xII6f08zTepish3BczOw8BfPEKIGVzGK7zFciQF4Av4eLVmqlBi+91X4WtGBcy024tPQ1B6JFgjKK+z6D/XErACGd09hzRHNEP4EB+aKDr2LaA8FoxfZlqwBRvAqGPH4gf7HnBGk+LKlqQMYBonfi2oBkOZXc4tabwa/fsIDIc4L69bygf6T7H360tjyIzUvJCkPGaYj8w6hOSzrC4TCfFXkIn3G1yVgql9eirDuVjxdKGIHBKvMBq8NeT5usmNL8KauW6Wj3+BCbUqvBmCoxzBhKlw9JFYwbBhCLKRhv3KwAI2PDXjvMYBxQLAfD1xBzNAru1YHxLavA8DVkmlFbrEtCkPA4Qmn+Y88JAPKipS9B8NofL2Y6+SbLB8QnHxAP0f8BZ5KgB0Puc50AAAAASUVORK5CYII=';
 b:='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAecUlEQVR4Xu1dC5gcRbU+p6eHR5KFKILsGhSMQeDyRnzrJSCoYAgBHLardhMBEVEUvRdBxEe8ihfF9wsQJbKZql5GICbR4Duo+AKfKF4IoKgYiCiJeUpmps/9Tr7eONmd3eme6e7p7qn6vvk2MFXn8Vf9U11dVecgmGIQMAhMigAabAwCBoHJETAEiXl0VCqV3arV6mGFQmE/z/P6iKgPEfmzNxFNG/tv/gsAeyOi3cSkzQCwFgAe9f+uJaK1nuetfeihh9YtXrzYi9mNnhVvCBJR11cqlf3r9fohAHAIET137C8iHggAceJcB4DHiOiviPh/iHi353l3F4vFX5dKpe0RudezYuLsuFyCunjxYus5z3nOIYj4fAB4PiIeTURHIuL0NDlMRFUA+DUA/BwA7iKiu6SUTCBKk51pt8UQJEAPLV26tN+yrDMAgD8vSRsZArgwVoUf1X4CAN8jom8LIX5pCDM1eoYgk+CjlHoWIp4FAPx5UcyPSSHGeHRViegfTBZEvN3zvFuHhoY2Ric9H5IMQRr6sVKpHFSr1c4morP9R6h89HIAL/iRDBG/DQC3ENFXpZTrAzTLfZWeJ0ilUtm7VqtJIlrUa6SYYnTz4v6rRHSDEOK7vfwY1rME0Vq/FAAuAIDXAsCeuf8pbN/BhwHgi/wRQqxrX0w2W/YUQVavXm0/9thjJc/zrkTEw7LZZV2z+kkAGCGiq6WUf+iaFQkr7gmCjIyMTC8UCucDwDsQcVbCGOdKHRF5iLiciK6SUv4iV841cSbXBFFKPQUALkbEtwHAU/PemUn7R0S3FQqFKwYHB9ckrTspfbkkiOu6A57nvR0ALsrwnkVSY6BTPbyTfxMiLnYc5y+dCktb+1wRxD/3dCkAvAcR90gb2Hm2h4j+hYif9Dzvf/O0n5IbgmitTwSALwDA7DwPxLT75m8+fmDz5s2fv/DCC/m4S6ZL5gkyMjKyX6FQ+AQiikz3RP6Mf4iILpBSrs6ya5klCBGh1voCRPwIHxPPcifk2XYi0oh4iRDi71n0M5MEGR0dPbRer9+IiC/MIui9ZjMRrbcs61LHcW7Mmu+ZIog/a7zVnzV2yxrYxt4dx1fOy9I5r8wQxF9r8HR9khlo2UWAiPhWpMzK2iQTBFFKvRIAFCLuk92hYSxvQIAvbV29Zs2ad6f9unCqCXL99dcX+/r6ruIjImZ45RKB73metyDN+yapJYjrugd4nrcMEY/L5dAwTo0h8FC9Xj9teHj4/jRCkkqCaK1fBQCj5vVtGodM9DYR0RYAKEkpV0UvvTOJqSOIUuq1iOgCQKEz10zrLCHAp4QB4FIp5SfSZHeqCKKU4sOFn08TQMaWxBFYYtv2BaVSiQ9Bdr2khiBKqasQ8V1dR8QYkAYEvler1U5fuHAhP3p1tXSdILz557ouX+k8r6tIGOWpQoCIfkFEJ3b7DVdXCcJB2ObMmTOCiDJVvWOMSQsC91Sr1RMXLVrE4Ym6UrpGEL4fvnbt2lsQcX5XPDdKs4LAAwDwsm4FjOgKQZgcjz766K0AcHpWesnY2VUE7t1zzz1fumDBgg1JW5E4QQw5ku7ifOgjoru3b9/+8nPPPfdfSXqUKEEMOZLs2vzpIqJvDQwMnDZ37txaUt4lRhD/bdVX/Fi3SfmXFT0cyfAJInoCEXlBut7/9xMAUCOiZyLiswCAP/15jBMctKOIaFRK6QSt32m9xAiitf4wAFzWqcEZb09ExBHVv0VEnIrgQdu2HyyVSo8H9csPTPGsQqFwkOd5BxHR4Yh4CgAcHFRGDupdLYS4Igk/EiGIUup8ROS9jp4rRLTBJ8TtxWLx62HIEAascrk8q1AozPc872QAOBkRp4Vpn7W6RHShlJKDdMRaYieIUupUAFiJiFasnqRLOD8ucayo5f39/T9K8pmZYViyZMkexWJxrmVZ5wDAUB7Ptflnt+bFfcAxVoKMjo7O9jyPsxzNSNf4jccaXkRalnXDxo0bl6cl5A2ndKhWq+8EgHMRsRiP512Turlerx8zPDz8YFwWxEaQlStXTtu4cSM/b3O+vryX+wDgjUKI76fVUdd1DySiLwEAxw/LU7mvr6/vuHnz5m2Nw6nYCKKUuhURz4zD6LTIJCLOyHRlsVi8Ni2nT1th47ouJwj6FAAMtKqboe9vEUJwGovISywE0VpfCADXRW5tugRWbNu+OK5Fd5yuLlu2bObWrVs/jYjDcepJUjYiXuQ4TuRjLnKC8LqjXq//Lq+xcTnGEy98414cJjG4XNc9nfcV8pBAiGMDFwqF4wcHB38XJXaREsQ/nXtXXu+RE9FPPc87c3h4mEPX5KK4rvtiz/NuR8S9cuDQmieffPKoKI+jREoQpdTliHh1DoBu5sLHbNu+PCtrjTB9oJQ62s92y/lUMl2I6AtSSn7Ej6RERpByuXyYZVm/AoA8Rjz8HyHE+yJBPKVCRkdHj6/X63fkYYMREV/jOM7Xo4A6EoL4dzv4le4RURiVJhlE9GUp5blpsikuW1zXPYGIOBW0HZeOJOQS0SPFYvHQUqm0uVN9kRBEKbUYEfP4C3vrmjVrSmmP/tfpIGhsn6PAGZ8RQry1U2w6JojW+kgA4GSOmf7VGQ8kEd1fLBaPLJVKfNK2p4rW+msAcFrGneaDocd3mmi0I4L40db5lW7eUipv9zzveUNDQ7/N+CBpy3w/+em9iMhH67Nc7rFt+9hOXqx0RBDXdc/zjy9kGcRmtl8mhLgmb06F8Ucp9TpEXBKmTRrrIuLFjuN8rl3b2ibIqlWrdt+wYQNnNd23XeUpbXen4zgvR0SOQN7TRWv9SwA4Jssg+Bu7s9vNSdI2QbTW7wWA92cZvGa2e553ZK8+Wo3HQyn1CkTkt1qZLp3sjbRFED+ZzR/z8M68seeJ6DYp5VmZHg0RG6+1/j0AHBqx2KTFked5R7Xzw9cWQZRSH0fEtyftZZz6+AKO53mHpTUMf5y+TyU7L+vMdn/8QhOkUqnsX61WefbYo1udFodeIlJSSr59Z0oDArzWXL9+/d/ycFYLEY91HIdPewQuoQmilPosIr45sIaMVEzL2oOzau29995HENFeiLjF87w/dyuq4FjXKaXKeQgPS0Rfk1LOCzMkQxFk6dKl/YVC4eG8nbfiQMlSyueFAS6qunwltlar8WWf44joUH9PaZfcKH7iy9FCoXBj1Me5g/ihtT4DAJYFqZv2OmFnkVAE0Vp/DAD+K+0ghLWPiN4kpbw2bLt261cqlUKtVjuXiC5AxOeHlLMSAN4thLgnZLu2q/uhhv6Zk8fqshAi8EWxwARZvnx535YtW9bl4XLNuJHyZK1W2yepXBTlcvkIy7Ju7vDN0JOI+BbHcW5oe9SHbKi1/gEHkQ7ZLI3VOSrjrKCPrYEJopR6FyJyxtlcFSLSnLQ7Cae01vz8y9Eld49I3zVCiESC8SmlrkbEyyOyu6tiiOiDUsr3BDEiEEF4iq3Vao/kcNecMRoWQpSDgNVJHT8x6fKo129EdKWU8kOd2BakrU/uFUHqZqDOEzNnzhw49dRTn2xlayCCaK359efSVsKy+H2tVnv6woUL/xan7f5lpB/E+Ax/ihAi1h3vSqXyDP9HMk6oEpNNRIuklCOtFAYlyB0A8J+thGXw+zVCiFjjdvGCvFqtrkHEZ8eIz19t255TKpW2xagDtNaceiCqx8M4TQ0i+2dCiBe2qtiSIJVK5Zm1Wu1PrQRl8Xsiuk5KeVGctiulLkHET8apg2XHFfam0W6tNUfJPCpuXxKUf7gQ4t6p9LUkSJ6jshORI6XksDexFI6Ru9tuuz2CiPvEomBXod8XQpwQpx6tNb9gODtOHQnLvlEIcX7bBPEvRD2GiPslbHhS6lr+gnRiSMLXV/kG3T7tHusO4qfW+tMA8JYgdTNSZ5tt2zOnujU65QyiteY4rt/NiLOhzZw5c+YeQd5khBbsN9Ba/xQAXtBu+7DtLMs6enBw8Ddh2wWt77ru+4hocdD6WajH4XEdx5n0lEArgnD+hQuy4GhYG4noD1LK2WHbBa3vH8tZG7R+FPU8zzt1aGjo9ihkNZOhlLoYET8Tl/xuyG11SHVSgvhvXx5HxMwHE5sE+G8IIV4dV6copc5ERM7km1ghooVSythexyulBhHRTcyhBBRxAPJisbjvZI9ZkxKEE98gYiTBtxLwM7QKIvq0lPKS0A0DNujGznPcM4jrugv4XkVACDJTbapAc5MSRGvNkbIjC+GYNrQQ8T2O43wwLruUUl9FxPlxyZ9E7lFxHmL0g13zaYC8leuFEG9s5tRUM8hfEHFW3pBo8OftQojY9ie01hwy6PCk8COifwgh9o0z2ERenyo4EqOU8oDABFm6dOlzC4UCZ03KbSGi10spOeNSLEUpxSmdk1y/tXyn36mjeT5yNNkbwKYzSFK7v512WCftEXHQcRw+dh5L0VrzQbjEAnnH/YqXQdJa8yPplbEA1n2hfMdmwmn1pgTRWvPinLPT5rZEGQF8PEicJ+Xggw+uJwjeCiFE7OudPKfVI6IfSSlfOr7PJhDE79x/9kBmWr6Rx9mi4iic8jqpy0WxZ3odA0gpldt1KRFVN2/ePH18duIJBBkdHT3W8zwORm1KBhCIcyZsdN+/CZnYNd9uQI+IL3Ec58eNuicQRCn1dkT8eDcMNDrDIZDUZSm2ynXddxPRB8JZmLnaE2IyTyCI1prPpXAUC1NSjAARfU5KeXFSJiqlfp7X3JNjGBLRcinlLmO/GUEeA4CnJwW80RMeASK6WQjhxLnn0WiVnwMmtkOQ4RGIrcU6IcT+kz5icf7sbdu2xbVwjc2rHhO8wrbtMzvJeREWr7wEjgvit23b+5RKpSfG6u4yg+T9eHsQgFJeZ0V/f/9Zc+fO5dA1iRQOVG7b9l/zlkFsMvAsy3rl4ODgt5oSpBc2CBMZVTEoIaKvDAwMiCTJwW5orT8CAO+IwaW0itxloT5+BuFAZK9Pq+W9ahffWeBogEmtOcZwVkrNQUROf5Cr/JNTjaPx90PGEyQv0fNywyU+li+EeFvS5ODr1q7r/iTJG5Ep6bRdop3sQpA875SmBPwwZvBRFT5x3JUbfAnfpw+DS9x1d3mTtZMgfkDlxBZ/cXuZZfl8yw0RTxdCfL8bfriue6DnefcgYl839Hdbp23b08ZijO0kSC8cce828AH18z32k4QQXbluwPlJ+vr67s5Z/KuA0O+sdugY/jsJUi6XX21Z1qqwkkz9SBFYZ1nWywcHB9dEKjWEsByG9gnh/c6qrxZCfIP/aydBlFLnI+IX25Fm2nSOABH9sVAonDw4OPhQ59Lak5DXG4NtoHGeEGJHjvhGglyOiFe3Icw06RyBBxDxBMdxEg0T1Gi267rHeJ73Q0Sc3rk7mZewcy+kkSDXIOKlmXctew7cU61WT1y0aNE/umU6x1+uVqu/TChEarfcDKP3I0KIHblQGgmyBBFfF0aKqdsZApwbkYhOHBoa2tiZpPZb33TTTfvYtn1XzNHn2zewOy133u9vJMhKvnzTHXt6UuuPa7XaKUmlfmuG8MjIyPRCobAaEY/vyR6Y3OmdV5h3EkRrzTF4ORavKfEj8DARHRtnoOlWLvDJ7a1bt34n73c8WuHQ7Hsi+q6U8hXjH7Hu5CuH7Qg0bYIjwJuAAPA8KeUDwVtFW9N/rOKMV4dFKzk30u4UQuyIKdA4g/DmUFdyhecG1taO8PER3gTsyg45m+cfX78TAOa0Nrc3axDR3VLKHem5GwmSaCTAXoQ+6Xzs4zEeHR09ql6vL0PEg3oR/xA+3yOE2JFJq5EgvHtrflVCoBimKhHdLqXsWqwxrfVbiOhjiFgMY3cv1iWi+6WUh4wnCJ/7P7QXAYnbZ1531Ov1OXFn023mh1LqKYjIKRFOi9vPvMgnot9LKf9jPEHylqAxNf1FROdKKb+ctEH+qdw7EPFZSevOsj4i+rWU8phdCKKU4s0i8z48+p79nhDipOjFTi2xXC7PQsSf5DxCfyywEtFdUsodqfMa1yA/BIAJsUljsaB3hNZ4h9pxnL8k6bJPDn5tb2aO9oD/oRDi5eMJYjYK2wNzqlY3CSESPb6jtX46Ef3MkKP9zmy6UWgiKrYP6CQtybKsQ5K828GXnWbMmMEzx453+Ka0jcAyIcSZ49cgX0TEKZOqt62uBxs2C2MZNwxaa34RsChuPT0g/4tCiB3ZnRvXIB8GgMt6wPlEXOQXHo7j/DwRZQBgYppFivTVQogrxhOEycEkMaVzBHYJHdO5uKkl8GUnPh4BAIW4dfWCfCJ6h5Tyo+MfscyV24h6n4gukVJ+OiJxLcX0QuT1liBEW2HilVsTtCEyhAkA+oUQ6yKTOIUgpdTrEHHH/WlTokGgMT7vzjXI6OjooZ7n8XETUzpAgIhWSykTuVezfPnyvi1btvwBAJ7Wgcmm6TgELMt67tjbx50EWbly5bRNmzZtMWh1hgARXSil/EJnUoK11lqbdWMwqELVsm3bHksvMT427+Pm1ygUlhMq27a9X6lUYhxjLRw7V2v9MCI+M1ZFvSf8r0KIWWNuj4/Nm/s0WzH398NCiETuWoyOjp7ied43Y/anF8XvPGbCzo8nyAgiDvciKlH4zDk8pJSlKGS1kqG1vg0AFrSqZ74PjcDnhRBvnmwGuRQRrwkt0jTYgUDj+/M4IVm1atXuGzZs2NxLeTvixHOc7DcKIa5vShCt9ckAsDP9VIJG5UXVCUncN3dd9yQi+k5eQEuTH57nvWhoaOinkxGEs9tylltT2kBg+vTpe82fP39TG01DNdFafxAArgzVyFQOhEBfX9/0efPmbW1KEP6fSql1iLhfIGmmUiMCm4UQieTT0Fr/CABebOCPFgEielBKuUtchmZ50pcDwOnRqs6/NCL6g5RydhKeaq03AMDeSejqMR0jQohdTkNPIIhSykR5b2NUENFPpZQvaqNpqCZ+gpvtoRqZykER2GWBzo0mEMR13ZcRESfzNCUcAjvjuYZrFq42B2LgXCLhWpnaQRDwPO/IoaEhjg+3s0wgSKVS2bNarf7TxE8KAum/6xDRl6SUsafQLpfLL7Qsi7PPmhIhAkS06YEHHpi5ePFib0qC8JdKKROnNzz4Nwgh3hC+WbgWJgtUOLyC1iair0kp542vP2EG8QnyLkS8KqhwU28HAmUhROynELTWfFKYA2yYEiECiHix4zifC0qQoxHxVxHqz70oIrpNSnlW3I66rvsCfiEQt55ek09EBzeLuN90BmFwtNZ/A4B9ew2odv1NKvZuuVw+wrKse9q107SbiAARPSKlPKAZNlMRhO807IjsYEogBO4QQswNVLODSkqpZyNi1zLhdmB6apsS0XVSyotCEcQsBlPbn8awiBEgoldJKZteHZh0BqlUKrtVq9XHEXGviO0x4gwCqUGAiNYXi8V9x24QBlqkj1VSSilEFKnxxhhiEIgegeuFEG+cTOykM4i/UOe3MrdEb5ORaBBIBwKchltKubotgvi76n9HxGnpcMdYYRCIFIHHHMcZQEQO1dS0TDmD+LPIDQAQ+xGKSN02wgwCARAgog9JKae8VxOEIJyK6ncB9JkqBoFMIUBEB0op/zSV0S0J4s8ivHO7I+OOKQaBPCAQNMBfUILwJZLEc+zloSOMD+lEABGl4zi6lXWBCOJH0VgLAE9tJdB8bxDIAAKP27Y9q1Qqtbx4Fogg7LBS6gOI+O4MON8tEznt2TuTUE5EKwFgRhK6cqrjCiHE1UF8C0wQzn0HAI+YWEzNYU3qsKL/Y7UeEWcG6WBTZ1cE+GLUjBkznhE0+kxggvgdY3bWJxlxhiCZoeLHhBCXBrU2FEH8TEa/DCq8l+oZgmSit7fX6/UDh4eHHw1qbSiCsFCt9QoAmHA1MajCvNYzBMlEz35KCPG2MJaGJoiZRcwaJMwAS0tdIvpXrVabtWjRon+EsSk0QfxZxEQWH4eymUHCDLuu1A219hizsC2C+Nc+f9MsrlZXXE+BUkOQFHTC5C9Qttbr9YMWLlzI18hDlbYI4s8i5hBjA9SGIKHGXaKVEfE9juNwwO/QpW2CVCqVfavV6kOImEjA5tCeJdzAECRhwIOre3zmzJkHnHrqqU8Gb/Lvmm0ThEUopS5BxE+2ozhvbQxB0tmjiHi+4zg3tmtdRwSpVCqFarV6DyIe1q4BeWlnCJLKnrzXcZwjproQ1crqjgjir0U4ojnnq+hYVitj0/y9IUjqeqcGAMcJITqKIRbJoNZac8jGN6UOogQNMgRJEOwAqojo/VLKxQGqTlklEoJUKpUZtVrtAQDYv1ODstreECQ9PUdEvx0YGDh27ty5PIt0VCIhCFvguu7pRMTZqXqyGIKkptu3W5Z13ODgYCTXxCMjiP9W63pEjD0FQGq6osEQQ5DU9MplQojIUplHSpAlS5bssfvuu/MO+8GpgSshQwxBEgJ6CjVE9AshxPGdvLUaLz5SgrDw0dHRwz3P+wUA7NZ9yJKzwBAkOaybaeLDiIVC4fDBwcFIA3tHThA2XmvNb7QmJCPpLoTxajcEiRffVtIR8SLHca5rVS/s97EQxCfJVwDg7LAGZbW+IUj3ei7O5EWxEWTlypXTNm3axI9ah3QPuuQ0G4Ikh3WjJiK6f6+99jp23rx5W+OwIDaCsLFLly59jmVZv+mF2L6GIHEMz5YyN1uWdXTU645GrbEShBW5rnua53krENFq6W6GKxiCJNt5RORZlnW64zhfj1Nz7ARh45VSb0DE6+N0pNuyiehBdjUhOy5HxD0S0pVKNUR0oZSS0wTGWhIhiE+SaxAxcLiVWL02wrOOwEeEEJcn4URiBCEidF230ktvtpLowB7UcYvjOKUoNwOnwjAxgrARq1evth999NFvA8AJPdixxuXOEVhh2/aZk+UT7Fz8RAmJEoTV8+vfjRs33oGIx8fhkJGZWwRW9Pf3nxXFCd0wCCVOEDZu2bJlM7dt23YnAHByHlMMAq0Q6Ao52KiuEIQVVyqV/avVKs8kz22Fjvm+dxEgoq8MDAyIpGeOMcS7RhA2QGv9NCL6NiIe3btDwHg+GQJEpIQQw0ktyJvZ0VWCsEHlcnkvRPyOWZMYojQiQETXCiHe3E1ydPURqxEMvrJbrVa/iognmWFiECCiD0gp35sGJLo+g4yBwCGEarXatQBwQRqAMTZ0BQEiordKKT/bFe1NlKaGIGO2aa3/GwD4ymTqbEtLp+XUjhoRDUspR9PkXyoHYblcfo1lWa7Jw5emoRKrLf8konOklN+MVUsbwlNJEP8NF98juR0ADmzDL9MkIwjwPXLLshY4jvOXNJqcWoIwWEqpp/CWCSK+Io3gGZs6QoAA4OP9/f3v7NYeRxDrU00QdmDx4sXWnDlzPoSIl5l1SZAuTX8dIuIsTzKNj1Tj0Us9QcYMVkrN5UkFEfvTPwSMhZMhQETfrdfrop1kNt1ANTMEGXvkQsSlAHBaN8AyOjtCYDsAXCGE+HhHUhJunCmCNMwmr+PnV0TkNYop6Ufgh0R0vpSS4zdnqmSSIIzwyMjIfrZtc/IeJ1OI95CxRLTBsqzLHMfhdH2ZLJklyBjao6Ojp3ie93kAmJ3JHsip0US0tF6vX5qVtcZk3ZB5grBjlUplt2q1ehG/9ELEmTkdc1lx6yEiOk9K+YOsGDyVnbkgyJiDlUpl71qt9i4+z9PrUT+6MDi3AcBVtm1fUyqVeEGei5Irgoz1SLlcnoWIPJvwYr6Qi55KqRNEtAkAOO3FR4UQ61JqZttm5ZIgY2horQ8hoqsQ8cy2ETINmyLgb/Z9atq0aZ9ZsGDBhrzClGuCNCzkj/c87woAOMPsxnc2lInoT/yKvVgs3lAqlfixKtelJwjSQJSDPc/j4HWLei1/SQSj+DdEdE2xWBxNMuxOBHZ3JKKnCNKwmN+/Xq+/nog4XdwBHSGY78Y8Q3AaixuEEByFpudKTxJkrJc52uPNN998sud5fIuRH7/snhsBTRwmorsQ8abp06cvnT9/Pi/Ce7b0NEEae52P1iPiGUT0WkQ8udfI4pPiFtu2by6VSn/uWUaMc9wQpMlI8PdT+M3Xq4jolJxuPvL97x8DwK0AcJuUkhffphiChBsD/n2UY3hWIaKTEPGFGb4KvJmIfoSIK2q12i1ZPwYSrifbq21mkJC48bpFKXUoIj4fAPjzPAA4GhGLIUXFXX0zAPwWAH4FAHdZlnXXOeecc1+340zF7XTU8g1BIkB01apVu69fv/4oy7KOJyL+HIaIAwCwf5w7+ZxlCQD+hIj3A8C9iMhJfO4rFAr3lUqlxyJwredFGILEOAT48Wz27NlPt237GUTUzx8AGPDJ8wwAmN5E/XY+voGI/DjEfzf5xzk287/543kev1laVywWf5+nc08xdkXbog1B2obONOwFBAxBeqGXjY9tI/D/JrWhbrQpc7gAAAAASUVORK5CYII=';
 c:='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAeqElEQVR4Xu1dCbxVVdVf69x7QeNJaGn4RAVNTTFt1swBh0pxwKnLu3s/ULDCyuxrMj8zwtLUUj/r04oyKXh7n8fNMkTRzML4nBrQyLB6mKko4AjKQ5N771nfb+FFn/CGM98z7P37vV8Da6/hv/f/nnP2sBaCaQYBg8CACKDBxiBgEBgYAUMQMzsMAoMgYAhipodBwBDEzAGDgD8EzBPEH26mV04QMATJyUCbMP0hYAjiDzfTKycIGILkZKBNmP4QMATxh5vplRMEDEEiGuhFixYNX7t27S4AMMayrDFEtDsRtSPiGP7/mn9vA4ChxoAA4GkiegIANv+t5P+OiE8Q0cre3t6VM2bMqEUUSq7VDjU4uQbHTfBEhPPnzx/faDQORMTxALA/EY1HxHEuJr8bE25kiIj+jYjLAWA5Ef2tUCgsmzx58nJEZIKZ5hMBQxCPwC1evLi4Zs2aDzqOcxgiHgIAhwLAmz2qiUWciNYi4r0AcA8iLhk9evS9Rx55ZD0W4xkxYgjiYiDnzp27U6FQOBYAJgLAcYg40kW3JIq8QES3I+ItAHCLEOLZJDqZJJ8MQQYYjQULFmzX29t7GgBIADgKEa0kDVxQX4jIAYDFANBVKpVuKJfLvUF1ZrG/IUifUW2+Pn2UiCQRnYKI22Rx0LeMiYj+g4g3IqIqFAq3lcvlRh7idhOjIQgAdHd3v8dxnKnNp8Vb3QCXVRkiehoRNSLOrVQqD2Q1Trdx5ZYgs2fPLo0cOfJjjuOcj4jvdAtYzuT+TERX9/b2VvO6jJw7gtx4442jXn755c8Q0bmIuFPOJryvcIloNSJeu+222157yimnrPOlJKWdckMQ/uh+6aWXPuc4zpdTvArV0mlGROssy7qyUChcnZeP+swThHe0161bdw4AXAAAO7R0hmXH+PMA8K1Ro0ZdM3HixFeyE9bWkWSaILZtH+84zrWIuHuWB7GFsT1KRGdLKX/dQh8iNZ1JgiilmBA/QcSjI0XPKN+EABHdbFnWZyuVyqNZgyRTBKlWq8MajcZ5RHQhAAzP2mAlOR7eS+HXrlKpdHm5XN6YZF+9+JYZgiilDkfE6wFgTy8AGNnQEfgXEU2XUi4JXXMLFKaeIM2P8B8AwLQW4GdMDozAnGKxeHbanyapJki1Wt2tVqvdbDb6EsvTB4rF4snlcvnxxHo4hGOpJYhS6hhEvCGpR83TOiEi8JtPEJ8upbwjAt2Rq0wdQfhA4erVq2c19zVS53/kI5pAA82Tw5eVSqWZaTsImaoJZtv2ro7jVBHx4ATOA+PSEAgQ0X2WZZUrlQpfGU5FSw1BtNZ8YanbvFKlYl4N5uQLANAhhLgtDZGkgiBKqQ5EnAcAxTSAanwcEoE6EU2RUvIPXqJb4gmilDoHEb8XYwKERA9YhpzjRBPnSimvSXJMiSaIUuoSRORDhqZlF4FLhBB88iGRLZEE4ctMbW1tcxGxI5GoGadCRYCIVG9v77QkXspKHEGq1WpbvV6/tZlOJ9SBMMqSiwARLWlrazth0qRJ65PkZaIIwpeaNmzY8H8AcGCSQDK+xIbAshEjRhyWJJIkhiB8Erder3MaGk7GZlp+EbirWCwenZQzXIkgSLVaLdRqtV8h4gn5nRcm8j4I3FQsFk9Nwq57IgiiteZj6uY0bjgceYCIbrAsa1mhUHiw70HBarW6Q6PReDcRvR8ApgPAXuGYjETLHCEE+9jS1nKCaK1nAsBFLUUh/cZ5T+HHRHRNZ2fng27D0Vp/mIguRsQPuO0Ts9zXhRDfiNnmG8y1lCC2bU8mosTvprZygIayTUQPFQqFKR0dHfcPJdvfv8+aNcvaZ599PkVE3wGAbf3oiLIPL/VXKpX5UdoYTHfLCMI3AAHgDkQstSr4tNslolt7e3snhbF/0N3d/RHHcTipdaKO8xAR1z05plU3FFtCEK3124iIa1e8Je2TtFX+E9HP29vbRZjlDGzbPp31tiqmgewS0XOlUunAcrn8ZNy+xU6Q5n0Ovq/8wbiDzYo9Irp7xYoVh8+aNYsztIfalFLfR8RPhao0BGVEtLS9vf3gMH8Q3LgVO0G01lcAwBfdOGdktkaAsxsi4juEEE9Fgc+cOXO2GT58OF+R3TEK/QF1Xi2E+HxAHZ66x0qQrq6uEyzLWujJQyP8BgSI6Awp5dwoYVFKXYWIsU5ED/GcJISIbQ7FRpBqtTq6Vqs9hIjbewDDiL4Rgad23nnnMVG/ZjTLQSxNIvhcVq5UKu1XLpfXxOFfLAThQpda6zsRkVeuTPOJABHNlFJ+02d31934ZEO9XuecuwXXnWIU5IONQogJcRQojYUgSqkvISKvs5sWAIFGo7HXlClTHg6gwnVXrfXfAeAdrjvELEhEX5ZS8vdspC1ygnR3d+/pOM5DADAs0kgyrpyXOqWUsVW/UkrdhYgfSjCsGxuNxviofzAiJQjv0u611173ISKf/TEtGAI3CiFODabCfW+t9Z8A4H3ue8QvSUR/LJVKh0R5qDFSgmitzweAS+OHLnsWiegHUspPxxWZ1vpvADA+LnsB7Py3EOKyAP0H7RoZQTiHFRGtMFnWQxu62PYAmpu5Lyft2MkASG4sFot7RZXeNDKCaK1vAoATQ5seRtFVQohYNlht2z6Ik7ylCPKbhBCTovA3EoLYtn00EaUyF2sUIIehk4h+KaU8LQxdQ+lQSn0eEa8aSi5J/05ER0RxoDF0gjRvB/Yg4h5JAjDtvvCxdillLN8ESql/IOI+acKM8SmVSgeE/cEeOkGUUmch4nVpAjclvjbq9Xr71KlTn47SX631UQDw2yhtRKWbiD4upfxJmPpDJQh/3K1atepfiLhbmE4aXa8h8CUhxJVR4qG15sQZE6K0EZVuInq8vb19zzCP4oRKEPP0iGroX9VLRI9s3Lhx/LRp07geYOgtCycewn6KhEYQ8/QIfb4OpHC2EOLssK1prfl+Dt/TSdSNQq9xhv0UCY0gtm0LTiHpNSAj7x0BIpompfyp957991BK8RJpNyJuE5bOFusRQgg7DB9CI4jWehkAHBCGU0bH4Ag0KzZNlVIG+kHiZH21Wu1riJjY5NE+58JfhRChZOcMhSBpXvnwOQCJ6MYZYRqNxuf8rGxlvWw2ER0lpeQFh0AtFIIopRYh4nGBPDGdfSFARBsQ8WdEdLWUko/2DNiUUnxZjYsRnQEAB/kymJ5Oi4QQxwd1NzBBuBRzvV5/1BS4CToUwfsT0WOIyJkV+XoBp8vhVuJNPyLanzMpIqIV3FIqNFCxWBwb9IxWYIJorS8HgPNSAZlxMm8IfFsI8ZUgQQciSHNpd43JbxVkCEzfqBDgS2bt7e2jg2wcBiKI1roCADqqAI1eg0AICARa8g1KEE5VOTGEIIwKg0BUCNwihPBdVsM3QbgaVG9v73Mmt24k40oA8CIArG0miusFgJEAsD0RjULE7SKxmk2lG0eMGPFWv1WrfBNEKXUmIs7JJqaxR8WbrH9CxKX8x7U9BquwVK1Wt3UcZ3/+4xSuRMRLt4Y0Aw/bmUKIn/kZ1SAEMXsffhB/9dDhBgBYgIi3c8FSPxt9fU3PnTt3RLFY5Doa55jsMf0Oiu89EV8EWbhw4ZtefPFFzhFrShd4I0kPEX2/ra3ter+P/MHMKaW4YtSchKfr8YZYCNJcQqHRaGw/depU/mHy1HwRRGt9MgDc6MlSvoX/DABfE0LcFjUMnGpp77335lffqVHbSpN+IjpZSrnAq8++CKKUmo2In/RqLIfyyxBxZqVS4QQWsbVmhnauOLVvbEYTboiIfiSlnOHVTV8E0VpzIZN2r8byIk9EnB6Unxjz48gf2x+uWutDAYBrzpv26nffE1LKXb2C4ZkgXV1d+1mWtdyroZzIP8sJptvb238cZPc2LKy01py6J+uHEl3D5TjO+M7OTj6n5rp5Joht22dzlj/XFnIiSESLEbESVWEbPzAqpc5BxP/10zejfc4WQsz2EptngiilFCIKL0YyLlvn16lKpXJ5q16nBsJXa81pgjiFqGmvvmYpKWWnFzA8E0RrvRoARnsxkmHZZxzHOamzszORWQi7urpGWpb1Qobx9xraKiHELl46eSJI8+7HY14MZFj2nmKxeNpglY74ghIilgFAAgB/NPPxkQuEEN+PCxetNRf69DTOcfnWCjvFYnF3L3dEPAFn2/ZJROR5LbkVQERpk4i+VSqVZg6Uxa9JjK8DAGcfGb6lL0T0binlX6L0kXVzZS/btkOvhBu13xHr91Tj0BNBtNZfBYCLIw4gseqbR0Q4WcIvB3Jy3rx5by8UCr8BgLEDyRDRp6WUkS90zJ07d6disRhJNdzEDtLQjl0ohLhkaLFXJTwRRCnFqWEmu1WeMbnniejogX75+de6u7t7huM4VyDiiMFiJ6KKlLI7any6uro+ZFnWXVHbSZN+Ipovpexw67MngmiteQ05d7uzRPRvAPjoQEkReOd62LBh/OPhJgX/RgDYRQjxrNtB8itn2/ZniOgav/2z2M9rEnCvBOFEAKnOvOdj0Fcg4oRKpbKqv77VarWtXq9zehm35cpiK4Sjtebbnnzr07TXEahXKpVhbpfkXRPEtu2xzV/S3IBNRP9ExEMH+rVvLqPe7na3moheLJVK48rl8vNRg9j8QF8LAG+O2lba9BPRWCmlq9VYLwSZwLvFaQMjgL+ruPjoIE+OXWq12u2IuJ8HG7zEG0vNxmZiuN978C03ooh4ZKVSudNNwK4JorWeBgDXu1GaBRkiOkhK+cf+Ypk3b94+hUKBa2h42XR66pVXXhkbVWb2Lf3UWnOdjOlZGIsIYpguhHB1G9YLQS4CgJkROJs4lYMdjdZaH0BEv/OR6ugTQohYCgvxDcNCofDUUKtpiQM+JoeI6JtSSldz2QtBfggAns/TxxRzmGYGzMjHry0AsBAROYGCl9bT09Oz76xZs2LZtLNt+xNMci8O5kzWdQkJ1wRRSv0CEWMrZN+qAePrmVLKYVvat217OhHxSVDPq3h+b7P5xSCvy/Ee8PqFEOJ0N/JeCPJ7RORf0Mw33s/YfAuQl3FrtdqFiOgrhSURLZVSul0CDoyt1vrDAMAra6YNgAARLZFSHuEGINcEydOvEhGttyzrPMdx2prEeKsbMPuTcRzn0M7Ozrv99vfaz2TaHxoxL5uFXgjyhMdVm6E9zbgEH+yUUnKCi1iaUupdnN09FmPpNvKkEGKMmxC8EITLD+/oRqmR2XSS1ikUCvt2dHT0xIWHUuo2RPxoXPZSbOcZIcRObvx3TRCl1As+Vm/c+JBVmeuEEJ+IKzjbtg8iokRe3IoLA7d2+ESDlNLVCQPXBNFac+nhre42uHUqT3JE9B9EHBvn/XSl1B2IeHSecPYbK4+PlHJbN/29EIQTKpvmDoFLhRAXuBMNLmWeHt4xFEK4mvuuhNi8UqqRo/Jd3hF/vcfzjuOM6+zs5Ou1sTSlVG6W4MMAlL8PpZQFN7q8EOTlDNXRdoONLxki+oKU8n98dfbRyVQY9g5aJK9Y5iPd1UA8uX79+nEzZszYXEDTVacgQiY5nHf0ovpIfwYAfG+YeQ8jlT2mCCG64vK8u7v7I47j/Douexmy86wQwtWWhetXLK212SgcZIYQ0YNSygPinETm6eEbbdf5sbwQ5EEA4IpGpvWDABEdK6WM7ddcKTUREblGpGkeEfDyY+aFIHybcIJHX/Iifo8Q4kNxBquUegAR3xWnzQzZulMIcaSbeLwQ5AYAOM2N0rzJENH7pJRL44rbJPALjPQNQoiPudHihSB5uTDlBrfXZLzmWfKkfABh8/QIjGIkF6ZmISKn0zTtdQQaxWJxr3K5zHmzYmlKqVMR8RexGMuoESK6SEo5y014Xp4guUra4AY8TsompfysG9mwZPJ0LycszLbUQ0TTpJQ/daPfNUGUUkci4u/cKM2DDOfpLZVKu8WR42oznlprzhQ/Pw/4RhljJGl/qtXquHq9/kiUjqdM99eFEFybPJbWrF7LxXByl/o1bIARcVylUnnUjV7XT5DFixcXV69ezUfeXR3ycmM8xTJP1ev1Pf3U3fYbs23bgisk+e1v+r2GQGPnnXfexm0NSdcEYfVKqeUeMwlmclziKl+wGbzm04NvJu6ZSUDjDWq5EML1hrdXguS5/MGmYeT8xKVSiVeuGnGNq1JqKiL+LC57WbbjdVneE0Fs276Qs9JlGUAXsU0WQlRdyIUiUq1WC/V6/Z/m6REKnKwk0gI6kxDxV6G5mjJFfOdbCHGI29T5YYTXTFjHeXZNCwEBr0n8vD5B2onoyRD8TKUKRHxPpVKJLa1O8+nBm5C7phKwBDrdaDTap0yZwpWaXTVPBGl+qD+KiLu70p4toVuEECfEGZJS6pOI6KnwfZz+pc0WET0mpRywdmR/8fghSBciclnj3LRmjqv9Ozo6/h5X0NVqdVi9Xn/YPD1CRbxLCDHFi0bPBLFt+2wiirxCq5cgYpCdK4Q4IwY7r5nQWn8aAK6N02YObJ0thPD0RPZMkO7u7n0dx+FinnlphIh7uN15DQOU5tODS4SNDkOf0fEqAo7jjO/s7PQ0dz0TpPkdshIRXeU2zcDguE6VH1asSqlzEfG7YekzejYh4PqabV+8/BJkNiJ+MifA7y+EWB5XrFxSevjw4bxyZZ4eIYI+WNWwwcz4Ioht26cQ0S9D9D+pqhYJIY6P0zmt9RcA4Mo4bebE1ilCCM97eL4IwjXwisUilzLeqhJTlsCOe9+Dnx7Dhg17wkf9wyzBHnosXDVs5MiRo0488cSXvCr3RRA2orW+GQBi/XX1GlxA+d8JIWJNBq21Pg8ALvfrNxFxoZ57AWCaIdkbUPS9h+WbIEqpMxHRVSldvwPeyn5ejyQE9bVZmfYxPxOb92kQ8fJKpfJVPgbTTGbNRPE9vkHjSVj/M4UQvg57+gZwwYIF223YsGFtFu+HENHDK1as2CeuqrTNlcFvIOLXvE4sIuLCRh+TUi7p21drzXXcj/KqL4PyjREjRmw/adKk9X5i802Q5qAuQsTj/BhOeJ/YapozDtVqdcdarfZvH3XNlyHixEqlsmpLPHPwCuxqChHRrVLKia6E+xEKRJCM3pF+Yf369TvGmYBaKfVdRDzX4yD+wXGcj/RXZqH5sf+UqQi2CdFA1xMCEWT27Nml7bbbjn+9MpPUmoi+J6X8nMfJ6lu8q6trDCI+goglt0qI6I6NGzeeOG3aNL4CvVXzSTi35lMjR0TPtbe3j3Z7vba/wAIRpPmadZnfGuJJRNqyrPd2dHTcH5dvWmuuJfJfHuzN7enpmTbQ95FS6hhE/I0HfZkVJaLLpZTnBwkwDILsjoi88xtYV5BAwuhLRI9IKWO7971o0aLha9eufdrNqxCvVAHA56WU3xsoVqXUHojI5HZVoDIMzBKsg4rF4thyufx4EB9DmdRZ+SBExFmVSuWiIIB66evhrnkvEU2WUi4ahBz8Q8X7ILt48SGrskR0s5TyxKDxhUKQrCSVsyzrXR0dHcuCguq2v9Z6yITgRPQ41z4XQvxjIL3d3d17Oo7ze0OO1xHykhxusPEKhSDNb5G0p+P3ddrTLRm2lCMitG2b95EGfB0ioj/V6/XjzjjjjOcGsqO1fgcRcRHPnfz6ksF+fxVCHBhGXGESRCJibOXHwgi+rw4iulZKeU7YegfSV61Wd6jX6/1O/ObO+LfXr18/c7DlZqXUBwDg14g4Ki6/02CHb7xWKhUdhq+hEYQzL65aterhFN9X93XaM8ggaK05nc/em3U0iXGLZVlfGep6L69WAcBCU3n4jSPAr6QrVqwYF9YpiNAIwm5qrdOcAX60EOKpIBPea1+t9XgA4Dxj2yPinYVC4bpyuTxk1hilVEfzaW3SwG4N+nQhRGhnBEMlSIqfIr1CiO28TvC45avV6rb1ep33TWbEbTsN9vjp0d7evmeQjcEt4wyVIM2P9bMQ8bo0ANrHx2VCiETX++vq6nonIv4cEfdJGbaxuUtEH5dShppkL3SCcLKzWq32D0R8e2zIBDf0ByHEwcHVhK+Bn8pr1qw533GcmV6Oo4TvSbI1EtFDpVLpgLBzJodOEIYxhQXu7xJCHJa0KcBPDcuy5gFAKEuWSYsvTH+I6Igtj/yHoT8SgjRftXiFJdZMhAEAWSmE2C1A/1C7Lly48E3r16/nepBfzOJ9m1DBelXZQiHESRHoje781Lx5895eKBS4ItLwKBwPW2exWBxVLpdfCFuvV31aaz4ewQnjTD5ed+C90mg09p8yZQpnoQy9RfYEYU+11nyS8tLQvY5AIRHNkFL+KALVrlRqrQ8lou8gYiK/hVwF0Rqh/xZCXBaV6UgJ0sxOvjQN79BEdL+U8r1RAT2Q3q6uroP5kCSft4rbdgbs/bWnp+fdYW0K9odHpARhg11dXftZlsUlAxKfIoiIviylvCKOiWOIERjljc3DpZEmFI+cIM1XLf7YjGXiBYS9DgBThRB2QD39dq9Wq2+u1+unsg0AmBCFjbzojOvHLBaCNE+uLgaAI9IwgER0RalUmlkul18O6m8zlSivsFQAgJMHJP5JGjTmqPsT0RIpZSxzKRaCMGDz5s3b2bIsrpK7fdQAhqSfz2VdRUR3lkqlpV42oJRSHOPhnI4HEScBQFtIPuVeDRGtLZVK+5XL5TVxgBEbQZqvWryEeVMcgYVpg4heQkRebLiPiFYj4vOO4zxnWdYriLgDHzZ0HGdHANgPEd9vCm6Gif5Wuk4SQiyM1EIf5bESpEkSTszMCZpNMwh4ReBKIcSXvHYKIh87QZonfu9p/tIG8d30zRECRLS0vb394DBP6rqBL3aCsFPVanWXWq3GWQHf4sZJI5NvBDi/ValUOtDNXZmwkWoJQTgI27YnOI5zuzmhGvaQZksfly5AxA8LITgpReytZQRpkkQQkYo9amMwNQggYkelUpnfKodbShAOWin1NUT8RqsAMHaTiwARzZRS8pXklrWWE4Qj11rzLbDpLUPBGE4iAtcLIc5qtWOJIEjzUCNXrDq21YAY+61HgLMilkqlk71szkbldSIIwsE1j2Rw0uVDowrW6E0FAvcUi8Ujy+XyxiR4mxiCMBhctaq3t3cJIiY6gUISBi6LPhDRX9ra2g73Ww0qCkwSRZA+JLkZEfksk2k5QYBrnrS1tZ2aJHIw9IkjCDvFhXna2trmcArJnMyPXIfJS/2lUumMJHxzbDkQiSTIZie11hcDwFdzPXuyH/wlQogLkxpmognCoCmlzkFELhqTeF+TOsgJ9YuI6Fwp5TUJ9W+TW6mYdM1ctJwfqphkMI1vrhGoE9EUKWW36x4tEkwFQRgbrTXvkTCgprxYiyZLSGY5tVKHEOK2kPRFqiY1BGEUbNve1XGcqkmNE+mciEw5Ed1nWVa5UqmsjMxIyIpTRRCOvXmf5GJEPC8tr4ghj1ka1REAXF4sFi9M4krVYICmjiCbg1FKcR6pblNdKfF8eYGITpdS3pF4T/txMLUEaa5wcWXXBWlITJfGyRHUZyJ6sFQqnRC0FHNQP4L0TzVBOPBmrfFrEbHlJz+DDEQG+84ZNWrUpyZOnPhKmmNLPUH6vHIdjojXm4wiLZ+O/yKi6VGUImhFZJkhCINXrVaH1et1Tph9QVqyyrdi0KOwSUT/QcRLi8XiZUk5iRtGnJkiSJ+nyR6IeDUAcB4u0yJGgO9vAMA5UsrHIjYVu/pMEqTvShci/hAAxsaObA4MEtFjlmWdValUfpvVcDNNkM0f8evWrTuLiM5LcQ33RM0/JgYifnvUqFE/SftH+FDAZp4gmwFoFhc9tbnB+L6hgDH/vjUCRPRHRLyyp6fnhihrciQJ+9wQpC/otm0fTUSzzPVe11PxLi7yk+VXqYGQyCVB+nyjHAMA3zRnu/qfHkR0NwDMSusuuGv6DyKYa4JsxqW7u/s9juNwUZspAMDZ2vPcnuHD05Zlze3o6Lg/z0Bw7IYgfWYAH4R88sknj7UsizM+noKI2+RhgjT3MG50HEcPGzbs1rQdKIxyjAxBBkC3q6trpGVZpwFAJxFNQEQryoGIWzcROYh4J5eRLBaLPy+Xy71x+5AGe4YgLkapWq3uWKvVjkPE44noWEQc6aJbEkX4ZC0nDL8FAG4RQjybRCeT5JMhiMfR4NewNWvWfNBxnMMQ8ZDmSlgibzkS0ToAuBcR70bEJaNHj7437voaHuFNnLghSMAh4QKl8+fPH99oNA5ExP0BYDwRjUfEcTF+43EChEcR8W8AsJz/LMv6y+TJk7kmJF9WMs0nAoYgPoEbqhsfnKzVamMAYIxlWWOIaHciakfETf9f8+9tLkjEE5wLij7Bf0S06T/5DxH5f6/s7e1dOWPGjNpQPpl/946AIYh3zEyPHCFgCJKjwTahekfAEMQ7ZqZHjhAwBMnRYJtQvSNgCOIdM9MjRwgYguRosE2o3hEwBPGOmemRIwQMQXI02CZU7wgYgnjHzPTIEQKGIDkabBOqdwT+H2yVV24xe7jFAAAAAElFTkSuQmCC';
    OPEN MESSAGEINFO FOR
    SELECT
    '' AS aboutphone,
    '' AS aboutdescription,
    '20px' AS lineheight,
     a AS lefticon,
    'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAKb0lEQVR4Xu2dv4ul1RnHzxmWGS6kmdtYxGLDWlikiI0mpAoLiiKsYLyJzeiAm/dNBkK6NAkZ0sTOQpb7vnsXEm2yJEZsrDbFElZd3SaQNmVg5g9IwMjc+4ZrZmEd58d7nvOc857zno+tz49zPt/z4e4dZ9Ea/oEABM4kYGEDAQicTQBBeB0QOIcAgvA8IIAgvAEIyAjwCSLjRlchBBCkkKC5powAgsi40VUIAQQpJGiuKSOAIDJudBVCAEEKCZprygggiIwbXYUQQJBCguaaMgIIIuNGVyEEEKSQoLmmjACCyLjRVQgBBCkkaK4pI4AgMm50FUKgSEEWi8Xjq9Vqxxiz2XXdf5fL5e/39vYOC8mcazoQKE6Qtm0Xxpg3TjLquu7tuq5/7sCO0gIIFCVI0zQfWGuvnZVr13Xv1XX9SgG5c8WeBIoRpGmaX1pr37yIC5JcRKisf1+EILdu3ZoeHR39y1o76RMvkvShVEZNEYI0TbNjrX3HJVIkcaE13toiBGnb9tfGmN+6xogkrsTGV1+KIL8wxrwljO8vVVX9UNhLW+YEihBksVh8d7VafeKR1Yfb29vXZrPZ0mMGrRkSKEKQdS5N0/zDWvttj4yQxANerq3FCDKfzy9vbGz81RhzRRpW13Xv13X9srSfvvwIFCPIOprFYvHYarW6Z4x5wiMqPkk84OXWWpQgSJLb8xz+vMUJgiTDP7qcTlCkIEiS0xMd9qzFCoIkwz68XLYXLQiS5PJMhztn8YIgyXCPL4fNCHKcEj8CzuG5xj8jgjzCHEniP8DUNyLIiYSQJPUnG/d8CHIKby1JDg4OXtrf3z+KGynbNAkgyBk0NSTpuu7O4eHhC0ii+WTjzkKQc3gjSdzHmOI2BLkgFSRJ8dnGOxOC9GCNJD0gjbQEQXoGiyQ9QY2sDEEcAkUSB1gjKUUQxyCRxBFY5uUIIggQSQTQMm1BEGFwSCIEl1kbgngEhiQe8DJpRRDPoJDEE2Di7QiiEBCSKEBMdASCKAWDJEogExuDIIqBIIkizERGIYhyEFqSTKfTF2ez2RfKx2OcIwEEcQTWp1xJkrvT6fQ5JOlDPFwNggRiiySBwEYeiyABgSNJQLiRRiNIYNBIEhhw4PEIEhjwejySRIAcaAWCBAJ7ciySRAKtvAZBlIGeNw5JIsJWWoUgSiD7jkGSvqTSqEOQAXJAkgGgC1ciiBCcbxuS+BKM048gcTifugVJBoTfczWC9AQVqgxJQpHVmYsgOhy9piCJF76gzQgSFG//4UjSn1XMSgSJSfuCXVqSbG1tPb+7u/t5QlfL9igIklh0GpIYYz7e3Ny8iiT+4SKIP0P1CUiijlQ8EEHE6MI2riVZLpf3rbWXPTbxSeIBb92KIJ4AQ7bP5/NvWmvvIUlIyufPRpDh2PfajCS9MAUrQpBgaPUGI4keS9dJCOJKbKB6JBkGPIIMw120FUlE2LyaEMQLX/xmJInLHEHi8lbZhiQqGHsNQZBemNIrQpI4mSBIHM5BtiBJEKxfGYog4RkH3YAkQfHyX9LD4o0zHUnCceYTJBzbqJO1JJlMJs/u7Oz8J+rhE16GIAmH43o0JUkeTCaTHyDJ/+kjiOsrTLweSXQDQhBdnklMQxK9GBBEj2VSk5BEJw4E0eGY5BQk8Y8FQfwZJj0BSfziQRA/fll0I4k8JgSRs8uqE0lkcSGIjFuWXUjiHhuCuDPLugNJ3OJDEDdeo6heLBaPr1arvxljviW9UNd1ny2Xy6t7e3v/ls7IoQ9BckgpwBmVJHmvrutXAhwvmZEIkkwU8Q+iJMmzdV3fiX/6OBsRJA7nZLcoSHK7qqpXk72g58EQxBPgGNo9v7j/vaqqp8bA4bQ7IMhYk3W4l6cgD6qqetphXValCJJVXPqH9ZTDdF3X1HX9U/2TpTERQdLIYZBTHH//uGuMuSI9wMbGxveuX79+X9qfeh+CpJ5QoPNpyNF13bt1Xb8W6IhJjEWQJGKIewgNOYwxn04mk6tj/6u5CBL3bQ6+zfc7x/EFivl76wgy+JONdwDkcGeNIO7MsuxADllsCCLjllUXcsjjQhA5uyw6kcMvJgTx45d0N3L4x4Mg/gyTnIAcOrEgiA7HpKYgh14cCKLHMolJyKEbA4Lo8hx0GnLo40cQfaaDTESOMNgRJAzXqFOV5PiY/zfI12NDkKhPWX+Zlhybm5tXd3d3P9c/Yd4TESTj/JAjfHgIEp5xkA3IEQTr14YiSBzOqluQQxXnucMQJB5rlU3IoYKx9xAE6Y1q+ELkiJ8BgsRnLtqIHCJs3k0I4o0w/ADkCM/4rA0IMhz7XpuRoxemYEUIEgyt/2Dk8GfoOwFBfAkG6keOQGAdxyKII7AY5cgRg3K/HQjSj1O0KuSIhrrXIgTphSlOkYYcXdfd3draep5fPNTJDEF0OHpP0ZJjOp0+N5vNvvA+EAO+JIAgCTwE5EgghDOOgCADZ4McAwdwwXoEGTCfxWLx2HK5vG+tvSw9xvo7B3+sktK7uA9BLmYUpGItx2q1umeMeUK6ADmk5Pr3IUh/VmqVyKGGMvggBAmO+KsLkCMycM91COIJ0KUdOVxopVGLIJFyQI5IoJXXIIgy0NPGIUcEyIFWIEggsA/HIkdgwIHHI0hAwMgREG6k0QgSCLSSHHem0+mL/G5VoJB6jEWQHpBcS7TkODw8fGF/f//IdT/1egQQRI/ll5OQQxnowOMQRDEA5FCEmcgoBFEKAjmUQCY2BkEUAkEOBYiJjkAQz2CQwxNg4u0I4hEQcnjAy6QVQYRBIYcQXGZtCCIIDDkE0DJtQRDH4JDDEVjm5QjiECByOMAaSSmC9AwSOXqCGlkZgvQIFDl6QBppCYJcEKyGHMaYDw8ODl7iFw/zswhBzslMS47t7e1rs9lsmd/z4MQIcsYbQA7kWBNAkFPeAXIgx0MCCHLiLSAHcjxKAEEeoYEcyHGSAIIcE0EO5DiNAIIo/TXZ9Y9y+WnV+CQrXhA+Ocb3qDVvVLQgyKH5lMY5q1hBkGOcD1r7VkUKghzaz2i884oTBDnG+5hD3KwoQZAjxBMa98xiBLlx48Y3Ll269MAY86RHpH+uqmrm0U9rZgSKEaRt2z8YY17zyAc5PODl2lqEIG3bXjHG/NMjJOTwgJdzaxGCNE3zM2vtDUlQXdf9qa7rH0l66cmfQBGCtG27b4z5jSAuPjkE0MbUUoQgTdP8xFrbOgaHHI7AxlhehCCu30H4Y9UYn7rsTkUIskbTtu1tY0yf7xK3q6p6VYaTrrERKEaQY0n+aIz58TkhvlNV1etjC5n7yAkUJcga082bN1/uuu5XxpjvPMTWdd1n1trfVVX1gRwlnWMkUJwgD0Ocz+fft9Y+Y639qKqqT8cYLnfyJ1CsIP7omFACAQQpIWXuKCaAIGJ0NJZAAEFKSJk7igkgiBgdjSUQQJASUuaOYgIIIkZHYwkEEKSElLmjmACCiNHRWAIBBCkhZe4oJoAgYnQ0lkAAQUpImTuKCSCIGB2NJRBAkBJS5o5iAggiRkdjCQQQpISUuaOYAIKI0dFYAgEEKSFl7igm8D/F3QsjHGil9QAAAABJRU5ErkJggg==' AS righttext,
    '岗位切换' AS describe,
    'Link' AS itemtype,
    '' AS beforewarningmsg,
    '' msgtitle,
    'pom-station-list' dataurl
FROM
    dual
UNION ALL
SELECT
    '' AS aboutphone,
    '' AS aboutdescription,
    '20px' AS lineheight,
     b AS lefticon,
    'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAKb0lEQVR4Xu2dv4ul1RnHzxmWGS6kmdtYxGLDWlikiI0mpAoLiiKsYLyJzeiAm/dNBkK6NAkZ0sTOQpb7vnsXEm2yJEZsrDbFElZd3SaQNmVg5g9IwMjc+4ZrZmEd58d7nvOc857zno+tz49zPt/z4e4dZ9Ea/oEABM4kYGEDAQicTQBBeB0QOIcAgvA8IIAgvAEIyAjwCSLjRlchBBCkkKC5powAgsi40VUIAQQpJGiuKSOAIDJudBVCAEEKCZprygggiIwbXYUQQJBCguaaMgIIIuNGVyEEEKSQoLmmjACCyLjRVQgBBCkkaK4pI4AgMm50FUKgSEEWi8Xjq9Vqxxiz2XXdf5fL5e/39vYOC8mcazoQKE6Qtm0Xxpg3TjLquu7tuq5/7sCO0gIIFCVI0zQfWGuvnZVr13Xv1XX9SgG5c8WeBIoRpGmaX1pr37yIC5JcRKisf1+EILdu3ZoeHR39y1o76RMvkvShVEZNEYI0TbNjrX3HJVIkcaE13toiBGnb9tfGmN+6xogkrsTGV1+KIL8wxrwljO8vVVX9UNhLW+YEihBksVh8d7VafeKR1Yfb29vXZrPZ0mMGrRkSKEKQdS5N0/zDWvttj4yQxANerq3FCDKfzy9vbGz81RhzRRpW13Xv13X9srSfvvwIFCPIOprFYvHYarW6Z4x5wiMqPkk84OXWWpQgSJLb8xz+vMUJgiTDP7qcTlCkIEiS0xMd9qzFCoIkwz68XLYXLQiS5PJMhztn8YIgyXCPL4fNCHKcEj8CzuG5xj8jgjzCHEniP8DUNyLIiYSQJPUnG/d8CHIKby1JDg4OXtrf3z+KGynbNAkgyBk0NSTpuu7O4eHhC0ii+WTjzkKQc3gjSdzHmOI2BLkgFSRJ8dnGOxOC9GCNJD0gjbQEQXoGiyQ9QY2sDEEcAkUSB1gjKUUQxyCRxBFY5uUIIggQSQTQMm1BEGFwSCIEl1kbgngEhiQe8DJpRRDPoJDEE2Di7QiiEBCSKEBMdASCKAWDJEogExuDIIqBIIkizERGIYhyEFqSTKfTF2ez2RfKx2OcIwEEcQTWp1xJkrvT6fQ5JOlDPFwNggRiiySBwEYeiyABgSNJQLiRRiNIYNBIEhhw4PEIEhjwejySRIAcaAWCBAJ7ciySRAKtvAZBlIGeNw5JIsJWWoUgSiD7jkGSvqTSqEOQAXJAkgGgC1ciiBCcbxuS+BKM048gcTifugVJBoTfczWC9AQVqgxJQpHVmYsgOhy9piCJF76gzQgSFG//4UjSn1XMSgSJSfuCXVqSbG1tPb+7u/t5QlfL9igIklh0GpIYYz7e3Ny8iiT+4SKIP0P1CUiijlQ8EEHE6MI2riVZLpf3rbWXPTbxSeIBb92KIJ4AQ7bP5/NvWmvvIUlIyufPRpDh2PfajCS9MAUrQpBgaPUGI4keS9dJCOJKbKB6JBkGPIIMw120FUlE2LyaEMQLX/xmJInLHEHi8lbZhiQqGHsNQZBemNIrQpI4mSBIHM5BtiBJEKxfGYog4RkH3YAkQfHyX9LD4o0zHUnCceYTJBzbqJO1JJlMJs/u7Oz8J+rhE16GIAmH43o0JUkeTCaTHyDJ/+kjiOsrTLweSXQDQhBdnklMQxK9GBBEj2VSk5BEJw4E0eGY5BQk8Y8FQfwZJj0BSfziQRA/fll0I4k8JgSRs8uqE0lkcSGIjFuWXUjiHhuCuDPLugNJ3OJDEDdeo6heLBaPr1arvxljviW9UNd1ny2Xy6t7e3v/ls7IoQ9BckgpwBmVJHmvrutXAhwvmZEIkkwU8Q+iJMmzdV3fiX/6OBsRJA7nZLcoSHK7qqpXk72g58EQxBPgGNo9v7j/vaqqp8bA4bQ7IMhYk3W4l6cgD6qqetphXValCJJVXPqH9ZTDdF3X1HX9U/2TpTERQdLIYZBTHH//uGuMuSI9wMbGxveuX79+X9qfeh+CpJ5QoPNpyNF13bt1Xb8W6IhJjEWQJGKIewgNOYwxn04mk6tj/6u5CBL3bQ6+zfc7x/EFivl76wgy+JONdwDkcGeNIO7MsuxADllsCCLjllUXcsjjQhA5uyw6kcMvJgTx45d0N3L4x4Mg/gyTnIAcOrEgiA7HpKYgh14cCKLHMolJyKEbA4Lo8hx0GnLo40cQfaaDTESOMNgRJAzXqFOV5PiY/zfI12NDkKhPWX+Zlhybm5tXd3d3P9c/Yd4TESTj/JAjfHgIEp5xkA3IEQTr14YiSBzOqluQQxXnucMQJB5rlU3IoYKx9xAE6Y1q+ELkiJ8BgsRnLtqIHCJs3k0I4o0w/ADkCM/4rA0IMhz7XpuRoxemYEUIEgyt/2Dk8GfoOwFBfAkG6keOQGAdxyKII7AY5cgRg3K/HQjSj1O0KuSIhrrXIgTphSlOkYYcXdfd3draep5fPNTJDEF0OHpP0ZJjOp0+N5vNvvA+EAO+JIAgCTwE5EgghDOOgCADZ4McAwdwwXoEGTCfxWLx2HK5vG+tvSw9xvo7B3+sktK7uA9BLmYUpGItx2q1umeMeUK6ADmk5Pr3IUh/VmqVyKGGMvggBAmO+KsLkCMycM91COIJ0KUdOVxopVGLIJFyQI5IoJXXIIgy0NPGIUcEyIFWIEggsA/HIkdgwIHHI0hAwMgREG6k0QgSCLSSHHem0+mL/G5VoJB6jEWQHpBcS7TkODw8fGF/f//IdT/1egQQRI/ll5OQQxnowOMQRDEA5FCEmcgoBFEKAjmUQCY2BkEUAkEOBYiJjkAQz2CQwxNg4u0I4hEQcnjAy6QVQYRBIYcQXGZtCCIIDDkE0DJtQRDH4JDDEVjm5QjiECByOMAaSSmC9AwSOXqCGlkZgvQIFDl6QBppCYJcEKyGHMaYDw8ODl7iFw/zswhBzslMS47t7e1rs9lsmd/z4MQIcsYbQA7kWBNAkFPeAXIgx0MCCHLiLSAHcjxKAEEeoYEcyHGSAIIcE0EO5DiNAIIo/TXZ9Y9y+WnV+CQrXhA+Ocb3qDVvVLQgyKH5lMY5q1hBkGOcD1r7VkUKghzaz2i884oTBDnG+5hD3KwoQZAjxBMa98xiBLlx48Y3Ll269MAY86RHpH+uqmrm0U9rZgSKEaRt2z8YY17zyAc5PODl2lqEIG3bXjHG/NMjJOTwgJdzaxGCNE3zM2vtDUlQXdf9qa7rH0l66cmfQBGCtG27b4z5jSAuPjkE0MbUUoQgTdP8xFrbOgaHHI7AxlhehCCu30H4Y9UYn7rsTkUIskbTtu1tY0yf7xK3q6p6VYaTrrERKEaQY0n+aIz58TkhvlNV1etjC5n7yAkUJcga082bN1/uuu5XxpjvPMTWdd1n1trfVVX1gRwlnWMkUJwgD0Ocz+fft9Y+Y639qKqqT8cYLnfyJ1CsIP7omFACAQQpIWXuKCaAIGJ0NJZAAEFKSJk7igkgiBgdjSUQQJASUuaOYgIIIkZHYwkEEKSElLmjmACCiNHRWAIBBCkhZe4oJoAgYnQ0lkAAQUpImTuKCSCIGB2NJRBAkBJS5o5iAggiRkdjCQQQpISUuaOYAIKI0dFYAgEEKSFl7igm8D/F3QsjHGil9QAAAABJRU5ErkJggg==' AS righttext,
    '帮助中心' AS describe,
    'Link' AS itemtype,
    '' AS beforewarningmsg,
    '' msgtitle,
    'question-list' dataurl
FROM
    dual
UNION ALL
SELECT
    '18590769090' AS aboutphone,
    '系统名称：计划运营管理系统</br>服务顾问：王传科</br>咨询电话：185-9076-9090' AS aboutdescription,
    '20px' AS lineheight,
     c AS lefticon,
    '' AS righttext,
    '关于我们' AS describe,
    'Info' AS itemtype,
    '' AS beforewarningmsg,
    '' msgtitle,
    '' dataurl
FROM
    dual;
END P_POM_MOBILE_CENTER_MESSAGE;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MOBILE_DELAY_NODE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_MOBILE_DELAY_NODE" (
    currentuserid IN VARCHAR2,
    currentstationid IN VARCHAR2,
    currentdeptid IN VARCHAR2,
    currentcompanyid IN VARCHAR2,
    bizcode IN VARCHAR2,
    plantype       IN             VARCHAR2,
    orgid          IN             VARCHAR2,
    title          OUT            VARCHAR2,
    pageindex     IN            INT,
    pagesizes     IN            INT,
    titleicon      OUT            VARCHAR2,
    currentdelay   OUT            SYS_REFCURSOR
) IS
    v_spid              VARCHAR2(200);
    --关键节点计划监控-当前延误节点
    --作者：鲜晓勇
    --日期：2020/03/20
BEGIN
    title := '当前延误节点';
    --图标库地址 https://element.eleme.cn/#/zh-CN/component/icon
    titleicon := 'el-icon-tickets';
    --调用数据权限验证存储过程
    P_SYS_AUTH_DATA_RULE_SPID(
            USERID => currentuserid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
    OPEN CURRENTDELAY FOR
        SELECT t.* from
           (
              select t1.*,rownum as rowno from (
                SELECT DISTINCT
                    '已超期' as "nodeStatus",
                    B2.PLAN_END_DATE AS "nodeTime",
                    B2.ORIGINAL_PLAN_ID as "nodeOriginalId",
                    plantype as "nodePlanType",
                    A.ORG_NAME AS "orgName",
                    B2.PROJECTSTAGE_NAME AS "projName",
                    '【'||B2.PROJECTSTAGE_NAME||'】'||B2.NODE_NAME AS "nodeName",
                    NODE_ID as "nodeId",
                    ORIGINAL_NODE_ID as "nodeOriginId",
                    '' AS "projOpenUrl",
                    '' AS "nodeOpenUrl",
                    '已延期'
                        ||TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd'))
                        ||'天' 			AS "delayDays",
                    TO_NUMBER(nvl(TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd')),0)) as days
                FROM   SYS_BUSINESS_UNIT A
                        LEFT   JOIN
                    (
                            SELECT LEVEL, ORG_NAME, CONNECT_BY_ROOT ID AS ID,
                               CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
                               B.UNIT_ID, B.NODE_NAME, B.NODE_ID,
                               B.ACTUAL_END_DATE, B.PLAN_END_DATE,
                               B.PROJECTSTAGE_NAME, B.PPID, B.PID,
                               'TYPE_ORG' AS CTYPE, B.ESTIMATE_END_DATE,
                               B.PLANID, ORIGINAL_NODE_ID,B.COMPANY_ID,
                               B.PROJ_ID,
                               B.STAGE_PROJECT_ID,
                               B.STAGE_ID,
                               ORIGINAL_PLAN_ID
                        FROM   SYS_BUSINESS_UNIT A
                                LEFT   JOIN
                            (
                                    SELECT B1.UNIT_ID,
                                           A.ID AS PLANID,
                                           A.COMPANY_ID,
                                           A.PROJ_ID,
                                           C1.PROJECT_ID AS STAGE_PROJECT_ID,
                                           C1.ID as STAGE_ID,
                                           B1.ID AS PPID, B1.ID AS PID,
                                           A1.ORIGINAL_NODE_ID,
                                           A1.ORIGINAL_PLAN_ID,
                                           A.PROJ_NAME AS PROJECTSTAGE_NAME,
                                           A1.NODE_NAME, A1.ID AS NODE_ID,
                                           A1.ACTUAL_END_DATE,
                                           A1.PLAN_END_DATE,
                                           A1.ESTIMATE_END_DATE
                                    FROM   POM_PROJ_PLAN A
                                                INNER  JOIN POM_PROJ_PLAN_NODE A1
                                                    ON     A.ID = A1.PROJ_PLAN_ID AND A1.IS_DISABLE=0
                                                INNER  JOIN SYS_PROJECT_STAGE C1
                                                    ON     A.PROJ_ID = C1.ID
                                                INNER  JOIN SYS_PROJECT B1
                                                     ON    C1.PROJECT_ID = B1.ID  WHERE  A.PLAN_TYPE = plantype
                                                        AND A.APPROVAL_STATUS = '已审核'
                                                        AND TRUNC(SYSDATE, 'dd') -TRUNC(PLAN_END_DATE, 'dd') > 0
                                                        AND ACTUAL_END_DATE IS NULL
                             ) B
                                    ON A.ID = B.UNIT_ID WHERE  ORG_TYPE = 0
                                        START  WITH ID = ORGID
                                        CONNECT BY PRIOR A.ID = A.PARENT_ID) B2
                                             ON     A.ID = B2.ID
                                       LEFT JOIN
                                        (
                                           select DISTINCT org_id AS ogid from  TMP_AUTH_LIST where id = v_spid)  tal
                                            on tal.ogid=B2.STAGE_PROJECT_ID
                            WHERE  NODE_NAME IS NOT NULL AND
                                    tal.ogid is not null AND
                                    ACTUAL_END_DATE IS NULL AND
                                        TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 --分期
                            UNION
                            SELECT DISTINCT
                                '已超期' as "nodeStatus",
                                PLAN_END_DATE AS "nodeTime",
                                A1.ORIGINAL_PLAN_ID as "nodeOriginalId",
                                plantype as "nodePlanType",
                                '' AS "orgName",
                                A.PROJ_NAME AS "projName",
                                '【'||A.PROJ_NAME||'】'||A1.NODE_NAME AS "nodeName",
                                A1.ID as "nodeId",
                                A1.ORIGINAL_NODE_ID as "nodeOriginId",
                                '' AS "projOpenUrl",
                                '' AS "nodeOpenUrl",
                                '已延期'
                                    ||TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd'))
                                    ||'天' 			AS "delayDays",
                                TO_NUMBER(nvl(TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd')),0)) as days

                            FROM   POM_PROJ_PLAN A
                                       INNER  JOIN POM_PROJ_PLAN_NODE A1
                                                   ON     A.ID = A1.PROJ_PLAN_ID AND A1.IS_DISABLE=0
                                       INNER  JOIN SYS_PROJECT_STAGE C1
                                                   ON     A.PROJ_ID = C1.ID
                                       INNER  JOIN SYS_PROJECT B1
                                                   ON     C1.PROJECT_ID = B1.ID
                                       LEFT JOIN (select DISTINCT org_id AS ogid from  TMP_AUTH_LIST where id = v_spid)  tal
                                                 on tal.ogid=C1.PROJECT_ID or tal.ogid=C1.ID
                            WHERE  A.PLAN_TYPE = plantype AND
                                    A.APPROVAL_STATUS = '已审核'   AND
                                    tal.ogid is not null AND
                                        TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 AND
                                    ACTUAL_END_DATE IS NULL AND
                                    C1.PROJECT_ID = ORGID
                            order by days desc
              ) t1
           )t  where  rownum <=  pageindex * pagesizes AND t.rowno >= pagesizes * ( pageindex - 1 );
END p_pom_mobile_delay_node;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MOBILE_DELAY_NODE_MORE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_MOBILE_DELAY_NODE_MORE" (
    currentuserid IN VARCHAR2,
    currentstationid IN VARCHAR2,
    currentdeptid IN VARCHAR2,
    currentcompanyid IN VARCHAR2,
    bizcode IN VARCHAR2,
    plantype       IN             VARCHAR2,
    orgid          IN             VARCHAR2,
    pageIndex     IN            INT,
    pageRows     IN            INT,
    currentdelay   OUT            SYS_REFCURSOR
) IS
    v_spid              VARCHAR2(200);
    --关键节点计划监控-当前延误节点
    --作者：鲜晓勇
    --日期：2020/03/20
BEGIN

    --调用数据权限验证存储过程
    P_SYS_AUTH_DATA_RULE_SPID(
            USERID => currentuserid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
    );
    OPEN CURRENTDELAY FOR
        SELECT t3.*
        from (
            select t2.*
            from (
                 select
                     t1.*,
                     rownum as rowno
                 from (
                     SELECT DISTINCT
                         '已超期' as "nodeStatus",
                         to_char(B2.PLAN_END_DATE,'yyyy-MM-dd') as "nodeTime",
                         B2.ORIGINAL_PLAN_ID as "planOriginalId",
                         ''||plantype||'' as "nodePlanType",
                         A.ORG_NAME AS "orgName",
                         B2.PROJECTSTAGE_NAME AS "projName",
                         '【'||B2.PROJECTSTAGE_NAME||'】'||B2.NODE_NAME AS "nodeName",
                         NODE_ID as "nodeId",
                         ORIGINAL_NODE_ID as "nodeOriginalId",
                         '' AS "projOpenUrl",
                         '' AS "nodeOpenUrl",
                         '已延期'
                             ||TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd'))
                             ||'天' 			AS "delayDays",
                         TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd')) days
                     FROM SYS_BUSINESS_UNIT A
                     LEFT JOIN (
                         SELECT LEVEL, ORG_NAME, CONNECT_BY_ROOT ID AS ID,
                            CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
                            B.UNIT_ID, B.NODE_NAME, B.NODE_ID,
                            B.ACTUAL_END_DATE, B.PLAN_END_DATE,
                            B.PROJECTSTAGE_NAME, B.PPID, B.PID,
                            'TYPE_ORG' AS CTYPE, B.ESTIMATE_END_DATE,
                            B.PLANID, ORIGINAL_NODE_ID,B.COMPANY_ID,
                            ORIGINAL_PLAN_ID
                         FROM SYS_BUSINESS_UNIT A
                         LEFT JOIN (
                             SELECT B1.UNIT_ID, A.ID AS PLANID,A.COMPANY_ID,
                                 B1.ID AS PPID, B1.ID AS PID,
                                 A1.ORIGINAL_NODE_ID,
                                 A1.ORIGINAL_PLAN_ID,
                                 A.PROJ_NAME AS PROJECTSTAGE_NAME,
                                 A1.NODE_NAME, A1.ID AS NODE_ID,
                                 A1.ACTUAL_END_DATE,
                                 A1.PLAN_END_DATE,
                                 A1.ESTIMATE_END_DATE
                             FROM POM_PROJ_PLAN A
                             INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
                                   AND A.ID = A1.PROJ_PLAN_ID AND A1.IS_DISABLE = 0
                             INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
                             INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID
                             WHERE A.PLAN_TYPE = plantype AND A.APPROVAL_STATUS = '已审核'
                                 AND TRUNC(SYSDATE, 'dd') -TRUNC(PLAN_END_DATE, 'dd') > 0
                                 AND ACTUAL_END_DATE IS NULL
                         ) B  ON A.ID = B.UNIT_ID
                         WHERE  ORG_TYPE = 0
                         START  WITH ID = ORGID
                         CONNECT BY PRIOR A.ID = A.PARENT_ID
                     ) B2 ON A.ID = B2.ID
                     LEFT JOIN (
                         select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = v_spid
                     ) tal on tal.orgid=B2.PLANID or tal.orgid=B2.COMPANY_ID
                     WHERE NODE_NAME IS NOT NULL AND tal.orgid IS NOT NULL AND  ACTUAL_END_DATE IS NULL
                       AND TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0
                     UNION
                     SELECT DISTINCT
                         '已超期' as "nodeStatus",
                         to_char(PLAN_END_DATE,'yyyy-MM-dd') as "nodeTime",
                         A1.ORIGINAL_PLAN_ID as "planOriginalId",
                         ''||plantype||'' as "nodePlanType",
                         '' AS "orgName",
                         A.PROJ_NAME AS "projName",
                         '【'||A.PROJ_NAME||'】'||A1.NODE_NAME AS "nodeName",
                         A1.ID as "nodeId",
                         A1.ORIGINAL_NODE_ID as "nodeOriginalId",
                         '' AS "projOpenUrl",
                         '' AS "nodeOpenUrl",
                         '已延期'
                              ||TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd'))
                              ||'天' 			AS "delayDays",
                          TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd')) days
                      FROM POM_PROJ_PLAN A
                               INNER  JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
                          AND A.ID = A1.PROJ_PLAN_ID AND A1.IS_DISABLE=0
                               INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
                               INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID
                               LEFT JOIN (
                          select DISTINCT org_id AS orgid
                          from  TMP_AUTH_LIST where id = v_spid
                      )  tal on tal.orgid=C1.PROJECT_ID or tal.orgid=A1.COMPANY_ID
                      WHERE A.PLAN_TYPE = plantype AND A.APPROVAL_STATUS = '已审核' AND tal.orgid is not null
                        AND TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0
                        AND ACTUAL_END_DATE IS NULL AND C1.PROJECT_ID = ORGID
                  ) t1 order by days*1 desc
            ) t2 where rowno > pageRows * (pageIndex - 1)
        ) t3
        where t3.rowno <= pageRows * pageIndex;
END p_pom_mobile_delay_node_more;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MOBILE_DELAY_NODE_PRED
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_MOBILE_DELAY_NODE_PRED" (
    plantype       IN             VARCHAR2,
    ctype           IN             INT, ---0 查询 近五天内到期或预计延误   1 查询预计延误  2 查询近五天内到期
    orgid          IN             VARCHAR2,
    pageindex      IN              INT,
    pagesizes      IN              INT,
    userid  IN             VARCHAR2,
    currentstationid  IN          VARCHAR2,
    currentdeptid  IN       VARCHAR2,
    currentcompanyid  IN          VARCHAR2,
    bizcode  IN             VARCHAR2,
    title          OUT            VARCHAR2,
    titleicon      OUT            VARCHAR2,
    predictdelay   OUT            SYS_REFCURSOR
) AS -- 移动端 关键节点计划监控-预计延误节点
		--作者：鲜晓勇
		--日期：2020/03/20
    v_sql   CLOB;
    v_sql_exec CLOB;
    v_caseSql  CLOB;
    v_whereSql CLOB;
    v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN
    title := '预计延误及5天内到期节点';
    titleicon := '';
     IF ctype=0 THEN
    v_whereSql:=' AND (TRUNC(ESTIMATE_END_DATE , ''dd'' ) - TRUNC(PLAN_END_DATE , ''dd'' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, ''dd'' ) - TRUNC( SYSDATE, ''dd'' )  BETWEEN 0 AND 5)
                             AND (TRUNC(SYSDATE , ''dd'' ) - TRUNC(PLAN_END_DATE , ''dd'' ) < 0)
                             ';
    v_caseSql:='
                 CASE
                      WHEN TRUNC(ESTIMATE_END_DATE, ''dd'') - TRUNC(PLAN_END_DATE, ''dd'') > 0 THEN
                          TO_CHAR(TRUNC(ESTIMATE_END_DATE, ''dd'') - TRUNC(PLAN_END_DATE, ''dd''))
                      WHEN TRUNC(SYSDATE, ''dd'') - TRUNC(PLAN_END_DATE) = 0 THEN TO_CHAR(0)
                      ELSE TO_CHAR(TRUNC(PLAN_END_DATE, ''dd'') - TRUNC(SYSDATE, ''dd''))
                      END         AS "days",   
                CASE  WHEN TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ) > 0   THEN
						''预计延误''||TO_CHAR( TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ))||''天'' 
								WHEN  TRUNC(SYSDATE, ''dd'') - TRUNC(PLAN_END_DATE)=0 THEN 
						''今天到期'' 
								ELSE ''余''
																||TO_CHAR(TRUNC(PLAN_END_DATE, ''dd'')-TRUNC(SYSDATE, ''dd''))
																||''天到期'' 	 END				
														AS "delayDays"';
    ELSIF ctype=1 THEN
    v_whereSql:=' AND (TRUNC(ESTIMATE_END_DATE , ''dd'' ) - TRUNC(PLAN_END_DATE , ''dd'' ) > 0 )
                 AND (TRUNC(SYSDATE , ''dd'' ) - TRUNC(PLAN_END_DATE , ''dd'' ) < 0)'
                  ;
    v_caseSql:='
                 CASE  WHEN TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ) > 0   THEN
						TO_CHAR( TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' )) END AS "days",

                CASE  WHEN TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ) > 0   THEN
						''预计延误''||TO_CHAR( TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ))||''天'' END AS "delayDays"';
    ELSE
    v_whereSql:=' AND ( TRUNC( PLAN_END_DATE, ''dd'' ) - TRUNC( SYSDATE, ''dd'' )  BETWEEN 0 AND 5)
                 AND (TRUNC(SYSDATE , ''dd'' ) - TRUNC(PLAN_END_DATE , ''dd'' ) < 0)
    ';
    v_caseSql:='  
                CASE	WHEN  TRUNC(SYSDATE, ''dd'') - TRUNC(PLAN_END_DATE)=0 THEN 
							TO_CHAR(TRUNC(PLAN_END_DATE, ''dd'')-TRUNC(SYSDATE, ''dd''))
                            END	AS "days",
                CASE	WHEN  TRUNC(SYSDATE, ''dd'') - TRUNC(PLAN_END_DATE)=0 THEN 
						''今天到期'' 
								ELSE ''余''
																||TO_CHAR(TRUNC(PLAN_END_DATE, ''dd'')-TRUNC(SYSDATE, ''dd''))
																||''天到期'' 	 END				
														AS "delayDays" 
                                                        ';
    END IF;

    --调用数据权限验证存储过程
    p_sys_auth_data_rule_spid(userid => userid, stationid => currentstationid, deptid => currentdeptid, companyid => currentcompanyid
    , bizcode => bizcode, data_auth_spid => v_spid);

    v_sql:='select t3.* from (
                select rownum as rowno, t2.* from (
                select t1.* from (
                    SELECT DISTINCT
                  ''未完成'' as "nodeStatus",
                  B2.ORIGINAL_PLAN_ID as "planOriginalId",
                  '''||plantype||''' as "nodePlanType",
                  to_char(B2.PLAN_END_DATE,''yyyy-MM-dd'') as "nodeTime",
                  A.ORG_NAME AS "orgName",
                  B2.PROJECTSTAGE_NAME AS "projName",
                  B2.NODE_NAME AS "nodeName",
                  ''【''||B2.PROJECTSTAGE_NAME||''】''||B2.NODE_NAME AS "allNodeName",
                  NODE_ID as "nodeId",
                  ORIGINAL_NODE_ID as "nodeOriginalId",
                  '''' AS "projOpenUrl",
                  '''' AS "nodeOpenUrl",
                  '||v_caseSql||'
                FROM
                  SYS_BUSINESS_UNIT a
                  LEFT JOIN (
                  SELECT LEVEL,
                    ORG_NAME,
                    CONNECT_BY_ROOT ID AS ID,
                    CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
                    B.UNIT_ID,
                    B.COMPANY_ID,
                    B.NODE_NAME,
                    B.ORIGINAL_PLAN_ID,
                    B.NODE_ID,
                    B.STAGE_PROJECT_ID,
                    B.ACTUAL_END_DATE,
                    B.PLAN_END_DATE,
                    B.PROJECTSTAGE_NAME,
                    B.PPID,
                    B.PID,
                    ''TYPE_ORG'' AS CTYPE,
                    B.ESTIMATE_END_DATE,
                    PLANID,
                    ORIGINAL_NODE_ID 
                  FROM
                    SYS_BUSINESS_UNIT A
                    LEFT JOIN (
                    SELECT
                      B1.UNIT_ID,
                      A.ID AS PLANID,
                      A1.ORIGINAL_NODE_ID,
                      A.PROJ_ID AS PPID,
                      C1.PROJECT_ID AS STAGE_PROJECT_ID,
                      B1.ID AS PID,
                       A.PROJ_NAME AS PROJECTSTAGE_NAME,
                       A1.ORIGINAL_PLAN_ID,
                      A1.NODE_NAME,
                      A1.ID AS NODE_ID,
                      A1.ACTUAL_END_DATE,
                      A1.PLAN_END_DATE,
                      A1.ESTIMATE_END_DATE,
                      A.COMPANY_ID
                    FROM
                      POM_PROJ_PLAN A
                      INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID AND A1.IS_DISABLE=0 
                      INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
                      INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
                    WHERE
                      A.PLAN_TYPE = '''||plantype||''' 
                      AND A.APPROVAL_STATUS = ''已审核'' 
                      '||v_whereSql||'
                      AND ACTUAL_END_DATE IS NULL 

                    ) B ON A.ID = B.UNIT_ID 
                  WHERE
                    ORG_TYPE = 0 START WITH ID = ''' || orgId || ''' CONNECT BY PRIOR A.ID = A.PARENT_ID 
                  ) B2 ON A.ID = B2.ID 
                   LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=B2.STAGE_PROJECT_ID or tal.orgid=B2.PPID
                WHERE
                  NODE_NAME IS NOT NULL 
                  AND tal.orgid is not null 
                AND
                  ACTUAL_END_DATE IS NULL 
                        --判断条件
                AND (TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ) > 0  OR 
                                         TRUNC( PLAN_END_DATE, ''dd'' ) - TRUNC( SYSDATE, ''dd'' )  BETWEEN 0 AND 5 --5天内到期
                            )
                        --分期
                UNION ALL
                SELECT DISTINCT
                   ''未完成'' as "nodeStatus",
                  A1.ORIGINAL_PLAN_ID as "planOriginalId",
                  '''||plantype||''' as "nodePlanType",
                     to_char(A1.PLAN_END_DATE,''yyyy-MM-dd'') as "nodeTime",
                  '''' AS "orgName",
                   A.PROJ_NAME AS "projName",
                  A1.NODE_NAME AS "nodeName",
                  ''【''||A.PROJ_NAME||''】''||A1.NODE_NAME AS "allNodeName",
                    A1.ID as "nodeId",
                  A1.ORIGINAL_NODE_ID as "nodeOriginalId",
                  '''' AS "projOpenUrl",
                  '''' AS "nodeOpenUrl",
                '||v_caseSql||'
                FROM
                  POM_PROJ_PLAN A
                  INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID AND A1.IS_DISABLE=0 
                  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
                  INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
                  LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal 
                  on tal.orgid=C1.PROJECT_ID or tal.orgid=A.PROJ_ID
                WHERE
                  A.PLAN_TYPE = '''||plantype||''' 
                  AND A.APPROVAL_STATUS = ''已审核'' 
                  AND tal.orgid is not null
                  ' ||v_whereSql||'
                  AND ACTUAL_END_DATE IS NULL 
                  AND C1.PROJECT_ID = ''' || orgId || '''
                ) t1 order by nvl("days", 0)*1 desc
                ) t2 
                ) t3 where t3.rowno>'||pagesizes * ( pageindex - 1 )||'';
       v_sql_exec := '
select t.* from ( '
                  || v_sql

                  || ' ) t where t.rowno <= '
                  || pagesizes * pageindex
                  || '';
       dbms_output.put_line(v_sql_exec);
   open predictdelay FOR v_sql_exec;
END p_pom_mobile_delay_node_pred;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MOBILE_ES_DEL_NODE_MORE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_MOBILE_ES_DEL_NODE_MORE" (
    plantype       IN             VARCHAR2,
    ctype           IN             INT, ---0 查询 近五天内到期或预计延误   1 查询预计延误  2 查询近五天内到期
    orgid          IN             VARCHAR2,
    pageIndex      IN              INT,
    pageRows      IN              INT,
    userid  IN             VARCHAR2,
    currentstationid  IN          VARCHAR2,
    currentdeptid  IN       VARCHAR2,
    currentcompanyid  IN          VARCHAR2,
    bizcode  IN             VARCHAR2,
    predictdelay   OUT            SYS_REFCURSOR
) AS -- 移动端 关键节点计划监控-预计延误节点
		--作者：鲜晓勇
		--日期：2020/03/20
    v_sql   CLOB;
    v_sql_exec CLOB;
    v_caseSql  CLOB;
    v_whereSql CLOB;
    v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN
    IF ctype=0 THEN
    v_whereSql:=' AND (TRUNC(ESTIMATE_END_DATE , ''dd'' ) - TRUNC(PLAN_END_DATE , ''dd'' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, ''dd'' ) - TRUNC( SYSDATE, ''dd'' )  BETWEEN 0 AND 5)
                             AND (TRUNC(SYSDATE , ''dd'' ) - TRUNC(PLAN_END_DATE , ''dd'' ) < 0)
                             ';
    v_caseSql:='
                 CASE
                      WHEN TRUNC(ESTIMATE_END_DATE, ''dd'') - TRUNC(PLAN_END_DATE, ''dd'') > 0 THEN
                          TO_CHAR(TRUNC(ESTIMATE_END_DATE, ''dd'') - TRUNC(PLAN_END_DATE, ''dd''))
                      WHEN TRUNC(SYSDATE, ''dd'') - TRUNC(PLAN_END_DATE) = 0 THEN TO_CHAR(0)
                      ELSE TO_CHAR(TRUNC(PLAN_END_DATE, ''dd'') - TRUNC(SYSDATE, ''dd''))
                      END         AS "days",   
                CASE  WHEN TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ) > 0   THEN
						''预计延误''||TO_CHAR( TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ))||''天'' 
								WHEN  TRUNC(SYSDATE, ''dd'') - TRUNC(PLAN_END_DATE)=0 THEN 
						''今天到期'' 
								ELSE ''余''
																||TO_CHAR(TRUNC(PLAN_END_DATE, ''dd'')-TRUNC(SYSDATE, ''dd''))
																||''天到期'' 	 END				
														AS "delayDays"';
    ELSIF ctype=1 THEN
    v_whereSql:=' AND (TRUNC(ESTIMATE_END_DATE , ''dd'' ) - TRUNC(PLAN_END_DATE , ''dd'' ) > 0 )
                 AND (TRUNC(SYSDATE , ''dd'' ) - TRUNC(PLAN_END_DATE , ''dd'' ) < 0)'
                  ;
    v_caseSql:='
                 CASE  WHEN TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ) > 0   THEN
						TO_CHAR( TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' )) END AS "days",

                CASE  WHEN TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ) > 0   THEN
						''预计延误''||TO_CHAR( TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ))||''天'' END AS "delayDays"';
    ELSE
    v_whereSql:=' AND ( TRUNC( PLAN_END_DATE, ''dd'' ) - TRUNC( SYSDATE, ''dd'' )  BETWEEN 0 AND 5)
                 AND (TRUNC(SYSDATE , ''dd'' ) - TRUNC(PLAN_END_DATE , ''dd'' ) < 0)
    ';
    v_caseSql:='  
                CASE	WHEN  TRUNC(SYSDATE, ''dd'') - TRUNC(PLAN_END_DATE)=0 THEN 
							TO_CHAR(TRUNC(PLAN_END_DATE, ''dd'')-TRUNC(SYSDATE, ''dd''))
                            END	AS "days",
                CASE	WHEN  TRUNC(SYSDATE, ''dd'') - TRUNC(PLAN_END_DATE)=0 THEN 
						''今天到期'' 
								ELSE ''余''
																||TO_CHAR(TRUNC(PLAN_END_DATE, ''dd'')-TRUNC(SYSDATE, ''dd''))
																||''天到期'' 	 END				
														AS "delayDays" 
                                                        ';
    END IF;

    --调用数据权限验证存储过程
    p_sys_auth_data_rule_spid(userid => userid, stationid => currentstationid, deptid => currentdeptid, companyid => currentcompanyid
    , bizcode => bizcode, data_auth_spid => v_spid);

    v_sql:='select t3.* from (
                select rownum as rowno, t2.* from (
                select t1.* from (
                    SELECT DISTINCT
                  ''未完成'' as "nodeStatus",
                  B2.ORIGINAL_PLAN_ID as "planOriginalId",
                  '''||plantype||''' as "nodePlanType",
                  to_char(B2.PLAN_END_DATE,''yyyy-MM-dd'') as "nodeTime",
                  A.ORG_NAME AS "orgName",
                  B2.PROJECTSTAGE_NAME AS "projName",
                  B2.NODE_NAME AS "nodeName",
                  ''【''||B2.PROJECTSTAGE_NAME||''】''||B2.NODE_NAME AS "allNodeName",
                  NODE_ID as "nodeId",
                  ORIGINAL_NODE_ID as "nodeOriginalId",
                  '''' AS "projOpenUrl",
                  '''' AS "nodeOpenUrl",
                  '||v_caseSql||'
                FROM
                  SYS_BUSINESS_UNIT a
                  LEFT JOIN (
                  SELECT LEVEL,
                    ORG_NAME,
                    CONNECT_BY_ROOT ID AS ID,
                    CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
                    B.UNIT_ID,
                    B.COMPANY_ID,
                    B.NODE_NAME,
                    B.ORIGINAL_PLAN_ID,
                    B.NODE_ID,
                    B.STAGE_PROJECT_ID,
                    B.ACTUAL_END_DATE,
                    B.PLAN_END_DATE,
                    B.PROJECTSTAGE_NAME,
                    B.PPID,
                    B.PID,
                    ''TYPE_ORG'' AS CTYPE,
                    B.ESTIMATE_END_DATE,
                    PLANID,
                    ORIGINAL_NODE_ID 
                  FROM
                    SYS_BUSINESS_UNIT A
                    LEFT JOIN (
                    SELECT
                      B1.UNIT_ID,
                      A.ID AS PLANID,
                      A1.ORIGINAL_NODE_ID,
                      A.PROJ_ID AS PPID,
                      C1.PROJECT_ID AS STAGE_PROJECT_ID,
                      B1.ID AS PID,
                       A.PROJ_NAME AS PROJECTSTAGE_NAME,
                       A1.ORIGINAL_PLAN_ID,
                      A1.NODE_NAME,
                      A1.ID AS NODE_ID,
                      A1.ACTUAL_END_DATE,
                      A1.PLAN_END_DATE,
                      A1.ESTIMATE_END_DATE,
                      A.COMPANY_ID
                    FROM
                      POM_PROJ_PLAN A
                      INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID AND A1.IS_DISABLE=0 
                      INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
                      INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
                    WHERE
                      A.PLAN_TYPE = '''||plantype||''' 
                      AND A.APPROVAL_STATUS = ''已审核'' 
                      '||v_whereSql||'
                      AND ACTUAL_END_DATE IS NULL 

                    ) B ON A.ID = B.UNIT_ID 
                  WHERE
                    ORG_TYPE = 0 START WITH ID = ''' || orgId || ''' CONNECT BY PRIOR A.ID = A.PARENT_ID 
                  ) B2 ON A.ID = B2.ID 
                   LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=B2.STAGE_PROJECT_ID or tal.orgid=B2.PPID
                WHERE
                  NODE_NAME IS NOT NULL 
                  AND tal.orgid is not null 
                AND
                  ACTUAL_END_DATE IS NULL 
                        --判断条件
                AND (TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ) > 0  OR 
                                         TRUNC( PLAN_END_DATE, ''dd'' ) - TRUNC( SYSDATE, ''dd'' )  BETWEEN 0 AND 5 --5天内到期
                            )
                        --分期
                UNION ALL
                SELECT DISTINCT
                   ''未完成'' as "nodeStatus",
                  A1.ORIGINAL_PLAN_ID as "planOriginalId",
                  '''||plantype||''' as "nodePlanType",
                     to_char(A1.PLAN_END_DATE,''yyyy-MM-dd'') as "nodeTime",
                  '''' AS "orgName",
                   A.PROJ_NAME AS "projName",
                  A1.NODE_NAME AS "nodeName",
                  ''【''||A.PROJ_NAME||''】''||A1.NODE_NAME AS "allNodeName",
                    A1.ID as "nodeId",
                  A1.ORIGINAL_NODE_ID as "nodeOriginalId",
                  '''' AS "projOpenUrl",
                  '''' AS "nodeOpenUrl",
                '||v_caseSql||'
                FROM
                  POM_PROJ_PLAN A
                  INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID AND A1.IS_DISABLE=0 
                  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
                  INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
                  LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal 
                  on tal.orgid=C1.PROJECT_ID or tal.orgid=A.PROJ_ID
                WHERE
                  A.PLAN_TYPE = '''||plantype||''' 
                  AND A.APPROVAL_STATUS = ''已审核'' 
                  AND tal.orgid is not null
                  ' ||v_whereSql||'
                  AND ACTUAL_END_DATE IS NULL 
                  AND C1.PROJECT_ID = ''' || orgId || '''
                ) t1 order by nvl("days", 0)*1 desc
                ) t2 
                ) t3 where t3.rowno>'||pageRows * ( pageIndex - 1 )||'';
       v_sql_exec := '
select t.* from ( '
                  || v_sql

                  || ' ) t where t.rowno <= '
                  || pageRows * pageIndex
                  || '';
       dbms_output.put_line(v_sql_exec);
   open predictdelay FOR v_sql_exec;


END p_pom_mobile_es_del_node_more;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MOBILE_HELP_CENTER
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_MOBILE_HELP_CENTER" (
    HELPINFO  OUT SYS_REFCURSOR
) IS BEGIN 

    OPEN HELPINFO FOR 
		SELECT
			ID as "id" ,
			Question as "question",
			Answer as "answer",
			System_ID as "systemId",
			Category as "category",
			Usable as "usable",
			Useless as "useless",
			CREATOR_ID as "creatorId",
			CREATED as "created",
			CREATOR as "creator",
			MODIFIER_ID as "modifierId",
			MODIFIER as "modifier",
			MODIFIED as "modified"
		FROM
			POM_FAQ;
END P_POM_MOBILE_HELP_CENTER;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MOBILE_HELP_MESSAGE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_MOBILE_HELP_MESSAGE" (
    FAQID POM_FAQ.ID%TYPE,
    HELPINFO  OUT SYS_REFCURSOR
) IS BEGIN 

    OPEN HELPINFO FOR 
		SELECT
			ID as "id" ,
			Question as "question",
			Answer as "answer",
			System_ID as "systemId",
			Category as "category",
			Usable as "usable",
			Useless as "useless",
			CREATOR_ID as "creatorId",
			CREATED as "created",
			CREATOR as "creator",
			MODIFIER_ID as "modifierId",
			MODIFIER as "modifier",
			MODIFIED as "modified"
		FROM
			POM_FAQ
        WHERE
            ID = FAQID;
END P_POM_MOBILE_HELP_MESSAGE;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MOBILE_KEY_NODE_RATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_MOBILE_KEY_NODE_RATE" 
(
      ORGID          IN VARCHAR2 := '003200000000000000000000000000'
	 ,DATASCOPE      IN VARCHAR2
	 ,PLANTYPE       IN VARCHAR2
     ,LEVEL_RANK     IN  INT
	 ,COMPLETIONRATE OUT SYS_REFCURSOR
     ,USERID         IN  VARCHAR2
     ,STATIONID      IN  VARCHAR2
     ,DEPTID         IN  VARCHAR2
     ,COMPANYID      IN  VARCHAR2
     ,BIZCODE        IN  VARCHAR2
     ,AUTHORGS       out clob
) AS
		--移动端关键节点计划监控-关键节点完成率查询
		--作者：鲜晓勇
		--日期：2020/03/20
		--查询2级单位SELECT * from  SYS_BUSINESS_UNIT A WHERE  A.COMPANY_TYPE='5' AND  PARENT_ID='003200000000000000000000000000'
    v_sql              CLOB;
    v_spid             VARCHAR2(200);---数据验证spid
    v_viewName         VARCHAR2(50);
    v_levelSql         CLOB;
    v_whereSql         CLOB:='where 1=1 ';
    v_unionSql         CLOB :=' AND 1=1 ';
    v_exectSql          CLOB:='';
    v_parentSql        CLOB :='''' || ORGID ||''' AS "parentId"';
BEGIN

        IF DATASCOPE='thisMonth' THEN
            IF PLANTYPE='关键节点计划'THEN
                 v_viewName:='V_POM_KEYNODE_M_STATISTICS';
            ELSE 
                 v_viewName:='V_POM_MAIN_PLAN_M_STATISTICS';
            END IF;
        ELSIF DATASCOPE='thisQuarter'THEN
            IF PLANTYPE='关键节点计划'THEN
                v_viewName:='V_POM_KEY_NODE_Q_STATISTICS';
            ELSE 
                v_viewName:='V_POM_MAIN_PLAN_Q_STATISTICS';
            END IF;
        ELSIF DATASCOPE='thisYear' THEN
            IF PLANTYPE='关键节点计划'THEN
                v_viewName:='V_POM_KEY_NODE_Y_STATISTICS';
            ELSE
                v_viewName:='V_POM_MAIN_PLAN_Y_STATISTICS';
            END IF;
        END IF;
        IF(LEVEL_RANK=3)THEN 
        P_SYS_GET_PROJ_TREE_SPID(
            USERID => USERID,
            STATIONID => STATIONID,
            DEPTID => DEPTID,
            COMPANYID => COMPANYID,
            BIZCODE => BIZCODE,
            AUTH_SPID => v_spid
          );
          --AUTHORGS:= 
            SELECT WM_CONCAT(b1."projtId") into AUTHORGS
                  FROM
                      sys_business_unit a1
                      LEFT JOIN (
                          SELECT
                              c.id   AS "projtId",
                              a.company_id
                          FROM
                              pom_proj_plan        a
                              INNER JOIN pom_proj_plan_node   b ON a.id = b.proj_plan_id
                              INNER JOIN sys_project_stage    c ON c.id = proj_id
                              INNER JOIN sys_project          d ON d.id = c.project_id
                              LEFT  JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                              on (case when c.id is not null then c.PROJECT_ID else a.proj_id end)=tal.orgId
                            WHERE
                              a.plan_type = ''||PLANTYPE||''
                              AND a.approval_status = '已审核'
                              AND b.is_disable = 0
                          GROUP BY
                              a.company_id,
                              a.company_name,
                              c.id
                      ) b1 ON b1.company_id = a1.id
                      LEFT JOIN (
                          SELECT
                              wm_concat(user_name) AS user_name,
                              project_id
                          FROM
                              sys_role_user_relation_result
                          WHERE
                              role_code = 'pom_project_plan_manager'
                          GROUP BY
                              project_id
                      ) c1 ON c1.project_id = b1."projtId"
                  WHERE
                      b1."projtId" is not null
                      AND CONNECT_BY_ROOT id = ''
                                               || orgid
                                               || ''
                                                CONNECT BY
                      PRIOR a1.id = a1.parent_id;

            v_parentsql:='
             CASE
												WHEN ID = ''003200000000000000000000000000'' THEN
												 NULL
                                                WHEN ID='''||ORGID||'''
                                                THEN A.PARENT_ID
												ELSE
												 '''||ORGID||'''
										END AS "parentId"
            ';
            v_whereSql:='  AND 1=1 ';
            v_levelSql:='	FROM   '||v_viewName||' A
                        START WITH A.ID='''||ORGID||''' 
                        CONNECT BY PRIOR A.ID=A.PARENT_ID ';
        ELSE 
        --查询有权限的数据
         P_GET_COMPANY_TREE_PROJ_SPID(
            USERID => USERID,
            STATIONID => STATIONID,
            DEPTID => DEPTID,
            COMPANYID => COMPANYID,
            BIZCODE => BIZCODE,
            data_auth_spid => v_spid
          );
          --AUTHORGS
         SELECT DISTINCT
               WM_CONCAT(
              TO_CHAR(   
                     org_id  ) 
                )  into AUTHORGS
        FROM tmp_company_tree
        WHERE id = ''||v_spid||''  
            AND org_id IN (
               SELECT DISTINCT id
               FROM sys_business_unit
               START WITH id IN (
                   SELECT id
                   FROM (
                       SELECT unit_id AS id
                       FROM sys_project
                       UNION
                       SELECT subordinate_company_id AS id
                       FROM cdb_feasible_project_config
                   ) ds
               ) CONNECT BY PRIOR parent_id = id
            );
            v_whereSql:='WHERE  PARENT_ID = ''' || ORGID || '''';
            v_levelSql:='FROM   '||v_viewName||' A ';
            v_unionSql:='UNION 
                        SELECT
                                     A.CTYPE  AS   "ctype",
                                     A. LEVEL_RANK AS "levelRank",
                                     NVL(case when A.CTYPE=''TYPE_PROJLAST'' THEN A.STAGEID END,A.PARENT_ID) AS "clickOperationTypeContent",
                                      CASE
												WHEN  A.CTYPE = ''TYPE_PROJLAST'' THEN
												 ''2''
                                                WHEN  '''||ORGID||'''=''003200000000000000000000000000''
                                                THEN ''0''
												ELSE
												 ''1''
										END AS "clickOperationType" ,
                                    ISFINISHTOTAL AS "completedTotal",--已完成
                                    NODESUM AS "shouldComplete",--应完成
                                    NVL(NVL(CASE WHEN A.CTYPE=''TYPE_PROJLAST'' THEN A.STAGEID END,A.ID), '''||ORGID||''') AS "orgId",
									 A.ORG_NAME AS "orgName",
									 A.FINLISHRATE AS "completionRate",
									 CASE
												WHEN ID = ''003200000000000000000000000000'' THEN
												 NULL
												ELSE
												 PARENT_ID
										END AS "parentId", ''ThisMoth'' AS "dataScope"
						'||v_levelSql||'
						WHERE  ID = ''' || ORGID || ''' AND
									 NODESUM > 0';
        END IF;
        v_sql:='SELECT 
                                    A.CTYPE  AS   "ctype",
                                    A. LEVEL_RANK AS "levelRank",
                                     NVL(case when A.CTYPE=''TYPE_PROJLAST'' THEN A.STAGEID END,A.PARENT_ID) AS "clickOperationTypeContent",
                                     CASE
												WHEN  A.CTYPE = ''TYPE_PROJLAST'' THEN
												 ''2''
												ELSE
												 ''1''
										END AS "clickOperationType",
                                     ISFINISHTOTAL AS "completedTotal",--已完成
                                     NODESUM AS "shouldComplete",--应完成
									 --右上角显示排序
									  NVL(NVL(CASE WHEN A.CTYPE=''TYPE_PROJLAST'' THEN A.STAGEID END,A.ID), '''||ORGID||''') AS "orgId",
									 --ID
									 A.ORG_NAME AS "orgName",
									 --显示名称
									 A.FINLISHRATE AS "completionRate",
									 --完成率
									 '||v_parentSql||'
									 --父级ID
									 , ''ThisMoth'' AS "dataScope" --范围
						--A表项目计划主表计划类别通过TYPE判断
						'||v_levelSql||'
                        '||v_whereSql||'
                         AND
									 NODESUM > 0 
                        '||v_unionSql||'
                         ';
                        -- v_sql:=v_sql||' order by "completionRate"  desc';

                      IF LEVEL_RANK=3 THEN 
                      v_exectSql:='select   LPAD(rownum-1,2,''0'') as "rightLable",t.* from ('||v_sql||') t  where t."ctype"!=''TYPE_PROJTOP'' START WITH t."orgId"='''||ORGID||''' 
                        CONNECT BY PRIOR t."orgId"=t."parentId" order SIBLINGS by t."completionRate" desc';
                      ELSE
                      v_exectSql:='select LPAD(rownum-1,2,''0'') as "rightLable",t.* from ('||v_sql||') t  START WITH t."orgId"='''||ORGID||''' 
                        CONNECT BY PRIOR t."orgId"=t."parentId" order SIBLINGS by t."completionRate" desc';
                      END IF;
                            dbms_output.put_line(v_exectSql);
                                     OPEN COMPLETIONRATE FOR v_exectSql;


END P_POM_MOBILE_KEY_NODE_RATE;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MONTH_QUARTER_YEAR
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_MONTH_QUARTER_YEAR" (
    now_date     in      DATE := SYSDATE,
    o_m_begin         OUT               DATE,
    o_m_end           OUT               DATE,
    o_quarter_begin   OUT               DATE,
    o_quarter_end     OUT               DATE,
    o_year_begin      OUT               DATE,
    o_year_end        OUT               DATE
) AS
    ----计划考核日--计算当前时间，本年，本季度，本月考核的开始时间和结束时间
    --作者：陈丽
    --日期：2020-06-14
BEGIN
    SELECT
--    yyyy,
--    mm,
--    q,
m_begin,
m_end,
quarter_begin,
quarter_end,
year_begin,
year_end
    into
        o_m_begin,
        o_m_end,
        o_quarter_begin,
        o_quarter_end,
        o_year_begin,
        o_year_end

    FROM
        v_pom_month_quarter_years
    where lpad(mm, 2,'0')=to_char(now_date, 'MM') and lpad(yyyy, 4,'0')=to_char(now_date, 'yyyy');

END P_POM_MONTH_QUARTER_YEAR;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_MONTHLY_ASSESSMENT_DTL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_MONTHLY_ASSESSMENT_DTL" (
    year         IN           VARCHAR2, --年
    month        IN           VARCHAR2, --月
    companyid    IN           VARCHAR2, --当前用户公司id
    plantype     IN           INT,--计划类型30 关键节点计划、40主项计划
    baseinfo     OUT          SYS_REFCURSOR, --基本信息
    detailinfo   OUT          SYS_REFCURSOR --明细信息
) AS --公司月度考核排行详情
--作者：叶丁荣
--日期：2019/12/05
  --20201026 陈丽调整 获取月度考核排行详情

    v_plantype         VARCHAR2(20);
    v_currentquarter   VARCHAR2(20);
    v_currentdate      VARCHAR2(20);
    v_monthbegin       DATE;
    v_monthend         DATE;
    v_quarterbegin     DATE;
    v_quarterend       DATE;
    v_yearbegin        DATE;
    v_yearend          DATE; 
    
 --chenl 202021026 月开始，月结束
    o_quarter_begin    DATE;
    o_quarter_end      DATE;
BEGIN
--  获取季度开始 和结束时间
    SELECT
        m_begin,
        m_end
    INTO
        o_quarter_begin,
        o_quarter_end
    FROM
        v_pom_month_quarter_years
    WHERE
        lpad(mm, 2, '0') = lpad(month, 2, '0')
        AND lpad(yyyy, 4, '0') = year
    GROUP BY
        m_begin,
        m_end;

    dbms_output.put_line('o_quarter_BEGIN = ' || o_quarter_begin);
    dbms_output.put_line('O_quarter_END = ' || o_quarter_end);
    IF plantype = 30 THEN
        v_plantype := '关键节点计划';
    ELSE
        v_plantype := '项目主项计划';
    END IF;

OPEN baseinfo FOR WITH base AS (
                         SELECT
                             a1.*,
                             CASE
                                 WHEN a1.actual_end_date IS NULL
                                      OR pne.new_examination_score IS NULL THEN
                                     0
                                 WHEN a1.actual_end_date IS NOT NULL THEN
                                     pne.new_examination_score
                             END AS "assessmentActualNodeScore" --∑考核期内节点实际得分(B)
                         FROM
                             pom_proj_plan          a
                             INNER JOIN pom_proj_plan_node     a1 ON a.id = a1.proj_plan_id
                             INNER JOIN sys_project_stage      c1 ON a.proj_id = c1.id
                             INNER JOIN sys_project            b1 ON c1.project_id = b1.id
                             LEFT JOIN (
                                 SELECT
                                     b2.org_name,
                                     b2.id,
                                     CONNECT_BY_ROOT org_name AS scorgname,
                                     CONNECT_BY_ROOT level_rank,
                                     CONNECT_BY_ROOT id AS rootid
                                 FROM
                                     sys_business_unit b2
                                 WHERE
                                     CONNECT_BY_ROOT level_rank = 2
  -- AnD ORG_NAME='重庆事业部'
                                 CONNECT BY
                                     PRIOR b2.id = b2.parent_id
                             ) b1 ON b1.unit_id = b1.id
                             LEFT JOIN pom_node_examination   pne ON a1.id = pne.node_id
                             LEFT JOIN pom_node_feedback      d ON d.feedback_node_id = a1.id
                                                              AND feedback_type = 'CARRY_OUT'
                                                              AND d.approval_status = '已审核'
                         WHERE
                             a.approval_status = '已审核'
                             AND nvl(a1.is_delete, 0) = 0
                             AND nvl(a1.is_disable, 0) = 0
                             AND a1.plan_end_date BETWEEN o_quarter_begin AND o_quarter_end
                             AND (
                                 SELECT
                                     fn_bizparam_config('pom_fission_node_is_examined') AS is_examined
                                 FROM
                                     dual
                             ) = 0 
--and SCOrgNAmE='华南公司' 
                         --集团不加该条件
                             AND (b1.rootid = case when companyid='003200000000000000000000000000' then b1.rootid else companyid end)
    
                             AND a.plan_type = v_plantype
                             AND fission_source_original_id IS NULL
                     )
                     SELECT
                         CASE
                             WHEN SUM(1) IS NULL THEN
                                 '0.00'
                             ELSE
                                 TO_CHAR((SUM(
                                     CASE
                                         WHEN base.actual_end_date IS NOT NULL THEN
                                             1
                                         ELSE
                                             0
                                     END
                                 ) / SUM(1)) * 100, 'FM999,999,999,999,990.00')
                         END AS "percentageComplete",--完成率(P=M/N*100)
                         SUM(1) AS "assessmentTasksCount",
                         SUM(
                             CASE
                                 WHEN base.actual_end_date IS NOT NULL THEN
                                     1
                                 ELSE
                                     0
                             END
                         ) AS "missionsCompleted",
                         CASE
                             WHEN SUM(standard_score) IS NULL THEN
                                 '0.00'
                             ELSE
                                 TO_CHAR(SUM("assessmentActualNodeScore") / (SUM(standard_score)) * 100, 'FM999,999,999,999,990.00'
                                 )
                         END AS "assessmentScore",
                         SUM(standard_score) AS "assessmentStandardNodeScore",--∑考核期内节点标准分(A)
                         SUM("assessmentActualNodeScore") AS "assessmentActualNodeScore" --∑考核期内节点实际得分(B)
                     FROM
                         base;

    OPEN detailinfo FOR WITH base AS (
                           SELECT
                               CASE 
 --未到期不亮灯
                                   WHEN a1.actual_end_date IS NULL
                                        AND trunc(SYSDATE) - trunc(a1.plan_end_date) <= 0 THEN
                                       ''
 --到期当天内完成反馈
                                   WHEN a1.actual_end_date IS NOT NULL
                                        AND ( trunc(a1.actual_end_date) - trunc(a1.plan_end_date) ) <= 0 THEN
                                       '<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>'
  --到期1-5天内完成反馈
                                   WHEN a1.actual_end_date IS NOT NULL
                                        AND ( trunc(a1.actual_end_date) - trunc(a1.plan_end_date) ) BETWEEN 1 AND 5 THEN
                                       '<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>'
 --到期未反馈黄灯 
                                   WHEN a1.actual_end_date IS NULL
                                        AND ( trunc(SYSDATE) - trunc(a1.plan_end_date) ) BETWEEN 1 AND 5 THEN
                                       '<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>' 
  --到期超过5天未反馈红灯 
                                   WHEN a1.actual_end_date IS NULL
                                        AND ( ( trunc(SYSDATE) - trunc(a1.plan_end_date) ) > 5 ) THEN
                                       '<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'
                                   ELSE
                                       '<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'
                               END AS "alertStatus",--预警状态
                               CASE
                                   WHEN a1.actual_end_date IS NULL THEN
                                       '未完成'
                                   WHEN a1.actual_end_date IS NOT NULL THEN
                                       '已完成'
                               END AS "completionStatus",--完成状态
                               a1.node_name          AS "taskName",--任务名称
                               a.plan_name           AS "planName",--计划名称
                               scorgname             "area",--区域
                               b1.org_name           AS "businessDivision",--事业部
                               a.proj_name           AS "project", --项目
                               a1.duty_department    AS "department",--主责部门
                               a1.node_level         AS "tasnkLevel",--任务级别
                               TO_CHAR(a1.plan_end_date, 'yyyy-MM-dd') AS "planEndDate",--计划完成日期
                               TO_CHAR(a1.actual_end_date, 'yyyy-MM-dd') AS "factEndDate",--实际完成日期
                               CASE
                                   WHEN a1.actual_end_date IS NULL THEN
                                       NULL
                                   WHEN a1.actual_end_date IS NOT NULL THEN
                                       TO_CHAR(d.approval_time, 'yyyy-MM-dd')
                               END AS "auditCompletionDate",--核完成日期
                               a1.standard_score     AS "standardScore",--标准分值
                               CASE
                                   WHEN a1.actual_end_date IS NULL THEN
                                       0 || '%'
                                   WHEN a1.actual_end_date IS NOT NULL THEN
                                           CASE
                                               WHEN pne.standard_score = 0 THEN
                                                   0
                                               ELSE
                                                   round(pne.new_examination_score / pne.standard_score, 2) * 100
                                           END
                                           || '%'
                               END AS "scoringPercentage",--得分比例
                               CASE
                                   WHEN a1.actual_end_date IS NULL
                                        OR pne.new_examination_score IS NULL THEN
                                       0
                                   WHEN a1.actual_end_date IS NOT NULL THEN
                                       pne.new_examination_score
                               END AS "actualScore",--实际得分
                               a1.id                 AS "node_id",
                               a.id                  AS "plan_id",
                               a1.original_node_id   AS "original_node_id"
                           FROM
                               pom_proj_plan          a
                               INNER JOIN pom_proj_plan_node     a1 ON a.id = a1.proj_plan_id
                               INNER JOIN sys_project_stage      c1 ON a.proj_id = c1.id
                               INNER JOIN sys_project            b1 ON c1.project_id = b1.id
                               LEFT JOIN (
                                   SELECT
                                       b2.org_name,
                                       b2.id,
                                       CONNECT_BY_ROOT org_name AS scorgname,
                                       CONNECT_BY_ROOT level_rank,
                                       CONNECT_BY_ROOT id AS rootid
                                   FROM
                                       sys_business_unit b2
                                   WHERE
                                       CONNECT_BY_ROOT level_rank = 2
  -- AnD ORG_NAME='重庆事业部'
                                   CONNECT BY
                                       PRIOR b2.id = b2.parent_id
                               ) b1 ON b1.unit_id = b1.id
                               LEFT JOIN pom_node_examination   pne ON a1.id = pne.node_id
                               LEFT JOIN pom_node_feedback      d ON d.feedback_node_id = a1.id
                                                                AND feedback_type = 'CARRY_OUT'
                                                                AND d.approval_status = '已审核'
                           WHERE
                               a.approval_status = '已审核'
                               AND nvl(a1.is_delete, 0) = 0
                               AND nvl(a1.is_disable, 0) = 0
                               AND a1.plan_end_date BETWEEN o_quarter_begin AND o_quarter_end
                               AND (
                                   SELECT
                                       fn_bizparam_config('pom_fission_node_is_examined') AS is_examined
                                   FROM
                                       dual
                               ) = 0 
--and SCOrgNAmE='华南公司' 
                           --集团不加该条件
                             AND (b1.rootid = case when companyid='003200000000000000000000000000' then b1.rootid else companyid end)
     AND a.plan_type = v_plantype
                               AND fission_source_original_id IS NULL
                       )
                       SELECT
                           *
                       FROM
                           base order by "planEndDate","planName","taskName";

END p_pom_monthly_assessment_dtl;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MSG_LIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_MSG_LIST" ( msgType IN VARCHAR2,
systemId IN VARCHAR2,
isRead IN NUMBER, 
msgList OUT SYS_REFCURSOR ) AS 
--?????????б?
--??????????
--?????2019/12/12
BEGIN
                --CASE WHEN (sms.SMS_CONTENT IS NULL) THEN
					--wechat.TITLE
				--WHEN (sms.SMS_CONTENT IS NOT NULL) THEN
					--sms.SMS_CONTENT END msg_title,
 		IF (isRead=1) THEN
			OPEN msgList FOR SELECT
			 	biz.ID AS  id,
				wechat.TITLE AS msg_title,
				CASE WHEN (sms.SMS_CONTENT IS NULL) THEN
					wechat.JUMP_LINK_URL
				WHEN (sms.SMS_CONTENT IS NOT NULL) THEN
					NULL END jump_link_url,	
				biz.CREATED_TIME AS msg_push_time,
				'true' AS is_read
			FROM
				SYS_MSG_RECORD_BIZ biz
				LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
				LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
			WHERE
				biz.BIZ_MSG_CATEGORY = ''||msgType||''
				AND biz.SYSTEM_ID=''||systemId||''
				AND biz.ID IN (SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD );

		ELSE 
                --CASE WHEN (sms.SMS_CONTENT IS NULL) THEN
					--wechat.TITLE
				--WHEN (sms.SMS_CONTENT IS NOT NULL) THEN
					--sms.SMS_CONTENT END msg_title,
 			OPEN msgList FOR SELECT
			 	biz.ID AS  id,
				wechat.TITLE AS msg_title,
				CASE WHEN (sms.SMS_CONTENT IS NULL) THEN
					wechat.JUMP_LINK_URL
				WHEN (sms.SMS_CONTENT IS NOT NULL) THEN
					NULL END jump_link_url,	
				biz.CREATED_TIME AS msg_push_time,
				CASE WHEN (biz.ID IN (SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD )) THEN
				'true'
				WHEN (biz.ID NOT IN (SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD )) THEN
					'false' END is_read
			FROM
				SYS_MSG_RECORD_BIZ biz
				LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
				LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
			WHERE
				biz.BIZ_MSG_CATEGORY = ''||msgType||''
				AND biz.SYSTEM_ID=''||systemId||'';

		END IF;



END p_pom_msg_list;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MSG_LIST_ADJUSTMENT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_MSG_LIST_ADJUSTMENT" ( msgType IN VARCHAR2,
systemId IN VARCHAR2,
userId IN VARCHAR2,
isRead IN NUMBER, 
msgList OUT SYS_REFCURSOR ) AS 
 v_sys_code VARCHAR2 (50);
 v_sql CLOB;
 v_isIn varchar2 (100);
 v_get_code_sql VARCHAR2 (2000);
BEGIN
      v_get_code_sql := 'select user_code from sys_user where id=:sys_code';

      EXECUTE IMMEDIATE v_get_code_sql INTO v_sys_code  using userId;


 		IF (isRead=1) THEN
			v_isIn := ' and 1=1';
		ELSE 
            v_isIn := ' and biz.id not in (SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD )';
		END IF;

        IF msgType = '催办消息' THEN
            v_sql := '
            select biz.ID AS  id,
                nvl(wechat.TITLE,biz.biz_source_category) AS msg_title,
                PRECORD.MOBILE_URL AS jump_link_url,	
                biz.CREATED_TIME AS msg_push_time,
                to_char((biz.CREATED_TIME), ''yyyy-MM-dd hh24:mi:ss'') AS msg_push_time_str,
                CASE WHEN (biz.ID IN (SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD)) THEN
                    ''true''
                WHEN (biz.ID NOT IN (SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD)) THEN
                    ''false''
                end is_read
                from SYS_MSG_RECORD_BIZ biz  
                left join sys_msg_read_record rr on biz.id = rr.msg_record_biz_guid 
                left join SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
                left join SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
                LEFT JOIN SYS_MESSAGE_CENTER_PUSH_RECORD PRECORD ON BIZ.ID = PRECORD.TASK_ID
                where BIZ.BIZ_MSG_CATEGORY = '''||msgType||'''
                and biz.system_id ='''||systemId||'''
                and (sms.receiver_id = '''||v_sys_code||''' or wechat.receiver_id = '''||v_sys_code||''')'||v_isIn||' order by msg_push_time desc ';
        ELSE 
            v_sql := '
            select biz.ID AS  id,
            nvl(wechat.TITLE,biz.TASK_NAME) AS msg_title,
            PRECORD.MOBILE_URL AS jump_link_url,	
            biz.CREATED AS msg_push_time,
            to_char((biz.CREATED), ''yyyy-MM-dd hh24:mi:ss'') AS msg_push_time_str,
            CASE WHEN (biz.ID IN (SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD)) THEN
                ''true''
            WHEN (biz.ID NOT IN (SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD)) THEN
                ''false''
            end is_read
            from SYS_MESSAGE_CENTER biz  
            left join sys_msg_read_record rr on biz.id = rr.msg_record_biz_guid 
            left join SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
            left join SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
            LEFT JOIN SYS_MESSAGE_CENTER_PUSH_RECORD PRECORD ON BIZ.ID = PRECORD.TASK_ID
            where BIZ.BIZ_MSG_CATEGORY = '''||msgType||'''
            and biz.type_name =''计划运营''
            and BIZ.OWNER_NAME = '''||v_sys_code||''' and 1=1 order by msg_push_time desc  ';
        END IF;

        dbms_output.put_line(v_sql);
        OPEN msgList FOR v_sql;

END P_POM_MSG_LIST_ADJUSTMENT;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MSGTYPE_LIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_MSGTYPE_LIST" ( systemId IN VARCHAR2, msgTypeList OUT SYS_REFCURSOR, unreadCount OUT VARCHAR2 ) AS 
--移动端消息类型列表
--作者：叶丁荣
--日期：2019/12/12
	v_COUNT NUMBER;
BEGIN
		OPEN msgTypeList FOR SELECT
		'57b55283-ce3a-4fc4-a70d-8240e66a1254' AS id,
		'提醒消息' AS msg_type,
		(
		SELECT
			* 
		FROM
			(
			SELECT
				wechat.TITLE 
			FROM
				SYS_MSG_RECORD_BIZ biz
				LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
				LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
			WHERE
				biz.BIZ_MSG_CATEGORY = '提醒消息' 
			AND biz.SYSTEM_ID=''||systemId||''
			ORDER BY
				biz.CREATED_TIME DESC 
			) 
		WHERE
			ROWNUM = 1 
		) AS frist_msg,
		(
		SELECT
			COUNT( * ) 
		FROM
			SYS_MSG_RECORD_BIZ biz
			LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
			LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
		WHERE
			biz.BIZ_MSG_CATEGORY = '提醒消息' 
			AND biz.ID NOT IN ( SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD ) 
			AND biz.SYSTEM_ID=''||systemId||''
		) AS msg_type_unreadcount 
	FROM
		dual UNION ALL
	SELECT
		'58055283-ce3a-4fc4-a70d-8240e66a1254' AS id,
		'预警消息' AS msg_type,
		(
		SELECT
			* 
		FROM
			(
			SELECT
				wechat.TITLE 
			FROM
				SYS_MSG_RECORD_BIZ biz
				LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
				LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
			WHERE
				biz.BIZ_MSG_CATEGORY = '预警消息' 
				AND biz.SYSTEM_ID=''||systemId||''
			ORDER BY
				biz.CREATED_TIME DESC 
			) 
		WHERE
			ROWNUM = 1 
		) AS frist_msg,
		(
		SELECT
			COUNT( * ) 
		FROM
			SYS_MSG_RECORD_BIZ biz
			LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
			LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
		WHERE
			biz.BIZ_MSG_CATEGORY = '预警消息' 
			AND biz.ID NOT IN ( SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD ) 
			AND biz.SYSTEM_ID=''||systemId||''
		) AS msg_type_unreadcount 
	FROM
		dual UNION ALL
	SELECT
		'58055283-ce3a-4fc4-a70d-8240e66a1254' AS id,
		'催办消息' AS msg_type,
		(
		SELECT
			* 
		FROM
			(
			SELECT
				wechat.TITLE 
			FROM
				SYS_MSG_RECORD_BIZ biz
				LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
				LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
			WHERE
				biz.BIZ_MSG_CATEGORY = '催办消息' 
				AND biz.SYSTEM_ID=''||systemId||''
			ORDER BY
				biz.CREATED_TIME DESC 
			) 
		WHERE
			ROWNUM = 1 
		) AS frist_msg,
		(
		SELECT
			COUNT( * ) 
		FROM
			SYS_MSG_RECORD_BIZ biz
			LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
			LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
		WHERE
			biz.BIZ_MSG_CATEGORY = '催办消息' 
			AND biz.ID NOT IN ( SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD ) 
			AND biz.SYSTEM_ID=''||systemId||''
		) AS msg_type_unreadcount 
	FROM
		dual;


		SELECT
	(
	SELECT
		COUNT( * ) 
	FROM
		SYS_MSG_RECORD_BIZ biz
		LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
		LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
	WHERE
		( biz.BIZ_MSG_CATEGORY = '提醒消息' OR biz.BIZ_MSG_CATEGORY = '预警消息' OR biz.BIZ_MSG_CATEGORY = '催办消息' ) 
		AND biz.ID NOT IN ( SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD ) -- 			AND biz.SYSTEM_ID=''||systemId||''

	)  INTO v_COUNT 
FROM
	dual;



	unreadCount := v_COUNT;

END p_pom_msgType_list;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MY_DUTY_NODE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_MY_DUTY_NODE" 
(
	USERID               IN VARCHAR2 --当前用户ID
 ,STATISTICALBEGINDATA IN DATE -- 开始日期
 ,STATISTICALENDDATA   IN DATE --结束日期
 ,CURRENTDATE          IN DATE --当前日期
 ,CALENDARSCOPETYPE    IN NVARCHAR2 -- 查看范围（本月到期OR本周到期），传入的值为，currentWeek：本周到期、currentMonth：本月到期
 ,ISONLYLOOKME         IN VARCHAR2 --是否只看本人
 ,NODEINFO             OUT SYS_REFCURSOR --返回的任务信息
) AS
	--计划首页-我的任务节点
	--作者：陈丽
	--日期：2019/11/15
BEGIN
	--/pom/mission-center-feedback/my-responsible-task?id=xxx&nodeSourcePlanType=XXX&feedbackNodeOriginalId=XXX&feedbackNodeId=XXX
--	IF CALENDARSCOPETYPE = 'currentWeek' THEN
--		OPEN NODEINFO FOR
--			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
--						 B.NODE_LEVEL AS NODELEVEL,
--						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
--							CHR(38) || 'nodeSourcePlanType=' || CASE
--								WHEN A.PLAN_TYPE = '关键节点计划' THEN
--								 '0'
--								WHEN A.PLAN_TYPE = '项目主项计划' THEN
--								 '1'
--								WHEN A.PLAN_TYPE = '专项计划' THEN
--								 '2'
--							END || CHR(38) || 'feedbackNodeOriginalId=' ||
--							B.ORIGINAL_NODE_ID || CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
--						 B.PLAN_END_DATE AS PLANENDDATE
--			FROM   POM_PROJ_PLAN A
--			INNER  JOIN POM_PROJ_PLAN_NODE B
--			ON     A.ID = B.PROJ_PLAN_ID
--			LEFT   JOIN POM_NODE_CHARGE_PERSON C
--			ON     B.ID = C.NODE_ID
--			WHERE  C.CHARGE_PERSON_ID = ''|| USERID||''
--
--						  AND TRUNC(CURRENTDATE, 'WW') = TRUNC(B.PLAN_END_DATE, 'WW')
--			UNION ALL
--			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
--						 '' AS NODELEVEL,
--						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
--							CHR(38) || 'nodeSourcePlanType=2' || CHR(38) ||
--							'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID || CHR(38) ||
--							'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
--						 B.PLAN_END_DATE AS PLANENDDATE
--			FROM   POM_SPECIAL_PLAN A
--			INNER  JOIN POM_SPECIAL_PLAN_NODE B
--			ON     A.ID = B.PLAN_ID
--			LEFT   JOIN POM_NODE_CHARGE_PERSON C
--			ON     B.ID = C.NODE_ID
--			WHERE  C.CHARGE_PERSON_ID = ''|| USERID||''  AND
--						 TRUNC(CURRENTDATE, 'WW') = TRUNC(B.PLAN_END_DATE, 'WW')
--			UNION ALL
--			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
--						 B.NODE_TYPE AS NODELEVEL,
--						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
--							CHR(38) || 'nodeSourcePlanType=3' || CHR(38) ||
--							'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID || CHR(38) ||
--							'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
--						 B.PLAN_END_DATE AS PLANENDDATE
--			FROM   POM_DEPT_MONTHLY_PLAN A
--			INNER  JOIN POM_DEPT_MONTHLY_PLAN_NODE B
--			ON     A.ID = B.DEPT_MONTHLY_PLAN_ID
--			LEFT   JOIN POM_NODE_CHARGE_PERSON C
--			ON     B.ID = C.NODE_ID
--			WHERE  B.SOURCE_PLAN_ID IS NULL AND
--						 C.CHARGE_PERSON_ID = ''|| USERID||''  AND
--						 TRUNC(CURRENTDATE, 'WW') = TRUNC(B.PLAN_END_DATE, 'WW');
--
--	ELSIF CALENDARSCOPETYPE = 'currentMonth' THEN
--		OPEN NODEINFO FOR
--			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
--						 B.NODE_LEVEL AS NODELEVEL,
--						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
--							CHR(38) || 'nodeSourcePlanType=' || CASE
--								WHEN A.PLAN_TYPE = '关键节点计划' THEN
--								 '0'
--								WHEN A.PLAN_TYPE = '项目主项计划' THEN
--								 '1'
--								WHEN A.PLAN_TYPE = '专项计划' THEN
--								 '2'
--							END || CHR(38) || 'feedbackNodeOriginalId=' ||
--							B.ORIGINAL_NODE_ID || CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
--						 B.PLAN_END_DATE AS PLANENDDATE
--			FROM   POM_PROJ_PLAN A
--			INNER  JOIN POM_PROJ_PLAN_NODE B
--			ON     A.ID = B.PROJ_PLAN_ID
--			LEFT   JOIN POM_NODE_CHARGE_PERSON C
--			ON     B.ID = C.NODE_ID
--			WHERE  C.CHARGE_PERSON_ID = ''|| USERID||'' AND
--						 TRUNC(CURRENTDATE, 'mm') = TRUNC(B.PLAN_END_DATE, 'mm')
--			UNION ALL
--			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
--						 '' AS NODELEVEL,
--						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
--							CHR(38) || 'nodeSourcePlanType=2' || CHR(38) ||
--							'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID || CHR(38) ||
--							'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
--						 B.PLAN_END_DATE AS PLANENDDATE
--			FROM   POM_SPECIAL_PLAN A
--			INNER  JOIN POM_SPECIAL_PLAN_NODE B
--			ON     A.ID = B.PLAN_ID
--			LEFT   JOIN POM_NODE_CHARGE_PERSON C
--			ON     B.ID = C.NODE_ID
--			WHERE  C.CHARGE_PERSON_ID = ''|| USERID||''  AND
--						 TRUNC(CURRENTDATE, 'mm') = TRUNC(B.PLAN_END_DATE, 'mm')
--			UNION ALL
--			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
--						 B.NODE_TYPE AS NODELEVEL,
--						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
--							CHR(38) || 'nodeSourcePlanType=3' || CHR(38) ||
--							'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID || CHR(38) ||
--							'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
--						 B.PLAN_END_DATE AS PLANENDDATE
--			FROM   POM_DEPT_MONTHLY_PLAN A
--			INNER  JOIN POM_DEPT_MONTHLY_PLAN_NODE B
--			ON     A.ID = B.DEPT_MONTHLY_PLAN_ID
--			LEFT   JOIN POM_NODE_CHARGE_PERSON C
--			ON     B.ID = C.NODE_ID
--			WHERE  B.SOURCE_PLAN_ID IS NULL AND
--						 C.CHARGE_PERSON_ID = ''|| USERID||''  AND
--						 TRUNC(CURRENTDATE, 'mm') = TRUNC(B.PLAN_END_DATE, 'mm');

--	ELSE  --在没有勾选本周/本月时间范围的时候默认全部查询By Yedr//2020-01-07
		OPEN NODEINFO FOR
			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
						 B.NODE_LEVEL AS NODELEVEL,
						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
							CHR(38) || 'nodeSourcePlanType=' || CASE
								WHEN A.PLAN_TYPE = '关键节点计划' THEN
								 '0'
								WHEN A.PLAN_TYPE = '项目主项计划' THEN
								 '1'
								WHEN A.PLAN_TYPE = '专项计划' THEN
								 '2'
							END || CHR(38) || 'feedbackNodeOriginalId=' ||
							B.ORIGINAL_NODE_ID || CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
						 B.PLAN_END_DATE AS PLANENDDATE
			FROM   POM_PROJ_PLAN A
			INNER  JOIN POM_PROJ_PLAN_NODE B
			ON     A.ID = B.PROJ_PLAN_ID
			LEFT   JOIN POM_NODE_CHARGE_PERSON C
			ON     B.ID = C.NODE_ID
			WHERE  C.CHARGE_PERSON_ID = ''|| USERID||''
 						  AND CURRENTDATE = B.PLAN_END_DATE
			UNION ALL
			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
						 '' AS NODELEVEL,
						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
							CHR(38) || 'nodeSourcePlanType=2' || CHR(38) ||
							'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID || CHR(38) ||
							'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
						 B.PLAN_END_DATE AS PLANENDDATE
			FROM   POM_SPECIAL_PLAN A
			INNER  JOIN POM_SPECIAL_PLAN_NODE B
			ON     A.ID = B.PLAN_ID
			LEFT   JOIN POM_NODE_CHARGE_PERSON C
			ON     B.ID = C.NODE_ID
			WHERE  C.CHARGE_PERSON_ID = ''|| USERID||''
 						 AND CURRENTDATE = B.PLAN_END_DATE
			UNION ALL
			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
						 B.NODE_TYPE AS NODELEVEL,
						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
							CHR(38) || 'nodeSourcePlanType=3' || CHR(38) ||
							'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID || CHR(38) ||
							'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
						 B.PLAN_END_DATE AS PLANENDDATE
			FROM   POM_DEPT_MONTHLY_PLAN A
			INNER  JOIN POM_DEPT_MONTHLY_PLAN_NODE B
			ON     A.ID = B.DEPT_MONTHLY_PLAN_ID
			LEFT   JOIN POM_NODE_CHARGE_PERSON C
			ON     B.ID = C.NODE_ID
			WHERE  B.SOURCE_PLAN_ID IS NULL AND
						 C.CHARGE_PERSON_ID = ''|| USERID||''
 						  AND CURRENTDATE = B.PLAN_END_DATE;
--	END IF;

END P_POM_MY_DUTY_NODE;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MY_MESSAGE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_MY_MESSAGE" 
(
    USERID      IN VARCHAR2
   ,MESSAGETYPE IN VARCHAR2
   ,TOTAL       OUT INT
   , --消息总数
    MESSAGEINFO OUT SYS_REFCURSOR
) AS
    --计划首页-我的消息
    --作者：陈丽
    --日期：2019/11/15
BEGIN
    TOTAL := -1;
    OPEN MESSAGEINFO FOR
         SELECT  *  FROM (  SELECT
           plan.PLAN_NAME AS "messageContent",
           node.NODE_LEVEL AS "nodeLevel",
           msg.ACTUAL_CREATED AS "messageArrivalTime", 
           msg.pc_url AS "openUrl",
           CASE
            WHEN node.PLAN_END_DATE - SYSDATE < 0 THEN
                '超期'
            WHEN node.PLAN_END_DATE - SYSDATE > 0 THEN
                '正常'
           END AS  "nodeState",
           node.PLAN_END_DATE AS "planEndDate"
           FROM          
           POM_PROJ_PLAN_NODE node
           LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID 
           LEFT JOIN SYS_MESSAGE_CENTER msg ON msg.TASK_ID = node.ID
           LEFT JOIN SYS_USER u ON msg.owner_name=u.user_code where msg.TASK_ID = node.ID and  msg.TASK_STATE = 0 AND u.ID=''||USERID||''
           AND msg.biz_msg_category=''||MESSAGETYPE||'' ORDER BY "messageArrivalTime" DESC) WHERE ROWNUM <= 20 ;
END P_POM_MY_MESSAGE;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MY_NODE_CALENDAR
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_MY_NODE_CALENDAR" 
(
      USERID               IN VARCHAR2 --传入用户ID
	 ,STATISTICALBEGINDATA IN DATE --日历中每月开始日期
	 ,STATISTICALENDDATA   IN DATE --日历中每月结束日期
--	 ,CURRENTDATE          IN DATE --日历中当前选中日期
--	 ,CALENDARSCOPETYPE    IN VARCHAR2 --查看范围（本月到期OR本周到期），传入的值为，0：本周到期、1：本月到期
--	 ,ISONLYLOOKME         IN VARCHAR2 --是否只看自己
	 ,STATISTICALINFO      OUT SYS_REFCURSOR --返回值
) AS
		--计划首页-首页日历
		--作者：陈丽
    --日期：2019/11/15
BEGIN
    /*    OPEN STATISTICALINFO FOR
    SELECT PLAN_END_DATE AS "date", COUNT(PLAN_END_DATE) "total"
    FROM   POM_PROJ_PLAN_NODE
    GROUP  BY PLAN_END_DATE;*/
    OPEN STATISTICALINFO FOR
        SELECT to_char(PLAN_END_DATE,'yyyy-mm-dd') AS nodeDate, COUNT(NODE_NAME) AS total
        FROM   (SELECT A.PLAN_TYPE, B.NODE_NAME, B.PLAN_END_DATE
                 FROM   POM_PROJ_PLAN A
                 INNER  JOIN POM_PROJ_PLAN_NODE B
                 ON     A.ID = B.PROJ_PLAN_ID
                 INNER  JOIN POM_NODE_CHARGE_PERSON C
                 ON     B.ID = C.NODE_ID
                 WHERE  B.ACTUAL_END_DATE IS NULL AND
                        C.CHARGE_PERSON_ID = USERID AND
                        B.PLAN_END_DATE BETWEEN STATISTICALBEGINDATA AND
                        STATISTICALENDDATA
                 UNION ALL
                 SELECT '专项计划', B.NODE_NAME, B.PLAN_END_DATE
                 FROM   POM_SPECIAL_PLAN A
                 INNER  JOIN POM_SPECIAL_PLAN_NODE B
                 ON     A.ID = B.PLAN_ID
                 INNER  JOIN POM_NODE_CHARGE_PERSON C
                 ON     B.ID = C.NODE_ID
                 WHERE  B.ACTUAL_END_DATE IS NULL AND
                        C.CHARGE_PERSON_ID = USERID AND
                        B.PLAN_END_DATE BETWEEN STATISTICALBEGINDATA AND
                        STATISTICALENDDATA
                 UNION ALL
                 SELECT '部门月度计划', B.NODE_NAME, B.PLAN_END_DATE
                 FROM   POM_DEPT_MONTHLY_PLAN A
                 INNER  JOIN POM_DEPT_MONTHLY_PLAN_NODE B
                 ON     A.ID = B.DEPT_MONTHLY_PLAN_ID
                 INNER  JOIN POM_NODE_CHARGE_PERSON C
                 ON     B.ID = C.NODE_ID
                 WHERE  B.ACTUAL_END_DATE IS NULL AND
                        B.SOURCE_PLAN_ID IS NULL AND
                        C.CHARGE_PERSON_ID = USERID AND
                        B.PLAN_END_DATE BETWEEN STATISTICALBEGINDATA AND
                        STATISTICALENDDATA)
        GROUP  BY PLAN_END_DATE;

END P_POM_MY_NODE_CALENDAR;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MY_WACTH_NODE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_MY_WACTH_NODE" 
(
    USERID               IN NVARCHAR2 --当前用户ID
,STATISTICALBEGINDATA IN DATE --日历中选中日期对应本月开始日期
,STATISTICALENDDATA   IN DATE --日历中选中日期对应本月结束日期
,CURRENTDATE          IN DATE --日历中当前选择日期
,CALENDARSCOPETYPE    IN VARCHAR2 --查看范围，currentWeek：本周，currentMonth：本月
,ISONLYLOOKME         IN VARCHAR2 --是否只查看我的，0：否，1：是
,NODEINFO             OUT SYS_REFCURSOR --返回值
) AS
    --计划首页-关注的节点
    --作者：陈丽
    --日期：2019/11/15
    --调整存储过程为根据CALENDARSCOPETYPE（日期范围）判断查询数据。默认全部查询，前端勾选了日期范围在根据前端传递日期范围查询  By Yedr 2020-01-07
BEGIN
    /*OPEN NODEINFO FOR
SELECT POM_PROJ_PLAN.PLAN_NAME AS "planName",
       POM_PROJ_PLAN_NODE.NODE_NAME AS "nodeName",
       POM_PROJ_PLAN_NODE.NODE_LEVEL AS "nodeLevel", '' AS "openUrl",
       PLAN_END_DATE "planEndDate", '正常' "nodeState"
FROM   POM_PROJ_PLAN_NODE
LEFT   JOIN POM_PROJ_PLAN
ON     POM_PROJ_PLAN_NODE.PROJ_PLAN_ID = POM_PROJ_PLAN.ID;*/

--		IF ISONLYLOOKME = 1 THEN
--				RETURN;
--		ELSE
--			IF CALENDARSCOPETYPE='currentWeek' THEN
    OPEN NODEINFO FOR
        --关键节点计划、项目主项计划
        SELECT C.PLAN_NAME AS "planName", B.NODE_NAME AS "nodeName",
               B.NODE_LEVEL AS "nodeLevel",
               '/pom/mission-center-feedback/my-responsible-task/view-task-information?id=' || C.ID ||
               CHR(38) || 'nodeSourcePlanType='
                   || CASE
                          WHEN C.PLAN_TYPE = '关键节点计划' THEN '0'
                          WHEN C.PLAN_TYPE = '项目主项计划' THEN  '1'
                          WHEN C.PLAN_TYPE = '专项计划' THEN '2'
                          ELSE NULL END
                   || CHR(38) || 'feedbackNodeOriginalId=' ||
               B.ORIGINAL_NODE_ID || CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS "openUrl",
               B.PLAN_END_DATE AS "planEndDate",
               CASE
                   WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN '正常'
                   WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN '已超期'
                   ELSE NULL
                   END AS "nodeState"
        FROM   SYS_BIZ_WATCH A
                   INNER  JOIN POM_PROJ_PLAN_NODE B
                               ON     A.BIZ_ID = B.ORIGINAL_NODE_ID
                   INNER  JOIN POM_PROJ_PLAN C
                               ON     B.PROJ_PLAN_ID = C.ID
        WHERE  A.WATCHER_ID =''|| USERID||''
          AND c.APPROVAL_STATUS='已审核'
          AND CURRENTDATE = B.PLAN_END_DATE
          --AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')
        UNION ALL
        --专项计划
        SELECT C.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
               '' AS NODELEVEL,
               '/pom/mission-center-feedback/my-responsible-task/view-task-information?id=' || C.ID ||
               CHR(38) || 'nodeSourcePlanType=' || '2' || CHR(38) ||
               'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID ||
               CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
               B.PLAN_END_DATE AS PLANENDDATE,
               CASE
                   WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN '正常'
                   WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN '已超期'
                   ELSE NULL
                   END AS NODESTATE
        FROM SYS_BIZ_WATCH A
                 INNER JOIN POM_SPECIAL_PLAN_NODE B ON  A.BIZ_ID = B.ORIGINAL_NODE_ID
                 INNER JOIN POM_SPECIAL_PLAN C ON B.PLAN_ID = C.ID
        WHERE A.WATCHER_ID = ''|| USERID||''
          and c.APPROVAL_STATUS='已审核'
          AND CURRENTDATE = B.PLAN_END_DATE
          -- AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')
        UNION ALL
        --部门月度计划
        SELECT C.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
               B.NODE_TYPE AS NODELEVEL,
               '/pom/mission-center-feedback/my-responsible-task/view-task-information?id=' || C.ID ||
               CHR(38) || 'nodeSourcePlanType=' || '3' || CHR(38) ||
               'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID ||
               CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
               B.PLAN_END_DATE AS PLANENDDATE,
               CASE WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN '正常'
                    WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN '已超期'
                    ELSE NULL
                   END AS NODESTATE
        FROM SYS_BIZ_WATCH A
                 INNER JOIN POM_DEPT_MONTHLY_PLAN_NODE B ON A.BIZ_ID =  B.ORIGINAL_NODE_ID
                 INNER JOIN POM_DEPT_MONTHLY_PLAN C ON B.DEPT_MONTHLY_PLAN_ID = C.ID
        WHERE A.WATCHER_ID = ''|| USERID||'' AND CURRENTDATE = B.PLAN_END_DATE;
    -- 									 AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')   ;

--			ELSIF CALENDARSCOPETYPE='currentMonth' THEN
--				OPEN NODEINFO FOR
--				--关键节点计划、项目主项计划
--						SELECT C.PLAN_NAME AS "planName", B.NODE_NAME AS "nodeName",
--									 B.NODE_LEVEL AS "nodeLevel",
--									 '/pom/mission-center-feedback/my-responsible-task/view-task-information?planId=' || C.ID ||
--									 CHR(38) || 'nodeSourcePlanType=' || CASE
--											 WHEN C.PLAN_TYPE = '关键节点计划' THEN
--												'0'
--											 WHEN C.PLAN_TYPE = '项目主项计划' THEN
--												'1'
--											 WHEN C.PLAN_TYPE = '专项计划' THEN
--												'2'
--											 ELSE
--												NULL
--									 END || CHR(38) || 'feedbackNodeOriginalId=' ||
--									 B.ORIGINAL_NODE_ID || CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS "openUrl",
--									 B.PLAN_END_DATE AS "planEndDate",
--									 CASE
--											 WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN
--												'正常'
--											 WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN
--												'已超期'
--											 ELSE
--												NULL
--									 END AS "nodeState"
--						FROM   SYS_BIZ_WATCH A
--						INNER  JOIN POM_PROJ_PLAN_NODE B
--						ON     A.BIZ_ID = B.ORIGINAL_NODE_ID
--						INNER  JOIN POM_PROJ_PLAN C
--						ON     B.PROJ_PLAN_ID = C.ID
--						WHERE  A.WATCHER_ID =''|| USERID||''
--                   AND c.APPROVAL_STATUS='已审核'
--									 AND TRUNC(CURRENTDATE, 'mm') = TRUNC(B.PLAN_END_DATE, 'mm')
--									  --AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')
--         UNION ALL
--         --专项计划
--         SELECT C.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
--                '' AS NODELEVEL,
--                '/pom/mission-center-feedback/my-responsible-task/view-task-information?id=' || C.ID ||
--                CHR(38) || 'nodeSourcePlanType=' || '2' || CHR(38) ||
--                'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID ||
--                CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
--                B.PLAN_END_DATE AS PLANENDDATE,
--                CASE
--                    WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN '正常'
--                    WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN '已超期'
--                    ELSE NULL
--                END AS NODESTATE
--         FROM SYS_BIZ_WATCH A
--             INNER JOIN POM_SPECIAL_PLAN_NODE B ON A.BIZ_ID = B.ORIGINAL_NODE_ID
--             INNER JOIN POM_SPECIAL_PLAN C ON B.PLAN_ID = C.ID
--         WHERE A.WATCHER_ID = ''|| USERID||''
--           AND c.APPROVAL_STATUS='已审核'
--           AND TRUNC(CURRENTDATE, 'mm') = TRUNC(B.PLAN_END_DATE, 'mm')
    --AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')
--						UNION ALL
--						--部门月度计划
--						SELECT C.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
--									 B.NODE_TYPE AS NODELEVEL,
--									 '/pom/mission-center-feedback/my-responsible-task/view-task-information?planId=' || C.ID ||
--										CHR(38) || 'nodeSourcePlanType=' || '3' || CHR(38) ||
--										'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID ||
--										CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
--									 B.PLAN_END_DATE AS PLANENDDATE,
--									 CASE
--												WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN
--												 '正常'
--												WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN
--												 '已超期'
--												ELSE
--												 NULL
--										END AS NODESTATE
--						FROM   SYS_BIZ_WATCH A
--						INNER  JOIN POM_DEPT_MONTHLY_PLAN_NODE B
--						ON     A.BIZ_ID =  B.ORIGINAL_NODE_ID
--						INNER  JOIN POM_DEPT_MONTHLY_PLAN C
--						ON     B.DEPT_MONTHLY_PLAN_ID = C.ID
--						WHERE  A.WATCHER_ID = ''|| USERID||''
--									 AND TRUNC(CURRENTDATE, 'mm') = TRUNC(B.PLAN_END_DATE, 'mm');
--									-- AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')   ;
--			ELSE
--				OPEN NODEINFO FOR
--				--关键节点计划、项目主项计划
--						SELECT C.PLAN_NAME AS "planName", B.NODE_NAME AS "nodeName",
--									 B.NODE_LEVEL AS "nodeLevel",
--									 '/pom/mission-center-feedback/my-responsible-task/view-task-information?planId=' || C.ID ||
--									 CHR(38) || 'nodeSourcePlanType=' || CASE
--											 WHEN C.PLAN_TYPE = '关键节点计划' THEN
--												'0'
--											 WHEN C.PLAN_TYPE = '项目主项计划' THEN
--												'1'
--											 WHEN C.PLAN_TYPE = '专项计划' THEN
--												'2'
--											 ELSE
--												NULL
--									 END || CHR(38) || 'feedbackNodeOriginalId=' ||
--									 B.ORIGINAL_NODE_ID || CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS "openUrl",
--									 B.PLAN_END_DATE AS "planEndDate",
--									 CASE
--											 WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN
--												'正常'
--											 WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN
--												'已超期'
--											 ELSE
--												NULL
--									 END AS "nodeState"
--						FROM   SYS_BIZ_WATCH A
--						INNER  JOIN POM_PROJ_PLAN_NODE B
--						ON     A.BIZ_ID = B.ORIGINAL_NODE_ID
--						INNER  JOIN POM_PROJ_PLAN C
--						ON     B.PROJ_PLAN_ID = C.ID
--						WHERE  A.WATCHER_ID =''|| USERID||''
--									 --AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')
--                                    and c.APPROVAL_STATUS='已审核'
--						UNION ALL
--						--专项计划
--						SELECT C.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
--									 '' AS NODELEVEL,
--									 '/pom/mission-center-feedback/my-responsible-task/view-task-information?planId=' || C.ID ||
--										CHR(38) || 'nodeSourcePlanType=' || '2' || CHR(38) ||
--										'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID ||
--										CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
--									 B.PLAN_END_DATE AS PLANENDDATE,
--									 CASE
--												WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN
--												 '正常'
--												WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN
--												 '已超期'
--												ELSE
--												 NULL
--										END AS NODESTATE
--						FROM   SYS_BIZ_WATCH A
--						INNER  JOIN POM_SPECIAL_PLAN_NODE B
--						ON     A.BIZ_ID = B.ORIGINAL_NODE_ID
--						INNER  JOIN POM_SPECIAL_PLAN C
--						ON     B.PLAN_ID = C.ID
--						WHERE  A.WATCHER_ID = ''|| USERID||''
--									 --AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')
--                                     and c.APPROVAL_STATUS='已审核'
--						UNION ALL
--						--部门月度计划
--						SELECT C.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
--									 B.NODE_TYPE AS NODELEVEL,
--									 '/pom/mission-center-feedback/my-responsible-task/view-task-information?planId=' || C.ID ||
--										CHR(38) || 'nodeSourcePlanType=' || '3' || CHR(38) ||
--										'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID ||
--										CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
--									 B.PLAN_END_DATE AS PLANENDDATE,
--									 CASE
--												WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN
--												 '正常'
--												WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN
--												 '已超期'
--												ELSE
--												 NULL
--										END AS NODESTATE
--						FROM   SYS_BIZ_WATCH A
--						INNER  JOIN POM_DEPT_MONTHLY_PLAN_NODE B
--						ON     A.BIZ_ID =  B.ORIGINAL_NODE_ID
--						INNER  JOIN POM_DEPT_MONTHLY_PLAN C
--						ON     B.DEPT_MONTHLY_PLAN_ID = C.ID
--						WHERE  A.WATCHER_ID = ''|| USERID||'';
--									-- AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')   ;
--			END IF;

--		END IF;
    /*/pom/mission-center-feedback/my-responsible-task/view-task-information;

    所需参数:{

    planId: String, //计划id
    nodeSourcePlanType: String, //计划类型
    feedbackNodeOriginalId: String, //任务原始id
    feedbackNodeId: String //任务id

    }*/
END P_POM_MY_WACTH_NODE;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_NODE_EXAMINATION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_NODE_EXAMINATION" 
(
		ORIGINALNODEID  IN VARCHAR2
	 ,EXAMINATIONINFO OUT SYS_REFCURSOR
) AS
		--查看反馈，考核信息查看列表
		--作者：陈丽
		--日期：2019/11/15
BEGIN
		OPEN EXAMINATIONINFO FOR
				SELECT C.PROJ_NAME AS "projName",
							 --项目名称
							 A.NODE_NAME AS "nodeName",
							 --任务名称
							 A.NODE_LEVEL AS "nodeLevel",
							 --任务级别
							 A.DUTY_DEPT AS "dutyDepartment",
							 --主责部门
							 NULL AS "dutyPerson",
							 --主责人
							 A.PLAN_END_DATE AS "planEndDate",
								--计划完成日期
							 A.ACTUAL_END_DATE AS "actualEndDate",
								--实际完成日期
							 A.NEW_EXAMINATION_SCORE AS "examinationScore",
								--考核得分
							 A.PLAN_START_DATE AS "planStartDate",
								--计划开始日期
--							 A. AS "estimateEndDate",
--								--预计完成日期
							 A.STANDARD_SCORE AS "standardScore" ---，标准分值
				FROM   POM_NODE_EXAMINATION A INNER JOIN 
                V_POM_GET_NODE_EXAMINE B ON A.NODE_ID=B.ID LEFT JOIN 
                POM_PROJ_PLAN C ON C.ID=B.PROJ_PLAN_ID
				WHERE a.ORIGINAL_NODE_ID = ORIGINALNODEID;

END P_POM_NODE_EXAMINATION;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_NODE_EXAMINATION_CREATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_NODE_EXAMINATION_CREATE" 
AS
--考核数据生成 1、根据设置的范围，创建考核范围数据。2、已经如表的本次考核范围数据，只更新修改时间
--作者：陈丽
--日期：2019/11/13
BEGIN
null;
END p_pom_node_examination_create;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_NODE_FEEDBACK_RESULTS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_NODE_FEEDBACK_RESULTS" (
    unitid         IN             VARCHAR2,--所属公司
    projectid      IN             VARCHAR2,--所属项目
    filename       IN             VARCHAR2,--文件名称
    nodename       IN             VARCHAR2,--计划节点
    filecreator    IN             VARCHAR2,---上传人
    begindate      IN             VARCHAR2,--范围开始时间
    beginend       IN             VARCHAR2,----范围结束日期
    userid         IN             VARCHAR2,--用户id(用户当前）
    stationid      IN             VARCHAR2,--岗位id(用户当前）
    departmentid   IN             VARCHAR2,--部门id(用户当前）
    companyid      IN             VARCHAR2,--公司id(用户所在公司)
    bizcode        IN             VARCHAR2,-- 权限编码
    pageindex      IN             INT,--页码
    pagesizes      IN             INT,--每页条数
    total          OUT            INT,--总数
    items          OUT            SYS_REFCURSOR--项
)
	--任务成功查询//鲜晓勇负责实现
	--作者：陈丽
	--日期：2019/12/08

	--修改：徐正来
	--日期：2020/06/05
 AS
    v_sql        CLOB;
    v_sql_exec   CLOB;
    v_where      VARCHAR2(500) := ' and 1=1 ';
    testmsg             NVARCHAR2(4000);
    v_spid      NVARCHAR2(4000);
    v_auth_sql         VARCHAR2(4000) :=' ';
    v_pcount int;
    v_proj  VARCHAR2(4000) :=' ';
    v_file_name_searchcondition CLOB;
    v_node_name_searchcondition CLOB;
    v_creator_searchcondition CLOB;
    v_projectid CLOB;
BEGIN


    BEGIN
        total := 1000;

            --执行数据权限存储过程。拿到零时表id 用户连临时表鉴权
 --调用查询数据权限的存储过程,返回spid
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => stationid,
            DEPTID => departmentid,
            COMPANYID => companyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
         --V_AUTH_SQL:='left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||V_SPID||''') ta on ta.orgid=plan.company_id or ta.orgid=plan.proj_id  where ta.orgid is not null ';
       --展示去掉权限取数 chenl
--        V_AUTH_SQL:=' where 1=1';
        --如果查询不到项目就是分期，暂时这样紧急处理，升级

select count(proj_id) into v_pcount from POM_PROJ_PLAN where proj_id=projectid;
if v_pcount=0  then
select wm_concat(id) into v_proj from SYS_PROJECT_STAGE where PROJECT_ID=projectid;
else
v_proj:=projectid;
end if;


testmsg := 'unitid:'
               || unitid
               || ';pageindex:'
               || pageindex
               || ';pagesizes:'
               || pagesizes
               || ';projectid:'
               || projectid
               || ';begindate:'
               || begindate
               || ';beginend:'
               || beginend;
        -------------------------------------------条件

        IF ( begindate IS NOT NULL ) THEN
            v_where := v_where
                       || 'and  to_char(attachment.created,''yyyy-MM-dd'')>='''
                       || begindate
                       || '''';
        END IF;

        IF ( beginend IS NOT NULL ) THEN
            v_where := v_where
                       || ' and  to_char(attachment.created,''yyyy-MM-dd'')<='''
                       || beginend
                       || '''';
        END IF;

    IF  filename IS NOT NULL  THEN
        v_file_name_searchcondition:='AND file_origin_name like ''%'|| filename|| '%'' ';
    ELSE    
        v_file_name_searchcondition:='';
    END IF;
    IF nodename IS NOT NULL THEN
        v_node_name_searchcondition:='AND node_name like ''%'|| nodename || '%''';
    ELSE
        v_node_name_searchcondition:='';
    END IF;
    IF  filecreator IS NOT NULL THEN
        v_creator_searchcondition:='AND attachment.creator like ''%'|| filecreator|| '%''';
    ELSE
        v_creator_searchcondition:='';
    END IF;
    IF  projectid IS NOT NULL THEN
        v_projectid :=' AND instr('''||v_proj||''', plan.proj_id) > 0';
    ELSE
        v_projectid :='';
    END IF;
    --------------------------------------拼接完整的sql
    IF unitid IS NULL THEN
    dbms_output.put_line(unitid);
        v_sql := '
    SELECT
    rownum as rowno,
    feedback.id             as "bizId",
    node.node_name      AS "nodeName",
    attachment.id             AS "attachmentId",
    attachment.file_origin_name as "fileName",
    TO_CHAR(attachment.file_size/(1024*1024),''FM99990.99'')||''M'' as "fileSize",
    1 AS "isAllowDownload",--是否允许下载，1允许。0不允许
    to_char(attachment.created ,''yyyy-MM-dd'') as "created",
    attachment.creator        AS "fileCreator",
    plan.plan_name      AS "planName",
    plan.company_id     AS "companyId",
    plan.proj_id        as "projId",
    plan.plan_type      AS "planType"
FROM
    pom_node_feedback    feedback
    LEFT JOIN pom_proj_plan_node   node ON feedback.FEEDBACK_NODE_ORIGINAL_ID = node.original_node_id
    LEFT JOIN pom_proj_plan        plan ON node.proj_plan_id = plan.id
    LEFT JOIN sys_attachment       attachment ON attachment.biz_id = feedback.id
    LEFT JOIN SYS_PROJECT_STAGE    stage ON plan.proj_id=stage.id
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||V_SPID||''') ta 
    on (case when stage.id is not null then stage.PROJECT_ID else plan.proj_id end)=ta.orgId  where ta.orgid is not null
    AND attachment.file_origin_name is not null
    AND feedback.APPROVAL_STATUS = ''已审核'' 
    AND plan.approval_status = ''已审核'''
    || v_file_name_searchcondition 
    || v_node_name_searchcondition
    || v_creator_searchcondition
    || v_where
   ;
    ELSE 
        v_sql := '
    SELECT
    rownum as rowno,
    feedback.id             as "bizId",
    node.node_name      AS "nodeName",
    attachment.id             AS "attachmentId",
    attachment.file_origin_name as "fileName",
    TO_CHAR(attachment.file_size/(1024*1024),''FM99990.99'')||''M'' as "fileSize",
    1 AS "isAllowDownload",--是否允许下载，1允许。0不允许
    to_char(attachment.created ,''yyyy-MM-dd'') as "created",
    attachment.creator        AS "fileCreator",
    plan.plan_name      AS "planName",
    plan.company_id     AS "companyId",
    plan.proj_id        as "projId",
    plan.plan_type      AS "planType"
FROM
    pom_node_feedback    feedback
    LEFT JOIN pom_proj_plan_node   node ON feedback.FEEDBACK_NODE_ORIGINAL_ID = node.original_node_id
    LEFT JOIN pom_proj_plan        plan ON node.proj_plan_id = plan.id
    LEFT JOIN sys_attachment       attachment ON attachment.biz_id = feedback.id
    LEFT JOIN SYS_PROJECT_STAGE    stage ON plan.proj_id=stage.id
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||V_SPID||''') ta 
    on (case when stage.id is not null then stage.PROJECT_ID else plan.proj_id end)=ta.orgId  where ta.orgid is not null
    AND attachment.file_origin_name is not null
    AND feedback.APPROVAL_STATUS = ''已审核'' 
    AND plan.approval_status = ''已审核'''
    ||v_projectid||'
    AND (plan.company_id='''||unitid||''' OR plan.company_id in (SELECT
                               id
                           FROM
                               sys_business_unit where is_company=1
                           START WITH
                               parent_id = '''||unitid||'''
                           CONNECT BY
                               PRIOR id = parent_id))'
    || v_file_name_searchcondition 
    || v_node_name_searchcondition
    || v_creator_searchcondition
    || v_where ;
    END IF;

    ----------------------------------------分页

        v_sql_exec := '
select a.* from ( '
                      || v_sql
                      || ' AND rownum <= '
                      || pageindex * pagesizes
                      || ' ) a where a.rowno > '
                      || pagesizes * ( pageindex - 1 )
                      || '';

        dbms_output.put_line(v_sql_exec);
----获取总条数
        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
                          || v_sql
                          || ') a '
        INTO total;
-- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN items FOR v_sql_exec;
    EXCEPTION
        WHEN OTHERS THEN
            testmsg := sqlerrm || testmsg;
            OPEN items FOR SELECT
                               '失败咯'
                           FROM
                               dual;

            dbms_output.put_line(sqlerrm);
    END;

END p_pom_node_feedback_results;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_NODE_FEEDBACK_RESULTS_C
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_NODE_FEEDBACK_RESULTS_C" (
    unitid         IN             VARCHAR2,--所属公司
    projectid      IN             VARCHAR2,--所属项目
    filename       IN             VARCHAR2,--文件名称
    nodename       IN             VARCHAR2,--计划节点
    filecreator    IN             VARCHAR2,---上传人
    begindate      IN             VARCHAR2,--范围开始时间
    beginend       IN             VARCHAR2,----范围结束日期
    userid         IN             VARCHAR2,--用户id(用户当前）
    stationid      IN             VARCHAR2,--岗位id(用户当前）
    departmentid   IN             VARCHAR2,--部门id(用户当前）
    companyid      IN             VARCHAR2,--公司id(用户所在公司)
    bizcode        IN             VARCHAR2,-- 权限编码
    pageindex      IN             INT,--页码
    pagesizes      IN             INT,--每页条数
    total          OUT            INT,--总数
    items_test          OUT            SYS_REFCURSOR,--项
    items          OUT            SYS_REFCURSOR--项
) 
	--任务成功查询//鲜晓勇负责实现
	--作者：陈丽
	--日期：2019/12/08	
 AS
    v_sql        CLOB;
    v_sql_exec   CLOB;
    v_where      VARCHAR2(500) := ' and 1=1 ';
    testmsg             NVARCHAR2(4000);
    v_spid      NVARCHAR2(4000);
    v_auth_sql         VARCHAR2(4000) :=' ';
    v_pcount int;
    v_proj  VARCHAR2(4000) :=' ';
     v_unitid               VARCHAR2(4000) :=' ';--所属公司
BEGIN


    BEGIN
        total := 1000;

            --执行数据权限存储过程。拿到零时表id 用户连临时表鉴权
 --调用查询数据权限的存储过程,返回spid 
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => stationid,
            DEPTID => departmentid,
            COMPANYID => companyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
        V_AUTH_SQL:='left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||V_SPID||''') ta on ta.orgid=pp.company_id or ta.orgid=p.id  where ta.orgid is not null ';        
       --展示去掉权限取数 chenl 
        --V_AUTH_SQL:=' where 1=1';
        --如果查询不到项目就是分期，暂时这样紧急处理，升级
                dbms_output.put_line(11111);
  OPEN items_test FOR select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = V_SPID;
 ---查找项目的分期
       if projectid is null then
            v_proj:=''' or ''1''=''1';
        else
          select id into v_proj from SYS_PROJECT_STAGE where PROJECT_ID=projectid;
        end if;

  ---查找项目的分期
       if unitid is null then
            v_unitid:=''' or ''1''=''1';
        else
          v_unitid:=unitid;
        end if;


testmsg := 'unitid:'
               || unitid
               || '；pageindex:'
               || pageindex
               || '；pagesizes:'
               || pagesizes
               || '；projectid:'
               || projectid
               || '；begindate:'
               || begindate
               || '；beginend:'
               || beginend;
        -------------------------------------------条件

        IF ( begindate <> NULL ) THEN
            v_where := v_where
                       || 'and  to_char(sa.created,''yyyy-MM-dd'')>='
                       || begindate
                       || '';
        END IF;

        IF ( beginend <> NULL ) THEN
            v_where := v_where
                       || ' and  to_char(sa.created,''yyyy-MM-dd'')<='
                       || beginend
                       || '';
        END IF;

    --------------------------------------拼接完整的sql

        v_sql := '
    SELECT
    rownum as rowno,
    pf.id             as "bizId",
    pn.node_name      AS "nodeName",
    sa.id             AS "attachmentId",
    sa.file_origin_name as "fileName",
    TO_CHAR(sa.file_size/(1024*1024),''FM99990.99'')||''M'' as "fileSize",
    1 AS "isAllowDownload",--是否允许下载，1允许。0不允许
    to_char(sa.created ,''yyyy-MM-dd'') as "created",
    sa.creator        AS "fileCreator",
    pp.plan_name      AS "planName",
    pp.company_id     AS "companyId",
    pp.proj_id        as "projId",
    pp.plan_type      AS "planType",
p.PROJECT_NAME,
ta.orgid
FROM
    pom_node_feedback    pf
    LEFT JOIN pom_proj_plan_node   pn ON pf.FEEDBACK_NODE_ORIGINAL_ID = pn.original_node_id
    LEFT JOIN pom_proj_plan        pp ON pn.proj_plan_id = pp.id
    LEFT JOIN sys_attachment       sa ON sa.biz_id = pf.id 
      left join SYS_PROJECT_STAGE ps on ps.id=pp.proj_id
      left join sys_project p on ps.PROJECT_ID=p.id

    '||v_auth_sql||'
    AND
    pn.actual_end_date IS NOT NULL 
    AND sa.file_origin_name is not null 
    AND pp.approval_status = ''已审核''
    AND (pp.proj_id='''||v_proj||''')
    and (pp.company_id='''||v_unitid||''')
    and (file_origin_name like ''%'
                 || filename
                 || '%'' and node_name like ''%'
                 || nodename
                 || '%'' and sa.creator like ''%'
                 || filecreator
                 || '%'')'
                 || v_where;


    ----------------------------------------分页

        v_sql_exec := '
select a.* from ( '
                      || v_sql
                      || ' AND rownum <= '
                      || pageindex * pagesizes
                      || ' ) a where a.rowno >= '
                      || pagesizes * ( pageindex - 1 )
                      || '';

        dbms_output.put_line(v_sql_exec);
----获取总条数
        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
                          || v_sql
                          || ') a '
        INTO total;

-- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN items FOR v_sql_exec;
    EXCEPTION
        WHEN OTHERS THEN
            testmsg := sqlerrm || testmsg;
            OPEN items FOR SELECT
                               testmsg
                           FROM
                               dual;

            dbms_output.put_line(sqlerrm);
    END;

END p_pom_node_feedback_results_c;
--=================================本公司负责的任务Start=========================

--=================================本公司负责的任务Start=========================

/
--------------------------------------------------------
--  DDL for Procedure P_POM_NODE_MESSAGE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_NODE_MESSAGE" 
(
  originalNodeId IN VARCHAR2,
  messageInfo OUT sys_refcursor
) AS 
--查看反馈，任务相关消息列表查询
--作者：陈丽
--日期：2019/11/15
BEGIN
 open messageInfo for
  select * from(    
  SELECT 
  biz.BIZ_SOURCE_CATEGORY  AS    "title"--消息标题
  ,node.NODE_NAME ||'-'|| node.NODE_LEVEL  AS  "nodeInfo"--任务信息
  ,nvl(UR.USER_NAME,URS.USER_NAME) AS "recipient"
  ,cast(nvl(MSG.SEND_DATE,msgs.SEND_DATE) as timestamp)   AS   "executionTime"
  --,to_timestamp(nvl(MSG.SEND_DATE,msgs.SEND_DATE),'yyyy-mm-dd hh24:mi:ss') AS   "executionTime"
  ,nvl(BIZ_MSG_CATEGORY,BIZ_SOURCE_CATEGORY)   AS  "msgType"
      FROM
      POM_PROJ_PLAN_NODE node  
      LEFT JOIN SYS_MSG_RECORD_BIZ biz ON node.ID = biz.BIZ_KEY
      LEFT JOIN SYS_MSG_RECORD_WECHAT msg ON biz.id = msg.MSG_RECORD_BIZ_ID 
      left join SYS_MSG_RECORD_SMS msgs on biz.id = msgs.MSG_RECORD_BIZ_ID 
      LEFT JOIN  SYS_USER UR ON UR.user_code=MSG.RECEIVER_ID
      LEFT JOIN  SYS_USER URS ON URS.user_code=msgs.RECEIVER_ID
    WHERE
      node.id = biz.biz_key  and  node.id=''||originalNodeId||''
      AND biz.ID NOT IN ( SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD ) ) a order by "executionTime" desc;
    
--  SELECT 
--  MSG.TITLE  AS    "title"--消息标题
--  ,node.NODE_NAME ||'-'|| node.NODE_LEVEL  AS  "nodeInfo"--任务信息
--  ,UR.USER_NAME AS "recipient"
--  ,MSG.SEND_DATE  AS   "executionTime"
--  ,MSG.ACTUAL_EXECUTE_TYPE   AS  "msgType"
--      FROM
--      POM_PROJ_PLAN_NODE node  
--      LEFT JOIN SYS_MSG_RECORD_BIZ biz ON node.ID = biz.BIZ_KEY
--      LEFT JOIN SYS_MSG_RECORD_WECHAT msg ON biz.id = msg.MSG_RECORD_BIZ_ID 
--      LEFT JOIN  SYS_USER UR ON UR.ID=MSG.RECEIVER_ID
--    WHERE
--      node.id = biz.biz_key  and  node.id=''||originalNodeId||''
--      AND biz.ID NOT IN ( SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD ) ;
      
        
END p_pom_node_message;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_NODE_MESSAGE_ADJUSTMENT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_NODE_MESSAGE_ADJUSTMENT" 
(
  originalNodeId IN VARCHAR2,
  messageInfo OUT sys_refcursor
) AS 
--查看反馈，任务相关消息列表查询
--作者：谢松宏
--日期：2020/03/13
BEGIN
 open messageInfo for
Select * from (
select 
	nvl(MSG.TITLE, biz.BIZ_SOURCE_CATEGORY)  AS    "title"--消息标题
	,node.NODE_NAME ||'-'|| node.NODE_LEVEL  AS  "nodeInfo"--任务信息
	,nvl(UR.USER_NAME,URS.USER_NAME) AS "recipient"
	,nvl(MSG.SEND_DATE, sms.SEND_DATE)  AS   "executionTime"
    ,to_char(nvl(MSG.SEND_DATE, sms.SEND_DATE), 'yyyy-MM-dd hh24:mi:ss') AS "executionTimeString" --添加一个返回字段用于将操作时间转换为字符串格式。
	,nvl(msg.WECHAT_MSG_TYPE, BIZ.BIZ_MSG_CATEGORY) AS  "msgType"
 from 
(select * from POM_PROJ_PLAN_NODE where  proj_plan_id = (select id from (select * from POM_PROJ_PLAN plan where plan.id in (select proj_plan_id from POM_PROJ_PLAN_NODE where original_node_id=''||originalNodeId||'') and approval_status='已审核'))) node 
LEFT JOIN SYS_MSG_RECORD_BIZ biz ON node.ID = biz.BIZ_KEY
LEFT JOIN SYS_MSG_RECORD_WECHAT msg ON biz.id = msg.MSG_RECORD_BIZ_ID 
LEFT JOIN SYS_MSG_RECORD_SMS sms on biz.id = sms.MSG_RECORD_BIZ_ID
LEFT JOIN  SYS_USER UR ON UR.ID=msg.RECEIVER_ID
LEFT JOIN  SYS_USER URS ON URS.user_code=sms.RECEIVER_ID
where 
node.id = biz.biz_key  and
original_node_id = ''||originalNodeId||''
AND biz.ID NOT IN ( SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD )) order by "executionTime" desc;

END p_pom_node_message_adjustment;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_NODE_MONTH_PHOTOGRAPH
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_NODE_MONTH_PHOTOGRAPH" (
    year in NUMBER,
    currentmonth IN NUMBER
)

--作者：yder
--日期：2020-06-10
--描述：记录节点考核 “月度”数据
 AS
    v_currentmonth VARCHAR2(200);
    v_month VARCHAR2(200);
    v_monthbegin     DATE;
    v_monthend       DATE;
    v_quarterbegin   DATE;
    v_quarterend     DATE;
    v_yearbegin      DATE;
    v_yearend        DATE;
BEGIN

    IF currentmonth < 10 THEN
        v_month := TO_CHAR(0 || currentmonth);
    ELSE
        v_month := TO_CHAR(currentmonth);
    END IF;
    IF currentmonth IS NULL AND year is NULL  THEN
        v_currentmonth := TO_CHAR(SYSDATE, 'yyyy-MM-dd');
    ELSIF  currentmonth IS NOT NULL AND year is NULL THEN
        v_currentmonth :=  TO_CHAR(SYSDATE, 'yyyy')||'-'||v_month||'-01';
    ELSIF  currentmonth IS NOT NULL AND year is NOT NULL THEN
         v_currentmonth :=  year||'-'||v_month||'-01';
    END IF;

    P_POM_MONTH_QUARTER_YEAR(
        now_date =>to_date(v_currentmonth,'yyyy-MM-dd'),
        o_m_begin => v_monthbegin,
        o_m_end => v_monthend,
        o_quarter_begin => v_quarterbegin,
        o_quarter_end => v_quarterend,
        o_year_begin => v_yearbegin,
        o_year_end => v_yearend
    );
    dbms_output.put_line(v_currentmonth);
-- 为保证拍照数据不重复，先删除记录类型为'0'并且计划完成月份和实际完成月份等于条件月份的数据
    DELETE POM_NODE_PHOTOGRAPH WHERE (plan_end_date < v_monthend AND  plan_end_date > v_monthbegin) AND record_type=0;
    COMMIT;
--批量插入月度拍照数据
    INSERT INTO POM_NODE_PHOTOGRAPH (
        id,
        node_id,
        node_name,
        node_level,
        standard_score,
        examination_score,
        scoring_percentage,
        completion_status,
        plan_start_date,
        plan_end_date,
        actual_start_date,
        actual_end_date,
        alert_status,
        plan_name,
        plan_id,
        plan_type,
        company_id,
        company_name,
        area_company_id,
        area_company_name,
        duty_dept_id,
        duty_dept,
        affiliation_month,
        affiliation_quarter,
        record_type,
        examination_date,
        complete_feedback_id,
        complete_feedback_approve_time,
        PROJECT_NAME,
        AFFILIATION_YEAR,
        PROJECT_ID,
        ORIGINAL_NODE_ID
    )
        SELECT
            get_uuid(),
            node.id,
            node.node_name,
            node.node_level,
            node.standard_score,
            CASE
                WHEN node.actual_end_date IS NULL OR exam.new_examination_score IS NULL THEN
                    0
                WHEN node.actual_end_date IS NOT NULL AND exam.complete_feedback_approve_time is NOT NULL THEN
                    CASE WHEN( TO_NUMBER(TO_CHAR(node.plan_end_date,'MM')) >= TO_NUMBER(TO_CHAR(exam.complete_feedback_approve_time,'MM'))) THEN
                        case WHEN (select plan_end_date from pom_proj_plan_node where proj_plan_id=plan.id  AND standard_node_id in (select FN_BIZPARAM_CONFIG('POM_EXAMINATION')  from dual)AND ROWNUM=1) is not null THEN
                            case WHEN to_char((select plan_end_date from pom_proj_plan_node where proj_plan_id=plan.id  AND standard_node_id in (select FN_BIZPARAM_CONFIG('POM_EXAMINATION')  from dual)AND ROWNUM=1),'MM') <> to_char(node.plan_end_date,'MM') THEN
                                    exam.examination_score
                                 WHEN to_char((select plan_end_date from pom_proj_plan_node where proj_plan_id=plan.id  AND standard_node_id in (select FN_BIZPARAM_CONFIG('POM_EXAMINATION')  from dual)AND ROWNUM=1),'MM') = to_char(node.plan_end_date,'MM') THEN
                                    exam.new_examination_score
                            END
                            WHEN (select plan_end_date from pom_proj_plan_node where proj_plan_id=plan.id  AND standard_node_id in (select FN_BIZPARAM_CONFIG('POM_EXAMINATION')  from dual)AND ROWNUM=1) is  null
                                AND node.actual_end_date IS NOT NULL AND exam.complete_feedback_approve_time is NOT NULL
                            THEN
                                exam.examination_score
                        END

                    WHEN TO_NUMBER(TO_CHAR(node.plan_end_date,'MM')) < TO_NUMBER(TO_CHAR(exam.complete_feedback_approve_time,'MM')) THEN
                        0
                    END
            END,
            CASE
                WHEN node.actual_end_date IS NULL OR exam.new_examination_score IS NULL THEN
                    0
                WHEN node.actual_end_date IS NOT NULL AND exam.complete_feedback_approve_time is NOT NULL THEN
                    CASE WHEN TO_NUMBER(TO_CHAR(node.plan_end_date,'MM')) >= TO_NUMBER(TO_CHAR(exam.complete_feedback_approve_time,'MM')) THEN
                          case WHEN (select plan_end_date from pom_proj_plan_node where proj_plan_id=plan.id  AND standard_node_id in (select FN_BIZPARAM_CONFIG('POM_EXAMINATION')  from dual)AND ROWNUM=1) is not null THEN
                            case WHEN to_char((select plan_end_date from pom_proj_plan_node where proj_plan_id=plan.id AND standard_node_id in (select FN_BIZPARAM_CONFIG('POM_EXAMINATION')  from dual)AND ROWNUM=1),'MM') <> to_char(node.plan_end_date,'MM') THEN
                                    ROUND(exam.examination_score / exam.standard_score,2)*100
                                 WHEN to_char((select plan_end_date from pom_proj_plan_node where proj_plan_id=plan.id  AND standard_node_id in (select FN_BIZPARAM_CONFIG('POM_EXAMINATION')  from dual)AND ROWNUM=1),'MM') = to_char(node.plan_end_date,'MM') THEN
                                    ROUND(exam.new_examination_score / exam.standard_score,2)*100
                            END
                         WHEN (select plan_end_date from pom_proj_plan_node where proj_plan_id=plan.id  AND standard_node_id in (select FN_BIZPARAM_CONFIG('POM_EXAMINATION')  from dual)AND ROWNUM=1) is  null
                                AND node.actual_end_date IS NOT NULL AND exam.complete_feedback_approve_time is NOT NULL
                            THEN
                                ROUND(exam.examination_score / exam.standard_score,2)*100
                        END
                    WHEN TO_NUMBER(TO_CHAR(node.plan_end_date,'MM')) < TO_NUMBER(TO_CHAR(exam.complete_feedback_approve_time,'MM')) THEN
                        0
                    END

            END,
            CASE
                WHEN node.actual_end_date IS NULL THEN
                    '未完成'
                WHEN node.actual_end_date IS NOT NULL THEN
                    '已完成'
            END,
            node.plan_start_date,
            node.plan_end_date,
            node.actual_start_date,
            node.actual_end_date,
            CASE
 --未到期不亮灯
                WHEN node.actual_end_date IS NULL
                     AND trunc(SYSDATE) - trunc(node.plan_end_date) <= 0 THEN
                    ''
 --到期当天内完成反馈
                WHEN node.actual_end_date IS NOT NULL
                     AND ( trunc(node.actual_end_date) - trunc(node.plan_end_date) ) <= 0 THEN
                    '<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>'
  --到期1-5天内完成反馈
                WHEN node.actual_end_date IS NOT NULL
                     AND ( trunc(node.actual_end_date) - trunc(node.plan_end_date) ) BETWEEN 1 AND 5 THEN
                    '<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>'
 --到期未反馈黄灯
                WHEN node.actual_end_date IS NULL
                     AND ( trunc(SYSDATE) - trunc(node.plan_end_date) ) BETWEEN 1 AND 5 THEN
                    '<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>'
  --到期超过5天未反馈红灯
                WHEN node.actual_end_date IS NULL
                     AND ( ( trunc(SYSDATE) - trunc(node.plan_end_date) ) > 5 ) THEN
                    '<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'
                ELSE
                    '<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'
            END,
            plan.plan_name,
            plan.id,
            plan.plan_type,
            plan.company_id,
            plan.company_name,
--            case when biz.level_rank=1 then
--            plan.company_id
--            when biz.level_rank <>1 then
--             biz.id end,
--            case when biz.level_rank=1 then
--            plan.company_name
--            when biz.level_rank <>1  then
--            biz.org_name end,
 (select id from sys_business_unit unit where unit.level_rank =2 start with plan.company_id = unit.id connect by prior unit.parent_id = unit.id),
            (select unit.org_name from sys_business_unit unit where unit.level_rank =2 start with plan.company_id = unit.id connect by prior unit.parent_id = unit.id) ,
            node.duty_department_id,
            node.duty_department,
            case when currentmonth is not null then
            currentmonth
            when currentmonth is null then
            to_number(TO_CHAR(sysdate,'MM')) end,
            NULL,
            0,
            CASE
                WHEN node.actual_end_date IS NULL THEN
                    NULL
                WHEN node.actual_end_date IS NOT NULL THEN
                    exam.complete_feedback_approve_time
            END,
            CASE
                WHEN node.actual_end_date IS NULL THEN
                    NULL
                WHEN node.actual_end_date IS NOT NULL THEN
                    exam.id
            END AS complete_feedback_id,
            CASE
                WHEN node.actual_end_date IS NULL THEN
                    NULL
                WHEN node.actual_end_date IS NOT NULL THEN
                    exam.complete_feedback_approve_time
            END,
            plan.proj_name,
            to_number(TO_CHAR(node.plan_end_date, 'yyyy')),
            plan.proj_id,
            node.ORIGINAL_NODE_ID
        FROM
            pom_proj_plan  plan
            INNER JOIN V_POM_GET_NODE_EXAMINE     node ON plan.id = node.proj_plan_id
            LEFT JOIN sys_business_unit      business ON plan.company_id = business.id
            LEFT JOIN sys_business_unit      biz ON business.parent_id = biz.id
            LEFT JOIN pom_node_feedback      feedback ON feedback.feedback_node_id = node.id AND feedback.feedback_type='CARRY_OUT'
            LEFT JOIN pom_node_examination   exam ON exam.node_id = node.id
        WHERE
            plan.approval_status = '已审核'
            AND node.is_disable = 0
            AND ( plan.plan_type = '项目主项计划'
                  OR plan.plan_type = '关键节点计划' )
            AND (node.plan_end_date < v_monthend AND  node.plan_end_date > v_monthbegin);
 COMMIT;
END p_pom_node_month_photograph;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_NODE_QUART_PHOTOGRAPH
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_NODE_QUART_PHOTOGRAPH" (
    year   IN  NUMBER,
    currentquarter IN NUMBER
)

--作者：yder
--日期：2020-06-10
--描述：记录节点考核 “季度”数据
 AS
    v_currentquarter NUMBER;
    v_currentdate   VARCHAR2(20);
    v_monthbegin     DATE;
    v_monthend       DATE;
    v_quarterbegin   DATE;
    v_quarterend     DATE;
    v_yearbegin      DATE;
    v_yearend        DATE;
BEGIN
    IF currentquarter IS NULL THEN
        v_currentquarter := to_number(TO_CHAR(SYSDATE, 'q'));
    ELSE
        v_currentquarter := currentquarter;
    END IF;

    IF year is not null then
        IF currentquarter=1 THEN
            v_currentdate:=year||'-02-01';
        ELSIF currentquarter=2 THEN
            v_currentdate:= year||'-05-01';
        ELSIF currentquarter=3 THEN
            v_currentdate:= year||'-08-01';
        ELSIF currentquarter=4 THEN
            v_currentdate:= year||'-11-01';
        END IF;
    else
        v_currentdate:=to_char(sysdate,'yyyy-MM-dd');
    END IF;
    dbms_output.put_line(v_currentdate);
    P_POM_MONTH_QUARTER_YEAR(
        now_date =>to_date(v_currentdate,'yyyy-MM-dd'),
        o_m_begin => v_monthbegin,
        o_m_end => v_monthend,
        o_quarter_begin => v_quarterbegin,
        o_quarter_end => v_quarterend,
        o_year_begin => v_yearbegin,
        o_year_end => v_yearend
    );

-- 为保证拍照数据不重复，先删除记录类型为'1'并且计划完成日期或者实际完成日期为该季度的节点
    DELETE POM_NODE_PHOTOGRAPH WHERE  (plan_end_date < v_quarterend AND  plan_end_date > v_quarterbegin) AND record_type=1;
    COMMIT;
--批量插入月度拍照数据
    INSERT INTO POM_NODE_PHOTOGRAPH (
        id,
        node_id,
        node_name,
        node_level,
        standard_score,
        examination_score,
        scoring_percentage,
        completion_status,
        plan_start_date,
        plan_end_date,
        actual_start_date,
        actual_end_date,
        alert_status,
        plan_name,
        plan_id,
        plan_type,
        company_id,
        company_name,
        area_company_id,
        area_company_name,
        duty_dept_id,
        duty_dept,
        affiliation_month,
        affiliation_quarter,
        record_type,
        examination_date,
        complete_feedback_id,
        complete_feedback_approve_time,
        PROJECT_NAME,
        AFFILIATION_YEAR,
        PROJECT_ID,
        ORIGINAL_NODE_ID
    )
        SELECT
        distinct
            get_uuid(),
            node.id,
            node.node_name,
            node.node_level,
            node.standard_score,
             CASE
                WHEN node.actual_end_date IS NULL OR exam.new_examination_score IS NULL THEN
                    0
                WHEN node.actual_end_date IS NOT NULL AND exam.complete_feedback_approve_time is NOT NULL THEN
                    CASE WHEN( TO_NUMBER(TO_CHAR(node.plan_end_date,'Q')) >= TO_NUMBER(TO_CHAR(exam.complete_feedback_approve_time,'Q'))) THEN
                        case WHEN (select plan_end_date from pom_proj_plan_node where proj_plan_id=plan.id  AND standard_node_id in (select FN_BIZPARAM_CONFIG('POM_EXAMINATION')  from dual)AND ROWNUM=1) is not null THEN
                            case WHEN to_char((select plan_end_date from pom_proj_plan_node where proj_plan_id=plan.id  AND standard_node_id in (select FN_BIZPARAM_CONFIG('POM_EXAMINATION')  from dual)AND ROWNUM=1),'Q') <> to_char(node.plan_end_date,'Q') THEN
                                    exam.examination_score
                                 WHEN to_char((select plan_end_date from pom_proj_plan_node where proj_plan_id=plan.id  AND standard_node_id in (select FN_BIZPARAM_CONFIG('POM_EXAMINATION')  from dual)AND ROWNUM=1),'Q') = to_char(node.plan_end_date,'Q') THEN
                                    exam.new_examination_score
                            END
                            WHEN (select plan_end_date from pom_proj_plan_node where proj_plan_id=plan.id  AND standard_node_id in (select FN_BIZPARAM_CONFIG('POM_EXAMINATION')  from dual)AND ROWNUM=1) is  null
                                AND node.actual_end_date IS NOT NULL AND exam.complete_feedback_approve_time is NOT NULL
                            THEN
                                exam.examination_score
                        END

                    WHEN TO_NUMBER(TO_CHAR(node.plan_end_date,'Q')) < TO_NUMBER(TO_CHAR(exam.complete_feedback_approve_time,'Q')) THEN
                        0
                    END
            END,
            CASE
                WHEN node.actual_end_date IS NULL OR exam.new_examination_score IS NULL THEN
                    0
                WHEN node.actual_end_date IS NOT NULL AND exam.complete_feedback_approve_time is NOT NULL THEN
                    CASE WHEN TO_NUMBER(TO_CHAR(node.plan_end_date,'Q')) >= TO_NUMBER(TO_CHAR(exam.complete_feedback_approve_time,'Q')) THEN
                          case WHEN (select plan_end_date from pom_proj_plan_node where proj_plan_id=plan.id  AND standard_node_id in (select FN_BIZPARAM_CONFIG('POM_EXAMINATION')  from dual)AND ROWNUM=1) is not null THEN
                            case WHEN to_char((select plan_end_date from pom_proj_plan_node where proj_plan_id=plan.id AND standard_node_id in (select FN_BIZPARAM_CONFIG('POM_EXAMINATION')  from dual)AND ROWNUM=1),'Q') <> to_char(node.plan_end_date,'Q') THEN
                                    ROUND(exam.examination_score / exam.standard_score,2)*100
                                 WHEN to_char((select plan_end_date from pom_proj_plan_node where proj_plan_id=plan.id  AND standard_node_id in (select FN_BIZPARAM_CONFIG('POM_EXAMINATION')  from dual)AND ROWNUM=1),'Q') = to_char(node.plan_end_date,'Q') THEN
                                    ROUND(exam.new_examination_score / exam.standard_score,2)*100
                            END
                         WHEN (select plan_end_date from pom_proj_plan_node where proj_plan_id=plan.id  AND standard_node_id in (select FN_BIZPARAM_CONFIG('POM_EXAMINATION')  from dual)AND ROWNUM=1) is  null
                                AND node.actual_end_date IS NOT NULL AND exam.complete_feedback_approve_time is NOT NULL
                            THEN
                                ROUND(exam.examination_score / exam.standard_score,2)*100
                        END
                    WHEN TO_NUMBER(TO_CHAR(node.plan_end_date,'Q')) < TO_NUMBER(TO_CHAR(exam.complete_feedback_approve_time,'Q')) THEN
                        0
                    END

            END,
            CASE
                WHEN node.actual_end_date IS NULL THEN
                    '未完成'
                WHEN node.actual_end_date IS NOT NULL THEN
                    '已完成'
            END,
            node.plan_start_date,
            node.plan_end_date,
            node.actual_start_date,
            node.actual_end_date,
            CASE
 --未到期不亮灯
                WHEN node.actual_end_date IS NULL
                     AND trunc(SYSDATE) - trunc(node.plan_end_date) <= 0 THEN
                    ''
 --到期当天内完成反馈
                WHEN node.actual_end_date IS NOT NULL
                     AND ( trunc(node.actual_end_date) - trunc(node.plan_end_date) ) <= 0 THEN
                    '<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>'
  --到期1-5天内完成反馈
                WHEN node.actual_end_date IS NOT NULL
                     AND ( trunc(node.actual_end_date) - trunc(node.plan_end_date) ) BETWEEN 1 AND 5 THEN
                    '<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>'
 --到期未反馈黄灯
                WHEN node.actual_end_date IS NULL
                     AND ( trunc(SYSDATE) - trunc(node.plan_end_date) ) BETWEEN 1 AND 5 THEN
                    '<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>'
  --到期超过5天未反馈红灯
                WHEN node.actual_end_date IS NULL
                     AND ( ( trunc(SYSDATE) - trunc(node.plan_end_date) ) > 5 ) THEN
                    '<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'
                ELSE
                    '<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'
            END,
            plan.plan_name,
            plan.id,
            plan.plan_type,
            plan.company_id,
            plan.company_name,
             case when biz.level_rank=1 then
            plan.company_id
            when biz.level_rank <>1 then
             biz.id end,
            case when biz.level_rank=1 then
            plan.company_name
            when biz.level_rank <>1  then
            biz.org_name end,
            node.duty_department_id,
            node.duty_department,
            NULL,
            case when currentquarter is not null then
             currentquarter
             when currentquarter is null then
            to_number(TO_CHAR(sysdate, 'q')) end,
            1,
            CASE
                WHEN node.actual_end_date IS NULL THEN
                    NULL
                WHEN node.actual_end_date IS NOT NULL THEN
--                    feedback.approval_time
(select approval_time from pom_node_feedback where feedback_node_id=node.id and feedback_type='CARRY_OUT')
            END,
            CASE
                WHEN node.actual_end_date IS NULL THEN
                    NULL
                WHEN node.actual_end_date IS NOT NULL THEN
                    exam.id
            END AS complete_feedback_id,
            CASE
                WHEN node.actual_end_date IS NULL THEN
                    NULL
                WHEN node.actual_end_date IS NOT NULL THEN
                    exam.complete_feedback_approve_time
            END,
            plan.proj_name,
            to_number(TO_CHAR(node.plan_end_date, 'yyyy')),
            plan.proj_id,
            node.ORIGINAL_NODE_ID
        FROM
            pom_proj_plan          plan
            INNER JOIN V_POM_GET_NODE_EXAMINE     node ON plan.id = node.proj_plan_id
            LEFT JOIN sys_business_unit      business ON plan.company_id = business.id
            LEFT JOIN sys_business_unit      biz ON business.parent_id = biz.id
--            LEFT JOIN pom_node_feedback      feedback ON feedback.feedback_node_id = node.id
            LEFT JOIN pom_node_examination   exam ON exam.node_id = node.id
        WHERE
            plan.approval_status = '已审核'
            AND  node.is_disable=0
            AND  node.fission_source_original_id is null
            AND ( plan.plan_type = '项目主项计划'
                  OR plan.plan_type = '关键节点计划' )
            AND (node.plan_end_date < v_quarterend AND  node.plan_end_date > v_quarterbegin) ;
COMMIT;
END p_pom_node_quart_photograph;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_OUT_EXCEL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_OUT_EXCEL" 
( 
    PROJID      IN VARCHAR2 --输入变量：项目
   ,CURRENTTYPE IN VARCHAR2
   , --完成节点类型(本月任务,超期未完成任务,所有未完成任务,所有已完成任务,所有任务,次月任务,本季度任务,本年任务)
    userid        IN            VARCHAR2,--用户id用于过滤关注的任务
    currentcompanyid     IN     VARCHAR2,--当前用户的公司
    currentstationid     IN            VARCHAR2,---当前用户的岗位
    currentdeptid        IN            VARCHAR2,---当前用户的部门
    bizcode       IN            VARCHAR2,---权限code
    ITEMS       OUT SYS_REFCURSOR
   ,TOTAL       OUT INT
) IS
    --本部门负责的任务
    --作者：陈丽
    --日期：2019/11/15

    V_SQL_START       CLOB;
    V_SQL_END         CLOB;
    V_SQL_CONTENT     CLOB;
    V_SQL             CLOB;
    V_SQL_EXEC        CLOB;
    V_SQL_EXEC_PAGING CLOB;
    V_WHERE           VARCHAR2(500);
    TESTMSG           NVARCHAR2(200);
    v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN
    ----------------------------------------------------统一解析
    TESTMSG := 'projid:' || PROJID ||'；currenttype:' || CURRENTTYPE;

    BEGIN
        TOTAL         := 1000;
        V_SQL_START   := ' case ';
        V_SQL_CONTENT := '';
        V_SQL_END     := '  else '''' end  ';


        --调用数据权限验证存储过程
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
        --1.拼接查询语句
        FOR ITEM IN (SELECT S.EXPRESSION, VV.NODE_LEVEL, VV.PLAN_TYPE
                     FROM   POM_RULE_SET S
                     LEFT   JOIN (SELECT MAX(S.CREATED_TIME) AS T, NODE_LEVEL, PLAN_TYPE
                                 FROM   POM_RULE_SET S
                                 LEFT   JOIN POM_RULE_SET_PLAN_TYPE PT
                                 ON     S.ID = PT.RULE_ID
                                 WHERE  RULE_TYPE = '亮灯规则'
                                       -- AND plan_type != '关键节点计划'
                                        AND
                                        S.IS_DISABLE = 0
                                 GROUP  BY NODE_LEVEL, PLAN_TYPE) VV
                     ON     S.CREATED_TIME = VV.T AND
                            S.NODE_LEVEL = VV.NODE_LEVEL
                     WHERE  VV.T IS NOT NULL)
        LOOP
            ---拼接字符串
            V_SQL_CONTENT := V_SQL_CONTENT || '  when plan_type=''' || CASE ITEM.PLAN_TYPE
                                 WHEN '项目全景计划' THEN
                                  '项目主项计划'
                                 ELSE
                                  ITEM.PLAN_TYPE
                             END || ''' and node_level=''' || ITEM.NODE_LEVEL || ''' then (' || ITEM.EXPRESSION || ')';
        END LOOP;

        --dbms_output.put_line('123333');
        --dbms_output.put_line(v_sql_content);
        --规则内容大于0才拼规则语句

        IF LENGTH(V_SQL_CONTENT) > 0
        THEN
            V_SQL := V_SQL_START || V_SQL_CONTENT || V_SQL_END;
        ELSE
            --无规则亮灯显示空
            V_SQL := '''''';
        END IF;

        -------------------------------------------------------------------------------------------内容


        IF CURRENTTYPE = '本月任务'
        THEN
            V_WHERE := ' and ACTUAL_END_DATE is null and (PLAN_END_DATE>=trunc(sysdate, ''month'') and PLAN_END_DATE<=trunc(last_day(sysdate))) ';
        ELSIF CURRENTTYPE = '超期未完成任务'
        THEN
            V_WHERE := ' and TRUNC(SYSDATE) > PLAN_END_DATE and ACTUAL_END_DATE is null';
        ELSIF CURRENTTYPE = '所有未完成任务'
        THEN
            V_WHERE := ' and ACTUAL_END_DATE is null ';
        ELSIF CURRENTTYPE = '所有已完成任务'
        THEN
            V_WHERE := ' and ACTUAL_END_DATE is not null ';
        ELSE
            V_WHERE := ' and 1=2';
        END IF;

        --3.拼接完整语句
        IF PROJID<>'111' THEN 
        V_SQL_EXEC := ' select  rownum as rowno,ID,
                    ORIGINAL_NODE_ID,
                    ORIGINAL_PLAN_ID,
                    PROJ_PLAN_ID as PLAN_ID,
                    PLAN_TYPE_INT,
                    NODE_NAME,
                    PLAN_NAME,
                    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
                    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
                    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
                    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
                    case when ACTUAL_END_DATE is null then ''未完成''
                    else ''已完成'' end as COMPLETION_STATUS,
                    PROJ_NAME,
                    PLAN_TYPE,
                    DUTY_DEPARTMENT,
                    CHARGE_PERSON,
                    NODE_LEVEL,
                    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,w_Url,' || V_SQL || ' as NODE_WARNING from (select n.*,w.IS_UN_WATCH
                ,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
                ,case when n.ACTUAL_END_DATE IS NOT NULL THEN NULL 
                ELSE ''催办'' END as HASTEN
                ,case when w.IS_UN_WATCH=0 then ''/api/pom/planfollow/unfollow?cancelType=0=724=300=''||ORIGINAL_NODE_ID else ''/pom/biz-watch/bizwatch-setting?cancelType=0=724=300==''||ORIGINAL_NODE_ID end as w_Url

                                      from(SELECT
                    n.ID,
                     p.ORIGINAL_PLAN_ID,
                    ORIGINAL_NODE_ID,
                    n.PROJ_PLAN_ID,
                    CASE p.PLAN_TYPE
                        WHEN ''关键节点计划''   THEN
                            0
                        WHEN ''项目主项计划''   THEN
                            1
                    END AS PLAN_TYPE_INT,

                    NODE_NAME,
                    p.PLAN_NAME,--计划名称
                    PLAN_START_DATE,
                    PLAN_END_DATE,

                    ACTUAL_END_DATE,
                    ESTIMATE_END_DATE,           --预计完成时间
                    p.PROJ_NAME,          --所属项目
                    p.PLAN_TYPE,        --计划类型显示名
                    DUTY_DEPARTMENT,          --主责部门
                    person.CHARGE_PERSON,
                    NODE_LEVEL,           --任务等级
                    STANDARD_SCORE          --标准分值
                FROM
                    POM_PROJ_PLAN_NODE n LEFT
                    JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
                    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON n.ID=person.NODE_ID
                    LEFT JOIN SYS_PROJECT_STAGE sps on p.proj_id=sps.id 
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal 
                    ON (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null 
                    AND   p.PLAN_TYPE=''关键节点计划'' AND NVL(n.IS_DISABLE,0) <> 1 and APPROVAL_STATUS=''已审核''
                    AND (p.PROJ_ID=''' || PROJID || ''' OR p.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''' || PROJID || '''))  ' || V_WHERE || '
                )n
                    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID  )  a ';
        ELSE
            V_SQL_EXEC := 'select  rownum as rowno,ID,
                    ORIGINAL_NODE_ID,
                    ORIGINAL_PLAN_ID,
                    PROJ_PLAN_ID as PLAN_ID,
                    PLAN_TYPE_INT,
                    NODE_NAME,
                    PLAN_NAME,
                    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
                    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
                    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
                    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
                    case when ACTUAL_END_DATE is null then ''未完成''
                    else ''已完成'' end as COMPLETION_STATUS,
                    PROJ_NAME,
                    PLAN_TYPE,
                    DUTY_DEPARTMENT,
                    CHARGE_PERSON,
                    NODE_LEVEL,
                    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,w_Url,' || V_SQL || ' as NODE_WARNING from (select n.*,w.IS_UN_WATCH
                ,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
                ,case when n.ACTUAL_END_DATE IS NOT NULL THEN NULL 
                ELSE ''催办'' END as HASTEN
                ,case when w.IS_UN_WATCH=0 then ''/api/pom/planfollow/unfollow?cancelType=0=724=300=''||ORIGINAL_NODE_ID else ''/pom/biz-watch/bizwatch-setting?cancelType=0=724=300==''||ORIGINAL_NODE_ID end as w_Url

                                      from(SELECT
                    n.ID,
                     p.ORIGINAL_PLAN_ID,
                    ORIGINAL_NODE_ID,
                    n.PROJ_PLAN_ID,
                    CASE p.PLAN_TYPE
                        WHEN ''关键节点计划''   THEN
                            0
                        WHEN ''项目主项计划''   THEN
                            1
                    END AS PLAN_TYPE_INT,

                    NODE_NAME,
                    p.PLAN_NAME,--计划名称
                    PLAN_START_DATE,
                    PLAN_END_DATE,

                    ACTUAL_END_DATE,
                    ESTIMATE_END_DATE,           --预计完成时间
                    p.PROJ_NAME,          --所属项目
                    p.PLAN_TYPE,        --计划类型显示名
                    DUTY_DEPARTMENT,          --主责部门
                    person.CHARGE_PERSON,
                    NODE_LEVEL,           --任务等级
                    STANDARD_SCORE          --标准分值
                FROM
                    POM_PROJ_PLAN_NODE n LEFT
                    JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
                    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON n.ID=person.NODE_ID
                    LEFT JOIN SYS_PROJECT_STAGE sps on p.proj_id=sps.id 
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal 
                    ON (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null 
                    AND   p.PLAN_TYPE=''关键节点计划'' AND NVL(n.IS_DISABLE,0) <> 1 and APPROVAL_STATUS=''已审核''
                     ' || V_WHERE || '
                )n
                    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID  ) a ';
        END IF;
        -------------------------------------------------------------------------------------------内容

        V_SQL_EXEC_PAGING := '
select a.* from ( ' || V_SQL_EXEC || ')a';

        DBMS_OUTPUT.PUT_LINE(V_SQL_EXEC);
        ----获取总条数
        EXECUTE IMMEDIATE 'SELECT count(rowno) from(' || V_SQL_EXEC || ') a '
            INTO TOTAL;

        -- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN ITEMS FOR V_SQL_EXEC_PAGING;
        --SELECT '' A FROM DUAL;

    EXCEPTION
        WHEN OTHERS THEN
            TESTMSG := SQLERRM || TESTMSG;
            OPEN ITEMS FOR
                SELECT '失败咯' || TESTMSG PLAN_NAME FROM DUAL;

            DBMS_OUTPUT.PUT_LINE(SQLERRM);
    END;

END P_POM_OUT_EXCEL;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_PERMIT_ID_LIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_PERMIT_ID_LIST" (
    info out SYS_REFCURSOR,
    originNodeId in varchar2
) is
--根据裂变原始节点Id查询所有节点所关联的证照id
--作者：韩金明
--日期：2010/02/28
--输入变量：裂变原始节点Id
begin
    open info for
        select fb.PERMIT_ID
        from POM_NODE_FEEDBACK fb
        left join POM_PROJ_PLAN_NODE node on fb.id = node.FISSION_SOURCE_ORIGINAL_ID
        left join POM_PROJ_PLAN plan on node.PROJ_PLAN_ID = plan.id
        where plan.ORIGINAL_PLAN_ID = originNodeId;
    -- 将原始节点id传入POM_PROJ_PLAN查询所有裂变计划
    -- 关联计划节点id
end P_POM_PERMIT_ID_LIST;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_PLAN_COMPLETIONRANKING
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_PLAN_COMPLETIONRANKING" (
    companyid          IN                 VARCHAR2,--公司id
    currentcompanyid   IN                 VARCHAR2,--当前用户的公司
    userid             IN                 VARCHAR2,--用户id用于过滤关注的任务
    currentstationid   IN                 VARCHAR2,---当前用户的岗位
    currentdeptid      IN                 VARCHAR2,---当前用户的部门
    bizcode            IN                 VARCHAR2,---权限code
    authdata           OUT                SYS_REFCURSOR,--有权限数据的ID集合
    datasource              OUT                SYS_REFCURSOR --亮灯信息
) AS
--项目主项计划监控项目完成率前排行榜
--作者：叶丁荣
--日期：2020/03/20
    v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN
--调用数据权限验证存储过程
    p_sys_auth_data_rule_spid(userid => userid, stationid => currentstationid, deptid => currentdeptid, companyid => currentcompanyid
    , bizcode => bizcode, data_auth_spid => v_spid);

    OPEN datasource FOR SELECT
                      ROWNUM,
                      b1."fullName",
                      b1."competationRate",
                      b1."projtId"
                  FROM
                      sys_business_unit a1
                      LEFT JOIN (
                          SELECT
                              '【'
                              || a.company_name
                              || '】'
                              || d.project_name
                              ||
                                  CASE
                                      WHEN c.stage_name NOT LIKE '%无分期%' THEN
                                          '_' || c.stage_name
                                      ELSE
                                          NULL
                                  END
                              AS "fullName",
                              c.id   AS "projtId",
                              a.company_id,
                              COUNT(b.id) AS "TOTALNODECOUNT",
                              SUM(
                                  CASE
                                      WHEN b.actual_end_date IS NOT NULL THEN
                                          1
                                      ELSE
                                          0
                                  END
                              ) AS "actualEndNodeCount",
                              round(SUM(
                                  CASE
                                      WHEN b.actual_end_date IS NOT NULL THEN
                                          1
                                      ELSE
                                          0
                                  END
                              ) /(

                                   CASE
                                      WHEN COUNT(b.id) = 0 THEN
                                          1
                                      ELSE
                                          COUNT(b.id)
                                  END

                              ),4) AS "competationRate"
--完成率说明：截止当前完成节点数量/截止当前应完成任务数量    亮灯规则说明：1）绿灯：完成率≥95% 2）黄灯：95%>完成率≥90% 3）红灯：完成率＜90%
                          FROM
                              pom_proj_plan        a
                              INNER JOIN pom_proj_plan_node   b ON a.id = b.proj_plan_id
                              INNER JOIN sys_project_stage    c ON c.id = proj_id
                              INNER JOIN sys_project          d ON d.id = c.project_id
                          WHERE
                              a.plan_type = '项目主项计划'
                              AND a.approval_status = '已审核'
                              AND b.is_disable = 0
                              AND b.plan_end_date is not null
                              AND b.plan_end_date <= SYSDATE
                          GROUP BY
                              '【'
                              || a.company_name
                              || '】'
                              || d.project_name
                              ||
                                  CASE
                                      WHEN c.stage_name NOT LIKE '%无分期%' THEN
                                          '_' || c.stage_name
                                      ELSE
                                          NULL
                                  END,
                              a.company_id,
                              a.company_name,
                              c.id
                      ) b1 ON b1.company_id = a1.id
                      LEFT JOIN (
                          SELECT
                              wm_concat(user_name) AS user_name,
                              project_id
                          FROM
                              sys_role_user_relation_result
                          WHERE
                              role_code = 'pom_project_plan_manager'
                          GROUP BY
                              project_id
                      ) c1 ON c1.project_id = b1."projtId"
                  WHERE
                      nvl(b1.totalnodecount, 0) > 0
                      AND ROWNUM <= 10
                      AND CONNECT_BY_ROOT id = ''
                                               || companyid
                                               || ''
                  CONNECT BY
                      PRIOR a1.id = a1.parent_id
                  ORDER BY
                      b1."competationRate" DESC;

    OPEN authdata FOR SELECT
                      b1."projtId"
                  FROM
                      sys_business_unit a1
                      LEFT JOIN (
                          SELECT
                              c.id   AS "projtId",
                              a.company_id
                          FROM
                              pom_proj_plan        a
                              INNER JOIN pom_proj_plan_node   b ON a.id = b.proj_plan_id
                              INNER JOIN sys_project_stage    c ON c.id = proj_id
                              INNER JOIN sys_project          d ON d.id = c.project_id
                              LEFT  JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                              on (case when c.id is not null then c.PROJECT_ID else a.proj_id end)=tal.orgId
                            WHERE
                              a.plan_type = '项目主项计划'
                              AND a.approval_status = '已审核'
                              AND b.is_disable = 0
                          GROUP BY
                              a.company_id,
                              a.company_name,
                              c.id
                      ) b1 ON b1.company_id = a1.id
                      LEFT JOIN (
                          SELECT
                              wm_concat(user_name) AS user_name,
                              project_id
                          FROM
                              sys_role_user_relation_result
                          WHERE
                              role_code = 'pom_project_plan_manager'
                          GROUP BY
                              project_id
                      ) c1 ON c1.project_id = b1."projtId"
                  WHERE
                      b1."projtId" is not null
                      AND CONNECT_BY_ROOT id = ''
                                               || companyid
                                               || ''
                                                CONNECT BY
                      PRIOR a1.id = a1.parent_id
                ;

END p_pom_plan_completionranking;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_PLAN_DTL_CONDITIONS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_PLAN_DTL_CONDITIONS" (
    authcode              IN           VARCHAR2,--鉴权CODE
    currentuserid         IN	       VARCHAR2,--用户ID 鉴权使用
    currentcompanyid      IN           VARCHAR2,--用户公司ID  鉴权使用
    currentdeptid         IN           VARCHAR2,--用户部门ID  鉴权使用
    currentstationid      IN           VARCHAR2,--用户岗位ID  鉴权使用
    o_second_company out  SYS_REFCURSOR,---二级单位
    o_cp_proj out  SYS_REFCURSOR,---是否操盘
    o_plan_type out  SYS_REFCURSOR,---计划类型
    o_node_level out  SYS_REFCURSOR,---任务级别
    o_node_status out  SYS_REFCURSOR,---完成状态
    o_node_overdue out  SYS_REFCURSOR,---是否超期
    o_node_plan_end out  SYS_REFCURSOR,---计划完成日期
    o_node_actual_end out  SYS_REFCURSOR,---实际完成日期
    o_licence_node out  SYS_REFCURSOR---证照节点
) AS
	--计划明细查询条件
	--作者：陈丽
	--日期：2020-07-21
NOW_DATE DATE; O_M_BEGIN DATE; O_M_END DATE; O_QUARTER_BEGIN DATE; O_QUARTER_END DATE; O_YEAR_BEGIN DATE; O_YEAR_END DATE; V_SPID VARCHAR2(200);

BEGIN
--1、调用鉴权的存储过程

    P_SYS_GET_COMPANY_PROJ_SPID(
        userid => currentuserid,
        stationid => currentstationid,
        deptid => currentdeptid,
        companyid => currentcompanyid,
        bizcode => authcode,
        DATA_AUTH_SPID => V_SPID
    );
    ----获取本年本月本季度
    BEGIN NOW_DATE :=sysdate;
        P_POM_MONTH_QUARTER_YEAR (
            NOW_DATE=> NOW_DATE,
            O_M_BEGIN=> O_M_BEGIN,
            O_M_END=> O_M_END,
            O_QUARTER_BEGIN=> O_QUARTER_BEGIN,
            O_QUARTER_END=> O_QUARTER_END,
            O_YEAR_BEGIN=> O_YEAR_BEGIN,
            O_YEAR_END=> O_YEAR_END
        );
END;
---二级单位
open o_second_company for
    SELECT DISTINCT *
    FROM(
        SELECT
               org_id       AS "value",
               'org-'||org_id as id,
               org_name     AS "label",
               ORDER_CODE AS "code",
               cnt as "cnt"
        FROM tmp_company_tree tmt
        left join (
            select topId, topName,sum(nvl(cnt, 0)) cnt
            from (
                 select ID, connect_by_root (ID) topId,connect_by_root (ORG_NAME) topName
                 from (
                      select sbu1.ID, PARENT_ID, ORG_NAME, LEVEL_RANK, min(LEVEL_RANK) over () minLevelRank
                      from SYS_BUSINESS_UNIT sbu1
                      where sbu1.IS_COMPANY =1
                        and LEVEL_RANK > 1
                 ) sbu2
                     start with LEVEL_RANK = sbu2.minLevelRank
                     connect by prior sbu2.ID = sbu2.PARENT_ID
                 ) sbu left join (
                select UNIT_ID, count(1) cnt from SYS_PROJECT
                group by UNIT_ID
            ) sp on sbu.ID = sp.UNIT_ID
            group by topId, topName
        ) sps on sps.topId = tmt.ORG_ID
        WHERE
           id = V_SPID
           AND cnt > 0
           AND PARENT_ID='003200000000000000000000000000'
       ) ORDER BY "code";


--open o_second_company for
--select  'org-'||tab."value" as id,tab."value",tab."label",ROWNUM as "sort",tab."isChecked" from (select id "value" ,org_name  "label",'org' as "ParentId",ORDER_HIERARCHY_CODE as "sort",0 as "isChecked"  from (select ID,org_name,order_hierarchy_code from (select ORG_ID from DWM_SALE_RATE_PROJECT group by ORG_ID) tab left join  SYS_BUSINESS_UNIT on tab.ORG_ID=SYS_BUSINESS_UNIT.ID where SYS_BUSINESS_UNIT.LEVEL_RANK=2
--        union
--        select ID,org_name,order_hierarchy_code from  (select parent_id  from (select ORG_ID from DWM_SALE_RATE_PROJECT group by ORG_ID) tab left join  SYS_BUSINESS_UNIT on tab.ORG_ID=SYS_BUSINESS_UNIT.ID where SYS_BUSINESS_UNIT.LEVEL_RANK=3) orgids
--        left join SYS_BUSINESS_UNIT on orgids.parent_id=SYS_BUSINESS_UNIT.id
--        union
--        select ID,org_name,order_hierarchy_code from(select * from SYS_BUSINESS_UNIT m start with m.id in (
--        select sys_business_unit.ID from (select ORG_ID from DWM_SALE_RATE_PROJECT group by ORG_ID) tab left join  SYS_BUSINESS_UNIT on tab.ORG_ID=SYS_BUSINESS_UNIT.ID where SYS_BUSINESS_UNIT.LEVEL_RANK>3
--        ) connect by prior m.parent_id=m.id)tab where tab.LEVEL_RANK=2 ) orgs order by orgs.order_hierarchy_code) tab
--       ;

open   o_cp_proj for---是否操盘
select a.* from (
select   '操盘' as "value",'操盘' as "label",1 as "sort",0 as "isChecked"  from dual
UNION ALL
select   '不操盘' as "value",'非操盘' as "label",2 as "sort",0 as "isChecked"  from dual
UNION ALL
select   '其他' as "value",'其他' as "label",3 as "sort",0 as "isChecked"  from dual
) a order by "sort";


open   o_plan_type for---计划类型
select a.* from (
select  '关键节点计划' as "value",'关键节点计划' as "label",1 as "sort",0 as "isChecked"  from dual
UNION
select  '项目主项计划' as "value",'项目主项计划' as "label",2 as "sort",0 as "isChecked"  from dual) a order by "sort";

open   o_node_level for---任务级别--需要调整为查询业务参数
select a.* from (
select   '里程碑' as "value",'里程碑' as "label",1 as "sort",0 as "isChecked"  from dual
UNION
select   '一级节点' as "value",'一级节点' as "label",2 as "sort",0 as "isChecked"  from dual) a order by "sort";

open   o_node_status for---完成状态
select a.* from (
select   '已完成' as "value",'已完成' as "label",1 as "sort",0 as "isChecked"  from dual
UNION
select   '未完成' as "value",'未完成' as "label",2 as "sort",0 as "isChecked"  from dual) a order by "sort";

open    o_node_overdue for---是否超期
select a.* from (
select   '是' as "value",'是' as "label",1 as "sort",0 as "isChecked"  from dual
UNION
select   '否' as "value",'否' as "label",2 as "sort",0 as "isChecked"  from dual) a order by "sort";

open   o_node_plan_end for---计划完成日期
select a.* from (
select   add_months(sysdate,-1200) as "begin",add_months(sysdate,1200) as "end",'所有' as "label",1 as "sort",0 as "isChecked",0 as "showDate"  from dual
UNION all
select   O_M_BEGIN as "begin",O_M_END as "end",'本月' as "label",2 as "sort",0 as "isChecked",0 as "showDate"  from dual
UNION all
select   O_QUARTER_BEGIN as "begin",O_QUARTER_END as "end",'本季度' as "label",3 as "sort",0 as "isChecked",0 as "showDate"  from dual
UNION all
select   O_YEAR_BEGIN as "begin",O_YEAR_END as "end",'本年' as "label",4 as "sort",0 as "isChecked",0 as "showDate"  from dual
UNION all
select   add_months(sysdate,-12) as "begin",add_months(sysdate,12) as "end",'自定义' as "label",5 as "sort",0 as "isChecked",1 as "showDate"  from dual) a order by "sort";

open    o_node_actual_end for---实际完成日期
select a.* from (
select   add_months(sysdate,-24000) as "begin",add_months(sysdate,24000) as "end",'所有' as "label",1 as "sort",0 as "isChecked",0 as "showDate"  from dual
UNION all
select   O_M_BEGIN as "begin",O_M_END as "end",'本月' as "label",2 as "sort",0 as "isChecked",0 as "showDate"  from dual
UNION all
select   O_QUARTER_BEGIN as "begin",O_QUARTER_END as "end",'本季度' as "label",3 as "sort",0 as "isChecked",0 as "showDate"  from dual
UNION all
select   O_YEAR_BEGIN as "begin",O_YEAR_END as "end",'本年' as "label",4 as "sort",0 as "isChecked",0 as "showDate"  from dual
UNION all
select   add_months(sysdate,-12) as "begin",add_months(sysdate,12) as "end",'自定义' as "label",5 as "sort",0 as "isChecked",1 as "showDate"  from dual) a order by "sort";

--    o_licence_Type out  SYS_REFCURSOR,---证照类型
open    o_licence_node for---证照节点
select a.* from (
select   '-1' as "value",'不过滤' as "label",1 as "sort",0 as "isChecked"  from dual
UNION
select   '2' as "value",'只含裂变节点' as "label",2 as "sort",0 as "isChecked"  from dual
UNION
select   '4' as "value",'不含裂变节点' as "label",3 as "sort",0 as "isChecked"  from dual
UNION
select   '1' as "value",'只含首次取证节点' as "label",4 as "sort",0 as "isChecked"  from dual
UNION
select   '3' as "value",'含首次取证与裂变节点' as "label",5 as "sort",0 as "isChecked"  from dual) a order by "sort";
END P_POM_plan_dtl_conditions;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_PLAN_DTL_FIELD
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_PLAN_DTL_FIELD" (
    o_result out  SYS_REFCURSOR
) AS
    --计划明细查询显示列
    --作者：陈丽
    --日期：2020-07-21
BEGIN
    ---条件
    open o_result for
        select *
        from (
                 select  'companyName' as "field",'所属二级单位' as "label",1 as "sort",1 as "isChecked",1 as "isHtml",''  as "openUrlFiled",110 "colWidth",'left' as  "textAlign"  from dual
                 UNION
                 select  'areaCompanyName' as "field",'所属三级单位' as "label",2 as "sort",0 as "isChecked",1 as "isHtml",''  as "openUrlFiled",110 "colWidth",'left' as  "textAlign"  from dual
                 UNION
                 select  'warning' as "field",'预警状态' as "label",3 as "sort",1 as "isChecked",1 as "isHtml",''  as "openUrlFiled",80 "colWidth",'center' as  "textAlign"  from dual
                 UNION
                 select  'planName' as "field",'计划名称' as "label",4 as "sort",1 as "isChecked",1 as "isHtml",'planNameOpenUrl'  as "openUrlFiled",150 "colWidth",'left' as  "textAlign"  from dual
                 UNION
                 select  'planType' as "field",'计划类型' as "label",5 as "sort",1 as "isChecked",1 as "isHtml",''  as "openUrlFiled",110 "colWidth",'center' as  "textAlign"  from dual
                 UNION
                 select  'nodeName' as "field",'任务名称' as "label",6 as "sort",1 as "isChecked",1 as "isHtml",'nodeNameOpenUrl' as "openUrlFiled",200 "colWidth" ,'left' as  "textAlign" from dual
                 UNION
                 select  'nodeState' as "field",'完成状态' as "label",7 as "sort",1 as "isChecked",0 as "isHtml",''  as "openUrlFiled",80 "colWidth",'center' as  "textAlign"  from dual
                 UNION
                 select  'planEndDate' as "field",'计划完成日期' as "label",8 as "sort",1 as "isChecked",0 as "isHtml",''  as "openUrlFiled",120 "colWidth",'center' as  "textAlign"  from dual
                 UNION
                 select  'estimateEndTime' as "field",'预计完成日期' as "label",9 as "sort",1 as "isChecked",0 as "isHtml",''  as "openUrlFiled",120 "colWidth",'center' as  "textAlign"  from dual
                 UNION
                 select  'actualEndDate' as "field",'实际完成日期' as "label",10 as "sort",1 as "isChecked",0 as "isHtml",''  as "openUrlFiled",120 "colWidth",'center' as  "textAlign"  from dual
                 UNION
                 select  'nodeLevel' as "field",'任务级别' as "label",11 as "sort",1 as "isChecked",0 as "isHtml",''  as "openUrlFiled",80 "colWidth",'center' as  "textAlign"  from dual
                 UNION
                 select  'processCount' as "field",'过程反馈次数' as "label",12 as "sort",0 as "isChecked",0 as "isHtml",''  as "openUrlFiled",100 "colWidth",'right' as  "textAlign"  from dual
                 UNION
                 select  'carryOutCount' as "field",'完成反馈次数' as "label",13 as "sort",0 as "isChecked",0 as "isHtml",''  as "openUrlFiled",100 "colWidth",'right' as  "textAlign"  from dual
                 UNION
                 select  'expiredCount' as "field",'超期未完成反馈次数' as "label",14 as "sort",0 as "isChecked",0 as "isHtml",''  as "openUrlFiled",100 "colWidth",'right' as  "textAlign"  from dual
                 UNION
                 select  'dutyDept' as "field",'主责部门' as "label",15 as "sort",0 as "isChecked",0 as "isHtml",''  as "openUrlFiled",100 "colWidth",'left' as  "textAlign"  from dual
                 UNION
                 select  'chargePerson' as "field",'主责人' as "label",16 as "sort",0 as "isChecked",0 as "isHtml",''  as "openUrlFiled",100 "colWidth",'left' as  "textAlign"  from dual
                 UNION
                 select  'standardScore' as "field",'标准分值' as "label",17 as "sort",1 as "isChecked",0 as "isHtml",''  as "openUrlFiled",100 "colWidth",'right' as  "textAlign"  from dual
                 UNION
                 select  'actualScore' as "field",'实际得分' as "label",18 as "sort",1 as "isChecked",0 as "isHtml",''  as "openUrlFiled",100 "colWidth",'right' as  "textAlign"  from dual
                 UNION
                 select  'completionStandard' as "field",'完成要求' as "label",19 as "sort",0 as "isChecked",0 as "isHtml",''  as "openUrlFiled",100 "colWidth",'left' as  "textAlign"  from dual
                 UNION
                 select  'completionResultsRemark' as "field",'完成成果说明' as "label",20 as "sort",0 as "isChecked",0 as "isHtml",''  as "openUrlFiled",100 "colWidth",'left' as  "textAlign"  from dual
             ) a order by a."sort";
END p_pom_plan_dtl_field;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_PLAN_MONITOR_LIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_PLAN_MONITOR_LIST" (
    plantype    IN          VARCHAR2, --输入变量：计划类型
    currentcompanyid   IN                 VARCHAR2,--当前用户的公司
    userid             IN                 VARCHAR2,--用户id用于过滤关注的任务
    currentstationid   IN                 VARCHAR2,---当前用户的岗位
    currentdeptid      IN                 VARCHAR2,---当前用户的部门
    bizcode            IN                 VARCHAR2,---权限code
    pageindex   IN          VARCHAR2,--输入变量：页码
    pagesizes    IN          VARCHAR2,--输入面临：页面条数
    items       OUT         SYS_REFCURSOR
) IS
    v_where              CLOB;
    v_sql_exec          CLOB;
    v_sql_exec_paging   CLOB;
    v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN
    --调用数据权限验证存储过程
    p_sys_auth_data_rule_spid(userid => userid, stationid => currentstationid, deptid => currentdeptid, companyid => currentcompanyid
    , bizcode => bizcode, data_auth_spid => v_spid);

  execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd hh24:mi:ss''';
    IF plantype = '关键节点计划' THEN
        v_where:= 'AND plan.PLAN_TYPE = ''关键节点计划''';
    ELSE
        v_where := 'AND plan.PLAN_TYPE = ''项目主项计划''';
    END IF;

 --open items for select * from  TMP_AUTH_LIST where id =v_spid ;
v_sql_exec:='SELECT  rownum as "rowno","userName", "executionTime","executionContent", "executionType","orgid","projid","stageid","deptid","ncompanyid","pcompanyid" from
(select "userName","executionTime","executionContent","executionType","orgid","projid","stageid","deptid","ncompanyid","pcompanyid" from (
SELECT
    back.FEEDBACKER AS "userName",
    back.CREATED AS "executionTime",
    case when  FEEDBACK_TYPE=''PROCESS'' then
    ''<span style="color:#A2A2A2">反馈了任务:</span> ''|| ( ''【'' || stage.STAGE_FULL_NAME || ''】''|| node.node_name )
    when FEEDBACK_TYPE=''CARRY_OUT'' then
    ''<span style="color:#A2A2A2">完成了任务:</span>''|| ( ''【'' || stage.STAGE_FULL_NAME || ''】''|| node.node_name )

     else
     ''<span style="color:#A2A2A2">反馈了超期未完成任务:</span>''|| ( ''【'' || stage.STAGE_FULL_NAME || ''】''|| node.node_name )
     end  AS "executionContent",
	case when  FEEDBACK_TYPE=''PROCESS'' then
        ''feedback''
     when FEEDBACK_TYPE=''CARRY_OUT'' then
        ''complete''
     else
        ''overdu''
     end AS "executionType",
     proj.unit_id AS "orgid",
     plan.proj_id AS "projid",
     stage.id AS "stageid",
     node.duty_department_id AS "deptid",
     node.company_id AS "ncompanyid",
     plan.company_id AS "pcompanyid"

--     to_char(back.CREATED,''yyyy-mm-dd'') as "groupDate"
    FROM
	pom_proj_plan_node node
	LEFT JOIN pom_proj_plan plan ON node.proj_plan_id = plan.id
    LEFT JOIN SYS_PROJECT_STAGE stage on plan.proj_id=stage.id
    LEFT JOIN SYS_PROJECT proj
    on (case when stage.id is not null then stage.ID else plan.proj_id end)=proj.id
    INNER join pom_node_feedback back on back.FEEDBACK_NODE_ORIGINAL_ID=node.original_node_id
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    ON (case when stage.id is not null then stage.PROJECT_ID else plan.proj_id end)=tal.orgId
    OR node.company_id=tal.orgId OR node.DUTY_DEPARTMENT_ID=tal.orgId
    where tal.orgId is not null AND plan.ID is not null and plan.APPROVAL_STATUS=''已审核'' '|| v_where||'
    UNION ALL
   SELECT
    message.user_name AS "userName",
      message.created_time AS "executionTime",
    ''<span style="color:#A2A2A2">催办了任务:</span>''|| ( ''【'' || stage.STAGE_FULL_NAME || ''】''|| node.node_name )   AS "executionContent",
    ''urge'' AS "executionType",
     proj.unit_id AS "orgid",
     plan.proj_id AS "projid",
     stage.id AS "stageid",
     node.duty_department_id AS "deptid",
     node.company_id AS "ncompanyid",
     plan.company_id AS "pcompanyid"
FROM
    pom_proj_plan_node   node
    LEFT JOIN pom_proj_plan        plan ON node.proj_plan_id = plan.id
    LEFT JOIN sys_project_stage    stage ON plan.proj_id = stage.id
    LEFT JOIN sys_project          proj ON (
        CASE
            WHEN stage.id IS NOT NULL THEN
                stage.ID
            ELSE
                plan.proj_id
        END
    ) = proj.id
    INNER JOIN (
         SELECT
            DISTINCT msg.biz_key,
            msg.biz_msg_category,
            msg.created_time,
            sms.sender_id      AS "sms_sender_id",
            sms.sms_content,
            wechat.sender_id   AS "wechat_sender_id",
            wechat.title,
            suser.user_name
        FROM
            sys_msg_record_biz      msg
            LEFT JOIN sys_msg_record_sms      sms ON sms.msg_record_biz_id = msg.id
            LEFT JOIN sys_msg_record_wechat   wechat ON wechat.msg_record_biz_id = msg.id
            INNER JOIN sys_user suser on suser.user_code=sms.sender_id OR suser.id=wechat.sender_id
        WHERE
            msg.biz_msg_category = ''催办消息''
    ) message ON message.biz_key = node.original_node_id
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    ON (case when stage.id is not null then stage.PROJECT_ID else plan.proj_id end)=tal.orgId
    OR node.company_id=tal.orgId OR node.DUTY_DEPARTMENT_ID=tal.orgId
    WHERE tal.orgId is not null AND  plan.APPROVAL_STATUS=''已审核'' '|| v_where||'
    UNION ALL
    select
    '''' AS "userName",
    to_date(  to_char("executionTime",''yyyy-mm-dd'')||'' 23:59:59'' ) AS "executionTime",
    ''''  AS "executionContent",
    to_char("executionTime",''mm"月"dd"日"'') "executionType",
     null AS "orgid",
     null AS "projid",
     null AS "stageid",
     null AS "deptid",
     null AS "ncompanyid",
     null AS "pcompanyid" from (
SELECT
    back.FEEDBACKER AS "userName",
    back.CREATED AS "executionTime",
    case when  FEEDBACK_TYPE=''PROCESS'' then
    ''反馈了任务 ''|| ( ''【'' || stage.STAGE_FULL_NAME || ''】''|| node.node_name )
    when FEEDBACK_TYPE=''CARRY_OUT'' then
    ''完成了任务''|| ( ''【'' || stage.STAGE_FULL_NAME || ''】''|| node.node_name )

     else
     ''反馈了超期未完成任务''|| ( ''【'' || stage.STAGE_FULL_NAME || ''】''|| node.node_name )
     end  AS "executionContent",
  case when  FEEDBACK_TYPE=''PROCESS'' then
        ''feedback''
     when FEEDBACK_TYPE=''CARRY_OUT'' then
        ''overdu''
     else
        ''complete''
     end AS "executionType",
     proj.unit_id AS "orgid",
     plan.proj_id AS "projid",
     stage.id AS "stageid",
     node.duty_department_id AS "deptid",
     node.company_id AS "ncompanyid",
     plan.company_id AS "pcompanyid"
--     to_char(back.CREATED,''yyyy-mm-dd'') as "groupDate"
    FROM
  pom_proj_plan_node node
  LEFT JOIN pom_proj_plan plan ON node.proj_plan_id = plan.id
    LEFT JOIN SYS_PROJECT_STAGE stage on plan.proj_id=stage.id
    LEFT JOIN SYS_PROJECT proj
    on (case when stage.id is not null then stage.ID else plan.proj_id end)=proj.id
    INNER join pom_node_feedback back on back.FEEDBACK_NODE_ORIGINAL_ID=node.original_node_id
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    ON (case when stage.id is not null then stage.PROJECT_ID else plan.proj_id end)=tal.orgId
    OR node.company_id=tal.orgId OR node.DUTY_DEPARTMENT_ID=tal.orgId
    where tal.orgId is not null AND plan.ID is not null and plan.APPROVAL_STATUS=''已审核'' '|| v_where||'
    UNION ALL
   SELECT
     message.user_name AS "userName",
      message.created_time AS "executionTime",
    ''催办了任务:''|| ( ''【'' || stage.STAGE_FULL_NAME || ''】''|| node.node_name )   AS "executionContent",
    ''urge'' AS "executionType",
     proj.unit_id AS "orgid",
     plan.proj_id AS "projid",
     stage.id AS "stageid",
     node.duty_department_id AS "deptid",
     node.company_id AS "ncompanyid",
     plan.company_id AS "pcompanyid"
FROM
    pom_proj_plan_node   node
    LEFT JOIN pom_proj_plan        plan ON node.proj_plan_id = plan.id
    LEFT JOIN sys_project_stage    stage ON plan.proj_id = stage.id
     LEFT JOIN sys_project          proj ON (
        CASE
            WHEN stage.id IS NOT NULL THEN
                stage.ID
            ELSE
                plan.proj_id
        END
    ) = proj.id
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    ON (case when stage.id is not null then stage.PROJECT_ID else plan.proj_id end)=tal.orgId
    OR node.company_id=tal.orgId OR node.DUTY_DEPARTMENT_ID=tal.orgId
    INNER JOIN (
         SELECT
            DISTINCT msg.biz_key,
            msg.biz_msg_category,
            msg.created_time,
            sms.sender_id      AS "sms_sender_id",
            sms.sms_content,
            wechat.sender_id   AS "wechat_sender_id",
            wechat.title,
            suser.user_name
        FROM
            sys_msg_record_biz      msg
            LEFT JOIN sys_msg_record_sms      sms ON sms.msg_record_biz_id = msg.id
            LEFT JOIN sys_msg_record_wechat   wechat ON wechat.msg_record_biz_id = msg.id
            INNER JOIN sys_user suser on suser.user_code=sms.sender_id OR suser.id=wechat.sender_id
        WHERE
            msg.biz_msg_category = ''催办消息''
    ) message ON message.biz_key = node.original_node_id   WHERE tal.orgId is not null AND plan.APPROVAL_STATUS=''已审核'' '|| v_where||')a
    group by to_char("executionTime",''mm"月"dd"日"'')
    , to_date(  to_char("executionTime",''yyyy-mm-dd'')||'' 23:59:59'' )) order BY "executionTime" DESC)   ';







      v_sql_exec_paging := '
select a.* from ( '
                         || v_sql_exec
                         || ' where rownum <= '
                         || pageIndex * pageSizes
                         || ' ) a where a."rowno" > '
                         || pagesizes * ( pageindex - 1 )
                         || '';

    dbms_output.put_line(v_sql_exec_paging);
    OPEN items FOR v_sql_exec_paging;

END p_pom_plan_monitor_list;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_PLAN_MONITOR_TASK_COUNT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_PLAN_MONITOR_TASK_COUNT" ( plantype IN VARCHAR2, --输入变量：计划类型
    currentcompanyid   IN                 VARCHAR2,--当前用户的公司
    userid             IN                 VARCHAR2,--用户id用于过滤关注的任务
    currentstationid   IN                 VARCHAR2,---当前用户的岗位
    currentdeptid      IN                 VARCHAR2,---当前用户的部门
    bizcode            IN                 VARCHAR2,---权限code
	beyondtask OUT VARCHAR2,
    completedtodaytask OUT VARCHAR2,
    todotodaytask OUT VARCHAR2 )
 IS
    v_where CLOB;
    v_beyondtask_sql  CLOB;
    v_completedtodaytask_sql  CLOB;
    v_todotodaytask_sql  CLOB;
    v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN
--调用数据权限验证存储过程
    p_sys_auth_data_rule_spid(userid => userid, stationid => currentstationid, deptid => currentdeptid, companyid => currentcompanyid
    , bizcode => bizcode, data_auth_spid => v_spid);

	IF
		plantype = '关键节点计划' THEN
			v_where := 'AND plan.PLAN_TYPE = ''关键节点计划''';
		ELSE v_where := 'AND plan.PLAN_TYPE = ''项目主项计划''';

	END IF;
	--超期任务
    v_beyondtask_sql:=	'SELECT COUNT( * ) FROM POM_PROJ_PLAN_NODE node LEFT JOIN
    POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
    LEFT JOIN sys_project_stage    c ON c.id = plan.proj_id
    LEFT JOIN sys_project          d ON d.id = c.project_id
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    on (case when c.id is not null then c.PROJECT_ID else plan.proj_id end)=tal.orgId
    OR node.company_id=tal.orgId OR node.DUTY_DEPARTMENT_ID=tal.orgId
    WHERE tal.orgId is not null AND plan.APPROVAL_STATUS=''已审核'' AND node.PLAN_END_DATE IS NOT NULL
    AND ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE ' ||v_where;
    EXECUTE IMMEDIATE  v_beyondtask_sql into beyondtask;
	--今日待办
	 v_todotodaytask_sql:='SELECT COUNT( * ) FROM POM_PROJ_PLAN_NODE node LEFT JOIN
	 POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
     LEFT JOIN sys_project_stage    c ON c.id = plan.proj_id
    LEFT JOIN sys_project          d ON d.id = c.project_id
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    on (case when c.id is not null then c.PROJECT_ID else plan.proj_id end)=tal.orgId
    OR node.company_id=tal.orgId OR node.DUTY_DEPARTMENT_ID=tal.orgId
     WHERE tal.orgId is not null AND plan.APPROVAL_STATUS=''已审核'' AND node.PLAN_END_DATE IS NOT NULL
     AND ACTUAL_END_DATE IS NULL AND TO_CHAR(SYSDATE,''yyyy-MM-dd'') = TO_CHAR(node.PLAN_END_DATE,''yyyy-MM-dd'') ' || v_where;
--     dbms_output.put_line(v_where);
--     dbms_output.put_line(v_completedtodaytask_sql);
     EXECUTE IMMEDIATE  v_todotodaytask_sql into todotodaytask;
	--今日完成
	v_completedtodaytask_sql:='SELECT COUNT( * ) FROM POM_PROJ_PLAN_NODE node LEFT JOIN
    POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
    LEFT JOIN sys_project_stage    c ON c.id = plan.proj_id
    LEFT JOIN sys_project          d ON d.id = c.project_id
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    on (case when c.id is not null then c.PROJECT_ID else plan.proj_id end)=tal.orgId
    OR node.company_id=tal.orgId OR node.DUTY_DEPARTMENT_ID=tal.orgId
    WHERE tal.orgId is not null AND plan.APPROVAL_STATUS=''已审核''
	AND	TO_CHAR(SYSDATE,''yyyy-MM-dd'') = TO_CHAR(node.ACTUAL_END_DATE,''yyyy-MM-dd'') ' || v_where;
    EXECUTE IMMEDIATE  v_completedtodaytask_sql into completedtodaytask;
--    dbms_output.put_line(v_where);

END P_POM_PLAN_MONITOR_TASK_COUNT;



/
--------------------------------------------------------
--  DDL for Procedure P_POM_PLAN_MONITOR_TASK_LIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_PLAN_MONITOR_TASK_LIST" (
    plantype    IN          VARCHAR2, --输入变量：计划类型
    tabtype     IN          VARCHAR2, --输入变量：查询类型//超期任务、今日待办、 今日完成
    pageIndex   IN          VARCHAR2,
    pageRows    IN          VARCHAR2,
    currentcompanyid   IN                 VARCHAR2,--当前用户的公司
    userid             IN                 VARCHAR2,--用户id用于过滤关注的任务
    currentstationid   IN                 VARCHAR2,---当前用户的岗位
    currentdeptid      IN                 VARCHAR2,---当前用户的部门
    bizcode            IN                 VARCHAR2,---权限code
    items       OUT         SYS_REFCURSOR
) IS
    v_whre              CLOB;
    v_sql_exec          CLOB;
    nodestatus          VARCHAR2(20);
    v_nodeTime          CLOB;
    v_sql_exec_paging   CLOB;
    v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN
    --调用数据权限验证存储过程
    p_sys_auth_data_rule_spid(userid => userid, stationid => currentstationid, deptid => currentdeptid, companyid => currentcompanyid
    , bizcode => bizcode, data_auth_spid => v_spid);

    IF tabtype = '超期任务' THEN
        v_whre := ' AND ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE AND plan.PLAN_TYPE ='''
                  || plantype
                  || '''';
        v_nodeTime:='TO_CHAR(node.PLAN_END_DATE,''yyyy-mm-dd'') AS "nodeTime"';
        nodestatus := '已超期';
    ELSIF tabtype = '今日待办' THEN
        v_whre := 'AND ACTUAL_END_DATE IS NULL AND TO_CHAR(SYSDATE,''yyyy-MM-dd'') = TO_CHAR(node.PLAN_END_DATE,''yyyy-MM-dd'') AND plan.PLAN_TYPE ='''
                  || plantype
                  || '''';
        v_nodeTime:='TO_CHAR(node.PLAN_END_DATE,''yyyy-mm-dd'') AS "nodeTime"';
        nodestatus := '未完成';
    ELSE
        v_whre := 'AND TO_CHAR(SYSDATE,''yyyy-MM-dd'') = TO_CHAR(node.ACTUAL_END_DATE,''yyyy-MM-dd'')  AND plan.PLAN_TYPE ='''
                  || plantype
                  || '''';
        v_nodeTime:='TO_CHAR(node.ACTUAL_END_DATE,''yyyy-mm-dd'') AS "nodeTime"';
        nodestatus := '已完成';
    END IF;

    v_sql_exec := ' SELECT
    rownum as rowno,
	node.id AS "nodeId",
	node.ORIGINAL_NODE_ID AS "nodeOriginalId",
	--plan.plan_name,
	'''
                  || nodestatus
                  || ''' AS "nodeStatus",
	(node.node_name || ''【'' || stage.STAGE_FULL_NAME || ''】'') AS "nodeName",
    plan.plan_type as "nodePlanType",
	'||v_nodeTime||'

    FROM
	pom_proj_plan_node node
	LEFT JOIN pom_proj_plan plan ON node.proj_plan_id = plan.id
    LEFT JOIN SYS_PROJECT_STAGE stage on plan.proj_id=stage.id
    LEFT JOIN SYS_PROJECT proj
    on (case when stage.id is not null then stage.ID else plan.proj_id end)=proj.id
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    ON (case when stage.id is not null then stage.PROJECT_ID else plan.proj_id end)=tal.orgId
    OR node.company_id=tal.orgId OR node.DUTY_DEPARTMENT_ID=tal.orgId
   where plan.ID is not null and tal.orgId is not null and  plan.APPROVAL_STATUS=''已审核'''
                  || v_whre||'';
    v_sql_exec_paging := '
select a.* from ( '
                         || v_sql_exec
                         || ' and rownum <= '
                         || pageIndex * pageRows
                         || '  ORDER BY node.plan_end_date desc) a where a.rowno > '
                         || pageRows * ( pageIndex - 1 )
                         || '';

    dbms_output.put_line(v_sql_exec_paging);
    OPEN items FOR v_sql_exec_paging;

END p_pom_plan_monitor_task_list;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_PLAN_PERFROM_DYNAMIC
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_PLAN_PERFROM_DYNAMIC" 
(
		IN_ORG_ID    IN VARCHAR2
	 ,DATASCOPE    IN VARCHAR2
	 ,IN_PLAN_TYPE IN VARCHAR2
	 ,IN_PROJID    IN VARCHAR2
	 ,PAGEINDEX    IN INT
	 ,PAGESIZES    IN INT
	 ,P_PAGETYPE   IN INT
	 ,ITEMS        OUT SYS_REFCURSOR
	 ,TOTAL        OUT INT
) AS
		--传入的参数有三个，1：IN_ORG_ID（公司ID）
		--，2：DATASCOPE（统计期间，3个值“THIS_MONTH、THIS_QUARTER、THIS_YEAR"）
		--，3：PLAN_TYPE（计划类型，预留，估计后面会用的到）
		--，4：P_PAGETYPE（页面类型：1：已延误 2：已完成 3：应完成）//alterby 李小聪
		--关键节点计划-执行动态查询（wangck需要）
		--作者：陈丽
		--日期：2019/12/07
		CURSOR CUR_COMPANY_LIST(V_ORG_ID SYS_BUSINESS_UNIT.ID%TYPE) IS
				SELECT P.ID, P.PARENT_ID, P.ORG_NAME FROM SYS_BUSINESS_UNIT P WHERE P.IS_COMPANY = 1 START WITH P.ID = V_ORG_ID CONNECT BY PRIOR P.ID = P.PARENT_ID;
		V_SQL_TOTAL     CLOB := ' ';
		V_SQL           CLOB := ' ';
		V_SQL_DATASCOPE CLOB := ' ';
		V_COMPANY_LIST  CLOB := ' ';
BEGIN

		DBMS_OUTPUT.PUT_LINE('开始');
		--月度
		--已延误
		IF DATASCOPE = 'thisMonth'
			 AND P_PAGETYPE = 1
		THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL   AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';
				--月度
				--已完成
		ELSIF DATASCOPE = 'thisMonth'
					AND P_PAGETYPE = 2
		THEN
				V_SQL_DATASCOPE := ' AND  PN.ACTUAL_END_DATE IS  NOT NULL  AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';

				--月度
				--应完成

		ELSIF DATASCOPE = 'thisMonth'
					AND P_PAGETYPE = 3
		THEN
				V_SQL_DATASCOPE := 'AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';

				--季度
				--已延误
		ELSIF DATASCOPE = 'thisQuarter'
					AND P_PAGETYPE = 1
		THEN
				V_SQL_DATASCOPE := ' AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL    AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((  SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((  SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
				--季度
				--已完成
		ELSIF DATASCOPE = 'thisQuarter'
					AND P_PAGETYPE = 2
		THEN
				V_SQL_DATASCOPE := 'AND  PN.ACTUAL_END_DATE IS  NOT NULL AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((  SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((  SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
				--季度
				--季度应完成
		ELSIF DATASCOPE = 'thisQuarter'
					AND P_PAGETYPE = 3
		THEN
				V_SQL_DATASCOPE := '  AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((  SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((  SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
				--年度
				--已延误
		ELSIF DATASCOPE = 'thisYear'
					AND P_PAGETYPE = 1
		THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL  
			 AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) ';
				--年度
				--已完成
		ELSIF DATASCOPE = 'thisYear'
					AND P_PAGETYPE = 2
		THEN
				V_SQL_DATASCOPE := 'AND  PN.ACTUAL_END_DATE IS  NOT NULL  
				 AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH)  ';
				--年度
				--应完成
		ELSIF DATASCOPE = 'thisYear'
					AND P_PAGETYPE = 3
		THEN
				V_SQL_DATASCOPE := ' AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) ';
				--全部，没有时间限
				--已延误
		ELSIF DATASCOPE = 'thisAll'
					AND P_PAGETYPE = 1
		THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL ';
				--计划所有节点
		ELSIF DATASCOPE = 'thisAll'
					AND P_PAGETYPE = 2
		THEN
				V_SQL_DATASCOPE := ' AND   1=1 ';



		END IF;

		FOR ITEM_COMPANY_LIST IN CUR_COMPANY_LIST(IN_ORG_ID)
		LOOP
				/*DBMS_OUTPUT.PUT_LINE(ITEM_COMPANY_LIST.ORG_NAME || ',PARENT_ID' ||
        ITEM_COMPANY_LIST.PARENT_ID || ',ID:' ||
        ITEM_COMPANY_LIST.ID);*/
				V_COMPANY_LIST := V_COMPANY_LIST || '''' || ITEM_COMPANY_LIST.ID || '''' || ',';
		END LOOP;
		--   dbms_output.put_line(V_COMPANY_LIST);
		V_COMPANY_LIST := '(' || SUBSTR(V_COMPANY_LIST, 1, LENGTH(V_COMPANY_LIST) - 1) || ')';
		--     dbms_output.put_line(V_COMPANY_LIST);
		IF V_COMPANY_LIST = '()'
		THEN
				V_COMPANY_LIST := '(''' || IN_ORG_ID || ''')';
		END IF;
		--   dbms_output.put_line(V_COMPANY_LIST);
		V_SQL := V_SQL || 'SELECT PP.COMPANY_ID, PP.COMPANY_NAME AS COMPANY_NAME,PP.PROJ_name AS PROJ_NAME,PP.PLAN_NAME AS PLAN_NAME, PN.ID,PN.PROJ_PLAN_ID,PN.ORIGINAL_NODE_ID,CASE WHEN PN.IS_DISABLE = 0 THEN  PN.NODE_NAME ELSE  ''【禁用】'' || PN.NODE_NAME END AS NODE_NAME, PN.NODE_CODE, PN.NODE_LEVEL, PN.PROJ_STAGE, PN.MAIN_RESPONSIBILITY, PN.DUTY_DEPARTMENT, TO_CHAR(PN.PLAN_START_DATE, ''yyyy-MM-dd'') AS PLAN_START_DATE, TO_CHAR(PN.PLAN_END_DATE, ''yyyy-MM-dd'') AS PLAN_END_DATE, PN.IS_DISABLE, PN.COMPLETION_STANDARD, PN.COMPLETION_RESULTS_REMARK, TO_CHAR(PN.ACTUAL_END_DATE, ''yyyy-MM-dd'') AS ACTUAL_END_DATE
	, case 
 --未到期不亮灯
 WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
 --到期当天内完成反馈
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
 then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
	--到期1-5天内完成反馈
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
 then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
 --到期未反馈黄灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE)) >0
 THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>'' 
	--到期超过5天未反馈红灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(PLAN_END_DATE)) >5) THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' 
 ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END
	AS PLAN_STATUS,PN.ESTIMATE_END_DATE,  nps.CHARGE_PERSON
	FROM  pom_proj_plan_node pn 
LEFT JOIN pom_proj_plan pp ON pn.proj_plan_id = pp.id 
LEFT JOIN  SYS_PROJECT_STAGE ps on  ps.id=pp.proj_id
LEFT JOIN SYS_PROJECT pj on  ps.PROJECT_ID =pj.id
LEFT JOIN(  SELECT  NODE_ID, listagg(CHARGE_PERSON,'','') WITHIN GROUP (ORDER BY CHARGE_PERSON )  as CHARGE_PERSON
	FROM POM_NODE_CHARGE_PERSON 
	GROUP BY NODE_ID) nps on  nps.NODE_ID=pn.id
	WHERE  PP.PLAN_TYPE = ''项目主项计划''  AND APPROVAL_STATUS = ''已审核'' AND 1=1 AND PN.IS_DISABLE = 0 
	and  ((pp.proj_id =''' || IN_PROJID || ''' or pn.proj_plan_id=''' || IN_PROJID || '''  OR  pj.id=''' || IN_PROJID || ''' )
	OR PP.COMPANY_ID IN ' || V_COMPANY_LIST || ' ) ' || V_SQL_DATASCOPE || '  ORDER BY PN.PROJ_PLAN_ID,  PN.NODE_CODE';

		DBMS_OUTPUT.PUT_LINE(V_SQL);
		V_SQL_TOTAL := V_SQL_TOTAL || 'SELECT  TO_CHAR(COUNT(pn.ID))
	FROM  pom_proj_plan_node pn 
LEFT JOIN pom_proj_plan pp ON pn.proj_plan_id = pp.id 
LEFT JOIN  SYS_PROJECT_STAGE ps on  ps.id=pp.proj_id
LEFT JOIN SYS_PROJECT pj on  ps.PROJECT_ID =pj.id
LEFT JOIN(  SELECT  NODE_ID, listagg(CHARGE_PERSON,'','') WITHIN GROUP (ORDER BY CHARGE_PERSON )  as CHARGE_PERSON
	FROM POM_NODE_CHARGE_PERSON 
	GROUP BY NODE_ID) nps on  nps.NODE_ID=pn.id
	WHERE  PP.PLAN_TYPE = ''项目主项计划''  AND APPROVAL_STATUS = ''已审核'' AND 1=1 
	and  ((pp.proj_id =''' || IN_PROJID || ''' or pn.proj_plan_id=''' || IN_PROJID || '''  OR  pj.id=''' || IN_PROJID || ''' )
	OR PP.COMPANY_ID IN ' || V_COMPANY_LIST || ' ) ' || V_SQL_DATASCOPE || '  ORDER BY PN.PROJ_PLAN_ID,  PN.NODE_CODE';

		--DBMS_OUTPUT.PUT_LINE(V_SQL_TOTAL);
		EXECUTE IMMEDIATE V_SQL_TOTAL
				INTO TOTAL;
		--   DBMS_OUTPUT.PUT_LINE(TOTAL);
		OPEN ITEMS FOR V_SQL;
END P_POM_PLAN_PERFROM_DYNAMIC;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_PMP_NODE_COMP_RATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_PMP_NODE_COMP_RATE" (
     tabType VARCHAR2,
     planType VARCHAR2,
     companyId VARCHAR2,
     nodeLevel VARCHAR2,
     currentcompanyid   IN                 VARCHAR2,--当前用户的公司
     userid             IN                 VARCHAR2,--用户id用于过滤关注的任务
     currentstationid   IN                 VARCHAR2,---当前用户的岗位
     currentdeptid      IN                 VARCHAR2,---当前用户的部门
     bizcode            IN                 VARCHAR2,---权限code
     pageRows INTEGER,
     pageIndex INTEGER,
     nodeList  OUT SYS_REFCURSOR
) IS 
v_condition varchar2(4000);
v_sql clob;
v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN 
v_condition:= ' AND 1=1';
IF(tabType is not null) THEN
    IF(tabType='超期任务')
        then  v_condition:=' and to_char(node.plan_end_date, ''yyyy-MM-dd'') <  to_char(sysdate, ''yyyy-MM-dd'') and node.actual_end_date is null order by node.plan_end_date desc'; 
    ELSIF(tabType='已完成')
        then  v_condition:=' and node.actual_end_date is not null order by node.actual_end_date desc'; 
    END IF;
END IF;

--调用数据权限验证存储过程
    p_sys_auth_data_rule_spid(userid => userid, stationid => currentstationid, deptid => currentdeptid, companyid => currentcompanyid
    , bizcode => bizcode, data_auth_spid => v_spid);

v_sql:='SELECT *
  FROM (SELECT tt.*, ROWNUM AS rowno
    FROM (  
        select 
            node.id as "nodeId",
            node.original_node_id as "nodeOriginalId",
            node.node_name||''【''|| nvl(proj.project_name, projs.stage_full_name)  ||''】''  as "nodeName",
			plan.plan_type as "nodePlanType",
            case 
                when '''||tabType||'''=''超期任务'' then to_char(node.plan_end_date, ''yyyy-MM-dd'')
                when '''||tabType||'''=''已完成'' then to_char(node.actual_end_date, ''yyyy-MM-dd'')
            end  as "nodeTime",
            case 
                when (to_char(node.plan_end_date, ''yyyy-MM-dd'') <  to_char(sysdate, ''yyyy-MM-dd'') and node.actual_end_date is null) then ''已超期''
                when (node.actual_end_date is not null) then ''已完成''
            end  as "nodeStatus"
        from pom_proj_plan_node node
        left join pom_proj_plan plan on node.proj_plan_id = plan.id
        left join sys_project proj on plan.proj_id = proj.id 
        left join sys_project_stage projs on plan.proj_id = projs.id
        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=proj.id or tal.orgid=plan.company_id or tal.orgid = projs.id
        where tal.orgid is not null and  plan_type='''||planType||''' and plan.company_id in (select id from sys_business_unit unit start with unit.id='''||companyId||''' connect by prior unit.id=unit.parent_id) and node.node_level = '''||nodeLevel||''' and plan.approval_status = ''已审核'''||v_condition||') tt
    WHERE ROWNUM <= '||pageRows||' * '||pageIndex||') table_alias
 WHERE table_alias.rowno >= '||pageRows||' * ('||pageIndex||'-1) + 1';
--dbms_output.put_line(v_sql);
open nodeList for v_sql;

END P_POM_PMP_NODE_COMP_RATE;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_PORTAL_ALREADY_MSG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_PORTAL_ALREADY_MSG" (
    bizid  in varchar2,
    info     OUT      SYS_REFCURSOR--消息集合
) IS
--门户推送数据，发送微信、短信消息记录获取
--作者：陈丽
--日期：2020/02/13
BEGIN
    OPEN info FOR SELECT
                ------------------------------------------------------------基础必须信息             
                      '71313f018a35f3a558166cba7599b5d6' AS "systemId",--系统id
                      'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "appid",--应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段，
                 ------------------------------------------------------------业务变动必须信息   
                      'bizid' AS "bizKey",--业务id
                       'tjWeChat,tjSMS' AS "msgChannel",--使用消息渠道 多个，逗号分隔   tjWeChat：铁建微信,tjSMS：铁建短信
                     ------------------------------------------------------------短信必须参数
                      '40010' AS "smsTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID
                      '["1","2","3","4"]' AS "smsParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》说明{1}为您的登录验证码，请于{2}分钟内填写，如非本人操作，请忽略本短信。
                      '13896186104' as "mobile",--短信接收人电话
                      ------------------------------------------------------------微信必须参数
                      '40011' AS "wechatTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID
                      '["1","2","3","4"]' AS "wechatParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》说明{1}为您的登录验证码，请于{2}分钟内填写，如非本人操作，请忽略本短信。
                       '///' AS "wechatJumplinkUrl",--微信打开地址，程序调用发消息前需要编码
                      'v-xufeng' AS "recipientAccount",--接收人usercode如：a-xiexuhua
                 ------------------------------------------------------------消息记录方追溯信息
                       '部门月度计划流程预警' AS "title",--消息标题
                      'v-xufeng' AS "senderAccount",--发送人usercode如：a-xiexuhua
                      '月度计划' AS "bizSourceCategory",--业务所属类别=》 （由业务系统自定义，方便根据业务回溯，同一类别下有很多个类似业务，如月度计划）
                      '预警消息' AS "bizMsgCategory"--消息所属类别=》 （由业务系统自定义，方便根据业务回溯，同一业务主键，有多个分类，如预警消息，提醒消息）
                  FROM
                      dual;

END p_pom_portal_already_msg;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_PORTAL_MSG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_PORTAL_MSG" (
    messagetype   OUT           VARCHAR2,     --0:门户终端消息都推送，1：只推送门户，2：只推送短信或微信
    info          OUT           SYS_REFCURSOR--消息集合
) IS
BEGIN
    messagetype := 0;
    OPEN info FOR
    
--    --超期任务提醒
--				SELECT 0 AS "msgType", A.ORIGINAL_NODE_ID AS "taskId", B1.USER_ACCOUNT AS "ownerName", 'v-xufeng' AS "creatorName",
--							 'http://pom.crccre.cn/pom/pom/middle?originalUrl=' ||
--								URL_ENCODE('http://pom.crccre.cn/pom/pom/mission-center-feedback/my-responsible-task?cancelType=0' || CHR(38) || 'id=' || A.PROJ_PLAN_ID || CHR(38) || 'feedbackNodeId=' || A.ID ||
--													 CHR(38) || 'feedbackNodeOriginalId=' || A.ORIGINAL_NODE_ID || CHR(38) || 'nodeSourcePlanType=1') AS "pcUrl", '' AS "mobileUrl", SYSDATE AS "created",
--							 TRUNC(SYSDATE) + 1 AS "expireTime", '【节点超期预警】【' || A.PROJ_NAME || '-' || A.PLAN_TYPE || '-' || A.NODE_NAME || '】超期' || TO_CHAR(TRUNC(SYSDATE) - A.PLAN_END_DATE) || '天预警' AS "taskName",
--							 '计划运营' AS "typeName",1 AS "priority", '' AS "remark"
--, 'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "sourceAppId",meg.MESSAGE_MSG_TYPE AS "messageMsgType"
--				FROM   V_POM_NODE_DT A
--				LEFT   JOIN SYS_ROLE_USER_RELATION_RESULT B1
--				ON     B1.DEPT_ID = A.DUTY_DEPARTMENT_ID AND
--							 B1.VIRTUAL_GROUP_NAME = '部门计划专员'
--				LEFT JOIN SYS_MESSAGE_CENTER meg
--				ON meg.TASK_ID=A.id AND meg.CREATED-SYSDATE=0
--				WHERE  A.FINISH_NO_STATUS_TYPE = '超期未完成' AND
--							 NOT EXISTS (SELECT 1
--								FROM   SYS_MESSAGE_CENTER_PUSH_RECORD P
--								WHERE  P.RESPONSE_RESULTS LIKE '%{"errcode":0%' AND
--											 TRUNC(SYSDATE) - TRUNC(P.REQUEST_TIME) = 0 AND
--											 A.ID = P.TASK_ID AND
--											 B1.USER_ACCOUNT = P.OWNER_NAME) AND
--							 B1.USER_ACCOUNT IS NOT NULL AND b1.USER_ACCOUNT = 'zhangzhuohan';

     SELECT
            ------------------------------------------------------------基础配置数据【必须】（集团门户网站和设备消息都必须配置）------------------------------------------------------------ 
                      'v-xufeng'   AS "senderAccount",--发送人usercode如：a-xiexuhua,---门户网站的creatorName
                      B1.USER_ACCOUNT       AS "recipientAccount",--接收人usercode如：a-xiexuhua--门户网站的ownerName
                      'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "appid",--应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段---门户网站的sourceAppId
                      '71313f018a35f3a558166cba7599b5d6' AS "systemId",--系统id
                      A.ORIGINAL_NODE_ID||B1.USER_ACCOUNT   AS "bizKey",--业务id--门户网站的taskId
                      '超期预警' AS "bizMsgCategory",--消息所属类别=》 （由业务系统自定义，方便根据业务回溯，同一业务主键，有多个分类，如预警消息，提醒消息）
            ------------------------------------------------------------设备消息配置开始------------------------------------------------------------ 
            ------------------------------------------------------------【短信微信必须】基础信息
                      'tjSMS,tjWeChat' AS "msgChannel",--使用消息渠道 多个，逗号分隔   tjWeChat：铁建微信,tjSMS：铁建短信
                        ------------【短信必须】参数
                      '400013' AS "smsTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID  
                      --{1}您好，您负责的任务“{2}”已超期{3}天，请及时到门户网站查看待办并在《计划管理系统》中反馈任务进度{4}。
                      '["'
                      || B1.USER_NAME
                      || '","'
                      || A.PROJ_NAME || '-' || A.PLAN_TYPE || '-' || A.NODE_NAME
                      || '","'
                      || TO_CHAR(TRUNC(SYSDATE) - A.PLAN_END_DATE) 
                      || '",""]' AS "smsParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
                      MOBILE_PHONE   AS "mobile",--短信接收人电话
                        ------------【微信必须】参数
                      '400013' AS "wechatTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID
                      '["'
                      || B1.USER_NAME
                      || '","'
                      || A.PROJ_NAME || '-' || A.PLAN_TYPE || '-' || A.NODE_NAME
                      || '","'
                      || TO_CHAR(TRUNC(SYSDATE) - A.PLAN_END_DATE) 
                      || '",""]' AS "wechatParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
                      'http://pom.crccre.cn/pom/wfi/bridge?jumpUrl=http%3a%2f%2fpom.crccre.cn%2fpom-h5%2fwfi%2fhow-to-read%3FinformationId%3D1786238shizebin%26bizUrl%3D'
                      || url_encode('http://pom.crccre.cn/pom-h5/pom/task-details?feedbackNodeId='||A.ORIGINAL_NODE_ID||'%26nodeSourcePlanType=KEY_NODE%26feedbackNodeOriginalId='||A.ORIGINAL_NODE_ID||'')||'&remoteUrl=aHR0cDovL3BvbS5jcmNjcmUuY24vcG9t'  AS "wechatJumplinkUrl",--微信打开地址，程序调用发消息前需要编码
                        ------------消息记录方便追溯信息
                      '【节点超期预警】【' || A.PROJ_NAME || '-' || A.PLAN_TYPE || '-' || A.NODE_NAME || '】超期' || TO_CHAR(TRUNC(SYSDATE) - A.PLAN_END_DATE) || '天预警' AS "title",--消息标题
                      '【节点超期预警】【' || A.PROJ_NAME || '-' || A.PLAN_TYPE || '-' || A.NODE_NAME || '】超期' || TO_CHAR(TRUNC(SYSDATE) - A.PLAN_END_DATE) || '天预警' AS "bizSourceCategory",--业务所属类别=》 （由业务系统自定义，方便根据业务回溯，同一类别下有很多个类似业务，如月度计划）
            ------------------------------------------------------------设备消息配置结束------------------------------------------------------------ 
            ------------------------------------------------------------集团门户网站信息------------------------------------------------------------ 
                --taskid	是	String	任务ID---------------------共有门户网站的1、插入待办/2、插入已办taskid，3、插入待阅/4、插入已阅informationid，5、插入我的关注的informationid
                --creatorname	是	String	创建人
                --ownername	是	String	拥有人
                --sourceAppId	是	String	推送应用的appId
                      0 "portalMsgType", --集团门户网站消息类型（0：待办,1:已办，10：待阅，11:已阅，20：关注）--已办，需要先根据bizKey删除待办，已阅接口需要根据bizKey调用集团待阅删除接口
                      'http://pom.crccre.cn/pom/pom/middle?originalUrl=' ||
								URL_ENCODE('http://pom.crccre.cn/pom/pom/mission-center-feedback/my-responsible-task?cancelType=0' || CHR(38) || 'id=' || A.PROJ_PLAN_ID || CHR(38) || 'feedbackNodeId=' || A.ID ||
													 CHR(38) || 'feedbackNodeOriginalId=' || A.ORIGINAL_NODE_ID || CHR(38) || 'nodeSourcePlanType=1') "url",--url	是	String	应用系统的url地址
                    --http://pom.crccre.cn/pom/wfi/bridge?jumpUrl=http%3A%2F%2Fpom.crccre.cn%2Fpom-h5%2Fwfi%2Fhow-to-read%3FinformationId%3D1786238shizebin%26bizUrl%3Dhttp%253A%252F%252Fpom.crccre.cn%252Fpom-h5%252Fwfi%252Fprocess-info%253FrootProcInstId%253D288110%2526item_id%253Dd6c370aa-ddd6-40b9-95de-6fc25fdef1f0%2526actInstID%253D1990892%2526procInstId%253D288110%2526workItemId%253D1786238&remoteUrl=aHR0cDovL3BvbS5jcmNjcmUuY24vcG9t
                      'http://pom.crccre.cn/pom/wfi/bridge?jumpUrl=http%3a%2f%2fpom.crccre.cn%2fpom-h5%2fwfi%2fhow-to-read%3FinformationId%3D1786238shizebin%26bizUrl%3D'
                      || url_encode('http://pom.crccre.cn/pom-h5/pom/task-details?feedbackNodeId='||A.ORIGINAL_NODE_ID||'%26nodeSourcePlanType=KEY_NODE%26feedbackNodeOriginalId='||A.ORIGINAL_NODE_ID||'')||'&remoteUrl=aHR0cDovL3BvbS5jcmNjcmUuY24vcG9t' as "mobileUrl",--mobileUrl	否	String	应用系统的手机端url地址
                       '【节点超期预警】【' || A.PROJ_NAME || '-' || A.PLAN_TYPE || '-' || A.NODE_NAME || '】超期' || TO_CHAR(TRUNC(SYSDATE) - A.PLAN_END_DATE) || '天预警' as "taskname",--taskname	是	String	任务名称，等于3、插入待阅/4、插入已阅informationname;等于插入关注的attentionname
                      '计划运营' "typename",--typename	是	String	任务类型
                      A.ORIGINAL_NODE_ID||B1.USER_ACCOUNT         "remark",--remark	否	String	备注

              ----------------------------------------------
              -----除【关注外特有】
                      SYSDATE          "expiretime",--expiretime	否	String	过期时间，格式yyyy-MM-dd HH:mm:ss-----过期时间，除关注都有
                      1 "priority"--priority	否	Integer	优先级，除关注都有
                      FROM   V_POM_NODE_DT A
				LEFT   JOIN SYS_ROLE_USER_RELATION_RESULT B1
				ON     B1.DEPT_ID = A.DUTY_DEPARTMENT_ID AND
							 B1.VIRTUAL_GROUP_NAME = '部门计划专员'
				LEFT JOIN SYS_MESSAGE_CENTER meg
				ON meg.TASK_ID=A.id AND meg.CREATED-SYSDATE=0
                left join sys_user u on  B1.USER_ACCOUNT=u.USER_CODE
				WHERE  A.FINISH_NO_STATUS_TYPE = '超期未完成' AND
							 NOT EXISTS (SELECT 1
								FROM   SYS_MESSAGE_CENTER_PUSH_RECORD P
								WHERE  P.RESPONSE_RESULTS LIKE '%{"errcode":0%' AND
											 TRUNC(SYSDATE) - TRUNC(P.REQUEST_TIME) = 0 AND
											 A.ID = P.TASK_ID AND
											 B1.USER_ACCOUNT = P.OWNER_NAME)
                                             AND
							 B1.USER_ACCOUNT IS NOT NULL 
                             --AND b1.USER_ACCOUNT = 'zhangzhuohan'
                             ;

END p_pom_portal_msg;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_PREDICT_DELAY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_PREDICT_DELAY" (planType in VARCHAR2
,dataScope in VARCHAR2
,searchKey in VARCHAR2
,orgId  in VARCHAR2
,currentDelay OUT sys_refcursor)
AS
BEGIN
open currentDelay for
SELECT
    p.COMPANY_NAME as  "orgName",
    proj_name as "projName",
    node_name as "nodeName",
    '' as "projOpenUrl",
    '' as "nodeOpenUrl",
    ROUND(TO_NUMBER(plan_end_date-sysdate)) as "delayDays"
FROM
    pom_proj_plan_node n
    left join
    pom_proj_plan p  on  n.proj_plan_id=p.id where proj_name is not null;


END p_pom_predict_delay;




/
--------------------------------------------------------
--  DDL for Procedure P_POM_PROJ_BY_KEY_NODE_PLAN
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_PROJ_BY_KEY_NODE_PLAN" 
(
    companyGUID IN VARCHAR2,
    USERID VARCHAR2,
    STATIONID VARCHAR2,
    DEPTID VARCHAR2,
    COMPANYID VARCHAR2,
    items OUT SYS_REFCURSOR
)IS
    v_sql clob;
    v_id varchar2(100);
    --当前日期
    nowdate date:=trunc(sysdate);
    BIZCODE VARCHAR2(200):='POM.JHJKYKHPH.01';
    DATA_AUTH_SPID VARCHAR2(200);
BEGIN
    IF companyGUID IS NULL THEN
        v_id := '003200000000000000000000000000';
    ELSE
        v_id := companyGUID;
    END IF;

    DECLARE


BEGIN
  P_SYS_GET_COMPANY_PROJ_SPID(
    USERID => USERID,
    STATIONID => STATIONID,
    DEPTID => DEPTID,
    COMPANYID => COMPANYID,
    BIZCODE => BIZCODE,
    DATA_AUTH_SPID => DATA_AUTH_SPID
  );
END;

     open items for   
    WITH
     分期 as(
     select  case when 总分期数量=0 then get_uuid else ps.id end as id,ps.STAGE_NAME,ps.PROJECT_ID,proj.PROJECT_NAME,UNIT_ID,to_char(ps.sn,'0.0') as sn
     ,case when 无分期数量=1 and 总分期数量=1 then 1 else 0 end 是无分期 
     from SYS_PROJECT_STAGE ps
     left join SYS_PROJECT proj on ps.PROJECT_ID=proj.id
     left join (select PROJECT_ID,sum(case when STAGE_NAME='无分期' then 1 else 0 end) as 无分期数量,count(PROJECT_ID) as 总分期数量 from SYS_PROJECT_STAGE group by PROJECT_ID)  pcount
     on proj.id=pcount.PROJECT_ID
     )
    ,basedata AS(
    ---查询已审核的分期 关键节点计划 基础信息
   select 
   plan.PROJ_ID
   from  POM_PROJ_PLAN_NODE node
   left join POM_PROJ_PLAN plan on node.PROJ_PLAN_ID=plan.id
   --- 未考虑一个节点重复考核情况
   left join POM_NODE_EXAMINATION nodee on node.ORIGINAL_NODE_ID=nodee.ORIGINAL_NODE_ID

   ---已审核、关键节点计划、未禁用节点
   where plan.APPROVAL_STATUS='已审核' 
   and plan.PLAN_TYPE='关键节点计划'
   and node.id is not null
   and node.IS_DISABLE=0
   and node.IS_DELETE=0
   group by plan.PROJ_ID )


   ,项目_分期 as(
   select case when 分期.是无分期=1 then 分期.PROJECT_ID else 分期.id end as id
   ,case when 分期.是无分期=1 then 分期.PROJECT_NAME else 分期.PROJECT_NAME||'-'||分期.STAGE_NAME end as name 
    --统计的父级字段处理，无分期项目父级是公司，有分期项目父级是项目
   ,case when 分期.是无分期=1 then 分期.UNIT_ID else PROJECT_ID end parent_id
   ,分期.UNIT_ID
   ,分期.sn
   from basedata
   left join 分期 on basedata.PROJ_ID=分期.id
   union all 
   select proj.id
   ,proj.project_name as name
   ,proj.UNIT_ID  as parent_id
   ,proj.UNIT_ID
   ,proj.sn
   from (SELECT
       *
   FROM sys_project where id in( select PROJ_ID from basedata )) proj
   left join (select * from 分期 where 是无分期=1) s on proj.id=s.project_id
   where s.id is null 
   )

    select Id
   ,NAME
   ,PARENT_ID
   ,UNIT_ID
   ,sn FROM 项目_分期
  where UNIT_ID=v_id
  order by sn
   ;

END P_POM_PROJ_BY_KEY_NODE_PLAN;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_PROJ_PLAN_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_PROJ_PLAN_DATA" (
    condition     IN            VARCHAR2,--输入变量;项目或部门id   专项计划传入部门id 其他计划传入项目id
    companyid     IN            VARCHAR2,--当前用户公司
    stationid     IN            VARCHAR2,---当前用户的岗位
    deptid        IN            VARCHAR2,---当前用户的部门
    bizcode       IN            VARCHAR2,---权限code
    userid        IN            VARCHAR2,---当前用户id
    pageindex     IN            INT,
    search1       IN            VARCHAR2, --输入变量 查询条件
    pagesizes     IN            INT,
    currenttype   IN            INT,--
    plantype      IN            VARCHAR2, --计划类型
    items         OUT           SYS_REFCURSOR,
    total         OUT           INT
  --  tabledata          OUT           SYS_REFCURSOR
) IS
--专项计划，可研计划，全盘开发计划，项目主项计划列表配置
--作者：鲜晓勇
--日期：2019/12/11

--更改：纪海龙
--日期：2020/4/14

    v_sql              CLOB;
    v_sql_exec         CLOB;
    v_spid             VARCHAR2(200);---数据验证spid
    v_where            VARCHAR2(4000);
    testmsg            NVARCHAR2(4000);
    v_maintable        NVARCHAR2(100);
    v_subtable         NVARCHAR2(100);
    v_middlesql        VARCHAR2(4000);   --非专项计划使用。用于区分调整表与计划表字段差异的拼接
    v_middlesql2       VARCHAR2(4000);
    quarantine_rule   VARCHAR2(50) :='';
    v_auth_sql         VARCHAR2(4000) :=' where 1=1';
    v_isneed_proj      VARCHAR2(200);  --是否需要proj进行排序
    conpanys            NVARCHAR2(4000);

BEGIN
     OPEN items FOR select ''||companyid||'' as companyid,
    ''||stationid||'' as  stationid,
    ''||deptid||'' as  deptid,
     ''||condition||'' as  condition,
      ''||userid||'' as  userid
    from dual;

----------------------------------------------------统一解析
    testmsg := 'condition:'
               || condition
               || '；pageindex:'
               || pageindex
               || '；pagesizes:'
               || pagesizes
               || '；currenttype:'
               || currenttype;

    BEGIN
        total := 1000;


    --执行数据权限存储过程。拿到零时表id 用户连临时表鉴权
 --调用查询数据权限的存储过程,返回spid
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => stationid,
            DEPTID => deptid,
            COMPANYID => companyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
--        OPEN tabledata FOR select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = v_spid;
       -- OPEN tabledata FOR select * from SYS_PROJECT_STAGE sps   inner join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') ta on sps.project_id=ta.orgid;
        --拼接权限验证sql
        v_auth_sql:=' left join SYS_PROJECT_STAGE projs on pp.proj_id=projs.id
                    --关联权限表结果
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') org
                    on (case when projs.id is not null then projs.PROJECT_ID else pp.proj_id end)=org.orgId
                    --左连接权限字段为空表示没有权限
                    where org.orgId is not null ';
         -- v_auth_sql:=' inner join SYS_PROJECT_STAGE sps on pp.proj_id=sps.id inner join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') ta on sps.project_id=ta.orgid or pp.proj_id=ta.orgid where ta.orgid is not null ';

    IF ( plantype <> '专项计划' ) THEN
--      IF(quarantine_rule='集团')THEN
--        v_auth_sql:=v_auth_sql||' proj_id='''||companyid||'''';
--    END IF;

    --选择父级公司查找计划
    conpanys := 'select distinct sbu.id
    from SYS_BUSINESS_UNIT sbu
    where IS_COMPANY = 1
    start with sbu.id = '''|| condition ||'''
    connect by prior sbu.id = sbu.PARENT_ID';


    v_isneed_proj := ',a.proj_name';

    --项目主项计划，可研计划，标准节点计划，全盘开发计划
        IF ( currenttype = 0 ) THEN
    --当前使用版本
            v_maintable := 'POM_PROJ_PLAN ';
            v_subtable := 'POM_PROJ_PLAN_NODE';
            v_middlesql := ' ps.cnt1 as finish_count,
    ps.cnt2 as not_ebd_count,
    ps.cnt3 as template_node_count,
    ps.cnt4 as user_add_node_count,
    (case when ps.cnt8-ps.cnt7 >= 0 then ps.cnt8-ps.cnt7 else 0 end) as valid_node_count,
    (case when pp.plan_type = ''项目主项计划'' then ps.cnt8 else ps.cnt6 end) as node_count,
    ps.cnt7 as disable_count,'
            ;
            v_middlesql2 := ' left join(   select proj_plan_id,count(id) as numid,IS_DELETE,
    sum(case when n.ACTUAL_END_DATE is not null and n.IS_DISABLE=0 then 1  else 0 end) as cnt1, --已完成
    sum(case when n.ACTUAL_END_DATE is null and n.IS_DISABLE=0  then 1 else 0 end) as cnt2,--未完成
    sum(case when n.TEMPLATE_NODE_ID is not null then 1 else 0 end) as cnt3,--模板节点
    sum(case when n.STANDARD_NODE_ID is null and n.TEMPLATE_NODE_ID is null then 1 else 0 end) as cnt4,--新增节点
    sum(case when n.TEMPLATE_NODE_ID is not null then 1 else 0 end) + sum(case when n.STANDARD_NODE_ID is null and n.TEMPLATE_NODE_ID is null then 1 else 0 end) as cnt5,
    sum(case when n.IS_DISABLE = 0 then 1 else 0 end) as cnt6,--任务节点
    sum(case when n.IS_DISABLE=1 then 1 else 0 end) cnt7,
    count(*) as cnt8
    from '
                            || v_subtable
                            || '  n GROUP by proj_plan_id,IS_DELETE )ps on pp.id=ps.proj_plan_id '||v_auth_sql;


            v_where := ' and ps.IS_DELETE = 0 and
            (Approval_Status = ''已审核'' or (Approval_Status != ''已审核'' and plan_version =''1''))and plan_type='''
                       || plantype
                       || ''' and (plan_name like ''%'
                       || search1
                       || '%'' or creator like ''%'
                       || search1
                       || '%'')';
            IF(condition!='默认')THEN
               v_where:=v_where||' and COMPANY_ID in ( '
                       || conpanys
                       || ' ) ';
            END IF;
        ELSE
    --历史调整版本
            v_maintable := 'POM_PROJ_PLAN_HISTORY';
            v_subtable := 'POM_PROJ_PLAN_NODE_HISTORY';
            v_where := ' and COMPANY_ID in ( '
                       || conpanys
                       || ' ) and plan_type='''
                       || plantype
                       || ''' and (plan_name like ''%'
                       || search1
                       || '%'' or creator like ''%'
                       || search1
                       || '%'')';

            v_middlesql := ' (case when pp.plan_type = ''项目主项计划'' then ps.cnt8 else ps.cnt6 end) as node_count,';
    --暂时未查询 调整新增数量，调整修改数量，调整 禁用数量
            v_middlesql2 := ' left join(   select proj_plan_id,
    sum(case when n.IS_DISABLE = 0 then 1 else 0 end) as cnt6, --任务节点
    count(*) as cnt8,
    count(id) as numid
    from '
                            || v_subtable
                            || '  n WHERE IS_DISABLE = 0 GROUP by proj_plan_id )ps on pp.id=ps.proj_plan_id '||v_auth_sql;
        END IF;

        v_sql := 'SELECT
    pp.id as id,
    pp.original_plan_id,
    template_id,
    plan_name,
    plan_version,
     (''v'' || to_char(plan_version,''0.0'')) verson,
    company_id,
    company_name,
    proj_id,
    proj_name,
    plan_type,
    approval_status,
    approver_id,
    (case when approval_status = ''未审核'' then null else to_char(approval_time,''yyyy-MM-dd'') end) as approval_time,
    other_remark,
    to_char(created,''yyyy-MM-dd'') as created,
     case plan_version when plan_version then (plan_version-1) end as adjuest_Number,
    creator_id,
    creator,
    to_char(modified,''yyyy-MM-dd'') as modified,
    modifier_id,
    modifier,
    adjust_source_id,
    adjust_subject,
    adjust_remark,
    ps.numid as ADJUEST_NODE_COUNT,
    (case when plan_version = 1 then ps.numid else 
        ( select count(*) from POM_PROJ_PLAN_NODE_HISTORY ppnh where ppnh.proj_plan_id = (
            select pph.id from POM_PROJ_PLAN_HISTORY pph where pph.original_plan_id = pp.original_plan_id 
            and pph.plan_version = (
                select pph1.plan_version-1 from POM_PROJ_PLAN_HISTORY pph1 where pph1.id = 
                pp.id GROUP BY pph1.plan_version)) and ppnh.IS_DISABLE = 0 )
    end) as ADJUEST_BEFORE_NODE_COUNT,
    '
                 || v_middlesql
                 || ' approver FROM '
                 || v_maintable
                 || ' pp '
                 || v_middlesql2
                 || v_where
                 || '' ;

    ELSE
    --专项计划

        --选择父级公司查找计划
        conpanys := 'select distinct sbu.id
        from SYS_BUSINESS_UNIT sbu
        start with sbu.id = '''|| condition ||'''
        connect by prior sbu.id = sbu.PARENT_ID';

        IF ( currenttype = 0 ) THEN
--          IF(quarantine_rule='集团')THEN
--             v_auth_sql:=v_auth_sql||' and (company_id='''||companyid||''' or department_id='''||deptid||''')';
--          END IF;

          v_isneed_proj := '';

          --当前使用版本
            v_where := ' and DEPARTMENT_ID in ('
                       || conpanys
                       || ' ) and (Approval_Status = ''已审核'' or (Approval_Status != ''已审核'' and plan_version =''1'')) and (plan_name like ''%'
                       || search1
                       || '%'' or creator like ''%'
                       || search1
                       || '%'')';
            v_maintable := 'POM_SPECIAL_PLAN';
            v_subtable := 'POM_SPECIAL_PLAN_NODE';
        ELSE
            --历史调整版本
            v_where := ' and DEPARTMENT_ID in ('
                       || conpanys
                       || ' ) and (plan_name like ''%'
                       || search1
                       || '%'' or creator like ''%'
                       || search1
                       || '%'')';

            v_maintable := 'POM_SPECIAL_PLAN_HIST';
            v_subtable := 'POM_SPECIAL_PLAN_NODE_HIST';
        END IF;

        v_sql := '
    select
    distinct
    ps.id,
    template_id,
    plan_name,
    plan_subclass,
    (''v'' || to_char(plan_version,''0.0'')) verson,
    company_id,
    company_name,
    department_id,
    department_name,
    remark,
    approval_status,
    approver_id,
    (case when approval_status = ''未审核'' then null else to_char(approval_time,''yyyy-MM-dd'') end) as approval_time,
    to_char(created,''yyyy-MM-dd'') as created,
    creator_id,
    creator,
    to_char(modified,''yyyy-MM-dd'') as modified,
    modifier_id,
    modifier,
    approver,
    original_plan_id,
    plan_version,
    adjust_theme,
    adjust_remark,
    is_delete,
    case plan_version when plan_version then (plan_version-1) end as adjuest_Number,
    case when  pn.cnt1 is null then 0 else pn.cnt1 end as finish_count,
    case when  pn.cnt2 is null then 0 else pn.cnt2 end as not_ebd_count,
    case when  pn.cnt3 is null then 0 else pn.cnt3 end as node_count
    FROM '
                 || v_maintable
                 || '
     ps left join (
    SELECT
    plan_id,
     sum(case  when n.ACTUAL_END_DATE is not null then 1 else 0 end) as cnt1,--完成数量
     sum(case  when n.ACTUAL_END_DATE is null then 1 else 0 end) as cnt2,--未数量,
         count(*) as cnt3
FROM
    '
                 || v_subtable
                 || ' n
    group by plan_id) pn on ps.id=pn.plan_id  where 1=1 '
                 || v_where
                 || '';

    END IF;


v_sql_exec := 'select c.* from(
                select b.*,rownum as rowno from (
                    select a.* from ( '
                      || v_sql
                      || ' ) a left join SYS_BUSINESS_UNIT s1 on a.company_id = s1.id 
                        order by s1.order_hierarchy_code '
                      || v_isneed_proj
                      || ' ) b where rownum <= '
                      || pageindex * pagesizes
                      || ' ) c where c.rowno > '
                      || pagesizes * ( pageindex - 1 );



    dbms_output.put_line(v_sql_exec);
----获取总条数
    EXECUTE IMMEDIATE 'SELECT count(id) from('
                      || v_sql
                      || ') a '
    INTO total;

-- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
    OPEN items FOR v_sql_exec;

EXCEPTION
    WHEN OTHERS THEN
        testmsg := sqlerrm || testmsg;
        OPEN items FOR SELECT
                           '失败'
                       FROM
                           dual;

        dbms_output.put_line(sqlerrm);
        end;
END p_pom_proj_plan_data;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_PROJ_PLAN_DTL_CONDITION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_PROJ_PLAN_DTL_CONDITION" (
    userid                 IN                     VARCHAR2,--用户id
    planid                 IN                     VARCHAR2,--计划id
    conditiontype          IN                     VARCHAR2,--条件类型0:节点级别1：公司ID
    condition              IN                     VARCHAR2,--条件：公司ID；节点级别
    total                  out              number,
    pageindex     IN            INT,
    pagesizes     IN            INT,
    items           out SYS_REFCURSOR      --计划明细一览表
) AS
--项目主项计划监控，详情页 ：明细
--作者：叶丁荣
--日期：2020/04/15
v_sql_exec   CLOB;
v_sql_exec_paging  CLOB;
BEGIN
----计划明细一览表
total:=100;
    IF conditiontype='0' THEN
      v_sql_exec:= '
        SELECT
          rownum AS rowno,
         a.PROJ_ID AS "PROJ_ID"
         ,a.PROJ_NAME AS "PROJ_NAME"
         ,a.PROJ_PLAN_ID AS "PROJ_PLAN_ID"
         ,a.NODE_ID AS "NODE_ID"
         ,a.PLAN_ID AS "PLAN_ID"
         ,a.PLAN_TYPE AS "PLAN_TYPE"
         ,a.ORIGINAL_NODE_ID AS "ORIGINAL_NODE_ID"
         ,CASE a.WARNING_STATUS
         WHEN ''红灯'' THEN
            ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
         WHEN ''绿灯'' THEN
            ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
         WHEN ''黄灯'' THEN
            ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
        ELSE NULL
         END AS "WARNING_STATUS"
         ,case when b.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as "IS_UN_WATCH"
        ,case when a.ACTUAL_END_DATE is null then ''催办'' else null end as "HASTEN"
         ,a.NODE_CODE AS "NODE_CODE"
         ,a.NODE_NAME AS "NODE_NAME"
         ,a.NODE_LEVEL AS "NODE_LEVEL"
         ,a.DUTY_DEPARTMENT AS "DUTY_DEPARTMENT"
         ,a.DUTY_MANS AS "DUTY_MANS"
         ,a.FINISH_STATUS AS "FINISH_STATUS"
         ,a.STANDARD_SCORE AS "STANDARD_SCORE"
         ,a.PLAN_START_DATE AS "PLAN_START_DATE"
         ,a.PLAN_END_DATE AS "PLAN_END_DATE"
         ,a.ACTUAL_START_DATE AS "ACTUAL_START_DATE"
         ,a.ACTUAL_END_DATE AS "ACTUAL_END_DATE"
         ,a.ESTIMATE_END_DATE AS "ESTIMATE_END_DATE"
         ,a.PROCESS_FEED_BACK_CON AS "PROCESS_FEED_BACK_CON"
         ,a.FINISH_FEED_BACK_CON AS "FINISH_FEED_BACK_CON"
         ,a.OVERDUE_FEED_BACK_CON AS "OVERDUE_FEED_BACK_CON"
         ,a.NODE_FLAG AS "NODE_FLAG"
         ,a.ESTIMATE_BEYOND_NODE_FLAG AS "ESTIMATE_BEYOND_NODE_FLAG"
         ,a.COMPLETION_STANDARD AS "COMPLETION_STANDARD"
         ,a.COMPLETION_RESULTS_REMARK AS "COMPLETION_RESULTS_REMARK"
         --,nvl(b.IS_UN_WATCH,1) as  "IS_UN_WATCH"
         ,to_char(a.PLAN_START_DATE, ''YYYY-mm-dd'') as "PLAN_START_TIME"
         ,to_char(a.PLAN_END_DATE, ''YYYY-mm-dd'') as "PLAN_END_TIME"
         ,to_char(a.ACTUAL_START_DATE, ''YYYY-mm-dd'') as "ACTUAL_START_TIME"
         ,to_char(a.ACTUAL_END_DATE, ''YYYY-mm-dd'') as "ACTUAL_END_TIME"
         ,to_char(a.ESTIMATE_END_DATE, ''YYYY-mm-dd'') as "ESTIMATE_END_TIME"
          ,b.UN_WATCH_TIME  ,b.WATCH_TIME
      FROM  v_pom_proj_monitor_node_list  a
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID='''||userid||''' --and   b.WATCH_TIME is  not   null
      WHERE     a.PLAN_ID='''||planid||''' AND a.NODE_LEVEL='''||condition||'''    ' ;
    ELSE
        IF condition='未指定主责部门' THEN
            v_sql_exec:= '
                 SELECT
                 rownum AS rowno,
                 a.PROJ_ID AS "PROJ_ID"
                 ,a.PROJ_NAME AS "PROJ_NAME"
                 ,a.PROJ_PLAN_ID AS "PROJ_PLAN_ID"
                 ,a.NODE_ID AS "NODE_ID"
                 ,a.PLAN_ID AS "PLAN_ID"
                 ,a.PLAN_TYPE AS "PLAN_TYPE"
                 ,a.ORIGINAL_NODE_ID AS "ORIGINAL_NODE_ID"
                 ,CASE a.WARNING_STATUS
                 WHEN ''红灯'' THEN
                    ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
                 WHEN ''绿灯'' THEN
                    ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
                 WHEN ''黄灯'' THEN
                    ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                ELSE NULL
                 END AS "WARNING_STATUS"
                 ,case when b.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as "IS_UN_WATCH"
                ,case when a.ACTUAL_END_DATE is null then ''催办'' else null end as  "HASTEN"
                 ,a.NODE_CODE AS "NODE_CODE"
                 ,a.NODE_NAME AS "NODE_NAME"
                 ,a.NODE_LEVEL AS "NODE_LEVEL"
                 ,a.DUTY_DEPARTMENT AS "DUTY_DEPARTMENT"
                 ,a.DUTY_MANS AS "DUTY_MANS"
                 ,a.FINISH_STATUS AS "FINISH_STATUS"
                 ,a.STANDARD_SCORE AS "STANDARD_SCORE"
                 ,a.PLAN_START_DATE AS "PLAN_START_DATE"
                 ,a.PLAN_END_DATE AS "PLAN_END_DATE"
                 ,a.ACTUAL_START_DATE AS "ACTUAL_START_DATE"
                 ,a.ACTUAL_END_DATE AS "ACTUAL_END_DATE"
                 ,a.ESTIMATE_END_DATE AS "ESTIMATE_END_DATE"
                 ,a.PROCESS_FEED_BACK_CON AS "PROCESS_FEED_BACK_CON"
                 ,a.FINISH_FEED_BACK_CON AS "FINISH_FEED_BACK_CON"
                 ,a.OVERDUE_FEED_BACK_CON AS "OVERDUE_FEED_BACK_CON"
                 ,a.NODE_FLAG AS "NODE_FLAG"
                 ,a.ESTIMATE_BEYOND_NODE_FLAG AS "ESTIMATE_BEYOND_NODE_FLAG"
                 ,a.COMPLETION_STANDARD AS "COMPLETION_STANDARD"
                 ,a.COMPLETION_RESULTS_REMARK AS "COMPLETION_RESULTS_REMARK"
                 --,nvl(b.IS_UN_WATCH,1) as  "IS_UN_WATCH"
                 ,to_char(a.PLAN_START_DATE, ''YYYY-mm-dd'') as "PLAN_START_TIME"
                 ,to_char(a.PLAN_END_DATE, ''YYYY-mm-dd'') as "PLAN_END_TIME"
                 ,to_char(a.ACTUAL_START_DATE, ''YYYY-mm-dd'') as "ACTUAL_START_TIME"
                 ,to_char(a.ACTUAL_END_DATE, ''YYYY-mm-dd'') as "ACTUAL_END_TIME"
                 ,to_char(a.ESTIMATE_END_DATE, ''YYYY-mm-dd'') as "ESTIMATE_END_TIME"
                  ,b.UN_WATCH_TIME  ,b.WATCH_TIME
              FROM  v_pom_proj_monitor_node_list  a
              LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID='''||userid||''' --and   b.WATCH_TIME is  not   null
              WHERE     a.PLAN_ID='''||planid||''' ' ;
        ELSE
           v_sql_exec:= '
                 SELECT
                 rownum AS rowno,
                 a.PROJ_ID AS "PROJ_ID"
                 ,a.PROJ_NAME AS "PROJ_NAME"
                 ,a.PROJ_PLAN_ID AS "PROJ_PLAN_ID"
                 ,a.NODE_ID AS "NODE_ID"
                 ,a.PLAN_ID AS "PLAN_ID"
                 ,a.PLAN_TYPE AS "PLAN_TYPE"
                 ,a.ORIGINAL_NODE_ID AS "ORIGINAL_NODE_ID"
                 ,CASE a.WARNING_STATUS
                 WHEN ''红灯'' THEN
                    ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
                 WHEN ''绿灯'' THEN
                    ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
                 WHEN ''黄灯'' THEN
                    ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                ELSE NULL
                 END AS "WARNING_STATUS"
                 ,case when b.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as "IS_UN_WATCH"
                ,case when a.ACTUAL_END_DATE is null then ''催办'' else null end as  "HASTEN"
                 ,a.NODE_CODE AS "NODE_CODE"
                 ,a.NODE_NAME AS "NODE_NAME"
                 ,a.NODE_LEVEL AS "NODE_LEVEL"
                 ,a.DUTY_DEPARTMENT AS "DUTY_DEPARTMENT"
                 ,a.DUTY_MANS AS "DUTY_MANS"
                 ,a.FINISH_STATUS AS "FINISH_STATUS"
                 ,a.STANDARD_SCORE AS "STANDARD_SCORE"
                 ,a.PLAN_START_DATE AS "PLAN_START_DATE"
                 ,a.PLAN_END_DATE AS "PLAN_END_DATE"
                 ,a.ACTUAL_START_DATE AS "ACTUAL_START_DATE"
                 ,a.ACTUAL_END_DATE AS "ACTUAL_END_DATE"
                 ,a.ESTIMATE_END_DATE AS "ESTIMATE_END_DATE"
                 ,a.PROCESS_FEED_BACK_CON AS "PROCESS_FEED_BACK_CON"
                 ,a.FINISH_FEED_BACK_CON AS "FINISH_FEED_BACK_CON"
                 ,a.OVERDUE_FEED_BACK_CON AS "OVERDUE_FEED_BACK_CON"
                 ,a.NODE_FLAG AS "NODE_FLAG"
                 ,a.ESTIMATE_BEYOND_NODE_FLAG AS "ESTIMATE_BEYOND_NODE_FLAG"
                 ,a.COMPLETION_STANDARD AS "COMPLETION_STANDARD"
                 ,a.COMPLETION_RESULTS_REMARK AS "COMPLETION_RESULTS_REMARK"
                 --,nvl(b.IS_UN_WATCH,1) as  "IS_UN_WATCH"
                 ,to_char(a.PLAN_START_DATE, ''YYYY-mm-dd'') as "PLAN_START_TIME"
                 ,to_char(a.PLAN_END_DATE, ''YYYY-mm-dd'') as "PLAN_END_TIME"
                 ,to_char(a.ACTUAL_START_DATE, ''YYYY-mm-dd'') as "ACTUAL_START_TIME"
                 ,to_char(a.ACTUAL_END_DATE, ''YYYY-mm-dd'') as "ACTUAL_END_TIME"
                 ,to_char(a.ESTIMATE_END_DATE, ''YYYY-mm-dd'') as "ESTIMATE_END_TIME"
                  ,b.UN_WATCH_TIME  ,b.WATCH_TIME
              FROM  v_pom_proj_monitor_node_list  a
              LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID='''||userid||''' --and   b.WATCH_TIME is  not   null
              WHERE     a.PLAN_ID='''||planid||''' AND a.DUTY_DEPARTMENT='''||condition||'''  ' ;
        END IF;
    END IF;


     v_sql_exec_paging := '
select f.* from ( '
                             || v_sql_exec
                             || '  AND rownum  <= '
                             || pageindex * pagesizes
                             ||' order by node_code asc'|| ' ) f where rowno > '
                             || pagesizes * ( pageindex - 1 )
                             || '';
    dbms_output.put_line(v_sql_exec_paging);
    EXECUTE IMMEDIATE 'SELECT count(rownum) from('
                          || v_sql_exec
                          || ') a '
        INTO total;
      OPEN items FOR v_sql_exec_paging;
END p_pom_proj_plan_dtl_condition;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_PUSH_WATCH_MESSAGE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_PUSH_WATCH_MESSAGE" (bizId in varchar,message OUT sys_refcursor)
AS  
--任务关注后推送相关消息
--作者：陈丽
--日期：2019/11/15
BEGIN  
open message for  
select 
'消息描述' as  "msgDescription",
'接收人id' as "RecipientId" ,
bizId as "bizKey" ,
'发送人id' as "senderId",
'业务类型' as "bizSourceCategory" ,
'消息业务类型' as "bizMsgCategory" ,
'系统id' as "systemId" ,
'微信跳转url'  as "wechatJumplinkUrl"
from dual;

END p_pom_Push_watch_message;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_QUARTER_ASSESSMENT_DTL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_QUARTER_ASSESSMENT_DTL" (
    year         IN           VARCHAR2, --年
    quarter      IN           VARCHAR2, --季度
    companyid    IN           VARCHAR2, --当前用户公司id
    plantype     IN           INT,--计划类型30 关键节点计划、40主项计划
    baseinfo     OUT          SYS_REFCURSOR, --基本信息
    detailinfo   OUT          SYS_REFCURSOR --明细信息
) AS
	--公司月度考核排行详情
--作者：叶丁荣
--日期：2019/12/05
--20201026 陈丽调整 获取月度考核排行详情

    v_plantype         VARCHAR2(20);
    v_currentquarter   VARCHAR2(20);
    v_currentdate      VARCHAR2(20);
    v_monthbegin       DATE;
    v_monthend         DATE;
    v_quarterbegin     DATE;
    v_quarterend       DATE;
    v_yearbegin        DATE;
    v_yearend          DATE; 
    
 --chenl 202021026 月开始，月结束
    o_quarter_begin    DATE;
    o_quarter_end      DATE;
BEGIN
--  获取季度开始 和结束时间
    SELECT
        quarter_begin,
        quarter_end
    INTO
        o_quarter_begin,
        o_quarter_end
    FROM
        v_pom_month_quarter_years
    WHERE
        lpad(q, 2, '0') = lpad(quarter, 2, '0')
        AND lpad(yyyy, 4, '0') = year
    GROUP BY
        quarter_begin,
        quarter_end;

    dbms_output.put_line('o_quarter_BEGIN = ' || o_quarter_begin);
    dbms_output.put_line('O_quarter_END = ' || o_quarter_end);
    IF plantype = 30 THEN
        v_plantype := '关键节点计划';
    ELSE
        v_plantype := '项目主项计划';
    END IF;

    OPEN baseinfo FOR WITH base AS (
                         SELECT
                             a1.*,
                             CASE
                                 WHEN a1.actual_end_date IS NULL
                                      OR pne.new_examination_score IS NULL THEN
                                     0
                                 WHEN a1.actual_end_date IS NOT NULL THEN
                                     pne.new_examination_score
                             END AS "assessmentActualNodeScore" --∑考核期内节点实际得分(B)
                         FROM
                             pom_proj_plan          a
                             INNER JOIN pom_proj_plan_node     a1 ON a.id = a1.proj_plan_id
                             INNER JOIN sys_project_stage      c1 ON a.proj_id = c1.id
                             INNER JOIN sys_project            b1 ON c1.project_id = b1.id
                             LEFT JOIN (
                                 SELECT
                                     b2.org_name,
                                     b2.id,
                                     CONNECT_BY_ROOT org_name AS scorgname,
                                     CONNECT_BY_ROOT level_rank,
                                     CONNECT_BY_ROOT id AS rootid
                                 FROM
                                     sys_business_unit b2
                                 WHERE
                                     CONNECT_BY_ROOT level_rank = 2
  -- AnD ORG_NAME='重庆事业部'
                                 CONNECT BY
                                     PRIOR b2.id = b2.parent_id
                             ) b1 ON b1.unit_id = b1.id
                             LEFT JOIN pom_node_examination   pne ON a1.id = pne.node_id
                             LEFT JOIN pom_node_feedback      d ON d.feedback_node_id = a1.id
                                                              AND feedback_type = 'CARRY_OUT'
                                                              AND d.approval_status = '已审核'
                         WHERE
                             a.approval_status = '已审核'
                             AND nvl(a1.is_delete, 0) = 0
                             AND nvl(a1.is_disable, 0) = 0
                             AND a1.plan_end_date BETWEEN o_quarter_begin AND o_quarter_end
                             AND (
                                 SELECT
                                     fn_bizparam_config('pom_fission_node_is_examined') AS is_examined
                                 FROM
                                     dual
                             ) = 0 
--and SCOrgNAmE='华南公司' 
--集团不加该条件
                             AND (b1.rootid = case when companyid='003200000000000000000000000000' then b1.rootid else companyid end)
                             AND a.plan_type = v_plantype
                             AND fission_source_original_id IS NULL
                     )
                     SELECT
                         CASE
                             WHEN SUM(1) IS NULL THEN
                                 '0.00'
                             ELSE
                                 TO_CHAR((SUM(
                                     CASE
                                         WHEN base.actual_end_date IS NOT NULL THEN
                                             1
                                         ELSE
                                             0
                                     END
                                 ) / SUM(1)) * 100, 'FM999,999,999,999,990.00')
                         END AS "percentageComplete",--完成率(P=M/N*100)
                         SUM(1) AS "assessmentTasksCount",
                         SUM(
                             CASE
                                 WHEN base.actual_end_date IS NOT NULL THEN
                                     1
                                 ELSE
                                     0
                             END
                         ) AS "missionsCompleted",
                         CASE
                             WHEN SUM(standard_score) IS NULL THEN
                                 '0.00'
                             ELSE
                                 TO_CHAR(SUM("assessmentActualNodeScore") / (SUM(standard_score)) * 100, 'FM999,999,999,999,990.00'
                                 )
                         END AS "assessmentScore",
                         SUM(standard_score) AS "assessmentStandardNodeScore",--∑考核期内节点标准分(A)
                         SUM("assessmentActualNodeScore") AS "assessmentActualNodeScore" --∑考核期内节点实际得分(B)
                     FROM
                         base;

    OPEN detailinfo FOR WITH base AS (
                           SELECT
                               CASE 
 --未到期不亮灯
                                   WHEN a1.actual_end_date IS NULL
                                        AND trunc(SYSDATE) - trunc(a1.plan_end_date) <= 0 THEN
                                       ''
 --到期当天内完成反馈
                                   WHEN a1.actual_end_date IS NOT NULL
                                        AND ( trunc(a1.actual_end_date) - trunc(a1.plan_end_date) ) <= 0 THEN
                                       '<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>'
  --到期1-5天内完成反馈
                                   WHEN a1.actual_end_date IS NOT NULL
                                        AND ( trunc(a1.actual_end_date) - trunc(a1.plan_end_date) ) BETWEEN 1 AND 5 THEN
                                       '<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>'
 --到期未反馈黄灯 
                                   WHEN a1.actual_end_date IS NULL
                                        AND ( trunc(SYSDATE) - trunc(a1.plan_end_date) ) BETWEEN 1 AND 5 THEN
                                       '<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>' 
  --到期超过5天未反馈红灯 
                                   WHEN a1.actual_end_date IS NULL
                                        AND ( ( trunc(SYSDATE) - trunc(a1.plan_end_date) ) > 5 ) THEN
                                       '<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'
                                   ELSE
                                       '<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'
                               END AS "alertStatus",--预警状态
                               CASE
                                   WHEN a1.actual_end_date IS NULL THEN
                                       '未完成'
                                   WHEN a1.actual_end_date IS NOT NULL THEN
                                       '已完成'
                               END AS "completionStatus",--完成状态
                               a1.node_name          AS "taskName",--任务名称
                               a.plan_name           AS "planName",--计划名称
                               scorgname             "area",--区域
                               b1.org_name           AS "businessDivision",--事业部
                               a.proj_name           AS "project", --项目
                               a1.duty_department    AS "department",--主责部门
                               a1.node_level         AS "tasnkLevel",--任务级别
                               TO_CHAR(a1.plan_end_date, 'yyyy-MM-dd') AS "planEndDate",--计划完成日期
                               TO_CHAR(a1.actual_end_date, 'yyyy-MM-dd') AS "factEndDate",--实际完成日期
                               CASE
                                   WHEN a1.actual_end_date IS NULL THEN
                                       NULL
                                   WHEN a1.actual_end_date IS NOT NULL THEN
                                       TO_CHAR(d.approval_time, 'yyyy-MM-dd')
                               END AS "auditCompletionDate",--核完成日期
                               a1.standard_score     AS "standardScore",--标准分值
                               CASE
                                   WHEN a1.actual_end_date IS NULL THEN
                                       0 || '%'
                                   WHEN a1.actual_end_date IS NOT NULL THEN
                                           CASE
                                               WHEN pne.standard_score = 0 THEN
                                                   0
                                               ELSE
                                                   round(pne.new_examination_score / pne.standard_score, 2) * 100
                                           END
                                           || '%'
                               END AS "scoringPercentage",--得分比例
                               CASE
                                   WHEN a1.actual_end_date IS NULL
                                        OR pne.new_examination_score IS NULL THEN
                                       0
                                   WHEN a1.actual_end_date IS NOT NULL THEN
                                       pne.new_examination_score
                               END AS "actualScore",--实际得分
                               a1.id                 AS "node_id",
                               a.id                  AS "plan_id",
                               a1.original_node_id   AS "original_node_id"
                           FROM
                               pom_proj_plan          a
                               INNER JOIN pom_proj_plan_node     a1 ON a.id = a1.proj_plan_id
                               INNER JOIN sys_project_stage      c1 ON a.proj_id = c1.id
                               INNER JOIN sys_project            b1 ON c1.project_id = b1.id
                               LEFT JOIN (
                                   SELECT
                                       b2.org_name,
                                       b2.id,
                                       CONNECT_BY_ROOT org_name AS scorgname,
                                       CONNECT_BY_ROOT level_rank,
                                       CONNECT_BY_ROOT id AS rootid
                                   FROM
                                       sys_business_unit b2
                                   WHERE
                                       CONNECT_BY_ROOT level_rank = 2
  -- AnD ORG_NAME='重庆事业部'
                                   CONNECT BY
                                       PRIOR b2.id = b2.parent_id
                               ) b1 ON b1.unit_id = b1.id
                               LEFT JOIN pom_node_examination   pne ON a1.id = pne.node_id
                               LEFT JOIN pom_node_feedback      d ON d.feedback_node_id = a1.id
                                                                AND feedback_type = 'CARRY_OUT'
                                                                AND d.approval_status = '已审核'
                           WHERE
                               a.approval_status = '已审核'
                               AND nvl(a1.is_delete, 0) = 0
                               AND nvl(a1.is_disable, 0) = 0
                               AND a1.plan_end_date BETWEEN o_quarter_begin AND o_quarter_end
                               AND (
                                   SELECT
                                       fn_bizparam_config('pom_fission_node_is_examined') AS is_examined
                                   FROM
                                       dual
                               ) = 0 
--and SCOrgNAmE='华南公司' 
                                                         
--集团不加该条件
                             AND (b1.rootid = case when companyid='003200000000000000000000000000' then b1.rootid else companyid end)

                               AND a.plan_type = v_plantype
                               AND fission_source_original_id IS NULL
                       )
                       SELECT
                           *
                       FROM
                           base order by "planEndDate","planName","taskName";

END p_pom_quarter_assessment_dtl;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_RANK_EXAMINATION_DTL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_RANK_EXAMINATION_DTL" (
    rangetype   IN          INT,--时间范围类型（10:月度，20季度）
    rangeval    IN          VARCHAR2,--范围值，月度：2019|09。季度：2019|04
    orgid       IN          VARCHAR2,--组织id(关键节点计划传空,项目主项计划传）
    title       OUT         VARCHAR2,
    bartype     OUT         VARCHAR2,
    unit        OUT         VARCHAR2,
    wacthinfo   OUT         SYS_REFCURSOR
) AS
--考核排行详情
--作者：陈丽
--日期：2019/11/13
BEGIN
    OPEN wacthinfo FOR SELECT
                           '广佛事业部-项目A' AS "name",
                           '100' AS "total",
                           '#37cd69' AS "color"
                       FROM
                           dual
                       UNION
                       SELECT
                           '南宁事业部-项目B' AS "name",
                           '25' AS "total",
                           '#37cd69' AS "color"
                       FROM
                           dual
                       UNION
                       SELECT
                           '广佛事业部-项目C' AS "name",
                           '25' AS "total",
                           '#37cd69' AS "color"
                       FROM
                           dual
                       UNION
                       SELECT
                           '福州地产-项目D' AS "name",
                           '25' AS "total",
                           '#37cd69' AS "color"
                       FROM
                           dual;

    title := '项目主项计划考核_项目排行榜：';
    unit := '%';
    bartype := 'column';
END p_pom_rank_examination_dtl;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_RANK_ORG_EXAM_DTL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_RANK_ORG_EXAM_DTL" (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    rangetype   IN          INT,--时间范围类型（10:月度，20季度）
  --计划类型  30关键节点计划，40项目主项计划
    rangeval    IN          VARCHAR2,--范围值，月度：2019|09。季度：2019|04
    orgid       IN          VARCHAR2,--组织id(关键节点计划传空,项目主项计划传）
    title       OUT         VARCHAR2,
    info   OUT         SYS_REFCURSOR
) AS
--公司考核排行详情
--作者：陈丽
--日期：2019/11/13
BEGIN
  IF rangetype=10
      THEN
    OPEN info FOR

with 树 ( 

ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH
,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯, CTYPE
)as( 



select   
ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分
	,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成
	,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯
,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯
,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯
, CTYPE
from POM_PJPLAN_EXM_SOCRE_TABLE where plan_type='关键节点计划' and PLANYEAR= SUBSTR(RANGEVAL, 0, 4)


UNION all 
select    
a2.ID,a2.PARENT_ID,a2.ORG_NAME,a1.PLAN_TYPE,a1.PROJECT_NAME ,a2.ORDER_CODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成
,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成
,三级节点已完成,里程碑绿灯,一级节点绿灯,二级节点绿灯
,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯
,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯
,三级节点红灯
, 'TYPE_ORG' as CTYPE

from  树 a1 INNER JOIN　SYS_BUSINESS_UNIT a2 on a1.parent_id=a2.id 

		where is_company=1


		)





,结果 as( 
select org_name AS "company",id AS "ORGID" ,parent_id
 ,(ROUND(CASE
												 WHEN SUM(CASE
																			WHEN SUBSTR(RANGEVAL, 0, 4) = PLANYEAR THEN
																			 应完成
																			ELSE
																			 0
																	END) > 0 THEN
													SUM(CASE
																	WHEN SUBSTR(RANGEVAL, 0, 4) = PLANYEAR THEN
																	 已完成
																	ELSE
																	 0
															END) / SUM(CASE
																						 WHEN SUBSTR(RANGEVAL, 0, 4) = PLANYEAR THEN
																							应完成
																						 ELSE
																							0
																				 END) * 100
												 ELSE
													0
										 END, 2)) AS "yearPercentageComplete",
			 (SUM(CASE
											 WHEN SUBSTR(RANGEVAL, 0, 4) = PLANYEAR THEN
												应完成
											 ELSE
												0
									 END)) AS "yearShouldComplete"
				--本年应完成数
			 ,
			 (SUM(CASE
											 WHEN SUBSTR(RANGEVAL, 0, 4) = PLANYEAR THEN
												已完成
											 ELSE
												0
									 END)) AS "yearDone"
				--本年已完成数
			 ,
			 (SUM(CASE
											 WHEN SUBSTR(RANGEVAL, 0, 4) = PLANYEAR THEN
												应完成
											 ELSE
												0
									 END) - SUM(CASE
																	WHEN SUBSTR(RANGEVAL, 0, 4) = PLANYEAR THEN
																	 已完成
																	ELSE
																	 0
															END)) AS "yearUnfinished"
				--本年未完成数
			 ,
			 (ROUND(CASE
												 WHEN SUM(CASE
																			WHEN  LPAD( (SUBSTR( RANGEVAL, 6, 2 )),2,'0')= PLANMOTH THEN
																			 SUMNODESCORE
																			ELSE
																			 0
																	END) > 0 THEN
													SUM(CASE
																	WHEN LPAD( (SUBSTR( RANGEVAL, 6, 2 )),2,'0') = PLANMOTH THEN
																	 动态得分
																	ELSE
																	 0
															END) / SUM(CASE
																						 WHEN LPAD( (SUBSTR( RANGEVAL, 6, 2 )),2,'0') = PLANMOTH THEN
																							SUMNODESCORE
																						 ELSE
																							0
																				 END) * 100
												 ELSE
													0
										 END, 2)) AS "dynamicScoring"
				--本月、季度动态得分
			 ,
			 (SUM(CASE
											 WHEN LPAD( (SUBSTR( RANGEVAL, 6, 2 )),2,'0') = PLANMOTH THEN
												应完成
											 ELSE
												0
									 END)) AS "monthShouldComplete"
				--本月、季度应完成数
			 ,
       (SUM(CASE
											 WHEN LPAD( (SUBSTR( RANGEVAL, 6, 2 )),2,'0') = PLANMOTH THEN
												SUMNODESCORE
											 ELSE
												0
									 END)) AS "monthShouldCompleteScore"
				--本月应完成总分
        ,
			 (SUM(CASE
											 WHEN LPAD( (SUBSTR( RANGEVAL, 6, 2 )),2,'0') = PLANMOTH THEN
												已完成
											 ELSE
												0
									 END)) AS "monthdDone"
				--本月、季度已完成数
			 ,
       (SUM(CASE
           WHEN LPAD( (SUBSTR( RANGEVAL, 6, 2 )),2,'0') = PLANMOTH THEN
            已完成总分
           ELSE
            0
        END)) AS "monthdDoneScore"
				--本月已完成总分
			 ,
			 (SUM(CASE
											 WHEN LPAD( (SUBSTR( RANGEVAL, 6, 2 )),2,'0') = PLANMOTH THEN
												应完成
											 ELSE
												0
									 END) - SUM(CASE
																	WHEN LPAD( (SUBSTR( RANGEVAL, 6, 2 )),2,'0') = PLANMOTH THEN
																	 已完成
																	ELSE
																	 0
															END)) AS "monthUnfinished"
				--本月未完成数
			 ,
			 (SUM(CASE
											 WHEN LPAD( (SUBSTR( RANGEVAL, 6, 2 )),2,'0') = PLANMOTH THEN
												里程碑红灯
											 ELSE
												0
									 END) + SUM(CASE
																	WHEN LPAD( (SUBSTR( RANGEVAL, 6, 2 )),2,'0') = PLANMOTH THEN
																	 一级节点红灯
																	ELSE
																	 0
															END) + SUM(CASE
																						 WHEN LPAD( (SUBSTR( RANGEVAL, 6, 2 )),2,'0') = PLANMOTH THEN
																							二级节点红灯 + 三级节点红灯
																						 ELSE
																							0
																				 END)) AS "red"
				--红灯数
			 ,
			 (SUM(CASE
											 WHEN LPAD( (SUBSTR( RANGEVAL, 6, 2 )),2,'0') = PLANMOTH THEN
												里程碑黄灯
											 ELSE
												0
									 END) + SUM(CASE
																	WHEN LPAD( (SUBSTR( RANGEVAL, 6, 2 )),2,'0') = PLANMOTH THEN
																	 一级节点黄灯
																	ELSE
																	 0
															END) + SUM(CASE
																						 WHEN LPAD( (SUBSTR( RANGEVAL, 6, 2 )),2,'0') = PLANMOTH THEN
																							二级节点黄灯 + 三级节点黄灯
																						 ELSE
																							0
																				 END)) AS "yellow"
				--黄灯数
			 ,
			 (SUM(CASE
											 WHEN LPAD( (SUBSTR( RANGEVAL, 6, 2 )),2,'0') = PLANMOTH THEN
												里程碑绿灯
											 ELSE
												0
									 END) + SUM(CASE
																	WHEN LPAD( (SUBSTR( RANGEVAL, 6, 2 )),2,'0') = PLANMOTH THEN
																	 一级节点绿灯
																	ELSE
																	 0
															END) + SUM(CASE
																						 WHEN LPAD( (SUBSTR( RANGEVAL, 6, 2 )),2,'0') = PLANMOTH THEN
																							二级节点绿灯 + 三级节点绿灯
																						 ELSE
																							0
																				 END)) AS "green"
				--绿灯数
			 ,
			 (SUM(CASE
											 WHEN LPAD( (SUBSTR( RANGEVAL, 6, 2 )),2,'0') = PLANMOTH THEN
												里程碑应完成
											 ELSE
												0
									 END)) AS "milestoneShouldComplete"
				--里程碑应完成数
			 ,
			 (SUM(CASE
											 WHEN LPAD( (SUBSTR( RANGEVAL, 6, 2 )),2,'0') = PLANMOTH THEN
												里程碑已完成
											 ELSE
												0
									 END)) AS "milestoneDone"
				--里程碑已完成数
			 ,
			 (SUM(CASE
											 WHEN LPAD( (SUBSTR( RANGEVAL, 6, 2 )),2,'0') = PLANMOTH THEN
												里程碑应完成
											 ELSE
												0
									 END) - SUM(CASE
																	WHEN LPAD( (SUBSTR( RANGEVAL, 6, 2 )),2,'0') = PLANMOTH THEN
																	 里程碑已完成
																	ELSE
																	 0
															END)) AS "milestoneUnfinished"
				--里程碑未完成数
			 ,
			 (SUM(CASE
											 WHEN LPAD( (SUBSTR( RANGEVAL, 6, 2 )),2,'0') = PLANMOTH THEN
												一级节点应完成
											 ELSE
												0
									 END)) AS "oneLevelNodeShouldComplete"
				--一级节点应完成数
			 ,
			 (SUM(CASE
											 WHEN LPAD( (SUBSTR( RANGEVAL, 6, 2 )),2,'0') = PLANMOTH THEN
												一级节点已完成
											 ELSE
												0
									 END)) AS "oneLevelNodeDone"
				--一级节点已完成数
			 ,
			 (SUM(CASE
											 WHEN LPAD( (SUBSTR( RANGEVAL, 6, 2 )),2,'0') = PLANMOTH THEN
												一级节点应完成
											 ELSE
												0
									 END) - SUM(CASE
																	WHEN LPAD( (SUBSTR( RANGEVAL, 6, 2 )),2,'0') = PLANMOTH THEN
																	 一级节点已完成
																	ELSE
																	 0
															END)) AS "oneLevelNodeUnfinished"
				--一级节点未完成数
			 , 'WWW.BAIDU.COM' AS "openUrl" --打开地址

 FROM 树 a where CTYPE='TYPE_ORG' and PARENT_ID = '' || ORGID || ''

group by org_name,    id,    parent_id
ORDER BY  8 desc,"monthShouldComplete" desc
)

    select * from 结果  

;
ELSIF RANGETYPE = 20 THEN OPEN INFO FOR

with 树 ( 

ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH
,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯, CTYPE
)as( 



select   
ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分
	,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成
	,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯
,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯
,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯
, CTYPE
from POM_PJPLAN_EXM_SOCRE_TABLE where plan_type='关键节点计划' and PLANYEAR= SUBSTR(RANGEVAL, 0, 4)


UNION all 
select    
a2.ID,a2.PARENT_ID,a2.ORG_NAME,a1.PLAN_TYPE,a1.PROJECT_NAME ,a2.ORDER_CODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成
,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成
,三级节点已完成,里程碑绿灯,一级节点绿灯,二级节点绿灯
,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯
,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯
,三级节点红灯
, 'TYPE_ORG' as CTYPE

from  树 a1 INNER JOIN　SYS_BUSINESS_UNIT a2 on a1.parent_id=a2.id 

		where is_company=1


		)





,结果 as( 
select org_name AS "company"
,id AS "ORGID" 
,parent_id
,ROUND(sum(已完成)/sum(应完成),2)*100 as "yearPercentageComplete"
,sum(应完成) AS "yearShouldComplete"
,sum(已完成) AS "yearDone"
,sum(应完成) - sum(已完成)  AS "yearUnfinished" --本年未完成数
, ROUND( case when SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN SUMNODESCORE ELSE 0 END) >0 then  SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 动态得分 ELSE 0 END)
/ SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN SUMNODESCORE ELSE 0 END) * 100  else 0 end, 2) AS "dynamicScoring" --本月、季度动态得分

, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 应完成 ELSE 0 END) AS "quarterShouldComplete" --本月、季度应完成数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN SUMNODESCORE ELSE 0 END) AS "quarterShouldCompleteScore" --本月、季度应完成分数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 已完成 ELSE 0 END) AS "quarterDone" --本月、季度已完成数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 已完成总分 ELSE 0 END) AS "quarterDoneScore" --本月、季度已完成分数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 应完成 ELSE 0 END) - SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 已完成 ELSE 0 END) AS "quarterUnfinished" --本月未完成数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 里程碑红灯 ELSE 0 END) + SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 一级节点红灯 ELSE 0 END) + SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 二级节点红灯 + 三级节点红灯 ELSE 0 END) AS "red" --红灯数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 里程碑黄灯 ELSE 0 END) + SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 一级节点黄灯 ELSE 0 END) + SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 二级节点黄灯 + 三级节点黄灯 ELSE 0 END) AS "yellow" --黄灯数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 里程碑绿灯 ELSE 0 END) + SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 一级节点绿灯 ELSE 0 END) + SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 二级节点绿灯 + 三级节点绿灯 ELSE 0 END) AS "green" --绿灯数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 里程碑应完成 ELSE 0 END) AS "milestoneShouldComplete" --里程碑应完成数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 里程碑已完成 ELSE 0 END) AS "milestoneDone" --里程碑已完成数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 里程碑应完成 ELSE 0 END) - SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 里程碑已完成 ELSE 0 END) AS "milestoneUnfinished" --里程碑未完成数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 一级节点应完成 ELSE 0 END) AS "oneLevelNodeShouldComplete" --一级节点应完成数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 一级节点已完成 ELSE 0 END) AS "oneLevelNodeDone" --一级节点已完成数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 一级节点应完成 ELSE 0 END) - SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 一级节点已完成 ELSE 0 END) AS "oneLevelNodeUnfinished" --一级节点未完成数
, '' AS "openUrl" --打开地址

 FROM 树 a where CTYPE='TYPE_ORG' and PARENT_ID = '' || ORGID || ''

group by org_name,    id,    parent_id
ORDER BY  8 desc,"quarterShouldComplete" desc
)

    select * from 结果  

;

--WHERE 应完成 > 0 AND PLAN_TYPE = '关键节点计划' AND CTYPE = 'TYPE_ORG' AND SUBSTR(RANGEVAL, 0, 4) = PLANYEAR AND PARENT_ID = '' || ORGID || '' GROUP BY ORG_NAME,ORG_FULL_NAME, ID ORDER BY ORG_FULL_NAME asc;

END IF; TITLE := '月度考核排行榜_明细数据统计'; END P_POM_RANK_ORG_EXAM_DTL;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_RANK_ORG_EXAMINATION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_RANK_ORG_EXAMINATION" (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    rankype        IN             INT,--时间范围类型（10:月度，20季度）
    plantype       IN             INT,--计划类型（30：关键节点计划，40：项目主项计划）
    rankval        IN             VARCHAR2,--范围值，月度：2019|09。季度：2019|04
    orgid          IN             VARCHAR2,--组织id(传前端选择的公司）
    title          OUT            VARCHAR2,
    bartype        OUT            VARCHAR2,
    unit           OUT            VARCHAR2,
    info      OUT            SYS_REFCURSOR
) AS
--考核排行-组织排行，包括月度排行的 关键节点和项目主项计划。季度排行的关键节点和项目主项计划
--作者：陈丽
--日期：2019/11/13
  org_lenth NUMBER(10):=60;
  lpad_str  VARCHAR2(10):=' ';
BEGIN

IF rankype=10  AND plantype=30
THEN
OPEN info FOR

with 树 ( 

ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH
,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯, CTYPE
)as( 



select   
ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分
	,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成
	,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯
,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯
,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯
, CTYPE
from POM_PJPLAN_EXM_SOCRE_TABLE where plan_type='关键节点计划' and PLANYEAR= SUBSTR(rankval, 0, 4) and PLANMOTH=LPAD( TO_CHAR(SUBSTR( rankval, 6, 2 )),2,'0')


UNION all 
select    
a2.ID,a2.PARENT_ID,a2.ORG_NAME,a1.PLAN_TYPE,a1.PROJECT_NAME ,a2.ORDER_CODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成
,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成
,三级节点已完成,里程碑绿灯,一级节点绿灯,二级节点绿灯
,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯
,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯
,三级节点红灯
, 'TYPE_ORG' as CTYPE

from  树 a1 INNER JOIN　SYS_BUSINESS_UNIT a2 on a1.parent_id=a2.id 

		where is_company=1


		)







,结果 as( 

select  
lpad(ORG_NAME,org_lenth-length(ORG_NAME),lpad_str)   AS "name" 

, TO_CHAR(
   CASE WHEN  SUM(
                  CASE
                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND LPAD( TO_CHAR(SUBSTR( rankval, 6, 2 )),2,'0') = PLANMOTH THEN
                  SUMNODESCORE ELSE 0
                    END
                )>0
        THEN   ROUND(
              SUM(
                  CASE

                      WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                      AND LPAD( TO_CHAR(SUBSTR( rankval, 6, 2 )),2,'0') = PLANMOTH THEN
                        "动态得分" ELSE 0
                      END
                        ) / SUM(
                      CASE

                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND LPAD( TO_CHAR(SUBSTR( rankval, 6, 2 )),2,'0') = PLANMOTH THEN
                    SUMNODESCORE ELSE 0
                  END
                ) * 100,
                2
              )
          ELSE  0 END

           ) AS "total" 
--,TO_CHAR(SUMNODESCORE)AS "total" 
			--,'90 'AS "total"
		   ,  
   CASE WHEN  SUM(
                  CASE
                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND LPAD( TO_CHAR(SUBSTR( rankval, 6, 2 )),2,'0') = PLANMOTH THEN
                  SUMNODESCORE ELSE 0
                    END
                )>0
        THEN   ROUND(
              SUM(
                  CASE

                      WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                      AND LPAD( TO_CHAR(SUBSTR( rankval, 6, 2 )),2,'0') = PLANMOTH THEN
                        "动态得分" ELSE 0
                      END
                        ) / SUM(
                      CASE

                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND LPAD( TO_CHAR(SUBSTR( rankval, 6, 2 )),2,'0') = PLANMOTH THEN
                    SUMNODESCORE ELSE 0
                  END
                ) * 100,
                2
              )
          ELSE  0 END

            AS   totalRank 
		
     , '#37cd69' AS "color"
			 ,
			 (SUM(CASE
											 WHEN LPAD( (SUBSTR( rankval, 6, 2 )),2,'0') = PLANMOTH THEN
												应完成
											 ELSE
												0
									 END)) AS "monthShouldComplete"
 FROM 树 a where PARENT_ID = ''||orgid||'' and  CTYPE='TYPE_ORG'

group by org_name
ORDER BY  totalRank asc, "monthShouldComplete"
)

    select * from 结果  

 ;



ELSIF rankype=10  AND plantype=40
THEN
OPEN info FOR


with 树 ( 

ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH
,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯, CTYPE
)as( 



select   
ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分
	,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成
	,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯
,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯
,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯
, CTYPE
from POM_PJPLAN_EXM_SOCRE_TABLE where plan_type='项目主项计划' and PLANYEAR= SUBSTR(rankval, 0, 4)


UNION all 
select    
a2.ID,a2.PARENT_ID,a2.ORG_NAME,a1.PLAN_TYPE,a1.PROJECT_NAME ,a2.ORDER_CODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成
,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成
,三级节点已完成,里程碑绿灯,一级节点绿灯,二级节点绿灯
,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯
,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯
,三级节点红灯
, 'TYPE_ORG' as CTYPE

from  树 a1 INNER JOIN　SYS_BUSINESS_UNIT a2 on a1.parent_id=a2.id 

		where is_company=1


		)









,结果 as( 
select  lpad(ORG_NAME,org_lenth-length(ORG_NAME),lpad_str)   AS "name"  , TO_CHAR(
   CASE WHEN  SUM(
                  CASE
                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND  LPAD( TO_CHAR(SUBSTR( rankval, 6, 2 )),2,'0') = PLANMOTH THEN
                  SUMNODESCORE ELSE 0
                    END
                )>0
        THEN   ROUND(
              SUM(
                  CASE

                      WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                      AND  LPAD( TO_CHAR(SUBSTR( rankval, 6, 2 )),2,'0') = PLANMOTH THEN
                        "动态得分" ELSE 0
                      END
                        ) / SUM(
                      CASE

                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND  LPAD( TO_CHAR(SUBSTR( rankval, 6, 2 )),2,'0') = PLANMOTH THEN
                    SUMNODESCORE ELSE 0
                  END
                ) * 100,
                2
              )
          ELSE  0 END
            )
           AS "total" --,'90 'AS "total"
		   ,  
   CASE WHEN  SUM(
                  CASE
                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND  LPAD( TO_CHAR(SUBSTR( rankval, 6, 2 )),2,'0') = PLANMOTH THEN
                  SUMNODESCORE ELSE 0
                    END
                )>0
        THEN   ROUND(
              SUM(
                  CASE

                      WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                      AND  LPAD( TO_CHAR(SUBSTR( rankval, 6, 2 )),2,'0') = PLANMOTH THEN
                        "动态得分" ELSE 0
                      END
                        ) / SUM(
                      CASE

                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND  LPAD( TO_CHAR(SUBSTR( rankval, 6, 2 )),2,'0') = PLANMOTH THEN
                    SUMNODESCORE ELSE 0
                  END
                ) * 100,
                2
              )
          ELSE  0 END

           AS   totalRank 
     , '#37cd69' AS "color"
			 ,
			 (SUM(CASE
											 WHEN LPAD( (SUBSTR( rankval, 6, 2 )),2,'0') = PLANMOTH THEN
												应完成
											 ELSE
												0
									 END)) AS "monthShouldComplete"
									 
 FROM 树 a where CTYPE='TYPE_ORG' and PARENT_ID = ''||orgid||''

group by org_name,    id,    parent_id
ORDER BY  totalRank asc, "monthShouldComplete"
)

    select * from 结果  

 ;





ELSIF rankype=20    AND plantype=30
THEN
OPEN info FOR

with 树 ( 

ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH
,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯, CTYPE
)as( 



select   
ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分
	,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成
	,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯
,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯
,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯
, CTYPE
from POM_PJPLAN_EXM_SOCRE_TABLE where plan_type='关键节点计划' and PLANYEAR= SUBSTR(rankval, 0, 4)


UNION all 
select    
a2.ID,a2.PARENT_ID,a2.ORG_NAME,a1.PLAN_TYPE,a1.PROJECT_NAME ,a2.ORDER_CODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成
,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成
,三级节点已完成,里程碑绿灯,一级节点绿灯,二级节点绿灯
,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯
,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯
,三级节点红灯
, 'TYPE_ORG' as CTYPE

from  树 a1 INNER JOIN　SYS_BUSINESS_UNIT a2 on a1.parent_id=a2.id 

		where is_company=1


		)







,结果 as( 
select  lpad(ORG_NAME,org_lenth-length(ORG_NAME),lpad_str)   AS "name"  , TO_CHAR(
   CASE WHEN  SUM(
                  CASE
                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND SUBSTR( rankval, 6, 2 ) = PLANQUATOR THEN
                  SUMNODESCORE ELSE 0
                    END
                )>0
        THEN   ROUND(
              SUM(
                  CASE

                      WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                      AND SUBSTR( rankval, 6, 2 ) = PLANQUATOR THEN
                        "动态得分" ELSE 0
                      END
                        ) / SUM(
                      CASE

                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND SUBSTR( rankval, 6, 2 ) = PLANQUATOR THEN
                    SUMNODESCORE ELSE 0
                  END
                ) * 100,
                2
              )
          ELSE  0 END
            )
           AS "total" --,'90 'AS "total"
		   ,  
   CASE WHEN  SUM(
                  CASE
                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND SUBSTR( rankval, 6, 2 ) = PLANQUATOR THEN
                  SUMNODESCORE ELSE 0
                    END
                )>0
        THEN   ROUND(
              SUM(
                  CASE

                      WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                      AND SUBSTR( rankval, 6, 2 ) = PLANQUATOR THEN
                        "动态得分" ELSE 0
                      END
                        ) / SUM(
                      CASE

                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND SUBSTR( rankval, 6, 2 ) = PLANQUATOR THEN
                    SUMNODESCORE ELSE 0
                  END
                ) * 100,
                2
              )
          ELSE  0 END

           AS   totalRank 
     , '#37cd69' AS "color"
, SUM(CASE WHEN SUBSTR(rankval, 6, 2) = PLANQUATOR THEN 应完成 ELSE 0 END) AS "quarterShouldComplete"
 FROM 树 a where CTYPE='TYPE_ORG' and PARENT_ID = ''||orgid||''

group by org_name,    id,    parent_id
ORDER BY  totalRank asc,"quarterShouldComplete"asc 
)

    select * from 结果  

 ;



ELSIF rankype=20    AND plantype=40
THEN
OPEN info FOR



with 树 ( 

ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH
,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯, CTYPE
)as( 



select   
ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分
	,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成
	,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯
,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯
,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯
, CTYPE
from POM_PJPLAN_EXM_SOCRE_TABLE where plan_type='项目主项计划' and PLANYEAR= SUBSTR(rankval, 0, 4)


UNION all 
select    
a2.ID,a2.PARENT_ID,a2.ORG_NAME,a1.PLAN_TYPE,a1.PROJECT_NAME ,a2.ORDER_CODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成
,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成
,三级节点已完成,里程碑绿灯,一级节点绿灯,二级节点绿灯
,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯
,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯
,三级节点红灯
, 'TYPE_ORG' as CTYPE

from  树 a1 INNER JOIN　SYS_BUSINESS_UNIT a2 on a1.parent_id=a2.id 

		where is_company=1


		)







,结果 as( 
select  lpad(ORG_NAME,org_lenth-length(ORG_NAME),lpad_str)   AS "name"  , TO_CHAR(
   CASE WHEN  SUM(
                  CASE
                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND SUBSTR( rankval, 6, 2 ) = PLANQUATOR THEN
                  SUMNODESCORE ELSE 0
                    END
                )>0
        THEN   ROUND(
              SUM(
                  CASE

                      WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                      AND SUBSTR( rankval, 6, 2 ) = PLANQUATOR THEN
                        "动态得分" ELSE 0
                      END
                        ) / SUM(
                      CASE

                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND SUBSTR( rankval, 6, 2 ) = PLANQUATOR THEN
                    SUMNODESCORE ELSE 0
                  END
                ) * 100,
                2
              )
          ELSE  0 END
            )
           AS "total" --,'90 'AS "total"
		   ,  
   CASE WHEN  SUM(
                  CASE
                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND SUBSTR( rankval, 6, 2 ) = PLANQUATOR THEN
                  SUMNODESCORE ELSE 0
                    END
                )>0
        THEN   ROUND(
              SUM(
                  CASE

                      WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                      AND SUBSTR( rankval, 6, 2 ) = PLANQUATOR THEN
                        "动态得分" ELSE 0
                      END
                        ) / SUM(
                      CASE

                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND SUBSTR( rankval, 6, 2 ) = PLANQUATOR THEN
                    SUMNODESCORE ELSE 0
                  END
                ) * 100,
                2
              )
          ELSE  0 END

           AS   totalRank 
     , '#37cd69' AS "color"

, SUM(CASE WHEN SUBSTR(rankval, 6, 2) = PLANQUATOR THEN 应完成 ELSE 0 END) AS "quarterShouldComplete"
 FROM 树 a where CTYPE='TYPE_ORG' and PARENT_ID = ''||orgid||''

group by org_name,    id,    parent_id
ORDER BY  totalRank asc,"quarterShouldComplete"asc 
)

    select * from 结果  

 ;

  END IF ;



    title :=   CASE WHEN  plantype=40 THEN '项目主项计划' ELSE '关键节点计划'  END  ||'考核排行榜：按照考核得分进行排行统计，展示公司得分的排行';
    unit := '';
    bartype := 'column';
END p_pom_rank_org_examination;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_RANK_ORG_GETDTL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_RANK_ORG_GETDTL" 
(
		PLANTYPE  IN VARCHAR2
	 , --计划类型
		RANGETYPE IN INT
	 , --时间范围类型（10:月度，20季度）
		RANGEVAL  IN VARCHAR2
	 , --范围值，月度：2019|09。季度：2019|04
		RANKDTL   OUT SYS_REFCURSOR
) AS
BEGIN
		IF RANGETYPE = 10 THEN
				OPEN RANKDTL FOR
						SELECT ROW_NUMBER() OVER(PARTITION BY A.PARENT_ID ORDER BY ROUND(CASE
											 WHEN NVL(B.本年应完成, 0) > 0 THEN
												NVL(本年已完成, 0) / NVL(B.本年应完成, 0)
											 ELSE
												0
									 END * 100, 2) DESC) AS RANK, A.ID, A.PARENT_ID,
									 A.ORG_NAME, NVL(B.本年应完成, 0) AS 本年应完成,
									 NVL(B.本年已完成, 0) AS 本年已完成
									 --     ,NVL(B.本季度应完成,0) AS 本季度应完成
									 --     ,NVL(B.本季度已完成,0) AS 本季度已完成
									, NVL(B.本月应完成, 0) AS 本月应完成, NVL(B.本月已完成, 0) AS 本月已完成
									 /*动态得分情况*/, NVL(B.本月动态得分, 0) AS 本月动态得分
									 --     ,NVL(B.本季度动态得分,0) AS 本季度动态得分
									 /*里程碑、一级节点完成情况*/, NVL(B.本月里程碑应完成, 0) AS 本月里程碑应完成,
									 NVL(B.本月里程碑已完成, 0) AS 本月里程碑已完成,
									 NVL(B.本月一级节点应完成, 0) AS 本月一级节点应完成,
									 NVL(B.本月一级节点已完成, 0) AS 本月一级节点已完成
									 --     ,NVL(B.本季度里程碑应完成,0) AS 本季度里程碑应完成
									 --     ,NVL(B.本季度里程碑已完成,0) AS 本季度里程碑已完成
									 --     ,NVL(B.本季度一级节点应完成,0) AS 本季度一级节点应完成
									 --     ,NVL(B.本季度一级节点已完成,0) AS 本季度一级节点已完成
									 /*亮点情况*/, NVL(B.本月里程碑绿灯, 0) AS 本月里程碑绿灯,
									 NVL(B.本月里程碑黄灯, 0) AS 本月里程碑黄灯,
									 NVL(B.本月里程碑红灯, 0) AS 本月里程碑红灯,
									 NVL(B.本月一级节点绿灯, 0) AS 本月一级节点绿灯,
									 NVL(B.本月一级节点黄灯, 0) AS 本月一级节点黄灯,
									 NVL(B.本月一级节点红灯, 0) AS 本月一级节点红灯,
									 NVL(B.本月二三级节点绿灯, 0) AS 本月二三级节点绿灯,
									 NVL(B.本月二三级节点黄灯, 0) AS 本月二三级节点黄灯,
									 NVL(B.本月二三级节点红灯, 0) AS 本月二三级节点红灯
									 --     ,NVL(B.本季度里程碑绿灯,0) AS 本季度里程碑绿灯
									 --     ,NVL(B.本季度里程碑黄灯,0) AS 本季度里程碑黄灯
									 --     ,NVL(B.本季度里程碑红灯,0) AS 本季度里程碑红灯
									 --     ,NVL(B.本季度一级节点绿灯,0) AS 本季度一级节点绿灯
									 --     ,NVL(B.本季度一级节点黄灯,0) AS 本季度一级节点黄灯
									 --     ,NVL(B.本季度一级节点红灯,0) AS 本季度一级节点红灯
									 --     ,NVL(B.本季度二三级节点绿灯,0) AS 本季度二三级节点绿灯
									 --     ,NVL(B.本季度二三级节点黄灯,0) AS 本季度二三级节点黄灯
									 --     ,NVL(B.本季度二三级节点红灯,0) AS 本季度二三级节点红灯
									 
									, 'TYPE_ORG' AS CTYPE
						FROM   SYS_BUSINESS_UNIT A
						LEFT   JOIN (SELECT AB.ID, AB.PARENT_ID, SUM(AB.本年应完成) AS 本年应完成,
																SUM(AB.本年已完成) AS 本年已完成
																--     ,SUM(AB.本季度应完成) AS 本季度应完成
																--     ,SUM(AB.本季度已完成) AS 本季度已完成
															 , SUM(AB.本月应完成) AS 本月应完成,
																SUM(AB.本月已完成) AS 本月已完成
																/*动态得分情况*/, SUM(AB.本月动态得分) AS 本月动态得分
																--     ,SUM(AB.本季度动态得分) AS 本季度动态得分
																/*里程碑、一级节点完成情况*/,
																SUM(AB.本月里程碑应完成) AS 本月里程碑应完成,
																SUM(AB.本月里程碑已完成) AS 本月里程碑已完成,
																SUM(AB.本月一级节点应完成) AS 本月一级节点应完成,
																SUM(AB.本月一级节点已完成) AS 本月一级节点已完成
																--     ,SUM(AB.本季度里程碑应完成) AS 本季度里程碑应完成
																--     ,SUM(AB.本季度里程碑已完成) AS 本季度里程碑已完成
																--     ,SUM(AB.本季度一级节点应完成) AS 本季度一级节点应完成
																--     ,SUM(AB.本季度一级节点已完成) AS 本季度一级节点已完成
																/*亮点情况*/, SUM(AB.本月里程碑绿灯) AS 本月里程碑绿灯,
																SUM(AB.本月里程碑黄灯) AS 本月里程碑黄灯,
																SUM(AB.本月里程碑红灯) AS 本月里程碑红灯,
																SUM(AB.本月一级节点绿灯) AS 本月一级节点绿灯,
																SUM(AB.本月一级节点黄灯) AS 本月一级节点黄灯,
																SUM(AB.本月一级节点红灯) AS 本月一级节点红灯,
																SUM(AB.本月二三级节点绿灯) AS 本月二三级节点绿灯,
																SUM(AB.本月二三级节点黄灯) AS 本月二三级节点黄灯,
																SUM(AB.本月二三级节点红灯) AS 本月二三级节点红灯
												 --     ,SUM(AB.本季度里程碑绿灯) AS 本季度里程碑绿灯
												 --     ,SUM(AB.本季度里程碑黄灯) AS 本季度里程碑黄灯
												 --     ,SUM(AB.本季度里程碑红灯) AS 本季度里程碑红灯
												 --     ,SUM(AB.本季度一级节点绿灯) AS 本季度一级节点绿灯
												 --     ,SUM(AB.本季度一级节点黄灯) AS 本季度一级节点黄灯
												 --     ,SUM(AB.本季度一级节点红灯) AS 本季度一级节点红灯
												 --     ,SUM(AB.本季度二三级节点绿灯) AS 本季度二三级节点绿灯
												 --     ,SUM(AB.本季度二三级节点黄灯) AS 本季度二三级节点黄灯
												 --     ,SUM(AB.本季度二三级节点红灯) AS 本季度二三级节点红灯
												 FROM   (
																	--  11
																	
																	SELECT
																	/*完成情况*/
																	 NVL(B.本年应完成, 0) AS 本年应完成,
																		NVL(B.本年已完成, 0) AS 本年已完成
																		--                    ,NVL(B.本季度应完成,0) AS 本季度应完成
																		--                    ,NVL(B.本季度已完成,0) AS 本季度已完成
																	, NVL(B.本月应完成, 0) AS 本月应完成,
																		NVL(B.本月已完成, 0) AS 本月已完成
																		/*动态得分情况*/, NVL(B.本月动态得分, 0) AS 本月动态得分
																		--                    ,NVL(B.本季度动态得分,0) AS 本季度动态得分
																		/*里程碑、一级节点完成情况*/,
																		NVL(B.本月里程碑应完成, 0) AS 本月里程碑应完成,
																		NVL(B.本月里程碑已完成, 0) AS 本月里程碑已完成,
																		NVL(B.本月一级节点应完成, 0) AS 本月一级节点应完成,
																		NVL(B.本月一级节点已完成, 0) AS 本月一级节点已完成
																		--                    ,NVL(B.本季度里程碑应完成,0) AS 本季度里程碑应完成
																		--                    ,NVL(B.本季度里程碑已完成,0) AS 本季度里程碑已完成
																		--                    ,NVL(B.本季度一级节点应完成,0) AS 本季度一级节点应完成
																		--                    ,NVL(B.本季度一级节点已完成,0) AS 本季度一级节点已完成
																		/*亮点情况*/, NVL(B.本月里程碑绿灯, 0) AS 本月里程碑绿灯,
																		NVL(B.本月里程碑黄灯, 0) AS 本月里程碑黄灯,
																		NVL(B.本月里程碑红灯, 0) AS 本月里程碑红灯,
																		NVL(B.本月一级节点绿灯, 0) AS 本月一级节点绿灯,
																		NVL(B.本月一级节点黄灯, 0) AS 本月一级节点黄灯,
																		NVL(B.本月一级节点红灯, 0) AS 本月一级节点红灯,
																		NVL(B.本月二三级节点绿灯, 0) AS 本月二三级节点绿灯,
																		NVL(B.本月二三级节点黄灯, 0) AS 本月二三级节点黄灯,
																		NVL(B.本月二三级节点红灯, 0) AS 本月二三级节点红灯
																		--                    ,NVL(B.本季度里程碑绿灯,0) AS 本季度里程碑绿灯
																		--                    ,NVL(B.本季度里程碑黄灯,0) AS 本季度里程碑黄灯
																		--                    ,NVL(B.本季度里程碑红灯,0) AS 本季度里程碑红灯
																		--                    ,NVL(B.本季度一级节点绿灯,0) AS 本季度一级节点绿灯
																		--                    ,NVL(B.本季度一级节点黄灯,0) AS 本季度一级节点黄灯
																		--                    ,NVL(B.本季度一级节点红灯,0) AS 本季度一级节点红灯
																		--                    ,NVL(B.本季度二三级节点绿灯,0) AS 本季度二三级节点绿灯
																		--                    ,NVL(B.本季度二三级节点黄灯,0) AS 本季度二三级节点黄灯
																		--                    ,NVL(B.本季度二三级节点红灯,0) AS 本季度二三级节点红灯
																	, CONNECT_BY_ROOT ID AS ID,
																		CONNECT_BY_ROOT PARENT_ID AS PARENT_ID
																	FROM   SYS_BUSINESS_UNIT A
																	LEFT   JOIN (
																							 
																							 SELECT B1.UNIT_ID,
																											 COUNT(A1.ID) AS "NODESUM",
																											 SUM(STANDARD_SCORE) AS "SUMNODESCORE"
																											 --完成规则
																											 
																											 ------------------
																											 /*本年任务*/
																											 ------------------
																											 ------
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.PLAN_END_DATE, 'YYYY') = TO_CHAR(SYSDATE, 'YYYY') THEN
																																 1
																																ELSE
																																 0
																														END
																														
																														) AS "本年应完成",
																											 SUM((CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本年
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY') = TO_CHAR(SYSDATE, 'YYYY')
																																--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																 THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本年已完成"
																											 
																											 ------------------
																											 /*本月任务*/
																											 ------------------
																											 ------
																											 ,
																											 SUM((CASE
																																WHEN TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																			FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本月应完成",
																											 SUM((CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																 THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本月已完成"
																											 
																											 ,
																											 SUM((CASE
																														--按时完成
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(A1.PLAN_END_DATE, 'DD') - TRUNC(D.APPROVAL_TIME, 'DD')) BETWEEN 0 AND 29 THEN
																																 A1.STANDARD_SCORE * 1
																														--提前一个月完成
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL --判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(A1.PLAN_END_DATE, 'DD') - TRUNC(D.APPROVAL_TIME, 'DD')) >= 30 AND
																																		 A1.NODE_LEVEL = '里程碑' THEN
																																 A1.STANDARD_SCORE * 1.2
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(A1.PLAN_END_DATE, 'DD') - TRUNC(D.APPROVAL_TIME, 'DD')) >= 30 AND
																																		 A1.NODE_LEVEL = '一级节点' THEN
																																 A1.STANDARD_SCORE * 1.1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(A1.PLAN_END_DATE, 'DD') - TRUNC(D.APPROVAL_TIME, 'DD')) >= 30 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 A1.STANDARD_SCORE * 1.0
																														--延时完成
																														--里程碑、一级节点3天
																														--二三级节点5天
																														--延时完成
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('里程碑', '一级节点') THEN
																																 A1.STANDARD_SCORE * 0.6
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 3 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 A1.STANDARD_SCORE * 1.0
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 4 AND 7 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 A1.STANDARD_SCORE * 0.6
																														--红灯
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('里程碑', '一级节点') THEN
																																 A1.STANDARD_SCORE * 0
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 8 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 A1.STANDARD_SCORE * 0
																																ELSE
																																 0
																														END)) AS "本月动态得分"
																											 
																											 ------------------
																											 /*-里程碑完成情况*/
																											 ------------------
																											 ,
																											 SUM((CASE
																																WHEN A1. NODE_LEVEL = '里程碑' AND
																																		 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																			FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本月里程碑应完成",
																											 SUM((CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL AND A1.
																																 NODE_LEVEL = '里程碑' AND
																																		 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																			FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本月里程碑已完成"
																											 ------------------
																											 /*-一级节点完成情况*/
																											 ------------------
																											 ,
																											 SUM((CASE
																																WHEN A1. NODE_LEVEL = '一级节点' AND
																																		 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																			FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本月一级节点应完成",
																											 SUM((CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL AND A1.
																																 NODE_LEVEL = '一级节点' AND
																																		 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																			FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本月一级节点已完成"
																											 
																											 ------------------
																											 /*-里程碑本月亮灯情况*/
																											 ------------------
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) <= 0 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月里程碑绿灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月里程碑黄灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月里程碑红灯"
																											 
																											 ------------------
																											 /*一级节点本月亮灯情况*/
																											 ------------------
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) <= 0 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月一级节点绿灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月一级节点黄灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月一级节点红灯"
																											 
																											 ------------------
																											 /*二三级节点本月亮灯情况*/
																											 ------------------
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) <= 2 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月二三级节点绿灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 3 AND 7 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 3 AND 7 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月二三级节点黄灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 8 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 8 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月二三级节点红灯"
																							 
																							 FROM   POM_PROJ_PLAN A
																							 INNER  JOIN POM_PROJ_PLAN_NODE A1
																							 ON     A.ID = A1.PROJ_PLAN_ID
																							 INNER  JOIN SYS_PROJECT_STAGE C1
																							 ON     A.PROJ_ID = C1.ID
																							 INNER  JOIN SYS_PROJECT B1
																							 ON     C1.PROJECT_ID = B1.ID
																							 LEFT   JOIN POM_NODE_FEEDBACK D
																							 ON     D.FEEDBACK_NODE_ID = A1.ID AND
																											FEEDBACK_TYPE = '完成反馈' AND
																											D.APPROVAL_STATUS = '已审核'
																							 WHERE  A.PLAN_TYPE = '项目主项计划' AND
																											A.APPROVAL_STATUS = '已审核'
																							 GROUP  BY B1.UNIT_ID) B
																	ON     A.ID = B.UNIT_ID
																	WHERE  NVL(B.NODESUM, 0) > 0
																	CONNECT BY PRIOR A.ID = A.PARENT_ID) AB
												 GROUP  BY AB.ID, AB.PARENT_ID) B
						ON     A.ID = B.ID
						WHERE  A.ORG_TYPE = 0 AND
									 A.COMPANY_TYPE = '5' AND
									 A.PARENT_ID = '003200000000000000000000000000';
		
		ELSIF RANGETYPE = 20 THEN
				OPEN RANKDTL FOR
						SELECT ROW_NUMBER() OVER(PARTITION BY A.PARENT_ID ORDER BY ROUND(CASE
											 WHEN NVL(B.本年应完成, 0) > 0 THEN
												NVL(本年已完成, 0) / NVL(B.本年应完成, 0)
											 ELSE
												0
									 END * 100, 2) DESC) AS RANK, A.ID, A.PARENT_ID,
									 A.ORG_NAME, NVL(B.本年应完成, 0) AS 本年应完成,
									 NVL(B.本年已完成, 0) AS 本年已完成, NVL(B.本季度应完成, 0) AS 本季度应完成,
									 NVL(B.本季度已完成, 0) AS 本季度已完成
									 --     ,NVL(B.本月应完成,0) AS 本月应完成
									 --     ,NVL(B.本月已完成,0) AS 本月已完成
									 /*动态得分情况*/
									 --     ,NVL(B.本月动态得分,0) AS 本月动态得分
									, NVL(B.本季度动态得分, 0) AS 本季度动态得分
									 /*里程碑、一级节点完成情况*/
									 --     ,NVL(B.本月里程碑应完成,0) AS 本月里程碑应完成
									 --     ,NVL(B.本月里程碑已完成,0) AS 本月里程碑已完成
									 --     ,NVL(B.本月一级节点应完成,0) AS 本月一级节点应完成
									 --     ,NVL(B.本月一级节点已完成,0) AS 本月一级节点已完成
									, NVL(B.本季度里程碑应完成, 0) AS 本季度里程碑应完成,
									 NVL(B.本季度里程碑已完成, 0) AS 本季度里程碑已完成,
									 NVL(B.本季度一级节点应完成, 0) AS 本季度一级节点应完成,
									 NVL(B.本季度一级节点已完成, 0) AS 本季度一级节点已完成
									 /*亮点情况*/
									 --     ,NVL(B.本月里程碑绿灯,0) AS 本月里程碑绿灯
									 --     ,NVL(B.本月里程碑黄灯,0) AS 本月里程碑黄灯
									 --     ,NVL(B.本月里程碑红灯,0) AS 本月里程碑红灯
									 --     ,NVL(B.本月一级节点绿灯,0) AS 本月一级节点绿灯
									 --     ,NVL(B.本月一级节点黄灯,0) AS 本月一级节点黄灯
									 --     ,NVL(B.本月一级节点红灯,0) AS 本月一级节点红灯
									 --     ,NVL(B.本月二三级节点绿灯,0) AS 本月二三级节点绿灯
									 --     ,NVL(B.本月二三级节点黄灯,0) AS 本月二三级节点黄灯
									 --     ,NVL(B.本月二三级节点红灯,0) AS 本月二三级节点红灯
									, NVL(B.本季度里程碑绿灯, 0) AS 本季度里程碑绿灯,
									 NVL(B.本季度里程碑黄灯, 0) AS 本季度里程碑黄灯,
									 NVL(B.本季度里程碑红灯, 0) AS 本季度里程碑红灯,
									 NVL(B.本季度一级节点绿灯, 0) AS 本季度一级节点绿灯,
									 NVL(B.本季度一级节点黄灯, 0) AS 本季度一级节点黄灯,
									 NVL(B.本季度一级节点红灯, 0) AS 本季度一级节点红灯,
									 NVL(B.本季度二三级节点绿灯, 0) AS 本季度二三级节点绿灯,
									 NVL(B.本季度二三级节点黄灯, 0) AS 本季度二三级节点黄灯,
									 NVL(B.本季度二三级节点红灯, 0) AS 本季度二三级节点红灯
									 
									, 'TYPE_ORG' AS CTYPE
						FROM   SYS_BUSINESS_UNIT A
						LEFT   JOIN (SELECT AB.ID, AB.PARENT_ID, SUM(AB.本年应完成) AS 本年应完成,
																SUM(AB.本年已完成) AS 本年已完成,
																SUM(AB.本季度应完成) AS 本季度应完成,
																SUM(AB.本季度已完成) AS 本季度已完成
																--     ,SUM(AB.本月应完成) AS 本月应完成
																--     ,SUM(AB.本月已完成) AS 本月已完成
																/*动态得分情况*/
																--     ,SUM(AB.本月动态得分) AS 本月动态得分
															 , SUM(AB.本季度动态得分) AS 本季度动态得分
																/*里程碑、一级节点完成情况*/
																--     ,SUM(AB.本月里程碑应完成) AS 本月里程碑应完成
																--     ,SUM(AB.本月里程碑已完成) AS 本月里程碑已完成
																--     ,SUM(AB.本月一级节点应完成) AS 本月一级节点应完成
																--     ,SUM(AB.本月一级节点已完成) AS 本月一级节点已完成
															 , SUM(AB.本季度里程碑应完成) AS 本季度里程碑应完成,
																SUM(AB.本季度里程碑已完成) AS 本季度里程碑已完成,
																SUM(AB.本季度一级节点应完成) AS 本季度一级节点应完成,
																SUM(AB.本季度一级节点已完成) AS 本季度一级节点已完成
																/*亮点情况*/
																--     ,SUM(AB.本月里程碑绿灯) AS 本月里程碑绿灯
																--     ,SUM(AB.本月里程碑黄灯) AS 本月里程碑黄灯
																--     ,SUM(AB.本月里程碑红灯) AS 本月里程碑红灯
																--     ,SUM(AB.本月一级节点绿灯) AS 本月一级节点绿灯
																--     ,SUM(AB.本月一级节点黄灯) AS 本月一级节点黄灯
																--     ,SUM(AB.本月一级节点红灯) AS 本月一级节点红灯
																--     ,SUM(AB.本月二三级节点绿灯) AS 本月二三级节点绿灯
																--     ,SUM(AB.本月二三级节点黄灯) AS 本月二三级节点黄灯
																--     ,SUM(AB.本月二三级节点红灯) AS 本月二三级节点红灯
															 , SUM(AB.本季度里程碑绿灯) AS 本季度里程碑绿灯,
																SUM(AB.本季度里程碑黄灯) AS 本季度里程碑黄灯,
																SUM(AB.本季度里程碑红灯) AS 本季度里程碑红灯,
																SUM(AB.本季度一级节点绿灯) AS 本季度一级节点绿灯,
																SUM(AB.本季度一级节点黄灯) AS 本季度一级节点黄灯,
																SUM(AB.本季度一级节点红灯) AS 本季度一级节点红灯,
																SUM(AB.本季度二三级节点绿灯) AS 本季度二三级节点绿灯,
																SUM(AB.本季度二三级节点黄灯) AS 本季度二三级节点黄灯,
																SUM(AB.本季度二三级节点红灯) AS 本季度二三级节点红灯
												 FROM   (
																	--  11
																	
																	SELECT
																	/*完成情况*/
																	 NVL(B.本年应完成, 0) AS 本年应完成,
																		NVL(B.本年已完成, 0) AS 本年已完成,
																		NVL(B.本季度应完成, 0) AS 本季度应完成,
																		NVL(B.本季度已完成, 0) AS 本季度已完成
																		--                    ,NVL(B.本月应完成,0) AS 本月应完成
																		--                    ,NVL(B.本月已完成,0) AS 本月已完成
																		/*动态得分情况*/
																		--                    ,NVL(B.本月动态得分,0) AS 本月动态得分
																	, NVL(B.本季度动态得分, 0) AS 本季度动态得分
																		/*里程碑、一级节点完成情况*/
																		--                    ,NVL(B.本月里程碑应完成,0) AS 本月里程碑应完成
																		--                    ,NVL(B.本月里程碑已完成,0) AS 本月里程碑已完成
																		--                    ,NVL(B.本月一级节点应完成,0) AS 本月一级节点应完成
																		--                    ,NVL(B.本月一级节点已完成,0) AS 本月一级节点已完成
																	, NVL(B.本季度里程碑应完成, 0) AS 本季度里程碑应完成,
																		NVL(B.本季度里程碑已完成, 0) AS 本季度里程碑已完成,
																		NVL(B.本季度一级节点应完成, 0) AS 本季度一级节点应完成,
																		NVL(B.本季度一级节点已完成, 0) AS 本季度一级节点已完成
																		/*亮点情况*/
																		--                    ,NVL(B.本月里程碑绿灯,0) AS 本月里程碑绿灯
																		--                    ,NVL(B.本月里程碑黄灯,0) AS 本月里程碑黄灯
																		--                    ,NVL(B.本月里程碑红灯,0) AS 本月里程碑红灯
																		--                    ,NVL(B.本月一级节点绿灯,0) AS 本月一级节点绿灯
																		--                    ,NVL(B.本月一级节点黄灯,0) AS 本月一级节点黄灯
																		--                    ,NVL(B.本月一级节点红灯,0) AS 本月一级节点红灯
																		--                    ,NVL(B.本月二三级节点绿灯,0) AS 本月二三级节点绿灯
																		--                    ,NVL(B.本月二三级节点黄灯,0) AS 本月二三级节点黄灯
																		--                    ,NVL(B.本月二三级节点红灯,0) AS 本月二三级节点红灯
																	, NVL(B.本季度里程碑绿灯, 0) AS 本季度里程碑绿灯,
																		NVL(B.本季度里程碑黄灯, 0) AS 本季度里程碑黄灯,
																		NVL(B.本季度里程碑红灯, 0) AS 本季度里程碑红灯,
																		NVL(B.本季度一级节点绿灯, 0) AS 本季度一级节点绿灯,
																		NVL(B.本季度一级节点黄灯, 0) AS 本季度一级节点黄灯,
																		NVL(B.本季度一级节点红灯, 0) AS 本季度一级节点红灯,
																		NVL(B.本季度二三级节点绿灯, 0) AS 本季度二三级节点绿灯,
																		NVL(B.本季度二三级节点黄灯, 0) AS 本季度二三级节点黄灯,
																		NVL(B.本季度二三级节点红灯, 0) AS 本季度二三级节点红灯,
																		CONNECT_BY_ROOT ID AS ID,
																		CONNECT_BY_ROOT PARENT_ID AS PARENT_ID
																	FROM   SYS_BUSINESS_UNIT A
																	LEFT   JOIN (
																							 
																							 SELECT B1.UNIT_ID,
																											 COUNT(A1.ID) AS "NODESUM",
																											 SUM(STANDARD_SCORE) AS "SUMNODESCORE"
																											 --完成规则
																											 
																											 ------------------
																											 /*本年任务*/
																											 ------------------
																											 ------
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.PLAN_END_DATE, 'YYYY') = TO_CHAR(SYSDATE, 'YYYY') THEN
																																 1
																																ELSE
																																 0
																														END
																														
																														) AS "本年应完成",
																											 SUM((CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本年
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY') = TO_CHAR(SYSDATE, 'YYYY')
																																--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																 THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本年已完成"
																											 
																											 ------------------
																											 /*本季度任务*/
																											 ------------------
																											 ------
																											 ,
																											 SUM((CASE
																																WHEN
																																--判断季度
																																 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																 (SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																	FROM   V_POM_GETEXAMINE_QUARTER A) AND
																																 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																	FROM   V_POM_GETEXAMINE_QUARTER A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本季度应完成",
																											 SUM((CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																 THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本季度已完成"
																											 
																											 ,
																											 SUM((CASE
																														--按时完成
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(A1.PLAN_END_DATE, 'DD') - TRUNC(D.APPROVAL_TIME, 'DD')) BETWEEN 0 AND 29 THEN
																																 A1.STANDARD_SCORE * 1
																														
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL --判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(A1.PLAN_END_DATE, 'DD') - TRUNC(D.APPROVAL_TIME, 'DD')) >= 30 AND
																																		 A1.NODE_LEVEL = '里程碑' THEN
																																 A1.STANDARD_SCORE * 1.2
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(A1.PLAN_END_DATE, 'DD') - TRUNC(D.APPROVAL_TIME, 'DD')) >= 30 AND
																																		 A1.NODE_LEVEL = '一级节点' THEN
																																 A1.STANDARD_SCORE * 1.1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(A1.PLAN_END_DATE, 'DD') - TRUNC(D.APPROVAL_TIME, 'DD')) >= 30 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 A1.STANDARD_SCORE * 1.0
																														--延时完成
																														--里程碑、一级节点3天
																														--二三级节点5天
																														--延时完成
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('里程碑', '一级节点') THEN
																																 A1.STANDARD_SCORE * 0.6
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 3 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 A1.STANDARD_SCORE * 1.0
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 4 AND 7 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 A1.STANDARD_SCORE * 0.6
																														--红灯
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('里程碑', '一级节点') THEN
																																 A1.STANDARD_SCORE * 0
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 8 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 A1.STANDARD_SCORE * 0
																																ELSE
																																 0
																														END)) AS "本季度动态得分"
																											 
																											 ------------------
																											 /*-里程碑完成情况*/
																											 ------------------
																											 ,
																											 SUM((CASE
																																WHEN A1. NODE_LEVEL = '里程碑' AND
																																		 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																			 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本季度里程碑应完成",
																											 SUM((CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL AND A1.
																																 NODE_LEVEL = '里程碑' AND
																																		 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本季度里程碑已完成"
																											 ------------------
																											 /*-一级节点完成情况*/
																											 ------------------
																											 ,
																											 SUM((CASE
																																WHEN A1. NODE_LEVEL = '一级节点' AND
																																		 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																			 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本季度一级节点应完成",
																											 SUM((CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL AND A1.
																																 NODE_LEVEL = '一级节点' AND
																																		 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本季度一级节点已完成"
																											 
																											 ------------------
																											 /*-里程碑本季度亮灯情况*/
																											 ------------------
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) <= 0 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度里程碑绿灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度里程碑黄灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度里程碑红灯"
																											 
																											 ------------------
																											 /*一级节点本季度亮灯情况*/
																											 ------------------
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) <= 0 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度一级节点绿灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度一级节点黄灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度一级节点红灯"
																											 
																											 ------------------
																											 /*二三级节点本季度亮灯情况*/
																											 ------------------
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) <= 2 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度二三级节点绿灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 3 AND 7 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 3 AND 7 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度二三级节点黄灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 8 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 8 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度二三级节点红灯"
																							 
																							 FROM   POM_PROJ_PLAN A
																							 INNER  JOIN POM_PROJ_PLAN_NODE A1
																							 ON     A.ID = A1.PROJ_PLAN_ID
																							 INNER  JOIN SYS_PROJECT_STAGE C1
																							 ON     A.PROJ_ID = C1.ID
																							 INNER  JOIN SYS_PROJECT B1
																							 ON     C1.PROJECT_ID = B1.ID
																							 LEFT   JOIN POM_NODE_FEEDBACK D
																							 ON     D.FEEDBACK_NODE_ID = A1.ID AND
																											FEEDBACK_TYPE = '完成反馈' AND
																											D.APPROVAL_STATUS = '已审核'
																							 WHERE  A.PLAN_TYPE = '项目主项计划' AND
																											A.APPROVAL_STATUS = '已审核'
																							 GROUP  BY B1.UNIT_ID) B
																	ON     A.ID = B.UNIT_ID
																	WHERE  NVL(B.NODESUM, 0) > 0
																	CONNECT BY PRIOR A.ID = A.PARENT_ID) AB
												 GROUP  BY AB.ID, AB.PARENT_ID) B
						ON     A.ID = B.ID
						WHERE  A.ORG_TYPE = 0 AND
									 A.COMPANY_TYPE = '5' AND
									 A.PARENT_ID = '003200000000000000000000000000';
		END IF;

END P_POM_RANK_ORG_GETDTL;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_RANK_PROJ_EXAM_DTL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_RANK_PROJ_EXAM_DTL" (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    rangetype      IN             INT,--时间范围类型（10:月度，20季度）
    rangeval       IN             VARCHAR2,--范围值，月度：2019|09。季度：2019|04
    orgid          IN             VARCHAR2,--组织id(关键节点计划传空,项目主项计划传）
    title          OUT            VARCHAR2,
    info           OUT            SYS_REFCURSOR--需要程序组装树
) AS
--公司考核排行详情
--作者：陈丽
--日期：2019/11/13
BEGIN




IF rangetype=10 then
   OPEN info FOR



with 树 ( 

ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH
,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯, CTYPE
)as( 



select   
ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分
	,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成
	,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯
,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯
,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯
, CTYPE
from POM_PJPLAN_EXM_SOCRE_TABLE where plan_type='项目主项计划' and PLANYEAR= SUBSTR(rangeval, 0, 4)


UNION all 
select    
a2.ID,a2.PARENT_ID,a2.ORG_NAME,a1.PLAN_TYPE,a1.PROJECT_NAME ,a2.ORDER_CODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成
,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成
,三级节点已完成,里程碑绿灯,一级节点绿灯,二级节点绿灯
,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯
,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯
,三级节点红灯
, 'TYPE_ORG' as CTYPE

from  树 a1 INNER JOIN　SYS_BUSINESS_UNIT a2 on a1.parent_id=a2.id 

		where is_company=1 --and (a2.PARENT_ID='003200000000000000000000000000' or a2.id='003200000000000000000000000000')


		)





,结果 as( 

select ORG_NAME  AS "company"

     ,  ID AS "orgId"
 		 , CASE  WHEN  ID='003200000000000000000000000000'  THEN NULL ELSE PARENT_ID END    AS "parentId"
    --,TO_CHAR(ROUND(CASE WHEN SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  应完成  ELSE 0 END )>0 THEN   SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  已完成  ELSE 0 END)/SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  应完成  ELSE 0 END )*100  ELSE 0 END,2) )   AS  "yearPercentageComplete"
    ,TO_CHAR(SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  应完成  ELSE 0 END)) AS "yearShouldComplete"--本年应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  已完成  ELSE 0 END) AS "yearDone"--本年已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  应完成  ELSE 0 END) - SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  已完成  ELSE 0 END) AS "yearUnfinished"--本年未完成数
   	 ,ROUND(CASE WHEN SUM(CASE WHEN  LPAD( (SUBSTR( RANGEVAL, 6, 1 )),2,'0')= PLANMOTH THEN SUMNODESCORE ELSE 0	END) > 0 THEN
													SUM(CASE	WHEN LPAD( (SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN 动态得分	ELSE	 0	END) 
													/ SUM(CASE WHEN LPAD( (SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN	SUMNODESCORE ELSE				0 END) * 100												 ELSE	0	 END, 2) AS "dynamicScoring"
    ,SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  应完成  ELSE 0 END) AS "monthShouldComplete"--本月、季度应完成数
    ,SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  SUMNODESCORE  ELSE 0 END) AS "monthShouldCompleteScore"--本月应完成总分
    ,SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  已完成  ELSE 0 END)  AS "monthdDone"--本月、季度已完成数
    ,SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  已完成总分  ELSE 0 END)  AS "monthdDoneScore"--本月已完成总分
    ,SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  应完成  ELSE 0 END)  - SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  已完成  ELSE 0 END)  AS "monthUnfinished"--本月未完成数
    ,SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  里程碑红灯  ELSE 0 END) +SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  一级节点红灯  ELSE 0 END) +SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN   二级节点红灯 + 三级节点红灯  ELSE 0 END)  AS "red"--红灯数
    ,SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  里程碑黄灯  ELSE 0 END) +SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  一级节点黄灯  ELSE 0 END) +SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  二级节点黄灯+三级节点黄灯  ELSE 0 END)   AS "yellow"--黄灯数
    ,SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  里程碑绿灯  ELSE 0 END) +SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  一级节点绿灯  ELSE 0 END) +SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  二级节点绿灯+三级节点绿灯  ELSE 0 END)  AS "green"--绿灯数
    ,SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  里程碑应完成  ELSE 0 END)  AS "milestoneShouldComplete"--里程碑应完成数
    ,SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  里程碑已完成  ELSE 0 END) AS "milestoneDone"--里程碑已完成数
    ,SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  里程碑应完成  ELSE 0 END)-SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  里程碑已完成  ELSE 0 END) AS "milestoneUnfinished"--里程碑未完成数
    ,SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  一级节点应完成  ELSE 0 END) AS "oneLevelNodeShouldComplete"--一级节点应完成数
    ,SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  一级节点已完成  ELSE 0 END)  AS "oneLevelNodeDone"--一级节点已完成数
    ,SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  一级节点应完成  ELSE 0 END) -SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  一级节点已完成  ELSE 0 END)   AS "oneLevelNodeUnfinished"--一级节点未完成数
 --
    ,SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  二级节点应完成  ELSE 0 END) AS "twoLevelNodeShouldComplete"--二级节点应完成数
    ,SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  二级节点已完成  ELSE 0 END)  AS "twoLevelNodeDone"--二级节点已完成数
    ,SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  二级节点应完成  ELSE 0 END) -SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  二级节点已完成  ELSE 0 END)   AS "twoLevelNodeUnfinished"--二级节点未完成数
      ,SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  三级节点应完成  ELSE 0 END) AS "threeLevelNodeShouldComplete"--三级节点应完成数
    ,SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  三级节点已完成  ELSE 0 END)  AS "threeLevelNodeDone"--三级节点已完成数
    ,SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  三级节点应完成  ELSE 0 END) -SUM(CASE WHEN LPAD( SUBSTR(rangeval, 6, 2) , 2,'0')=PLANMOTH  THEN  三级节点已完成  ELSE 0 END)   AS "threeLevelNodeUnfinished"--三级节点未完成数
    ,    '' as  "openUrl"--打开地址
 --

 FROM 树 a where 1=1 
group by org_name,    id,    parent_id,ORGCODE



)

    select * from 结果  
ORDER BY  "dynamicScoring" desc
;





ELSIF rangetype=20 then
   OPEN info FOR



with 树 ( 

ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH
,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯, CTYPE
)as( 



select   
ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分
	,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成
	,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯
,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯
,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯
, CTYPE
from POM_PJPLAN_EXM_SOCRE_TABLE where plan_type='项目主项计划' and PLANYEAR= SUBSTR(rangeval, 0, 4)


UNION all 
select    
a2.ID,a2.PARENT_ID,a2.ORG_NAME,a1.PLAN_TYPE,a1.PROJECT_NAME ,a2.ORDER_CODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成
,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成
,三级节点已完成,里程碑绿灯,一级节点绿灯,二级节点绿灯
,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯
,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯
,三级节点红灯
, 'TYPE_ORG' as CTYPE

from  树 a1 INNER JOIN　SYS_BUSINESS_UNIT a2 on a1.parent_id=a2.id 

		where is_company=1 --and (a2.PARENT_ID='003200000000000000000000000000' or a2.id='003200000000000000000000000000')


		)





,结果 as( 

select ORG_NAME  AS "company"

     ,  ID AS "orgId"
 		 , CASE  WHEN  ID='003200000000000000000000000000'  THEN NULL ELSE PARENT_ID END    AS "parentId"
    --,TO_CHAR(ROUND(CASE WHEN SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  应完成  ELSE 0 END )>0 THEN   SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  已完成  ELSE 0 END)/SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  应完成  ELSE 0 END )*100  ELSE 0 END,2) )   AS  "yearPercentageComplete"
    ,TO_CHAR(SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  应完成  ELSE 0 END)) AS "yearShouldComplete"--本年应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  已完成  ELSE 0 END) AS "yearDone"--本年已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  应完成  ELSE 0 END) - SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  已完成  ELSE 0 END) AS "yearUnfinished"--本年未完成数
   , ROUND( case when SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN SUMNODESCORE ELSE 0 END) >0 then  SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 动态得分 ELSE 0 END)
/ SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN SUMNODESCORE ELSE 0 END) * 100  else 0 end, 2) AS "dynamicScoring" --本月、季度动态得分

    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  应完成  ELSE 0 END) AS "quarterShouldComplete"--本月、季度应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  SUMNODESCORE  ELSE 0 END) AS "quarterShouldCompleteScore"--本月应完成总分
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  已完成  ELSE 0 END)  AS "quarterDone"--本月、季度已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  已完成总分  ELSE 0 END)  AS "quarterDoneScore"--本月已完成总分
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  应完成  ELSE 0 END)  - SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  已完成  ELSE 0 END)  AS "quarterUnfinished"--本月未完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  里程碑红灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  一级节点红灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN   二级节点红灯 + 三级节点红灯  ELSE 0 END)  AS "red"--红灯数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  里程碑黄灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  一级节点黄灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  二级节点黄灯+三级节点黄灯  ELSE 0 END)   AS "yellow"--黄灯数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  里程碑绿灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  一级节点绿灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  二级节点绿灯+三级节点绿灯  ELSE 0 END)  AS "green"--绿灯数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  里程碑应完成  ELSE 0 END)  AS "milestoneShouldComplete"--里程碑应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  里程碑已完成  ELSE 0 END) AS "milestoneDone"--里程碑已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  里程碑应完成  ELSE 0 END)-SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  里程碑已完成  ELSE 0 END) AS "milestoneUnfinished"--里程碑未完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  一级节点应完成  ELSE 0 END) AS "oneLevelNodeShouldComplete"--一级节点应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  一级节点已完成  ELSE 0 END)  AS "oneLevelNodeDone"--一级节点已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  一级节点应完成  ELSE 0 END) -SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  一级节点已完成  ELSE 0 END)   AS "oneLevelNodeUnfinished"--一级节点未完成数
 --
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  二级节点应完成  ELSE 0 END) AS "twoLevelNodeShouldComplete"--二级节点应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  二级节点已完成  ELSE 0 END)  AS "twoLevelNodeDone"--二级节点已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  二级节点应完成  ELSE 0 END) -SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  二级节点已完成  ELSE 0 END)   AS "twoLevelNodeUnfinished"--二级节点未完成数
      ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  三级节点应完成  ELSE 0 END) AS "threeLevelNodeShouldComplete"--三级节点应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  三级节点已完成  ELSE 0 END)  AS "threeLevelNodeDone"--三级节点已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  三级节点应完成  ELSE 0 END) -SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  三级节点已完成  ELSE 0 END)   AS "threeLevelNodeUnfinished"--三级节点未完成数
    ,    '' as  "openUrl"--打开地址
 --

 FROM 树 a where 1=1 
group by org_name,    id,    parent_id,ORGCODE



)

    select * from 结果  
ORDER BY  "dynamicScoring" desc
;




END  IF;
    title := '考核排行榜_主项目计划明细数据统计';
END p_pom_rank_proj_exam_dtl;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_RANK_PROJ_EXAM_DTLTEST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_RANK_PROJ_EXAM_DTLTEST" 
(
orgid   IN  VARCHAR2,
info           OUT            SYS_REFCURSOR
)
AS
BEGIN

OPEN info FOR
SELECT
  row_number() over( PARTITION  BY A.PARENT_ID  order by ROUND( CASE WHEN NVL(B.应完成,0)>0 THEN nvl(已完成,0)/NVL(B.应完成,0) ELSE 0 END *100,2) desc) as rank ,
  '项目主项计划'AS  PLAN_TYPE,A.ID,A.PARENT_ID,A.ORG_NAME ,B.PLANYEAR  ,B.PLANQUATOR,B.PLANMOTH
--     ,NVL(B.本季度应完成,0) AS 本季度应完成
--     ,NVL(B.本季度已完成,0) AS 本季度已完成
    ,NVL(B.应完成,0) AS 应完成
    ,NVL(B.已完成,0) AS 已完成
    /*动态得分情况*/
    , NVL(B.动态得分,0) AS 动态得分
    ,NVL(B.SUMNODESCORE,0) AS SUMNODESCORE
--     ,NVL(B.本季度动态得分,0) AS 本季度动态得分
    /*里程碑、一级节点完成情况*/
    ,NVL(B.里程碑应完成,0) AS 里程碑应完成
    ,NVL(B.里程碑已完成,0) AS 里程碑已完成
    ,NVL(B.一级节点应完成,0) AS 一级节点应完成
    ,NVL(B.一级节点已完成,0) AS 一级节点已完成
    ,NVL(B.二级节点应完成,0) AS 二级节点应完成
    ,NVL(B.二级节点已完成,0) AS 二级节点已完成
    ,NVL(B.三级节点应完成,0) AS 三级节点应完成
    ,NVL(B.三级节点已完成,0) AS 三级节点已完成
--     ,NVL(B.本季度里程碑应完成,0) AS 本季度里程碑应完成
--     ,NVL(B.本季度里程碑已完成,0) AS 本季度里程碑已完成
--     ,NVL(B.本季度一级节点应完成,0) AS 本季度一级节点应完成
--     ,NVL(B.本季度一级节点已完成,0) AS 本季度一级节点已完成
    /*亮点情况*/
    ,NVL(B.里程碑绿灯,0) AS 里程碑绿灯
    ,NVL(B.里程碑黄灯,0) AS 里程碑黄灯
    ,NVL(B.里程碑红灯,0) AS 里程碑红灯
    ,NVL(B.一级节点绿灯,0) AS 一级节点绿灯
    ,NVL(B.一级节点黄灯,0) AS 一级节点黄灯
    ,NVL(B.一级节点红灯,0) AS 一级节点红灯
    ,NVL(B.二级节点绿灯,0) AS 二级节点绿灯
    ,NVL(B.二级节点黄灯,0) AS 二级节点黄灯
    ,NVL(B.二级节点红灯,0) AS 二级节点红灯
    ,NVL(B.三级节点绿灯,0) AS 三级节点绿灯
    ,NVL(B.三级节点黄灯,0) AS 三级节点黄灯
    ,NVL(B.三级节点红灯,0) AS 三级节点红灯

--     ,NVL(B.本季度里程碑绿灯,0) AS 本季度里程碑绿灯
--     ,NVL(B.本季度里程碑黄灯,0) AS 本季度里程碑黄灯
--     ,NVL(B.本季度里程碑红灯,0) AS 本季度里程碑红灯
--     ,NVL(B.本季度一级节点绿灯,0) AS 本季度一级节点绿灯
--     ,NVL(B.本季度一级节点黄灯,0) AS 本季度一级节点黄灯
--     ,NVL(B.本季度一级节点红灯,0) AS 本季度一级节点红灯
--     ,NVL(B.本季度二三级节点绿灯,0) AS 本季度二三级节点绿灯
--     ,NVL(B.本季度二三级节点黄灯,0) AS 本季度二三级节点黄灯
--     ,NVL(B.本季度二三级节点红灯,0) AS 本季度二三级节点红灯

  ,'TYPE_ORG' AS CTYPE
FROM SYS_BUSINESS_UNIT A LEFT JOIN  (
 SELECT AB.ID,AB.PARENT_ID
 ,AB.PLANYEAR  ,AB.PLANQUATOR,AB.PLANMOTH
--     ,SUM(AB.本季度应完成) AS 本季度应完成
--     ,SUM(AB.本季度已完成) AS 本季度已完成
    ,SUM(AB.应完成) AS 应完成
    ,SUM(AB.已完成) AS 已完成
    /*动态得分情况*/
    ,SUM(AB.动态得分) AS 动态得分
    ,SUM(AB.SUMNODESCORE) AS SUMNODESCORE
--     ,SUM(AB.本季度动态得分) AS 本季度动态得分
    /*里程碑、一级节点完成情况*/
    ,SUM(AB.里程碑应完成) AS 里程碑应完成
     ,SUM(AB.里程碑已完成) AS 里程碑已完成
     ,SUM(AB.一级节点应完成) AS 一级节点应完成
     ,SUM(AB.一级节点已完成) AS 一级节点已完成
     ,SUM(AB.二级节点应完成) AS 二级节点应完成
     ,SUM(AB.二级节点已完成) AS 二级节点已完成
     ,SUM(AB.三级节点应完成) AS 三级节点应完成
     ,SUM(AB.三级节点已完成) AS 三级节点已完成
  --                    ,NVL(B.本季度里程碑应完成,0) AS 本季度里程碑应完成
  --                    ,NVL(B.本季度里程碑已完成,0) AS 本季度里程碑已完成
  --                    ,NVL(B.本季度一级节点应完成,0) AS 本季度一级节点应完成
  --                    ,NVL(B.本季度一级节点已完成,0) AS 本季度一级节点已完成
     /*亮点情况*/
     ,SUM(AB.里程碑绿灯) AS 里程碑绿灯
     ,SUM(AB.里程碑黄灯) AS 里程碑黄灯
     ,SUM(AB.里程碑红灯) AS 里程碑红灯
     ,SUM(AB.一级节点绿灯) AS 一级节点绿灯
     ,SUM(AB.一级节点黄灯) AS 一级节点黄灯
     ,SUM(AB.一级节点红灯) AS 一级节点红灯
     ,SUM(AB.二级节点绿灯) AS 二级节点绿灯
     ,SUM(AB.二级节点黄灯) AS 二级节点黄灯
     ,SUM(AB.二级节点红灯) AS 二级节点红灯
     ,SUM(AB.三级节点绿灯) AS 三级节点绿灯
     ,SUM(AB.三级节点黄灯) AS 三级节点黄灯
     ,SUM(AB.三级节点红灯) AS 三级节点红灯

--     ,SUM(AB.本季度里程碑绿灯) AS 本季度里程碑绿灯
--     ,SUM(AB.本季度里程碑黄灯) AS 本季度里程碑黄灯
--     ,SUM(AB.本季度里程碑红灯) AS 本季度里程碑红灯
--     ,SUM(AB.本季度一级节点绿灯) AS 本季度一级节点绿灯
--     ,SUM(AB.本季度一级节点黄灯) AS 本季度一级节点黄灯
--     ,SUM(AB.本季度一级节点红灯) AS 本季度一级节点红灯
--     ,SUM(AB.本季度二三级节点绿灯) AS 本季度二三级节点绿灯
--     ,SUM(AB.本季度二三级节点黄灯) AS 本季度二三级节点黄灯
--     ,SUM(AB.本季度二三级节点红灯) AS 本季度二三级节点红灯
     FROM  (
--  11

                   SELECT
                  /*完成情况*/
--                    ,NVL(B.本季度应完成,0) AS 本季度应完成
--                    ,NVL(B.本季度已完成,0) AS 本季度已完成
                    B.PLANYEAR
                    ,B.PLANQUATOR
                    ,B.PLANMOTH
                   ,NVL(B.应完成,0) AS 应完成
                   ,NVL(B.已完成,0) AS 已完成
                   /*动态得分情况*/
                   ,NVL(B.SUMNODESCORE,0)  AS "SUMNODESCORE"
                   ,NVL(B.动态得分,0) AS 动态得分
--                    ,NVL(B.本季度动态得分,0) AS 本季度动态得分
                   /*里程碑、一级节点完成情况*/
                   ,NVL(B.里程碑应完成,0) AS 里程碑应完成
                   ,NVL(B.里程碑已完成,0) AS 里程碑已完成
                   ,NVL(B.一级节点应完成,0) AS 一级节点应完成
                   ,NVL(B.一级节点已完成,0) AS 一级节点已完成
                   ,NVL(B.二级节点应完成,0) AS 二级节点应完成
                   ,NVL(B.二级节点已完成,0) AS 二级节点已完成
                   ,NVL(B.三级节点应完成,0) AS 三级节点应完成
                   ,NVL(B.三级节点已完成,0) AS 三级节点已完成
--                    ,NVL(B.本季度里程碑应完成,0) AS 本季度里程碑应完成
--                    ,NVL(B.本季度里程碑已完成,0) AS 本季度里程碑已完成
--                    ,NVL(B.本季度一级节点应完成,0) AS 本季度一级节点应完成
--                    ,NVL(B.本季度一级节点已完成,0) AS 本季度一级节点已完成
                   /*亮点情况*/
                   ,NVL(B.里程碑绿灯,0) AS 里程碑绿灯
                   ,NVL(B.里程碑黄灯,0) AS 里程碑黄灯
                   ,NVL(B.里程碑红灯,0) AS 里程碑红灯
                   ,NVL(B.一级节点绿灯,0) AS 一级节点绿灯
                   ,NVL(B.一级节点黄灯,0) AS 一级节点黄灯
                   ,NVL(B.一级节点红灯,0) AS 一级节点红灯
                   ,NVL(B.二级节点绿灯,0) AS 二级节点绿灯
                   ,NVL(B.二级节点黄灯,0) AS 二级节点黄灯
                   ,NVL(B.二级节点红灯,0) AS 二级节点红灯
                   ,NVL(B.三级节点绿灯,0) AS 三级节点绿灯
                   ,NVL(B.三级节点黄灯,0) AS 三级节点黄灯
                   ,NVL(B.三级节点红灯,0) AS 三级节点红灯

--                    ,NVL(B.本季度里程碑绿灯,0) AS 本季度里程碑绿灯
--                    ,NVL(B.本季度里程碑黄灯,0) AS 本季度里程碑黄灯
--                    ,NVL(B.本季度里程碑红灯,0) AS 本季度里程碑红灯
--                    ,NVL(B.本季度一级节点绿灯,0) AS 本季度一级节点绿灯
--                    ,NVL(B.本季度一级节点黄灯,0) AS 本季度一级节点黄灯
--                    ,NVL(B.本季度一级节点红灯,0) AS 本季度一级节点红灯
--                    ,NVL(B.本季度二三级节点绿灯,0) AS 本季度二三级节点绿灯
--                    ,NVL(B.本季度二三级节点黄灯,0) AS 本季度二三级节点黄灯
--                    ,NVL(B.本季度二三级节点红灯,0) AS 本季度二三级节点红灯
                   ,CONNECT_BY_ROOT ID AS  ID ,CONNECT_BY_ROOT PARENT_ID  AS  PARENT_ID
                   from   SYS_BUSINESS_UNIT A  LEFT JOIN
                   (


                   SELECT  B1.UNIT_ID ,COUNT(A1.ID) AS "NODESUM"

                , TO_CHAR(A1.PLAN_END_DATE,'YYYY')   AS  "PLANYEAR"
                , CASE WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '12-26'  AND '03-25'  THEN 1
                       WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '03-26'  AND '06-25'  THEN 2
                       WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '06-26'  AND '09-25'  THEN 3
                       WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '09-26'  AND '12-25'  THEN 4  END
                      AS "PLANQUATOR"
                ,CASE
                        WHEN
                        CASE
                            WHEN TO_CHAR( PLAN_END_DATE, 'DD' ) > 25 THEN
                            TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) )
                          END > 12 THEN
                    1 ELSE
                  CASE
                      WHEN TO_CHAR( PLAN_END_DATE, 'DD' ) > 25 THEN
                      TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) )
                    END
                    END AS "PLANMOTH"
                  ,SUM(STANDARD_SCORE)   AS "SUMNODESCORE"
                   --完成规则




                   ------------------
                   /*任务*/
                   ------------------
                   ------
                  , SUM(
                    (CASE
                      WHEN
                        TO_CHAR( A1.PLAN_END_DATE, 'YYYY-MM-DD' ) IS NOT NULL

                      THEN    1
                      ELSE 0
                      END
                      )
                    ) AS "应完成"
                  ,SUM( (CASE      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                   --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                     THEN     1  ELSE    0 END))   AS "已完成"

                  ,SUM(
                  (CASE
                  --按时完成
                      WHEN
                          TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                         --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                        AND  (TRUNC( A1.PLAN_END_DATE, 'DD' ) -TRUNC( D.APPROVAL_TIME, 'DD' ) )BETWEEN 0 AND 29
                      THEN   A1.STANDARD_SCORE*1
                      --提前一个月完成
                      WHEN
                          TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
                          --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( A1.PLAN_END_DATE, 'DD' ) -TRUNC( D.APPROVAL_TIME, 'DD' ) )>= 30   AND  A1.NODE_LEVEL='里程碑'
                      THEN   A1.STANDARD_SCORE*1.2
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                         --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                        AND  (TRUNC( A1.PLAN_END_DATE, 'DD' ) -TRUNC( D.APPROVAL_TIME, 'DD' ) )>= 30   AND  A1.NODE_LEVEL='一级节点'
                      THEN   A1.STANDARD_SCORE*1.1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                         --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'

                          AND  (TRUNC( A1.PLAN_END_DATE, 'DD' ) - TRUNC( D.APPROVAL_TIME, 'DD' ) )>= 30   AND  A1.NODE_LEVEL IN ('二级节点' ,'三级节点')
                      THEN   A1.STANDARD_SCORE*1.0
                  --延时完成
                  --里程碑、一级节点3天
                  --二三级节点5天
                  --延时完成
                    WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                         --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'

                        AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC(A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 1 AND 4 AND   A1.NODE_LEVEL IN ('里程碑' ,'一级节点')
                    THEN   A1.STANDARD_SCORE*0.6
                    WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                         --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'

                        AND  ( TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC(A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 1 AND 3 AND A1.NODE_LEVEL IN ('二级节点' ,'三级节点')
                    THEN   A1.STANDARD_SCORE*1.0
                    WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                       --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                        AND  ( TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC(A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 4 AND 7 AND A1.NODE_LEVEL IN ('二级节点' ,'三级节点')
                    THEN   A1.STANDARD_SCORE*0.6
                  --红灯
                    WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                       --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'

                      AND  ( TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC(A1.PLAN_END_DATE, 'DD' )  )  >=5 AND    A1.NODE_LEVEL IN ('里程碑' ,'一级节点')
                    THEN   A1.STANDARD_SCORE*0
                    WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                       --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'

                      AND  ( TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC(A1.PLAN_END_DATE, 'DD' )  )>=8  AND  A1.NODE_LEVEL IN ('二级节点' ,'三级节点')
                    THEN   A1.STANDARD_SCORE*0
                  ELSE  0 END
                  )
                  )   AS "动态得分"

                   ------------------
                   /*-里程碑完成情况*/
                   ------------------
                  ,SUM((CASE  WHEN      A1. NODE_LEVEL='里程碑'

                              THEN   1  ELSE    0 END))   AS "里程碑应完成"
                  ,SUM((CASE  WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
                              AND A1. NODE_LEVEL='里程碑'
                              THEN   1  ELSE    0 END))   AS "里程碑已完成"
                   ------------------
                   /*-一级节点完成情况*/
                   ------------------
                  ,SUM((CASE   WHEN     A1. NODE_LEVEL='一级节点'
                                THEN   1  ELSE    0 END))   AS "一级节点应完成"
                  ,SUM((CASE   WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
                              AND A1. NODE_LEVEL='一级节点'
                                   THEN   1  ELSE    0 END))   AS "一级节点已完成"
                   ------------------
                   /*-二级节点完成情况*/
                   ------------------
                  ,SUM((CASE   WHEN     A1. NODE_LEVEL='二级节点'
                                THEN   1  ELSE    0 END))   AS "二级节点应完成"
                  ,SUM((CASE   WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
                              AND A1. NODE_LEVEL='二级节点'
                                   THEN   1  ELSE    0 END))   AS "二级节点已完成"
                     ------------------
                   /*-三级节点完成情况*/
                   ------------------
                  ,SUM((CASE   WHEN     A1. NODE_LEVEL='三级节点'
                                THEN   1  ELSE    0 END))   AS "三级节点应完成"
                  ,SUM((CASE   WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
                              AND A1. NODE_LEVEL='三年级节点'
                                   THEN   1  ELSE    0 END))   AS "三级节点已完成"

                    ------------------
                   /*-里程碑亮灯情况*/
                   ------------------
                   ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  <= 0 AND    A1.NODE_LEVEL IN ('里程碑')
                        THEN 1

                       ELSE  0  END ) AS  "里程碑绿灯"

                   ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 1 AND 4 AND    A1.NODE_LEVEL IN ('里程碑')
                        THEN 1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 1 AND 4  AND    A1.NODE_LEVEL IN ('里程碑')
                        THEN 1


                       ELSE  0  END ) AS  "里程碑黄灯"


                  ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=5 AND    A1.NODE_LEVEL IN ('里程碑')
                        THEN 1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=5 AND    A1.NODE_LEVEL IN ('里程碑')
                        THEN 1


                       ELSE  0  END ) AS  "里程碑红灯"



                    ------------------
                   /*一级节点亮灯情况*/
                   ------------------
                   ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  <= 0  AND    A1.NODE_LEVEL IN ('一级节点')
                        THEN 1

                       ELSE  0  END ) AS  "一级节点绿灯"

                   ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 1 AND 4 AND    A1.NODE_LEVEL IN ('一级节点')
                        THEN 1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 1 AND 4  AND    A1.NODE_LEVEL IN ('一级节点')
                        THEN 1


                       ELSE  0  END ) AS  "一级节点黄灯"


                  ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=5 AND    A1.NODE_LEVEL IN ('一级节点')
                        THEN 1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=5 AND    A1.NODE_LEVEL IN ('一级节点')
                        THEN 1


                       ELSE  0  END ) AS  "一级节点红灯"




                    ------------------
                   /*二级节点亮灯情况*/
                   ------------------
                   ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  <= 2 AND     A1.NODE_LEVEL IN ('二级节点')
                        THEN 1

                       ELSE  0  END ) AS  "二级节点绿灯"

                   ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 3 AND 7 AND    A1.NODE_LEVEL IN ('二级节点')
                        THEN 1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 3 AND 7  AND    A1.NODE_LEVEL IN  ('二级节点')
                        THEN 1


                       ELSE  0  END ) AS  "二级节点黄灯"


                  ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=8 AND    A1.NODE_LEVEL IN  ('二级节点')
                        THEN 1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=8 AND    A1.NODE_LEVEL IN  ('二级节点')
                        THEN 1


                    ELSE  0  END ) AS  "二级节点红灯"

                    ------------------
                   /*三级节点亮灯情况*/
                   ------------------
                   ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  <= 2 AND     A1.NODE_LEVEL IN ('三级节点')
                        THEN 1

                       ELSE  0  END ) AS  "三级节点绿灯"

                   ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 3 AND 7 AND    A1.NODE_LEVEL IN ('三级节点')
                        THEN 1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 3 AND 7  AND    A1.NODE_LEVEL IN  ('三级节点')
                        THEN 1


                       ELSE  0  END ) AS  "三级节点黄灯"


                  ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=8 AND    A1.NODE_LEVEL IN  ('三级节点')
                        THEN 1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=8 AND    A1.NODE_LEVEL IN  ('三级节点')
                        THEN 1


                    ELSE  0  END ) AS  "三级节点红灯"

                  FROM
                  POM_PROJ_PLAN A
                  INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
                  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
                  INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
                  LEFT JOIN POM_NODE_FEEDBACK D ON D.FEEDBACK_NODE_ID=A1.ID AND  FEEDBACK_TYPE='1' AND  D.APPROVAL_STATUS='已审核'
                  WHERE  A.PLAN_TYPE='项目主项计划' AND  A.APPROVAL_STATUS='已审核'
                  GROUP BY B1.UNIT_ID  , TO_CHAR(A1.PLAN_END_DATE,'YYYY')
                  , CASE WHEN CASE   WHEN TO_CHAR( PLAN_END_DATE, 'DD' ) > 25 THEN  TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) )
                        END > 12 THEN  1 ELSE  CASE    WHEN TO_CHAR( PLAN_END_DATE, 'DD' ) > 25 THEN    TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) )
                  END   END
                  , CASE WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '12-26'  AND '03-25'  THEN 1    WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '03-26'  AND '06-25'  THEN 2
                   WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '06-26'  AND '09-25'  THEN 3      WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '09-26'  AND '12-25'  THEN 4  END

                    )  B ON  A.ID=B.UNIT_ID
                    WHERE NVL(B.NODESUM,0)>0
										start with  a.id='45e9c408-dd59-4a41-8c50-7b4eaf6c1e46'
                  CONNECT  by PRIOR   A.ID= A.PARENT_ID

) AB
GROUP BY AB.ID,AB.PARENT_ID  ,AB.PLANYEAR  ,AB.PLANQUATOR,AB.PLANMOTH
)B  ON  A.ID=B.ID
WHERE  A.ORG_TYPE=0  ;--  AND  A.COMPANY_TYPE='5' AND  A.PARENT_ID='003200000000000000000000000000'
--



END p_pom_rank_proj_exam_dtltest;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_RANK_PROJ_EXAMINATION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_RANK_PROJ_EXAMINATION" (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    rangetype        IN             INT,--时间范围类型（10:月度，20季度）
     plantype       IN             INT,--计划类型（30：关键节点计划，40：项目主项计划）
    rangeval    IN          VARCHAR2,--范围值，月度：2019|09。季度：2019|04
    orgid       IN          VARCHAR2,--组织id(关键节点计划传空,项目主项计划传）
    title          OUT            VARCHAR2,--标题
    bartype        OUT            VARCHAR2,--图类型
    unit           OUT            VARCHAR2,--单位
    info      OUT            SYS_REFCURSOR--图数据
) AS
--项目考核排行
--作者：陈丽
--日期：2019/11/13
  org_lenth NUMBER(10):=60;
  lpad_str  VARCHAR2(10):=' ';
BEGIN

IF rangetype=10  AND plantype=30
THEN
OPEN info FOR
SELECT  lpad(A.ORG_NAME,org_lenth-length(A.ORG_NAME),lpad_str) AS "name",
			 TO_CHAR(CASE
									 WHEN SUM(CASE
																WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND
																		 LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 2 )),2,'0') = A.PLANMOTH THEN
																 SUMNODESCORE
																ELSE
																 0
														END) > 0 THEN
										ROUND(SUM(CASE

																	WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND
																			LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 2 )),2,'0') = A.PLANMOTH THEN
																	  "动态得分"
																	ELSE
																	 0
															END) / SUM(CASE

																						 WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND
																									LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 2 )),2,'0') = A.PLANMOTH THEN
																							SUMNODESCORE
																						 ELSE
																							0
																				 END) * 100, 2)
									 ELSE
										0
							 END) AS "total"
			  ,  
   CASE
									 WHEN SUM(CASE
																WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND
																		 LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 2 )),2,'0') = A.PLANMOTH THEN
																 SUMNODESCORE
																ELSE
																 0
														END) > 0 THEN
										ROUND(SUM(CASE

																	WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND
																			 LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 2 )),2,'0') = A.PLANMOTH THEN
																	  "动态得分"
																	ELSE
																	 0
															END) / SUM(CASE

																						 WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND
																									LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 2 )),2,'0') = A.PLANMOTH THEN
																							SUMNODESCORE
																						 ELSE
																							0
																				 END) * 100, 2)
									 ELSE
										0
							 END

           AS   totalRank
				--,'90 'AS "total"
			 , '#37cd69' AS "color"
FROM   POM_PJPLAN_EXM_SOCRE_TABLE A

WHERE  1=1

		AND 	 A.PLAN_TYPE = '关键节点计划'
		AND 	 A.CTYPE = 'TYPE_PROJTOP'  
		AND 	 SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR  
		AND 	 LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 2 )),2,'0') = A.PLANMOTH  
		 AND( A.PARENT_ID  IN (  SELECT a.ID
 	from   SYS_BUSINESS_UNIT A
 	where  1=1 and    IS_COMPANY=1
 	START WITH a.id=''||orgid||''
 	CONNECT  by PRIOR   A.ID= A.PARENT_ID	)
 	OR A.ID=''||orgid||'')
--      AND   B.COMPANY_TYPE='5'
GROUP  BY A.ORG_NAME
HAVING SUM(SUMNODESCORE)>0
ORDER  BY 3 asc;







ELSIF RANGETYPE = 10 AND PLANTYPE = 40 THEN OPEN INFO FOR

SELECT  lpad(A.ORG_NAME,org_lenth-length(A.ORG_NAME),lpad_str) AS "name"
, TO_CHAR(CASE WHEN SUM(CASE WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 2 )),2,'0') = A.PLANMOTH THEN SUMNODESCORE ELSE 0 END) > 0 THEN ROUND(SUM(CASE
WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 2 )),2,'0') = A.PLANMOTH THEN  "动态得分" ELSE 0 END)
/ SUM(CASE
WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 2 )),2,'0') = A.PLANMOTH THEN SUMNODESCORE ELSE 0 END) * 100, 2) ELSE 0 END) AS "total" --,'90 'AS "total"
  ,  
  CASE WHEN SUM(CASE WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 2 )),2,'0') = A.PLANMOTH THEN SUMNODESCORE ELSE 0 END) > 0 THEN ROUND(SUM(CASE
WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 2 )),2,'0') = A.PLANMOTH THEN  "动态得分" ELSE 0 END)
/ SUM(CASE
WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 2 )),2,'0') = A.PLANMOTH THEN SUMNODESCORE ELSE 0 END) * 100, 2) ELSE 0 END

           AS   totalRank

, '#37cd69' AS "color"
FROM POM_PJPLAN_EXM_SOCRE_TABLE A 
-- INNER JOIN SYS_BUSINESS_UNIT B ON A.ID = B.ID
WHERE 1=1
AND SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR 
AND LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 2 )),2,'0') = A.PLANMOTH 
AND A.CTYPE = 'TYPE_PROJTOP' AND A.PLAN_TYPE = '项目主项计划'
AND( A.PARENT_ID  IN (  SELECT a.ID
 	from   SYS_BUSINESS_UNIT A
 	where  1=1 and    IS_COMPANY=1
 	START WITH a.id=''||orgid||''
 	CONNECT  by PRIOR   A.ID= A.PARENT_ID	)
 	OR A.ID=''||orgid||'')
GROUP BY A.ORG_NAME ORDER BY 3 asc ;




ELSIF RANGETYPE = 20 AND PLANTYPE = 30 THEN 

OPEN INFO FOR 

SELECT  lpad(A.ORG_NAME,org_lenth-length(A.ORG_NAME),lpad_str) AS "name"
, TO_CHAR(CASE WHEN SUM(CASE WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN SUMNODESCORE ELSE 0 END) > 0 THEN ROUND(SUM(CASE
WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN  "动态得分" ELSE 0 END)
/ SUM(CASE
WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN SUMNODESCORE ELSE 0 END) * 100, 2) ELSE 0 END) AS "total" --,'90 'AS "total"
  ,  
   CASE WHEN SUM(CASE WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN SUMNODESCORE ELSE 0 END) > 0 THEN ROUND(SUM(CASE
WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN  "动态得分" ELSE 0 END)
/ SUM(CASE
WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN SUMNODESCORE ELSE 0 END) * 100, 2) ELSE 0 END

           AS   totalRank
, '#37cd69' AS "color" 
FROM POM_PJPLAN_EXM_SOCRE_TABLE A 
-- INNER JOIN SYS_BUSINESS_UNIT B ON A.ID = B.ID 
WHERE 1=1
AND A.CTYPE = 'TYPE_PROJTOP' 
AND A.PLAN_TYPE = '关键节点计划' 
AND SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR
AND( A.PARENT_ID  IN (  SELECT a.ID
 	from   SYS_BUSINESS_UNIT A
 	where  1=1 and    IS_COMPANY=1
 	START WITH a.id=''||orgid||''
 	CONNECT  by PRIOR   A.ID= A.PARENT_ID	)
 	OR A.ID=''||orgid||'')
--      AND   B.COMPANY_TYPE='5'
GROUP BY A.ORG_NAME ORDER BY 3 asc;


ELSIF RANGETYPE = 20 AND PLANTYPE = 40 THEN 
OPEN INFO FOR 
SELECT  lpad(A.ORG_NAME,org_lenth-length(A.ORG_NAME),lpad_str) AS "name"
, TO_CHAR(CASE WHEN SUM(CASE WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN SUMNODESCORE ELSE 0 END) > 0 THEN ROUND(SUM(CASE
WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN  "动态得分" ELSE 0 END)
/ SUM(CASE
WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN SUMNODESCORE ELSE 0 END) * 100, 2) ELSE 0 END) AS "total" --,'90 'AS "total"
  ,  
 CASE WHEN SUM(CASE WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN SUMNODESCORE ELSE 0 END) > 0 THEN ROUND(SUM(CASE
WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN  "动态得分" ELSE 0 END)
/ SUM(CASE
WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN SUMNODESCORE ELSE 0 END) * 100, 2) ELSE 0 END

           AS   totalRank

, '#37cd69' AS "color" 
FROM POM_PJPLAN_EXM_SOCRE_TABLE A 
-- INNER JOIN SYS_BUSINESS_UNIT B ON A.ID = B.ID 
WHERE 1=1
AND SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR 
AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR 
AND A.CTYPE = 'TYPE_PROJTOP' 
AND A.PLAN_TYPE = '项目主项计划'
AND( A.PARENT_ID  IN (  SELECT a.ID
 	from   SYS_BUSINESS_UNIT A
 	where  1=1 and    IS_COMPANY=1
 	START WITH a.id=''||orgid||''
 	CONNECT  by PRIOR   A.ID= A.PARENT_ID	)
 	OR A.ID=''||orgid||'')
GROUP BY A.ORG_NAME ORDER BY 3 asc; END IF; TITLE := CASE WHEN PLANTYPE = 40 THEN '项目主项计划' ELSE '关键节点计划' END || '考核_项目排行榜：'; UNIT := '%'; BARTYPE := 'column';

END P_POM_RANK_PROJ_EXAMINATION;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_REPAIR_GET_BUILDING
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_REPAIR_GET_BUILDING" (
    info out sys_refcursor,
    projectStageId in varchar2
) AS
begin
    open info for with t1 as (
        select ID, ORDER_HIERARCHY_CODE, BUILD_NAME, PERIOD_ID, PROJ_ID
        from MDM_BUILD mb1
        where IS_GET_COMPLETED_PERMIT = 1
          and (projectStageId is null or mb1.PERIOD_ID = projectStageId)
    ), t2 as (
        select
            mbp.BUILD_ID,
            WM_CONCAT(moppi.PRODUCT_TYPE_ID) productTypeIds,
            WM_CONCAT(moppi.PRODUCT_TYPE_NAME) productTypeNames
        from t1 inner join MDM_BUILD_PHASE mbp on t1.ID = mbp.BUILD_ID
             inner join MDM_OBJ_PHASE_PT_INDEX moppi on moppi.OBJ_PHASE_ID = mbp.ID
        group by mbp.BUILD_ID
    )
                  select
                      mb1.ID "id",
                      mb1.ORDER_HIERARCHY_CODE "buildingCode",
                      mb1.BUILD_NAME "buildingName",
                          mp2.PROJECT_NAME || '_' || mp1.PERIOD_NAME || '_' || mb1.BUILD_NAME "buildingFullName",
                      mp1.ID "projectStageId",
                      mp1.PERIOD_NAME "projectStageName",
                      '' "buildingDeliveryDate",
                      mp2.ID "projectId",
                      mp2.PROJECT_NAME "projectName",
                      productTypeIds "productTypeIds",
                      productTypeNames "productTypeNames"
                  from t1 mb1
                       inner join MDM_PERIOD mp1 on mb1.PERIOD_ID = mp1.ID
                       inner join MDM_PROJECT mp2 on mp2.ID = mb1.PROJ_ID
                       inner join t2 on t2.BUILD_ID = mb1.ID;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_REPAIR_PRODUCT_TYPE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_REPAIR_PRODUCT_TYPE" (
    info out sys_refcursor
) as
begin
    open info for
        select t.*, ROWNUM "sn"
        from (
                 select
                     mbpt.ID "id",
                     mbpt.PRODUCT_TYPE_SHORT_CODE "productTypeShortCode",
                     mbpt.PRODUCT_TYPE_SHORT_NAME "productTypeShortName",
                     mbpt.PRODUCT_TYPE_CODE "productTypeCode",
                     mbpt.PRODUCT_TYPE_NAME "productTypeName",
                     mbpt.PARENT_CODE "parentCode",
                     mbpt.PRODUCT_TYPE_LEVEL "productLevel",
                     mbpt.IS_END "isEnd"
                 from MDM_BUILD_PRODUCT_TYPE mbpt
                 order by mbpt.PRODUCT_TYPE_CODE
             ) t;
end;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_RULE_MSG_PRE_GENERATED
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_RULE_MSG_PRE_GENERATED" 
(
    RULEID        IN VARCHAR --规则ID
   ,MSGGROUPID    OUT VARCHAR --本次插入至POM_PRE_GENERATED_MESSAGE表中，唯一标识
   ,TOTAL         OUT NUMBER --本次更新的数据总数
   ,EXECUTIONTIME OUT VARCHAR --存储过程执行的时间
) AS
    --预警与提醒，消息预生成。
    --作者：陈丽
    --日期：2019/11/15

    VS_WHERE     CLOB; --SQL后面where过滤条件动态SQL
    VS_KEY_PLAN  CLOB; --关键节点计划动态SQL
    VS_PROJ_PLAN CLOB; --项目主项计划动态SQL
    VS_DEPT_PLAN CLOB; --部门月度计划动态SQL
    VS_SPEC_PLAN CLOB; --专项计划动态SQL
    VS_QUERY     CLOB; --拼接所有SQL

    V_FLAG            NUMBER(2, 0); --判断当前规则是否可执行，若判断规则设置有问题，直接RETURN
    V_RULE_TYPE       VARCHAR2(100); --记录当前规则类型
    V_PLAN_TYPE       VARCHAR(200); --存储规则类型
    V_SYSTEM_ID       VARCHAR(100); --系统ID，固定值，插入POM_PRE_GENERATED_MESSAGE表中时使用，勿改
    V_RULE_NODE_LEVEL VARCHAR(100); --存储规则的任务级别，用于拼接VS_WHERE字符串
    V_RULE_MSG        VARCHAR(200); --存储规则中定义的消息格式
    V_RULE_FERQ_TYPE  VARCHAR(200); --执行频率类别
    V_RULE_FERQ_DATE  VARCHAR(200); --哪一天执行，需根据执行类别进行判断

    V_MONTH_DAY VARCHAR(20); -- 取日期中的号
    V_WEEK_DAY  VARCHAR(20); -- 取星期几
    --定义RC_NODE_INFO类型，存储节点信息
    TYPE RC_NODE_INFO IS RECORD(
         PLAN_NAME        POM_PROJ_PLAN.PLAN_NAME%TYPE
        ,COMPANY_NAME     POM_PROJ_PLAN.COMPANY_NAME%TYPE
        ,DEPT_ID          POM_NODE_CHARGE_PERSON.CHARGE_PERSON_DEPT_ID%TYPE
        ,COMPANY_ID       POM_NODE_CHARGE_PERSON.CHARGE_PERSON_COMPANY_ID%TYPE
        ,NODE_NAME        POM_PROJ_PLAN_NODE.NODE_NAME%TYPE
        ,NODE_LEVEL       POM_PROJ_PLAN_NODE.NODE_LEVEL%TYPE
        ,PLAN_ID          POM_PROJ_PLAN_NODE.PROJ_PLAN_ID%TYPE
        ,NODE_ID          POM_PROJ_PLAN_NODE.ID%TYPE
        ,PLAN_START_DATE  VARCHAR(50)
        ,PLAN_END_DATE    VARCHAR(50)
        ,CHARGE_PERSON_ID POM_NODE_CHARGE_PERSON.ID%TYPE
        ,CHARGE_PERSON    POM_NODE_CHARGE_PERSON.CHARGE_PERSON%TYPE
        ,CURRENT_DATE     VARCHAR(50)
        ,NODE_MSG         VARCHAR(100)
        ,PROJ_ID          VARCHAR(100));
    --声明V_NODE_INFO变量

    V_NODE_INFO RC_NODE_INFO;
    --定义ref_type类型
    TYPE REF_TYPE IS REF CURSOR;
    VC_REF REF_TYPE;

    V_BUFFER VARCHAR(200); --用来存储过程中临时使用的值

BEGIN
    EXECUTIONTIME := TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MM:SS');
    MSGGROUPID    := GET_UUID();
    V_SYSTEM_ID   := '71313f018a35f3a558166cba7599b5d6';

    V_MONTH_DAY := TO_CHAR(SYSDATE, 'dd');
    V_WEEK_DAY := CASE
                      WHEN TO_CHAR(SYSDATE, 'day') = '星期一' THEN
                       1
                      WHEN TO_CHAR(SYSDATE, 'day') = '星期二' THEN
                       2
                      WHEN TO_CHAR(SYSDATE, 'day') = '星期三' THEN
                       3
                      WHEN TO_CHAR(SYSDATE, 'day') = '星期四' THEN
                       4
                      WHEN TO_CHAR(SYSDATE, 'day') = '星期五' THEN
                       5
                      WHEN TO_CHAR(SYSDATE, 'day') = '星期六' THEN
                       6
                      WHEN TO_CHAR(SYSDATE, 'day') = '星期日' THEN
                       7
                  END;

    DBMS_OUTPUT.PUT_LINE(V_WEEK_DAY || ' ,' || V_MONTH_DAY);

    BEGIN
        SELECT NVL(A.IS_DISABLE, 0)
        INTO   V_FLAG
        FROM   POM_RULE_SET A
        WHERE  A.ID = RULEID;

        SELECT COUNT(1)
        INTO   V_FLAG
        FROM   POM_RULE_SET_PLAN_TYPE A
        WHERE  A.RULE_ID = RULEID;

        IF V_FLAG = 0 THEN
            DBMS_OUTPUT.PUT_LINE('检测到【POM_RULE_SET_PLAN_TYPE】表中无数据，请检查配置信息');
            RETURN;
        END IF;

    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            V_FLAG := 0;
            DBMS_OUTPUT.PUT_LINE('该规则初始化信息有误，请检查规则配置');
    END;

    SELECT A.EXPRESSION, A.RULE_TYPE, A.NODE_LEVEL, A.MESSAGE_TEMPLATE,
           A.TIME_FREQUENCY, A.MSG_FREQUENCY_TYPE, A.DATE_FREQUENCY
    INTO   VS_WHERE, V_RULE_TYPE, V_RULE_NODE_LEVEL, V_RULE_MSG,
           EXECUTIONTIME, V_RULE_FERQ_TYPE, V_RULE_FERQ_DATE
    FROM   POM_RULE_SET A
    WHERE  A.ID = RULEID AND
           IS_DISABLE <> 1;
    /*
    WHERE条件拼接
    */
    V_RULE_NODE_LEVEL := ' AND NODE_LEVEL = ''' || V_RULE_NODE_LEVEL || '''';
    VS_WHERE          := 'WHERE 1=1 ' || ' AND ' || VS_WHERE; --1=1勿删，确保无论where后是否有条件，SQL都能执行
    VS_WHERE          := VS_WHERE || V_RULE_NODE_LEVEL;

    SELECT TO_CHAR(WM_CONCAT(A.PLAN_TYPE))
    INTO   V_PLAN_TYPE
    FROM   POM_RULE_SET_PLAN_TYPE A
    WHERE  A.RULE_ID = RULEID;

    --执行频率判断
    IF V_RULE_FERQ_TYPE = '每周' THEN
        IF V_WEEK_DAY <> V_RULE_FERQ_DATE THEN
            TOTAL := 0;
            RETURN;
        END IF;
    ELSIF V_RULE_FERQ_TYPE = '每月' THEN
        IF V_MONTH_DAY <> V_RULE_FERQ_DATE THEN
            TOTAL := 0;
            RETURN;
        END IF;
    ELSIF V_RULE_FERQ_TYPE = '提醒一次' THEN
        VS_WHERE := VS_WHERE ||
                    ' AND NOT EXISTS (SELECT 1 FROM POM_PRE_GENERATED_MESSAGE WHERE POM_PRE_GENERATED_MESSAGE.BIZ_KEY = NODE_ID) ';
    END IF;

    IF INSTR(V_PLAN_TYPE, '项目主项计划', 1, 1) <> 0 THEN
        /*
            SQL拼接，where条件中的1=1勿删，防止RTRIM时，将NULL字符删除
        */
        VS_PROJ_PLAN := ' SELECT A.PLAN_NAME, A.COMPANY_NAME,C.CHARGE_PERSON_DEPT_ID AS DEPT_ID,C.CHARGE_PERSON_COMPANY_ID AS COMPANY_ID, B.NODE_NAME,B.NODE_LEVEL AS NODE_LEVEL, A.ID AS PLAN_ID, B.ID AS NODE_ID,TO_CHAR(B.PLAN_START_DATE, ''YYYY-MM-DD'') AS PLAN_START_DATE,TO_CHAR(B.PLAN_END_DATE, ''YYYY-MM-DD'') AS PLAN_END_DATE,C.CHARGE_PERSON_ID, C.CHARGE_PERSON,TO_CHAR(SYSDATE, ''YYYY-MM-DD'') AS CURRENT_DATE,a.PROJ_ID FROM   POM_PROJ_PLAN A INNER  JOIN POM_PROJ_PLAN_NODE B ON     A.ID = B.PROJ_PLAN_ID INNER  JOIN POM_NODE_CHARGE_PERSON C ON     B.ID = C.NODE_ID WHERE  A.PLAN_TYPE = ''项目主项计划'' AND B.ACTUAL_END_DATE IS NULL AND 1=1   UNION ALL';
    ELSE
        VS_PROJ_PLAN := '';
    END IF;

    IF INSTR(V_PLAN_TYPE, '关键节点计划', 1, 1) <> 0 THEN
        VS_KEY_PLAN := ' SELECT A.PLAN_NAME, A.COMPANY_NAME, C.CHARGE_PERSON_DEPT_ID AS DEPT_ID,C.CHARGE_PERSON_COMPANY_ID AS COMPANY_ID, B.NODE_NAME,B.NODE_LEVEL AS NODE_LEVEL, A.ID AS PLAN_ID, B.ID AS NODE_ID,TO_CHAR(B.PLAN_START_DATE, ''YYYY-MM-DD'') AS PLAN_START_DATE,TO_CHAR(B.PLAN_END_DATE, ''YYYY-MM-DD'') AS PLAN_END_DATE,C.CHARGE_PERSON_ID, C.CHARGE_PERSON,TO_CHAR(SYSDATE, ''YYYY-MM-DD'') AS CURRENT_DATE,a.PROJ_ID  FROM   POM_PROJ_PLAN A INNER  JOIN POM_PROJ_PLAN_NODE B ON     A.ID = B.PROJ_PLAN_ID INNER  JOIN POM_NODE_CHARGE_PERSON C ON     B.ID = C.NODE_ID WHERE  A.PLAN_TYPE = ''关键节点计划'' AND B.ACTUAL_END_DATE IS NULL AND 1=1 UNION ALL';
    ELSE
        VS_KEY_PLAN := '';
    END IF;

    IF INSTR(V_PLAN_TYPE, '专项计划', 1, 1) <> 0 THEN
        VS_SPEC_PLAN := ' SELECT A.PLAN_NAME, A.COMPANY_NAME, C.CHARGE_PERSON_DEPT_ID AS DEPT_ID,C.CHARGE_PERSON_COMPANY_ID AS COMPANY_ID, B.NODE_NAME,NULL AS NODE_LEVEL, A.ID AS PLAN_ID, B.ID AS NODE_ID,TO_CHAR(B.PLAN_START_DATE, ''YYYY-MM-DD'') AS PLAN_START_DATE,TO_CHAR(B.PLAN_END_DATE, ''YYYY-MM-DD'') AS PLAN_END_DATE,C.CHARGE_PERSON_ID, C.CHARGE_PERSON,TO_CHAR(SYSDATE, ''YYYY-MM-DD'') AS CURRENT_DATE,null FROM   POM_SPECIAL_PLAN A INNER  JOIN POM_SPECIAL_PLAN_NODE B ON     A.ID = B.PLAN_ID INNER  JOIN POM_NODE_CHARGE_PERSON C ON     B.ID = C.NODE_ID WHERE  B.ACTUAL_END_DATE IS NULL AND 1=1 UNION ALL';
    ELSE
        VS_SPEC_PLAN := '';
    END IF;

    IF INSTR(V_PLAN_TYPE, '部门月度计划', 1, 1) <> 0 THEN
        VS_DEPT_PLAN := ' SELECT A.PLAN_NAME, A.COMPANY_NAME, C.CHARGE_PERSON_DEPT_ID AS DEPT_ID,C.CHARGE_PERSON_COMPANY_ID AS COMPANY_ID, B.NODE_NAME,B.NODE_TYPE AS NODE_LEVEL, A.ID AS PLAN_ID, B.ID AS NODE_ID,TO_CHAR(B.PLAN_START_DATE, ''YYYY-MM-DD'') AS PLAN_START_DATE,TO_CHAR(B.PLAN_END_DATE, ''YYYY-MM-DD'') AS PLAN_END_DATE,C.CHARGE_PERSON_ID, C.CHARGE_PERSON,TO_CHAR(SYSDATE, ''YYYY-MM-DD'') AS CURRENT_DATE FROM   POM_DEPT_MONTHLY_PLAN A INNER  JOIN POM_DEPT_MONTHLY_PLAN_NODE B ON     A.ID = B.DEPT_MONTHLY_PLAN_ID INNER  JOIN POM_NODE_CHARGE_PERSON C ON     B.ID = C.NODE_ID WHERE  B.ACTUAL_END_DATE IS NULL AND 1=1 UNION ALL';
    ELSE
        VS_DEPT_PLAN := '';
    END IF;

    /*    IF V_RULE_TYPE = '提醒规则' THEN
        --下方需补充提醒规则的条件

        VS_WHERE = VS_WHERE || '';

    ELSIF V_RULE_TYPE = '预警规则' THEN
        --下方补充预警规则的条件
        VS_WHERE = VS_WHERE || '';

    END IF;*/

    VS_QUERY := 'SELECT PLAN_NAME,COMPANY_NAME,DEPT_ID,COMPANY_ID,NODE_NAME,NODE_LEVEL,PLAN_ID,NODE_ID,PLAN_START_DATE,PLAN_END_DATE,CHARGE_PERSON_ID,CHARGE_PERSON, CURRENT_DATE, ' ||
                V_RULE_MSG || ' AS NODE_MSG FROM (' ||
                RTRIM(VS_PROJ_PLAN || ' ' || VS_KEY_PLAN || ' ' ||
                      VS_SPEC_PLAN || ' ' || VS_DEPT_PLAN, 'UNION ALL') || ')' || ' ' ||
                VS_WHERE;

    DBMS_OUTPUT.PUT_LINE(VS_QUERY);
    /*
        更新值至POM_PRE_GENERATED_MESSAGE表中
    */

    OPEN VC_REF FOR VS_QUERY;
    LOOP
        FETCH VC_REF
            INTO V_NODE_INFO;
        EXIT WHEN VC_REF%NOTFOUND;
        INSERT INTO POM_PRE_GENERATED_MESSAGE
        VALUES
            (GET_UUID(),MSGGROUPID, V_NODE_INFO.NODE_MSG, V_NODE_INFO.CHARGE_PERSON_ID,
             V_NODE_INFO.NODE_ID, 'wangck', '计划管理',
             CASE WHEN V_RULE_TYPE = '提醒规则' THEN '提醒消息' WHEN
              V_RULE_TYPE = '预警规则' THEN '预警消息' ELSE NULL END, V_SYSTEM_ID,
             'wechat_jumpLink_Url',V_NODE_INFO.COMPANY_ID,V_NODE_INFO.DEPT_ID,V_NODE_INFO.PROJ_ID);
    END LOOP;
    
    VS_QUERY:=' insert into POM_PRE_GENERATED_MESSAGE  '||VS_QUERY; 
    execute immediate VS_QUERY;
    TOTAL := VC_REF%ROWCOUNT;
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('更新成功，已更新数据' || TOTAL || '条');
    CLOSE VC_REF;

END P_POM_RULE_MSG_PRE_GENERATED;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_RULE_MSG_PUSH
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_RULE_MSG_PUSH" 
(
    RULEID     IN VARCHAR
   ,MSGGROUPID IN VARCHAR
   ,MESSAGE    OUT SYS_REFCURSOR
) AS
    --预警与提醒，消息推送。p_pom_rule_msg_pre_generated
    --作者：陈丽
    --日期：2019/11/15
    TYPE REF_CURSOR IS REF CURSOR;
    VC_REF_CURSOR REF_CURSOR;

    TYPE RC_PRE_MSG IS RECORD(
         ID                  POM_PRE_GENERATED_MESSAGE.ID%TYPE
        ,MSG_GROUP_ID        POM_PRE_GENERATED_MESSAGE.MSG_GROUP_ID%TYPE
        ,MSG_DESCRIPTION     POM_PRE_GENERATED_MESSAGE.MSG_DESCRIPTION%TYPE
        ,RECIPIENT_ID        POM_PRE_GENERATED_MESSAGE.RECIPIENT_ID%TYPE
        ,BIZ_KEY             POM_PRE_GENERATED_MESSAGE.BIZ_KEY%TYPE
        ,SENDER_ID           POM_PRE_GENERATED_MESSAGE.SENDER_ID%TYPE
        ,BIZ_SOURCE_CATEGORY POM_PRE_GENERATED_MESSAGE.BIZ_SOURCE_CATEGORY%TYPE
        ,BIZ_MSG_CATEGORY    POM_PRE_GENERATED_MESSAGE.BIZ_MSG_CATEGORY%TYPE
        ,SYSTEM_ID           POM_PRE_GENERATED_MESSAGE.SYSTEM_ID%TYPE
        ,WECHAT_JUMPLINK_URL POM_PRE_GENERATED_MESSAGE.WECHAT_JUMPLINK_URL%TYPE
        ,COMPANY_ID          POM_PRE_GENERATED_MESSAGE.COMPANY_ID%TYPE
        ,DEPT_ID             POM_PRE_GENERATED_MESSAGE.DEPT_ID%TYPE
        ,PROJ_ID             POM_PRE_GENERATED_MESSAGE.PROJ_ID%TYPE);
    V_RC_PRE_MSG RC_PRE_MSG;
BEGIN
    OPEN VC_REF_CURSOR FOR
        SELECT A.ID, A.MSG_GROUP_ID AS "msgGroupId",
               A.MSG_DESCRIPTION AS "msgDescription",
               A.RECIPIENT_ID AS "RecipientId", A.BIZ_KEY AS "bizKey",
               A.SENDER_ID AS "senderId",
               A.BIZ_SOURCE_CATEGORY AS "bizSourceCategory",
               A.BIZ_MSG_CATEGORY AS "bizMsgCategory",
               A.SYSTEM_ID AS "systemId",
               A.WECHAT_JUMPLINK_URL AS "wechatJumplinkUrl"
        FROM   POM_PRE_GENERATED_MESSAGE A
        INNER  JOIN POM_PROJ_PLAN_NODE B
        ON     A.BIZ_KEY = B.ID
        WHERE  MSG_GROUP_ID = MSGGROUPID AND
               B.ACTUAL_END_DATE IS NOT NULL
        UNION ALL
        SELECT A.ID, A.MSG_GROUP_ID AS "msgGroupId",
               A.MSG_DESCRIPTION AS "msgDescription",
               A.RECIPIENT_ID AS "RecipientId", A.BIZ_KEY AS "bizKey",
               A.SENDER_ID AS "senderId",
               A.BIZ_SOURCE_CATEGORY AS "bizSourceCategory",
               A.BIZ_MSG_CATEGORY AS "bizMsgCategory",
               A.SYSTEM_ID AS "systemId",
               A.WECHAT_JUMPLINK_URL AS "wechatJumplinkUrl"
        FROM   POM_PRE_GENERATED_MESSAGE A
        INNER  JOIN POM_SPECIAL_PLAN_NODE B
        ON     A.BIZ_KEY = B.ID
        WHERE  MSG_GROUP_ID = MSGGROUPID AND
               B.ACTUAL_END_DATE IS NOT NULL
        UNION ALL
        SELECT A.ID, A.MSG_GROUP_ID AS "msgGroupId",
               A.MSG_DESCRIPTION AS "msgDescription",
               A.RECIPIENT_ID AS "RecipientId", A.BIZ_KEY AS "bizKey",
               A.SENDER_ID AS "senderId",
               A.BIZ_SOURCE_CATEGORY AS "bizSourceCategory",
               A.BIZ_MSG_CATEGORY AS "bizMsgCategory",
               A.SYSTEM_ID AS "systemId",
               A.WECHAT_JUMPLINK_URL AS "wechatJumplinkUrl"
        FROM   POM_PRE_GENERATED_MESSAGE A
        INNER  JOIN POM_DEPT_MONTHLY_PLAN_NODE B
        ON     A.BIZ_KEY = B.ID
        WHERE  MSG_GROUP_ID = MSGGROUPID AND
               B.ACTUAL_END_DATE IS NOT NULL;
    LOOP
        FETCH VC_REF_CURSOR
            INTO V_RC_PRE_MSG;
        EXIT WHEN VC_REF_CURSOR%NOTFOUND;
        DELETE POM_PRE_GENERATED_MESSAGE WHERE ID = V_RC_PRE_MSG.ID;
    END LOOP;

    OPEN MESSAGE FOR
        SELECT A.ID AS "id", MSG_GROUP_ID AS "msgGroupId",
               A.MSG_DESCRIPTION AS "msgDescription",
               A.RECIPIENT_ID AS "RecipientId", A.BIZ_KEY AS "bizKey",
               A.SENDER_ID AS "senderId",
               A.BIZ_SOURCE_CATEGORY AS "bizSourceCategory",
               A.BIZ_MSG_CATEGORY AS "bizMsgCategory",
               A.SYSTEM_ID AS "systemId",
               A.WECHAT_JUMPLINK_URL AS "wechatJumplinkUrl",
               A.COMPANY_ID AS "companyId", A.DEPT_ID AS "deptId",
               A.PROJ_ID AS "projId"
        FROM   POM_PRE_GENERATED_MESSAGE A
        WHERE  MSG_GROUP_ID = MSGGROUPID;
END P_POM_RULE_MSG_PUSH;



/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_CURRENTCOMPANY_TBS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_SMART_CURRENTCOMPANY_TBS" (
        --orgtype IN VARCHAR2, --查询类型，用于判断过滤 0,公司|1,部门|2,项目|3,,本人
		condition IN VARCHAR2, --输入变量：公司id
        currentuserid        IN 			VARCHAR2,--用户id，用于过滤关注的任务
        currentcompanyid     IN            VARCHAR2,--当前用户公司
        currentdeptid        IN            VARCHAR2,--当前用户部门
        currentstationid     IN            VARCHAR2,---当前用户的岗位
        bizcode       IN            VARCHAR2,---权限code
        searchcondition IN          VARCHAR2,--模糊查询条件
        item OUT SYS_REFCURSOR ) IS --任务中心tabs任务条数统计数据源
--作者：yedr
--日期：2020/04/07

    v_spid              VARCHAR2(200);
	BEGIN
--调用数据权限验证存储过程
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => currentuserid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
		IF  condition <> '111' THEN
            OPEN item FOR SELECT
            SUM(ACOUNT) AS ACOUNT,
            SUM(BCOUNT) AS BCOUNT,
            SUM(CCOUNT) AS CCOUNT,
            SUM(DCOUNT) AS DCOUNT,
            SUM(ECOUNT) AS ECOUNT,
            SUM(FCOUNT) AS FCOUNT,
            SUM(GCOUNT) AS GCOUNT,
            SUM(HCOUNT) AS HCOUNT
            FROM(
                SELECT NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE <= last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT

                FROM
                POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    LEFT JOIN (SELECT node_id,LISTAGG( to_char(charge_person), ',') WITHIN GROUP(ORDER BY charge_person) AS charge_person
                    FROM POM_NODE_CHARGE_PERSON group by node_id) person on node.id=person.NODE_ID
                    LEFT JOIN SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                    ON (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.PROJ_NAME like '%'||searchcondition||'%' OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
					AND node.COMPANY_ID in (select sbu.id
                            from SYS_BUSINESS_UNIT sbu
                            start with sbu.id = '' || condition ||''
                            connect by prior sbu.id = sbu.PARENT_ID)
--                UNION ALL
--                SELECT
--                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
--                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
--                THEN  1 ELSE 0 END), 0)AS ACOUNT,
--                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
--                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
--                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
--                COUNT(*) AS ECOUNT,
--                NVL(SUM(CASE WHEN (
--						node.PLAN_END_DATE >= last_day( trunc( SYSDATE ) ) + 1
--						AND node.PLAN_END_DATE <= last_day( last_day( trunc( SYSDATE ) ) + 1 )
--					) THEN 1 ELSE 0 END),0) AS FCOUNT,
--                NVL(SUM(CASE WHEN  (
--						node.PLAN_END_DATE >= trunc( SYSDATE, 'Q' )
--						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
--					) THEN 1 ELSE 0 END),0) AS GCOUNT,
--                NVL(SUM(CASE WHEN (
--						node.PLAN_END_DATE >= trunc( SYSDATE, 'yyyy' )
--						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
--					) THEN 1 ELSE 0 END),0) AS HCOUNT
--                FROM
--                POM_SPECIAL_PLAN_NODE node
--					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
--                    LEFT JOIN (SELECT node_id,LISTAGG( to_char(charge_person), ',') WITHIN GROUP(ORDER BY charge_person) AS charge_person
--                    FROM POM_NODE_CHARGE_PERSON group by node_id) person on node.id=person.NODE_ID
--                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.COMPANY_ID
--                    WHERE tal.orgid is not null AND node.ACTUAL_END_DATE IS NULL
--					AND plan.APPROVAL_STATUS = '已审核'
--					AND	node.IS_DELETE=0
--                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
--                    OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
--					AND node.COMPANY_ID in (select sbu.id
--                            from SYS_BUSINESS_UNIT sbu
--                            start with sbu.id = '' || condition ||''
--                            connect by prior sbu.id = sbu.PARENT_ID)
--                UNION ALL
--                SELECT
--                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
--                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
--                THEN  1 ELSE 0 END), 0)AS ACOUNT,
--                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
--                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
--                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
--                COUNT(*) AS ECOUNT,
--                NVL(SUM(CASE WHEN (
--						node.PLAN_END_DATE >= last_day( trunc( SYSDATE ) ) + 1
--						AND node.PLAN_END_DATE <= last_day( last_day( trunc( SYSDATE ) ) + 1 )
--					) THEN 1 ELSE 0 END),0) AS FCOUNT,
--                NVL(SUM(CASE WHEN  (
--						node.PLAN_END_DATE >= trunc( SYSDATE, 'Q' )
--						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
--					) THEN 1 ELSE 0 END),0) AS GCOUNT,
--                NVL(SUM(CASE WHEN (
--						node.PLAN_END_DATE >= trunc( SYSDATE, 'yyyy' )
--						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
--					) THEN 1 ELSE 0 END),0) AS HCOUNT
--                FROM
--                pom_dept_monthly_plan_node node
--					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
--                    LEFT JOIN (SELECT node_id,LISTAGG( to_char(charge_person), ',') WITHIN GROUP(ORDER BY charge_person) AS charge_person
--                    FROM POM_NODE_CHARGE_PERSON group by node_id) person on node.id=person.NODE_ID
--                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
--                    WHERE tal.orgid is not null
--					AND APPROVE_STATUS = '已审核'
--					AND (node.IS_DEL=0 OR node.IS_DEL=null)
--                     AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
--                    OR plan.DEPT_NAME like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
--					AND plan.COMPANY_ID in (select sbu.id
--                            from SYS_BUSINESS_UNIT sbu
--                            start with sbu.id = '' || condition ||''
--                            connect by prior sbu.id = sbu.PARENT_ID)

            );
		ELSE
			OPEN item FOR SELECT
            SUM(ACOUNT) AS ACOUNT,
            SUM(BCOUNT) AS BCOUNT,
            SUM(CCOUNT) AS CCOUNT,
            SUM(DCOUNT) AS DCOUNT,
            SUM(ECOUNT) AS ECOUNT,
            SUM(FCOUNT) AS FCOUNT,
            SUM(GCOUNT) AS GCOUNT,
            SUM(HCOUNT) AS HCOUNT
            FROM(
                SELECT NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE <= last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT

                FROM
                POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    LEFT JOIN (SELECT node_id,LISTAGG( to_char(charge_person), ',') WITHIN GROUP(ORDER BY charge_person) AS charge_person
                    FROM POM_NODE_CHARGE_PERSON group by node_id) person on node.id=person.NODE_ID
                    LEFT JOIN SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                    ON (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.PROJ_NAME like '%'||searchcondition||'%' OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
--                UNION ALL
--                SELECT
--                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
--                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
--                THEN  1 ELSE 0 END), 0)AS ACOUNT,
--                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
--                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
--                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
--                COUNT(*) AS ECOUNT,
--                NVL(SUM(CASE WHEN (
--						node.PLAN_END_DATE >= last_day( trunc( SYSDATE ) ) + 1
--						AND node.PLAN_END_DATE <= last_day( last_day( trunc( SYSDATE ) ) + 1 )
--					) THEN 1 ELSE 0 END),0) AS FCOUNT,
--                NVL(SUM(CASE WHEN  (
--						node.PLAN_END_DATE >= trunc( SYSDATE, 'Q' )
--						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
--					) THEN 1 ELSE 0 END),0) AS GCOUNT,
--                NVL(SUM(CASE WHEN (
--						node.PLAN_END_DATE >= trunc( SYSDATE, 'yyyy' )
--						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
--					) THEN 1 ELSE 0 END),0) AS HCOUNT
--                FROM
--                POM_SPECIAL_PLAN_NODE node
--					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
--                    LEFT JOIN (SELECT node_id,LISTAGG( to_char(charge_person), ',') WITHIN GROUP(ORDER BY charge_person) AS charge_person
--                    FROM POM_NODE_CHARGE_PERSON group by node_id) person on node.id=person.NODE_ID
--                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.COMPANY_ID
--                    WHERE tal.orgid is not null AND node.ACTUAL_END_DATE IS NULL
--					AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
--					AND plan.APPROVAL_STATUS = '已审核'
--					AND	node.IS_DELETE=0
--                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
--                    OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
--                UNION ALL
--                SELECT
--                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
--                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
--                THEN  1 ELSE 0 END), 0)AS ACOUNT,
--                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
--                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
--                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
--                COUNT(*) AS ECOUNT,
--                NVL(SUM(CASE WHEN (
--						node.PLAN_END_DATE >= last_day( trunc( SYSDATE ) ) + 1
--						AND node.PLAN_END_DATE <= last_day( last_day( trunc( SYSDATE ) ) + 1 )
--					) THEN 1 ELSE 0 END),0) AS FCOUNT,
--                NVL(SUM(CASE WHEN  (
--						node.PLAN_END_DATE >= trunc( SYSDATE, 'Q' )
--						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
--					) THEN 1 ELSE 0 END),0) AS GCOUNT,
--                NVL(SUM(CASE WHEN (
--						node.PLAN_END_DATE >= trunc( SYSDATE, 'yyyy' )
--						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
--					) THEN 1 ELSE 0 END),0) AS HCOUNT
--                FROM
--                pom_dept_monthly_plan_node node
--					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
--                    LEFT JOIN (SELECT node_id,LISTAGG( to_char(charge_person), ',') WITHIN GROUP(ORDER BY charge_person) AS charge_person
--                    FROM POM_NODE_CHARGE_PERSON group by node_id) person on node.id=person.NODE_ID
--                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
--                    WHERE tal.orgid is not null
--					AND APPROVE_STATUS = '已审核'
--					AND (node.IS_DEL=0 OR node.IS_DEL=null)
--                     AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
--                    OR plan.DEPT_NAME like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')

            );
		END IF;

END P_POM_SMART_CURRENTCOMPANY_TBS;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_CURRENTDEPT_TBS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_SMART_CURRENTDEPT_TBS" (
    condition IN VARCHAR2, --输入变量：部门id
    currentuserid IN VARCHAR2,--用户id，用于过滤关注的任务
    currentcompanyid IN VARCHAR2,--当前用户公司
    currentdeptid IN VARCHAR2,--当前用户部门
    currentstationid IN VARCHAR2,---当前用户的岗位
    bizcode IN VARCHAR2,---权限code
    searchcondition IN VARCHAR2,--模糊查询条件
    item OUT SYS_REFCURSOR) IS --任务中心tabs任务条数统计数据源
--作者：yedr
--日期：2020/04/07

    v_spid VARCHAR2(200);
BEGIN
    P_SYS_AUTH_DATA_RULE_SPID(
            USERID => currentuserid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
    OPEN item for
        SELECT SUM(nvl(ACOUNT, 0)) AS ACOUNT,
               SUM(nvl(BCOUNT, 0)) AS BCOUNT,
               SUM(nvl(CCOUNT, 0)) AS CCOUNT,
               SUM(nvl(DCOUNT, 0)) AS DCOUNT,
               SUM(nvl(ECOUNT, 0)) AS ECOUNT,
               SUM(nvl(FCOUNT, 0)) AS FCOUNT,
               SUM(nvl(GCOUNT, 0)) AS GCOUNT,
               SUM(nvl(HCOUNT, 0)) AS HCOUNT
        FROM (
                 SELECT
                     sum(CASE WHEN trunc(node.PLAN_END_DATE, 'month') = trunc(SYSDATE, 'month')
                         and node.ACTUAL_END_DATE is null THEN 1 ELSE 0 END)                                                                              AS                           ACOUNT,
                     SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END) BCOUNT,
                     SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END)     AS                           CCOUNT,
                     SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END) AS                           DCOUNT,
                     COUNT(*)                                                          AS                           ECOUNT,
                     SUM(CASE WHEN (node.PLAN_END_DATE >= last_day(trunc(SYSDATE)) + 1
                         AND node.PLAN_END_DATE <= last_day(last_day(trunc(SYSDATE)) + 1)
                         ) THEN 1 ELSE 0 END)                                      AS                           FCOUNT,
                     SUM(CASE WHEN( node.PLAN_END_DATE >= trunc(SYSDATE, 'Q')
                         AND node.PLAN_END_DATE <= add_months(trunc(SYSDATE, 'Q'), 3) - 1
                         ) THEN 1 ELSE 0 END)                                      AS                           GCOUNT,
                     SUM(CASE WHEN (node.PLAN_END_DATE >= trunc(SYSDATE, 'yyyy')
                         AND node.PLAN_END_DATE <= add_months(trunc(SYSDATE, 'yyyy'), 12) - 1
                         ) THEN 1 ELSE 0 END) AS HCOUNT
                 FROM V_POM_PROJ_PLAN_NODE node
                          LEFT JOIN V_POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                          LEFT JOIN (
                     SELECT listagg(CHARGE_PERSON, ',') within GROUP (order by CHARGE_PERSON ) CHARGE_PERSON, NODE_ID
                     FROM POM_NODE_CHARGE_PERSON
                     GROUP BY NODE_ID
                 ) person ON node.ID = person.NODE_ID
                          LEFT JOIN SYS_PROJECT_STAGE sps on plan.proj_id = sps.id
                          INNER JOIN (
                     select DISTINCT org_id AS orgid
                     from TMP_AUTH_LIST
                     where id = v_spid
                 ) tal ON instr(sps.PROJECT_ID||'$#$'||plan.proj_id||'$#$'||DUTY_DEPARTMENT_ID||'$#$', tal.orgId||'$#$') > 0
                 WHERE (plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' OR plan.PLAN_TYPE='专项计划')
                   AND plan.APPROVAL_STATUS = '已审核' AND node.IS_DISABLE = 0 and node.IS_DELETE = 0
                   AND (searchcondition is null or instr(node.node_name||'$#$'||plan.plan_name||'$#$'
                                                             ||plan.PROJ_NAME||'$#$'||node.DUTY_DEPARTMENT||'$#$'||person.CHARGE_PERSON||'$#$',
                                                         searchcondition||'$#$') > 0)
                   AND (condition is null or node.DUTY_DEPARTMENT_ID = condition)
             );
end;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_CURRENTPROJ_TBS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_SMART_CURRENTPROJ_TBS" (
    --orgtype IN VARCHAR2, --查询类型，用于判断过滤 0,公司|1,部门|2,项目|3,,本人
    condition IN VARCHAR2, --输入变量：项目id
    currentuserid IN VARCHAR2,--用户id，用于过滤关注的任务
    currentcompanyid IN VARCHAR2,--当前用户公司
    currentdeptid IN VARCHAR2,--当前用户部门
    currentstationid IN VARCHAR2,---当前用户的岗位
    bizcode IN VARCHAR2,---权限code
    searchcondition IN VARCHAR2,--模糊查询条件
    item OUT SYS_REFCURSOR) IS --任务中心tabs任务条数统计数据源
--作者：yedr
--日期：2020/04/07

    v_spid VARCHAR2(200);
BEGIN
    --调用数据权限验证存储过程
    P_SYS_AUTH_DATA_RULE_SPID(
            USERID => currentuserid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
    IF condition <> '111' THEN
        OPEN item FOR SELECT SUM(ACOUNT) AS ACOUNT,
                             SUM(BCOUNT) AS BCOUNT,
                             SUM(CCOUNT) AS CCOUNT,
                             SUM(DCOUNT) AS DCOUNT,
                             SUM(ECOUNT) AS ECOUNT,
                             SUM(FCOUNT) AS FCOUNT,
                             SUM(GCOUNT) AS GCOUNT,
                             SUM(HCOUNT) AS HCOUNT
                      FROM (
                               SELECT NVL(SUM(CASE
                                                  WHEN node.ACTUAL_END_DATE IS NULL AND
                                                       (node.PLAN_END_DATE >= trunc(SYSDATE, 'month') AND
                                                        node.PLAN_END_DATE <= trunc(last_day(SYSDATE)))
                                                      THEN 1
                                                  ELSE 0 END), 0)                                               AS ACOUNT,
                                      NVL(SUM(CASE
                                                  WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE
                                                      THEN 1
                                                  ELSE 0 END),
                                          0)                                                                    AS BCOUNT,
                                      NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END), 0)     AS CCOUNT,
                                      NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),
                                          0)                                                                    AS DCOUNT,
                                      COUNT(node.id)                                                            AS ECOUNT,
                                      NVL(SUM(CASE
                                                  WHEN (
                                                              node.PLAN_END_DATE >= last_day(trunc(SYSDATE)) + 1
                                                          AND
                                                              node.PLAN_END_DATE <= last_day(last_day(trunc(SYSDATE)) + 1)
                                                      ) THEN 1
                                                  ELSE 0 END),
                                          0)                                                                    AS FCOUNT,
                                      NVL(SUM(CASE
                                                  WHEN (
                                                              node.PLAN_END_DATE >= trunc(SYSDATE, 'Q')
                                                          AND
                                                              node.PLAN_END_DATE <= add_months(trunc(SYSDATE, 'Q'), 3) - 1
                                                      ) THEN 1
                                                  ELSE 0 END),
                                          0)                                                                    AS GCOUNT,
                                      NVL(SUM(CASE
                                                  WHEN (
                                                              node.PLAN_END_DATE >= trunc(SYSDATE, 'yyyy')
                                                          AND
                                                              node.PLAN_END_DATE <= add_months(trunc(SYSDATE, 'yyyy'), 12) - 1
                                                      ) THEN 1
                                                  ELSE 0 END),
                                          0)                                                                    AS HCOUNT

                               FROM POM_PROJ_PLAN_NODE node
                                        LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                                        LEFT JOIN (
                                   SELECT listagg(CHARGE_PERSON, ',') within GROUP (order by CHARGE_PERSON ) CHARGE_PERSON,
                                          NODE_ID
                                   FROM POM_NODE_CHARGE_PERSON
                                   GROUP BY NODE_ID
                               ) person ON node.ID = person.NODE_ID
                                        LEFT JOIN SYS_PROJECT_STAGE sps on plan.proj_id = sps.id
                                        LEFT JOIN (select DISTINCT org_id AS orgid
                                                   from TMP_AUTH_LIST
                                                   where id = '' || v_spid || '') tal
                                                  ON (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end) =
                                                     tal.orgId
                               WHERE tal.orgid is not null and node.IS_DELETE = 0
                                 AND (plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划')
                                 AND plan.APPROVAL_STATUS = '已审核'
                                 AND node.IS_DISABLE = 0
                                 AND (node.node_name like '%' || searchcondition || '%' OR
                                      plan.plan_name like '%' || searchcondition || '%'
                                   OR plan.PROJ_NAME like '%' || searchcondition || '%' OR
                                      node.DUTY_DEPARTMENT like '%' || searchcondition || '%'
                                   OR person.CHARGE_PERSON like '%' || searchcondition || '%')
                                 AND (plan.PROJ_ID = '' || condition || '' OR plan.PROJ_ID IN
                                                                              (SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID = '' || condition || ''))
                           );
    ELSE
        OPEN item FOR SELECT SUM(ACOUNT) AS ACOUNT,
                             SUM(BCOUNT) AS BCOUNT,
                             SUM(CCOUNT) AS CCOUNT,
                             SUM(DCOUNT) AS DCOUNT,
                             SUM(ECOUNT) AS ECOUNT,
                             SUM(FCOUNT) AS FCOUNT,
                             SUM(GCOUNT) AS GCOUNT,
                             SUM(HCOUNT) AS HCOUNT
                      FROM (
                               SELECT NVL(SUM(CASE
                                                  WHEN node.ACTUAL_END_DATE IS NULL AND
                                                       (node.PLAN_END_DATE >= trunc(SYSDATE, 'month') AND
                                                        node.PLAN_END_DATE <= trunc(last_day(SYSDATE)))
                                                      THEN 1
                                                  ELSE 0 END), 0)                                               AS ACOUNT,
                                      NVL(SUM(CASE
                                                  WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE
                                                      THEN 1
                                                  ELSE 0 END),
                                          0)                                                                    AS BCOUNT,
                                      NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END), 0)     AS CCOUNT,
                                      NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),
                                          0)                                                                    AS DCOUNT,
                                      COUNT(node.id)                                                            AS ECOUNT,
                                      NVL(SUM(CASE
                                                  WHEN (
                                                              node.PLAN_END_DATE >= last_day(trunc(SYSDATE)) + 1
                                                          AND
                                                              node.PLAN_END_DATE <= last_day(last_day(trunc(SYSDATE)) + 1)
                                                      ) THEN 1
                                                  ELSE 0 END),
                                          0)                                                                    AS FCOUNT,
                                      NVL(SUM(CASE
                                                  WHEN (
                                                              node.PLAN_END_DATE >= trunc(SYSDATE, 'Q')
                                                          AND
                                                              node.PLAN_END_DATE <= add_months(trunc(SYSDATE, 'Q'), 3) - 1
                                                      ) THEN 1
                                                  ELSE 0 END),
                                          0)                                                                    AS GCOUNT,
                                      NVL(SUM(CASE
                                                  WHEN (
                                                              node.PLAN_END_DATE >= trunc(SYSDATE, 'yyyy')
                                                          AND
                                                              node.PLAN_END_DATE <= add_months(trunc(SYSDATE, 'yyyy'), 12) - 1
                                                      ) THEN 1
                                                  ELSE 0 END),
                                          0)                                                                    AS HCOUNT

                               FROM POM_PROJ_PLAN_NODE node
                                        LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                                        LEFT JOIN SYS_PROJECT_STAGE sps on plan.proj_id = sps.id
                                        LEFT JOIN
                                    (SELECT listagg(CHARGE_PERSON, ',') within GROUP (order by CHARGE_PERSON ) CHARGE_PERSON,
                                            NODE_ID
                                     FROM POM_NODE_CHARGE_PERSON
                                     GROUP BY NODE_ID
                                    ) person ON node.ID = person.NODE_ID
                                        LEFT JOIN (select org_id AS orgid
                                                   from TMP_AUTH_LIST
                                                   where id = '' || v_spid || ''
                                                   GROUP BY org_id) tal
                                                  ON (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end) =
                                                     tal.orgId
                               WHERE tal.orgid is not null and node.IS_DELETE = 0
                                 AND (plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划')
                                 AND plan.APPROVAL_STATUS = '已审核'
                                 AND node.IS_DISABLE = 0
                                 AND (node.node_name like '%' || searchcondition || '%' OR
                                      plan.plan_name like '%' || searchcondition || '%'
                                   OR plan.PROJ_NAME like '%' || searchcondition || '%' OR
                                      node.DUTY_DEPARTMENT like '%' || searchcondition || '%' OR
                                      person.CHARGE_PERSON like '%' || searchcondition || '%')
                               --AND node.COMPANY_ID = ''|| condition ||''
                           );
    END IF;
END P_POM_SMART_CURRENTPROJ_TBS;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_CURRENTPSRSON_TBS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_SMART_CURRENTPSRSON_TBS" (
		condition IN VARCHAR2, --输入变量：当前用户ID
        searchcondition IN          VARCHAR2,--模糊查询条件
        item OUT SYS_REFCURSOR ) IS --任务中心tabs任务条数统计数据源
--作者：yedr
--日期：2020/04/07

    v_spid              VARCHAR2(200);
	BEGIN
    OPEN item FOR SELECT
            SUM(ACOUNT) AS ACOUNT,
            SUM(BCOUNT) AS BCOUNT,
            SUM(CCOUNT) AS CCOUNT
            FROM(
                SELECT
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS ACOUNT,
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS CCOUNT
                    FROM
                    POM_PROJ_PLAN_NODE node
                    LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
                    WHERE  (plan.PLAN_TYPE = '项目主项计划' OR  plan.PLAN_TYPE = '关键节点计划')
                    AND plan.APPROVAL_STATUS = '已审核'
                    AND node.IS_DISABLE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.PROJ_NAME like '%'||searchcondition||'%' OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
                    AND person.CHARGE_PERSON_ID = '' || condition || ''
--                UNION ALL
--                SELECT
--                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS ACOUNT,
--                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
--                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS CCOUNT
--                    FROM POM_SPECIAL_PLAN_NODE node
--					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
--                    LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
--                    WHERE node.ACTUAL_END_DATE IS NULL
--					AND plan.APPROVAL_STATUS = '已审核'
--					AND	node.IS_DELETE=0
--                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
--                    OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
--                    AND person.CHARGE_PERSON_ID = '' || condition || ''
--                UNION ALL
--                SELECT
--                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
--                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
--                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS ECOUNT
--                    FROM pom_dept_monthly_plan_node node
--					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
--                    LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
--                    WHERE APPROVE_STATUS = '已审核'
--					AND (node.IS_DEL=0 OR node.IS_DEL=null)
--                    AND person.CHARGE_PERSON_ID = '' || condition || ''
--                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
--                    OR plan.DEPT_NAME like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')

            );

END P_POM_SMART_CURRENTPSRSON_TBS;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_DELAY_NODE_CURRENT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_SMART_DELAY_NODE_CURRENT" (
    plantype       IN             VARCHAR2,
    datascope      IN             VARCHAR2,
    orgid          IN             VARCHAR2,
    title          OUT            VARCHAR2,
    titleicon      OUT            VARCHAR2,
    currentdelay   OUT            SYS_REFCURSOR
) AS --关键节点计划监控-当前延误节点
        --作者：陈丽
        --日期：2019/11/13
BEGIN
    title := '当前延误节点';
    --图标库地址 https://element.eleme.cn/#/zh-CN/component/icon
    titleicon := 'el-icon-tickets';
     
																		 
                OPEN CURRENTDELAY FOR
                        SELECT DISTINCT A.ORG_NAME AS "orgName",
                                                        B2.PROJECTSTAGE_NAME AS "projName",
                                                        B2.NODE_NAME|| CASE WHEN ESTIMATE_END_DATE IS NOT NULL THEN   '(预计完成日期：'||TO_CHAR(ESTIMATE_END_DATE,'YYYY-MM-DD ')||')'END  AS "nodeName",
                                                        NODE_ID as "nodeId",
                                                        ORIGINAL_NODE_ID as "nodeOriginId",
                                                        '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||
                                                         NVL(B2.COMPANY_ID, '003200000000000000000000000000') ||
                                                         '&ppid=' || B2.PPID || '&planType=关键节点计划' AS "projOpenUrl",
                                                        '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id=' ||
                                                         B2.PLANID || '&feedbackNodeId=' || NODE_ID ||
                                                         '&feedbackNodeOriginalId=' || ORIGINAL_NODE_ID ||
                                                         '&nodeSourcePlanType=0' AS "nodeOpenUrl",
                                                          '<span class="right"> 已延误 <span style="display: inline-block;
                                                                width: 40px;
                                                                text-align: center;
                                                                border-radius: 4px;
                                                                margin: 0 4px;
                                                                background-color: rgb(248, 94, 90);
                                                                color: #fff;
                                                                font-weight: 700;">'
                                                                ||TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd'))
                                                                ||'</span> 天 </span>'             AS "delayDays"
																																,TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') as "DelayDAYsRUNK"
                        FROM   SYS_BUSINESS_UNIT A

                        LEFT   JOIN (SELECT LEVEL, ORG_NAME, CONNECT_BY_ROOT ID AS ID,
                                                                CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
                                                                B.UNIT_ID, B.NODE_NAME, B.NODE_ID,
                                                                B.ACTUAL_END_DATE, B.PLAN_END_DATE,
                                                                B.PROJECTSTAGE_NAME, B.PPID, B.PID,
                                                                'TYPE_ORG' AS CTYPE, B.ESTIMATE_END_DATE,
                                                                B.PLANID, ORIGINAL_NODE_ID,B.COMPANY_ID
                                                 FROM   SYS_BUSINESS_UNIT A
                                                 LEFT   JOIN (SELECT B1.UNIT_ID, A.ID AS PLANID,A.COMPANY_ID,
                                                                                        case when  STAGE_NAME like '%无分期%' then  B1.ID else A.PROJ_ID end   AS PPID,--20200427李小聪调整勿修改
																																												B1.ID AS PID,
                                                                                        A1.ORIGINAL_NODE_ID,

                                                                                         A.PROJ_NAME AS PROJECTSTAGE_NAME,
                                                                                        A1.NODE_NAME, A1.ID AS NODE_ID,
                                                                                        A1.ACTUAL_END_DATE,
                                                                                        A1.PLAN_END_DATE,
                                                                                        A1.ESTIMATE_END_DATE
                                                                         FROM   POM_PROJ_PLAN A
                                                                         INNER  JOIN POM_PROJ_PLAN_NODE A1
                                                                         ON     A.ID = A1.PROJ_PLAN_ID
                                                                         INNER  JOIN SYS_PROJECT_STAGE C1
                                                                         ON     A.PROJ_ID = C1.ID
                                                                         INNER  JOIN SYS_PROJECT B1
                                                                         ON     C1.PROJECT_ID = B1.ID
                                                                         WHERE  A.PLAN_TYPE = '关键节点计划' AND

                                                                                        A.APPROVAL_STATUS = '已审核'
																																									and  A1.IS_DISABLE=0
																																									AND

                                                                                        TRUNC(SYSDATE, 'dd') -TRUNC(PLAN_END_DATE, 'dd') > 0 AND
                                                                                        ACTUAL_END_DATE IS NULL) B
                                                 ON     A.ID = B.UNIT_ID
                                                 WHERE  ORG_TYPE = 0
                                                 START  WITH ID = '' || ORGID || ''
                                                 CONNECT BY PRIOR A.ID = A.PARENT_ID) B2
                        ON     A.ID = B2.ID
                        WHERE  NODE_NAME IS NOT NULL AND
                                     ACTUAL_END_DATE IS NULL AND
                                     TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 
																		 --分期
                        UNION ALL
                        SELECT DISTINCT '' AS "orgName",
                                                     A.PROJ_NAME AS "projName",
                                                        A1.NODE_NAME|| CASE WHEN ESTIMATE_END_DATE IS NOT NULL THEN   '(预计完成日期：'||TO_CHAR(ESTIMATE_END_DATE,'YYYY-MM-DD ')||')'END  AS "nodeName",
                                                         A1.ID as "nodeId",
                                                        A1.ORIGINAL_NODE_ID as "nodeOriginId",
                                                        '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||
                                                         NVL(A.COMPANY_ID,
                                                                 '003200000000000000000000000001') ||
                                                         '&ppid=' || C1.ID || '&planType=关键节点计划' AS "projOpenUrl",
                                                        '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id=' || A.ID ||
                                                         '&feedbackNodeId=' || A1.ID ||
                                                         '&feedbackNodeOriginalId=' ||
                                                         A1.ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
                                                          '<span class="right"> 已延误 <span style="display: inline-block;
                                                                width: 40px;
                                                                text-align: center;
                                                                border-radius: 4px;
                                                                margin: 0 4px;
                                                                background-color: rgb(248, 94, 90);
                                                                color: #fff;
                                                                font-weight: 700;">'
                                                                ||TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd'))
                                                                ||'</span> 天 </span>'             AS "delayDays"
--                                                        TRUNC(SYSDATE, 'dd') -
--                                                         TRUNC(PLAN_END_DATE, 'dd') AS "delayDays"
,TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') as "DelayDAYsRUNK"

                        FROM   POM_PROJ_PLAN A
                        INNER  JOIN POM_PROJ_PLAN_NODE A1
                        ON     A.ID = A1.PROJ_PLAN_ID
                        INNER  JOIN SYS_PROJECT_STAGE C1
                        ON     A.PROJ_ID = C1.ID
                        INNER  JOIN SYS_PROJECT B1
                        ON     C1.PROJECT_ID = B1.ID
                        WHERE  A.PLAN_TYPE = '关键节点计划' AND
                                     A.APPROVAL_STATUS = '已审核'
																		 and  A1.IS_DISABLE=0
																		 AND

                                     TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 AND
                                     ACTUAL_END_DATE IS NULL AND
                                     C1.PROJECT_ID = '' || ORGID || ''
                        ORDER  BY 9 DESC,2;							 
																		 
END p_pom_smart_delay_node_current;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_DELAY_NODE_PREDICT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_SMART_DELAY_NODE_PREDICT" (
    plantype       IN             VARCHAR2,
    datascope      IN             VARCHAR2,
    orgid          IN             VARCHAR2,
    title          OUT            VARCHAR2,
    titleicon      OUT            VARCHAR2,
    predictdelay   OUT            SYS_REFCURSOR
) AS --关键节点计划监控-预计延误节点
		--作者：陈丽
		--日期：2019/11/13
BEGIN

    title := '预计延误及5天内到期节点';
    titleicon := '';

   open predictdelay FOR


      SELECT DISTINCT
      A.ORG_NAME AS "orgName",
      B2.PROJECTSTAGE_NAME AS "projName",
      B2.NODE_NAME ||case when  ESTIMATE_END_DATE is NOT null then '   (预计完成日期：'||  TO_CHAR(ESTIMATE_END_DATE,'yyyy-mm-dd') ||')' else  null end AS "nodeName",
      NODE_ID as "nodeId",
      ORIGINAL_NODE_ID as "nodeOriginId",
      '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' || b2.UNIT_ID ||  '&ppid=' || B2.PPID || '&planType=关键节点计划' AS "projOpenUrl",
      '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id=' || B2.PLANID || '&feedbackNodeId=' || NODE_ID || '&feedbackNodeOriginalId=' || ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",

				CASE  WHEN TRUNC(ESTIMATE_END_DATE, 'dd' ) - TRUNC(  PLAN_END_DATE, 'dd' ) > 0   THEN
						'<span class="right"> 预计延误 <span style="display: inline-block;
																width: 40px;
																text-align: center;
																border-radius: 4px;
																margin: 0 4px;
																background-color: rgb(248, 94, 90);
																color: #fff;
																font-weight: 700;">'
																||TO_CHAR( TRUNC(ESTIMATE_END_DATE, 'dd' ) - TRUNC(  PLAN_END_DATE, 'dd' ))
																||'</span> 天 </span>'
								WHEN  TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE)=0 THEN
						'<span class="right"> 今天到期 </span>'
								ELSE
													'<span class="right"> 余  <span style="display: inline-block;
																width: 30px;
																text-align: center;
																border-radius: 4px;
																margin: 0 4px;
																background-color:  #409eff;
																color: #fff;
																font-weight: 700;">'
																||TO_CHAR(TRUNC(PLAN_END_DATE, 'dd')-TRUNC(SYSDATE, 'dd'))
																||'</span> 天到期 </span>' 	 END
														AS "delayDays"
											, case when ESTIMATE_END_DATE is not null  then  TRUNC(ESTIMATE_END_DATE, 'dd' ) - TRUNC(  PLAN_END_DATE, 'dd' )   else  TRUNC(PLAN_END_DATE, 'dd')-TRUNC(SYSDATE, 'dd')
										  end  as daycount
    FROM
      SYS_BUSINESS_UNIT a
      LEFT JOIN (
      SELECT LEVEL
        ,
        ORG_NAME,
        CONNECT_BY_ROOT ID AS ID,
        CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
        B.UNIT_ID,
        B.NODE_NAME,
        B.NODE_ID,
        B.ACTUAL_END_DATE,
        B.PLAN_END_DATE,
        B.PROJECTSTAGE_NAME,
        B.PPID,
        B.PID,
        'TYPE_ORG' AS CTYPE,
        B.ESTIMATE_END_DATE,
        PLANID,
        ORIGINAL_NODE_ID
      FROM
        SYS_BUSINESS_UNIT A
        LEFT JOIN (
        SELECT
          B1.UNIT_ID,
          A.ID AS PLANID,
          A1.ORIGINAL_NODE_ID,
         	 case when  STAGE_NAME like '%无分期%' then  B1.ID else A.PROJ_ID end   AS PPID,--20200427李小聪调整勿修改
          B1.ID AS PID,
           A.PROJ_NAME AS PROJECTSTAGE_NAME,
          A1.NODE_NAME,
          A1.ID AS NODE_ID,
          A1.ACTUAL_END_DATE,
          A1.PLAN_END_DATE,
          A1.ESTIMATE_END_DATE
        FROM
          POM_PROJ_PLAN A
          INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
          INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
          INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID
        WHERE
          A.PLAN_TYPE = '关键节点计划'
          AND A.APPROVAL_STATUS = '已审核'
					and  A1.IS_DISABLE=0
          AND (TRUNC(ESTIMATE_END_DATE , 'dd' ) - TRUNC(PLAN_END_DATE , 'dd' ) > 0  OR
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5)
          AND ACTUAL_END_DATE IS NULL

        ) B ON A.ID = B.UNIT_ID
      WHERE
        ORG_TYPE = 0 START WITH ID = '' || orgId || '' CONNECT BY PRIOR A.ID = A.PARENT_ID
      ) B2 ON A.ID = B2.ID
    WHERE
      NODE_NAME IS NOT NULL
      AND ACTUAL_END_DATE IS NULL
			--判断条件

    AND (TRUNC(ESTIMATE_END_DATE, 'dd' ) - TRUNC(  PLAN_END_DATE, 'dd' ) > 0  OR
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5 --5天内到期
				)
				--	未超期
		AND		TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') <= 0
			--分期
    UNION ALL
    SELECT DISTINCT
      '' AS "orgName",
       A.PROJ_NAME AS "projName",
      A1.NODE_NAME  ||case when  ESTIMATE_END_DATE is NOT null then '   (预计完成日期：'||  TO_CHAR(ESTIMATE_END_DATE,'yyyy-mm-dd') ||')' else  null end  AS "nodeName",
        A1.ID as "nodeId",
      A1.ORIGINAL_NODE_ID as "nodeOriginId",
      '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||A.COMPANY_ID || '&ppid=' || B1.ID || '&planType=关键节点计划' AS "projOpenUrl",
      '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id=' || A.ID || '&feedbackNodeId=' || A1.ID || '&feedbackNodeOriginalId=' || A1.ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
			CASE  WHEN  TRUNC(ESTIMATE_END_DATE, 'dd' ) - TRUNC(  PLAN_END_DATE, 'dd' ) > 0   THEN
						'<span class="right"> 预计延误 <span style="display: inline-block;
																width: 40px;
																text-align: center;
																border-radius: 4px;
																margin: 0 4px;
																background-color: rgb(248, 94, 90);
																color: #fff;
																font-weight: 700;">'
																||TO_CHAR( TRUNC(ESTIMATE_END_DATE, 'dd' ) - TRUNC(  PLAN_END_DATE, 'dd' ))
																||'</span> 天 </span>'
								WHEN  TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE)=0 THEN
						'<span class="right"> 今天到期 </span>'
								ELSE
													'<span class="right"> 余  <span style="display: inline-block;
																width: 30px;
																text-align: center;
																border-radius: 4px;
																margin: 0 4px;
																background-color:  #409eff;
																color: #fff;
																font-weight: 700;">'
																||TO_CHAR(TRUNC(PLAN_END_DATE, 'dd')-TRUNC(SYSDATE, 'dd'))
																||'</span> 天到期 </span>' 	 END
														AS "delayDays"
				, case when ESTIMATE_END_DATE is not null  then  TRUNC(ESTIMATE_END_DATE, 'dd' ) - TRUNC(  PLAN_END_DATE, 'dd' )
				else  TRUNC(PLAN_END_DATE, 'dd')-TRUNC(SYSDATE, 'dd')
										  end  as daycount
    FROM
      POM_PROJ_PLAN A
      INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
      INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
      INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID
    WHERE
      A.PLAN_TYPE = '关键节点计划'
      AND A.APPROVAL_STATUS = '已审核'
				and  A1.IS_DISABLE=0
      AND (TRUNC(ESTIMATE_END_DATE, 'dd' ) - TRUNC(  PLAN_END_DATE, 'dd' ) > 0  OR
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5)
			AND	 TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') <= 0
      AND ACTUAL_END_DATE IS NULL

      AND C1.PROJECT_ID = '' || orgId || ''
    ORDER BY
      daycount asc;

END p_pom_smart_delay_node_predict;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_EXAM_RUEL_DEL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_SMART_EXAM_RUEL_DEL" 
(
		RULEID  IN VARCHAR2
	 , --输入变量：规则id
		ERRMSG  OUT VARCHAR2
	 , --提示消息
		ERRCODE OUT INT --0成功，1失败
) IS
		--考核规则删除
		--作者：叶丁荣
		--日期：2019/11/22
		COUNTDTL INT;
BEGIN
		BEGIN
				COUNTDTL := 0;
				IF LENGTH(RULEID) < 32 THEN
						RAISE_APPLICATION_ERROR(-20000, '请选择要删除的规则');
				END IF;
				--循环规则id
		
				FOR ITEM IN (SELECT REGEXP_SUBSTR('' || RULEID || '', '[^,]+', 1,
																					 ROWNUM) AS ID
										 FROM   DUAL
										 CONNECT BY ROWNUM <=
																LENGTH('' || RULEID || '') -
																LENGTH(REGEXP_REPLACE('' || RULEID || '', ',',
																											'')) + 1)
				LOOP
						---删除规则
						DELETE POM_RULE_EXAMINATION WHERE ID = '' || ITEM.ID || '';
				
						COUNTDTL := COUNTDTL + 1;
				END LOOP;
		
				ERRCODE := 0;
				ERRMSG  := '删除成功！' || COUNTDTL || '条规则';
		EXCEPTION
				WHEN OTHERS THEN
						ERRCODE := 1;
						ERRMSG  := SQLERRM;
		END;
END P_POM_SMART_EXAM_RUEL_DEL;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_EXAMRULE_SET_STATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_SMART_EXAMRULE_SET_STATE" ( 
        ruleid      IN  CLOB, --输入变量：规则id
		statetype   IN  INT, --0生效，1失效
		errmsg      OUT VARCHAR2, --提示消息
		errcode     OUT INT --0成功，1失败
	) IS --考核规则生效失效设置
--作者：叶丁荣
--日期：2019/11/21
	typemsg VARCHAR2 ( 50 );
    ruleids VARCHAR2 ( 4000 );
    countdtl INT;
    testmsg CLOB;
    statuscount NUMBER;
BEGIN
	BEGIN
			testmsg := 'ruleid:' || to_char(ruleid) || '.statetype:' || statetype;
            countdtl := 0;
		IF
			statetype = 0 THEN
				typemsg := '失效';
			ELSE typemsg := '生效';

		END IF;
		IF
			length( to_char(ruleid) ) < 36 THEN
				raise_application_error ( - 20000, '请选择要' || typemsg || '的规则' || testmsg );

		END IF;
--循环规则id
		FOR item IN (
			SELECT
				regexp_substr( '' || to_char(ruleid) || '', '[^,]+', 1, ROWNUM ) AS id 
			FROM
				dual CONNECT BY ROWNUM <= length( '' || to_char(ruleid) || '' ) - length( regexp_replace( '' || to_char(ruleid) || '', ',', '' ) ) + 1 
			)
			LOOP---拼接字符串
			ruleids := ruleids || item.id;
		SELECT COUNT(IS_ACTIVE) INTO statuscount  FROM POM_RULE_EXAMINATION WHERE ID='' || item.id || '' AND IS_ACTIVE=statetype ;

			IF(statuscount>0) THEN
				errcode := 1;
				errmsg := '已有'''||typemsg||'''的规则，请选择相同状态的数据进行操作';
				return;
			ELSE 
					UPDATE POM_RULE_EXAMINATION 
					SET IS_ACTIVE = statetype 
					WHERE
						id = '' || item.id || '';
					countdtl := countdtl + 1;
			END IF;

	END LOOP;

			errcode := 0;
			errmsg := typemsg || '设置成功！' || countdtl || '条规则';

EXCEPTION 
	WHEN OTHERS THEN
	errcode := 1;
errmsg := sqlerrm;

END;

END p_pom_smart_examrule_set_state;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_KEY_NODE_PLAN_PROJ
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_SMART_KEY_NODE_PLAN_PROJ" 
(
    PROJID      IN VARCHAR2
   , --输入变量：项目
    PAGEINDEX   IN INT
   ,PAGESIZES   IN INT
   ,CURRENTTYPE IN VARCHAR2
   , --完成节点类型(本月任务,超期未完成任务,所有未完成任务,所有已完成任务,所有任务,次月任务,本季度任务,本年任务)
    userid        IN            VARCHAR2,--用户id用于过滤关注的任务
    currentcompanyid     IN     VARCHAR2,--当前用户的公司
    currentstationid     IN            VARCHAR2,---当前用户的岗位
    currentdeptid        IN            VARCHAR2,---当前用户的部门
    searchcondition IN          VARCHAR2,--模糊查询条件
    bizcode       IN            VARCHAR2,---权限code
    ITEMS       OUT SYS_REFCURSOR
   ,TOTAL       OUT INT
) IS
    --本部门负责的任务
    --作者：陈丽
    --日期：2019/11/15

    V_SQL_START       CLOB;
    V_SQL_END         CLOB;
    V_SQL_CONTENT     CLOB;
    V_SQL             CLOB;
    V_SQL_EXEC        CLOB;
    V_SQL_EXEC_PAGING CLOB;
    V_WHERE           VARCHAR2(500);
    TESTMSG           NVARCHAR2(200);
    v_spid              VARCHAR2(200);--数据权限验证spid
    v_where_like       CLOB;
    v_test_land        CLOB;
    plan_expression     varchar2(4000);
BEGIN
    ----------------------------------------------------统一解析
    TESTMSG := 'projid:' || PROJID || '；pageindex:' || PAGEINDEX || '；pagesizes:' || PAGESIZES || '；currenttype:' || CURRENTTYPE;

    BEGIN
        TOTAL         := 1000;
        V_SQL_START   := ' case ';
        V_SQL_CONTENT := '';
        V_SQL_END     := '  else '''' end  ';


        --调用数据权限验证存储过程
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
        --1.拼接查询语句
        FOR ITEM IN (SELECT S.EXPRESSION, VV.NODE_LEVEL, VV.PLAN_TYPE
                     FROM   POM_RULE_SET S
                     LEFT   JOIN (SELECT MAX(S.CREATED_TIME) AS T, NODE_LEVEL, PLAN_TYPE
                                 FROM   POM_RULE_SET S
                                 LEFT   JOIN POM_RULE_SET_PLAN_TYPE PT
                                 ON     S.ID = PT.RULE_ID
                                 WHERE  RULE_TYPE = '亮灯规则'
                                       -- AND plan_type != '关键节点计划'
                                        AND
                                        S.IS_DISABLE = 0
                                 GROUP  BY NODE_LEVEL, PLAN_TYPE) VV
                     ON     S.CREATED_TIME = VV.T AND
                            S.NODE_LEVEL = VV.NODE_LEVEL
                     WHERE  VV.T IS NOT NULL)
        LOOP

        IF ITEM.plan_type = '专项计划' THEN
            plan_expression := ''' then ('''
                                || ITEM.expression
                                || ''') ';
        ELSE
            plan_expression := ''' then ('
                                || ITEM.expression
                                || ') ';
        END IF ;

            ---拼接字符串
            V_SQL_CONTENT := V_SQL_CONTENT || '  when plan_type=''' || CASE ITEM.PLAN_TYPE
                                 WHEN '项目全景计划' THEN
                                  '项目主项计划'
                                 ELSE
                                  ITEM.PLAN_TYPE
                             END || ''' and node_level='''
                                 || ITEM.NODE_LEVEL
                                 || plan_expression;
        END LOOP;

        --dbms_output.put_line('123333');
        --dbms_output.put_line(v_sql_content);
        --规则内容大于0才拼规则语句

        IF LENGTH(V_SQL_CONTENT) > 0
        THEN
            V_SQL := V_SQL_START || V_SQL_CONTENT || V_SQL_END;
        ELSE
            --无规则亮灯显示空
            V_SQL := '''''';
        END IF;

        -------------------------------------------------------------------------------------------内容


        IF CURRENTTYPE = '本月任务'
        THEN
            V_WHERE := ' and n.ACTUAL_END_DATE is null and (n.PLAN_END_DATE>=trunc(sysdate, ''month'') and n.PLAN_END_DATE<=trunc(last_day(sysdate))) ';
        ELSIF CURRENTTYPE = '超期未完成任务'
        THEN
            V_WHERE := ' and TRUNC(SYSDATE) > n.PLAN_END_DATE and n.ACTUAL_END_DATE is null';
        ELSIF CURRENTTYPE = '所有未完成任务'
        THEN
            V_WHERE := ' and n.ACTUAL_END_DATE is null ';
        ELSIF CURRENTTYPE = '所有已完成任务'
        THEN
            V_WHERE := ' and n.ACTUAL_END_DATE is not null ';
        ELSIF CURRENTTYPE = '所有任务'
        THEN
            V_WHERE := ' ';
        ELSE
            V_WHERE := ' and 1=2';
        END IF;

        --当输入条件部位空时
        IF searchcondition is not null THEN
          v_where_like := 'WHERE (instr(n.NODE_NAME,'''||searchcondition||''')>0 OR instr(n.PLAN_NAME,'''||searchcondition||''')>0
              OR instr(n.PROJ_NAME,'''||searchcondition||''')>0 OR instr(n.DUTY_DEPARTMENT,'''||searchcondition||''')>0
              OR instr(charge_person,'''||searchcondition||''')>0 )';
        ELSE
          v_where_like := '';
        END IF;

        --3.拼接完整语句
        IF PROJID<>'111' THEN
        V_SQL_EXEC := ' select  rownum as rowno,ID,
                    ORIGINAL_NODE_ID,
                    ORIGINAL_PLAN_ID,
                    PROJ_PLAN_ID as PLAN_ID,
                    PLAN_TYPE_INT,
                    NODE_NAME,
                    PLAN_NAME,
                    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
                    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
                    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
                    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
                    case when ACTUAL_END_DATE is null then ''未完成''
                    else ''已完成'' end as COMPLETION_STATUS,
                    PROJ_NAME,
                    PLAN_TYPE,
                    DUTY_DEPARTMENT,
                    CHARGE_PERSON,
                    NODE_LEVEL,
                    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,w_Url,' || V_SQL || ' as NODE_WARNING from (select n.*,w.IS_UN_WATCH
                ,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
                ,case when n.ACTUAL_END_DATE IS NOT NULL THEN NULL
                ELSE ''催办'' END as HASTEN
                ,case when w.IS_UN_WATCH=0 then ''/api/pom/planfollow/unfollow?cancelType=0=724=300=''||ORIGINAL_NODE_ID else ''/pom/biz-watch/bizwatch-setting?cancelType=0=724=300==''||ORIGINAL_NODE_ID end as w_Url

                                      from(SELECT
                    n.ID,
                     p.ORIGINAL_PLAN_ID,
                    n.ORIGINAL_NODE_ID,
                    n.PROJ_PLAN_ID,
                    CASE p.PLAN_TYPE
                        WHEN ''关键节点计划''   THEN
                            0
                        WHEN ''项目主项计划''   THEN
                            1
                    END AS PLAN_TYPE_INT,

                    CASE WHEN f.id IS NULL THEN
                        n.NODE_NAME
                    WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE <> ''CARRY_OUT'' THEN
                        n.NODE_NAME||''【预计完成日期:''||to_char(f.ESTIMATE_END_TIME,''yyyy-MM-dd'')||''】''
                    WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''未审核'' THEN
                        n.NODE_NAME||''【完成反馈未发起】''
                    WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''审核中'' THEN
                        n.NODE_NAME||''【完成反馈审核中】''
                    WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''已审核'' THEN
                        n.NODE_NAME||''【实际完成日期:''||to_char(f.ACTUAL_END_TIME,''yyyy-MM-dd'')||''】''
                    END AS NODE_NAME,
                    p.PLAN_NAME,--计划名称
                    n.PLAN_START_DATE,
                    n.PLAN_END_DATE,

                    n.ACTUAL_END_DATE,
                    n.ESTIMATE_END_DATE,           --预计完成时间
                    p.PROJ_NAME,          --所属项目
                    p.PLAN_TYPE,        --计划类型显示名
                    n.DUTY_DEPARTMENT,          --主责部门
                    cp.CHARGE_PERSON,
                    n.NODE_LEVEL,           --任务等级
                    n.STANDARD_SCORE          --标准分值
                FROM
                    POM_PROJ_PLAN_NODE n LEFT
                    JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
                    left join (SELECT node_id,LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
                    FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID
                    LEFT JOIN SYS_PROJECT_STAGE sps on p.proj_id=sps.id
                    LEFT JOIN (SELECT B.*FROM (SELECT A.*,
                    ROW_NUMBER() OVER(partition by a.feedback_node_id order by A.CREATED desc nulls last) rn
                    FROM POM_NODE_FEEDBACK A) B
                    WHERE RN = 1) f on f.feedback_node_id=n.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal
                    ON (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
                    WHERE tal.orgId is not null
                    and p.PLAN_TYPE=''关键节点计划'' AND NVL(n.IS_DISABLE,0) <> 1 and p.APPROVAL_STATUS=''已审核''
                    AND (p.PROJ_ID=''' || PROJID || ''' OR p.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''' || PROJID || '''))  ' || V_WHERE || '
                )n
                    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID '||v_where_like||' ORDER BY n.PLAN_END_DATE)  a ';

        ELSE
            V_SQL_EXEC := 'select  rownum as rowno,ID,
                    ORIGINAL_NODE_ID,
                    ORIGINAL_PLAN_ID,
                    PROJ_PLAN_ID as PLAN_ID,
                    PLAN_TYPE_INT,
                    NODE_NAME,
                    PLAN_NAME,
                    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
                    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
                    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
                    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
                    case when ACTUAL_END_DATE is null then ''未完成''
                    else ''已完成'' end as COMPLETION_STATUS,
                    PROJ_NAME,
                    PLAN_TYPE,
                    DUTY_DEPARTMENT,
                    CHARGE_PERSON,
                    NODE_LEVEL,
                    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,w_Url,' || V_SQL || ' as NODE_WARNING from (select n.*,w.IS_UN_WATCH
                ,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
                ,case when n.ACTUAL_END_DATE IS NOT NULL THEN NULL
                ELSE ''催办'' END as HASTEN
                ,case when w.IS_UN_WATCH=0 then ''/api/pom/planfollow/unfollow?cancelType=0=724=300=''||ORIGINAL_NODE_ID else ''/pom/biz-watch/bizwatch-setting?cancelType=0=724=300==''||ORIGINAL_NODE_ID end as w_Url

                                      from(SELECT
                    n.ID,
                    p.ORIGINAL_PLAN_ID,
                    n.ORIGINAL_NODE_ID,
                    n.PROJ_PLAN_ID,
                    CASE p.PLAN_TYPE
                        WHEN ''关键节点计划''   THEN
                            0
                        WHEN ''项目主项计划''   THEN
                            1
                    END AS PLAN_TYPE_INT,

                    CASE WHEN f.id IS NULL THEN
                        n.NODE_NAME
                    WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE <> ''CARRY_OUT'' THEN
                        n.NODE_NAME||''【预计完成日期:''||to_char(f.ESTIMATE_END_TIME,''yyyy-MM-dd'')||''】''
                    WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''未审核'' THEN
                        n.NODE_NAME||''【完成反馈未发起】''
                    WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''审核中'' THEN
                        n.NODE_NAME||''【完成反馈审核中】''
                    WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''已审核'' THEN
                        n.NODE_NAME||''【实际完成日期:''||to_char(f.ACTUAL_END_TIME,''yyyy-MM-dd'')||''】''
                    END AS NODE_NAME,
                    p.PLAN_NAME,--计划名称
                    n.PLAN_START_DATE,
                    n.PLAN_END_DATE,

                    n.ACTUAL_END_DATE,
                    n.ESTIMATE_END_DATE,           --预计完成时间
                    p.PROJ_NAME,          --所属项目
                    p.PLAN_TYPE,        --计划类型显示名
                    n.DUTY_DEPARTMENT,          --主责部门
                    cp.CHARGE_PERSON,
                    n.NODE_LEVEL,           --任务等级
                    n.STANDARD_SCORE          --标准分值
                FROM
                    POM_PROJ_PLAN_NODE n LEFT
                    JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
                    left join (SELECT node_id,LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
                    FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID
                    LEFT JOIN SYS_PROJECT_STAGE sps on p.proj_id=sps.id
                    LEFT JOIN (SELECT B.*FROM (SELECT A.*,
                    ROW_NUMBER() OVER(partition by a.feedback_node_id order by A.CREATED desc nulls last) rn
                    FROM POM_NODE_FEEDBACK A) B
                    WHERE RN = 1) f on f.feedback_node_id=n.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal
                    ON (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
                    WHERE tal.orgId is not null
                    and p.PLAN_TYPE=''关键节点计划'' AND NVL(n.IS_DISABLE,0) <> 1 and p.APPROVAL_STATUS=''已审核''
                     ' || V_WHERE || '
                )n
                    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID '||v_where_like||' ORDER BY n.PLAN_END_DATE) a ';
        END IF;
        -------------------------------------------------------------------------------------------内容

        V_SQL_EXEC_PAGING := '
select a.* from ( ' || V_SQL_EXEC || ' where rownum <= ' || PAGEINDEX * PAGESIZES || ' ) a where a.rowno > ' || PAGESIZES * (PAGEINDEX - 1) || '';

        DBMS_OUTPUT.PUT_LINE(V_SQL_EXEC);
        ----获取总条数
        EXECUTE IMMEDIATE 'SELECT count(rowno) from(' || V_SQL_EXEC || ') a '
            INTO TOTAL;

        -- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN ITEMS FOR V_SQL_EXEC_PAGING;
        --SELECT '' A FROM DUAL;

    EXCEPTION
        WHEN OTHERS THEN
            TESTMSG := SQLERRM || TESTMSG;
            OPEN ITEMS FOR
                SELECT '失败咯' || TESTMSG PLAN_NAME FROM DUAL;

            DBMS_OUTPUT.PUT_LINE(SQLERRM);
    END;

END P_POM_SMART_KEY_NODE_PLAN_PROJ;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_KEY_NODE_PLAN_TBS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_SMART_KEY_NODE_PLAN_TBS" 
(
    ORGTYPE   IN VARCHAR2
   , --查询类型，用于判断过滤 0,公司|1,部门|2,项目|3,本人
    CONDITION IN VARCHAR2
   , --输入变量：公司id | 部门id | 项目id | 当前用户ID
    userid        IN            VARCHAR2,--用户id用于过滤关注的任务
    currentcompanyid     IN     VARCHAR2,--当前用户的公司
    currentstationid     IN            VARCHAR2,---当前用户的岗位
    currentdeptid        IN            VARCHAR2,---当前用户的部门
    bizcode       IN            VARCHAR2,---权限code
    searchcondition IN          VARCHAR2,--模糊查询条件
    ITEM      OUT SYS_REFCURSOR
) IS
    --任务中心tabs任务条数统计数据源
    --作者：yedr
    --日期：2019/12/25
    v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN

    --调用数据权限验证存储过程
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
    IF CONDITION<>'222' THEN
        OPEN ITEM FOR
            SELECT NVL(SUM(CASE
                               WHEN B.ACTUAL_END_DATE IS NULL
                               AND ( B.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND B.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) ) THEN
                                1
                               ELSE
                                0
                           END), 0) AS ACOUNT,
                   NVL(SUM(CASE
                               WHEN B.ACTUAL_END_DATE IS NULL
                                    AND TRUNC(SYSDATE) > B.PLAN_END_DATE THEN
                                1
                               ELSE
                                0
                           END),
                       0) AS BCOUNT,
                   NVL(SUM(CASE
                               WHEN B.ACTUAL_END_DATE IS NULL THEN
                                1
                               ELSE
                                0
                           END),
                       0) AS CCOUNT,
                   NVL(SUM(CASE
                               WHEN B.ACTUAL_END_DATE IS NOT NULL THEN
                                1
                               ELSE
                                0
                           END),
                       0) AS DCOUNT,
                   COUNT(*) AS ECOUNT
            FROM  POM_PROJ_PLAN_NODE B
            LEFT JOIN  POM_PROJ_PLAN A ON  A.ID = B.PROJ_PLAN_ID
            LEFT JOIN (
						
		SELECT  listagg(CHARGE_PERSON,',') within GROUP(order by CHARGE_PERSON ) CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID
							
						
						)  person ON B.ID=person.NODE_ID
            LEFT JOIN  SYS_PROJECT_STAGE sps on A.proj_id=sps.id
            LEFT JOIN  (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
            on (case when sps.id is not null then sps.PROJECT_ID else A.proj_id end)=tal.orgId
            WHERE
                   tal.orgId is not null and
                   A.APPROVAL_STATUS = '已审核' AND
                   A.PLAN_TYPE = '关键节点计划' AND
                   NVL(B.IS_DISABLE, 0) <> 1 AND
                   (A.PROJ_ID = '' || CONDITION || '' OR A.PROJ_ID IN (SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID = '' || CONDITION || ''))
                   AND (b.node_name like '%'||searchcondition||'%' OR a.plan_name like '%'||searchcondition||'%'
                   OR a.PROJ_NAME like '%'||searchcondition||'%' OR b.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%');
        ELSE
             OPEN ITEM FOR
             SELECT NVL(SUM(CASE
                               WHEN B.ACTUAL_END_DATE IS NULL
                               AND ( B.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND B.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                               THEN
                                1
                               ELSE
                                0
                           END), 0) AS ACOUNT,
                   NVL(SUM(CASE
                               WHEN B.ACTUAL_END_DATE IS NULL
                                    AND TRUNC(SYSDATE) > B.PLAN_END_DATE THEN
                                1
                               ELSE
                                0
                           END),
                       0) AS BCOUNT,
                   NVL(SUM(CASE
                               WHEN B.ACTUAL_END_DATE IS NULL THEN
                                1
                               ELSE
                                0
                           END),
                       0) AS CCOUNT,
                   NVL(SUM(CASE
                               WHEN B.ACTUAL_END_DATE IS NOT NULL THEN
                                1
                               ELSE
                                0
                           END),
                       0) AS DCOUNT,
                   COUNT(*) AS ECOUNT
            FROM  POM_PROJ_PLAN_NODE B
            LEFT JOIN  POM_PROJ_PLAN A ON  A.ID = B.PROJ_PLAN_ID
            LEFT JOIN (
						
		SELECT  listagg(CHARGE_PERSON,',') within GROUP(order by CHARGE_PERSON ) CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID
							
						
						)  person ON B.ID=person.NODE_ID
            LEFT JOIN  SYS_PROJECT_STAGE sps on A.proj_id=sps.id
            LEFT JOIN  (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
            on (case when sps.id is not null then sps.PROJECT_ID else A.proj_id end)=tal.orgId
            WHERE
                   tal.orgId is not null and
                   A.APPROVAL_STATUS = '已审核' AND
                   A.PLAN_TYPE = '关键节点计划' AND
                   NVL(B.IS_DISABLE, 0) <> 1
                  AND (b.node_name like '%'||searchcondition||'%' OR a.plan_name like '%'||searchcondition||'%'
                   OR a.PROJ_NAME like '%'||searchcondition||'%' OR b.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%');
                  --AND (A.PROJ_ID = '' || CONDITION || '' OR A.PROJ_ID IN (SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID = '' || CONDITION || ''))
        END IF;
END P_POM_SMART_KEY_NODE_PLAN_TBS;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_KEYNODEPLAN_TBS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_SMART_KEYNODEPLAN_TBS" ( orgtype IN VARCHAR2, --查询类型，用于判断过滤 0,公司|1,部门|2,项目|3,,本人
    condition IN VARCHAR2, --输入变量：公司id | 部门id | 项目id | 当前用户ID
  item OUT SYS_REFCURSOR ) IS
  --任务中心tabs任务条数统计数据源
  --作者：yedr
  --日期：2019/12/25
BEGIN

OPEN item FOR

            POM_PROJ_PLAN_NODE node
            LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
          WHERE
            plan.PLAN_TYPE = '关键节点计划'
            AND plan.APPROVAL_STATUS = '已审核'
            AND plan.PROJ_ID ='e381dc98-c7db-4a4a-872c-02faa4c0759e'
        ) AS ACOUNT,
--超期未完成任务
        1 AS BCOUNT,
--所有未完成任务

          2
         AS CCOUNT,
--所有已完成任务

          3
         AS DCOUNT,
--所有任务

          4
         AS ECOUNT,
--次月任务

          5
        AS FCOUNT,
--本季度任务

          6
        AS GCOUNT,
--本年任务

          7
         AS HCOUNT
      FROM
        dual;

END P_POM_SMART_KEYNODEPLAN_TBS;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_MY_CURRENT_COMPANY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_SMART_MY_CURRENT_COMPANY" (
    companyid     IN            VARCHAR2,--输入变量：公司id
    currentcompanyid     IN     VARCHAR2,--当前用户的公司
    userid        IN            VARCHAR2,--用户id用于过滤关注的任务
    currentstationid     IN            VARCHAR2,---当前用户的岗位
    currentdeptid        IN            VARCHAR2,---当前用户的部门
    bizcode       IN            VARCHAR2,---权限code
    pageindex     IN            INT,
    pagesizes     IN            INT,
    currenttype   IN            VARCHAR2,--完成节点类型(本月任务,超期未完成任务,所有未完成任务,所有已完成任务,所有任务,次月任务,本季度任务,本年任务)
    searchcondition IN          VARCHAR2,--模糊查询条件
    items         OUT           SYS_REFCURSOR,
    total         OUT           INT
--  spiditems         OUT           SYS_REFCURSOR
) IS
    --本部门负责的任务
--作者：陈丽
--日期：2019/11/15

    v_sql_start          CLOB;
    v_sql_end            CLOB;
    v_sql_content       CLOB;
    v_sql               CLOB;
    v_sql_exec          CLOB;
    v_sql_exec_paging   CLOB;
    v_where              CLOB;
    v_spid              VARCHAR2(200);--数据权限验证spid
    testmsg             CLOB;
    v_where_like       CLOB;
    company_ids        CLOB;
    spcil_sql           CLOB;
    plan_expression     varchar2(4000);
BEGIN
    ----------------------------------------------------统一解析
    testmsg := 'companyid:'
        || companyid
        || '；pageindex:'
        || pageindex
        || '；pagesizes:'
        || pagesizes
        || '；currenttype:'
        || currenttype;

    --通过id获取三级子公司
    company_ids := 'select sbu.id
        from SYS_BUSINESS_UNIT sbu
        start with sbu.id = ''' || companyid || '''
        connect by prior sbu.id = sbu.PARENT_ID';

    BEGIN
        total := 1000;
        v_sql_start := ' case ';
        v_sql_content := '';
        v_sql_end := '  else '''' end  ';
--调用数据权限验证存储过程
        P_AUTH_BLOCK_PROJ_COMPANY(
                USERID => userid,
                STATIONID => currentstationid,
                DEPTID => currentdeptid,
                COMPANYID => currentcompanyid,
                BIZCODE => bizcode,
                DATA_SPID_ID => v_spid
            );

        -- open  spiditems   for select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = v_spid;
--1.拼接查询语句
        FOR item IN (
            SELECT
                s.expression,
                vv.node_level,
                vv.plan_type
            FROM
                pom_rule_set s
                    LEFT JOIN (
                    SELECT
                        MAX(s.created_time) AS t,
                        node_level,
                        plan_type
                    FROM
                        pom_rule_set             s
                            LEFT JOIN pom_rule_set_plan_type   pt ON s.id = pt.rule_id
                    WHERE
                            rule_type = '亮灯规则'
                      --AND plan_type = '关键节点计划'
                      AND s.is_disable = 0
                    GROUP BY
                        node_level,
                        plan_type
                ) vv ON s.created_time = vv.t
                    AND s.node_level = vv.node_level
            WHERE vv.t IS NOT NULL ) LOOP

                IF item.plan_type = '专项计划' THEN
                    plan_expression := ''' then (''' || item.expression || ''') ';
                ELSE
                    plan_expression := ''' then (' || item.expression || ') ';
                END IF ;

                ---拼接字符串
                v_sql_content := v_sql_content || '  when plan_type='''
                    || CASE item.plan_type WHEN '项目全景计划' THEN '项目主项计划'
                                           ELSE item.plan_type END
                    || ''' and node_level='''
                    || item.node_level
                    || plan_expression;
            END LOOP;

        --dbms_output.put_line('123333');
        --dbms_output.put_line(v_sql_content);
        --规则内容大于0才拼规则语句

        IF length(v_sql_content) > 0 THEN
            v_sql := v_sql_start || v_sql_content || v_sql_end;
        ELSE
            --无规则亮灯显示空
            v_sql := '''''';
        END IF;
-------------------------------------------------------------------------------------------内容
        IF currenttype = '本月任务' THEN
            v_where := ' and n.ACTUAL_END_DATE is null and (n.PLAN_END_DATE>=trunc(sysdate, ''month'') and n.PLAN_END_DATE<=trunc(last_day(sysdate))) ';
        ELSIF currenttype = '超期未完成任务' THEN
            v_where := ' and sysdate>n.PLAN_END_DATE and n.ACTUAL_END_DATE is null ';
        ELSIF currenttype = '所有未完成任务' THEN
            v_where := ' and n.ACTUAL_END_DATE is null ';
        ELSIF currenttype = '所有已完成任务' THEN
            v_where := ' and n.ACTUAL_END_DATE is not null ';
        ELSIF currenttype = '所有任务' THEN
            v_where := ' ';
        ELSIF currenttype = '次月任务' THEN
            v_where := ' and (n.PLAN_END_DATE>=last_day(trunc(sysdate))+1 and n.PLAN_END_DATE<=last_day(last_day(trunc(sysdate))+1))';
        ELSIF currenttype = '本季度任务' THEN
            v_where := ' and (n.PLAN_END_DATE>=trunc(sysdate, ''Q'') and n.PLAN_END_DATE<=add_months(trunc(sysdate, ''Q''), 3) - 1) ';
        ELSIF currenttype = '本年任务' THEN
            v_where := ' and (n.PLAN_END_DATE>=trunc(sysdate, ''yyyy'') and n.PLAN_END_DATE<=add_months(trunc(sysdate, ''yyyy''), 12) - 1)  ';
        ELSE
            v_where := ' and 1=2';
        END IF;
        --当输入条件部位空时
        IF searchcondition is not null THEN
            v_where_like := 'WHERE (instr(n.NODE_NAME,'''||searchcondition||''')>0 OR instr(n.PLAN_NAME,'''||searchcondition||''')>0
              OR instr(n.PROJ_NAME,'''||searchcondition||''')>0 OR instr(n.DUTY_DEPARTMENT,'''||searchcondition||''')>0
              OR instr(charge_person,'''||searchcondition||''')>0 )';
        ELSE
            v_where_like := '';
        END IF;
        spcil_sql := ' UNION ALL
            SELECT
                n.ID   AS id,
                 p.id as ORIGINAL_PLAN_ID,
                n.ID   AS ORIGINAL_NODE_ID,
                n.PLAN_ID,
                2 AS PLAN_TYPE_INT,

                CASE WHEN f.id IS NULL THEN
            n.NODE_NAME
         WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE <> ''CARRY_OUT'' THEN
            n.NODE_NAME||''【预计完成日期:''||to_char(f.ESTIMATE_END_TIME,''yyyy-MM-dd'')||''】''
        WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''未审核'' THEN
            n.NODE_NAME||''【完成反馈未发起】''
        WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''审核中'' THEN
            n.NODE_NAME||''【完成反馈审核中】''
        WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''已审核'' THEN
            n.NODE_NAME||''【实际完成日期:''||to_char(f.ACTUAL_END_TIME,''yyyy-MM-dd'')||''】''
     END AS NODE_NAME,
                p.PLAN_NAME,--计划名称
                n.PLAN_START_DATE,
                n.PLAN_END_DATE,

                n.ACTUAL_END_DATE,
                n.PREDICT_END_DATE,
                ''所属项目'' AS E,
                ''专项计划'' AS F,
                n.DUTY_DEPARTMENT,
                    cp.CHARGE_PERSON,
                ''专项计划级'' AS M,
                0 AS N
            FROM
                POM_SPECIAL_PLAN_NODE n
                    LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID
                    left join (SELECT node_id,LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
                    FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID
                    LEFT JOIN (SELECT B.*FROM (SELECT A.*,
                    ROW_NUMBER() OVER(partition by a.feedback_node_id order by A.CREATED desc nulls last) rn
                    FROM POM_NODE_FEEDBACK A) B
                    WHERE RN = 1) f on f.feedback_node_id=n.id
                    inner JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal
                    on n.COMPANY_ID in tal.orgid
                    WHERE p.APPROVAL_STATUS=''已审核''  AND (n.IS_DELETE=0 or n.is_DELETE is null)' ||
                     ' and (p.COMPANY_ID in ('|| company_ids || ') or '''|| companyid ||''' is null)'
            || '
               UNION ALL
               SELECT    n.id,
               p.ORIGINAL_PLAN_ID,
               n.original_node_id,
               dept_monthly_plan_id,
               3 as  PLAN_TYPE_INT,
               node_name,
               p.PLAN_NAME,
               PLAN_START_DATE,
               PLAN_END_DATE,
               ACTUAL_END_DATE,
               ESTIMATE_END_DATE,           --预计完成时间
               ''无'' as PROJ_NAME,          --所属项目
               ''部门月度计划'' as  PLAN_TYPE,        --计划类型显示名
               p.DEPT_NAME,          --主责部门
                   cp.CHARGE_PERSON,
               node_Type,           --任务等级
               stand_SCORE          --标准分值
           FROM
               pom_dept_monthly_plan_node n
               left join pom_dept_monthly_plan p on n.dept_monthly_plan_id=p.id
               left join (SELECT node_id,LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
               FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID
               inner JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal
               on p.COMPANY_ID in tal.orgid
               WHERE (IS_DEL=0 OR IS_DEL is null) and APPROVE_STATUS=''已审核'' and (p.COMPANY_ID in ( '
            || company_ids || ' ) or ''' || companyid ||''' is null)' || v_where;
--3.拼接完整语句
        IF companyid <> '333' THEN
            v_sql_exec := ' select  rownum as rowno,ID,
    ORIGINAL_NODE_ID,
    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
		CHARGE_PERSON,
    NODE_LEVEL,
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,w_Url,'
                || v_sql
                || ' as NODE_WARNING from (select n.*,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE is null then ''催办''
else null end as HASTEN
,case when w.IS_UN_WATCH=0 then ''/pom/biz-watch/bizwatch-unfollow?cancelType=0=400=70=''||ORIGINAL_NODE_ID else ''/pom/biz-watch/bizwatch-setting?cancelType=0=724=300=''||ORIGINAL_NODE_ID end as W_Url
                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    n.ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    CASE WHEN f.id IS NULL THEN
            n.NODE_NAME
         WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE <> ''CARRY_OUT'' THEN
            n.NODE_NAME||''【预计完成日期:''||to_char(f.ESTIMATE_END_TIME,''yyyy-MM-dd'')||''】''
        WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''未审核'' THEN
            n.NODE_NAME||''【完成反馈未发起】''
        WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''审核中'' THEN
            n.NODE_NAME||''【完成反馈审核中】''
        WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''已审核'' THEN
            n.NODE_NAME||''【实际完成日期:''||to_char(f.ACTUAL_END_TIME,''yyyy-MM-dd'')||''】''
     END AS NODE_NAME,
    p.PLAN_NAME,--计划名称
    n.PLAN_START_DATE,
    n.PLAN_END_DATE,

    n.ACTUAL_END_DATE,
    n.ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    n.DUTY_DEPARTMENT,          --主责部门
		cp.CHARGE_PERSON,
    n.NODE_LEVEL,           --任务等级
    n.STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n
		LEFT JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
		left join (SELECT node_id,LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
        FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID
        left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id
        LEFT JOIN (SELECT B.*FROM (SELECT A.*,
        ROW_NUMBER() OVER(partition by a.feedback_node_id order by A.CREATED desc nulls last) rn
        FROM POM_NODE_FEEDBACK A) B
        WHERE RN = 1) f on f.feedback_node_id=n.id
        inner JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal
        on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
        WHERE (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and p.APPROVAL_STATUS=''已审核''
		AND	n.IS_DISABLE=0
    and (n.COMPANY_ID in ( '|| company_ids || ' ) or '''|| companyid||''' is null) '
                || v_where || spcil_sql || ')n
        left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID '||v_where_like||' ORDER BY n.PLAN_END_DATE) a ';
        ELSE
            v_sql_exec := ' select  rownum as rowno,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
		CHARGE_PERSON,
    NODE_LEVEL,
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,w_Url,'
                || v_sql
                || ' as NODE_WARNING from (select n.*,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE is null then ''催办''
else null end as HASTEN
,case when w.IS_UN_WATCH=0 then ''/pom/biz-watch/bizwatch-unfollow?cancelType=0=400=70=''||ORIGINAL_NODE_ID else ''/pom/biz-watch/bizwatch-setting?cancelType=0=724=300=''||ORIGINAL_NODE_ID end as W_Url
                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    n.ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    CASE WHEN f.id IS NULL THEN
            n.NODE_NAME
         WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE <> ''CARRY_OUT'' THEN
            n.NODE_NAME||''【预计完成日期:''||to_char(f.ESTIMATE_END_TIME,''yyyy-MM-dd'')||''】''
        WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''未审核'' THEN
            n.NODE_NAME||''【完成反馈未发起】''
        WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''审核中'' THEN
            n.NODE_NAME||''【完成反馈审核中】''
        WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''已审核'' THEN
            n.NODE_NAME||''【实际完成日期:''||to_char(f.ACTUAL_END_TIME,''yyyy-MM-dd'')||''】''
     END AS NODE_NAME,
    p.PLAN_NAME,--计划名称
    n.PLAN_START_DATE,
    n.PLAN_END_DATE,

    n.ACTUAL_END_DATE,
    n.ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    n.DUTY_DEPARTMENT,          --主责部门
		cp.CHARGE_PERSON,
    n.NODE_LEVEL,           --任务等级
    n.STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n
		LEFT JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
		left join (SELECT node_id,LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
        FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID
        left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id
        LEFT JOIN (SELECT B.*FROM (SELECT A.*,
        ROW_NUMBER() OVER(partition by a.feedback_node_id order by A.CREATED desc nulls last) rn
        FROM POM_NODE_FEEDBACK A) B
        WHERE RN = 1) f on f.feedback_node_id=n.id
        inner JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal
        on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
        WHERE (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and p.APPROVAL_STATUS=''已审核''
		AND	n.IS_DISABLE=0
         '|| v_where || spcil_sql ||')n left join (SELECT * FROM SYS_BIZ_WATCH w WHERE WATCHER_ID='''||userid||''')' ||
                          ' w on n.ORIGINAL_NODE_ID=w.BIZ_ID '||v_where_like||' ORDER BY n.PLAN_END_DATE) a  ';
        END IF;
-------------------------------------------------------------------------------------------内容

        v_sql_exec_paging := ' select a.* from ( ' || v_sql_exec
            || ' where rownum <= ' || pageindex * pagesizes || ' ) a '
            || 'where a.rowno > ' || pagesizes * ( pageindex - 1 ) || '';


        dbms_output.put_line(v_sql_exec_paging);
----获取总条数
        EXECUTE IMMEDIATE 'SELECT count(rowno) from(' || v_sql_exec || ') a ' INTO total;
        OPEN items FOR v_sql_exec_paging;

    EXCEPTION
        WHEN OTHERS THEN
            testmsg:=sqlerrm||testmsg;
            OPEN items FOR SELECT '失败咯' || testmsg plan_name FROM dual;
    END;

END p_pom_smart_my_current_company;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_MY_CURRENT_DEPT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_SMART_MY_CURRENT_DEPT" (
    userid        IN            VARCHAR,--用户id，用于过滤关注的任务
    deptid        IN            VARCHAR2,--输入变量：部门
    currentcompanyid     IN            VARCHAR2,--当前用户公司
    currentdeptid        IN            VARCHAR2,--当前用户部门
    currentstationid     IN            VARCHAR2,---当前用户的岗位
    bizcode       IN            VARCHAR2,---权限code
    pageindex     IN            INT,
    pagesizes     IN            INT,
    currenttype   IN            VARCHAR2,--完成节点类型(本月任务,超期未完成任务,所有未完成任务,所有已完成任务,所有任务,次月任务,本季度任务,本年任务)
    searchcondition IN          VARCHAR2,
    items         OUT           SYS_REFCURSOR,
    total         OUT           INT
--    auth          OUT           SYS_REFCURSOR
) IS
    --本部门负责的任务
--作者：陈丽
--日期：2019/11/15

    v_sql_start          CLOB;
    v_sql_end            CLOB;
    v_sql_content        CLOB;
    v_sql               CLOB;
    v_sql_exec          CLOB;
    v_sql_exec_paging   CLOB;
    v_spid              CLOB;
    deptidwhere         CLOB;
    testmsg         CLOB;
    v_where              CLOB;
    v_nextLine           CLOB;
    plan_expression     varchar2(4000);
--    test_sql        CLOB;
BEGIN
    --统一解析
    deptidwhere := deptid;
    BEGIN
        total := 1000;
        v_sql_start := ' case ';
        v_sql_content := '';
        v_sql_end := '  else '''' end ';

        --调用数据权限验证存储过程
        P_SYS_AUTH_DATA_RULE_SPID(
                USERID => userid,
                STATIONID => currentstationid,
                DEPTID => currentdeptid,
                COMPANYID => currentcompanyid,
                BIZCODE => bizcode,
                DATA_AUTH_SPID => v_spid
            );
        --1.拼接查询语句
        FOR item IN (
            SELECT s.expression, vv.node_level, vv.plan_type
            FROM pom_rule_set s
                     LEFT JOIN (
                SELECT MAX(s.created_time) AS t, node_level, plan_type
                FROM pom_rule_set s LEFT JOIN pom_rule_set_plan_type   pt ON s.id = pt.rule_id
                WHERE rule_type = '亮灯规则' AND s.is_disable = 0
                  -- AND plan_type != '关键节点计划'
                GROUP BY node_level, plan_type
            ) vv ON s.created_time = vv.t AND s.node_level = vv.node_level
            WHERE vv.t IS NOT NULL
            ) LOOP
                IF item.plan_type = '专项计划' THEN
                    plan_expression := ''' then (''' || item.expression || ''') ';
                ELSE
                    plan_expression := ''' then (' || item.expression || ') ';
                END IF ;

                --拼接字符串
                v_sql_content := v_sql_content
                    || '  when plan_type=''' ||
                                 CASE item.plan_type WHEN '项目全景计划' THEN '项目主项计划' ELSE item.plan_type END
                    || ''' and node_level=''' || item.node_level || plan_expression;
            END LOOP;

        --规则内容大于0才拼规则语句
        IF length(v_sql_content) > 0 THEN
            v_sql := v_sql_start || v_sql_content || v_sql_end;
        ELSE
            --无规则亮灯显示空
            v_sql := '''''';
        END IF;

        IF currenttype = '本月任务' THEN
            v_where := ' and n.ACTUAL_END_DATE is null and (n.PLAN_END_DATE>=trunc(sysdate, ''month'') and n.PLAN_END_DATE<=trunc(last_day(sysdate))) ';
        ELSIF currenttype = '超期未完成任务' THEN
            v_where := ' and sysdate>n.PLAN_END_DATE and n.ACTUAL_END_DATE is null';
        ELSIF currenttype = '所有未完成任务' THEN
            v_where := ' and n.ACTUAL_END_DATE is null ';
        ELSIF currenttype = '所有已完成任务' THEN
            v_where := ' and n.ACTUAL_END_DATE is not null ';
        ELSIF currenttype = '所有任务' THEN
            v_where := ' ';
        ELSIF currenttype = '次月任务' THEN
            v_where := ' and (n.PLAN_END_DATE>=last_day(trunc(sysdate))+1 and n.PLAN_END_DATE<=last_day(last_day(trunc(sysdate))+1))';
        ELSIF currenttype = '本季度任务' THEN
            v_where := ' and (n.PLAN_END_DATE>=trunc(sysdate, ''Q'') and n.PLAN_END_DATE<=add_months(trunc(sysdate, ''Q''), 3) - 1) ';
        ELSIF currenttype = '本年任务' THEN
            v_where := ' and (n.PLAN_END_DATE>=trunc(sysdate, ''yyyy'') and n.PLAN_END_DATE<=add_months(trunc(sysdate, ''yyyy''), 12) - 1)  ';
        ELSE
            v_where := ' and 1=2';
        END IF;

        v_sql_exec := '
        select
            rownum as rowno,ID,
            ORIGINAL_NODE_ID,
            ORIGINAL_PLAN_ID,
            PROJ_PLAN_ID as PLAN_ID,
            PLAN_TYPE_INT,
            NODE_NAME,
            PLAN_NAME,
            TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
            TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
            TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
            TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
            case when ACTUAL_END_DATE is null then ''未完成''
            else ''已完成'' end as COMPLETION_STATUS,
            PROJ_NAME,
            PLAN_TYPE,
            DUTY_DEPARTMENT,
            NODE_LEVEL,
            STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,charge_person,'
            || v_sql
            || ' as NODE_WARNING from (select n.*,charge_person,w.IS_UN_WATCH
            ,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
            ,case when n.ACTUAL_END_DATE is null then ''催办''
            else null end as HASTEN
            from(
                SELECT
                    n.ID,
                    p.ORIGINAL_PLAN_ID,
                    n.ORIGINAL_NODE_ID,
                    n.PROJ_PLAN_ID,
                    CASE p.PLAN_TYPE
                        WHEN ''关键节点计划'' THEN 0
                        WHEN ''项目主项计划'' THEN 1
                    END AS PLAN_TYPE_INT,
                    CASE WHEN f.id IS NULL THEN n.NODE_NAME
                         WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE <> ''CARRY_OUT'' THEN
                            n.NODE_NAME||''【预计完成日期:''||to_char(f.ESTIMATE_END_TIME,''yyyy-MM-dd'')||''】''
                        WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''未审核'' THEN
                            n.NODE_NAME||''【完成反馈未发起】''
                        WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''审核中'' THEN
                            n.NODE_NAME||''【完成反馈审核中】''
                        WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''已审核'' THEN
                            n.NODE_NAME||''【实际完成日期:''||to_char(f.ACTUAL_END_TIME,''yyyy-MM-dd'')||''】''
                    END AS NODE_NAME,
                    p.PLAN_NAME,--计划名称
                    n.PLAN_START_DATE,
                    n.PLAN_END_DATE,
                    n.ACTUAL_END_DATE,
                    n.ESTIMATE_END_DATE,           --预计完成时间
                    p.PROJ_NAME,          --所属项目
                    p.PLAN_TYPE,        --计划类型显示名
                    n.DUTY_DEPARTMENT,          --主责部门
                    n.NODE_LEVEL,           --任务等级
                    n.STANDARD_SCORE          --标准分值
                FROM V_POM_PROJ_PLAN_NODE n
                LEFT JOIN V_POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
                left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id
                LEFT JOIN (
                    SELECT B.*FROM (
                        SELECT A.*, ROW_NUMBER() OVER(partition by a.feedback_node_id order by A.CREATED desc nulls last) rn
                        FROM POM_NODE_FEEDBACK A
                    ) B WHERE RN = 1
                ) f on f.feedback_node_id=n.id
                inner join (
                    select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||'''
--                 ) tal on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
                ) tal on instr(sps.PROJECT_ID||p.proj_id||DUTY_DEPARTMENT_ID,tal.orgId) > 0
                WHERE  (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'' or p.PLAN_TYPE=''专项计划'')
                and p.APPROVAL_STATUS=''已审核''  AND n.IS_DISABLE=0 AND n.IS_DELETE=0
                and ('''||deptidwhere||''' is null or DUTY_DEPARTMENT_ID='''|| deptidwhere|| ''')'|| v_where ||'
            ) n left join (
                SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||'''
            ) w on n.ORIGINAL_NODE_ID=w.BIZ_ID
            left join (
                SELECT node_id,
                LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
                FROM POM_NODE_CHARGE_PERSON group by node_id
            ) cp on n.id=cp.NODE_ID
            WHERE (n.NODE_NAME LIKE ''%'||searchcondition||'%'' OR  n.PLAN_NAME LIKE ''%'||searchcondition||'%''
            OR n.PROJ_NAME LIKE ''%'||searchcondition||'%'' OR n. DUTY_DEPARTMENT LIKE ''%'||searchcondition||'%''
            OR cp.charge_person like ''%'||searchcondition||'%'' )
            ORDER BY n.PLAN_END_DATE
        ) a ';

        v_sql_exec_paging := '
        select a.*
        from ( '
            || v_sql_exec
            || ' where rownum <= '
            || pageindex * pagesizes
            || '
        ) a where a.rowno > '|| pagesizes * ( pageindex - 1 )|| '';
        --获取总条数
        EXECUTE IMMEDIATE 'SELECT count(rowno) from('|| v_sql_exec || ') a ' INTO total;
        OPEN items FOR v_sql_exec_paging;
    EXCEPTION WHEN OTHERS THEN
        testmsg := sqlerrm;
        OPEN items FOR
            SELECT '失败咯' || testmsg plan_name FROM dual;
    END;
END p_pom_smart_my_current_dept;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_MY_CURRENT_PERSON
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_SMART_MY_CURRENT_PERSON" (
    userid        IN            VARCHAR2,--输入变量：用户ID
    pageindex     IN            INT,
    pagesizes     IN            INT,
    currenttype   IN            VARCHAR2,--完成节点类型（所有未完成，超期未完成，所有已完成）
    searchcondition IN          VARCHAR2,
    items         OUT           SYS_REFCURSOR,
    total         OUT           INT
) IS
    --我负责的任务  关键节点计划、项目主项计划、专项计划
--作者：陈丽
--日期：2019/11/15
    v_sql_start          CLOB;
    v_sql_end           CLOB;
    v_sql_content        CLOB;
    v_sql               CLOB;
    v_sql_exec          CLOB;
    v_sql_exec_paging   CLOB;
    v_where              CLOB;
    testmsg             CLOB;
    v_where_like       CLOB;
    spcil_sql           CLOB;
    plan_expression     varchar2(4000);
BEGIN
    total := 1000;
    v_sql_start := ' case ';
    v_sql_content := '';
    v_sql_end := '  else '''' end  ';
    BEGIN
        --1.拼接查询语句
        FOR item IN (
            SELECT
                s.expression,
                vv.node_level,
                vv.plan_type
            FROM
                pom_rule_set s
                    LEFT JOIN (
                    SELECT
                        MAX(s.created_time) AS t,
                        node_level,
                        plan_type
                    FROM
                        pom_rule_set             s
                            LEFT JOIN pom_rule_set_plan_type   pt ON s.id = pt.rule_id
                    WHERE
                            rule_type = '亮灯规则'
                      --AND plan_type != '关键节点计划'
                      AND s.is_disable = 0
                    GROUP BY
                        node_level,
                        plan_type
                ) vv ON s.created_time = vv.t
                    AND s.node_level = vv.node_level
            WHERE
                    vv.t IS NOT NULL
            ) LOOP
                IF item.plan_type = '专项计划' THEN
                    plan_expression := ''' then ('''
                        || item.expression
                        || ''') ';
                ELSE
                    plan_expression := ''' then ('
                        || item.expression
                        || ') ';
                END IF ;
                ---拼接字符串
                v_sql_content := v_sql_content
                    || '  when plan_type='''
                    || CASE item.plan_type
                           WHEN '项目全景计划' THEN '项目主项计划'
                           ELSE item.plan_type END
                    || ''' and node_level='''
                    || item.node_level
                    || plan_expression;
            END LOOP;
        --规则内容大于0才拼规则语句
        IF length(v_sql_content) > 0 THEN
            v_sql := v_sql_start
                || v_sql_content
                || v_sql_end;
        ELSE
            --无规则亮灯显示空
            v_sql := '''''';
        END IF;
-------------------------------------------------------------------------------------------内容
        IF currenttype = '所有未完成任务' THEN
            v_where := ' and n.ACTUAL_END_DATE is null ';
        ELSIF currenttype = '超期未完成任务' THEN
            v_where := ' and sysdate>PLAN_END_DATE  and n.ACTUAL_END_DATE is null ';
        ELSIF currenttype = '所有已完成任务' THEN
            v_where := ' and n.ACTUAL_END_DATE is not null ';
        ELSE
            v_where := '' ;
        END IF;
        --当输入条件不为空时
        IF searchcondition is not null THEN
            v_where_like := 'WHERE (instr(n.NODE_NAME,'''||searchcondition||''')>0 OR instr(n.PLAN_NAME,'''||searchcondition||''')>0
              OR instr(n.PROJ_NAME,'''||searchcondition||''')>0 OR instr(n.DUTY_DEPARTMENT,'''||searchcondition||''')>0
              OR instr(n.charge_person,'''||searchcondition||''')>0 )';
        ELSE
            v_where_like := '' ;
        END IF;
        spcil_sql := ' UNION ALL
                SELECT
                    n.ID   AS id,
                     p.id as ORIGINAL_PLAN_ID,
                    n.ID   AS ORIGINAL_NODE_ID,
                    n.PLAN_ID,
                    2 AS PLAN_TYPE_INT,
                    CASE WHEN f.id IS NULL THEN
                            n.NODE_NAME
                         WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE <> ''CARRY_OUT'' THEN
                            n.NODE_NAME||''【预计完成日期:''||to_char(f.ESTIMATE_END_TIME,''yyyy-MM-dd'')||''】''
                         WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''未审核'' THEN
                            n.NODE_NAME||''【完成反馈未发起】''
                        WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''审核中'' THEN
                            n.NODE_NAME||''【完成反馈审核中】''
                        WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''已审核'' THEN
                            n.NODE_NAME||''【实际完成日期:''||to_char(f.ACTUAL_END_TIME,''yyyy-MM-dd'')||''】''
                    END AS NODE_NAME,
                    p.PLAN_NAME,--计划名称
                    n.PLAN_START_DATE,
                    n.PLAN_END_DATE,
                    n.ACTUAL_END_DATE,
                    n.PREDICT_END_DATE,
                    ''所属项目'' AS E,
                    ''专项计划'' AS F,
                    n.DUTY_DEPARTMENT,
                        person.CHARGE_PERSON,
                    ''专项计划级'' AS M,
                    0 AS N
                FROM
                    POM_SPECIAL_PLAN_NODE n
                        LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID
                        LEFT JOIN POM_NODE_CHARGE_PERSON person ON n.ID=person.NODE_ID
                        LEFT JOIN (SELECT B.*FROM (SELECT A.*,
                        ROW_NUMBER() OVER(partition by a.feedback_node_id order by A.CREATED desc nulls last) rn
                        FROM POM_NODE_FEEDBACK A) B
                        WHERE RN = 1) f on f.feedback_node_id=n.id
                        where n.IS_DELETE=0 AND p.APPROVAL_STATUS=''已审核''
                        AND CHARGE_PERSON_ID='''||userid||'''  '
            || v_where
            || '';
        --专项计划已启用，但是部门月度计划还未启用、需要启用部门月度计划时，取消下面的sql即可
--                UNION ALL
--                    SELECT    n.id,
--                    p.ORIGINAL_PLAN_ID,
--                    n.original_node_id,
--                    dept_monthly_plan_id,
--                    3 as  PLAN_TYPE_INT,
--
--                    n.node_name,
--                    p.PLAN_NAME,
--                    PLAN_START_DATE,
--                    PLAN_END_DATE,
--
--                    ACTUAL_END_DATE,
--                    ESTIMATE_END_DATE,           --预计完成时间
--                    ''无'' as PROJ_NAME,          --所属项目
--                    ''部门月度计划'' as  PLAN_TYPE,        --计划类型显示名
--                    p.DEPT_NAME,          --主责部门
--                        person.CHARGE_PERSON,
--                    node_Type,           --任务等级
--                    stand_SCORE          --标准分值
--                FROM
--                    pom_dept_monthly_plan_node n
--                    left join pom_dept_monthly_plan p on n.dept_monthly_plan_id=p.id
--                        LEFT JOIN POM_NODE_CHARGE_PERSON person ON n.ID=person.NODE_ID
--                    where n.IS_DEL=0 and APPROVE_STATUS=''已审核''
--                        AND CHARGE_PERSON_ID='''||userid||'''  '
--                                      || v_where;
--3.拼接完整语句
        v_sql_exec := ' select  rownum as rowno,ID,
    ORIGINAL_NODE_ID,
    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
    NODE_LEVEL,
		CHARGE_PERSON,
    STANDARD_SCORE ,WACTH,HASTEN,'
            || v_sql
            || ' as NODE_WARNING from (select n.*,''关注'' as WACTH,''催办'' as HASTEN from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    n.ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,
    CASE WHEN f.id IS NULL THEN
        n.NODE_NAME
    WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE <> ''CARRY_OUT'' THEN
        n.NODE_NAME||''【预计完成日期:''||to_char(f.ESTIMATE_END_TIME,''yyyy-MM-dd'')||''】''
    WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''未审核'' THEN
        n.NODE_NAME||''【完成反馈未发起】''
    WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''审核中'' THEN
        n.NODE_NAME||''【完成反馈审核中】''
    WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''已审核'' THEN
        n.NODE_NAME||''【实际完成日期:''||to_char(f.ACTUAL_END_TIME,''yyyy-MM-dd'')||''】''
    END AS NODE_NAME,
    p.PLAN_NAME,--计划名称
    n.PLAN_START_DATE,
    n.PLAN_END_DATE,

    n.ACTUAL_END_DATE,
    n.ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    n.DUTY_DEPARTMENT,          --主责部门
		person.CHARGE_PERSON,
    n.NODE_LEVEL,           --任务等级
    n.STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n
		LEFT JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
		LEFT JOIN POM_NODE_CHARGE_PERSON person ON n.ID=person.NODE_ID
        LEFT JOIN (SELECT B.*FROM (SELECT A.*,
        ROW_NUMBER() OVER(partition by a.feedback_node_id order by A.CREATED desc nulls last) rn
        FROM POM_NODE_FEEDBACK A) B
        WHERE RN = 1) f on f.feedback_node_id=n.id
		WHERE (p.PLAN_TYPE=''项目主项计划'' OR p.PLAN_TYPE=''关键节点计划'') AND n.IS_DISABLE=0  and p.APPROVAL_STATUS=''已审核''
		AND CHARGE_PERSON_ID='''||userid||'''  '
            || v_where
            || spcil_sql
            || ')n '||v_where_like||'
   ORDER BY n.PLAN_END_DATE  ) a  ';-- left join POM_NODE_CHARGE_PERSON cp on n.id=cp.NODE_ID where CHARGE_PERSON_ID='''||userid||'''
-------------------------------------------------------------------------------------------内容
        -- dbms_output.put_line(v_sql_exec);
        v_sql_exec_paging := '
select a.* from ( '
            || v_sql_exec
            || ' where rownum <= '
            || pageindex * pagesizes
            || ' ) a where a.rowno > '
            || pagesizes * ( pageindex - 1 )
            || '';
----获取总条数
        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
            || v_sql_exec
            || ') a '
            INTO total;
        dbms_output.put_line(v_sql_exec_paging);
-- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN items FOR v_sql_exec_paging;
--SELECT '' A FROM DUAL;
    EXCEPTION
        WHEN OTHERS THEN
            OPEN items FOR SELECT '失败咯' || testmsg plan_name FROM dual;
            dbms_output.put_line(sqlerrm);
    END;
END p_pom_smart_my_current_person;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_MY_CURRENT_PROJ
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_SMART_MY_CURRENT_PROJ" (
    projid        IN            VARCHAR2,--输入变量：项目
    userid        IN 			VARCHAR2,--用户id，用于过滤关注的任务
    currentcompanyid     IN            VARCHAR2,--当前用户公司
    currentdeptid        IN            VARCHAR2,--当前用户部门
    currentstationid     IN            VARCHAR2,---当前用户的岗位
    bizcode       IN            VARCHAR2,---权限code
    pageindex     IN            INT,
    pagesizes     IN            INT,
    currenttype   IN            VARCHAR2,--完成节点类型(本月任务,超期未完成任务,所有未完成任务,所有已完成任务,所有任务,次月任务,本季度任务,本年任务)
    searchcondition IN          VARCHAR2,--模糊查询条件
    items         OUT           SYS_REFCURSOR,
    total         OUT           INT
) IS
    --本部门负责的任务
--作者：陈丽
--日期：2019/11/15
    v_sql_start          CLOB;
    v_sql_end            CLOB;
    v_sql_content        CLOB;
    v_sql               CLOB;
    v_sql_exec          CLOB;
    v_sql_exec_paging   CLOB;
    v_where              CLOB;
    v_spid              CLOB;
    spcil_sql              CLOB;
    testmsg              CLOB;
    v_where_like       CLOB;
    plan_expression     varchar2(4000);
BEGIN
    ----------------------------------------------------统一解析
    testmsg := 'projid:'
        || projid
        || '；pageindex:'
        || pageindex
        || '；pagesizes:'
        || pagesizes
        || '；currenttype:'
        || currenttype;

    BEGIN
        total := 1000;
        v_sql_start := ' case ';
        v_sql_content := '';
        v_sql_end := '  else '''' end  ';
--调用数据权限验证存储过程
        P_AUTH_BLOCK_PROJ_COMPANY(
                USERID => userid,
                STATIONID => currentstationid,
                DEPTID => currentdeptid,
                COMPANYID => currentcompanyid,
                BIZCODE => bizcode,
                DATA_SPID_ID => v_spid
            );
--1.拼接查询语句
        FOR item IN (
            SELECT
                s.expression,
                vv.node_level,
                vv.plan_type
            FROM
                pom_rule_set s
                    LEFT JOIN (
                    SELECT MAX(s.created_time) AS t, node_level, plan_type
                    FROM pom_rule_set             s
                             LEFT JOIN pom_rule_set_plan_type   pt ON s.id = pt.rule_id
                    WHERE rule_type = '亮灯规则'
                      -- AND plan_type != '关键节点计划'
                      AND s.is_disable = 0
                    GROUP BY  node_level,  plan_type
                ) vv ON s.created_time = vv.t
                    AND s.node_level = vv.node_level
            WHERE
                    vv.t IS NOT NULL
            ) LOOP
                IF item.plan_type = '专项计划' THEN
                    plan_expression := ''' then ('''
                        || item.expression
                        || ''') ';
                ELSE
                    plan_expression := ''' then ('
                        || item.expression
                        || ') ';
                END IF ;
                ---拼接字符串
                v_sql_content := v_sql_content
                    || '  when plan_type='''
                    || CASE item.plan_type WHEN '项目全景计划' THEN '项目主项计划' ELSE item.plan_type END
                    || ''' and node_level='''
                    || item.node_level
                    || plan_expression;
            END LOOP;
        --规则内容大于0才拼规则语句
        IF length(v_sql_content) > 0 THEN
            v_sql := v_sql_start || v_sql_content || v_sql_end;
        ELSE
            --无规则亮灯显示空
            v_sql := '''''';
        END IF;
-------------------------------------------------------------------------------------------内容
        IF currenttype = '本月任务' THEN
            v_where := ' and n.ACTUAL_END_DATE is null and (n.PLAN_END_DATE>=trunc(sysdate, ''month'') and n.PLAN_END_DATE<=trunc(last_day(sysdate))) ';
        ELSIF currenttype = '超期未完成任务' THEN
            v_where := ' and sysdate>n.PLAN_END_DATE and n.ACTUAL_END_DATE is null ';
        ELSIF currenttype = '所有未完成任务' THEN
            v_where := ' and n.ACTUAL_END_DATE is null ';
        ELSIF currenttype = '所有已完成任务' THEN
            v_where := ' and n.ACTUAL_END_DATE is not null ';
        ELSIF currenttype = '所有任务' THEN
            v_where := ' ';
        ELSIF currenttype = '次月任务' THEN
            v_where := ' and (n.PLAN_END_DATE>=last_day(trunc(sysdate))+1 and n.PLAN_END_DATE<=last_day(last_day(trunc(sysdate))+1))';
        ELSIF currenttype = '本季度任务' THEN
            v_where := ' and (n.PLAN_END_DATE>=trunc(sysdate, ''Q'') and n.PLAN_END_DATE<=add_months(trunc(sysdate, ''Q''), 3) - 1) ';
        ELSIF currenttype = '本年任务' THEN
            v_where := ' and (n.PLAN_END_DATE>=trunc(sysdate, ''yyyy'') and n.PLAN_END_DATE<=add_months(trunc(sysdate, ''yyyy''), 12) - 1)  ';
        ELSE
            v_where := ' and 1=2';
        END IF;
        --当输入条件部位空时
        IF searchcondition is not null THEN
            v_where_like := 'WHERE (instr(n.NODE_NAME,'''||searchcondition||''')>0 OR instr(n.PLAN_NAME,'''||searchcondition||''')>0
              OR instr(n.PROJ_NAME,'''||searchcondition||''')>0 OR instr(n.DUTY_DEPARTMENT,'''||searchcondition||''')>0
              OR instr(cp.charge_person,'''||searchcondition||''')>0 )';
        ELSE
            v_where_like := '';
        END IF;
        spcil_sql := ' UNION ALL
                SELECT
                    n.ID   AS id,
                     p.id as ORIGINAL_PLAN_ID,
                    n.ID   AS ORIGINAL_NODE_ID,
                    n.PLAN_ID,
                    2 AS PLAN_TYPE_INT,
                    ''backid'' backid,
                    CASE WHEN f.id IS NULL THEN
                            n.NODE_NAME
                         WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE <> ''CARRY_OUT'' THEN
                            n.NODE_NAME||''【预计完成日期:''||to_char(f.ESTIMATE_END_TIME,''yyyy-MM-dd'')||''】''
                         WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''未审核'' THEN
                            n.NODE_NAME||''【完成反馈未发起】''
                        WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''审核中'' THEN
                            n.NODE_NAME||''【完成反馈审核中】''
                        WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''已审核'' THEN
                            n.NODE_NAME||''【实际完成日期:''||to_char(f.ACTUAL_END_TIME,''yyyy-MM-dd'')||''】''
                    END AS NODE_NAME,
                    p.PLAN_NAME,--计划名称
                    n.PLAN_START_DATE,
                    n.PLAN_END_DATE,
                    n.ACTUAL_END_DATE,
                    n.PREDICT_END_DATE,
                    ''所属项目'' AS PROJ_NAME,
                    ''专项计划'' AS PLAN_TYPE,
                    n.DUTY_DEPARTMENT,
                    ''专项计划级'' AS NODE_LEVEL,
                    0 AS STANDARD_SCORE
                FROM
                    POM_SPECIAL_PLAN_NODE n
                        LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID
                        LEFT JOIN POM_NODE_CHARGE_PERSON person ON n.ID=person.NODE_ID
                        LEFT JOIN (SELECT B.*FROM (SELECT A.*,
                        ROW_NUMBER() OVER(partition by a.feedback_node_id order by A.CREATED desc nulls last) rn
                        FROM POM_NODE_FEEDBACK A) B
                        WHERE RN = 1) f on f.feedback_node_id=n.id
                        where n.IS_DELETE=0 AND p.APPROVAL_STATUS=''已审核''
                        AND CHARGE_PERSON_ID='''||userid||'''  '
            || v_where
            || '';
--3.拼接完整语句
        if projid <> '111' then
            v_sql_exec := ' select  rownum as rowno,ID,
    ORIGINAL_NODE_ID,
    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
		CHARGE_PERSON,
    NODE_LEVEL,
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,w_Url,'
                || v_sql
                || ' as NODE_WARNING from (select n.*,charge_person,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE is null then ''催办''
else null end as HASTEN
,case when w.IS_UN_WATCH=0 then ''/api/pom/planfollow/unfollow?cancelType=0&windowWidth=724&windowHeight=300&bizId=''||ORIGINAL_NODE_ID else ''/pom/biz-watch/bizwatch-setting?cancelType=0&windowWidth=724&windowHeight=300&bizId=&bizId=''||ORIGINAL_NODE_ID end as w_Url
                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    n.ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,
        f.id as backId,
CASE WHEN f.id IS NULL THEN
            n.NODE_NAME
         WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE <> ''CARRY_OUT'' THEN
            n.NODE_NAME||''【预计完成日期:''||to_char(f.ESTIMATE_END_TIME,''yyyy-MM-dd'')||''】''
        WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''未审核'' THEN
            n.NODE_NAME||''【完成反馈未发起】''
        WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''审核中'' THEN
            n.NODE_NAME||''【完成反馈审核中】''
        WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''已审核'' THEN
            n.NODE_NAME||''【实际完成日期:''||to_char(f.ACTUAL_END_TIME,''yyyy-MM-dd'')||''】''
     END AS NODE_NAME,
    p.PLAN_NAME,--计划名称
    n.PLAN_START_DATE,
    n.PLAN_END_DATE,
    n.ACTUAL_END_DATE,
    n.ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    n.DUTY_DEPARTMENT,          --主责部门
    n.NODE_LEVEL,           --任务等级
    n.STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n
		LEFT JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
        left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id
         LEFT JOIN (SELECT B.*
  FROM (SELECT A.*,
               ROW_NUMBER() OVER(partition by a.feedback_node_id order by A.CREATED desc nulls last) rn
          FROM POM_NODE_FEEDBACK A) B
 WHERE RN = 1) f on f.feedback_node_id=n.id
        inner JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
        on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
        WHERE (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and p.APPROVAL_STATUS=''已审核''
		AND n.IS_DISABLE=0
		AND (p.PROJ_ID='''||projid||''' OR p.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID='''
                ||projid||'''))  '||v_where|| spcil_sql ||'
)n
    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID
    left join (SELECT node_id,
    LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
    FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID '||v_where_like||' ORDER BY n.PLAN_END_DATE) a ';
        else
            v_sql_exec := ' select  rownum as rowno,ID,
    ORIGINAL_NODE_ID,
    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
		CHARGE_PERSON,
    NODE_LEVEL,
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,w_Url,'
                || v_sql
                || ' as NODE_WARNING from (select n.*,charge_person,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE is null then ''催办''
else null end as HASTEN
,case when w.IS_UN_WATCH=0 then ''/api/pom/planfollow/unfollow?cancelType=0&windowWidth=724&windowHeight=300&bizId=''||ORIGINAL_NODE_ID else ''/pom/biz-watch/bizwatch-setting?cancelType=0&windowWidth=724&windowHeight=300&bizId=&bizId=''||ORIGINAL_NODE_ID end as w_Url
                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    n.ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,
        f.id as backId,
CASE WHEN f.id IS NULL THEN
            n.NODE_NAME
         WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE <> ''CARRY_OUT'' THEN
            n.NODE_NAME||''【预计完成日期:''||to_char(f.ESTIMATE_END_TIME,''yyyy-MM-dd'')||''】''
        WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''未审核'' THEN
            n.NODE_NAME||''【完成反馈未发起】''
        WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''审核中'' THEN
            n.NODE_NAME||''【完成反馈审核中】''
        WHEN f.id IS NOT NULL AND f.FEEDBACK_TYPE = ''CARRY_OUT'' AND f.APPROVAL_STATUS=''已审核'' THEN
            n.NODE_NAME||''【实际完成日期:''||to_char(f.ACTUAL_END_TIME,''yyyy-MM-dd'')||''】''
     END AS NODE_NAME,
    p.PLAN_NAME,--计划名称
    n.PLAN_START_DATE,
    n.PLAN_END_DATE,
    n.ACTUAL_END_DATE,
    n.ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    n.DUTY_DEPARTMENT,          --主责部门
    n.NODE_LEVEL,           --任务等级
    n.STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n
		LEFT JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
		left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id
        LEFT JOIN (SELECT B.*
  FROM (SELECT A.*,
               ROW_NUMBER() OVER(partition by a.feedback_node_id order by A.CREATED desc nulls last) rn
          FROM POM_NODE_FEEDBACK A) B
 WHERE RN = 1) f on f.feedback_node_id=n.id
        inner JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
        on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
        WHERE (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and p.APPROVAL_STATUS=''已审核''
		AND n.IS_DISABLE=0
		  ' ||v_where || spcil_sql ||')n
    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID
    left join (SELECT node_id,
    LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
    FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID '||v_where_like||' ORDER BY n.PLAN_END_DATE) a ';
        end if;
-------------------------------------------------------------------------------------------内容
        v_sql_exec_paging := '
select a.* from ( '
            || v_sql_exec
            || ' where rownum <= '
            || pageindex * pagesizes
            || ' ) a where a.rowno > '
            || pagesizes * ( pageindex - 1 )
            || '';

        dbms_output.put_line(v_sql_exec_paging);
----获取总条数
        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
            || v_sql_exec
            || ') a '
            INTO total;

        OPEN items FOR v_sql_exec_paging;
    EXCEPTION
        WHEN OTHERS THEN
            testmsg:=sqlerrm||testmsg;
            OPEN items FOR SELECT '失败咯' || testmsg plan_name FROM dual;
            dbms_output.put_line(sqlerrm);
    END;
END p_pom_smart_my_current_proj;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_PROJ_PLAN_DEL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_SMART_PROJ_PLAN_DEL" (
    planid    IN        VARCHAR2,--输入变量：规则id
    type      IN        VARCHAR2,--0删除前验证，1执行删除,2调整验证
    errmsg    OUT       VARCHAR2,--提示消息
    errcode   OUT       INT--0成功，1失败
) IS
--规则删除
--作者：鲜晓勇 
--日期：2019/11/27
    countdtl   INT;
    testmsg    NVARCHAR2(200);
    errorCount INT;
     hiddleCount INT;
BEGIN
    BEGIN
                 errorCount := 0;
        testmsg := 'planid:'
                   || planid
                   || '.type:'
                   || type;
        countdtl := 0;
        IF length(planid) < 36 THEN
            raise_application_error(-20000, '请选择要删除的计划');
        END IF;
--循环计划id
-------------------------------------------------------
-------------------------------------------------------
        IF ( type = 1 ) THEN
            FOR item IN (
                SELECT
                    regexp_substr(''
                                  || planid
                                  || '', '[^,]+', 1, ROWNUM) AS id
                FROM
                    dual
                CONNECT BY
                    ROWNUM <= length(''
                                     || planid
                                     || '') - length(regexp_replace(''
                                                                    || planid
                                                                    || '', ',', '')) + 1
            ) LOOP 
    ---删除计划
                DELETE pom_proj_plan 
                WHERE
                    id = ''
                         || item.id
                         || '';

                DELETE pom_proj_plan_node 
                WHERE
                    PROJ_PLAN_ID = ''
                                   || item.id
                                   || '';

                countdtl := countdtl + 1;
            END LOOP;
            errcode := 0;
            errmsg := '删除成功！'
                      || countdtl
                      || '条计划';
        ELSIF ( type = 0 ) THEN
               FOR item IN (
                SELECT
                    regexp_substr(''
                                  || planid
                                  || '', '[^,]+', 1, ROWNUM) AS id
                FROM
                    dual
                CONNECT BY
                    ROWNUM <= length(''
                                     || planid
                                     || '') - length(regexp_replace(''
                                                                    || planid
                                                                    || '', ',', '')) + 1
            ) LOOP          
        SELECT
            COUNT(id)
        INTO hiddleCount
        FROM
            pom_proj_Plan
        WHERE
            id = ''
                        || item.id
                        || '' and (APPROVAL_STATUS='已审核' or APPROVAL_STATUS='审核中');
               errorCount:=errorCount+hiddleCount;
            END LOOP; 
              IF errorCount > 0 THEN
              errcode := 1;
            errmsg := '只允许删除未审核状态的计划！';
            ELSE
            errcode := 0;
            errmsg := '';
            END IF;

        ELSIF ( type = 2 ) THEN
        IF length(planid)>36 THEN
        errcode:=1;
        errmsg:='一次只允许调整一条计划';
        ELSE 
         SELECT COUNT(id) INTO hiddleCount FROM POM_PROJ_PLAN WHERE APPROVAL_STATUS <>'已审核' AND ID=''|| planid;
         IF hiddleCount>0 THEN
          errcode:=1;
          errmsg:='该计划还未审批,请将计划审批完成后再调整！';
          ELSE
          errcode:=0;
          errmsg:='';
          END IF;
        END IF;

    END IF;

    EXCEPTION
        WHEN OTHERS THEN
            errcode := 1;
            errmsg := sqlerrm;
    END;
END p_pom_smart_proj_plan_del;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_PROJECT_PLAN_DEL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_SMART_PROJECT_PLAN_DEL" 
(
		PLANID  IN VARCHAR2
	 , --输入变量：规则id
		TYPE    IN VARCHAR2
	 , --0删除前验证，1执行删除
		ERRMSG  OUT VARCHAR2
	 , --提示消息
		ERRCODE OUT INT --0成功，1失败
) IS
		--规则删除
		--作者：鲜晓勇
		--日期：2019/11/27
		COUNTDTL    INT;
		TESTMSG     NVARCHAR2(200);
		ERRORCOUNT  INT;
		HIDDLECOUNT INT;
BEGIN
		BEGIN
				ERRORCOUNT := 0;
				TESTMSG    := 'planid:' || PLANID || '.type:' || TYPE;
				COUNTDTL   := 0;
				IF LENGTH(PLANID) < 36 THEN
						RAISE_APPLICATION_ERROR(-20000, '请选择要删除的计划' || TESTMSG);
				END IF;
				--循环规则id
				-------------------------------------------------------
				-------------------------------------------------------
				IF (TYPE = 1) THEN
						FOR ITEM IN (SELECT REGEXP_SUBSTR('' || PLANID || '', '[^,]+', 1,
																							 ROWNUM) AS ID
												 FROM   DUAL
												 CONNECT BY ROWNUM <=
																		LENGTH('' || PLANID || '') -
																		LENGTH(REGEXP_REPLACE('' || PLANID || '',
																													',', '')) + 1)
						LOOP
								---删除计划
								DELETE POM_PROJ_PLAN WHERE ID = '' || ITEM.ID || '';
						
								COUNTDTL := COUNTDTL + 1;
						END LOOP;
						ERRCODE := 0;
						ERRMSG  := '删除成功！' || COUNTDTL || '条计划';
				ELSIF (TYPE = 0) THEN
						FOR ITEM IN (SELECT REGEXP_SUBSTR('' || PLANID || '', '[^,]+', 1,
																							 ROWNUM) AS ID
												 FROM   DUAL
												 CONNECT BY ROWNUM <=
																		LENGTH('' || PLANID || '') -
																		LENGTH(REGEXP_REPLACE('' || PLANID || '',
																													',', '')) + 1)
						LOOP
								SELECT COUNT(ID)
								INTO   HIDDLECOUNT
								FROM   POM_PROJ_PLAN
								WHERE  ID = '' || ITEM.ID || '' AND
											 APPROVAL_STATUS = '已审核';
								ERRORCOUNT := ERRORCOUNT + HIDDLECOUNT;
						END LOOP;
						IF ERRORCOUNT > 0 THEN
								ERRCODE := 1;
								ERRMSG  := '存在已审核的计划！';
						ELSE
								ERRCODE := 0;
								ERRMSG  := '验证通过！';
						END IF;
				END IF;
		
		EXCEPTION
				WHEN OTHERS THEN
						ERRCODE := 1;
						ERRMSG  := SQLERRM;
		END;
END P_POM_SMART_PROJECT_PLAN_DEL;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_RULE_SET_DEL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_SMART_RULE_SET_DEL" 
(
		RULEID  IN VARCHAR2
	 , --输入变量：规则id
		TYPE    IN VARCHAR2
	 , --0删除前验证，1执行删除
		ERRMSG  OUT VARCHAR2
	 , --提示消息
		ERRCODE OUT INT --0成功，1失败
) IS
		--规则删除
		--作者：陈丽
		--日期：2019/11/17
		COUNTDTL INT;
		TESTMSG  NVARCHAR2(4000);
BEGIN
		BEGIN
				TESTMSG  := 'ruleid:' || RULEID || '.type:' || TYPE;
				COUNTDTL := 0;
				IF LENGTH(RULEID) < 36 THEN
						RAISE_APPLICATION_ERROR(-20000, '请选择要删除的规则' || TESTMSG);
				END IF;
				--循环规则id
		
				IF (TYPE = 1) THEN
						FOR ITEM IN (SELECT REGEXP_SUBSTR('' || RULEID || '', '[^,]+', 1,
																							 ROWNUM) AS ID
												 FROM   DUAL
												 CONNECT BY ROWNUM <=
																		LENGTH('' || RULEID || '') -
																		LENGTH(REGEXP_REPLACE('' || RULEID || '',
																													',', '')) + 1)
						LOOP
								---删除规则
								DELETE POM_RULE_SET WHERE ID = '' || ITEM.ID || '';
						
								COUNTDTL := COUNTDTL + 1;
						END LOOP;
				
						ERRCODE := 0;
						ERRMSG  := '删除成功！' || COUNTDTL || '条规则';
				ELSIF (TYPE = 0) THEN
						ERRCODE := 0;
						ERRMSG  := '验证通过！';
				END IF;
		
		EXCEPTION
				WHEN OTHERS THEN
						ERRCODE := 1;
						ERRMSG  := SQLERRM;
		END;
END P_POM_SMART_RULE_SET_DEL;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_RULE_SET_STATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_SMART_RULE_SET_STATE" (
    ruleid      IN          VARCHAR2,--输入变量：规则id
    statetype   IN          INT,--0生效，1失效
    errmsg      OUT         VARCHAR2,--提示消息
    errcode     OUT         INT--0成功，1失败
) IS
--规则生效失效设置
--作者：陈丽
--日期：2019/11/17
    typemsg    VARCHAR2(50);
    ruleids    VARCHAR2(4000);
    countdtl   INT;
     testmsg NVARCHAR2(4000);
		 statuscount NUMBER;
BEGIN
    BEGIN
        testmsg:='ruleid:'||ruleid||'.statetype:'||statetype;
        countdtl := 0;
        IF statetype = 0 THEN
            typemsg := '生效';
        ELSE
            typemsg := '失效';
        END IF;

        IF length(ruleid) < 36 THEN
            raise_application_error(-20000, '请选择要'
                                            || typemsg
                                            || '的规则'||testmsg);
        END IF;



--循环规则id

        FOR item IN (
            SELECT
                regexp_substr(''
                              || ruleid
                              || '', '[^,]+', 1, ROWNUM) AS id
            FROM
                dual
            CONNECT BY
                ROWNUM <= length(''
                                 || ruleid
                                 || '') - length(regexp_replace(''
                                                                || ruleid
                                                                || '', ',', '')) + 1
        ) LOOP 
    ---拼接字符串
		  ruleids := ruleids || item.id;
			SELECT COUNT(is_disable) INTO statuscount  FROM pom_rule_set WHERE ID='' || item.id || '' AND is_disable=statetype ;
			IF(statuscount>0) THEN
				errcode := 1;
				errmsg := '已有'''||typemsg||'''的规则，请选择相同状态的数据进行操作';
				return;
			ELSE 
					UPDATE pom_rule_set 
					SET is_disable = statetype 
					WHERE
						id = '' || item.id || '';
					countdtl := countdtl + 1;
			END IF;


--             UPDATE pom_rule_set
--             SET
--                 is_disable = statetype
--             WHERE
--                 id = ''
--                      || item.id
--                      || '';
-- 
--             countdtl := countdtl + 1;
        END LOOP;

        errcode := 0;
        errmsg := typemsg
                  || '设置成功！'
                  || countdtl
                  || '条规则';
    EXCEPTION
        WHEN OTHERS THEN
            errcode := 1;
            errmsg := sqlerrm;
    END;
END p_pom_smart_rule_set_state;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_SPECIAL_PLAN_DEL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_SMART_SPECIAL_PLAN_DEL" (
    planid    IN        VARCHAR2,--输入变量：规则id
    type      IN        VARCHAR2,--0删除前验证，1执行删除,2 调整验证
    errmsg    OUT       VARCHAR2,--提示消息
    errcode   OUT       INT--0成功，1失败
) IS
--规则删除
--作者：鲜晓勇 
--日期：2019/11/27
    countdtl   INT;
    testmsg    NVARCHAR2(200);
    errorCount INT;
     hiddleCount INT;
BEGIN
    BEGIN
                 errorCount := 0;
        testmsg := 'planid:'
                   || planid
                   || '.type:'
                   || type;
        countdtl := 0;
        IF length(planid) < 36 THEN
            raise_application_error(-20000, '请选择要删除的计划');
        END IF;
--循环计划id
-------------------------------------------------------
-------------------------------------------------------
        IF ( type = 1 ) THEN
            FOR item IN (
                SELECT
                    regexp_substr(''
                                  || planid
                                  || '', '[^,]+', 1, ROWNUM) AS id
                FROM
                    dual
                CONNECT BY
                    ROWNUM <= length(''
                                     || planid
                                     || '') - length(regexp_replace(''
                                                                    || planid
                                                                    || '', ',', '')) + 1
            ) LOOP 
    ---删除计划
                DELETE POM_SPECIAL_PLAN 
                WHERE
                    id = ''
                         || item.id
                         || '';

                DELETE POM_SPECIAL_PLAN_NODE
                WHERE
                    PLAN_ID = ''
                         || item.id
                         || '';

                countdtl := countdtl + 1;
            END LOOP;
            errcode := 0;
            errmsg := '删除成功！'
                      || countdtl
                      || '条计划';
        ELSIF ( type = 0 ) THEN
               FOR item IN (
                SELECT
                    regexp_substr(''
                                  || planid
                                  || '', '[^,]+', 1, ROWNUM) AS id
                FROM
                    dual
                CONNECT BY
                    ROWNUM <= length(''
                                     || planid
                                     || '') - length(regexp_replace(''
                                                                    || planid
                                                                    || '', ',', '')) + 1
            ) LOOP          
        SELECT
            COUNT(id)
        INTO hiddleCount
        FROM
            POM_SPECIAL_PLAN
        WHERE
            id = ''
                        || item.id
                        || '' and (APPROVAL_STATUS='已审核' or APPROVAL_STATUS='审核中');
               errorCount:=errorCount+hiddleCount;
            END LOOP; 
              IF errorCount > 0 THEN
              errcode := 1;
            errmsg := '只允许删除未审核状态的计划！';
            ELSE
            errcode := 0;
            errmsg := '';
            END IF;
        ELSIF ( type = 2 ) THEN
        IF length(planid)>36 THEN
        errcode:=1;
        errmsg:='一次只允许调整一条计划';
        ELSE 
         SELECT COUNT(id) INTO hiddleCount FROM POM_SPECIAL_PLAN WHERE APPROVAL_STATUS<>'已审核' AND ID=''|| planid;
         IF hiddleCount>0 THEN
          errcode:=1;
          errmsg:='该计划还未审批,请将计划审批完成再调整！';
          ELSE
          errcode:=0;
          errmsg:='';
          END IF;
        END IF;
        END IF;

    EXCEPTION
        WHEN OTHERS THEN
            errcode := 1;
            errmsg := sqlerrm;
    END;
END p_pom_smart_special_plan_del;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_SPECIALTEMP_DEL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_SMART_SPECIALTEMP_DEL" ( templateid IN VARCHAR2, --输入变量：专项计划模板ID
		type IN VARCHAR2, 
		errmsg OUT VARCHAR2, --提示消息
		errcode OUT INT --0成功，1失败
	) IS --专项计划模板删除
--作者：叶丁荣
--日期：2019/11/21
	hiddleCount INT;
BEGIN
	BEGIN
		IF
			length( templateid ) < 36 THEN
				raise_application_error ( - 20000, '请选择要删除的模板' );

		END IF;
		IF
			( type = 1 ) THEN
-- 				DELETE POM_SPECIAL_TEMPLATE 
-- 			WHERE
-- 				id = ''||templateid||'';
-- 			errcode := 0;
-- 			errmsg := '删除成功！';
-- 			


				SELECT
				COUNT( ID ) INTO hiddleCount 
			FROM
				POM_SPECIAL_TEMPLATE 
			WHERE
				ID = ''||templateid||'' 
				AND TEMPLATE_STATUS = '正式';
			IF
				( hiddleCount > 0 ) THEN
					errcode := 1;
				errmsg := '已发布的计划模板不允许删除！';
				ELSE errcode := 0;
				errmsg := '';

			END IF;
			ELSE
							DELETE POM_SPECIAL_TEMPLATE 
			WHERE
				id = ''||templateid||'';
			errcode := 0;
			errmsg := '删除成功！';


		END IF;
		EXCEPTION 
			WHEN OTHERS THEN
			errcode := 1;
		errmsg := sqlerrm;

	END;

END p_pom_smart_specialtemp_del;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_STANDARD_NODE_DEL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_SMART_STANDARD_NODE_DEL" ( nodeid IN VARCHAR2, --输入变量：任务项ID
		type IN VARCHAR2,--操作类型   0：
		errmsg OUT VARCHAR2, --提示消息
		errcode OUT INT --0成功，1失败
	) IS --标准节点库批量删除
--作者：叶丁荣
--日期：2019/11/21
    countdtl NUMBER;
		templatenodecount NUMBER;
        nodelist CLOB;
BEGIN


 BEGIN
        countdtl := 0;
        IF length(nodeid) < 36 THEN
            raise_application_error(-20000, '请选择要删除的任务项');
        END IF;

		IF (type=1) THEN
				--循环规则id

        FOR item IN (
            SELECT
                regexp_substr(''
                              || nodeid
                              || '', '[^,]+', 1, ROWNUM) AS id
            FROM
                dual
            CONNECT BY
                ROWNUM <= length(''
                                 || nodeid
                                 || '') - length(regexp_replace(''
                                                                || nodeid
                                                                || '', ',', '')) + 1
        ) LOOP
    ---删除任务项
            DELETE POM_STANDARD_NODE
            WHERE
                id = ''
                     || item.id
                     || '';

            countdtl := countdtl + 1;
        END LOOP;

        errcode := 0;
        errmsg := '删除成功！'
                  || countdtl
                  || '条任务项';

		ELSE
			--循环规则id

        FOR item IN (
            SELECT
                regexp_substr(''
                              || nodeid
                              || '', '[^,]+', 1, ROWNUM) AS id
            FROM
                dual
            CONNECT BY
                ROWNUM <= length(''
                                 || nodeid
                                 || '') - length(regexp_replace(''
                                                                || nodeid
                                                                || '', ',', '')) + 1
        ) LOOP
    ---删除验证
          SELECT COUNT(ID) INTO templatenodecount FROM POM_TEMPLATE_NODE WHERE STANDARD_NODE_ID=''||item.id||'';
					IF (templatenodecount>0) THEN
						 errcode := 1;
							errmsg := '已经被模板引用的节点不允许删除';
					ELSE
					 errcode := 0;
						errmsg := '';

					END IF;
          select wm_concat(NODE_NAME) into nodelist from POM_STANDARD_NODE where REFERENCE_DATE_NODE_ID = ''||item.id||'';
                    IF (nodelist is not null) THEN
                        errcode := 1;
                        errmsg := '当前节点是“'|| nodelist ||'”节点的参考时间节点，请清除该依赖关系后，再进行节点删除';
					ELSE
                        errcode := 0;
                        errmsg := '';

					END IF;

        END LOOP;

		END IF;

    EXCEPTION
        WHEN OTHERS THEN
            errcode := 1;
            errmsg :=  '删除节点失败！';
    END;





END p_pom_smart_standard_node_del;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_TASKCENTER_TBS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_SMART_TASKCENTER_TBS" (
        orgtype IN VARCHAR2, --查询类型，用于判断过滤 0,公司|1,部门|2,项目|3,,本人
		condition IN VARCHAR2, --输入变量：公司id | 部门id | 项目id | 当前用户ID
        currentuserid        IN 			VARCHAR2,--用户id，用于过滤关注的任务
        currentcompanyid     IN            VARCHAR2,--当前用户公司
        currentdeptid        IN            VARCHAR2,--当前用户部门
        currentstationid     IN            VARCHAR2,---当前用户的岗位
        bizcode       IN            VARCHAR2,---权限code
        item OUT SYS_REFCURSOR ) IS --任务中心tabs任务条数统计数据源
--作者：yedr
--日期：2019/12/25

    v_spid              VARCHAR2(200);
	BEGIN--========================================================本公司负责的任务
--调用数据权限验证存储过程
 P_SYS_AUTH_DATA_RULE_SPID(
            USERID => currentuserid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
	IF
		( orgtype = 0 ) THEN
		IF  condition <> '111' THEN
			OPEN item FOR SELECT--本月任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NULL
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					AND node.COMPANY_ID = '' || condition || ''
                    AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NULL
					AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
					AND plan.APPROVAL_STATUS = '已审核'
					AND	node.IS_DELETE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND (node.IS_DEL=0 OR node.IS_DEL=null)
					AND node.ACTUAL_END_DATE IS NULL
					AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
					AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS ACOUNT,
--超期未完成任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND SYSDATE > node.PLAN_END_DATE
					AND node.ACTUAL_END_DATE IS NULL
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND SYSDATE > node.PLAN_END_DATE
					AND node.ACTUAL_END_DATE IS NULL
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					AND node.COMPANY_ID = '' || condition || ''
					) +(
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND SYSDATE > node.PLAN_END_DATE
					AND node.ACTUAL_END_DATE IS NULL
					AND (node.IS_DEL=0 OR node.IS_DEL=null)
					AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS BCOUNT,
--所有未完成任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NULL
                    AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NULL
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND node.IS_DEL=0
					AND ACTUAL_END_DATE IS NULL
					AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS CCOUNT,
--所有已完成任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NOT NULL
                    AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND ACTUAL_END_DATE IS NOT NULL
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND ACTUAL_END_DATE IS NOT NULL
					AND node.IS_DEL=0
					AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS DCOUNT,
--所有任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND node.IS_DEL=0
					AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS ECOUNT,
--次月任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
					)
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
					)
					AND node.IS_DELETE=0
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND node.IS_DEL=0
					AND APPROVE_STATUS = '已审核'
					AND ( PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1 AND PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 ) )
					AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS FCOUNT,
--本季度任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					)
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					)
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND ( PLAN_END_DATE > trunc( SYSDATE, 'Q' ) AND PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1 )
					AND node.IS_DEL=0
					AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS GCOUNT,
--本年任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.proj_plan_id = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					)
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					)
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					AND node.COMPANY_ID = 'condition'
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND ( PLAN_END_DATE > trunc( SYSDATE, 'yyyy' ) AND PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1 )
					AND node.IS_DEL=0
					AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS HCOUNT
		FROM
			dual;
		ELSE
				OPEN item FOR SELECT--本月任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NULL
					AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NULL
					AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
					AND plan.APPROVAL_STATUS = '已审核'
					AND	node.IS_DELETE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND (node.IS_DEL=0 OR node.IS_DEL=null)
					AND node.ACTUAL_END_DATE IS NULL
					AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
				)
			) AS ACOUNT,
--超期未完成任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND SYSDATE > node.PLAN_END_DATE
					AND node.ACTUAL_END_DATE IS NULL
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND SYSDATE > node.PLAN_END_DATE
					AND node.ACTUAL_END_DATE IS NULL
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					) +(
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND SYSDATE > node.PLAN_END_DATE
					AND node.ACTUAL_END_DATE IS NULL
					AND (node.IS_DEL=0 OR node.IS_DEL=null)
				)
			) AS BCOUNT,
--所有未完成任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NULL
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NULL
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND node.IS_DEL=0
					AND ACTUAL_END_DATE IS NULL
					--AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS CCOUNT,
--所有已完成任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NOT NULL
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND ACTUAL_END_DATE IS NOT NULL
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND ACTUAL_END_DATE IS NOT NULL
					AND node.IS_DEL=0
				)
			) AS DCOUNT,
--所有任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND node.IS_DEL=0
				)
			) AS ECOUNT,
--次月任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
					)
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
					)
					AND node.IS_DELETE=0
					AND plan.APPROVAL_STATUS = '已审核'
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND node.IS_DEL=0
					AND APPROVE_STATUS = '已审核'
					AND ( PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1 AND PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 ) )
				)
			) AS FCOUNT,
--本季度任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND(
						node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					)
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					)
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND ( PLAN_END_DATE > trunc( SYSDATE, 'Q' ) AND PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1 )
					AND node.IS_DEL=0
				)
			) AS GCOUNT,
--本年任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.proj_plan_id = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					)
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					)
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND ( PLAN_END_DATE > trunc( SYSDATE, 'yyyy' ) AND PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1 )
					AND node.IS_DEL=0
				)
			) AS HCOUNT
		FROM
			dual;
		END IF;
--========================================================本公司负责的任务END
--========================================================本部门负责的任务
		ELSIF ( orgtype = 1 ) THEN
			IF(condition <> '222') THEN
                OPEN item FOR SELECT--本月任务
			(
				(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						AND node.IS_DELETE=0
						AND plan.APPROVAL_STATUS = '已审核'
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND ACTUAL_END_DATE IS NULL
						AND node.IS_DEL=0
						AND ( PLAN_END_DATE > trunc( SYSDATE, 'month' ) AND PLAN_END_DATE < trunc( last_day( SYSDATE ) ) )
						AND DUTY_DEPT_ID = '' || condition || ''
					)
				) AS ACOUNT,
--超期未完成任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND SYSDATE > node.PLAN_END_DATE
						AND node.ACTUAL_END_DATE IS NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND SYSDATE > node.PLAN_END_DATE
						AND node.ACTUAL_END_DATE IS NULL
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND SYSDATE > PLAN_END_DATE
						AND ACTUAL_END_DATE IS NULL
						AND node.IS_DEL=0
						AND DUTY_DEPT_ID = '' || condition || ''
					)
				) AS BCOUNT,
--所有未完成任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND ACTUAL_END_DATE IS NULL
						AND node.IS_DEL=0
						AND DUTY_DEPT_ID = '' || condition || ''
					)
				) AS CCOUNT,
--所有已完成任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NOT NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND ACTUAL_END_DATE IS NOT NULL
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND ACTUAL_END_DATE IS NOT NULL
						AND node.IS_DEL=0
						AND DUTY_DEPT_ID = '' || condition || ''
					)
				) AS DCOUNT,
--所有任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND node.IS_DEL=0
						AND DUTY_DEPT_ID = '' || condition || ''
					)
				) AS ECOUNT,
--次月任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND(
							node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
							AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
							AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
						)
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND ( PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1 AND PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 ) )
						AND node.IS_DEL=0
						AND DUTY_DEPT_ID = '' || condition || ''
					)
				) AS FCOUNT,
--本季度任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
						)
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND node.IS_DEL=0
						AND ( PLAN_END_DATE > trunc( SYSDATE, 'Q' ) AND PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1 )
						AND DUTY_DEPT_ID = '' || condition || ''
					)
				) AS GCOUNT,
--本年任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
						)
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND node.IS_DEL=0
						AND ( PLAN_END_DATE > trunc( SYSDATE, 'yyyy' ) AND PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1 )
						AND DUTY_DEPT_ID = '' || condition || ''
					)
				) AS HCOUNT
			FROM
				dual;
            ELSE
                OPEN item FOR SELECT--本月任务
			(
				(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
						AND node.IS_DELETE=0
						AND plan.APPROVAL_STATUS = '已审核'
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND ACTUAL_END_DATE IS NULL
						AND node.IS_DEL=0
						AND ( PLAN_END_DATE > trunc( SYSDATE, 'month' ) AND PLAN_END_DATE < trunc( last_day( SYSDATE ) ) )
					)
				) AS ACOUNT,
--超期未完成任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND SYSDATE > node.PLAN_END_DATE
						AND node.ACTUAL_END_DATE IS NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND SYSDATE > node.PLAN_END_DATE
						AND node.ACTUAL_END_DATE IS NULL
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND SYSDATE > PLAN_END_DATE
						AND ACTUAL_END_DATE IS NULL
						AND node.IS_DEL=0
					)
				) AS BCOUNT,
--所有未完成任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND ACTUAL_END_DATE IS NULL
						AND node.IS_DEL=0
					)
				) AS CCOUNT,
--所有已完成任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NOT NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND ACTUAL_END_DATE IS NOT NULL
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND ACTUAL_END_DATE IS NOT NULL
						AND node.IS_DEL=0
					)
				) AS DCOUNT,
--所有任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND node.IS_DEL=0
					)
				) AS ECOUNT,
--次月任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
							AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
							AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
						)
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND ( PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1 AND PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 ) )
						AND node.IS_DEL=0
					)
				) AS FCOUNT,
--本季度任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND(
							node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
						)
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND node.IS_DEL=0
						AND ( PLAN_END_DATE > trunc( SYSDATE, 'Q' ) AND PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1 )
					)
				) AS GCOUNT,
--本年任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                         LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
						)
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND node.IS_DEL=0
						AND ( PLAN_END_DATE > trunc( SYSDATE, 'yyyy' ) AND PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1 )
					)
				) AS HCOUNT
			FROM
				dual;
            END IF;
--========================================================本部门负责的任务END
--========================================================本项目负责的任务
			ELSIF ( orgtype = 2 ) THEN
				IF ( condition <> '111') THEN
					OPEN item FOR SELECT--本月任务
				(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND node.ACTUAL_END_DATE IS NULL
						AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND (plan.PROJ_ID=''||condition||'' OR plan.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''||condition||''))
					) AS ACOUNT,
--超期未完成任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND SYSDATE > node.PLAN_END_DATE
						AND node.ACTUAL_END_DATE IS NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND (plan.PROJ_ID=''||condition||'' OR plan.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''||condition||''))
					) AS BCOUNT,
--所有未完成任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND (plan.PROJ_ID=''||condition||'' OR plan.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''||condition||''))
					) AS CCOUNT,
--所有已完成任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NOT NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND (plan.PROJ_ID=''||condition||'' OR plan.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''||condition||''))
					) AS DCOUNT,
--所有任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND (plan.PROJ_ID=''||condition||'' OR plan.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''||condition||''))
					) AS ECOUNT,
--次月任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
							AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND (plan.PROJ_ID=''||condition||'' OR plan.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''||condition||''))
					) AS FCOUNT,
--本季度任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND (plan.PROJ_ID=''||condition||'' OR plan.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''||condition||''))
					) AS GCOUNT,
--本年任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND (plan.PROJ_ID=''||condition||'' OR plan.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''||condition||''))
					) AS HCOUNT
				FROM
					dual;
				ELSE
					OPEN item FOR SELECT--本月任务
				(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND node.ACTUAL_END_DATE IS NULL
						AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
					) AS ACOUNT,
--超期未完成任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND SYSDATE > node.PLAN_END_DATE
						AND node.ACTUAL_END_DATE IS NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
					) AS BCOUNT,
--所有未完成任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
					) AS CCOUNT,
--所有已完成任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NOT NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
					) AS DCOUNT,
--所有任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
					) AS ECOUNT,
--次月任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
							AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
					) AS FCOUNT,
--本季度任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
					) AS GCOUNT,
--本年任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
					) AS HCOUNT
				FROM
					dual;
				END IF;
--========================================================本项目负责的任务END
--========================================================本人负责的任务
				ELSE OPEN item FOR SELECT--所有未完成任务
				(
					(
						SELECT
							COUNT( * )
						FROM
							POM_PROJ_PLAN_NODE node
							LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							node.ACTUAL_END_DATE IS NULL
							AND ( plan.PLAN_TYPE = '项目主项计划' )
							AND plan.APPROVAL_STATUS = '已审核'
							AND node.IS_DISABLE=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
							) + (
						SELECT
							COUNT( * )
						FROM
							POM_SPECIAL_PLAN_NODE node
							LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							node.ACTUAL_END_DATE IS NULL
							AND plan.APPROVAL_STATUS = '已审核'
							AND node.IS_DELETE=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
							) + (
						SELECT
							COUNT( * )
						FROM
							pom_dept_monthly_plan_node node
							LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							node_source IS NULL
							AND ACTUAL_END_DATE IS NULL
							AND APPROVE_STATUS = '已审核'
							AND node.IS_DEL=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
						)
					) AS ACOUNT,
--超期未完成任务
					(
						(
						SELECT
							COUNT( * )
						FROM
							POM_PROJ_PLAN_NODE node
							LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							SYSDATE > node.PLAN_END_DATE
							AND node.ACTUAL_END_DATE IS NULL
							AND ( plan.PLAN_TYPE = '项目主项计划' )
							AND plan.APPROVAL_STATUS = '已审核'
							AND node.IS_DISABLE=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
							) + (
						SELECT
							COUNT( * )
						FROM
							POM_SPECIAL_PLAN_NODE node
							LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							SYSDATE > node.PLAN_END_DATE
							AND node.ACTUAL_END_DATE IS NULL
							AND plan.APPROVAL_STATUS = '已审核'
							AND node.IS_DELETE=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
							) + (
						SELECT
							COUNT( * )
						FROM
							pom_dept_monthly_plan_node node
							LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							node_source IS NULL
							AND SYSDATE > PLAN_END_DATE
							AND ACTUAL_END_DATE IS NULL
							AND APPROVE_STATUS = '已审核'
							AND node.IS_DEL=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
						)
					) AS BCOUNT,
--所有已完成任务
					(
						(
						SELECT
							COUNT( * )
						FROM
							POM_PROJ_PLAN_NODE node
							LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							node.ACTUAL_END_DATE IS NOT NULL
							AND ( plan.PLAN_TYPE = '项目主项计划' )
							AND plan.APPROVAL_STATUS = '已审核'
							AND node.IS_DISABLE=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
							) + (
						SELECT
							COUNT( * )
						FROM
							POM_SPECIAL_PLAN_NODE node
							LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							ACTUAL_END_DATE IS NOT NULL
							AND plan.APPROVAL_STATUS = '已审核'
							AND node.IS_DELETE=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
							) + (
						SELECT
							COUNT( * )
						FROM
							pom_dept_monthly_plan_node node
							LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							node_source IS NULL
							AND ACTUAL_END_DATE IS NOT NULL
							AND APPROVE_STATUS = '已审核'
							AND node.IS_DEL=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
						)
					) AS CCOUNT
				FROM
					dual;
--========================================================本人负责的任务END

			END IF;

END P_POM_SMART_TASKCENTER_TBS;
--============================任务中心数据源=====================================


--============================任务中心数据源=====================================

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SPECIAL_MSG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_SPECIAL_MSG" (
    ruleId in varchar,
    messagetype out integer,
    info out sys_refcursor
) as
    vSql clob;
    vCompanyId varchar(36);
    vRule clob;
    vResponsibleTitle varchar(3000) := '{节点责任人}负责节点{任务名称},{10},请督促责任人进行反馈';
    vSender varchar(36);
    vRuleType varchar(50);
    vMsgTemplate varchar(500);
    vSystemId varchar(36) := '71313f018a35f3a558166cba7599b5d6';
    vAppId varchar(36);
    vRemoteHost varchar(200) := GET_JUMP_URL_DOMAIN('PC', 'POM');
begin
    -- 获取系统id
    SELECT APP_ID into vAppId
    FROM SYS_APPLICATION WHERE ID = vSystemId;
    messagetype := 1; -- 只推送门户信息
    -- 关键字解析
    select
        APPLY_COMPANY_ID,
        replace(RULE_TYPE, '规则', '消息'),
        su.USER_CODE,
        replace(replace(replace(replace(replace(replace(MESSAGE_TEMPLATE
                                                    , '{项目名称}', 'pspn.CORRESPONDING_PROJ_NAME||''')
                                            , '{任务名称}', '''||NODE_NAME||''')
                                    , '{任务级别}', '''||''')
                            , '{当前日期}', '''||to_char(sysdate, ''yyyy-MM-dd'')||''')
                    , '{计划开始时间}', '''||to_char(pspn.PLAN_START_DATE, ''yyyy-MM-dd'')||''')
            , '{计划完成日期}', '''||to_char(pspn.PLAN_END_DATE, ''yyyy-MM-dd'')||'''),
        replace( replace( replace( replace( replace( replace( replace( replace( replace(prs.EXPRESSION
                                                                                    , '{实际完成时间}', 'ACTUAL_END_DATE')
                                                                           , '{当前日期}', 'sysdate'), '{}', '')
                                                         , '{计划完成时间}', 'pspn.PLAN_END_DATE')
                                                , '{所属公司}', 'cpy.ORG_NAME')
                                       , '{预计完成时间}', 'pspn.PREDICT_END_DATE')
                              , '{实际开始时间}', 'pspn.PLAN_START_DATE')
                     , '{任务名称}', 'NODE_NAME')
            , '{项目名称}', 'pspn.CORRESPONDING_PROJ_NAME')
    into vCompanyId, vRuleType, vSender,vMsgTemplate, vRule
    from POM_RULE_SET prs
             inner join POM_RULE_RECEIVER prr on prr.BIZ_ID = prs.ID
             inner join SYS_USER su on su.ID = prr.RECEIVER_ROLE_CODE
    where prs.id = ruleId;
    vSql := '
    select tmp.*, "title" AS "bizSourceCategory", "title" AS "taskname"
    from (
         select
            ''yuzheng'' AS "senderAccount",
             su.USER_CODE AS "recipientAccount",
            '''||vAppId||''' AS "appid",
            '''||vSystemId||''' AS "systemId",
            pspn.ID AS "bizKey",
            '''||vRuleType||''' AS "bizMsgCategory",
            ''tjSMS,tjWeChat'' AS "msgChannel",
            decode('''||vRuleType||''', ''预警消息'', ''4000010'', ''提醒消息'', ''400013'', '''||vRuleType||''') AS "smsTemplateid",
            ''["''||su.USER_NAME||''","''||NODE_NAME||''", '' ||''"''
                    ||TO_CHAR(TRUNC(SYSDATE)-TRUNC(PLAN_END_DATE))||''"]'' AS "smsParams",
            MOBILE_PHONE AS "mobile",
            ''400014'' AS "wechatTemplateid",
            ''["''||su.USER_NAME||''","''||NODE_NAME||''", '' ||''"''
                ||TO_CHAR(TRUNC(SYSDATE)-TRUNC(PLAN_END_DATE))||''"]'' AS "wechatParams",
            ''无'' AS "wechatJumplinkUrl",
            ''bizSourceCategory'' AS "bizSourceCategory",
            pncp.pmt "portalMsgType",
            '''||vRemoteHost||'/pom/mission-center-feedback/my-responsible-task?cancelType=0&id=''||PLAN_ID||''&feedbackNodeId=''
                ||pspn.ID|| ''&feedbackNodeOriginalId=''|| pspn.ORIGINAL_NODE_ID ||''&nodeSourcePlanType=1'' url,
            ''计划运营'' AS "typename",
            '''||vRuleType||''' "remark",
            TO_CHAR(SYSDATE,''yyyy-MM-dd HH:mm:ss'')  "expiretime",
            1 "priority",
            decode(su.USER_CODE, '''||vSender||''', replace(replace(replace('''||vResponsibleTitle||'''
            , ''{节点责任人}'', su.USER_NAME)
            , ''{任务名称}'', ''"''||NODE_NAME||''"'')
            , ''{10}'', decode(SIGN(TRUNC(SYSDATE)-TRUNC(PLAN_END_DATE)),
                    -1,''预计''||TO_CHAR(TRUNC(PLAN_END_DATE)-TRUNC(SYSDATE))||''天到期'',
                    1,''已超期''||TO_CHAR(TRUNC(SYSDATE)-TRUNC(PLAN_END_DATE))||''天'', ''预计0天到期'')),
            '||vMsgTemplate||''') "title"
        from POM_SPECIAL_PLAN psp
        inner join (
            select sbu.ID, sbu.ORG_NAME
            from SYS_BUSINESS_UNIT sbu
            start with sbu.ID = '''||vCompanyId||'''
            connect by prior sbu.ID=sbu.PARENT_ID
            union select sbu.ID, sbu.ORG_NAME
            from SYS_BUSINESS_UNIT sbu
            where IS_COMPANY = 1
            start with sbu.ID = '''||vCompanyId||'''
            connect by prior sbu.PARENT_ID = sbu.ID
        ) cpy on psp.COMPANY_ID = cpy.ID
        inner join POM_SPECIAL_PLAN_NODE pspn on psp.ORIGINAL_PLAN_ID = pspn.PLAN_ID
        inner join (
             select NODE_ID, CHARGE_PERSON, CHARGE_PERSON_ID userId, '''' userCode,  0 pmt from POM_NODE_CHARGE_PERSON
             union select NODE_ID, CHARGE_PERSON, '''' userId , '''||vSender||''' userCode, 10 pmt from POM_NODE_CHARGE_PERSON
        ) pncp on pncp.NODE_ID = pspn.ORIGINAL_NODE_ID
        inner join POM_RULE_RECEIVER prr on prr.BIZ_ID = '''||ruleId||'''
        inner join SYS_USER su on pncp.userId = su.ID or pncp.userCode = su.USER_CODE
        '|| (case when vRule is null then  '' else 'where ' end) || vRule ||'
    ) tmp order by "bizKey", "portalMsgType"
    ';
    insert into TEST(ID, TEST.PROJ_NAME, TEST.SQL_STR) values (GET_UUID(), 'specialMsg', vSql);
    commit;
    open info for vSql;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_TARGET_QUERY_BASE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_TARGET_QUERY_BASE" (
    targetId in varchar,
    baseInfo out sys_refcursor,
    attachmentList out sys_refcursor,
    targetPhase out integer,
    errCode out integer,
    errMsg out varchar
)
as
begin
    begin
        select TARGET_WORTH_PHASE into targetPhase from DWM_TARGET_WORTH dtw where dtw.id = targetId;
    exception when others then
        errMsg := '未找到对应的目标货值';
        errCode := 505;
        return;
    end;
    open baseInfo for
        -- 可研版:[所属项目,货值阶段,目标货值(万元), 创建人, 审核状态]
        -- 全盘版:[所属项目,货值阶段,目标货值(万元), 创建人, 审核状态, A全盘版目标货值(万元), B可研版目标货值(万元), C差额(万元)(B-A)]
        -- 动态版v1:[所属项目,货值阶段,目标货值(万元), 创建人, 审核状态, A全盘版目标货值(万元), B可研版目标货值(万元), C差额(万元)(B-A)]
        with T_BASE  as (
            select dtw.*, PROJECT_NAME
            from DWM_TARGET_WORTH dtw
                     left join SYS_PROJECT sp on sp.ID = dtw.PROJ_ID
            where dtw.id = targetId
        )
        select realName "realName", text "text", value "value"
        from (
                 select 'projectName' realName,'所属项目' text,PROJECT_NAME value,'0' orderCode from T_BASE
                 union all
                 select
                     'targetWorthPhase' realName,
                     '货值阶段' text,
                     decode(TARGET_WORTH_PHASE, 0, '可研版', 10, '全盘开发版', 20,
                            '动态版目标货值(V'||WORTH_V||')', '') value,
                     '1' orderCode
                 from T_BASE
                 union all
                 select
                     'targetWorth' realName,
                     decode(dtw.TARGET_WORTH_PHASE, 0, '目标货值(万元)', 10, 'A2全盘版目标货值(万元)',
                            20, 'B动态版目标货值V'||nvl(dtw.WORTH_V, 1)||'(万元)', '') text,
                     TO_CHAR(nvl(dtw.TARGET_WORTH, 0), 'FM99999990.0000') value,
                     '20' orderCode
                 from T_BASE dtw
                 union all
                 select
                     decode(dtw.TARGET_WORTH_PHASE, 10, 'feasibilityStudyVWorth', 20,
                            decode(nvl(dtw.WORTH_V, 1), 1, 'fullVWorth', 'previousVWorth'), '') realName,
                     decode(dtw.TARGET_WORTH_PHASE, 10, 'B可研版目标货值(万元)', 20,
                            decode(nvl(dtw.WORTH_V, 1), 1,'A全盘版目标货值(万元)',
                                   'A动态版目标货值V'||(nvl(dtw.WORTH_V, 1)-1)||'(万元)'), '') text,
                     TO_CHAR(nvl(decode(dtw.TARGET_WORTH_PHASE, 10, dtw.FEASIBILITY_STUDY_V_WORTH,
                                        decode(nvl(dtw.WORTH_V, 1), 1, FULL_V_WORTH, PREVIOUS_V_WORTH)), 0), 'FM99999990.0000')  value,
                     '21' orderCode
                 from T_BASE dtw where dtw.TARGET_WORTH_PHASE != 0
                 union all
                 select
                     decode(dtw.TARGET_WORTH_PHASE, 10, 'feasibilityStudyVIncrement', 20,
                            decode(nvl(dtw.WORTH_V, 1), 1, 'fullVIncrement', 'previousVIncrement'), '') realName,
                     decode(dtw.TARGET_WORTH_PHASE, 10, 'C差额(万元) (B-A)', 'C货值增量(万元)(B-A)') text,
                     TO_CHAR(decode(dtw.TARGET_WORTH_PHASE, 10, nvl(dtw.TARGET_WORTH,0) - nvl(dtw.FEASIBILITY_STUDY_V_WORTH, 0),
                                    decode(nvl(dtw.WORTH_V, 1), 1, nvl(dtw.TARGET_WORTH,0) - nvl(dtw.FULL_V_WORTH, 0),
                                           nvl(dtw.TARGET_WORTH,0) - nvl(dtw.PREVIOUS_V_WORTH, 0))), 'FM99999990.0000') value,
                     '22' orderCode
                 from T_BASE dtw where dtw.TARGET_WORTH_PHASE != 0
                 union all
                 select
                     'creator' realName,
                     '创建人' text,
                     dtw.CREATOR value,
                     '3' orderCode
                 from T_BASE dtw
                 union all
                 select
                     'approvalStatus' realName,
                     '审核状态' text,
                     dtw.APPROVAL_STATUS value,
                     '4' orderCode
                 from T_BASE dtw
             ) order by orderCode;
    open attachmentList for
        select
            id "id",
            '/api/attachment/app/review?attachmentId='||ID
                ||'&systemId=71313f018a35f3a558166cba7599b5d6' "appOfficeUrl",
            '/api/public/attachment/v2/download_single?attachmentId='||ID "url",
            '/api/public/attachment/thumbnail/download?attachmentId='||ID "thumbnailUrl",
            FILE_ORIGIN_NAME "filename",
            FILE_TYPE "type"
        from SYS_ATTACHMENT sa where sa.BIZ_ID=targetId;
end;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_TARGET_QUERY_DETAIL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_TARGET_QUERY_DETAIL" (
    targetId in varchar,
    info out sys_refcursor,
    errCode out integer,
    errMsg out varchar
)
as
    vPreviousTargetId varchar(36);
    vTargetId varchar(36) := targetId;
    vProjectId varchar(36);
    vTargetType varchar(36);
    vDynamicVersion int;
    vIsNoPeriod int;
    targetPhase int;
begin
    --获取项目id和货值类型
    begin
        select dtw.PROJ_ID, dtw.TARGET_WORTH_PHASE, nvl(dtw.WORTH_V, 1),TARGET_WORTH_PHASE
        into vProjectId, vTargetType,vDynamicVersion, targetPhase
        from DWM_TARGET_WORTH dtw
        where dtw.ID = vTargetId;
    exception when others then
        errCode := 505;
        errMsg :=  '未找到对应的目标货值';
        return;
    end;
    -- 动态版
    if vTargetType = 20 then
        begin
            if vDynamicVersion > 1 then
                select dtw.id into vPreviousTargetId
                from DWM_TARGET_WORTH dtw
                where dtw.PROJ_ID = vProjectId and dtw.TARGET_WORTH_PHASE=20
                  and dtw.WORTH_V = (vDynamicVersion - 1) and IS_DELETE = 0 and APPROVAL_STATUS='已审核';
            end if;
            if vDynamicVersion = 1 then
                select dtw.id into vPreviousTargetId
                from DWM_TARGET_WORTH dtw
                where dtw.PROJ_ID = vProjectId and dtw.TARGET_WORTH_PHASE = 10
                  and IS_DELETE = 0 and APPROVAL_STATUS='已审核';
            end if;
        exception when others then
            vPreviousTargetId := GET_UUID();
        end;
    end if;
    -- 判断是否为无分期
    if vProjectId is not null and vTargetType <> 0 then
        select (case when count(*) over() < 2 then decode(max(STAGE_NAME), '无分期', 0, 1) else 1 end) into vIsNoPeriod
        from SYS_PROJECT_STAGE
        where PROJECT_ID = vProjectId;    end if;
    open info for
        with PROJECT_INFO as (
            -- 获取项目信息
            select
                sp.ID id,
                '' pid,
                sp.PROJECT_NAME name,
                'project' type,
                TO_NUMBER(dtw.TARGET_WORTH - dtw.PREVIOUS_V_WORTH) previousTargetWorthContrast,
                dtw.TARGET_WORTH value
            from DWM_TARGET_WORTH dtw
                     inner join SYS_PROJECT sp on sp.ID = dtw.PROJ_ID
            where dtw.ID = vTargetId
        ),
             PERIOD_INFO as (
--             获取分期信息
                 select id                                     id,
                        pid                                    pid,
                        'period'                               type,
                        max(currentValue)           value,
                        name                                   name,
                        TO_NUMBER(max(currentValue)-max(previousValue)) previousTargetWorthContrast
                 from (
                          select sps.ID                                                                    id,
                                 sps.STAGE_NAME                                                            name,
                                 decode(TARGET_WORTH_ID, vTargetId, WORTH, 0) currentValue,
                                 sps.PROJECT_ID                                                            pid,
                                 decode(TARGET_WORTH_ID, vPreviousTargetId, WORTH, 0) previousValue,
                                 sps.ORDER_CODE orderCode
                          from DWM_TARGET_WORTH_DTL dtwd
                                   left join SYS_PROJECT_STAGE SPS on dtwd.OBJ_ID = SPS.ID
                          where sps.PROJECT_ID = vProjectId and dtwd.TARGET_WORTH_ID in (vTargetId, vPreviousTargetId)
                          -- 为无分期是 返回数据为空
                      ) where vIsNoPeriod = 1 group by id, pid, name, orderCode order by orderCode
             ),
             CUSTOM_PRODUCT as (
                 -- 自定义业态
                 select id cid, connect_by_root(TOP_PRODUCT_TYPE_NAME) TOP_PRODUCT_TYPE_NAME,
                        PRODUCT_TYPE_NAME, connect_by_root(PRODUCT_TYPE_CODE) PRODUCT_TYPE_CODE
                 from (
                          select id, PRODUCT_TYPE_CODE, PRODUCT_TYPE_NAME,
                                 replace(PRODUCT_TYPE_NAME, '车位仓储/') TOP_PRODUCT_TYPE_NAME, PARENT_CODE
                          from MDM_BUILD_PRODUCT_TYPE
                          where PRODUCT_TYPE_NAME != '车位仓储'
                      )a
                 start with length(PRODUCT_TYPE_CODE) < 2 or TOP_PRODUCT_TYPE_NAME='车位'
                         or TOP_PRODUCT_TYPE_NAME='仓储'
                 connect by prior a.PRODUCT_TYPE_CODE = PARENT_CODE
             ),
             PRODUCT_INFO_BASE as (
                 -- 同时遍历两个版本会有重复数据  需要去重
                 select distinct *
                 from (
                          select *
                          from (
                                   select
                                       tt.*,
                                       connect_by_root (tt.OBJ_ID)   TOP_OBJ_ID,
                                       connect_by_root (tt.OBJ_NAME) TOP_OBJ_NAME
                                   from (
                                            select dt.*, min(OBJ_TYPE) over () minObjType
                                            from DWM_TARGET_WORTH_DTL dt
                                            where TARGET_WORTH_ID in (vTargetId, vPreviousTargetId)
                                              and (OBJ_TYPE = vTargetType or OBJ_TYPE != 0)
                                        ) tt
                                   start with tt.OBJ_TYPE = minObjType
                                   connect by prior tt.OBJ_ID = tt.OBJ_PARENT_ID
                               ) where OBJ_TYPE = 40
                      ) dtwd left join CUSTOM_PRODUCT mbpt on mbpt.CID = dtwd.OBJ_ID
             ),
             PRODUCT_INFO_V1 as (
                 -- 业态信息已办
                 select
                     TOP_OBJ_ID pid,
                     nvl(sum(WORTH), 0) value,
                     TOP_PRODUCT_TYPE_NAME,
                     TARGET_WORTH_ID,
                     PRODUCT_TYPE_CODE code
                 from PRODUCT_INFO_BASE
                 group by TOP_PRODUCT_TYPE_NAME, TOP_OBJ_ID, TARGET_WORTH_ID, PRODUCT_TYPE_CODE
             ),
             BLANK_PRODUCT_INFO as (
                 -- 空白业态信息 用于填充无数据的记录
                 select
                     PID, TOP_PRODUCT_TYPE_NAME,  previousTargetValue, currentTargetValue, code
                 from (
                          select *
                          from (
                                   select cp.TOP_PRODUCT_TYPE_NAME, 0.0 currentTargetValue, 0.0 previousTargetValue,
                                          PRODUCT_TYPE_CODE code
                                   from CUSTOM_PRODUCT cp group by cp.TOP_PRODUCT_TYPE_NAME, PRODUCT_TYPE_CODE
                               ), (
                                   select decode(vIsNoPeriod, 1, PID, vProjectId) PID, TARGET_WORTH_ID
                                   from PRODUCT_INFO_V1 piv
                                   where piv.TARGET_WORTH_ID = vTargetId
                                   group by PID, TARGET_WORTH_ID, vProjectId, vIsNoPeriod
                               )
                      )
             ),
             INDEX_TYPE as (
                 -- 基础指标类型
                 select '可售面积（O）' productShowName, '住宅' typeName, 'saleableArea' columnName, 1 orderCode
                      , 'FM999999999990.00' precision from dual
                 union all select '可售车位个数', '车位' typeName, 'saleableCarport' columnName, 2 orderCode
                                , 'FM999999999990' precision from dual
                 union all select '货值（万元）' productShowName, '货值' typeName, 'targetValue' columnName,3 orderCode
                                , 'FM99999999990.0000' precision from dual
             ),
             BLANK_PRODUCT_INDEX_INFO as (
                 -- 空白指标信息 用于添加空白业态指标数据
                 select GET_UUID() ID, PID, productShowName, columnName, TOP_PRODUCT_TYPE_NAME, precision,
                        value, code, orderCode
                 from (
                          select cp.TOP_PRODUCT_TYPE_NAME, 0 value, PRODUCT_TYPE_CODE code
                          from CUSTOM_PRODUCT cp group by cp.TOP_PRODUCT_TYPE_NAME, PRODUCT_TYPE_CODE
                      ),(
                          select decode(vIsNoPeriod, 1, PID, vProjectId) PID
                          from PRODUCT_INFO_V1 piv
                          where piv.TARGET_WORTH_ID = vTargetId
                          group by PID, vProjectId, vIsNoPeriod
                      ), INDEX_TYPE
             ),
             PRODUCT_INFO as (
                 -- 指标数据
                 select
                         sys.Utl_Raw.Cast_To_Raw(sys.dbms_obfuscation_toolkit
                             .md5(input_string => TOP_PRODUCT_TYPE_NAME || PID)) ||'' ID,
                         TOP_PRODUCT_TYPE_NAME name,
                         PID pid,
                         'productType' type,
                         SUM(currentTargetValue) value,
                         TO_NUMBER(SUM(currentTargetValue)-SUM(previousTargetValue)) previousTargetWorthContrast
                 from (
                          select decode(vIsNoPeriod, 1, PID, vProjectId) pid, TOP_PRODUCT_TYPE_NAME,
                                 decode(TARGET_WORTH_ID, vPreviousTargetId, value, 0.0) previousTargetValue,
                                 decode(TARGET_WORTH_ID, vTargetId, value, 0.0) currentTargetValue, code
                          from PRODUCT_INFO_V1 piv
                          where piv.TARGET_WORTH_ID in (vTargetId, vPreviousTargetId)
                          union all select * from BLANK_PRODUCT_INFO
                      ) group by TOP_PRODUCT_TYPE_NAME, PID, code
                 order by code
             ),
             PRODUCT_INDEX_INFO as (
                 -- 指标数据信息
                 select
                     GET_UUID() id,
                     productShowName name,
                     sys.Utl_Raw.Cast_To_Raw(sys.dbms_obfuscation_toolkit
                         .md5(input_string => TOP_PRODUCT_TYPE_NAME || PID)) ||'' pid,
                     'productType-'||columnName type,
                     TO_CHAR(nvl(SUM(value), 0), precision) value,
                     0 previousTargetWorthContrast
                 from (
                          select
                              GET_UUID() ID, decode(vIsNoPeriod, 1, TOP_OBJ_ID, vProjectId)  PID, productShowName,
                              columnName, TOP_PRODUCT_TYPE_NAME, orderCode, precision,
                              nvl(decode(typeName, '车位', TOTAL_CARPORT, '货值', WORTH, TOTAL_SALES_AREA), 0) value
                          from PRODUCT_INFO_BASE mtb, INDEX_TYPE
                          where mtb.TARGET_WORTH_ID = vTargetId
                          union all select id, pid, productShowName, columnName, TOP_PRODUCT_TYPE_NAME, orderCode,
                                           precision,value
                          from BLANK_PRODUCT_INDEX_INFO
                      )group by TOP_PRODUCT_TYPE_NAME, PID, productShowName, columnName, orderCode, precision
                 order by orderCode
             )
        select id "id", name "name", pid "pid", type "type", sign(nvl(previoustargetworthcontrast, 0))
                  "previousTargetWorthContrast",  previoustargetworthcontrast "addedWorth", value "value",
               targetPhase "targetPhase"
        from (
                 select id, pid, name, type, previoustargetworthcontrast, TO_CHAR(value) value from PROJECT_INFO
                 union all select id, pid, name, type, previoustargetworthcontrast, TO_CHAR(value) value from PERIOD_INFO
                 union all select id, pid, name, type, previoustargetworthcontrast, TO_CHAR(value) value from PRODUCT_INFO
                 union all select id, pid, name, type, previoustargetworthcontrast, value from PRODUCT_INDEX_INFO
                 union all (
                     select GET_UUID() id, pid, '业态均价（元）' name, 'productType-averagePrice',
                            0 previoustargetworthcontrast,
                            TO_CHAR(decode(max(cnt), 0, 0, max(totalValue)*10000/max(cnt)), 'FM999990.00') value
                     from (
                              select
                                  id, pid, name, type, previoustargetworthcontrast, value,
                                  decode(type, 'productType-targetValue', 0, value) cnt,
                                  decode(type, 'productType-targetValue', value, 0) totalValue
                              from PRODUCT_INDEX_INFO
                          ) group by pid
                 )
             );
end;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_TASKLEVELCOMPLETIONRATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_TASKLEVELCOMPLETIONRATE" (
items out SYS_REFCURSOR)
is
--项目主项计划监控任务级别完成率
--作者：叶丁荣
--日期：2020/03/20
begin
open items for select nodes.* from (select node_level as "fullName",round(SUM(
                CASE
                    WHEN node.actual_end_date IS NOT NULL THEN
                        1
                    ELSE
                        0
                END
            ) /(
                CASE
                    WHEN COUNT(node.id) = 0 THEN
                        1
                    ELSE
                        COUNT(node.id)
                END
            ), 4) AS "competationRate" FROM pom_proj_plan_node node left join pom_proj_plan plan on plan.id=node.proj_plan_id
where plan.plan_type='项目主项计划' AND plan.approval_status = '已审核'  GROUP BY node.node_level
) nodes left join sys_bizparam_option param on param.PARAM_VALUE=nodes."fullName" order by param.PARAM_CODE;
end p_pom_tasklevelcompletionrate;
--===================================项目主项计划监控任务级别完成率=========

/
--------------------------------------------------------
--  DDL for Procedure P_POM_URGE_MESSAGE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_URGE_MESSAGE" (
    originalnodeid    varchar2,     --节点原始ID
    USERID IN VARCHAR2,--当前登录人
    plantype          varchar2,     --计划类型 （关键节点计划/项目主项计划/专项计划/部门月度计划）
   
    info     OUT      SYS_REFCURSOR--消息集合
) IS
--催办消息
--作者：谢松宏
--日期：2020/02/18
  m_user         varchar2(3000); -- 催办人名称
  m_nodeid         varchar2(300); -- 节点id
  m_userName         varchar2(2000); -- 被催办人名称
  m_userId varchar2(2000); -- 被催办人id
  m_MOBILE_PHONE varchar2(2000); -- 被催办人电话
  m_nodeName         varchar2(2000); -- 催办节点
BEGIN

 begin

if plantype = '关键节点计划' or plantype = '项目主项计划' then
    dbms_output.put_line('1');
       select NODE_NAME,n.id into m_nodeName,m_nodeid from POM_PROJ_PLAN_NODE n left join 
       POM_Proj_PLAN p on n.PROJ_PLAN_ID=p.id
       where  ORIGINAL_NODE_ID=originalnodeid and p.APPROVAL_STATUS='已审核';
       dbms_output.put_line('2');
  elsif plantype = '专项计划' then
     select NODE_NAME,n.id into m_nodeName,m_nodeid from POM_SPECIAL_PLAN_NODE n left join 
       POM_SPECIAL_PLAN p on n.PLAN_ID=p.id
       where  ORIGINAL_NODE_ID=originalnodeid and p.APPROVAL_STATUS='已审核';
  elsif plantype = '部门月度计划' then
       select NODE_NAME,n.id into m_nodeName,m_nodeid from POM_DEPT_MONTHLY_PLAN_NODE n left join 
       POM_DEPT_MONTHLY_PLAN p on n.DEPT_MONTHLY_PLAN_ID=p.id
       where  ORIGINAL_NODE_ID=originalnodeid and p.APPROVE_STATUS='已审核';
end if;
 select CHARGE_PERSON,CHARGE_PERSON_ID into m_userName,m_userId from POM_NODE_CHARGE_PERSON where node_id=m_nodeid;
 select MOBILE_PHONE into m_MOBILE_PHONE from sys_user where id=m_userId;
 select user_name into m_user from sys_user where id=USERID;
   EXCEPTION
        WHEN OTHERS THEN
--           m_userName:='未知';
--           m_nodeName:='未知';
            dbms_output.put_line(sqlerrm);
    END;
    OPEN info FOR SELECT
                ------------------------------------------------------------基础必须信息
              '71313f018a35f3a558166cba7599b5d6' AS "systemId",--系统id
              'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "appid",--应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段，
            ------------------------------------------------------------业务变动必须信息
              originalnodeid AS "bizKey",--业务id
               'tjSMS' AS "msgChannel",--使用消息渠道 多个，逗号分隔   tjWeChat：铁建微信,tjSMS：铁建短信
            ------------------------------------------------------------短信必须参数
              '400014' AS "smsTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID  --{1}您好，{2}对您负责的任务“{3}”进行了催办，请及时到门户网站查看待办并在《计划管理系统》中反馈任务进度{4}。
              '["'||m_userName||'","'||m_user||'","'||m_nodeName||'",""]' AS "smsParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
              m_MOBILE_PHONE as "mobile",--短信接收人电话
            ------------------------------------------------------------微信必须参数
              '400014' AS "wechatTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID
              '["'||m_userName||'","'||m_user||'","'||m_nodeName||'",""]' AS "wechatParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
               '///' AS "wechatJumplinkUrl",--微信打开地址，程序调用发消息前需要编码
              'v-xufeng' AS "recipientAccount",--接收人usercode如：a-xiexuhua
            ------------------------------------------------------------消息记录方追溯信息
              '催办消息' AS "title",--消息标题
              'v-xufeng' AS "senderAccount",--发送人usercode如：a-xiexuhua
              ''||m_userName||'您好，'||m_user||'对您负责的任务“'||m_nodeName||'”进行了催办' AS "bizSourceCategory",--业务所属类别=》 （由业务系统自定义，方便根据业务回溯，同一类别下有很多个类似业务，如月度计划）
              '催办消息' AS "bizMsgCategory"--消息所属类别=》 （由业务系统自定义，方便根据业务回溯，同一业务主键，有多个分类，如预警消息，提醒消息）
             FROM
                      dual;

END p_pom_urge_message;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_URGE_MSG_INFO
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_URGE_MSG_INFO" 
(
    ORIGINALNODEID IN VARCHAR2 --节点原始ID
,USERID         IN VARCHAR2 --当前登录人
,PLANTYPE       IN VARCHAR2 --计划类型 （关键节点计划/项目主项计划/专项计划/部门月度计划）
,MESSAGETYPE    OUT VARCHAR2 --0:门户终端消息都推送，1：只推送门户，2：只推送短信或微信
,INFO           OUT SYS_REFCURSOR --消息集合
) IS
    --通用推送集团门户和短信微信消息数据获取存储过程-------催办消息实例
    --1、输入参数可根据存储过程注册自定义
    --2、输出删除messageType和info必须，info返回结果字段名称和大小写需要严格按照定义返回
    --作者：陈丽
    --日期：2020/03/03
    M_USER           VARCHAR2(3000); -- 催办人名称
    M_URGEUSERCODE   VARCHAR2(3000); -- 催办人code
    M_PLANID         VARCHAR2(300); -- 计划id
    M_NODEID         VARCHAR2(300); -- 节点id
    M_USERNAME       VARCHAR2(2000); -- 被催办人名称
    M_USERCODE       VARCHAR2(2000); -- 被催办人id
    M_MOBILE_PHONE   VARCHAR2(2000); -- 被催办人电话
    M_NODENAME       VARCHAR2(2000); -- 催办节点
    M_SEC_COMPANY_ID VARCHAR(2000); -- 二级单位ID
    M_PLAN_NAME      VARCHAR2(1000); --计划名称
    M_IS_GROUPS      VARCHAR2(1000); --用于判断是否是"集团人员发的催办信息
    JUMP_URL_DOMAIN_H5  VARCHAR2(1000); --用于获取当前系统的域名地址
    JUMP_URL_DOMAIN_PC  VARCHAR2(1000); --用于获取当前系统的域名地址
BEGIN
    MESSAGETYPE := 0;

    BEGIN
        --货取节点信息
        IF PLANTYPE = '关键节点计划' OR PLANTYPE = '项目主项计划' THEN
            SELECT NODE_NAME, N.ID, P.ID
            INTO   M_NODENAME, M_NODEID, M_PLANID
            FROM   POM_PROJ_PLAN_NODE N
                       LEFT   JOIN POM_PROJ_PLAN P
                                   ON     N.PROJ_PLAN_ID = P.ID
            WHERE  ORIGINAL_NODE_ID = ORIGINALNODEID AND P.APPROVAL_STATUS = '已审核';
        ELSIF PLANTYPE = '专项计划' THEN
            SELECT NODE_NAME, N.ID, P.ID
            INTO   M_NODENAME, M_NODEID, M_PLANID
            FROM   POM_SPECIAL_PLAN_NODE N
                       LEFT   JOIN POM_SPECIAL_PLAN P
                                   ON     N.PLAN_ID = P.ID
            WHERE  ORIGINAL_NODE_ID = ORIGINALNODEID AND P.APPROVAL_STATUS = '已审核';
        ELSIF PLANTYPE = '部门月度计划' THEN
            SELECT NODE_NAME, N.ID, P.ID
            INTO   M_NODENAME, M_NODEID, M_PLANID
            FROM   POM_DEPT_MONTHLY_PLAN_NODE N
                       LEFT   JOIN POM_DEPT_MONTHLY_PLAN P
                                   ON     N.DEPT_MONTHLY_PLAN_ID = P.ID
            WHERE  ORIGINAL_NODE_ID = ORIGINALNODEID AND P.APPROVE_STATUS = '已审核';
        END IF;
        --获取二级单位公司ID
        SELECT A.ID
        INTO   M_SEC_COMPANY_ID
        FROM   SYS_BUSINESS_UNIT A
        WHERE  A.LEVEL_RANK = 2
        START  WITH A.ID = (SELECT P.COMPANY_ID FROM POM_PROJ_PLAN P WHERE P.ID = M_PLANID)
        CONNECT BY PRIOR A.PARENT_ID = A.ID;

        --获取项目名称
        SELECT A.PLAN_NAME INTO M_PLAN_NAME FROM POM_PROJ_PLAN A WHERE A.ID = M_PLANID;

        --判断是否是集团公司人员发的催办信息//若是集团人员发的催办信息,需推送给二级单位计划运营负责人

        SELECT COUNT(1)
        INTO   M_IS_GROUPS
        FROM   SYS_USER A
                   INNER  JOIN SYS_STATION_TO_USER B
                               ON     A.ID = B.USER_ID
                   INNER  JOIN SYS_STATION C
                               ON     B.STATION_ID = C.ID
                   INNER  JOIN SYS_BUSINESS_UNIT D
                               ON     C.ORG_ID = D.ID
        WHERE  A.ID = USERID AND (
                                     SELECT P.ORG_NAME FROM SYS_BUSINESS_UNIT P
                                     WHERE P.IS_COMPANY = 1 AND P.LEVEL_RANK = 2
                                     START WITH P.ID = C.ORG_ID
                                     CONNECT BY PRIOR P.PARENT_ID = P.ID
                                 ) = '集团总部';
        IF USERID = '622f125e-e475-4a56-88e7-34d1ced1c063' THEN--时凡,非集团人员,但是暂时在集团兼职,特殊处理
            M_IS_GROUPS := 1;
        ELSIF USERID = 'c5c997cc-23fd-4c2f-8933-c3c9f488668f' THEN--代世光，非集团人员，但是暂时在集团兼职，特殊处理
            M_IS_GROUPS := 1;
        END IF;
        --获取被催办人信息
        /* select CHARGE_PERSON,u.user_code,u.MOBILE_PHONE into m_userName,m_userCode,m_MOBILE_PHONE from POM_NODE_CHARGE_PERSON p
left join  sys_user u on p.CHARGE_PERSON_ID=u.id where node_id=m_nodeid;*/
        SELECT USER_NAME, USER_CODE INTO M_USER, M_URGEUSERCODE FROM SYS_USER WHERE ID = USERID;
    EXCEPTION
        WHEN OTHERS THEN
            --           m_userName:='未知';
            --           m_nodeName:='未知';
            NULL;
    END;
    --调用函数，获取跳转域名
    JUMP_URL_DOMAIN_H5:= GET_JUMP_URL_DOMAIN('H5', '71313f018a35f3a558166cba7599b5d6');
    JUMP_URL_DOMAIN_PC:= GET_JUMP_URL_DOMAIN('PC', '71313f018a35f3a558166cba7599b5d6');
    IF M_IS_GROUPS <> 0 THEN
        BEGIN
            OPEN INFO FOR
                SELECT
                    ------------------------------------------------------------基础配置数据【必须】（集团门户网站和设备消息都必须配置）----------------------------
                    M_URGEUSERCODE AS "senderAccount",
                    --发送人usercode如：a-xiexuhua,---门户网站的creatorName
                    U.USER_CODE AS "recipientAccount",
                    --接收人usercode如：a-xiexuhua--门户网站的ownerName
                    'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "appid",
                    --应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段---门户网站的sourceAppId
                    '71313f018a35f3a558166cba7599b5d6' AS "systemId",
                    --系统id
                    ORIGINALNODEID AS "bizKey",
                    --业务id--门户网站的taskId
                    '催办消息' AS "bizMsgCategory",
                    --消息所属类别=》 （由业务系统自定义，方便根据业务回溯，同一业务主键，有多个分类，如预警消息，提醒消息）
                    ------------------------------------------------------------设备消息配置开始------------------------------------------------------------
                    ------------------------------------------------------------【短信微信必须】基础信息
                    'tjSMS,tjWeChat' AS "msgChannel",
                    --使用消息渠道 多个，逗号分隔   tjWeChat：铁建微信,tjSMS：铁建短信
                    ------------【短信必须】参数
                    '400014' AS "smsTemplateid",
                    --模板 ID，在腾讯云短信审核通过的模板 ID  --{1}您好，{2}对您负责的任务“{3}”进行了催办，请及时到门户网站查看待办并在《计划管理系统》中反馈任务进度{4}。
                    '["' || P.CHARGE_PERSON || '","' || M_USER || '","' || M_NODENAME || '",""]' AS "smsParams",
                    --接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
                    U.MOBILE_PHONE AS "mobile",
                    --短信接收人电话
                    ------------【微信必须】参数
                    '400014' AS "wechatTemplateid",
                    --模板 ID，在腾讯云短信审核通过的模板 ID
                    '["' || P.CHARGE_PERSON || '","' || M_USER || '","' || M_NODENAME || '",""]' AS "wechatParams",
                    --接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
                    'USERID' AS "wechatJumplinkUrl",
                    --微信打开地址，程序调用发消息前需要编码
                    ------------消息记录方便追溯信息
                    '' || P.CHARGE_PERSON || '您好，' || M_USER || '对您负责的任务“' || M_NODENAME || '”进行了催办' AS "title",
                    --消息标题
                    '' || P.CHARGE_PERSON || '您好，' || M_USER || '对您负责的任务“' || M_NODENAME || '”进行了催办' AS "bizSourceCategory",
                    --业务所属类别=》 （由业务系统自定义，方便根据业务回溯，同一类别下有很多个类似业务，如月度计划）
                    ------------------------------------------------------------设备消息配置结束------------------------------------------------------------
                    ------------------------------------------------------------集团门户网站信息------------------------------------------------------------
                    --taskid  是 String  任务ID---------------------共有门户网站的1、插入待办/2、插入已办taskid，3、插入待阅/4、插入已阅informationid，5、插入我的关注的informationid
                    --creatorname 是 String  创建人
                    --ownername 是 String  拥有人
                    --sourceAppId 是 String  推送应用的appId
                    0 "portalMsgType",
                    --集团门户网站消息类型（0：待办,1:已办，10：待阅，11:已阅，20：关注）--已办，需要先根据bizKey删除待办，已阅接口需要根据bizKey调用集团待阅删除接口
                    JUMP_URL_DOMAIN_PC||'/pom/mission-center-feedback/my-responsible-task?cancelType=0' || CHR(38) || 'id=' || M_PLANID || CHR(38) || 'feedbackNodeId=' || M_NODEID ||
                    CHR(38) || 'feedbackNodeOriginalId=' || ORIGINALNODEID || CHR(38) || 'nodeSourcePlanType=1' "url",

                    --url 是 String  应用系统的url地址
                    JUMP_URL_DOMAIN_H5||'/pom/middle?originalUrl=' ||
                    URL_ENCODE(JUMP_URL_DOMAIN_H5||'/pom/mission-center-feedback/my-responsible-task?cancelType=0' || CHR(38) || 'id=' || M_PLANID || CHR(38) || 'feedbackNodeId=' || M_NODEID ||
                               CHR(38) || 'feedbackNodeOriginalId=' || ORIGINALNODEID || CHR(38) || 'nodeSourcePlanType=1') "mobileUrl",
                    --mobileUrl  否 String  应用系统的手机端url地址
                    '' || P.CHARGE_PERSON || '您好，' || M_USER || '对您负责的任务“' || M_NODENAME || '”进行了催办' "taskname",
                    --taskname 是 String  任务名称，等于3、插入待阅/4、插入已阅informationname;等于插入关注的attentionname
                    '计划运营' "typename",
                    --typename 是 String  任务类型
                    PLANTYPE "remark",
                    --remark 否 String  备注

                    ----------------------------------------------
                    -----除【关注外特有】
                    TO_CHAR(SYSDATE,'yyyy-MM-dd HH:mm:ss')  "expiretime",
                    --expiretime  否 String  过期时间，格式yyyy-MM-dd HH:mm:ss-----过期时间，除关注都有
                    1 "priority" --priority 否 Integer 优先级，除关注都有
                FROM   POM_NODE_CHARGE_PERSON P
                           LEFT   JOIN SYS_USER U
                                       ON     P.CHARGE_PERSON_ID = U.ID
                WHERE  NODE_ID = M_NODEID
                UNION ALL
                --获取二级单位计划运营负责人
                SELECT
                    ------------------------------------------------------------基础配置数据【必须】（集团门户网站和设备消息都必须配置）----------------------------
                    M_URGEUSERCODE AS "senderAccount",
                    --发送人usercode如：a-xiexuhua,---门户网站的creatorName
                    U.USER_CODE AS "recipientAccount",
                    --接收人usercode如：a-xiexuhua--门户网站的ownerName
                    (SELECT APP_ID FROM SYS_APPLICATION WHERE ID = '71313f018a35f3a558166cba7599b5d6') AS "appid",
                    --应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段---门户网站的sourceAppId
                    '71313f018a35f3a558166cba7599b5d6' AS "systemId",
                    --系统id
                    ORIGINALNODEID AS "bizKey",
                    --业务id--门户网站的taskId
                    '催办消息' AS "bizMsgCategory",
                    --消息所属类别=》 （由业务系统自定义，方便根据业务回溯，同一业务主键，有多个分类，如预警消息，提醒消息）
                    ------------------------------------------------------------设备消息配置开始------------------------------------------------------------
                    ------------------------------------------------------------【短信微信必须】基础信息
                    'tjSMS,tjWeChat' AS "msgChannel",
                    --使用消息渠道 多个，逗号分隔   tjWeChat：铁建微信,tjSMS：铁建短信
                    ------------【短信必须】参数
                    '400014' AS "smsTemplateid",
                    --模板 ID，在腾讯云短信审核通过的模板 ID  --{1}您好，{2}对您负责的任务“{3}”进行了催办，请及时到门户网站查看待办并在《计划管理系统》中反馈任务进度{4}。
                    '["' || U.USER_NAME || '","' || M_USER || '","' || M_NODENAME || '",""]' AS "smsParams",
                    --接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
                    U.MOBILE_PHONE AS "mobile",
                    --短信接收人电话
                    ------------【微信必须】参数
                    '400014' AS "wechatTemplateid",
                    --模板 ID，在腾讯云短信审核通过的模板 ID
                    '["' || U.USER_NAME || '","' || M_USER || '","' || M_NODENAME || '",""]' AS "wechatParams",
                    --接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
                    '///' AS "wechatJumplinkUrl",
                    --微信打开地址，程序调用发消息前需要编码
                    ------------消息记录方便追溯信息
                    '' || U.USER_NAME || '您好，' || M_USER || '对您负责的任务“' || M_NODENAME || '”进行了催办' AS "title",
                    --消息标题
                    '' || U.USER_NAME || '您好，' || M_USER || '对您负责的任务“' || M_NODENAME || '”进行了催办' AS "bizSourceCategory",
                    --业务所属类别=》 （由业务系统自定义，方便根据业务回溯，同一类别下有很多个类似业务，如月度计划）
                    ------------------------------------------------------------设备消息配置结束------------------------------------------------------------
                    ------------------------------------------------------------集团门户网站信息------------------------------------------------------------
                    --taskid  是 String  任务ID---------------------共有门户网站的1、插入待办/2、插入已办taskid，3、插入待阅/4、插入已阅informationid，5、插入我的关注的informationid
                    --creatorname 是 String  创建人
                    --ownername 是 String  拥有人
                    --sourceAppId 是 String  推送应用的appId
                    10 "portalMsgType",
                    --集团门户网站消息类型（0：待办,1:已办，10：待阅，11:已阅，20：关注）--已办，需要先根据bizKey删除待办，已阅接口需要根据bizKey调用集团待阅删除接口
                    JUMP_URL_DOMAIN_PC||'/pom/mission-center-feedback/my-responsible-task?cancelType=0' || CHR(38) || 'id=' || M_PLANID || CHR(38) || 'feedbackNodeId=' || M_NODEID ||
                    CHR(38) || 'feedbackNodeOriginalId=' || ORIGINALNODEID || CHR(38) || 'nodeSourcePlanType=1' "url",
                    --url 是 String  应用系统的url地址
                    JUMP_URL_DOMAIN_H5||'/pom/middle?originalUrl=' ||
                    URL_ENCODE(JUMP_URL_DOMAIN_H5||'/pom/mission-center-feedback/my-responsible-task?cancelType=0' || CHR(38) || 'id=' || M_PLANID || CHR(38) || 'feedbackNodeId=' || M_NODEID ||
                               CHR(38) || 'feedbackNodeOriginalId=' || ORIGINALNODEID || CHR(38) || 'nodeSourcePlanType=1') "mobileUrl",
                    --mobileUrl  否 String  应用系统的手机端url地址
                    '' || U.USER_NAME || '您好，' || M_USER || '对任务“' || M_NODENAME || '”进行了催办，请督促任务责任人及时进行反馈' "taskname",
                    --taskname 是 String  任务名称，等于3、插入待阅/4、插入已阅informationname;等于插入关注的attentionname
                    '计划运营' "typename",
                    --typename 是 String  任务类型
                    PLANTYPE "remark",
                    --remark 否 String  备注

                    ----------------------------------------------
                    -----除【关注外特有】
                    TO_CHAR(SYSDATE,'yyyy-MM-dd HH:mm:ss')  "expiretime",
                    --expiretime  否 String  过期时间，格式yyyy-MM-dd HH:mm:ss-----过期时间，除关注都有
                    1 "priority" --priority 否 Integer 优先级，除关注都有
                FROM   POM_PROJ_PLAN_NODE O
                           INNER  JOIN SYS_USER U
                                       ON  U.USER_CODE IN
                                           (SELECT OO.USER_ACCOUNT
                                            FROM   (
                                                       SELECT (
                                                                  SELECT P.ID FROM SYS_BUSINESS_UNIT P
                                                                  WHERE P.LEVEL_RANK = 2
                                                                  START WITH P.ID = A.COMPANY_ID
                                                                  CONNECT BY PRIOR P.PARENT_ID = P.ID
                                                              ) AS SEC_COMPANY_ID, A.*
                                                       FROM   SYS_ROLE_USER_RELATION_RESULT A
                                                       WHERE  A.ROLE_TYPE = 40 AND VIRTUAL_GROUP_NAME = '二级单位计划运营负责人'
                                                   ) OO WHERE  OO.SEC_COMPANY_ID = M_SEC_COMPANY_ID
                                           ) AND EXISTS(
                                                   SELECT 1 FROM POM_PROJ_PLAN QQ
                                                   WHERE QQ.ORIGINAL_PLAN_ID = O.ORIGINAL_PLAN_ID
                                                     AND QQ.PLAN_TYPE = '关键节点计划'
                                                     AND QQ.APPROVAL_STATUS = '已审核'
                                               ) WHERE  O.ID = M_NODEID;
        END;
    ELSE
        BEGIN
            OPEN INFO FOR
                SELECT
                    ------------------------------------------------------------基础配置数据【必须】（集团门户网站和设备消息都必须配置）----------------------------
                    M_URGEUSERCODE AS "senderAccount",
                    --发送人usercode如：a-xiexuhua,---门户网站的creatorName
                    U.USER_CODE AS "recipientAccount",
                    --接收人usercode如：a-xiexuhua--门户网站的ownerName
                    'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "appid",
                    --应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段---门户网站的sourceAppId
                    (SELECT APP_ID FROM SYS_APPLICATION WHERE ID = '71313f018a35f3a558166cba7599b5d6') AS "systemId",
                    --系统id
                    ORIGINALNODEID AS "bizKey",
                    --业务id--门户网站的taskId
                    '催办消息' AS "bizMsgCategory",
                    --消息所属类别=》 （由业务系统自定义，方便根据业务回溯，同一业务主键，有多个分类，如预警消息，提醒消息）
                    ------------------------------------------------------------设备消息配置开始------------------------------------------------------------
                    ------------------------------------------------------------【短信微信必须】基础信息
                    'tjSMS,tjWeChat' AS "msgChannel",
                    --使用消息渠道 多个，逗号分隔   tjWeChat：铁建微信,tjSMS：铁建短信
                    ------------【短信必须】参数
                    '400014' AS "smsTemplateid",
                    --模板 ID，在腾讯云短信审核通过的模板 ID  --{1}您好，{2}对您负责的任务“{3}”进行了催办，请及时到门户网站查看待办并在《计划管理系统》中反馈任务进度{4}。
                    '["' || P.CHARGE_PERSON || '","' || M_USER || '","' || M_NODENAME || '",""]' AS "smsParams",
                    --接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
                    U.MOBILE_PHONE AS "mobile",
                    --短信接收人电话
                    ------------【微信必须】参数
                    '400014' AS "wechatTemplateid",
                    --模板 ID，在腾讯云短信审核通过的模板 ID
                    '["' || P.CHARGE_PERSON || '","' || M_USER || '","' || M_NODENAME || '",""]' AS "wechatParams",
                    --接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
                    '///' AS "wechatJumplinkUrl",
                    --微信打开地址，程序调用发消息前需要编码
                    ------------消息记录方便追溯信息
                    '' || P.CHARGE_PERSON || '您好，' || M_USER || '对您负责的任务“' || M_NODENAME || '”进行了催办' AS "title",
                    --消息标题
                    '' || P.CHARGE_PERSON || '您好，' || M_USER || '对您负责的任务“' || M_NODENAME || '”进行了催办' AS "bizSourceCategory",
                    --业务所属类别=》 （由业务系统自定义，方便根据业务回溯，同一类别下有很多个类似业务，如月度计划）
                    ------------------------------------------------------------设备消息配置结束------------------------------------------------------------
                    ------------------------------------------------------------集团门户网站信息------------------------------------------------------------
                    --taskid  是 String  任务ID---------------------共有门户网站的1、插入待办/2、插入已办taskid，3、插入待阅/4、插入已阅informationid，5、插入我的关注的informationid
                    --creatorname 是 String  创建人
                    --ownername 是 String  拥有人
                    --sourceAppId 是 String  推送应用的appId
                    0 "portalMsgType",
                    --集团门户网站消息类型（0：待办,1:已办，10：待阅，11:已阅，20：关注）--已办，需要先根据bizKey删除待办，已阅接口需要根据bizKey调用集团待阅删除接口
                    JUMP_URL_DOMAIN_PC||'/pom/mission-center-feedback/my-responsible-task?cancelType=0' || CHR(38) || 'id=' || M_PLANID || CHR(38) || 'feedbackNodeId=' || M_NODEID ||
                    CHR(38) || 'feedbackNodeOriginalId=' || ORIGINALNODEID || CHR(38) || 'nodeSourcePlanType=1' "url",
                    --url 是 String  应用系统的url地址
                    JUMP_URL_DOMAIN_H5||'/pom/middle?originalUrl=' ||
                    URL_ENCODE(JUMP_URL_DOMAIN_H5||'/pom/mission-center-feedback/my-responsible-task?cancelType=0' || CHR(38) || 'id=' || M_PLANID || CHR(38) || 'feedbackNodeId=' || M_NODEID ||
                               CHR(38) || 'feedbackNodeOriginalId=' || ORIGINALNODEID || CHR(38) || 'nodeSourcePlanType=1') "mobileUrl",
                    --mobileUrl  否 String  应用系统的手机端url地址
                    '' || P.CHARGE_PERSON || '您好，' || M_USER || '对您负责的任务“' || M_NODENAME || '”进行了催办' "taskname",
                    --taskname 是 String  任务名称，等于3、插入待阅/4、插入已阅informationname;等于插入关注的attentionname
                    '计划运营' "typename",
                    --typename 是 String  任务类型
                    PLANTYPE "remark",
                    --remark 否 String  备注
                    ----------------------------------------------
                    -----除【关注外特有】
                    TO_CHAR(SYSDATE,'yyyy-MM-dd HH:mm:ss')  "expiretime",
                    --expiretime  否 String  过期时间，格式yyyy-MM-dd HH:mm:ss-----过期时间，除关注都有
                    1 "priority" --priority 否 Integer 优先级，除关注都有
                FROM   POM_NODE_CHARGE_PERSON P
                           LEFT   JOIN SYS_USER U
                                       ON     P.CHARGE_PERSON_ID = U.ID
                WHERE  NODE_ID = M_NODEID;
        END;
    END IF;
END;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_URGE_MSG_INFO_NEWS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_URGE_MSG_INFO_NEWS" 
(
    ORIGINALNODEID IN VARCHAR2 --节点原始ID
,URGEID         IN CLOB --催办人信息集合
,USERID         IN VARCHAR2 --当前登录人
,PLANTYPE       IN VARCHAR2 --计划类型 （关键节点计划/项目主项计划/专项计划/部门月度计划）
,MESSAGETYPE    OUT VARCHAR2 --0:门户终端消息都推送，1：只推送门户，2：只推送短信或微信
,INFO           OUT SYS_REFCURSOR --消息集合
) IS
    --作者：纪海龙
    --日期：2020/08/26
    M_USER           VARCHAR2(3000); -- 催办人名称
    M_URGEUSERCODE   VARCHAR2(3000); -- 催办人code
    M_PLANID         VARCHAR2(300);  -- 计划id
    M_NODEID         VARCHAR2(300);  -- 节点id
    M_NODENAME       VARCHAR2(2000); -- 催办节点
    JUMP_URL_DOMAIN_H5  VARCHAR2(1000); --用于获取当前系统的域名地址
    JUMP_URL_DOMAIN_PC  VARCHAR2(1000); --用于获取当前系统的域名地址
    CHAR_CODE        VARCHAR2(50);   --责任人标识
    CHAR_MOBILE      VARCHAR2(50);   --责任人电话
    CHARGE_NAME      VARCHAR2(50);   --责任人名称
    PLAN_TYPE_CODE   VARCHAR2(2);    --计划类型编号  0：关键节点计划，1：项目主项计划
    U_UERID          VARCHAR2(50);   --用户id
    U_MSG_TYPE       VARCHAR2(5);    --消息类型
BEGIN
    MESSAGETYPE := 0;
    BEGIN
        --获取节点信息
        IF PLANTYPE = '关键节点计划' OR PLANTYPE = '项目主项计划' THEN
            SELECT NODE_NAME, N.ID, P.ID
            INTO   M_NODENAME, M_NODEID, M_PLANID
            FROM   POM_PROJ_PLAN_NODE N
                       LEFT   JOIN POM_PROJ_PLAN P
                                   ON     N.PROJ_PLAN_ID = P.ID
            WHERE  ORIGINAL_NODE_ID = ORIGINALNODEID AND P.APPROVAL_STATUS = '已审核';
        ELSIF PLANTYPE = '专项计划' THEN
            SELECT NODE_NAME, N.ID, P.ID
            INTO   M_NODENAME, M_NODEID, M_PLANID
            FROM   POM_SPECIAL_PLAN_NODE N
                       LEFT   JOIN POM_SPECIAL_PLAN P
                                   ON N.ORIGINAL_PLAN_ID = P.ORIGINAL_PLAN_ID
            WHERE  ORIGINAL_NODE_ID = ORIGINALNODEID AND P.APPROVAL_STATUS = '已审核';
        ELSIF PLANTYPE = '部门月度计划' THEN
            SELECT NODE_NAME, N.ID, P.ID
            INTO   M_NODENAME, M_NODEID, M_PLANID
            FROM   POM_DEPT_MONTHLY_PLAN_NODE N
                       LEFT   JOIN POM_DEPT_MONTHLY_PLAN P
                                   ON     N.DEPT_MONTHLY_PLAN_ID = P.ID
            WHERE  ORIGINAL_NODE_ID = ORIGINALNODEID AND P.APPROVE_STATUS = '已审核';
        END IF;

        --判断计划类型编号
        IF PLANTYPE = '关键节点计划' THEN
            PLAN_TYPE_CODE := '0';
        ELSE
            PLAN_TYPE_CODE := '1';
        END IF;
        --获取被催办人信息
        SELECT USER_NAME, USER_CODE INTO M_USER, M_URGEUSERCODE FROM SYS_USER WHERE ID = USERID;
    EXCEPTION
        WHEN OTHERS THEN
            NULL;
    END;
    --调用函数，获取跳转域名
    JUMP_URL_DOMAIN_H5:= GET_JUMP_URL_DOMAIN('H5', '71313f018a35f3a558166cba7599b5d6');
    JUMP_URL_DOMAIN_PC:= GET_JUMP_URL_DOMAIN('PC', '71313f018a35f3a558166cba7599b5d6');
    BEGIN
        FOR ITEM IN (SELECT REGEXP_SUBSTR('' || TO_CHAR(URGEID) || '', '[^,]+', 1,ROWNUM) AS ID
                     FROM   DUAL
                     CONNECT BY ROWNUM <= LENGTH('' || TO_CHAR(URGEID) || '') -
                                          LENGTH(REGEXP_REPLACE('' || TO_CHAR(URGEID) || '',',', '')) + 1)
            LOOP
                --拆分用户信息  获取U_UERID，U_MSG_TYPE
                SELECT REGEXP_SUBSTR('' || ITEM.ID || '', '[^_]+', 1,1) into U_UERID FROM DUAL;
                SELECT REGEXP_SUBSTR('' || ITEM.ID || '', '[^_]+', 1,2) into U_MSG_TYPE FROM DUAL;
                --获取责任人信息
                SELECT
                    DISTINCT NVL(U.USER_CODE,'未知名'), NVL(U.MOBILE_PHONE,'没有号码'), U.USER_NAME
                INTO CHAR_CODE, CHAR_MOBILE, CHARGE_NAME
                FROM
                    SYS_USER U
                WHERE U.ID = U_UERID;
                --插入责任人数据至临时表
                INSERT INTO tmp_pom_urge_info (
                    ID,senderaccount,recipientaccount,appid,systemid,bizkey,bizmsgcategory,msgchannel,
                    smstemplateid,smsparams,mobile,wechattemplateid,wechatparams,wechatjumplinkurl,
                    title,bizsourcecategory,portalmsgtype,url,mobileurl,taskname,typename,remark,
                    expiretime,priority )
                VALUES (
                           0,
                           nvl(M_URGEUSERCODE, 'v-xufeng'),
                           CHAR_CODE,
                           (SELECT APP_ID FROM SYS_APPLICATION WHERE system_code = 'pom'),
                           (SELECT id FROM SYS_APPLICATION where system_code = 'pom'),
                           ORIGINALNODEID,
                           '催办消息',
                           'tjSMS,tjWeChat',
                           '400014',
                           '["' || CHARGE_NAME || '","' || M_USER || '","' || M_NODENAME || '",""]',
                           CHAR_MOBILE,
                           '400014',
                           '["' || CHARGE_NAME || '","' || M_USER || '","' || M_NODENAME || '",""]',
                           '///',
                           '' || CHARGE_NAME || '您好，' || M_USER || '对您负责的任务“' || M_NODENAME || '”进行了催办',
                           '' || CHARGE_NAME || '您好，' || M_USER || '对您负责的任务“' || M_NODENAME || '”进行了催办',
                           to_number(U_MSG_TYPE),
                           -- url
                           JUMP_URL_DOMAIN_PC||'/pom/mission-center-feedback/my-responsible-task?cancelType=0' || CHR(38) || 'id=' || M_PLANID || CHR(38) ||
                           'feedbackNodeId=' || M_NODEID || CHR(38) || 'feedbackNodeOriginalId=' || ORIGINALNODEID || CHR(38) || 'nodeSourcePlanType=' || PLAN_TYPE_CODE,
                           -- mobileurl
                           JUMP_URL_DOMAIN_H5||'/pom/middle?originalUrl=' || URL_ENCODE(JUMP_URL_DOMAIN_H5 ||'/pom/mission-center-feedback/my-responsible-task?cancelType=0' ||
                                                                                        CHR(38) || 'id=' || M_PLANID || CHR(38) || 'feedbackNodeId=' || M_NODEID || CHR(38) || 'feedbackNodeOriginalId=' || ORIGINALNODEID ||
                                                                                        CHR(38) || 'nodeSourcePlanType=' || PLAN_TYPE_CODE),
                           '' || CHARGE_NAME || '您好，' || M_USER || '对您负责的任务“' || M_NODENAME || '”进行了催办',
                           '计划运营',
                           PLANTYPE,
                           TO_CHAR(SYSDATE,'yyyy-MM-dd HH:mm:ss'),
                           to_number('1')
                       );
            END LOOP;
        OPEN INFO FOR
            SELECT
                senderaccount,recipientaccount,appid,systemid,bizkey,bizmsgcategory,msgchannel,
                smstemplateid,smsparams,mobile,wechattemplateid,wechatparams,wechatjumplinkurl,
                title,bizsourcecategory,portalmsgtype,url,mobileurl,taskname,typename,remark,
                expiretime,priority
            FROM tmp_pom_urge_info;
    END;
    DELETE FROM tmp_pom_urge_info;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_URGED_MSG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_URGED_MSG" (
    bizid      IN         VARCHAR2,--输入变量：业务id
    biztype    IN         VARCHAR2,--业务类型：1:关键节点计划节点，2：项目主项计划节点，3：专项计划节点，4：月度计划节点
    urgedmsg   OUT        SYS_REFCURSOR--0推送消息
) IS
--点击催办按钮，获取消息信息
--作者：陈丽
--日期：2019/11/17
    testmsg    NVARCHAR2(4000);
BEGIN
    BEGIN
        OPEN urgedmsg FOR SELECT
                              sysdate||'id' AS "msgGroupId",
                              '消息描述' || sysdate AS "msgDescription",
                              '1' AS "RecipientId",
                              bizid AS "bizKey",
                              'v-xufeng' AS "senderId",
                              biztype AS "bizSourceCategory",
                              '催办消息' AS "bizMsgCategory",
                              '预警' AS "systemId",
                              '111' AS "wechatJumplinkUrl"
                          FROM
                              dual;

    EXCEPTION
        WHEN OTHERS THEN
            testmsg := sqlerrm;
    END;
END p_pom_urged_msg;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_VERIFY_ATTR_AREA_USE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_VERIFY_ATTR_AREA_USE" (
    attrid     IN         VARCHAR2_LIST,--输入变量：单位面积等级id集合
    attrtype   IN         INT,--0单位面积等级,10项目合作属性,20经营属性
    message    OUT        VARCHAR2,--提示消息
    isuse      OUT        INT--0未使用，1已使用
) IS
--验证业态是否被使用
--作者：陈丽
--日期：2019/11/17
BEGIN
    BEGIN
        isuse := 0;
        message := '验证通过';
    --查看是否在指标表使用---先单个后期调整
--        SELECT
--            COUNT(attribute_area_level_id)
--        INTO isuse
--        FROM
--            mdm_obj_phase_area_level
--        WHERE
--            attribute_area_level_id = ''
--                                      || attributeid
--                                      || '';
        IF isuse > 0 THEN
            raise_application_error(-20000, '属性已被使用不允许删除');
        END IF;

    EXCEPTION
        WHEN OTHERS THEN
            isuse := 1;
            message := '验证失败，' || sqlerrm;
    END;
END p_pom_verify_attr_area_use;



/
--------------------------------------------------------
--  DDL for Procedure P_POM_VERIFY_BUILDING_USE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_VERIFY_BUILDING_USE" 
(
		BUILDINGID IN VARCHAR2
	 , --输入变量：楼栋id
		MESSAGE    OUT VARCHAR2
	 , --提示消息
		ISUSE      OUT INT --0未使用，1已使用
) IS
		--验证楼栋是否被使用
		--作者：陈丽
		--日期：2019/11/17
BEGIN
		BEGIN
				ISUSE := 0;
				--查看分期是否在指标表使用
				SELECT COUNT(BUILD_ID)
				INTO   ISUSE
				FROM   MDM_BUILD_PHASE
				WHERE  BUILD_ID = '' || BUILDINGID || '';
				IF LENGTH(ISUSE) > 0 THEN
						RAISE_APPLICATION_ERROR(-20000, '楼栋已存在指标数据不允许删除');
				END IF;
		EXCEPTION
				WHEN OTHERS THEN
						ISUSE   := 1;
						MESSAGE := '验证失败，' || SQLERRM;
		END;
END P_POM_VERIFY_BUILDING_USE;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_VERIFY_PERIOD_USE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_VERIFY_PERIOD_USE" (
periodoriginalid IN VARCHAR2,--输入变量：分期原始id,多个逗号分隔
message OUT VARCHAR2,--提示消息
isuse OUT INT--0未使用，1已使用
) IS--验证分期是否被使用
--作者：陈丽
--日期：2019/11/17
--分期删除验证计划（全盘、关键节点、项目主项计划）是否使用，目标货值是否使用，证照是否使用，主数据维护是否使用）
PLAN_USE int:=0;
TARGET_WORTH_USE int:=0;
PERMIT_USE int:=0;
PHASE_USE int:=0;
BEGIN 
BEGIN 
isuse :=0;--查看分期是否在指标表使用
--分期删除验证计划（关键节点、项目主项计划）是否使用
SELECT COUNT(id) INTO PLAN_USE FROM POM_PROJ_PLAN WHERE PROJ_ID IN (SELECT column_value FROM TABLE ( split(periodoriginalid) ))   ; 
--分期删除验证,目标货值是否使用
SELECT COUNT(id) INTO TARGET_WORTH_Use FROM DWM_TARGET_WORTH_DTL WHERE OBJ_ID IN (SELECT column_value FROM TABLE ( split(periodoriginalid) ))   ; 
--证照是否使用
SELECT COUNT(id) INTO PERMIT_USE FROM MDM_PERMIT WHERE PROJECT_ID IN (SELECT column_value FROM TABLE ( split(periodoriginalid) ))   ;  
--主数据维护是否使用
SELECT COUNT(period_id) INTO PHASE_USE FROM mdm_period_phase WHERE period_id IN (SELECT column_value FROM TABLE ( split(periodoriginalid) ))   ;  

IF plan_Use> 0 THEN 
isuse:=1;
message:='分期已存在计划不允许删除'; 
END IF; 
IF PHASE_USE> 0 THEN 
isuse:=1;
message:='分期已存在指标数据不允许删除分期'; 
END IF; 
IF TARGET_WORTH_Use> 0 THEN 
isuse:=1;
message:='分期已存在目标货值数据不允许删除'; 
END IF; 
IF PERMIT_Use> 0 THEN 
isuse:=1;
message:='分期已存在证照不允许删除'; 
END IF; 

EXCEPTION WHEN OTHERS THEN isuse :=1; message :='验证失败，' || sqlerrm;
END;
END p_pom_verify_period_use;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_VERIFY_PRODUCT_TYPE_USE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_VERIFY_PRODUCT_TYPE_USE" (
    ptid   IN           VARCHAR2,--输入变量：业态id。多个逗号分隔，
    message      OUT          VARCHAR2,--提示消息
    isuse        OUT          INT--0未使用，1已使用
) IS
--验证业态是否被使用
--作者：陈丽
--日期：2019/11/17
BEGIN
  BEGIN
        isuse := 0;
    --查看分期是否在指标表使用
        SELECT
            COUNT(PRODUCT_TYPE_ID)
        INTO isuse
        FROM
            MDM_OBJ_PHASE_PT_INDEX
        WHERE
            PRODUCT_TYPE_ID = ''
                        || ptid
                        || '';
        IF isuse > 0 THEN
            raise_application_error(-20000, '业务已被使用不允许删除');
        END IF;
        message := '验证通过';
    EXCEPTION
        WHEN OTHERS THEN
            isuse := 1;
            message := '验证失败，'||isuse || sqlerrm;
    END;
END p_pom_verify_product_type_use;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_W_PROJ_MAIN_LIGHT_UP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_W_PROJ_MAIN_LIGHT_UP" (
    companyId    IN           VARCHAR2,--公司id
    info    OUT          SYS_REFCURSOR --亮灯信息
) AS  
--项目主项计划监控-亮灯集合
--作者：陈丽
--修改：联合查询SYS_ROLE_USER_RELATION_RESULT表查询出项目计划专员  ByYedr 20200309
--日期：2019/12/07
BEGIN
    OPEN info FOR                    
    SELECT DISTINCT   B1.*,B1.TOTALNODECOUNT AS "totalNodeCount"  ,'项目计划专员:'|| CASE WHEN C1.USER_NAME is null then '无' else to_char(C1.USER_NAME) end AS "projectPlanManager"  
		FROM SYS_BUSINESS_UNIT A1  LEFT JOIN(
SELECT  D.PROJECT_NAME|| CASE WHEN C.STAGE_NAME NOT LIKE '%无分期%' THEN '_'||C.STAGE_NAME ELSE NULL END    AS "projectName"
,A.ID AS "planId"
,D.ID  as  "PROJECT_ID"
,A.COMPANY_ID
,COUNT(B.ID)  AS  "TOTALNODECOUNT"
,SUM( CASE WHEN    B.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END)  AS "actualEndNodeCount" 
,ROUND(SUM( CASE WHEN    B.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END)/COUNT(B.ID),2) AS "completeRate"
--完成率说明：截止当前完成节点数量/截止当前应完成任务数量    亮灯规则说明：1）绿灯：完成率≥95% 2）黄灯：95%>完成率≥90% 3）红灯：完成率＜90%
,
case when COUNT(B.ID)>0 then 
CASE WHEN ROUND(SUM( CASE WHEN    B.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END)/COUNT(B.ID),2)*100>=95 THEN 3 
      WHEN ROUND(SUM( CASE WHEN    B.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END)/COUNT(B.ID),2)*100>=90 then 2 
      WHEN ROUND(SUM( CASE WHEN    B.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END)/COUNT(B.ID),2)*100 <90 then 1
      ELSE 1 
  END else 1 END  AS "completeStatus"
    ,SUM( CASE WHEN  B.NODE_LEVEL='里程碑'    AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END) 
    +SUM( CASE WHEN  B.NODE_LEVEL='一级节点'  AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END) 
    +SUM( CASE WHEN  B.NODE_LEVEL='二级节点'  AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END) 
    +SUM( CASE WHEN  B.NODE_LEVEL='三级节点'  AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END) 
  --  +SUM( CASE WHEN  B.NODE_LEVEL='四级节点'  AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END) 

AS "overDueNotCompletedCount"

,SUM( CASE WHEN  B.NODE_LEVEL='里程碑'  AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END)  AS "milestoneNotCompleteCount" 
,SUM( CASE WHEN  B.NODE_LEVEL='一级节点'  AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END)  AS "oneNodeNotCompleteCount" 
,SUM( CASE WHEN  B.NODE_LEVEL='二级节点'  AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END)  AS "twoNodeNotCompleteCount" 
,SUM( CASE WHEN  B.NODE_LEVEL='三级节点'  AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END)  AS "threeNodeNotCompleteCount" 
--李晓聪20200330修改排除零做除数
, case when SUM( CASE WHEN  B.NODE_LEVEL='里程碑'  THEN 1 ELSE 0 END)>0 then  ROUND(SUM( CASE WHEN  B.NODE_LEVEL='里程碑'  AND  B.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END) /SUM( CASE WHEN  B.NODE_LEVEL='里程碑'  THEN 1 ELSE 0 END),2)  else 1 end  AS "milestoneNotCompletePercent" 
,case when SUM( CASE WHEN  B.NODE_LEVEL='一级节点'  THEN 1 ELSE 0 END)>0 then ROUND(SUM( CASE WHEN  B.NODE_LEVEL='一级节点'  AND  B.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END) /SUM( CASE WHEN  B.NODE_LEVEL='一级节点'  THEN 1 ELSE 0 END),2)  else 1 end  AS "oneNodeNotCompletePercent" 
,case when SUM( CASE WHEN  B.NODE_LEVEL='二级节点'  THEN 1 ELSE 0 END)>0 then ROUND(SUM( CASE WHEN  B.NODE_LEVEL='二级节点'  AND  B.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END) /SUM( CASE WHEN  B.NODE_LEVEL='二级节点'  THEN 1 ELSE 0 END),2) else 1  end   AS "twoNodeNotCompletePercent" 
,case when SUM( CASE WHEN  B.NODE_LEVEL='三级节点'  THEN 1 ELSE 0 END)>0 then ROUND(SUM( CASE WHEN  B.NODE_LEVEL='三级节点'  AND  B.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END) /SUM( CASE WHEN  B.NODE_LEVEL='三级节点'  THEN 1 ELSE 0 END),2) else 1 end   AS "threeNodeNotCompletePercent" 

FROM POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE B ON A.ID=B.PROJ_PLAN_ID
LEFT  JOIN SYS_PROJECT_STAGE C ON C.ID=PROJ_ID
INNER JOIN SYS_PROJECT D ON (D.ID=C.PROJECT_ID or PROJ_ID=d.id) 
WHERE     A.PLAN_TYPE='项目主项计划' AND A.APPROVAL_STATUS='已审核' AND B.IS_DISABLE=0  AND B.PLAN_END_DATE<=SYSDATE
 AND  A.PLAN_VERSION IN ( SELECT MAX(PLAN_VERSION) FROM POM_PROJ_PLAN A1 WHERE  A1.PROJ_ID=A.PROJ_ID AND A1.APPROVAL_STATUS='已审核' )
GROUP BY D.PROJECT_NAME|| CASE WHEN C.STAGE_NAME NOT LIKE '%无分期%' THEN '_'||C.STAGE_NAME ELSE NULL END,A.COMPANY_ID,A.ID,D.ID )
B1 ON B1.COMPANY_ID=A1.ID 
LEFT JOIN(SELECT wm_concat(USER_NAME) AS USER_NAME,PROJECT_ID FROM SYS_ROLE_USER_RELATION_RESULT WHERE ROLE_CODE='pom_project_plan_manager' GROUP BY PROJECT_ID) C1 ON C1.PROJECT_ID=B1.PROJECT_ID
WHERE  NVL(B1.TOTALNODECOUNT,0)>0 AND  CONNECT_BY_ROOT ID =''||companyId||''
CONNECT  by PRIOR   A1.ID= A1.PARENT_ID ;
END p_pom_w_proj_main_light_up;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_W_PROJ_MAIN_TREE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_W_PROJ_MAIN_TREE" (
    USERID VARCHAR2,
    STATIONID VARCHAR2,
    DEPTID VARCHAR2,
    COMPANYID VARCHAR2,
    info OUT SYS_REFCURSOR
)IS
    v_sql clob;
    --当前日期
    nowdate date:=trunc(sysdate);
    BIZCODE VARCHAR2(200):='POM.JHJKYKHPH.01';
    DATA_AUTH_SPID VARCHAR2(200);
BEGIN
BEGIN
  P_SYS_GET_COMPANY_PROJ_SPID(
    USERID => USERID,
    STATIONID => STATIONID,
    DEPTID => DEPTID,
    COMPANYID => COMPANYID,
    BIZCODE => BIZCODE,
    DATA_AUTH_SPID => DATA_AUTH_SPID
  );
END;
    OPEN info FOR                    
      WITH
     项目or分期 as (
    SELECT DISTINCT   B1.*
		FROM SYS_BUSINESS_UNIT A1  LEFT JOIN(
SELECT  D.PROJECT_NAME|| CASE WHEN C.STAGE_NAME NOT LIKE '%无分期%' THEN '_'||C.STAGE_NAME ELSE NULL END    AS "projectName"
,A.ID AS "planId"
,D.ID  as  "PROJECT_ID"
,A.COMPANY_ID
,COUNT(B.ID)  AS  "TOTALNODECOUNT"
,ROUND(SUM( CASE WHEN    B.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END)/COUNT(B.ID),4) AS "completeRate"
--完成率说明：截止当前完成节点数量/截止当前应完成任务数量    亮灯规则说明：1）绿灯：完成率≥95% 2）黄灯：95%>完成率≥90% 3）红灯：完成率＜90%
,
case when COUNT(B.ID)>0 then 
CASE WHEN ROUND(SUM( CASE WHEN    B.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END)/COUNT(B.ID),2)*100>=95 THEN 3 
      WHEN ROUND(SUM( CASE WHEN    B.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END)/COUNT(B.ID),2)*100>=90 then 2 
      WHEN ROUND(SUM( CASE WHEN    B.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END)/COUNT(B.ID),2)*100 <90 then 1
      ELSE 1 
  END else 1 END  AS "completeStatus"
FROM POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE B ON A.ID=B.PROJ_PLAN_ID
LEFT  JOIN SYS_PROJECT_STAGE C ON C.ID=PROJ_ID
INNER JOIN SYS_PROJECT D ON (D.ID=C.PROJECT_ID or PROJ_ID=d.id) 
WHERE     A.PLAN_TYPE='项目主项计划' AND A.APPROVAL_STATUS='已审核' AND B.IS_DISABLE=0  AND B.PLAN_END_DATE<=SYSDATE
AND  A.PLAN_VERSION IN ( SELECT MAX(PLAN_VERSION) FROM POM_PROJ_PLAN A1 WHERE  A1.PROJ_ID=A.PROJ_ID AND A1.APPROVAL_STATUS='已审核' )
GROUP BY D.PROJECT_NAME|| CASE WHEN C.STAGE_NAME NOT LIKE '%无分期%' THEN '_'||C.STAGE_NAME ELSE NULL END,A.COMPANY_ID,A.ID,D.ID )
B1 ON B1.COMPANY_ID=A1.ID 
LEFT JOIN(SELECT wm_concat(USER_NAME) AS USER_NAME,PROJECT_ID FROM SYS_ROLE_USER_RELATION_RESULT WHERE ROLE_CODE='pom_project_plan_manager' GROUP BY PROJECT_ID) C1 ON C1.PROJECT_ID=B1.PROJECT_ID
WHERE  NVL(B1.TOTALNODECOUNT,0)>0 AND  CONNECT_BY_ROOT ID ='003200000000000000000000000000'

CONNECT  by PRIOR   A1.ID= A1.PARENT_ID)

 ,拼接项目公司树 as(
   SELECT DISTINCT
   org_id       AS "orgId",
   org_name     AS "orgName",
   0 as  "orgType",
   parent_id    AS "parentId",
   1 as "isCompany"
   ,order_code as "orderCode"
   ,0 as "red"
    ,0 as "yellow"
    ,0 as "green"

                           FROM
                               tmp_company_tree
                           WHERE
                               id = DATA_AUTH_SPID
                               AND org_id IN (
                                   SELECT DISTINCT
                                       id
                                   FROM
                                       sys_business_unit
                                   START WITH
                                       id IN (
                                           SELECT
                                               id
                                           FROM
                                               (
                                                   SELECT
                                                       unit_id AS id
                                                   FROM
                                                       sys_project
                                                   UNION
                                                   SELECT
                                                       subordinate_company_id AS id
                                                   FROM
                                                       cdb_feasible_project_config
                                               ) ds
                                       )
                                   CONNECT BY
                                       PRIOR parent_id = id
                               )

   union all
    select    "planId"       AS "orgId",
   "projectName"     AS "orgName",
   0 as  "orgType",
   COMPANY_ID    AS "parentId",
   0 as "isCompany"
   ,'0' "orderCode"
   ,case when "completeStatus"=1 then 1 else 0 end as "red"
   ,case when "completeStatus"=2 then 1 else 0 end as "yellow"
   ,case when "completeStatus"=3 then 1 else 0 end as "green"  FROM 项目or分期)

   ,汇总 as(select
    "orgId",
    "orgName",
    "orgType",
    "parentId",
   "isCompany",
   "orderCode"
--,绿灯,黄灯,红灯
,(select sum("red") from 拼接项目公司树 start with "orgId"=s."orgId" connect by prior "orgId"="parentId" ) "red"
,(select sum("yellow") from 拼接项目公司树 start with "orgId"=s."orgId" connect by prior "orgId"="parentId" ) "yellow"
,(select sum("green") from 拼接项目公司树 start with "orgId"=s."orgId" connect by prior "orgId"="parentId" ) "green"
 from 拼接项目公司树 s)

   select  *
   from 汇总   where "isCompany"=1

   order by LPAD("orderCode",10,'0')
   ;

END p_pom_w_proj_main_tree;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_W_PROJ_PLAN_CHART
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_W_PROJ_PLAN_CHART" (
   userid                 IN                     VARCHAR2,--用户id
    planid                 IN                     VARCHAR2,--计划id
    completion_level_rate_title   OUT                    VARCHAR2,---一、按任务级别统计完成率 (%)--标题
    completion_level_rate  out SYS_REFCURSOR,---一、按任务级别统计完成率 (%)
    completion_dept_rate_title   OUT                    VARCHAR2,--- 二、按执行部门统计完成率 (%) --标题
    completion_dept_rate  out SYS_REFCURSOR---二、按执行部门统计完成率 (%)
) AS
--项目主项计划监控，详情页 ：图表
--作者：陈丽定义，李小聪实现  
--日期：2020/02/26
  v_timeout_count VARCHAR2(20):='';
  v_expect_timeout_count VARCHAR2(20):='';
BEGIN
completion_level_rate_title:='一、按任务级别统计完成率 (%)';
completion_dept_rate_title:='二、按执行部门统计完成率 (%)';

    OPEN Completion_level_rate FOR
--      SELECT  '里程碑' as "nodeName",1 as "percentage" from dual
--      UNION all 
--      SELECT  '一级节点' as "nodeName",1 as "percentage" from dual
--     UNION all 
--      SELECT  '二级节点' as "nodeName",1 as "percentage" from dual;
		SELECT   NODE_LEVEL  as "nodeName",	ROUND(SUM( CASE WHEN   B.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END) /COUNT(b.id),2)  AS "percentage" 
			FROM POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE B ON A.ID=B.PROJ_PLAN_ID
			INNER JOIN SYS_PROJECT_STAGE C ON C.ID=PROJ_ID
			INNER JOIN SYS_PROJECT D ON D.ID=C.PROJECT_ID
			WHERE     A.PLAN_TYPE='项目主项计划' AND A.APPROVAL_STATUS='已审核' AND B.IS_DISABLE=0  AND B.PLAN_END_DATE<=SYSDATE and  a.id=''||planid||''
			GROUP BY NODE_LEVEL    ORDER BY   CASE  WHEN   NODE_LEVEL='里程碑' THEN  0 WHEN   NODE_LEVEL='一级节点' THEN  1 WHEN   NODE_LEVEL='二级节点' THEN  3   WHEN   NODE_LEVEL='三级节点' THEN  4  WHEN   NODE_LEVEL='四级节点' THEN  5 else 6 END asc;

	 OPEN completion_dept_rate FOR	 

SELECT 　B.DUTY_DEPARTMENT as "department"  , TO_CHAR( ROUND ( SUM(CASE WHEN B.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END )/COUNT(B.ID),2)) AS "percentage" 
FROM  POM_PROJ_PLAN A  INNER JOIN POM_PROJ_PLAN_NODE B ON A.id=b.PROJ_PLAN_ID
where A.PLAN_TYPE='项目主项计划' AND A.APPROVAL_STATUS='已审核'  AND B.IS_DISABLE=0  AND A.ID=''||planId||''
GROUP BY   B.DUTY_DEPARTMENT_ID,B.DUTY_DEPARTMENT
ORDER BY 2 desc;

END p_pom_w_proj_plan_chart;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_W_PROJ_PLAN_DEPT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_W_PROJ_PLAN_DEPT" (planId in varchar2,wacthinfo OUT sys_refcursor)
AS
--项目主项计划监控，部门排行图
--作者：陈丽
--日期：2019/11/13
BEGIN
open wacthinfo for

SELECT 　B.DUTY_DEPARTMENT as "department"  , TO_CHAR( ROUND ( SUM(CASE WHEN B.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END )/COUNT(B.ID),2)) AS "percentage" 
FROM  POM_PROJ_PLAN A  INNER JOIN POM_PROJ_PLAN_NODE B ON A.id=b.PROJ_PLAN_ID
where A.PLAN_TYPE='项目主项计划' AND A.APPROVAL_STATUS='已审核'  AND B.IS_DISABLE=0  AND A.ID=''||planId||''
GROUP BY   B.DUTY_DEPARTMENT_ID,B.DUTY_DEPARTMENT
ORDER BY 2 desc
;
 
 
END p_pom_w_proj_plan_dept;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_W_PROJ_PLAN_DTL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_W_PROJ_PLAN_DTL" (
    userid                 IN                     VARCHAR2,--用户id
    planid                 IN                     VARCHAR2,--计划id
    pandect_info           out SYS_REFCURSOR      --计划明细一览表
) AS
--项目主项计划监控，详情页 ：明细一览表
--作者：陈丽
--修改者：谢松宏
--修改时间：2020/05/08 
--添加5个时间转换为字符串后查询的字段，日期字段去掉时间格式
--日期：2020/02/26
BEGIN
----计划明细一览表
    OPEN pandect_info FOR
        SELECT
    proj_id,
    proj_name,
    proj_plan_id,
    node_id,
    plan_id,
    plan_type,
    original_node_id,
    warning_status,
    node_code,
    node_name,
    node_level,
    duty_department,
    duty_department_id,
    duty_mans,
    finish_status,
    standard_score,
    to_char(a.PLAN_START_DATE, 'YYYY-mm-dd') as plan_start_date,
    to_char(a.PLAN_END_DATE, 'YYYY-mm-dd') as  plan_end_date,
    to_char(a.ACTUAL_START_DATE, 'YYYY-mm-dd')  as actual_start_date,
    to_char(a.ACTUAL_END_DATE, 'YYYY-mm-dd') as actual_end_date,
    to_char(a.ESTIMATE_END_DATE, 'YYYY-mm-dd') as estimate_end_date,
    process_feed_back_con,
    finish_feed_back_con,
    overdue_feed_back_con,
     nvl(b.IS_UN_WATCH,1) as  IS_UN_WATCH
         ,to_char(a.PLAN_START_DATE, 'YYYY-mm-dd') as "PLAN_START_TIME"
         ,to_char(a.PLAN_END_DATE, 'YYYY-mm-dd') as "PLAN_END_TIME"
         ,to_char(a.ACTUAL_START_DATE, 'YYYY-mm-dd') as "ACTUAL_START_TIME"
         ,to_char(a.ACTUAL_END_DATE, 'YYYY-mm-dd') as "ACTUAL_END_TIME"
         ,to_char(a.ESTIMATE_END_DATE, 'YYYY-mm-dd') as "ESTIMATE_END_TIME"
          ,b.UN_WATCH_TIME  ,b.WATCH_TIME , 
    node_flag,
    estimate_beyond_node_flag,
    completion_standard,
    completion_results_remark
      FROM  V_POM_PROJ_MONITOR_SUMMARYLIST  a   
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' --and   b.WATCH_TIME is  not   null
      WHERE     a.PLAN_ID=''||planid||'' ORDER BY NODE_CODE asc ;
END p_pom_w_proj_plan_dtl;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_W_PROJ_PLAN_OVERDUE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_W_PROJ_PLAN_OVERDUE" (
    userid                 IN                     VARCHAR2,--用户id
    planid                 IN                     VARCHAR2,--计划id
    timeout_info           OUT                    SYS_REFCURSOR,--三、超期未完成任务 
    timeout_title          OUT                    VARCHAR2,--标题 超期未完成任务：共0项
    expect_timeout_info    OUT                    SYS_REFCURSOR,--四、预计超期任务 
    expect_timeout_title   OUT                    VARCHAR2--标题预计超期任务：共0项
) AS
--项目主项计划监控，详情页 ：超期未完成任务,预计超期任务
--作者：陈丽定义，李小聪实现
--修改：联合查询SYS_ROLE_USER_RELATION_RESULT表查询出项目计划专员  ByYedr 20200309
--日期：2020/02/26
  v_timeout_count VARCHAR2(20):='';
  v_expect_timeout_count VARCHAR2(20):='';
  planning_specialist VARCHAR2(20):='';
BEGIN
   EXECUTE IMMEDIATE  
    'SELECT role.USER_NAME FROM POM_PROJ_PLAN plan LEFT JOIN SYS_PROJECT_STAGE stage ON plan.PROJ_ID=stage.ID
    LEFT JOIN SYS_PROJECT proj ON proj.ID=stage.PROJECT_ID
    LEFT JOIN (SELECT wm_concat(USER_NAME) AS USER_NAME,PROJECT_ID FROM SYS_ROLE_USER_RELATION_RESULT WHERE ROLE_CODE=''pom_project_plan_manager'' GROUP BY PROJECT_ID) role ON role.PROJECT_ID=stage.PROJECT_ID WHERE plan.ID='''||planid||'''' into planning_specialist;

    IF to_char(planning_specialist) is null then
        planning_specialist:='无';
    END IF;


 OPEN timeout_info FOR
      SELECT   a.*,nvl(b.IS_UN_WATCH,1)  as  IS_UN_WATCH ,b.UN_WATCH_TIME  ,b.WATCH_TIME  
      FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' --and   b.WATCH_TIME is  not   null
      WHERE     a.PLAN_ID=''||planid||''
      AND  TRUNC( a.PLAN_END_DATE)-TRUNC(SYSDATE)<0  and  a.ACTUAL_END_DATE  is null   ;
 OPEN expect_timeout_info FOR 
          SELECT   a.*,nvl(b.IS_UN_WATCH,1)  as  IS_UN_WATCH ,b.UN_WATCH_TIME  ,b.WATCH_TIME  
      FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND   TRUNC( a.ESTIMATE_END_DATE)-TRUNC(SYSDATE)<0   and  a.ACTUAL_END_DATE  is null  
			and  TRUNC( a.PLAN_END_DATE)-TRUNC(SYSDATE)>=0;


SELECT  (SELECT  TO_CHAR(COUNT(NODE_ID))        FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND  TRUNC( PLAN_END_DATE)-TRUNC(SYSDATE)<0  and  ACTUAL_END_DATE  is null   )  
INTO v_timeout_count  FROM  DUAL;
SELECT  (SELECT  TO_CHAR(COUNT(NODE_ID))        FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND   TRUNC( ESTIMATE_END_DATE)-TRUNC(SYSDATE)<0  and  ACTUAL_END_DATE  is null 	and  TRUNC( PLAN_END_DATE)-TRUNC(SYSDATE)>=0 ) 
		
INTO v_expect_timeout_count  FROM  DUAL;
    timeout_title := '超期未完成任务：共'||v_timeout_count||'项       (项目计划专员：'||planning_specialist||')';
    expect_timeout_title := '预计超期任务：共'||v_expect_timeout_count||'项';



END p_pom_w_proj_plan_overdue;
--==========================项目主项计划监控解析计划专员===================


--==========================任务中心--关键节点计划反馈====================

/
--------------------------------------------------------
--  DDL for Procedure P_POM_WARNING_MSG_LIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_WARNING_MSG_LIST" ( isread IN VARCHAR2, --0、未读1、已读
                                                     userid IN VARCHAR2,--当前用户ID
                                                     items OUT SYS_REFCURSOR,
                                                     total OUT INT ,--明细信息
                                                     pageindex     IN            INT,
                                                     pagesizes     IN            INT
)IS--预警消息台账
--作者：叶丁荣
--日期：2019/12/18
--日期：2020/01/13 康文靖修改
    v_sql               CLOB;
    v_sql_exec          CLOB;
    v_sql_exec_paging   CLOB;
BEGIN
    v_sql :='SELECT
      node.ID as nodeid,
      get_uuid() as id,
      ROWNUM as rowno,
      node.DUTY_DEPARTMENT AS DEPARTMENT,--部门
      node.NODE_LEVEL AS NODE_LEVEL,--任务级别
      node.STANDARD_SCORE,--标准分值
      to_char(node.PLAN_START_DATE,''yyyy-mm-dd'')   AS PLAN_BEGIN_TIME,--计划开始时间
      to_char(node.PLAN_END_DATE,''yyyy-mm-dd'') AS PLAN_END_TIME,--计划结束时间
      to_char(msg.ACTUAL_CREATED,''yyyy-mm-dd'')  AS WARNING_TIME,--预警时间
      msg.pc_url AS URL, --跳转URL
      msg.TASK_NAME AS WARNING_INFO,--预警信息
    CASE
        WHEN node.PLAN_END_DATE - SYSDATE < 0 THEN
        ''<i style="margin-left:0.6cm;width:20px;height:20px;border-radius:50%;background-color:red;display: block"></i>''
        WHEN node.PLAN_END_DATE - SYSDATE > 0 THEN
      ''<i style="margin-left:0.6cm;width:20px;height:20px;border-radius:50%;background-color:green;display: block"></i>''
    END AS WARNING_STATUS,
    msg.biz_msg_category as WARNING_TYPE
    FROM(
        select ORIGINAL_NODE_ID ID, DUTY_DEPARTMENT, NODE_LEVEL, STANDARD_SCORE,PLAN_START_DATE,PLAN_END_DATE from POM_PROJ_PLAN_NODE
        union all select ORIGINAL_NODE_ID ID, ''――'' DUTY_DEPARTMENT, ''――'' NODE_LEVEL, null STANDARD_SCORE,PLAN_START_DATE,PLAN_END_DATE from POM_DEPT_MONTHLY_PLAN_NODE
        union all select ORIGINAL_NODE_ID ID, DUTY_DEPARTMENT, ''--'' NODE_LEVEL, null STANDARD_SCORE,PLAN_START_DATE,PLAN_END_DATE from POM_SPECIAL_PLAN_NODE
    ) node
      left JOIN SYS_MESSAGE_CENTER msg ON msg.TASK_ID = node.ID
      left JOIN SYS_USER u ON msg.owner_name=u.user_code
      where msg.TASK_ID = node.ID AND u.ID='''||userid||'''
      AND (msg.biz_msg_category=''提醒消息'' OR msg.biz_msg_category=''预警消息'')';
    IF(isread='已读消息') THEN
        v_sql_exec :=v_sql ||'  and  msg.TASK_STATE = 10 ';
    ELSE
        v_sql_exec :=v_sql ||' and  msg.TASK_STATE = 0 ';
    END IF;
    v_sql_exec_paging :='select a.* from ( '|| v_sql_exec|| ' and ROWNUM <= '|| pageindex * pagesizes|| ' ) a where a.rowno >= '|| pagesizes * ( pageindex - 1 )|| '';
    insert into TEST(ID, PROJ_NAME, SQL_STR) values(GET_UUID(), 'msglist1', v_sql_exec);
    commit;
    dbms_output.put_line(v_sql_exec);
    ----获取总条数
    EXECUTE IMMEDIATE 'SELECT count(ROWNUM) from('
        || v_sql_exec
        || ') a'
        INTO total;
    OPEN items FOR v_sql_exec_paging;
END p_pom_warning_msg_list;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_WARNING_RULES_MSG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_POM_WARNING_RULES_MSG" 
(
    ruleId IN varchar2,
    messageType OUT VARCHAR2,
    info OUT SYS_REFCURSOR
)
    IS
    UseableRule clob;
    RuleType varchar2(200);
    RulePlanType varchar2(100);
    RuleNodeLevel varchar2(200);
    UseableTemplate clob;
    UseableProjIds clob;
    backlogTemplate clob;

    RuleReceiveType Number; --"接收人类型(0:集团级通用角色。10：公司级通用角色。20部门级通用角色，30，项目级通用角色。100：组织架构-公司，:110：组织-部门。120：组织架构-岗位。130：组织架构-人。200：相对人"
    RuleReceiveCode varchar2(36);

    RuleReceiveCodeStr clob;
    Sms_Template varchar(10);
    Wechat_Template varchar(10);
    JUMP_URL_DOMAIN varchar2(100);
    v_sql_exec clob;
BEGIN
    --DBMS_OUTPUT.ENABLE(buffer_size => null);
    --集团门户网站
    messageType:='1';
    --根据传入的规则ID，查询规则信息
    SELECT
        Analysis_Rule_KeyWord(EXPRESSION)
         ,RULE_TYPE
         ,NODE_LEVEL
         ,'REPLACE(
                   REPLACE(
                   REPLACE(
                   REPLACE(
                   REPLACE(
                   REPLACE(
                   REPLACE(
                   REPLACE(
                   REPLACE(
                   REPLACE(REPLACE('''||MESSAGE_TEMPLATE||''', ''{审核完成日期}'', APPROVAL_TIME_STR),''{任务级别}'',NODE_LEVEL),
                   ''{计划类型}'', PLAN_TYPE
                   ),  ''{当前日期}'', CURRENT_DATE_STR
                   ), ''{计划开始日期}'',PLAN_START_DATE_STR
                   ),''{计划完成日期}'',PLAN_END_DATE_STR
                   ),''{实际开始日期}'',ACTUAL_START_DATE_STR
                   ), ''{标准得分}'',STANDARD_SCORE
                   ), ''{项目名称}'',STAGE_FULL_NAME
                   ), ''{任务名称}'',NODE_NAME
                   ), ''{预计完成日期}'',ESTIMATE_END_DATE_STR
               )'
    INTO
        UseableRule
        ,RuleType
        ,RuleNodeLevel
        ,UseableTemplate
    FROM POM_RULE_SET  WHERE ID = ruleId;
    --获取规则的计划类型
    EXECUTE IMMEDIATE 'SELECT
            WM_CONCAT(RPLANTYPE.PLAN_TYPE)
            FROM POM_RULE_SET RSET
                LEFT JOIN POM_RULE_SET_PLAN_TYPE RPLANTYPE ON RSET.ID = RPLANTYPE.RULE_ID WHERE RSET.ID = '''||ruleId||'''' INTO RulePlanType;  --ruleId

    --根据传入的规则ID，查询未被禁用的项目IDs
    EXECUTE IMMEDIATE 'SELECT WM_CONCAT(RSCOPE.PROJECT_ID) FROM POM_RULE_SET RSET
    LEFT JOIN POM_RULE_SET_SCOPE RSCOPE ON RSET.ID = RSCOPE.RULE_ID
    WHERE RSET.IS_DISABLE = 0
    AND RSET.ID = '''||ruleId||'''
    AND (RSCOPE.START_DATE < SYSDATE OR RSCOPE.START_DATE IS NULL)
    AND (RSCOPE.END_DATE > SYSDATE OR RSCOPE.END_DATE IS NULL)' INTO UseableProjIds;  --ruleId

    --调用函数，获取跳转域名
    JUMP_URL_DOMAIN:= GET_JUMP_URL_DOMAIN('PC', '71313f018a35f3a558166cba7599b5d6');
    --根据不同的规则类型，设置不同的待阅模板
    IF RuleType  = '预警规则' THEN
        backlogTemplate:= '{节点责任人}负责节点{任务名称},预计{10}天到期,请督促责任人进行反馈';
        Sms_Template := '400010';
    ELSIF RuleType  = '提醒规则' THEN
        backlogTemplate:= '{节点责任人}负责节点{任务名称},已超期{10}天,请督促责任人进行反馈';
        Sms_Template := '400013';
    END IF;


    v_sql_exec := 'SELECT * FROM (
                  select
                      ''yuzheng1'' AS "senderAccount",
     --发送人usercode如：a-xiexuhua,---门户网站的creatorName
                      USER_CODE AS "recipientAccount",
                      (SELECT APP_ID FROM SYS_APPLICATION WHERE ID = ''71313f018a35f3a558166cba7599b5d6'') AS "appid",
     --应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段---门户网站的sourceAppId
                      ''71313f018a35f3a558166cba7599b5d6'' AS "systemId",
                      ID AS "bizKey",
                      CASE WHEN '''||RuleType||''' = ''预警规则'' THEN
                        ''预警消息''
                        WHEN '''||RuleType||''' = ''提醒规则'' THEN
                        ''提醒消息'' END  AS "bizMsgCategory",
                      ''tjSMS,tjWeChat'' AS "msgChannel",
                      ''无'' AS "smsTemplateid",
                      ''[]'' AS "smsParams",
                      MOBILE_PHONE AS "mobile",
                      ''400014'' AS "wechatTemplateid",
                      ''[]'' AS "wechatParams",
                      ''无'' AS "wechatJumplinkUrl",
                      CASE
                        WHEN '''||RuleType||''' = ''预警规则'' THEN
                            REPLACE((REPLACE(REPLACE(''{节点责任人}负责节点{任务名称},已超期{10}天,请督促责任人进行反馈'', ''{10}'', TRUNC(SYSDATE)- TRUNC(PLAN_END_DATE)), ''{任务名称}'', NODE_NAME)), ''{节点责任人}'', PERSON_Names)
                        WHEN '''||RuleType||''' = ''提醒规则'' THEN
                            REPLACE((REPLACE(REPLACE(''{节点责任人}负责节点{任务名称},预计{10}天到期,请督促责任人进行反馈'', ''{10}'', TRUNC(PLAN_END_DATE)-TRUNC(SYSDATE) ), ''{任务名称}'', NODE_NAME)), ''{节点责任人}'', PERSON_Names)
                             END AS "title",
                      CASE
                        WHEN '''||RuleType||''' = ''预警规则'' THEN
                            REPLACE((REPLACE(REPLACE(''{节点责任人}负责节点{任务名称},已超期{10}天,请督促责任人进行反馈'', ''{10}'', TRUNC(SYSDATE)- TRUNC(PLAN_END_DATE)), ''{任务名称}'', NODE_NAME)), ''{节点责任人}'', PERSON_Names)
                        WHEN '''||RuleType||''' = ''提醒规则'' THEN
                            REPLACE((REPLACE(REPLACE(''{节点责任人}负责节点{任务名称},预计{10}天到期,请督促责任人进行反馈'', ''{10}'', TRUNC(PLAN_END_DATE)-TRUNC(SYSDATE) ), ''{任务名称}'', NODE_NAME)), ''{节点责任人}'', PERSON_Names)
                              END AS "bizSourceCategory",
                      10 "portalMsgType",
                      --集团门户网站消息类型（0：待办,1:已办，10：待阅，11:已阅，20：关注）
                      '''||JUMP_URL_DOMAIN||'/pom/middle?originalUrl=''||URL_ENCODE('''||JUMP_URL_DOMAIN||'/pom/mission-center-feedback/my-responsible-task?cancelType=0''||CHR(38)||''id=''||PLAN_ID||CHR(38)||''feedbackNodeId=''||ID||
                      CHR(38) || ''feedbackNodeOriginalId='' || ORIGINAL_NODE_ID || CHR(38) || ''nodeSourcePlanType=1'') "url",
                      CASE
                        WHEN '''||RuleType||''' = ''预警规则'' THEN
                            REPLACE((REPLACE(REPLACE(''{节点责任人}负责节点{任务名称},已超期{10}天,请督促责任人进行反馈'', ''{10}'', TRUNC(SYSDATE)- TRUNC(PLAN_END_DATE)), ''{任务名称}'', NODE_NAME)), ''{节点责任人}'', PERSON_Names)
                        WHEN '''||RuleType||''' = ''提醒规则'' THEN
                            REPLACE((REPLACE(REPLACE(''{节点责任人}负责节点{任务名称},预计{10}天到期,请督促责任人进行反馈'', ''{10}'', TRUNC(PLAN_END_DATE)-TRUNC(SYSDATE) ), ''{任务名称}'', NODE_NAME)), ''{节点责任人}'', PERSON_Names)
                             END AS "taskname",
                      ''计划运营'' "typename",
                      PLAN_TYPE "remark",
                      TO_CHAR(SYSDATE,''yyyy-MM-dd HH:mm:ss'')  "expiretime",
                      1 "priority" --priority 否 Integer 优先级，除关注都有
                  from(
                  SELECT * FROM (
                      (
                        SELECT USER_CODE,MOBILE_PHONE FROM SYS_USER WHERE ID IN (SELECT RECEIVER_ROLE_CODE FROM POM_RULE_RECEIVER WHERE BIZ_ID = '''||ruleId||''' AND RECEIVER_TYPE = 130)   --单个接收人
                        UNION
                        SELECT USER_CODE,MOBILE_PHONE FROM SYS_USER WHERE ID IN(
                            SELECT USER_ID FROM SYS_STATION_TO_USER WHERE STATION_ID IN (
                                SELECT RECEIVER_ROLE_CODE FROM POM_RULE_RECEIVER WHERE BIZ_ID = '''||ruleId||''' AND RECEIVER_TYPE = 120 ))     --岗位接收人                                                                                                               --项目级角色
                      ) a
                      cross join
                      (
                        SELECT
                               NODE.ID
                              ,NODE.ORIGINAL_NODE_ID
                              ,NODE.NODE_NAME
                              ,PROJ.PROJECT_NAME
                              ,NODE.NODE_LEVEL
                              ,PLAN.ID AS PLAN_ID
                              ,PROJS.STAGE_FULL_NAME
                              ,PROJS.ID AS PROJS_ID
                              ,TO_CHAR(SYSDATE, ''yyyy-MM-dd'') AS CURRENT_DATE_STR
                              ,TO_CHAR(NODE.PLAN_START_DATE, ''yyyy-MM-dd'') AS PLAN_START_DATE_STR
                              ,TO_CHAR(NODE.PLAN_END_DATE, ''yyyy-MM-dd'') AS PLAN_END_DATE_STR
                              ,TO_CHAR(NODE.ACTUAL_START_DATE, ''yyyy-MM-dd'') AS ACTUAL_START_DATE_STR
                              ,TO_CHAR(NODE.ACTUAL_END_DATE, ''yyyy-MM-dd'') AS ACTUAL_END_DATE_STR
                              ,TO_CHAR(NODE.ESTIMATE_END_DATE, ''yyyy-MM-dd'') AS ESTIMATE_END_DATE_STR
                              ,FB.APPROVAL_TIME
                              ,TO_CHAR(FB.APPROVAL_TIME, ''yyyy-MM-dd'') AS APPROVAL_TIME_STR
                              ,PLAN.COMPANY_ID
                              ,PLAN.PLAN_TYPE
                              ,NODE.STANDARD_SCORE
                              ,NODE.PLAN_START_DATE AS PLAN_START_DATE
                              ,NODE.PLAN_END_DATE AS PLAN_END_DATE
                              ,NODE.ACTUAL_START_DATE
                              ,NODE.ACTUAL_END_DATE
                              ,NODE.ESTIMATE_END_DATE
                              ,(SELECT WM_CONCAT(CHARGE_PERSON_ID) FROM POM_NODE_CHARGE_PERSON WHERE NODE_ID = NODE.ID) AS PERSON_IDs
                              ,(SELECT WM_CONCAT(CHARGE_PERSON) FROM POM_NODE_CHARGE_PERSON WHERE NODE_ID = NODE.ID) AS PERSON_Names
                          FROM POM_PROJ_PLAN_NODE NODE
                              LEFT JOIN POM_PROJ_PLAN PLAN ON NODE.PROJ_PLAN_ID = PLAN.ID
                              LEFT JOIN SYS_PROJECT_STAGE PROJS ON PLAN.PROJ_ID = PROJS.ID
                              LEFT JOIN SYS_PROJECT PROJ ON PROJS.PROJECT_ID = PROJ.ID
                              LEFT JOIN POM_NODE_FEEDBACK FB ON NODE.ID = FB.FEEDBACK_NODE_ID
                          WHERE PROJ.ID IN (
                                    SELECT REGEXP_SUBSTR ('''||UseableProjIds||''', ''[^,]+'', 1,rownum) from dual
                                    connect by rownum<=LENGTH ('''||UseableProjIds||''') - LENGTH (regexp_replace('''||UseableProjIds||''', '','', ''''))+1
                              )
                              AND NODE.NODE_LEVEL = '''||RuleNodeLevel||'''
                              AND PLAN.PLAN_TYPE IN (
                                SELECT REGEXP_SUBSTR ('''||RulePlanType||''', ''[^,]+'', 1,rownum) from dual
                                connect by rownum<=LENGTH ('''||RulePlanType||''') - LENGTH (regexp_replace('''||RulePlanType||''', '','', ''''))+1
                              )
                              AND PLAN.APPROVAL_STATUS = ''已审核''
                              AND NODE.PLAN_END_DATE IS NOT NULL
                              AND NODE.ACTUAL_END_DATE IS NULL
                              AND NODE.IS_DISABLE = 0
                        ) b
                    )WHERE  '||UseableRule||'   --待阅
              )
UNION           --单个接收人与岗位接收人
select
                      ''yuzheng1'' AS "senderAccount",
     --发送人usercode如：a-xiexuhua,---门户网站的creatorName
                      USER_CODE AS "recipientAccount",
                      (SELECT APP_ID FROM SYS_APPLICATION WHERE ID = ''71313f018a35f3a558166cba7599b5d6'') AS "appid",
     --应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段---门户网站的sourceAppId
                      ''71313f018a35f3a558166cba7599b5d6'' AS "systemId",
                      ID AS "bizKey",
                      CASE WHEN '''||RuleType||''' = ''预警规则'' THEN
                        ''预警消息''
                        WHEN '''||RuleType||''' = ''提醒规则'' THEN
                        ''提醒消息'' END  AS "bizMsgCategory",
                      ''tjSMS,tjWeChat'' AS "msgChannel",
                      '''||Sms_Template||''' AS "smsTemplateid",
                      ''[]'' AS "smsParams",
                      ''无'' AS "mobile",
                      ''400014'' AS "wechatTemplateid",
                      ''[]'' AS "wechatParams",
                      ''无'' AS "wechatJumplinkUrl",
                  '||UseableTemplate||' AS "title",
                  '||UseableTemplate||' AS "bizSourceCategory",
                  10 "portalMsgType",
                  --集团门户网站消息类型（0：待办,1:已办，10：待阅，11:已阅，20：关注）
                  '''||JUMP_URL_DOMAIN||'/pom/middle?originalUrl=''||URL_ENCODE('''||JUMP_URL_DOMAIN||'/pom/mission-center-feedback/my-responsible-task?cancelType=0''||CHR(38)||''id=''||PLAN_ID||CHR(38)||''feedbackNodeId=''||ID||
                  CHR(38) || ''feedbackNodeOriginalId='' || ORIGINAL_NODE_ID || CHR(38) || ''nodeSourcePlanType=1'') "url",
                  '||UseableTemplate||' "taskname",
                  ''计划运营'' "typename",
                  PLAN_TYPE "remark",
                  TO_CHAR(SYSDATE,''yyyy-MM-dd HH:mm:ss'')  "expiretime",
                  1 "priority" --priority 否 Integer 优先级，除关注都有
FROM(
    SELECT A.USER_ACCOUNT AS USER_CODE,B.* FROM(
        SELECT RRESULT.USER_ACCOUNT ,UNIT.PARENT_ID FROM SYS_ROLE_USER_RELATION_RESULT RRESULT
            LEFT JOIN SYS_BUSINESS_UNIT UNIT ON RRESULT.COMPANY_ID = UNIT.ID
                WHERE VIRTUAL_GROUP_ID IN (
                    SELECT RECEIVER_ROLE_CODE
                    FROM POM_RULE_RECEIVER
                    WHERE BIZ_ID = '''||ruleId||'''
                      AND RECEIVER_TYPE = 40
                ) AND RRESULT.COMPANY_ID IS NOT NULL
                GROUP BY UNIT.PARENT_ID,RRESULT.USER_ACCOUNT
    )A
    CROSS JOIN
    (
        SELECT
                NODE.ID
              ,NODE.ORIGINAL_NODE_ID
              ,NODE.NODE_NAME
              ,PROJ.PROJECT_NAME
              ,NODE.NODE_LEVEL
              ,PLAN.ID AS PLAN_ID
              ,PROJS.STAGE_FULL_NAME
              ,PROJS.ID AS PROJS_ID
              ,TO_CHAR(SYSDATE, ''yyyy-MM-dd'') AS CURRENT_DATE_STR
              ,TO_CHAR(NODE.PLAN_START_DATE, ''yyyy-MM-dd'') AS PLAN_START_DATE_STR
              ,TO_CHAR(NODE.PLAN_END_DATE, ''yyyy-MM-dd'') AS PLAN_END_DATE_STR
              ,TO_CHAR(NODE.ACTUAL_START_DATE, ''yyyy-MM-dd'') AS ACTUAL_START_DATE_STR
              ,TO_CHAR(NODE.ACTUAL_END_DATE, ''yyyy-MM-dd'') AS ACTUAL_END_DATE_STR
              ,TO_CHAR(NODE.ESTIMATE_END_DATE, ''yyyy-MM-dd'') AS ESTIMATE_END_DATE_STR
              ,FB.APPROVAL_TIME
              ,TO_CHAR(FB.APPROVAL_TIME, ''yyyy-MM-dd'') AS APPROVAL_TIME_STR
              ,PROJ.UNIT_ID
              ,PLAN.COMPANY_ID
              ,PLAN.PLAN_TYPE
              ,NODE.STANDARD_SCORE
              ,NODE.PLAN_START_DATE AS PLAN_START_DATE
              ,NODE.PLAN_END_DATE AS PLAN_END_DATE
              ,NODE.ACTUAL_START_DATE
              ,NODE.ACTUAL_END_DATE
              ,NODE.ESTIMATE_END_DATE
              ,(SELECT WM_CONCAT(CHARGE_PERSON_ID) FROM POM_NODE_CHARGE_PERSON WHERE NODE_ID = NODE.ID) AS PERSON_IDs
              ,(SELECT WM_CONCAT(CHARGE_PERSON) FROM POM_NODE_CHARGE_PERSON WHERE NODE_ID = NODE.ID) AS PERSON_Names
            FROM POM_PROJ_PLAN_NODE NODE
                     LEFT JOIN POM_PROJ_PLAN PLAN ON NODE.PROJ_PLAN_ID = PLAN.ID
                     LEFT JOIN SYS_PROJECT_STAGE PROJS ON PLAN.PROJ_ID = PROJS.ID
                     LEFT JOIN SYS_PROJECT PROJ ON PROJS.PROJECT_ID = PROJ.ID
                     LEFT JOIN POM_NODE_FEEDBACK FB ON NODE.ID = FB.FEEDBACK_NODE_ID
            WHERE PROJ.ID IN (
                    SELECT REGEXP_SUBSTR ('''||UseableProjIds||''', ''[^,]+'', 1,rownum) from dual
                    connect by rownum<=LENGTH ('''||UseableProjIds||''') - LENGTH (regexp_replace('''||UseableProjIds||''', '','', ''''))+1
              )
              AND NODE.NODE_LEVEL = '''||RuleNodeLevel||'''
              AND NODE.ACTUAL_END_DATE IS NULL
              AND NODE.IS_DISABLE = 0
              AND PLAN.PLAN_TYPE IN (
                SELECT REGEXP_SUBSTR ('''||RulePlanType||''', ''[^,]+'', 1,rownum) from dual
                connect by rownum<=LENGTH ('''||RulePlanType||''') - LENGTH (regexp_replace('''||RulePlanType||''', '','', ''''))+1
              )
              AND PLAN.APPROVAL_STATUS = ''已审核''
              AND PROJ.UNIT_ID IN (
                SELECT PARENT_ID
                FROM SYS_BUSINESS_UNIT
                WHERE ID IN (
                    SELECT COMPANY_ID
                    FROM SYS_ROLE_USER_RELATION_RESULT
                    WHERE VIRTUAL_GROUP_ID IN (
                        SELECT RECEIVER_ROLE_CODE
                        FROM POM_RULE_RECEIVER
                        WHERE BIZ_ID = '''||ruleId||'''
                          AND RECEIVER_TYPE = 40
                    )
                      AND COMPANY_ID IS NOT NULL
                    GROUP BY COMPANY_ID
                    UNION
                    SELECT PARENT_ID AS COMPANY_ID
                    FROM SYS_BUSINESS_UNIT
                    WHERE PARENT_ID IN (
                        SELECT ID
                        FROM SYS_BUSINESS_UNIT
                        WHERE ID IN (
                            SELECT PARENT_ID
                            FROM SYS_BUSINESS_UNIT
                            WHERE ID IN (
                                SELECT COMPANY_ID
                                FROM SYS_ROLE_USER_RELATION_RESULT
                                WHERE VIRTUAL_GROUP_ID IN (
                                    SELECT RECEIVER_ROLE_CODE
                                    FROM POM_RULE_RECEIVER
                                    WHERE BIZ_ID = '''||ruleId||'''
                                      AND RECEIVER_TYPE = 40
                                )
                                  AND COMPANY_ID IS NOT NULL
                                GROUP BY COMPANY_ID
                            )
                              AND IS_COMPANY = 1
                              AND LEVEL_RANK = 3
                            GROUP BY PARENT_ID
                        )
                    )
                      AND ORDER_CODE = 1
                )
                GROUP BY PARENT_ID
            )
    )B WHERE A.PARENT_ID = B.UNIT_ID           --解析虚拟组
)WHERE  '||UseableRule||'
UNION
select
                      ''yuzheng1'' AS "senderAccount",
     --发送人usercode如：a-xiexuhua,---门户网站的creatorName
                      USER_CODE AS "recipientAccount",
                      (SELECT APP_ID FROM SYS_APPLICATION WHERE ID = ''71313f018a35f3a558166cba7599b5d6'') AS "appid",
     --应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段---门户网站的sourceAppId
                      ''71313f018a35f3a558166cba7599b5d6'' AS "systemId",
                      ID AS "bizKey",
                      CASE WHEN '''||RuleType||''' = ''预警规则'' THEN
                        ''预警消息''
                        WHEN '''||RuleType||''' = ''提醒规则'' THEN
                        ''提醒消息'' END  AS "bizMsgCategory",
                      ''tjSMS,tjWeChat'' AS "msgChannel",
                      '''||Sms_Template||''' AS "smsTemplateid",
                      ''[]'' AS "smsParams",
                      ''无'' AS "mobile",
                      ''400014'' AS "wechatTemplateid",
                      ''[]'' AS "wechatParams",
                      ''无'' AS "wechatJumplinkUrl",
                  '||UseableTemplate||' AS "title",
                  '||UseableTemplate||' AS "bizSourceCategory",
                  10 "portalMsgType",
                  --集团门户网站消息类型（0：待办,1:已办，10：待阅，11:已阅，20：关注）
                  '''||JUMP_URL_DOMAIN||'/pom/middle?originalUrl=''||URL_ENCODE('''||JUMP_URL_DOMAIN||'/pom/mission-center-feedback/my-responsible-task?cancelType=0''||CHR(38)||''id=''||PLAN_ID||CHR(38)||''feedbackNodeId=''||ID||
                  CHR(38) || ''feedbackNodeOriginalId='' || ORIGINAL_NODE_ID || CHR(38) || ''nodeSourcePlanType=1'') "url",
                  '||UseableTemplate||' "taskname",
                  ''计划运营'' "typename",
                  PLAN_TYPE "remark",
                  TO_CHAR(SYSDATE,''yyyy-MM-dd HH:mm:ss'')  "expiretime",
                  1 "priority" --priority 否 Integer 优先级，除关注都有
FROM(
    SELECT A.USER_CODE,B.* FROM(
            SELECT USER_ACCOUNT AS USER_CODE, PROJECT_ID FROM SYS_ROLE_USER_RELATION_RESULT RRESULT WHERE ROLE_TYPE = ''30'' AND ROLE_CODE IN (
               SELECT RECEIVER_ROLE_CODE FROM POM_RULE_RECEIVER WHERE BIZ_ID = '''||ruleId||'''
            )
    )A
    CROSS JOIN
    (
        SELECT
                NODE.ID
              ,NODE.ORIGINAL_NODE_ID
              ,NODE.NODE_NAME
              ,PROJ.PROJECT_NAME
              ,NODE.NODE_LEVEL
              ,PLAN.ID AS PLAN_ID
              ,PROJS.STAGE_FULL_NAME
              ,PROJS.ID AS PROJS_ID
              ,TO_CHAR(SYSDATE, ''yyyy-MM-dd'') AS CURRENT_DATE_STR
              ,TO_CHAR(NODE.PLAN_START_DATE, ''yyyy-MM-dd'') AS PLAN_START_DATE_STR
              ,TO_CHAR(NODE.PLAN_END_DATE, ''yyyy-MM-dd'') AS PLAN_END_DATE_STR
              ,TO_CHAR(NODE.ACTUAL_START_DATE, ''yyyy-MM-dd'') AS ACTUAL_START_DATE_STR
              ,TO_CHAR(NODE.ACTUAL_END_DATE, ''yyyy-MM-dd'') AS ACTUAL_END_DATE_STR
              ,TO_CHAR(NODE.ESTIMATE_END_DATE, ''yyyy-MM-dd'') AS ESTIMATE_END_DATE_STR
              ,FB.APPROVAL_TIME
              ,TO_CHAR(FB.APPROVAL_TIME, ''yyyy-MM-dd'') AS APPROVAL_TIME_STR
              ,PROJ.ID AS PROJ_ID
              ,PLAN.COMPANY_ID
              ,PLAN.PLAN_TYPE
              ,NODE.STANDARD_SCORE
              ,NODE.PLAN_START_DATE AS PLAN_START_DATE
              ,NODE.PLAN_END_DATE AS PLAN_END_DATE
              ,NODE.ACTUAL_START_DATE
              ,NODE.ACTUAL_END_DATE
              ,NODE.ESTIMATE_END_DATE
              ,(SELECT WM_CONCAT(CHARGE_PERSON_ID) FROM POM_NODE_CHARGE_PERSON WHERE NODE_ID = NODE.ID) AS PERSON_IDs
              ,(SELECT WM_CONCAT(CHARGE_PERSON) FROM POM_NODE_CHARGE_PERSON WHERE NODE_ID = NODE.ID) AS PERSON_Names
            FROM POM_PROJ_PLAN_NODE NODE
                     LEFT JOIN POM_PROJ_PLAN PLAN ON NODE.PROJ_PLAN_ID = PLAN.ID
                     LEFT JOIN SYS_PROJECT_STAGE PROJS ON PLAN.PROJ_ID = PROJS.ID
                     LEFT JOIN SYS_PROJECT PROJ ON PROJS.PROJECT_ID = PROJ.ID
                     LEFT JOIN POM_NODE_FEEDBACK FB ON NODE.ID = FB.FEEDBACK_NODE_ID
            WHERE  PROJ.ID IN (
                  SELECT PROJECT_ID FROM SYS_ROLE_USER_RELATION_RESULT RRESULT WHERE ROLE_TYPE = ''30'' AND ROLE_CODE IN (
                      SELECT RECEIVER_ROLE_CODE FROM POM_RULE_RECEIVER WHERE BIZ_ID = '''||ruleId||'''
                      ) GROUP BY PROJECT_ID
                )
              AND NODE.NODE_LEVEL = '''||RuleNodeLevel||'''
              AND NODE.ACTUAL_END_DATE IS NULL
              AND NODE.IS_DISABLE = 0
              AND PLAN.PLAN_TYPE IN (
                SELECT REGEXP_SUBSTR ('''||RulePlanType||''', ''[^,]+'', 1,rownum) from dual
                connect by rownum<=LENGTH ('''||RulePlanType||''') - LENGTH (regexp_replace('''||RulePlanType||''', '','', ''''))+1
              )
              AND PLAN.APPROVAL_STATUS = ''已审核''
    )B           --解析项目级角色接收人
)WHERE  '||UseableRule||'
UNION
    select
                      ''yuzheng1'' AS "senderAccount",
     --发送人usercode如：a-xiexuhua,---门户网站的creatorName
                      USER_CODE AS "recipientAccount",
                      (SELECT APP_ID FROM SYS_APPLICATION WHERE ID = ''71313f018a35f3a558166cba7599b5d6'') AS "appid",
     --应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段---门户网站的sourceAppId
                      ''71313f018a35f3a558166cba7599b5d6'' AS "systemId",
                      ID AS "bizKey",
                      CASE WHEN '''||RuleType||''' = ''预警规则'' THEN
                        ''预警消息''
                        WHEN '''||RuleType||''' = ''提醒规则'' THEN
                        ''提醒消息'' END  AS "bizMsgCategory",
                      ''tjSMS,tjWeChat'' AS "msgChannel",
                      '''||Sms_Template||''' AS "smsTemplateid",
                      CASE WHEN '''||RuleType||''' = ''预警规则'' THEN
                        ''["''||PERSON_Names||''","''||NODE_NAME||''","''||TO_CHAR(TRUNC(SYSDATE)- TRUNC(PLAN_END_DATE))||''",""]''
                        WHEN '''||RuleType||''' = ''提醒规则'' THEN
                        ''["''||PERSON_Names||''","''||NODE_NAME||''","''||TO_CHAR(TRUNC(PLAN_END_DATE)-TRUNC(SYSDATE))||''",""]'' END AS "smsParams",
                      MOBILE_PHONE AS "mobile",
                      ''400014'' AS "wechatTemplateid",
                      CASE WHEN '''||RuleType||''' = ''预警规则'' THEN
                        ''["''||PERSON_Names||''","''||NODE_NAME||''","''||TO_CHAR(TRUNC(SYSDATE)- TRUNC(PLAN_END_DATE))||''",""]''
                        WHEN '''||RuleType||''' = ''提醒规则'' THEN
                        ''["''||PERSON_Names||''","''||NODE_NAME||''","''||TO_CHAR(TRUNC(PLAN_END_DATE)-TRUNC(SYSDATE))||''",""]'' END AS "wechatParams",
                      ''无'' AS "wechatJumplinkUrl",
                  '||UseableTemplate||' AS "title",
                  '||UseableTemplate||' AS "bizSourceCategory",
                  0 "portalMsgType",
                  --集团门户网站消息类型（0：待办,1:已办，10：待阅，11:已阅，20：关注）
                  '''||JUMP_URL_DOMAIN||'/pom/middle?originalUrl=''||URL_ENCODE('''||JUMP_URL_DOMAIN||'/pom/mission-center-feedback/my-responsible-task?cancelType=0''||CHR(38)||''id=''||PLAN_ID||CHR(38)||''feedbackNodeId=''||ID||
                  CHR(38) || ''feedbackNodeOriginalId='' || ORIGINAL_NODE_ID || CHR(38) || ''nodeSourcePlanType=1'') "url",
                  '||UseableTemplate||' "taskname",
                  ''计划运营'' "typename",
                  PLAN_TYPE "remark",
                  TO_CHAR(SYSDATE,''yyyy-MM-dd HH:mm:ss'')  "expiretime",
                  1 "priority" --priority 否 Integer 优先级，除关注都有
FROM
        (
            SELECT * FROM (
                SELECT
                      NODE.ID
                     ,NODE.ORIGINAL_NODE_ID
                     ,NODE.NODE_NAME
                     ,PROJ.PROJECT_NAME
                     ,NODE.NODE_LEVEL
                     ,TO_CHAR(FB.APPROVAL_TIME, ''yyyy-MM-dd'') AS APPROVAL_TIME_STR
                     ,PLAN.ID AS PLAN_ID
                     ,PROJS.STAGE_FULL_NAME
                     ,PROJS.ID AS PROJS_ID
                     ,TO_CHAR(SYSDATE, ''yyyy-MM-dd'') AS CURRENT_DATE_STR
                     ,TO_CHAR(NODE.PLAN_START_DATE, ''yyyy-MM-dd'') AS PLAN_START_DATE_STR
                     ,TO_CHAR(NODE.PLAN_END_DATE, ''yyyy-MM-dd'') AS PLAN_END_DATE_STR
                     ,TO_CHAR(NODE.ACTUAL_START_DATE, ''yyyy-MM-dd'') AS ACTUAL_START_DATE_STR
                     ,TO_CHAR(NODE.ACTUAL_END_DATE, ''yyyy-MM-dd'') AS ACTUAL_END_DATE_STR
                     ,TO_CHAR(NODE.ESTIMATE_END_DATE, ''yyyy-MM-dd'') AS ESTIMATE_END_DATE_STR
                     ,FB.APPROVAL_TIME
                     ,PLAN.COMPANY_ID
                     ,PLAN.PLAN_TYPE
                     ,PLAN.PLAN_NAME
                     ,SUSER.USER_CODE
                     ,SUSER.MOBILE_PHONE
                     ,NODE.PLAN_START_DATE AS PLAN_START_DATE
                     ,NODE.PLAN_END_DATE AS PLAN_END_DATE
                     ,NODE.ACTUAL_START_DATE
                     ,NODE.ACTUAL_END_DATE
                     ,NODE.ESTIMATE_END_DATE
                     ,NODE.STANDARD_SCORE
                     ,CHARGE_PERSON_ID AS PERSON_IDs
                     ,CHARGE_PERSON AS PERSON_Names
                FROM POM_PROJ_PLAN_NODE NODE
                         LEFT JOIN POM_PROJ_PLAN PLAN ON NODE.PROJ_PLAN_ID = PLAN.ID
                         LEFT JOIN SYS_PROJECT_STAGE PROJS ON PLAN.PROJ_ID = PROJS.ID
                         LEFT JOIN SYS_PROJECT PROJ ON PROJS.PROJECT_ID = PROJ.ID
                         LEFT JOIN POM_NODE_CHARGE_PERSON PERSON ON NODE.ID = PERSON.NODE_ID
                         LEFT JOIN SYS_USER SUSER ON PERSON.CHARGE_PERSON_ID = SUSER.ID
                         LEFT JOIN POM_NODE_FEEDBACK FB ON NODE.ID = FB.FEEDBACK_NODE_ID
                WHERE PROJ.ID IN (                           SELECT REGEXP_SUBSTR ('''||UseableProjIds||''', ''[^,]+'', 1,rownum) from dual connect by rownum<=LENGTH ('''||UseableProjIds||''') - LENGTH (regexp_replace('''||UseableProjIds||''', '','', ''''))+1
                              )
                              AND NODE.NODE_LEVEL = '''||RuleNodeLevel||'''
                              AND PLAN.PLAN_TYPE IN (
                                SELECT REGEXP_SUBSTR ('''||RulePlanType||''', ''[^,]+'', 1,rownum) from dual
                                connect by rownum<=LENGTH ('''||RulePlanType||''') - LENGTH (regexp_replace('''||RulePlanType||''', '','', ''''))+1
                              )
                              AND PLAN.APPROVAL_STATUS = ''已审核''
                              AND NODE.PLAN_END_DATE IS NOT NULL
                              AND NODE.ACTUAL_END_DATE IS NULL
                              AND NODE.IS_DISABLE = 0
                 ) b
            )WHERE  '||UseableRule||' )  --待办
    ';

    OPEN info FOR v_sql_exec;
END p_pom_warning_rules_msg;

/
--------------------------------------------------------
--  DDL for Procedure P_SWM_BLOC_SUPPLY_MONITOR
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SWM_BLOC_SUPPLY_MONITOR" (userid IN VARCHAR2, --当前用户id
                                                   stationid IN VARCHAR2, --当前用户岗位id
                                                   departmentid IN VARCHAR2, --当前用户部门id
                                                   companyid IN VARCHAR2, --当前用户公司id
                                                   unitid IN VARCHAR2, --选择公司id
                                                   parentId IN VARCHAR2, --选择父级id
                                                   excel IN VARCHAR2, --是否是导出EXCEL
                                                   info OUT SYS_REFCURSOR--返回结果
) AS
    --《货值管理系统》供货情况监控
--作者：chenl
--日期：2020/12/10
    data_auth_spid VARCHAR2(200);
    bizcode        VARCHAR2(200);
    unitid_val     VARCHAR2(200);
    sql_str clob;
BEGIN
    OPEN  info for 
				

SELECT 




"PROJ_ID"
,"OBJ_TYPE"
,"OBJ_ID"
,"OBJ_NAME"
,"OBJ_PARENT_ID"
,"LEVEL"
,"LEVEL_ORDER"
,"ORDER_CODE"
,"COMPANY_NAME"
,"COMPANY_ID"
,"COMPANY_ORDER_HIERARCHY_CODE"
,"id"
,"projConstitute"
,"parentId"
,"ORDER_HIERARCHY_CODE"
,"objId"
,"objType"
,"buildProductTypeName"
,"ownBuildProductTypeId"
,"buildProductTypeId"

,SUM(NVL("thisYearSupplyAmount",0)) AS "thisYearSupplyAmount"
,SUM(NVL("thisYearSupplyNumber",0)) AS "thisYearSupplyNumber"
,SUM(NVL("thisYearSupplyArea",0)) AS "thisYearSupplyArea"
,SUM(NVL("firstSeasonSupplyAmount",0)) AS "firstSeasonSupplyAmount"
,SUM(NVL("firstSeasonSupplyNumber",0)) AS "firstSeasonSupplyNumber"
,SUM(NVL("firstSeasonSupplyArea",0)) AS "firstSeasonSupplyArea"
,SUM(NVL("januarySupplyAmount",0)) AS "januarySupplyAmount"
,SUM(NVL("januarySupplyNumberx",0)) AS "januarySupplyNumberx"
,SUM(NVL("januarySupplyNumber",0)) AS "januarySupplyNumber"
,SUM(NVL("februarySupplyAmount",0)) AS "februarySupplyAmount"
,SUM(NVL("februarySupplyNumber",0)) AS "februarySupplyNumber"
,SUM(NVL("februarySupplyArea",0)) AS "februarySupplyArea"
,SUM(NVL("marchSupplyAmount",0)) AS "marchSupplyAmount"
,SUM(NVL("marchSupplyNumber",0)) AS "marchSupplyNumber"
,SUM(NVL("marchSupplyArea",0)) AS "marchSupplyArea"
,SUM(NVL("secondSeasonSupplyAmount",0)) AS "secondSeasonSupplyAmount"
,SUM(NVL("secondSeasonSupplyNumber",0)) AS "secondSeasonSupplyNumber"
,SUM(NVL("secondSeasonSupplyArea",0)) AS "secondSeasonSupplyArea"
,SUM(NVL("aprilSupplyAmount",0)) AS "aprilSupplyAmount"
,SUM(NVL("aprilSupplyNumber",0)) AS "aprilSupplyNumber"
,SUM(NVL("aprilSupplyArea",0)) AS "aprilSupplyArea"
,SUM(NVL("maySupplyAmount",0)) AS "maySupplyAmount"
,SUM(NVL("maySupplyNumber",0)) AS "maySupplyNumber"
,SUM(NVL("maySupplyArea",0)) AS "maySupplyArea"
,SUM(NVL("juneSupplyAmount",0)) AS "juneSupplyAmount"
,SUM(NVL("juneSupplyNumber",0)) AS "juneSupplyNumber"
,SUM(NVL("juneSupplyArea",0)) AS "juneSupplyArea"
,SUM(NVL("thirdSeasonSupplyAmount",0)) AS "thirdSeasonSupplyAmount"
,SUM(NVL("thirdSeasonSupplyNumber",0)) AS "thirdSeasonSupplyNumber"
,SUM(NVL("thirdSeasonSupplyArea",0)) AS "thirdSeasonSupplyArea"
,SUM(NVL("julySupplyAmount",0)) AS "julySupplyAmount"
,SUM(NVL("julySupplyNumber",0)) AS "julySupplyNumber"
,SUM(NVL("julySupplyArea",0)) AS "julySupplyArea"
,SUM(NVL("augustSupplyAmount",0)) AS "augustSupplyAmount"
,SUM(NVL("augustSupplyNumber",0)) AS "augustSupplyNumber"
,SUM(NVL("augustSupplyArea",0)) AS "augustSupplyArea"
,SUM(NVL("septemberSupplyAmount",0)) AS "septemberSupplyAmount"
,SUM(NVL("septemberSupplyNumber",0)) AS "septemberSupplyNumber"
,SUM(NVL("septemberSupplyArea",0)) AS "septemberSupplyArea"
,SUM(NVL("fourthSeasonSupplyAmount",0)) AS "fourthSeasonSupplyAmount"
,SUM(NVL("fourthSeasonSupplyNumber",0)) AS "fourthSeasonSupplyNumber"
,SUM(NVL("fourthSeasonSupplyArea",0)) AS "fourthSeasonSupplyArea"
,SUM(NVL("octoberSupplyAmount",0)) AS "octoberSupplyAmount"
,SUM(NVL("octoberSupplyNumber",0)) AS "octoberSupplyNumber"
,SUM(NVL("octoberSupplyArea",0)) AS "octoberSupplyArea"
,SUM(NVL("novemberSupplyAmount",0)) AS "novemberSupplyAmount"
,SUM(NVL("novemberSupplyNumber",0)) AS "novemberSupplyNumber"
,SUM(NVL("novemberSupplyArea",0)) AS "novemberSupplyArea"
,SUM(NVL("decemberSupplyAmount",0)) AS "decemberSupplyAmount"
,SUM(NVL("decemberSupplyNumber",0)) AS "decemberSupplyNumber"
,SUM(NVL("decemberSupplyArea",0)) AS "decemberSupplyArea"
,SUM(NVL("poTotalSaleCount",0)) AS "poTotalSaleCount"
,SUM(NVL("poTotalSaleArea",0)) AS "poTotalSaleArea"
,SUM(NVL("poTotalSaleAmount",0))/10000 AS "poTotalSaleAmount"
,SUM(NVL("rpTotalArea",0)) AS "rpTotalArea"
,SUM(NVL("rpTotalAmount",0))/10000 AS "rpTotalAmount"
,SUM(NVL("rpTotalCount",0)) AS "rpTotalCount"
,SUM(NVL("poSaleArea",0)) AS "poSaleArea"
,SUM(NVL("poSaleAmount",0))/10000 AS "poSaleAmount"
,SUM(NVL("poSaleCount",0)) AS "poSaleCount"
,SUM(NVL("rpSurplusArea",0)) AS "rpSurplusArea"
,SUM(NVL("rpSurplusAmount",0))/10000 AS "rpSurplusAmount"
,SUM(NVL("rpSurplusCount",0)) AS "rpSurplusCount"
,SUM(NVL("poSurplusSaleAmount",0))/10000 AS "poSurplusSaleAmount"
,SUM(NVL("poSurplusSaleArea",0)) AS "poSurplusSaleArea"
,SUM(NVL("poSurplusSaleCount",0)) AS "poSurplusSaleCount"
,SUM(NVL("thisYearActualSupplyArea",0)) AS "thisYearActualSupplyArea"
,SUM(NVL("thisYearActualSupplyNumber",0)) AS "thisYearActualSupplyNumber"
,SUM(NVL("thisYearActualSupplyAmount",0))/10000 AS "thisYearActualSupplyAmount"
,SUM(NVL("firstSeasonActualSupplyArea",0)) AS "firstSeasonActualSupplyArea"
,SUM(NVL("firstSeasonActualSupplyNumber",0)) AS "firstSeasonActualSupplyNumber"
,SUM(NVL("firstSeasonActualSupplyAmount",0))/10000 AS "firstSeasonActualSupplyAmount"
,SUM(NVL("secondSeasonActualSupplyArea",0)) AS "secondSeasonActualSupplyArea"
,SUM(NVL("secondSeasonActualSupplyNumber",0)) AS "secondSeasonActualSupplyNumber"
,SUM(NVL("secondSeasonActualSupplyAmount",0))/10000 AS "secondSeasonActualSupplyAmount"
,SUM(NVL("thirdSeasonActualSupplyArea",0)) AS "thirdSeasonActualSupplyArea"
,SUM(NVL("thirdSeasonActualSupplyNumber",0)) AS "thirdSeasonActualSupplyNumber"
,SUM(NVL("thirdSeasonActualSupplyAmount",0))/10000 AS "thirdSeasonActualSupplyAmount"
,SUM(NVL("fourthSeasonActualSupplyArea",0)) AS "fourthSeasonActualSupplyArea"
,SUM(NVL("fourthSeasonActualSupplyNumber",0)) AS "fourthSeasonActualSupplyNumber"
,SUM(NVL("fourthSeasonActualSupplyAmount",0))/10000 AS "fourthSeasonActualSupplyAmount"
,SUM(NVL("januaryActualSupplyArea",0)) AS "januaryActualSupplyArea"
,SUM(NVL("januaryActualSupplyNumber",0)) AS "januaryActualSupplyNumber"
,SUM(NVL("januaryActualSupplyAmount",0))/10000 AS "januaryActualSupplyAmount"
,SUM(NVL("februaryActualSupplyArea",0)) AS "februaryActualSupplyArea"
,SUM(NVL("februaryActualSupplyNumber",0)) AS "februaryActualSupplyNumber"
,SUM(NVL("februaryActualSupplyAmount",0))/10000 AS "februaryActualSupplyAmount"
,SUM(NVL("marchActualSupplyArea",0)) AS "marchActualSupplyArea"
,SUM(NVL("marchActualSupplyNumber",0)) AS "marchActualSupplyNumber"
,SUM(NVL("marchActualSupplyAmount",0))/10000 AS "marchActualSupplyAmount"
,SUM(NVL("aprilActualSupplyArea",0)) AS "aprilActualSupplyArea"
,SUM(NVL("aprilActualSupplyNumber",0)) AS "aprilActualSupplyNumber"
,SUM(NVL("aprilActualSupplyAmount",0))/10000 AS "aprilActualSupplyAmount"
,SUM(NVL("mayActualSupplyArea",0)) AS "mayActualSupplyArea"
,SUM(NVL("mayActualSupplyNumber",0)) AS "mayActualSupplyNumber"
,SUM(NVL("mayActualSupplyAmount",0))/10000 AS "mayActualSupplyAmount"
,SUM(NVL("juneActualSupplyArea",0)) AS "juneActualSupplyArea"
,SUM(NVL("juneActualSupplyNumber",0)) AS "juneActualSupplyNumber"
,SUM(NVL("juneActualSupplyAmount",0))/10000 AS "juneActualSupplyAmount"
,SUM(NVL("julyActualSupplyArea",0)) AS "julyActualSupplyArea"
,SUM(NVL("julyActualSupplyNumber",0)) AS "julyActualSupplyNumber"
,SUM(NVL("julyActualSupplyAmount",0))/10000 AS "julyActualSupplyAmount"
,SUM(NVL("augustActualSupplyArea",0)) AS "augustActualSupplyArea"
,SUM(NVL("augustActualSupplyNumber",0)) AS "augustActualSupplyNumber"
,SUM(NVL("augustActualSupplyAmount",0))/10000 AS "augustActualSupplyAmount"
,SUM(NVL("septemberActualSupplyArea",0)) AS "septemberActualSupplyArea"
,SUM(NVL("septemberActualSupplyNumber",0)) AS "septemberActualSupplyNumber"
,SUM(NVL("septemberActualSupplyAmount",0))/10000 AS "septemberActualSupplyAmount"
,SUM(NVL("octoberActualSupplyArea",0)) AS "octoberActualSupplyArea"
,SUM(NVL("octoberActualSupplyNumber",0)) AS "octoberActualSupplyNumber"
,SUM(NVL("octoberActualSupplyAmount",0))/10000 AS "octoberActualSupplyAmount"
,SUM(NVL("novemberActualSupplyArea",0)) AS "novemberActualSupplyArea"
,SUM(NVL("novemberActualSupplyNumber",0)) AS "novemberActualSupplyNumber"
,SUM(NVL("novemberActualSupplyAmount",0))/10000 AS "novemberActualSupplyAmount"
,SUM(NVL("decemberActualSupplyArea",0)) AS "decemberActualSupplyArea"
,SUM(NVL("decemberActualSupplyNumber",0)) AS "decemberActualSupplyNumber"
,SUM(NVL("decemberActualSupplyAmount",0))/10000 AS "decemberActualSupplyAmount"
,SUM(NVL("thisYearSellArea",0)) AS "thisYearSellArea"
,SUM(NVL("thisYearSellNumber",0)) AS "thisYearSellNumber"
,SUM(NVL("thisYearSellAmount",0))/10000 AS "thisYearSellAmount"
,SUM(NVL("firstSellArea",0)) AS "firstSellArea"
,SUM(NVL("firstSellNumber",0)) AS "firstSellNumber"
,SUM(NVL("firstSellAmount",0))/10000 AS "firstSellAmount"
,SUM(NVL("secondSeasonSellArea",0)) AS "secondSeasonSellArea"
,SUM(NVL("secondSeasonSellNumber",0)) AS "secondSeasonSellNumber"
,SUM(NVL("secondSeasonSellAmount",0))/10000 AS "secondSeasonSellAmount"
,SUM(NVL("thirdSeasonSellArea",0)) AS "thirdSeasonSellArea"
,SUM(NVL("thirdSeasonSellNumber",0)) AS "thirdSeasonSellNumber"
,SUM(NVL("thirdSeasonSellAmount",0))/10000 AS "thirdSeasonSellAmount"
,SUM(NVL("fourthSeasonSellArea",0)) AS "fourthSeasonSellArea"
,SUM(NVL("fourthSeasonSellNumber",0)) AS "fourthSeasonSellNumber"
,SUM(NVL("fourthSeasonSellAmount",0))/10000 AS "fourthSeasonSellAmount"
,SUM(NVL("januarySellArea",0)) AS "januarySellArea"
,SUM(NVL("januarySellNumber",0)) AS "januarySellNumber"
,SUM(NVL("januarySellAmount",0))/10000 AS "januarySellAmount"
,SUM(NVL("februarySellArea",0)) AS "februarySellArea"
,SUM(NVL("februarySellNumber",0)) AS "februarySellNumber"
,SUM(NVL("februarySellAmount",0))/10000 AS "februarySellAmount"
,SUM(NVL("marchSellArea",0)) AS "marchSellArea"
,SUM(NVL("marchSellNumber",0)) AS "marchSellNumber"
,SUM(NVL("marchSellAmount",0))/10000 AS "marchSellAmount"
,SUM(NVL("aprilSellArea",0)) AS "aprilSellArea"
,SUM(NVL("aprilSellNumber",0)) AS "aprilSellNumber"
,SUM(NVL("aprilSellAmount",0))/10000 AS "aprilSellAmount"
,SUM(NVL("maySellArea",0)) AS "maySellArea"
,SUM(NVL("maySellNumber",0)) AS "maySellNumber"
,SUM(NVL("maySellAmount",0))/10000 AS "maySellAmount"
,SUM(NVL("juneSellArea",0)) AS "juneSellArea"
,SUM(NVL("juneSellNumber",0)) AS "juneSellNumber"
,SUM(NVL("juneSellAmount",0))/10000 AS "juneSellAmount"
,SUM(NVL("julySellArea",0)) AS "julySellArea"
,SUM(NVL("julySellNumber",0)) AS "julySellNumber"
,SUM(NVL("julySellAmount",0))/10000 AS "julySellAmount"
,SUM(NVL("augustSellArea",0)) AS "augustSellArea"
,SUM(NVL("augustSellNumber",0)) AS "augustSellNumber"
,SUM(NVL("augustSellAmount",0))/10000 AS "augustSellAmount"
,SUM(NVL("septemberSellArea",0)) AS "septemberSellArea"
,SUM(NVL("septemberSellNumber",0)) AS "septemberSellNumber"
,SUM(NVL("septemberSellAmount",0))/10000 AS "septemberSellAmount"
,SUM(NVL("octoberSellArea",0)) AS "octoberSellArea"
,SUM(NVL("octoberSellNumber",0)) AS "octoberSellNumber"
,SUM(NVL("octoberSellAmount",0))/10000 AS "octoberSellAmount"
,SUM(NVL("novemberSellArea",0)) AS "novemberSellArea"
,SUM(NVL("novemberSellNumber",0)) AS "novemberSellNumber"
,SUM(NVL("novemberSellAmount",0))/10000 AS "novemberSellAmount"
,SUM(NVL("decemberSellArea",0)) AS "decemberSellArea"
,SUM(NVL("decemberSellNumber",0)) AS "decemberSellNumber"
,SUM(NVL("decemberSellAmount",0))/10000 AS "decemberSellAmount"
,SUM(NVL("thisYearSellPlannedAmount",0))  AS "thisYearSellPlannedAmount"--金额（年计划销售）
,SUM(NVL("thisYearSellPlannedNumber",0))  AS "thisYearSellPlannedNumber"--套数（年计划销售）
,SUM(NVL("thisYearSellPlannedArea",0))  AS "thisYearSellPlannedArea"--面积（年计划销售）
,SUM(NVL("firstSeonSellPlannedAmount",0))  AS "firstSeonSellPlannedAmount"--金额（1季度计划销售）
,SUM(NVL("firstSeonSellPlannedNumber",0))  AS "firstSeonSellPlannedNumber"--套数（1季度计划销售）
,SUM(NVL("firstSeonSellPlannedArea",0))  AS "firstSeonSellPlannedArea"--面积（1季度计划销售）
,SUM(NVL("secondSeonSellPlannedAmount",0))  AS "secondSeonSellPlannedAmount"--金额（2季度计划销售）
,SUM(NVL("secondSeonSellPlannedNumber",0))  AS "secondSeonSellPlannedNumber"--套数（2季度计划销售）
,SUM(NVL("secondSeonSellPlannedArea",0))  AS "secondSeonSellPlannedArea"--面积（2季度计划销售）
,SUM(NVL("thirdSeonSellPlannedAmount",0))  AS "thirdSeonSellPlannedAmount"--金额（3季度计划销售）
,SUM(NVL("thirdSeonSellPlannedNumber",0))  AS "thirdSeonSellPlannedNumber"--套数（3季度计划销售）
,SUM(NVL("thirdSeonSellPlannedArea",0))  AS "thirdSeonSellPlannedArea"--面积（3季度计划销售）
,SUM(NVL("fourthSeonSellPlannedAmount",0))  AS "fourthSeonSellPlannedAmount"--金额（4季度计划销售）
,SUM(NVL("fourthSeonSellPlannedNumber",0))  AS "fourthSeonSellPlannedNumber"--套数（4季度计划销售）
,SUM(NVL("fourthSeonSellPlannedArea",0))  AS "fourthSeonSellPlannedArea"--面积（4季度计划销售）
,SUM(NVL("januarySellPlannedAmount",0))  AS "januarySellPlannedAmount"--金额（1月计划销售）
,SUM(NVL("januarySellPlannedNumber",0))  AS "januarySellPlannedNumber"--套数（1月计划销售）
,SUM(NVL("januarySellPlannedArea",0))  AS "januarySellPlannedArea"--面积（1月计划销售）
,SUM(NVL("februarySellPlannedAmount",0))  AS "februarySellPlannedAmount"--金额（2月计划销售）
,SUM(NVL("februarySellPlannedNumber",0))  AS "februarySellPlannedNumber"--套数（2月计划销售）
,SUM(NVL("februarySellPlannedArea",0))  AS "februarySellPlannedArea"--面积（2月计划销售）
,SUM(NVL("marchSellPlannedAmount",0))  AS "marchSellPlannedAmount"--金额（3月计划销售）
,SUM(NVL("marchSellPlannedNumber",0))  AS "marchSellPlannedNumber"--套数（3月计划销售）
,SUM(NVL("marchSellPlannedArea",0))  AS "marchSellPlannedArea"--面积（3月计划销售）
,SUM(NVL("aprilSellPlannedAmount",0))  AS "aprilSellPlannedAmount"--金额（4月计划销售）
,SUM(NVL("aprilSellPlannedNumber",0))  AS "aprilSellPlannedNumber"--套数（4月计划销售）
,SUM(NVL("aprilSellPlannedArea",0))  AS "aprilSellPlannedArea"--面积（4月计划销售）
,SUM(NVL("maySellPlannedAmount",0))  AS "maySellPlannedAmount"--金额（5月计划销售）
,SUM(NVL("maySellPlannedNumber",0))  AS "maySellPlannedNumber"--套数（5月计划销售）
,SUM(NVL("maySellPlannedArea",0))  AS "maySellPlannedArea"--面积（5月计划销售）
,SUM(NVL("juneSellPlannedAmount",0))  AS "juneSellPlannedAmount"--金额（6月计划销售）
,SUM(NVL("juneSellPlannedNumber",0))  AS "juneSellPlannedNumber"--套数（6月计划销售）
,SUM(NVL("juneSellPlannedArea",0))  AS "juneSellPlannedArea"--面积（6月计划销售）
,SUM(NVL("julySellPlannedAmount",0))  AS "julySellPlannedAmount"--金额（7月计划销售）
,SUM(NVL("julySellPlannedNumber",0))  AS "julySellPlannedNumber"--套数（7月计划销售）
,SUM(NVL("julySellPlannedArea",0))  AS "julySellPlannedArea"--面积（7月计划销售）
,SUM(NVL("augustSellPlannedAmount",0))  AS "augustSellPlannedAmount"--金额（8月计划销售）
,SUM(NVL("augustSellPlannedNumber",0))  AS "augustSellPlannedNumber"--套数（8月计划销售）
,SUM(NVL("augustSellPlannedArea",0))  AS "augustSellPlannedArea"--面积（8月计划销售）
,SUM(NVL("septemberSellPlannedAmount",0))  AS "septemberSellPlannedAmount"--金额（10月计划销售）
,SUM(NVL("septemberSellPlannedNumber",0))  AS "septemberSellPlannedNumber"--套数（10月计划销售）
,SUM(NVL("septemberSellPlannedArea",0))  AS "septemberSellPlannedArea"--面积（10月计划销售）
,SUM(NVL("octoberSellPlannedAmount",0))  AS "octoberSellPlannedAmount"--金额（10月计划销售）
,SUM(NVL("octoberSellPlannedNumber",0))  AS "octoberSellPlannedNumber"--套数（10月计划销售）
,SUM(NVL("octoberSellPlannedArea",0))  AS "octoberSellPlannedArea"--面积（10月计划销售）
,SUM(NVL("novemberSellPlannedAmount",0))  AS "novemberSellPlannedAmount"--金额（11月计划销售）
,SUM(NVL("novemberSellPlannedNumber",0))  AS "novemberSellPlannedNumber"--套数（11月计划销售）
,SUM(NVL("novemberSellPlannedArea",0))  AS "novemberSellPlannedArea"--面积（11月计划销售）
,SUM(NVL("decemberSellPlannedAmount",0))  AS "decemberSellPlannedAmount"--金额（12月计划销售）
,SUM(NVL("decemberSellPlannedNumber",0))  AS "decemberSellPlannedNumber"--套数（12月计划销售）
,SUM(NVL("decemberSellPlannedArea",0))  AS "decemberSellPlannedArea"--面积（12月计划销售）


 FROM  SWM_BLOC_SUPPLY_MONITOR_LIST LIST
		 --WHERE "thisYearSupplyAmount">0
		 WHERE 
		 --根据筛选条件过滤公司
		 "objId" IN (
	SELECT 	"objId"  FROM SWM_BLOC_SUPPLY_MONITOR_LIST  	LIST	

	START WITH LIST."parentId"=unitid
		CONNECT BY PRIOR LIST."objId"=LIST."parentId"
		 )
		 		 --过滤无分期
		 AND  "objId" NOT  IN (
	SELECT 	"objId"  FROM SWM_BLOC_SUPPLY_MONITOR_LIST  	LIST	

	START WITH "projConstitute"  LIKE '%无分期%'
		CONNECT BY PRIOR LIST."objId"= LIST."parentId"
		 )
		 


 GROUP BY "PROJ_ID"
,"OBJ_TYPE"
,"OBJ_ID"
,"OBJ_NAME"
,"OBJ_PARENT_ID"
,"LEVEL"
,"LEVEL_ORDER"
,"ORDER_CODE"
,"COMPANY_NAME"
,"COMPANY_ID"
,"COMPANY_ORDER_HIERARCHY_CODE"
,"id"
,"projConstitute"
,"parentId"
,"ORDER_HIERARCHY_CODE"
,"objId"
,"objType"
,"buildProductTypeName"
,"ownBuildProductTypeId"
,"buildProductTypeId"
 ORDER BY "COMPANY_ORDER_HIERARCHY_CODE","ORDER_CODE"
 ;
  --AND P1.PROJECT_ID=P2.PROJ_ID 


END P_SWM_BLOC_SUPPLY_MONITOR;

/
--------------------------------------------------------
--  DDL for Procedure P_SWM_DT_VAL_BY_SUPPLY_PLAN
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SWM_DT_VAL_BY_SUPPLY_PLAN" ( 
projectId IN VARCHAR2 ,
planYear in number,
p_spid OUT VARCHAR2) 
AS
spid VARCHAR2(36) :=get_uuid();--使用临时表的批次号
ROWCNT NUMBER:=0;
Begin
p_spid:=spid;
--判断是否存在最新的已经发布的供货节点计划
select count (1) INTO ROWCNT from SWM_SUPPLY_NODE_PLAN 
where project_id=projectId and extract( year from PLAN_YEAR ) <planYear  and RELEASE_STATUS='已发布';
IF ROWCNT<>0 THEN
    delete TMP_DT_VAL_BY_SUPPLY_PLAN_DTL WHERE  SPID=spid;
    --判断供货节点的计划明细数据的
    insert into TMP_DT_VAL_BY_SUPPLY_PLAN_DTL
    select  SWM_YE_VALUE_INVENTORY_DTL.biz_id,
     SWM_YE_VALUE_INVENTORY_DTL.BIZ_PARENT_ID,
     SWM_YE_VALUE_INVENTORY_DTL.OBJ_TYPE,
      SWM_YE_VALUE_INVENTORY_DTL.OBJ_id,
     SWM_YE_VALUE_INVENTORY_DTL.OBJ_NAME,
     SWM_YE_VALUE_INVENTORY_DTL.OWN_BUILD_PRODUCT_TYPE_ID,
    SWM_YE_VALUE_INVENTORY_DTL.PO_TOTAL_SALE_AREA  supply_area,
    SWM_YE_VALUE_INVENTORY_DTL.PO_TOTAL_SALE_COUNT  supply_count,
    SWM_YE_VALUE_INVENTORY_DTL.PO_TOTAL_SALE_AVERAGE_AMOUNT  average_amount,
    SWM_YE_VALUE_INVENTORY_DTL.PO_TOTAL_SALE_AMOUNT  sale_amount,
    spid
    from 
    SWM_YE_VALUE_INVENTORY_DTL left join ( select*from SWM_SUPPLY_PLAN_DTL where SUPPLY_NODE_PLAN_ID=
    (select ID from( select * from SWM_SUPPLY_NODE_PLAN where project_id=projectId and  extract( year from PLAN_YEAR ) < planYear and RELEASE_STATUS='已发布'
    order by PERIOD_CODE desc)tab where rownum=1)) supplynode on SWM_YE_VALUE_INVENTORY_DTL.biz_id=supplynode.biz_id 
    where supplynode.biz_id is not null and  extract( year from supplynode.SUPPLY_MONTH ) = planYear
    union
    select  SWM_YE_VALUE_INVENTORY_DTL.biz_id,
     SWM_YE_VALUE_INVENTORY_DTL.BIZ_PARENT_ID,
     SWM_YE_VALUE_INVENTORY_DTL.OBJ_TYPE,
     SWM_YE_VALUE_INVENTORY_DTL.OBJ_id,
     SWM_YE_VALUE_INVENTORY_DTL.OBJ_NAME,
     SWM_YE_VALUE_INVENTORY_DTL.OWN_BUILD_PRODUCT_TYPE_ID,
    0  supply_area,
    0  supply_count,
    0 average_amount,
    0  sale_amount,
    spid
    from 
    SWM_YE_VALUE_INVENTORY_DTL left join ( select*from SWM_SUPPLY_PLAN_DTL where SUPPLY_NODE_PLAN_ID=
    (select ID from( select * from SWM_SUPPLY_NODE_PLAN where project_id=projectId and  extract( year from PLAN_YEAR ) < planYear  and RELEASE_STATUS='已发布'
    order by PERIOD_CODE desc)tab where rownum=1)) supplynode on SWM_YE_VALUE_INVENTORY_DTL.biz_id=supplynode.biz_id 
    where supplynode.biz_id is not null and  supplynode.obj_type in ('楼栋','业态')   and (extract( year from supplynode.SUPPLY_MONTH ) <> planYear or supplynode.SUPPLY_MONTH is null ) ;

    insert into TMP_DT_VAL_BY_SUPPLY_PLAN_DTL
    select  SWM_YE_VALUE_INVENTORY_DTL.biz_id,
    SWM_YE_VALUE_INVENTORY_DTL.BIZ_PARENT_ID,
     SWM_YE_VALUE_INVENTORY_DTL.OBJ_TYPE,
      SWM_YE_VALUE_INVENTORY_DTL.OBJ_id,
     SWM_YE_VALUE_INVENTORY_DTL.OBJ_NAME,
     SWM_YE_VALUE_INVENTORY_DTL.OWN_BUILD_PRODUCT_TYPE_ID,
     (select sum(SUPPLY_TOTAL_AREA) from TMP_DT_VAL_BY_SUPPLY_PLAN_DTL where SPID =spid )  SUPPLY_TOTAL_AREA,
    (select sum(SUPPLY_TOTAL_NUMBER) from TMP_DT_VAL_BY_SUPPLY_PLAN_DTL where SPID =spid )  SUPPLY_TOTAL_NUMBER,
    0 SUPPLY_AVERAGE_AMOUNT,
    (select sum(SUPPLY_TOTAL_AMOUNT) from TMP_DT_VAL_BY_SUPPLY_PLAN_DTL where SPID =spid ) SUPPLY_TOTAL_AMOUNT,
    spid
    from 
    SWM_YE_VALUE_INVENTORY_DTL left join SWM_YE_VALUE_INVENTORY on SWM_YE_VALUE_INVENTORY.id=SWM_YE_VALUE_INVENTORY_DTL.YE_VALUE_INVENTORY_ID
    where extract( year from SWM_YE_VALUE_INVENTORY.year ) =planYear and SWM_YE_VALUE_INVENTORY.project_id=projectId and 
    SWM_YE_VALUE_INVENTORY_DTL.obj_type='项目';


    insert into TMP_DT_VAL_BY_SUPPLY_PLAN_DTL
    select  SWM_YE_VALUE_INVENTORY_DTL.biz_id,
      SWM_YE_VALUE_INVENTORY_DTL.BIZ_PARENT_ID,
     SWM_YE_VALUE_INVENTORY_DTL.OBJ_TYPE,
      SWM_YE_VALUE_INVENTORY_DTL.OBJ_id,
     SWM_YE_VALUE_INVENTORY_DTL.OBJ_NAME,
     SWM_YE_VALUE_INVENTORY_DTL.OWN_BUILD_PRODUCT_TYPE_ID,
     (select sum(SUPPLY_TOTAL_AREA) from TMP_DT_VAL_BY_SUPPLY_PLAN_DTL where SPID =spid and BIZ_PARENT_ID=SWM_YE_VALUE_INVENTORY_DTL.BIZ_ID)  SUPPLY_TOTAL_AREA,
    (select sum(SUPPLY_TOTAL_NUMBER) from TMP_DT_VAL_BY_SUPPLY_PLAN_DTL where SPID =spid and BIZ_PARENT_ID=SWM_YE_VALUE_INVENTORY_DTL.BIZ_ID)  SUPPLY_TOTAL_NUMBER,
    0 SUPPLY_AVERAGE_AMOUNT,
    (select sum(SUPPLY_TOTAL_AMOUNT) from TMP_DT_VAL_BY_SUPPLY_PLAN_DTL where SPID =spid and BIZ_PARENT_ID=SWM_YE_VALUE_INVENTORY_DTL.BIZ_ID) SUPPLY_TOTAL_AMOUNT,
    spid
    from 
    SWM_YE_VALUE_INVENTORY_DTL left join SWM_YE_VALUE_INVENTORY on SWM_YE_VALUE_INVENTORY.id=SWM_YE_VALUE_INVENTORY_DTL.YE_VALUE_INVENTORY_ID
    where extract( year from SWM_YE_VALUE_INVENTORY.year ) =planYear and SWM_YE_VALUE_INVENTORY.project_id=projectId and 
    (SWM_YE_VALUE_INVENTORY_DTL.obj_type='分期' or SWM_YE_VALUE_INVENTORY_DTL.obj_type='宗地' );

    insert into TMP_DT_VAL_BY_SUPPLY_PLAN_DTL
    select  SWM_YE_VALUE_INVENTORY_DTL.biz_id,
      SWM_YE_VALUE_INVENTORY_DTL.BIZ_PARENT_ID,
     SWM_YE_VALUE_INVENTORY_DTL.OBJ_TYPE,
      SWM_YE_VALUE_INVENTORY_DTL.OBJ_id,
     SWM_YE_VALUE_INVENTORY_DTL.OBJ_NAME,
     SWM_YE_VALUE_INVENTORY_DTL.OWN_BUILD_PRODUCT_TYPE_ID,
     (select sum(SUPPLY_TOTAL_AREA) from TMP_DT_VAL_BY_SUPPLY_PLAN_DTL where SPID =spid and OWN_BUILD_PRODUCT_TYPE_ID=SWM_YE_VALUE_INVENTORY_DTL.OBJ_ID)  SUPPLY_TOTAL_AREA,
    (select sum(SUPPLY_TOTAL_NUMBER) from TMP_DT_VAL_BY_SUPPLY_PLAN_DTL where SPID =spid and OWN_BUILD_PRODUCT_TYPE_ID=SWM_YE_VALUE_INVENTORY_DTL.OBJ_ID)  SUPPLY_TOTAL_NUMBER,
    0 SUPPLY_AVERAGE_AMOUNT,
    (select sum(SUPPLY_TOTAL_AMOUNT) from TMP_DT_VAL_BY_SUPPLY_PLAN_DTL where SPID =spid and OWN_BUILD_PRODUCT_TYPE_ID=SWM_YE_VALUE_INVENTORY_DTL.OBJ_ID) SUPPLY_TOTAL_AMOUNT,
    spid
    from 
    SWM_YE_VALUE_INVENTORY_DTL left join SWM_YE_VALUE_INVENTORY on SWM_YE_VALUE_INVENTORY.id=SWM_YE_VALUE_INVENTORY_DTL.YE_VALUE_INVENTORY_ID
    where extract( year from SWM_YE_VALUE_INVENTORY.year ) =planYear and SWM_YE_VALUE_INVENTORY.project_id=projectId and 
    SWM_YE_VALUE_INVENTORY_DTL.obj_type='一级业态' ;

    insert into TMP_DT_VAL_BY_SUPPLY_PLAN_DTL
    select 
     biz_id||'_firstLevelProductTypeStatistics',
     biz_id BIZ_PARENT_ID,
     '按业态汇总',
     OBJ_id,
     OBJ_NAME,
     OWN_BUILD_PRODUCT_TYPE_ID,
     SUPPLY_TOTAL_AREA,
     SUPPLY_TOTAL_NUMBER,
     SUPPLY_AVERAGE_AMOUNT,
     SUPPLY_TOTAL_AMOUNT,
     spid
    from TMP_DT_VAL_BY_SUPPLY_PLAN_DTL where obj_type='项目' and SPID =spid;
END IF;
END P_SWM_DT_VAL_BY_SUPPLY_PLAN;
--------------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------------

/
--------------------------------------------------------
--  DDL for Procedure P_SWM_DT_VALUE_TABLE_REPORT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SWM_DT_VALUE_TABLE_REPORT" 
AS 
---用于查询供货月报
BEGIN
--DROP TABLE SWM_DT_VALUE_TABLE;
--CREATE TABLE  SWM_DT_VALUE_TABLE  as 
DELETE SWM_DT_VALUE_TABLE;
INSERT INTO SWM_DT_VALUE_TABLE
 SELECT * FROM V_SWM_DT_VALUE;
 END P_SWM_DT_VALUE_TABLE_REPORT;

/
--------------------------------------------------------
--  DDL for Procedure P_SWM_GET_SUPPLYDETAIL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SWM_GET_SUPPLYDETAIL" (
    supplySellPlanId IN VARCHAR2,
    info OUT SYS_REFCURSOR
)AS
    --《供货管理》供货存计划编制明细
--作者：wangl
--日期：2020/12/17
    projectID VARCHAR2(36); -- 项目id
    nostagingID VARCHAR2(200); -- 无分期id
    mixType integer;
BEGIN
    -- 查询条数
    SELECT
        count(*) into mixType
    FROM
        SWM_SUPPLY_SELL_PLAN_DTL 
    WHERE
        OBJ_TYPE = '无分期' 
        AND SUPPLY_SELL_PLAN_ID = supplySellPlanId;
IF mixType>0 THEN
    -- 查询无分期的id
    SELECT
        BIZ_ID INTO nostagingID 
    FROM
        SWM_SUPPLY_SELL_PLAN_DTL 
    WHERE
        OBJ_TYPE = '无分期' 
        AND SUPPLY_SELL_PLAN_ID = supplySellPlanId;  
END IF; 
    -- 查询条数
    SELECT
       count(*) into mixType
    FROM
        SWM_SUPPLY_SELL_PLAN_DTL 
    WHERE
        OBJ_TYPE = '项目' 
        AND SUPPLY_SELL_PLAN_ID = supplySellPlanId;
IF mixType>0 THEN
    -- 查询项目
    SELECT
        BIZ_ID INTO projectID 
    FROM
        SWM_SUPPLY_SELL_PLAN_DTL 
    WHERE
        OBJ_TYPE = '项目' 
        AND SUPPLY_SELL_PLAN_ID = supplySellPlanId;
END IF; 
   -- 查询树
    OPEN info FOR
     select
            ID,
            OBJ_NAME,
            SUPPLY_MONTH_DETAIL_ID,
            BUILD_PRODUCT_TYPE_NAME,                                         
            PO_TOTAL_SALE_AREA,
            PO_TOTAL_SALE_COUNT,
            PO_TOTAL_SALE_AMOUNT,
            PO_SURPLUS_SALE_AREA,
            PO_SURPLUS_SALE_COUNT,
            PO_SURPLUS_SALE_AMOUNT,
            RP_TOTAL_AREA,
            RP_TOTAL_COUNT,
            RP_TOTAL_AMOUNT,
            PO_SALE_AREA,
            PO_SALE_COUNT,
            PO_SALE_AMOUNT,
            RP_SURPLUS_AREA,
            RP_SURPLUS_COUNT,
            RP_SURPLUS_AMOUNT,
            SUPPLY_TOTAL_AREA,
            SUPPLY_TOTAL_NUMBER,
            SUPPLY_TOTAL_AMOUNT,
            SELL_TOTAL_AREA,
            SELL_TOTAL_NUMBER,
            SELL_TOTAL_AMOUNT,
            JANUARY_SUPPLY_AREA,
            JANUARY_SUPPLY_NUMBER,
            JANUARY_SUPPLY_AMOUNT,
            JANUARY_SELL_AREA,
            JANUARY_SELL_NUMBER,
            JANUARY_SELL_AMOUNT,
            FEBRUARY_SUPPLY_AREA,
            FEBRUARY_SUPPLY_NUMBER,
            FEBRUARY_SUPPLY_AMOUNT,
            FEBRUARY_SELL_AREA,
            FEBRUARY_SELL_NUMBER,
            FEBRUARY_SELL_AMOUNT,
            MARCH_SUPPLY_AREA,
            MARCH_SUPPLY_NUMBER,
            MARCH_SUPPLY_AMOUNT,
            MARCH_SELL_AREA,
            MARCH_SELL_NUMBER,
            MARCH_SELL_AMOUNT,
            APRIL_SUPPLY_AREA,
            APRIL_SUPPLY_NUMBER,
            APRIL_SUPPLY_AMOUNT,
            APRIL_SELL_AREA,
            APRIL_SELL_NUMBER,
            APRIL_SELL_AMOUNT,
            MAY_SUPPLY_AREA,
            MAY_SUPPLY_NUMBER,
            MAY_SUPPLY_AMOUNT,
            MAY_SELL_AREA,
            MAY_SELL_NUMBER,
            MAY_SELL_AMOUNT,
            JUNE_SUPPLY_AREA,
            JUNE_SUPPLY_NUMBER,
            JUNE_SUPPLY_AMOUNT,
            JUNE_SELL_AREA,
            JUNE_SELL_NUMBER,
            JUNE_SELL_AMOUNT,
            JULY_SUPPLY_AREA,
            JULY_SUPPLY_NUMBER,
            JULY_SUPPLY_AMOUNT,
            JULY_SELL_AREA,
            JULY_SELL_NUMBER,
            JULY_SELL_AMOUNT,
            AUGUST_SUPPLY_AREA,
            AUGUST_SUPPLY_NUMBER,
            AUGUST_SUPPLY_AMOUNT,
            AUGUST_SELL_AREA,
            AUGUST_SELL_NUMBER,
            AUGUST_SELL_AMOUNT,
            SEPTEMBER_SUPPLY_AREA,
            SEPTEMBER_SUPPLY_NUMBER,
            SEPTEMBER_SUPPLY_AMOUNT,
            SEPTEMBER_SELL_AREA,
            SEPTEMBER_SELL_NUMBER,
            SEPTEMBER_SELL_AMOUNT,
            OCTOBER_SUPPLY_AREA,
            OCTOBER_SUPPLY_NUMBER,
            OCTOBER_SUPPLY_AMOUNT,
            OCTOBER_SELL_AREA,
            OCTOBER_SELL_NUMBER,
            OCTOBER_SELL_AMOUNT,
            NOVEMBER_SUPPLY_AREA,
            NOVEMBER_SUPPLY_NUMBER,
            NOVEMBER_SUPPLY_AMOUNT,
            NOVEMBER_SELL_AREA,
            NOVEMBER_SELL_NUMBER,
            NOVEMBER_SELL_AMOUNT,
            DECEMBER_SUPPLY_NUMBER,
            DECEMBER_SUPPLY_AREA,
            DECEMBER_SUPPLY_AMOUNT,
            DECEMBER_SELL_AREA,
            DECEMBER_SELL_NUMBER,
            DECEMBER_SELL_AMOUNT,
            decode( CAN_EDIT, 0, '#F3F3F3', NULL ) "BGCOLOR",
            BIZ_ID,
            decode( BIZ_PARENT_ID, NVL(nostagingID,'11'), projectID, BIZ_PARENT_ID ) "BIZ_PARENT_ID",
            CAN_EDIT,
            ORDER_CODE
        FROM        
            SWM_SUPPLY_SELL_PLAN_DTL
        WHERE SWM_SUPPLY_SELL_PLAN_DTL.SUPPLY_SELL_PLAN_ID = supplySellPlanId
        AND OBJ_TYPE!='无分期'
        AND IS_DELETED = '0'
        ORDER BY (case when OBJ_TYPE='项目' then 0 when  OBJ_TYPE ='按业态汇总' then 1 when OBJ_TYPE ='一级业态' then 2 else 3 end), ORDER_CODE;
END P_SWM_GET_SUPPLYDETAIL;

/
--------------------------------------------------------
--  DDL for Procedure P_SWM_MONTH_REALSPLY_SALE_DTL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SWM_MONTH_REALSPLY_SALE_DTL" 

AS 
----查询抓取每月实际供货、销售
BEGIN
--DROP TABLE SWM_MONTH_RealSUPPLY_DTL;
--DROP TABLE SWM_MOTH_RealSALE_DTL;
DELETE  SWM_MONTH_RealSUPPLY_DTL;
DELETE  SWM_MOTH_RealSALE_DTL;

--查询12个月的实际销售数据
--CREATE table SWM_MOTH_RealSALE_DTL as 
INSERT INTO  SWM_MOTH_RealSALE_DTL
SELECT A.PROJ_ID,PROJECT_NAME
,STAGE_ID,STAGE_NAME
,A.PRODUCT_NAME
-- ,BUILD_ID
-- ,BUILD_NAME
,销售年份
,SUM(NVL("1月_销售面积",0)+NVL("2月_销售面积",0)+NVL("3月_销售面积",0) +NVL("4月_销售面积",0)+NVL("5月_销售面积",0)+NVL("6月_销售面积",0) +NVL("7月_销售面积",0)+NVL("8月_销售面积",0)+NVL("9月_销售面积",0)+NVL("10月_销售面积",0)+NVL("11月_销售面积",0)+NVL("12月_销售面积",0))  AS 本年销售面积
,SUM(NVL("1月_销售套数",0)+NVL("2月_销售套数",0)+NVL("3月_销售套数",0) +NVL("4月_销售套数",0)+NVL("5月_销售套数",0)+NVL("6月_销售套数",0) +NVL("7月_销售套数",0)+NVL("8月_销售套数",0)+NVL("9月_销售套数",0)+NVL("10月_销售套数",0)+NVL("11月_销售套数",0)+NVL("12月_销售套数",0))  AS 本年销售套数
,SUM(NVL("1月_销售金额",0)+NVL("2月_销售金额",0)+NVL("3月_销售金额",0) +NVL("4月_销售金额",0)+NVL("5月_销售金额",0)+NVL("6月_销售金额",0) +NVL("7月_销售金额",0)+NVL("8月_销售金额",0)+NVL("9月_销售金额",0)+NVL("10月_销售金额",0)+NVL("11月_销售金额",0)+NVL("12月_销售金额",0))  AS 本年销售金额
,SUM(NVL("1月_销售面积",0)+NVL("2月_销售面积",0)+NVL("3月_销售面积",0)) AS "一季度销售面积"
,SUM(NVL("1月_销售套数",0)+NVL("2月_销售套数",0)+NVL("3月_销售套数",0)) AS "一季度销售套数"
,SUM(NVL("1月_销售金额",0)+NVL("2月_销售金额",0)+NVL("3月_销售金额",0)) AS "一季度销售金额"
,SUM(NVL("4月_销售面积",0)+NVL("5月_销售面积",0)+NVL("6月_销售面积",0)) AS "二季度销售面积"
,SUM(NVL("4月_销售套数",0)+NVL("5月_销售套数",0)+NVL("6月_销售套数",0)) AS "二季度销售套数"
,SUM(NVL("4月_销售金额",0)+NVL("5月_销售金额",0)+NVL("6月_销售金额",0)) AS "二季度销售金额"
,SUM(NVL("7月_销售面积",0)+NVL("8月_销售面积",0)+NVL("9月_销售面积",0)) AS "三季度销售面积"
,SUM(NVL("7月_销售套数",0)+NVL("8月_销售套数",0)+NVL("9月_销售套数",0)) AS "三季度销售套数"
,SUM(NVL("7月_销售金额",0)+NVL("8月_销售金额",0)+NVL("9月_销售金额",0)) AS "三季度销售金额"
,SUM(NVL("10月_销售面积",0)+NVL("11月_销售面积",0)+NVL("12月_销售面积",0)) AS "四季度销售面积"
,SUM(NVL("10月_销售套数",0)+NVL("11月_销售套数",0)+NVL("12月_销售套数",0)) AS "四季度销售套数"
,SUM(NVL("10月_销售金额",0)+NVL("11月_销售金额",0)+NVL("12月_销售金额",0)) AS "四季度销售金额"
,SUM(NVL("1月_销售面积",0)) AS "1月_销售面积"
,SUM(NVL("1月_销售套数",0)) AS "1月_销售套数"
,SUM(NVL("1月_销售金额",0)) AS "1月_销售金额"
,SUM(NVL("2月_销售面积",0)) AS "2月_销售面积"
,SUM(NVL("2月_销售套数",0)) AS "2月_销售套数"
,SUM(NVL("2月_销售金额",0)) AS "2月_销售金额"
,SUM(NVL("3月_销售面积",0)) AS "3月_销售面积"
,SUM(NVL("3月_销售套数",0)) AS "3月_销售套数"
,SUM(NVL("3月_销售金额",0)) AS "3月_销售金额"
,SUM(NVL("4月_销售面积",0)) AS "4月_销售面积"
,SUM(NVL("4月_销售套数",0)) AS "4月_销售套数"
,SUM(NVL("4月_销售金额",0)) AS "4月_销售金额"
,SUM(NVL("5月_销售面积",0)) AS "5月_销售面积"
,SUM(NVL("5月_销售套数",0)) AS "5月_销售套数"
,SUM(NVL("5月_销售金额",0)) AS "5月_销售金额"
,SUM(NVL("6月_销售面积",0)) AS "6月_销售面积"
,SUM(NVL("6月_销售套数",0)) AS "6月_销售套数"
,SUM(NVL("6月_销售金额",0)) AS "6月_销售金额"
,SUM(NVL("7月_销售面积",0)) AS "7月_销售面积"
,SUM(NVL("7月_销售套数",0)) AS "7月_销售套数"
,SUM(NVL("7月_销售金额",0)) AS "7月_销售金额"
,SUM(NVL("8月_销售面积",0)) AS "8月_销售面积"
,SUM(NVL("8月_销售套数",0)) AS "8月_销售套数"
,SUM(NVL("8月_销售金额",0)) AS "8月_销售金额"
,SUM(NVL("9月_销售面积",0)) AS "9月_销售面积"
,SUM(NVL("9月_销售套数",0)) AS "9月_销售套数"
,SUM(NVL("9月_销售金额",0)) AS "9月_销售金额"
,SUM(NVL("10月_销售面积",0)) AS "10月_销售面积"
,SUM(NVL("10月_销售套数",0)) AS "10月_销售套数"
,SUM(NVL("10月_销售金额",0)) AS "10月_销售金额"
,SUM(NVL("11月_销售面积",0)) AS "11月_销售面积"
,SUM(NVL("11月_销售套数",0)) AS "11月_销售套数"
,SUM(NVL("11月_销售金额",0)) AS "11月_销售金额"
,SUM(NVL("12月_销售面积",0)) AS "12月_销售面积"
,SUM(NVL("12月_销售套数",0)) AS "12月_销售套数"
,SUM(NVL("12月_销售金额",0)) AS "12月_销售金额"

FROM (


SELECT 
 "PROJ_ID","PROJECT_NAME","STAGE_ID","STAGE_NAME","销售年份","PRODUCT_NAME","面价标准总价汇总","1月_销售面积","1月_销售套数","1月_销售金额","2月_销售面积","2月_销售套数","2月_销售金额","3月_销售面积","3月_销售套数","3月_销售金额","4月_销售面积","4月_销售套数","4月_销售金额","5月_销售面积","5月_销售套数","5月_销售金额","6月_销售面积","6月_销售套数","6月_销售金额","7月_销售面积","7月_销售套数","7月_销售金额","8月_销售面积","8月_销售套数","8月_销售金额","9月_销售面积","9月_销售套数","9月_销售金额","10月_销售面积","10月_销售套数","10月_销售金额","11月_销售面积","11月_销售套数","11月_销售金额","12月_销售面积","12月_销售套数","12月_销售金额" from (
SELECT D.ID AS PROJ_ID,D.PROJECT_NAME,C.ID AS STAGE_ID ,C.STAGE_NAME
--,B.ID as BUILD_ID,B.BUILD_NAME

,to_char(A.TRADE_CONTRACT_DATE,'YYYY') AS 销售年份, to_char(A.TRADE_CONTRACT_DATE,'MM') 销售月份
, CASE WHEN A.PRODUCT_NAME LIKE '%住宅%' THEN '住宅'  WHEN A.PRODUCT_NAME LIKE '%商办%' THEN '商办产业' WHEN A.PRODUCT_NAME='车位' THEN '车位仓储' WHEN A.PRODUCT_NAME LIKE '%配套%' THEN '配套实施' END AS  PRODUCT_NAME
,COUNT(A.ID) AS 成交套数
,SUM(NVL(A.NEW_BLD_AREA,0)) AS 最新建筑面积汇总,SUM(NVL(BZ_TOTAL,0)) AS 面价标准总价汇总,SUM(NVL(TRADE_TOTAL,0)) AS 合同成交总价汇总   
FROM
MDM_BUILD B 
INNER JOIN SYS_PROJECT_STAGE C ON C.ID=B.PERIOD_ID
INNER JOIN SYS_PROJECT D ON C.PROJECT_ID=D.ID 
LEFT JOIN MDM_ROOM A  ON B.ID=A.BUILDING_ID 
WHERE SALE_STATE='签约' 
-- AND D.PROJECT_NAME LIKE '%重庆西派城%'  
AND to_char(A.TRADE_CONTRACT_DATE,'YYYY') =TO_CHAR(SYSDATE,'YYYY')  --AND to_char(A.TRADE_CONTRACT_DATE,'MM') ='08'
GROUP BY  D.ID,D.PROJECT_NAME,C.ID,C.STAGE_NAME--,B.ID,B.BUILD_NAME
,CASE WHEN A.PRODUCT_NAME LIKE '%住宅%' THEN '住宅'  WHEN A.PRODUCT_NAME LIKE '%商办%' THEN '商办产业' WHEN A.PRODUCT_NAME='车位' THEN '车位仓储' WHEN A.PRODUCT_NAME LIKE '%配套%' THEN '配套实施' END, to_char(A.TRADE_CONTRACT_DATE,'YYYY'), to_char(A.TRADE_CONTRACT_DATE,'MM')
)A  pivot 
( SUM(NVL(最新建筑面积汇总,0)) 销售面积,SUM(NVL(成交套数,0)) 销售套数,SUM(NVL(合同成交总价汇总,0)) 销售金额  FOR  销售月份  
	in  ('01' AS "1月",'02' AS "2月",'03'AS "3月",'04' AS "4月",'05' AS "5月",'06' AS "6月",'07' AS "7月",'08' AS "8月",'09'AS "9月",'10' AS "10月",'11' AS "11月",'12' AS "12月")		  

) 

)
 A where  1=1   AND 销售年份=TO_CHAR(SYSDATE,'yyyy') --PROJECT_NAME LIKE '%重庆西派城%'   
GROUP BY A.PROJ_ID,PROJECT_NAME
,STAGE_ID,STAGE_NAME
,A.PRODUCT_NAME
-- ,BUILD_ID
-- ,BUILD_NAME
,销售年份;

--CREATE table SWM_MONTH_RealSUPPLY_DTL AS 
INSERT INTO  SWM_MONTH_RealSUPPLY_DTL
SELECT 
PROJ_ID,PROJECT_NAME,STAGE_ID,STAGE_NAME,"一级业态"
-- ,OBJ_ID
-- ,OBJ_NAME
,"实际供货年份"
,SUM(NVL("1月_供货面积",0)+NVL("2月_供货面积",0)+NVL("3月_供货面积",0) +NVL("4月_供货面积",0)+NVL("5月_供货面积",0)+NVL("6月_供货面积",0) +NVL("7月_供货面积",0)+NVL("8月_供货面积",0)+NVL("9月_供货面积",0)+NVL("10月_供货面积",0)+NVL("11月_供货面积",0)+NVL("12月_供货面积",0)) AS 本年供货面积
,SUM(NVL("1月_供货套数",0)+NVL("2月_供货套数",0)+NVL("3月_供货套数",0) +NVL("4月_供货套数",0)+NVL("5月_供货套数",0)+NVL("6月_供货套数",0) +NVL("7月_供货套数",0)+NVL("8月_供货套数",0)+NVL("9月_供货套数",0)+NVL("10月_供货套数",0)+NVL("11月_供货套数",0)+NVL("12月_供货套数",0))  AS 本年供货套数
,SUM(NVL("1月_供货金额",0)+NVL("2月_供货金额",0)+NVL("3月_供货金额",0) +NVL("4月_供货金额",0)+NVL("5月_供货金额",0)+NVL("6月_供货金额",0) +NVL("7月_供货金额",0)+NVL("8月_供货金额",0)+NVL("9月_供货金额",0)+NVL("10月_供货金额",0)+NVL("11月_供货金额",0)+NVL("12月_供货金额",0))  AS 本年供货金额
,SUM(NVL("1月_供货面积",0)+NVL("2月_供货面积",0)+NVL("3月_供货面积",0) ) AS "一季度供货面积"
,SUM(NVL("1月_供货套数",0)+NVL("2月_供货套数",0)+NVL("3月_供货套数",0)) AS "一季度供货套数"
,SUM(NVL("1月_供货金额",0)+NVL("2月_供货金额",0)+NVL("3月_供货金额",0)) AS "一季度供货金额"
,SUM(NVL("4月_供货面积",0)+NVL("5月_供货面积",0)+NVL("6月_供货面积",0)) AS "二季度供货面积"
,SUM(NVL("4月_供货套数",0)+NVL("5月_供货套数",0)+NVL("6月_供货套数",0)) AS "二季度供货套数"
,SUM(NVL("4月_供货金额",0)+NVL("5月_供货金额",0)+NVL("6月_供货金额",0)) AS "二季度供货金额"
,SUM(NVL("7月_供货面积",0)+NVL("8月_供货面积",0)+NVL("9月_供货面积",0)) AS "三季度供货面积"
,SUM(NVL("7月_供货套数",0)+NVL("8月_供货套数",0)+NVL("9月_供货套数",0)) AS "三季度供货套数"
,SUM(NVL("7月_供货金额",0)+NVL("8月_供货金额",0)+NVL("9月_供货金额",0)) AS "三季度供货金额"
,SUM(NVL("10月_供货面积",0)+NVL("11月_供货面积",0)+NVL("12月_供货面积",0)) AS "四季度供货面积"
,SUM(NVL("10月_供货套数",0)+NVL("11月_供货套数",0)+NVL("12月_供货套数",0)) AS "四季度供货套数"
,SUM(NVL("10月_供货金额",0)+NVL("11月_供货金额",0)+NVL("12月_供货金额",0)) AS "四季度供货金额"
,SUM(NVL("1月_供货面积",0)) AS "1月_供货面积"
,SUM(NVL("1月_供货套数",0)) AS "1月_供货套数"
,SUM(NVL("1月_供货金额",0)) AS "1月_供货金额"
,SUM(NVL("2月_供货面积",0)) AS "2月_供货面积"
,SUM(NVL("2月_供货套数",0)) AS "2月_供货套数"
,SUM(NVL("2月_供货金额",0)) AS "2月_供货金额"
,SUM(NVL("3月_供货面积",0)) AS "3月_供货面积"
,SUM(NVL("3月_供货套数",0)) AS "3月_供货套数"
,SUM(NVL("3月_供货金额",0)) AS "3月_供货金额"
,SUM(NVL("4月_供货面积",0)) AS "4月_供货面积"
,SUM(NVL("4月_供货套数",0)) AS "4月_供货套数"
,SUM(NVL("4月_供货金额",0)) AS "4月_供货金额"
,SUM(NVL("5月_供货面积",0)) AS "5月_供货面积"
,SUM(NVL("5月_供货套数",0)) AS "5月_供货套数"
,SUM(NVL("5月_供货金额",0)) AS "5月_供货金额"
,SUM(NVL("6月_供货面积",0)) AS "6月_供货面积"
,SUM(NVL("6月_供货套数",0)) AS "6月_供货套数"
,SUM(NVL("6月_供货金额",0)) AS "6月_供货金额"
,SUM(NVL("7月_供货面积",0)) AS "7月_供货面积"
,SUM(NVL("7月_供货套数",0)) AS "7月_供货套数"
,SUM(NVL("7月_供货金额",0)) AS "7月_供货金额"
,SUM(NVL("8月_供货面积",0)) AS "8月_供货面积"
,SUM(NVL("8月_供货套数",0)) AS "8月_供货套数"
,SUM(NVL("8月_供货金额",0)) AS "8月_供货金额"
,SUM(NVL("9月_供货面积",0)) AS "9月_供货面积"
,SUM(NVL("9月_供货套数",0)) AS "9月_供货套数"
,SUM(NVL("9月_供货金额",0)) AS "9月_供货金额"
,SUM(NVL("10月_供货面积",0)) AS "10月_供货面积"
,SUM(NVL("10月_供货套数",0)) AS "10月_供货套数"
,SUM(NVL("10月_供货金额",0)) AS "10月_供货金额"
,SUM(NVL("11月_供货面积",0)) AS "11月_供货面积"
,SUM(NVL("11月_供货套数",0)) AS "11月_供货套数"
,SUM(NVL("11月_供货金额",0)) AS "11月_供货金额"
,SUM(NVL("12月_供货面积",0)) AS "12月_供货面积"
,SUM(NVL("12月_供货套数",0)) AS "12月_供货套数"
,SUM(NVL("12月_供货金额",0)) AS "12月_供货金额"
FROM
( 
	SELECT* FROM
	(
		SELECT 
		PROJ_ID,PROJECT_NAME,STAGE_ID,STAGE_NAME
		,OBJ_ID
		,OBJ_NAME
		,"一级业态"
		,A."实际供货年份"
		,A."实际供货月份"
		,SUM(NVL("总户数",0)) AS "供货套数"
		,sum(NVL("总可售面积",0)) AS "供货面积"
		,sum(NVL("A_当前最新版目标货值",0)) AS  "供货金额"

		FROM V_SWM_DT_VALUE  A where 1=1 -- PROJECT_NAME LIKE '%重庆西派城%'   
		AND  实际供货年份 IS NOT NULL AND "A_当前最新版目标货值" IS NOT NULL
		AND 实际供货年份=TO_CHAR(SYSDATE,'yyyy')
		GROUP BY PROJ_ID,PROJECT_NAME,STAGE_ID,STAGE_NAME,OBJ_ID,OBJ_NAME,"一级业态",A."实际供货年份",A."实际供货月份"
	)  A  pivot  
	(
		SUM(NVL("供货面积",0)) AS 供货面积
		,SUM(NVL("供货套数",0)) AS 供货套数
		,SUM(NVL("供货金额",0)) AS 供货金额  
		FOR  "实际供货月份" 	in  ('01' AS "1月",'02' AS "2月",'03'AS "3月",'04' AS "4月",'05' AS "5月",'06' AS "6月",'07' AS "7月",'08' AS "8月",'09'AS "9月",'10' AS "10月",'11' AS "11月",'12' AS "12月")		  
	)
) A1 
GROUP BY PROJ_ID,PROJECT_NAME,STAGE_ID,STAGE_NAME,"一级业态"
-- ,OBJ_ID
-- ,OBJ_NAME
,"实际供货年份";



END P_SWM_MONTH_REAlSPLY_SALE_DTL;

/
--------------------------------------------------------
--  DDL for Procedure P_SWM_PLAN_YEAR
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SWM_PLAN_YEAR" ( 
module in varchar2,
INFOS OUT sys_refcursor) 
AS
current_year varchar(10);
current_nd varchar(10);
begin_nd  varchar(10):='2021';
param_begin_nd  varchar(10);
rowCount number;
begin
    select FN_BIZPARAM_CONFIG('dwm_swm_start_plan_year') into param_begin_nd  from dual; 
    if param_begin_nd is not null then
        begin_nd:=param_begin_nd;
    end if;
    select  to_char(add_months(sysdate,24),'yyyy') into current_year  from dual;
    select  to_char(sysdate,'yyyy') into current_nd  from dual;
    open INFOS for 
    SELECT nds.nd||'年' as "planYearLabel",nds.nd||'-01-01' as "planYear",module as "module",case when current_nd=nds.nd then 1 else 0 end as "selected"   from (SELECT TO_CHAR(ADD_MONTHS(TO_DATE(begin_nd, 'yyyy'), (ROWNUM - 1) * 12), 'yyyy') as nd
    FROM DUAL
    CONNECT BY ROWNUM <=
    months_between(to_date(current_year,'yyyy') ,
    to_date(begin_nd, 'yyyy')) / 12 + 1) nds order by nds.nd asc;
end P_SWM_PLAN_YEAR;

/
--------------------------------------------------------
--  DDL for Procedure P_SWM_SUPPLY_MONITOR
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SWM_SUPPLY_MONITOR" (userid IN VARCHAR2, --当前用户id
                                                   stationid IN VARCHAR2, --当前用户岗位id
                                                   departmentid IN VARCHAR2, --当前用户部门id
                                                   companyid IN VARCHAR2, --当前用户公司id
                                                   unitid IN VARCHAR2, --选择公司id
                                                   parentId IN VARCHAR2, --选择父级id
                                                   excel IN VARCHAR2, --是否是导出EXCEL
                                                   info OUT SYS_REFCURSOR--返回结果
) AS
    --《货值管理系统》供货情况监控
--作者：chenl
--日期：2020/12/10
    data_auth_spid VARCHAR2(200);
    bizcode        VARCHAR2(200);
    unitid_val     VARCHAR2(200);
    sql_str clob;
BEGIN
    OPEN  info for 
				
				
SELECT 




"PROJ_ID"
,"OBJ_TYPE"
,"OBJ_ID"
,"OBJ_NAME"
,"OBJ_PARENT_ID"
,"LEVEL"
,"LEVEL_ORDER"
,"ORDER_CODE"
,"COMPANY_NAME"
,"COMPANY_ID"
,"COMPANY_ORDER_HIERARCHY_CODE"
,"id"
,"projConstitute"
,"parentId"
,"ORDER_HIERARCHY_CODE"
,"objId"
,"objType"
,"buildProductTypeName"
,"ownBuildProductTypeId"
,"buildProductTypeId"

,SUM(NVL("thisYearSupplyAmount",0)) AS "thisYearSupplyAmount"
,SUM(NVL("thisYearSupplyNumber",0)) AS "thisYearSupplyNumber"
,SUM(NVL("thisYearSupplyArea",0)) AS "thisYearSupplyArea"
,SUM(NVL("firstSeasonSupplyAmount",0)) AS "firstSeasonSupplyAmount"
,SUM(NVL("firstSeasonSupplyNumber",0)) AS "firstSeasonSupplyNumber"
,SUM(NVL("firstSeasonSupplyArea",0)) AS "firstSeasonSupplyArea"
,SUM(NVL("januarySupplyAmount",0)) AS "januarySupplyAmount"
,SUM(NVL("januarySupplyNumberx",0)) AS "januarySupplyNumberx"
,SUM(NVL("januarySupplyNumber",0)) AS "januarySupplyNumber"
,SUM(NVL("februarySupplyAmount",0)) AS "februarySupplyAmount"
,SUM(NVL("februarySupplyNumber",0)) AS "februarySupplyNumber"
,SUM(NVL("februarySupplyArea",0)) AS "februarySupplyArea"
,SUM(NVL("marchSupplyAmount",0)) AS "marchSupplyAmount"
,SUM(NVL("marchSupplyNumber",0)) AS "marchSupplyNumber"
,SUM(NVL("marchSupplyArea",0)) AS "marchSupplyArea"
,SUM(NVL("secondSeasonSupplyAmount",0)) AS "secondSeasonSupplyAmount"
,SUM(NVL("secondSeasonSupplyNumber",0)) AS "secondSeasonSupplyNumber"
,SUM(NVL("secondSeasonSupplyArea",0)) AS "secondSeasonSupplyArea"
,SUM(NVL("aprilSupplyAmount",0)) AS "aprilSupplyAmount"
,SUM(NVL("aprilSupplyNumber",0)) AS "aprilSupplyNumber"
,SUM(NVL("aprilSupplyArea",0)) AS "aprilSupplyArea"
,SUM(NVL("maySupplyAmount",0)) AS "maySupplyAmount"
,SUM(NVL("maySupplyNumber",0)) AS "maySupplyNumber"
,SUM(NVL("maySupplyArea",0)) AS "maySupplyArea"
,SUM(NVL("juneSupplyAmount",0)) AS "juneSupplyAmount"
,SUM(NVL("juneSupplyNumber",0)) AS "juneSupplyNumber"
,SUM(NVL("juneSupplyArea",0)) AS "juneSupplyArea"
,SUM(NVL("thirdSeasonSupplyAmount",0)) AS "thirdSeasonSupplyAmount"
,SUM(NVL("thirdSeasonSupplyNumber",0)) AS "thirdSeasonSupplyNumber"
,SUM(NVL("thirdSeasonSupplyArea",0)) AS "thirdSeasonSupplyArea"
,SUM(NVL("julySupplyAmount",0)) AS "julySupplyAmount"
,SUM(NVL("julySupplyNumber",0)) AS "julySupplyNumber"
,SUM(NVL("julySupplyArea",0)) AS "julySupplyArea"
,SUM(NVL("augustSupplyAmount",0)) AS "augustSupplyAmount"
,SUM(NVL("augustSupplyNumber",0)) AS "augustSupplyNumber"
,SUM(NVL("augustSupplyArea",0)) AS "augustSupplyArea"
,SUM(NVL("septemberSupplyAmount",0)) AS "septemberSupplyAmount"
,SUM(NVL("septemberSupplyNumber",0)) AS "septemberSupplyNumber"
,SUM(NVL("septemberSupplyArea",0)) AS "septemberSupplyArea"
,SUM(NVL("fourthSeasonSupplyAmount",0)) AS "fourthSeasonSupplyAmount"
,SUM(NVL("fourthSeasonSupplyNumber",0)) AS "fourthSeasonSupplyNumber"
,SUM(NVL("fourthSeasonSupplyArea",0)) AS "fourthSeasonSupplyArea"
,SUM(NVL("octoberSupplyAmount",0)) AS "octoberSupplyAmount"
,SUM(NVL("octoberSupplyNumber",0)) AS "octoberSupplyNumber"
,SUM(NVL("octoberSupplyArea",0)) AS "octoberSupplyArea"
,SUM(NVL("novemberSupplyAmount",0)) AS "novemberSupplyAmount"
,SUM(NVL("novemberSupplyNumber",0)) AS "novemberSupplyNumber"
,SUM(NVL("novemberSupplyArea",0)) AS "novemberSupplyArea"
,SUM(NVL("decemberSupplyAmount",0)) AS "decemberSupplyAmount"
,SUM(NVL("decemberSupplyNumber",0)) AS "decemberSupplyNumber"
,SUM(NVL("decemberSupplyArea",0)) AS "decemberSupplyArea"
,SUM(NVL("poTotalSaleCount",0)) AS "poTotalSaleCount"
,SUM(NVL("poTotalSaleArea",0)) AS "poTotalSaleArea"
,SUM(NVL("poTotalSaleAmount",0))/10000 AS "poTotalSaleAmount"
,SUM(NVL("rpTotalArea",0)) AS "rpTotalArea"
,SUM(NVL("rpTotalAmount",0))/10000 AS "rpTotalAmount"
,SUM(NVL("rpTotalCount",0)) AS "rpTotalCount"
,SUM(NVL("poSaleArea",0)) AS "poSaleArea"
,SUM(NVL("poSaleAmount",0))/10000 AS "poSaleAmount"
,SUM(NVL("poSaleCount",0)) AS "poSaleCount"
,SUM(NVL("rpSurplusArea",0)) AS "rpSurplusArea"
,SUM(NVL("rpSurplusAmount",0))/10000 AS "rpSurplusAmount"
,SUM(NVL("rpSurplusCount",0)) AS "rpSurplusCount"
,SUM(NVL("poSurplusSaleAmount",0))/10000 AS "poSurplusSaleAmount"
,SUM(NVL("poSurplusSaleArea",0)) AS "poSurplusSaleArea"
,SUM(NVL("poSurplusSaleCount",0)) AS "poSurplusSaleCount"
,SUM(NVL("thisYearActualSupplyArea",0)) AS "thisYearActualSupplyArea"
,SUM(NVL("thisYearActualSupplyNumber",0)) AS "thisYearActualSupplyNumber"
,SUM(NVL("thisYearActualSupplyAmount",0))/10000 AS "thisYearActualSupplyAmount"
,SUM(NVL("firstSeasonActualSupplyArea",0)) AS "firstSeasonActualSupplyArea"
,SUM(NVL("firstSeasonActualSupplyNumber",0)) AS "firstSeasonActualSupplyNumber"
,SUM(NVL("firstSeasonActualSupplyAmount",0))/10000 AS "firstSeasonActualSupplyAmount"
,SUM(NVL("secondSeasonActualSupplyArea",0)) AS "secondSeasonActualSupplyArea"
,SUM(NVL("secondSeasonActualSupplyNumber",0)) AS "secondSeasonActualSupplyNumber"
,SUM(NVL("secondSeasonActualSupplyAmount",0))/10000 AS "secondSeasonActualSupplyAmount"
,SUM(NVL("thirdSeasonActualSupplyArea",0)) AS "thirdSeasonActualSupplyArea"
,SUM(NVL("thirdSeasonActualSupplyNumber",0)) AS "thirdSeasonActualSupplyNumber"
,SUM(NVL("thirdSeasonActualSupplyAmount",0))/10000 AS "thirdSeasonActualSupplyAmount"
,SUM(NVL("fourthSeasonActualSupplyArea",0)) AS "fourthSeasonActualSupplyArea"
,SUM(NVL("fourthSeasonActualSupplyNumber",0)) AS "fourthSeasonActualSupplyNumber"
,SUM(NVL("fourthSeasonActualSupplyAmount",0))/10000 AS "fourthSeasonActualSupplyAmount"
,SUM(NVL("januaryActualSupplyArea",0)) AS "januaryActualSupplyArea"
,SUM(NVL("januaryActualSupplyNumber",0)) AS "januaryActualSupplyNumber"
,SUM(NVL("januaryActualSupplyAmount",0))/10000 AS "januaryActualSupplyAmount"
,SUM(NVL("februaryActualSupplyArea",0)) AS "februaryActualSupplyArea"
,SUM(NVL("februaryActualSupplyNumber",0)) AS "februaryActualSupplyNumber"
,SUM(NVL("februaryActualSupplyAmount",0))/10000 AS "februaryActualSupplyAmount"
,SUM(NVL("marchActualSupplyArea",0)) AS "marchActualSupplyArea"
,SUM(NVL("marchActualSupplyNumber",0)) AS "marchActualSupplyNumber"
,SUM(NVL("marchActualSupplyAmount",0))/10000 AS "marchActualSupplyAmount"
,SUM(NVL("aprilActualSupplyArea",0)) AS "aprilActualSupplyArea"
,SUM(NVL("aprilActualSupplyNumber",0)) AS "aprilActualSupplyNumber"
,SUM(NVL("aprilActualSupplyAmount",0))/10000 AS "aprilActualSupplyAmount"
,SUM(NVL("mayActualSupplyArea",0)) AS "mayActualSupplyArea"
,SUM(NVL("mayActualSupplyNumber",0)) AS "mayActualSupplyNumber"
,SUM(NVL("mayActualSupplyAmount",0))/10000 AS "mayActualSupplyAmount"
,SUM(NVL("juneActualSupplyArea",0)) AS "juneActualSupplyArea"
,SUM(NVL("juneActualSupplyNumber",0)) AS "juneActualSupplyNumber"
,SUM(NVL("juneActualSupplyAmount",0))/10000 AS "juneActualSupplyAmount"
,SUM(NVL("julyActualSupplyArea",0)) AS "julyActualSupplyArea"
,SUM(NVL("julyActualSupplyNumber",0)) AS "julyActualSupplyNumber"
,SUM(NVL("julyActualSupplyAmount",0))/10000 AS "julyActualSupplyAmount"
,SUM(NVL("augustActualSupplyArea",0)) AS "augustActualSupplyArea"
,SUM(NVL("augustActualSupplyNumber",0)) AS "augustActualSupplyNumber"
,SUM(NVL("augustActualSupplyAmount",0))/10000 AS "augustActualSupplyAmount"
,SUM(NVL("septemberActualSupplyArea",0)) AS "septemberActualSupplyArea"
,SUM(NVL("septemberActualSupplyNumber",0)) AS "septemberActualSupplyNumber"
,SUM(NVL("septemberActualSupplyAmount",0))/10000 AS "septemberActualSupplyAmount"
,SUM(NVL("octoberActualSupplyArea",0)) AS "octoberActualSupplyArea"
,SUM(NVL("octoberActualSupplyNumber",0)) AS "octoberActualSupplyNumber"
,SUM(NVL("octoberActualSupplyAmount",0))/10000 AS "octoberActualSupplyAmount"
,SUM(NVL("novemberActualSupplyArea",0)) AS "novemberActualSupplyArea"
,SUM(NVL("novemberActualSupplyNumber",0)) AS "novemberActualSupplyNumber"
,SUM(NVL("novemberActualSupplyAmount",0))/10000 AS "novemberActualSupplyAmount"
,SUM(NVL("decemberActualSupplyArea",0)) AS "decemberActualSupplyArea"
,SUM(NVL("decemberActualSupplyNumber",0)) AS "decemberActualSupplyNumber"
,SUM(NVL("decemberActualSupplyAmount",0))/10000 AS "decemberActualSupplyAmount"
,SUM(NVL("thisYearSellArea",0)) AS "thisYearSellArea"
,SUM(NVL("thisYearSellNumber",0)) AS "thisYearSellNumber"
,SUM(NVL("thisYearSellAmount",0))/10000 AS "thisYearSellAmount"
,SUM(NVL("firstSellArea",0)) AS "firstSellArea"
,SUM(NVL("firstSellNumber",0)) AS "firstSellNumber"
,SUM(NVL("firstSellAmount",0))/10000 AS "firstSellAmount"
,SUM(NVL("secondSeasonSellArea",0)) AS "secondSeasonSellArea"
,SUM(NVL("secondSeasonSellNumber",0)) AS "secondSeasonSellNumber"
,SUM(NVL("secondSeasonSellAmount",0))/10000 AS "secondSeasonSellAmount"
,SUM(NVL("thirdSeasonSellArea",0)) AS "thirdSeasonSellArea"
,SUM(NVL("thirdSeasonSellNumber",0)) AS "thirdSeasonSellNumber"
,SUM(NVL("thirdSeasonSellAmount",0))/10000 AS "thirdSeasonSellAmount"
,SUM(NVL("fourthSeasonSellArea",0)) AS "fourthSeasonSellArea"
,SUM(NVL("fourthSeasonSellNumber",0)) AS "fourthSeasonSellNumber"
,SUM(NVL("fourthSeasonSellAmount",0))/10000 AS "fourthSeasonSellAmount"
,SUM(NVL("januarySellArea",0)) AS "januarySellArea"
,SUM(NVL("januarySellNumber",0)) AS "januarySellNumber"
,SUM(NVL("januarySellAmount",0))/10000 AS "januarySellAmount"
,SUM(NVL("februarySellArea",0)) AS "februarySellArea"
,SUM(NVL("februarySellNumber",0)) AS "februarySellNumber"
,SUM(NVL("februarySellAmount",0))/10000 AS "februarySellAmount"
,SUM(NVL("marchSellArea",0)) AS "marchSellArea"
,SUM(NVL("marchSellNumber",0)) AS "marchSellNumber"
,SUM(NVL("marchSellAmount",0))/10000 AS "marchSellAmount"
,SUM(NVL("aprilSellArea",0)) AS "aprilSellArea"
,SUM(NVL("aprilSellNumber",0)) AS "aprilSellNumber"
,SUM(NVL("aprilSellAmount",0))/10000 AS "aprilSellAmount"
,SUM(NVL("maySellArea",0)) AS "maySellArea"
,SUM(NVL("maySellNumber",0)) AS "maySellNumber"
,SUM(NVL("maySellAmount",0))/10000 AS "maySellAmount"
,SUM(NVL("juneSellArea",0)) AS "juneSellArea"
,SUM(NVL("juneSellNumber",0)) AS "juneSellNumber"
,SUM(NVL("juneSellAmount",0))/10000 AS "juneSellAmount"
,SUM(NVL("julySellArea",0)) AS "julySellArea"
,SUM(NVL("julySellNumber",0)) AS "julySellNumber"
,SUM(NVL("julySellAmount",0))/10000 AS "julySellAmount"
,SUM(NVL("augustSellArea",0)) AS "augustSellArea"
,SUM(NVL("augustSellNumber",0)) AS "augustSellNumber"
,SUM(NVL("augustSellAmount",0))/10000 AS "augustSellAmount"
,SUM(NVL("septemberSellArea",0)) AS "septemberSellArea"
,SUM(NVL("septemberSellNumber",0)) AS "septemberSellNumber"
,SUM(NVL("septemberSellAmount",0))/10000 AS "septemberSellAmount"
,SUM(NVL("octoberSellArea",0)) AS "octoberSellArea"
,SUM(NVL("octoberSellNumber",0)) AS "octoberSellNumber"
,SUM(NVL("octoberSellAmount",0))/10000 AS "octoberSellAmount"
,SUM(NVL("novemberSellArea",0)) AS "novemberSellArea"
,SUM(NVL("novemberSellNumber",0)) AS "novemberSellNumber"
,SUM(NVL("novemberSellAmount",0))/10000 AS "novemberSellAmount"
,SUM(NVL("decemberSellArea",0)) AS "decemberSellArea"
,SUM(NVL("decemberSellNumber",0)) AS "decemberSellNumber"
,SUM(NVL("decemberSellAmount",0))/10000 AS "decemberSellAmount"
,SUM(NVL("thisYearSellPlannedAmount",0))  AS "thisYearSellPlannedAmount"--金额（年计划销售）
,SUM(NVL("thisYearSellPlannedNumber",0))  AS "thisYearSellPlannedNumber"--套数（年计划销售）
,SUM(NVL("thisYearSellPlannedArea",0))  AS "thisYearSellPlannedArea"--面积（年计划销售）
,SUM(NVL("firstSeonSellPlannedAmount",0))  AS "firstSeonSellPlannedAmount"--金额（1季度计划销售）
,SUM(NVL("firstSeonSellPlannedNumber",0))  AS "firstSeonSellPlannedNumber"--套数（1季度计划销售）
,SUM(NVL("firstSeonSellPlannedArea",0))  AS "firstSeonSellPlannedArea"--面积（1季度计划销售）
,SUM(NVL("secondSeonSellPlannedAmount",0))  AS "secondSeonSellPlannedAmount"--金额（2季度计划销售）
,SUM(NVL("secondSeonSellPlannedNumber",0))  AS "secondSeonSellPlannedNumber"--套数（2季度计划销售）
,SUM(NVL("secondSeonSellPlannedArea",0))  AS "secondSeonSellPlannedArea"--面积（2季度计划销售）
,SUM(NVL("thirdSeonSellPlannedAmount",0))  AS "thirdSeonSellPlannedAmount"--金额（3季度计划销售）
,SUM(NVL("thirdSeonSellPlannedNumber",0))  AS "thirdSeonSellPlannedNumber"--套数（3季度计划销售）
,SUM(NVL("thirdSeonSellPlannedArea",0))  AS "thirdSeonSellPlannedArea"--面积（3季度计划销售）
,SUM(NVL("fourthSeonSellPlannedAmount",0))  AS "fourthSeonSellPlannedAmount"--金额（4季度计划销售）
,SUM(NVL("fourthSeonSellPlannedNumber",0))  AS "fourthSeonSellPlannedNumber"--套数（4季度计划销售）
,SUM(NVL("fourthSeonSellPlannedArea",0))  AS "fourthSeonSellPlannedArea"--面积（4季度计划销售）
,SUM(NVL("januarySellPlannedAmount",0))  AS "januarySellPlannedAmount"--金额（1月计划销售）
,SUM(NVL("januarySellPlannedNumber",0))  AS "januarySellPlannedNumber"--套数（1月计划销售）
,SUM(NVL("januarySellPlannedArea",0))  AS "januarySellPlannedArea"--面积（1月计划销售）
,SUM(NVL("februarySellPlannedAmount",0))  AS "februarySellPlannedAmount"--金额（2月计划销售）
,SUM(NVL("februarySellPlannedNumber",0))  AS "februarySellPlannedNumber"--套数（2月计划销售）
,SUM(NVL("februarySellPlannedArea",0))  AS "februarySellPlannedArea"--面积（2月计划销售）
,SUM(NVL("marchSellPlannedAmount",0))  AS "marchSellPlannedAmount"--金额（3月计划销售）
,SUM(NVL("marchSellPlannedNumber",0))  AS "marchSellPlannedNumber"--套数（3月计划销售）
,SUM(NVL("marchSellPlannedArea",0))  AS "marchSellPlannedArea"--面积（3月计划销售）
,SUM(NVL("aprilSellPlannedAmount",0))  AS "aprilSellPlannedAmount"--金额（4月计划销售）
,SUM(NVL("aprilSellPlannedNumber",0))  AS "aprilSellPlannedNumber"--套数（4月计划销售）
,SUM(NVL("aprilSellPlannedArea",0))  AS "aprilSellPlannedArea"--面积（4月计划销售）
,SUM(NVL("maySellPlannedAmount",0))  AS "maySellPlannedAmount"--金额（5月计划销售）
,SUM(NVL("maySellPlannedNumber",0))  AS "maySellPlannedNumber"--套数（5月计划销售）
,SUM(NVL("maySellPlannedArea",0))  AS "maySellPlannedArea"--面积（5月计划销售）
,SUM(NVL("juneSellPlannedAmount",0))  AS "juneSellPlannedAmount"--金额（6月计划销售）
,SUM(NVL("juneSellPlannedNumber",0))  AS "juneSellPlannedNumber"--套数（6月计划销售）
,SUM(NVL("juneSellPlannedArea",0))  AS "juneSellPlannedArea"--面积（6月计划销售）
,SUM(NVL("julySellPlannedAmount",0))  AS "julySellPlannedAmount"--金额（7月计划销售）
,SUM(NVL("julySellPlannedNumber",0))  AS "julySellPlannedNumber"--套数（7月计划销售）
,SUM(NVL("julySellPlannedArea",0))  AS "julySellPlannedArea"--面积（7月计划销售）
,SUM(NVL("augustSellPlannedAmount",0))  AS "augustSellPlannedAmount"--金额（8月计划销售）
,SUM(NVL("augustSellPlannedNumber",0))  AS "augustSellPlannedNumber"--套数（8月计划销售）
,SUM(NVL("augustSellPlannedArea",0))  AS "augustSellPlannedArea"--面积（8月计划销售）
,SUM(NVL("septemberSellPlannedAmount",0))  AS "septemberSellPlannedAmount"--金额（10月计划销售）
,SUM(NVL("septemberSellPlannedNumber",0))  AS "septemberSellPlannedNumber"--套数（10月计划销售）
,SUM(NVL("septemberSellPlannedArea",0))  AS "septemberSellPlannedArea"--面积（10月计划销售）
,SUM(NVL("octoberSellPlannedAmount",0))  AS "octoberSellPlannedAmount"--金额（10月计划销售）
,SUM(NVL("octoberSellPlannedNumber",0))  AS "octoberSellPlannedNumber"--套数（10月计划销售）
,SUM(NVL("octoberSellPlannedArea",0))  AS "octoberSellPlannedArea"--面积（10月计划销售）
,SUM(NVL("novemberSellPlannedAmount",0))  AS "novemberSellPlannedAmount"--金额（11月计划销售）
,SUM(NVL("novemberSellPlannedNumber",0))  AS "novemberSellPlannedNumber"--套数（11月计划销售）
,SUM(NVL("novemberSellPlannedArea",0))  AS "novemberSellPlannedArea"--面积（11月计划销售）
,SUM(NVL("decemberSellPlannedAmount",0))  AS "decemberSellPlannedAmount"--金额（12月计划销售）
,SUM(NVL("decemberSellPlannedNumber",0))  AS "decemberSellPlannedNumber"--套数（12月计划销售）
,SUM(NVL("decemberSellPlannedArea",0))  AS "decemberSellPlannedArea"--面积（12月计划销售）


 FROM  SWM_SUPPLY_MONITOR_LIST LIST
		 --WHERE "thisYearSupplyAmount">0
		 WHERE 
		 --根据筛选条件过滤公司Z
		 "objId" IN (
	SELECT 	"objId"  FROM SWM_SUPPLY_MONITOR_LIST  	LIST	

	START WITH LIST."parentId"=unitid
		CONNECT BY PRIOR LIST."objId"=LIST."parentId"
		 )
		 		 --过滤无分期
		 AND  "objId" NOT  IN (
	SELECT 	"objId"  FROM SWM_SUPPLY_MONITOR_LIST  	LIST	

	START WITH "projConstitute"  LIKE '%无分期%'
		CONNECT BY PRIOR LIST."objId"= LIST."parentId"
		 )
		 


 GROUP BY "PROJ_ID"
,"OBJ_TYPE"
,"OBJ_ID"
,"OBJ_NAME"
,"OBJ_PARENT_ID"
,"LEVEL"
,"LEVEL_ORDER"
,"ORDER_CODE"
,"COMPANY_NAME"
,"COMPANY_ID"
,"COMPANY_ORDER_HIERARCHY_CODE"
,"id"
,"projConstitute"
,"parentId"
,"ORDER_HIERARCHY_CODE"
,"objId"
,"objType"
,"buildProductTypeName"
,"ownBuildProductTypeId"
,"buildProductTypeId"
 ORDER BY "COMPANY_ORDER_HIERARCHY_CODE","ORDER_CODE"
 ;
  --AND P1.PROJECT_ID=P2.PROJ_ID 


END P_SWM_SUPPLY_MONITOR;

/
--------------------------------------------------------
--  DDL for Procedure P_SWM_SUPPLY_MONITOR_INI_LIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SWM_SUPPLY_MONITOR_INI_LIST" 
AS 
-----用于抓取监控排行榜
BEGIN 

----------------------------------------------

DELETE SWM_SUPPLY_MONITOR_TABLE;
--CREATE TABLE  SWM_SUPPLY_MONITOR_TABLE AS 
INSERT INTO SWM_SUPPLY_MONITOR_TABLE
------分期子级业态
SELECT GET_UUID() AS"id"
,PRODUCT_TYPE_NAME AS "projConstitute"
-- ,STAGE_ID AS "parentId"
,PROJ_ID AS PROJ_ID
,PROJ_ID||'_'||STAGE_ID AS OBJ_PARENT_ID
,PRODUCT_TYPE_NAME AS OBJ_NAME
,ORDER_CODE||PRODUCT_TYPE_SHORT_CODE AS ORDER_HIERARCHY_CODE
,PROJ_ID||'_'||STAGE_ID||'_'||PRODUCT_TYPE_ID AS "OBJID"
,PRODUCT_TYPE_NAME AS "objType"
,PRODUCT_TYPE_NAME AS "buildProductTypeName"
, PRODUCT_TYPE_ID AS "ownBuildProductTypeId"
,PRODUCT_TYPE_ID AS  "buildProductTypeId"
,'3' AS "LEVEL"
,"全案可售户数" AS "poTotalSaleCount"
,"全案可售面积" AS "poTotalSaleArea"
,"全案可售货值" AS "poTotalSaleAmount"
,"已取证面积" AS "rpTotalArea"
,"已取证货值" AS "rpTotalAmount"
,"已取证套数" AS "rpTotalCount"
,"已售面积" AS "poSaleArea"
,"已售货值" AS "poSaleAmount"
,"已售套数" AS "poSaleCount"
,"已取证库存面积" AS "rpSurplusArea"
,"已取证库存货值" AS "rpSurplusAmount"
,"已取证库存套数" AS "rpSurplusCount"
,"全案剩余货值" AS "poSurplusSaleAmount"
,"全案剩余面积" AS "poSurplusSaleArea"
,"全案剩余套数" AS "poSurplusSaleCount"
,"本年供货面积" AS "thisYearActualSupplyArea"
,"本年供货套数" AS "thisYearActualSupplyNumber"
,"本年供货金额" AS "thisYearActualSupplyAmount"
,"一季度供货面积" AS "firstSeasonActualSupplyArea"
,"一季度供货套数" AS "firstSeasonActualSupplyNumber"
,"一季度供货金额" AS "firstSeasonActualSupplyAmount"
,"二季度供货面积" AS "secondSeasonActualSupplyArea"
,"二季度供货套数" AS "secondSeasonActualSupplyNumber"
,"二季度供货金额" AS "secondSeasonActualSupplyAmount"
,"三季度供货面积" AS "thirdSeasonActualSupplyArea"
,"三季度供货套数" AS "thirdSeasonActualSupplyNumber"
,"三季度供货金额" AS "thirdSeasonActualSupplyAmount"
,"四季度供货面积" AS "fourthSeasonActualSupplyArea"
,"四季度供货套数" AS "fourthSeasonActualSupplyNumber"
,"四季度供货金额" AS "fourthSeasonActualSupplyAmount"
,"1月_供货面积" AS "januaryActualSupplyArea"
,"1月_供货套数" AS "januaryActualSupplyNumber"
,"1月_供货金额" AS "januaryActualSupplyAmount"
,"2月_供货面积" AS "februaryActualSupplyArea"
,"2月_供货套数" AS "februaryActualSupplyNumber"
,"2月_供货金额" AS "februaryActualSupplyAmount"
,"3月_供货面积" AS "marchActualSupplyArea"
,"3月_供货套数" AS "marchActualSupplyNumber"
,"3月_供货金额" AS "marchActualSupplyAmount"
,"4月_供货面积" AS "aprilActualSupplyArea"
,"4月_供货套数" AS "aprilActualSupplyNumber"
,"4月_供货金额" AS "aprilActualSupplyAmount"
,"5月_供货面积" AS "mayActualSupplyArea"
,"5月_供货套数" AS "mayActualSupplyNumber"
,"5月_供货金额" AS "mayActualSupplyAmount"
,"6月_供货面积" AS "juneActualSupplyArea"
,"6月_供货套数" AS "juneActualSupplyNumber"
,"6月_供货金额" AS "juneActualSupplyAmount"
,"7月_供货面积" AS "julyActualSupplyArea"
,"7月_供货套数" AS "julyActualSupplyNumber"
,"7月_供货金额" AS "julyActualSupplyAmount"
,"8月_供货面积" AS "augustActualSupplyArea"
,"8月_供货套数" AS "augustActualSupplyNumber"
,"8月_供货金额" AS "augustActualSupplyAmount"
,"9月_供货面积" AS "septemberActualSupplyArea"
,"9月_供货套数" AS "septemberActualSupplyNumber"
,"9月_供货金额" AS "septemberActualSupplyAmount"
,"10月_供货面积" AS "octoberActualSupplyArea"
,"10月_供货套数" AS "octoberActualSupplyNumber"
,"10月_供货金额" AS "octoberActualSupplyAmount"
,"11月_供货面积" AS "novemberActualSupplyArea"
,"11月_供货套数" AS "novemberActualSupplyNumber"
,"11月_供货金额" AS "novemberActualSupplyAmount"
,"12月_供货面积" AS "decemberActualSupplyArea"
,"12月_供货套数" AS "decemberActualSupplyNumber"
,"12月_供货金额" AS "decemberActualSupplyAmount"
,"本年销售面积" AS "thisYearSellArea"
,"本年销售套数" AS "thisYearSellNumber"
,"本年销售金额" AS "thisYearSellAmount"
,"一季度销售面积" AS "firstSellArea"
,"一季度销售套数" AS "firstSellNumber"
,"一季度销售金额" AS "firstSellAmount"
,"二季度销售面积" AS "secondSeasonSellArea"
,"二季度销售套数" AS "secondSeasonSellNumber"
,"二季度销售金额" AS "secondSeasonSellAmount"
,"三季度销售面积" AS "thirdSeasonSellArea"
,"三季度销售套数" AS "thirdSeasonSellNumber"
,"三季度销售金额" AS "thirdSeasonSellAmount"
,"四季度销售面积" AS "fourthSeasonSellArea"
,"四季度销售套数" AS "fourthSeasonSellNumber"
,"四季度销售金额" AS "fourthSeasonSellAmount"
,"1月_销售面积" AS "januarySellArea"
,"1月_销售套数" AS "januarySellNumber"
,"1月_销售金额" AS "januarySellAmount"
,"2月_销售面积" AS "februarySellArea"
,"2月_销售套数" AS "februarySellNumber"
,"2月_销售金额" AS "februarySellAmount"
,"3月_销售面积" AS "marchSellArea"
,"3月_销售套数" AS "marchSellNumber"
,"3月_销售金额" AS "marchSellAmount"
,"4月_销售面积" AS "aprilSellArea"
,"4月_销售套数" AS "aprilSellNumber"
,"4月_销售金额" AS "aprilSellAmount"
,"5月_销售面积" AS "maySellArea"
,"5月_销售套数" AS "maySellNumber"
,"5月_销售金额" AS "maySellAmount"
,"6月_销售面积" AS "juneSellArea"
,"6月_销售套数" AS "juneSellNumber"
,"6月_销售金额" AS "juneSellAmount"
,"7月_销售面积" AS "julySellArea"
,"7月_销售套数" AS "julySellNumber"
,"7月_销售金额" AS "julySellAmount"
,"8月_销售面积" AS "augustSellArea"
,"8月_销售套数" AS "augustSellNumber"
,"8月_销售金额" AS "augustSellAmount"
,"9月_销售面积" AS "septemberSellArea"
,"9月_销售套数" AS "septemberSellNumber"
,"9月_销售金额" AS "septemberSellAmount"
,"10月_销售面积" AS "octoberSellArea"
,"10月_销售套数" AS "octoberSellNumber"
,"10月_销售金额" AS "octoberSellAmount"
,"11月_销售面积" AS "novemberSellArea"
,"11月_销售套数" AS "novemberSellNumber"
,"11月_销售金额" AS "novemberSellAmount"
,"12月_销售面积" AS "decemberSellArea"
,"12月_销售套数" AS "decemberSellNumber"
,"12月_销售金额" AS "decemberSellAmount"


FROM 
(		
							 
SELECT A.ID as PROJ_ID,A.PROJECT_NAME,B.STAGE_NAME,B.ID AS STAGE_ID--,B.ID AS PARENT_ID
,F."一级业态"
,PRODUCT_TYPE_NAME
, PRODUCT_TYPE_ID
,B.ORDER_CODE,PRODUCT_TYPE_SHORT_CODE
,SUM(F.全案可售户数) AS 全案可售户数
,SUM(F.全案可售面积) AS 全案可售面积
,SUM(F.全案可售货值) AS 全案可售货值
,SUM(F.已取证面积) AS 已取证面积
,SUM(F.已取证货值) AS 已取证货值
,SUM(F.已取证套数) AS 已取证套数
,SUM(F.已售面积) AS 已售面积
,SUM(F.已售货值) AS 已售货值
,SUM(F.已售套数) AS 已售套数
,SUM(F.已取证库存面积) AS 已取证库存面积
,SUM(F.已取证库存货值) AS 已取证库存货值
,SUM(F.已取证库存套数) AS 已取证库存套数
,SUM(F.全案剩余货值) AS 全案剩余货值
,SUM(F.全案剩余面积) AS 全案剩余面积
,SUM(F.全案剩余套数) AS 全案剩余套数
,SUM(NVL(本年供货面积,0)) AS "本年供货面积"
,SUM(NVL(本年供货套数,0)) AS "本年供货套数"
,SUM(NVL(本年供货金额,0)) AS "本年供货金额"
,SUM(NVL(一季度供货面积,0)) AS "一季度供货面积"
,SUM(NVL(一季度供货套数,0)) AS "一季度供货套数"
,SUM(NVL(一季度供货金额,0)) AS "一季度供货金额"
,SUM(NVL(二季度供货面积,0)) AS "二季度供货面积"
,SUM(NVL(二季度供货套数,0)) AS "二季度供货套数"
,SUM(NVL(二季度供货金额,0)) AS "二季度供货金额"
,SUM(NVL(三季度供货面积,0)) AS "三季度供货面积"
,SUM(NVL(三季度供货套数,0)) AS "三季度供货套数"
,SUM(NVL(三季度供货金额,0)) AS "三季度供货金额"
,SUM(NVL(四季度供货面积,0)) AS "四季度供货面积"
,SUM(NVL(四季度供货套数,0)) AS "四季度供货套数"
,SUM(NVL(四季度供货金额,0)) AS "四季度供货金额"
,SUM(NVL("1月_供货面积",0)) AS "1月_供货面积"
,SUM(NVL("1月_供货套数",0)) AS "1月_供货套数"
,SUM(NVL("1月_供货金额",0)) AS "1月_供货金额"
,SUM(NVL("2月_供货面积",0)) AS "2月_供货面积"
,SUM(NVL("2月_供货套数",0)) AS "2月_供货套数"
,SUM(NVL("2月_供货金额",0)) AS "2月_供货金额"
,SUM(NVL("3月_供货面积",0)) AS "3月_供货面积"
,SUM(NVL("3月_供货套数",0)) AS "3月_供货套数"
,SUM(NVL("3月_供货金额",0)) AS "3月_供货金额"
,SUM(NVL("4月_供货面积",0)) AS "4月_供货面积"
,SUM(NVL("4月_供货套数",0)) AS "4月_供货套数"
,SUM(NVL("4月_供货金额",0)) AS "4月_供货金额"
,SUM(NVL("5月_供货面积",0)) AS "5月_供货面积"
,SUM(NVL("5月_供货套数",0)) AS "5月_供货套数"
,SUM(NVL("5月_供货金额",0)) AS "5月_供货金额"
,SUM(NVL("6月_供货面积",0)) AS "6月_供货面积"
,SUM(NVL("6月_供货套数",0)) AS "6月_供货套数"
,SUM(NVL("6月_供货金额",0)) AS "6月_供货金额"
,SUM(NVL("7月_供货面积",0)) AS "7月_供货面积"
,SUM(NVL("7月_供货套数",0)) AS "7月_供货套数"
,SUM(NVL("7月_供货金额",0)) AS "7月_供货金额"
,SUM(NVL("8月_供货面积",0)) AS "8月_供货面积"
,SUM(NVL("8月_供货套数",0)) AS "8月_供货套数"
,SUM(NVL("8月_供货金额",0)) AS "8月_供货金额"
,SUM(NVL("9月_供货面积",0)) AS "9月_供货面积"
,SUM(NVL("9月_供货套数",0)) AS "9月_供货套数"
,SUM(NVL("9月_供货金额",0)) AS "9月_供货金额"
,SUM(NVL("10月_供货面积",0)) AS "10月_供货面积"
,SUM(NVL("10月_供货套数",0)) AS "10月_供货套数"
,SUM(NVL("10月_供货金额",0)) AS "10月_供货金额"
,SUM(NVL("11月_供货面积",0)) AS "11月_供货面积"
,SUM(NVL("11月_供货套数",0)) AS "11月_供货套数"
,SUM(NVL("11月_供货金额",0)) AS "11月_供货金额"
,SUM(NVL("12月_供货面积",0)) AS "12月_供货面积"
,SUM(NVL("12月_供货套数",0)) AS "12月_供货套数"
,SUM(NVL("12月_供货金额",0)) AS "12月_供货金额"
,SUM(NVL(本年销售面积,0)) AS "本年销售面积"
,SUM(NVL(本年销售套数,0)) AS "本年销售套数"
,SUM(NVL(本年销售金额,0)) AS "本年销售金额"
,SUM(NVL(一季度销售面积,0)) AS "一季度销售面积"
,SUM(NVL(一季度销售套数,0)) AS "一季度销售套数"
,SUM(NVL(一季度销售金额,0)) AS "一季度销售金额"
,SUM(NVL(二季度销售面积,0)) AS "二季度销售面积"
,SUM(NVL(二季度销售套数,0)) AS "二季度销售套数"
,SUM(NVL(二季度销售金额,0)) AS "二季度销售金额"
,SUM(NVL(三季度销售面积,0)) AS "三季度销售面积"
,SUM(NVL(三季度销售套数,0)) AS "三季度销售套数"
,SUM(NVL(三季度销售金额,0)) AS "三季度销售金额"
,SUM(NVL(四季度销售面积,0)) AS "四季度销售面积"
,SUM(NVL(四季度销售套数,0)) AS "四季度销售套数"
,SUM(NVL(四季度销售金额,0)) AS "四季度销售金额"
,SUM(NVL("1月_销售面积",0)) AS "1月_销售面积"
,SUM(NVL("1月_销售套数",0)) AS "1月_销售套数"
,SUM(NVL("1月_销售金额",0)) AS "1月_销售金额"
,SUM(NVL("2月_销售面积",0)) AS "2月_销售面积"
,SUM(NVL("2月_销售套数",0)) AS "2月_销售套数"
,SUM(NVL("2月_销售金额",0)) AS "2月_销售金额"
,SUM(NVL("3月_销售面积",0)) AS "3月_销售面积"
,SUM(NVL("3月_销售套数",0)) AS "3月_销售套数"
,SUM(NVL("3月_销售金额",0)) AS "3月_销售金额"
,SUM(NVL("4月_销售面积",0)) AS "4月_销售面积"
,SUM(NVL("4月_销售套数",0)) AS "4月_销售套数"
,SUM(NVL("4月_销售金额",0)) AS "4月_销售金额"
,SUM(NVL("5月_销售面积",0)) AS "5月_销售面积"
,SUM(NVL("5月_销售套数",0)) AS "5月_销售套数"
,SUM(NVL("5月_销售金额",0)) AS "5月_销售金额"
,SUM(NVL("6月_销售面积",0)) AS "6月_销售面积"
,SUM(NVL("6月_销售套数",0)) AS "6月_销售套数"
,SUM(NVL("6月_销售金额",0)) AS "6月_销售金额"
,SUM(NVL("7月_销售面积",0)) AS "7月_销售面积"
,SUM(NVL("7月_销售套数",0)) AS "7月_销售套数"
,SUM(NVL("7月_销售金额",0)) AS "7月_销售金额"
,SUM(NVL("8月_销售面积",0)) AS "8月_销售面积"
,SUM(NVL("8月_销售套数",0)) AS "8月_销售套数"
,SUM(NVL("8月_销售金额",0)) AS "8月_销售金额"
,SUM(NVL("9月_销售面积",0)) AS "9月_销售面积"
,SUM(NVL("9月_销售套数",0)) AS "9月_销售套数"
,SUM(NVL("9月_销售金额",0)) AS "9月_销售金额"
,SUM(NVL("10月_销售面积",0)) AS "10月_销售面积"
,SUM(NVL("10月_销售套数",0)) AS "10月_销售套数"
,SUM(NVL("10月_销售金额",0)) AS "10月_销售金额"
,SUM(NVL("11月_销售面积",0)) AS "11月_销售面积"
,SUM(NVL("11月_销售套数",0)) AS "11月_销售套数"
,SUM(NVL("11月_销售金额",0)) AS "11月_销售金额"
,SUM(NVL("12月_销售面积",0)) AS "12月_销售面积"
,SUM(NVL("12月_销售套数",0)) AS "12月_销售套数"
,SUM(NVL("12月_销售金额",0)) AS "12月_销售金额"
FROM SYS_PROJECT A 
INNER JOIN SYS_PROJECT_STAGE B ON A.ID=B.PROJECT_ID
--FULL JOIN (SELECT * FROM MDM_BUILD_PRODUCT_TYPE  WHERE PRODUCT_TYPE_LEVEL=1 AND IS_END=0) C ON 1=1
LEFT JOIN 
(
	SELECT PROJ_ID,STAGE_ID,STAGE_NAME,"一级业态",PRODUCT_TYPE_NAME,PD.ID AS  PRODUCT_TYPE_ID , PRODUCT_TYPE_SHORT_CODE
	,SUM(NVL(总车位数,0))+SUM(NVL(总户数,0))  AS  全案可售户数
	,SUM(NVL(总可售面积,0))  AS 全案可售面积
	,SUM(NVL(A_当前最新版目标货值,0))  AS 全案可售货值
	,SUM(NVL(已取证建筑面积,0))  AS  已取证面积
	,SUM(NVL(已取证货值,0)) AS  已取证货值
	,SUM(NVL(已取证套数,0)) AS 已取证套数
	,SUM(NVL(已售建筑面积,0))  AS 已售面积
	,SUM(NVL(已售货值,0)) AS 已售货值
	,SUM(NVL(已售套数,0)) AS 已售套数
	,SUM(NVL(库存建筑面积,0))  AS 已取证库存面积
	,SUM(NVL(库存货值,0)) AS 已取证库存货值
	,SUM(NVL(库存套数,0)) AS 已取证库存套数
	,SUM(NVL(全案剩余货值,0)) AS 全案剩余货值
	,SUM(NVL(全案剩余面积,0)) AS 全案剩余面积
	,SUM(NVL(全案剩余套数,0))  AS 全案剩余套数
	FROM SWM_DT_VALUE_TABLE   
	LEFT JOIN MDM_BUILD_PRODUCT_TYPE PD ON PD.PRODUCT_TYPE_NAME="一级业态"
	--WHERE  PROJECT_NAME LIKE '%温州%' 
	GROUP BY PROJ_ID,STAGE_ID,STAGE_NAME,"一级业态",PRODUCT_TYPE_SHORT_CODE,PD.ID ,PRODUCT_TYPE_NAME
) F ON F.STAGE_ID=B.ID --AND F."一级业态"=F.PRODUCT_TYPE_NAME
LEFT  JOIN  SWM_MONTH_RealSUPPLY_DTL D ON  D.STAGE_ID=B.ID   AND D."实际供货年份"=TO_CHAR(SYSDATE,'YYYY') AND F.PRODUCT_TYPE_NAME=D."一级业态"
LEFT JOIN  SWM_MOTH_RealSALE_DTL E ON  E.STAGE_ID=B.ID      AND 销售年份=TO_CHAR(SYSDATE,'YYYY')  AND F.PRODUCT_TYPE_NAME=E."PRODUCT_NAME"
  --WHERE  A.PROJECT_NAME LIKE '%北京西派国际%'  
GROUP BY A.ID,A.PROJECT_NAME,B.STAGE_NAME,B.ID
--,C.ID,F.PRODUCT_TYPE_NAME
,F."一级业态"
, B.ORDER_CODE,PRODUCT_TYPE_SHORT_CODE,PRODUCT_TYPE_ID,PRODUCT_TYPE_NAME
) A2

------------------
-------分期
 UNION ALL

SELECT GET_UUID() AS"id"
,NULL AS "projConstitute"
-- ,STAGE_ID AS "parentId"
,PROJ_ID AS PROJ_ID
,PROJ_ID AS BIZ_PARENT_ID
,STAGE_NAME AS OBJ_NAME
,ORDER_CODE AS ORDER_HIERARCHY_CODE
,PROJ_ID||'_'||STAGE_ID AS "objId"
,'分期' AS "objType"
, NULL AS "buildProductTypeName"
,NULL  AS "ownBuildProductTypeId"
,NULL AS  "buildProductTypeId"
,'2' AS "LEVEL"
,"全案可售户数" AS "poTotalSaleCount"
,"全案可售面积" AS "poTotalSaleArea"
,"全案可售货值" AS "poTotalSaleAmount"
,"已取证面积" AS "rpTotalArea"
,"已取证货值" AS "rpTotalAmount"
,"已取证套数" AS "rpTotalCount"
,"已售面积" AS "poSaleArea"
,"已售货值" AS "poSaleAmount"
,"已售套数" AS "poSaleCount"
,"已取证库存面积" AS "rpSurplusArea"
,"已取证库存货值" AS "rpSurplusAmount"
,"已取证库存套数" AS "rpSurplusCount"
,"全案剩余货值" AS "poSurplusSaleAmount"
,"全案剩余面积" AS "poSurplusSaleArea"
,"全案剩余套数" AS "poSurplusSaleCount"
,"本年供货面积" AS "thisYearActualSupplyArea"
,"本年供货套数" AS "thisYearActualSupplyNumber"
,"本年供货金额" AS "thisYearActualSupplyAmount"
,"一季度供货面积" AS "firstSeasonActualSupplyArea"
,"一季度供货套数" AS "firstSeasonActualSupplyNumber"
,"一季度供货金额" AS "firstSeasonActualSupplyAmount"
,"二季度供货面积" AS "secondSeasonActualSupplyArea"
,"二季度供货套数" AS "secondSeasonActualSupplyNumber"
,"二季度供货金额" AS "secondSeasonActualSupplyAmount"
,"三季度供货面积" AS "thirdSeasonActualSupplyArea"
,"三季度供货套数" AS "thirdSeasonActualSupplyNumber"
,"三季度供货金额" AS "thirdSeasonActualSupplyAmount"
,"四季度供货面积" AS "fourthSeasonActualSupplyArea"
,"四季度供货套数" AS "fourthSeasonActualSupplyNumber"
,"四季度供货金额" AS "fourthSeasonActualSupplyAmount"
,"1月_供货面积" AS "januaryActualSupplyArea"
,"1月_供货套数" AS "januaryActualSupplyNumber"
,"1月_供货金额" AS "januaryActualSupplyAmount"
,"2月_供货面积" AS "februaryActualSupplyArea"
,"2月_供货套数" AS "februaryActualSupplyNumber"
,"2月_供货金额" AS "februaryActualSupplyAmount"
,"3月_供货面积" AS "marchActualSupplyArea"
,"3月_供货套数" AS "marchActualSupplyNumber"
,"3月_供货金额" AS "marchActualSupplyAmount"
,"4月_供货面积" AS "aprilActualSupplyArea"
,"4月_供货套数" AS "aprilActualSupplyNumber"
,"4月_供货金额" AS "aprilActualSupplyAmount"
,"5月_供货面积" AS "mayActualSupplyArea"
,"5月_供货套数" AS "mayActualSupplyNumber"
,"5月_供货金额" AS "mayActualSupplyAmount"
,"6月_供货面积" AS "juneActualSupplyArea"
,"6月_供货套数" AS "juneActualSupplyNumber"
,"6月_供货金额" AS "juneActualSupplyAmount"
,"7月_供货面积" AS "julyActualSupplyArea"
,"7月_供货套数" AS "julyActualSupplyNumber"
,"7月_供货金额" AS "julyActualSupplyAmount"
,"8月_供货面积" AS "augustActualSupplyArea"
,"8月_供货套数" AS "augustActualSupplyNumber"
,"8月_供货金额" AS "augustActualSupplyAmount"
,"9月_供货面积" AS "septemberActualSupplyArea"
,"9月_供货套数" AS "septemberActualSupplyNumber"
,"9月_供货金额" AS "septemberActualSupplyAmount"
,"10月_供货面积" AS "octoberActualSupplyArea"
,"10月_供货套数" AS "octoberActualSupplyNumber"
,"10月_供货金额" AS "octoberActualSupplyAmount"
,"11月_供货面积" AS "novemberActualSupplyArea"
,"11月_供货套数" AS "novemberActualSupplyNumber"
,"11月_供货金额" AS "novemberActualSupplyAmount"
,"12月_供货面积" AS "decemberActualSupplyArea"
,"12月_供货套数" AS "decemberActualSupplyNumber"
,"12月_供货金额" AS "decemberActualSupplyAmount"
,"本年销售面积" AS "thisYearSellArea"
,"本年销售套数" AS "thisYearSellNumber"
,"本年销售金额" AS "thisYearSellAmount"
,"一季度销售面积" AS "firstSellArea"
,"一季度销售套数" AS "firstSellNumber"
,"一季度销售金额" AS "firstSellAmount"
,"二季度销售面积" AS "secondSeasonSellArea"
,"二季度销售套数" AS "secondSeasonSellNumber"
,"二季度销售金额" AS "secondSeasonSellAmount"
,"三季度销售面积" AS "thirdSeasonSellArea"
,"三季度销售套数" AS "thirdSeasonSellNumber"
,"三季度销售金额" AS "thirdSeasonSellAmount"
,"四季度销售面积" AS "fourthSeasonSellArea"
,"四季度销售套数" AS "fourthSeasonSellNumber"
,"四季度销售金额" AS "fourthSeasonSellAmount"
,"1月_销售面积" AS "januarySellArea"
,"1月_销售套数" AS "januarySellNumber"
,"1月_销售金额" AS "januarySellAmount"
,"2月_销售面积" AS "februarySellArea"
,"2月_销售套数" AS "februarySellNumber"
,"2月_销售金额" AS "februarySellAmount"
,"3月_销售面积" AS "marchSellArea"
,"3月_销售套数" AS "marchSellNumber"
,"3月_销售金额" AS "marchSellAmount"
,"4月_销售面积" AS "aprilSellArea"
,"4月_销售套数" AS "aprilSellNumber"
,"4月_销售金额" AS "aprilSellAmount"
,"5月_销售面积" AS "maySellArea"
,"5月_销售套数" AS "maySellNumber"
,"5月_销售金额" AS "maySellAmount"
,"6月_销售面积" AS "juneSellArea"
,"6月_销售套数" AS "juneSellNumber"
,"6月_销售金额" AS "juneSellAmount"
,"7月_销售面积" AS "julySellArea"
,"7月_销售套数" AS "julySellNumber"
,"7月_销售金额" AS "julySellAmount"
,"8月_销售面积" AS "augustSellArea"
,"8月_销售套数" AS "augustSellNumber"
,"8月_销售金额" AS "augustSellAmount"
,"9月_销售面积" AS "septemberSellArea"
,"9月_销售套数" AS "septemberSellNumber"
,"9月_销售金额" AS "septemberSellAmount"
,"10月_销售面积" AS "octoberSellArea"
,"10月_销售套数" AS "octoberSellNumber"
,"10月_销售金额" AS "octoberSellAmount"
,"11月_销售面积" AS "novemberSellArea"
,"11月_销售套数" AS "novemberSellNumber"
,"11月_销售金额" AS "novemberSellAmount"
,"12月_销售面积" AS "decemberSellArea"
,"12月_销售套数" AS "decemberSellNumber"
,"12月_销售金额" AS "decemberSellAmount"


FROM 
(		
							 
SELECT A.ID as PROJ_ID,A.PROJECT_NAME,B.STAGE_NAME,B.ID AS STAGE_ID--,B.ID AS PARENT_ID
--,F."一级业态"
--,PRODUCT_TYPE_NAME
--, PRODUCT_TYPE_ID
,B.ORDER_CODE
--,PRODUCT_TYPE_SHORT_CODE
,SUM(F.全案可售户数) AS 全案可售户数
,SUM(F.全案可售面积) AS 全案可售面积
,SUM(F.全案可售货值) AS 全案可售货值
,SUM(F.已取证面积) AS 已取证面积
,SUM(F.已取证货值) AS 已取证货值
,SUM(F.已取证套数) AS 已取证套数
,SUM(F.已售面积) AS 已售面积
,SUM(F.已售货值) AS 已售货值
,SUM(F.已售套数) AS 已售套数
,SUM(F.已取证库存面积) AS 已取证库存面积
,SUM(F.已取证库存货值) AS 已取证库存货值
,SUM(F.已取证库存套数) AS 已取证库存套数
,SUM(F.全案剩余货值) AS 全案剩余货值
,SUM(F.全案剩余面积) AS 全案剩余面积
,SUM(F.全案剩余套数) AS 全案剩余套数
,SUM(NVL(本年供货面积,0)) AS "本年供货面积"
,SUM(NVL(本年供货套数,0)) AS "本年供货套数"
,SUM(NVL(本年供货金额,0)) AS "本年供货金额"
,SUM(NVL(一季度供货面积,0)) AS "一季度供货面积"
,SUM(NVL(一季度供货套数,0)) AS "一季度供货套数"
,SUM(NVL(一季度供货金额,0)) AS "一季度供货金额"
,SUM(NVL(二季度供货面积,0)) AS "二季度供货面积"
,SUM(NVL(二季度供货套数,0)) AS "二季度供货套数"
,SUM(NVL(二季度供货金额,0)) AS "二季度供货金额"
,SUM(NVL(三季度供货面积,0)) AS "三季度供货面积"
,SUM(NVL(三季度供货套数,0)) AS "三季度供货套数"
,SUM(NVL(三季度供货金额,0)) AS "三季度供货金额"
,SUM(NVL(四季度供货面积,0)) AS "四季度供货面积"
,SUM(NVL(四季度供货套数,0)) AS "四季度供货套数"
,SUM(NVL(四季度供货金额,0)) AS "四季度供货金额"
,SUM(NVL("1月_供货面积",0)) AS "1月_供货面积"
,SUM(NVL("1月_供货套数",0)) AS "1月_供货套数"
,SUM(NVL("1月_供货金额",0)) AS "1月_供货金额"
,SUM(NVL("2月_供货面积",0)) AS "2月_供货面积"
,SUM(NVL("2月_供货套数",0)) AS "2月_供货套数"
,SUM(NVL("2月_供货金额",0)) AS "2月_供货金额"
,SUM(NVL("3月_供货面积",0)) AS "3月_供货面积"
,SUM(NVL("3月_供货套数",0)) AS "3月_供货套数"
,SUM(NVL("3月_供货金额",0)) AS "3月_供货金额"
,SUM(NVL("4月_供货面积",0)) AS "4月_供货面积"
,SUM(NVL("4月_供货套数",0)) AS "4月_供货套数"
,SUM(NVL("4月_供货金额",0)) AS "4月_供货金额"
,SUM(NVL("5月_供货面积",0)) AS "5月_供货面积"
,SUM(NVL("5月_供货套数",0)) AS "5月_供货套数"
,SUM(NVL("5月_供货金额",0)) AS "5月_供货金额"
,SUM(NVL("6月_供货面积",0)) AS "6月_供货面积"
,SUM(NVL("6月_供货套数",0)) AS "6月_供货套数"
,SUM(NVL("6月_供货金额",0)) AS "6月_供货金额"
,SUM(NVL("7月_供货面积",0)) AS "7月_供货面积"
,SUM(NVL("7月_供货套数",0)) AS "7月_供货套数"
,SUM(NVL("7月_供货金额",0)) AS "7月_供货金额"
,SUM(NVL("8月_供货面积",0)) AS "8月_供货面积"
,SUM(NVL("8月_供货套数",0)) AS "8月_供货套数"
,SUM(NVL("8月_供货金额",0)) AS "8月_供货金额"
,SUM(NVL("9月_供货面积",0)) AS "9月_供货面积"
,SUM(NVL("9月_供货套数",0)) AS "9月_供货套数"
,SUM(NVL("9月_供货金额",0)) AS "9月_供货金额"
,SUM(NVL("10月_供货面积",0)) AS "10月_供货面积"
,SUM(NVL("10月_供货套数",0)) AS "10月_供货套数"
,SUM(NVL("10月_供货金额",0)) AS "10月_供货金额"
,SUM(NVL("11月_供货面积",0)) AS "11月_供货面积"
,SUM(NVL("11月_供货套数",0)) AS "11月_供货套数"
,SUM(NVL("11月_供货金额",0)) AS "11月_供货金额"
,SUM(NVL("12月_供货面积",0)) AS "12月_供货面积"
,SUM(NVL("12月_供货套数",0)) AS "12月_供货套数"
,SUM(NVL("12月_供货金额",0)) AS "12月_供货金额"
,SUM(NVL(本年销售面积,0)) AS "本年销售面积"
,SUM(NVL(本年销售套数,0)) AS "本年销售套数"
,SUM(NVL(本年销售金额,0)) AS "本年销售金额"
,SUM(NVL(一季度销售面积,0)) AS "一季度销售面积"
,SUM(NVL(一季度销售套数,0)) AS "一季度销售套数"
,SUM(NVL(一季度销售金额,0)) AS "一季度销售金额"
,SUM(NVL(二季度销售面积,0)) AS "二季度销售面积"
,SUM(NVL(二季度销售套数,0)) AS "二季度销售套数"
,SUM(NVL(二季度销售金额,0)) AS "二季度销售金额"
,SUM(NVL(三季度销售面积,0)) AS "三季度销售面积"
,SUM(NVL(三季度销售套数,0)) AS "三季度销售套数"
,SUM(NVL(三季度销售金额,0)) AS "三季度销售金额"
,SUM(NVL(四季度销售面积,0)) AS "四季度销售面积"
,SUM(NVL(四季度销售套数,0)) AS "四季度销售套数"
,SUM(NVL(四季度销售金额,0)) AS "四季度销售金额"
,SUM(NVL("1月_销售面积",0)) AS "1月_销售面积"
,SUM(NVL("1月_销售套数",0)) AS "1月_销售套数"
,SUM(NVL("1月_销售金额",0)) AS "1月_销售金额"
,SUM(NVL("2月_销售面积",0)) AS "2月_销售面积"
,SUM(NVL("2月_销售套数",0)) AS "2月_销售套数"
,SUM(NVL("2月_销售金额",0)) AS "2月_销售金额"
,SUM(NVL("3月_销售面积",0)) AS "3月_销售面积"
,SUM(NVL("3月_销售套数",0)) AS "3月_销售套数"
,SUM(NVL("3月_销售金额",0)) AS "3月_销售金额"
,SUM(NVL("4月_销售面积",0)) AS "4月_销售面积"
,SUM(NVL("4月_销售套数",0)) AS "4月_销售套数"
,SUM(NVL("4月_销售金额",0)) AS "4月_销售金额"
,SUM(NVL("5月_销售面积",0)) AS "5月_销售面积"
,SUM(NVL("5月_销售套数",0)) AS "5月_销售套数"
,SUM(NVL("5月_销售金额",0)) AS "5月_销售金额"
,SUM(NVL("6月_销售面积",0)) AS "6月_销售面积"
,SUM(NVL("6月_销售套数",0)) AS "6月_销售套数"
,SUM(NVL("6月_销售金额",0)) AS "6月_销售金额"
,SUM(NVL("7月_销售面积",0)) AS "7月_销售面积"
,SUM(NVL("7月_销售套数",0)) AS "7月_销售套数"
,SUM(NVL("7月_销售金额",0)) AS "7月_销售金额"
,SUM(NVL("8月_销售面积",0)) AS "8月_销售面积"
,SUM(NVL("8月_销售套数",0)) AS "8月_销售套数"
,SUM(NVL("8月_销售金额",0)) AS "8月_销售金额"
,SUM(NVL("9月_销售面积",0)) AS "9月_销售面积"
,SUM(NVL("9月_销售套数",0)) AS "9月_销售套数"
,SUM(NVL("9月_销售金额",0)) AS "9月_销售金额"
,SUM(NVL("10月_销售面积",0)) AS "10月_销售面积"
,SUM(NVL("10月_销售套数",0)) AS "10月_销售套数"
,SUM(NVL("10月_销售金额",0)) AS "10月_销售金额"
,SUM(NVL("11月_销售面积",0)) AS "11月_销售面积"
,SUM(NVL("11月_销售套数",0)) AS "11月_销售套数"
,SUM(NVL("11月_销售金额",0)) AS "11月_销售金额"
,SUM(NVL("12月_销售面积",0)) AS "12月_销售面积"
,SUM(NVL("12月_销售套数",0)) AS "12月_销售套数"
,SUM(NVL("12月_销售金额",0)) AS "12月_销售金额"
FROM SYS_PROJECT A 
INNER JOIN SYS_PROJECT_STAGE B ON A.ID=B.PROJECT_ID
--FULL JOIN (SELECT * FROM MDM_BUILD_PRODUCT_TYPE  WHERE PRODUCT_TYPE_LEVEL=1 AND IS_END=0) C ON 1=1
LEFT JOIN 
(
	SELECT PROJ_ID,STAGE_ID,STAGE_NAME,"一级业态",PRODUCT_TYPE_NAME,PD.ID AS  PRODUCT_TYPE_ID , PRODUCT_TYPE_SHORT_CODE
	,SUM(NVL(总车位数,0))+SUM(NVL(总户数,0))  AS  全案可售户数
	,SUM(NVL(总可售面积,0))  AS 全案可售面积
	,SUM(NVL(A_当前最新版目标货值,0))  AS 全案可售货值
	,SUM(NVL(已取证建筑面积,0))  AS  已取证面积
	,SUM(NVL(已取证货值,0)) AS  已取证货值
	,SUM(NVL(已取证套数,0)) AS 已取证套数
	,SUM(NVL(已售建筑面积,0))  AS 已售面积
	,SUM(NVL(已售货值,0)) AS 已售货值
	,SUM(NVL(已售套数,0)) AS 已售套数
	,SUM(NVL(库存建筑面积,0))  AS 已取证库存面积
	,SUM(NVL(库存货值,0)) AS 已取证库存货值
	,SUM(NVL(库存套数,0)) AS 已取证库存套数
	,SUM(NVL(全案剩余货值,0)) AS 全案剩余货值
	,SUM(NVL(全案剩余面积,0)) AS 全案剩余面积
	,SUM(NVL(全案剩余套数,0))  AS 全案剩余套数
	FROM SWM_DT_VALUE_TABLE   
	LEFT JOIN MDM_BUILD_PRODUCT_TYPE PD ON PD.PRODUCT_TYPE_NAME="一级业态"
	--WHERE  PROJECT_NAME LIKE '%天津万科翡翠大道%' 
	GROUP BY PROJ_ID,STAGE_ID,STAGE_NAME,"一级业态",PRODUCT_TYPE_SHORT_CODE,PD.ID ,PRODUCT_TYPE_NAME
) F ON F.STAGE_ID=B.ID --AND F."一级业态"=F.PRODUCT_TYPE_NAME
LEFT  JOIN  SWM_MONTH_RealSUPPLY_DTL D ON  D.STAGE_ID=B.ID   AND D."实际供货年份"=TO_CHAR(SYSDATE,'YYYY')  AND F.PRODUCT_TYPE_NAME=D."一级业态"
LEFT JOIN  SWM_MOTH_RealSALE_DTL E ON  E.STAGE_ID=B.ID      AND 销售年份=TO_CHAR(SYSDATE,'YYYY')  AND F.PRODUCT_TYPE_NAME=E."PRODUCT_NAME"
  --WHERE  A.PROJECT_NAME LIKE '%天津万科翡翠大道%'  
GROUP BY A.ID,A.PROJECT_NAME,B.STAGE_NAME,B.ID
--,C.ID,F.PRODUCT_TYPE_NAME
--,F."一级业态"
, B.ORDER_CODE--,PRODUCT_TYPE_SHORT_CODE,PRODUCT_TYPE_ID,PRODUCT_TYPE_NAME
) A2 --WHERE  PROJ_ID='10905db7-5420-4fc2-a99b-190f44ee1163'


-------业态汇总的一级业态
UNION ALL
-----业态
SELECT GET_UUID() AS"id"
,PRODUCT_TYPE_NAME AS "projConstitute"
,PROJ_ID AS PROJ_ID
-- ,PROJ_ID||'_firstLevelProductTypeStatistics'  AS "parentId"
,PROJ_ID||'_firstLevelProductTypeStatistics' AS BIZ_PARENT_ID
,PRODUCT_TYPE_NAME AS OBJ_NAME
,PRODUCT_TYPE_SHORT_CODE AS ORDER_HIERARCHY_CODE
,PROJ_ID||'_'||PRODUCT_TYPE_ID  AS "objId"
,PRODUCT_TYPE_NAME AS "objType"
,PRODUCT_TYPE_NAME AS "buildProductTypeName"
,PRODUCT_TYPE_ID AS "ownBuildProductTypeId"
,PRODUCT_TYPE_ID AS  "buildProductTypeId"
,'3' AS "LEVEL"
,"全案可售户数" AS poTotalSaleCount
,"全案可售面积" AS poTotalSaleArea
,"全案可售货值" AS poTotalSaleAmount
,"已取证面积" AS rpTotalArea
,"已取证货值" AS rpTotalAmount
,"已取证套数" AS rpTotalCount
,"已售面积" AS poSaleCount
,"已售货值" AS poSaleArea
,"已售套数" AS poSaleCount
,"已取证库存面积" AS rpSurplusArea
,"已取证库存货值" AS rpSurplusAmount
,"已取证库存套数" AS rpSurplusCount
,"全案剩余货值" AS poSurplusSaleAmount
,"全案剩余面积" AS poSurplusSaleArea
,"全案剩余套数" AS poSurplusSaleCount
,"本年供货面积" AS thisYearActualSupplyArea
,"本年供货套数" AS thisYearActualSupplyNumber
,"本年供货金额" AS thisYearActualSupplyAmount
,"一季度供货面积" AS firstSeasonActualSupplyArea
,"一季度供货套数" AS firstSeasonActualSupplyNumber
,"一季度供货金额" AS firstSeasonActualSupplyAmount
,"二季度供货面积" AS secondSeasonActualSupplyArea
,"二季度供货套数" AS secondSeasonActualSupplyNumber
,"二季度供货金额" AS secondSeasonActualSupplyAmount
,"三季度供货面积" AS thirdSeasonActualSupplyArea
,"三季度供货套数" AS thirdSeasonActualSupplyNumber
,"三季度供货金额" AS thirdSeasonActualSupplyAmount
,"四季度供货面积" AS fourthSeasonActualSupplyArea
,"四季度供货套数" AS fourthSeasonActualSupplyNumber
,"四季度供货金额" AS fourthSeasonActualSupplyAmount
,"1月_供货面积" AS januaryActualSupplyArea
,"1月_供货套数" AS januaryActualSupplyNumber
,"1月_供货金额" AS januaryActualSupplyAmount
,"2月_供货面积" AS februaryActualSupplyArea
,"2月_供货套数" AS februaryActualSupplyNumber
,"2月_供货金额" AS februaryActualSupplyAmount
,"3月_供货面积" AS marchActualSupplyArea
,"3月_供货套数" AS marchActualSupplyNumber
,"3月_供货金额" AS marchActualSupplyAmount
,"4月_供货面积" AS aprilActualSupplyArea
,"4月_供货套数" AS aprilActualSupplyNumber
,"4月_供货金额" AS aprilActualSupplyAmount
,"5月_供货面积" AS mayActualSupplyArea
,"5月_供货套数" AS mayActualSupplyNumber
,"5月_供货金额" AS mayActualSupplyAmount
,"6月_供货面积" AS juneActualSupplyArea
,"6月_供货套数" AS juneActualSupplyNumber
,"6月_供货金额" AS juneActualSupplyAmount
,"7月_供货面积" AS julyActualSupplyArea
,"7月_供货套数" AS julyActualSupplyNumber
,"7月_供货金额" AS julyActualSupplyAmount
,"8月_供货面积" AS augustActualSupplyArea
,"8月_供货套数" AS augustActualSupplyNumber
,"8月_供货金额" AS augustActualSupplyAmount
,"9月_供货面积" AS septemberActualSupplyArea
,"9月_供货套数" AS septemberActualSupplyNumber
,"9月_供货金额" AS septemberActualSupplyAmount
,"10月_供货面积" AS octoberActualSupplyArea
,"10月_供货套数" AS octoberActualSupplyNumber
,"10月_供货金额" AS octoberActualSupplyAmount
,"11月_供货面积" AS novemberActualSupplyArea
,"11月_供货套数" AS novemberActualSupplyNumber
,"11月_供货金额" AS novemberActualSupplyAmount
,"12月_供货面积" AS decemberActualSupplyArea
,"12月_供货套数" AS decemberActualSupplyNumber
,"12月_供货金额" AS decemberActualSupplyAmount
,"本年销售面积" AS thisYearSellArea
,"本年销售套数" AS thisYearSellNumber
,"本年销售金额" AS thisYearSellAmount
,"一季度销售面积" AS januarySelllArea
,"一季度销售套数" AS januarySellNumber
,"一季度销售金额" AS januarySellAmount
,"二季度销售面积" AS secondSeasonSellArea
,"二季度销售套数" AS secondSeasonSellNumber
,"二季度销售金额" AS secondSeasonSellAmount
,"三季度销售面积" AS thirdSeasonSellArea
,"三季度销售套数" AS thirdSeasonSellNumber
,"三季度销售金额" AS thirdSeasonSellAmount
,"四季度销售面积" AS fourthSeasonSellArea
,"四季度销售套数" AS fourthSeasonSellNumber
,"四季度销售金额" AS fourthSeasonSellAmount
,"1月_销售面积" AS januarySellArea
,"1月_销售套数" AS januarySellNumber
,"1月_销售金额" AS januarySellAmount
,"2月_销售面积" AS februarySellArea
,"2月_销售套数" AS februarySellNumber
,"2月_销售金额" AS februarySellAmount
,"3月_销售面积" AS marchSellArea
,"3月_销售套数" AS marchSellNumber
,"3月_销售金额" AS marchSellAmount
,"4月_销售面积" AS aprilSellArea
,"4月_销售套数" AS aprilSellNumber
,"4月_销售金额" AS aprilSellAmount
,"5月_销售面积" AS maySellArea
,"5月_销售套数" AS maySellNumber
,"5月_销售金额" AS maySellAmount
,"6月_销售面积" AS juneSellArea
,"6月_销售套数" AS juneSellNumber
,"6月_销售金额" AS juneSellAmount
,"7月_销售面积" AS julySellArea
,"7月_销售套数" AS julySellNumber
,"7月_销售金额" AS julySellAmount
,"8月_销售面积" AS augustSellArea
,"8月_销售套数" AS augustSellNumber
,"8月_销售金额" AS augustSellAmount
,"9月_销售面积" AS septemberSellArea
,"9月_销售套数" AS septemberSellNumber
,"9月_销售金额" AS septemberSellAmount
,"10月_销售面积" AS octoberSellArea
,"10月_销售套数" AS octoberSellNumber
,"10月_销售金额" AS octoberSellAmount
,"11月_销售面积" AS novemberSellArea
,"11月_销售套数" AS novemberSellNumber
,"11月_销售金额" AS novemberSellAmount
,"12月_销售面积" AS decemberSellArea
,"12月_销售套数" AS decemberSellNumber
,"12月_销售金额" AS decemberSellAmount

FROM 
(						 
SELECT A.ID as PROJ_ID,A.PROJECT_NAME--,B.ID AS PARENT_ID
, PRODUCT_TYPE_NAME, PRODUCT_TYPE_ID,PRODUCT_TYPE_SHORT_CODE
,SUM(F.全案可售户数) AS 全案可售户数
,SUM(F.全案可售面积) AS 全案可售面积
,SUM(F.全案可售货值) AS 全案可售货值
,SUM(F.已取证面积) AS 已取证面积
,SUM(F.已取证货值) AS 已取证货值
,SUM(F.已取证套数) AS 已取证套数
,SUM(F.已售面积) AS 已售面积
,SUM(F.已售货值) AS 已售货值
,SUM(F.已售套数) AS 已售套数
,SUM(F.已取证库存面积) AS 已取证库存面积
,SUM(F.已取证库存货值) AS 已取证库存货值
,SUM(F.已取证库存套数) AS 已取证库存套数
,SUM(F.全案剩余货值) AS 全案剩余货值
,SUM(F.全案剩余面积) AS 全案剩余面积
,SUM(F.全案剩余套数) AS 全案剩余套数
,SUM(NVL(本年供货面积,0)) AS "本年供货面积"
,SUM(NVL(本年供货套数,0)) AS "本年供货套数"
,SUM(NVL(本年供货金额,0)) AS "本年供货金额"
,SUM(NVL(一季度供货面积,0)) AS "一季度供货面积"
,SUM(NVL(一季度供货套数,0)) AS "一季度供货套数"
,SUM(NVL(一季度供货金额,0)) AS "一季度供货金额"
,SUM(NVL(二季度供货面积,0)) AS "二季度供货面积"
,SUM(NVL(二季度供货套数,0)) AS "二季度供货套数"
,SUM(NVL(二季度供货金额,0)) AS "二季度供货金额"
,SUM(NVL(三季度供货面积,0)) AS "三季度供货面积"
,SUM(NVL(三季度供货套数,0)) AS "三季度供货套数"
,SUM(NVL(三季度供货金额,0)) AS "三季度供货金额"
,SUM(NVL(四季度供货面积,0)) AS "四季度供货面积"
,SUM(NVL(四季度供货套数,0)) AS "四季度供货套数"
,SUM(NVL(四季度供货金额,0)) AS "四季度供货金额"
,SUM(NVL("1月_供货面积",0)) AS "1月_供货面积"
,SUM(NVL("1月_供货套数",0)) AS "1月_供货套数"
,SUM(NVL("1月_供货金额",0)) AS "1月_供货金额"
,SUM(NVL("2月_供货面积",0)) AS "2月_供货面积"
,SUM(NVL("2月_供货套数",0)) AS "2月_供货套数"
,SUM(NVL("2月_供货金额",0)) AS "2月_供货金额"
,SUM(NVL("3月_供货面积",0)) AS "3月_供货面积"
,SUM(NVL("3月_供货套数",0)) AS "3月_供货套数"
,SUM(NVL("3月_供货金额",0)) AS "3月_供货金额"
,SUM(NVL("4月_供货面积",0)) AS "4月_供货面积"
,SUM(NVL("4月_供货套数",0)) AS "4月_供货套数"
,SUM(NVL("4月_供货金额",0)) AS "4月_供货金额"
,SUM(NVL("5月_供货面积",0)) AS "5月_供货面积"
,SUM(NVL("5月_供货套数",0)) AS "5月_供货套数"
,SUM(NVL("5月_供货金额",0)) AS "5月_供货金额"
,SUM(NVL("6月_供货面积",0)) AS "6月_供货面积"
,SUM(NVL("6月_供货套数",0)) AS "6月_供货套数"
,SUM(NVL("6月_供货金额",0)) AS "6月_供货金额"
,SUM(NVL("7月_供货面积",0)) AS "7月_供货面积"
,SUM(NVL("7月_供货套数",0)) AS "7月_供货套数"
,SUM(NVL("7月_供货金额",0)) AS "7月_供货金额"
,SUM(NVL("8月_供货面积",0)) AS "8月_供货面积"
,SUM(NVL("8月_供货套数",0)) AS "8月_供货套数"
,SUM(NVL("8月_供货金额",0)) AS "8月_供货金额"
,SUM(NVL("9月_供货面积",0)) AS "9月_供货面积"
,SUM(NVL("9月_供货套数",0)) AS "9月_供货套数"
,SUM(NVL("9月_供货金额",0)) AS "9月_供货金额"
,SUM(NVL("10月_供货面积",0)) AS "10月_供货面积"
,SUM(NVL("10月_供货套数",0)) AS "10月_供货套数"
,SUM(NVL("10月_供货金额",0)) AS "10月_供货金额"
,SUM(NVL("11月_供货面积",0)) AS "11月_供货面积"
,SUM(NVL("11月_供货套数",0)) AS "11月_供货套数"
,SUM(NVL("11月_供货金额",0)) AS "11月_供货金额"
,SUM(NVL("12月_供货面积",0)) AS "12月_供货面积"
,SUM(NVL("12月_供货套数",0)) AS "12月_供货套数"
,SUM(NVL("12月_供货金额",0)) AS "12月_供货金额"
,SUM(NVL(本年销售面积,0)) AS "本年销售面积"
,SUM(NVL(本年销售套数,0)) AS "本年销售套数"
,SUM(NVL(本年销售金额,0)) AS "本年销售金额"
,SUM(NVL(一季度销售面积,0)) AS "一季度销售面积"
,SUM(NVL(一季度销售套数,0)) AS "一季度销售套数"
,SUM(NVL(一季度销售金额,0)) AS "一季度销售金额"
,SUM(NVL(二季度销售面积,0)) AS "二季度销售面积"
,SUM(NVL(二季度销售套数,0)) AS "二季度销售套数"
,SUM(NVL(二季度销售金额,0)) AS "二季度销售金额"
,SUM(NVL(三季度销售面积,0)) AS "三季度销售面积"
,SUM(NVL(三季度销售套数,0)) AS "三季度销售套数"
,SUM(NVL(三季度销售金额,0)) AS "三季度销售金额"
,SUM(NVL(四季度销售面积,0)) AS "四季度销售面积"
,SUM(NVL(四季度销售套数,0)) AS "四季度销售套数"
,SUM(NVL(四季度销售金额,0)) AS "四季度销售金额"
,SUM(NVL("1月_销售面积",0)) AS "1月_销售面积"
,SUM(NVL("1月_销售套数",0)) AS "1月_销售套数"
,SUM(NVL("1月_销售金额",0)) AS "1月_销售金额"
,SUM(NVL("2月_销售面积",0)) AS "2月_销售面积"
,SUM(NVL("2月_销售套数",0)) AS "2月_销售套数"
,SUM(NVL("2月_销售金额",0)) AS "2月_销售金额"
,SUM(NVL("3月_销售面积",0)) AS "3月_销售面积"
,SUM(NVL("3月_销售套数",0)) AS "3月_销售套数"
,SUM(NVL("3月_销售金额",0)) AS "3月_销售金额"
,SUM(NVL("4月_销售面积",0)) AS "4月_销售面积"
,SUM(NVL("4月_销售套数",0)) AS "4月_销售套数"
,SUM(NVL("4月_销售金额",0)) AS "4月_销售金额"
,SUM(NVL("5月_销售面积",0)) AS "5月_销售面积"
,SUM(NVL("5月_销售套数",0)) AS "5月_销售套数"
,SUM(NVL("5月_销售金额",0)) AS "5月_销售金额"
,SUM(NVL("6月_销售面积",0)) AS "6月_销售面积"
,SUM(NVL("6月_销售套数",0)) AS "6月_销售套数"
,SUM(NVL("6月_销售金额",0)) AS "6月_销售金额"
,SUM(NVL("7月_销售面积",0)) AS "7月_销售面积"
,SUM(NVL("7月_销售套数",0)) AS "7月_销售套数"
,SUM(NVL("7月_销售金额",0)) AS "7月_销售金额"
,SUM(NVL("8月_销售面积",0)) AS "8月_销售面积"
,SUM(NVL("8月_销售套数",0)) AS "8月_销售套数"
,SUM(NVL("8月_销售金额",0)) AS "8月_销售金额"
,SUM(NVL("9月_销售面积",0)) AS "9月_销售面积"
,SUM(NVL("9月_销售套数",0)) AS "9月_销售套数"
,SUM(NVL("9月_销售金额",0)) AS "9月_销售金额"
,SUM(NVL("10月_销售面积",0)) AS "10月_销售面积"
,SUM(NVL("10月_销售套数",0)) AS "10月_销售套数"
,SUM(NVL("10月_销售金额",0)) AS "10月_销售金额"
,SUM(NVL("11月_销售面积",0)) AS "11月_销售面积"
,SUM(NVL("11月_销售套数",0)) AS "11月_销售套数"
,SUM(NVL("11月_销售金额",0)) AS "11月_销售金额"
,SUM(NVL("12月_销售面积",0)) AS "12月_销售面积"
,SUM(NVL("12月_销售套数",0)) AS "12月_销售套数"
,SUM(NVL("12月_销售金额",0)) AS "12月_销售金额"
FROM SYS_PROJECT A 
INNER JOIN SYS_PROJECT_STAGE B ON A.ID=B.PROJECT_ID
--FULL JOIN (SELECT * FROM MDM_BUILD_PRODUCT_TYPE  WHERE PRODUCT_TYPE_LEVEL=1 AND IS_END=0) C ON 1=1
LEFT JOIN 
(
		SELECT PROJ_ID,STAGE_ID,STAGE_NAME,"一级业态",PRODUCT_TYPE_NAME,PD.ID AS  PRODUCT_TYPE_ID , PRODUCT_TYPE_SHORT_CODE
	,SUM(NVL(总车位数,0))+SUM(NVL(总户数,0))  AS  全案可售户数
	,SUM(NVL(总可售面积,0))  AS 全案可售面积
	,SUM(NVL(A_当前最新版目标货值,0))  AS 全案可售货值
	,SUM(NVL(已取证建筑面积,0))  AS  已取证面积
	,SUM(NVL(已取证货值,0)) AS  已取证货值
	,SUM(NVL(已取证套数,0)) AS 已取证套数
	,SUM(NVL(已售建筑面积,0))  AS 已售面积
	,SUM(NVL(已售货值,0)) AS 已售货值
	,SUM(NVL(已售套数,0)) AS 已售套数
	,SUM(NVL(库存建筑面积,0))  AS 已取证库存面积
	,SUM(NVL(库存货值,0)) AS 已取证库存货值
	,SUM(NVL(库存套数,0)) AS 已取证库存套数
	,SUM(NVL(全案剩余货值,0)) AS 全案剩余货值
	,SUM(NVL(全案剩余面积,0)) AS 全案剩余面积
	,SUM(NVL(全案剩余套数,0))  AS 全案剩余套数
	FROM SWM_DT_VALUE_TABLE   
	LEFT JOIN MDM_BUILD_PRODUCT_TYPE PD ON PD.PRODUCT_TYPE_NAME="一级业态"
	--WHERE  PROJECT_NAME LIKE '%天津万科翡翠大道%' 
	GROUP BY PROJ_ID,STAGE_ID,STAGE_NAME,"一级业态",PRODUCT_TYPE_SHORT_CODE,PD.ID ,PRODUCT_TYPE_NAME
) F ON F.STAGE_ID=B.ID --AND F."一级业态"=F.PRODUCT_TYPE_NAME
LEFT  JOIN  SWM_MONTH_RealSUPPLY_DTL D ON  D.STAGE_ID=B.ID   AND D."实际供货年份"=TO_CHAR(SYSDATE,'YYYY') AND F.PRODUCT_TYPE_NAME=D."一级业态"
LEFT JOIN  SWM_MOTH_RealSALE_DTL E ON  E.STAGE_ID=B.ID      AND 销售年份=TO_CHAR(SYSDATE,'YYYY') AND F.PRODUCT_TYPE_NAME=E."PRODUCT_NAME"
--WHERE  A.PROJECT_NAME LIKE '%天津万科翡翠大道%'  
GROUP BY A.ID,A.PROJECT_NAME,PRODUCT_TYPE_ID,PRODUCT_TYPE_NAME,PRODUCT_TYPE_SHORT_CODE
) A2


-------业态汇总行
UNION ALL 
SELECT GET_UUID() AS"id"
,NULL AS "projConstitute"
,PROJ_ID AS PROJ_ID
-- ,PROJ_ID AS "parentId"
,PROJ_ID AS OBJ_PARENT_ID
,PROJECT_NAME AS OBJ_NAME
,NULL AS ORDER_HIERARCHY_CODE
,PROJ_ID||'_firstLevelProductTypeStatistics' AS "objId"
,NULL AS "objType"
, NULL AS "buildProductTypeName"
,NULL  AS "ownBuildProductTypeId"
,NULL AS  "buildProductTypeId"
,'2' AS "LEVEL"
,"全案可售户数" AS poTotalSaleCount
,"全案可售面积" AS poTotalSaleArea
,"全案可售货值" AS poTotalSaleAmount
,"已取证面积" AS rpTotalArea
,"已取证货值" AS rpTotalAmount
,"已取证套数" AS rpTotalCount
,"已售面积" AS poSaleCount
,"已售货值" AS poSaleArea
,"已售套数" AS poSaleCount
,"已取证库存面积" AS rpSurplusArea
,"已取证库存货值" AS rpSurplusAmount
,"已取证库存套数" AS rpSurplusCount
,"全案剩余货值" AS poSurplusSaleAmount
,"全案剩余面积" AS poSurplusSaleArea
,"全案剩余套数" AS poSurplusSaleCount
,"本年供货面积" AS thisYearActualSupplyArea
,"本年供货套数" AS thisYearActualSupplyNumber
,"本年供货金额" AS thisYearActualSupplyAmount
,"一季度供货面积" AS firstSeasonActualSupplyArea
,"一季度供货套数" AS firstSeasonActualSupplyNumber
,"一季度供货金额" AS firstSeasonActualSupplyAmount
,"二季度供货面积" AS secondSeasonActualSupplyArea
,"二季度供货套数" AS secondSeasonActualSupplyNumber
,"二季度供货金额" AS secondSeasonActualSupplyAmount
,"三季度供货面积" AS thirdSeasonActualSupplyArea
,"三季度供货套数" AS thirdSeasonActualSupplyNumber
,"三季度供货金额" AS thirdSeasonActualSupplyAmount
,"四季度供货面积" AS fourthSeasonActualSupplyArea
,"四季度供货套数" AS fourthSeasonActualSupplyNumber
,"四季度供货金额" AS fourthSeasonActualSupplyAmount
,"1月_供货面积" AS januaryActualSupplyArea
,"1月_供货套数" AS januaryActualSupplyNumber
,"1月_供货金额" AS januaryActualSupplyAmount
,"2月_供货面积" AS februaryActualSupplyArea
,"2月_供货套数" AS februaryActualSupplyNumber
,"2月_供货金额" AS februaryActualSupplyAmount
,"3月_供货面积" AS marchActualSupplyArea
,"3月_供货套数" AS marchActualSupplyNumber
,"3月_供货金额" AS marchActualSupplyAmount
,"4月_供货面积" AS aprilActualSupplyArea
,"4月_供货套数" AS aprilActualSupplyNumber
,"4月_供货金额" AS aprilActualSupplyAmount
,"5月_供货面积" AS mayActualSupplyArea
,"5月_供货套数" AS mayActualSupplyNumber
,"5月_供货金额" AS mayActualSupplyAmount
,"6月_供货面积" AS juneActualSupplyArea
,"6月_供货套数" AS juneActualSupplyNumber
,"6月_供货金额" AS juneActualSupplyAmount
,"7月_供货面积" AS julyActualSupplyArea
,"7月_供货套数" AS julyActualSupplyNumber
,"7月_供货金额" AS julyActualSupplyAmount
,"8月_供货面积" AS augustActualSupplyArea
,"8月_供货套数" AS augustActualSupplyNumber
,"8月_供货金额" AS augustActualSupplyAmount
,"9月_供货面积" AS septemberActualSupplyArea
,"9月_供货套数" AS septemberActualSupplyNumber
,"9月_供货金额" AS septemberActualSupplyAmount
,"10月_供货面积" AS octoberActualSupplyArea
,"10月_供货套数" AS octoberActualSupplyNumber
,"10月_供货金额" AS octoberActualSupplyAmount
,"11月_供货面积" AS novemberActualSupplyArea
,"11月_供货套数" AS novemberActualSupplyNumber
,"11月_供货金额" AS novemberActualSupplyAmount
,"12月_供货面积" AS decemberActualSupplyArea
,"12月_供货套数" AS decemberActualSupplyNumber
,"12月_供货金额" AS decemberActualSupplyAmount
,"本年销售面积" AS thisYearSellArea
,"本年销售套数" AS thisYearSellNumber
,"本年销售金额" AS thisYearSellAmount
,"一季度销售面积" AS januarySelllArea
,"一季度销售套数" AS januarySellNumber
,"一季度销售金额" AS januarySellAmount
,"二季度销售面积" AS secondSeasonSellArea
,"二季度销售套数" AS secondSeasonSellNumber
,"二季度销售金额" AS secondSeasonSellAmount
,"三季度销售面积" AS thirdSeasonSellArea
,"三季度销售套数" AS thirdSeasonSellNumber
,"三季度销售金额" AS thirdSeasonSellAmount
,"四季度销售面积" AS fourthSeasonSellArea
,"四季度销售套数" AS fourthSeasonSellNumber
,"四季度销售金额" AS fourthSeasonSellAmount
,"1月_销售面积" AS januarySellArea
,"1月_销售套数" AS januarySellNumber
,"1月_销售金额" AS januarySellAmount
,"2月_销售面积" AS februarySellArea
,"2月_销售套数" AS februarySellNumber
,"2月_销售金额" AS februarySellAmount
,"3月_销售面积" AS marchSellArea
,"3月_销售套数" AS marchSellNumber
,"3月_销售金额" AS marchSellAmount
,"4月_销售面积" AS aprilSellArea
,"4月_销售套数" AS aprilSellNumber
,"4月_销售金额" AS aprilSellAmount
,"5月_销售面积" AS maySellArea
,"5月_销售套数" AS maySellNumber
,"5月_销售金额" AS maySellAmount
,"6月_销售面积" AS juneSellArea
,"6月_销售套数" AS juneSellNumber
,"6月_销售金额" AS juneSellAmount
,"7月_销售面积" AS julySellArea
,"7月_销售套数" AS julySellNumber
,"7月_销售金额" AS julySellAmount
,"8月_销售面积" AS augustSellArea
,"8月_销售套数" AS augustSellNumber
,"8月_销售金额" AS augustSellAmount
,"9月_销售面积" AS septemberSellArea
,"9月_销售套数" AS septemberSellNumber
,"9月_销售金额" AS septemberSellAmount
,"10月_销售面积" AS octoberSellArea
,"10月_销售套数" AS octoberSellNumber
,"10月_销售金额" AS octoberSellAmount
,"11月_销售面积" AS novemberSellArea
,"11月_销售套数" AS novemberSellNumber
,"11月_销售金额" AS novemberSellAmount
,"12月_销售面积" AS decemberSellArea
,"12月_销售套数" AS decemberSellNumber
,"12月_销售金额" AS decemberSellAmount

FROM 
(						 
SELECT A.ID as PROJ_ID,A.PROJECT_NAME

,SUM(F.全案可售户数) AS 全案可售户数
,SUM(F.全案可售面积) AS 全案可售面积
,SUM(F.全案可售货值) AS 全案可售货值
,SUM(F.已取证面积) AS 已取证面积
,SUM(F.已取证货值) AS 已取证货值
,SUM(F.已取证套数) AS 已取证套数
,SUM(F.已售面积) AS 已售面积
,SUM(F.已售货值) AS 已售货值
,SUM(F.已售套数) AS 已售套数
,SUM(F.已取证库存面积) AS 已取证库存面积
,SUM(F.已取证库存货值) AS 已取证库存货值
,SUM(F.已取证库存套数) AS 已取证库存套数
,SUM(F.全案剩余货值) AS 全案剩余货值
,SUM(F.全案剩余面积) AS 全案剩余面积
,SUM(F.全案剩余套数) AS 全案剩余套数
,SUM(NVL(本年供货面积,0)) AS "本年供货面积"
,SUM(NVL(本年供货套数,0)) AS "本年供货套数"
,SUM(NVL(本年供货金额,0)) AS "本年供货金额"
,SUM(NVL(一季度供货面积,0)) AS "一季度供货面积"
,SUM(NVL(一季度供货套数,0)) AS "一季度供货套数"
,SUM(NVL(一季度供货金额,0)) AS "一季度供货金额"
,SUM(NVL(二季度供货面积,0)) AS "二季度供货面积"
,SUM(NVL(二季度供货套数,0)) AS "二季度供货套数"
,SUM(NVL(二季度供货金额,0)) AS "二季度供货金额"
,SUM(NVL(三季度供货面积,0)) AS "三季度供货面积"
,SUM(NVL(三季度供货套数,0)) AS "三季度供货套数"
,SUM(NVL(三季度供货金额,0)) AS "三季度供货金额"
,SUM(NVL(四季度供货面积,0)) AS "四季度供货面积"
,SUM(NVL(四季度供货套数,0)) AS "四季度供货套数"
,SUM(NVL(四季度供货金额,0)) AS "四季度供货金额"
,SUM(NVL("1月_供货面积",0)) AS "1月_供货面积"
,SUM(NVL("1月_供货套数",0)) AS "1月_供货套数"
,SUM(NVL("1月_供货金额",0)) AS "1月_供货金额"
,SUM(NVL("2月_供货面积",0)) AS "2月_供货面积"
,SUM(NVL("2月_供货套数",0)) AS "2月_供货套数"
,SUM(NVL("2月_供货金额",0)) AS "2月_供货金额"
,SUM(NVL("3月_供货面积",0)) AS "3月_供货面积"
,SUM(NVL("3月_供货套数",0)) AS "3月_供货套数"
,SUM(NVL("3月_供货金额",0)) AS "3月_供货金额"
,SUM(NVL("4月_供货面积",0)) AS "4月_供货面积"
,SUM(NVL("4月_供货套数",0)) AS "4月_供货套数"
,SUM(NVL("4月_供货金额",0)) AS "4月_供货金额"
,SUM(NVL("5月_供货面积",0)) AS "5月_供货面积"
,SUM(NVL("5月_供货套数",0)) AS "5月_供货套数"
,SUM(NVL("5月_供货金额",0)) AS "5月_供货金额"
,SUM(NVL("6月_供货面积",0)) AS "6月_供货面积"
,SUM(NVL("6月_供货套数",0)) AS "6月_供货套数"
,SUM(NVL("6月_供货金额",0)) AS "6月_供货金额"
,SUM(NVL("7月_供货面积",0)) AS "7月_供货面积"
,SUM(NVL("7月_供货套数",0)) AS "7月_供货套数"
,SUM(NVL("7月_供货金额",0)) AS "7月_供货金额"
,SUM(NVL("8月_供货面积",0)) AS "8月_供货面积"
,SUM(NVL("8月_供货套数",0)) AS "8月_供货套数"
,SUM(NVL("8月_供货金额",0)) AS "8月_供货金额"
,SUM(NVL("9月_供货面积",0)) AS "9月_供货面积"
,SUM(NVL("9月_供货套数",0)) AS "9月_供货套数"
,SUM(NVL("9月_供货金额",0)) AS "9月_供货金额"
,SUM(NVL("10月_供货面积",0)) AS "10月_供货面积"
,SUM(NVL("10月_供货套数",0)) AS "10月_供货套数"
,SUM(NVL("10月_供货金额",0)) AS "10月_供货金额"
,SUM(NVL("11月_供货面积",0)) AS "11月_供货面积"
,SUM(NVL("11月_供货套数",0)) AS "11月_供货套数"
,SUM(NVL("11月_供货金额",0)) AS "11月_供货金额"
,SUM(NVL("12月_供货面积",0)) AS "12月_供货面积"
,SUM(NVL("12月_供货套数",0)) AS "12月_供货套数"
,SUM(NVL("12月_供货金额",0)) AS "12月_供货金额"
,SUM(NVL(本年销售面积,0)) AS "本年销售面积"
,SUM(NVL(本年销售套数,0)) AS "本年销售套数"
,SUM(NVL(本年销售金额,0)) AS "本年销售金额"
,SUM(NVL(一季度销售面积,0)) AS "一季度销售面积"
,SUM(NVL(一季度销售套数,0)) AS "一季度销售套数"
,SUM(NVL(一季度销售金额,0)) AS "一季度销售金额"
,SUM(NVL(二季度销售面积,0)) AS "二季度销售面积"
,SUM(NVL(二季度销售套数,0)) AS "二季度销售套数"
,SUM(NVL(二季度销售金额,0)) AS "二季度销售金额"
,SUM(NVL(三季度销售面积,0)) AS "三季度销售面积"
,SUM(NVL(三季度销售套数,0)) AS "三季度销售套数"
,SUM(NVL(三季度销售金额,0)) AS "三季度销售金额"
,SUM(NVL(四季度销售面积,0)) AS "四季度销售面积"
,SUM(NVL(四季度销售套数,0)) AS "四季度销售套数"
,SUM(NVL(四季度销售金额,0)) AS "四季度销售金额"
,SUM(NVL("1月_销售面积",0)) AS "1月_销售面积"
,SUM(NVL("1月_销售套数",0)) AS "1月_销售套数"
,SUM(NVL("1月_销售金额",0)) AS "1月_销售金额"
,SUM(NVL("2月_销售面积",0)) AS "2月_销售面积"
,SUM(NVL("2月_销售套数",0)) AS "2月_销售套数"
,SUM(NVL("2月_销售金额",0)) AS "2月_销售金额"
,SUM(NVL("3月_销售面积",0)) AS "3月_销售面积"
,SUM(NVL("3月_销售套数",0)) AS "3月_销售套数"
,SUM(NVL("3月_销售金额",0)) AS "3月_销售金额"
,SUM(NVL("4月_销售面积",0)) AS "4月_销售面积"
,SUM(NVL("4月_销售套数",0)) AS "4月_销售套数"
,SUM(NVL("4月_销售金额",0)) AS "4月_销售金额"
,SUM(NVL("5月_销售面积",0)) AS "5月_销售面积"
,SUM(NVL("5月_销售套数",0)) AS "5月_销售套数"
,SUM(NVL("5月_销售金额",0)) AS "5月_销售金额"
,SUM(NVL("6月_销售面积",0)) AS "6月_销售面积"
,SUM(NVL("6月_销售套数",0)) AS "6月_销售套数"
,SUM(NVL("6月_销售金额",0)) AS "6月_销售金额"
,SUM(NVL("7月_销售面积",0)) AS "7月_销售面积"
,SUM(NVL("7月_销售套数",0)) AS "7月_销售套数"
,SUM(NVL("7月_销售金额",0)) AS "7月_销售金额"
,SUM(NVL("8月_销售面积",0)) AS "8月_销售面积"
,SUM(NVL("8月_销售套数",0)) AS "8月_销售套数"
,SUM(NVL("8月_销售金额",0)) AS "8月_销售金额"
,SUM(NVL("9月_销售面积",0)) AS "9月_销售面积"
,SUM(NVL("9月_销售套数",0)) AS "9月_销售套数"
,SUM(NVL("9月_销售金额",0)) AS "9月_销售金额"
,SUM(NVL("10月_销售面积",0)) AS "10月_销售面积"
,SUM(NVL("10月_销售套数",0)) AS "10月_销售套数"
,SUM(NVL("10月_销售金额",0)) AS "10月_销售金额"
,SUM(NVL("11月_销售面积",0)) AS "11月_销售面积"
,SUM(NVL("11月_销售套数",0)) AS "11月_销售套数"
,SUM(NVL("11月_销售金额",0)) AS "11月_销售金额"
,SUM(NVL("12月_销售面积",0)) AS "12月_销售面积"
,SUM(NVL("12月_销售套数",0)) AS "12月_销售套数"
,SUM(NVL("12月_销售金额",0)) AS "12月_销售金额"
FROM SYS_PROJECT A 
INNER JOIN SYS_PROJECT_STAGE B ON A.ID=B.PROJECT_ID
--FULL JOIN (SELECT * FROM MDM_BUILD_PRODUCT_TYPE  WHERE PRODUCT_TYPE_LEVEL=1 AND IS_END=0) C ON 1=1
LEFT JOIN 
(
	SELECT PROJ_ID,STAGE_ID,STAGE_NAME,"一级业态",PRODUCT_TYPE_NAME,PD.ID AS  PRODUCT_TYPE_ID , PRODUCT_TYPE_SHORT_CODE
	,SUM(NVL(总车位数,0))+SUM(NVL(总户数,0))  AS  全案可售户数
	,SUM(NVL(总可售面积,0))  AS 全案可售面积
	,SUM(NVL(A_当前最新版目标货值,0))  AS 全案可售货值
	,SUM(NVL(已取证建筑面积,0))  AS  已取证面积
	,SUM(NVL(已取证货值,0)) AS  已取证货值
	,SUM(NVL(已取证套数,0)) AS 已取证套数
	,SUM(NVL(已售建筑面积,0))  AS 已售面积
	,SUM(NVL(已售货值,0)) AS 已售货值
	,SUM(NVL(已售套数,0)) AS 已售套数
	,SUM(NVL(库存建筑面积,0))  AS 已取证库存面积
	,SUM(NVL(库存货值,0)) AS 已取证库存货值
	,SUM(NVL(库存套数,0)) AS 已取证库存套数
	,SUM(NVL(全案剩余货值,0)) AS 全案剩余货值
	,SUM(NVL(全案剩余面积,0)) AS 全案剩余面积
	,SUM(NVL(全案剩余套数,0))  AS 全案剩余套数
	FROM SWM_DT_VALUE_TABLE   
	LEFT JOIN MDM_BUILD_PRODUCT_TYPE PD ON PD.PRODUCT_TYPE_NAME="一级业态"
	--WHERE  PROJECT_NAME LIKE '%北京西派国际%' 
	GROUP BY PROJ_ID,STAGE_ID,STAGE_NAME,"一级业态",PRODUCT_TYPE_SHORT_CODE,PD.ID ,PRODUCT_TYPE_NAME
) F ON F.STAGE_ID=B.ID --AND F."一级业态"=F.PRODUCT_TYPE_NAME
LEFT  JOIN  SWM_MONTH_RealSUPPLY_DTL D ON  D.STAGE_ID=B.ID   AND D."实际供货年份"=TO_CHAR(SYSDATE,'YYYY') AND F.PRODUCT_TYPE_NAME=D."一级业态"
LEFT JOIN  SWM_MOTH_RealSALE_DTL E ON  E.STAGE_ID=B.ID      AND 销售年份=TO_CHAR(SYSDATE,'YYYY') AND F.PRODUCT_TYPE_NAME=E."PRODUCT_NAME"
--WHERE  A.PROJECT_NAME LIKE '%天津万科翡翠大道%'  
GROUP BY  A.ID,A.PROJECT_NAME
) A2

-------项目行
UNION ALL 
SELECT GET_UUID() AS"id"
,NULL AS "projConstitute"
,PROJ_ID AS PROJ_ID
-- ,NULL AS "parentId"
,NULL AS BIZ_PARENT_ID
,PROJECT_NAME AS OBJ_NAME
,NULL AS ORDER_HIERARCHY_CODE
,PROJ_ID AS "objId"
,NULL AS "objType"
, NULL AS "buildProductTypeName"
,NULL  AS "ownBuildProductTypeId"
,NULL AS  "buildProductTypeId"
,'1' AS "LEVEL"
,"全案可售户数" AS poTotalSaleCount
,"全案可售面积" AS poTotalSaleArea
,"全案可售货值" AS poTotalSaleAmount
,"已取证面积" AS rpTotalArea
,"已取证货值" AS rpTotalAmount
,"已取证套数" AS rpTotalCount
,"已售面积" AS poSaleCount
,"已售货值" AS poSaleArea
,"已售套数" AS poSaleCount
,"已取证库存面积" AS rpSurplusArea
,"已取证库存货值" AS rpSurplusAmount
,"已取证库存套数" AS rpSurplusCount
,"全案剩余货值" AS poSurplusSaleAmount
,"全案剩余面积" AS poSurplusSaleArea
,"全案剩余套数" AS poSurplusSaleCount
,"本年供货面积" AS thisYearActualSupplyArea
,"本年供货套数" AS thisYearActualSupplyNumber
,"本年供货金额" AS thisYearActualSupplyAmount
,"一季度供货面积" AS firstSeasonActualSupplyArea
,"一季度供货套数" AS firstSeasonActualSupplyNumber
,"一季度供货金额" AS firstSeasonActualSupplyAmount
,"二季度供货面积" AS secondSeasonActualSupplyArea
,"二季度供货套数" AS secondSeasonActualSupplyNumber
,"二季度供货金额" AS secondSeasonActualSupplyAmount
,"三季度供货面积" AS thirdSeasonActualSupplyArea
,"三季度供货套数" AS thirdSeasonActualSupplyNumber
,"三季度供货金额" AS thirdSeasonActualSupplyAmount
,"四季度供货面积" AS fourthSeasonActualSupplyArea
,"四季度供货套数" AS fourthSeasonActualSupplyNumber
,"四季度供货金额" AS fourthSeasonActualSupplyAmount
,"1月_供货面积" AS januaryActualSupplyArea
,"1月_供货套数" AS januaryActualSupplyNumber
,"1月_供货金额" AS januaryActualSupplyAmount
,"2月_供货面积" AS februaryActualSupplyArea
,"2月_供货套数" AS februaryActualSupplyNumber
,"2月_供货金额" AS februaryActualSupplyAmount
,"3月_供货面积" AS marchActualSupplyArea
,"3月_供货套数" AS marchActualSupplyNumber
,"3月_供货金额" AS marchActualSupplyAmount
,"4月_供货面积" AS aprilActualSupplyArea
,"4月_供货套数" AS aprilActualSupplyNumber
,"4月_供货金额" AS aprilActualSupplyAmount
,"5月_供货面积" AS mayActualSupplyArea
,"5月_供货套数" AS mayActualSupplyNumber
,"5月_供货金额" AS mayActualSupplyAmount
,"6月_供货面积" AS juneActualSupplyArea
,"6月_供货套数" AS juneActualSupplyNumber
,"6月_供货金额" AS juneActualSupplyAmount
,"7月_供货面积" AS julyActualSupplyArea
,"7月_供货套数" AS julyActualSupplyNumber
,"7月_供货金额" AS julyActualSupplyAmount
,"8月_供货面积" AS augustActualSupplyArea
,"8月_供货套数" AS augustActualSupplyNumber
,"8月_供货金额" AS augustActualSupplyAmount
,"9月_供货面积" AS septemberActualSupplyArea
,"9月_供货套数" AS septemberActualSupplyNumber
,"9月_供货金额" AS septemberActualSupplyAmount
,"10月_供货面积" AS octoberActualSupplyArea
,"10月_供货套数" AS octoberActualSupplyNumber
,"10月_供货金额" AS octoberActualSupplyAmount
,"11月_供货面积" AS novemberActualSupplyArea
,"11月_供货套数" AS novemberActualSupplyNumber
,"11月_供货金额" AS novemberActualSupplyAmount
,"12月_供货面积" AS decemberActualSupplyArea
,"12月_供货套数" AS decemberActualSupplyNumber
,"12月_供货金额" AS decemberActualSupplyAmount
,"本年销售面积" AS thisYearSellArea
,"本年销售套数" AS thisYearSellNumber
,"本年销售金额" AS thisYearSellAmount
,"一季度销售面积" AS januarySelllArea
,"一季度销售套数" AS januarySellNumber
,"一季度销售金额" AS januarySellAmount
,"二季度销售面积" AS secondSeasonSellArea
,"二季度销售套数" AS secondSeasonSellNumber
,"二季度销售金额" AS secondSeasonSellAmount
,"三季度销售面积" AS thirdSeasonSellArea
,"三季度销售套数" AS thirdSeasonSellNumber
,"三季度销售金额" AS thirdSeasonSellAmount
,"四季度销售面积" AS fourthSeasonSellArea
,"四季度销售套数" AS fourthSeasonSellNumber
,"四季度销售金额" AS fourthSeasonSellAmount
,"1月_销售面积" AS januarySellArea
,"1月_销售套数" AS januarySellNumber
,"1月_销售金额" AS januarySellAmount
,"2月_销售面积" AS februarySellArea
,"2月_销售套数" AS februarySellNumber
,"2月_销售金额" AS februarySellAmount
,"3月_销售面积" AS marchSellArea
,"3月_销售套数" AS marchSellNumber
,"3月_销售金额" AS marchSellAmount
,"4月_销售面积" AS aprilSellArea
,"4月_销售套数" AS aprilSellNumber
,"4月_销售金额" AS aprilSellAmount
,"5月_销售面积" AS maySellArea
,"5月_销售套数" AS maySellNumber
,"5月_销售金额" AS maySellAmount
,"6月_销售面积" AS juneSellArea
,"6月_销售套数" AS juneSellNumber
,"6月_销售金额" AS juneSellAmount
,"7月_销售面积" AS julySellArea
,"7月_销售套数" AS julySellNumber
,"7月_销售金额" AS julySellAmount
,"8月_销售面积" AS augustSellArea
,"8月_销售套数" AS augustSellNumber
,"8月_销售金额" AS augustSellAmount
,"9月_销售面积" AS septemberSellArea
,"9月_销售套数" AS septemberSellNumber
,"9月_销售金额" AS septemberSellAmount
,"10月_销售面积" AS octoberSellArea
,"10月_销售套数" AS octoberSellNumber
,"10月_销售金额" AS octoberSellAmount
,"11月_销售面积" AS novemberSellArea
,"11月_销售套数" AS novemberSellNumber
,"11月_销售金额" AS novemberSellAmount
,"12月_销售面积" AS decemberSellArea
,"12月_销售套数" AS decemberSellNumber
,"12月_销售金额" AS decemberSellAmount

FROM 
(						 
SELECT A.ID as PROJ_ID,A.PROJECT_NAME

,SUM(F.全案可售户数) AS 全案可售户数
,SUM(F.全案可售面积) AS 全案可售面积
,SUM(F.全案可售货值) AS 全案可售货值
,SUM(F.已取证面积) AS 已取证面积
,SUM(F.已取证货值) AS 已取证货值
,SUM(F.已取证套数) AS 已取证套数
,SUM(F.已售面积) AS 已售面积
,SUM(F.已售货值) AS 已售货值
,SUM(F.已售套数) AS 已售套数
,SUM(F.已取证库存面积) AS 已取证库存面积
,SUM(F.已取证库存货值) AS 已取证库存货值
,SUM(F.已取证库存套数) AS 已取证库存套数
,SUM(F.全案剩余货值) AS 全案剩余货值
,SUM(F.全案剩余面积) AS 全案剩余面积
,SUM(F.全案剩余套数) AS 全案剩余套数
,SUM(NVL(本年供货面积,0)) AS "本年供货面积"
,SUM(NVL(本年供货套数,0)) AS "本年供货套数"
,SUM(NVL(本年供货金额,0)) AS "本年供货金额"
,SUM(NVL(一季度供货面积,0)) AS "一季度供货面积"
,SUM(NVL(一季度供货套数,0)) AS "一季度供货套数"
,SUM(NVL(一季度供货金额,0)) AS "一季度供货金额"
,SUM(NVL(二季度供货面积,0)) AS "二季度供货面积"
,SUM(NVL(二季度供货套数,0)) AS "二季度供货套数"
,SUM(NVL(二季度供货金额,0)) AS "二季度供货金额"
,SUM(NVL(三季度供货面积,0)) AS "三季度供货面积"
,SUM(NVL(三季度供货套数,0)) AS "三季度供货套数"
,SUM(NVL(三季度供货金额,0)) AS "三季度供货金额"
,SUM(NVL(四季度供货面积,0)) AS "四季度供货面积"
,SUM(NVL(四季度供货套数,0)) AS "四季度供货套数"
,SUM(NVL(四季度供货金额,0)) AS "四季度供货金额"
,SUM(NVL("1月_供货面积",0)) AS "1月_供货面积"
,SUM(NVL("1月_供货套数",0)) AS "1月_供货套数"
,SUM(NVL("1月_供货金额",0)) AS "1月_供货金额"
,SUM(NVL("2月_供货面积",0)) AS "2月_供货面积"
,SUM(NVL("2月_供货套数",0)) AS "2月_供货套数"
,SUM(NVL("2月_供货金额",0)) AS "2月_供货金额"
,SUM(NVL("3月_供货面积",0)) AS "3月_供货面积"
,SUM(NVL("3月_供货套数",0)) AS "3月_供货套数"
,SUM(NVL("3月_供货金额",0)) AS "3月_供货金额"
,SUM(NVL("4月_供货面积",0)) AS "4月_供货面积"
,SUM(NVL("4月_供货套数",0)) AS "4月_供货套数"
,SUM(NVL("4月_供货金额",0)) AS "4月_供货金额"
,SUM(NVL("5月_供货面积",0)) AS "5月_供货面积"
,SUM(NVL("5月_供货套数",0)) AS "5月_供货套数"
,SUM(NVL("5月_供货金额",0)) AS "5月_供货金额"
,SUM(NVL("6月_供货面积",0)) AS "6月_供货面积"
,SUM(NVL("6月_供货套数",0)) AS "6月_供货套数"
,SUM(NVL("6月_供货金额",0)) AS "6月_供货金额"
,SUM(NVL("7月_供货面积",0)) AS "7月_供货面积"
,SUM(NVL("7月_供货套数",0)) AS "7月_供货套数"
,SUM(NVL("7月_供货金额",0)) AS "7月_供货金额"
,SUM(NVL("8月_供货面积",0)) AS "8月_供货面积"
,SUM(NVL("8月_供货套数",0)) AS "8月_供货套数"
,SUM(NVL("8月_供货金额",0)) AS "8月_供货金额"
,SUM(NVL("9月_供货面积",0)) AS "9月_供货面积"
,SUM(NVL("9月_供货套数",0)) AS "9月_供货套数"
,SUM(NVL("9月_供货金额",0)) AS "9月_供货金额"
,SUM(NVL("10月_供货面积",0)) AS "10月_供货面积"
,SUM(NVL("10月_供货套数",0)) AS "10月_供货套数"
,SUM(NVL("10月_供货金额",0)) AS "10月_供货金额"
,SUM(NVL("11月_供货面积",0)) AS "11月_供货面积"
,SUM(NVL("11月_供货套数",0)) AS "11月_供货套数"
,SUM(NVL("11月_供货金额",0)) AS "11月_供货金额"
,SUM(NVL("12月_供货面积",0)) AS "12月_供货面积"
,SUM(NVL("12月_供货套数",0)) AS "12月_供货套数"
,SUM(NVL("12月_供货金额",0)) AS "12月_供货金额"
,SUM(NVL(本年销售面积,0)) AS "本年销售面积"
,SUM(NVL(本年销售套数,0)) AS "本年销售套数"
,SUM(NVL(本年销售金额,0)) AS "本年销售金额"
,SUM(NVL(一季度销售面积,0)) AS "一季度销售面积"
,SUM(NVL(一季度销售套数,0)) AS "一季度销售套数"
,SUM(NVL(一季度销售金额,0)) AS "一季度销售金额"
,SUM(NVL(二季度销售面积,0)) AS "二季度销售面积"
,SUM(NVL(二季度销售套数,0)) AS "二季度销售套数"
,SUM(NVL(二季度销售金额,0)) AS "二季度销售金额"
,SUM(NVL(三季度销售面积,0)) AS "三季度销售面积"
,SUM(NVL(三季度销售套数,0)) AS "三季度销售套数"
,SUM(NVL(三季度销售金额,0)) AS "三季度销售金额"
,SUM(NVL(四季度销售面积,0)) AS "四季度销售面积"
,SUM(NVL(四季度销售套数,0)) AS "四季度销售套数"
,SUM(NVL(四季度销售金额,0)) AS "四季度销售金额"
,SUM(NVL("1月_销售面积",0)) AS "1月_销售面积"
,SUM(NVL("1月_销售套数",0)) AS "1月_销售套数"
,SUM(NVL("1月_销售金额",0)) AS "1月_销售金额"
,SUM(NVL("2月_销售面积",0)) AS "2月_销售面积"
,SUM(NVL("2月_销售套数",0)) AS "2月_销售套数"
,SUM(NVL("2月_销售金额",0)) AS "2月_销售金额"
,SUM(NVL("3月_销售面积",0)) AS "3月_销售面积"
,SUM(NVL("3月_销售套数",0)) AS "3月_销售套数"
,SUM(NVL("3月_销售金额",0)) AS "3月_销售金额"
,SUM(NVL("4月_销售面积",0)) AS "4月_销售面积"
,SUM(NVL("4月_销售套数",0)) AS "4月_销售套数"
,SUM(NVL("4月_销售金额",0)) AS "4月_销售金额"
,SUM(NVL("5月_销售面积",0)) AS "5月_销售面积"
,SUM(NVL("5月_销售套数",0)) AS "5月_销售套数"
,SUM(NVL("5月_销售金额",0)) AS "5月_销售金额"
,SUM(NVL("6月_销售面积",0)) AS "6月_销售面积"
,SUM(NVL("6月_销售套数",0)) AS "6月_销售套数"
,SUM(NVL("6月_销售金额",0)) AS "6月_销售金额"
,SUM(NVL("7月_销售面积",0)) AS "7月_销售面积"
,SUM(NVL("7月_销售套数",0)) AS "7月_销售套数"
,SUM(NVL("7月_销售金额",0)) AS "7月_销售金额"
,SUM(NVL("8月_销售面积",0)) AS "8月_销售面积"
,SUM(NVL("8月_销售套数",0)) AS "8月_销售套数"
,SUM(NVL("8月_销售金额",0)) AS "8月_销售金额"
,SUM(NVL("9月_销售面积",0)) AS "9月_销售面积"
,SUM(NVL("9月_销售套数",0)) AS "9月_销售套数"
,SUM(NVL("9月_销售金额",0)) AS "9月_销售金额"
,SUM(NVL("10月_销售面积",0)) AS "10月_销售面积"
,SUM(NVL("10月_销售套数",0)) AS "10月_销售套数"
,SUM(NVL("10月_销售金额",0)) AS "10月_销售金额"
,SUM(NVL("11月_销售面积",0)) AS "11月_销售面积"
,SUM(NVL("11月_销售套数",0)) AS "11月_销售套数"
,SUM(NVL("11月_销售金额",0)) AS "11月_销售金额"
,SUM(NVL("12月_销售面积",0)) AS "12月_销售面积"
,SUM(NVL("12月_销售套数",0)) AS "12月_销售套数"
,SUM(NVL("12月_销售金额",0)) AS "12月_销售金额"
FROM SYS_PROJECT A 
INNER JOIN SYS_PROJECT_STAGE B ON A.ID=B.PROJECT_ID
-- FULL JOIN (SELECT * FROM MDM_BUILD_PRODUCT_TYPE  WHERE PRODUCT_TYPE_LEVEL=1 AND IS_END=0) C ON 1=1
LEFT JOIN 
(
	SELECT PROJ_ID,STAGE_ID,STAGE_NAME,"一级业态",PRODUCT_TYPE_NAME,PD.ID AS  PRODUCT_TYPE_ID , PRODUCT_TYPE_SHORT_CODE
	,SUM(NVL(总车位数,0))+SUM(NVL(总户数,0))  AS  全案可售户数
	,SUM(NVL(总可售面积,0))  AS 全案可售面积
	,SUM(NVL(A_当前最新版目标货值,0))  AS 全案可售货值
	,SUM(NVL(已取证建筑面积,0))  AS  已取证面积
	,SUM(NVL(已取证货值,0)) AS  已取证货值
	,SUM(NVL(已取证套数,0)) AS 已取证套数
	,SUM(NVL(已售建筑面积,0))  AS 已售面积
	,SUM(NVL(已售货值,0)) AS 已售货值
	,SUM(NVL(已售套数,0)) AS 已售套数
	,SUM(NVL(库存建筑面积,0))  AS 已取证库存面积
	,SUM(NVL(库存货值,0)) AS 已取证库存货值
	,SUM(NVL(库存套数,0)) AS 已取证库存套数
	,SUM(NVL(全案剩余货值,0)) AS 全案剩余货值
	,SUM(NVL(全案剩余面积,0)) AS 全案剩余面积
	,SUM(NVL(全案剩余套数,0))  AS 全案剩余套数
	FROM SWM_DT_VALUE_TABLE   
	LEFT JOIN MDM_BUILD_PRODUCT_TYPE PD ON PD.PRODUCT_TYPE_NAME="一级业态"
	--WHERE  PROJECT_NAME LIKE '%北京西派国际%' 
	GROUP BY PROJ_ID,STAGE_ID,STAGE_NAME,"一级业态",PRODUCT_TYPE_SHORT_CODE,PD.ID ,PRODUCT_TYPE_NAME
) F ON F.STAGE_ID=B.ID --AND F."一级业态"=F.PRODUCT_TYPE_NAME
LEFT  JOIN  SWM_MONTH_RealSUPPLY_DTL D ON  D.STAGE_ID=B.ID   AND D."实际供货年份"=TO_CHAR(SYSDATE,'YYYY') AND F.PRODUCT_TYPE_NAME=D."一级业态"
LEFT JOIN  SWM_MOTH_RealSALE_DTL E ON  E.STAGE_ID=B.ID      AND 销售年份=TO_CHAR(SYSDATE,'YYYY') AND F.PRODUCT_TYPE_NAME=E."PRODUCT_NAME"
--WHERE  A.PROJECT_NAME LIKE '%北湖%'  
GROUP BY  A.ID,A.PROJECT_NAME
) A2 ;--WHERE   PROJ_ID='10905db7-5420-4fc2-a99b-190f44ee1163';
-------------------------------------------最新版监控----------------------
DELETE  SWM_SUPPLY_MONITOR_LIST ;
INSERT INTO  SWM_SUPPLY_MONITOR_LIST
WITH  LIST_SWM_SUPPLY_MONITOR 
(

"PROJ_ID"
,"OBJ_TYPE"
,"OBJ_ID"
,"OBJ_NAME"
,"PD_NAME"
,"OBJ_PARENT_ID"
,"LEVEL"
,"LEVEL_ORDER"
,"ORDER_CODE"
,"COMPANY_NAME"
,"COMPANY_ID"
,"COMPANY_ORDER_HIERARCHY_CODE"
,"id"
,"projConstitute"
,"parentId"
,"ORDER_HIERARCHY_CODE"
,"objId"
,"objType"
,"buildProductTypeName"
,"ownBuildProductTypeId"
,"buildProductTypeId"
,"thisYearSupplyAmount"
,"thisYearSupplyNumber"
,"thisYearSupplyArea"
,"firstSeasonSupplyAmount"
,"firstSeasonSupplyNumber"
,"firstSeasonSupplyArea"
,"januarySupplyAmount"
,"januarySupplyNumberx"
,"januarySupplyNumber"
,"februarySupplyAmount"
,"februarySupplyNumber"
,"februarySupplyArea"
,"marchSupplyAmount"
,"marchSupplyNumber"
,"marchSupplyArea"
,"secondSeasonSupplyAmount"
,"secondSeasonSupplyNumber"
,"secondSeasonSupplyArea"
,"aprilSupplyAmount"
,"aprilSupplyNumber"
,"aprilSupplyArea"
,"maySupplyAmount"
,"maySupplyNumber"
,"maySupplyArea"
,"juneSupplyAmount"
,"juneSupplyNumber"
,"juneSupplyArea"
,"thirdSeasonSupplyAmount"
,"thirdSeasonSupplyNumber"
,"thirdSeasonSupplyArea"
,"julySupplyAmount"
,"julySupplyNumber"
,"julySupplyArea"
,"augustSupplyAmount"
,"augustSupplyNumber"
,"augustSupplyArea"
,"septemberSupplyAmount"
,"septemberSupplyNumber"
,"septemberSupplyArea"
,"fourthSeasonSupplyAmount"
,"fourthSeasonSupplyNumber"
,"fourthSeasonSupplyArea"
,"octoberSupplyAmount"
,"octoberSupplyNumber"
,"octoberSupplyArea"
,"novemberSupplyAmount"
,"novemberSupplyNumber"
,"novemberSupplyArea"
,"decemberSupplyAmount"
,"decemberSupplyNumber"
,"decemberSupplyArea"
------计划销售

,"thisYearSellPlannedAmount"--金额（年计划销售）
,"thisYearSellPlannedNumber"--套数（年计划销售）
,"thisYearSellPlannedArea"--面积（年计划销售）
,"firstSeonSellPlannedAmount"--金额（1季度计划销售）
,"firstSeonSellPlannedNumber"--套数（1季度计划销售）
,"firstSeonSellPlannedArea"--面积（1季度计划销售）
,"secondSeonSellPlannedAmount"--金额（2季度计划销售）
,"secondSeonSellPlannedNumber"--套数（2季度计划销售）
,"secondSeonSellPlannedArea"--面积（2季度计划销售）
,"thirdSeonSellPlannedAmount"--金额（3季度计划销售）
,"thirdSeonSellPlannedNumber"--套数（3季度计划销售）
,"thirdSeonSellPlannedArea"--面积（3季度计划销售）
,"fourthSeonSellPlannedAmount"--金额（4季度计划销售）
,"fourthSeonSellPlannedNumber"--套数（4季度计划销售）
,"fourthSeonSellPlannedArea"--面积（4季度计划销售）
,"januarySellPlannedAmount"--金额（1月计划销售）
,"januarySellPlannedNumber"--套数（1月计划销售）
,"januarySellPlannedArea"--面积（1月计划销售）
,"februarySellPlannedAmount"--金额（2月计划销售）
,"februarySellPlannedNumber"--套数（2月计划销售）
,"februarySellPlannedArea"--面积（2月计划销售）
,"marchSellPlannedAmount"--金额（3月计划销售）
,"marchSellPlannedNumber"--套数（3月计划销售）
,"marchSellPlannedArea"--面积（3月计划销售）
,"aprilSellPlannedAmount"--金额（4月计划销售）
,"aprilSellPlannedNumber"--套数（4月计划销售）
,"aprilSellPlannedArea"--面积（4月计划销售）
,"maySellPlannedAmount"--金额（5月计划销售）
,"maySellPlannedNumber"--套数（5月计划销售）
,"maySellPlannedArea"--面积（5月计划销售）
,"juneSellPlannedAmount"--金额（6月计划销售）
,"juneSellPlannedNumber"--套数（6月计划销售）
,"juneSellPlannedArea"--面积（6月计划销售）
,"julySellPlannedAmount"--金额（7月计划销售）
,"julySellPlannedNumber"--套数（7月计划销售）
,"julySellPlannedArea"--面积（7月计划销售）
,"augustSellPlannedAmount"--金额（8月计划销售）
,"augustSellPlannedNumber"--套数（8月计划销售）
,"augustSellPlannedArea"--面积（8月计划销售）
,"septemberSellPlannedAmount"--金额（10月计划销售）
,"septemberSellPlannedNumber"--套数（10月计划销售）
,"septemberSellPlannedArea"--面积（10月计划销售）
,"octoberSellPlannedAmount"--金额（10月计划销售）
,"octoberSellPlannedNumber"--套数（10月计划销售）
,"octoberSellPlannedArea"--面积（10月计划销售）
,"novemberSellPlannedAmount"--金额（11月计划销售）
,"novemberSellPlannedNumber"--套数（11月计划销售）
,"novemberSellPlannedArea"--面积（11月计划销售）
,"decemberSellPlannedAmount"--金额（12月计划销售）
,"decemberSellPlannedNumber"--套数（12月计划销售）
,"decemberSellPlannedArea"--面积（12月计划销售）


------------实际
,"LEVEL(1)"
,"poTotalSaleCount"
,"poTotalSaleArea"
,"poTotalSaleAmount"
,"rpTotalArea"
,"rpTotalAmount"
,"rpTotalCount"
,"poSaleArea"
,"poSaleAmount"
,"poSaleCount"
,"rpSurplusArea"
,"rpSurplusAmount"
,"rpSurplusCount"
,"poSurplusSaleAmount"
,"poSurplusSaleArea"
,"poSurplusSaleCount"
,"thisYearActualSupplyArea"
,"thisYearActualSupplyNumber"
,"thisYearActualSupplyAmount"
,"firstSeasonActualSupplyArea"
,"firstSeasonActualSupplyNumber"
,"firstSeasonActualSupplyAmount"
,"secondSeasonActualSupplyArea"
,"secondSeasonActualSupplyNumber"
,"secondSeasonActualSupplyAmount"
,"thirdSeasonActualSupplyArea"
,"thirdSeasonActualSupplyNumber"
,"thirdSeasonActualSupplyAmount"
,"fourthSeasonActualSupplyArea"
,"fourthSeasonActualSupplyNumber"
,"fourthSeasonActualSupplyAmount"
,"januaryActualSupplyArea"
,"januaryActualSupplyNumber"
,"januaryActualSupplyAmount"
,"februaryActualSupplyArea"
,"februaryActualSupplyNumber"
,"februaryActualSupplyAmount"
,"marchActualSupplyArea"
,"marchActualSupplyNumber"
,"marchActualSupplyAmount"
,"aprilActualSupplyArea"
,"aprilActualSupplyNumber"
,"aprilActualSupplyAmount"
,"mayActualSupplyArea"
,"mayActualSupplyNumber"
,"mayActualSupplyAmount"
,"juneActualSupplyArea"
,"juneActualSupplyNumber"
,"juneActualSupplyAmount"
,"julyActualSupplyArea"
,"julyActualSupplyNumber"
,"julyActualSupplyAmount"
,"augustActualSupplyArea"
,"augustActualSupplyNumber"
,"augustActualSupplyAmount"
,"septemberActualSupplyArea"
,"septemberActualSupplyNumber"
,"septemberActualSupplyAmount"
,"octoberActualSupplyArea"
,"octoberActualSupplyNumber"
,"octoberActualSupplyAmount"
,"novemberActualSupplyArea"
,"novemberActualSupplyNumber"
,"novemberActualSupplyAmount"
,"decemberActualSupplyArea"
,"decemberActualSupplyNumber"
,"decemberActualSupplyAmount"
,"thisYearSellArea"
,"thisYearSellNumber"
,"thisYearSellAmount"
,"firstSellArea"
,"firstSellNumber"
,"firstSellAmount"
,"secondSeasonSellArea"
,"secondSeasonSellNumber"
,"secondSeasonSellAmount"
,"thirdSeasonSellArea"
,"thirdSeasonSellNumber"
,"thirdSeasonSellAmount"
,"fourthSeasonSellArea"
,"fourthSeasonSellNumber"
,"fourthSeasonSellAmount"
,"januarySellArea"
,"januarySellNumber"
,"januarySellAmount"
,"februarySellArea"
,"februarySellNumber"
,"februarySellAmount"
,"marchSellArea"
,"marchSellNumber"
,"marchSellAmount"
,"aprilSellArea"
,"aprilSellNumber"
,"aprilSellAmount"
,"maySellArea"
,"maySellNumber"
,"maySellAmount"
,"juneSellArea"
,"juneSellNumber"
,"juneSellAmount"
,"julySellArea"
,"julySellNumber"
,"julySellAmount"
,"augustSellArea"
,"augustSellNumber"
,"augustSellAmount"
,"septemberSellArea"
,"septemberSellNumber"
,"septemberSellAmount"
,"octoberSellArea"
,"octoberSellNumber"
,"octoberSellAmount"
,"novemberSellArea"
,"novemberSellNumber"
,"novemberSellAmount"
,"decemberSellArea"
,"decemberSellNumber"
,"decemberSellAmount"
)
AS (

SELECT 	
A1.*
,A1.OBJ_ID	      as "id"
, A1.OBJ_NAME AS "projConstitute"--项目构成 objName 项目构成
,A1.OBJ_PARENT_ID AS "parentId"--父级id（生成树父级id）业务父ID bizPrentId
,A1.ORDER_CODE AS ORDER_HIERARCHY_CODE
,A1.OBJ_ID	    AS "objId"--项目ID
,A1.OBJ_TYPE    AS "objType"--对象类型
,A1.PD_NAME    AS "buildProductTypeName"--业态名称
,A1.OBJ_ID      AS "ownBuildProductTypeId"--所属的一级业态id
,A1.OBJ_ID      AS "buildProductTypeId"--业态Id
, "本年计划供货金额" AS "thisYearSupplyAmount"--金额（年计划供货）,
, "本年计划供货套数" AS "thisYearSupplyNumber"--套数（年计划供货）
, "本年计划供货面积" AS "thisYearSupplyArea"--面积（年计划供货）
, "一季度供货金额" AS "firstSeasonSupplyAmount"--金额（1季度计划供货）
, "一季度供货套数" AS "firstSeasonSupplyNumber"--套数（1季度计划供货）
, "一季度供货面积" AS "firstSeasonSupplyArea"--面积（1季度计划供货）
, "一月供货金额" AS "januarySupplyAmount"--金额（一月计划供货）
, "一月供货套数" AS "januarySupplyNumberx"--套数（一月计划供货）
, "一月供货面积" AS "januarySupplyNumber"--面积（一月计划供货）
, "二月供货金额" AS "februarySupplyAmount"--金额（二月计划供货）
, "二月供货套数" AS "februarySupplyNumber"--套数（二月计划供货）
, "二月供货面积" AS "februarySupplyArea"--面积（二月计划供货）
, "三月供货金额" AS "marchSupplyAmount"--金额（三月计划供货）
, "三月供货套数" AS "marchSupplyNumber"--套数（三月计划供货）
, "三月供货面积" AS "marchSupplyArea"--面积（三月计划供货）
, "二季度供货金额" AS "secondSeasonSupplyAmount"--金额（2季度计划供货）
, "二季度供货套数" AS "secondSeasonSupplyNumber"--套数（2季度计划供货）
, "二季度供货面积" AS "secondSeasonSupplyArea"--面积（2季度计划供货）
, "四月供货金额" AS "aprilSupplyAmount"--金额（四月计划供货）
, "四月供货套数" AS "aprilSupplyNumber"--套数（四月计划供货）
, "四月供货面积" AS "aprilSupplyArea"--面积（四月计划供货）
, "五月供货金额" AS "maySupplyAmount"--金额（五月计划供货）
, "五月供货套数" AS "maySupplyNumber"--套数（五月计划供货）
, "五月供货面积" AS "maySupplyArea"--面积（五月计划供货）
, "六月供货金额" AS "juneSupplyAmount"--金额（六月计划供货）
, "六月供货套数" AS "juneSupplyNumber"--套数（六月计划供货）
, "六月供货面积" AS "juneSupplyArea"--面积（六月计划供货）
, "三季度供货金额" AS "thirdSeasonSupplyAmount"--金额（3季度计划供货）
, "三季度供货套数" AS "thirdSeasonSupplyNumber"--套数（3季度计划供货）
, "三季度供货面积" AS "thirdSeasonSupplyArea"--面积（3季度计划供货）
, "七月供货金额" AS "julySupplyAmount"--金额（七月计划供货）
, "七月供货套数" AS "julySupplyNumber"--套数（七月计划供货）
, "七月供货面积" AS "julySupplyArea"--面积（七月计划供货）
, "八月供货金额" AS "augustSupplyAmount"--金额（八月计划供货）
, "八月供货套数" AS "augustSupplyNumber"--套数（八月计划供货）
, "八月供货面积" AS "augustSupplyArea"--面积（八月计划供货）
, "九月供货金额" AS "septemberSupplyAmount"--金额（九月计划供货）
, "九月供货套数" AS "septemberSupplyNumber"--套数（九月计划供货）
, "九月供货面积" AS "septemberSupplyArea"--面积（九月计划供货）
, "四季度供货金额" AS "fourthSeasonSupplyAmount"--金额（4季度计划供货）
, "四季度供货套数" AS "fourthSeasonSupplyNumber"--套数（4季度计划供货）
, "四季度供货面积" AS "fourthSeasonSupplyArea"--面积（4季度计划供货）
, "十月供货金额" AS "octoberSupplyAmount"--金额（十月计划供货）
, "十月供货套数" AS "octoberSupplyNumber"--套数（十月计划供货）
, "十月供货面积" AS "octoberSupplyArea"--面积（十月计划供货）
, "十一月供货金额" AS "novemberSupplyAmount"--金额（十一月计划供货）
, "十一月供货套数" AS "novemberSupplyNumber"--套数（十一月计划供货）
, "十一月供货面积" AS "novemberSupplyArea"--面积（十一月计划供货）
, "十二月供货金额" AS "decemberSupplyAmount"--金额（十二月计划供货）
, "十二月供货套数" AS "decemberSupplyNumber"--套数（十二月计划供货）
, "十二月供货面积" AS "decemberSupplyArea"--面积（十二月计划供货）
--,本年计划销售金额  AS  "thisYearSellPlannedArea"
----计划销售
,"本年计划销售金额" AS "thisYearSellPlannedAmount"--金额（年计划销售）
,"本年计划销售套数" AS "thisYearSellPlannedNumber"--套数（年计划销售）
,"本年计划销售面积" AS "thisYearSellPlannedArea"--面积（年计划销售）
,"一季度销售金额" AS "firstSeonSellPlannedAmount"--金额（1季度计划销售）
,"一季度销售套数" AS "firstSeonSellPlannedNumber"--套数（1季度计划销售）
,"一季度销售面积" AS "firstSeonSellPlannedArea"--面积（1季度计划销售）
,"二季度销售金额" AS "secondSeonSellPlannedAmount"--金额（2季度计划销售）
,"二季度销售套数" AS "secondSeonSellPlannedNumber"--套数（2季度计划销售）
,"二季度销售面积" AS "secondSeonSellPlannedArea"--面积（2季度计划销售）
,"三季度销售金额" AS "thirdSeonSellPlannedAmount"--金额（3季度计划销售）
,"三季度销售套数" AS "thirdSeonSellPlannedNumber"--套数（3季度计划销售）
,"三季度销售面积" AS "thirdSeonSellPlannedArea"--面积（3季度计划销售）
,"四季度销售金额" AS "fourthSeonSellPlannedAmount"--金额（4季度计划销售）
,"四季度销售套数" AS "fourthSeonSellPlannedNumber"--套数（4季度计划销售）
,"四季度销售面积" AS "fourthSeonSellPlannedArea"--面积（4季度计划销售）
,"一月签约金额" AS "januarySellPlannedAmount"--金额（1月计划销售）
,"一月签约套数" AS "januarySellPlannedNumber"--套数（1月计划销售）
,"一月签约面积" AS "januarySellPlannedArea"--面积（1月计划销售）
,"二月签约金额" AS "februarySellPlannedAmount"--金额（2月计划销售）
,"二月签约套数" AS "februarySellPlannedNumber"--套数（2月计划销售）
,"二月签约面积" AS "februarySellPlannedArea"--面积（2月计划销售）
,"三月签约金额" AS "marchSellPlannedAmount"--金额（3月计划销售）
,"三月签约套数" AS "marchSellPlannedNumber"--套数（3月计划销售）
,"三月签约面积" AS "marchSellPlannedArea"--面积（3月计划销售）
,"四月签约金额" AS "aprilSellPlannedAmount"--金额（4月计划销售）
,"四月签约套数" AS "aprilSellPlannedNumber"--套数（4月计划销售）
,"四月签约面积" AS "aprilSellPlannedArea"--面积（4月计划销售）
,"五月签约金额" AS "maySellPlannedAmount"--金额（5月计划销售）
,"五月签约套数" AS "maySellPlannedNumber"--套数（5月计划销售）
,"五月签约面积" AS "maySellPlannedArea"--面积（5月计划销售）
,"六月签约金额" AS "juneSellPlannedAmount"--金额（6月计划销售）
,"六月签约套数" AS "juneSellPlannedNumber"--套数（6月计划销售）
,"六月签约面积" AS "juneSellPlannedArea"--面积（6月计划销售）
,"七月签约金额" AS "julySellPlannedAmount"--金额（7月计划销售）
,"七月签约套数" AS "julySellPlannedNumber"--套数（7月计划销售）
,"七月签约面积" AS "julySellPlannedArea"--面积（7月计划销售）
,"八月签约金额" AS "augustSellPlannedAmount"--金额（8月计划销售）
,"八月签约套数" AS "augustSellPlannedNumber"--套数（8月计划销售）
,"八月签约面积" AS "augustSellPlannedArea"--面积（8月计划销售）
,"九月签约金额" AS "septemberSellPlannedAmount"--金额（10月计划销售）
,"九月签约套数" AS "septemberSellPlannedNumber"--套数（10月计划销售）
,"九月签约面积" AS "septemberSellPlannedArea"--面积（10月计划销售）
,"十月签约金额" AS "octoberSellPlannedAmount"--金额（10月计划销售）
,"十月签约套数" AS "octoberSellPlannedNumber"--套数（10月计划销售）
,"十月签约面积" AS "octoberSellPlannedArea"--面积（10月计划销售）
,"十一月签约金额" AS "novemberSellPlannedAmount"--金额（11月计划销售）
,"十一月签约套数" AS "novemberSellPlannedNumber"--套数（11月计划销售）
,"十一月签约面积" AS "novemberSellPlannedArea"--面积（11月计划销售）
,"十二月签约金额" AS "decemberSellPlannedAmount"--金额（12月计划销售）
,"十二月签约套数" AS "decemberSellPlannedNumber"--套数（12月计划销售）
,"十二月签约面积" AS "decemberSellPlannedArea"--面积（12月计划销售）



------实际
,P2."LEVEL"					
,P2."poTotalSaleCount"
,P2."poTotalSaleArea"
,P2."poTotalSaleAmount"
,P2."rpTotalArea"
,P2."rpTotalAmount"
,P2."rpTotalCount"
,P2."poSaleArea"
,P2."poSaleAmount"
,P2."poSaleCount"
,P2."rpSurplusArea"
,P2."rpSurplusAmount"
,P2."rpSurplusCount"
,P2."poSurplusSaleAmount"
,P2."poSurplusSaleArea"
,P2."poSurplusSaleCount"
,P2."thisYearActualSupplyArea"
,P2."thisYearActualSupplyNumber"
,P2."thisYearActualSupplyAmount"
,P2."firstSeasonActualSupplyArea"
,P2."firstSeasonActualSupplyNumber"
,P2."firstSeasonActualSupplyAmount"
,P2."secondSeasonActualSupplyArea"
,P2."secondSeasonActualSupplyNumber"
,P2."secondSeasonActualSupplyAmount"
,P2."thirdSeasonActualSupplyArea"
,P2."thirdSeasonActualSupplyNumber"
,P2."thirdSeasonActualSupplyAmount"
,P2."fourthSeasonActualSupplyArea"
,P2."fourthSeasonActualSupplyNumber"
,P2."fourthSeasonActualSupplyAmount"
,P2."januaryActualSupplyArea"
,P2."januaryActualSupplyNumber"
,P2."januaryActualSupplyAmount"
,P2."februaryActualSupplyArea"
,P2."februaryActualSupplyNumber"
,P2."februaryActualSupplyAmount"
,P2."marchActualSupplyArea"
,P2."marchActualSupplyNumber"
,P2."marchActualSupplyAmount"
,P2."aprilActualSupplyArea"
,P2."aprilActualSupplyNumber"
,P2."aprilActualSupplyAmount"
,P2."mayActualSupplyArea"
,P2."mayActualSupplyNumber"
,P2."mayActualSupplyAmount"
,P2."juneActualSupplyArea"
,P2."juneActualSupplyNumber"
,P2."juneActualSupplyAmount"
,P2."julyActualSupplyArea"
,P2."julyActualSupplyNumber"
,P2."julyActualSupplyAmount"
,P2."augustActualSupplyArea"
,P2."augustActualSupplyNumber"
,P2."augustActualSupplyAmount"
,P2."septemberActualSupplyArea"
,P2."septemberActualSupplyNumber"
,P2."septemberActualSupplyAmount"
,P2."octoberActualSupplyArea"
,P2."octoberActualSupplyNumber"
,P2."octoberActualSupplyAmount"
,P2."novemberActualSupplyArea"
,P2."novemberActualSupplyNumber"
,P2."novemberActualSupplyAmount"
,P2."decemberActualSupplyArea"
,P2."decemberActualSupplyNumber"
,P2."decemberActualSupplyAmount"
,P2."thisYearSellArea"
,P2."thisYearSellNumber"
,P2."thisYearSellAmount"
,P2."firstSellArea"
,P2."firstSellNumber"
,P2."firstSellAmount"
,P2."secondSeasonSellArea"
,P2."secondSeasonSellNumber"
,P2."secondSeasonSellAmount"
,P2."thirdSeasonSellArea"
,P2."thirdSeasonSellNumber"
,P2."thirdSeasonSellAmount"
,P2."fourthSeasonSellArea"
,P2."fourthSeasonSellNumber"
,P2."fourthSeasonSellAmount"
,P2."januarySellArea"
,P2."januarySellNumber"
,P2."januarySellAmount"
,P2."februarySellArea"
,P2."februarySellNumber"
,P2."februarySellAmount"
,P2."marchSellArea"
,P2."marchSellNumber"
,P2."marchSellAmount"
,P2."aprilSellArea"
,P2."aprilSellNumber"
,P2."aprilSellAmount"
,P2."maySellArea"
,P2."maySellNumber"
,P2."maySellAmount"
,P2."juneSellArea"
,P2."juneSellNumber"
,P2."juneSellAmount"
,P2."julySellArea"
,P2."julySellNumber"
,P2."julySellAmount"
,P2."augustSellArea"
,P2."augustSellNumber"
,P2."augustSellAmount"
,P2."septemberSellArea"
,P2."septemberSellNumber"
,P2."septemberSellAmount"
,P2."octoberSellArea"
,P2."octoberSellNumber"
,P2."octoberSellAmount"
,P2."novemberSellArea"
,P2."novemberSellNumber"
,P2."novemberSellAmount"
,P2."decemberSellArea"
,P2."decemberSellNumber"
,P2."decemberSellAmount"

FROM 
--项目树
 (
--项目
SELECT PR.ID AS PROJ_ID,'项目' OBJ_TYPE,PR.ID AS OBJ_ID
,PROJECT_NAME AS OBJ_NAME
,NULL AS PD_NAME
,COMPANY_ID AS OBJ_PARENT_ID  --项目所属公司为父级
--,(SELECT O.ID FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID)  AS OBJ_PARENT_ID  --项目所属区域公司为父级
,'1' AS "LEVEL"
,'1' AS "LEVEL_ORDER" 
--,COMPANY_ORDER_HIERARCHY_CODE||'_'||PROJECT_CODE||'_0' AS ORDER_CODE --奥霖排序
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) ||'_'||PROJECT_CODE AS ORDER_CODE --lixc排序
,(SELECT O.ORG_NAME FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_NAME
,(SELECT O.ID FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ID
,(SELECT O.ORDER_HIERARCHY_CODE  FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ORDER_HIERARCHY_CODE 
 FROM SYS_PROJECT PR 
--存在供货计划才查询
	WHERE    EXISTS ( SELECT 1 FROM SWM_SUPPLY_SELL_PLAN SP WHERE  SP.PROJECT_ID=PR.ID AND IS_DELETED=0 AND APPROVAL_STATUS='已审核' )
 UNION ALL 
--按业态汇总-
SELECT PR.ID AS PROJ_ID,'按业态汇总' OBJ_TYPE,PR.ID||'_firstLevelProductTypeStatistics' AS OBJ_ID
,'按业态汇总' AS OBJ_NAME
, NULL AS PD_NAME
,PR.ID AS OBJ_PARENT_ID ,'2' AS "LEVEL",'2' AS "LEVEL_ORDER" 
--,'99_'||LPAD (PR.SN , 6 , '0')||'_00' AS ORDER_CODE  
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) ||'_'||PROJECT_CODE||'_0' ----lixc排序
,(SELECT O.ORG_NAME FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_NAME
,(SELECT O.ID FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ID 
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ORDER_HIERARCHY_CODE 
FROM SYS_PROJECT PR 
UNION ALL 
--按业态汇总一级业态

SELECT PR.ID AS PROJ_ID,'一级业态' OBJ_TYPE,PR.ID||'_'||PD.ID AS OBJ_ID
,PRODUCT_TYPE_NAME AS OBJ_NAME
,PRODUCT_TYPE_NAME AS PD_NAME
,PR.ID||'_firstLevelProductTypeStatistics' AS OBJ_PARENT_ID  
,'3' AS "LEVEL",'4' AS "LEVEL_ORDER" 
--,'99_'||LPAD (PR.SN , 6 , '0')||'_00_'||PRODUCT_TYPE_SHORT_CODE   AS ORDER_CODE
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) ||'_'||PROJECT_CODE||'_0'||CASE WHEN  PRODUCT_TYPE_NAME='住宅' THEN '1'  WHEN  PRODUCT_TYPE_NAME='商办产业' THEN '2'  WHEN  PRODUCT_TYPE_NAME='车位仓储' THEN '3'  WHEN  PRODUCT_TYPE_NAME='配套设施' THEN '4'  END AS  ORDER_CODE----lixc排序
,(SELECT O.ORG_NAME FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_NAME
,(SELECT O.ID FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ID
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ORDER_HIERARCHY_CODE 
	FROM SYS_PROJECT PR 
	INNER JOIN MDM_BUILD_PRODUCT_TYPE PD ON 1=1 AND PRODUCT_TYPE_LEVEL=1 --and  PROJECT_NAME='北京西派国际'
	
--分期
UNION ALL 
SELECT PS.ID AS STAGE_ID,'分期' OBJ_TYPE,PR.ID||'_'||PS.ID AS OBJ_ID
,STAGE_NAME AS OBJ_NAME
,NULL PD_NAME
,PR.ID AS OBJ_PARENT_ID 
,'2' AS "LEVEL",'3' AS "LEVEL_ORDER"
--,'99_'||LPAD (PR.SN , 6 , '0')||'_10_'||PS.ORDER_CODE  AS ORDER_CODE  
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) ||'_'||PROJECT_CODE||'_'||PS.ORDER_CODE AS  ORDER_CODE
,(SELECT O.ORG_NAME FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_NAME
,(SELECT O.ID FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ID
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ORDER_HIERARCHY_CODE 
FROM SYS_PROJECT PR  INNER JOIN SYS_PROJECT_STAGE PS ON PR.ID=PROJECT_ID

--分期业态
UNION ALL 
SELECT PS.ID AS STAGE_ID,'分期业态' OBJ_TYPE
,PR.ID||'_'||PS.ID||'_'||Pd.ID AS OBJ_ID
,PRODUCT_TYPE_NAME AS OBJ_NAME
,PRODUCT_TYPE_NAME AS PD_NAME
,PR.ID||'_'||PS.ID AS OBJ_PARENT_ID 
,'3' AS "LEVEL",'4' AS "LEVEL_ORDER"
--, '99_'||LPAD (PR.SN , 6 , '0')||'_10_'||PS.ORDER_CODE||'_'||PRODUCT_TYPE_SHORT_CODE   AS ORDER_CODE  
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) ||'_'||PROJECT_CODE||'_'||PS.ORDER_CODE||CASE WHEN  PRODUCT_TYPE_NAME='住宅' THEN '1'  WHEN  PRODUCT_TYPE_NAME='商办产业' THEN '2'  WHEN  PRODUCT_TYPE_NAME='车位仓储' THEN '3'  WHEN  PRODUCT_TYPE_NAME='配套设施' THEN '4'  END  AS  ORDER_CODE
,(SELECT O.ORG_NAME FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_NAME
,(SELECT O.ID FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ID
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ORDER_HIERARCHY_CODE 
FROM SYS_PROJECT PR  INNER JOIN SYS_PROJECT_STAGE PS ON PR.ID=PROJECT_ID
	

INNER JOIN MDM_BUILD_PRODUCT_TYPE PD ON 1=1 AND PRODUCT_TYPE_LEVEL=1 ) A1
LEFT JOIN    
(

	SELECT  
	PROJECT_ID
	,PROJECT_NAME
	,B.OBJ_TYPE
	,CASE WHEN  B.OBJ_TYPE='楼栋' THEN B.BIZ_PARENT_ID||'_'||B.BUILD_PRODUCT_TYPE_ID ELSE  B.BIZ_ID  END  AS OBJ_ID
	,B.BIZ_PARENT_ID AS obj_PARENT_ID
	,CASE WHEN  B.OBJ_TYPE='楼栋' THEN B.BUILD_PRODUCT_TYPE_NAME ELSE  B.OBJ_NAME  END  AS OBJ_NAME
	,C.OBJ_NAME  AS OBJ_PARENT_NAME
	,SUM(NVL(B.JANUARY_SUPPLY_AMOUNT,0))+SUM(NVL(B.FEBRUARY_SUPPLY_AMOUNT,0))+SUM(NVL(B.MARCH_SUPPLY_AMOUNT,0)) +SUM(NVL(B.APRIL_SUPPLY_AMOUNT,0))+SUM(NVL(B.MAY_SUPPLY_AMOUNT,0)) +SUM(NVL(B.JUNE_SUPPLY_AMOUNT,0))+SUM(NVL(B.JULY_SUPPLY_AMOUNT,0))+SUM(NVL(B.AUGUST_SUPPLY_AMOUNT,0))+SUM(NVL(B.SEPTEMBER_SUPPLY_AMOUNT,0))+SUM(NVL(B.OCTOBER_SUPPLY_AMOUNT,0)) +SUM(NVL(B.NOVEMBER_SUPPLY_AMOUNT,0)) +SUM(NVL(B.DECEMBER_SUPPLY_AMOUNT,0))  AS 本年计划供货金额
	,SUM(NVL(B.JANUARY_SUPPLY_Area,0))+SUM(NVL(B.FEBRUARY_SUPPLY_Area,0))+SUM(NVL(B.MARCH_SUPPLY_Area,0)) +SUM(NVL(B.APRIL_SUPPLY_Area,0))+SUM(NVL(B.MAY_SUPPLY_Area,0)) +SUM(NVL(B.JUNE_SUPPLY_Area,0))+SUM(NVL(B.JULY_SUPPLY_Area,0))+SUM(NVL(B.AUGUST_SUPPLY_Area,0))+SUM(NVL(B.SEPTEMBER_SUPPLY_Area,0))+SUM(NVL(B.OCTOBER_SUPPLY_Area,0)) +SUM(NVL(B.NOVEMBER_SUPPLY_Area,0)) +SUM(NVL(B.DECEMBER_SUPPLY_Area,0))  AS 本年计划供货面积
	,SUM(NVL(B.JANUARY_SUPPLY_Number,0))+SUM(NVL(B.FEBRUARY_SUPPLY_Number,0))+SUM(NVL(B.MARCH_SUPPLY_Number,0)) +SUM(NVL(B.APRIL_SUPPLY_Number,0))+SUM(NVL(B.MAY_SUPPLY_Number,0)) +SUM(NVL(B.JUNE_SUPPLY_Number,0))+SUM(NVL(B.JULY_SUPPLY_Number,0))+SUM(NVL(B.AUGUST_SUPPLY_Number,0))+SUM(NVL(B.SEPTEMBER_SUPPLY_Number,0))+SUM(NVL(B.OCTOBER_SUPPLY_Number,0)) +SUM(NVL(B.NOVEMBER_SUPPLY_Number,0)) +SUM(NVL(B.DECEMBER_SUPPLY_Number,0))  AS 本年计划供货套数
	,SUM(NVL(B.JANUARY_SUPPLY_AMOUNT,0))+SUM(NVL(B.FEBRUARY_SUPPLY_AMOUNT,0))+SUM(NVL(B.MARCH_SUPPLY_AMOUNT,0))  AS 一季度供货金额
	,SUM(NVL(B.JANUARY_SUPPLY_AREA,0))+SUM(NVL(B.FEBRUARY_SUPPLY_AREA,0))+SUM(NVL(B.MARCH_SUPPLY_AREA,0))  AS 一季度供货面积
	,SUM(NVL(B.JANUARY_SUPPLY_NUMBER,0))+SUM(NVL(B.FEBRUARY_SUPPLY_NUMBER,0))+SUM(NVL(B.MARCH_SUPPLY_NUMBER,0))  AS 一季度供货套数
	,SUM(NVL(B.APRIL_SUPPLY_AMOUNT,0))+SUM(NVL(B.MAY_SUPPLY_AMOUNT,0)) +SUM(NVL(B.JUNE_SUPPLY_AMOUNT,0))  AS 二季度供货金额
	,SUM(NVL(B.APRIL_SUPPLY_AREA,0))+SUM(NVL(B.MAY_SUPPLY_AREA,0)) +SUM(NVL(B.JUNE_SUPPLY_AREA,0))  AS 二季度供货面积
	,SUM(NVL(B.APRIL_SUPPLY_NUMBER,0))+SUM(NVL(B.MAY_SUPPLY_NUMBER,0)) +SUM(NVL(B.JUNE_SUPPLY_NUMBER,0))  AS 二季度供货套数
	,SUM(NVL(B.JULY_SUPPLY_AMOUNT,0))+SUM(NVL(B.AUGUST_SUPPLY_AMOUNT,0))+SUM(NVL(B.SEPTEMBER_SUPPLY_AMOUNT,0))  AS 三季度供货金额 
	,SUM(NVL(B.JULY_SUPPLY_AREA,0))+SUM(NVL(B.AUGUST_SUPPLY_AREA,0))+SUM(NVL(B.SEPTEMBER_SUPPLY_AREA,0))  AS 三季度供货面积
	,SUM(NVL(B.JULY_SUPPLY_NUMBER,0))+SUM(NVL(B.AUGUST_SUPPLY_NUMBER,0))+SUM(NVL(B.SEPTEMBER_SUPPLY_NUMBER,0))  AS 三季度供货套数
	,SUM(NVL(B.OCTOBER_SUPPLY_AMOUNT,0)) +SUM(NVL(B.NOVEMBER_SUPPLY_AMOUNT,0)) +SUM(NVL(B.DECEMBER_SUPPLY_AMOUNT,0)) AS 四季度供货金额
	,SUM(NVL(B.OCTOBER_SUPPLY_AREA,0)) +SUM(NVL(B.NOVEMBER_SUPPLY_AREA,0)) +SUM(NVL(B.DECEMBER_SUPPLY_AREA,0)) AS 四季度供货面积
	,SUM(NVL(B.OCTOBER_SUPPLY_NUMBER,0)) +SUM(NVL(B.NOVEMBER_SUPPLY_NUMBER,0)) +SUM(NVL(B.DECEMBER_SUPPLY_NUMBER,0)) AS 四季度供货套数

	,SUM(NVL(B.JANUARY_SELL_AMOUNT,0))+SUM(NVL(B.FEBRUARY_SELL_AMOUNT,0))+SUM(NVL(B.MARCH_SELL_AMOUNT,0)) +SUM(NVL(B.APRIL_SELL_AMOUNT,0))+SUM(NVL(B.MAY_SELL_AMOUNT,0)) +SUM(NVL(B.JUNE_SELL_AMOUNT,0))+SUM(NVL(B.JULY_SELL_AMOUNT,0))+SUM(NVL(B.AUGUST_SELL_AMOUNT,0))+SUM(NVL(B.SEPTEMBER_SELL_AMOUNT,0))+SUM(NVL(B.OCTOBER_SELL_AMOUNT,0)) +SUM(NVL(B.NOVEMBER_SELL_AMOUNT,0)) +SUM(NVL(B.DECEMBER_SELL_AMOUNT,0))  AS 本年计划销售金额
	,SUM(NVL(B.JANUARY_SELL_Area,0))+SUM(NVL(B.FEBRUARY_SELL_Area,0))+SUM(NVL(B.MARCH_SELL_Area,0)) +SUM(NVL(B.APRIL_SELL_Area,0))+SUM(NVL(B.MAY_SELL_Area,0)) +SUM(NVL(B.JUNE_SELL_Area,0))+SUM(NVL(B.JULY_SELL_Area,0))+SUM(NVL(B.AUGUST_SELL_Area,0))+SUM(NVL(B.SEPTEMBER_SELL_Area,0))+SUM(NVL(B.OCTOBER_SELL_Area,0)) +SUM(NVL(B.NOVEMBER_SELL_Area,0)) +SUM(NVL(B.DECEMBER_SELL_Area,0))  AS 本年计划销售面积
	,SUM(NVL(B.JANUARY_SELL_Number,0))+SUM(NVL(B.FEBRUARY_SELL_Number,0))+SUM(NVL(B.MARCH_SELL_Number,0)) +SUM(NVL(B.APRIL_SELL_Number,0))+SUM(NVL(B.MAY_SELL_Number,0)) +SUM(NVL(B.JUNE_SELL_Number,0))+SUM(NVL(B.JULY_SELL_Number,0))+SUM(NVL(B.AUGUST_SELL_Number,0))+SUM(NVL(B.SEPTEMBER_SELL_Number,0))+SUM(NVL(B.OCTOBER_SELL_Number,0)) +SUM(NVL(B.NOVEMBER_SELL_Number,0)) +SUM(NVL(B.DECEMBER_SELL_Number,0))  AS 本年计划销售套数
	,SUM(NVL(B.JANUARY_SELL_AMOUNT,0))+SUM(NVL(B.FEBRUARY_SELL_AMOUNT,0))+SUM(NVL(B.MARCH_SELL_AMOUNT,0))  AS 一季度销售金额
	,SUM(NVL(B.JANUARY_SELL_AREA,0))+SUM(NVL(B.FEBRUARY_SELL_AREA,0))+SUM(NVL(B.MARCH_SELL_AREA,0))  AS 一季度销售面积
	,SUM(NVL(B.JANUARY_SELL_NUMBER,0))+SUM(NVL(B.FEBRUARY_SELL_NUMBER,0))+SUM(NVL(B.MARCH_SELL_NUMBER,0))  AS 一季度销售套数
	,SUM(NVL(B.APRIL_SELL_AMOUNT,0))+SUM(NVL(B.MAY_SELL_AMOUNT,0)) +SUM(NVL(B.JUNE_SELL_AMOUNT,0))  AS 二季度销售金额
	,SUM(NVL(B.APRIL_SELL_AREA,0))+SUM(NVL(B.MAY_SELL_AREA,0)) +SUM(NVL(B.JUNE_SELL_AREA,0))  AS 二季度销售面积
	,SUM(NVL(B.APRIL_SELL_NUMBER,0))+SUM(NVL(B.MAY_SELL_NUMBER,0)) +SUM(NVL(B.JUNE_SELL_NUMBER,0))  AS 二季度销售套数
	,SUM(NVL(B.JULY_SELL_AMOUNT,0))+SUM(NVL(B.AUGUST_SELL_AMOUNT,0))+SUM(NVL(B.SEPTEMBER_SELL_AMOUNT,0))  AS 三季度销售金额 
	,SUM(NVL(B.JULY_SELL_AREA,0))+SUM(NVL(B.AUGUST_SELL_AREA,0))+SUM(NVL(B.SEPTEMBER_SELL_AREA,0))  AS 三季度销售面积
	,SUM(NVL(B.JULY_SELL_NUMBER,0))+SUM(NVL(B.AUGUST_SELL_NUMBER,0))+SUM(NVL(B.SEPTEMBER_SELL_NUMBER,0))  AS 三季度销售套数
	,SUM(NVL(B.OCTOBER_SELL_AMOUNT,0)) +SUM(NVL(B.NOVEMBER_SELL_AMOUNT,0)) +SUM(NVL(B.DECEMBER_SELL_AMOUNT,0)) AS 四季度销售金额
	,SUM(NVL(B.OCTOBER_SELL_AREA,0)) +SUM(NVL(B.NOVEMBER_SELL_AREA,0)) +SUM(NVL(B.DECEMBER_SELL_AREA,0)) AS 四季度销售面积
	,SUM(NVL(B.OCTOBER_SELL_NUMBER,0)) +SUM(NVL(B.NOVEMBER_SELL_NUMBER,0)) +SUM(NVL(B.DECEMBER_SELL_NUMBER,0)) AS 四季度销售套数

	,SUM(NVL(B.JANUARY_SUPPLY_AMOUNT,0)) AS 一月供货金额
	,SUM(NVL(B.JANUARY_SUPPLY_AREA,0)) AS 一月供货面积
	,SUM(NVL(B.JANUARY_SUPPLY_NUMBER,0)) AS 一月供货套数
	,SUM(NVL(B.JANUARY_SELL_AMOUNT,0)) AS 一月签约金额
	,SUM(NVL(B.JANUARY_SELL_AREA,0)) AS 一月签约面积
	,SUM(NVL(B.JANUARY_SELL_NUMBER,0)) AS 一月签约套数
	,SUM(NVL(B.FEBRUARY_SUPPLY_AMOUNT,0)) AS 二月供货金额
	,SUM(NVL(B.FEBRUARY_SUPPLY_AREA,0)) AS 二月供货面积
	,SUM(NVL(B.FEBRUARY_SUPPLY_NUMBER,0)) AS 二月供货套数
	,SUM(NVL(B.FEBRUARY_SELL_AMOUNT,0)) AS 二月签约金额
	,SUM(NVL(B.FEBRUARY_SELL_AREA,0)) AS 二月签约面积
	,SUM(NVL(B.FEBRUARY_SELL_NUMBER,0)) AS 二月签约套数
	,SUM(NVL(B.MARCH_SUPPLY_AMOUNT,0)) AS 三月供货金额
	,SUM(NVL(B.MARCH_SUPPLY_AREA,0)) AS 三月供货面积
	,SUM(NVL(B.MARCH_SUPPLY_NUMBER,0)) AS 三月供货套数
	,SUM(NVL(B.MARCH_SELL_AMOUNT,0)) AS 三月签约金额
	,SUM(NVL(B.MARCH_SELL_AREA,0)) AS 三月签约面积
	,SUM(NVL(B.MARCH_SELL_NUMBER,0)) AS 三月签约套数
	,SUM(NVL(B.APRIL_SUPPLY_AMOUNT,0)) AS 四月供货金额
	,SUM(NVL(B.APRIL_SUPPLY_AREA,0)) AS 四月供货面积
	,SUM(NVL(B.APRIL_SUPPLY_NUMBER,0)) AS 四月供货套数
	,SUM(NVL(B.APRIL_SELL_AMOUNT,0)) AS 四月签约金额
	,SUM(NVL(B.APRIL_SELL_AREA,0)) AS 四月签约面积
	,SUM(NVL(B.APRIL_SELL_NUMBER,0)) AS 四月签约套数
	,SUM(NVL(B.MAY_SUPPLY_AMOUNT,0)) AS 五月供货金额
	,SUM(NVL(B.MAY_SUPPLY_AREA,0)) AS 五月供货面积
	,SUM(NVL(B.MAY_SUPPLY_NUMBER,0)) AS 五月供货套数
	,SUM(NVL(B.MAY_SELL_AMOUNT,0)) AS 五月签约金额
	,SUM(NVL(B.MAY_SELL_AREA,0)) AS 五月签约面积
	,SUM(NVL(B.MAY_SELL_NUMBER,0)) AS 五月签约套数
	,SUM(NVL(B.JUNE_SUPPLY_AMOUNT,0)) AS 六月供货金额
	,SUM(NVL(B.JUNE_SUPPLY_AREA,0)) AS 六月供货面积
	,SUM(NVL(B.JUNE_SUPPLY_NUMBER,0)) AS 六月供货套数
	,SUM(NVL(B.JUNE_SELL_AMOUNT,0)) AS 六月签约金额
	,SUM(NVL(B.JUNE_SELL_AREA,0)) AS 六月签约面积
	,SUM(NVL(B.JUNE_SELL_NUMBER,0)) AS 六月签约套数
	,SUM(NVL(B.JULY_SUPPLY_AMOUNT,0)) AS 七月供货金额
	,SUM(NVL(B.JULY_SUPPLY_AREA,0)) AS 七月供货面积
	,SUM(NVL(B.JULY_SUPPLY_NUMBER,0)) AS 七月供货套数
	,SUM(NVL(B.JULY_SELL_AMOUNT,0)) AS 七月签约金额
	,SUM(NVL(B.JULY_SELL_AREA,0)) AS 七月签约面积
	,SUM(NVL(B.JULY_SELL_NUMBER,0)) AS 七月签约套数
	,SUM(NVL(B.AUGUST_SUPPLY_AMOUNT,0)) AS 八月供货金额
	,SUM(NVL(B.AUGUST_SUPPLY_AREA,0)) AS 八月供货面积
	,SUM(NVL(B.AUGUST_SUPPLY_NUMBER,0)) AS 八月供货套数
	,SUM(NVL(B.AUGUST_SELL_AMOUNT,0)) AS 八月签约金额
	,SUM(NVL(B.AUGUST_SELL_AREA,0)) AS 八月签约面积
	,SUM(NVL(B.AUGUST_SELL_NUMBER,0)) AS 八月签约套数
	,SUM(NVL(B.SEPTEMBER_SUPPLY_AMOUNT,0)) AS 九月供货金额
	,SUM(NVL(B.SEPTEMBER_SUPPLY_AREA,0)) AS 九月供货面积
	,SUM(NVL(B.SEPTEMBER_SUPPLY_NUMBER,0)) AS 九月供货套数
	,SUM(NVL(B.SEPTEMBER_SELL_AMOUNT,0)) AS 九月签约金额
	,SUM(NVL(B.SEPTEMBER_SELL_AREA,0)) AS 九月签约面积
	,SUM(NVL(B.SEPTEMBER_SELL_NUMBER,0)) AS 九月签约套数
	,SUM(NVL(B.OCTOBER_SUPPLY_AMOUNT,0)) AS 十月供货金额
	,SUM(NVL(B.OCTOBER_SUPPLY_AREA,0)) AS 十月供货面积
	,SUM(NVL(B.OCTOBER_SUPPLY_NUMBER,0)) AS 十月供货套数
	,SUM(NVL(B.OCTOBER_SELL_AMOUNT,0)) AS 十月签约金额
	,SUM(NVL(B.OCTOBER_SELL_AREA,0)) AS 十月签约面积
	,SUM(NVL(B.OCTOBER_SELL_NUMBER,0)) AS 十月签约套数
	,SUM(NVL(B.NOVEMBER_SUPPLY_AMOUNT,0)) AS 十一月供货金额
	,SUM(NVL(B.NOVEMBER_SUPPLY_AREA,0)) AS 十一月供货面积
	,SUM(NVL(B.NOVEMBER_SUPPLY_NUMBER,0)) AS 十一月供货套数
	,SUM(NVL(B.NOVEMBER_SELL_AMOUNT,0)) AS 十一月签约金额
	,SUM(NVL(B.NOVEMBER_SELL_AREA,0)) AS 十一月签约面积
	,SUM(NVL(B.NOVEMBER_SELL_NUMBER,0)) AS 十一月签约套数
	,SUM(NVL(B.DECEMBER_SUPPLY_AMOUNT,0)) AS 十二月供货金额
	,SUM(NVL(B.DECEMBER_SUPPLY_AREA,0)) AS 十二月供货面积
	,SUM(NVL(B.DECEMBER_SUPPLY_NUMBER,0)) AS 十二月供货套数
	,SUM(NVL(B.DECEMBER_SELL_AMOUNT,0)) AS 十二月签约金额
	,SUM(NVL(B.DECEMBER_SELL_AREA,0)) AS 十二月签约面积
	,SUM(NVL(B.DECEMBER_SELL_NUMBER,0)) AS 十二月签约套数


FROM
	SWM_SUPPLY_SELL_PLAN A  --ON  A.PROJ_ID=PR.PROJ_ID
    left join (select ID from ( select tmp.*, row_number() over(PARTITION BY project_id order by LPAD (PERIOD_CODE , 6 , '0') desc) as rn from  SWM_SUPPLY_SELL_PLAN  tmp where tmp.APPROVAL_STATUS='已审核' AND IS_DELETED =0 ) where rn = 1) newPlan
    on newPlan.id=A.ID
	LEFT  JOIN SWM_SUPPLY_SELL_PLAN_DTL B ON A.ID=B.SUPPLY_SELL_PLAN_ID
	LEFT JOIN SWM_SUPPLY_SELL_PLAN_DTL C ON C.BIZ_ID=B.BIZ_PARENT_ID  AND  A.ID=C.SUPPLY_SELL_PLAN_ID
	WHERE B.IS_DELETED =0 and  newPlan.id is not null --AND B.SUPPLY_SELL_PLAN_ID='97187e1c-f056-44aa-93fa-7fa9bcb0d813'
	
	AND PERIOD_CODE =(
	SELECT MAX(PERIOD_CODE) FROM SWM_SUPPLY_SELL_PLAN A1 WHERE A.PROJECT_ID=A1.PROJECT_ID AND IS_DELETED=0 AND APPROVAL_STATUS='已审核'
	)
	GROUP BY 
    PROJECT_ID
	,PROJECT_NAME
	,B.BIZ_PARENT_ID 
	,B.OBJ_TYPE
	-- ,B.OBJ_NAME
	-- ,BUILD_PRODUCT_TYPE_NAME
	-- ,ORDER_CODE
	,CASE WHEN  B.OBJ_TYPE='楼栋' THEN 'XXX'  ELSE  B.BIZ_ID  END 
	,CASE WHEN  B.OBJ_TYPE='楼栋' THEN B.BUILD_PRODUCT_TYPE_NAME ELSE  B.OBJ_NAME  END
	,CASE WHEN  B.OBJ_TYPE='楼栋' THEN '99'  ELSE  B.ORDER_CODE  END
	,C.OBJ_NAME,c.BIZ_ID
	,CASE WHEN  B.OBJ_TYPE='楼栋' THEN B.BIZ_PARENT_ID||'_'||B.BUILD_PRODUCT_TYPE_ID ELSE  B.BIZ_ID  END 
	 --ORDER BY  CASE WHEN  B.OBJ_TYPE='楼栋' THEN '99'  ELSE  B.ORDER_CODE END ,C.OBJ_NAME||CASE WHEN  B.OBJ_TYPE='楼栋' THEN B.BUILD_PRODUCT_TYPE_NAME ELSE  B.OBJ_NAME  END 
 ) P1 on A1.OBJ_ID=P1.OBJ_ID --AND P1.PROJECT_ID=A1.PROJ_ID AND P1.OBJ_TYPE=A1.OBJ_TYPE  AND P1.OBJ_NAME=A1.OBJ_NAME  

 
 LEFT JOIN 
 -----------------------------------------------------------------------------------------------------
SWM_SUPPLY_MONITOR_TABLE  P2 ON A1.OBJ_ID=P2.OBJID 
--order by A1.COMPANY_ORDER_HIERARCHY_CODE,A1.ORDER_CODE 


UNION ALL 

select    

a2.ID 
,'公司' "OBJ_TYPE"
,a2.ID AS "OBJ_ID"
,a2.ORG_NAME AS "OBJ_NAME"
,null
,a2.PARENT_ID AS "OBJ_PARENT_ID"
,TO_CHAR(A2.LEVEL_RANK)
,NULL
,A2.ORDER_HIERARCHY_CODE AS  "ORDER_CODE"
,a2.ORG_NAME AS  "COMPANY_NAME"
,a2.ID AS  "COMPANY_ID"
,A2.ORDER_HIERARCHY_CODE  "COMPANY_ORDER_HIERARCHY_CODE"
,a2.ID  AS "id"
, a2.ORG_NAME AS "projConstitute"
,a2.PARENT_ID  AS "parentId"
,a2.ORDER_HIERARCHY_CODE  AS "ORDER_HIERARCHY_CODE"
,a2.ID AS "objId"
,'公司'"objType"
,NULL AS "buildProductTypeName"
,NULL AS "ownBuildProductTypeId"
,NULL AS "buildProductTypeId"
,a1."thisYearSupplyAmount"
,a1."thisYearSupplyNumber"
,a1."thisYearSupplyArea"
,a1."firstSeasonSupplyAmount"
,a1."firstSeasonSupplyNumber"
,a1."firstSeasonSupplyArea"
,a1."januarySupplyAmount"
,a1."januarySupplyNumberx"
,a1."januarySupplyNumber"
,a1."februarySupplyAmount"
,a1."februarySupplyNumber"
,a1."februarySupplyArea"
,a1."marchSupplyAmount"
,a1."marchSupplyNumber"
,a1."marchSupplyArea"
,a1."secondSeasonSupplyAmount"
,a1."secondSeasonSupplyNumber"
,a1."secondSeasonSupplyArea"
,a1."aprilSupplyAmount"
,a1."aprilSupplyNumber"
,a1."aprilSupplyArea"
,a1."maySupplyAmount"
,a1."maySupplyNumber"
,a1."maySupplyArea"
,a1."juneSupplyAmount"
,a1."juneSupplyNumber"
,a1."juneSupplyArea"
,a1."thirdSeasonSupplyAmount"
,a1."thirdSeasonSupplyNumber"
,a1."thirdSeasonSupplyArea"
,a1."julySupplyAmount"
,a1."julySupplyNumber"
,a1."julySupplyArea"
,a1."augustSupplyAmount"
,a1."augustSupplyNumber"
,a1."augustSupplyArea"
,a1."septemberSupplyAmount"
,a1."septemberSupplyNumber"
,a1."septemberSupplyArea"
,a1."fourthSeasonSupplyAmount"
,a1."fourthSeasonSupplyNumber"
,a1."fourthSeasonSupplyArea"
,a1."octoberSupplyAmount"
,a1."octoberSupplyNumber"
,a1."octoberSupplyArea"
,a1."novemberSupplyAmount"
,a1."novemberSupplyNumber"
,a1."novemberSupplyArea"
,a1."decemberSupplyAmount"
,a1."decemberSupplyNumber"
,a1."decemberSupplyArea"


,"thisYearSellPlannedAmount"--金额（年计划销售）
,"thisYearSellPlannedNumber"--套数（年计划销售）
,"thisYearSellPlannedArea"--面积（年计划销售）
,"firstSeonSellPlannedAmount"--金额（1季度计划销售）
,"firstSeonSellPlannedNumber"--套数（1季度计划销售）
,"firstSeonSellPlannedArea"--面积（1季度计划销售）
,"secondSeonSellPlannedAmount"--金额（2季度计划销售）
,"secondSeonSellPlannedNumber"--套数（2季度计划销售）
,"secondSeonSellPlannedArea"--面积（2季度计划销售）
,"thirdSeonSellPlannedAmount"--金额（3季度计划销售）
,"thirdSeonSellPlannedNumber"--套数（3季度计划销售）
,"thirdSeonSellPlannedArea"--面积（3季度计划销售）
,"fourthSeonSellPlannedAmount"--金额（4季度计划销售）
,"fourthSeonSellPlannedNumber"--套数（4季度计划销售）
,"fourthSeonSellPlannedArea"--面积（4季度计划销售）
,"januarySellPlannedAmount"--金额（1月计划销售）
,"januarySellPlannedNumber"--套数（1月计划销售）
,"januarySellPlannedArea"--面积（1月计划销售）
,"februarySellPlannedAmount"--金额（2月计划销售）
,"februarySellPlannedNumber"--套数（2月计划销售）
,"februarySellPlannedArea"--面积（2月计划销售）
,"marchSellPlannedAmount"--金额（3月计划销售）
,"marchSellPlannedNumber"--套数（3月计划销售）
,"marchSellPlannedArea"--面积（3月计划销售）
,"aprilSellPlannedAmount"--金额（4月计划销售）
,"aprilSellPlannedNumber"--套数（4月计划销售）
,"aprilSellPlannedArea"--面积（4月计划销售）
,"maySellPlannedAmount"--金额（5月计划销售）
,"maySellPlannedNumber"--套数（5月计划销售）
,"maySellPlannedArea"--面积（5月计划销售）
,"juneSellPlannedAmount"--金额（6月计划销售）
,"juneSellPlannedNumber"--套数（6月计划销售）
,"juneSellPlannedArea"--面积（6月计划销售）
,"julySellPlannedAmount"--金额（7月计划销售）
,"julySellPlannedNumber"--套数（7月计划销售）
,"julySellPlannedArea"--面积（7月计划销售）
,"augustSellPlannedAmount"--金额（8月计划销售）
,"augustSellPlannedNumber"--套数（8月计划销售）
,"augustSellPlannedArea"--面积（8月计划销售）
,"septemberSellPlannedAmount"--金额（10月计划销售）
,"septemberSellPlannedNumber"--套数（10月计划销售）
,"septemberSellPlannedArea"--面积（10月计划销售）
,"octoberSellPlannedAmount"--金额（10月计划销售）
,"octoberSellPlannedNumber"--套数（10月计划销售）
,"octoberSellPlannedArea"--面积（10月计划销售）
,"novemberSellPlannedAmount"--金额（11月计划销售）
,"novemberSellPlannedNumber"--套数（11月计划销售）
,"novemberSellPlannedArea"--面积（11月计划销售）
,"decemberSellPlannedAmount"--金额（12月计划销售）
,"decemberSellPlannedNumber"--套数（12月计划销售）
,"decemberSellPlannedArea"--面积（12月计划销售）



,TO_CHAR(a2."LEVEL_RANK")
,a1."poTotalSaleCount"
,a1."poTotalSaleArea"
,a1."poTotalSaleAmount"
,a1."rpTotalArea"
,a1."rpTotalAmount"
,a1."rpTotalCount"
,a1."poSaleArea"
,a1."poSaleAmount"
,a1."poSaleCount"
,a1."rpSurplusArea"
,a1."rpSurplusAmount"
,a1."rpSurplusCount"
,a1."poSurplusSaleAmount"
,a1."poSurplusSaleArea"
,a1."poSurplusSaleCount"
,a1."thisYearActualSupplyArea"
,a1."thisYearActualSupplyNumber"
,a1."thisYearActualSupplyAmount"
,a1."firstSeasonActualSupplyArea"
,a1."firstSeasonActualSupplyNumber"
,a1."firstSeasonActualSupplyAmount"
,a1."secondSeasonActualSupplyArea"
,a1."secondSeasonActualSupplyNumber"
,a1."secondSeasonActualSupplyAmount"
,a1."thirdSeasonActualSupplyArea"
,a1."thirdSeasonActualSupplyNumber"
,a1."thirdSeasonActualSupplyAmount"
,a1."fourthSeasonActualSupplyArea"
,a1."fourthSeasonActualSupplyNumber"
,a1."fourthSeasonActualSupplyAmount"
,a1."januaryActualSupplyArea"
,a1."januaryActualSupplyNumber"
,a1."januaryActualSupplyAmount"
,a1."februaryActualSupplyArea"
,a1."februaryActualSupplyNumber"
,a1."februaryActualSupplyAmount"
,a1."marchActualSupplyArea"
,a1."marchActualSupplyNumber"
,a1."marchActualSupplyAmount"
,a1."aprilActualSupplyArea"
,a1."aprilActualSupplyNumber"
,a1."aprilActualSupplyAmount"
,a1."mayActualSupplyArea"
,a1."mayActualSupplyNumber"
,a1."mayActualSupplyAmount"
,a1."juneActualSupplyArea"
,a1."juneActualSupplyNumber"
,a1."juneActualSupplyAmount"
,a1."julyActualSupplyArea"
,a1."julyActualSupplyNumber"
,a1."julyActualSupplyAmount"
,a1."augustActualSupplyArea"
,a1."augustActualSupplyNumber"
,a1."augustActualSupplyAmount"
,a1."septemberActualSupplyArea"
,a1."septemberActualSupplyNumber"
,a1."septemberActualSupplyAmount"
,a1."octoberActualSupplyArea"
,a1."octoberActualSupplyNumber"
,a1."octoberActualSupplyAmount"
,a1."novemberActualSupplyArea"
,a1."novemberActualSupplyNumber"
,a1."novemberActualSupplyAmount"
,a1."decemberActualSupplyArea"
,a1."decemberActualSupplyNumber"
,a1."decemberActualSupplyAmount"
,a1."thisYearSellArea"
,a1."thisYearSellNumber"
,a1."thisYearSellAmount"
,a1."firstSellArea"
,a1."firstSellNumber"
,a1."firstSellAmount"
,a1."secondSeasonSellArea"
,a1."secondSeasonSellNumber"
,a1."secondSeasonSellAmount"
,a1."thirdSeasonSellArea"
,a1."thirdSeasonSellNumber"
,a1."thirdSeasonSellAmount"
,a1."fourthSeasonSellArea"
,a1."fourthSeasonSellNumber"
,a1."fourthSeasonSellAmount"
,a1."januarySellArea"
,a1."januarySellNumber"
,a1."januarySellAmount"
,a1."februarySellArea"
,a1."februarySellNumber"
,a1."februarySellAmount"
,a1."marchSellArea"
,a1."marchSellNumber"
,a1."marchSellAmount"
,a1."aprilSellArea"
,a1."aprilSellNumber"
,a1."aprilSellAmount"
,a1."maySellArea"
,a1."maySellNumber"
,a1."maySellAmount"
,a1."juneSellArea"
,a1."juneSellNumber"
,a1."juneSellAmount"
,a1."julySellArea"
,a1."julySellNumber"
,a1."julySellAmount"
,a1."augustSellArea"
,a1."augustSellNumber"
,a1."augustSellAmount"
,a1."septemberSellArea"
,a1."septemberSellNumber"
,a1."septemberSellAmount"
,a1."octoberSellArea"
,a1."octoberSellNumber"
,a1."octoberSellAmount"
,a1."novemberSellArea"
,a1."novemberSellNumber"
,a1."novemberSellAmount"
,a1."decemberSellArea"
,a1."decemberSellNumber"
,a1."decemberSellAmount"

from  LIST_SWM_SUPPLY_MONITOR 
a1 INNER JOIN　SYS_BUSINESS_UNIT a2 on a1.OBJ_PARENT_ID=a2.id 

		where is_company=1 
		--and a2.PARENT_ID=''||unitid||''


)

SELECT 




"PROJ_ID"
,"OBJ_TYPE"
,"OBJ_ID"
,"OBJ_NAME"
,"OBJ_PARENT_ID"
,"LEVEL"
,"LEVEL_ORDER"
,"ORDER_CODE"
,"COMPANY_NAME"
,"COMPANY_ID"
,"COMPANY_ORDER_HIERARCHY_CODE"
,"id"
,"projConstitute"
,"parentId"
,"ORDER_HIERARCHY_CODE"
,"objId"
,"objType"
,"buildProductTypeName"
,"ownBuildProductTypeId"
,"buildProductTypeId"
,SUM(NVL("thisYearSupplyAmount",0)) AS "thisYearSupplyAmount"
,SUM(NVL("thisYearSupplyNumber",0)) AS "thisYearSupplyNumber"
,SUM(NVL("thisYearSupplyArea",0)) AS "thisYearSupplyArea"
,SUM(NVL("firstSeasonSupplyAmount",0)) AS "firstSeasonSupplyAmount"
,SUM(NVL("firstSeasonSupplyNumber",0)) AS "firstSeasonSupplyNumber"
,SUM(NVL("firstSeasonSupplyArea",0)) AS "firstSeasonSupplyArea"
,SUM(NVL("januarySupplyAmount",0)) AS "januarySupplyAmount"
,SUM(NVL("januarySupplyNumberx",0)) AS "januarySupplyNumberx"
,SUM(NVL("januarySupplyNumber",0)) AS "januarySupplyNumber"
,SUM(NVL("februarySupplyAmount",0)) AS "februarySupplyAmount"
,SUM(NVL("februarySupplyNumber",0)) AS "februarySupplyNumber"
,SUM(NVL("februarySupplyArea",0)) AS "februarySupplyArea"
,SUM(NVL("marchSupplyAmount",0)) AS "marchSupplyAmount"
,SUM(NVL("marchSupplyNumber",0)) AS "marchSupplyNumber"
,SUM(NVL("marchSupplyArea",0)) AS "marchSupplyArea"
,SUM(NVL("secondSeasonSupplyAmount",0)) AS "secondSeasonSupplyAmount"
,SUM(NVL("secondSeasonSupplyNumber",0)) AS "secondSeasonSupplyNumber"
,SUM(NVL("secondSeasonSupplyArea",0)) AS "secondSeasonSupplyArea"
,SUM(NVL("aprilSupplyAmount",0)) AS "aprilSupplyAmount"
,SUM(NVL("aprilSupplyNumber",0)) AS "aprilSupplyNumber"
,SUM(NVL("aprilSupplyArea",0)) AS "aprilSupplyArea"
,SUM(NVL("maySupplyAmount",0)) AS "maySupplyAmount"
,SUM(NVL("maySupplyNumber",0)) AS "maySupplyNumber"
,SUM(NVL("maySupplyArea",0)) AS "maySupplyArea"
,SUM(NVL("juneSupplyAmount",0)) AS "juneSupplyAmount"
,SUM(NVL("juneSupplyNumber",0)) AS "juneSupplyNumber"
,SUM(NVL("juneSupplyArea",0)) AS "juneSupplyArea"
,SUM(NVL("thirdSeasonSupplyAmount",0)) AS "thirdSeasonSupplyAmount"
,SUM(NVL("thirdSeasonSupplyNumber",0)) AS "thirdSeasonSupplyNumber"
,SUM(NVL("thirdSeasonSupplyArea",0)) AS "thirdSeasonSupplyArea"
,SUM(NVL("julySupplyAmount",0)) AS "julySupplyAmount"
,SUM(NVL("julySupplyNumber",0)) AS "julySupplyNumber"
,SUM(NVL("julySupplyArea",0)) AS "julySupplyArea"
,SUM(NVL("augustSupplyAmount",0)) AS "augustSupplyAmount"
,SUM(NVL("augustSupplyNumber",0)) AS "augustSupplyNumber"
,SUM(NVL("augustSupplyArea",0)) AS "augustSupplyArea"
,SUM(NVL("septemberSupplyAmount",0)) AS "septemberSupplyAmount"
,SUM(NVL("septemberSupplyNumber",0)) AS "septemberSupplyNumber"
,SUM(NVL("septemberSupplyArea",0)) AS "septemberSupplyArea"
,SUM(NVL("fourthSeasonSupplyAmount",0)) AS "fourthSeasonSupplyAmount"
,SUM(NVL("fourthSeasonSupplyNumber",0)) AS "fourthSeasonSupplyNumber"
,SUM(NVL("fourthSeasonSupplyArea",0)) AS "fourthSeasonSupplyArea"
,SUM(NVL("octoberSupplyAmount",0)) AS "octoberSupplyAmount"
,SUM(NVL("octoberSupplyNumber",0)) AS "octoberSupplyNumber"
,SUM(NVL("octoberSupplyArea",0)) AS "octoberSupplyArea"
,SUM(NVL("novemberSupplyAmount",0)) AS "novemberSupplyAmount"
,SUM(NVL("novemberSupplyNumber",0)) AS "novemberSupplyNumber"
,SUM(NVL("novemberSupplyArea",0)) AS "novemberSupplyArea"
,SUM(NVL("decemberSupplyAmount",0)) AS "decemberSupplyAmount"
,SUM(NVL("decemberSupplyNumber",0)) AS "decemberSupplyNumber"
,SUM(NVL("decemberSupplyArea",0)) AS "decemberSupplyArea"
,SUM(NVL("poTotalSaleCount",0)) AS "poTotalSaleCount"
,SUM(NVL("poTotalSaleArea",0)) AS "poTotalSaleArea"
,SUM(NVL("poTotalSaleAmount",0)) AS "poTotalSaleAmount"
,SUM(NVL("rpTotalArea",0)) AS "rpTotalArea"
,SUM(NVL("rpTotalAmount",0)) AS "rpTotalAmount"
,SUM(NVL("rpTotalCount",0)) AS "rpTotalCount"
,SUM(NVL("poSaleArea",0)) AS "poSaleArea"
,SUM(NVL("poSaleAmount",0)) AS "poSaleAmount"
,SUM(NVL("poSaleCount",0)) AS "poSaleCount"
,SUM(NVL("rpSurplusArea",0)) AS "rpSurplusArea"
,SUM(NVL("rpSurplusAmount",0)) AS "rpSurplusAmount"
,SUM(NVL("rpSurplusCount",0)) AS "rpSurplusCount"
,SUM(NVL("poSurplusSaleAmount",0)) AS "poSurplusSaleAmount"
,SUM(NVL("poSurplusSaleArea",0)) AS "poSurplusSaleArea"
,SUM(NVL("poSurplusSaleCount",0)) AS "poSurplusSaleCount"
,SUM(NVL("thisYearActualSupplyArea",0)) AS "thisYearActualSupplyArea"
,SUM(NVL("thisYearActualSupplyNumber",0)) AS "thisYearActualSupplyNumber"
,SUM(NVL("thisYearActualSupplyAmount",0)) AS "thisYearActualSupplyAmount"
,SUM(NVL("firstSeasonActualSupplyArea",0)) AS "firstSeasonActualSupplyArea"
,SUM(NVL("firstSeasonActualSupplyNumber",0)) AS "firstSeasonActualSupplyNumber"
,SUM(NVL("firstSeasonActualSupplyAmount",0)) AS "firstSeasonActualSupplyAmount"
,SUM(NVL("secondSeasonActualSupplyArea",0)) AS "secondSeasonActualSupplyArea"
,SUM(NVL("secondSeasonActualSupplyNumber",0)) AS "secondSeasonActualSupplyNumber"
,SUM(NVL("secondSeasonActualSupplyAmount",0)) AS "secondSeasonActualSupplyAmount"
,SUM(NVL("thirdSeasonActualSupplyArea",0)) AS "thirdSeasonActualSupplyArea"
,SUM(NVL("thirdSeasonActualSupplyNumber",0)) AS "thirdSeasonActualSupplyNumber"
,SUM(NVL("thirdSeasonActualSupplyAmount",0)) AS "thirdSeasonActualSupplyAmount"
,SUM(NVL("fourthSeasonActualSupplyArea",0)) AS "fourthSeasonActualSupplyArea"
,SUM(NVL("fourthSeasonActualSupplyNumber",0)) AS "fourthSeasonActualSupplyNumber"
,SUM(NVL("fourthSeasonActualSupplyAmount",0)) AS "fourthSeasonActualSupplyAmount"
,SUM(NVL("januaryActualSupplyArea",0)) AS "januaryActualSupplyArea"
,SUM(NVL("januaryActualSupplyNumber",0)) AS "januaryActualSupplyNumber"
,SUM(NVL("januaryActualSupplyAmount",0)) AS "januaryActualSupplyAmount"
,SUM(NVL("februaryActualSupplyArea",0)) AS "februaryActualSupplyArea"
,SUM(NVL("februaryActualSupplyNumber",0)) AS "februaryActualSupplyNumber"
,SUM(NVL("februaryActualSupplyAmount",0)) AS "februaryActualSupplyAmount"
,SUM(NVL("marchActualSupplyArea",0)) AS "marchActualSupplyArea"
,SUM(NVL("marchActualSupplyNumber",0)) AS "marchActualSupplyNumber"
,SUM(NVL("marchActualSupplyAmount",0)) AS "marchActualSupplyAmount"
,SUM(NVL("aprilActualSupplyArea",0)) AS "aprilActualSupplyArea"
,SUM(NVL("aprilActualSupplyNumber",0)) AS "aprilActualSupplyNumber"
,SUM(NVL("aprilActualSupplyAmount",0)) AS "aprilActualSupplyAmount"
,SUM(NVL("mayActualSupplyArea",0)) AS "mayActualSupplyArea"
,SUM(NVL("mayActualSupplyNumber",0)) AS "mayActualSupplyNumber"
,SUM(NVL("mayActualSupplyAmount",0)) AS "mayActualSupplyAmount"
,SUM(NVL("juneActualSupplyArea",0)) AS "juneActualSupplyArea"
,SUM(NVL("juneActualSupplyNumber",0)) AS "juneActualSupplyNumber"
,SUM(NVL("juneActualSupplyAmount",0)) AS "juneActualSupplyAmount"
,SUM(NVL("julyActualSupplyArea",0)) AS "julyActualSupplyArea"
,SUM(NVL("julyActualSupplyNumber",0)) AS "julyActualSupplyNumber"
,SUM(NVL("julyActualSupplyAmount",0)) AS "julyActualSupplyAmount"
,SUM(NVL("augustActualSupplyArea",0)) AS "augustActualSupplyArea"
,SUM(NVL("augustActualSupplyNumber",0)) AS "augustActualSupplyNumber"
,SUM(NVL("augustActualSupplyAmount",0)) AS "augustActualSupplyAmount"
,SUM(NVL("septemberActualSupplyArea",0)) AS "septemberActualSupplyArea"
,SUM(NVL("septemberActualSupplyNumber",0)) AS "septemberActualSupplyNumber"
,SUM(NVL("septemberActualSupplyAmount",0)) AS "septemberActualSupplyAmount"
,SUM(NVL("octoberActualSupplyArea",0)) AS "octoberActualSupplyArea"
,SUM(NVL("octoberActualSupplyNumber",0)) AS "octoberActualSupplyNumber"
,SUM(NVL("octoberActualSupplyAmount",0)) AS "octoberActualSupplyAmount"
,SUM(NVL("novemberActualSupplyArea",0)) AS "novemberActualSupplyArea"
,SUM(NVL("novemberActualSupplyNumber",0)) AS "novemberActualSupplyNumber"
,SUM(NVL("novemberActualSupplyAmount",0)) AS "novemberActualSupplyAmount"
,SUM(NVL("decemberActualSupplyArea",0)) AS "decemberActualSupplyArea"
,SUM(NVL("decemberActualSupplyNumber",0)) AS "decemberActualSupplyNumber"
,SUM(NVL("decemberActualSupplyAmount",0)) AS "decemberActualSupplyAmount"
,SUM(NVL("thisYearSellArea",0)) AS "thisYearSellArea"
,SUM(NVL("thisYearSellNumber",0)) AS "thisYearSellNumber"
,SUM(NVL("thisYearSellAmount",0)) AS "thisYearSellAmount"
,SUM(NVL("firstSellArea",0)) AS "firstSellArea"
,SUM(NVL("firstSellNumber",0)) AS "firstSellNumber"
,SUM(NVL("firstSellAmount",0)) AS "firstSellAmount"
,SUM(NVL("secondSeasonSellArea",0)) AS "secondSeasonSellArea"
,SUM(NVL("secondSeasonSellNumber",0)) AS "secondSeasonSellNumber"
,SUM(NVL("secondSeasonSellAmount",0)) AS "secondSeasonSellAmount"
,SUM(NVL("thirdSeasonSellArea",0)) AS "thirdSeasonSellArea"
,SUM(NVL("thirdSeasonSellNumber",0)) AS "thirdSeasonSellNumber"
,SUM(NVL("thirdSeasonSellAmount",0)) AS "thirdSeasonSellAmount"
,SUM(NVL("fourthSeasonSellArea",0)) AS "fourthSeasonSellArea"
,SUM(NVL("fourthSeasonSellNumber",0)) AS "fourthSeasonSellNumber"
,SUM(NVL("fourthSeasonSellAmount",0)) AS "fourthSeasonSellAmount"
,SUM(NVL("januarySellArea",0)) AS "januarySellArea"
,SUM(NVL("januarySellNumber",0)) AS "januarySellNumber"
,SUM(NVL("januarySellAmount",0)) AS "januarySellAmount"
,SUM(NVL("februarySellArea",0)) AS "februarySellArea"
,SUM(NVL("februarySellNumber",0)) AS "februarySellNumber"
,SUM(NVL("februarySellAmount",0)) AS "februarySellAmount"
,SUM(NVL("marchSellArea",0)) AS "marchSellArea"
,SUM(NVL("marchSellNumber",0)) AS "marchSellNumber"
,SUM(NVL("marchSellAmount",0)) AS "marchSellAmount"
,SUM(NVL("aprilSellArea",0)) AS "aprilSellArea"
,SUM(NVL("aprilSellNumber",0)) AS "aprilSellNumber"
,SUM(NVL("aprilSellAmount",0)) AS "aprilSellAmount"
,SUM(NVL("maySellArea",0)) AS "maySellArea"
,SUM(NVL("maySellNumber",0)) AS "maySellNumber"
,SUM(NVL("maySellAmount",0)) AS "maySellAmount"
,SUM(NVL("juneSellArea",0)) AS "juneSellArea"
,SUM(NVL("juneSellNumber",0)) AS "juneSellNumber"
,SUM(NVL("juneSellAmount",0)) AS "juneSellAmount"
,SUM(NVL("julySellArea",0)) AS "julySellArea"
,SUM(NVL("julySellNumber",0)) AS "julySellNumber"
,SUM(NVL("julySellAmount",0)) AS "julySellAmount"
,SUM(NVL("augustSellArea",0)) AS "augustSellArea"
,SUM(NVL("augustSellNumber",0)) AS "augustSellNumber"
,SUM(NVL("augustSellAmount",0)) AS "augustSellAmount"
,SUM(NVL("septemberSellArea",0)) AS "septemberSellArea"
,SUM(NVL("septemberSellNumber",0)) AS "septemberSellNumber"
,SUM(NVL("septemberSellAmount",0)) AS "septemberSellAmount"
,SUM(NVL("octoberSellArea",0)) AS "octoberSellArea"
,SUM(NVL("octoberSellNumber",0)) AS "octoberSellNumber"
,SUM(NVL("octoberSellAmount",0)) AS "octoberSellAmount"
,SUM(NVL("novemberSellArea",0)) AS "novemberSellArea"
,SUM(NVL("novemberSellNumber",0)) AS "novemberSellNumber"
,SUM(NVL("novemberSellAmount",0)) AS "novemberSellAmount"
,SUM(NVL("decemberSellArea",0)) AS "decemberSellArea"
,SUM(NVL("decemberSellNumber",0)) AS "decemberSellNumber"
,SUM(NVL("decemberSellAmount",0)) AS "decemberSellAmount"
,SUM(NVL("thisYearSellPlannedAmount",0))  AS "thisYearSellPlannedAmount"--金额（年计划销售）
,SUM(NVL("thisYearSellPlannedNumber",0))  AS "thisYearSellPlannedNumber"--套数（年计划销售）
,SUM(NVL("thisYearSellPlannedArea",0))  AS "thisYearSellPlannedArea"--面积（年计划销售）
,SUM(NVL("firstSeonSellPlannedAmount",0))  AS "firstSeonSellPlannedAmount"--金额（1季度计划销售）
,SUM(NVL("firstSeonSellPlannedNumber",0))  AS "firstSeonSellPlannedNumber"--套数（1季度计划销售）
,SUM(NVL("firstSeonSellPlannedArea",0))  AS "firstSeonSellPlannedArea"--面积（1季度计划销售）
,SUM(NVL("secondSeonSellPlannedAmount",0))  AS "secondSeonSellPlannedAmount"--金额（2季度计划销售）
,SUM(NVL("secondSeonSellPlannedNumber",0))  AS "secondSeonSellPlannedNumber"--套数（2季度计划销售）
,SUM(NVL("secondSeonSellPlannedArea",0))  AS "secondSeonSellPlannedArea"--面积（2季度计划销售）
,SUM(NVL("thirdSeonSellPlannedAmount",0))  AS "thirdSeonSellPlannedAmount"--金额（3季度计划销售）
,SUM(NVL("thirdSeonSellPlannedNumber",0))  AS "thirdSeonSellPlannedNumber"--套数（3季度计划销售）
,SUM(NVL("thirdSeonSellPlannedArea",0))  AS "thirdSeonSellPlannedArea"--面积（3季度计划销售）
,SUM(NVL("fourthSeonSellPlannedAmount",0))  AS "fourthSeonSellPlannedAmount"--金额（4季度计划销售）
,SUM(NVL("fourthSeonSellPlannedNumber",0))  AS "fourthSeonSellPlannedNumber"--套数（4季度计划销售）
,SUM(NVL("fourthSeonSellPlannedArea",0))  AS "fourthSeonSellPlannedArea"--面积（4季度计划销售）
,SUM(NVL("januarySellPlannedAmount",0))  AS "januarySellPlannedAmount"--金额（1月计划销售）
,SUM(NVL("januarySellPlannedNumber",0))  AS "januarySellPlannedNumber"--套数（1月计划销售）
,SUM(NVL("januarySellPlannedArea",0))  AS "januarySellPlannedArea"--面积（1月计划销售）
,SUM(NVL("februarySellPlannedAmount",0))  AS "februarySellPlannedAmount"--金额（2月计划销售）
,SUM(NVL("februarySellPlannedNumber",0))  AS "februarySellPlannedNumber"--套数（2月计划销售）
,SUM(NVL("februarySellPlannedArea",0))  AS "februarySellPlannedArea"--面积（2月计划销售）
,SUM(NVL("marchSellPlannedAmount",0))  AS "marchSellPlannedAmount"--金额（3月计划销售）
,SUM(NVL("marchSellPlannedNumber",0))  AS "marchSellPlannedNumber"--套数（3月计划销售）
,SUM(NVL("marchSellPlannedArea",0))  AS "marchSellPlannedArea"--面积（3月计划销售）
,SUM(NVL("aprilSellPlannedAmount",0))  AS "aprilSellPlannedAmount"--金额（4月计划销售）
,SUM(NVL("aprilSellPlannedNumber",0))  AS "aprilSellPlannedNumber"--套数（4月计划销售）
,SUM(NVL("aprilSellPlannedArea",0))  AS "aprilSellPlannedArea"--面积（4月计划销售）
,SUM(NVL("maySellPlannedAmount",0))  AS "maySellPlannedAmount"--金额（5月计划销售）
,SUM(NVL("maySellPlannedNumber",0))  AS "maySellPlannedNumber"--套数（5月计划销售）
,SUM(NVL("maySellPlannedArea",0))  AS "maySellPlannedArea"--面积（5月计划销售）
,SUM(NVL("juneSellPlannedAmount",0))  AS "juneSellPlannedAmount"--金额（6月计划销售）
,SUM(NVL("juneSellPlannedNumber",0))  AS "juneSellPlannedNumber"--套数（6月计划销售）
,SUM(NVL("juneSellPlannedArea",0))  AS "juneSellPlannedArea"--面积（6月计划销售）
,SUM(NVL("julySellPlannedAmount",0))  AS "julySellPlannedAmount"--金额（7月计划销售）
,SUM(NVL("julySellPlannedNumber",0))  AS "julySellPlannedNumber"--套数（7月计划销售）
,SUM(NVL("julySellPlannedArea",0))  AS "julySellPlannedArea"--面积（7月计划销售）
,SUM(NVL("augustSellPlannedAmount",0))  AS "augustSellPlannedAmount"--金额（8月计划销售）
,SUM(NVL("augustSellPlannedNumber",0))  AS "augustSellPlannedNumber"--套数（8月计划销售）
,SUM(NVL("augustSellPlannedArea",0))  AS "augustSellPlannedArea"--面积（8月计划销售）
,SUM(NVL("septemberSellPlannedAmount",0))  AS "septemberSellPlannedAmount"--金额（10月计划销售）
,SUM(NVL("septemberSellPlannedNumber",0))  AS "septemberSellPlannedNumber"--套数（10月计划销售）
,SUM(NVL("septemberSellPlannedArea",0))  AS "septemberSellPlannedArea"--面积（10月计划销售）
,SUM(NVL("octoberSellPlannedAmount",0))  AS "octoberSellPlannedAmount"--金额（10月计划销售）

,SUM(NVL("octoberSellPlannedNumber",0))  AS "octoberSellPlannedNumber"--套数（10月计划销售）
,SUM(NVL("octoberSellPlannedArea",0))  AS "octoberSellPlannedArea"--面积（10月计划销售）
,SUM(NVL("novemberSellPlannedAmount",0))  AS "novemberSellPlannedAmount"--金额（11月计划销售）
,SUM(NVL("novemberSellPlannedNumber",0))  AS "novemberSellPlannedNumber"--套数（11月计划销售）
,SUM(NVL("novemberSellPlannedArea",0))  AS "novemberSellPlannedArea"--面积（11月计划销售）
,SUM(NVL("decemberSellPlannedAmount",0))  AS "decemberSellPlannedAmount"--金额（12月计划销售）
,SUM(NVL("decemberSellPlannedNumber",0))  AS "decemberSellPlannedNumber"--套数（12月计划销售）
,SUM(NVL("decemberSellPlannedArea",0))  AS "decemberSellPlannedArea"--面积（12月计划销售）


 FROM  LIST_SWM_SUPPLY_MONITOR LIST
		 --WHERE "thisYearSupplyAmount">0
		
		 


 GROUP BY "PROJ_ID"
,"OBJ_TYPE"
,"OBJ_ID"
,"OBJ_NAME"
,"OBJ_PARENT_ID"
,"LEVEL"
,"LEVEL_ORDER"
,"ORDER_CODE"
,"COMPANY_NAME"
,"COMPANY_ID"
,"COMPANY_ORDER_HIERARCHY_CODE"
,"id"
,"projConstitute"
,"parentId"
,"ORDER_HIERARCHY_CODE"
,"objId"
,"objType"
,"buildProductTypeName"
,"ownBuildProductTypeId"
,"buildProductTypeId"
 ORDER BY "COMPANY_ORDER_HIERARCHY_CODE","ORDER_CODE"
 ;
 ------------------------------------集团版目标监控------------------------------
DELETE SWM_BLOC_SUPPLY_MONITOR_LIST; 
 
INSERT INTO  SWM_BLOC_SUPPLY_MONITOR_LIST
WITH  LIST_SWM_SUPPLY_MONITOR 
(

"PROJ_ID"
,"OBJ_TYPE"
,"OBJ_ID"
,"OBJ_NAME"
,"PD_NAME"
,"OBJ_PARENT_ID"
,"LEVEL"
,"LEVEL_ORDER"
,"ORDER_CODE"
,"COMPANY_NAME"
,"COMPANY_ID"
,"COMPANY_ORDER_HIERARCHY_CODE"
,"id"
,"projConstitute"
,"parentId"
,"ORDER_HIERARCHY_CODE"
,"objId"
,"objType"
,"buildProductTypeName"
,"ownBuildProductTypeId"
,"buildProductTypeId"
,"thisYearSupplyAmount"
,"thisYearSupplyNumber"
,"thisYearSupplyArea"
,"firstSeasonSupplyAmount"
,"firstSeasonSupplyNumber"
,"firstSeasonSupplyArea"
,"januarySupplyAmount"
,"januarySupplyNumberx"
,"januarySupplyNumber"
,"februarySupplyAmount"
,"februarySupplyNumber"
,"februarySupplyArea"
,"marchSupplyAmount"
,"marchSupplyNumber"
,"marchSupplyArea"
,"secondSeasonSupplyAmount"
,"secondSeasonSupplyNumber"
,"secondSeasonSupplyArea"
,"aprilSupplyAmount"
,"aprilSupplyNumber"
,"aprilSupplyArea"
,"maySupplyAmount"
,"maySupplyNumber"
,"maySupplyArea"
,"juneSupplyAmount"
,"juneSupplyNumber"
,"juneSupplyArea"
,"thirdSeasonSupplyAmount"
,"thirdSeasonSupplyNumber"
,"thirdSeasonSupplyArea"
,"julySupplyAmount"
,"julySupplyNumber"
,"julySupplyArea"
,"augustSupplyAmount"
,"augustSupplyNumber"
,"augustSupplyArea"
,"septemberSupplyAmount"
,"septemberSupplyNumber"
,"septemberSupplyArea"
,"fourthSeasonSupplyAmount"
,"fourthSeasonSupplyNumber"
,"fourthSeasonSupplyArea"
,"octoberSupplyAmount"
,"octoberSupplyNumber"
,"octoberSupplyArea"
,"novemberSupplyAmount"
,"novemberSupplyNumber"
,"novemberSupplyArea"
,"decemberSupplyAmount"
,"decemberSupplyNumber"
,"decemberSupplyArea"
------计划销售

,"thisYearSellPlannedAmount"--金额（年计划销售）
,"thisYearSellPlannedNumber"--套数（年计划销售）
,"thisYearSellPlannedArea"--面积（年计划销售）
,"firstSeonSellPlannedAmount"--金额（1季度计划销售）
,"firstSeonSellPlannedNumber"--套数（1季度计划销售）
,"firstSeonSellPlannedArea"--面积（1季度计划销售）
,"secondSeonSellPlannedAmount"--金额（2季度计划销售）
,"secondSeonSellPlannedNumber"--套数（2季度计划销售）
,"secondSeonSellPlannedArea"--面积（2季度计划销售）
,"thirdSeonSellPlannedAmount"--金额（3季度计划销售）
,"thirdSeonSellPlannedNumber"--套数（3季度计划销售）
,"thirdSeonSellPlannedArea"--面积（3季度计划销售）
,"fourthSeonSellPlannedAmount"--金额（4季度计划销售）
,"fourthSeonSellPlannedNumber"--套数（4季度计划销售）
,"fourthSeonSellPlannedArea"--面积（4季度计划销售）
,"januarySellPlannedAmount"--金额（1月计划销售）
,"januarySellPlannedNumber"--套数（1月计划销售）
,"januarySellPlannedArea"--面积（1月计划销售）
,"februarySellPlannedAmount"--金额（2月计划销售）
,"februarySellPlannedNumber"--套数（2月计划销售）
,"februarySellPlannedArea"--面积（2月计划销售）
,"marchSellPlannedAmount"--金额（3月计划销售）
,"marchSellPlannedNumber"--套数（3月计划销售）
,"marchSellPlannedArea"--面积（3月计划销售）
,"aprilSellPlannedAmount"--金额（4月计划销售）
,"aprilSellPlannedNumber"--套数（4月计划销售）
,"aprilSellPlannedArea"--面积（4月计划销售）
,"maySellPlannedAmount"--金额（5月计划销售）
,"maySellPlannedNumber"--套数（5月计划销售）
,"maySellPlannedArea"--面积（5月计划销售）
,"juneSellPlannedAmount"--金额（6月计划销售）
,"juneSellPlannedNumber"--套数（6月计划销售）
,"juneSellPlannedArea"--面积（6月计划销售）
,"julySellPlannedAmount"--金额（7月计划销售）
,"julySellPlannedNumber"--套数（7月计划销售）
,"julySellPlannedArea"--面积（7月计划销售）
,"augustSellPlannedAmount"--金额（8月计划销售）
,"augustSellPlannedNumber"--套数（8月计划销售）
,"augustSellPlannedArea"--面积（8月计划销售）
,"septemberSellPlannedAmount"--金额（10月计划销售）
,"septemberSellPlannedNumber"--套数（10月计划销售）
,"septemberSellPlannedArea"--面积（10月计划销售）
,"octoberSellPlannedAmount"--金额（10月计划销售）
,"octoberSellPlannedNumber"--套数（10月计划销售）
,"octoberSellPlannedArea"--面积（10月计划销售）
,"novemberSellPlannedAmount"--金额（11月计划销售）
,"novemberSellPlannedNumber"--套数（11月计划销售）
,"novemberSellPlannedArea"--面积（11月计划销售）
,"decemberSellPlannedAmount"--金额（12月计划销售）
,"decemberSellPlannedNumber"--套数（12月计划销售）
,"decemberSellPlannedArea"--面积（12月计划销售）


------------实际
,"LEVEL(1)"
,"poTotalSaleCount"
,"poTotalSaleArea"
,"poTotalSaleAmount"
,"rpTotalArea"
,"rpTotalAmount"
,"rpTotalCount"
,"poSaleArea"
,"poSaleAmount"
,"poSaleCount"
,"rpSurplusArea"
,"rpSurplusAmount"
,"rpSurplusCount"
,"poSurplusSaleAmount"
,"poSurplusSaleArea"
,"poSurplusSaleCount"
,"thisYearActualSupplyArea"
,"thisYearActualSupplyNumber"
,"thisYearActualSupplyAmount"
,"firstSeasonActualSupplyArea"
,"firstSeasonActualSupplyNumber"
,"firstSeasonActualSupplyAmount"
,"secondSeasonActualSupplyArea"
,"secondSeasonActualSupplyNumber"
,"secondSeasonActualSupplyAmount"
,"thirdSeasonActualSupplyArea"
,"thirdSeasonActualSupplyNumber"
,"thirdSeasonActualSupplyAmount"
,"fourthSeasonActualSupplyArea"
,"fourthSeasonActualSupplyNumber"
,"fourthSeasonActualSupplyAmount"
,"januaryActualSupplyArea"
,"januaryActualSupplyNumber"
,"januaryActualSupplyAmount"
,"februaryActualSupplyArea"
,"februaryActualSupplyNumber"
,"februaryActualSupplyAmount"
,"marchActualSupplyArea"
,"marchActualSupplyNumber"
,"marchActualSupplyAmount"
,"aprilActualSupplyArea"
,"aprilActualSupplyNumber"
,"aprilActualSupplyAmount"
,"mayActualSupplyArea"
,"mayActualSupplyNumber"
,"mayActualSupplyAmount"
,"juneActualSupplyArea"
,"juneActualSupplyNumber"
,"juneActualSupplyAmount"
,"julyActualSupplyArea"
,"julyActualSupplyNumber"
,"julyActualSupplyAmount"
,"augustActualSupplyArea"
,"augustActualSupplyNumber"
,"augustActualSupplyAmount"
,"septemberActualSupplyArea"
,"septemberActualSupplyNumber"
,"septemberActualSupplyAmount"
,"octoberActualSupplyArea"
,"octoberActualSupplyNumber"
,"octoberActualSupplyAmount"
,"novemberActualSupplyArea"
,"novemberActualSupplyNumber"
,"novemberActualSupplyAmount"
,"decemberActualSupplyArea"
,"decemberActualSupplyNumber"
,"decemberActualSupplyAmount"
,"thisYearSellArea"
,"thisYearSellNumber"
,"thisYearSellAmount"
,"firstSellArea"
,"firstSellNumber"
,"firstSellAmount"
,"secondSeasonSellArea"
,"secondSeasonSellNumber"
,"secondSeasonSellAmount"
,"thirdSeasonSellArea"
,"thirdSeasonSellNumber"
,"thirdSeasonSellAmount"
,"fourthSeasonSellArea"
,"fourthSeasonSellNumber"
,"fourthSeasonSellAmount"
,"januarySellArea"
,"januarySellNumber"
,"januarySellAmount"
,"februarySellArea"
,"februarySellNumber"
,"februarySellAmount"
,"marchSellArea"
,"marchSellNumber"
,"marchSellAmount"
,"aprilSellArea"
,"aprilSellNumber"
,"aprilSellAmount"
,"maySellArea"
,"maySellNumber"
,"maySellAmount"
,"juneSellArea"
,"juneSellNumber"
,"juneSellAmount"
,"julySellArea"
,"julySellNumber"
,"julySellAmount"
,"augustSellArea"
,"augustSellNumber"
,"augustSellAmount"
,"septemberSellArea"
,"septemberSellNumber"
,"septemberSellAmount"
,"octoberSellArea"
,"octoberSellNumber"
,"octoberSellAmount"
,"novemberSellArea"
,"novemberSellNumber"
,"novemberSellAmount"
,"decemberSellArea"
,"decemberSellNumber"
,"decemberSellAmount"
)
AS (

SELECT 	
A1.*
,A1.OBJ_ID	      as "id"
, A1.OBJ_NAME AS "projConstitute"--项目构成 objName 项目构成
,A1.OBJ_PARENT_ID AS "parentId"--父级id（生成树父级id）业务父ID bizPrentId
,A1.ORDER_CODE AS ORDER_HIERARCHY_CODE
,A1.OBJ_ID	    AS "objId"--项目ID
,A1.OBJ_TYPE    AS "objType"--对象类型
,A1.PD_NAME    AS "buildProductTypeName"--业态名称
,A1.OBJ_ID      AS "ownBuildProductTypeId"--所属的一级业态id
,A1.OBJ_ID      AS "buildProductTypeId"--业态Id
, "本年计划供货金额" AS "thisYearSupplyAmount"--金额（年计划供货）,
, "本年计划供货套数" AS "thisYearSupplyNumber"--套数（年计划供货）
, "本年计划供货面积" AS "thisYearSupplyArea"--面积（年计划供货）
, "一季度供货金额" AS "firstSeasonSupplyAmount"--金额（1季度计划供货）
, "一季度供货套数" AS "firstSeasonSupplyNumber"--套数（1季度计划供货）
, "一季度供货面积" AS "firstSeasonSupplyArea"--面积（1季度计划供货）
, "一月供货金额" AS "januarySupplyAmount"--金额（一月计划供货）
, "一月供货套数" AS "januarySupplyNumberx"--套数（一月计划供货）
, "一月供货面积" AS "januarySupplyNumber"--面积（一月计划供货）
, "二月供货金额" AS "februarySupplyAmount"--金额（二月计划供货）
, "二月供货套数" AS "februarySupplyNumber"--套数（二月计划供货）
, "二月供货面积" AS "februarySupplyArea"--面积（二月计划供货）
, "三月供货金额" AS "marchSupplyAmount"--金额（三月计划供货）
, "三月供货套数" AS "marchSupplyNumber"--套数（三月计划供货）
, "三月供货面积" AS "marchSupplyArea"--面积（三月计划供货）
, "二季度供货金额" AS "secondSeasonSupplyAmount"--金额（2季度计划供货）
, "二季度供货套数" AS "secondSeasonSupplyNumber"--套数（2季度计划供货）
, "二季度供货面积" AS "secondSeasonSupplyArea"--面积（2季度计划供货）
, "四月供货金额" AS "aprilSupplyAmount"--金额（四月计划供货）
, "四月供货套数" AS "aprilSupplyNumber"--套数（四月计划供货）
, "四月供货面积" AS "aprilSupplyArea"--面积（四月计划供货）
, "五月供货金额" AS "maySupplyAmount"--金额（五月计划供货）
, "五月供货套数" AS "maySupplyNumber"--套数（五月计划供货）
, "五月供货面积" AS "maySupplyArea"--面积（五月计划供货）
, "六月供货金额" AS "juneSupplyAmount"--金额（六月计划供货）
, "六月供货套数" AS "juneSupplyNumber"--套数（六月计划供货）
, "六月供货面积" AS "juneSupplyArea"--面积（六月计划供货）
, "三季度供货金额" AS "thirdSeasonSupplyAmount"--金额（3季度计划供货）
, "三季度供货套数" AS "thirdSeasonSupplyNumber"--套数（3季度计划供货）
, "三季度供货面积" AS "thirdSeasonSupplyArea"--面积（3季度计划供货）
, "七月供货金额" AS "julySupplyAmount"--金额（七月计划供货）
, "七月供货套数" AS "julySupplyNumber"--套数（七月计划供货）
, "七月供货面积" AS "julySupplyArea"--面积（七月计划供货）
, "八月供货金额" AS "augustSupplyAmount"--金额（八月计划供货）
, "八月供货套数" AS "augustSupplyNumber"--套数（八月计划供货）
, "八月供货面积" AS "augustSupplyArea"--面积（八月计划供货）
, "九月供货金额" AS "septemberSupplyAmount"--金额（九月计划供货）
, "九月供货套数" AS "septemberSupplyNumber"--套数（九月计划供货）
, "九月供货面积" AS "septemberSupplyArea"--面积（九月计划供货）
, "四季度供货金额" AS "fourthSeasonSupplyAmount"--金额（4季度计划供货）
, "四季度供货套数" AS "fourthSeasonSupplyNumber"--套数（4季度计划供货）
, "四季度供货面积" AS "fourthSeasonSupplyArea"--面积（4季度计划供货）
, "十月供货金额" AS "octoberSupplyAmount"--金额（十月计划供货）
, "十月供货套数" AS "octoberSupplyNumber"--套数（十月计划供货）
, "十月供货面积" AS "octoberSupplyArea"--面积（十月计划供货）
, "十一月供货金额" AS "novemberSupplyAmount"--金额（十一月计划供货）
, "十一月供货套数" AS "novemberSupplyNumber"--套数（十一月计划供货）
, "十一月供货面积" AS "novemberSupplyArea"--面积（十一月计划供货）
, "十二月供货金额" AS "decemberSupplyAmount"--金额（十二月计划供货）
, "十二月供货套数" AS "decemberSupplyNumber"--套数（十二月计划供货）
, "十二月供货面积" AS "decemberSupplyArea"--面积（十二月计划供货）
--,本年计划销售金额  AS  "thisYearSellPlannedArea"
----计划销售
,"本年计划销售金额" AS "thisYearSellPlannedAmount"--金额（年计划销售）
,"本年计划销售套数" AS "thisYearSellPlannedNumber"--套数（年计划销售）
,"本年计划销售面积" AS "thisYearSellPlannedArea"--面积（年计划销售）
,"一季度销售金额" AS "firstSeonSellPlannedAmount"--金额（1季度计划销售）
,"一季度销售套数" AS "firstSeonSellPlannedNumber"--套数（1季度计划销售）
,"一季度销售面积" AS "firstSeonSellPlannedArea"--面积（1季度计划销售）
,"二季度销售金额" AS "secondSeonSellPlannedAmount"--金额（2季度计划销售）
,"二季度销售套数" AS "secondSeonSellPlannedNumber"--套数（2季度计划销售）
,"二季度销售面积" AS "secondSeonSellPlannedArea"--面积（2季度计划销售）
,"三季度销售金额" AS "thirdSeonSellPlannedAmount"--金额（3季度计划销售）
,"三季度销售套数" AS "thirdSeonSellPlannedNumber"--套数（3季度计划销售）
,"三季度销售面积" AS "thirdSeonSellPlannedArea"--面积（3季度计划销售）
,"四季度销售金额" AS "fourthSeonSellPlannedAmount"--金额（4季度计划销售）
,"四季度销售套数" AS "fourthSeonSellPlannedNumber"--套数（4季度计划销售）
,"四季度销售面积" AS "fourthSeonSellPlannedArea"--面积（4季度计划销售）
,"一月签约金额" AS "januarySellPlannedAmount"--金额（1月计划销售）
,"一月签约套数" AS "januarySellPlannedNumber"--套数（1月计划销售）
,"一月签约面积" AS "januarySellPlannedArea"--面积（1月计划销售）
,"二月签约金额" AS "februarySellPlannedAmount"--金额（2月计划销售）
,"二月签约套数" AS "februarySellPlannedNumber"--套数（2月计划销售）
,"二月签约面积" AS "februarySellPlannedArea"--面积（2月计划销售）
,"三月签约金额" AS "marchSellPlannedAmount"--金额（3月计划销售）
,"三月签约套数" AS "marchSellPlannedNumber"--套数（3月计划销售）
,"三月签约面积" AS "marchSellPlannedArea"--面积（3月计划销售）
,"四月签约金额" AS "aprilSellPlannedAmount"--金额（4月计划销售）
,"四月签约套数" AS "aprilSellPlannedNumber"--套数（4月计划销售）
,"四月签约面积" AS "aprilSellPlannedArea"--面积（4月计划销售）
,"五月签约金额" AS "maySellPlannedAmount"--金额（5月计划销售）
,"五月签约套数" AS "maySellPlannedNumber"--套数（5月计划销售）
,"五月签约面积" AS "maySellPlannedArea"--面积（5月计划销售）
,"六月签约金额" AS "juneSellPlannedAmount"--金额（6月计划销售）
,"六月签约套数" AS "juneSellPlannedNumber"--套数（6月计划销售）
,"六月签约面积" AS "juneSellPlannedArea"--面积（6月计划销售）
,"七月签约金额" AS "julySellPlannedAmount"--金额（7月计划销售）
,"七月签约套数" AS "julySellPlannedNumber"--套数（7月计划销售）
,"七月签约面积" AS "julySellPlannedArea"--面积（7月计划销售）
,"八月签约金额" AS "augustSellPlannedAmount"--金额（8月计划销售）
,"八月签约套数" AS "augustSellPlannedNumber"--套数（8月计划销售）
,"八月签约面积" AS "augustSellPlannedArea"--面积（8月计划销售）
,"九月签约金额" AS "septemberSellPlannedAmount"--金额（10月计划销售）
,"九月签约套数" AS "septemberSellPlannedNumber"--套数（10月计划销售）
,"九月签约面积" AS "septemberSellPlannedArea"--面积（10月计划销售）
,"十月签约金额" AS "octoberSellPlannedAmount"--金额（10月计划销售）
,"十月签约套数" AS "octoberSellPlannedNumber"--套数（10月计划销售）
,"十月签约面积" AS "octoberSellPlannedArea"--面积（10月计划销售）
,"十一月签约金额" AS "novemberSellPlannedAmount"--金额（11月计划销售）
,"十一月签约套数" AS "novemberSellPlannedNumber"--套数（11月计划销售）
,"十一月签约面积" AS "novemberSellPlannedArea"--面积（11月计划销售）
,"十二月签约金额" AS "decemberSellPlannedAmount"--金额（12月计划销售）
,"十二月签约套数" AS "decemberSellPlannedNumber"--套数（12月计划销售）
,"十二月签约面积" AS "decemberSellPlannedArea"--面积（12月计划销售）



------实际
,P2."LEVEL"					
,P2."poTotalSaleCount"
,P2."poTotalSaleArea"
,P2."poTotalSaleAmount"
,P2."rpTotalArea"
,P2."rpTotalAmount"
,P2."rpTotalCount"
,P2."poSaleArea"
,P2."poSaleAmount"
,P2."poSaleCount"
,P2."rpSurplusArea"
,P2."rpSurplusAmount"
,P2."rpSurplusCount"
,P2."poSurplusSaleAmount"
,P2."poSurplusSaleArea"
,P2."poSurplusSaleCount"
,P2."thisYearActualSupplyArea"
,P2."thisYearActualSupplyNumber"
,P2."thisYearActualSupplyAmount"
,P2."firstSeasonActualSupplyArea"
,P2."firstSeasonActualSupplyNumber"
,P2."firstSeasonActualSupplyAmount"
,P2."secondSeasonActualSupplyArea"
,P2."secondSeasonActualSupplyNumber"
,P2."secondSeasonActualSupplyAmount"
,P2."thirdSeasonActualSupplyArea"
,P2."thirdSeasonActualSupplyNumber"
,P2."thirdSeasonActualSupplyAmount"
,P2."fourthSeasonActualSupplyArea"
,P2."fourthSeasonActualSupplyNumber"
,P2."fourthSeasonActualSupplyAmount"
,P2."januaryActualSupplyArea"
,P2."januaryActualSupplyNumber"
,P2."januaryActualSupplyAmount"
,P2."februaryActualSupplyArea"
,P2."februaryActualSupplyNumber"
,P2."februaryActualSupplyAmount"
,P2."marchActualSupplyArea"
,P2."marchActualSupplyNumber"
,P2."marchActualSupplyAmount"
,P2."aprilActualSupplyArea"
,P2."aprilActualSupplyNumber"
,P2."aprilActualSupplyAmount"
,P2."mayActualSupplyArea"
,P2."mayActualSupplyNumber"
,P2."mayActualSupplyAmount"
,P2."juneActualSupplyArea"
,P2."juneActualSupplyNumber"
,P2."juneActualSupplyAmount"
,P2."julyActualSupplyArea"
,P2."julyActualSupplyNumber"
,P2."julyActualSupplyAmount"
,P2."augustActualSupplyArea"
,P2."augustActualSupplyNumber"
,P2."augustActualSupplyAmount"
,P2."septemberActualSupplyArea"
,P2."septemberActualSupplyNumber"
,P2."septemberActualSupplyAmount"
,P2."octoberActualSupplyArea"
,P2."octoberActualSupplyNumber"
,P2."octoberActualSupplyAmount"
,P2."novemberActualSupplyArea"
,P2."novemberActualSupplyNumber"
,P2."novemberActualSupplyAmount"
,P2."decemberActualSupplyArea"
,P2."decemberActualSupplyNumber"
,P2."decemberActualSupplyAmount"
,P2."thisYearSellArea"
,P2."thisYearSellNumber"
,P2."thisYearSellAmount"
,P2."firstSellArea"
,P2."firstSellNumber"
,P2."firstSellAmount"
,P2."secondSeasonSellArea"
,P2."secondSeasonSellNumber"
,P2."secondSeasonSellAmount"
,P2."thirdSeasonSellArea"
,P2."thirdSeasonSellNumber"
,P2."thirdSeasonSellAmount"
,P2."fourthSeasonSellArea"
,P2."fourthSeasonSellNumber"
,P2."fourthSeasonSellAmount"
,P2."januarySellArea"
,P2."januarySellNumber"
,P2."januarySellAmount"
,P2."februarySellArea"
,P2."februarySellNumber"
,P2."februarySellAmount"
,P2."marchSellArea"
,P2."marchSellNumber"
,P2."marchSellAmount"
,P2."aprilSellArea"
,P2."aprilSellNumber"
,P2."aprilSellAmount"
,P2."maySellArea"
,P2."maySellNumber"
,P2."maySellAmount"
,P2."juneSellArea"
,P2."juneSellNumber"
,P2."juneSellAmount"
,P2."julySellArea"
,P2."julySellNumber"
,P2."julySellAmount"
,P2."augustSellArea"
,P2."augustSellNumber"
,P2."augustSellAmount"
,P2."septemberSellArea"
,P2."septemberSellNumber"
,P2."septemberSellAmount"
,P2."octoberSellArea"
,P2."octoberSellNumber"
,P2."octoberSellAmount"
,P2."novemberSellArea"
,P2."novemberSellNumber"
,P2."novemberSellAmount"
,P2."decemberSellArea"
,P2."decemberSellNumber"
,P2."decemberSellAmount"

FROM 
--项目树
 (
--项目
SELECT PR.ID AS PROJ_ID,'项目' OBJ_TYPE,PR.ID AS OBJ_ID
,PROJECT_NAME AS OBJ_NAME
,NULL AS PD_NAME
,COMPANY_ID AS OBJ_PARENT_ID  --项目所属公司为父级
--,(SELECT O.ID FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID)  AS OBJ_PARENT_ID  --项目所属区域公司为父级
,'1' AS "LEVEL"
,'1' AS "LEVEL_ORDER" 
--,COMPANY_ORDER_HIERARCHY_CODE||'_'||PROJECT_CODE||'_0' AS ORDER_CODE --奥霖排序
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) ||'_'||PROJECT_CODE AS ORDER_CODE --lixc排序
,(SELECT O.ORG_NAME FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_NAME
,(SELECT O.ID FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ID
,(SELECT O.ORDER_HIERARCHY_CODE  FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ORDER_HIERARCHY_CODE 
 FROM SYS_PROJECT PR 
--存在供货计划才查询
	WHERE    EXISTS ( SELECT 1 FROM SWM_SUPPLY_SELL_PLAN SP WHERE  SP.PROJECT_ID=PR.ID AND IS_DELETED=0 AND APPROVAL_STATUS='已审核' )
 UNION ALL 
--按业态汇总-
SELECT PR.ID AS PROJ_ID,'按业态汇总' OBJ_TYPE,PR.ID||'_firstLevelProductTypeStatistics' AS OBJ_ID
,'按业态汇总' AS OBJ_NAME
, NULL AS PD_NAME
,PR.ID AS OBJ_PARENT_ID ,'2' AS "LEVEL",'2' AS "LEVEL_ORDER" 
--,'99_'||LPAD (PR.SN , 6 , '0')||'_00' AS ORDER_CODE  
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) ||'_'||PROJECT_CODE||'_0' ----lixc排序
,(SELECT O.ORG_NAME FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_NAME
,(SELECT O.ID FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ID 
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ORDER_HIERARCHY_CODE 
FROM SYS_PROJECT PR 
UNION ALL 
--按业态汇总一级业态

SELECT PR.ID AS PROJ_ID,'一级业态' OBJ_TYPE,PR.ID||'_'||PD.ID AS OBJ_ID
,PRODUCT_TYPE_NAME AS OBJ_NAME
,PRODUCT_TYPE_NAME AS PD_NAME
,PR.ID||'_firstLevelProductTypeStatistics' AS OBJ_PARENT_ID  
,'3' AS "LEVEL",'4' AS "LEVEL_ORDER" 
--,'99_'||LPAD (PR.SN , 6 , '0')||'_00_'||PRODUCT_TYPE_SHORT_CODE   AS ORDER_CODE
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) ||'_'||PROJECT_CODE||'_0'||CASE WHEN  PRODUCT_TYPE_NAME='住宅' THEN '1'  WHEN  PRODUCT_TYPE_NAME='商办产业' THEN '2'  WHEN  PRODUCT_TYPE_NAME='车位仓储' THEN '3'  WHEN  PRODUCT_TYPE_NAME='配套设施' THEN '4'  END AS  ORDER_CODE----lixc排序
,(SELECT O.ORG_NAME FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_NAME
,(SELECT O.ID FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ID
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ORDER_HIERARCHY_CODE 
	FROM SYS_PROJECT PR 
	INNER JOIN MDM_BUILD_PRODUCT_TYPE PD ON 1=1 AND PRODUCT_TYPE_LEVEL=1 --and  PROJECT_NAME='北京西派国际'
	
--分期
UNION ALL 
SELECT PS.ID AS STAGE_ID,'分期' OBJ_TYPE,PR.ID||'_'||PS.ID AS OBJ_ID
,STAGE_NAME AS OBJ_NAME
,NULL PD_NAME
,PR.ID AS OBJ_PARENT_ID 
,'2' AS "LEVEL",'3' AS "LEVEL_ORDER"
--,'99_'||LPAD (PR.SN , 6 , '0')||'_10_'||PS.ORDER_CODE  AS ORDER_CODE  
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) ||'_'||PROJECT_CODE||'_'||PS.ORDER_CODE AS  ORDER_CODE
,(SELECT O.ORG_NAME FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_NAME
,(SELECT O.ID FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ID
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ORDER_HIERARCHY_CODE 
FROM SYS_PROJECT PR  INNER JOIN SYS_PROJECT_STAGE PS ON PR.ID=PROJECT_ID

--分期业态
UNION ALL 
SELECT PS.ID AS STAGE_ID,'分期业态' OBJ_TYPE,PR.ID||'_'||PS.ID||'_'||Pd.ID AS OBJ_ID
,PRODUCT_TYPE_NAME AS OBJ_NAME
,PRODUCT_TYPE_NAME AS PD_NAME
,PR.ID||'_'||PS.ID AS OBJ_PARENT_ID 
,'3' AS "LEVEL",'4' AS "LEVEL_ORDER"
--, '99_'||LPAD (PR.SN , 6 , '0')||'_10_'||PS.ORDER_CODE||'_'||PRODUCT_TYPE_SHORT_CODE   AS ORDER_CODE  
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) ||'_'||PROJECT_CODE||'_'||PS.ORDER_CODE||CASE WHEN  PRODUCT_TYPE_NAME='住宅' THEN '1'  WHEN  PRODUCT_TYPE_NAME='商办产业' THEN '2'  WHEN  PRODUCT_TYPE_NAME='车位仓储' THEN '3'  WHEN  PRODUCT_TYPE_NAME='配套设施' THEN '4'  END  AS  ORDER_CODE
,(SELECT O.ORG_NAME FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_NAME
,(SELECT O.ID FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ID
,(SELECT O.ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH O.ID = PR.COMPANY_ID CONNECT BY PRIOR O.PARENT_ID = O.ID) AS COMPANY_ORDER_HIERARCHY_CODE 
FROM SYS_PROJECT PR  INNER JOIN SYS_PROJECT_STAGE PS ON PR.ID=PROJECT_ID
	

INNER JOIN MDM_BUILD_PRODUCT_TYPE PD ON 1=1 AND PRODUCT_TYPE_LEVEL=1 ) A1
LEFT JOIN    
(

	SELECT  
	PROJECT_ID
	,PROJECT_NAME
	,B.OBJ_TYPE
	,CASE WHEN  B.OBJ_TYPE='楼栋' THEN B.BIZ_PARENT_ID||'_'||B.BUILD_PRODUCT_TYPE_ID ELSE  B.BIZ_ID  END  AS OBJ_ID
	,B.BIZ_PARENT_ID AS obj_PARENT_ID
	,CASE WHEN  B.OBJ_TYPE='楼栋' THEN B.BUILD_PRODUCT_TYPE_NAME ELSE  B.OBJ_NAME  END  AS OBJ_NAME
	,C.OBJ_NAME  AS OBJ_PARENT_NAME
	,SUM(NVL(B.JANUARY_SUPPLY_AMOUNT,0))+SUM(NVL(B.FEBRUARY_SUPPLY_AMOUNT,0))+SUM(NVL(B.MARCH_SUPPLY_AMOUNT,0)) +SUM(NVL(B.APRIL_SUPPLY_AMOUNT,0))+SUM(NVL(B.MAY_SUPPLY_AMOUNT,0)) +SUM(NVL(B.JUNE_SUPPLY_AMOUNT,0))+SUM(NVL(B.JULY_SUPPLY_AMOUNT,0))+SUM(NVL(B.AUGUST_SUPPLY_AMOUNT,0))+SUM(NVL(B.SEPTEMBER_SUPPLY_AMOUNT,0))+SUM(NVL(B.OCTOBER_SUPPLY_AMOUNT,0)) +SUM(NVL(B.NOVEMBER_SUPPLY_AMOUNT,0)) +SUM(NVL(B.DECEMBER_SUPPLY_AMOUNT,0))  AS 本年计划供货金额
	,SUM(NVL(B.JANUARY_SUPPLY_Area,0))+SUM(NVL(B.FEBRUARY_SUPPLY_Area,0))+SUM(NVL(B.MARCH_SUPPLY_Area,0)) +SUM(NVL(B.APRIL_SUPPLY_Area,0))+SUM(NVL(B.MAY_SUPPLY_Area,0)) +SUM(NVL(B.JUNE_SUPPLY_Area,0))+SUM(NVL(B.JULY_SUPPLY_Area,0))+SUM(NVL(B.AUGUST_SUPPLY_Area,0))+SUM(NVL(B.SEPTEMBER_SUPPLY_Area,0))+SUM(NVL(B.OCTOBER_SUPPLY_Area,0)) +SUM(NVL(B.NOVEMBER_SUPPLY_Area,0)) +SUM(NVL(B.DECEMBER_SUPPLY_Area,0))  AS 本年计划供货面积
	,SUM(NVL(B.JANUARY_SUPPLY_Number,0))+SUM(NVL(B.FEBRUARY_SUPPLY_Number,0))+SUM(NVL(B.MARCH_SUPPLY_Number,0)) +SUM(NVL(B.APRIL_SUPPLY_Number,0))+SUM(NVL(B.MAY_SUPPLY_Number,0)) +SUM(NVL(B.JUNE_SUPPLY_Number,0))+SUM(NVL(B.JULY_SUPPLY_Number,0))+SUM(NVL(B.AUGUST_SUPPLY_Number,0))+SUM(NVL(B.SEPTEMBER_SUPPLY_Number,0))+SUM(NVL(B.OCTOBER_SUPPLY_Number,0)) +SUM(NVL(B.NOVEMBER_SUPPLY_Number,0)) +SUM(NVL(B.DECEMBER_SUPPLY_Number,0))  AS 本年计划供货套数
	,SUM(NVL(B.JANUARY_SUPPLY_AMOUNT,0))+SUM(NVL(B.FEBRUARY_SUPPLY_AMOUNT,0))+SUM(NVL(B.MARCH_SUPPLY_AMOUNT,0))  AS 一季度供货金额
	,SUM(NVL(B.JANUARY_SUPPLY_AREA,0))+SUM(NVL(B.FEBRUARY_SUPPLY_AREA,0))+SUM(NVL(B.MARCH_SUPPLY_AREA,0))  AS 一季度供货面积
	,SUM(NVL(B.JANUARY_SUPPLY_NUMBER,0))+SUM(NVL(B.FEBRUARY_SUPPLY_NUMBER,0))+SUM(NVL(B.MARCH_SUPPLY_NUMBER,0))  AS 一季度供货套数
	,SUM(NVL(B.APRIL_SUPPLY_AMOUNT,0))+SUM(NVL(B.MAY_SUPPLY_AMOUNT,0)) +SUM(NVL(B.JUNE_SUPPLY_AMOUNT,0))  AS 二季度供货金额
	,SUM(NVL(B.APRIL_SUPPLY_AREA,0))+SUM(NVL(B.MAY_SUPPLY_AREA,0)) +SUM(NVL(B.JUNE_SUPPLY_AREA,0))  AS 二季度供货面积
	,SUM(NVL(B.APRIL_SUPPLY_NUMBER,0))+SUM(NVL(B.MAY_SUPPLY_NUMBER,0)) +SUM(NVL(B.JUNE_SUPPLY_NUMBER,0))  AS 二季度供货套数
	,SUM(NVL(B.JULY_SUPPLY_AMOUNT,0))+SUM(NVL(B.AUGUST_SUPPLY_AMOUNT,0))+SUM(NVL(B.SEPTEMBER_SUPPLY_AMOUNT,0))  AS 三季度供货金额 
	,SUM(NVL(B.JULY_SUPPLY_AREA,0))+SUM(NVL(B.AUGUST_SUPPLY_AREA,0))+SUM(NVL(B.SEPTEMBER_SUPPLY_AREA,0))  AS 三季度供货面积
	,SUM(NVL(B.JULY_SUPPLY_NUMBER,0))+SUM(NVL(B.AUGUST_SUPPLY_NUMBER,0))+SUM(NVL(B.SEPTEMBER_SUPPLY_NUMBER,0))  AS 三季度供货套数
	,SUM(NVL(B.OCTOBER_SUPPLY_AMOUNT,0)) +SUM(NVL(B.NOVEMBER_SUPPLY_AMOUNT,0)) +SUM(NVL(B.DECEMBER_SUPPLY_AMOUNT,0)) AS 四季度供货金额
	,SUM(NVL(B.OCTOBER_SUPPLY_AREA,0)) +SUM(NVL(B.NOVEMBER_SUPPLY_AREA,0)) +SUM(NVL(B.DECEMBER_SUPPLY_AREA,0)) AS 四季度供货面积
	,SUM(NVL(B.OCTOBER_SUPPLY_NUMBER,0)) +SUM(NVL(B.NOVEMBER_SUPPLY_NUMBER,0)) +SUM(NVL(B.DECEMBER_SUPPLY_NUMBER,0)) AS 四季度供货套数

	,SUM(NVL(B.JANUARY_SELL_AMOUNT,0))+SUM(NVL(B.FEBRUARY_SELL_AMOUNT,0))+SUM(NVL(B.MARCH_SELL_AMOUNT,0)) +SUM(NVL(B.APRIL_SELL_AMOUNT,0))+SUM(NVL(B.MAY_SELL_AMOUNT,0)) +SUM(NVL(B.JUNE_SELL_AMOUNT,0))+SUM(NVL(B.JULY_SELL_AMOUNT,0))+SUM(NVL(B.AUGUST_SELL_AMOUNT,0))+SUM(NVL(B.SEPTEMBER_SELL_AMOUNT,0))+SUM(NVL(B.OCTOBER_SELL_AMOUNT,0)) +SUM(NVL(B.NOVEMBER_SELL_AMOUNT,0)) +SUM(NVL(B.DECEMBER_SELL_AMOUNT,0))  AS 本年计划销售金额
	,SUM(NVL(B.JANUARY_SELL_Area,0))+SUM(NVL(B.FEBRUARY_SELL_Area,0))+SUM(NVL(B.MARCH_SELL_Area,0)) +SUM(NVL(B.APRIL_SELL_Area,0))+SUM(NVL(B.MAY_SELL_Area,0)) +SUM(NVL(B.JUNE_SELL_Area,0))+SUM(NVL(B.JULY_SELL_Area,0))+SUM(NVL(B.AUGUST_SELL_Area,0))+SUM(NVL(B.SEPTEMBER_SELL_Area,0))+SUM(NVL(B.OCTOBER_SELL_Area,0)) +SUM(NVL(B.NOVEMBER_SELL_Area,0)) +SUM(NVL(B.DECEMBER_SELL_Area,0))  AS 本年计划销售面积
	,SUM(NVL(B.JANUARY_SELL_Number,0))+SUM(NVL(B.FEBRUARY_SELL_Number,0))+SUM(NVL(B.MARCH_SELL_Number,0)) +SUM(NVL(B.APRIL_SELL_Number,0))+SUM(NVL(B.MAY_SELL_Number,0)) +SUM(NVL(B.JUNE_SELL_Number,0))+SUM(NVL(B.JULY_SELL_Number,0))+SUM(NVL(B.AUGUST_SELL_Number,0))+SUM(NVL(B.SEPTEMBER_SELL_Number,0))+SUM(NVL(B.OCTOBER_SELL_Number,0)) +SUM(NVL(B.NOVEMBER_SELL_Number,0)) +SUM(NVL(B.DECEMBER_SELL_Number,0))  AS 本年计划销售套数
	,SUM(NVL(B.JANUARY_SELL_AMOUNT,0))+SUM(NVL(B.FEBRUARY_SELL_AMOUNT,0))+SUM(NVL(B.MARCH_SELL_AMOUNT,0))  AS 一季度销售金额
	,SUM(NVL(B.JANUARY_SELL_AREA,0))+SUM(NVL(B.FEBRUARY_SELL_AREA,0))+SUM(NVL(B.MARCH_SELL_AREA,0))  AS 一季度销售面积
	,SUM(NVL(B.JANUARY_SELL_NUMBER,0))+SUM(NVL(B.FEBRUARY_SELL_NUMBER,0))+SUM(NVL(B.MARCH_SELL_NUMBER,0))  AS 一季度销售套数
	,SUM(NVL(B.APRIL_SELL_AMOUNT,0))+SUM(NVL(B.MAY_SELL_AMOUNT,0)) +SUM(NVL(B.JUNE_SELL_AMOUNT,0))  AS 二季度销售金额
	,SUM(NVL(B.APRIL_SELL_AREA,0))+SUM(NVL(B.MAY_SELL_AREA,0)) +SUM(NVL(B.JUNE_SELL_AREA,0))  AS 二季度销售面积
	,SUM(NVL(B.APRIL_SELL_NUMBER,0))+SUM(NVL(B.MAY_SELL_NUMBER,0)) +SUM(NVL(B.JUNE_SELL_NUMBER,0))  AS 二季度销售套数
	,SUM(NVL(B.JULY_SELL_AMOUNT,0))+SUM(NVL(B.AUGUST_SELL_AMOUNT,0))+SUM(NVL(B.SEPTEMBER_SELL_AMOUNT,0))  AS 三季度销售金额 
	,SUM(NVL(B.JULY_SELL_AREA,0))+SUM(NVL(B.AUGUST_SELL_AREA,0))+SUM(NVL(B.SEPTEMBER_SELL_AREA,0))  AS 三季度销售面积
	,SUM(NVL(B.JULY_SELL_NUMBER,0))+SUM(NVL(B.AUGUST_SELL_NUMBER,0))+SUM(NVL(B.SEPTEMBER_SELL_NUMBER,0))  AS 三季度销售套数
	,SUM(NVL(B.OCTOBER_SELL_AMOUNT,0)) +SUM(NVL(B.NOVEMBER_SELL_AMOUNT,0)) +SUM(NVL(B.DECEMBER_SELL_AMOUNT,0)) AS 四季度销售金额
	,SUM(NVL(B.OCTOBER_SELL_AREA,0)) +SUM(NVL(B.NOVEMBER_SELL_AREA,0)) +SUM(NVL(B.DECEMBER_SELL_AREA,0)) AS 四季度销售面积
	,SUM(NVL(B.OCTOBER_SELL_NUMBER,0)) +SUM(NVL(B.NOVEMBER_SELL_NUMBER,0)) +SUM(NVL(B.DECEMBER_SELL_NUMBER,0)) AS 四季度销售套数

	,SUM(NVL(B.JANUARY_SUPPLY_AMOUNT,0)) AS 一月供货金额
	,SUM(NVL(B.JANUARY_SUPPLY_AREA,0)) AS 一月供货面积
	,SUM(NVL(B.JANUARY_SUPPLY_NUMBER,0)) AS 一月供货套数
	,SUM(NVL(B.JANUARY_SELL_AMOUNT,0)) AS 一月签约金额
	,SUM(NVL(B.JANUARY_SELL_AREA,0)) AS 一月签约面积
	,SUM(NVL(B.JANUARY_SELL_NUMBER,0)) AS 一月签约套数
	,SUM(NVL(B.FEBRUARY_SUPPLY_AMOUNT,0)) AS 二月供货金额
	,SUM(NVL(B.FEBRUARY_SUPPLY_AREA,0)) AS 二月供货面积
	,SUM(NVL(B.FEBRUARY_SUPPLY_NUMBER,0)) AS 二月供货套数
	,SUM(NVL(B.FEBRUARY_SELL_AMOUNT,0)) AS 二月签约金额
	,SUM(NVL(B.FEBRUARY_SELL_AREA,0)) AS 二月签约面积
	,SUM(NVL(B.FEBRUARY_SELL_NUMBER,0)) AS 二月签约套数
	,SUM(NVL(B.MARCH_SUPPLY_AMOUNT,0)) AS 三月供货金额
	,SUM(NVL(B.MARCH_SUPPLY_AREA,0)) AS 三月供货面积
	,SUM(NVL(B.MARCH_SUPPLY_NUMBER,0)) AS 三月供货套数
	,SUM(NVL(B.MARCH_SELL_AMOUNT,0)) AS 三月签约金额
	,SUM(NVL(B.MARCH_SELL_AREA,0)) AS 三月签约面积
	,SUM(NVL(B.MARCH_SELL_NUMBER,0)) AS 三月签约套数
	,SUM(NVL(B.APRIL_SUPPLY_AMOUNT,0)) AS 四月供货金额
	,SUM(NVL(B.APRIL_SUPPLY_AREA,0)) AS 四月供货面积
	,SUM(NVL(B.APRIL_SUPPLY_NUMBER,0)) AS 四月供货套数
	,SUM(NVL(B.APRIL_SELL_AMOUNT,0)) AS 四月签约金额
	,SUM(NVL(B.APRIL_SELL_AREA,0)) AS 四月签约面积
	,SUM(NVL(B.APRIL_SELL_NUMBER,0)) AS 四月签约套数
	,SUM(NVL(B.MAY_SUPPLY_AMOUNT,0)) AS 五月供货金额
	,SUM(NVL(B.MAY_SUPPLY_AREA,0)) AS 五月供货面积
	,SUM(NVL(B.MAY_SUPPLY_NUMBER,0)) AS 五月供货套数
	,SUM(NVL(B.MAY_SELL_AMOUNT,0)) AS 五月签约金额
	,SUM(NVL(B.MAY_SELL_AREA,0)) AS 五月签约面积
	,SUM(NVL(B.MAY_SELL_NUMBER,0)) AS 五月签约套数
	,SUM(NVL(B.JUNE_SUPPLY_AMOUNT,0)) AS 六月供货金额
	,SUM(NVL(B.JUNE_SUPPLY_AREA,0)) AS 六月供货面积
	,SUM(NVL(B.JUNE_SUPPLY_NUMBER,0)) AS 六月供货套数
	,SUM(NVL(B.JUNE_SELL_AMOUNT,0)) AS 六月签约金额
	,SUM(NVL(B.JUNE_SELL_AREA,0)) AS 六月签约面积
	,SUM(NVL(B.JUNE_SELL_NUMBER,0)) AS 六月签约套数
	,SUM(NVL(B.JULY_SUPPLY_AMOUNT,0)) AS 七月供货金额
	,SUM(NVL(B.JULY_SUPPLY_AREA,0)) AS 七月供货面积
	,SUM(NVL(B.JULY_SUPPLY_NUMBER,0)) AS 七月供货套数
	,SUM(NVL(B.JULY_SELL_AMOUNT,0)) AS 七月签约金额
	,SUM(NVL(B.JULY_SELL_AREA,0)) AS 七月签约面积
	,SUM(NVL(B.JULY_SELL_NUMBER,0)) AS 七月签约套数
	,SUM(NVL(B.AUGUST_SUPPLY_AMOUNT,0)) AS 八月供货金额
	,SUM(NVL(B.AUGUST_SUPPLY_AREA,0)) AS 八月供货面积
	,SUM(NVL(B.AUGUST_SUPPLY_NUMBER,0)) AS 八月供货套数
	,SUM(NVL(B.AUGUST_SELL_AMOUNT,0)) AS 八月签约金额
	,SUM(NVL(B.AUGUST_SELL_AREA,0)) AS 八月签约面积
	,SUM(NVL(B.AUGUST_SELL_NUMBER,0)) AS 八月签约套数
	,SUM(NVL(B.SEPTEMBER_SUPPLY_AMOUNT,0)) AS 九月供货金额
	,SUM(NVL(B.SEPTEMBER_SUPPLY_AREA,0)) AS 九月供货面积
	,SUM(NVL(B.SEPTEMBER_SUPPLY_NUMBER,0)) AS 九月供货套数
	,SUM(NVL(B.SEPTEMBER_SELL_AMOUNT,0)) AS 九月签约金额
	,SUM(NVL(B.SEPTEMBER_SELL_AREA,0)) AS 九月签约面积
	,SUM(NVL(B.SEPTEMBER_SELL_NUMBER,0)) AS 九月签约套数
	,SUM(NVL(B.OCTOBER_SUPPLY_AMOUNT,0)) AS 十月供货金额
	,SUM(NVL(B.OCTOBER_SUPPLY_AREA,0)) AS 十月供货面积
	,SUM(NVL(B.OCTOBER_SUPPLY_NUMBER,0)) AS 十月供货套数
	,SUM(NVL(B.OCTOBER_SELL_AMOUNT,0)) AS 十月签约金额
	,SUM(NVL(B.OCTOBER_SELL_AREA,0)) AS 十月签约面积
	,SUM(NVL(B.OCTOBER_SELL_NUMBER,0)) AS 十月签约套数
	,SUM(NVL(B.NOVEMBER_SUPPLY_AMOUNT,0)) AS 十一月供货金额
	,SUM(NVL(B.NOVEMBER_SUPPLY_AREA,0)) AS 十一月供货面积
	,SUM(NVL(B.NOVEMBER_SUPPLY_NUMBER,0)) AS 十一月供货套数
	,SUM(NVL(B.NOVEMBER_SELL_AMOUNT,0)) AS 十一月签约金额
	,SUM(NVL(B.NOVEMBER_SELL_AREA,0)) AS 十一月签约面积
	,SUM(NVL(B.NOVEMBER_SELL_NUMBER,0)) AS 十一月签约套数
	,SUM(NVL(B.DECEMBER_SUPPLY_AMOUNT,0)) AS 十二月供货金额
	,SUM(NVL(B.DECEMBER_SUPPLY_AREA,0)) AS 十二月供货面积
	,SUM(NVL(B.DECEMBER_SUPPLY_NUMBER,0)) AS 十二月供货套数
	,SUM(NVL(B.DECEMBER_SELL_AMOUNT,0)) AS 十二月签约金额
	,SUM(NVL(B.DECEMBER_SELL_AREA,0)) AS 十二月签约面积
	,SUM(NVL(B.DECEMBER_SELL_NUMBER,0)) AS 十二月签约套数


FROM
	SWM_SUPPLY_SELL_PLAN A  --ON  A.PROJ_ID=PR.PROJ_ID
    left join (select ID from ( select tmp.*, row_number() over(PARTITION BY project_id order by LPAD (PERIOD_CODE , 6 , '0') desc) as rn from  SWM_SUPPLY_SELL_PLAN  tmp where tmp.APPROVAL_STATUS='已审核' AND IS_DELETED =0 ) where rn = 1) newPlan
    on newPlan.id=A.ID
	LEFT  JOIN SWM_SUPPLY_SELL_PLAN_DTL B ON A.ID=B.SUPPLY_SELL_PLAN_ID
	LEFT JOIN SWM_SUPPLY_SELL_PLAN_DTL C ON C.BIZ_ID=B.BIZ_PARENT_ID  AND  A.ID=C.SUPPLY_SELL_PLAN_ID
	WHERE B.IS_DELETED =0 and  newPlan.id is not null --AND B.SUPPLY_SELL_PLAN_ID='97187e1c-f056-44aa-93fa-7fa9bcb0d813'
	AND A.REMARKS='集团目标迁移'
	AND PERIOD_CODE =(
	SELECT MAX(PERIOD_CODE) FROM SWM_SUPPLY_SELL_PLAN A1 WHERE A.PROJECT_ID=A1.PROJECT_ID AND IS_DELETED=0 AND APPROVAL_STATUS='已审核'
	)
	GROUP BY 
    PROJECT_ID
	,PROJECT_NAME
	,B.BIZ_PARENT_ID 
	,B.OBJ_TYPE
	-- ,B.OBJ_NAME
	-- ,BUILD_PRODUCT_TYPE_NAME
	-- ,ORDER_CODE
	,CASE WHEN  B.OBJ_TYPE='楼栋' THEN 'XXX'  ELSE  B.BIZ_ID  END 
	,CASE WHEN  B.OBJ_TYPE='楼栋' THEN B.BUILD_PRODUCT_TYPE_NAME ELSE  B.OBJ_NAME  END
	,CASE WHEN  B.OBJ_TYPE='楼栋' THEN '99'  ELSE  B.ORDER_CODE  END
	,C.OBJ_NAME,c.BIZ_ID
	,CASE WHEN  B.OBJ_TYPE='楼栋' THEN B.BIZ_PARENT_ID||'_'||B.BUILD_PRODUCT_TYPE_ID ELSE  B.BIZ_ID  END 
	 --ORDER BY  CASE WHEN  B.OBJ_TYPE='楼栋' THEN '99'  ELSE  B.ORDER_CODE END ,C.OBJ_NAME||CASE WHEN  B.OBJ_TYPE='楼栋' THEN B.BUILD_PRODUCT_TYPE_NAME ELSE  B.OBJ_NAME  END 
 ) P1 on A1.OBJ_ID=P1.OBJ_ID --AND P1.PROJECT_ID=A1.PROJ_ID AND P1.OBJ_TYPE=A1.OBJ_TYPE  AND P1.OBJ_NAME=A1.OBJ_NAME  

 
 LEFT JOIN 
 -----------------------------------------------------------------------------------------------------
SWM_SUPPLY_MONITOR_TABLE  P2 ON A1.OBJ_ID=P2.OBJID 
--order by A1.COMPANY_ORDER_HIERARCHY_CODE,A1.ORDER_CODE 


UNION ALL 

select    

a2.ID 
,'公司' "OBJ_TYPE"
,a2.ID AS "OBJ_ID"
,a2.ORG_NAME AS "OBJ_NAME"
,null
,a2.PARENT_ID AS "OBJ_PARENT_ID"
,TO_CHAR(A2.LEVEL_RANK)
,NULL
,A2.ORDER_HIERARCHY_CODE AS  "ORDER_CODE"
,a2.ORG_NAME AS  "COMPANY_NAME"
,a2.ID AS  "COMPANY_ID"
,A2.ORDER_HIERARCHY_CODE  "COMPANY_ORDER_HIERARCHY_CODE"
,a2.ID  AS "id"
, a2.ORG_NAME AS "projConstitute"
,a2.PARENT_ID  AS "parentId"
,a2.ORDER_HIERARCHY_CODE  AS "ORDER_HIERARCHY_CODE"
,a2.ID AS "objId"
,'公司'"objType"
,NULL AS "buildProductTypeName"
,NULL AS "ownBuildProductTypeId"
,NULL AS "buildProductTypeId"
,a1."thisYearSupplyAmount"
,a1."thisYearSupplyNumber"
,a1."thisYearSupplyArea"
,a1."firstSeasonSupplyAmount"
,a1."firstSeasonSupplyNumber"
,a1."firstSeasonSupplyArea"
,a1."januarySupplyAmount"
,a1."januarySupplyNumberx"
,a1."januarySupplyNumber"
,a1."februarySupplyAmount"
,a1."februarySupplyNumber"
,a1."februarySupplyArea"
,a1."marchSupplyAmount"
,a1."marchSupplyNumber"
,a1."marchSupplyArea"
,a1."secondSeasonSupplyAmount"
,a1."secondSeasonSupplyNumber"
,a1."secondSeasonSupplyArea"
,a1."aprilSupplyAmount"
,a1."aprilSupplyNumber"
,a1."aprilSupplyArea"
,a1."maySupplyAmount"
,a1."maySupplyNumber"
,a1."maySupplyArea"
,a1."juneSupplyAmount"
,a1."juneSupplyNumber"
,a1."juneSupplyArea"
,a1."thirdSeasonSupplyAmount"
,a1."thirdSeasonSupplyNumber"
,a1."thirdSeasonSupplyArea"
,a1."julySupplyAmount"
,a1."julySupplyNumber"
,a1."julySupplyArea"
,a1."augustSupplyAmount"
,a1."augustSupplyNumber"
,a1."augustSupplyArea"
,a1."septemberSupplyAmount"
,a1."septemberSupplyNumber"
,a1."septemberSupplyArea"
,a1."fourthSeasonSupplyAmount"
,a1."fourthSeasonSupplyNumber"
,a1."fourthSeasonSupplyArea"
,a1."octoberSupplyAmount"
,a1."octoberSupplyNumber"
,a1."octoberSupplyArea"
,a1."novemberSupplyAmount"
,a1."novemberSupplyNumber"
,a1."novemberSupplyArea"
,a1."decemberSupplyAmount"
,a1."decemberSupplyNumber"
,a1."decemberSupplyArea"


,"thisYearSellPlannedAmount"--金额（年计划销售）
,"thisYearSellPlannedNumber"--套数（年计划销售）
,"thisYearSellPlannedArea"--面积（年计划销售）
,"firstSeonSellPlannedAmount"--金额（1季度计划销售）
,"firstSeonSellPlannedNumber"--套数（1季度计划销售）
,"firstSeonSellPlannedArea"--面积（1季度计划销售）
,"secondSeonSellPlannedAmount"--金额（2季度计划销售）
,"secondSeonSellPlannedNumber"--套数（2季度计划销售）
,"secondSeonSellPlannedArea"--面积（2季度计划销售）
,"thirdSeonSellPlannedAmount"--金额（3季度计划销售）
,"thirdSeonSellPlannedNumber"--套数（3季度计划销售）
,"thirdSeonSellPlannedArea"--面积（3季度计划销售）
,"fourthSeonSellPlannedAmount"--金额（4季度计划销售）
,"fourthSeonSellPlannedNumber"--套数（4季度计划销售）
,"fourthSeonSellPlannedArea"--面积（4季度计划销售）
,"januarySellPlannedAmount"--金额（1月计划销售）
,"januarySellPlannedNumber"--套数（1月计划销售）
,"januarySellPlannedArea"--面积（1月计划销售）
,"februarySellPlannedAmount"--金额（2月计划销售）
,"februarySellPlannedNumber"--套数（2月计划销售）
,"februarySellPlannedArea"--面积（2月计划销售）
,"marchSellPlannedAmount"--金额（3月计划销售）
,"marchSellPlannedNumber"--套数（3月计划销售）
,"marchSellPlannedArea"--面积（3月计划销售）
,"aprilSellPlannedAmount"--金额（4月计划销售）
,"aprilSellPlannedNumber"--套数（4月计划销售）
,"aprilSellPlannedArea"--面积（4月计划销售）
,"maySellPlannedAmount"--金额（5月计划销售）
,"maySellPlannedNumber"--套数（5月计划销售）
,"maySellPlannedArea"--面积（5月计划销售）
,"juneSellPlannedAmount"--金额（6月计划销售）
,"juneSellPlannedNumber"--套数（6月计划销售）
,"juneSellPlannedArea"--面积（6月计划销售）
,"julySellPlannedAmount"--金额（7月计划销售）
,"julySellPlannedNumber"--套数（7月计划销售）
,"julySellPlannedArea"--面积（7月计划销售）
,"augustSellPlannedAmount"--金额（8月计划销售）
,"augustSellPlannedNumber"--套数（8月计划销售）
,"augustSellPlannedArea"--面积（8月计划销售）
,"septemberSellPlannedAmount"--金额（10月计划销售）
,"septemberSellPlannedNumber"--套数（10月计划销售）
,"septemberSellPlannedArea"--面积（10月计划销售）
,"octoberSellPlannedAmount"--金额（10月计划销售）
,"octoberSellPlannedNumber"--套数（10月计划销售）
,"octoberSellPlannedArea"--面积（10月计划销售）
,"novemberSellPlannedAmount"--金额（11月计划销售）
,"novemberSellPlannedNumber"--套数（11月计划销售）
,"novemberSellPlannedArea"--面积（11月计划销售）
,"decemberSellPlannedAmount"--金额（12月计划销售）
,"decemberSellPlannedNumber"--套数（12月计划销售）
,"decemberSellPlannedArea"--面积（12月计划销售）



,TO_CHAR(a2."LEVEL_RANK")
,a1."poTotalSaleCount"
,a1."poTotalSaleArea"
,a1."poTotalSaleAmount"
,a1."rpTotalArea"
,a1."rpTotalAmount"
,a1."rpTotalCount"
,a1."poSaleArea"
,a1."poSaleAmount"
,a1."poSaleCount"
,a1."rpSurplusArea"
,a1."rpSurplusAmount"
,a1."rpSurplusCount"
,a1."poSurplusSaleAmount"
,a1."poSurplusSaleArea"
,a1."poSurplusSaleCount"
,a1."thisYearActualSupplyArea"
,a1."thisYearActualSupplyNumber"
,a1."thisYearActualSupplyAmount"
,a1."firstSeasonActualSupplyArea"
,a1."firstSeasonActualSupplyNumber"
,a1."firstSeasonActualSupplyAmount"
,a1."secondSeasonActualSupplyArea"
,a1."secondSeasonActualSupplyNumber"
,a1."secondSeasonActualSupplyAmount"
,a1."thirdSeasonActualSupplyArea"
,a1."thirdSeasonActualSupplyNumber"
,a1."thirdSeasonActualSupplyAmount"
,a1."fourthSeasonActualSupplyArea"
,a1."fourthSeasonActualSupplyNumber"
,a1."fourthSeasonActualSupplyAmount"
,a1."januaryActualSupplyArea"
,a1."januaryActualSupplyNumber"
,a1."januaryActualSupplyAmount"
,a1."februaryActualSupplyArea"
,a1."februaryActualSupplyNumber"
,a1."februaryActualSupplyAmount"
,a1."marchActualSupplyArea"
,a1."marchActualSupplyNumber"
,a1."marchActualSupplyAmount"
,a1."aprilActualSupplyArea"
,a1."aprilActualSupplyNumber"
,a1."aprilActualSupplyAmount"
,a1."mayActualSupplyArea"
,a1."mayActualSupplyNumber"
,a1."mayActualSupplyAmount"
,a1."juneActualSupplyArea"
,a1."juneActualSupplyNumber"
,a1."juneActualSupplyAmount"
,a1."julyActualSupplyArea"
,a1."julyActualSupplyNumber"
,a1."julyActualSupplyAmount"
,a1."augustActualSupplyArea"
,a1."augustActualSupplyNumber"
,a1."augustActualSupplyAmount"
,a1."septemberActualSupplyArea"
,a1."septemberActualSupplyNumber"
,a1."septemberActualSupplyAmount"
,a1."octoberActualSupplyArea"
,a1."octoberActualSupplyNumber"
,a1."octoberActualSupplyAmount"
,a1."novemberActualSupplyArea"
,a1."novemberActualSupplyNumber"
,a1."novemberActualSupplyAmount"
,a1."decemberActualSupplyArea"
,a1."decemberActualSupplyNumber"
,a1."decemberActualSupplyAmount"
,a1."thisYearSellArea"
,a1."thisYearSellNumber"
,a1."thisYearSellAmount"
,a1."firstSellArea"
,a1."firstSellNumber"
,a1."firstSellAmount"
,a1."secondSeasonSellArea"
,a1."secondSeasonSellNumber"
,a1."secondSeasonSellAmount"
,a1."thirdSeasonSellArea"
,a1."thirdSeasonSellNumber"
,a1."thirdSeasonSellAmount"
,a1."fourthSeasonSellArea"
,a1."fourthSeasonSellNumber"
,a1."fourthSeasonSellAmount"
,a1."januarySellArea"
,a1."januarySellNumber"
,a1."januarySellAmount"
,a1."februarySellArea"
,a1."februarySellNumber"
,a1."februarySellAmount"
,a1."marchSellArea"
,a1."marchSellNumber"
,a1."marchSellAmount"
,a1."aprilSellArea"
,a1."aprilSellNumber"
,a1."aprilSellAmount"
,a1."maySellArea"
,a1."maySellNumber"
,a1."maySellAmount"
,a1."juneSellArea"
,a1."juneSellNumber"
,a1."juneSellAmount"
,a1."julySellArea"
,a1."julySellNumber"
,a1."julySellAmount"
,a1."augustSellArea"
,a1."augustSellNumber"
,a1."augustSellAmount"
,a1."septemberSellArea"
,a1."septemberSellNumber"
,a1."septemberSellAmount"
,a1."octoberSellArea"
,a1."octoberSellNumber"
,a1."octoberSellAmount"
,a1."novemberSellArea"
,a1."novemberSellNumber"
,a1."novemberSellAmount"
,a1."decemberSellArea"
,a1."decemberSellNumber"
,a1."decemberSellAmount"

from  LIST_SWM_SUPPLY_MONITOR 
a1 INNER JOIN　SYS_BUSINESS_UNIT a2 on a1.OBJ_PARENT_ID=a2.id 

		where is_company=1 
		--and a2.PARENT_ID=''||unitid||''


)

SELECT 




"PROJ_ID"
,"OBJ_TYPE"
,"OBJ_ID"
,"OBJ_NAME"
,"OBJ_PARENT_ID"
,"LEVEL"
,"LEVEL_ORDER"
,"ORDER_CODE"
,"COMPANY_NAME"
,"COMPANY_ID"
,"COMPANY_ORDER_HIERARCHY_CODE"
,"id"
,"projConstitute"
,"parentId"
,"ORDER_HIERARCHY_CODE"
,"objId"
,"objType"
,"buildProductTypeName"
,"ownBuildProductTypeId"
,"buildProductTypeId"
,SUM(NVL("thisYearSupplyAmount",0)) AS "thisYearSupplyAmount"
,SUM(NVL("thisYearSupplyNumber",0)) AS "thisYearSupplyNumber"
,SUM(NVL("thisYearSupplyArea",0)) AS "thisYearSupplyArea"
,SUM(NVL("firstSeasonSupplyAmount",0)) AS "firstSeasonSupplyAmount"
,SUM(NVL("firstSeasonSupplyNumber",0)) AS "firstSeasonSupplyNumber"
,SUM(NVL("firstSeasonSupplyArea",0)) AS "firstSeasonSupplyArea"
,SUM(NVL("januarySupplyAmount",0)) AS "januarySupplyAmount"
,SUM(NVL("januarySupplyNumberx",0)) AS "januarySupplyNumberx"
,SUM(NVL("januarySupplyNumber",0)) AS "januarySupplyNumber"
,SUM(NVL("februarySupplyAmount",0)) AS "februarySupplyAmount"
,SUM(NVL("februarySupplyNumber",0)) AS "februarySupplyNumber"
,SUM(NVL("februarySupplyArea",0)) AS "februarySupplyArea"
,SUM(NVL("marchSupplyAmount",0)) AS "marchSupplyAmount"
,SUM(NVL("marchSupplyNumber",0)) AS "marchSupplyNumber"
,SUM(NVL("marchSupplyArea",0)) AS "marchSupplyArea"
,SUM(NVL("secondSeasonSupplyAmount",0)) AS "secondSeasonSupplyAmount"
,SUM(NVL("secondSeasonSupplyNumber",0)) AS "secondSeasonSupplyNumber"
,SUM(NVL("secondSeasonSupplyArea",0)) AS "secondSeasonSupplyArea"
,SUM(NVL("aprilSupplyAmount",0)) AS "aprilSupplyAmount"
,SUM(NVL("aprilSupplyNumber",0)) AS "aprilSupplyNumber"
,SUM(NVL("aprilSupplyArea",0)) AS "aprilSupplyArea"
,SUM(NVL("maySupplyAmount",0)) AS "maySupplyAmount"
,SUM(NVL("maySupplyNumber",0)) AS "maySupplyNumber"
,SUM(NVL("maySupplyArea",0)) AS "maySupplyArea"
,SUM(NVL("juneSupplyAmount",0)) AS "juneSupplyAmount"
,SUM(NVL("juneSupplyNumber",0)) AS "juneSupplyNumber"
,SUM(NVL("juneSupplyArea",0)) AS "juneSupplyArea"
,SUM(NVL("thirdSeasonSupplyAmount",0)) AS "thirdSeasonSupplyAmount"
,SUM(NVL("thirdSeasonSupplyNumber",0)) AS "thirdSeasonSupplyNumber"
,SUM(NVL("thirdSeasonSupplyArea",0)) AS "thirdSeasonSupplyArea"
,SUM(NVL("julySupplyAmount",0)) AS "julySupplyAmount"
,SUM(NVL("julySupplyNumber",0)) AS "julySupplyNumber"
,SUM(NVL("julySupplyArea",0)) AS "julySupplyArea"
,SUM(NVL("augustSupplyAmount",0)) AS "augustSupplyAmount"
,SUM(NVL("augustSupplyNumber",0)) AS "augustSupplyNumber"
,SUM(NVL("augustSupplyArea",0)) AS "augustSupplyArea"
,SUM(NVL("septemberSupplyAmount",0)) AS "septemberSupplyAmount"
,SUM(NVL("septemberSupplyNumber",0)) AS "septemberSupplyNumber"
,SUM(NVL("septemberSupplyArea",0)) AS "septemberSupplyArea"
,SUM(NVL("fourthSeasonSupplyAmount",0)) AS "fourthSeasonSupplyAmount"
,SUM(NVL("fourthSeasonSupplyNumber",0)) AS "fourthSeasonSupplyNumber"
,SUM(NVL("fourthSeasonSupplyArea",0)) AS "fourthSeasonSupplyArea"
,SUM(NVL("octoberSupplyAmount",0)) AS "octoberSupplyAmount"
,SUM(NVL("octoberSupplyNumber",0)) AS "octoberSupplyNumber"
,SUM(NVL("octoberSupplyArea",0)) AS "octoberSupplyArea"
,SUM(NVL("novemberSupplyAmount",0)) AS "novemberSupplyAmount"
,SUM(NVL("novemberSupplyNumber",0)) AS "novemberSupplyNumber"
,SUM(NVL("novemberSupplyArea",0)) AS "novemberSupplyArea"
,SUM(NVL("decemberSupplyAmount",0)) AS "decemberSupplyAmount"
,SUM(NVL("decemberSupplyNumber",0)) AS "decemberSupplyNumber"
,SUM(NVL("decemberSupplyArea",0)) AS "decemberSupplyArea"
,SUM(NVL("poTotalSaleCount",0)) AS "poTotalSaleCount"
,SUM(NVL("poTotalSaleArea",0)) AS "poTotalSaleArea"
,SUM(NVL("poTotalSaleAmount",0)) AS "poTotalSaleAmount"
,SUM(NVL("rpTotalArea",0)) AS "rpTotalArea"
,SUM(NVL("rpTotalAmount",0)) AS "rpTotalAmount"
,SUM(NVL("rpTotalCount",0)) AS "rpTotalCount"
,SUM(NVL("poSaleArea",0)) AS "poSaleArea"
,SUM(NVL("poSaleAmount",0)) AS "poSaleAmount"
,SUM(NVL("poSaleCount",0)) AS "poSaleCount"
,SUM(NVL("rpSurplusArea",0)) AS "rpSurplusArea"
,SUM(NVL("rpSurplusAmount",0)) AS "rpSurplusAmount"
,SUM(NVL("rpSurplusCount",0)) AS "rpSurplusCount"
,SUM(NVL("poSurplusSaleAmount",0)) AS "poSurplusSaleAmount"
,SUM(NVL("poSurplusSaleArea",0)) AS "poSurplusSaleArea"
,SUM(NVL("poSurplusSaleCount",0)) AS "poSurplusSaleCount"
,SUM(NVL("thisYearActualSupplyArea",0)) AS "thisYearActualSupplyArea"
,SUM(NVL("thisYearActualSupplyNumber",0)) AS "thisYearActualSupplyNumber"
,SUM(NVL("thisYearActualSupplyAmount",0)) AS "thisYearActualSupplyAmount"
,SUM(NVL("firstSeasonActualSupplyArea",0)) AS "firstSeasonActualSupplyArea"
,SUM(NVL("firstSeasonActualSupplyNumber",0)) AS "firstSeasonActualSupplyNumber"
,SUM(NVL("firstSeasonActualSupplyAmount",0)) AS "firstSeasonActualSupplyAmount"
,SUM(NVL("secondSeasonActualSupplyArea",0)) AS "secondSeasonActualSupplyArea"
,SUM(NVL("secondSeasonActualSupplyNumber",0)) AS "secondSeasonActualSupplyNumber"
,SUM(NVL("secondSeasonActualSupplyAmount",0)) AS "secondSeasonActualSupplyAmount"
,SUM(NVL("thirdSeasonActualSupplyArea",0)) AS "thirdSeasonActualSupplyArea"
,SUM(NVL("thirdSeasonActualSupplyNumber",0)) AS "thirdSeasonActualSupplyNumber"
,SUM(NVL("thirdSeasonActualSupplyAmount",0)) AS "thirdSeasonActualSupplyAmount"
,SUM(NVL("fourthSeasonActualSupplyArea",0)) AS "fourthSeasonActualSupplyArea"
,SUM(NVL("fourthSeasonActualSupplyNumber",0)) AS "fourthSeasonActualSupplyNumber"
,SUM(NVL("fourthSeasonActualSupplyAmount",0)) AS "fourthSeasonActualSupplyAmount"
,SUM(NVL("januaryActualSupplyArea",0)) AS "januaryActualSupplyArea"
,SUM(NVL("januaryActualSupplyNumber",0)) AS "januaryActualSupplyNumber"
,SUM(NVL("januaryActualSupplyAmount",0)) AS "januaryActualSupplyAmount"
,SUM(NVL("februaryActualSupplyArea",0)) AS "februaryActualSupplyArea"
,SUM(NVL("februaryActualSupplyNumber",0)) AS "februaryActualSupplyNumber"
,SUM(NVL("februaryActualSupplyAmount",0)) AS "februaryActualSupplyAmount"
,SUM(NVL("marchActualSupplyArea",0)) AS "marchActualSupplyArea"
,SUM(NVL("marchActualSupplyNumber",0)) AS "marchActualSupplyNumber"
,SUM(NVL("marchActualSupplyAmount",0)) AS "marchActualSupplyAmount"
,SUM(NVL("aprilActualSupplyArea",0)) AS "aprilActualSupplyArea"
,SUM(NVL("aprilActualSupplyNumber",0)) AS "aprilActualSupplyNumber"
,SUM(NVL("aprilActualSupplyAmount",0)) AS "aprilActualSupplyAmount"
,SUM(NVL("mayActualSupplyArea",0)) AS "mayActualSupplyArea"
,SUM(NVL("mayActualSupplyNumber",0)) AS "mayActualSupplyNumber"
,SUM(NVL("mayActualSupplyAmount",0)) AS "mayActualSupplyAmount"
,SUM(NVL("juneActualSupplyArea",0)) AS "juneActualSupplyArea"
,SUM(NVL("juneActualSupplyNumber",0)) AS "juneActualSupplyNumber"
,SUM(NVL("juneActualSupplyAmount",0)) AS "juneActualSupplyAmount"
,SUM(NVL("julyActualSupplyArea",0)) AS "julyActualSupplyArea"
,SUM(NVL("julyActualSupplyNumber",0)) AS "julyActualSupplyNumber"
,SUM(NVL("julyActualSupplyAmount",0)) AS "julyActualSupplyAmount"
,SUM(NVL("augustActualSupplyArea",0)) AS "augustActualSupplyArea"
,SUM(NVL("augustActualSupplyNumber",0)) AS "augustActualSupplyNumber"
,SUM(NVL("augustActualSupplyAmount",0)) AS "augustActualSupplyAmount"
,SUM(NVL("septemberActualSupplyArea",0)) AS "septemberActualSupplyArea"
,SUM(NVL("septemberActualSupplyNumber",0)) AS "septemberActualSupplyNumber"
,SUM(NVL("septemberActualSupplyAmount",0)) AS "septemberActualSupplyAmount"
,SUM(NVL("octoberActualSupplyArea",0)) AS "octoberActualSupplyArea"
,SUM(NVL("octoberActualSupplyNumber",0)) AS "octoberActualSupplyNumber"
,SUM(NVL("octoberActualSupplyAmount",0)) AS "octoberActualSupplyAmount"
,SUM(NVL("novemberActualSupplyArea",0)) AS "novemberActualSupplyArea"
,SUM(NVL("novemberActualSupplyNumber",0)) AS "novemberActualSupplyNumber"
,SUM(NVL("novemberActualSupplyAmount",0)) AS "novemberActualSupplyAmount"
,SUM(NVL("decemberActualSupplyArea",0)) AS "decemberActualSupplyArea"
,SUM(NVL("decemberActualSupplyNumber",0)) AS "decemberActualSupplyNumber"
,SUM(NVL("decemberActualSupplyAmount",0)) AS "decemberActualSupplyAmount"
,SUM(NVL("thisYearSellArea",0)) AS "thisYearSellArea"
,SUM(NVL("thisYearSellNumber",0)) AS "thisYearSellNumber"
,SUM(NVL("thisYearSellAmount",0)) AS "thisYearSellAmount"
,SUM(NVL("firstSellArea",0)) AS "firstSellArea"
,SUM(NVL("firstSellNumber",0)) AS "firstSellNumber"
,SUM(NVL("firstSellAmount",0)) AS "firstSellAmount"
,SUM(NVL("secondSeasonSellArea",0)) AS "secondSeasonSellArea"
,SUM(NVL("secondSeasonSellNumber",0)) AS "secondSeasonSellNumber"
,SUM(NVL("secondSeasonSellAmount",0)) AS "secondSeasonSellAmount"
,SUM(NVL("thirdSeasonSellArea",0)) AS "thirdSeasonSellArea"
,SUM(NVL("thirdSeasonSellNumber",0)) AS "thirdSeasonSellNumber"
,SUM(NVL("thirdSeasonSellAmount",0)) AS "thirdSeasonSellAmount"
,SUM(NVL("fourthSeasonSellArea",0)) AS "fourthSeasonSellArea"
,SUM(NVL("fourthSeasonSellNumber",0)) AS "fourthSeasonSellNumber"
,SUM(NVL("fourthSeasonSellAmount",0)) AS "fourthSeasonSellAmount"
,SUM(NVL("januarySellArea",0)) AS "januarySellArea"
,SUM(NVL("januarySellNumber",0)) AS "januarySellNumber"
,SUM(NVL("januarySellAmount",0)) AS "januarySellAmount"
,SUM(NVL("februarySellArea",0)) AS "februarySellArea"
,SUM(NVL("februarySellNumber",0)) AS "februarySellNumber"
,SUM(NVL("februarySellAmount",0)) AS "februarySellAmount"
,SUM(NVL("marchSellArea",0)) AS "marchSellArea"
,SUM(NVL("marchSellNumber",0)) AS "marchSellNumber"
,SUM(NVL("marchSellAmount",0)) AS "marchSellAmount"
,SUM(NVL("aprilSellArea",0)) AS "aprilSellArea"
,SUM(NVL("aprilSellNumber",0)) AS "aprilSellNumber"
,SUM(NVL("aprilSellAmount",0)) AS "aprilSellAmount"
,SUM(NVL("maySellArea",0)) AS "maySellArea"
,SUM(NVL("maySellNumber",0)) AS "maySellNumber"
,SUM(NVL("maySellAmount",0)) AS "maySellAmount"
,SUM(NVL("juneSellArea",0)) AS "juneSellArea"
,SUM(NVL("juneSellNumber",0)) AS "juneSellNumber"
,SUM(NVL("juneSellAmount",0)) AS "juneSellAmount"
,SUM(NVL("julySellArea",0)) AS "julySellArea"
,SUM(NVL("julySellNumber",0)) AS "julySellNumber"
,SUM(NVL("julySellAmount",0)) AS "julySellAmount"
,SUM(NVL("augustSellArea",0)) AS "augustSellArea"
,SUM(NVL("augustSellNumber",0)) AS "augustSellNumber"
,SUM(NVL("augustSellAmount",0)) AS "augustSellAmount"
,SUM(NVL("septemberSellArea",0)) AS "septemberSellArea"
,SUM(NVL("septemberSellNumber",0)) AS "septemberSellNumber"
,SUM(NVL("septemberSellAmount",0)) AS "septemberSellAmount"
,SUM(NVL("octoberSellArea",0)) AS "octoberSellArea"
,SUM(NVL("octoberSellNumber",0)) AS "octoberSellNumber"
,SUM(NVL("octoberSellAmount",0)) AS "octoberSellAmount"
,SUM(NVL("novemberSellArea",0)) AS "novemberSellArea"
,SUM(NVL("novemberSellNumber",0)) AS "novemberSellNumber"
,SUM(NVL("novemberSellAmount",0)) AS "novemberSellAmount"
,SUM(NVL("decemberSellArea",0)) AS "decemberSellArea"
,SUM(NVL("decemberSellNumber",0)) AS "decemberSellNumber"
,SUM(NVL("decemberSellAmount",0)) AS "decemberSellAmount"
,SUM(NVL("thisYearSellPlannedAmount",0))  AS "thisYearSellPlannedAmount"--金额（年计划销售）
,SUM(NVL("thisYearSellPlannedNumber",0))  AS "thisYearSellPlannedNumber"--套数（年计划销售）
,SUM(NVL("thisYearSellPlannedArea",0))  AS "thisYearSellPlannedArea"--面积（年计划销售）
,SUM(NVL("firstSeonSellPlannedAmount",0))  AS "firstSeonSellPlannedAmount"--金额（1季度计划销售）
,SUM(NVL("firstSeonSellPlannedNumber",0))  AS "firstSeonSellPlannedNumber"--套数（1季度计划销售）
,SUM(NVL("firstSeonSellPlannedArea",0))  AS "firstSeonSellPlannedArea"--面积（1季度计划销售）
,SUM(NVL("secondSeonSellPlannedAmount",0))  AS "secondSeonSellPlannedAmount"--金额（2季度计划销售）
,SUM(NVL("secondSeonSellPlannedNumber",0))  AS "secondSeonSellPlannedNumber"--套数（2季度计划销售）
,SUM(NVL("secondSeonSellPlannedArea",0))  AS "secondSeonSellPlannedArea"--面积（2季度计划销售）
,SUM(NVL("thirdSeonSellPlannedAmount",0))  AS "thirdSeonSellPlannedAmount"--金额（3季度计划销售）
,SUM(NVL("thirdSeonSellPlannedNumber",0))  AS "thirdSeonSellPlannedNumber"--套数（3季度计划销售）
,SUM(NVL("thirdSeonSellPlannedArea",0))  AS "thirdSeonSellPlannedArea"--面积（3季度计划销售）
,SUM(NVL("fourthSeonSellPlannedAmount",0))  AS "fourthSeonSellPlannedAmount"--金额（4季度计划销售）
,SUM(NVL("fourthSeonSellPlannedNumber",0))  AS "fourthSeonSellPlannedNumber"--套数（4季度计划销售）
,SUM(NVL("fourthSeonSellPlannedArea",0))  AS "fourthSeonSellPlannedArea"--面积（4季度计划销售）
,SUM(NVL("januarySellPlannedAmount",0))  AS "januarySellPlannedAmount"--金额（1月计划销售）
,SUM(NVL("januarySellPlannedNumber",0))  AS "januarySellPlannedNumber"--套数（1月计划销售）
,SUM(NVL("januarySellPlannedArea",0))  AS "januarySellPlannedArea"--面积（1月计划销售）
,SUM(NVL("februarySellPlannedAmount",0))  AS "februarySellPlannedAmount"--金额（2月计划销售）
,SUM(NVL("februarySellPlannedNumber",0))  AS "februarySellPlannedNumber"--套数（2月计划销售）
,SUM(NVL("februarySellPlannedArea",0))  AS "februarySellPlannedArea"--面积（2月计划销售）
,SUM(NVL("marchSellPlannedAmount",0))  AS "marchSellPlannedAmount"--金额（3月计划销售）
,SUM(NVL("marchSellPlannedNumber",0))  AS "marchSellPlannedNumber"--套数（3月计划销售）
,SUM(NVL("marchSellPlannedArea",0))  AS "marchSellPlannedArea"--面积（3月计划销售）
,SUM(NVL("aprilSellPlannedAmount",0))  AS "aprilSellPlannedAmount"--金额（4月计划销售）
,SUM(NVL("aprilSellPlannedNumber",0))  AS "aprilSellPlannedNumber"--套数（4月计划销售）
,SUM(NVL("aprilSellPlannedArea",0))  AS "aprilSellPlannedArea"--面积（4月计划销售）
,SUM(NVL("maySellPlannedAmount",0))  AS "maySellPlannedAmount"--金额（5月计划销售）
,SUM(NVL("maySellPlannedNumber",0))  AS "maySellPlannedNumber"--套数（5月计划销售）
,SUM(NVL("maySellPlannedArea",0))  AS "maySellPlannedArea"--面积（5月计划销售）
,SUM(NVL("juneSellPlannedAmount",0))  AS "juneSellPlannedAmount"--金额（6月计划销售）
,SUM(NVL("juneSellPlannedNumber",0))  AS "juneSellPlannedNumber"--套数（6月计划销售）
,SUM(NVL("juneSellPlannedArea",0))  AS "juneSellPlannedArea"--面积（6月计划销售）
,SUM(NVL("julySellPlannedAmount",0))  AS "julySellPlannedAmount"--金额（7月计划销售）
,SUM(NVL("julySellPlannedNumber",0))  AS "julySellPlannedNumber"--套数（7月计划销售）
,SUM(NVL("julySellPlannedArea",0))  AS "julySellPlannedArea"--面积（7月计划销售）
,SUM(NVL("augustSellPlannedAmount",0))  AS "augustSellPlannedAmount"--金额（8月计划销售）
,SUM(NVL("augustSellPlannedNumber",0))  AS "augustSellPlannedNumber"--套数（8月计划销售）
,SUM(NVL("augustSellPlannedArea",0))  AS "augustSellPlannedArea"--面积（8月计划销售）
,SUM(NVL("septemberSellPlannedAmount",0))  AS "septemberSellPlannedAmount"--金额（10月计划销售）
,SUM(NVL("septemberSellPlannedNumber",0))  AS "septemberSellPlannedNumber"--套数（10月计划销售）
,SUM(NVL("septemberSellPlannedArea",0))  AS "septemberSellPlannedArea"--面积（10月计划销售）
,SUM(NVL("octoberSellPlannedAmount",0))  AS "octoberSellPlannedAmount"--金额（10月计划销售）
,SUM(NVL("octoberSellPlannedNumber",0))  AS "octoberSellPlannedNumber"--套数（10月计划销售）
,SUM(NVL("octoberSellPlannedArea",0))  AS "octoberSellPlannedArea"--面积（10月计划销售）
,SUM(NVL("novemberSellPlannedAmount",0))  AS "novemberSellPlannedAmount"--金额（11月计划销售）
,SUM(NVL("novemberSellPlannedNumber",0))  AS "novemberSellPlannedNumber"--套数（11月计划销售）
,SUM(NVL("novemberSellPlannedArea",0))  AS "novemberSellPlannedArea"--面积（11月计划销售）
,SUM(NVL("decemberSellPlannedAmount",0))  AS "decemberSellPlannedAmount"--金额（12月计划销售）
,SUM(NVL("decemberSellPlannedNumber",0))  AS "decemberSellPlannedNumber"--套数（12月计划销售）
,SUM(NVL("decemberSellPlannedArea",0))  AS "decemberSellPlannedArea"--面积（12月计划销售）


 FROM  LIST_SWM_SUPPLY_MONITOR LIST
		 --WHERE "thisYearSupplyAmount">0



 GROUP BY "PROJ_ID"
,"OBJ_TYPE"
,"OBJ_ID"
,"OBJ_NAME"
,"OBJ_PARENT_ID"
,"LEVEL"
,"LEVEL_ORDER"
,"ORDER_CODE"
,"COMPANY_NAME"
,"COMPANY_ID"
,"COMPANY_ORDER_HIERARCHY_CODE"
,"id"
,"projConstitute"
,"parentId"
,"ORDER_HIERARCHY_CODE"
,"objId"
,"objType"
,"buildProductTypeName"
,"ownBuildProductTypeId"
,"buildProductTypeId"
 ORDER BY "COMPANY_ORDER_HIERARCHY_CODE","ORDER_CODE"
 ;

 END  P_SWM_SUPPLY_MONITOR_INI_LIST;

/
--------------------------------------------------------
--  DDL for Procedure P_SWM_SUPPLY_MONTH
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SWM_SUPPLY_MONTH" ( supplyPlanId IN VARCHAR2, monthDtl OUT sys_refcursor ) 
AS 
  nostagingID VARCHAR2 ( 200 );-- 无分期id
  nostagingCount INTEGER;--无分期数量
  projectId varchar2(36);--项目id
  inventoryId varchar2(36);
  rowcnt number;
BEGIN-- 查询条数
  SELECT
    count( * ) INTO nostagingCount 
  FROM
    SWM_SUPPLY_PLAN_DTL 
  WHERE
    OBJ_TYPE = '无分期' 
    AND SUPPLY_NODE_PLAN_ID = supplyPlanId;
  IF
    nostagingCount > 0 THEN-- 查询无分期的id
    SELECT
      BIZ_ID INTO nostagingID 
    FROM
      SWM_SUPPLY_PLAN_DTL 
    WHERE
      OBJ_TYPE = '无分期' 
      AND SUPPLY_NODE_PLAN_ID = supplyPlanId;
  END IF;      

  select 
    project_id into projectId 
  from 
    swm_supply_node_plan 
  where 
    id = supplyPlanId;


    select count(1) into rowcnt from swm_value_inventory 
    where project_id = projectId
    order by created desc;

    if rowcnt<>0 then

  select ID into inventoryId from (
    select ID from swm_value_inventory 
    where project_id = projectId
    order by created desc) 
  where rownum = 1;

  open monthDtl FOR SELECT
  md.ID,
  md.OBJ_NAME,
  md.ID AS SUPPLY_MONTH_DETAIL_ID,
  md.BUILD_PRODUCT_TYPE_NAME,
  inved.PO_TOTAL_SALE_AREA,
  inved.PO_TOTAL_SALE_COUNT,
  inved.PO_TOTAL_SALE_AMOUNT,
  inved.PO_SURPLUS_SALE_AREA,
  inved.PO_SURPLUS_SALE_COUNT,
  inved.PO_SURPLUS_SALE_AMOUNT,
  inved.RP_TOTAL_AREA,
  inved.RP_TOTAL_COUNT,
  inved.RP_TOTAL_AMOUNT,
  inved.PO_SALE_AREA,
  inved.PO_SALE_COUNT,
  inved.PO_SALE_AMOUNT,
  inved.RP_SURPLUS_AREA,
  inved.RP_SURPLUS_COUNT,
  inved.RP_SURPLUS_AMOUNT,
  SUPPLY_TOTAL_AREA,
  SUPPLY_TOTAL_NUMBER,
  SUPPLY_TOTAL_AMOUNT,
  0 AS SELL_TOTAL_AREA,
  0 AS SELL_TOTAL_NUMBER,
  0 AS SELL_TOTAL_AMOUNT,
  md.JANUARY_SUPPLY_AREA,
  md.JANUARY_SUPPLY_NUMBER,
  md.JANUARY_SUPPLY_AMOUNT,
  0 AS JANUARY_SELL_AREA,
  0 AS JANUARY_SELL_NUMBER,
  0 AS JANUARY_SELL_AMOUNT,
  md.FEBRUARY_SUPPLY_AREA,
  md.FEBRUARY_SUPPLY_NUMBER,
  md.FEBRUARY_SUPPLY_AMOUNT,
  0 AS FEBRUARY_SELL_AREA,
  0 AS FEBRUARY_SELL_NUMBER,
  0 AS FEBRUARY_SELL_AMOUNT,
  md.MARCH_SUPPLY_AREA,
  md.MARCH_SUPPLY_NUMBER,
  md.MARCH_SUPPLY_AMOUNT,
  0 AS MARCH_SELL_AREA,
  0 AS MARCH_SELL_NUMBER,
  0 AS MARCH_SELL_AMOUNT,
  md.APRIL_SUPPLY_AREA,
  md.APRIL_SUPPLY_NUMBER,
  md.APRIL_SUPPLY_AMOUNT,
  0 AS APRIL_SELL_AREA,
  0 AS APRIL_SELL_NUMBER,
  0 AS APRIL_SELL_AMOUNT,
  md.MAY_SUPPLY_AREA,
  md.MAY_SUPPLY_NUMBER,
  md.MAY_SUPPLY_AMOUNT,
  0 AS MAY_SELL_AREA,
  0 AS MAY_SELL_NUMBER,
  0 AS MAY_SELL_AMOUNT,
  md.JUNE_SUPPLY_AREA,
  md.JUNE_SUPPLY_NUMBER,
  md.JUNE_SUPPLY_AMOUNT,
  0 AS JUNE_SELL_AREA,
  0 AS JUNE_SELL_NUMBER,
  0 AS JUNE_SELL_AMOUNT,
  md.JULY_SUPPLY_AREA,
  md.JULY_SUPPLY_NUMBER,
  md.JULY_SUPPLY_AMOUNT,
  0 AS JULY_SELL_AREA,
  0 AS JULY_SELL_NUMBER,
  0 AS JULY_SELL_AMOUNT,
  md.AUGUST_SUPPLY_AREA,
  md.AUGUST_SUPPLY_NUMBER,
  md.AUGUST_SUPPLY_AMOUNT,
  0 AS AUGUST_SELL_AREA,
  0 AS AUGUST_SELL_NUMBER,
  0 AS AUGUST_SELL_AMOUNT,
  md.SEPTEMBER_SUPPLY_AREA,
  md.SEPTEMBER_SUPPLY_NUMBER,
  md.SEPTEMBER_SUPPLY_AMOUNT,
  0 AS SEPTEMBER_SELL_AREA,
  0 AS SEPTEMBER_SELL_NUMBER,
  0 AS SEPTEMBER_SELL_AMOUNT,
  md.OCTOBER_SUPPLY_AREA,
  md.OCTOBER_SUPPLY_NUMBER,
  md.OCTOBER_SUPPLY_AMOUNT,
  0 AS OCTOBER_SELL_AREA,
  0 AS OCTOBER_SELL_NUMBER,
  0 AS OCTOBER_SELL_AMOUNT,
  md.NOVEMBER_SUPPLY_AREA,
  md.NOVEMBER_SUPPLY_NUMBER,
  md.NOVEMBER_SUPPLY_AMOUNT,
  0 AS NOVEMBER_SELL_AREA,
  0 AS NOVEMBER_SELL_NUMBER,
  0 AS NOVEMBER_SELL_AMOUNT,
  md.DECEMBER_SUPPLY_NUMBER,
  md.DECEMBER_SUPPLY_AREA,
  md.DECEMBER_SUPPLY_AMOUNT,
  0 AS DECEMBER_SELL_AREA,
  0 AS DECEMBER_SELL_NUMBER,
  0 AS DECEMBER_SELL_AMOUNT,
  decode( md.CAN_EDIT, 0, '#F3F3F3', NULL ) "BGCOLOR",
  md.BIZ_ID,
  CASE
      WHEN md.BIZ_PARENT_ID IS NULL THEN
    NULL 
      WHEN md.BIZ_PARENT_ID = nostagingID THEN
      p.PROJECT_ID ELSE md.BIZ_PARENT_ID 
    END AS BIZ_PARENT_ID,
    md.CAN_EDIT,
    md.ORDER_CODE 
  FROM
    swm_supply_month_dtl md
    LEFT JOIN swm_supply_node_plan p ON p.id = md.supply_node_plan_id
    LEFT JOIN swm_value_inventory_dtl inved ON inved.value_inventory_id = inventoryId 
    AND inved.biz_id = md.biz_id
  WHERE
    md.supply_node_plan_id = supplyPlanId 
    AND md.OBJ_TYPE != '无分期' 
  ORDER BY
    (
    CASE

        WHEN md.OBJ_TYPE = '项目' THEN
        0 
        WHEN md.OBJ_TYPE = '按业态汇总' THEN
        1 
        WHEN md.OBJ_TYPE = '一级业态' THEN
        2 ELSE 3 
      END 
      ),
      md.ORDER_CODE;
  else
  open monthDtl FOR SELECT
  md.ID,
  md.OBJ_NAME,
  md.ID AS SUPPLY_MONTH_DETAIL_ID,
  md.BUILD_PRODUCT_TYPE_NAME,
  0 PO_TOTAL_SALE_AREA,
  0 PO_TOTAL_SALE_COUNT,
  0 PO_TOTAL_SALE_AMOUNT,
  0 PO_SURPLUS_SALE_AREA,
  0 PO_SURPLUS_SALE_COUNT,
  0 PO_SURPLUS_SALE_AMOUNT,
  0 RP_TOTAL_AREA,
  0 RP_TOTAL_COUNT,
  0 RP_TOTAL_AMOUNT,
  0 PO_SALE_AREA,
  0 PO_SALE_COUNT,
  0 PO_SALE_AMOUNT,
  0 RP_SURPLUS_AREA,
  0 RP_SURPLUS_COUNT,
  0 RP_SURPLUS_AMOUNT,
  SUPPLY_TOTAL_AREA,
  SUPPLY_TOTAL_NUMBER,
  SUPPLY_TOTAL_AMOUNT,
  0 AS SELL_TOTAL_AREA,
  0 AS SELL_TOTAL_NUMBER,
  0 AS SELL_TOTAL_AMOUNT,
  md.JANUARY_SUPPLY_AREA,
  md.JANUARY_SUPPLY_NUMBER,
  md.JANUARY_SUPPLY_AMOUNT,
  0 AS JANUARY_SELL_AREA,
  0 AS JANUARY_SELL_NUMBER,
  0 AS JANUARY_SELL_AMOUNT,
  md.FEBRUARY_SUPPLY_AREA,
  md.FEBRUARY_SUPPLY_NUMBER,
  md.FEBRUARY_SUPPLY_AMOUNT,
  0 AS FEBRUARY_SELL_AREA,
  0 AS FEBRUARY_SELL_NUMBER,
  0 AS FEBRUARY_SELL_AMOUNT,
  md.MARCH_SUPPLY_AREA,
  md.MARCH_SUPPLY_NUMBER,
  md.MARCH_SUPPLY_AMOUNT,
  0 AS MARCH_SELL_AREA,
  0 AS MARCH_SELL_NUMBER,
  0 AS MARCH_SELL_AMOUNT,
  md.APRIL_SUPPLY_AREA,
  md.APRIL_SUPPLY_NUMBER,
  md.APRIL_SUPPLY_AMOUNT,
  0 AS APRIL_SELL_AREA,
  0 AS APRIL_SELL_NUMBER,
  0 AS APRIL_SELL_AMOUNT,
  md.MAY_SUPPLY_AREA,
  md.MAY_SUPPLY_NUMBER,
  md.MAY_SUPPLY_AMOUNT,
  0 AS MAY_SELL_AREA,
  0 AS MAY_SELL_NUMBER,
  0 AS MAY_SELL_AMOUNT,
  md.JUNE_SUPPLY_AREA,
  md.JUNE_SUPPLY_NUMBER,
  md.JUNE_SUPPLY_AMOUNT,
  0 AS JUNE_SELL_AREA,
  0 AS JUNE_SELL_NUMBER,
  0 AS JUNE_SELL_AMOUNT,
  md.JULY_SUPPLY_AREA,
  md.JULY_SUPPLY_NUMBER,
  md.JULY_SUPPLY_AMOUNT,
  0 AS JULY_SELL_AREA,
  0 AS JULY_SELL_NUMBER,
  0 AS JULY_SELL_AMOUNT,
  md.AUGUST_SUPPLY_AREA,
  md.AUGUST_SUPPLY_NUMBER,
  md.AUGUST_SUPPLY_AMOUNT,
  0 AS AUGUST_SELL_AREA,
  0 AS AUGUST_SELL_NUMBER,
  0 AS AUGUST_SELL_AMOUNT,
  md.SEPTEMBER_SUPPLY_AREA,
  md.SEPTEMBER_SUPPLY_NUMBER,
  md.SEPTEMBER_SUPPLY_AMOUNT,
  0 AS SEPTEMBER_SELL_AREA,
  0 AS SEPTEMBER_SELL_NUMBER,
  0 AS SEPTEMBER_SELL_AMOUNT,
  md.OCTOBER_SUPPLY_AREA,
  md.OCTOBER_SUPPLY_NUMBER,
  md.OCTOBER_SUPPLY_AMOUNT,
  0 AS OCTOBER_SELL_AREA,
  0 AS OCTOBER_SELL_NUMBER,
  0 AS OCTOBER_SELL_AMOUNT,
  md.NOVEMBER_SUPPLY_AREA,
  md.NOVEMBER_SUPPLY_NUMBER,
  md.NOVEMBER_SUPPLY_AMOUNT,
  0 AS NOVEMBER_SELL_AREA,
  0 AS NOVEMBER_SELL_NUMBER,
  0 AS NOVEMBER_SELL_AMOUNT,
  md.DECEMBER_SUPPLY_NUMBER,
  md.DECEMBER_SUPPLY_AREA,
  md.DECEMBER_SUPPLY_AMOUNT,
  0 AS DECEMBER_SELL_AREA,
  0 AS DECEMBER_SELL_NUMBER,
  0 AS DECEMBER_SELL_AMOUNT,
  decode( md.CAN_EDIT, 0, '#F3F3F3', NULL ) "BGCOLOR",
  md.BIZ_ID,
  CASE
      WHEN md.BIZ_PARENT_ID IS NULL THEN
    NULL 
      WHEN md.BIZ_PARENT_ID = nostagingID THEN
      p.PROJECT_ID ELSE md.BIZ_PARENT_ID 
    END AS BIZ_PARENT_ID,
    md.CAN_EDIT,
    md.ORDER_CODE 
  FROM
    swm_supply_month_dtl md
    LEFT JOIN swm_supply_node_plan p ON p.id = md.supply_node_plan_id
  WHERE
    md.supply_node_plan_id = supplyPlanId 
    AND md.OBJ_TYPE != '无分期' 
  ORDER BY
    (
    CASE

        WHEN md.OBJ_TYPE = '项目' THEN
        0 
        WHEN md.OBJ_TYPE = '按业态汇总' THEN
        1 
        WHEN md.OBJ_TYPE = '一级业态' THEN
        2 ELSE 3 
      END 
      ),
      md.ORDER_CODE;
 end if;

END p_swm_supply_month;

/
--------------------------------------------------------
--  DDL for Procedure P_SWM_SUPPLY_NODE_PLAN
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SWM_SUPPLY_NODE_PLAN" 
(
companyId IN VARCHAR2, 
projectId IN VARCHAR2, 
planYear IN VARCHAR2, 
condition IN VARCHAR2, 
unitId in varchar2,
userId IN VARCHAR2, 
stationId IN VARCHAR2, 
deptId IN VARCHAR2,
supplyNodePlan OUT sys_refcursor
) AS 
v_sql clob :='';
-- 动态拼接的条件
companyStr clob := ' AND PROJECT_ID IN ';
projectStr varchar2(500):='';
planYearStr varchar2(500):='';
conditionStr varchar2(500):='';
-- 获取
ret sys_refcursor;
--定义一种类型，用来存放返回的记录
type typ_row is record (ID varchar2(50), projectName varchar2(500), sn varchar2(100));
--定义一个临时变量
result_temp typ_row;
BEGIN


--调用存储过程---
--P_SYS_PROJECT_BY_ORG_ID(companyId,'admin',NULL,NULL,NULL,'SWM.GHJDBZ',ret);
P_SYS_PROJECT_BY_ORG_ID(
            unitId=>unitId,
            USERID => userid,
            STATIONID => stationId,
            DEPTID => deptId,
            COMPANYID => companyId,
            BIZCODE => 'SWM.GHJDBZ',
            INFOS => ret
        );
companyStr := companyStr || '( ';
    loop 
    fetch ret into result_temp;          
    exit when ret%notfound;
    companyStr := companyStr || '''' || result_temp.ID || '''' || ',';
    end loop;
companyStr := rtrim(companyStr, ',') || ')';


IF projectId is not null THEN 
    projectStr := ' AND PROJECT_ID = ' || '''' || projectId || '''';
END IF;
IF planYear is not null THEN 
    planYearStr := ' AND to_char(PLAN_YEAR, ''yyyy'') = ' || planYear;
END IF; 
IF condition is not null THEN 
    conditionStr := ' WHERE ( PROJECT_NAME LIKE CONCAT( CONCAT( ''%'', ' || '''' ||  condition || '''' || ' ), ''%'' )  OR PERIOD_CODE LIKE CONCAT(CONCAT(''%'', ' || '''' ||  condition || '''' || ' ), ''%'' ) )';
END IF;

v_sql:=' select ROWNUM NUMB, pn.* from (SELECT
		nodePlan.*,
		NVL( redIndex.rn, 0 ) RED_INDEX 
	FROM
		(
		SELECT
			plan.*
		FROM
			(
			SELECT 
                ID,
                PROJECT_ID,
                PROJECT_NAME,
                CONCAT(''V'', CONCAT(PERIOD_CODE, ''.0'')) PERIOD_CODE,
                CONCAT( to_char( PLAN_YEAR, ''yyyy'' ), ''年'' ) PLAN_YEAR,
                LAST_YEAR_INVENTORY_INFLOW,
                THIS_YEAR_NEW_SUPPLY_EXPECTED,
                THIS_YEAR_TOTAL_SUPPLY,
                RELEASE_STATUS,
                to_char(RELEASE_TIME, ''yyyy-mm-dd'') RELEASE_TIME,
                to_char(MODIFIED, ''yyyy-mm-dd'') MODIFIED 
			FROM
				SWM_SUPPLY_NODE_PLAN p 
			WHERE
				IS_DELETED = 0  ' 
|| companyStr|| planYearStr || projectStr ||
                ' ) plan 
                ' || conditionStr || '
		) nodePlan
		LEFT JOIN (
		SELECT
			ORDER_HIERARCHY_CODE,
			project.id AS PROJECT_ID,
			SN 
		FROM
			( SELECT id, parent_id, ORDER_HIERARCHY_CODE FROM SYS_BUSINESS_UNIT ) business
			LEFT JOIN ( SELECT id, unit_id, SN FROM SYS_PROJECT ) project ON business.id = project.unit_id 
		WHERE
			project.id IS NOT NULL 
		) businessProj ON nodePlan.PROJECT_ID = businessProj.PROJECT_ID
		LEFT JOIN (
		SELECT
			* 
		FROM
			(
			SELECT
				ID,
				PROJECT_ID,
				ROW_NUMBER () OVER ( PARTITION BY PROJECT_ID ORDER BY to_number( PERIOD_CODE ) DESC ) AS RN 
			FROM
				( SELECT * FROM SWM_SUPPLY_NODE_PLAN WHERE IS_DELETED = 0 AND RELEASE_STATUS = ''已发布'' ) 
			) 
		WHERE
			RN <= 1 
		) redIndex ON nodePlan.ID = redIndex.ID 
	ORDER BY
		businessProj.ORDER_HIERARCHY_CODE ASC,
		to_number( businessProj.SN ) ASC,
		to_number(
		SUBSTR( nodePlan.PERIOD_CODE, 2 )) DESC ) pn  ';
        dbms_output.put_line(v_sql);
OPEN supplyNodePlan FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE supplyNodePlan;
END P_SWM_SUPPLY_NODE_PLAN;

/
--------------------------------------------------------
--  DDL for Procedure P_SWM_SUPPLY_PLAN_DTL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SWM_SUPPLY_PLAN_DTL" (
	supplyPlanId IN VARCHAR2,
	info OUT SYS_REFCURSOR)
AS
    projectID VARCHAR2(36); -- 项目id
    nostagingID VARCHAR2(200); -- 无分期id
    mixType integer;
BEGIN
	-- routine body goes here, e.g.
	-- DBMS_OUTPUT.PUT_LINE('Navicat for Oracle');
				    -- 查询条数
    SELECT
        count(*) into mixType
    FROM
        SWM_SUPPLY_PLAN_DTL 
    WHERE
        OBJ_TYPE = '无分期' 
        AND SUPPLY_NODE_PLAN_ID = supplyPlanId AND (IS_DELETED = '0' or IS_DELETED is null);
IF mixType>0 THEN
	    -- 查询无分期的id
    SELECT
        BIZ_ID INTO nostagingID 
    FROM
        SWM_SUPPLY_PLAN_DTL 
    WHERE
        OBJ_TYPE = '无分期' 
        AND SUPPLY_NODE_PLAN_ID = supplyPlanId AND (IS_DELETED = '0' or IS_DELETED is null);  
END IF; 
    -- 查询条数
    SELECT
       count(*) into mixType
    FROM
        SWM_SUPPLY_PLAN_DTL 
    WHERE
        OBJ_TYPE = '项目' 
        AND SUPPLY_NODE_PLAN_ID = supplyPlanId AND (IS_DELETED = '0' or IS_DELETED is null);
IF mixType>0 THEN
    -- 查询项目
    SELECT
        BIZ_ID INTO projectID 
    FROM
        SWM_SUPPLY_PLAN_DTL 
    WHERE
        OBJ_TYPE = '项目' 
        AND SUPPLY_NODE_PLAN_ID = supplyPlanId AND (IS_DELETED = '0' or IS_DELETED is null);
END IF; 

	OPEN info FOR 
	select 
		ID,
		SUPPLY_NODE_PLAN_ID,
		BIZ_ID,
		OBJ_TYPE,
		OBJ_ID,
		OBJ_NAME,
		BUILD_PRODUCT_TYPE_NAME,
		OWN_BUILD_PRODUCT_TYPE_ID,
		BUILD_PRODUCT_TYPE_ID,
		CAN_EDIT,
		ORDER_CODE,
		SUPPLY_TOTAL_AMOUNT,
		SUPPLY_TOTAL_AREA,
		SUPPLY_TOTAL_NUMBER,
    to_char(SUPPLY_MONTH, 'yyyy"年"fmmm"月"') "SUPPLY_MONTH",
    to_char(RESERVED_COLUMN1, 'yyyy-mm-dd') "RESERVED_COLUMN1",
    to_char(RESERVED_COLUMN2, 'yyyy-mm-dd') "RESERVED_COLUMN2",
    to_char(RESERVED_COLUMN3, 'yyyy-mm-dd') "RESERVED_COLUMN3",
    to_char(RESERVED_COLUMN4, 'yyyy-mm-dd') "RESERVED_COLUMN4",
    to_char(RESERVED_COLUMN5, 'yyyy-mm-dd') "RESERVED_COLUMN5",
    to_char(RESERVED_COLUMN6, 'yyyy-mm-dd') "RESERVED_COLUMN6",
    to_char(RESERVED_COLUMN7, 'yyyy-mm-dd') "RESERVED_COLUMN7",
    to_char(RESERVED_COLUMN8, 'yyyy-mm-dd') "RESERVED_COLUMN8",
    to_char(RESERVED_COLUMN9, 'yyyy-mm-dd') "RESERVED_COLUMN9",
    to_char(RESERVED_COLUMN10, 'yyyy-mm-dd') "RESERVED_COLUMN10",
    to_char(RESERVED_COLUMN11, 'yyyy-mm-dd') "RESERVED_COLUMN11",
    to_char(RESERVED_COLUMN12, 'yyyy-mm-dd') "RESERVED_COLUMN12",
    to_char(RESERVED_COLUMN13, 'yyyy-mm-dd') "RESERVED_COLUMN13",
    to_char(RESERVED_COLUMN14, 'yyyy-mm-dd') "RESERVED_COLUMN14",
    to_char(RESERVED_COLUMN15, 'yyyy-mm-dd') "RESERVED_COLUMN15",
    to_char(RESERVED_COLUMN16, 'yyyy-mm-dd') "RESERVED_COLUMN16",
    to_char(RESERVED_COLUMN17, 'yyyy-mm-dd') "RESERVED_COLUMN17",
    to_char(RESERVED_COLUMN18, 'yyyy-mm-dd') "RESERVED_COLUMN18",
    to_char(RESERVED_COLUMN19, 'yyyy-mm-dd') "RESERVED_COLUMN19",
    to_char(RESERVED_COLUMN20, 'yyyy-mm-dd') "RESERVED_COLUMN20",
    to_char(RESERVED_COLUMN21, 'yyyy-mm-dd') "RESERVED_COLUMN21",
    to_char(RESERVED_COLUMN22, 'yyyy-mm-dd') "RESERVED_COLUMN22",
    to_char(RESERVED_COLUMN23, 'yyyy-mm-dd') "RESERVED_COLUMN23",
    to_char(RESERVED_COLUMN24, 'yyyy-mm-dd') "RESERVED_COLUMN24",
    to_char(RESERVED_COLUMN25, 'yyyy-mm-dd') "RESERVED_COLUMN25",
    to_char(RESERVED_COLUMN26, 'yyyy-mm-dd') "RESERVED_COLUMN26",
    to_char(RESERVED_COLUMN27, 'yyyy-mm-dd') "RESERVED_COLUMN27",
    to_char(RESERVED_COLUMN28, 'yyyy-mm-dd') "RESERVED_COLUMN28",
    to_char(RESERVED_COLUMN29, 'yyyy-mm-dd') "RESERVED_COLUMN29",
    to_char(RESERVED_COLUMN30, 'yyyy-mm-dd') "RESERVED_COLUMN30",
    to_char(RESERVED_COLUMN31, 'yyyy-mm-dd') "RESERVED_COLUMN31",
    to_char(RESERVED_COLUMN32, 'yyyy-mm-dd') "RESERVED_COLUMN32",
    to_char(RESERVED_COLUMN33, 'yyyy-mm-dd') "RESERVED_COLUMN33",
    to_char(RESERVED_COLUMN34, 'yyyy-mm-dd') "RESERVED_COLUMN34",
    to_char(RESERVED_COLUMN35, 'yyyy-mm-dd') "RESERVED_COLUMN35",
    to_char(RESERVED_COLUMN36, 'yyyy-mm-dd') "RESERVED_COLUMN36",
    to_char(RESERVED_COLUMN37, 'yyyy-mm-dd') "RESERVED_COLUMN37",
    to_char(RESERVED_COLUMN38, 'yyyy-mm-dd') "RESERVED_COLUMN38",
    to_char(RESERVED_COLUMN39, 'yyyy-mm-dd') "RESERVED_COLUMN39",
    to_char(RESERVED_COLUMN40, 'yyyy-mm-dd') "RESERVED_COLUMN40",
	decode( CAN_EDIT, 0, '#F3F3F3', NULL , '#F3F3F3') "BGCOLOR",
	decode( BIZ_PARENT_ID, NVL(nostagingID,'11'), projectID, BIZ_PARENT_ID ) "BIZ_PARENT_ID",
		CREATED,
		CREATOR_ID,
		CREATOR,
		MODIFIED,
		MODIFIER_ID,
		MODIFIER,
		IS_DELETED ,
		RANK() OVER(PARTITION BY ORDER_CODE ORDER BY ID DESC) RO
		        from SWM_SUPPLY_PLAN_DTL
        WHERE SUPPLY_NODE_PLAN_ID = supplyPlanId and (OBJ_TYPE != '无分期' or OBJ_TYPE is NULL) and (IS_DELETED = '0' or IS_DELETED is null) ORDER BY (case when OBJ_TYPE='项目' then 0 when  OBJ_TYPE ='按业态汇总' then 1 when OBJ_TYPE ='一级业态' then 2 else 3 end), ORDER_CODE, RO; 
END P_SWM_SUPPLY_PLAN_DTL;

/
--------------------------------------------------------
--  DDL for Procedure P_SWM_SUPPLY_SELL_PLAN_EXPORT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SWM_SUPPLY_SELL_PLAN_EXPORT" 
(
	-- 所属公司id、项目id、计划年份、搜索条件(查询条件)
		COMPANY_ID IN VARCHAR2, 
		PROJECT_ID IN VARCHAR2, 
		PLAN_YEAR IN VARCHAR2, 
		SEARCH_WHERE IN VARCHAR2, 
		-- 用户默认公司id、岗位id
		UNIT_ID IN VARCHAR2,
		USERID IN VARCHAR2, 
		STATION_ID IN VARCHAR2, 
		DEPT_ID IN VARCHAR2, 
		-- 游标(返回结果集)
		CUR_SELL_PLAN	OUT sys_refcursor
	) AS 
	-- 获取有权限的项目id 游标
	CUR_PROJECT_LIST sys_refcursor;
	--定义一种类型，用来存放返回的记录
	type typ_row is record (ID varchar2(50), projectName varchar2(500), sn varchar2(100));
	--游标临时行数据
	result_temp typ_row;

	DYNAMIC_SQL clob :='';
	v_sql clob :='';
	BEGIN

	--调用存储过程---
	P_SYS_PROJECT_BY_ORG_ID(
			unitId=> COMPANY_ID,
				USERID => USERID,
				STATIONID => STATION_ID,
				DEPTID => DEPT_ID,
				COMPANYID => UNIT_ID,
				BIZCODE => 'SWM.GXCJHBZ',
				INFOS => CUR_PROJECT_LIST
	);

	 -- 循环拼接动态SQL
	loop 
		fetch CUR_PROJECT_LIST into result_temp;          
		exit when CUR_PROJECT_LIST%notfound;
		DYNAMIC_SQL := DYNAMIC_SQL || '''' || result_temp.ID || '''' || ',';
	end loop;

	-- 数据权限过滤
	IF DYNAMIC_SQL is null OR DYNAMIC_SQL = '' THEN 
		DYNAMIC_SQL := '''''';
	END IF;
	DYNAMIC_SQL :=  ' AND A.PROJECT_ID IN ('|| rtrim(DYNAMIC_SQL, ',') || ')';


	-- 搜索条件：所属公司
	IF COMPANY_ID is not null THEN 
		DYNAMIC_SQL := DYNAMIC_SQL || ' AND A.PROJECT_ID IN (
		SELECT DISTINCT
		( PROJECT.ID )
		FROM
		( SELECT ID, PARENT_ID FROM SYS_BUSINESS_UNIT START WITH ID = ' || '''' || COMPANY_ID || '''' || ' CONNECT BY PRIOR ID = PARENT_ID ) BUSINESS
		LEFT JOIN ( SELECT ID, UNIT_ID FROM SYS_PROJECT ) PROJECT ON BUSINESS.ID = PROJECT.UNIT_ID
		WHERE
		PROJECT.ID IS NOT NULL
	)  ';
	END IF;

	-- 搜索条件：项目
	IF PROJECT_ID is not null THEN 
		DYNAMIC_SQL := DYNAMIC_SQL || ' AND a.PROJECT_ID = ' || '''' || PROJECT_ID || '''';
	END IF;

	-- 搜索条件：计划年份
	IF PLAN_YEAR is not null THEN 
		DYNAMIC_SQL := DYNAMIC_SQL || ' and to_char(a.PLAN_YEAR,''yyyy'') = substr('|| '''' || PLAN_YEAR || '''' ||',0,4) ';
	END IF;

	-- 搜索条件：模糊搜索
	IF SEARCH_WHERE is not null THEN 
		DYNAMIC_SQL := DYNAMIC_SQL || ' and (
					a.PROJECT_NAME like''%'' || ' || '''' || SEARCH_WHERE || '''' || '  || ''%''
					OR ''V''|| a.PERIOD_CODE||''.0''  like''%'' ||  ' || '''' || SEARCH_WHERE || '''' || ' || ''%''
					) ';
	END IF;


	v_sql:=' SELECT ROWNUM as "index",temp.* FROM (
	SELECT
		a.APPROVAL_STATUS AS "approvalStatus"
		,a.PROJECT_NAME AS "projectName"
		,''V''||a.PERIOD_CODE||''.0'' AS "periodCode"
		,TO_CHAR(a.PLAN_YEAR,''YYYY'')||''年'' AS "planYearLabel"
		,a.THIS_YEAR_SELL_TARGET AS "thisYearSellTarget"
		,a.LAST_YEAR_INVENTORY_INFLOW AS "lastYearInventoryInflow"
		,a.THIS_YEAR_NEW_SUPPLY_EXPECTED AS "thisYearNewSupplyExpected"
		,a.THIS_YEAR_TOTAL_SUPPLY_PREDICT AS "thisYearTotalSupplyPredict"
		,a.SUPPLY_PLAN_DIFFERENCE AS "supplyPlanDifference"
		,a.SUPPLY_SALE_RATIO_FORECAST AS "supplySaleRatioForecast"
		,TO_CHAR(a.CREATED,''YYYY-MM-dd'') AS "created"
		,TO_CHAR(a.APPROVAL_TIME,''YYYY-MM-dd'') AS "approvalTime"
	FROM SWM_SUPPLY_SELL_PLAN a
	LEFT JOIN SYS_PROJECT b ON a.PROJECT_ID = b.id
	LEFT JOIN SYS_BUSINESS_UNIT c on b.UNIT_ID = c.id
	WHERE a.IS_DELETED = ''0'' ' || DYNAMIC_SQL ||'
	ORDER BY c.ORDER_HIERARCHY_CODE asc,LPAD (b.SN , 6 , ''0'') asc,to_number(a.PERIOD_CODE) desc ) temp';

	-- 结果集插入游标
	OPEN CUR_SELL_PLAN FOR v_sql;

	EXCEPTION
		WHEN OTHERS THEN
			CLOSE CUR_SELL_PLAN;

END P_SWM_SUPPLY_SELL_PLAN_EXPORT;

/
--------------------------------------------------------
--  DDL for Procedure P_SWM_SUPPLYDETAIL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SWM_SUPPLYDETAIL" (
    supplyType IN VARCHAR2,
    supplyId IN VARCHAR2,
    info OUT SYS_REFCURSOR
)AS
    --《供货管理》供货计划编制明细
--作者：wangl
--日期：2020/12/17
BEGIN
-- 传入类型是供销存计划编制类型
IF supplyType ='supplySellPlan' THEN
    P_SWM_GET_SUPPLYDETAIL(supplyId,info);
END IF; 
-- 传入类型是供销节点计划编制类型
IF supplyType ='supplyMonth' THEN
    P_SWM_SUPPLY_MONTH(supplyId,info);
END IF; 
END P_SWM_SUPPLYDETAIL;

/
--------------------------------------------------------
--  DDL for Procedure P_SWM_VALUE_DTL_EVERYDAY_LOG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SWM_VALUE_DTL_EVERYDAY_LOG" 
is
currentDate varchar2(20);
ROWCONT number;
begin
currentDate:=TO_CHAR(sysdate,'yyyy-mm-dd');
 SELECT COUNT(1) INTO ROWCONT FROM SWM_VALUE_INVENTORY WHERE TO_CHAR(created,'yyyy-mm-dd')=currentDate;
         IF ROWCONT <> 0 THEN
            delete SWM_VALUE_INVENTORY WHERE TO_CHAR(created,'yyyy-mm-dd')=currentDate;
            delete from SWM_VALUE_INVENTORY_DTL WHERE VALUE_INVENTORY_ID IN
            (
                 select id
                 from SWM_VALUE_INVENTORY where TO_CHAR(created,'yyyy-mm-dd')=currentDate
            );
        END IF;
insert into SWM_VALUE_INVENTORY select GET_UUID(),ID,PROJECT_NAME,sysdate,NULL,NULL from sys_project;

--货值盘点明细 项目统计
insert into SWM_VALUE_INVENTORY_DTL 
select GET_UUID() ID,
SWM_VALUE_INVENTORY.id VALUE_INVENTORY_ID,
SYS_PROJECT.ID BIZ_ID ,
null as BIZ_PARENT_ID,
'项目' OBJ_TYPE,
SYS_PROJECT.ID OBJ_ID,
SYS_PROJECT.PROJECT_NAME OBJ_NAME,
NULL BUILD_PRODUCT_TYPE_NAME,
NULL OWN_BUILD_PRODUCT_TYPE_ID,
NULL BUILD_PRODUCT_TYPE_ID,
case when SYS_PROJECT.SN is null then '000001' else  lpad(SYS_PROJECT.SN,6,'0')  end  ORDER_CODE,
DT_VALUE."A全案总可售面积",
DT_VALUE."A全案总可售户数",
DT_VALUE."A全案总可售均价",
FN_DWN_divide10000(DT_VALUE."A全案总可售货值"),
DT_VALUE."B全案已售面积",
DT_VALUE."B全案已售套数",
DT_VALUE."B全案已售均价",
FN_DWN_divide10000(DT_VALUE."B全案已售货值"),
DT_VALUE."C全案库存面积",
DT_VALUE."C全案库存套数",
DT_VALUE."C全案库存均价",
FN_DWN_divide10000(DT_VALUE."C全案库存货值"),
DT_VALUE."D已取证面积",
DT_VALUE."D已取证套数",
DT_VALUE."D已取证均价",
FN_DWN_divide10000(DT_VALUE."D已取证货值"),
DT_VALUE."E已取证库存面积",
DT_VALUE."E已取证库存套数",
DT_VALUE."E已取证库存均价",
FN_DWN_divide10000(DT_VALUE."E已取证库存货值"),
sysdate,
NULL,
NULL
from SYS_PROJECT left join SWM_VALUE_INVENTORY on SYS_PROJECT.id=SWM_VALUE_INVENTORY.project_id
left join (select project_id from  sys_project_stage group by project_id) stage on stage.project_id= SYS_PROJECT.id
left join (
select proj_id,PROJECT_NAME,
SUM(CASE when 总可售面积 is null then 0 else 总可售面积 end)  A全案总可售面积,
SUM(case when 一级业态='车位仓储' then NVL("总车位数",0) else NVL(总户数,0) end) A全案总可售户数,
0 A全案总可售均价,
SUM(NVL( A_当前最新版目标货值,0))  A全案总可售货值,
SUM(NVL(已售建筑面积,0)) B全案已售面积,
SUM(NVL(已售套数,0)) B全案已售套数,
0 B全案已售均价,
SUM(NVL(已售货值,0)) B全案已售货值,
SUM(NVL(全案剩余面积,0)) C全案库存面积,
SUM(NVL(全案剩余套数,0)) C全案库存套数,
0 C全案库存均价,
SUM(NVL(全案剩余货值,0)) C全案库存货值,
SUM(NVL(已取证建筑面积,0)) D已取证面积,
SUM(NVL(已取证套数,0)) D已取证套数,
0 D已取证均价,
SUM(NVL(已取证货值,0)) D已取证货值,
SUM(NVL(库存建筑面积,0)) E已取证库存面积,
SUM(NVL(库存套数,0)) E已取证库存套数,
0 E已取证库存均价,
SUM(NVL( 库存货值,0)) E已取证库存货值
from V_SWM_DT_VALUE where V_SWM_DT_VALUE.OBJ_TYPE<>'宗地一级业态'  GROUP by proj_id,PROJECT_NAME
) DT_VALUE on DT_VALUE.proj_id=SYS_PROJECT.id where stage.project_id is not null and to_char(SWM_VALUE_INVENTORY.CREATED,'yyyy-mm-dd')=currentDate ;


insert into SWM_VALUE_INVENTORY_DTL 
select GET_UUID() ID,
SWM_VALUE_INVENTORY.id VALUE_INVENTORY_ID,
SYS_PROJECT.ID BIZ_ID ,
null as BIZ_PARENT_ID,
'项目' OBJ_TYPE,
SYS_PROJECT.ID OBJ_ID,
SYS_PROJECT.PROJECT_NAME OBJ_NAME,
NULL BUILD_PRODUCT_TYPE_NAME,
NULL OWN_BUILD_PRODUCT_TYPE_ID,
NULL BUILD_PRODUCT_TYPE_ID,
case when SYS_PROJECT.SN is null then '000001' else  lpad(SYS_PROJECT.SN,6,'0')  end  ORDER_CODE,
DT_VALUE."A全案总可售面积",
DT_VALUE."A全案总可售户数",
DT_VALUE."A全案总可售均价",
FN_DWN_divide10000(DT_VALUE."A全案总可售货值"),
DT_VALUE."B全案已售面积",
DT_VALUE."B全案已售套数",
DT_VALUE."B全案已售均价",
FN_DWN_divide10000(DT_VALUE."B全案已售货值"),
DT_VALUE."C全案库存面积",
DT_VALUE."C全案库存套数",
DT_VALUE."C全案库存均价",
FN_DWN_divide10000(DT_VALUE."C全案库存货值"),
DT_VALUE."D已取证面积",
DT_VALUE."D已取证套数",
DT_VALUE."D已取证均价",
FN_DWN_divide10000(DT_VALUE."D已取证货值"),
DT_VALUE."E已取证库存面积",
DT_VALUE."E已取证库存套数",
DT_VALUE."E已取证库存均价",
FN_DWN_divide10000(DT_VALUE."E已取证库存货值"),
sysdate,
NULL,
NULL
from SYS_PROJECT left join SWM_VALUE_INVENTORY on SYS_PROJECT.id=SWM_VALUE_INVENTORY.project_id
left join (select project_id from  sys_project_stage group by project_id) stage on stage.project_id= SYS_PROJECT.id
left join (
select proj_id,PROJECT_NAME,
SUM(CASE when 总可售面积 is null then 0 else 总可售面积 end)  A全案总可售面积,
SUM(case when 一级业态='车位仓储' then NVL("总车位数",0) else NVL(总户数,0) end) A全案总可售户数,
0 A全案总可售均价,
SUM(NVL( A_当前最新版目标货值,0))  A全案总可售货值,
SUM(NVL(已售建筑面积,0)) B全案已售面积,
SUM(NVL(已售套数,0)) B全案已售套数,
0 B全案已售均价,
SUM(NVL(已售货值,0)) B全案已售货值,
SUM(NVL(全案剩余面积,0)) C全案库存面积,
SUM(NVL(全案剩余套数,0)) C全案库存套数,
0 C全案库存均价,
SUM(NVL(全案剩余货值,0)) C全案库存货值,
SUM(NVL(已取证建筑面积,0)) D已取证面积,
SUM(NVL(已取证套数,0)) D已取证套数,
0 D已取证均价,
SUM(NVL(已取证货值,0)) D已取证货值,
SUM(NVL(库存建筑面积,0)) E已取证库存面积,
SUM(NVL(库存套数,0)) E已取证库存套数,
0 E已取证库存均价,
SUM(NVL( 库存货值,0)) E已取证库存货值
from V_SWM_DT_VALUE where V_SWM_DT_VALUE.OBJ_TYPE='宗地一级业态'  GROUP by proj_id,PROJECT_NAME
) DT_VALUE on DT_VALUE.proj_id=SYS_PROJECT.id where stage.project_id is  null  and to_char(SWM_VALUE_INVENTORY.CREATED,'yyyy-mm-dd')=currentDate ;


--按业态汇总行
insert into SWM_VALUE_INVENTORY_DTL 
select GET_UUID() ID,
SWM_VALUE_INVENTORY.id VALUE_INVENTORY_ID,
SYS_PROJECT.ID||'_firstLevelProductTypeStatistics' BIZ_ID ,
SYS_PROJECT.ID as BIZ_PARENT_ID,
'按业态汇总' OBJ_TYPE,
SYS_PROJECT.ID OBJ_ID,
'按业态汇总' OBJ_NAME,
NULL BUILD_PRODUCT_TYPE_NAME,
NULL OWN_BUILD_PRODUCT_TYPE_ID,
NULL BUILD_PRODUCT_TYPE_ID,
case when SYS_PROJECT.SN is null then '000001_000000' else  lpad(SYS_PROJECT.SN,6,'0')||'_000000'  end  ORDER_CODE,
DT_VALUE."A全案总可售面积",
DT_VALUE."A全案总可售户数",
DT_VALUE."A全案总可售均价",
DT_VALUE."A全案总可售货值",
DT_VALUE."B全案已售面积",
DT_VALUE."B全案已售套数",
DT_VALUE."B全案已售均价",
DT_VALUE."B全案已售货值",
DT_VALUE."C全案库存面积",
DT_VALUE."C全案库存套数",
DT_VALUE."C全案库存均价",
DT_VALUE."C全案库存货值",
DT_VALUE."D已取证面积",
DT_VALUE."D已取证套数",
DT_VALUE."D已取证均价",
DT_VALUE."D已取证货值",
DT_VALUE."E已取证库存面积",
DT_VALUE."E已取证库存套数",
DT_VALUE."E已取证库存均价",
DT_VALUE."E已取证库存货值",
sysdate,
NULL,
NULL
from SYS_PROJECT left join SWM_VALUE_INVENTORY on SYS_PROJECT.id=SWM_VALUE_INVENTORY.project_id
right join (
select obj_id,
SUM(NVL(PO_TOTAL_SALE_AREA,0))  A全案总可售面积,
SUM(NVL(PO_TOTAL_SALE_COUNT,0))  A全案总可售户数,
0 A全案总可售均价,
SUM(NVL(PO_TOTAL_SALE_AMOUNT,0))  A全案总可售货值,
SUM(NVL(PO_SALE_AREA,0))  B全案已售面积,
SUM(NVL(PO_SALE_COUNT,0)) B全案已售套数,
0 B全案已售均价,
SUM(NVL(PO_SALE_AMOUNT,0))  B全案已售货值,
SUM(NVL(PO_SURPLUS_SALE_AREA,0)) C全案库存面积,
SUM(NVL(PO_SURPLUS_SALE_COUNT,0)) C全案库存套数,
0 C全案库存均价,
SUM(NVL(PO_SURPLUS_SALE_AMOUNT,0)) C全案库存货值,
SUM(NVL(RP_TOTAL_AREA,0)) D已取证面积,
SUM(NVL(RP_TOTAL_COUNT,0)) D已取证套数,
0 D已取证均价,
SUM(NVL(RP_TOTAL_AMOUNT,0)) D已取证货值,
SUM(NVL(RP_SURPLUS_AREA,0)) E已取证库存面积,
SUM(NVL(RP_SURPLUS_COUNT,0)) E已取证库存套数,
0 E已取证库存均价,
SUM(NVL(RP_SURPLUS_AMOUNT,0)) E已取证库存货值
from SWM_VALUE_INVENTORY_DTL left join SWM_VALUE_INVENTORY on SWM_VALUE_INVENTORY_DTL.VALUE_INVENTORY_ID =SWM_VALUE_INVENTORY.id where obj_type='项目' and to_char(SWM_VALUE_INVENTORY_DTL.CREATED,'yyyy-mm-dd')=currentDate
and to_char(SWM_VALUE_INVENTORY.CREATED,'yyyy-mm-dd')=currentDate  GROUP by obj_id
) DT_VALUE on DT_VALUE.obj_id=SYS_PROJECT.id and to_char(SWM_VALUE_INVENTORY.CREATED,'yyyy-mm-dd')=currentDate
and SWM_VALUE_INVENTORY.project_id=DT_VALUE.obj_id;


--一级业态汇总行
insert into SWM_VALUE_INVENTORY_DTL 
select GET_UUID() ID,
SWM_VALUE_INVENTORY.ID VALUE_INVENTORY_ID,
DT_VALUE.proj_id||'_'||MDM_BUILD_PRODUCT_TYPE.id BIZ_ID,
DT_VALUE.proj_id||'_firstLevelProductTypeStatistics' BIZ_PARENT_ID,
'一级业态' OBJ_TYPE,
MDM_BUILD_PRODUCT_TYPE.id OBJ_ID,
DT_VALUE.一级业态 OBJ_NAME,
DT_VALUE.一级业态 BUILD_PRODUCT_TYPE_NAME,
MDM_BUILD_PRODUCT_TYPE.id OWN_BUILD_PRODUCT_TYPE_ID,
MDM_BUILD_PRODUCT_TYPE.id  BUILD_PRODUCT_TYPE_ID,
SWM_VALUE_INVENTORY_DTL.ORDER_CODE||'_'||MDM_BUILD_PRODUCT_TYPE.PRODUCT_TYPE_CODE ORDER_CODE,
DT_VALUE."A全案总可售面积",
DT_VALUE."A全案总可售户数",

CASE when 一级业态='车位仓储' and NVL(DT_VALUE."A全案总可售户数",0)<>0 then round(DT_VALUE."A全案总可售货值"/DT_VALUE."A全案总可售户数",4)
when 一级业态='车位仓储' and NVL(DT_VALUE."A全案总可售户数",0)=0 then 0
when 一级业态<>'车位仓储' and NVL(DT_VALUE."A全案总可售面积",0)<>0 then round(DT_VALUE."A全案总可售货值"/DT_VALUE."A全案总可售面积",4)
when 一级业态<>'车位仓储' and NVL(DT_VALUE."A全案总可售面积",0)=0 then 0 end  A全案总可售均价,

FN_DWN_divide10000(DT_VALUE."A全案总可售货值"),
DT_VALUE."B全案已售面积",
DT_VALUE."B全案已售套数",

CASE when 一级业态='车位仓储' and NVL(DT_VALUE."B全案已售套数",0)<>0 then round(DT_VALUE."B全案已售货值"/DT_VALUE."B全案已售套数",4)
when 一级业态='车位仓储' and NVL(DT_VALUE."B全案已售套数",0)=0 then 0
when 一级业态<>'车位仓储' and NVL(DT_VALUE."B全案已售面积",0)<>0 then round(DT_VALUE."B全案已售货值"/DT_VALUE."B全案已售面积",4)
when 一级业态<>'车位仓储' and NVL(DT_VALUE."B全案已售面积",0)=0 then 0 end  B全案已售均价,

FN_DWN_divide10000(DT_VALUE."B全案已售货值"),
DT_VALUE."C全案库存面积",
DT_VALUE."C全案库存套数",

CASE when 一级业态='车位仓储' and NVL(DT_VALUE."C全案库存套数",0)<>0 then round(DT_VALUE."C全案库存货值"/DT_VALUE."C全案库存套数",4)
when 一级业态='车位仓储' and NVL(DT_VALUE."C全案库存套数",0)=0 then 0
when 一级业态<>'车位仓储' and NVL(DT_VALUE."C全案库存面积",0)<>0 then round(DT_VALUE."C全案库存货值"/DT_VALUE."C全案库存面积",4)
when 一级业态<>'车位仓储' and NVL(DT_VALUE."C全案库存面积",0)=0 then 0 end  C全案库存均价,

FN_DWN_divide10000(DT_VALUE."C全案库存货值"),
DT_VALUE."D已取证面积",
DT_VALUE."D已取证套数",

CASE when 一级业态='车位仓储' and NVL(DT_VALUE."D已取证套数",0)<>0 then round(DT_VALUE."D已取证货值"/DT_VALUE."D已取证套数",4)
when 一级业态='车位仓储' and NVL(DT_VALUE."D已取证套数",0)=0 then 0
when 一级业态<>'车位仓储' and NVL(DT_VALUE."D已取证面积",0)<>0 then round(DT_VALUE."D已取证货值"/DT_VALUE."D已取证面积",4)
when 一级业态<>'车位仓储' and NVL(DT_VALUE."D已取证面积",0)=0 then 0 end  D已取证均价,

FN_DWN_divide10000(DT_VALUE."D已取证货值"),
DT_VALUE."E已取证库存面积",
DT_VALUE."E已取证库存套数",

CASE when 一级业态='车位仓储' and NVL(DT_VALUE."E已取证库存套数",0)<>0 then round(DT_VALUE."E已取证库存货值"/DT_VALUE."E已取证库存套数",4)
when 一级业态='车位仓储' and NVL(DT_VALUE."E已取证库存套数",0)=0 then 0
when 一级业态<>'车位仓储' and NVL(DT_VALUE."E已取证库存面积",0)<>0 then round(DT_VALUE."E已取证库存货值"/DT_VALUE."E已取证库存面积",4)
when 一级业态<>'车位仓储' and NVL(DT_VALUE."E已取证库存面积",0)=0 then 0 end  E已取证库存均价,

FN_DWN_divide10000(DT_VALUE."E已取证库存货值"),
sysdate,
NULL,
NULL
from (
select  proj_id,PROJECT_NAME,一级业态,
SUM(CASE when 总可售面积 is null then 0 else 总可售面积 end)  A全案总可售面积,
SUM(case when 一级业态='车位仓储' then NVL("总车位数",0) else NVL(总户数,0) end) A全案总可售户数,
0 A全案总可售均价,
SUM(NVL( A_当前最新版目标货值,0))  A全案总可售货值,
SUM(NVL(已售建筑面积,0)) B全案已售面积,
SUM(NVL(已售套数,0)) B全案已售套数,
0 B全案已售均价,
SUM(NVL(已售货值,0)) B全案已售货值,
SUM(NVL(全案剩余面积,0)) C全案库存面积,
SUM(NVL(全案剩余套数,0)) C全案库存套数,
0 C全案库存均价,
SUM(NVL(全案剩余货值,0)) C全案库存货值,
SUM(NVL(已取证建筑面积,0)) D已取证面积,
SUM(NVL(已取证套数,0)) D已取证套数,
0 D已取证均价,
SUM(NVL(已取证货值,0)) D已取证货值,
SUM(NVL(库存建筑面积,0)) E已取证库存面积,
SUM(NVL(库存套数,0)) E已取证库存套数,
0 E已取证库存均价,
SUM(NVL( 库存货值,0)) E已取证库存货值
from V_SWM_DT_VALUE where V_SWM_DT_VALUE.OBJ_TYPE<>'宗地一级业态' GROUP by proj_id,PROJECT_NAME,一级业态) DT_VALUE
left join SWM_VALUE_INVENTORY_DTL  on DT_VALUE.proj_id=SWM_VALUE_INVENTORY_DTL.obj_id
left join SWM_VALUE_INVENTORY on SWM_VALUE_INVENTORY.ID=SWM_VALUE_INVENTORY_DTL.VALUE_INVENTORY_ID
left join MDM_BUILD_PRODUCT_TYPE on DT_VALUE.一级业态=MDM_BUILD_PRODUCT_TYPE.PRODUCT_TYPE_NAME
left join (select project_id from  sys_project_stage group by project_id) stage on stage.project_id= DT_VALUE.proj_id
where SWM_VALUE_INVENTORY_DTL.obj_type='按业态汇总' and MDM_BUILD_PRODUCT_TYPE.id is not null  and stage.project_id is not null
and to_char(SWM_VALUE_INVENTORY_DTL.CREATED,'yyyy-mm-dd')=currentDate and to_char(SWM_VALUE_INVENTORY.CREATED,'yyyy-mm-dd')=currentDate
and SWM_VALUE_INVENTORY.project_id=DT_VALUE.proj_id
union
select GET_UUID() ID,
SWM_VALUE_INVENTORY.ID VALUE_INVENTORY_ID,
DT_VALUE.proj_id||'_'||MDM_BUILD_PRODUCT_TYPE.id BIZ_ID,
DT_VALUE.proj_id||'_firstLevelProductTypeStatistics' BIZ_PARENT_ID,
'一级业态' OBJ_TYPE,
MDM_BUILD_PRODUCT_TYPE.id OBJ_ID,
DT_VALUE.一级业态 OBJ_NAME,
DT_VALUE.一级业态 BUILD_PRODUCT_TYPE_NAME,
MDM_BUILD_PRODUCT_TYPE.id OWN_BUILD_PRODUCT_TYPE_ID,
MDM_BUILD_PRODUCT_TYPE.id  BUILD_PRODUCT_TYPE_ID,
SWM_VALUE_INVENTORY_DTL.ORDER_CODE||'_'||MDM_BUILD_PRODUCT_TYPE.PRODUCT_TYPE_CODE ORDER_CODE,
DT_VALUE."A全案总可售面积",
DT_VALUE."A全案总可售户数",

CASE when 一级业态='车位仓储' and NVL(DT_VALUE."A全案总可售户数",0)<>0 then round(DT_VALUE."A全案总可售货值"/DT_VALUE."A全案总可售户数",4)
when 一级业态='车位仓储' and NVL(DT_VALUE."A全案总可售户数",0)=0 then 0
when 一级业态<>'车位仓储' and NVL(DT_VALUE."A全案总可售面积",0)<>0 then round(DT_VALUE."A全案总可售货值"/DT_VALUE."A全案总可售面积",4)
when 一级业态<>'车位仓储' and NVL(DT_VALUE."A全案总可售面积",0)=0 then 0 end  A全案总可售均价,

FN_DWN_divide10000(DT_VALUE."A全案总可售货值"),
DT_VALUE."B全案已售面积",
DT_VALUE."B全案已售套数",

CASE when 一级业态='车位仓储' and NVL(DT_VALUE."B全案已售套数",0)<>0 then round(DT_VALUE."B全案已售货值"/DT_VALUE."B全案已售套数",4)
when 一级业态='车位仓储' and NVL(DT_VALUE."B全案已售套数",0)=0 then 0
when 一级业态<>'车位仓储' and NVL(DT_VALUE."B全案已售面积",0)<>0 then round(DT_VALUE."B全案已售货值"/DT_VALUE."B全案已售面积",4)
when 一级业态<>'车位仓储' and NVL(DT_VALUE."B全案已售面积",0)=0 then 0 end  B全案已售均价,

FN_DWN_divide10000(DT_VALUE."B全案已售货值"),
DT_VALUE."C全案库存面积",
DT_VALUE."C全案库存套数",

CASE when 一级业态='车位仓储' and NVL(DT_VALUE."C全案库存套数",0)<>0 then round(DT_VALUE."C全案库存货值"/DT_VALUE."C全案库存套数",4)
when 一级业态='车位仓储' and NVL(DT_VALUE."C全案库存套数",0)=0 then 0
when 一级业态<>'车位仓储' and NVL(DT_VALUE."C全案库存面积",0)<>0 then round(DT_VALUE."C全案库存货值"/DT_VALUE."C全案库存面积",4)
when 一级业态<>'车位仓储' and NVL(DT_VALUE."C全案库存面积",0)=0 then 0 end  C全案库存均价,

FN_DWN_divide10000(DT_VALUE."C全案库存货值"),
DT_VALUE."D已取证面积",
DT_VALUE."D已取证套数",

CASE when 一级业态='车位仓储' and NVL(DT_VALUE."D已取证套数",0)<>0 then round(DT_VALUE."D已取证货值"/DT_VALUE."D已取证套数",4)
when 一级业态='车位仓储' and NVL(DT_VALUE."D已取证套数",0)=0 then 0
when 一级业态<>'车位仓储' and NVL(DT_VALUE."D已取证面积",0)<>0 then round(DT_VALUE."D已取证货值"/DT_VALUE."D已取证面积",4)
when 一级业态<>'车位仓储' and NVL(DT_VALUE."D已取证面积",0)=0 then 0 end  D已取证均价,

FN_DWN_divide10000(DT_VALUE."D已取证货值"),
DT_VALUE."E已取证库存面积",
DT_VALUE."E已取证库存套数",

CASE when 一级业态='车位仓储' and NVL(DT_VALUE."E已取证库存套数",0)<>0 then round(DT_VALUE."E已取证库存货值"/DT_VALUE."E已取证库存套数",4)
when 一级业态='车位仓储' and NVL(DT_VALUE."E已取证库存套数",0)=0 then 0
when 一级业态<>'车位仓储' and NVL(DT_VALUE."E已取证库存面积",0)<>0 then round(DT_VALUE."E已取证库存货值"/DT_VALUE."E已取证库存面积",4)
when 一级业态<>'车位仓储' and NVL(DT_VALUE."E已取证库存面积",0)=0 then 0 end  E已取证库存均价,

FN_DWN_divide10000(DT_VALUE."E已取证库存货值"),
sysdate,
NULL,
NULL
from (
select  proj_id,PROJECT_NAME,一级业态,
SUM(CASE when 总可售面积 is null then 0 else 总可售面积 end)  A全案总可售面积,
SUM(case when 一级业态='车位仓储' then NVL("总车位数",0) else NVL(总户数,0) end)  A全案总可售户数,
0 A全案总可售均价,
SUM(NVL( A_当前最新版目标货值,0))  A全案总可售货值,
SUM(NVL(已售建筑面积,0)) B全案已售面积,
SUM(NVL(已售套数,0)) B全案已售套数,
0 B全案已售均价,
SUM(NVL(已售货值,0)) B全案已售货值,
SUM(NVL(全案剩余面积,0)) C全案库存面积,
SUM(NVL(全案剩余套数,0)) C全案库存套数,
0 C全案库存均价,
SUM(NVL(全案剩余货值,0)) C全案库存货值,
SUM(NVL(已取证建筑面积,0)) D已取证面积,
SUM(NVL(已取证套数,0)) D已取证套数,
0 D已取证均价,
SUM(NVL(已取证货值,0)) D已取证货值,
SUM(NVL(库存建筑面积,0)) E已取证库存面积,
SUM(NVL(库存套数,0)) E已取证库存套数,
0 E已取证库存均价,
SUM(NVL( 库存货值,0)) E已取证库存货值
from V_SWM_DT_VALUE where V_SWM_DT_VALUE.OBJ_TYPE='宗地一级业态' GROUP by proj_id,PROJECT_NAME,一级业态) DT_VALUE
left join SWM_VALUE_INVENTORY_DTL  on DT_VALUE.proj_id=SWM_VALUE_INVENTORY_DTL.obj_id
left join SWM_VALUE_INVENTORY on SWM_VALUE_INVENTORY.ID=SWM_VALUE_INVENTORY_DTL.VALUE_INVENTORY_ID
left join MDM_BUILD_PRODUCT_TYPE on DT_VALUE.一级业态=MDM_BUILD_PRODUCT_TYPE.PRODUCT_TYPE_NAME
left join (select project_id from  sys_project_stage group by project_id) stage on stage.project_id= DT_VALUE.proj_id
where SWM_VALUE_INVENTORY_DTL.obj_type='按业态汇总' and MDM_BUILD_PRODUCT_TYPE.id is not null  and stage.project_id is null 
and to_char(SWM_VALUE_INVENTORY_DTL.CREATED,'yyyy-mm-dd')=currentDate and to_char(SWM_VALUE_INVENTORY.CREATED,'yyyy-mm-dd')=currentDate
and SWM_VALUE_INVENTORY.project_id=DT_VALUE.proj_id;


--宗地汇总数据
insert into SWM_VALUE_INVENTORY_DTL 
select  GET_UUID() ID,
SWM_VALUE_INVENTORY.id VALUE_INVENTORY_ID,
SWM_VALUE_INVENTORY_DTL.obj_id||'_'||SYS_PARCEL.ID BIZ_ID,
SWM_VALUE_INVENTORY_DTL.obj_id BIZ_PARENT_ID,
'宗地' OBJ_TYPE,
SYS_PARCEL.ID OBJ_ID,
SYS_PARCEL.PARCEL_NAME OBJ_NAME,
NULL BUILD_PRODUCT_TYPE_NAME,
NULL OWN_BUILD_PRODUCT_TYPE_ID,
NULL BUILD_PRODUCT_TYPE_ID,
SWM_VALUE_INVENTORY_DTL.ORDER_CODE||'_1'||lpad(regexp_substr(SYS_PARCEL.PARCEL_NAME, '[0-9]+'), 9, '0') ORDER_CODE,
DT_VALUE."A全案总可售面积",
DT_VALUE."A全案总可售户数",
DT_VALUE."A全案总可售均价",
FN_DWN_divide10000(DT_VALUE."A全案总可售货值"),
DT_VALUE."B全案已售面积",
DT_VALUE."B全案已售套数",
DT_VALUE."B全案已售均价",
FN_DWN_divide10000(DT_VALUE."B全案已售货值"),
DT_VALUE."C全案库存面积",
DT_VALUE."C全案库存套数",
DT_VALUE."C全案库存均价",
FN_DWN_divide10000(DT_VALUE."C全案库存货值"),
DT_VALUE."D已取证面积",
DT_VALUE."D已取证套数",
DT_VALUE."D已取证均价",
FN_DWN_divide10000(DT_VALUE."D已取证货值"),
DT_VALUE."E已取证库存面积",
DT_VALUE."E已取证库存套数",
DT_VALUE."E已取证库存均价",
FN_DWN_divide10000(DT_VALUE."E已取证库存货值"),
sysdate,
NULL,
NULL
from SYS_PARCEL
left join SWM_VALUE_INVENTORY_DTL on SYS_PARCEL.PROJECT_ID=SWM_VALUE_INVENTORY_DTL.obj_id 
left join SWM_VALUE_INVENTORY on SWM_VALUE_INVENTORY.id=SWM_VALUE_INVENTORY_DTL.VALUE_INVENTORY_ID
left join (SELECT
    v.proj_id,
    v.phase_name
FROM
    (
        SELECT
            a.proj_id,
            a.phase_order,
            b.phase_name
        FROM
            mdm_project_phase a
            LEFT JOIN (
                SELECT
                    id,
                    phase_name
                FROM
                    mdm_phase
            ) b ON a.phase_id = b.id
    ) v
    INNER JOIN (
        SELECT
            proj_id,
            MAX(phase_order) max
        FROM
            mdm_project_phase
        GROUP BY
            proj_id
    ) vv ON v.proj_id = vv.proj_id
            AND v.phase_order = vv.max
) stage on stage.proj_id= SYS_PARCEL.PROJECT_ID
right join (select STAGE_ID,STAGE_NAME,
SUM(CASE when 总可售面积 is null then 0 else 总可售面积 end)  A全案总可售面积,
SUM(case when 一级业态='车位仓储' then NVL("总车位数",0) else NVL(总户数,0) end)  A全案总可售户数,
0 A全案总可售均价,
SUM(NVL( A_当前最新版目标货值,0))  A全案总可售货值,
SUM(NVL(已售建筑面积,0)) B全案已售面积,
SUM(NVL(已售套数,0)) B全案已售套数,
0 B全案已售均价,
SUM(NVL(已售货值,0)) B全案已售货值,
SUM(NVL(全案剩余面积,0)) C全案库存面积,
SUM(NVL(全案剩余套数,0)) C全案库存套数,
0 C全案库存均价,
SUM(NVL(全案剩余货值,0)) C全案库存货值,
SUM(NVL(已取证建筑面积,0)) D已取证面积,
SUM(NVL(已取证套数,0)) D已取证套数,
0 D已取证均价,
SUM(NVL(已取证货值,0)) D已取证货值,
SUM(NVL(库存建筑面积,0)) E已取证库存面积,
SUM(NVL(库存套数,0)) E已取证库存套数,
0 E已取证库存均价,
SUM(NVL( 库存货值,0)) E已取证库存货值
from V_SWM_DT_VALUE where V_SWM_DT_VALUE.OBJ_TYPE='宗地一级业态'  GROUP by STAGE_ID,STAGE_NAME) DT_VALUE on DT_VALUE.STAGE_ID=SYS_PARCEL.id
where SWM_VALUE_INVENTORY_DTL.obj_type='项目' and stage.phase_name = '可研版'
and to_char(SWM_VALUE_INVENTORY_DTL.CREATED,'yyyy-mm-dd')=currentDate  and to_char(SWM_VALUE_INVENTORY.CREATED,'yyyy-mm-dd')=currentDate 
and to_char(SWM_VALUE_INVENTORY.CREATED,'yyyy-mm-dd')=currentDate
and SWM_VALUE_INVENTORY.ID=SWM_VALUE_INVENTORY_DTL.VALUE_INVENTORY_ID;


--分期汇总数据
insert into SWM_VALUE_INVENTORY_DTL 
select  GET_UUID() ID,
SWM_VALUE_INVENTORY.id VALUE_INVENTORY_ID,
SWM_VALUE_INVENTORY_DTL.obj_id||'_'||SYS_PROJECT_STAGE.ID BIZ_ID,
SWM_VALUE_INVENTORY_DTL.obj_id BIZ_PARENT_ID,
case when wfq.wfqid is null then '分期' else '无分期' end OBJ_TYPE,
SYS_PROJECT_STAGE.ID OBJ_ID,
SYS_PROJECT_STAGE.STAGE_NAME OBJ_NAME,
NULL BUILD_PRODUCT_TYPE_NAME,
NULL OWN_BUILD_PRODUCT_TYPE_ID,
NULL BUILD_PRODUCT_TYPE_ID,
SWM_VALUE_INVENTORY_DTL.ORDER_CODE||'_1'||SYS_PROJECT_STAGE.order_code ORDER_CODE,
DT_VALUE."A全案总可售面积",
DT_VALUE."A全案总可售户数",
DT_VALUE."A全案总可售均价",
FN_DWN_divide10000(DT_VALUE."A全案总可售货值"),
DT_VALUE."B全案已售面积",
DT_VALUE."B全案已售套数",
DT_VALUE."B全案已售均价",
FN_DWN_divide10000(DT_VALUE."B全案已售货值"),
DT_VALUE."C全案库存面积",
DT_VALUE."C全案库存套数",
DT_VALUE."C全案库存均价",
FN_DWN_divide10000(DT_VALUE."C全案库存货值"),
DT_VALUE."D已取证面积",
DT_VALUE."D已取证套数",
DT_VALUE."D已取证均价",
FN_DWN_divide10000(DT_VALUE."D已取证货值"),
DT_VALUE."E已取证库存面积",
DT_VALUE."E已取证库存套数",
DT_VALUE."E已取证库存均价",
FN_DWN_divide10000(DT_VALUE."E已取证库存货值"),
sysdate,
NULL,
NULL
from SYS_PROJECT_STAGE
left join SWM_VALUE_INVENTORY_DTL on SYS_PROJECT_STAGE.project_id=SWM_VALUE_INVENTORY_DTL.obj_id left join (select ID wfqid from (SELECT DISTINCT
            spg.id,
            spg.stage_name,
            COUNT(*) OVER(
                PARTITION BY sp.id
            ) AS cnt
        FROM
            sys_project         sp
LEFT JOIN sys_project_stage   spg ON spg.project_id = sp.id ) tab where tab.stage_name='无分期' and tab.cnt=1) wfq on wfq.wfqid=SYS_PROJECT_STAGE.id   
left join SWM_VALUE_INVENTORY on SWM_VALUE_INVENTORY.id=SWM_VALUE_INVENTORY_DTL.VALUE_INVENTORY_ID
left join (
SELECT
    v.proj_id,
    v.phase_name
FROM
    (
        SELECT
            a.proj_id,
            a.phase_order,
            b.phase_name
        FROM
            mdm_project_phase a
            LEFT JOIN (
                SELECT
                    id,
                    phase_name
                FROM
                    mdm_phase
            ) b ON a.phase_id = b.id
    ) v
    INNER JOIN (
        SELECT
            proj_id,
            MAX(phase_order) max
        FROM
            mdm_project_phase
        GROUP BY
            proj_id
    ) vv ON v.proj_id = vv.proj_id
            AND v.phase_order = vv.max
) stage on stage.proj_id= SYS_PROJECT_STAGE.PROJECT_ID
left join (select STAGE_ID,STAGE_NAME,
SUM(CASE when 总可售面积 is null then 0 else 总可售面积 end)  A全案总可售面积,
SUM(case when 一级业态='车位仓储' then NVL("总车位数",0) else NVL(总户数,0) end)  A全案总可售户数,
0 A全案总可售均价,
SUM(NVL( A_当前最新版目标货值,0))  A全案总可售货值,
SUM(NVL(已售建筑面积,0)) B全案已售面积,
SUM(NVL(已售套数,0)) B全案已售套数,
0 B全案已售均价,
SUM(NVL(已售货值,0)) B全案已售货值,
SUM(NVL(全案剩余面积,0)) C全案库存面积,
SUM(NVL(全案剩余套数,0)) C全案库存套数,
0 C全案库存均价,
SUM(NVL(全案剩余货值,0)) C全案库存货值,
SUM(NVL(已取证建筑面积,0)) D已取证面积,
SUM(NVL(已取证套数,0)) D已取证套数,
0 D已取证均价,
SUM(NVL(已取证货值,0)) D已取证货值,
SUM(NVL(库存建筑面积,0)) E已取证库存面积,
SUM(NVL(库存套数,0)) E已取证库存套数,
0 E已取证库存均价,
SUM(NVL( 库存货值,0)) E已取证库存货值
from V_SWM_DT_VALUE GROUP by STAGE_ID,STAGE_NAME) DT_VALUE on DT_VALUE.STAGE_ID=SYS_PROJECT_STAGE.id
where SWM_VALUE_INVENTORY_DTL.obj_type='项目' and to_char(SWM_VALUE_INVENTORY_DTL.CREATED,'yyyy-mm-dd')=currentDate
and stage.phase_name<>'可研版'
and to_char(SWM_VALUE_INVENTORY.CREATED,'yyyy-mm-dd')=currentDate and to_char(SWM_VALUE_INVENTORY.CREATED,'yyyy-mm-dd')=currentDate;


--楼栋，宗地，分期下一级业态的汇总数据
insert into SWM_VALUE_INVENTORY_DTL 
select 
GET_UUID() ID,
SWM_VALUE_INVENTORY_DTL.VALUE_INVENTORY_ID VALUE_INVENTORY_ID,
case when v_swm_dt_value.obj_type='楼栋一级业态'  then
v_swm_dt_value.proj_id||'_'||v_swm_dt_value.STAGE_ID||'_'||v_swm_dt_value.OBJ_ID||'_'||MDM_BUILD_PRODUCT_TYPE.id
when  v_swm_dt_value.obj_type='分期一级业态' or v_swm_dt_value.obj_type='宗地一级业态'  then
v_swm_dt_value.proj_id||'_'||v_swm_dt_value.STAGE_ID||'_'||MDM_BUILD_PRODUCT_TYPE.id
end BIZ_ID,
v_swm_dt_value.proj_id||'_'||v_swm_dt_value.STAGE_ID BIZ_PARENT_ID,
case  when v_swm_dt_value.obj_type='楼栋一级业态' then '楼栋'
when v_swm_dt_value.obj_type='分期一级业态' or v_swm_dt_value.obj_type='宗地一级业态'  then '业态' end OBJ_TYPE,
v_swm_dt_value.OBJ_ID,
v_swm_dt_value.OBJ_NAME,
V_SWM_DT_VALUE.一级业态 BUILD_PRODUCT_TYPE_NAME,
MDM_BUILD_PRODUCT_TYPE.id OWN_BUILD_PRODUCT_TYPE_ID,
MDM_BUILD_PRODUCT_TYPE.id BUILD_PRODUCT_TYPE_ID,
case  when v_swm_dt_value.obj_type='楼栋一级业态' then SWM_VALUE_INVENTORY_DTL.ORDER_CODE||'_'|| lpad(regexp_substr(MDM_BUILD.BUILD_NAME, '[0-9]+'), 9, '0') 
when v_swm_dt_value.obj_type='分期一级业态' or v_swm_dt_value.obj_type='宗地一级业态'  then SWM_VALUE_INVENTORY_DTL.ORDER_CODE||'_'||MDM_BUILD_PRODUCT_TYPE.PRODUCT_TYPE_CODE end ORDER_CODE,
CASE when 总可售面积 is null then 0 else 总可售面积 end  A全案总可售面积,
CASE when V_SWM_DT_VALUE.一级业态='车位仓储' then NVL(总车位数,0)
else NVL(总户数,0) end A全案总可售户数,

CASE when 一级业态='车位仓储' and NVL(总车位数,0)<>0 then round(A_当前最新版目标货值/总车位数,4)
when 一级业态='车位仓储' and NVL(总车位数,0)=0 then 0
when 一级业态<>'车位仓储' and NVL(总可售面积,0)<>0 then round(A_当前最新版目标货值/总可售面积,4)
when 一级业态<>'车位仓储' and NVL(总可售面积,0)=0 then 0 end  A全案总可售均价,

FN_DWN_divide10000(NVL(A_当前最新版目标货值,0))  A全案总可售货值,
CASE when 已售建筑面积 is null then 0 else 已售建筑面积 end  B全案已售面积,
CASE when 已售套数 is null then 0 else 已售套数 end  B全案已售套数,

CASE when 一级业态='车位仓储' and NVL(已售套数,0)<>0 then round(已售货值/已售套数,4)
when 一级业态='车位仓储' and NVL(已售套数,0)=0 then 0
when 一级业态<>'车位仓储' and NVL(已售建筑面积,0)<>0 then round(已售货值/已售建筑面积,4)
when 一级业态<>'车位仓储' and NVL(已售建筑面积,0)=0 then 0 end  B全案已售均价,

FN_DWN_divide10000(NVL(已售货值,0)) B全案已售货值,
CASE when 全案剩余面积 is null then 0 else 全案剩余面积 end  C全案库存面积,
CASE when 全案剩余套数 is null then 0 else 全案剩余套数 end  C全案库存套数,

CASE when 一级业态='车位仓储' and NVL(全案剩余套数,0)<>0 then round(全案剩余货值/全案剩余套数,4)
when 一级业态='车位仓储' and NVL(全案剩余套数,0)=0 then 0
when 一级业态<>'车位仓储' and NVL(全案剩余面积,0)<>0 then round(全案剩余货值/全案剩余面积,4)
when 一级业态<>'车位仓储' and NVL(全案剩余面积,0)=0 then 0 end  C全案库存均价,

FN_DWN_divide10000(NVL(全案剩余货值,0)) C全案库存货值,
CASE when 已取证建筑面积 is null then 0 else 已取证建筑面积 end  D已取证面积,
CASE when 已取证套数 is null then 0 else 已取证套数 end  D已取证套数,

CASE when 一级业态='车位仓储' and NVL(已取证套数,0)<>0 then round(已取证货值/已取证套数,4)
when 一级业态='车位仓储' and NVL(已取证套数,0)=0 then 0
when 一级业态<>'车位仓储' and NVL(已取证建筑面积,0)<>0 then round(已取证货值/已取证建筑面积,4)
when 一级业态<>'车位仓储' and NVL(已取证建筑面积,0)=0 then 0 end  D已取证均价,

FN_DWN_divide10000(NVL(已取证货值,0)) D已取证货值,
CASE when 库存建筑面积 is null then 0 else 库存建筑面积 end  E已取证库存面积,
CASE when 库存套数 is null then 0 else 库存套数 end  E已取证库存套数,

CASE when 一级业态='车位仓储' and NVL(库存套数,0)<>0 then round(库存货值/库存套数,4)
when 一级业态='车位仓储' and NVL(库存套数,0)=0 then 0
when 一级业态<>'车位仓储' and NVL(库存建筑面积,0)<>0 then round(库存货值/库存建筑面积,4)
when 一级业态<>'车位仓储' and NVL(库存建筑面积,0)=0 then 0 end  E已取证库存均价,
FN_DWN_divide10000(NVL(库存货值,0)) E已取证库存货值,
sysdate,
NULL,
NULL
from V_SWM_DT_VALUE right join SWM_VALUE_INVENTORY_DTL on v_swm_dt_value.stage_id=SWM_VALUE_INVENTORY_DTL.OBJ_ID
left join SWM_VALUE_INVENTORY on SWM_VALUE_INVENTORY.id=SWM_VALUE_INVENTORY_DTL.VALUE_INVENTORY_ID
left join MDM_BUILD_PRODUCT_TYPE on V_SWM_DT_VALUE.一级业态=MDM_BUILD_PRODUCT_TYPE.PRODUCT_TYPE_NAME
left join  MDM_BUILD on  MDM_BUILD.id=V_SWM_DT_VALUE.obj_id
where (SWM_VALUE_INVENTORY_DTL.obj_type='分期' or SWM_VALUE_INVENTORY_DTL.obj_type='无分期' or SWM_VALUE_INVENTORY_DTL.obj_type='宗地')
 and to_char(SWM_VALUE_INVENTORY_DTL.CREATED,'yyyy-mm-dd')=currentDate and to_char(SWM_VALUE_INVENTORY.CREATED,'yyyy-mm-dd')=currentDate
 and MDM_BUILD.BUILD_STATE=10 and SWM_VALUE_INVENTORY.ID=SWM_VALUE_INVENTORY_DTL.VALUE_INVENTORY_ID and V_SWM_DT_VALUE.一级业态 is not null;
commit;
END P_SWM_VALUE_DTL_EVERYDAY_LOG;

/
--------------------------------------------------------
--  DDL for Procedure P_SWM_YE_VALUE_DTL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SWM_YE_VALUE_DTL" (yearDate varchar)
is
currentyear varchar2(5);
currentDate varchar2(20);
ROWCONT NUMBER;
begin
    if yearDate is not null then
        dbms_output.put_line(yearDate);
        currentyear:=TO_CHAR(to_date(yearDate,'yyyy-mm-dd'),'yyyy');
        currentDate:=TO_CHAR(to_date(yearDate,'yyyy-mm-dd'),'yyyy-mm-dd');
    else
        currentyear:=TO_CHAR(sysdate,'yyyy');
        currentDate:=TO_CHAR(sysdate,'yyyy-mm-dd');
    end IF;
    execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd hh24:mi:ss''';
     if currentDate=currentyear||'-12-31' then
        dbms_output.put_line(currentyear);
         SELECT COUNT(1) INTO ROWCONT FROM SWM_YE_VALUE_INVENTORY WHERE TO_CHAR(CREATED,'yyyy')=currentyear;
         IF ROWCONT <> 0 THEN
            dbms_output.put_line(ROWCONT);
            delete SWM_YE_VALUE_INVENTORY_DTL WHERE TO_CHAR(CREATED,'yyyy')=currentyear;
            delete SWM_YE_VALUE_INVENTORY WHERE TO_CHAR(CREATED,'yyyy')=currentyear;
         END IF;
         P_SWM_YE_VALUE_DTL_HELP(
            yearDatestr => currentDate
          );
    end if;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_SWM_YE_VALUE_DTL_HELP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SWM_YE_VALUE_DTL_HELP" (yearDatestr in varchar)
is
yearDate date;
currentDate varchar2(20);
creatDate varchar2(20);
begin
     if yearDatestr is not null then
      currentDate:=yearDatestr;
      creatDate:=TO_CHAR(to_date(currentDate,'yyyy-mm-dd'),'yyyy')||'-12-31';
     else
    currentDate:=to_date(TO_CHAR(sysdate,'yyyy-mm-dd'),'yyyy-mm-dd');
    end if;
--年末货值盘点主表
insert into SWM_YE_VALUE_INVENTORY select GET_UUID(),ID,PROJECT_NAME,TO_Date(currentDate,'yyyy-mm-dd'),creatDate,NULL,NULL from sys_project;

--货值盘点明细 项目统计
insert into SWM_YE_VALUE_INVENTORY_DTL 
select GET_UUID() ID,
SWM_YE_VALUE_INVENTORY.id YE_VALUE_INVENTORY_ID,
SYS_PROJECT.ID BIZ_ID ,
null as BIZ_PARENT_ID,
'项目' OBJ_TYPE,
SYS_PROJECT.ID OBJ_ID,
SYS_PROJECT.PROJECT_NAME OBJ_NAME,
NULL BUILD_PRODUCT_TYPE_NAME,
NULL OWN_BUILD_PRODUCT_TYPE_ID,
NULL BUILD_PRODUCT_TYPE_ID,
case when SYS_PROJECT.SN is null then '000001' else  lpad(SYS_PROJECT.SN,6,'0')  end  ORDER_CODE,
DT_VALUE."A全案总可售面积",
DT_VALUE."A全案总可售户数",
DT_VALUE."A全案总可售均价",
FN_DWN_divide10000(DT_VALUE."A全案总可售货值"),
DT_VALUE."B全案已售面积",
DT_VALUE."B全案已售套数",
DT_VALUE."B全案已售均价",
FN_DWN_divide10000(DT_VALUE."B全案已售货值"),
DT_VALUE."C全案库存面积",
DT_VALUE."C全案库存套数",
DT_VALUE."C全案库存均价",
FN_DWN_divide10000(DT_VALUE."C全案库存货值"),
DT_VALUE."D已取证面积",
DT_VALUE."D已取证套数",
DT_VALUE."D已取证均价",
FN_DWN_divide10000(DT_VALUE."D已取证货值"),
DT_VALUE."E已取证库存面积",
DT_VALUE."E已取证库存套数",
DT_VALUE."E已取证库存均价",
FN_DWN_divide10000(DT_VALUE."E已取证库存货值"),
creatDate,
NULL,
NULL
from SYS_PROJECT left join SWM_YE_VALUE_INVENTORY on SYS_PROJECT.id=SWM_YE_VALUE_INVENTORY.project_id
left join (select project_id from  sys_project_stage group by project_id) stage on stage.project_id= SYS_PROJECT.id
left join (
select proj_id,PROJECT_NAME,
SUM(CASE when 总可售面积 is null then 0 else 总可售面积 end)  A全案总可售面积,
SUM(case when 一级业态='车位仓储' then NVL("总车位数",0) else NVL(总户数,0) end) A全案总可售户数,
0 A全案总可售均价,
SUM(NVL( A_当前最新版目标货值,0))  A全案总可售货值,
SUM(NVL(已售建筑面积,0)) B全案已售面积,
SUM(NVL(已售套数,0)) B全案已售套数,
0 B全案已售均价,
SUM(NVL(已售货值,0)) B全案已售货值,
SUM(NVL(全案剩余面积,0)) C全案库存面积,
SUM(NVL(全案剩余套数,0)) C全案库存套数,
0 C全案库存均价,
SUM(NVL(全案剩余货值,0)) C全案库存货值,
SUM(NVL(已取证建筑面积,0)) D已取证面积,
SUM(NVL(已取证套数,0)) D已取证套数,
0 D已取证均价,
SUM(NVL(已取证货值,0)) D已取证货值,
SUM(NVL(库存建筑面积,0)) E已取证库存面积,
SUM(NVL(库存套数,0)) E已取证库存套数,
0 E已取证库存均价,
SUM(NVL( 库存货值,0)) E已取证库存货值
from V_SWM_DT_VALUE where V_SWM_DT_VALUE.OBJ_TYPE<>'宗地一级业态'  GROUP by proj_id,PROJECT_NAME
) DT_VALUE on DT_VALUE.proj_id=SYS_PROJECT.id where stage.project_id is not null and to_char(SWM_YE_VALUE_INVENTORY.CREATED,'yyyy-mm-dd')=currentDate ;


insert into SWM_YE_VALUE_INVENTORY_DTL 
select GET_UUID() ID,
SWM_YE_VALUE_INVENTORY.id YE_VALUE_INVENTORY_ID,
SYS_PROJECT.ID BIZ_ID ,
null as BIZ_PARENT_ID,
'项目' OBJ_TYPE,
SYS_PROJECT.ID OBJ_ID,
SYS_PROJECT.PROJECT_NAME OBJ_NAME,
NULL BUILD_PRODUCT_TYPE_NAME,
NULL OWN_BUILD_PRODUCT_TYPE_ID,
NULL BUILD_PRODUCT_TYPE_ID,
case when SYS_PROJECT.SN is null then '000001' else  lpad(SYS_PROJECT.SN,6,'0')  end  ORDER_CODE,
DT_VALUE."A全案总可售面积",
DT_VALUE."A全案总可售户数",
DT_VALUE."A全案总可售均价",
FN_DWN_divide10000(DT_VALUE."A全案总可售货值"),
DT_VALUE."B全案已售面积",
DT_VALUE."B全案已售套数",
DT_VALUE."B全案已售均价",
FN_DWN_divide10000(DT_VALUE."B全案已售货值"),
DT_VALUE."C全案库存面积",
DT_VALUE."C全案库存套数",
DT_VALUE."C全案库存均价",
FN_DWN_divide10000(DT_VALUE."C全案库存货值"),
DT_VALUE."D已取证面积",
DT_VALUE."D已取证套数",
DT_VALUE."D已取证均价",
FN_DWN_divide10000(DT_VALUE."D已取证货值"),
DT_VALUE."E已取证库存面积",
DT_VALUE."E已取证库存套数",
DT_VALUE."E已取证库存均价",
FN_DWN_divide10000(DT_VALUE."E已取证库存货值"),
creatDate,
NULL,
NULL
from SYS_PROJECT left join SWM_YE_VALUE_INVENTORY on SYS_PROJECT.id=SWM_YE_VALUE_INVENTORY.project_id
left join (select project_id from  sys_project_stage group by project_id) stage on stage.project_id= SYS_PROJECT.id
left join (
select proj_id,PROJECT_NAME,
SUM(CASE when 总可售面积 is null then 0 else 总可售面积 end)  A全案总可售面积,
SUM(case when 一级业态='车位仓储' then NVL("总车位数",0) else NVL(总户数,0) end) A全案总可售户数,
0 A全案总可售均价,
SUM(NVL( A_当前最新版目标货值,0))  A全案总可售货值,
SUM(NVL(已售建筑面积,0)) B全案已售面积,
SUM(NVL(已售套数,0)) B全案已售套数,
0 B全案已售均价,
SUM(NVL(已售货值,0)) B全案已售货值,
SUM(NVL(全案剩余面积,0)) C全案库存面积,
SUM(NVL(全案剩余套数,0)) C全案库存套数,
0 C全案库存均价,
SUM(NVL(全案剩余货值,0)) C全案库存货值,
SUM(NVL(已取证建筑面积,0)) D已取证面积,
SUM(NVL(已取证套数,0)) D已取证套数,
0 D已取证均价,
SUM(NVL(已取证货值,0)) D已取证货值,
SUM(NVL(库存建筑面积,0)) E已取证库存面积,
SUM(NVL(库存套数,0)) E已取证库存套数,
0 E已取证库存均价,
SUM(NVL( 库存货值,0)) E已取证库存货值
from V_SWM_DT_VALUE where V_SWM_DT_VALUE.OBJ_TYPE='宗地一级业态'  GROUP by proj_id,PROJECT_NAME
) DT_VALUE on DT_VALUE.proj_id=SYS_PROJECT.id where stage.project_id is  null  and to_char(SWM_YE_VALUE_INVENTORY.CREATED,'yyyy-mm-dd')=currentDate ;


--按业态汇总行
insert into SWM_YE_VALUE_INVENTORY_DTL 
select GET_UUID() ID,
SWM_YE_VALUE_INVENTORY.id YE_VALUE_INVENTORY_ID,
SYS_PROJECT.ID||'_firstLevelProductTypeStatistics' BIZ_ID ,
SYS_PROJECT.ID as BIZ_PARENT_ID,
'按业态汇总' OBJ_TYPE,
SYS_PROJECT.ID OBJ_ID,
'按业态汇总' OBJ_NAME,
NULL BUILD_PRODUCT_TYPE_NAME,
NULL OWN_BUILD_PRODUCT_TYPE_ID,
NULL BUILD_PRODUCT_TYPE_ID,
case when SYS_PROJECT.SN is null then '000001_000000' else  lpad(SYS_PROJECT.SN,6,'0')||'_000000'  end  ORDER_CODE,
DT_VALUE."A全案总可售面积",
DT_VALUE."A全案总可售户数",
DT_VALUE."A全案总可售均价",
DT_VALUE."A全案总可售货值",
DT_VALUE."B全案已售面积",
DT_VALUE."B全案已售套数",
DT_VALUE."B全案已售均价",
DT_VALUE."B全案已售货值",
DT_VALUE."C全案库存面积",
DT_VALUE."C全案库存套数",
DT_VALUE."C全案库存均价",
DT_VALUE."C全案库存货值",
DT_VALUE."D已取证面积",
DT_VALUE."D已取证套数",
DT_VALUE."D已取证均价",
DT_VALUE."D已取证货值",
DT_VALUE."E已取证库存面积",
DT_VALUE."E已取证库存套数",
DT_VALUE."E已取证库存均价",
DT_VALUE."E已取证库存货值",
creatDate,
NULL,
NULL
from SYS_PROJECT left join SWM_YE_VALUE_INVENTORY on SYS_PROJECT.id=SWM_YE_VALUE_INVENTORY.project_id
right join (
select obj_id,
SUM(NVL(PO_TOTAL_SALE_AREA,0))  A全案总可售面积,
SUM(NVL(PO_TOTAL_SALE_COUNT,0))  A全案总可售户数,
0 A全案总可售均价,
SUM(NVL(PO_TOTAL_SALE_AMOUNT,0))  A全案总可售货值,
SUM(NVL(PO_SALE_AREA,0))  B全案已售面积,
SUM(NVL(PO_SALE_COUNT,0)) B全案已售套数,
0 B全案已售均价,
SUM(NVL(PO_SALE_AMOUNT,0))  B全案已售货值,
SUM(NVL(PO_SURPLUS_SALE_AREA,0)) C全案库存面积,
SUM(NVL(PO_SURPLUS_SALE_COUNT,0)) C全案库存套数,
0 C全案库存均价,
SUM(NVL(PO_SURPLUS_SALE_AMOUNT,0)) C全案库存货值,
SUM(NVL(RP_TOTAL_AREA,0)) D已取证面积,
SUM(NVL(RP_TOTAL_COUNT,0)) D已取证套数,
0 D已取证均价,
SUM(NVL(RP_TOTAL_AMOUNT,0)) D已取证货值,
SUM(NVL(RP_SURPLUS_AREA,0)) E已取证库存面积,
SUM(NVL(RP_SURPLUS_COUNT,0)) E已取证库存套数,
0 E已取证库存均价,
SUM(NVL(RP_SURPLUS_AMOUNT,0)) E已取证库存货值
from SWM_YE_VALUE_INVENTORY_DTL left join SWM_YE_VALUE_INVENTORY on SWM_YE_VALUE_INVENTORY_DTL.YE_VALUE_INVENTORY_ID =SWM_YE_VALUE_INVENTORY.id where obj_type='项目' and to_char(SWM_YE_VALUE_INVENTORY_DTL.CREATED,'yyyy-mm-dd')=currentDate
and to_char(SWM_YE_VALUE_INVENTORY.CREATED,'yyyy-mm-dd')=currentDate  GROUP by obj_id
) DT_VALUE on DT_VALUE.obj_id=SYS_PROJECT.id and to_char(SWM_YE_VALUE_INVENTORY.CREATED,'yyyy-mm-dd')=currentDate
and SWM_YE_VALUE_INVENTORY.project_id=DT_VALUE.obj_id;


--一级业态汇总行
insert into SWM_YE_VALUE_INVENTORY_DTL 
select GET_UUID() ID,
SWM_YE_VALUE_INVENTORY.ID YE_VALUE_INVENTORY_ID,
DT_VALUE.proj_id||'_'||MDM_BUILD_PRODUCT_TYPE.id BIZ_ID,
DT_VALUE.proj_id||'_firstLevelProductTypeStatistics' BIZ_PARENT_ID,
'一级业态' OBJ_TYPE,
MDM_BUILD_PRODUCT_TYPE.id OBJ_ID,
DT_VALUE.一级业态 OBJ_NAME,
DT_VALUE.一级业态 BUILD_PRODUCT_TYPE_NAME,
MDM_BUILD_PRODUCT_TYPE.id OWN_BUILD_PRODUCT_TYPE_ID,
MDM_BUILD_PRODUCT_TYPE.id  BUILD_PRODUCT_TYPE_ID,
SWM_YE_VALUE_INVENTORY_DTL.ORDER_CODE||'_'||MDM_BUILD_PRODUCT_TYPE.PRODUCT_TYPE_CODE ORDER_CODE,
DT_VALUE."A全案总可售面积",
DT_VALUE."A全案总可售户数",

CASE when 一级业态='车位仓储' and NVL(DT_VALUE."A全案总可售户数",0)<>0 then round(DT_VALUE."A全案总可售货值"/DT_VALUE."A全案总可售户数",4)
when 一级业态='车位仓储' and NVL(DT_VALUE."A全案总可售户数",0)=0 then 0
when 一级业态<>'车位仓储' and NVL(DT_VALUE."A全案总可售面积",0)<>0 then round(DT_VALUE."A全案总可售货值"/DT_VALUE."A全案总可售面积",4)
when 一级业态<>'车位仓储' and NVL(DT_VALUE."A全案总可售面积",0)=0 then 0 end  A全案总可售均价,

FN_DWN_divide10000(DT_VALUE."A全案总可售货值"),
DT_VALUE."B全案已售面积",
DT_VALUE."B全案已售套数",

CASE when 一级业态='车位仓储' and NVL(DT_VALUE."B全案已售套数",0)<>0 then round(DT_VALUE."B全案已售货值"/DT_VALUE."B全案已售套数",4)
when 一级业态='车位仓储' and NVL(DT_VALUE."B全案已售套数",0)=0 then 0
when 一级业态<>'车位仓储' and NVL(DT_VALUE."B全案已售面积",0)<>0 then round(DT_VALUE."B全案已售货值"/DT_VALUE."B全案已售面积",4)
when 一级业态<>'车位仓储' and NVL(DT_VALUE."B全案已售面积",0)=0 then 0 end  B全案已售均价,

FN_DWN_divide10000(DT_VALUE."B全案已售货值"),
DT_VALUE."C全案库存面积",
DT_VALUE."C全案库存套数",

CASE when 一级业态='车位仓储' and NVL(DT_VALUE."C全案库存套数",0)<>0 then round(DT_VALUE."C全案库存货值"/DT_VALUE."C全案库存套数",4)
when 一级业态='车位仓储' and NVL(DT_VALUE."C全案库存套数",0)=0 then 0
when 一级业态<>'车位仓储' and NVL(DT_VALUE."C全案库存面积",0)<>0 then round(DT_VALUE."C全案库存货值"/DT_VALUE."C全案库存面积",4)
when 一级业态<>'车位仓储' and NVL(DT_VALUE."C全案库存面积",0)=0 then 0 end  C全案库存均价,

FN_DWN_divide10000(DT_VALUE."C全案库存货值"),
DT_VALUE."D已取证面积",
DT_VALUE."D已取证套数",

CASE when 一级业态='车位仓储' and NVL(DT_VALUE."D已取证套数",0)<>0 then round(DT_VALUE."D已取证货值"/DT_VALUE."D已取证套数",4)
when 一级业态='车位仓储' and NVL(DT_VALUE."D已取证套数",0)=0 then 0
when 一级业态<>'车位仓储' and NVL(DT_VALUE."D已取证面积",0)<>0 then round(DT_VALUE."D已取证货值"/DT_VALUE."D已取证面积",4)
when 一级业态<>'车位仓储' and NVL(DT_VALUE."D已取证面积",0)=0 then 0 end  D已取证均价,

FN_DWN_divide10000(DT_VALUE."D已取证货值"),
DT_VALUE."E已取证库存面积",
DT_VALUE."E已取证库存套数",

CASE when 一级业态='车位仓储' and NVL(DT_VALUE."E已取证库存套数",0)<>0 then round(DT_VALUE."E已取证库存货值"/DT_VALUE."E已取证库存套数",4)
when 一级业态='车位仓储' and NVL(DT_VALUE."E已取证库存套数",0)=0 then 0
when 一级业态<>'车位仓储' and NVL(DT_VALUE."E已取证库存面积",0)<>0 then round(DT_VALUE."E已取证库存货值"/DT_VALUE."E已取证库存面积",4)
when 一级业态<>'车位仓储' and NVL(DT_VALUE."E已取证库存面积",0)=0 then 0 end  E已取证库存均价,

FN_DWN_divide10000(DT_VALUE."E已取证库存货值"),
creatDate,
NULL,
NULL
from (
select  proj_id,PROJECT_NAME,一级业态,
SUM(CASE when 总可售面积 is null then 0 else 总可售面积 end)  A全案总可售面积,
SUM(case when 一级业态='车位仓储' then NVL("总车位数",0) else NVL(总户数,0) end) A全案总可售户数,
0 A全案总可售均价,
SUM(NVL( A_当前最新版目标货值,0))  A全案总可售货值,
SUM(NVL(已售建筑面积,0)) B全案已售面积,
SUM(NVL(已售套数,0)) B全案已售套数,
0 B全案已售均价,
SUM(NVL(已售货值,0)) B全案已售货值,
SUM(NVL(全案剩余面积,0)) C全案库存面积,
SUM(NVL(全案剩余套数,0)) C全案库存套数,
0 C全案库存均价,
SUM(NVL(全案剩余货值,0)) C全案库存货值,
SUM(NVL(已取证建筑面积,0)) D已取证面积,
SUM(NVL(已取证套数,0)) D已取证套数,
0 D已取证均价,
SUM(NVL(已取证货值,0)) D已取证货值,
SUM(NVL(库存建筑面积,0)) E已取证库存面积,
SUM(NVL(库存套数,0)) E已取证库存套数,
0 E已取证库存均价,
SUM(NVL( 库存货值,0)) E已取证库存货值
from V_SWM_DT_VALUE where V_SWM_DT_VALUE.OBJ_TYPE<>'宗地一级业态' GROUP by proj_id,PROJECT_NAME,一级业态) DT_VALUE
left join SWM_YE_VALUE_INVENTORY_DTL  on DT_VALUE.proj_id=SWM_YE_VALUE_INVENTORY_DTL.obj_id
left join SWM_YE_VALUE_INVENTORY on SWM_YE_VALUE_INVENTORY.ID=SWM_YE_VALUE_INVENTORY_DTL.YE_VALUE_INVENTORY_ID
left join MDM_BUILD_PRODUCT_TYPE on DT_VALUE.一级业态=MDM_BUILD_PRODUCT_TYPE.PRODUCT_TYPE_NAME
left join (select project_id from  sys_project_stage group by project_id) stage on stage.project_id= DT_VALUE.proj_id
where SWM_YE_VALUE_INVENTORY_DTL.obj_type='按业态汇总' and MDM_BUILD_PRODUCT_TYPE.id is not null  and stage.project_id is not null
and to_char(SWM_YE_VALUE_INVENTORY_DTL.CREATED,'yyyy-mm-dd')=currentDate and to_char(SWM_YE_VALUE_INVENTORY.CREATED,'yyyy-mm-dd')=currentDate
and SWM_YE_VALUE_INVENTORY.project_id=DT_VALUE.proj_id
union
select GET_UUID() ID,
SWM_YE_VALUE_INVENTORY.ID YE_VALUE_INVENTORY_ID,
DT_VALUE.proj_id||'_'||MDM_BUILD_PRODUCT_TYPE.id BIZ_ID,
DT_VALUE.proj_id||'_firstLevelProductTypeStatistics' BIZ_PARENT_ID,
'一级业态' OBJ_TYPE,
MDM_BUILD_PRODUCT_TYPE.id OBJ_ID,
DT_VALUE.一级业态 OBJ_NAME,
DT_VALUE.一级业态 BUILD_PRODUCT_TYPE_NAME,
MDM_BUILD_PRODUCT_TYPE.id OWN_BUILD_PRODUCT_TYPE_ID,
MDM_BUILD_PRODUCT_TYPE.id  BUILD_PRODUCT_TYPE_ID,
SWM_YE_VALUE_INVENTORY_DTL.ORDER_CODE||'_'||MDM_BUILD_PRODUCT_TYPE.PRODUCT_TYPE_CODE ORDER_CODE,
DT_VALUE."A全案总可售面积",
DT_VALUE."A全案总可售户数",

CASE when 一级业态='车位仓储' and NVL(DT_VALUE."A全案总可售户数",0)<>0 then round(DT_VALUE."A全案总可售货值"/DT_VALUE."A全案总可售户数",4)
when 一级业态='车位仓储' and NVL(DT_VALUE."A全案总可售户数",0)=0 then 0
when 一级业态<>'车位仓储' and NVL(DT_VALUE."A全案总可售面积",0)<>0 then round(DT_VALUE."A全案总可售货值"/DT_VALUE."A全案总可售面积",4)
when 一级业态<>'车位仓储' and NVL(DT_VALUE."A全案总可售面积",0)=0 then 0 end  A全案总可售均价,

FN_DWN_divide10000(DT_VALUE."A全案总可售货值"),
DT_VALUE."B全案已售面积",
DT_VALUE."B全案已售套数",

CASE when 一级业态='车位仓储' and NVL(DT_VALUE."B全案已售套数",0)<>0 then round(DT_VALUE."B全案已售货值"/DT_VALUE."B全案已售套数",4)
when 一级业态='车位仓储' and NVL(DT_VALUE."B全案已售套数",0)=0 then 0
when 一级业态<>'车位仓储' and NVL(DT_VALUE."B全案已售面积",0)<>0 then round(DT_VALUE."B全案已售货值"/DT_VALUE."B全案已售面积",4)
when 一级业态<>'车位仓储' and NVL(DT_VALUE."B全案已售面积",0)=0 then 0 end  B全案已售均价,

FN_DWN_divide10000(DT_VALUE."B全案已售货值"),
DT_VALUE."C全案库存面积",
DT_VALUE."C全案库存套数",

CASE when 一级业态='车位仓储' and NVL(DT_VALUE."C全案库存套数",0)<>0 then round(DT_VALUE."C全案库存货值"/DT_VALUE."C全案库存套数",4)
when 一级业态='车位仓储' and NVL(DT_VALUE."C全案库存套数",0)=0 then 0
when 一级业态<>'车位仓储' and NVL(DT_VALUE."C全案库存面积",0)<>0 then round(DT_VALUE."C全案库存货值"/DT_VALUE."C全案库存面积",4)
when 一级业态<>'车位仓储' and NVL(DT_VALUE."C全案库存面积",0)=0 then 0 end  C全案库存均价,

FN_DWN_divide10000(DT_VALUE."C全案库存货值"),
DT_VALUE."D已取证面积",
DT_VALUE."D已取证套数",

CASE when 一级业态='车位仓储' and NVL(DT_VALUE."D已取证套数",0)<>0 then round(DT_VALUE."D已取证货值"/DT_VALUE."D已取证套数",4)
when 一级业态='车位仓储' and NVL(DT_VALUE."D已取证套数",0)=0 then 0
when 一级业态<>'车位仓储' and NVL(DT_VALUE."D已取证面积",0)<>0 then round(DT_VALUE."D已取证货值"/DT_VALUE."D已取证面积",4)
when 一级业态<>'车位仓储' and NVL(DT_VALUE."D已取证面积",0)=0 then 0 end  D已取证均价,

FN_DWN_divide10000(DT_VALUE."D已取证货值"),
DT_VALUE."E已取证库存面积",
DT_VALUE."E已取证库存套数",

CASE when 一级业态='车位仓储' and NVL(DT_VALUE."E已取证库存套数",0)<>0 then round(DT_VALUE."E已取证库存货值"/DT_VALUE."E已取证库存套数",4)
when 一级业态='车位仓储' and NVL(DT_VALUE."E已取证库存套数",0)=0 then 0
when 一级业态<>'车位仓储' and NVL(DT_VALUE."E已取证库存面积",0)<>0 then round(DT_VALUE."E已取证库存货值"/DT_VALUE."E已取证库存面积",4)
when 一级业态<>'车位仓储' and NVL(DT_VALUE."E已取证库存面积",0)=0 then 0 end  E已取证库存均价,

FN_DWN_divide10000(DT_VALUE."E已取证库存货值"),
creatDate,
NULL,
NULL
from (
select  proj_id,PROJECT_NAME,一级业态,
SUM(CASE when 总可售面积 is null then 0 else 总可售面积 end)  A全案总可售面积,
SUM(case when 一级业态='车位仓储' then NVL("总车位数",0) else NVL(总户数,0) end)  A全案总可售户数,
0 A全案总可售均价,
SUM(NVL( A_当前最新版目标货值,0))  A全案总可售货值,
SUM(NVL(已售建筑面积,0)) B全案已售面积,
SUM(NVL(已售套数,0)) B全案已售套数,
0 B全案已售均价,
SUM(NVL(已售货值,0)) B全案已售货值,
SUM(NVL(全案剩余面积,0)) C全案库存面积,
SUM(NVL(全案剩余套数,0)) C全案库存套数,
0 C全案库存均价,
SUM(NVL(全案剩余货值,0)) C全案库存货值,
SUM(NVL(已取证建筑面积,0)) D已取证面积,
SUM(NVL(已取证套数,0)) D已取证套数,
0 D已取证均价,
SUM(NVL(已取证货值,0)) D已取证货值,
SUM(NVL(库存建筑面积,0)) E已取证库存面积,
SUM(NVL(库存套数,0)) E已取证库存套数,
0 E已取证库存均价,
SUM(NVL( 库存货值,0)) E已取证库存货值
from V_SWM_DT_VALUE where V_SWM_DT_VALUE.OBJ_TYPE='宗地一级业态' GROUP by proj_id,PROJECT_NAME,一级业态) DT_VALUE
left join SWM_YE_VALUE_INVENTORY_DTL  on DT_VALUE.proj_id=SWM_YE_VALUE_INVENTORY_DTL.obj_id
left join SWM_YE_VALUE_INVENTORY on SWM_YE_VALUE_INVENTORY.ID=SWM_YE_VALUE_INVENTORY_DTL.YE_VALUE_INVENTORY_ID
left join MDM_BUILD_PRODUCT_TYPE on DT_VALUE.一级业态=MDM_BUILD_PRODUCT_TYPE.PRODUCT_TYPE_NAME
left join (select project_id from  sys_project_stage group by project_id) stage on stage.project_id= DT_VALUE.proj_id
where SWM_YE_VALUE_INVENTORY_DTL.obj_type='按业态汇总' and MDM_BUILD_PRODUCT_TYPE.id is not null  and stage.project_id is null 
and to_char(SWM_YE_VALUE_INVENTORY_DTL.CREATED,'yyyy-mm-dd')=currentDate and to_char(SWM_YE_VALUE_INVENTORY.CREATED,'yyyy-mm-dd')=currentDate
and SWM_YE_VALUE_INVENTORY.project_id=DT_VALUE.proj_id;


--宗地汇总数据
insert into SWM_YE_VALUE_INVENTORY_DTL 
select  GET_UUID() ID,
SWM_YE_VALUE_INVENTORY.id YE_VALUE_INVENTORY_ID,
SWM_YE_VALUE_INVENTORY_DTL.obj_id||'_'||SYS_PARCEL.ID BIZ_ID,
SWM_YE_VALUE_INVENTORY_DTL.obj_id BIZ_PARENT_ID,
'宗地' OBJ_TYPE,
SYS_PARCEL.ID OBJ_ID,
SYS_PARCEL.PARCEL_NAME OBJ_NAME,
NULL BUILD_PRODUCT_TYPE_NAME,
NULL OWN_BUILD_PRODUCT_TYPE_ID,
NULL BUILD_PRODUCT_TYPE_ID,
SWM_YE_VALUE_INVENTORY_DTL.ORDER_CODE||'_1'||lpad(regexp_substr(SYS_PARCEL.PARCEL_NAME, '[0-9]+'), 9, '0') ORDER_CODE,
DT_VALUE."A全案总可售面积",
DT_VALUE."A全案总可售户数",
DT_VALUE."A全案总可售均价",
FN_DWN_divide10000(DT_VALUE."A全案总可售货值"),
DT_VALUE."B全案已售面积",
DT_VALUE."B全案已售套数",
DT_VALUE."B全案已售均价",
FN_DWN_divide10000(DT_VALUE."B全案已售货值"),
DT_VALUE."C全案库存面积",
DT_VALUE."C全案库存套数",
DT_VALUE."C全案库存均价",
FN_DWN_divide10000(DT_VALUE."C全案库存货值"),
DT_VALUE."D已取证面积",
DT_VALUE."D已取证套数",
DT_VALUE."D已取证均价",
FN_DWN_divide10000(DT_VALUE."D已取证货值"),
DT_VALUE."E已取证库存面积",
DT_VALUE."E已取证库存套数",
DT_VALUE."E已取证库存均价",
FN_DWN_divide10000(DT_VALUE."E已取证库存货值"),
creatDate,
NULL,
NULL
from SYS_PARCEL
left join SWM_YE_VALUE_INVENTORY_DTL on SYS_PARCEL.PROJECT_ID=SWM_YE_VALUE_INVENTORY_DTL.obj_id 
left join SWM_YE_VALUE_INVENTORY on SWM_YE_VALUE_INVENTORY.id=SWM_YE_VALUE_INVENTORY_DTL.YE_VALUE_INVENTORY_ID
left join (SELECT
    v.proj_id,
    v.phase_name
FROM
    (
        SELECT
            a.proj_id,
            a.phase_order,
            b.phase_name
        FROM
            mdm_project_phase a
            LEFT JOIN (
                SELECT
                    id,
                    phase_name
                FROM
                    mdm_phase
            ) b ON a.phase_id = b.id
    ) v
    INNER JOIN (
        SELECT
            proj_id,
            MAX(phase_order) max
        FROM
            mdm_project_phase
        GROUP BY
            proj_id
    ) vv ON v.proj_id = vv.proj_id
            AND v.phase_order = vv.max
) stage on stage.proj_id= SYS_PARCEL.PROJECT_ID
right join (select STAGE_ID,STAGE_NAME,
SUM(CASE when 总可售面积 is null then 0 else 总可售面积 end)  A全案总可售面积,
SUM(case when 一级业态='车位仓储' then NVL("总车位数",0) else NVL(总户数,0) end)  A全案总可售户数,
0 A全案总可售均价,
SUM(NVL( A_当前最新版目标货值,0))  A全案总可售货值,
SUM(NVL(已售建筑面积,0)) B全案已售面积,
SUM(NVL(已售套数,0)) B全案已售套数,
0 B全案已售均价,
SUM(NVL(已售货值,0)) B全案已售货值,
SUM(NVL(全案剩余面积,0)) C全案库存面积,
SUM(NVL(全案剩余套数,0)) C全案库存套数,
0 C全案库存均价,
SUM(NVL(全案剩余货值,0)) C全案库存货值,
SUM(NVL(已取证建筑面积,0)) D已取证面积,
SUM(NVL(已取证套数,0)) D已取证套数,
0 D已取证均价,
SUM(NVL(已取证货值,0)) D已取证货值,
SUM(NVL(库存建筑面积,0)) E已取证库存面积,
SUM(NVL(库存套数,0)) E已取证库存套数,
0 E已取证库存均价,
SUM(NVL( 库存货值,0)) E已取证库存货值
from V_SWM_DT_VALUE where V_SWM_DT_VALUE.OBJ_TYPE='宗地一级业态'  GROUP by STAGE_ID,STAGE_NAME) DT_VALUE on DT_VALUE.STAGE_ID=SYS_PARCEL.id
where SWM_YE_VALUE_INVENTORY_DTL.obj_type='项目' and stage.phase_name = '可研版'
and to_char(SWM_YE_VALUE_INVENTORY_DTL.CREATED,'yyyy-mm-dd')=currentDate  and to_char(SWM_YE_VALUE_INVENTORY.CREATED,'yyyy-mm-dd')=currentDate 
and to_char(SWM_YE_VALUE_INVENTORY.CREATED,'yyyy-mm-dd')=currentDate
and SWM_YE_VALUE_INVENTORY.ID=SWM_YE_VALUE_INVENTORY_DTL.YE_VALUE_INVENTORY_ID;


--分期汇总数据
insert into SWM_YE_VALUE_INVENTORY_DTL 
select  GET_UUID() ID,
SWM_YE_VALUE_INVENTORY.id YE_VALUE_INVENTORY_ID,
SWM_YE_VALUE_INVENTORY_DTL.obj_id||'_'||SYS_PROJECT_STAGE.ID BIZ_ID,
SWM_YE_VALUE_INVENTORY_DTL.obj_id BIZ_PARENT_ID,
case when wfq.wfqid is null then '分期' else '无分期' end OBJ_TYPE,
SYS_PROJECT_STAGE.ID OBJ_ID,
SYS_PROJECT_STAGE.STAGE_NAME OBJ_NAME,
NULL BUILD_PRODUCT_TYPE_NAME,
NULL OWN_BUILD_PRODUCT_TYPE_ID,
NULL BUILD_PRODUCT_TYPE_ID,
SWM_YE_VALUE_INVENTORY_DTL.ORDER_CODE||'_1'||SYS_PROJECT_STAGE.order_code ORDER_CODE,
DT_VALUE."A全案总可售面积",
DT_VALUE."A全案总可售户数",
DT_VALUE."A全案总可售均价",
FN_DWN_divide10000(DT_VALUE."A全案总可售货值"),
DT_VALUE."B全案已售面积",
DT_VALUE."B全案已售套数",
DT_VALUE."B全案已售均价",
FN_DWN_divide10000(DT_VALUE."B全案已售货值"),
DT_VALUE."C全案库存面积",
DT_VALUE."C全案库存套数",
DT_VALUE."C全案库存均价",
FN_DWN_divide10000(DT_VALUE."C全案库存货值"),
DT_VALUE."D已取证面积",
DT_VALUE."D已取证套数",
DT_VALUE."D已取证均价",
FN_DWN_divide10000(DT_VALUE."D已取证货值"),
DT_VALUE."E已取证库存面积",
DT_VALUE."E已取证库存套数",
DT_VALUE."E已取证库存均价",
FN_DWN_divide10000(DT_VALUE."E已取证库存货值"),
creatDate,
NULL,
NULL
from SYS_PROJECT_STAGE
left join SWM_YE_VALUE_INVENTORY_DTL on SYS_PROJECT_STAGE.project_id=SWM_YE_VALUE_INVENTORY_DTL.obj_id left join (select ID wfqid from (SELECT DISTINCT
            spg.id,
            spg.stage_name,
            COUNT(*) OVER(
                PARTITION BY sp.id
            ) AS cnt
        FROM
            sys_project         sp
LEFT JOIN sys_project_stage   spg ON spg.project_id = sp.id ) tab where tab.stage_name='无分期' and tab.cnt=1) wfq on wfq.wfqid=SYS_PROJECT_STAGE.id   
left join SWM_YE_VALUE_INVENTORY on SWM_YE_VALUE_INVENTORY.id=SWM_YE_VALUE_INVENTORY_DTL.YE_VALUE_INVENTORY_ID
left join (
SELECT
    v.proj_id,
    v.phase_name
FROM
    (
        SELECT
            a.proj_id,
            a.phase_order,
            b.phase_name
        FROM
            mdm_project_phase a
            LEFT JOIN (
                SELECT
                    id,
                    phase_name
                FROM
                    mdm_phase
            ) b ON a.phase_id = b.id
    ) v
    INNER JOIN (
        SELECT
            proj_id,
            MAX(phase_order) max
        FROM
            mdm_project_phase
        GROUP BY
            proj_id
    ) vv ON v.proj_id = vv.proj_id
            AND v.phase_order = vv.max
) stage on stage.proj_id= SYS_PROJECT_STAGE.PROJECT_ID
left join (select STAGE_ID,STAGE_NAME,
SUM(CASE when 总可售面积 is null then 0 else 总可售面积 end)  A全案总可售面积,
SUM(case when 一级业态='车位仓储' then NVL("总车位数",0) else NVL(总户数,0) end)  A全案总可售户数,
0 A全案总可售均价,
SUM(NVL( A_当前最新版目标货值,0))  A全案总可售货值,
SUM(NVL(已售建筑面积,0)) B全案已售面积,
SUM(NVL(已售套数,0)) B全案已售套数,
0 B全案已售均价,
SUM(NVL(已售货值,0)) B全案已售货值,
SUM(NVL(全案剩余面积,0)) C全案库存面积,
SUM(NVL(全案剩余套数,0)) C全案库存套数,
0 C全案库存均价,
SUM(NVL(全案剩余货值,0)) C全案库存货值,
SUM(NVL(已取证建筑面积,0)) D已取证面积,
SUM(NVL(已取证套数,0)) D已取证套数,
0 D已取证均价,
SUM(NVL(已取证货值,0)) D已取证货值,
SUM(NVL(库存建筑面积,0)) E已取证库存面积,
SUM(NVL(库存套数,0)) E已取证库存套数,
0 E已取证库存均价,
SUM(NVL( 库存货值,0)) E已取证库存货值
from V_SWM_DT_VALUE GROUP by STAGE_ID,STAGE_NAME) DT_VALUE on DT_VALUE.STAGE_ID=SYS_PROJECT_STAGE.id
where SWM_YE_VALUE_INVENTORY_DTL.obj_type='项目' and to_char(SWM_YE_VALUE_INVENTORY_DTL.CREATED,'yyyy-mm-dd')=currentDate
and stage.phase_name<>'可研版'
and to_char(SWM_YE_VALUE_INVENTORY.CREATED,'yyyy-mm-dd')=currentDate and to_char(SWM_YE_VALUE_INVENTORY.CREATED,'yyyy-mm-dd')=currentDate;


--楼栋，宗地，分期下一级业态的汇总数据
insert into SWM_YE_VALUE_INVENTORY_DTL 
select 
GET_UUID() ID,
SWM_YE_VALUE_INVENTORY_DTL.YE_VALUE_INVENTORY_ID YE_VALUE_INVENTORY_ID,
case when v_swm_dt_value.obj_type='楼栋一级业态'  then
v_swm_dt_value.proj_id||'_'||v_swm_dt_value.STAGE_ID||'_'||v_swm_dt_value.OBJ_ID||'_'||MDM_BUILD_PRODUCT_TYPE.id
when  v_swm_dt_value.obj_type='分期一级业态' or v_swm_dt_value.obj_type='宗地一级业态'  then
v_swm_dt_value.proj_id||'_'||v_swm_dt_value.STAGE_ID||'_'||MDM_BUILD_PRODUCT_TYPE.id
end BIZ_ID,
v_swm_dt_value.proj_id||'_'||v_swm_dt_value.STAGE_ID BIZ_PARENT_ID,
case  when v_swm_dt_value.obj_type='楼栋一级业态' then '楼栋'
when v_swm_dt_value.obj_type='分期一级业态' or v_swm_dt_value.obj_type='宗地一级业态'  then '业态' end OBJ_TYPE,
v_swm_dt_value.OBJ_ID,
v_swm_dt_value.OBJ_NAME,
V_SWM_DT_VALUE.一级业态 BUILD_PRODUCT_TYPE_NAME,
MDM_BUILD_PRODUCT_TYPE.id OWN_BUILD_PRODUCT_TYPE_ID,
MDM_BUILD_PRODUCT_TYPE.id BUILD_PRODUCT_TYPE_ID,
case  when v_swm_dt_value.obj_type='楼栋一级业态' then SWM_YE_VALUE_INVENTORY_DTL.ORDER_CODE||'_'|| lpad(regexp_substr(MDM_BUILD.BUILD_NAME, '[0-9]+'), 9, '0') 
when v_swm_dt_value.obj_type='分期一级业态' or v_swm_dt_value.obj_type='宗地一级业态'  then SWM_YE_VALUE_INVENTORY_DTL.ORDER_CODE||'_'||MDM_BUILD_PRODUCT_TYPE.PRODUCT_TYPE_CODE end ORDER_CODE,
CASE when 总可售面积 is null then 0 else 总可售面积 end  A全案总可售面积,
CASE when V_SWM_DT_VALUE.一级业态='车位仓储' then NVL(总车位数,0)
else NVL(总户数,0) end A全案总可售户数,

CASE when 一级业态='车位仓储' and NVL(总车位数,0)<>0 then round(A_当前最新版目标货值/总车位数,4)
when 一级业态='车位仓储' and NVL(总车位数,0)=0 then 0
when 一级业态<>'车位仓储' and NVL(总可售面积,0)<>0 then round(A_当前最新版目标货值/总可售面积,4)
when 一级业态<>'车位仓储' and NVL(总可售面积,0)=0 then 0 end  A全案总可售均价,

FN_DWN_divide10000(NVL(A_当前最新版目标货值,0))  A全案总可售货值,
CASE when 已售建筑面积 is null then 0 else 已售建筑面积 end  B全案已售面积,
CASE when 已售套数 is null then 0 else 已售套数 end  B全案已售套数,

CASE when 一级业态='车位仓储' and NVL(已售套数,0)<>0 then round(已售货值/已售套数,4)
when 一级业态='车位仓储' and NVL(已售套数,0)=0 then 0
when 一级业态<>'车位仓储' and NVL(已售建筑面积,0)<>0 then round(已售货值/已售建筑面积,4)
when 一级业态<>'车位仓储' and NVL(已售建筑面积,0)=0 then 0 end  B全案已售均价,

FN_DWN_divide10000(NVL(已售货值,0)) B全案已售货值,
CASE when 全案剩余面积 is null then 0 else 全案剩余面积 end  C全案库存面积,
CASE when 全案剩余套数 is null then 0 else 全案剩余套数 end  C全案库存套数,

CASE when 一级业态='车位仓储' and NVL(全案剩余套数,0)<>0 then round(全案剩余货值/全案剩余套数,4)
when 一级业态='车位仓储' and NVL(全案剩余套数,0)=0 then 0
when 一级业态<>'车位仓储' and NVL(全案剩余面积,0)<>0 then round(全案剩余货值/全案剩余面积,4)
when 一级业态<>'车位仓储' and NVL(全案剩余面积,0)=0 then 0 end  C全案库存均价,

FN_DWN_divide10000(NVL(全案剩余货值,0)) C全案库存货值,
CASE when 已取证建筑面积 is null then 0 else 已取证建筑面积 end  D已取证面积,
CASE when 已取证套数 is null then 0 else 已取证套数 end  D已取证套数,

CASE when 一级业态='车位仓储' and NVL(已取证套数,0)<>0 then round(已取证货值/已取证套数,4)
when 一级业态='车位仓储' and NVL(已取证套数,0)=0 then 0
when 一级业态<>'车位仓储' and NVL(已取证建筑面积,0)<>0 then round(已取证货值/已取证建筑面积,4)
when 一级业态<>'车位仓储' and NVL(已取证建筑面积,0)=0 then 0 end  D已取证均价,

FN_DWN_divide10000(NVL(已取证货值,0)) D已取证货值,
CASE when 库存建筑面积 is null then 0 else 库存建筑面积 end  E已取证库存面积,
CASE when 库存套数 is null then 0 else 库存套数 end  E已取证库存套数,

CASE when 一级业态='车位仓储' and NVL(库存套数,0)<>0 then round(库存货值/库存套数,4)
when 一级业态='车位仓储' and NVL(库存套数,0)=0 then 0
when 一级业态<>'车位仓储' and NVL(库存建筑面积,0)<>0 then round(库存货值/库存建筑面积,4)
when 一级业态<>'车位仓储' and NVL(库存建筑面积,0)=0 then 0 end  E已取证库存均价,
FN_DWN_divide10000(NVL(库存货值,0)) E已取证库存货值,
creatDate,
NULL,
NULL
from V_SWM_DT_VALUE right join SWM_YE_VALUE_INVENTORY_DTL on v_swm_dt_value.stage_id=SWM_YE_VALUE_INVENTORY_DTL.OBJ_ID
left join SWM_YE_VALUE_INVENTORY on SWM_YE_VALUE_INVENTORY.id=SWM_YE_VALUE_INVENTORY_DTL.YE_VALUE_INVENTORY_ID
left join MDM_BUILD_PRODUCT_TYPE on V_SWM_DT_VALUE.一级业态=MDM_BUILD_PRODUCT_TYPE.PRODUCT_TYPE_NAME
left join  MDM_BUILD on  MDM_BUILD.id=V_SWM_DT_VALUE.obj_id
where (SWM_YE_VALUE_INVENTORY_DTL.obj_type='分期' or SWM_YE_VALUE_INVENTORY_DTL.obj_type='无分期' or SWM_YE_VALUE_INVENTORY_DTL.obj_type='宗地')
and to_char(SWM_YE_VALUE_INVENTORY_DTL.CREATED,'yyyy-mm-dd')=currentDate and to_char(SWM_YE_VALUE_INVENTORY.CREATED,'yyyy-mm-dd')=currentDate
and MDM_BUILD.BUILD_STATE=10 and SWM_YE_VALUE_INVENTORY.ID=SWM_YE_VALUE_INVENTORY_DTL.YE_VALUE_INVENTORY_ID and V_SWM_DT_VALUE.一级业态 is not null;
commit;
END P_SWM_YE_VALUE_DTL_HELP;

/
--------------------------------------------------------
--  DDL for Procedure P_SWM_YE_VALUE_INVENTORY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SWM_YE_VALUE_INVENTORY" (userid IN VARCHAR2, --当前用户id
                                                       stationid IN VARCHAR2, --当前用户岗位id
                                                       departmentid IN VARCHAR2, --当前用户部门id
                                                       companyid IN VARCHAR2, --当前用户公司id
                                                       unitid IN VARCHAR2, --选择公司id
                                                       projectId IN VARCHAR2, --选择项目id
                                                       planYear IN VARCHAR2, --选择年份
                                                       info OUT SYS_REFCURSOR--返回结果
) AS
    data_auth_spid             VARCHAR2(200);
    bizcode                    VARCHAR2(200);
    unitid_val                 VARCHAR2(200);
    yeValueInventoryId         VARCHAR2(200);
    businessSummaryBizId       VARCHAR2(200); --业态汇总bizId
    businessSummaryBizParentId VARCHAR2(200); --业态汇总bizParentId
    no_staging                 VARCHAR2(200); -- 无分期Id
    no_staging_order           VARCHAR2(200); -- 无分期排序
    mixType                    NUMBER;
    swmSupplySellPlanId        Varchar2(200); -- 年度供销存ID
    endYear                    Varchar2(200);
    spid                       VARCHAR2(36);--使用临时表的批次号
    ROWCNT                     NUMBER := 0;

BEGIN

    --权限编码
--    unitid_val := nvl(unitid, '003200000000000000000000000000');
--    bizcode := 'DWM.DTHZGL.03';
--    p_sys_get_company_proj_spid(userid => userid, stationid => stationid, deptid => departmentid, companyid => companyid, bizcode
--    => bizcode, data_auth_spid => data_auth_spid);


    endYear := '';
    if planYear is not null then
select to_char(to_number(planYear) - 1) into endYear from dual;
end if;

select count(*)
into mixType
from SWM_YE_VALUE_INVENTORY
WHERE PROJECT_ID = projectId
  and TO_CHAR(YEAR, 'YYYY') = endYear;
if mixType > 0 then
select ID
into yeValueInventoryId
from SWM_YE_VALUE_INVENTORY
WHERE PROJECT_ID = projectId
  and TO_CHAR(YEAR, 'YYYY') = endYear;

select count(*)
into mixType
from SWM_YE_VALUE_INVENTORY_DTL
WHERE OBJ_TYPE = '按业态汇总'
  and YE_VALUE_INVENTORY_ID = yeValueInventoryId;
if mixType > 0 then
select BIZ_ID
into businessSummaryBizId
FROM SWM_YE_VALUE_INVENTORY_DTL
WHERE OBJ_TYPE = '按业态汇总'
  and YE_VALUE_INVENTORY_ID = yeValueInventoryId;
select BIZ_PARENT_ID
into businessSummaryBizParentId
FROM SWM_YE_VALUE_INVENTORY_DTL
WHERE OBJ_TYPE = '按业态汇总'
  and YE_VALUE_INVENTORY_ID = yeValueInventoryId;

end if;
end if;


select count(*)
into mixType
from SWM_YE_VALUE_INVENTORY_DTL
where OBJ_TYPE = '无分期'
  and YE_VALUE_INVENTORY_ID = yeValueInventoryId;
if (mixType > 0) then
select ORDER_CODE
into no_staging_order
from SWM_YE_VALUE_INVENTORY_DTL
where OBJ_TYPE = '无分期'
  and YE_VALUE_INVENTORY_ID = yeValueInventoryId;
select OBJ_NAME
into no_staging
from SWM_YE_VALUE_INVENTORY_DTL
where OBJ_TYPE = '无分期'
  and YE_VALUE_INVENTORY_ID = yeValueInventoryId;
end if;

select count(*)
into mixType
from SWM_SUPPLY_SELL_PLAN
WHERE PROJECT_ID = projectId
  and TO_CHAR(PLAN_YEAR
          , 'YYYY') = planYear;
if (mixType > 0) then
SELECT ID
INTO swmSupplySellPlanId
FROM (select SWM_SUPPLY_SELL_PLAN.ID
      from SWM_SUPPLY_SELL_PLAN
      WHERE PROJECT_ID = projectId
        and TO_CHAR(PLAN_YEAR
                , 'YYYY') = planYear
      order by SWM_SUPPLY_SELL_PLAN.PERIOD_CODE DESC)
WHERE ROWNUM = 1;
end if;


    P_SWM_DT_VAL_BY_SUPPLY_PLAN
(
            projectId => projectId,
            planYear => planYear,
            p_spid => spid
        );
select count(1) into ROWCNT from TMP_DT_VAL_BY_SUPPLY_PLAN_DTL where SPID = spid;
if ROWCNT <> 0 then
        if (no_staging is NULL) then
begin
OPEN info FOR
select *
from (select SWYVID.ID                             id,                          -- id
             SWYVID.BIZ_ID                         "bizId",                     -- 业态id
             SWYVID.BIZ_PARENT_ID                  "bizParentId",               --父id
             SWYVID.OBJ_TYPE                       "objType",                   -- 对象类型
             SWYVID.OBJ_ID                         "objId",                     -- 项目id
             SWYVID.OBJ_NAME                       "objName",                   --项目名称
             SWYVID.BUILD_PRODUCT_TYPE_NAME        "buildProductTypeName",      --业态名称
             SWYVID.OWN_BUILD_PRODUCT_TYPE_ID      "ownBuildProductTypeId",     --所属一级业态
             SWYVID.BUILD_PRODUCT_TYPE_ID          "buildProductTypeId",
             SWYVID.ORDER_CODE                     "orderCode",
             SWYVID.PO_TOTAL_SALE_AREA             "poTotalSaleArea",--面积（全案总可售）
             SWYVID.PO_TOTAL_SALE_COUNT            "poTotalSaleCount",--套数（全案总可售）
             SWYVID.PO_TOTAL_SALE_AVERAGE_AMOUNT   "poTotalSaleAverageAmount",--均价（全案总可售）
             SWYVID.PO_TOTAL_SALE_AMOUNT           "poTotalSaleAmount",--货值（全案总可售）
             SWYVID.PO_SALE_AREA                   "poSaleArea",--面积（全案已售）
             SWYVID.PO_SALE_COUNT                  "poSaleCount",--套数（全案已售）
             SWYVID.PO_SALE_AVERAGE_AMOUNT         "poSaleAverageAmount",--均价  （全案已售）
             SWYVID.PO_SALE_AMOUNT                 "poSaleAmount",--货值（全案已售）
             SWYVID.PO_SURPLUS_SALE_AREA           "poSurplusSaleArea",--面积（全案库存）
             SWYVID.PO_SURPLUS_SALE_COUNT          "poSurplusSaleCount",--套数（全案库存）
             SWYVID.PO_SURPLUS_SALE_AVERAGE_AMOUNT "poSurplusSaleAverageAmount",--均价（全案库存）
             SWYVID.PO_SURPLUS_SALE_AMOUNT         "poSurplusSale",--货值  (全案库存)
             SWYVID.RP_TOTAL_AREA                  "rpTotalArea",--面积  (已取证)
             SWYVID.RP_TOTAL_COUNT                 "rpTotalCount",--套数  (已取证)
             SWYVID.RP_TOTAL_AVERAGE_AMOUNT        "rpTotalAverageAmount",--均价  (已取证)
             SWYVID.RP_TOTAL_AMOUNT                "rpTotalAmount",--货值  (已取证)
             SWYVID.RP_SURPLUS_AREA                "rpSurplusArea",--面积  (已取证库存)
             SWYVID.RP_SURPLUS_COUNT               "rpSurplusCount",--套数  (已取证库存)
             SWYVID.RP_SURPLUS_AVERAGE_AMOUNT      "rpSurplusAverageAmount",--均价  (已取证库存)
             SWYVID.RP_SURPLUS_AMOUNT              "rpSurplus",--货值  (已取证库存)
             ens.SUPPLY_TOTAL_AMOUNT               "supplyTotalAmount",
             ens.SUPPLY_TOTAL_AREA                 "supplyTotalArea",
             ens.SUPPLY_TOTAL_NUMBER               "supplyTotalCount",
             ens.SUPPLY_AVERAGE_AMOUNT             "supplyTotalAverageAmount",
             SELL_TOTAL_AMOUNT                     "sellTotalAmount",
             SELL_TOTAL_AREA                       "sellTotalArea",
             SELL_TOTAL_NUMBER                     "sellTotalCount"
      from SWM_YE_VALUE_INVENTORY_DTL SWYVID
               left join (select SWM_SUPPLY_SELL_PLAN_DTL.BIZ_ID,
                                 SWM_SUPPLY_SELL_PLAN_DTL.SELL_TOTAL_AMOUNT,
                                 SWM_SUPPLY_SELL_PLAN_DTL.SELL_TOTAL_AREA,
                                 SWM_SUPPLY_SELL_PLAN_DTL.SELL_TOTAL_NUMBER
                          from SWM_SUPPLY_SELL_PLAN_DTL
                          where SUPPLY_SELL_PLAN_ID = swmSupplySellPlanId) SSSPD
                         on SSSPD.BIZ_ID = SWYVID.BIZ_ID
               left join (select biz_id,
                                 SUPPLY_TOTAL_AREA,
                                 SUPPLY_TOTAL_NUMBER,
                                 CASE
                                     when OBJ_TYPE = '一级业态' and OBJ_NAME = '车位仓储' and SUPPLY_TOTAL_NUMBER <> 0
                                         then round(SUPPLY_TOTAL_AMOUNT * 10000 / SUPPLY_TOTAL_NUMBER, 4)
                                     when OBJ_TYPE = '一级业态' and OBJ_NAME <> '车位仓储' and SUPPLY_TOTAL_AREA <> 0
                                         then round(SUPPLY_TOTAL_AMOUNT * 10000 / SUPPLY_TOTAL_AREA, 4)
                                     else SUPPLY_AVERAGE_AMOUNT end SUPPLY_AVERAGE_AMOUNT,
                                 SUPPLY_TOTAL_AMOUNT
                          from TMP_DT_VAL_BY_SUPPLY_PLAN_DTL
                          where SPID = spid) ens on ens.biz_id = SWYVID.BIZ_ID
      where YE_VALUE_INVENTORY_ID = yeValueInventoryId
      order by "ORDER_CODE")
WHERE "bizId" = businessSummaryBizParentId
   or "bizId" = businessSummaryBizId
   or "bizParentId" = businessSummaryBizId
union all
select *
from (
         select SWYVID.ID                             id,                          -- id
                SWYVID.BIZ_ID                         "bizId",                     -- 业态id
                SWYVID.BIZ_PARENT_ID                  "bizParentId",               --父id
                SWYVID.OBJ_TYPE                       "objType",                   -- 对象类型
                SWYVID.OBJ_ID                         "objId",                     -- 项目id
                SWYVID.OBJ_NAME                       "objName",                   --项目名称
                SWYVID.BUILD_PRODUCT_TYPE_NAME        "buildProductTypeName",      --业态名称
                SWYVID.OWN_BUILD_PRODUCT_TYPE_ID      "ownBuildProductTypeId",     --所属一级业态
                SWYVID.BUILD_PRODUCT_TYPE_ID          "buildProductTypeId",
                SWYVID.ORDER_CODE                     "orderCode",
                SWYVID.PO_TOTAL_SALE_AREA             "poTotalSaleArea",--面积（全案总可售）
                SWYVID.PO_TOTAL_SALE_COUNT            "poTotalSaleCount",--套数（全案总可售）
                SWYVID.PO_TOTAL_SALE_AVERAGE_AMOUNT   "poTotalSaleAverageAmount",--均价（全案总可售）
                SWYVID.PO_TOTAL_SALE_AMOUNT           "poTotalSaleAmount",--货值（全案总可售）
                SWYVID.PO_SALE_AREA                   "poSaleArea",--面积（全案已售）
                SWYVID.PO_SALE_COUNT                  "poSaleCount",--套数（全案已售）
                SWYVID.PO_SALE_AVERAGE_AMOUNT         "poSaleAverageAmount",--均价（全案已售）
                SWYVID.PO_SALE_AMOUNT                 "poSaleAmount",--货值（全案已售）
                SWYVID.PO_SURPLUS_SALE_AREA           "poSurplusSaleArea",--面积（全案库存）
                SWYVID.PO_SURPLUS_SALE_COUNT          "poSurplusSaleCount",--套数（全案库存）
                SWYVID.PO_SURPLUS_SALE_AVERAGE_AMOUNT "poSurplusSaleAverageAmount",--均价（全案库存）
                SWYVID.PO_SURPLUS_SALE_AMOUNT         "poSurplusSale",--货值  (全案库存)
                SWYVID.RP_TOTAL_AREA                  "rpTotalArea",--面积  (已取证)
                SWYVID.RP_TOTAL_COUNT                 "rpTotalCount",--套数  (已取证)
                SWYVID.RP_TOTAL_AVERAGE_AMOUNT        "rpTotalAverageAmount",--均价  (已取证)
                SWYVID.RP_TOTAL_AMOUNT                "rpTotalAmount",--货值  (已取证)
                SWYVID.RP_SURPLUS_AREA                "rpSurplusArea",--面积  (已取证库存)
                SWYVID.RP_SURPLUS_COUNT               "rpSurplusCount",--套数  (已取证库存)
                SWYVID.RP_SURPLUS_AVERAGE_AMOUNT      "rpSurplusAverageAmount",--均价  (已取证库存)
                SWYVID.RP_SURPLUS_AMOUNT              "rpSurplus",--货值  (已取证库存)
                ens.SUPPLY_TOTAL_AMOUNT               "supplyTotalAmount",
                ens.SUPPLY_TOTAL_AREA                 "supplyTotalArea",
                ens.SUPPLY_TOTAL_NUMBER               "supplyTotalCount",
                ens.SUPPLY_AVERAGE_AMOUNT             "supplyTotalAverageAmount",
                SELL_TOTAL_AMOUNT                     "sellTotalAmount",
                SELL_TOTAL_AREA                       "sellTotalArea",
                SELL_TOTAL_NUMBER                     "sellTotalCount"
         from SWM_YE_VALUE_INVENTORY_DTL SWYVID
                  left join (select SWM_SUPPLY_SELL_PLAN_DTL.BIZ_ID,
                                    SWM_SUPPLY_SELL_PLAN_DTL.SELL_TOTAL_AMOUNT,
                                    SWM_SUPPLY_SELL_PLAN_DTL.SELL_TOTAL_AREA,
                                    SWM_SUPPLY_SELL_PLAN_DTL.SELL_TOTAL_NUMBER
                             from SWM_SUPPLY_SELL_PLAN_DTL
                             where SUPPLY_SELL_PLAN_ID = swmSupplySellPlanId) SSSPD
                            on SSSPD.BIZ_ID = SWYVID.BIZ_ID
                  left join (select biz_id,
                                    SUPPLY_TOTAL_AREA,
                                    SUPPLY_TOTAL_NUMBER,
                                    CASE
                                        when OBJ_TYPE = '一级业态' and OBJ_NAME = '车位仓储' and SUPPLY_TOTAL_NUMBER <> 0
                                            then round(SUPPLY_TOTAL_AMOUNT * 10000 / SUPPLY_TOTAL_NUMBER, 4)
                                        when OBJ_TYPE = '一级业态' and OBJ_NAME <> '车位仓储' and SUPPLY_TOTAL_AREA <> 0
                                            then round(SUPPLY_TOTAL_AMOUNT * 10000 / SUPPLY_TOTAL_AREA, 4)
                                        else SUPPLY_AVERAGE_AMOUNT end SUPPLY_AVERAGE_AMOUNT,
                                    SUPPLY_TOTAL_AMOUNT
                             from TMP_DT_VAL_BY_SUPPLY_PLAN_DTL
                             where SPID = spid
         ) ens on ens.biz_id = SWYVID.BIZ_ID
         WHERE SWYVID.BIZ_ID <> businessSummaryBizId
           and BIZ_PARENT_ID <> (businessSummaryBizId)
           and YE_VALUE_INVENTORY_ID = yeValueInventoryId
         order by "ORDER_CODE");
end;
else
            OPEN info FOR select *
                          from (select SWYVID.ID                             id,                          -- id
                                       SWYVID.BIZ_ID                         "bizId",                     -- 业态id
                                       SWYVID.BIZ_PARENT_ID                  "bizParentId",               --父id
                                       SWYVID.OBJ_TYPE                       "objType",                   -- 对象类型
                                       SWYVID.OBJ_ID                         "objId",                     -- 项目id
                                       SWYVID.OBJ_NAME                       "objName",                   --项目名称
                                       SWYVID.BUILD_PRODUCT_TYPE_NAME        "buildProductTypeName",      --业态名称
                                       SWYVID.OWN_BUILD_PRODUCT_TYPE_ID      "ownBuildProductTypeId",     --所属一级业态
                                       SWYVID.BUILD_PRODUCT_TYPE_ID          "buildProductTypeId",
                                       SWYVID.ORDER_CODE                     "orderCode",
                                       SWYVID.PO_TOTAL_SALE_AREA             "poTotalSaleArea",--面积（全案总可售）
                                       SWYVID.PO_TOTAL_SALE_COUNT            "poTotalSaleCount",--套数（全案总可售）
                                       SWYVID.PO_TOTAL_SALE_AVERAGE_AMOUNT   "poTotalSaleAverageAmount",--均价（全案总可售）
                                       SWYVID.PO_TOTAL_SALE_AMOUNT           "poTotalSaleAmount",--货值（全案总可售）
                                       SWYVID.PO_SALE_AREA                   "poSaleArea",--面积（全案已售）
                                       SWYVID.PO_SALE_COUNT                  "poSaleCount",--套数（全案已售）
                                       SWYVID.PO_SALE_AVERAGE_AMOUNT         "poSaleAverageAmount",--均价（全案已售）
                                       SWYVID.PO_SALE_AMOUNT                 "poSaleAmount",--货值（全案已售）
                                       SWYVID.PO_SURPLUS_SALE_AREA           "poSurplusSaleArea",--面积（全案库存）
                                       SWYVID.PO_SURPLUS_SALE_COUNT          "poSurplusSaleCount",--套数（全案库存）
                                       SWYVID.PO_SURPLUS_SALE_AVERAGE_AMOUNT "poSurplusSaleAverageAmount",--均价（全案库存）
                                       SWYVID.PO_SURPLUS_SALE_AMOUNT         "poSurplusSale",--货值  (全案库存)
                                       SWYVID.RP_TOTAL_AREA                  "rpTotalArea",--面积  (已取证)
                                       SWYVID.RP_TOTAL_COUNT                 "rpTotalCount",--套数  (已取证)
                                       SWYVID.RP_TOTAL_AVERAGE_AMOUNT        "rpTotalAverageAmount",--均价  (已取证)
                                       SWYVID.RP_TOTAL_AMOUNT                "rpTotalAmount",--货值  (已取证)
                                       SWYVID.RP_SURPLUS_AREA                "rpSurplusArea",--面积  (已取证库存)
                                       SWYVID.RP_SURPLUS_COUNT               "rpSurplusCount",--套数  (已取证库存)
                                       SWYVID.RP_SURPLUS_AVERAGE_AMOUNT      "rpSurplusAverageAmount",--均价  (已取证库存)
                                       SWYVID.RP_SURPLUS_AMOUNT              "rpSurplus",--货值  (已取证库存)
                                       ens.SUPPLY_TOTAL_AMOUNT               "supplyTotalAmount",
                                       ens.SUPPLY_TOTAL_AREA                 "supplyTotalArea",
                                       ens.SUPPLY_TOTAL_NUMBER               "supplyTotalCount",
                                       ens.SUPPLY_AVERAGE_AMOUNT             "supplyTotalAverageAmount",
                                       SELL_TOTAL_AMOUNT                     "sellTotalAmount",
                                       SELL_TOTAL_AREA                       "sellTotalArea",
                                       SELL_TOTAL_NUMBER                     "sellTotalCount"
                                from SWM_YE_VALUE_INVENTORY_DTL SWYVID
                                         left join (select SWM_SUPPLY_SELL_PLAN_DTL.BIZ_ID,
                                                           SWM_SUPPLY_SELL_PLAN_DTL.SELL_TOTAL_AMOUNT,
                                                           SWM_SUPPLY_SELL_PLAN_DTL.SELL_TOTAL_AREA,
                                                           SWM_SUPPLY_SELL_PLAN_DTL.SELL_TOTAL_NUMBER
                                                    from SWM_SUPPLY_SELL_PLAN_DTL
                                                    where SUPPLY_SELL_PLAN_ID = swmSupplySellPlanId) SSSPD
                                                   on SSSPD.BIZ_ID = SWYVID.BIZ_ID
                                         left join (select biz_id,
                                                           SUPPLY_TOTAL_AREA,
                                                           SUPPLY_TOTAL_NUMBER,
                                                           CASE
                                                               when OBJ_TYPE = '一级业态' and OBJ_NAME = '车位仓储' and SUPPLY_TOTAL_NUMBER <> 0
                                                                   then round(SUPPLY_TOTAL_AMOUNT * 10000 / SUPPLY_TOTAL_NUMBER, 4)
                                                               when OBJ_TYPE = '一级业态' and OBJ_NAME <> '车位仓储' and SUPPLY_TOTAL_AREA <> 0
                                                                   then round(SUPPLY_TOTAL_AMOUNT * 10000 / SUPPLY_TOTAL_AREA, 4)
                                                               else SUPPLY_AVERAGE_AMOUNT end SUPPLY_AVERAGE_AMOUNT,
                                                           SUPPLY_TOTAL_AMOUNT
                                                    from TMP_DT_VAL_BY_SUPPLY_PLAN_DTL
                                                    where SPID = spid
                                ) ens on ens.biz_id = SWYVID.BIZ_ID
                                where YE_VALUE_INVENTORY_ID = yeValueInventoryId
                                order by "ORDER_CODE")
                          WHERE "bizId" = businessSummaryBizParentId
                             or "bizId" = businessSummaryBizId
                             or "bizParentId" = businessSummaryBizId
                          union all
                          select *
                          from (
                                   select SWYVID.ID                             id,                          -- id
                                          SWYVID.BIZ_ID                         "bizId",                     -- 业态id
                                          (DECODE(BIZ_PARENT_ID, null, businessSummaryBizParentId,
                                                  businessSummaryBizParentId))  "bizParentId",               --父id
                                          SWYVID.OBJ_TYPE                       "objType",                   -- 对象类型
                                          SWYVID.OBJ_ID                         "objId",                     -- 项目id
                                          SWYVID.OBJ_NAME                       "objName",                   --项目名称
                                          SWYVID.BUILD_PRODUCT_TYPE_NAME        "buildProductTypeName",      --业态名称
                                          SWYVID.OWN_BUILD_PRODUCT_TYPE_ID      "ownBuildProductTypeId",     --所属一级业态
                                          SWYVID.BUILD_PRODUCT_TYPE_ID          "buildProductTypeId",
                                          (DECODE(ORDER_CODE, null, no_staging_order, no_staging_order))
                                                                                "orderCode",
                                          SWYVID.PO_TOTAL_SALE_AREA             "poTotalSaleArea",--面积（全案总可售）
                                          SWYVID.PO_TOTAL_SALE_COUNT            "poTotalSaleCount",--套数（全案总可售）
                                          SWYVID.PO_TOTAL_SALE_AVERAGE_AMOUNT   "poTotalSaleAverageAmount",--均价（全案总可售）
                                          SWYVID.PO_TOTAL_SALE_AMOUNT           "poTotalSaleAmount",--货值（全案总可售）
                                          SWYVID.PO_SALE_AREA                   "poSaleArea",--面积（全案已售）
                                          SWYVID.PO_SALE_COUNT                  "poSaleCount",--套数（全案已售）
                                          SWYVID.PO_SALE_AVERAGE_AMOUNT         "poSaleAverageAmount",--均价（全案已售）
                                          SWYVID.PO_SALE_AMOUNT                 "poSaleAmount",--货值（全案已售）
                                          SWYVID.PO_SURPLUS_SALE_AREA           "poSurplusSaleArea",--面积（全案库存）
                                          SWYVID.PO_SURPLUS_SALE_COUNT          "poSurplusSaleCount",--套数（全案库存）
                                          SWYVID.PO_SURPLUS_SALE_AVERAGE_AMOUNT "poSurplusSaleAverageAmount",--均价（全案库存）
                                          SWYVID.PO_SURPLUS_SALE_AMOUNT         "poSurplusSale",--货值  (全案库存)
                                          SWYVID.RP_TOTAL_AREA                  "rpTotalArea",--面积  (已取证)
                                          SWYVID.RP_TOTAL_COUNT                 "rpTotalCount",--套数  (已取证)
                                          SWYVID.RP_TOTAL_AVERAGE_AMOUNT        "rpTotalAverageAmount",--均价  (已取证)
                                          SWYVID.RP_TOTAL_AMOUNT                "rpTotalAmount",--货值  (已取证)
                                          SWYVID.RP_SURPLUS_AREA                "rpSurplusArea",--面积  (已取证库存)
                                          SWYVID.RP_SURPLUS_COUNT               "rpSurplusCount",--套数  (已取证库存)
                                          SWYVID.RP_SURPLUS_AVERAGE_AMOUNT      "rpSurplusAverageAmount",--均价  (已取证库存)
                                          SWYVID.RP_SURPLUS_AMOUNT              "rpSurplus",--货值  (已取证库存)
                                          ens.SUPPLY_TOTAL_AMOUNT               "supplyTotalAmount",
                                          ens.SUPPLY_TOTAL_AREA                 "supplyTotalArea",
                                          ens.SUPPLY_TOTAL_NUMBER               "supplyTotalCount",
                                          ens.SUPPLY_AVERAGE_AMOUNT             "supplyTotalAverageAmount",
                                          SELL_TOTAL_AMOUNT                     "sellTotalAmount",
                                          SELL_TOTAL_AREA                       "sellTotalArea",
                                          SELL_TOTAL_NUMBER                     "sellTotalCount"
                                   from SWM_YE_VALUE_INVENTORY_DTL SWYVID
                                            left join (select SWM_SUPPLY_SELL_PLAN_DTL.BIZ_ID,
                                                              SWM_SUPPLY_SELL_PLAN_DTL.SELL_TOTAL_AMOUNT,
                                                              SWM_SUPPLY_SELL_PLAN_DTL.SELL_TOTAL_AREA,
                                                              SWM_SUPPLY_SELL_PLAN_DTL.SELL_TOTAL_NUMBER
                                                       from SWM_SUPPLY_SELL_PLAN_DTL
                                                       where SUPPLY_SELL_PLAN_ID = swmSupplySellPlanId) SSSPD
                                                      on SSSPD.BIZ_ID = SWYVID.BIZ_ID
                                            left join (select biz_id,
                                                              SUPPLY_TOTAL_AREA,
                                                              SUPPLY_TOTAL_NUMBER,
                                                              CASE
                                                                  when OBJ_TYPE = '一级业态' and OBJ_NAME = '车位仓储' and SUPPLY_TOTAL_NUMBER <> 0
                                                                      then round(SUPPLY_TOTAL_AMOUNT * 10000 / SUPPLY_TOTAL_NUMBER, 4)
                                                                  when OBJ_TYPE = '一级业态' and OBJ_NAME <> '车位仓储' and SUPPLY_TOTAL_AREA <> 0
                                                                      then round(SUPPLY_TOTAL_AMOUNT * 10000 / SUPPLY_TOTAL_AREA, 4)
                                                                  else SUPPLY_AVERAGE_AMOUNT end SUPPLY_AVERAGE_AMOUNT,
                                                              SUPPLY_TOTAL_AMOUNT
                                                       from TMP_DT_VAL_BY_SUPPLY_PLAN_DTL
                                                       where SPID = spid
                                   ) ens on ens.biz_id = SWYVID.BIZ_ID
                                   WHERE OBJ_TYPE <> '无分期'
                                     and SWYVID.BIZ_ID <> businessSummaryBizId
                                     and BIZ_PARENT_ID <> businessSummaryBizId
                                     and YE_VALUE_INVENTORY_ID = yeValueInventoryId
                                   order by "ORDER_CODE");
end if;

else
        if (no_staging is NULL) then
begin
OPEN info FOR
select *
from (select SWYVID.ID                             id,                          -- id
             SWYVID.BIZ_ID                         "bizId",                     -- 业态id
             SWYVID.BIZ_PARENT_ID                  "bizParentId",               --父id
             SWYVID.OBJ_TYPE                       "objType",                   -- 对象类型
             SWYVID.OBJ_ID                         "objId",                     -- 项目id
             SWYVID.OBJ_NAME                       "objName",                   --项目名称
             SWYVID.BUILD_PRODUCT_TYPE_NAME        "buildProductTypeName",      --业态名称
             SWYVID.OWN_BUILD_PRODUCT_TYPE_ID      "ownBuildProductTypeId",     --所属一级业态
             SWYVID.BUILD_PRODUCT_TYPE_ID          "buildProductTypeId",
             SWYVID.ORDER_CODE                     "orderCode",
             SWYVID.PO_TOTAL_SALE_AREA             "poTotalSaleArea",--面积（全案总可售）
             SWYVID.PO_TOTAL_SALE_COUNT            "poTotalSaleCount",--套数（全案总可售）
             SWYVID.PO_TOTAL_SALE_AVERAGE_AMOUNT   "poTotalSaleAverageAmount",--均价（全案总可售）
             SWYVID.PO_TOTAL_SALE_AMOUNT           "poTotalSaleAmount",--货值（全案总可售）
             SWYVID.PO_SALE_AREA                   "poSaleArea",--面积（全案已售）
             SWYVID.PO_SALE_COUNT                  "poSaleCount",--套数（全案已售）
             SWYVID.PO_SALE_AVERAGE_AMOUNT         "poSaleAverageAmount",--均价  （全案已售）
             SWYVID.PO_SALE_AMOUNT                 "poSaleAmount",--货值（全案已售）
             SWYVID.PO_SURPLUS_SALE_AREA           "poSurplusSaleArea",--面积（全案库存）
             SWYVID.PO_SURPLUS_SALE_COUNT          "poSurplusSaleCount",--套数（全案库存）
             SWYVID.PO_SURPLUS_SALE_AVERAGE_AMOUNT "poSurplusSaleAverageAmount",--均价（全案库存）
             SWYVID.PO_SURPLUS_SALE_AMOUNT         "poSurplusSale",--货值  (全案库存)
             SWYVID.RP_TOTAL_AREA                  "rpTotalArea",--面积  (已取证)
             SWYVID.RP_TOTAL_COUNT                 "rpTotalCount",--套数  (已取证)
             SWYVID.RP_TOTAL_AVERAGE_AMOUNT        "rpTotalAverageAmount",--均价  (已取证)
             SWYVID.RP_TOTAL_AMOUNT                "rpTotalAmount",--货值  (已取证)
             SWYVID.RP_SURPLUS_AREA                "rpSurplusArea",--面积  (已取证库存)
             SWYVID.RP_SURPLUS_COUNT               "rpSurplusCount",--套数  (已取证库存)
             SWYVID.RP_SURPLUS_AVERAGE_AMOUNT      "rpSurplusAverageAmount",--均价  (已取证库存)
             SWYVID.RP_SURPLUS_AMOUNT              "rpSurplus",--货值  (已取证库存)
             ens.SUPPLY_TOTAL_AMOUNT               "supplyTotalAmount",
             ens.SUPPLY_TOTAL_AREA                 "supplyTotalArea",
             ens.SUPPLY_TOTAL_NUMBER               "supplyTotalCount",
             ens.SUPPLY_AVERAGE_AMOUNT             "supplyTotalAverageAmount",
             SELL_TOTAL_AMOUNT                     "sellTotalAmount",
             SELL_TOTAL_AREA                       "sellTotalArea",
             SELL_TOTAL_NUMBER                     "sellTotalCount"
      from SWM_YE_VALUE_INVENTORY_DTL SWYVID
               left join (select SWM_SUPPLY_SELL_PLAN_DTL.BIZ_ID,
                                 SWM_SUPPLY_SELL_PLAN_DTL.SELL_TOTAL_AMOUNT,
                                 SWM_SUPPLY_SELL_PLAN_DTL.SELL_TOTAL_AREA,
                                 SWM_SUPPLY_SELL_PLAN_DTL.SELL_TOTAL_NUMBER
                          from SWM_SUPPLY_SELL_PLAN_DTL
                          where SUPPLY_SELL_PLAN_ID = swmSupplySellPlanId) SSSPD
                         on SSSPD.BIZ_ID = SWYVID.BIZ_ID
               left join (select biz_id,
                                 0 AS SUPPLY_TOTAL_AREA,
                                 0 AS SUPPLY_TOTAL_NUMBER,
                                 0 AS SUPPLY_AVERAGE_AMOUNT,
                                 0 AS SUPPLY_TOTAL_AMOUNT
                          from SWM_YE_VALUE_INVENTORY_DTL
                                   left join SWM_YE_VALUE_INVENTORY
                                             on SWM_YE_VALUE_INVENTORY_DTL.YE_VALUE_INVENTORY_ID =
                                                SWM_YE_VALUE_INVENTORY.ID
                          where extract(year from SWM_YE_VALUE_INVENTORY.YEAR) = (planYear - 1)
                            AND SWM_YE_VALUE_INVENTORY.PROJECT_ID = projectId) ens
                         on ens.biz_id = SWYVID.BIZ_ID
      where YE_VALUE_INVENTORY_ID = yeValueInventoryId
      order by "ORDER_CODE")
WHERE "bizId" = businessSummaryBizParentId
   or "bizId" = businessSummaryBizId
   or "bizParentId" = businessSummaryBizId
union all
select *
from (
         select SWYVID.ID                             id,                          -- id
                SWYVID.BIZ_ID                         "bizId",                     -- 业态id
                SWYVID.BIZ_PARENT_ID                  "bizParentId",               --父id
                SWYVID.OBJ_TYPE                       "objType",                   -- 对象类型
                SWYVID.OBJ_ID                         "objId",                     -- 项目id
                SWYVID.OBJ_NAME                       "objName",                   --项目名称
                SWYVID.BUILD_PRODUCT_TYPE_NAME        "buildProductTypeName",      --业态名称
                SWYVID.OWN_BUILD_PRODUCT_TYPE_ID      "ownBuildProductTypeId",     --所属一级业态
                SWYVID.BUILD_PRODUCT_TYPE_ID          "buildProductTypeId",
                SWYVID.ORDER_CODE                     "orderCode",
                SWYVID.PO_TOTAL_SALE_AREA             "poTotalSaleArea",--面积（全案总可售）
                SWYVID.PO_TOTAL_SALE_COUNT            "poTotalSaleCount",--套数（全案总可售）
                SWYVID.PO_TOTAL_SALE_AVERAGE_AMOUNT   "poTotalSaleAverageAmount",--均价（全案总可售）
                SWYVID.PO_TOTAL_SALE_AMOUNT           "poTotalSaleAmount",--货值（全案总可售）
                SWYVID.PO_SALE_AREA                   "poSaleArea",--面积（全案已售）
                SWYVID.PO_SALE_COUNT                  "poSaleCount",--套数（全案已售）
                SWYVID.PO_SALE_AVERAGE_AMOUNT         "poSaleAverageAmount",--均价（全案已售）
                SWYVID.PO_SALE_AMOUNT                 "poSaleAmount",--货值（全案已售）
                SWYVID.PO_SURPLUS_SALE_AREA           "poSurplusSaleArea",--面积（全案库存）
                SWYVID.PO_SURPLUS_SALE_COUNT          "poSurplusSaleCount",--套数（全案库存）
                SWYVID.PO_SURPLUS_SALE_AVERAGE_AMOUNT "poSurplusSaleAverageAmount",--均价（全案库存）
                SWYVID.PO_SURPLUS_SALE_AMOUNT         "poSurplusSale",--货值  (全案库存)
                SWYVID.RP_TOTAL_AREA                  "rpTotalArea",--面积  (已取证)
                SWYVID.RP_TOTAL_COUNT                 "rpTotalCount",--套数  (已取证)
                SWYVID.RP_TOTAL_AVERAGE_AMOUNT        "rpTotalAverageAmount",--均价  (已取证)
                SWYVID.RP_TOTAL_AMOUNT                "rpTotalAmount",--货值  (已取证)
                SWYVID.RP_SURPLUS_AREA                "rpSurplusArea",--面积  (已取证库存)
                SWYVID.RP_SURPLUS_COUNT               "rpSurplusCount",--套数  (已取证库存)
                SWYVID.RP_SURPLUS_AVERAGE_AMOUNT      "rpSurplusAverageAmount",--均价  (已取证库存)
                SWYVID.RP_SURPLUS_AMOUNT              "rpSurplus",--货值  (已取证库存)
                ens.SUPPLY_TOTAL_AMOUNT               "supplyTotalAmount",
                ens.SUPPLY_TOTAL_AREA                 "supplyTotalArea",
                ens.SUPPLY_TOTAL_NUMBER               "supplyTotalCount",
                ens.SUPPLY_AVERAGE_AMOUNT             "supplyTotalAverageAmount",
                SELL_TOTAL_AMOUNT                     "sellTotalAmount",
                SELL_TOTAL_AREA                       "sellTotalArea",
                SELL_TOTAL_NUMBER                     "sellTotalCount"
         from SWM_YE_VALUE_INVENTORY_DTL SWYVID
                  left join (select SWM_SUPPLY_SELL_PLAN_DTL.BIZ_ID,
                                    SWM_SUPPLY_SELL_PLAN_DTL.SELL_TOTAL_AMOUNT,
                                    SWM_SUPPLY_SELL_PLAN_DTL.SELL_TOTAL_AREA,
                                    SWM_SUPPLY_SELL_PLAN_DTL.SELL_TOTAL_NUMBER
                             from SWM_SUPPLY_SELL_PLAN_DTL
                             where SUPPLY_SELL_PLAN_ID = swmSupplySellPlanId) SSSPD
                            on SSSPD.BIZ_ID = SWYVID.BIZ_ID
                  left join (select biz_id,
                                    0 AS SUPPLY_TOTAL_AREA,
                                    0 AS SUPPLY_TOTAL_NUMBER,
                                    0 AS SUPPLY_AVERAGE_AMOUNT,
                                    0 AS SUPPLY_TOTAL_AMOUNT
                             from SWM_YE_VALUE_INVENTORY_DTL
                                      left join SWM_YE_VALUE_INVENTORY
                                                on SWM_YE_VALUE_INVENTORY_DTL.YE_VALUE_INVENTORY_ID =
                                                   SWM_YE_VALUE_INVENTORY.ID
                             where extract(year from SWM_YE_VALUE_INVENTORY.YEAR) = (planYear - 1)
                               AND SWM_YE_VALUE_INVENTORY.PROJECT_ID = projectId
         ) ens on ens.biz_id = SWYVID.BIZ_ID
         WHERE SWYVID.BIZ_ID <> businessSummaryBizId
           and BIZ_PARENT_ID <> (businessSummaryBizId)
           and YE_VALUE_INVENTORY_ID = yeValueInventoryId
         order by "ORDER_CODE");
end;
else
            OPEN info FOR select *
                          from (select SWYVID.ID                             id,                          -- id
                                       SWYVID.BIZ_ID                         "bizId",                     -- 业态id
                                       SWYVID.BIZ_PARENT_ID                  "bizParentId",               --父id
                                       SWYVID.OBJ_TYPE                       "objType",                   -- 对象类型
                                       SWYVID.OBJ_ID                         "objId",                     -- 项目id
                                       SWYVID.OBJ_NAME                       "objName",                   --项目名称
                                       SWYVID.BUILD_PRODUCT_TYPE_NAME        "buildProductTypeName",      --业态名称
                                       SWYVID.OWN_BUILD_PRODUCT_TYPE_ID      "ownBuildProductTypeId",     --所属一级业态
                                       SWYVID.BUILD_PRODUCT_TYPE_ID          "buildProductTypeId",
                                       SWYVID.ORDER_CODE                     "orderCode",
                                       SWYVID.PO_TOTAL_SALE_AREA             "poTotalSaleArea",--面积（全案总可售）
                                       SWYVID.PO_TOTAL_SALE_COUNT            "poTotalSaleCount",--套数（全案总可售）
                                       SWYVID.PO_TOTAL_SALE_AVERAGE_AMOUNT   "poTotalSaleAverageAmount",--均价（全案总可售）
                                       SWYVID.PO_TOTAL_SALE_AMOUNT           "poTotalSaleAmount",--货值（全案总可售）
                                       SWYVID.PO_SALE_AREA                   "poSaleArea",--面积（全案已售）
                                       SWYVID.PO_SALE_COUNT                  "poSaleCount",--套数（全案已售）
                                       SWYVID.PO_SALE_AVERAGE_AMOUNT         "poSaleAverageAmount",--均价（全案已售）
                                       SWYVID.PO_SALE_AMOUNT                 "poSaleAmount",--货值（全案已售）
                                       SWYVID.PO_SURPLUS_SALE_AREA           "poSurplusSaleArea",--面积（全案库存）
                                       SWYVID.PO_SURPLUS_SALE_COUNT          "poSurplusSaleCount",--套数（全案库存）
                                       SWYVID.PO_SURPLUS_SALE_AVERAGE_AMOUNT "poSurplusSaleAverageAmount",--均价（全案库存）
                                       SWYVID.PO_SURPLUS_SALE_AMOUNT         "poSurplusSale",--货值  (全案库存)
                                       SWYVID.RP_TOTAL_AREA                  "rpTotalArea",--面积  (已取证)
                                       SWYVID.RP_TOTAL_COUNT                 "rpTotalCount",--套数  (已取证)
                                       SWYVID.RP_TOTAL_AVERAGE_AMOUNT        "rpTotalAverageAmount",--均价  (已取证)
                                       SWYVID.RP_TOTAL_AMOUNT                "rpTotalAmount",--货值  (已取证)
                                       SWYVID.RP_SURPLUS_AREA                "rpSurplusArea",--面积  (已取证库存)
                                       SWYVID.RP_SURPLUS_COUNT               "rpSurplusCount",--套数  (已取证库存)
                                       SWYVID.RP_SURPLUS_AVERAGE_AMOUNT      "rpSurplusAverageAmount",--均价  (已取证库存)
                                       SWYVID.RP_SURPLUS_AMOUNT              "rpSurplus",--货值  (已取证库存)
                                       ens.SUPPLY_TOTAL_AMOUNT               "supplyTotalAmount",
                                       ens.SUPPLY_TOTAL_AREA                 "supplyTotalArea",
                                       ens.SUPPLY_TOTAL_NUMBER               "supplyTotalCount",
                                       ens.SUPPLY_AVERAGE_AMOUNT             "supplyTotalAverageAmount",
                                       SELL_TOTAL_AMOUNT                     "sellTotalAmount",
                                       SELL_TOTAL_AREA                       "sellTotalArea",
                                       SELL_TOTAL_NUMBER                     "sellTotalCount"
                                from SWM_YE_VALUE_INVENTORY_DTL SWYVID
                                         left join (select SWM_SUPPLY_SELL_PLAN_DTL.BIZ_ID,
                                                           SWM_SUPPLY_SELL_PLAN_DTL.SELL_TOTAL_AMOUNT,
                                                           SWM_SUPPLY_SELL_PLAN_DTL.SELL_TOTAL_AREA,
                                                           SWM_SUPPLY_SELL_PLAN_DTL.SELL_TOTAL_NUMBER
                                                    from SWM_SUPPLY_SELL_PLAN_DTL
                                                    where SUPPLY_SELL_PLAN_ID = swmSupplySellPlanId) SSSPD
                                                   on SSSPD.BIZ_ID = SWYVID.BIZ_ID
                                         left join (select biz_id,
                                                           0 AS SUPPLY_TOTAL_AREA,
                                                           0 AS SUPPLY_TOTAL_NUMBER,
                                                           0 AS SUPPLY_AVERAGE_AMOUNT,
                                                           0 AS SUPPLY_TOTAL_AMOUNT
                                                    from SWM_YE_VALUE_INVENTORY_DTL
                                                             left join SWM_YE_VALUE_INVENTORY
                                                                       on SWM_YE_VALUE_INVENTORY_DTL.YE_VALUE_INVENTORY_ID =
                                                                          SWM_YE_VALUE_INVENTORY.ID
                                                    where extract(year from SWM_YE_VALUE_INVENTORY.YEAR) = (planYear - 1)
                                                      AND SWM_YE_VALUE_INVENTORY.PROJECT_ID = projectId
                                ) ens on ens.biz_id = SWYVID.BIZ_ID
                                where YE_VALUE_INVENTORY_ID = yeValueInventoryId
                                order by "ORDER_CODE")
                          WHERE "bizId" = businessSummaryBizParentId
                             or "bizId" = businessSummaryBizId
                             or "bizParentId" = businessSummaryBizId
                          union all
                          select *
                          from (
                                   select SWYVID.ID                             id,                          -- id
                                          SWYVID.BIZ_ID                         "bizId",                     -- 业态id
                                          (DECODE(BIZ_PARENT_ID, null, businessSummaryBizParentId,
                                                  businessSummaryBizParentId))  "bizParentId",               --父id
                                          SWYVID.OBJ_TYPE                       "objType",                   -- 对象类型
                                          SWYVID.OBJ_ID                         "objId",                     -- 项目id
                                          SWYVID.OBJ_NAME                       "objName",                   --项目名称
                                          SWYVID.BUILD_PRODUCT_TYPE_NAME        "buildProductTypeName",      --业态名称
                                          SWYVID.OWN_BUILD_PRODUCT_TYPE_ID      "ownBuildProductTypeId",     --所属一级业态
                                          SWYVID.BUILD_PRODUCT_TYPE_ID          "buildProductTypeId",
                                          (DECODE(ORDER_CODE, null, no_staging_order, no_staging_order))
                                                                                "orderCode",
                                          SWYVID.PO_TOTAL_SALE_AREA             "poTotalSaleArea",--面积（全案总可售）
                                          SWYVID.PO_TOTAL_SALE_COUNT            "poTotalSaleCount",--套数（全案总可售）
                                          SWYVID.PO_TOTAL_SALE_AVERAGE_AMOUNT   "poTotalSaleAverageAmount",--均价（全案总可售）
                                          SWYVID.PO_TOTAL_SALE_AMOUNT           "poTotalSaleAmount",--货值（全案总可售）
                                          SWYVID.PO_SALE_AREA                   "poSaleArea",--面积（全案已售）
                                          SWYVID.PO_SALE_COUNT                  "poSaleCount",--套数（全案已售）
                                          SWYVID.PO_SALE_AVERAGE_AMOUNT         "poSaleAverageAmount",--均价（全案已售）
                                          SWYVID.PO_SALE_AMOUNT                 "poSaleAmount",--货值（全案已售）
                                          SWYVID.PO_SURPLUS_SALE_AREA           "poSurplusSaleArea",--面积（全案库存）
                                          SWYVID.PO_SURPLUS_SALE_COUNT          "poSurplusSaleCount",--套数（全案库存）
                                          SWYVID.PO_SURPLUS_SALE_AVERAGE_AMOUNT "poSurplusSaleAverageAmount",--均价（全案库存）
                                          SWYVID.PO_SURPLUS_SALE_AMOUNT         "poSurplusSale",--货值  (全案库存)
                                          SWYVID.RP_TOTAL_AREA                  "rpTotalArea",--面积  (已取证)
                                          SWYVID.RP_TOTAL_COUNT                 "rpTotalCount",--套数  (已取证)
                                          SWYVID.RP_TOTAL_AVERAGE_AMOUNT        "rpTotalAverageAmount",--均价  (已取证)
                                          SWYVID.RP_TOTAL_AMOUNT                "rpTotalAmount",--货值  (已取证)
                                          SWYVID.RP_SURPLUS_AREA                "rpSurplusArea",--面积  (已取证库存)
                                          SWYVID.RP_SURPLUS_COUNT               "rpSurplusCount",--套数  (已取证库存)
                                          SWYVID.RP_SURPLUS_AVERAGE_AMOUNT      "rpSurplusAverageAmount",--均价  (已取证库存)
                                          SWYVID.RP_SURPLUS_AMOUNT              "rpSurplus",--货值  (已取证库存)
                                          ens.SUPPLY_TOTAL_AMOUNT               "supplyTotalAmount",
                                          ens.SUPPLY_TOTAL_AREA                 "supplyTotalArea",
                                          ens.SUPPLY_TOTAL_NUMBER               "supplyTotalCount",
                                          ens.SUPPLY_AVERAGE_AMOUNT             "supplyTotalAverageAmount",
                                          SELL_TOTAL_AMOUNT                     "sellTotalAmount",
                                          SELL_TOTAL_AREA                       "sellTotalArea",
                                          SELL_TOTAL_NUMBER                     "sellTotalCount"
                                   from SWM_YE_VALUE_INVENTORY_DTL SWYVID
                                            left join (select SWM_SUPPLY_SELL_PLAN_DTL.BIZ_ID,
                                                              SWM_SUPPLY_SELL_PLAN_DTL.SELL_TOTAL_AMOUNT,
                                                              SWM_SUPPLY_SELL_PLAN_DTL.SELL_TOTAL_AREA,
                                                              SWM_SUPPLY_SELL_PLAN_DTL.SELL_TOTAL_NUMBER
                                                       from SWM_SUPPLY_SELL_PLAN_DTL
                                                       where SUPPLY_SELL_PLAN_ID = swmSupplySellPlanId) SSSPD
                                                      on SSSPD.BIZ_ID = SWYVID.BIZ_ID
                                            left join (select biz_id,
                                                              0 AS SUPPLY_TOTAL_AREA,
                                                              0 AS SUPPLY_TOTAL_NUMBER,
                                                              0 AS SUPPLY_AVERAGE_AMOUNT,
                                                              0 AS SUPPLY_TOTAL_AMOUNT
                                                       from SWM_YE_VALUE_INVENTORY_DTL
                                                                left join SWM_YE_VALUE_INVENTORY
                                                                          on SWM_YE_VALUE_INVENTORY_DTL.YE_VALUE_INVENTORY_ID =
                                                                             SWM_YE_VALUE_INVENTORY.ID
                                                       where extract(year from SWM_YE_VALUE_INVENTORY.YEAR) = (planYear - 1)
                                                         AND SWM_YE_VALUE_INVENTORY.PROJECT_ID = projectId
                                   ) ens on ens.biz_id = SWYVID.BIZ_ID
                                   WHERE OBJ_TYPE <> '无分期'
                                     and SWYVID.BIZ_ID <> businessSummaryBizId
                                     and BIZ_PARENT_ID <> businessSummaryBizId
                                     and YE_VALUE_INVENTORY_ID = yeValueInventoryId
                                   order by "ORDER_CODE");
end if;
end if;


END P_SWM_YE_VALUE_INVENTORY;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_ANALYSIS_VIRTUAL_PERSONS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_ANALYSIS_VIRTUAL_PERSONS" (
    companyid        IN                   varchar2,
    deptid        IN                   varchar2,
    info     OUT             SYS_REFCURSOR
) IS
--虚拟组解析
--作者：陈丽
--日期：2020/08/25
BEGIN
OPEN info FOR
with base as(
SELECT r.user_account,r.company_id,r.company_name,r.dept_id,r.dept_name FROM sys_role_user_relation_result r
--【三级单位】：获取当前项目所属公司，递归所有父级公司集合（项目所属公司在三级单位子级公司），包含自身（项目所属公司在三级单位），并且公司层级=3，公司 id作为虚拟组解析公司。--递归所有父级公司集合，包含自身，并且公司层级=3
INNER JOIN
(
SELECT id FROM (
SELECT*FROM sys_business_unit m START WITH m.id=companyid CONNECT BY PRIOR m.parent_id=m.id
) org
WHERE org.is_company=1 AND org.level_rank=3
UNION ALL
--chenl 20200718 项目所属公司在三级单位。期望解析三级单位的子公司，计划运营岗位（实际是四级单位的）的人。
SELECT id FROM sys_business_unit m WHERE m.parent_id=companyid AND m.is_company=1 AND m.level_rank=4
) org
ON r.company_id=org.id WHERE r.virtual_group_name LIKE '%【三级单位】%'
AND r.role_type=40 AND r.user_account IS NOT NULL
UNION
SELECT r.user_account,r.company_id,r.company_name,r.dept_id,r.dept_name FROM sys_role_user_relation_result r
--兄弟节点和所有子级，并且公司层级=3
INNER JOIN
(
SELECT id FROM (
SELECT*FROM sys_business_unit m1 WHERE EXISTS (
SELECT*FROM sys_business_unit m2 WHERE m1.parent_id=m2.parent_id AND m2.id=companyid)
UNION
SELECT*FROM sys_business_unit m START WITH m.id=companyid CONNECT BY m.parent_id=PRIOR m.id) org WHERE org.is_company=1 AND org.level_rank=3
) org
ON r.company_id=org.id WHERE r.virtual_group_name   LIKE '%【二级单位】%'
AND r.role_type=40 AND r.user_account IS NOT NULL)

select u.id as "id",
    base.user_account as "userAccount",
    base.company_id as "companyId",
    base.company_name as "companyName",
    base.dept_id as "deptId",
    base.dept_name as "deptName",
    user_name as "userName",
    mobile_phone as "mobilePhone",
    SUBSTR(org_full_name,length('中国铁建地产集团->')+1 ) as "orgFullNname"
    from base left join sys_user u on base.user_account=u.USER_CODE
    left join SYS_BUSINESS_UNIT unit on base.dept_id=unit.id;
end;


/
--------------------------------------------------------
--  DDL for Procedure P_SYS_AUTH_DATA_RULE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_AUTH_DATA_RULE" ( USERID IN VARCHAR2, STATIONID IN VARCHAR2, DEPTID IN VARCHAR2, COMPANYID IN VARCHAR2, BIZCODE IN VARCHAR2 ,
DATA_AUTH_INFO OUT sys_refcursor) 
AS
--数据鉴权，返回数据权限中有权限的项目或部门（不考虑隔离规则）
--作者：谷国斌
--日期：2019/12/13
AUTHCOUNT INT;--用于判断当前公司、部门是否与数据授权的主体有关系
SPID VARCHAR2(36);--使用临时表的批次号
BEGIN

select get_uuid() into SPID from dual;


--插入数据授权的数据：

        DECLARE
                OWNERID  VARCHAR2(36);
                OENERTYPE NVARCHAR2(50);
                CURSOR cursor_company IS
                select distinct auth_owner_id,auth_owner_type from SYS_DATA_AUTH where auth_biz_code=BIZCODE and is_disabled=0;

            BEGIN   

            --打开游标
                OPEN cursor_company;
                loop
                    fetch cursor_company into OWNERID,OENERTYPE;
                    exit when cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                if OENERTYPE='公司' or OENERTYPE='集团'
                then
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                     SELECT count(*) into AUTHCOUNT FROM sys_business_unit where is_company=1 and id=COMPANYID
                    START WITH ID=OWNERID CONNECT BY PRIOR  ID=parent_id;
                    if AUTHCOUNT<>0
                    then
                        insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
                        values(SPID,OWNERID,OENERTYPE);

                    end if;

                end if;

                 if OENERTYPE='部门'
                then
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                     SELECT count(*) into AUTHCOUNT FROM sys_business_unit where is_company=0 and id=DEPTID
                    START WITH ID=OWNERID CONNECT BY PRIOR  ID=parent_id;
                    if AUTHCOUNT<>0
                    then
                        insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
                        values(SPID,OWNERID,OENERTYPE);

                    end if;

                end if;

                 if (OENERTYPE='岗位' and OWNERID=STATIONID) or (OENERTYPE='人员' and OWNERID=USERID)
                then

                       insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
                        values(SPID,OWNERID,OENERTYPE);    
                end if;

                end loop;

                close cursor_company;

            END;   


          --获取有权限的公司及其部门：            
                DECLARE
                        OWNERID2  VARCHAR2(36);
                        CURSOR cursor_auth IS
                        select distinct auth_owner_id from TMP_AUTH_OWNER where ID=SPID;

                    BEGIN   

                    --打开游标
                        OPEN cursor_auth;
                        loop
                            fetch cursor_auth into OWNERID2;
                            exit when cursor_auth%notfound;


                            --授权对象为公司：
                            --取授权公司的子级：
                            insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,ID FROM
                            sys_business_unit where is_company=0
                                START WITH ID in (
                                select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type in ('公司','集团') and auth_type='部门'
                                )  CONNECT BY PRIOR  ID=parent_id;


                         insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,org_id FROM
                            v_sys_project where org_type<>0
                                START WITH org_id in (
                                select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type in ('公司','集团') and auth_type='项目'
                                )  CONNECT BY PRIOR  org_id=parent_id;

                           --插入可研项目     
                          insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,id FROM
                            CDB_FEASIBLE_PROJECT_CONFIG 
                            where subordinate_company_id in
                                (select id from sys_business_unit where is_company=1 START WITH id in (
                                select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type in ('公司','集团') and auth_type='项目'
                                )  CONNECT BY PRIOR  id=parent_id);       

                             --授权对象为部门：
                               --取授权部门及其子级：

                                 insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,ID FROM
                            sys_business_unit where is_company=0
                                START WITH ID in  (select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type='部门' and auth_type='部门'
                                )  CONNECT BY PRIOR  ID=parent_id;

                               --授权对象为项目： 
                            insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,org_id FROM
                            v_sys_project where org_type<>0 and project_id in 
                                 (select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type='项目' and auth_type='项目'
                                );   

                              end loop;
                           close  cursor_auth;    
                        end;

    --2020/2/20:成本数据库需要，增加
    --插入隔离规则-项目：
    insert into TMP_AUTH_LIST(ID,ORG_ID)
    select SPID,id from sys_project a inner join (
    select ISOLATION_RULE_VALUE from SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE=BIZCODE and ISOLATION_RULE_VALUE='全集团')
    on 1=1;
    --插入隔离规则-可研项目：
    insert into TMP_AUTH_LIST(ID,ORG_ID)
    select SPID,id from CDB_FEASIBLE_PROJECT_CONFIG a inner join (
    select ISOLATION_RULE_VALUE from SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE=BIZCODE and ISOLATION_RULE_VALUE='全集团')
    on 1=1;
    --插入隔离规则-项目：
    insert into TMP_AUTH_LIST(ID,ORG_ID)
    select SPID,id from sys_project a inner join (
    select ISOLATION_RULE_VALUE from SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE=BIZCODE and ISOLATION_RULE_VALUE='本公司')
    on 1=1 where a.unit_id=COMPANYID;
    --插入隔离规则-可研项目：
    insert into TMP_AUTH_LIST(ID,ORG_ID)
    select SPID,id from CDB_FEASIBLE_PROJECT_CONFIG a inner join (
    select ISOLATION_RULE_VALUE from SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE=BIZCODE and ISOLATION_RULE_VALUE='本公司')
    on 1=1 where a.subordinate_company_id=COMPANYID;



 open DATA_AUTH_INFO for
select distinct ORG_ID as orgId
from TMP_AUTH_LIST WHERE ID=SPID;

END P_SYS_AUTH_DATA_RULE;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_AUTH_DATA_RULE_SPID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_AUTH_DATA_RULE_SPID" ( USERID IN VARCHAR2, STATIONID IN VARCHAR2, DEPTID IN VARCHAR2, COMPANYID IN VARCHAR2, BIZCODE IN VARCHAR2 ,
DATA_AUTH_SPID OUT VARCHAR2) 
AS
--数据鉴权，返回数据权限中有权限的项目或部门（不考虑隔离规则）
--作者：谷国斌
--日期：2019/12/13
AUTHCOUNT INT;--用于判断当前公司、部门是否与数据授权的主体有关系
SPID VARCHAR2(36);--使用临时表的批次号
BEGIN
select get_uuid() into SPID from dual;
------------------------------------------------------开始-----------------------------------------------部门和项目 复制谷哥鉴权存储过程 
--插入数据授权的数据：

        DECLARE
                OWNERID  VARCHAR2(36);
                OENERTYPE NVARCHAR2(50);
                CURSOR cursor_company IS
                select distinct auth_owner_id,auth_owner_type from SYS_DATA_AUTH where auth_biz_code=BIZCODE and is_disabled=0;

            BEGIN   

            --打开游标
                OPEN cursor_company;
                loop
                    fetch cursor_company into OWNERID,OENERTYPE;
                    exit when cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                if OENERTYPE='公司' or OENERTYPE='集团'
                then
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                     SELECT count(*) into AUTHCOUNT FROM sys_business_unit where is_company=1 and id=COMPANYID
                    START WITH ID=OWNERID CONNECT BY PRIOR  ID=parent_id;
                    if AUTHCOUNT<>0
                    then
                        insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
                        values(SPID,OWNERID,OENERTYPE);

                    end if;

                end if;

                 if OENERTYPE='部门'
                then
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                     SELECT count(*) into AUTHCOUNT FROM sys_business_unit where is_company=0 and id=DEPTID
                    START WITH ID=OWNERID CONNECT BY PRIOR  ID=parent_id;
                    if AUTHCOUNT<>0
                    then
                        insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
                        values(SPID,OWNERID,OENERTYPE);

                    end if;

                end if;

                 if (OENERTYPE='岗位' and OWNERID=STATIONID) or (OENERTYPE='人员' and OWNERID=USERID)
                then

                       insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
                        values(SPID,OWNERID,OENERTYPE);    
                end if;

                end loop;

                close cursor_company;

            END;   


          --获取有权限的公司及其部门：            
                DECLARE
                        OWNERID2  VARCHAR2(36);
                        CURSOR cursor_auth IS
                        select distinct auth_owner_id from TMP_AUTH_OWNER where ID=SPID;

                    BEGIN   

                    --打开游标
                        OPEN cursor_auth;
                        loop
                            fetch cursor_auth into OWNERID2;
                            exit when cursor_auth%notfound;


                            --授权对象为公司：
                            --取授权公司的子级：
                            insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,ID FROM
                            sys_business_unit where is_company=0
                                START WITH ID in (
                                select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type in ('公司','集团') and auth_type='部门'
                                )  CONNECT BY PRIOR  ID=parent_id;


                         insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,org_id FROM
                            v_sys_project where org_type<>0
                                START WITH org_id in (
                                select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type in ('公司','集团') and auth_type='项目'
                                )  CONNECT BY PRIOR  org_id=parent_id;

                           --插入可研项目     
                          insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,id FROM
                            CDB_FEASIBLE_PROJECT_CONFIG 
                            where subordinate_company_id in
                                (select id from sys_business_unit where is_company=1 START WITH id in (
                                select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type in ('公司','集团') and auth_type='项目'
                                )  CONNECT BY PRIOR  id=parent_id);       

                             --授权对象为部门：
                               --取授权部门及其子级：

                                 insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,ID FROM
                            sys_business_unit where is_company=0
                                START WITH ID in  (select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type='部门' and auth_type='部门'
                                )  CONNECT BY PRIOR  ID=parent_id;

                               --授权对象为项目： 
                            insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,org_id FROM
                            v_sys_project where org_type<>0 and project_id in 
                                 (select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type='项目' and auth_type='项目'
                                );   

                              end loop;
                           close  cursor_auth;    
                        end;

    --2020/2/20:成本数据库需要，增加
    --插入隔离规则-项目：
    insert into TMP_AUTH_LIST(ID,ORG_ID)
    select SPID,id from sys_project a inner join (
    select ISOLATION_RULE_VALUE from SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE=BIZCODE and ISOLATION_RULE_VALUE='全集团')
    on 1=1;
    --插入隔离规则-可研项目：
    insert into TMP_AUTH_LIST(ID,ORG_ID)
    select SPID,id from CDB_FEASIBLE_PROJECT_CONFIG a inner join (
    select ISOLATION_RULE_VALUE from SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE=BIZCODE and ISOLATION_RULE_VALUE='全集团')
    on 1=1;
    --插入隔离规则-项目：
    insert into TMP_AUTH_LIST(ID,ORG_ID)
    select SPID,id from sys_project a inner join (
    select ISOLATION_RULE_VALUE from SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE=BIZCODE and ISOLATION_RULE_VALUE='本公司')
    on 1=1 where a.unit_id=COMPANYID;
    --插入隔离规则-可研项目：
    insert into TMP_AUTH_LIST(ID,ORG_ID)
    select SPID,id from CDB_FEASIBLE_PROJECT_CONFIG a inner join (
    select ISOLATION_RULE_VALUE from SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE=BIZCODE and ISOLATION_RULE_VALUE='本公司')
    on 1=1 where a.subordinate_company_id=COMPANYID;
------------------------------------------------------结束-----------------------------------------------部门和项目 复制谷哥鉴权存储过程 
-------------------------------------------------------开始----------------------------------------------公司、岗位、人 chenl
    --插入隔离规则-公司、岗位、人
    insert into TMP_AUTH_LIST(ID,ORG_ID)
  	SELECT SPID,
CASE 
	ISOLATION_RULE_VALUE 
	WHEN '本公司' THEN COMPANYID
	WHEN '本部门' THEN DEPTID
	WHEN '本岗位' THEN STATIONID
	WHEN '本人' THEN USERID
	ELSE ''
END AS AUTH_SCOPE_ID
FROM SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE = BIZCODE and ISOLATION_RULE_VALUE in ('本公司','本部门','本岗位','本人');


 DATA_AUTH_SPID:=SPID;
-- open DATA_AUTH_INFO for
--select distinct ORG_ID as orgId
--from TMP_AUTH_LIST WHERE ID=SPID;

END P_SYS_AUTH_DATA_RULE_SPID;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_AUTH_ISOLATION_RULE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_AUTH_ISOLATION_RULE" 
(
		USER_ID        IN VARCHAR2
	 ,STATION_ID     IN VARCHAR2
	 ,DEPT_ID        IN VARCHAR2
	 ,COMPANY_ID     IN VARCHAR2
	 ,BIZ_CODE       IN VARCHAR2
	 ,DATA_AUTH_INFO OUT SYS_REFCURSOR
) AS
		--隔离规则鉴权
		--作者：徐峰
		--日期：2019/12/14
BEGIN
		OPEN DATA_AUTH_INFO FOR
				SELECT CASE ISOLATION_RULE_VALUE
										WHEN '全集团' THEN
										 '003200000000000000000000000000'
										WHEN '本公司' THEN
										 COMPANY_ID
										WHEN '本部门' THEN
										 DEPT_ID
										WHEN '本岗位' THEN
										 STATION_ID
										WHEN '本岗位' THEN
										 USER_ID
										ELSE
										 ''
								END AS AUTH_SCOPE_ID,
							 SUBSTR(ISOLATION_RULE_VALUE, 2, LENGTH(ISOLATION_RULE_VALUE)) AS AUTH_SCOPE_TYPE
				FROM   SYS_DATA_AUTH_BIZ
				WHERE  BIZ_OBJ_CODE = BIZ_CODE;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_BUILD_SYNCHRONIZATION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_BUILD_SYNCHRONIZATION" AS
--同步主数据数据--楼同步
--处理原因：除主数据维护外，其他地方使用项目表混乱。主数据维护外使用项目按设计，应计划统一调整使用 分期、楼栋sys_project,sys_project_stage,sys_build,sys_PARCEL
--作者：陈丽
--日期：2020-06-19
BEGIN------同步主数据项目
----删除楼栋;
DELETE sys_build;
INSERT INTO sys_build (id,build_name,period_id,parcel_id,proj_id,delivery_type,issue_time,is_get_con_plan_permit,con_plan_permit_date,con_plan_permit_no,is_get_constrcution_permit,constrcution_permit_date,construction_permit_no,is_get_pre_sale_permit,pre_sale_permit_date,pre_sale_permit_no,is_get_completed_permit,completed_permit_date,completed_permit_no,ORDER_HIERARCHY_CODE) 
WITH build AS (
   SELECT id,build_name,period_id,parcel_id,proj_id,delivery_type,issue_time,is_get_con_plan_permit,get_con_plan_permit_date,con_plan_permit_no,is_get_constrcution_permit,get_constrcution_permit_date,construction_permit_no,is_get_pre_sale_permit,get_pre_sale_permit_date,pre_sale_permit_no,is_get_completed_permit,get_completed_permit_date,get_completed_permit_no,ORDER_HIERARCHY_CODE FROM mdm_build WHERE BUILD_STATE=10
) 
SELECT*FROM build;
COMMIT;
EXCEPTION
  WHEN OTHERS THEN
    dbms_output.put_line(SQLERRM);
    ROLLBACK;
END P_SYS_BUILD_SYNCHRONIZATION;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_CURRENT_USER
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_CURRENT_USER" (userid in varchar,positionid in varchar,user_id OUT varchar,position_id OUT varchar)
AS  
BEGIN  
position_id:=positionid;
user_id:=userid;
END p_sys_current_user;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_DATA_AUTH
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_DATA_AUTH" ( USER_ID IN VARCHAR2, STATION_ID IN VARCHAR2, DEPT_ID IN VARCHAR2, COMPANY_ID IN VARCHAR2, BIZ_CODE IN VARCHAR2 ,
  DATA_AUTH_INFO OUT sys_refcursor) 
AS
--数据鉴权。包含数据权限和隔离规则的鉴权。
--作者：徐峰
--日期：2019/11/17
BEGIN
 open DATA_AUTH_INFO for
--数据权限
SELECT
	AUTH_SCOPE_ID,
	AUTH_SCOPE_TYPE,
	'数据权限' AS Auth_TYPE 
FROM
	SYS_DATA_AUTH 
WHERE
    IS_DISABLED = 0
    AND auth_biz_code = BIZ_CODE
		AND ( AUTH_OWNER_ID = USER_ID OR AUTH_OWNER_ID = STATION_ID OR AUTH_OWNER_ID = DEPT_ID OR AUTH_OWNER_ID = COMPANY_ID )
	UNION all 
--隔离规则
	SELECT
CASE
	ISOLATION_RULE_VALUE 
	WHEN '全集团' THEN '003200000000000000000000000000'
	WHEN '本公司' THEN COMPANY_ID
	WHEN '本部门' THEN DEPT_ID
	WHEN '本岗位' THEN STATION_ID
	else USER_ID
END AS AUTH_SCOPE_ID,
	SUBSTR( ISOLATION_RULE_VALUE, 2, length( ISOLATION_RULE_VALUE )) AS AUTH_SCOPE_TYPE,
	'隔离规则' AS Auth_TYPE 
FROM SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE = BIZ_CODE;
END P_SYS_DATA_AUTH;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_GET_COMPANY_PROJ_SPID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_GET_COMPANY_PROJ_SPID" 
(
		USERID         IN VARCHAR2
	 ,STATIONID      IN VARCHAR2
	 ,DEPTID         IN VARCHAR2
	 ,COMPANYID      IN VARCHAR2
	 ,BIZCODE        IN VARCHAR2
	 ,DATA_AUTH_SPID OUT VARCHAR2
) AS
		--获取有项目的公司树
		--作者：谷国斌
		--日期：2019/12/13
		RULEVALUE VARCHAR2(50);
		AUTHCOUNT INT; --用于判断当前公司、部门是否与数据授权的主体有关系
		SPID      VARCHAR2(36); --使用临时表的批次号
BEGIN

		SELECT GET_UUID() INTO SPID FROM DUAL;
		--插入集团作为根节点
		INSERT INTO TMP_COMPANY_TREE
				(ID, ORG_ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY, ORDER_CODE)
				SELECT SPID, ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
							 ORDER_HIERARCHY_CODE
				FROM   SYS_BUSINESS_UNIT
				WHERE  ID = '003200000000000000000000000000';

		--获取隔离规则：
		SELECT ISOLATION_RULE_VALUE
		INTO   RULEVALUE
		FROM   SYS_DATA_AUTH_BIZ
		WHERE  BIZ_OBJ_CODE = BIZCODE;
		IF RULEVALUE = '全集团' THEN
				INSERT INTO TMP_COMPANY_TREE
						(ID, ORG_ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
						 ORDER_CODE)
						SELECT SPID, ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
									 ORDER_HIERARCHY_CODE
						FROM   SYS_BUSINESS_UNIT
						WHERE  IS_COMPANY = 1;
		ELSE
				--插入本公司及其父级
				INSERT INTO TMP_COMPANY_TREE
						(ID, ORG_ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
						 ORDER_CODE)
						SELECT SPID, ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
									 ORDER_HIERARCHY_CODE
						FROM   SYS_BUSINESS_UNIT
						WHERE  IS_COMPANY = 1
						START  WITH ID = COMPANYID
						CONNECT BY PRIOR PARENT_ID = ID;

				--插入数据授权的数据：

				DECLARE
						OWNERID   VARCHAR2(36);
						OENERTYPE NVARCHAR2(50);
						CURSOR CURSOR_COMPANY IS
								SELECT DISTINCT AUTH_OWNER_ID, AUTH_OWNER_TYPE
								FROM   SYS_DATA_AUTH
								WHERE  AUTH_BIZ_CODE = BIZCODE AND
											 IS_DISABLED = 0;

				BEGIN

						--打开游标
						OPEN CURSOR_COMPANY;
						LOOP
								FETCH CURSOR_COMPANY
										INTO OWNERID, OENERTYPE;
								EXIT WHEN CURSOR_COMPANY%NOTFOUND;

								--过滤当前用户有权限的授权对象：
								IF OENERTYPE = '公司' OR OENERTYPE = '集团' THEN
										--AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司
										SELECT COUNT(*)
										INTO   AUTHCOUNT
										FROM   SYS_BUSINESS_UNIT
										WHERE  IS_COMPANY = 1 AND
													 ID = COMPANYID
										START  WITH ID = OWNERID
										CONNECT BY PRIOR ID = PARENT_ID;
										IF AUTHCOUNT <> 0 THEN
												INSERT INTO TMP_AUTH_OWNER
														(ID, AUTH_OWNER_ID, AUTH_OWNER_TYPE)
												VALUES
														(SPID, OWNERID, OENERTYPE);

										END IF;

								END IF;

								IF OENERTYPE = '部门' THEN
										--AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门
										SELECT COUNT(*)
										INTO   AUTHCOUNT
										FROM   SYS_BUSINESS_UNIT
										WHERE  IS_COMPANY = 0 AND
													 ID = DEPTID
										START  WITH ID = OWNERID
										CONNECT BY PRIOR ID = PARENT_ID;
										IF AUTHCOUNT <> 0 THEN
												INSERT INTO TMP_AUTH_OWNER
														(ID, AUTH_OWNER_ID, AUTH_OWNER_TYPE)
												VALUES
														(SPID, OWNERID, OENERTYPE);

										END IF;

								END IF;

								IF (OENERTYPE = '岗位' AND OWNERID = STATIONID) OR
									 (OENERTYPE = '人员' AND OWNERID = USERID) THEN

										INSERT INTO TMP_AUTH_OWNER
												(ID, AUTH_OWNER_ID, AUTH_OWNER_TYPE)
										VALUES
												(SPID, OWNERID, OENERTYPE);
								END IF;

						END LOOP;

						CLOSE CURSOR_COMPANY;

				END;

				--获取有权限的公司及其父级：
				DECLARE
						OWNERID2 VARCHAR2(36);
						CURSOR CURSOR_AUTH IS
								SELECT AUTH_OWNER_ID FROM TMP_AUTH_OWNER WHERE ID = SPID;

				BEGIN

						--打开游标
						OPEN CURSOR_AUTH;
						LOOP
								FETCH CURSOR_AUTH
										INTO OWNERID2;
								EXIT WHEN CURSOR_AUTH%NOTFOUND;

								--授权对象为公司：
								--取授权公司的子级：
								INSERT INTO TMP_COMPANY_TREE
										(ID, ORG_ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
										 ORDER_CODE)
										SELECT SPID, ID, ORG_NAME, ORG_TYPE, PARENT_ID,
													 IS_COMPANY, ORDER_HIERARCHY_CODE
										FROM   SYS_BUSINESS_UNIT
										WHERE  IS_COMPANY = 1
										START  WITH ID IN
																(SELECT DISTINCT AUTH_SCOPE_ID
																 FROM   SYS_DATA_AUTH
																 WHERE  AUTH_BIZ_CODE = BIZCODE AND
																				IS_DISABLED = 0 AND
																				AUTH_OWNER_ID = OWNERID2 AND
																				AUTH_SCOPE_TYPE IN ('公司', '集团'))
										CONNECT BY PRIOR ID = PARENT_ID;

								--取授权公司的父级：
								INSERT INTO TMP_COMPANY_TREE
										(ID, ORG_ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
										 ORDER_CODE)
										SELECT SPID, ID, ORG_NAME, ORG_TYPE, PARENT_ID,
													 IS_COMPANY, ORDER_HIERARCHY_CODE
										FROM   SYS_BUSINESS_UNIT
										WHERE  IS_COMPANY = 1
										START  WITH ID IN
																(SELECT DISTINCT AUTH_SCOPE_ID
																 FROM   SYS_DATA_AUTH
																 WHERE  AUTH_BIZ_CODE = BIZCODE AND
																				IS_DISABLED = 0 AND
																				AUTH_OWNER_ID = OWNERID2 AND
																				AUTH_SCOPE_TYPE IN ('公司', '集团'))
										CONNECT BY PRIOR PARENT_ID = ID;

								--授权对应为部门：
								--取授权部门的父级：

								INSERT INTO TMP_COMPANY_TREE
										(ID, ORG_ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
										 ORDER_CODE)
										SELECT SPID, ID, ORG_NAME, ORG_TYPE, PARENT_ID,
													 IS_COMPANY, ORDER_HIERARCHY_CODE
										FROM   SYS_BUSINESS_UNIT
										WHERE  IS_COMPANY = 1
										START  WITH ID IN (SELECT DISTINCT AUTH_SCOPE_ID
																			 FROM   SYS_DATA_AUTH
																			 WHERE  AUTH_BIZ_CODE = BIZCODE AND
																							IS_DISABLED = 0 AND
																							AUTH_OWNER_ID = OWNERID2 AND
																							AUTH_SCOPE_TYPE = '部门')
										CONNECT BY PRIOR PARENT_ID = ID;
								--授权对应为项目：

								INSERT INTO TMP_COMPANY_TREE
										(ID, ORG_ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
										 ORDER_CODE)
										SELECT SPID, ID, ORG_NAME, ORG_TYPE, PARENT_ID,
													 IS_COMPANY, ORDER_HIERARCHY_CODE
										FROM   SYS_BUSINESS_UNIT
										WHERE  IS_COMPANY = 1
										START  WITH ID IN
																(SELECT UNIT_ID
																 FROM   SYS_PROJECT
																 WHERE  ID IN
																				(SELECT DISTINCT AUTH_SCOPE_ID
																				 FROM   SYS_DATA_AUTH
																				 WHERE  AUTH_BIZ_CODE = BIZCODE AND
																								IS_DISABLED = 0 AND
																								AUTH_OWNER_ID = OWNERID2 AND
																								AUTH_SCOPE_TYPE = '项目'))
										CONNECT BY PRIOR PARENT_ID = ID;

						END LOOP;
						CLOSE CURSOR_AUTH;
				END;

		END IF;
DATA_AUTH_SPID:=SPID;
--		OPEN DATA_AUTH_INFO FOR
--				SELECT DISTINCT ORG_ID AS ORGID, ORG_NAME AS ORGNAME,
--												ORG_TYPE AS ORGTYPE, PARENT_ID AS PARENTID,
--												1 AS ISCOMPANY, ORDER_CODE AS ORDERCODE
--				FROM   TMP_COMPANY_TREE
--				WHERE  ID = SPID AND
--							 ORG_ID IN (SELECT DISTINCT ID
--													FROM   SYS_BUSINESS_UNIT
--													START  WITH ID IN
--																			(SELECT ID
--																			 FROM   (SELECT UNIT_ID AS ID
--																								FROM   SYS_PROJECT
--																								UNION
--																								SELECT SUBORDINATE_COMPANY_ID AS ID
--																								FROM   CDB_FEASIBLE_PROJECT_CONFIG) DS)
--													CONNECT BY PRIOR PARENT_ID = ID)
--				ORDER  BY TO_NUMBER(ORDER_CODE);

END P_SYS_GET_COMPANY_PROJ_SPID;


/
--------------------------------------------------------
--  DDL for Procedure P_SYS_GET_COMPANY_TREE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_GET_COMPANY_TREE" (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    data_auth_info   OUT              SYS_REFCURSOR
) AS
--获取公司树
--作者：谷国斌
--日期：2019/12/13
    rulevalue   VARCHAR2(50);
    authcount   INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    spid        VARCHAR2(36);--使用临时表的批次号
BEGIN
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;
--插入集团作为根节点

    INSERT INTO tmp_company_tree (
        id,
        org_id,
        org_name,
        org_type,
        parent_id,
        is_company,
        order_code
    )
        SELECT
            spid,
            id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_hierarchy_code
        FROM
            sys_business_unit
        WHERE
            id = '003200000000000000000000000000';

--获取隔离规则：

    SELECT
        isolation_rule_value
    INTO rulevalue
    FROM
        sys_data_auth_biz
    WHERE
        biz_obj_code = bizcode;

    IF rulevalue = '全集团' THEN
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                is_company,
                order_hierarchy_code
            FROM
                sys_business_unit
            WHERE
                is_company = 1;

    ELSE 
--插入本公司及其父级
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                is_company,
                order_hierarchy_code
            FROM
                sys_business_unit
            WHERE
                is_company = 1
            START WITH
                id = companyid
            CONNECT BY
                PRIOR parent_id = id;

--插入数据授权的数据：

        DECLARE
            ownerid     VARCHAR2(36);
            oenertype   NVARCHAR2(50);
            CURSOR cursor_company IS
            SELECT DISTINCT
                auth_owner_id,
                auth_owner_type
            FROM
                sys_data_auth
            WHERE
                auth_biz_code = bizcode
                AND is_disabled = 0;

        BEGIN   

            --打开游标
            OPEN cursor_company;
            LOOP
                FETCH cursor_company INTO
                    ownerid,
                    oenertype;
                EXIT WHEN cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                IF oenertype = '公司' OR oenertype = '集团' THEN
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                        AND id = companyid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF oenertype = '部门' THEN
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 0
                        AND id = deptid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                    INSERT INTO tmp_auth_owner (
                        id,
                        auth_owner_id,
                        auth_owner_type
                    ) VALUES (
                        spid,
                        ownerid,
                        oenertype
                    );

                END IF;

            END LOOP;

            CLOSE cursor_company;
        END;   

          --获取有权限的公司及其父级：            

        DECLARE
            ownerid2 VARCHAR2(36);
            CURSOR cursor_auth IS
            SELECT
                auth_owner_id
            FROM
                tmp_auth_owner
            WHERE
                id = spid;

        BEGIN   

                    --打开游标
            OPEN cursor_auth;
            LOOP
                FETCH cursor_auth INTO ownerid2;
                EXIT WHEN cursor_auth%notfound;


                            --授权对象为公司：
                            --取授权公司的子级：
                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type IN (
                                    '公司',
                                    '集团'
                                )
                        )
                    CONNECT BY
                        PRIOR id = parent_id;


                            --取授权公司的父级：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type IN (
                                    '公司',
                                    '集团'
                                )
                        )
                    CONNECT BY
                        PRIOR parent_id = id;

                             --授权对应为部门：
                               --取授权部门的父级：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type = '部门'
                        )
                    CONNECT BY
                        PRIOR parent_id = id;
                               --授权对应为项目：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT
                                unit_id
                            FROM
                                sys_project
                            WHERE
                                id IN (
                                    SELECT DISTINCT
                                        auth_scope_id
                                    FROM
                                        sys_data_auth
                                    WHERE
                                        auth_biz_code = bizcode
                                        AND is_disabled = 0
                                        AND auth_owner_id = ownerid2
                                        --20200516 chenl 组织鉴权，按项目范围授权，单个项目 auth_scope_type 第一次保存错误"集团"，兼容改类数据
                                        AND (auth_scope_type = '项目' or auth_type='项目')
                                )
                        )
                    CONNECT BY
                        PRIOR parent_id = id;

            END LOOP;

            CLOSE cursor_auth;
        END;

    END IF;

    OPEN data_auth_info FOR SELECT DISTINCT
                               org_id       AS orgid,
                               org_name     AS orgname,
                               org_type     AS orgtype,
                               parent_id    AS parentid,
                               is_company   AS iscompany,
                               order_code   AS ordercode
                           FROM
                               tmp_company_tree
                           WHERE
                               id = spid
                           ORDER BY
                               order_code;

END p_sys_get_company_tree;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_GET_COMPANY_TREE_PROJ
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_GET_COMPANY_TREE_PROJ" (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    data_auth_info   OUT              SYS_REFCURSOR
) AS
--获取有项目的公司树
--作者：谷国斌
--日期：2019/12/13
    rulevalue   VARCHAR2(50);
    authcount   INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    spid        VARCHAR2(36);--使用临时表的批次号
BEGIN
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;
--插入集团作为根节点

    INSERT INTO tmp_company_tree (
        id,
        org_id,
        org_name,
        org_type,
        parent_id,
        is_company,
        order_code
    )
        SELECT
            spid,
            id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_hierarchy_code
        FROM
            sys_business_unit
        WHERE
            id = '003200000000000000000000000000';

--获取隔离规则：

    SELECT
        isolation_rule_value
    INTO rulevalue
    FROM
        sys_data_auth_biz
    WHERE
        biz_obj_code = bizcode;

    IF rulevalue = '全集团' THEN
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                is_company,
                order_hierarchy_code
            FROM
                sys_business_unit
            WHERE
                is_company = 1;

    ELSE 
--插入本公司及其父级
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                is_company,
                order_hierarchy_code
            FROM
                sys_business_unit
            WHERE
                is_company = 1
            START WITH
                id = companyid
            CONNECT BY
                PRIOR parent_id = id;

--插入数据授权的数据：

        DECLARE
            ownerid     VARCHAR2(36);
            oenertype   NVARCHAR2(50);
            CURSOR cursor_company IS
            SELECT DISTINCT
                auth_owner_id,
                auth_owner_type
            FROM
                sys_data_auth
            WHERE
                auth_biz_code = bizcode
                AND is_disabled = 0;

        BEGIN   

            --打开游标
            OPEN cursor_company;
            LOOP
                FETCH cursor_company INTO
                    ownerid,
                    oenertype;
                EXIT WHEN cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                IF oenertype = '公司' OR oenertype = '集团' THEN
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                        AND id = companyid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF oenertype = '部门' THEN
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 0
                        AND id = deptid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                    INSERT INTO tmp_auth_owner (
                        id,
                        auth_owner_id,
                        auth_owner_type
                    ) VALUES (
                        spid,
                        ownerid,
                        oenertype
                    );

                END IF;

            END LOOP;

            CLOSE cursor_company;
        END;   

          --获取有权限的公司及其父级：            

        DECLARE
            ownerid2 VARCHAR2(36);
            CURSOR cursor_auth IS
            SELECT
                auth_owner_id
            FROM
                tmp_auth_owner
            WHERE
                id = spid;

        BEGIN   

                    --打开游标
            OPEN cursor_auth;
            LOOP
                FETCH cursor_auth INTO ownerid2;
                EXIT WHEN cursor_auth%notfound;


                            --授权对象为公司：
                            --取授权公司的子级：
                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type IN (
                                    '公司',
                                    '集团'
                                )
                        )
                    CONNECT BY
                        PRIOR id = parent_id;


                            --取授权公司的父级：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type IN (
                                    '公司',
                                    '集团'
                                )
                        )
                    CONNECT BY
                        PRIOR parent_id = id;

                             --授权对应为部门：
                               --取授权部门的父级：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type = '部门'
                        )
                    CONNECT BY
                        PRIOR parent_id = id;
                               --授权对应为项目：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT
                                unit_id
                            FROM
                                sys_project
                            WHERE
                                id IN (
                                    SELECT DISTINCT
                                        auth_scope_id
                                    FROM
                                        sys_data_auth
                                    WHERE
                                        auth_biz_code = bizcode
                                        AND is_disabled = 0
                                        AND auth_owner_id = ownerid2
                                        --20200516 chenl 组织鉴权，按项目范围授权，单个项目 auth_scope_type 第一次保存错误"集团"，兼容改类数据
                                        AND (auth_scope_type = '项目' or auth_type='项目')
                                )
                        )
                    CONNECT BY
                        PRIOR parent_id = id;

            END LOOP;

            CLOSE cursor_auth;
        END;

    END IF;

    OPEN data_auth_info FOR SELECT DISTINCT
                               org_id       AS orgid,
                               org_name     AS orgname,
                               org_type     AS orgtype,
                               parent_id    AS parentid,
                               1 AS iscompany,
                               order_code   AS ordercode
                           FROM
                               tmp_company_tree
                           WHERE
                               id = spid
                               AND org_id IN (
                                   SELECT DISTINCT
                                       id
                                   FROM
                                       sys_business_unit
                                   START WITH
                                       id IN (
                                           SELECT
                                               id
                                           FROM
                                               (
                                                   SELECT
                                                       unit_id AS id
                                                   FROM
                                                       sys_project
                                                   UNION
                                                   SELECT
                                                       subordinate_company_id AS id
                                                   FROM
                                                       cdb_feasible_project_config
                                               ) ds
                                       )
                                   CONNECT BY
                                       PRIOR parent_id = id
                               )
                           ORDER BY
                               order_code;

END p_sys_get_company_tree_proj;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_GET_COMPANY_TREE_SPID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_GET_COMPANY_TREE_SPID" ( USERID IN VARCHAR2, STATIONID IN VARCHAR2, DEPTID IN VARCHAR2, COMPANYID IN VARCHAR2, BIZCODE IN VARCHAR2 ,
DATA_AUTH_SPID OUT varchar2) 
AS
--获取公司树
--作者：谷国斌
--日期：2019/12/13
RULEVALUE varchar2(50);
AUTHCOUNT INT;--用于判断当前公司、部门是否与数据授权的主体有关系
SPID VARCHAR2(36);--使用临时表的批次号
BEGIN
   SELECT
        get_uuid()
    INTO spid
    FROM
        dual;
--插入集团作为根节点

    INSERT INTO tmp_company_tree (
        id,
        org_id,
        org_name,
        org_type,
        parent_id,
        is_company,
        order_code
    )
        SELECT
            spid,
            id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_hierarchy_code
        FROM
            sys_business_unit
        WHERE
            id = '003200000000000000000000000000';

--获取隔离规则：

    SELECT
        isolation_rule_value
    INTO rulevalue
    FROM
        sys_data_auth_biz
    WHERE
        biz_obj_code = bizcode;

    IF rulevalue = '全集团' THEN
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                is_company,
                order_hierarchy_code
            FROM
                sys_business_unit
            WHERE
                is_company = 1;

    ELSE 
--插入本公司及其父级
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                is_company,
                order_hierarchy_code
            FROM
                sys_business_unit
            WHERE
                is_company = 1
            START WITH
                id = companyid
            CONNECT BY
                PRIOR parent_id = id;

--插入数据授权的数据：

        DECLARE
            ownerid     VARCHAR2(36);
            oenertype   NVARCHAR2(50);
            CURSOR cursor_company IS
            SELECT DISTINCT
                auth_owner_id,
                auth_owner_type
            FROM
                sys_data_auth
            WHERE
                auth_biz_code = bizcode
                AND is_disabled = 0;

        BEGIN   

            --打开游标
            OPEN cursor_company;
            LOOP
                FETCH cursor_company INTO
                    ownerid,
                    oenertype;
                EXIT WHEN cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                IF oenertype = '公司' OR oenertype = '集团' THEN
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                        AND id = companyid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF oenertype = '部门' THEN
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 0
                        AND id = deptid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                    INSERT INTO tmp_auth_owner (
                        id,
                        auth_owner_id,
                        auth_owner_type
                    ) VALUES (
                        spid,
                        ownerid,
                        oenertype
                    );

                END IF;

            END LOOP;

            CLOSE cursor_company;
        END;   

          --获取有权限的公司及其父级：            

        DECLARE
            ownerid2 VARCHAR2(36);
            CURSOR cursor_auth IS
            SELECT
                auth_owner_id
            FROM
                tmp_auth_owner
            WHERE
                id = spid;

        BEGIN   

                    --打开游标
            OPEN cursor_auth;
            LOOP
                FETCH cursor_auth INTO ownerid2;
                EXIT WHEN cursor_auth%notfound;


                            --授权对象为公司：
                            --取授权公司的子级：
                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type IN (
                                    '公司',
                                    '集团'
                                )
                        )
                    CONNECT BY
                        PRIOR id = parent_id;


                            --取授权公司的父级：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type IN (
                                    '公司',
                                    '集团'
                                )
                        )
                    CONNECT BY
                        PRIOR parent_id = id;

                             --授权对应为部门：
                               --取授权部门的父级：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type = '部门'
                        )
                    CONNECT BY
                        PRIOR parent_id = id;
                               --授权对应为项目：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT
                                unit_id
                            FROM
                                sys_project
                            WHERE
                                id IN (
                                    SELECT DISTINCT
                                        auth_scope_id
                                    FROM
                                        sys_data_auth
                                    WHERE
                                        auth_biz_code = bizcode
                                        AND is_disabled = 0
                                        AND auth_owner_id = ownerid2
                                        AND auth_scope_type = '项目'
                                )
                        )
                    CONNECT BY
                        PRIOR parent_id = id;

            END LOOP;

            CLOSE cursor_auth;
        END;

    END IF;
DATA_AUTH_SPID:=spid;
--    OPEN data_auth_info FOR SELECT DISTINCT
--                               org_id       AS orgid,
--                               org_name     AS orgname,
--                               org_type     AS orgtype,
--                               parent_id    AS parentid,
--                               is_company   AS iscompany,
--                               order_code   AS ordercode
--                           FROM
--                               tmp_company_tree
--                           WHERE
--                               id = spid
--                           ORDER BY
--                               order_code;

END P_SYS_GET_COMPANY_TREE_SPID;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_GET_DPT_TREE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_GET_DPT_TREE" (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    data_auth_info   OUT              SYS_REFCURSOR
) AS
--获取有权限的公司部门树
--作者：谷国斌
--日期：2019/12/13
    rulevalue   VARCHAR2(50);
    authcount   INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    spid        VARCHAR2(36);--使用临时表的批次号
BEGIN
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;

--IS_COMPANY在这个存储过程中调整为判断是否有权限使用，如本部门时，不能看父级部门的数据。
--获取隔离规则：

    SELECT
        isolation_rule_value
    INTO rulevalue
    FROM
        sys_data_auth_biz
    WHERE
        biz_obj_code = bizcode;

    IF rulevalue = '全集团' THEN
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                0,
                order_hierarchy_code
            FROM
                sys_business_unit;

    ELSE
        BEGIN
            IF rulevalue = '本公司' THEN
--插入本公司及其部门
                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        0,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    START WITH
                        id = companyid
                    CONNECT BY PRIOR id = parent_id
                               AND is_company = 0;

            ELSE  
--插入本公司及当前部门
                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        0,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        id = companyid;

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        CASE
                            WHEN id = deptid THEN
                                0
                            ELSE
                                1
                        END AS is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    START WITH
                        id = deptid
                    CONNECT BY PRIOR parent_id = id
                               AND is_company = 0;

            END IF;   
--插入数据授权的数据：

            DECLARE
                ownerid     VARCHAR2(36);
                oenertype   NVARCHAR2(50);
                CURSOR cursor_company IS
                SELECT DISTINCT
                    auth_owner_id,
                    auth_owner_type
                FROM
                    sys_data_auth
                WHERE
                    auth_biz_code = bizcode
                    AND is_disabled = 0
                    AND auth_type = '部门';

            BEGIN   

            --打开游标
                OPEN cursor_company;
                LOOP
                    FETCH cursor_company INTO
                        ownerid,
                        oenertype;
                    EXIT WHEN cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                    IF oenertype = '公司' OR oenertype = '集团' THEN
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                        SELECT
                            COUNT(*)
                        INTO authcount
                        FROM
                            sys_business_unit
                        WHERE
                            is_company = 1
                            AND id = companyid
                        START WITH
                            id = ownerid
                        CONNECT BY
                            PRIOR id = parent_id;

                        IF authcount <> 0 THEN
                            INSERT INTO tmp_auth_owner (
                                id,
                                auth_owner_id,
                                auth_owner_type
                            ) VALUES (
                                spid,
                                ownerid,
                                oenertype
                            );

                        END IF;

                    END IF;

                    IF oenertype = '部门' THEN
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                        SELECT
                            COUNT(*)
                        INTO authcount
                        FROM
                            sys_business_unit
                        WHERE
                            is_company = 0
                            AND id = deptid
                        START WITH
                            id = ownerid
                        CONNECT BY
                            PRIOR id = parent_id;

                        IF authcount <> 0 THEN
                            INSERT INTO tmp_auth_owner (
                                id,
                                auth_owner_id,
                                auth_owner_type
                            ) VALUES (
                                spid,
                                ownerid,
                                oenertype
                            );

                        END IF;

                    END IF;

                    IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END LOOP;

                CLOSE cursor_company;
            END;   

          --获取有权限的公司及其部门：            

            DECLARE
                ownerid2 VARCHAR2(36);
                CURSOR cursor_auth IS
                SELECT
                    auth_owner_id
                FROM
                    tmp_auth_owner
                WHERE
                    id = spid;

            BEGIN   

                    --打开游标
                OPEN cursor_auth;
                LOOP
                    FETCH cursor_auth INTO ownerid2;
                    EXIT WHEN cursor_auth%notfound;


                            --授权对象为公司：
                            --取授权公司的子级：
                    INSERT INTO tmp_company_tree (
                        id,
                        org_id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_code
                    )
                        SELECT
                            spid,
                            id,
                            org_name,
                            org_type,
                            parent_id,
                            0,
                            order_hierarchy_code
                        FROM
                            sys_business_unit
                        START WITH
                            id IN (
                                SELECT DISTINCT
                                    auth_scope_id
                                FROM
                                    sys_data_auth
                                WHERE
                                    auth_biz_code = bizcode
                                    AND is_disabled = 0
                                    AND auth_owner_id = ownerid2
                                    AND auth_scope_type IN (
                                        '公司',
                                        '集团'
                                    )
                                    AND auth_type = '部门'
                            )
                        CONNECT BY
                            PRIOR id = parent_id;


                             --授权对象为部门：
                               --取授权部门及其子级：

                    INSERT INTO tmp_company_tree (
                        id,
                        org_id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_code
                    )
                        SELECT
                            spid,
                            id,
                            org_name,
                            org_type,
                            parent_id,
                            0,
                            order_hierarchy_code
                        FROM
                            sys_business_unit
                        START WITH
                            id IN (
                                SELECT DISTINCT
                                    auth_scope_id
                                FROM
                                    sys_data_auth
                                WHERE
                                    auth_biz_code = bizcode
                                    AND is_disabled = 0
                                    AND auth_owner_id = ownerid2
                                    AND auth_scope_type = '部门'
                                    AND auth_type = '部门'
                            )
                        CONNECT BY
                            PRIOR id = parent_id;

                END LOOP;

                CLOSE cursor_auth;
            END;

        END;
    END IF;

    OPEN data_auth_info FOR SELECT DISTINCT
                               org_id       AS orgid,
                               org_name     AS orgname,
                               org_type     AS orgtype,
                               parent_id    AS parentid,
                               is_company   AS isdisable,
                               CASE
                                   WHEN org_type = 0 THEN
                                       1
                                   ELSE
                                       0
                               END AS iscompany,
                               order_code   AS ordercode
                           FROM
                               tmp_company_tree
                           WHERE
                               id = spid
                           ORDER BY
                               order_code;

END p_sys_get_dpt_tree;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_GET_HAS_PROJ_TREE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_GET_HAS_PROJ_TREE" (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    data_auth_info   OUT              SYS_REFCURSOR
) AS
    --获取有权限的公司树
    --作者：韩金明
    --日期：2020年5月9日
    ruleValue   VARCHAR2(50);
    ruleOrgId        VARCHAR2(36);--使用临时表的批次号
BEGIN
    SELECT isolation_rule_value INTO rulevalue FROM sys_data_auth_biz WHERE biz_obj_code = bizcode;
    if ruleValue = '全集团' then
        ruleOrgId := '003200000000000000000000000000';
    end if;
    if ruleValue = '本公司' then
        ruleOrgId := companyId;
    end if;
    if ruleValue = '本部门' then
        ruleOrgId := deptid;
    end if;
    open data_auth_info for with t1 as (
        -- 获取所有权限公司id
        select *
        from SYS_DATA_AUTH sda
        where instr(userId||','|| stationId || ',' || deptId || ',' || companyId, sda.AUTH_OWNER_ID) > 0
          and nvl(sda.AUTH_TYPE, '项目') = '项目' and sda.AUTH_BIZ_CODE=bizCode
    ), t2 as (
        -- 加上隔离规则id
        select AUTH_SCOPE_ID from t1
        union
        select ruleOrgId from dual
    ), t3 as (
        -- 查询公司的下面所有子公司
        select distinct *
        from SYS_BUSINESS_UNIT sbu
        where IS_COMPANY = 1
        start with sbu.id in (select AUTH_SCOPE_ID from t2)
        connect by prior sbu.id = sbu.PARENT_ID
    ), t4 as (
        --查询项目不为空的公司ID
        select  distinct mp.id mid, mp.PROJECT_NAME, mp.UNIT_ID mParentId,
            nvl(mp.ORDER_HIERARCHY_CODE, mp.PROJECT_CODE)  as pCode,
            t3.*
        from t3 left join SYS_PROJECT mp on t3.ID = mp.UNIT_ID
        where mp.ID is not null
    ) select
            distinct ID orgId,
            ORG_NAME orgName,
            ORG_TYPE orgType,
            PARENT_ID parentId,
            IS_COMPANY isCompany,
            ORDER_HIERARCHY_CODE || '' orderCode
    from SYS_BUSINESS_UNIT sbu
    start with sbu.ID in (select ID from t4)
    connect by prior sbu.PARENT_ID = sbu.ID
    union
    select
        t4.mid orgId,
        t4.PROJECT_NAME orgName,
        '10' orgType,
        t4.mParentId parentId,
        0 isCompany,
        nvl(pCode, '0') orderCode
    from t4;
END P_SYS_GET_HAS_PROJ_TREE;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_GET_ISOLATION_ID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_GET_ISOLATION_ID" 
(
		USER_ID           IN VARCHAR2
	 ,STATION_ID        IN VARCHAR2
	 ,DEPT_ID           IN VARCHAR2
	 ,COMPANY_ID        IN VARCHAR2
	 ,BIZ_CODE          IN VARCHAR2
	 ,OUT_AUTH_SCOPE_ID OUT VARCHAR2
) AS
		--隔离规则鉴权
		--作者：徐峰
		--日期：2019/12/14
BEGIN

		SELECT AUTH_SCOPE_ID
		INTO   OUT_AUTH_SCOPE_ID
		FROM   (SELECT CASE ISOLATION_RULE_VALUE
												 WHEN '全集团' THEN
													'集团'
												 WHEN '本公司' THEN
													COMPANY_ID
												 WHEN '本部门' THEN
													DEPT_ID
												 WHEN '本岗位' THEN
													STATION_ID
												 WHEN '本岗位' THEN
													USER_ID
												 ELSE
													''
										 END AS AUTH_SCOPE_ID
						 FROM   SYS_DATA_AUTH_BIZ
						 WHERE  BIZ_OBJ_CODE = BIZ_CODE);

END;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_GET_PROJ_STAGE_TREE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_GET_PROJ_STAGE_TREE" (
     userid           IN               VARCHAR2,
     stationid        IN               VARCHAR2,
     deptid           IN               VARCHAR2,
     companyid        IN               VARCHAR2,
     bizcode          IN               VARCHAR2,
     data_auth_info   OUT              SYS_REFCURSOR
 ) AS
 --获取有权限的项目树
 --作者：谢松宏
 --日期：2020/04/10
     rulevalue   VARCHAR2(50);
     authcount   INT;--用于判断当前公司、部门是否与数据授权的主体有关系
     spid        VARCHAR2(36);--使用临时表的批次号
 BEGIN
     SELECT
         get_uuid()
     INTO spid
     FROM
         dual;

 --获取隔离规则：

     SELECT
         isolation_rule_value
     INTO rulevalue
     FROM
         sys_data_auth_biz
     WHERE
             biz_obj_code = bizcode;

     IF rulevalue = '全集团' THEN
         INSERT INTO tmp_proj_tree (
             id,
             org_id,
             org_name,
             org_type,
             parent_id,
             full_name,
             is_end,
             city_name,
             company_id,
             order_code
         )
         SELECT
             spid,
             org_id,
             org_name,
             org_type,
             parent_id,
             full_name,
             is_end,
             city_name,
             company_id,
             sn
         FROM
             V_SYS_PROJECT_STAGE_TREE;

     ELSE
 --插入本公司的项目
         INSERT INTO tmp_proj_tree (
             id,
             org_id,
             org_name,
             org_type,
             parent_id,
             full_name,
             is_end,
             city_name,
             company_id,
             order_code
         )
         SELECT
             spid,
             org_id,
             org_name,
             org_type,
             parent_id,
             full_name,
             is_end,
             city_name,
             company_id,
             sn
         FROM
             V_SYS_PROJECT_STAGE_TREE
         WHERE
                 company_id = companyid;

 --插入数据授权的数据：

         DECLARE
             ownerid     VARCHAR2(36);
             oenertype   NVARCHAR2(50);
             CURSOR cursor_company IS
                 SELECT DISTINCT
                     auth_owner_id,
                     auth_owner_type
                 FROM
                     sys_data_auth
                 WHERE
                         auth_biz_code = bizcode
                   AND is_disabled = 0
                   AND nvl(auth_type, '项目') = '项目';

         BEGIN

             --打开游标
             OPEN cursor_company;
             LOOP
                 FETCH cursor_company INTO
                     ownerid,
                     oenertype;
                 EXIT WHEN cursor_company%notfound;

                 --过滤当前用户有权限的授权对象：
                 IF oenertype = '公司' OR oenertype = '集团' THEN
                     --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                     SELECT
                         COUNT(*)
                     INTO authcount
                     FROM
                         sys_business_unit
                     WHERE
                             is_company = 1
                       AND id = companyid
                     START WITH
                             id = ownerid
                     CONNECT BY
                             PRIOR id = parent_id;

                     IF authcount <> 0 THEN
                         INSERT INTO tmp_auth_owner (
                             id,
                             auth_owner_id,
                             auth_owner_type
                         ) VALUES (
                                      spid,
                                      ownerid,
                                      oenertype
                                  );

                     END IF;

                 END IF;

                 IF oenertype = '部门' THEN
                     --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                     SELECT
                         COUNT(*)
                     INTO authcount
                     FROM
                         sys_business_unit
                     WHERE
                             is_company = 0
                       AND id = deptid
                     START WITH
                             id = ownerid
                     CONNECT BY
                             PRIOR id = parent_id;

                     IF authcount <> 0 THEN
                         INSERT INTO tmp_auth_owner (
                             id,
                             auth_owner_id,
                             auth_owner_type
                         ) VALUES (
                                      spid,
                                      ownerid,
                                      oenertype
                                  );

                     END IF;

                 END IF;

                 IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                     INSERT INTO tmp_auth_owner (
                         id,
                         auth_owner_id,
                         auth_owner_type
                     ) VALUES (
                                  spid,
                                  ownerid,
                                  oenertype
                              );

                 END IF;

             END LOOP;

             CLOSE cursor_company;
         END;

         --获取有权限的公司及其父级：            

         DECLARE
             ownerid2 VARCHAR2(36);
             CURSOR cursor_auth IS
                 SELECT
                     auth_owner_id
                 FROM
                     tmp_auth_owner
                 WHERE
                         id = spid;

         BEGIN

             --打开游标
             OPEN cursor_auth;
             LOOP
                 FETCH cursor_auth INTO ownerid2;
                 EXIT WHEN cursor_auth%notfound;


                 --授权对象为公司：
                 --取授权公司的子级：
                 INSERT INTO tmp_proj_tree (
                     id,
                     org_id,
                     org_name,
                     org_type,
                     parent_id,
                     full_name,
                     is_end,
                     city_name,
                     company_id,
                     order_code
                 )
                 SELECT
                     spid,
                     org_id,
                     org_name,
                     org_type,
                     parent_id,
                     full_name,
                     is_end,
                     city_name,
                     company_id,
                     sn
                 FROM
                     V_SYS_PROJECT_STAGE_TREE
                 WHERE
                         company_id IN (
                         SELECT
                             id
                         FROM
                             sys_business_unit
                         WHERE
                                 is_company = 1
                         START WITH
                                 id IN (
                                 SELECT DISTINCT
                                     auth_scope_id
                                 FROM
                                     sys_data_auth
                                 WHERE
                                         auth_biz_code = bizcode
                                   AND is_disabled = 0
                                   AND auth_owner_id = ownerid2
                                   AND auth_scope_type IN (
                                                           '公司',
                                                           '集团'
                                     )
                                   AND nvl(auth_type, '项目') = '项目'
                             )
                         CONNECT BY
                                 PRIOR id = parent_id
                     );



                 --授权对应为项目：

                 INSERT INTO tmp_proj_tree (
                     id,
                     org_id,
                     org_name,
                     org_type,
                     parent_id,
                     full_name,
                     is_end,
                     city_name,
                     company_id,
                     order_code
                 )
                 SELECT
                     spid,
                     org_id,
                     org_name,
                     org_type,
                     parent_id,
                     full_name,
                     is_end,
                     city_name,
                     company_id,
                     sn
                 FROM
                     V_SYS_PROJECT_STAGE_TREE
                 WHERE
                         project_id IN (
                         SELECT DISTINCT
                             auth_scope_id
                         FROM
                             sys_data_auth
                         WHERE
                                 auth_biz_code = bizcode
                           AND is_disabled = 0
                           AND auth_owner_id = ownerid2
                           AND auth_scope_type = '项目'
                           AND nvl(auth_type, '项目') = '项目'
                     );

             END LOOP;

             CLOSE cursor_auth;
         END;

     END IF;

     OPEN data_auth_info FOR SELECT DISTINCT
                                 a.org_id         AS orgid,
                                 a.org_name       AS orgname,
                                 a.org_type       AS orgtype,
                                 a.parent_id      AS parentid,
                                 a.full_name      AS fullname,
                                 a.is_end         AS isend,
                                 a.city_name      AS cityname,
                                 a.company_id     AS companyid,
                                 b.company_type   AS companytype,
                                 a.order_code     AS ordercode
                             FROM
                                 tmp_proj_tree       a
                                     LEFT JOIN sys_business_unit   b ON a.org_id = b.id
                             ORDER BY
                                 a.order_code;

 END p_sys_get_proj_stage_tree;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_GET_PROJ_TREE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_GET_PROJ_TREE" (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    data_auth_info   OUT              SYS_REFCURSOR
) AS
--获取有权限的项目树
--作者：谷国斌
--日期：2019/12/14
    rulevalue   VARCHAR2(50);
    authcount   INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    spid        VARCHAR2(36);--使用临时表的批次号
BEGIN
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;

--获取隔离规则：

    SELECT
        isolation_rule_value
    INTO rulevalue
    FROM
        sys_data_auth_biz
    WHERE
        biz_obj_code = bizcode;

    IF rulevalue = '全集团' THEN
        INSERT INTO tmp_proj_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            full_name,
            is_end,
            city_name,
            company_id,
            order_code
        )
            SELECT
                spid,
                org_id,
                org_name,
                org_type,
                parent_id,
                full_name,
                is_end,
                city_name,
                company_id,
                sn
            FROM
                v_sys_project;

    ELSE 
--插入本公司的项目
        INSERT INTO tmp_proj_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            full_name,
            is_end,
            city_name,
            company_id,
            order_code
        )
            SELECT
                spid,
                org_id,
                org_name,
                org_type,
                parent_id,
                full_name,
                is_end,
                city_name,
                company_id,
                sn
            FROM
                v_sys_project
            WHERE
                company_id = companyid;

--插入数据授权的数据：

        DECLARE
            ownerid     VARCHAR2(36);
            oenertype   NVARCHAR2(50);
            CURSOR cursor_company IS
            SELECT DISTINCT
                auth_owner_id,
                auth_owner_type
            FROM
                sys_data_auth
            WHERE
                auth_biz_code = bizcode
                AND is_disabled = 0
                AND nvl(auth_type, '项目') = '项目';

        BEGIN   

            --打开游标
            OPEN cursor_company;
            LOOP
                FETCH cursor_company INTO
                    ownerid,
                    oenertype;
                EXIT WHEN cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                IF oenertype = '公司' OR oenertype = '集团' THEN
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                        AND id = companyid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF oenertype = '部门' THEN
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 0
                        AND id = deptid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                    INSERT INTO tmp_auth_owner (
                        id,
                        auth_owner_id,
                        auth_owner_type
                    ) VALUES (
                        spid,
                        ownerid,
                        oenertype
                    );

                END IF;

            END LOOP;

            CLOSE cursor_company;
        END;   

          --获取有权限的公司及其父级：            

        DECLARE
            ownerid2 VARCHAR2(36);
            CURSOR cursor_auth IS
            SELECT
                auth_owner_id
            FROM
                tmp_auth_owner
            WHERE
                id = spid;

        BEGIN   

                    --打开游标
            OPEN cursor_auth;
            LOOP
                FETCH cursor_auth INTO ownerid2;
                EXIT WHEN cursor_auth%notfound;


                            --授权对象为公司：
                            --取授权公司的子级：
                INSERT INTO tmp_proj_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    full_name,
                    is_end,
                    city_name,
                    company_id,
                    order_code
                )
                    SELECT
                        spid,
                        org_id,
                        org_name,
                        org_type,
                        parent_id,
                        full_name,
                        is_end,
                        city_name,
                        company_id,
                        sn
                    FROM
                        v_sys_project
                    WHERE
                        company_id IN (
                            SELECT
                                id
                            FROM
                                sys_business_unit
                            WHERE
                                is_company = 1
                            START WITH
                                id IN (
                                    SELECT DISTINCT
                                        auth_scope_id
                                    FROM
                                        sys_data_auth
                                    WHERE
                                        auth_biz_code = bizcode
                                        AND is_disabled = 0
                                        AND auth_owner_id = ownerid2
                                        AND auth_scope_type IN (
                                            '公司',
                                            '集团'
                                        )
                                        AND nvl(auth_type, '项目') = '项目'
                                )
                            CONNECT BY
                                PRIOR id = parent_id
                        );



                               --授权对应为项目：

                INSERT INTO tmp_proj_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    full_name,
                    is_end,
                    city_name,
                    company_id,
                    order_code
                )
                    SELECT
                        spid,
                        org_id,
                        org_name,
                        org_type,
                        parent_id,
                        full_name,
                        is_end,
                        city_name,
                        company_id,
                        sn
                    FROM
                        v_sys_project
                    WHERE
                        project_id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type = '项目'
                                AND nvl(auth_type, '项目') = '项目'
                        );

            END LOOP;

            CLOSE cursor_auth;
        END;

    END IF;

    OPEN data_auth_info FOR SELECT DISTINCT
                               a.org_id         AS orgid,
                               a.org_name       AS orgname,
                               a.org_type       AS orgtype,
                               a.parent_id      AS parentid,
                               a.full_name      AS fullname,
                               a.is_end         AS isend,
                               a.city_name      AS cityname,
                               a.company_id     AS companyid,
                               b.company_type   AS companytype,
                               a.order_code     AS ordercode
                           FROM
                               tmp_proj_tree       a
                               LEFT JOIN sys_business_unit   b ON a.org_id = b.id
                           ORDER BY
                               a.order_code;

END p_sys_get_proj_tree;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_GET_PROJ_TREE_SPID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_GET_PROJ_TREE_SPID" (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    auth_spid           OUT           VARCHAR2
) AS
--获取有权限的项目树
--作者：谷国斌
--日期：2019/12/14
    rulevalue   VARCHAR2(50);
    authcount   INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    spid        VARCHAR2(36);--使用临时表的批次号
BEGIN
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;

--获取隔离规则：

    SELECT
        isolation_rule_value
    INTO rulevalue
    FROM
        sys_data_auth_biz
    WHERE
        biz_obj_code = bizcode;

    IF rulevalue = '全集团' THEN
        INSERT INTO tmp_proj_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            full_name,
            is_end,
            city_name,
            company_id,
            order_code
        )
            SELECT
                spid,
                org_id,
                org_name,
                org_type,
                parent_id,
                full_name,
                is_end,
                city_name,
                company_id,
                sn
            FROM
                v_sys_project;

    ELSE 
--插入本公司的项目
        INSERT INTO tmp_proj_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            full_name,
            is_end,
            city_name,
            company_id,
            order_code
        )
            SELECT
                spid,
                org_id,
                org_name,
                org_type,
                parent_id,
                full_name,
                is_end,
                city_name,
                company_id,
                sn
            FROM
                v_sys_project
            WHERE
                company_id = companyid;

--插入数据授权的数据：

        DECLARE
            ownerid     VARCHAR2(36);
            oenertype   NVARCHAR2(50);
            CURSOR cursor_company IS
            SELECT DISTINCT
                auth_owner_id,
                auth_owner_type
            FROM
                sys_data_auth
            WHERE
                auth_biz_code = bizcode
                AND is_disabled = 0
                AND nvl(auth_type, '项目') = '项目';

        BEGIN   

            --打开游标
            OPEN cursor_company;
            LOOP
                FETCH cursor_company INTO
                    ownerid,
                    oenertype;
                EXIT WHEN cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                IF oenertype = '公司' OR oenertype = '集团' THEN
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                        AND id = companyid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF oenertype = '部门' THEN
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 0
                        AND id = deptid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                    INSERT INTO tmp_auth_owner (
                        id,
                        auth_owner_id,
                        auth_owner_type
                    ) VALUES (
                        spid,
                        ownerid,
                        oenertype
                    );

                END IF;

            END LOOP;

            CLOSE cursor_company;
        END;   

          --获取有权限的公司及其父级：            

        DECLARE
            ownerid2 VARCHAR2(36);
            CURSOR cursor_auth IS
            SELECT
                auth_owner_id
            FROM
                tmp_auth_owner
            WHERE
                id = spid;

        BEGIN   

                    --打开游标
            OPEN cursor_auth;
            LOOP
                FETCH cursor_auth INTO ownerid2;
                EXIT WHEN cursor_auth%notfound;


                            --授权对象为公司：
                            --取授权公司的子级：
                INSERT INTO tmp_proj_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    full_name,
                    is_end,
                    city_name,
                    company_id,
                    order_code
                )
                    SELECT
                        spid,
                        org_id,
                        org_name,
                        org_type,
                        parent_id,
                        full_name,
                        is_end,
                        city_name,
                        company_id,
                        sn
                    FROM
                        v_sys_project
                    WHERE
                        company_id IN (
                            SELECT
                                id
                            FROM
                                sys_business_unit
                            WHERE
                                is_company = 1
                            START WITH
                                id IN (
                                    SELECT DISTINCT
                                        auth_scope_id
                                    FROM
                                        sys_data_auth
                                    WHERE
                                        auth_biz_code = bizcode
                                        AND is_disabled = 0
                                        AND auth_owner_id = ownerid2
                                        AND auth_scope_type IN (
                                            '公司',
                                            '集团'
                                        )
                                        AND nvl(auth_type, '项目') = '项目'
                                )
                            CONNECT BY
                                PRIOR id = parent_id
                        );



                               --授权对应为项目：

                INSERT INTO tmp_proj_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    full_name,
                    is_end,
                    city_name,
                    company_id,
                    order_code
                )
                    SELECT
                        spid,
                        org_id,
                        org_name,
                        org_type,
                        parent_id,
                        full_name,
                        is_end,
                        city_name,
                        company_id,
                        sn
                    FROM
                        v_sys_project
                    WHERE
                        project_id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type = '项目'
                                AND nvl(auth_type, '项目') = '项目'
                        );

            END LOOP;
            CLOSE cursor_auth;
        END;
    END IF;
--    OPEN data_auth_info FOR SELECT DISTINCT
--                               a.org_id         AS orgid,
--                               a.org_name       AS orgname,
--                               a.org_type       AS orgtype,
--                               a.parent_id      AS parentid,
--                               a.full_name      AS fullname,
--                               a.is_end         AS isend,
--                               a.city_name      AS cityname,
--                               a.company_id     AS companyid,
--                               b.company_type   AS companytype,
--                               a.order_code     AS ordercode
--                           FROM
--                               tmp_proj_tree       a
--                               LEFT JOIN sys_business_unit   b ON a.org_id = b.id
--                           ORDER BY
--                               a.order_code;
        auth_spid:=spid;
END p_sys_get_proj_tree_spid;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_MSG_BY_TYPE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_MSG_BY_TYPE" ( isMobile in int,msgType IN VARCHAR2,systemId IN VARCHAR2,userName IN VARCHAR2,wherestr  IN VARCHAR2,datalist OUT SYS_REFCURSOR,total out int )
as
rowcountBySystemId  int;
whereSql VARCHAR2(200);
orderSql VARCHAR2(200);
systemWhereSql VARCHAR2(2000);
appid VARCHAR2(1000);
selectSql VARCHAR2(4000);
likeWhereSql  VARCHAR2(1000);
v_sql VARCHAR2(1000);
systemIds VARCHAR2(1000);
BEGIN
likeWhereSql:=' ';
/*判断是否传入筛选语句，传入格式为%条件%*/
if wherestr is not null then
likeWhereSql:=' and ( task_name like '''||wherestr||''' or  type_name like '''||wherestr||''')';
end if;
/*判断是否传入系统id条件，加入系统筛选*/
if systemId is not null then
   if instr(systemId,',',1,1) !=0 then
         systemIds:=''''||replace(systemId, ',', ''',''')||'''';
         execute immediate ' select count(1) from  SYS_APPLICATION  s where s.id in ('||systemIds||')' INTO  rowcountBySystemId;
          if rowcountBySystemId<>0 THEN
             execute immediate '  select  WMSYS.WM_CONCAT(APP_ID)  from  SYS_APPLICATION  s  where s.id in ('||systemIds||')' INTO  appid;
             appid:=''''||replace(appid, ',', ''',''')||'''';
             systemWhereSql:=' and SOURCE_APP_ID in ('||appid||')';
          end if;
    else
        select count(1) into rowcountBySystemId  from  SYS_APPLICATION  s
        where s.id=systemId;
        if rowcountBySystemId<>0 THEN
        select APP_ID into appid  from  SYS_APPLICATION  s
        where s.id=systemId;
        systemWhereSql:=' and SOURCE_APP_ID= '''||appid||'''';
        end if;
   end if;
end if;
/*根据传入类型不同展示不同的时间列*/
if msgType='todo' then
selectSql:=' SELECT
    {url},
   created as startTime,
    task_name as processInstName,
    CREATOR_NAME as partiName,
    BIZ_MSG_CATEGORY  as activityInstName,
    type_name as processChName,
    CREATOR_NAME as sender
FROM
    sys_message_center where owner_name=  '''||userName||'''';
whereSql:=' and MSG_TYPE=0 and TASK_STATE=0';
ELSIF  msgType='haveTodo' then
selectSql:=' SELECT
    {url},
    complete_time as startTime,
    task_name as processInstName,
    CREATOR_NAME as partiName,
    BIZ_MSG_CATEGORY  as activityInstName,
    type_name as processChName,
    CREATOR_NAME as sender
FROM
    sys_message_center where owner_name=  '''||userName||'''';
whereSql:=' and MSG_TYPE=0 and TASK_STATE=10';
orderSql:=' order by EXPIRE_TIME desc';
ELSIF  msgType='unRead' then
selectSql:=' SELECT
    {url},
    created as startTime,
    task_name as processInstName,
    cuser.user_name as partiName,
    BIZ_MSG_CATEGORY  as activityInstName,
    type_name as processChName,
    cuser.user_name as sender
FROM
    sys_message_center 
    left join sys_user cuser 
    on sys_message_center.CREATOR_NAME=cuser.user_code 
    where owner_name=  '''||userName||'''';
whereSql:=' and MSG_TYPE=10 and TASK_STATE=0';
ELSIF  msgType='haveRead' then
selectSql:=' SELECT
    {url},
    complete_time as startTime,
    task_name as processInstName,
    cuser.user_name as partiName,
    BIZ_MSG_CATEGORY  as activityInstName,
    type_name as processChName,
    cuser.user_name as sender
FROM
    sys_message_center 
    left join sys_user cuser 
    on sys_message_center.CREATOR_NAME=cuser.user_code 
    where owner_name=  '''||userName||'''';
whereSql:=' and MSG_TYPE=10 and TASK_STATE=10';
else
selectSql:=' SELECT
    {url},
    complete_time as startTime,
    task_name as processInstName,
    cuser.user_name as partiName,
    BIZ_MSG_CATEGORY  as activityInstName,
    type_name as processChName,
    cuser.user_name as sender
FROM
    sys_message_center 
    left join sys_user cuser 
    on sys_message_center.CREATOR_NAME=cuser.user_code 
    where owner_name=  '''||userName||'''';
whereSql:=' and MSG_TYPE=20';
end if;
dbms_output.put_line(whereSql);
/*拼接sql*/
selectSql:=selectSql||whereSql||systemWhereSql||likeWhereSql;
/*根据传入是否为移动端来打开不同的地址*/
if isMobile=1 then
selectSql:=replace(selectSql,'{url}','mobile_url as url');
else
selectSql:=replace(selectSql,'{url}','pc_url as url');
end if;
dbms_output.put_line(selectSql);
  v_sql:= 'select count(*) FROM (' || selectSql || ')';
  EXECUTE IMMEDIATE v_sql INTO total;
OPEN datalist FOR selectSql;
EXCEPTION
WHEN OTHERS THEN
 CLOSE datalist;
end p_sys_msg_by_type;
--==============================================================数据动态化==================================================================

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_MSG_CONFIG_HAVETODO
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_MSG_CONFIG_HAVETODO" (
    havetodopcaddress   IN                  VARCHAR2,         --消息打开pc端地址
    projectid           IN                  VARCHAR2,                    --项目实例ID
    msgcode             IN                  VARCHAR2,                     --消息的code
    messagetype         OUT                 VARCHAR2,       --0:门户终端消息都推送，1：只推送门户，2：只推送短信或微信
    info                OUT                 SYS_REFCURSOR     --消息集合
) IS
    rowcount         NUMBER;
    config_code      VARCHAR2(100);
    havetodopcurl    VARCHAR2(4000);
    systemid         VARCHAR2(36);
    systemappid      VARCHAR(36);
    bizmsgcategory   VARCHAR2(50);
    project_id       VARCHAR2(50);
BEGIN
    EXECUTE IMMEDIATE ' alter session set nls_date_format = ''yyyy-mm-dd hh24:mi:ss''';
    IF projectid IS NOT NULL AND instr(projectid, ';', 1, 1) <> 0 THEN
        project_id := splitstr(projectid, 1, ';');
    ELSE
        project_id := projectid;
    END IF;

    EXECUTE IMMEDIATE ' alter session set nls_date_format = ''yyyy-mm-dd hh24:mi:ss''';
    messagetype := 1;
    bizmsgcategory := '催办消息(数据动态化)';
    config_code := replace(msgcode, 'HaveToDo', '');
    havetodopcurl := replace(havetodopcaddress, '||', '&');
    SELECT
        COUNT(1)
    INTO rowcount
    FROM
        sys_message_config
    WHERE
        code = msgcode;

    IF rowcount = 1 THEN
        SELECT
            f.system_id,
            s.app_id
        INTO
            systemid,
            systemappid
        FROM
            sys_message_config   f
            LEFT JOIN sys_application      s ON f.system_id = s.id
        WHERE
            f.code = msgcode;
        OPEN info FOR SELECT
                         tab.creator_name       AS senderaccount,                        --发送人
                         tab.owner_name         AS recipientaccount,    --接收人
                         systemid               AS systemid,--系统id
                         systemappid            AS appid,--应用id
                         tab.task_id            AS bizkey,--业务id--门户网站的taskId
                         tab.biz_msg_category   AS bizmsgcategory,--消息所属类别
  -------------------------------------------------------------【短信微信必须】基础信息 ------------------------------------------------------------
                         '' AS msgchannel, --使用消息渠道 多个，逗号分隔   tjWeChat：铁建微信,tjSMS：铁建短信
                         '' AS smstemplateid,--模板 ID，在腾讯云短信审核通过的模板 ID  --{1}您好，{2}对您负责的任务“{3}”进行了催办，请及时到门户网站查看待办并在《计划管理系统》中反馈任务进度{4}。
                         '[]' AS smsparams,--接收消息参数，--实例如：[  流程  ,  提醒0522  ] ---发送时会按顺序替换模板的位置=》
                         '' AS mobile,--短信接收人电话
                         '' AS wechattemplateid,--模板 ID，在腾讯云短信审核通过的模板 ID
                         '[]' AS wechatparams,--接收消息参数，--实例如：[  流程  ,  提醒0522  ] ---发送时会按顺序替换模板的位置=》
                         '' AS wechatjumplinkurl,--微信打开地址，程序调用发消息前需要编码
                         '' AS title,--消息标题
                         '' AS bizsourcecategory,
  -------------------------------------------------------------【门户消息必须】基础信息 ------------------------------------------------------------
                         1 AS portalmsgtype,
                         havetodopcurl          AS url,--pc端的url地址
                         '' AS mobileurl,--移动端的url地址
                         tab.task_name          AS taskname, --任务名称，等于3、插入待阅/4、插入已阅informationname;等于插入关注的attentionname
                         tab.type_name          AS typename,--任务类型
                         projectid AS remark,
                         TO_CHAR(SYSDATE, 'yyyy-MM-dd HH24:mi:ss') expiretime,--expiretime	否	String	过期时间，格式yyyy-MM-dd HH:mm:ss-----过期时间，除关注都有
                         1 priority  --priority	否	Integer	优先级，除关注都有 
                     FROM
                         (
                             SELECT
                                 creator_name,
                                 owner_name,
                                 task_id,
                                 task_name,
                                 type_name,
                                 biz_msg_category
                             FROM
                                 sys_message_center
                             WHERE
                                 task_state = 0
                                 AND msg_type = 0
                                 AND ( remark = config_code
                                                || 'ToDo_'
                                                || projectid
                                       OR remark = config_code
                                                   || 'ToDo_'
                                                   || project_id )
                         ) tab;

    END IF;

END p_sys_msg_config_havetodo;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_MSG_CONFIG_INFO
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_MSG_CONFIG_INFO" (
    toDoPCAddress    IN     varchar2,     -- 消息打开pc端地址
    toReadPCAddress in varchar2,         --消息打开mobile端地址
    toDoTitle  in varchar2,                     --消息标题
    toReadTitle  in varchar2,                  --消息标题
    projectID  in varchar2,                    --项目实例ID
    msgCode in varchar2,                     --消息的code
    creater in varchar2,                        --发送人usercode
    messageType out      varchar2,       --0:门户终端消息都推送，1：只推送门户，2：只推送短信或微信
    info     OUT      SYS_REFCURSOR     --消息集合
) IS
uuid  varchar2(36) ;
rowcount number;
begin
uuid:=get_uuid();
messageType:=1;
p_sys_msg_config_info_help(
    TODOPCADDRESS => TODOPCADDRESS,
    TOREADPCADDRESS => TOREADPCADDRESS,
    TODOTITLE => TODOTITLE,
    TOREADTITLE => TOREADTITLE,
    PROJECTID => PROJECTID,
    MSGCODE => MSGCODE,
    CREATER => CREATER,
    uuid => uuid
);
 select count(1) into rowcount from TEMP_SYS_MESSAGE_SEND_LIST WHERE ID=uuid;
    if rowcount <> 0 then
   open info for select 
        senderAccount "senderAccount",
        recipientAccount  "recipientAccount",
        systemId  "systemId",
        appid "appid",
        bizKey "bizKey",
        bizMsgCategory  "bizMsgCategory",
        msgChannel "msgChannel",
        smsTemplateid "smsTemplateid",
        smsParams "smsParams",
        mobile "mobile",
        wechatTemplateid "wechatTemplateid",
        wechatParams "wechatParams",
        wechatJumplinkUrl "wechatJumplinkUrl",
        title "title",
        bizSourceCategory "bizSourceCategory",
        portalMsgType "portalMsgType",
        url "url",
        mobileUrl "mobileUrl",
        taskname "taskname",
        typename "typename",
        remark "remark",
        expiretime "expiretime",
        priority  "priority"
   from TEMP_SYS_MESSAGE_SEND_LIST where id=uuid;
end if;
exception
when others then
 dbms_output.put_line(sqlcode||'--'||sqlerrm);--sqlcode表示异常代码，sqlerrm表示异常信息
END p_sys_msg_config_info;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_MSG_CONFIG_INFO_HELP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_MSG_CONFIG_INFO_HELP" (
    todopcaddress     IN                VARCHAR2,     -- 消息打开pc端地址
    toreadpcaddress   IN                VARCHAR2,         --消息打开mobile端地址
    todotitle         IN                VARCHAR2,                     --消息标题
    toreadtitle       IN                VARCHAR2,                  --消息标题
    projectid         IN                VARCHAR2,                    --项目实例ID
    msgcode           IN                VARCHAR2,                     --消息的code
    creater           IN                VARCHAR2,                        --发送人usercode
    uuid              IN                VARCHAR2
) IS

    todorow                    NUMBER;
    toreadrow                  NUMBER;
    rowcount                   NUMBER := 0;
    readrowcount            number:=0;
    todo_systemid              VARCHAR2(100);
    todo_systemappid           VARCHAR2(100);
    toread_systemid            VARCHAR2(100);
    toread_systemappid         VARCHAR2(100);
    bizmsgcategory             VARCHAR2(100);
    todopcurl                  VARCHAR2(4000);
    toreadpcurl                VARCHAR2(4000);
    todomsgid                  VARCHAR2(36);
    toreadmsgid                VARCHAR2(36);
    config_code                VARCHAR(100);
    todonoticegroups           CLOB;
    todonoticeprojectroles     CLOB;
    todonoticeorgids           CLOB;
    todonoticepersons          CLOB;
    toreadnoticegroups         CLOB;
    toreadnoticeprojectroles   CLOB;
    toreadnoticeorgids         CLOB;
    toreadnoticepersons        CLOB;
    todopersonuuid             VARCHAR2(36);
    toreadpersonuuid           VARCHAR2(36);
    typename                   VARCHAR2(50);
    project_id                 VARCHAR2(50);
    periodid                   VARCHAR2(50);
    project_name               VARCHAR2(100);
    period_name                VARCHAR2(1000);
    todo_title                 VARCHAR2(1000);
    toread_title               VARCHAR2(1000);
    domain                     VARCHAR2(1000);
BEGIN
    EXECUTE IMMEDIATE ' alter session set nls_date_format = ''yyyy-mm-dd hh24:mi:ss''';
    IF projectid IS NOT NULL AND instr(projectid, ';', 1, 1) <> 0 THEN
        project_id := splitstr(projectid, 1, ';');
        periodid := splitstr(projectid, 2, ';');
    ELSE
        project_id := projectid;
    END IF;

    typename := '计划运营';
    bizmsgcategory := '催办消息(数据动态化)';
    config_code := replace(msgcode, 'ToDo', '');
    todopcurl := replace(todopcaddress, '||', '&');
    toreadpcurl := replace(toreadpcaddress, '||', '&');
    todo_title := todotitle;
    toread_title := toreadtitle;
 
 
 
   --判断是否已经推送过该消息，如果推送过则不再进行消息推送，【如果不需要验证请注释掉查询语句】
    SELECT
        COUNT(1)
    INTO rowcount
    FROM
        sys_message_center
    WHERE
        remark = config_code
                 || 'ToDo_'
                 || projectid
        OR remark = config_code
                    || 'ToDo_'
                    || project_id;
    SELECT
        COUNT(1)
    INTO readrowcount
    FROM
        sys_message_center
    WHERE
        remark = config_code
                 || 'ToRead_'||projectid
        and 
        BIZ_MSG_CATEGORY='催办消息(数据动态化)';
        
    IF rowcount = 0 and readrowcount=0 THEN   
 
 
 
   --处理关键字 start
        IF instr(toreadpcurl, '{projectId}', 1, 1) <> 0 OR instr(todopcurl, '{projectId}', 1, 1) <> 0 THEN
            SELECT
                project_name
            INTO project_name
            FROM
                mdm_project
            WHERE
                project_original_id = project_id
                AND ROWNUM = 1;

            toreadpcurl := replace(toreadpcurl, '{projectName}', project_name);
            toreadpcurl := replace(toreadpcurl, '{projectId}', project_id);
            todopcurl := replace(todopcurl, '{projectName}', project_name);
            todopcurl := replace(todopcurl, '{projectId}', project_id);
            todo_title := replace(todo_title, '{projectName}', project_name);
            todo_title := replace(todo_title, '{projectId}', project_id);
            toread_title := replace(toread_title, '{projectName}', project_name);
            toread_title := replace(toread_title, '{projectId}', project_id);
            IF periodid IS NOT NULL AND ( instr(toreadpcurl, '{projectId}', 1, 1) <> 0 OR instr(todopcurl, '{periodId}', 1, 1) <>
            0 ) THEN
                SELECT
                    period_name
                INTO period_name
                FROM
                    mdm_period
                WHERE
                    period_original_id = periodid
                    AND ROWNUM = 1;

                toreadpcurl := replace(toreadpcurl, '{periodName}', period_name);
                toreadpcurl := replace(toreadpcurl, '{periodId}', periodid);
                todopcurl := replace(todopcurl, '{periodName}', period_name);
                todopcurl := replace(todopcurl, '{periodId}', periodid);
                todo_title := replace(todo_title, '{periodName}', period_name);
                todo_title := replace(todo_title, '{periodId}', periodid);
                toread_title := replace(toread_title, '{periodName}', period_name);
                toread_title := replace(toread_title, '{periodId}', periodid);
            END IF;

        END IF;
 
 
 
  --处理关键字 end

        SELECT
            COUNT(1)
        INTO todorow
        FROM
            sys_message_config
        WHERE
            code = config_code || 'ToDo';

        IF todorow = 1 THEN
            SELECT
                f.system_id,
                s.app_id,
                f.id,
                CASE
                    WHEN f.system_id = '534e2b6a0d5bb4fec7d55f551f8930ab' THEN
                        '项目主数据'
                    WHEN f.system_id = '25094143a887a05c3f0e0f1cd5ac938d' THEN
                        '动态货值管理'
                    ELSE
                        '计划运营'
                END typename
            INTO
                todo_systemid,
                todo_systemappid,
                todomsgid,
                typename
            FROM
                sys_message_config   f
                LEFT JOIN sys_application      s ON f.system_id = s.id
            WHERE
                f.code = config_code || 'ToDo';
 
 
 
     --处理代办发送人信息 start

            IF instr(todopcurl, 'http://', 1, 1) = 0 AND instr(todopcurl, 'https://', 1, 1) = 0 THEN
                SELECT
                    application_url
                INTO domain
                FROM
                    sys_application_terminal
                WHERE
                    application_id = todo_systemid
                    AND application_terminal_code = 'PC'
                    AND ROWNUM = 1;

                todopcurl := domain || todopcurl;
            END IF;

            SELECT
                COUNT(1)
            INTO rowcount
            FROM
                sys_message_config_receiver
            WHERE
                message_config_id = todomsgid
                AND type = 40;

            IF rowcount <> 0 THEN
                SELECT
                    receiver_value
                INTO todonoticegroups
                FROM
                    sys_message_config_receiver
                WHERE
                    message_config_id = todomsgid
                    AND type = 40;

            END IF;

            SELECT
                COUNT(1)
            INTO rowcount
            FROM
                sys_message_config_receiver
            WHERE
                message_config_id = todomsgid
                AND type = 30;

            IF rowcount <> 0 THEN
                SELECT
                    receiver_value
                INTO todonoticeprojectroles
                FROM
                    sys_message_config_receiver
                WHERE
                    message_config_id = todomsgid
                    AND type = 30;

            END IF;

            SELECT
                COUNT(1)
            INTO rowcount
            FROM
                sys_message_config_receiver
            WHERE
                message_config_id = todomsgid
                AND type = 110;

            IF rowcount <> 0 THEN
                SELECT
                    receiver_value
                INTO todonoticeorgids
                FROM
                    sys_message_config_receiver
                WHERE
                    message_config_id = todomsgid
                    AND type = 110;

            END IF;

            SELECT
                COUNT(1)
            INTO rowcount
            FROM
                sys_message_config_receiver
            WHERE
                message_config_id = todomsgid
                AND type = 130;

            IF rowcount <> 0 THEN
                SELECT
                    receiver_value
                INTO todonoticepersons
                FROM
                    sys_message_config_receiver
                WHERE
                    message_config_id = todomsgid
                    AND type = 130;

            END IF;
            p_sys_person_list_analysis(noticepersons => todonoticepersons, noticegroups => todonoticegroups, 
            noticeprojectroles => todonoticeprojectroles, noticeorgids => todonoticeorgids, projectid => project_id, uuid => todopersonuuid);

            SELECT
                COUNT(1)
            INTO rowcount
            FROM
                person_role_analysis_table
            WHERE
                detail = todopersonuuid;
            dbms_output.put_line('todo:' || rowcount);
    --处理代办发送人信息 end;
        END IF;

        SELECT
            COUNT(1)
        INTO toreadrow
        FROM
            sys_message_config
        WHERE
            code = config_code || 'ToRead';

        IF toreadrow = 1 THEN
            SELECT
                f.system_id,
                s.app_id,
                f.id
            INTO
                toread_systemid,
                toread_systemappid,
                toreadmsgid
            FROM
                sys_message_config   f
                LEFT JOIN sys_application      s ON f.system_id = s.id
            WHERE
                f.code = config_code || 'ToRead';

            IF instr(toreadpcurl, 'http://', 1, 1) = 0 THEN
                SELECT
                    application_url
                INTO domain
                FROM
                    sys_application_terminal
                WHERE
                    application_id = toread_systemid
                    AND application_terminal_code = 'PC'
                    AND ROWNUM = 1;

                toreadpcurl := domain || toreadpcurl;
            END IF;
 
 
 
    --处理待阅发送人信息 start

            SELECT
                COUNT(1)
            INTO rowcount
            FROM
                sys_message_config_receiver
            WHERE
                message_config_id = toreadmsgid
                AND type = 40;

            IF rowcount <> 0 THEN
                SELECT
                    receiver_value
                INTO toreadnoticegroups
                FROM
                    sys_message_config_receiver
                WHERE
                    message_config_id = toreadmsgid
                    AND type = 40;

            END IF;

            SELECT
                COUNT(1)
            INTO rowcount
            FROM
                sys_message_config_receiver
            WHERE
                message_config_id = toreadmsgid
                AND type = 30;

            IF rowcount <> 0 THEN
                SELECT
                    receiver_value
                INTO toreadnoticeprojectroles
                FROM
                    sys_message_config_receiver
                WHERE
                    message_config_id = toreadmsgid
                    AND type = 30;

            END IF;

            SELECT
                COUNT(1)
            INTO rowcount
            FROM
                sys_message_config_receiver
            WHERE
                message_config_id = toreadmsgid
                AND type = 110;

            IF rowcount <> 0 THEN
                SELECT
                    receiver_value
                INTO toreadnoticeorgids
                FROM
                    sys_message_config_receiver
                WHERE
                    message_config_id = toreadmsgid
                    AND type = 110;

            END IF;

            SELECT
                COUNT(1)
            INTO rowcount
            FROM
                sys_message_config_receiver
            WHERE
                message_config_id = toreadmsgid
                AND type = 130;

            IF rowcount <> 0 THEN
                SELECT
                    receiver_value
                INTO toreadnoticepersons
                FROM
                    sys_message_config_receiver
                WHERE
                    message_config_id = toreadmsgid
                    AND type = 130;
            END IF;
            p_sys_person_list_analysis(noticepersons => toreadnoticepersons, noticegroups => toreadnoticegroups,
            noticeprojectroles=> toreadnoticeprojectroles, noticeorgids => toreadnoticeorgids, projectid => project_id, uuid => toreadpersonuuid);
            SELECT
                COUNT(1)
            INTO rowcount
            FROM
                person_role_analysis_table
            WHERE
                detail = toreadpersonuuid;
            dbms_output.put_line('toread:' || rowcount);
     --处理待阅发送人信息 end
        END IF;
        SELECT
            COUNT(1)
        INTO rowcount
        FROM
            person_role_analysis_table;
        
        IF toreadrow <> 0 AND todorow <> 0 AND rowcount <> 0 THEN
            dbms_output.put_line('total:' || rowcount);
            INSERT INTO temp_sys_message_send_list
                SELECT
                    uuid               AS id,
                    creater            AS senderaccount,                        --发送人
                    tab.code           AS recipientaccount,    --接收人
                    todo_systemid      AS systemid,--系统id
                    todo_systemappid   AS appid,--应用id
                    get_uuid() AS bizkey,--业务id--门户网站的taskId
                    bizmsgcategory     AS bizmsgcategory,--消息所属类别
  -------------------------------------------------------------【短信微信必须】基础信息 ------------------------------------------------------------
                    '' AS msgchannel, --使用消息渠道 多个，逗号分隔   tjWeChat：铁建微信,tjSMS：铁建短信
                    '' AS smstemplateid,--模板 ID，在腾讯云短信审核通过的模板 ID  --{1}您好，{2}对您负责的任务“{3}”进行了催办，请及时到门户网站查看待办并在《计划管理系统》中反馈任务进度{4}。
                    '[]' AS smsparams,--接收消息参数，--实例如：[  流程  ,  提醒0522  ] ---发送时会按顺序替换模板的位置=》
                    '' AS mobile,--短信接收人电话
                    '' AS wechattemplateid,--模板 ID，在腾讯云短信审核通过的模板 ID
                    '[]' AS wechatparams,--接收消息参数，--实例如：[  流程  ,  提醒0522  ] ---发送时会按顺序替换模板的位置=》
                    '' AS wechatjumplinkurl,--微信打开地址，程序调用发消息前需要编码
                    '' AS title,--消息标题
                    '' AS bizsourcecategory,
  -------------------------------------------------------------【门户消息必须】基础信息 ------------------------------------------------------------
                    0 AS portalmsgtype,
                    todopcurl          AS url,--pc端的url地址
                    '' AS mobileurl,--移动端的url地址
                    todo_title         AS taskname, --任务名称，等于3、插入待阅/4、插入已阅informationname;等于插入关注的attentionname
                    typename           AS typename,--任务类型
                    config_code
                    || 'ToDo_'
                    || projectid AS remark,
                    TO_CHAR(SYSDATE, 'yyyy-MM-dd HH24:mi:ss') expiretime,--expiretime	否	String	过期时间，格式yyyy-MM-dd HH:mm:ss-----过期时间，除关注都有
                    1 priority  --priority	否	Integer	优先级，除关注都有 
                FROM 
      --查询发送人是需要进行按用户user_code进行分组
                    (
                        SELECT
                            code
                        FROM
                            person_role_analysis_table
                        WHERE
                            detail = todopersonuuid
                        GROUP BY
                            code
                    ) tab
                UNION
                SELECT
                    uuid                 AS id,
                    creater              AS senderaccount,                        --发送人
                    tab.code             AS recipientaccount,    --接收人
                    toread_systemid      AS systemid,--系统id
                    toread_systemappid   AS appid,--应用id
                    get_uuid() AS bizkey,--业务id--门户网站的taskId
                    bizmsgcategory       AS bizmsgcategory,--消息所属类别
  -------------------------------------------------------------【短信微信必须】基础信息 ------------------------------------------------------------
                    '' AS msgchannel, --使用消息渠道 多个，逗号分隔   tjWeChat：铁建微信,tjSMS：铁建短信
                    '' AS smstemplateid,--模板 ID，在腾讯云短信审核通过的模板 ID  --{1}您好，{2}对您负责的任务“{3}”进行了催办，请及时到门户网站查看待办并在《计划管理系统》中反馈任务进度{4}。
                    '[]' AS smsparams,--接收消息参数，--实例如：[  流程  ,  提醒0522  ] ---发送时会按顺序替换模板的位置=》
                    '' AS mobile,--短信接收人电话
                    '' AS wechattemplateid,--模板 ID，在腾讯云短信审核通过的模板 ID
                    '[]' AS wechatparams,--接收消息参数，--实例如：[  流程  ,  提醒0522  ] ---发送时会按顺序替换模板的位置=》
                    '' AS wechatjumplinkurl,--微信打开地址，程序调用发消息前需要编码
                    '' AS title,--消息标题
                    '' AS bizsourcecategory,
  -------------------------------------------------------------【门户消息必须】基础信息 ------------------------------------------------------------
                    10 AS portalmsgtype,
                    toreadpcurl          AS url,--pc端的url地址
                    '' AS mobileurl,--移动端的url地址
                    toread_title         AS taskname, --任务名称，等于3、插入待阅/4、插入已阅informationname;等于插入关注的attentionname
                    typename             AS typename,--任务类型
                     config_code
                    || 'ToRead_'
                    || projectid AS remark,
                    TO_CHAR(SYSDATE, 'yyyy-MM-dd HH24:mi:ss') expiretime,--expiretime	否	String	过期时间，格式yyyy-MM-dd HH:mm:ss-----过期时间，除关注都有
                    1 priority  --priority	否	Integer	优先级，除关注都有 
                FROM 
     --查询发送人是需要进行按用户user_code进行分组
                    (
                        SELECT
                            code
                        FROM
                            person_role_analysis_table
                        WHERE
                            detail = toreadpersonuuid
                        GROUP BY
                            code
                    ) tab;
        END IF;
    END IF;
END p_sys_msg_config_info_help;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_MSG_CONFIG_LIST_BY_CODE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_MSG_CONFIG_LIST_BY_CODE" (
  msgCode in varchar2,
  messageType out      varchar2,       --0:门户终端消息都推送，1：只推送门户，2：只推送短信或微信
  info     OUT      SYS_REFCURSOR     --消息集合
) IS
rowcount number;
betweenDays number;
toDoPCAddress varchar2(4000);
toReadPCAddress varchar2(4000);
toDoTitle varchar2(1000);
toReadTitle  varchar2(1000);
sql_str clob;
INFO_SQL clob;
CREATER varchar2(50):='yuzheng1';
uuid varchar2(36):='';
begin 
sql_str:='';
betweenDays:=0;
messageType:=1;
uuid:=GET_UUID();
select count(1) into rowcount  from SYS_MESSAGE_CONFIG where CODE=msgCode;
if rowcount <>0 then
        select case when DAYS_BETWEEN is null then 0 else DAYS_BETWEEN end as DAYS_BETWEEN,TITLE,LINK_ADDRESS into betweenDays,toDoTitle,toDoPCAddress from SYS_MESSAGE_CONFIG where CODE=msgCode and rownum=1;
        select TITLE,LINK_ADDRESS into toReadTitle,toReadPCAddress from SYS_MESSAGE_CONFIG where CODE=replace(msgCode,'ToDo','')||'ToRead' and rownum=1;
        TODOTITLE:=replace(TODOTITLE,'{daysBetween}',betweenDays);
        TOREADTITLE:=replace(TOREADTITLE,'{daysBetween}',betweenDays);
        --分期维护待办
        if msgCode='staInfoToDo' then
                for item in ( select project.project_Name,project.PROJECT_ORIGINAL_ID from  
               (select * from mdm_project project where project.id=project.PROJECT_ORIGINAL_ID and project.APPROVAL_STATUS='已审核')  project 
               left join (select count(1) APPROVAL_COUNT,PROJECT_ORIGINAL_ID  from MDM_PERIOD_VERSION where APPROVAL_STATUS='已审核'  
                group by PROJECT_ORIGINAL_ID) tab  on  project.PROJECT_ORIGINAL_ID=tab.PROJECT_ORIGINAL_ID 
                where  floor(sysdate-project.PROJECT_GET_TIME)>=betweenDays and tab.APPROVAL_COUNT is null) loop
                        P_SYS_MSG_CONFIG_INFO_HELP(
                            TODOPCADDRESS => TODOPCADDRESS,
                            TOREADPCADDRESS => TOREADPCADDRESS,
                            TODOTITLE => TODOTITLE,
                            TOREADTITLE => TOREADTITLE,
                            PROJECTID => item.PROJECT_ORIGINAL_ID,
                            MSGCODE => MSGCODE,
                            CREATER => CREATER,
                            UUID => uuid
                      );
               end loop;
        --可研计划编制待办
        elsif msgCode='feasiblePlanToDo' then
              for item in ( select PROJECT_ORIGINAL_ID,Project_name from (select * from mdm_project project where project.id=project.PROJECT_ORIGINAL_ID and project.APPROVAL_STATUS='已审核') project 
             left join (select count(1) APPROVAL_COUNT,PROJ_ID from POM_PROJ_PLAN where PLAN_TYPE='可研计划' and ( APPROVAL_STATUS='已审核'   or APPROVAL_STATUS='审核中')
            group by PROJ_ID) plan on project.PROJECT_ORIGINAL_ID=plan.PROJ_ID where plan.APPROVAL_COUNT is null and  floor(sysdate-project.PROJECT_GET_TIME)>=betweenDays) loop
                 P_SYS_MSG_CONFIG_INFO_HELP(
                    TODOPCADDRESS => TODOPCADDRESS,
                    TOREADPCADDRESS => TOREADPCADDRESS,
                    TODOTITLE => TODOTITLE,
                    TOREADTITLE => TOREADTITLE,
                    PROJECTID => item.PROJECT_ORIGINAL_ID,
                    MSGCODE => MSGCODE,
                    CREATER => CREATER,
                     UUID => uuid
                );
             end loop;
         --首开分期关键节点计划编制待办
        elsif msgCode='firstStageKeyNodeToDo' then
             for item in (select pro.PERIOD_ORIGINAL_ID,pro.period_name,pro.project_original_id,project.project_name,project.id from
             --已审核的首开分期分期
             (select per.PERIOD_ORIGINAL_ID,per.period_name,per.project_original_id from MDM_PERIOD per left join MDM_PERIOD_VERSION ver on per.PERIOD_VERSION_ID=ver.id 
             where ver.APPROVAL_STATUS='已审核' and per.IS_FIRST_OPEN_PERIOD=1 and per.Id=per.PERIOD_ORIGINAL_ID) pro
            --关联项目
             left join mdm_project project on project.id=pro.project_original_id
             --查询分期的已审核和审核中的关键节点计划的数量
            left join (select count(1) APPROVAL_COUNT,PROJ_ID from POM_PROJ_PLAN  where PLAN_TYPE='关键节点计划' and ( APPROVAL_STATUS='已审核'   or APPROVAL_STATUS='审核中')
            group by PROJ_ID) plan
            on pro.PERIOD_ORIGINAL_ID=plan.PROJ_ID  where project.id is not null and project.APPROVAL_STATUS='已审核' and plan.APPROVAL_COUNT is null  and  floor(sysdate-project.PROJECT_GET_TIME)>=betweenDays) loop
                     P_SYS_MSG_CONFIG_INFO_HELP(
                        TODOPCADDRESS => TODOPCADDRESS,
                        TOREADPCADDRESS => TOREADPCADDRESS,
                        TODOTITLE => TODOTITLE,
                        TOREADTITLE => TOREADTITLE,
                        PROJECTID => item.PROJECT_ORIGINAL_ID||';'||item.PERIOD_ORIGINAL_ID,
                        MSGCODE => MSGCODE,
                        CREATER => CREATER,
                        UUID => uuid
                    );
            end loop;
        --首开分期项目主项计划编制待办
        elsif msgCode='firstStageProToDo' then
             for item in (select pro.PERIOD_ORIGINAL_ID,pro.period_name,pro.project_original_id,project.project_name,project.id from
             --已审核的首开分期分期
             (select per.PERIOD_ORIGINAL_ID,per.period_name,per.project_original_id from MDM_PERIOD per left join MDM_PERIOD_VERSION ver on per.PERIOD_VERSION_ID=ver.id 
             where ver.APPROVAL_STATUS='已审核' and per.IS_FIRST_OPEN_PERIOD=1 and per.Id=per.PERIOD_ORIGINAL_ID) pro
            --关联项目
             left join mdm_project project on project.id=pro.project_original_id
             --查询分期的已审核和审核中的项目主项计划的数量
            left join (select count(1) APPROVAL_COUNT,PROJ_ID from POM_PROJ_PLAN  where PLAN_TYPE='项目主项计划' and ( APPROVAL_STATUS='已审核'   or APPROVAL_STATUS='审核中')
            group by PROJ_ID) plan
            on pro.PERIOD_ORIGINAL_ID=plan.PROJ_ID  where project.id is not null and project.APPROVAL_STATUS='已审核' and plan.APPROVAL_COUNT is null  and  floor(sysdate-project.PROJECT_GET_TIME)>=betweenDays) loop
                     P_SYS_MSG_CONFIG_INFO_HELP(
                        TODOPCADDRESS => TODOPCADDRESS,
                        TOREADPCADDRESS => TOREADPCADDRESS,
                        TODOTITLE => TODOTITLE,
                        TOREADTITLE => TOREADTITLE,
                        PROJECTID => item.PROJECT_ORIGINAL_ID||';'||item.PERIOD_ORIGINAL_ID,
                        MSGCODE => MSGCODE,
                        CREATER => CREATER,
                         UUID => uuid
                    );
            end loop;
        --续开分期关键节点计划
        elsif msgCode='conStageKeyNodeToDo' then
             for item in (
             --已审核的续开分期分期
             select pro.PERIOD_ORIGINAL_ID,pro.period_name,pro.project_original_id,project.project_name,project.id from
             (select per.PERIOD_ORIGINAL_ID,per.period_name,per.project_original_id from MDM_PERIOD per left join MDM_PERIOD_VERSION ver on per.PERIOD_VERSION_ID=ver.id 
             where ver.APPROVAL_STATUS='已审核' and per.IS_FIRST_OPEN_PERIOD<>1 and per.Id=per.PERIOD_ORIGINAL_ID) pro
             --已审核的续开分期分期所属项目
             left join mdm_project project on project.id=pro.project_original_id
             --查询分期的已审核和审核中的关键节点计划的数量
            left join (select count(1) APPROVAL_COUNT,PROJ_ID from POM_PROJ_PLAN  where PLAN_TYPE='关键节点计划' and ( APPROVAL_STATUS='已审核'   or APPROVAL_STATUS='审核中')
            group by PROJ_ID) plan
            on pro.PERIOD_ORIGINAL_ID=plan.PROJ_ID  where project.id is not null and project.APPROVAL_STATUS='已审核' and  floor(sysdate-project.PROJECT_GET_TIME)>=betweenDays  and plan.APPROVAL_COUNT is null) loop
                  P_SYS_MSG_CONFIG_INFO_HELP(
                        TODOPCADDRESS => TODOPCADDRESS,
                        TOREADPCADDRESS => TOREADPCADDRESS,
                        TODOTITLE => TODOTITLE,
                        TOREADTITLE => TOREADTITLE,
                        PROJECTID => item.PROJECT_ORIGINAL_ID||';'||item.PERIOD_ORIGINAL_ID,
                        MSGCODE => MSGCODE,
                        CREATER => CREATER,
                        UUID => uuid
                    );
             end loop;
        end if;
    select count(1) into rowcount from TEMP_SYS_MESSAGE_SEND_LIST WHERE ID=uuid;
    dbms_output.put_line('rowcount:'||rowcount);
    if rowcount <> 0 then
        open info for select 
        rownum,
        senderAccount "senderAccount",
        recipientAccount  "recipientAccount",
        systemId  "systemId",
        appid "appid",
        bizKey "bizKey",
        bizMsgCategory  "bizMsgCategory",
        msgChannel "msgChannel",
        smsTemplateid "smsTemplateid",
        smsParams "smsParams",
        mobile "mobile",
        wechatTemplateid "wechatTemplateid",
        wechatParams "wechatParams",
        wechatJumplinkUrl "wechatJumplinkUrl",
        title "title",
        bizSourceCategory "bizSourceCategory",
        portalMsgType "portalMsgType",
        url "url",
        mobileUrl "mobileUrl",
        taskname "taskname",
        typename "typename",
        remark "remark",
        expiretime "expiretime",
        priority  "priority"
        from TEMP_SYS_MESSAGE_SEND_LIST WHERE ID=uuid;
    end if;
end if;
exception
when others then
 dbms_output.put_line(sqlcode||'--'||sqlerrm);--sqlcode表示异常代码，sqlerrm表示异常信息
end p_sys_msg_config_list_by_code;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_PERIOD_SYNCHRONIZATION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_PERIOD_SYNCHRONIZATION" AS
--同步主数据数据--分期/分期宗地关系表 强关联所以一起同步
--处理原因：除主数据维护外，其他地方使用项目表混乱。主数据维护外使用项目按设计，应计划统一调整使用 分期、楼栋sys_project,sys_project_stage,sys_build,sys_PARCEL
--作者：陈丽
--日期：2020-06-19
BEGIN------同步主数据项目
----删除项目;
DELETE sys_project_stage;
----新增项目;
INSERT INTO sys_project_stage (id,stage,stage_name,project_state,project_id,is_first_open_period,stage_full_name,ORDER_CODE)
WITH period AS (
    SELECT DISTINCT d.id,d.period_original_id,d.period_name,e.phase_name,f.project_original_id,d.is_first_open_period,d.PERIOD_CODE FROM mdm_period d 
    LEFT JOIN mdm_period_version f ON d.period_version_id=f.id LEFT JOIN (
    SELECT v.period_id,v.phase_name FROM (
    SELECT a.period_id,a.phase_order,b.phase_name FROM mdm_period_phase a LEFT JOIN (
    SELECT id,phase_name FROM mdm_phase) b ON a.phase_id=b.id) v INNER JOIN (
    SELECT period_id,MAX(phase_order) max FROM mdm_period_phase GROUP BY period_id) vv
    ON v.period_id=vv.period_id AND v.phase_order=vv.max) e 
    ON d.period_original_id=e.period_id WHERE f.approval_status='已审核' and d.IS_DELETE=0 ORDER BY f.project_original_id)
SELECT period.period_original_id,period.period_name,period.period_name,period.phase_name,period.project_original_id,period.is_first_open_period,case when period.period_name='无分期' then proj.PROJECT_NAME else proj.PROJECT_NAME||period.period_name end,PERIOD_CODE  FROM period
left join sys_project  proj on period.project_original_id=proj.id;
--删除分期和宗地的关系
DELETE sys_parcel_obj_r WHERE obj_type='分期';
----新增分期和宗地的关系;
INSERT INTO sys_parcel_obj_r (id,obj_id,obj_type,parcel_id) 
WITH period AS (
    SELECT DISTINCT d.id,d.period_original_id,d.period_name,e.phase_name,f.project_original_id,d.is_first_open_period FROM mdm_period d LEFT JOIN mdm_period_version f ON d.period_version_id=f.id LEFT JOIN (
    SELECT v.period_id,v.phase_name FROM (
    SELECT a.period_id,a.phase_order,b.phase_name FROM mdm_period_phase a LEFT JOIN (
    SELECT id,phase_name FROM mdm_phase) b ON a.phase_id=b.id) v INNER JOIN (
    SELECT period_id,MAX(phase_order) max FROM mdm_period_phase GROUP BY period_id) vv ON v.period_id=vv.period_id AND v.phase_order=vv.max) e ON d.period_original_id=e.period_id WHERE f.approval_status='已审核' ORDER BY f.project_original_id)
SELECT get_uuid () id,period.period_original_id AS obj_id,obj_type,parcel_original_id AS PARCEL_ID FROM mdm_obj_parcel_r r LEFT JOIN period ON r.obj_id=period.id WHERE obj_type='分期' AND period.id IS NOT NULL;
COMMIT;
EXCEPTION
  WHEN OTHERS THEN
    dbms_output.put_line(SQLERRM);
    ROLLBACK;
END P_SYS_PERIOD_SYNCHRONIZATION;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_PERSON_LIST_ANALYSIS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_PERSON_LIST_ANALYSIS" (
    noticepersons        IN                   CLOB,          --用户code多个
    noticegroups         IN                   CLOB,        --虚拟组
    noticeprojectroles   IN                   CLOB,  --项目级角色
    noticeorgids         IN                   CLOB,        --组织Id
    projectid            IN                   VARCHAR2,
    uuid                 OUT                  VARCHAR2
) IS
    companyid   VARCHAR2(36);
    row_count   NUMBER;
BEGIN
    SELECT
        get_uuid()
    INTO uuid
    FROM
        dual;

    IF noticepersons IS NOT NULL THEN
        INSERT INTO person_role_analysis_table
            SELECT
                splitstr(column_value, 2),
                splitstr(column_value, 1) AS detail,
                'userid' AS type
            FROM
                TABLE ( split(noticepersons, ';') );

        INSERT INTO person_role_analysis_table
            SELECT
                r.user_code,
                uuid,
                'person'
            FROM
                (
                    SELECT
                        *
                    FROM
                        person_role_analysis_table
                    WHERE
                        type = 'userid'
                        AND code IS NOT NULL
                ) tab
                LEFT JOIN sys_user r ON tab.code = r.id
            WHERE
                r.user_code IS NOT NULL;

        DELETE person_role_analysis_table
        WHERE
            type = 'userid';

    END IF;

    IF noticegroups IS NOT NULL THEN
        INSERT INTO person_role_analysis_table
            SELECT
                splitstr(column_value, 1) AS code,
                splitstr(column_value, 2) AS detail,
                'group' AS type
            FROM
                TABLE ( split(noticegroups, ';') );

        IF projectid IS NULL THEN
            INSERT INTO person_role_analysis_table
                SELECT
                    r.user_account,
                    uuid,
                    'person'
                FROM
                    (
                        SELECT
                            *
                        FROM
                            person_role_analysis_table
                        WHERE
                            type = 'group'
                            AND code IS NOT NULL
                    ) tab
                    LEFT JOIN sys_role_user_relation_result r ON tab.code = r.virtual_group_name
                WHERE
                    r.role_type = 40
                    AND r.user_account IS NOT NULL;

        ELSE
        --获取项目的所属公司
          --判断是否能够在mdm中查询到id=项目原始id(传入项目id)的数据
            SELECT
                COUNT(1)
            INTO row_count
            FROM
                mdm_project
            WHERE
                id = projectid;

            IF row_count <> 0 THEN
                SELECT
                    company_id
                INTO companyid
                FROM
                    mdm_project
                WHERE
                    id = projectid
                    AND ROWNUM = 1;

            END IF;
            --判断是否能够在mdm中查询到项目原始id=项目原始id(传入项目id)的数据，如果有查询审批时间最近的一条
            SELECT
                COUNT(1)
            INTO row_count
            FROM
                mdm_project
            WHERE
                project_original_id = projectid
                AND approval_time IS NOT NULL
            ORDER BY
                approval_time DESC;
            IF row_count <> 0 THEN
                SELECT
                    company_id
                INTO companyid
                FROM
                    mdm_project
                WHERE
                    project_original_id = projectid
                    AND ROWNUM = 1
                    AND approval_time IS NOT NULL
                ORDER BY
                    approval_time DESC;

            END IF;

            IF companyid IS NOT NULL THEN
                dbms_output.put_line('COMPANYID:' || companyid);
                INSERT INTO person_role_analysis_table
                    SELECT
                        r.user_account,
                        uuid,
                        'person'
                    FROM
                        sys_role_user_relation_result r    

                        --【三级单位】：获取当前项目所属公司，递归所有父级公司集合（项目所属公司在三级单位子级公司），包含自身（项目所属公司在三级单位），并且公司层级=3，公司id作为虚拟组解析公司。

                        --递归所有父级公司集合，包含自身，并且公司层级=3
                        INNER JOIN (
                            SELECT
                                id
                            FROM
                                (
                                    SELECT
                                        *
                                    FROM
                                        sys_business_unit m
                                    START WITH
                                        m.id = companyid
                                    CONNECT BY
                                        PRIOR m.parent_id = m.id
                                ) org
                            WHERE
                                org.is_company = 1
                                AND org.level_rank = 3
                            UNION ALL

                        --chenl  20200718  项目所属公司在三级单位。期望解析三级单位的子公司，计划运营岗位（实际是四级单位的）的人。
                            SELECT
                                id
                            FROM
                                sys_business_unit m
                            WHERE
                                m.parent_id = companyid
                                AND m.is_company = 1
                                AND m.level_rank = 4
                        ) org ON r.company_id = org.id
                    WHERE
                        r.virtual_group_name IN (
                            SELECT
                                code
                            FROM
                                person_role_analysis_table
                            WHERE
                                type = 'group'
                                AND code IS NOT NULL
                                AND code LIKE '%【三级单位】%'
                        )
                        AND r.role_type = 40
                        AND r.user_account IS NOT NULL
                    UNION
                    SELECT
                        r.user_account,
                        uuid,
                        'person'
                    FROM
                        sys_role_user_relation_result r    

                          --兄弟节点和所有子级，并且公司层级=3
                        INNER JOIN (
                            SELECT
                                id
                            FROM
                                (
                                    SELECT
                                        *
                                    FROM
                                        sys_business_unit m1
                                    WHERE
                                        EXISTS (
                                            SELECT
                                                *
                                            FROM
                                                sys_business_unit m2
                                            WHERE
                                                m1.parent_id = m2.parent_id
                                                AND m2.id = companyid
                                        )
                                    UNION
                                    SELECT
                                        *
                                    FROM
                                        sys_business_unit m
                                    START WITH
                                        m.id = companyid
                                    CONNECT BY
                                        m.parent_id = PRIOR m.id
                                ) org
                            WHERE
                                org.is_company = 1
                                AND org.level_rank = 3
                        ) org ON r.company_id = org.id
                    WHERE
                        r.virtual_group_name IN (
                            SELECT
                                code
                            FROM
                                person_role_analysis_table
                            WHERE
                                type = 'group'
                                AND code IS NOT NULL
                                AND code LIKE '%【二级单位】%'
                        )
                        AND r.role_type = 40
                        AND r.user_account IS NOT NULL;

            END IF;

        END IF;

        DELETE person_role_analysis_table
        WHERE
            type = 'group';

    END IF;

    IF noticeprojectroles IS NOT NULL THEN
        INSERT INTO person_role_analysis_table
            SELECT
                splitstr(column_value, 2) AS code,
                splitstr(column_value, 1) AS detail,
                'projectRole' AS type
            FROM
                TABLE ( split(noticeprojectroles, ';') );

        INSERT INTO person_role_analysis_table
            SELECT
                r.user_account,
                uuid,
                'person'
            FROM
                (
                    SELECT
                        *
                    FROM
                        person_role_analysis_table
                    WHERE
                        type = 'projectRole'
                        AND code IS NOT NULL
                ) tab
                LEFT JOIN sys_role_user_relation_result r ON tab.code = r.role_code
            WHERE
                r.role_type = 30
                AND r.project_id = projectid
                AND r.user_account IS NOT NULL;

        DELETE person_role_analysis_table
        WHERE
            type = 'projectRole';

    END IF;

    IF noticeorgids IS NOT NULL THEN
        INSERT INTO person_role_analysis_table
            SELECT
                splitstr(column_value, 2) AS code,
                splitstr(column_value, 1) AS detail,
                'org' AS type
            FROM
                TABLE ( split(noticeorgids, ';') );

        INSERT INTO person_role_analysis_table
            SELECT
                sys_user.user_code,
                uuid,
                'person'
            FROM
                (
                    SELECT
                        *
                    FROM
                        sys_business_unit m
                    START WITH
                        m.id IN (
                            SELECT
                                code
                            FROM
                                person_role_analysis_table
                            WHERE
                                type = 'org'
                        )
                    CONNECT BY
                        m.parent_id = PRIOR m.id
                ) tab
                LEFT JOIN sys_station ON tab.id = sys_station.org_id
                LEFT JOIN sys_station_to_user ON sys_station.id = sys_station_to_user.station_id
                LEFT JOIN sys_user ON sys_user.id = sys_station_to_user.user_id
            WHERE
                sys_user.user_code IS NOT NULL;

        DELETE person_role_analysis_table
        WHERE
            type = 'org';

    END IF;

END p_sys_person_list_analysis;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_PROJ_SYNCHRONIZATION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_PROJ_SYNCHRONIZATION" AS
--同步主数据数据---项目、宗地 强关联所以一起同步
--处理原因：除主数据维护外，其他地方使用项目表混乱。主数据维护外使用项目按设计，应计划统一调整使用 分期、楼栋sys_project,sys_project_stage,sys_build,sys_PARCEL
--作者：陈丽
--日期：2020-06-19
--chenl 2021-01-05 同步数据兼容阶段重复情况，阶段重复去重处理
BEGIN------同步主数据项目

------更新项目全路径
update mdm_project set ORDER_HIERARCHY_CODE=(
select code from (
select p.id,u.ORDER_HIERARCHY_CODE||'.'||PROJECT_CODE as code from  mdm_project p
left join SYS_BUSINESS_UNIT u on  p.COMPANY_ID=u.id) s where mdm_project.id=s.id );
commit;
----删除项目;
DELETE sys_project;

INSERT INTO sys_project (sn,---排序
id,---主键
project_name,---项目名称
update_date,---更新时间
project_code,---项目编号
----------------
unit_id,---公司id
unit_name,---公司名称
project_state,---项目状态
address,---地址
city_code,---城市编号
----------------
city_name,---城市名称
update_user_id,---更新人id
update_user,---更新人
take_date,---获得日期
order_hierarchy_code,---全路径排序编码//黄伟1227增加
----------------
project_reply_name,---项目批复名称///陈丽20200619新增
project_popularize_name,---项目推广名称///陈丽20200619新增
is_cooperate,---是否合作项目///陈丽20200619新增

PROJ_COOPERATE,
PROJ_COOPERATE_ID,
---------------------- 主数据无
    project_get_time,
    company_id,
    company_name,
    legal_person_company_id,
    legal_person_company,
    legal_person_company_code,
    real_estate_share_ratio,
    series_ratio,
    person_liable,
    partners1,
    partners2,
    partners3,
    place_id,
    province_name,
    place_name,
    plane_figure,
    proj_address,
    approval_status,
    approval_time,
    approver_id,
    approver,
    remark,
    created,
    creator,
    creator_id,
    first_proj_approval_time,
    first_period_approval_time,
    project_original_id,
    project_version,
    province_id,
    city_id,
    create_station_id,
    create_station,
    modified,
    modifier_id,
    modifier,
    r_proj_id
) WITH 
phase as(  SELECT v.proj_id,v.phase_name FROM (
    SELECT a.proj_id,a.phase_order,b.phase_name FROM mdm_project_phase a LEFT JOIN (
    SELECT id,phase_name FROM mdm_phase) b ON a.phase_id=b.id) v INNER JOIN (
    SELECT proj_id,MAX(phase_order) max FROM mdm_project_phase GROUP BY proj_id) vv
    ON v.proj_id=vv.proj_id AND v.phase_order=vv.max
    group by v.proj_id,v.phase_name)
,proj AS (
    SELECT d.id,d.project_name,d.project_code,---------------------
    e.phase_name,d.city_name,d.order_hierarchy_code,---------------------
    d.project_reply_name,d.project_popularize_name,d.is_cooperate,d.PROJ_COOPERATE,
    d.PROJ_COOPERATE_ID,
d.Project_Get_Time,
d.Company_Id,
d.Company_Name,
d.Legal_Person_Company_Id,
d.Legal_Person_Company,
d.Legal_Person_Company_Code,
d.Real_Estate_Share_Ratio,
d.Series_Ratio,
d.Person_Liable,
d.Partners1,
d.Partners2,
d.Partners3,
d.Place_Id,
d.Province_Name,
d.Place_Name,
d.Plane_Figure,
d.Proj_Address,
d.Approval_Status,
d.Approval_Time,
d.Approver_Id,
d.Approver,
d.Remark,
d.Created,
d.Creator,
d.Creator_Id,
d.First_Proj_Approval_Time,
d.First_Period_Approval_Time,
d.Project_Original_Id,
d.Project_Version,
d.Province_Id,
d.City_Id,
d.Create_Station_Id,
d.Create_Station,
d.Modified,
d.Modifier_Id,
d.Modifier,r_proj_id

FROM mdm_project d LEFT JOIN phase e ON d.project_original_id=e.proj_id WHERE d.approval_status='已审核' ORDER BY d.project_code)
SELECT ROWNUM sn,project_original_id AS id,project_name AS name,modified AS updatedate,project_code AS code,company_id AS unitid,company_name AS unitname,phase_name AS state,proj_address AS address,city_id AS citycode,city_name AS cityname,modifier_id AS updateuserid,modifier AS updateuser,project_get_time AS takedate,order_hierarchy_code,project_reply_name,project_popularize_name,is_cooperate,PROJ_COOPERATE,
PROJ_COOPERATE_ID,
proj.project_get_time,
proj.company_id,
proj.company_name,
proj.legal_person_company_id,
proj.legal_person_company,
proj.legal_person_company_code,
proj.real_estate_share_ratio,
proj.series_ratio,
proj.person_liable,
proj.partners1,
proj.partners2,
proj.partners3,
proj.place_id,
proj.province_name,
proj.place_name,
proj.plane_figure,
proj.proj_address,
proj.approval_status,
proj.approval_time,
proj.approver_id,
proj.approver,
proj.remark,
proj.created,
proj.creator,
proj.creator_id,
proj.first_proj_approval_time,
proj.first_period_approval_time,
proj.project_original_id,
proj.project_version,
proj.province_id,
proj.city_id,
proj.create_station_id,
proj.create_station,
proj.modified,
proj.modifier_id,
proj.modifier,
proj.r_proj_id
FROM proj ORDER BY ROWNUM;

DELETE SYS_PARCEL;---同步宗地
INSERT INTO sys_parcel (id,parcel_name,project_id,land_transfer_contract_code,contract_total_price,land_transfer_method,land_transferer,land_get_date,hand_over_date,land_state,land_address,land_useage,province_name,city_name,district_name,remarks,province_id,city_id,district_id)
WITH 
phase as(  SELECT v.proj_id,v.phase_name FROM (
    SELECT a.proj_id,a.phase_order,b.phase_name FROM mdm_project_phase a LEFT JOIN (
    SELECT id,phase_name FROM mdm_phase) b ON a.phase_id=b.id) v INNER JOIN (
    SELECT proj_id,MAX(phase_order) max FROM mdm_project_phase GROUP BY proj_id) vv
    ON v.proj_id=vv.proj_id AND v.phase_order=vv.max
    group by v.proj_id,v.phase_name)
,
proj AS (
    SELECT d.id FROM mdm_project d LEFT JOIN phase e ON d.project_original_id=e.proj_id WHERE d.approval_status='已审核' ORDER BY d.project_code)
SELECT PARCEL_ORIGINAL_ID,parcel_name,PROJECT_ORIGINAL_ID,land_transfer_contract_code,contract_total_price,land_transfer_method,land_transferer,land_get_date,hand_over_date,land_state,land_address,land_useage,province_name,city_name,district_name,remarks,province_id,city_id,district_id

FROM MDM_PARCEL pa LEFT JOIN proj p ON pa.PROJECT_ID=p.id where  p.id is not null and PARCEL_ORIGINAL_ID  is not null;



commit;
EXCEPTION
  WHEN OTHERS THEN
    dbms_output.put_line(SQLERRM);
    ROLLBACK;
END P_SYS_PROJ_SYNCHRONIZATION;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_PROJECT_BY_ORG_ID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_PROJECT_BY_ORG_ID" ( unitId in varchar2,
USERID IN VARCHAR2, 
STATIONID IN VARCHAR2, 
DEPTID IN VARCHAR2, 
COMPANYID IN VARCHAR2, 
BIZCODE IN VARCHAR2 ,
INFOS OUT sys_refcursor) 
AS
v_spid VARCHAR2(36);--使用临时表的批次号
rowCnt NUMBER;
begin
--查询有数据权限的组织和项目
     P_SYS_TMP_PROJECT_BY_ORG_ID(
            unitId=>unitId,
            USERID => userid,
            STATIONID => STATIONID,
            DEPTID => DEPTID,
            COMPANYID => COMPANYID,
            BIZCODE => bizcode,
            p_spid => v_spid
        );
            if v_spid is null then
                OPEN INFOS FOR  select pro.ID AS "id",pro.project_name AS "projectName",pro.sn AS "sn" from sys_project pro where pro.id is null;
            else   
                OPEN INFOS FOR  select pro.ID AS "id",pro.project_name AS "projectName",pro.sn AS "sn" from TMP_PROJRCT_BY_SUPPLY_PLAN pro where pro.SPID=v_spid order by pro.sn asc;
        end if;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_ROLE_ORG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_ROLE_ORG" (
   userInfo out  SYS_REFCURSOR
) AS
	--虚拟组角色数据源
	--作者：陈丽
	--日期：2020-07-16
BEGIN
open userInfo for
select null as "createtime"
,null "nodetype"
,null "pguid"
,null "isparent"
,null "display"
,VIRTUAL_GROUP_NAME as  "name"
,null "guid"
,null "pid"
,null "ordernum"
,VIRTUAL_GROUP_ID as "id"
,VIRTUAL_GROUP_NAME as  "title"
from SYS_ROLE_USER_RELATION_RESULT where ROLE_TYPE=40 group by VIRTUAL_GROUP_ID,VIRTUAL_GROUP_NAME
order by VIRTUAL_GROUP_NAME
;
END P_SYS_ROLE_ORG;
----------------------------------------------chenl20200621结束------从主数据刷新目标货值存储过程


----------------------------------------------chenl20200621开始------从主数据刷新目标货值存储过程注册

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_ROLE_PROJ
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_ROLE_PROJ" (
   userInfo out  SYS_REFCURSOR,
   o_result out varchar2
) AS
	--项目级角色数据源
	--作者：陈丽
	--日期：2020-07-16
BEGIN
o_result:='';
open userInfo for
select ROLE_CODE as  "roleCode",
ROLE_NAME as  "roleName" 
from SYS_ROLE_USER_RELATION_RESULT where ROLE_TYPE=30 group by ROLE_NAME,ROLE_CODE
order by ROLE_CODE desc
;
END P_SYS_ROLE_PROJ  ;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_TMP_PROJECT_BY_ORG_ID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_TMP_PROJECT_BY_ORG_ID" ( 
unitId in varchar2,
USERID IN VARCHAR2, 
STATIONID IN VARCHAR2, 
DEPTID IN VARCHAR2, 
COMPANYID IN VARCHAR2, 
BIZCODE IN VARCHAR2 ,
p_spid OUT VARCHAR2) 
AS
v_spid VARCHAR2(36);--使用临时表的批次号
rowCnt NUMBER;
spid VARCHAR2(36):=get_uuid();--使用临时表的批次号
begin
p_spid:=spid;
--查询有数据权限的组织和项目
     P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => STATIONID,
            DEPTID => DEPTID,
            COMPANYID => COMPANYID,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
        select count(1)  into rowCnt  from  TMP_AUTH_LIST where id = v_spid and org_id='003200000000000000000000000000';
         if unitId is null or unitId='003200000000000000000000000000' or rowCnt<>0 then
                --查询所有权限的项目
                 insert into TMP_PROJRCT_BY_SUPPLY_PLAN select sys_project.ID as "id",sys_project.project_name as "projectName",LPAD (sys_project.sn , 6 , '0'),spid as SPID  from sys_project right join
                (
                select DISTINCT SYS_PROJECT.ID  FROM SYS_PROJECT right JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = v_spid) list
                ON list.orgid=SYS_PROJECT.ID where sys_project.id is not null
                union
                --查询所有权限的组织下的项目
               select DISTINCT pro.ID from sys_project pro right join(
               select  unit.id from SYS_BUSINESS_UNIT unit right JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = v_spid) list  ON list.orgid=unit.ID where unit.id is not null ) org_unit  
               on pro.COMPANY_ID=org_unit.id where pro.id is not null
               ) pros on sys_project.id=pros.id;
            else    
                 insert into TMP_PROJRCT_BY_SUPPLY_PLAN select sys_project.ID as "id",sys_project.project_name as "projectName",LPAD (sys_project.sn , 6 , '0'),spid as SPID 
                 from sys_project right join (select id from (select pro.id from  (select sys_project.* from sys_project right join (select ID from SYS_BUSINESS_UNIT m start with m.id=unitId connect by m.PARENT_ID=prior m.id) unit on sys_project.COMPANY_ID=unit.id
                 where sys_project.id is not null ) pro left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = v_spid) list ON list.orgid=pro.ID  where pro.id is not null 
                union
                --查询传入组织下所有子级组织的项目
               select pro.id from sys_project pro right join(
               select m.ID from SYS_BUSINESS_UNIT m start with m.id =unitId
               connect by m.PARENT_ID=prior m.id) org_unit  on pro.COMPANY_ID=org_unit.id where pro.id is not null)) projects on projects.id=sys_project.id
               INNER join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = v_spid) projs on sys_project.id =projs.orgid
               order by LPAD (sys_project.sn , 6 , '0');
        end if;
end P_SYS_TMP_PROJECT_BY_ORG_ID;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_USER_TREE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_SYS_USER_TREE" (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    parentid         IN               VARCHAR2,
    data_auth_info   OUT              SYS_REFCURSOR
) AS
--获取用户树
--作者：陈丽
--日期：2020/06/18

    rulevalue        VARCHAR2(50);
    authcount        INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    spid             VARCHAR2(36);--使用临时表的批次号
    data_auth_spid   VARCHAR2(200);
    authcode         VARCHAR2(50);---- 权限编码
    v_id varchar2(100);
BEGIN

    IF parentid IS NULL THEN
        v_id := '0001';
    ELSE
        v_id := parentid;
    END IF;
  --先不健全
    OPEN data_auth_info FOR WITH base AS (
                                SELECT
                                    *
                                FROM
                                    (
                                        SELECT DISTINCT
                                            a.id           AS id,
                                            a.id           AS objid,
                                            a.org_name     AS orgname,
                                            a.org_type     AS orgtype,
                                            a.parent_id    AS parentid,
                                            a.order_code   AS ordercode
                                        FROM
                                            sys_business_unit a
                                        UNION ALL
                                   ----岗位
                                        SELECT
                                            id,
                                            id       AS obj_id,
                                            station_name,
                                            '100' AS orgtype,
                                            org_id   AS parent_id,
                                            station_name
                                        FROM
                                            sys_station
                                        UNION ALL
                                   ----人
                                        SELECT
                                            stu.id,
                                            u.id             AS user_id,
                                            u.user_name,
                                            '110' AS orgtype,
                                            stu.station_id   AS parent_id,
                                            user_code
                                        FROM
                                            sys_station_to_user   stu
                                            LEFT JOIN sys_user              u ON stu.user_id = u.id
                                    )
                            ), 计算 AS (
                                SELECT
                                    base1.id,
                                    base1.objid,
                                    base1.orgname,
                                    base1.orgtype,
                                    base1.parentid,
                                    lpad(base1.ordercode, 10, '0') AS ordercode,
                                    CASE
                                        WHEN base2.parentid IS NULL THEN
                                            1
                                        ELSE
                                            0
                                    END AS isleaf
                                FROM
                                    base base1
                                    LEFT JOIN (
                                        SELECT
                                            parentid
                                        FROM
                                            base
                                        GROUP BY
                                            parentid
                                    ) base2 ON base1.id = base2.parentid
                            )
                            SELECT  *  FROM  计算 WHERE  parentid = v_id  ORDER BY ordercode;

END p_sys_user_tree;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_COMPONENT_BY_PAGE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_UDP_COMPONENT_BY_PAGE" (containerGuid in varchar,pageComponents OUT sys_refcursor,treeSelect OUT sys_refcursor,tabs OUT sys_refcursor,tableColumn OUT sys_refcursor,buttoneEvent OUT sys_refcursor,eventMonitoring OUT sys_refcursor,datePicker OUT sys_refcursor)
AS  
haspage INTEGER;
BEGIN  
select count(1) into haspage  from UDP_PAGE where ID=containerGuid;
if haspage=1
then
open pageComponents for  
select   c.ID componentId,                                                      --组件ID
p.ID containerGuid,                                                                --容器ID          
c.COMPONENT_HIGH componentHeight,                          --组件高度
c.COMPONENT_WIDE componentWidth,                            --组件宽度
p.TITLE  pageTitle,                                                                    --页面标题
p.WINDOW_WIDTH  windowWidth,                                      --打开窗口宽度
p.WINDOW_HEIGHT windowHeight,                                     --打开窗口高度
c.COMPONENT_ORDER,                                                           --展示顺序 
c.COMPONENT_NAME componentName,                           --组件名称
c.COMPONENT_LABLE lable,                                                   --组件展示标题
c.COMPONENT_TYPE componentType,                                --组件类型
c.PLACEHOLDER placeholder,                                                 --展示水印文字
p.LAYOUT_TEMPLATE_ID templateName,                              --使用模板名称
l.LAYOUT_AREA_TEMPLATE_ID regionMark,                        --使用区域标识名称
s.IS_CHECK,                                                                                 --是否能够多选
s.IS_CHECKED_LAST_STAGE,                                                    --是否只能选中最末级
 s.DEFAULT_VALUE,                                                                   --默认值
s.DATA_SOURCE_TYPE,                                                             --数据源类型
s.DATA_SOURCE componentSource,                                      --组件数据源
s.PK_FIELD,                                                                                    --主键字段
s.LABLE_FIELD,                                                                              --展示字段
c.DATA_SOURCE                                                                          --展示数据(TemplateHyperText、TemplateContainer)
 from  UDP_LAYOUT l  
 left join UDP_PAGE P on  l.page_id=p.ID
 left join UDP_COMPONENT c on  l.COMPONENT_ID=c.ID 
left join UDP_COMPONENT_DATA_SOURCE s on c.COMPONENT_DATA_SOURCE_ID=s.ID
where l.PAGE_ID=containerGuid and l.page_id=c.page_id order by c.COMPONENT_ORDER asc;
else
open pageComponents for  
select   c.ID componentId,                                                      --组件ID
containerGuid containerGuid,                                                 --容器ID         
c.COMPONENT_HIGH componentHeight,                          --组件高度
c.COMPONENT_WIDE componentWidth,                            --组件宽度
''  pageTitle,                                                                              --页面标题
''  windowWidth,                                                                       --打开窗口宽度
'' windowHeight,                                                                       --打开窗口高度
c.COMPONENT_ORDER ,                                                         --展示顺序 
c.COMPONENT_NAME componentName,                           --组件名称
c.COMPONENT_LABLE lable,                                                  --组件展示标题
c.COMPONENT_TYPE componentType,                               --组件类型
c.PLACEHOLDER placeholder,                                                --展示水印文字
'' templateName,                                                                        --模板名称
l.LAYOUT_AREA_TEMPLATE_ID regionMark,                       --使用区域标识名称
s.IS_CHECK,                                                                                --是否能够多选
s.IS_CHECKED_LAST_STAGE,                                                   --是否只能选中最末级
s.DEFAULT_VALUE ,                                                                   --默认值
s.DATA_SOURCE_TYPE,                                                             --数据源类型
s.DATA_SOURCE componentSource,                                      --组件数据源
s.PK_FIELD,                                                                                    --主键字段
s.LABLE_FIELD,                                                                              --展示字段
c.DATA_SOURCE                                                                       --展示数据(TemplateHyperText、TemplateContainer)
from UDP_COMPONENT c
left join UDP_LAYOUT l on  l.COMPONENT_ID=c.ID 
left join UDP_COMPONENT_DATA_SOURCE s on c.COMPONENT_DATA_SOURCE_ID=s.ID
where c.PAGE_ID=containerGuid order by c.COMPONENT_ORDER asc;
end if;

open treeSelect for  
select  
c.id componentId,                                                                     --组件ID
containerGuid containerGuid,                                                 --容器ID       
case when  t.default_expanded is null then '{"node":0,"level":1,"type":"index"}'
else
t.default_expanded end as default_expanded,                                   --默认展开
t.default_checked,                                                                      --默认选中
case when t.IS_CHECKED_LAST_STAGE   is null
then  s.IS_CHECKED_LAST_STAGE  else    t.IS_CHECKED_LAST_STAGE 
end as  IS_CHECKED_LAST_STAGE                                                --是否只能选中最末级
from  UDP_COMPONENT c 
left join UDP_COMPONENT_DATA_SOURCE s on c.COMPONENT_DATA_SOURCE_ID=s.ID
left join UDP_COMPONENT_TREE_SELECT t on t.ID=c.id
where c.page_id=containerGuid and (c.component_type='TemplateTreeSelect') ;


open tabs for  
select  
c.id componentId,                                                               --组件ID
t.default_tabsitem,                                                              --默认选中项
t.layout_style,                                                                       --默认样式
i.ITEM_VALUE,                                                                       --tabs组件的项具体值
i.ITEM_LABLE,                                                                        --tabs组件的项展示值
i.ID                                                                                          --tabs组件的项ID
from  UDP_COMPONENT c 
left join UDP_COMPONENT_TABS t on t.ID=c.id
left join UDP_COMPONENT_TABS_ITEM i on t.ID=i.COMPONENT_TABS_ID
where c.page_id=containerGuid and (c.component_type='TemplateTabs') order by i.item_order;

open tableColumn for
select 
*
from
(select 
n.ID,
c.ID componentId,                                                     --组件ID
n.COLUMN_LABLE,                                                     --列标题
n.COLUMN_FIELD  ,                                                    --列字段名
n.COLUMN_WIDE ,                                                     --列宽度
n.COLUMN_ALIGN ,                                                   --列对齐
n.COLUMN_FIXED ,                                                    --浮动反方向（left,right）
2 COLUMN_NUMBER_FLOAT,                               --小数字段保留几位
n.COLUMN_DATA_TYPE ,                                         --数据类型
n.is_show_total,                                                          --是否显示合计
n.parent_column_id,                                                  --父级列主键
n.is_use_sort,                                                              --是否使用排序
d.IS_CHECK,                                                                 --是否复选
t.detail_url,                                                                   --双击行跳转地址
d.PK_FIELD,                                                                  --主键字段
n.JUMP_URL,                                                               --点击列跳转地址
n.OPEN_MODE,                                                           --点击列打开页面方式
t.OPEN_MODE DETAIL_MODE,                                          --双击行打开页面方式
n.WINDOW_WIDTH,                                                   --单击列打开弹窗的宽度
n.WINDOW_HEIGHT,                                                   --单击列打开弹窗的高度
n.DEAL_WITH_MODE,                                                  --单击列处理的模式
t.WINDOW_WIDTH as ROW_WINDOW_WIDTH,                              --双击行打开弹窗的宽度
t.WINDOW_HEIGHT as ROW_WINDOW_HEIGHT,                             --双击行打开弹窗的高度
n.IS_USE_HTML,                                                                                      --是否使用html
case  when t.IS_SHOW_PAGINATION is null
then 1 else t.IS_SHOW_PAGINATION end IS_SHOW_PAGINATION,           --是否显示分页
case  when t.IS_SHOW_BORDER is null
then 1 else t.IS_SHOW_BORDER end IS_SHOW_BORDER,                   --是否显示边框
case  when t.IS_SHOW_STRIPE is null
then 1 else t.IS_SHOW_STRIPE end is_show_stripe,                    --是否显示斑马纹
1 is_default_expanded,          --是否展开所有子级
t.ENABLE_STATUS_FIELD,
t.ENABLE_DOUBLE_CLICK_FIELD,
t.DISABLE_PROMPT,
0 as IS_SHOW_EXPAND_BY_LEVEL,
0 as DEFAULT_EXPAND_LEVEL,
case  when t.IS_NEED_PARAMETER_CACHE is null then 0 else  t.IS_NEED_PARAMETER_CACHE end as IS_NEED_PARAMETER_CACHE ,
case  when n.IS_NEED_PARAMETER_CACHE is null then 0 else  n.IS_NEED_PARAMETER_CACHE end as COL_IS_NEED_PARAMETER_CACHE,
case  when t.IS_SHOW_SERIAL_NUMBER is null and lower(c.component_type)='templatetable'  then 1 when
t.IS_SHOW_SERIAL_NUMBER is null and lower(c.component_type)<>'templatetable' then 0 
else t.IS_SHOW_SERIAL_NUMBER end as IS_SHOW_SERIAL_NUMBER,
n.COLUMN_ORDER
from UDP_COMPONENT c 
left join UDP_COMPONENT_TABLE_COLUMN n on c.ID=n.component_table_id
left join UDP_COMPONENT_TABLE  t on c.ID=t.ID
left join UDP_COMPONENT_DATA_SOURCE  d on d.ID=c.COMPONENT_DATA_SOURCE_ID
where c.page_id=containerGuid and (lower(c.component_type)='templatetable' or lower(c.component_type)='templatetreetable' )
and n.STATE=1
union 
select 
n.ID,
c.ID componentId,                                                     --组件ID
n.COLUMN_LABLE,                                                     --列标题
n.COLUMN_FIELD  ,                                                    --列字段名
n.COLUMN_WIDE ,                                                     --列宽度
n.COLUMN_ALIGN ,                                                   --列对齐
n.COLUMN_FIXED ,                                                    --浮动反方向（left,right）
2 COLUMN_NUMBER_FLOAT,                               --小数字段保留几位
n.COLUMN_DATA_TYPE ,                                         --数据类型
n.is_show_total,                                                          --是否显示合计
n.parent_column_id,                                                  --父级列主键
n.is_use_sort,                                                              --是否使用排序
d.IS_CHECK,                                                                 --是否复选
t.detail_url,                                                                   --双击行跳转地址
d.PK_FIELD,                                                                  --主键字段
n.JUMP_URL,                                                               --点击列跳转地址
n.OPEN_MODE,                                                           --点击列打开页面方式
t.OPEN_MODE DETAIL_MODE,                                          --双击行打开页面方式
n.WINDOW_WIDTH,                                                   --单击列打开弹窗的宽度
n.WINDOW_HEIGHT,                                                   --单击列打开弹窗的高度
n.DEAL_WITH_MODE,                                                  --单击列处理的模式
t.WINDOW_WIDTH as ROW_WINDOW_WIDTH,                              --双击行打开弹窗的宽度
t.WINDOW_HEIGHT as ROW_WINDOW_HEIGHT,                             --双击行打开弹窗的高度
n.IS_USE_HTML,                                                                                      --是否使用html
0 IS_SHOW_PAGINATION,                                                                    --是否显示分页
case  when t.IS_SHOW_BORDER is null
then 1 else t.IS_SHOW_BORDER end IS_SHOW_BORDER,                   --是否显示边框
case  when t.IS_SHOW_STRIPE is null
then 1 else t.IS_SHOW_STRIPE end is_show_stripe,                    --是否显示斑马纹
case  when t.IS_DEFAULT_EXPANDED is null
then 1 else t.IS_DEFAULT_EXPANDED end is_default_expanded,          --是否展开所有子级
t.ENABLE_STATUS_FIELD,
t.ENABLE_DOUBLE_CLICK_FIELD,
t.DISABLE_PROMPT,
t.IS_SHOW_EXPAND_BY_LEVEL,
t.DEFAULT_EXPAND_LEVEL,
case  when t.IS_NEED_PARAMETER_CACHE is null then 0 else  t.IS_NEED_PARAMETER_CACHE end as IS_NEED_PARAMETER_CACHE ,
case  when n.IS_NEED_PARAMETER_CACHE is null then 0 else  n.IS_NEED_PARAMETER_CACHE end as COL_IS_NEED_PARAMETER_CACHE,
case  when t.IS_SHOW_SERIAL_NUMBER is null then 0 else t.IS_SHOW_SERIAL_NUMBER end as IS_SHOW_SERIAL_NUMBER,
n.COLUMN_ORDER
from UDP_COMPONENT c 
left join UDP_COMPONENT_TABLE_COLUMN n on c.ID=n.component_table_id
left join UDP_COMPONENT_TREE_TABLE  t on c.ID=t.ID
left join UDP_COMPONENT_DATA_SOURCE  d on d.ID=c.COMPONENT_DATA_SOURCE_ID
where c.page_id=containerGuid and lower(c.component_type)='templatetreetable'
and n.STATE=1) tab
order by COLUMN_ORDER asc;



open buttoneEvent for
SELECT
    e.COMPONENT_BUTTON_ID,                                 --按钮组件ID
    b.TRADE_ID,                                                               --权限点ID
    b.icon,                                                                         --按钮图标
    e.EVENT_TYPE ,                                                          --按钮事件类型
    e.EXECUTE_TYPE ,                                                      --按钮执行类型
    e.EXECUTE_CONTENT,                                              --按钮执行内容
    e.DIALOG_TITLE,                                                        --点击弹窗标题
    e.DIALOG_CONTEN,                                                   --点击弹窗内容
    e.WINDOW_WIDTH,                                                   --打开弹窗的宽度
    e.WINDOW_HEIGHT,                                                   --打开弹窗的高度
case  when e.IS_NEED_PARAMETER_CACHE is null then 0 else  e.IS_NEED_PARAMETER_CACHE end  as IS_NEED_PARAMETER_CACHE
FROM
    UDP_COMPONENT c 
    left join UDP_COMPONENT_BUTTON_EVENT e  on c.ID=e.COMPONENT_BUTTON_ID
    left join udp_component_button b  on c.ID=b.ID
    where c.PAGE_ID=containerGuid and  e.COMPONENT_BUTTON_ID  is not null;

open eventMonitoring for
select 
m.ID,                                                                              --事件监听主键
m.COMPONENT_ID ,                                                   --组件ID
m.TARGET_COMPONENT_ID ,                                   --被监听组件ID
c.COMPONENT_TYPE ,                                                --组件类型
m.IS_MUST_MONITORING   from UDP_EVENT_MONITORING m 
left join UDP_COMPONENT c on m.TARGET_COMPONENT_ID=c.ID
where m.component_id in (select  c.ID   from UDP_COMPONENT c where  c.PAGE_ID=containerGuid);

open datePicker for
select 
c.ID componentId,                                                     --组件ID
d.START_TIME,                                                           --开始时间
d.END_TIME,                                                               --结束时间
d.DEFAULT_VALUE,                                                   --默认时间
d.VALUE_FORMAT                                                    --时间格式
from  UDP_COMPONENT c 
left join UDP_COMPONENT_DATE_PICKER d on c.ID=d.ID
where  c.PAGE_ID=containerGuid and (lower(c.component_type)='templatedatepicker' or lower(c.component_type)='templatedatetimepicker' );
END P_UDP_COMPONENT_BY_PAGE;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_COMPONENT_BY_TABLE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_UDP_COMPONENT_BY_TABLE" (componentId in varchar,componentInfo OUT sys_refcursor,tableAttributes OUT sys_refcursor)
AS
haspage INTEGER;
BEGIN
open componentInfo for
select   c.ID componentId,                                                      --组件ID
c.COMPONENT_HIGH componentHeight,                          --组件高度
c.COMPONENT_WIDE componentWidth,                            --组件宽度
''  pageTitle,                                                                              --页面标题
''  windowWidth,                                                                       --打开窗口宽度
'' windowHeight,                                                                       --打开窗口高度
c.COMPONENT_ORDER ,                                                         --展示顺序
c.COMPONENT_NAME componentName,                           --组件名称
c.COMPONENT_LABLE lable,                                                  --组件展示标题
c.COMPONENT_TYPE componentType,                               --组件类型
c.PLACEHOLDER placeholder,                                                --展示水印文字
'' templateName,                                                                        --模板名称
l.LAYOUT_AREA_TEMPLATE_ID regionMark,                       --使用区域标识名称
s.IS_CHECK,                                                                                --是否能够多选
s.IS_CHECKED_LAST_STAGE,                                                   --是否只能选中最末级
s.DEFAULT_VALUE ,                                                                   --默认值
s.DATA_SOURCE_TYPE,                                                             --数据源类型
s.DATA_SOURCE componentSource,                                      --组件数据源
s.PK_FIELD,                                                                                    --主键字段
s.LABLE_FIELD,                                                                              --展示字段
c.DATA_SOURCE                                                                       --展示数据(TemplateHyperText、TemplateContainer)
from UDP_COMPONENT c
left join UDP_LAYOUT l on  l.COMPONENT_ID=c.ID
left join UDP_COMPONENT_DATA_SOURCE s on c.COMPONENT_DATA_SOURCE_ID=s.ID
where c.ID=componentId;
open tableAttributes for
select
*
from
(select
n.ID,
c.ID componentId,                                                     --组件ID
n.COLUMN_LABLE,                                                     --列标题
n.COLUMN_FIELD  ,                                                    --列字段名
n.COLUMN_WIDE ,                                                     --列宽度
n.COLUMN_ALIGN ,                                                   --列对齐
n.COLUMN_FIXED ,                                                    --浮动反方向（left,right）
2 COLUMN_NUMBER_FLOAT,                               --小数字段保留几位
n.COLUMN_DATA_TYPE ,                                         --数据类型
n.is_show_total,                                                          --是否显示合计
n.parent_column_id,                                                  --父级列主键
n.is_use_sort,                                                              --是否使用排序
d.IS_CHECK,                                                                 --是否复选
t.detail_url,                                                                   --双击行跳转地址
d.PK_FIELD,                                                                  --主键字段
n.JUMP_URL,                                                               --点击列跳转地址
n.OPEN_MODE,                                                           --点击列打开页面方式
t.OPEN_MODE DETAIL_MODE,                                          --双击行打开页面方式
n.WINDOW_WIDTH,                                                   --单击列打开弹窗的宽度
n.WINDOW_HEIGHT,                                                   --单击列打开弹窗的高度
n.DEAL_WITH_MODE,                                                  --单击列处理的模式
t.WINDOW_WIDTH as ROW_WINDOW_WIDTH,                              --双击行打开弹窗的宽度
t.WINDOW_HEIGHT as ROW_WINDOW_HEIGHT,                             --双击行打开弹窗的高度
n.IS_USE_HTML,                                                                                      --是否使用html
case  when t.IS_SHOW_PAGINATION is null
then 1 else t.IS_SHOW_PAGINATION end IS_SHOW_PAGINATION,           --是否显示分页
case  when t.IS_SHOW_BORDER is null
then 1 else t.IS_SHOW_BORDER end IS_SHOW_BORDER,                   --是否显示边框
case  when t.IS_SHOW_STRIPE is null
then 1 else t.IS_SHOW_STRIPE end is_show_stripe,                    --是否显示斑马纹
1 is_default_expanded,          --是否展开所有子级
t.ENABLE_STATUS_FIELD,
t.ENABLE_DOUBLE_CLICK_FIELD,
t.DISABLE_PROMPT,
0 as IS_SHOW_EXPAND_BY_LEVEL,
0 as DEFAULT_EXPAND_LEVEL,
case  when t.IS_NEED_PARAMETER_CACHE is null then 0 else  t.IS_NEED_PARAMETER_CACHE end as IS_NEED_PARAMETER_CACHE ,
case  when n.IS_NEED_PARAMETER_CACHE is null then 0 else  n.IS_NEED_PARAMETER_CACHE end as COL_IS_NEED_PARAMETER_CACHE,
case  when t.IS_SHOW_SERIAL_NUMBER is null and lower(c.component_type)='templatetable'  then 1 when
t.IS_SHOW_SERIAL_NUMBER is null and lower(c.component_type)<>'templatetable' then 0
else t.IS_SHOW_SERIAL_NUMBER end as IS_SHOW_SERIAL_NUMBER,
n.COLUMN_ORDER
from UDP_COMPONENT c
left join UDP_COMPONENT_TABLE_COLUMN n on c.ID=n.component_table_id
left join UDP_COMPONENT_TABLE  t on c.ID=t.ID
left join UDP_COMPONENT_DATA_SOURCE  d on d.ID=c.COMPONENT_DATA_SOURCE_ID
where c.Id=componentId and lower(c.component_type)='templatetable'
and n.STATE=1
union
select
n.ID,
c.ID componentId,                                                     --组件ID
n.COLUMN_LABLE,                                                     --列标题
n.COLUMN_FIELD  ,                                                    --列字段名
n.COLUMN_WIDE ,                                                     --列宽度
n.COLUMN_ALIGN ,                                                   --列对齐
n.COLUMN_FIXED ,                                                    --浮动反方向（left,right）
2 COLUMN_NUMBER_FLOAT,                               --小数字段保留几位
n.COLUMN_DATA_TYPE ,                                         --数据类型
n.is_show_total,                                                          --是否显示合计
n.parent_column_id,                                                  --父级列主键
n.is_use_sort,                                                              --是否使用排序
d.IS_CHECK,                                                                 --是否复选
t.detail_url,                                                                   --双击行跳转地址
d.PK_FIELD,                                                                  --主键字段
n.JUMP_URL,                                                               --点击列跳转地址
n.OPEN_MODE,                                                           --点击列打开页面方式
t.OPEN_MODE DETAIL_MODE,                                          --双击行打开页面方式
n.WINDOW_WIDTH,                                                   --单击列打开弹窗的宽度
n.WINDOW_HEIGHT,                                                   --单击列打开弹窗的高度
n.DEAL_WITH_MODE,                                                  --单击列处理的模式
t.WINDOW_WIDTH as ROW_WINDOW_WIDTH,                              --双击行打开弹窗的宽度
t.WINDOW_HEIGHT as ROW_WINDOW_HEIGHT,                             --双击行打开弹窗的高度
n.IS_USE_HTML,                                                                                      --是否使用html
0 IS_SHOW_PAGINATION,                                                                    --是否显示分页
case  when t.IS_SHOW_BORDER is null
then 1 else t.IS_SHOW_BORDER end IS_SHOW_BORDER,                   --是否显示边框
case  when t.IS_SHOW_STRIPE is null
then 1 else t.IS_SHOW_STRIPE end is_show_stripe,                    --是否显示斑马纹
case  when t.IS_DEFAULT_EXPANDED is null
then 1 else t.IS_DEFAULT_EXPANDED end is_default_expanded,          --是否展开所有子级
t.ENABLE_STATUS_FIELD,
t.ENABLE_DOUBLE_CLICK_FIELD,
t.DISABLE_PROMPT,
t.IS_SHOW_EXPAND_BY_LEVEL,
t.DEFAULT_EXPAND_LEVEL,
case  when t.IS_NEED_PARAMETER_CACHE is null then 0 else  t.IS_NEED_PARAMETER_CACHE end as IS_NEED_PARAMETER_CACHE ,
case  when n.IS_NEED_PARAMETER_CACHE is null then 0 else  n.IS_NEED_PARAMETER_CACHE end as COL_IS_NEED_PARAMETER_CACHE,
case  when t.IS_SHOW_SERIAL_NUMBER is null then 0 else t.IS_SHOW_SERIAL_NUMBER end as IS_SHOW_SERIAL_NUMBER,
n.COLUMN_ORDER
from UDP_COMPONENT c
left join UDP_COMPONENT_TABLE_COLUMN n on c.ID=n.component_table_id
left join UDP_COMPONENT_TREE_TABLE  t on c.ID=t.ID
left join UDP_COMPONENT_DATA_SOURCE  d on d.ID=c.COMPONENT_DATA_SOURCE_ID
where c.Id=componentId and lower(c.component_type)='templatetreetable'
and n.STATE=1) tab
order by COLUMN_ORDER asc;
END P_UDP_COMPONENT_BY_TABLE;


/
--------------------------------------------------------
--  DDL for Procedure P_UDP_COMPONENT_DATA_SOURCE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_UDP_COMPONENT_DATA_SOURCE" (componentId in varchar,dataSourceInfo OUT sys_refcursor)
AS  
BEGIN  
open dataSourceInfo for  
select 
c.DATA_SOURCE ,                                                                                      --数据源配置查询语句或者存储过程标识code
c.DATA_SOURCE_TYPE ,                                                                           --数据源类型
c.PARENT_FIELD ,                                                                                       --父级字段名
c.PK_FIELD ,                                                                                                 --主键字段名
c.LABLE_FIELD,                                                                                            --展示字段名
c.CHILD_FIELD,                                                                                            --子级字段名
t.COMPONENT_TYPE
from UDP_COMPONENT t
left join UDP_COMPONENT_DATA_SOURCE c on t.COMPONENT_DATA_SOURCE_ID=c.id
where t.id=componentId;
END p_UDP_Component_Data_Source;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_CREATE_TEMP_TABLE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_UDP_CREATE_TEMP_TABLE" (temp_table_name in VARCHAR2,tablename in VARCHAR2,SQL_STR  in VARCHAR2) AUTHID current_user 
as
sqlstr VARCHAR2(4000);
sqlstr1 VARCHAR2(4000);
TABLEEXIST NUMBER;
begin
select    WMSYS.WM_CONCAT( tab.col)   into sqlstr1  from (SELECT a.column_name||'  '||a.data_type||case 
 WHEN  a.DATA_TYPE = 'NVARCHAR2' OR a.DATA_TYPE = 'VARCHAR2' or  a.DATA_TYPE ='CHAR'  THEN  '('||a.DATA_LENGTH||')' 
 WHEN  a.DATA_TYPE = 'DATE' OR a.DATA_TYPE = 'CLOB' or  a.DATA_TYPE = 'NUMBER' or   a.DATA_TYPE ='BLOB' THEN ''
 end as col
 FROM USER_TAB_COLUMNS a where a.TABLE_NAME=tablename order by a.column_id ) tab;
  select count(1) into TABLEEXIST from user_tables where table_name = upper(temp_table_name);
    if TABLEEXIST=1 then 
     execute immediate 'drop table '||upper(temp_table_name);
    end if;
 sqlstr:=' create global temporary table '||upper(temp_table_name)||'(';
 sqlstr:=sqlstr||sqlstr1||') on commit delete rows';
 --创建临时表
  execute immediate sqlstr;
--向临时表中导入数据
  if  SQL_STR is not null
  then
  execute immediate ' insert into  '||temp_table_name||' '||SQL_STR;
  end if;
end P_UDP_CREATE_TEMP_TABLE;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_DATA_SOURCE_BY_CODE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_UDP_DATA_SOURCE_BY_CODE" (code in varchar,dataSourceInfo OUT sys_refcursor)
AS  
pcode VARCHAR2(1000);
rowcountByCode int;
rowcountBySource int;
BEGIN  
pcode:=code;
select count(1) into rowcountByCode  from  UDP_COMPONENT_DATA_SOURCE c 
where c.CODE=pcode ;
select count(1) into rowcountBySource  from  UDP_COMPONENT_DATA_SOURCE c 
where c.DATA_SOURCE=pcode ;
if rowcountBySource<>0 THEN
open dataSourceInfo for  
select 
c.DATA_SOURCE ,                                                                                      --数据源配置查询语句或者存储过程标识code
c.DATA_SOURCE_TYPE ,                                                                            --数据源类型
c.PARENT_FIELD ,                                                                                       --父级字段名
c.PK_FIELD ,                                                                                                 --主键字段名
c.LABLE_FIELD,                                                                                            --展示字段名
c.CHILD_FIELD                                                                                             --子级字段名
from  UDP_COMPONENT_DATA_SOURCE c 
where c.DATA_SOURCE=pcode and rownum = 1;
ELSIF rowcountByCode<>0 then
open dataSourceInfo for  
select 
c.DATA_SOURCE ,                                                                                      --数据源配置查询语句或者存储过程标识code
c.DATA_SOURCE_TYPE ,                                                                            --数据源类型
c.PARENT_FIELD ,                                                                                       --父级字段名
c.PK_FIELD ,                                                                                                 --主键字段名
c.LABLE_FIELD,                                                                                            --展示字段名
c.CHILD_FIELD                                                                                             --子级字段名
from  UDP_COMPONENT_DATA_SOURCE c 
where c.CODE=pcode and rownum = 1;
else 
open dataSourceInfo for  
SELECT pcode as  DATA_SOURCE,
'procedure' as  DATA_SOURCE_TYPE,
'' as PARENT_FIELD,
'' as PK_FIELD,
'' as LABLE_FIELD,
'' as CHILD_FIELD
from dual;
end if;
END p_UDP_Data_Source_By_Code;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_DATA_SOURCE_BY_PAGE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_UDP_DATA_SOURCE_BY_PAGE" (
    p_pagesql  IN CLOB,                  --sql
    p_curPage  IN  NUMBER ,         --当前页
    p_pageSize IN NUMBER ,         --每页显示记录的条数
    total OUT NUMBER,                   --总记录数
    items OUT SYS_REFCURSOR     -- 输出结果集游标
  )
AS
  v_sql    CLOB;                                  --sql语句
  v_startRecord NUMBER;             --开始显示的记录数
  v_endRecord   NUMBER;             --结束显示的记录条数
BEGIN
                                                            --记录总记录条数
  v_sql:= 'select count(*) FROM (' || p_pagesql || ')';
  EXECUTE IMMEDIATE v_sql INTO total;
                                                            --实现分页查询
  v_startRecord :=(p_curPage - 1) * p_pageSize + 1;
  v_endRecord   :=p_curPage  * p_pageSize;
  v_sql         :='select * from (SELECT t.*, ROWNUM RN from (' || p_pagesql || ') t where rownum<=' || v_endRecord || ' ) where RN>=' ||v_startRecord;

  OPEN items FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE items;
END p_UDP_Data_Source_By_Page;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_DELETE_SQL_BY_EXCELID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_UDP_DELETE_SQL_BY_EXCELID" (CODE in VARCHAR2, EXPORT_SQL_LIST OUT SYS_REFCURSOR)  AUTHID current_user 
as
str_sql VARCHAR2(4000);
TEMP_TABLE_NAME VARCHAR2(200);
TABLE_NAME VARCHAR2(200);
SQL_STR VARCHAR2(4000);
EXPORT_SQL CLOB :='';
row_index NUMBER;
ROW_COUNT NUMBER;
TABLEEXIST NUMBER;
begin
    row_index:=1;
     str_sql := 'create global temporary table EXPORT_SQL_TABLE  (
        ID INT,
        TABLE_NAME VARCHAR(1000),
        SQL  VARCHAR(4000)
     ) 
    on commit preserve rows';
    --判断临时表是否存在存在就删除
    select count(1) into TABLEEXIST from user_tables where table_name = 'EXPORT_SQL_TABLE';
    if TABLEEXIST=0 then 
     --创建临时表
    execute immediate str_sql;
    else 
    execute immediate 'delete EXPORT_SQL_TABLE';
    end if;

  insert into EXPORT_SQL_TABLE VALUES(row_index,'','set define off;');
/*=================================删除字段信息配置=================================================*/
  TABLE_NAME:= 'UDP_EXPORT_FIELD';
  SQL_STR:=' select * from UDP_EXPORT_FIELD where id in (select EXPORT_FIELD_ID from  UDP_EXPORT_SHEET_FIELD where EXPORT_SHEET_ID='''||CODE||'''';
  SQL_STR:=SQL_STR||'UNION select EXPORT_FIELD_ID from  UDP_EXPORT_SHEET_FIELD where  EXPORT_SHEET_ID in (select Id from UDP_EXPORT_SHEET where EXCEL_ID='''||CODE||'''))';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除字段信息配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*=================================删除sheet配置字段信息配置=================================================*/
  TABLE_NAME:= 'UDP_EXPORT_SHEET_FIELD';
  SQL_STR:=' select * from UDP_EXPORT_SHEET_FIELD where EXPORT_SHEET_ID='''||CODE||''' UNION select * from UDP_EXPORT_SHEET_FIELD where EXPORT_SHEET_ID in (select ID from UDP_EXPORT_SHEET where EXCEL_ID='''||CODE||''' )';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除sheet配置字段信息配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*=================================删除sheet配置信息配置=================================================*/
  TABLE_NAME:= 'UDP_EXPORT_SHEET';
  SQL_STR:=' select * from UDP_EXPORT_SHEET where ID='''||CODE||''' UNION select * from UDP_EXPORT_SHEET where EXCEL_ID='''||CODE||''' ';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除sheet配置信息配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*=================================删除excel配置信息配置=================================================*/
  TABLE_NAME:= 'UDP_EXPORT_EXCEL';
  SQL_STR:='select * from UDP_EXPORT_EXCEL where ID='''||CODE||''' ';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除excel配置信息配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
  /*=================================查询导出的sql语句信息=================================================*/
  open EXPORT_SQL_LIST for 'select SQL from EXPORT_SQL_TABLE order by ID';
  commit;
end  P_UDP_DELETE_SQL_BY_EXCELID;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_DELETE_SQL_BY_PAGEID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_UDP_DELETE_SQL_BY_PAGEID" (PAGEID in VARCHAR2, EXPORT_SQL_LIST OUT SYS_REFCURSOR  )  AUTHID current_user 
as
str_sql VARCHAR2(4000);
SQL_STR CLOB :='';
row_index NUMBER;
TABLEEXIST NUMBER;
TABLE_NAME VARCHAR2(4000);
ROW_COUNT NUMBER;
SELECT_COMPONENT_BY_PAGEID CLOB :='';
BEGIN
 row_index:=1;
    str_sql := 'create global temporary table EXPORT_SQL_TABLE  (
        ID INT,
        TABLE_NAME VARCHAR(1000),
        SQL  VARCHAR(4000)
     ) 
    on commit preserve rows';
    --判断临时表是否存在不存在就创建
    select count(1) into TABLEEXIST from user_tables where table_name = 'EXPORT_SQL_TABLE';
    if TABLEEXIST=0 then 
      --创建临时表
      execute immediate str_sql;
    else
     --删除临时表数据
      execute immediate 'delete  EXPORT_SQL_TABLE';
    end if;
  insert into EXPORT_SQL_TABLE  VALUES(row_index,'','set define off;');
  SQL_STR:='select * from udp_component where  page_id='''||PAGEID||''' UNION select * from udp_component where  page_id in ';
  SQL_STR:=SQL_STR||'(select ID from UDP_COMPONENT_TABS_ITEM where component_tabs_id in  (select id from udp_component where  page_id='''||PAGEID||''' and component_type=''TemplateTabs''))';
  SQL_STR:=SQL_STR||' UNION ';
  SQL_STR:=SQL_STR||' select * from udp_component WHERE page_id IN (select ID from (select * from udp_component where page_id='''||PAGEID||''' ';
  SQL_STR:=SQL_STR||' UNION  ';
  SQL_STR:=SQL_STR||' select * from udp_component where  page_id in ';
  SQL_STR:=SQL_STR||' (select ID from UDP_COMPONENT_TABS_ITEM where component_tabs_id in  ';
  SQL_STR:=SQL_STR||'(select id from udp_component where  page_id='''||PAGEID||''' and component_type=''TemplateTabs''))) tab1';
  SQL_STR:=SQL_STR||' where tab1.COMPONENT_TYPE=''TemplateDropdown'')';
  SELECT_COMPONENT_BY_PAGEID:='select t.ID from ('||SQL_STR||') t';
/*==================================删除 UDP_EXPORT_FIELD 表字段配置================================================*/
  TABLE_NAME:= 'UDP_EXPORT_FIELD';
  SQL_STR:=' select * from '||TABLE_NAME||' where ID in (select EXPORT_FIELD_ID from UDP_EXPORT_SHEET_FIELD where  EXPORT_SHEET_ID in（select ID from  UDP_EXPORT_SHEET  where EXCEL_ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') )';
  SQL_STR:=SQL_STR||' UNION select ID from  UDP_EXPORT_SHEET  where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') ) ) )';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除字段配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_EXPORT_SHEET_FIELD 表sheet导出字段配置================================================*/
  TABLE_NAME:= 'UDP_EXPORT_SHEET_FIELD';
   SQL_STR:=' select * from '||TABLE_NAME||' where  EXPORT_SHEET_ID in（select ID from  UDP_EXPORT_SHEET  where EXCEL_ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') )';
  SQL_STR:=SQL_STR||' UNION select ID from  UDP_EXPORT_SHEET  where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') ) )';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除sheet导出字段配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_EXPORT_SHEET 表excel导出sheet配置================================================*/
  TABLE_NAME:= 'UDP_EXPORT_SHEET';
  SQL_STR:=' select * from  '||TABLE_NAME||' where EXCEL_ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') )';
  SQL_STR:=SQL_STR||' UNION  select * from '||TABLE_NAME||' where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') ) ';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除excel导出sheet配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_EXPORT_EXCEL 表excel导出配置================================================*/
  TABLE_NAME:= 'UDP_EXPORT_EXCEL';
  SQL_STR:=' select * from  '||TABLE_NAME||' where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') )';
  SQL_STR:=SQL_STR||' UNION  select * from '||TABLE_NAME||' where ID in  (select EXCEL_ID from  UDP_EXPORT_SHEET  where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') ) )';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除excel导出配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
  /*==================================删除 UDP_LAYOUT 表组件布局配置================================================*/
  TABLE_NAME:= 'UDP_LAYOUT';
  SQL_STR:='  select * from '||TABLE_NAME||' where COMPONENT_ID  in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除组件布局配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_EVENT_MONITORING 表组件监听配置================================================*/
 TABLE_NAME:= 'UDP_EVENT_MONITORING';
  SQL_STR:='  select *  from '||TABLE_NAME||' where component_id in ('||SELECT_COMPONENT_BY_PAGEID||') and TARGET_COMPONENT_ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除组件监听配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_DATE_PICKER 表存储过程参数配置================================================*/
  TABLE_NAME:= 'UDP_PROCEDURE_PARAMETER';
    SQL_STR:='select r.* from UDP_PROCEDURE_REGISTRATION r where r.code in (select s.data_source from  (select component_data_source_id from UDP_COMPONENT where ID  in   ('||SELECT_COMPONENT_BY_PAGEID||') ';
    SQL_STR:=SQL_STR||' and component_data_source_id is not null) d left join UDP_COMPONENT_DATA_SOURCE s on d.component_data_source_id=s.id where s.data_source_type=''procedure'') ';
    SQL_STR:=SQL_STR|| ' UNION ';
    SQL_STR:=SQL_STR||'select  r.* from ( select  case when instr(s.data_source,''?'',1,1) <>0 then  substr(s.data_source,instr(s.data_source,''?'',1,1)+1)||''&''  end conten ';
    SQL_STR:=SQL_STR||'from  (select component_data_source_id from UDP_COMPONENT where ID in  ('||SELECT_COMPONENT_BY_PAGEID||') ';
    SQL_STR:=SQL_STR||'and component_data_source_id is not null) d left join UDP_COMPONENT_DATA_SOURCE s on d.component_data_source_id=s.id ';
    SQL_STR:=SQL_STR||'where s.data_source LIKE ''/api/udp/getExecuteProcedureResult%'' or  s.data_source LIKE ''/api/udp/getRegisterResult%'' or  s.data_source LIKE ''/api/public/udp/getRegisterResult%'' )tab , UDP_PROCEDURE_REGISTRATION r ';
    SQL_STR:=SQL_STR||'where tab.conten like ''%code=''||r.code||''&%'' ';
    SQL_STR:=SQL_STR||' UNION ';
    SQL_STR:=SQL_STR||'select  r.*  from (select case when instr(EXECUTE_CONTENT,''?'',1,1) <>0 then  substr(EXECUTE_CONTENT,instr(EXECUTE_CONTENT,''?'',1,1)+1)||''&''  end conten   from UDP_COMPONENT_BUTTON_EVENT where COMPONENT_BUTTON_ID in   ('||SELECT_COMPONENT_BY_PAGEID||') ';
    SQL_STR:=SQL_STR||'and EXECUTE_CONTENT LIKE ''/api/udp/getExecuteProcedureResult%'' or  EXECUTE_CONTENT LIKE ''/api/udp/getRegisterResult%'' or  EXECUTE_CONTENT LIKE ''/api/public/udp/getRegisterResult%'' ) tab, UDP_PROCEDURE_REGISTRATION r ';
    SQL_STR:=SQL_STR||'where tab.conten like ''%code=''||r.code||''&%'' ';
  SQL_STR:='select * from '||TABLE_NAME||' where PROCEDURE_REGISTRATION_ID in ('||' select ID  from ('||SQL_STR||') '||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除存储过程参数配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_PROCEDURE_REGISTRATION 表存储过程配置================================================*/
  TABLE_NAME:= 'UDP_PROCEDURE_REGISTRATION';
    SQL_STR:='select r.* from UDP_PROCEDURE_REGISTRATION r where r.code in (select s.data_source from  (select component_data_source_id from UDP_COMPONENT where ID  in   ('||SELECT_COMPONENT_BY_PAGEID||') ';
    SQL_STR:=SQL_STR||' and component_data_source_id is not null) d left join UDP_COMPONENT_DATA_SOURCE s on d.component_data_source_id=s.id where s.data_source_type=''procedure'') ';
    SQL_STR:=SQL_STR|| ' UNION ';
    SQL_STR:=SQL_STR||'select  r.* from ( select  case when instr(s.data_source,''?'',1,1) <>0 then  substr(s.data_source,instr(s.data_source,''?'',1,1)+1)||''&''  end conten ';
    SQL_STR:=SQL_STR||'from  (select component_data_source_id from UDP_COMPONENT where ID in  ('||SELECT_COMPONENT_BY_PAGEID||') ';
    SQL_STR:=SQL_STR||'and component_data_source_id is not null) d left join UDP_COMPONENT_DATA_SOURCE s on d.component_data_source_id=s.id ';
    SQL_STR:=SQL_STR||'where s.data_source LIKE ''/api/udp/getExecuteProcedureResult%'' or  s.data_source LIKE ''/api/udp/getRegisterResult%'' or  s.data_source LIKE ''/api/public/udp/getRegisterResult%'' )tab , UDP_PROCEDURE_REGISTRATION r ';
    SQL_STR:=SQL_STR||'where tab.conten like ''%code=''||r.code||''&%'' ';
    SQL_STR:=SQL_STR||' UNION ';
    SQL_STR:=SQL_STR||'select  r.*  from (select case when instr(EXECUTE_CONTENT,''?'',1,1) <>0 then  substr(EXECUTE_CONTENT,instr(EXECUTE_CONTENT,''?'',1,1)+1)||''&''  end conten   from UDP_COMPONENT_BUTTON_EVENT where COMPONENT_BUTTON_ID in   ('||SELECT_COMPONENT_BY_PAGEID||') ';
    SQL_STR:=SQL_STR||'and EXECUTE_CONTENT LIKE ''/api/udp/getExecuteProcedureResult%'' or  EXECUTE_CONTENT LIKE ''/api/udp/getRegisterResult%'' or  EXECUTE_CONTENT LIKE ''/api/public/udp/getRegisterResult%'' ) tab, UDP_PROCEDURE_REGISTRATION r ';
    SQL_STR:=SQL_STR||'where tab.conten like ''%code=''||r.code||''&%'' ';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除存储过程配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_DATA_SOURCE 表数据源配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_DATA_SOURCE';
  SQL_STR:='select s.*  FROM udp_component c RIGHT join udp_component_data_source s on c.component_data_source_id=s.id where c.id in ('||SELECT_COMPONENT_BY_PAGEID||') UNION ';
  SQL_STR:=SQL_STR||'select s.*  from (SELECT case when instr(s.data_source,''?'',1,1) <>0 then  substr(s.data_source,instr(s.data_source,''?'',1,1)+1)||''&''  end conten  FROM udp_component c RIGHT join udp_component_data_source s on c.component_data_source_id=s.id where c.id in (';
  SQL_STR:=SQL_STR||SELECT_COMPONENT_BY_PAGEID||')';
  SQL_STR:=SQL_STR||' and  s.data_source LIKE ''/api/udp/getDataSource%'')  tab,udp_component_data_source s where  tab.conten   like ''%code=''||s.code||''&%'' ';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除数据源配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_BUTTON_EVENT 表按钮组件事件配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_BUTTON_EVENT';
  SQL_STR:=' select *  from '||TABLE_NAME||' where COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除按钮组件事件配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_BUTTON 表按钮组件配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_BUTTON';
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除按钮组件配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_TABLE_COLUMN 表table列表组件配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_TABLE_COLUMN';
  SQL_STR:=' select *  from '||TABLE_NAME||' where COMPONENT_TABLE_ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除table组件列配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_TABLE 表table列表组件配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_TABLE';
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除table列表组件配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_TREE_SELECT 表tree-select组件配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_TREE_SELECT';
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除tree-select组件配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_DATE_PICKER 表时间选择器组件配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_DATE_PICKER';
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除时间选择器组件配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_TABS_ITEM 表tabs组件items配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_TABS_ITEM';
  SQL_STR:=' select *  from '||TABLE_NAME||' where COMPONENT_TABS_ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除tabs组件items配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_TABS 表tabs组件配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_TABS';
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除tabs组件配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_PAGE 表配置================================================*/
  TABLE_NAME:= 'UDP_PAGE';
  SQL_STR:='  select * from '||TABLE_NAME||' where ID='''||PAGEID||'''';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除页面配置');
    row_index:=row_index+1;
     insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT 表组件配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT';
  SQL_STR:='select * from udp_component where  page_id='''||PAGEID||''' UNION select * from udp_component where  page_id in ';
  SQL_STR:=SQL_STR||'(select ID from UDP_COMPONENT_TABS_ITEM where component_tabs_id in  (select id from udp_component where  page_id='''||PAGEID||''' and component_type=''TemplateTabs''))';
  SQL_STR:=SQL_STR||' UNION ';
  SQL_STR:=SQL_STR||' select * from udp_component WHERE page_id IN (select ID from (select * from udp_component where page_id='''||PAGEID||''' ';
  SQL_STR:=SQL_STR||' UNION  ';
  SQL_STR:=SQL_STR||' select * from udp_component where  page_id in ';
  SQL_STR:=SQL_STR||' (select ID from UDP_COMPONENT_TABS_ITEM where component_tabs_id in  ';
  SQL_STR:=SQL_STR||'(select id from udp_component where  page_id='''||PAGEID||''' and component_type=''TemplateTabs''))) tab1';
  SQL_STR:=SQL_STR||' where tab1.COMPONENT_TYPE=''TemplateDropdown'')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除组件配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*=================================查询导出的sql语句信息=================================================*/
open EXPORT_SQL_LIST for 'select SQL from EXPORT_SQL_TABLE order by ID';
END P_UDP_DELETE_SQL_BY_PAGEID;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_DELETE_SQL_BY_PROCODE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_UDP_DELETE_SQL_BY_PROCODE" (CODE in VARCHAR2, EXPORT_SQL_LIST OUT SYS_REFCURSOR)  AUTHID current_user 
as
str_sql VARCHAR2(4000);
TEMP_TABLE_NAME VARCHAR2(200);
TABLE_NAME VARCHAR2(200);
SQL_STR VARCHAR2(4000);
EXPORT_SQL CLOB :='';
row_index NUMBER;
ROW_COUNT NUMBER;
TABLEEXIST NUMBER;
begin
    row_index:=1;
     str_sql := 'create global temporary table EXPORT_SQL_TABLE  (
        ID INT,
        TABLE_NAME VARCHAR(1000),
        SQL  VARCHAR(4000)
     ) 
    on commit preserve rows';
    --判断临时表是否存在存在就删除
    select count(1) into TABLEEXIST from user_tables where table_name = 'EXPORT_SQL_TABLE';
    if TABLEEXIST=0 then 
     --创建临时表
    execute immediate str_sql;
    else 
    execute immediate 'delete EXPORT_SQL_TABLE';
    end if;

  insert into EXPORT_SQL_TABLE VALUES(row_index,'','set define off;');
/*=================================删除存储过程参数信息配置=================================================*/
  TABLE_NAME:= 'UDP_PROCEDURE_PARAMETER';
  SQL_STR:=' select * from '||TABLE_NAME||' WHERE PROCEDURE_REGISTRATION_ID IN (select ID from UDP_PROCEDURE_REGISTRATION where CODE='''||CODE||''' and  STATE=1)';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除存储过程参数信息配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*=================================删除存储过程注册信息配置=================================================*/
  TABLE_NAME:= 'UDP_PROCEDURE_REGISTRATION';
  SQL_STR:='  select * from '||TABLE_NAME||' where CODE='''||CODE||'''  and  STATE=1';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除存储过程注册信息配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
  /*=================================查询导出的sql语句信息=================================================*/
  open EXPORT_SQL_LIST for 'select SQL from EXPORT_SQL_TABLE order by ID';
  commit;
end  P_UDP_DELETE_SQL_BY_PROCODE;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_EXPORT_BY_CODE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_UDP_EXPORT_BY_CODE" (
    code in VARCHAR2,
    sheetField OUT sys_refcursor
)
AS
    rowcountByExcelId    int;
    rowcountByDataSource int;
BEGIN
    select count(1)
    into rowcountByExcelId
    from UDP_EXPORT_EXCEL e
    where e.id = code;
    if rowcountByExcelId <> 0 THEN
        open sheetField for
            select t1.*
            from (
                     select level, connect_by_isleaf, m.*
                     from (
                              SELECT e.id        as excel_id,
                                     e.file_name,
                                     s.id        as sheet_id,
                                     data_source,
                                     name,
                                     excel_title,
                                     ROW_BG_COLOR_FIELD,
                                     header_bg_color,
                                     header_font_color,
                                     sheet_order,
                                     t.FIELD_ORDER ,
                                     f.id,
                                     f.lable,
                                     f.field,
                                     f.wide,
                                     f.align,
                                     f.data_type,
                                     f.is_show_total,
                                     f.TEXT_ALIGN,
                                     t.IS_FIXED,
                                     t.IS_SHOW,
                                     t.COLUMN_BG_COLOR,
                                     s.IS_USE_ROW_COLLAPSE,
                                     f.parent_id as PARENT_COLUMN_ID,
                                     s.IS_COLUMN_HEAD_FLOAT,
		     s.IS_DEFAULT_COLLAPSE_ROW
                              FROM udp_export_sheet s
                                       left join UDP_EXPORT_EXCEL e on s.excel_id = e.id
                                       left join UDP_EXPORT_SHEET_FIELD t on s.Id = t.export_sheet_id
                                       left join UDP_EXPORT_FIELD f on t.export_field_id = f.id
                              where e.id = code
                                and t.state = 1) m
                     start with m.PARENT_COLUMN_ID is null --开始条件
                     connect by prior m.id = m.PARENT_COLUMN_ID
                 ) t1 order by FIELD_ORDER;
    else
        select count(1)
        into rowcountByDataSource
        from udp_export_sheet s
        where s.id = code;
        if rowcountByDataSource <> 0 THEN
            open sheetField for
                select t1.*
                from (
                         select level, connect_by_isleaf, m.*
                         from (
                                  SELECT e.id        as excel_id,
                                         e.file_name,
                                         s.id        as sheet_id,
                                         data_source,
                                         name,
                                         excel_title,
                                         ROW_BG_COLOR_FIELD,
                                         header_bg_color,
                                         header_font_color,
                                         sheet_order,
                                         t.FIELD_ORDER,
                                         f.id,
                                         f.lable,
                                         f.field,
                                         f.wide,
                                         f.align,
                                         f.data_type,
                                         f.is_show_total,
                                         f.TEXT_ALIGN,
                                         t.IS_FIXED,
                                         t.IS_SHOW,
                                         t.COLUMN_BG_COLOR,
                                         s.IS_USE_ROW_COLLAPSE,
                                         f.parent_id as PARENT_COLUMN_ID,
                                         s.IS_COLUMN_HEAD_FLOAT,
		         s.IS_DEFAULT_COLLAPSE_ROW
                                  FROM udp_export_sheet s
                                           left join UDP_EXPORT_EXCEL e on s.excel_id = e.id
                                           left join UDP_EXPORT_SHEET_FIELD t on s.Id = t.export_sheet_id
                                           left join UDP_EXPORT_FIELD f on t.export_field_id = f.id
                                  where s.id = code
                                    and t.state = 1) m
                         start with m.PARENT_COLUMN_ID is null --开始条件
                         connect by prior m.id = m.PARENT_COLUMN_ID
                     ) t1 order by FIELD_ORDER;
        end if;
    end if;
END P_UDP_EXPORT_BY_CODE;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_EXPORT_SQL_BY_EXCELID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_UDP_EXPORT_SQL_BY_EXCELID" (EXCELID in VARCHAR2, EXPORT_SQL_LIST OUT SYS_REFCURSOR)  AUTHID current_user
as
str_sql VARCHAR2(4000);
TEMP_TABLE_NAME VARCHAR2(200);
TABLE_NAME VARCHAR2(200);
SQL_STR VARCHAR2(4000);
EXPORT_SQL CLOB :='';
row_index NUMBER;
TABLEEXIST NUMBER;
ROW_COUNT NUMBER;
begin
    row_index:=1;
    str_sql := 'create global temporary table EXPORT_SQL_TABLE  (
        ID INT,
        TABLE_NAME VARCHAR(1000),
        SQL  VARCHAR(4000)
     )
    on commit preserve rows';
    --判断临时表是否存在不存在就创建
    select count(1) into TABLEEXIST from user_tables where table_name = 'EXPORT_SQL_TABLE';
    if TABLEEXIST=0 then
      --创建临时表
      execute immediate str_sql;
    else
     --删除临时表数据
      execute immediate 'delete  EXPORT_SQL_TABLE';
    end if;
  execute immediate 'select count(1) from UDP_EXPORT_EXCEL where id='''||EXCELID||''' '  INTO  ROW_COUNT;
  insert into EXPORT_SQL_TABLE VALUES(row_index,'','set define off;');
/*=================================EXCEL导出文件信息配置=================================================*/
 --需要导出的表名
  TABLE_NAME := 'UDP_EXPORT_EXCEL';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
--查询语句
   if ROW_COUNT = 1  then
   SQL_STR:='  select * from '||TABLE_NAME||' where ID='''||EXCELID||'''  ';

   end if;
    if ROW_COUNT = 0  then
    SQL_STR:='  select * from '||TABLE_NAME||' where ID in (SELECT EXCEL_ID FROM UDP_EXPORT_SHEET WHERE  ID= '''||EXCELID||''') ';
   end if;

--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--EXCEL导出文件信息初始化',
    SQL_STR => EXPORT_SQL
  );
    --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================EXCEL导出工作簿信息配置=================================================*/
  select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_EXPORT_SHEET';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  --查询页面显示组件的id的集合
   if ROW_COUNT = 1  then
     SQL_STR:=' select * from '||TABLE_NAME||' WHERE EXCEL_ID ='''||EXCELID||''' ';
   end if;
    if ROW_COUNT = 0  then
    SQL_STR:='  select * from '||TABLE_NAME||' where ID ='''||EXCELID||''' ';
   end if;

--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--EXCEL导出工作簿信息初始化' ,
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
 /*=================================EXCEL导出工作簿关联表字段信息配置=================================================*/
  select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_EXPORT_SHEET_FIELD';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_EXPORT_SHEET_FIELD';
   if ROW_COUNT = 1  then
   SQL_STR:='select * from '||TABLE_NAME||'  where EXPORT_SHEET_ID in (select ID from UDP_EXPORT_SHEET WHERE EXCEL_ID ='''||EXCELID||''' )';
   end if;
    if ROW_COUNT = 0  then
    SQL_STR:='select * from '||TABLE_NAME||'  where EXPORT_SHEET_ID ='''||EXCELID||''' ';
   end if;

--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--EXCEL导出工作簿关联表字段信息初始化' ,
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
 /*=================================EXCEL导出字段信息配置=================================================*/
  select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_EXPORT_FIELD';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  --查询页面显示组件的id的集合
   if ROW_COUNT = 1  then
     SQL_STR:='select * from '||TABLE_NAME||' where ID in (select  EXPORT_FIELD_ID  from UDP_EXPORT_SHEET_FIELD  where EXPORT_SHEET_ID in (select ID from UDP_EXPORT_SHEET WHERE EXCEL_ID ='''||EXCELID||''' ))';
   end if;
    if ROW_COUNT = 0  then
     SQL_STR:='select * from '||TABLE_NAME||' where ID in (select  EXPORT_FIELD_ID  from UDP_EXPORT_SHEET_FIELD  where EXPORT_SHEET_ID  ='''||EXCELID||''' )';
   end if;

--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--EXCEL导出字段信息初始化' ,
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
 /*=================================EXCEL导出数据源信息配置=================================================*/
  select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_DATA_SOURCE';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  --查询页面显示组件的id的集合
   if ROW_COUNT = 1  then
     SQL_STR:=' select '||TABLE_NAME||'.* from '||TABLE_NAME||' inner join (select data_source from UDP_EXPORT_SHEET where EXCEL_ID='''||EXCELID||''') sourceids on  '||TABLE_NAME||'.id=sourceids.data_source  ';
   end if;
    if ROW_COUNT = 0  then
     SQL_STR:=' select '||TABLE_NAME||'.* from '||TABLE_NAME||' inner join (select data_source from UDP_EXPORT_SHEET where ID='''||EXCELID||''') sourceids on  '||TABLE_NAME||'.id=sourceids.data_source  ';
   end if;
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--EXCEL导出数据源信息初始化' ,
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
 /*=================================EXCEL导出数据源存储过程配置=================================================*/
  select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_PROCEDURE_REGISTRATION';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_PROCEDURE_REGISTRATION';
  --查询页面显示组件的id的集合
   if ROW_COUNT = 1  then
     SQL_STR:='select '||TABLE_NAME||'.* from '||TABLE_NAME||' inner join (select UDP_COMPONENT_DATA_SOURCE.DATA_SOURCE from UDP_COMPONENT_DATA_SOURCE inner join (select data_source from UDP_EXPORT_SHEET where EXCEL_ID='''||EXCELID||''') sourceids
     on UDP_COMPONENT_DATA_SOURCE.id=sourceids.data_source where UDP_COMPONENT_DATA_SOURCE.DATA_SOURCE_TYPE=''procedure'') PROCCodes
     on '||TABLE_NAME||'.code=PROCCodes.DATA_SOURCE ';
   end if;
    if ROW_COUNT = 0  then
    SQL_STR:='select '||TABLE_NAME||'.* from '||TABLE_NAME||' inner join (select UDP_COMPONENT_DATA_SOURCE.DATA_SOURCE from UDP_COMPONENT_DATA_SOURCE inner join (select data_source from UDP_EXPORT_SHEET where ID='''||EXCELID||''') sourceids
     on UDP_COMPONENT_DATA_SOURCE.id=sourceids.data_source where UDP_COMPONENT_DATA_SOURCE.DATA_SOURCE_TYPE=''procedure'') PROCCodes
     on '||TABLE_NAME||'.code=PROCCodes.DATA_SOURCE ';
   end if;
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--EXCEL导出数据源存储过程初始化' ,
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
 /*=================================EXCEL导出数据源存储过程参数配置=================================================*/
  select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_PROCEDURE_PARAMETER';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  --查询页面显示组件的id的集合
   if ROW_COUNT = 1  then
     SQL_STR:=' select '||TABLE_NAME||'.* from '||TABLE_NAME||' inner join (select UDP_PROCEDURE_REGISTRATION.id from UDP_PROCEDURE_REGISTRATION inner join (select UDP_COMPONENT_DATA_SOURCE.DATA_SOURCE from UDP_COMPONENT_DATA_SOURCE inner join (select data_source from UDP_EXPORT_SHEET where EXCEL_ID='''||EXCELID||''') sourceids
    on UDP_COMPONENT_DATA_SOURCE.id=sourceids.data_source where UDP_COMPONENT_DATA_SOURCE.DATA_SOURCE_TYPE=''procedure'') PROCCodes
    on UDP_PROCEDURE_REGISTRATION.code=PROCCodes.DATA_SOURCE) PROCIds
    on '||TABLE_NAME||'.PROCEDURE_REGISTRATION_ID=PROCIds.id';
   end if;
    if ROW_COUNT = 0  then
    SQL_STR:=' select '||TABLE_NAME||'.* from '||TABLE_NAME||' inner join (select UDP_PROCEDURE_REGISTRATION.id from UDP_PROCEDURE_REGISTRATION inner join (select UDP_COMPONENT_DATA_SOURCE.DATA_SOURCE from UDP_COMPONENT_DATA_SOURCE inner join (select data_source from UDP_EXPORT_SHEET where ID='''||EXCELID||''') sourceids
    on UDP_COMPONENT_DATA_SOURCE.id=sourceids.data_source where UDP_COMPONENT_DATA_SOURCE.DATA_SOURCE_TYPE=''procedure'') PROCCodes
    on UDP_PROCEDURE_REGISTRATION.code=PROCCodes.DATA_SOURCE) PROCIds
    on '||TABLE_NAME||'.PROCEDURE_REGISTRATION_ID=PROCIds.id';
   end if;
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--EXCEL导出数据源存储过程参数初始化' ,
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================查询导出的sql语句信息=================================================*/
   open EXPORT_SQL_LIST for 'select replace(replace(SQL,''''''$("time")$'',''to_date(''''''),''$("timeend")$'''''','''''',''''yyyy-mm-dd hh24:mi:ss'''')'') SQL from EXPORT_SQL_TABLE order by ID';

  commit;
end  P_UDP_EXPORT_SQL_BY_EXCELID;


/
--------------------------------------------------------
--  DDL for Procedure P_UDP_EXPORT_SQL_BY_PAGEID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_UDP_EXPORT_SQL_BY_PAGEID" (PAGEID in VARCHAR2,IS_COPY in NUMBER, EXPORT_SQL_LIST OUT SYS_REFCURSOR  )  AUTHID current_user 
as
str_sql VARCHAR2(4000);
TEMP_TABLE_NAME VARCHAR2(200);
TABLE_NAME VARCHAR2(200);
SQL_STR CLOB :='';
EXPORT_SQL CLOB :='';
row_index NUMBER;
TABLEEXIST NUMBER;
REGISTRATION_IDS VARCHAR2(4000);
SELECT_COMPONENT_BY_PAGEID VARCHAR2(4000);
SELECT_COL VARCHAR2(4000);
begin
    row_index:=1;
    str_sql := 'create global temporary table EXPORT_SQL_TABLE  (
        ID INT,
        TABLE_NAME VARCHAR(1000),
        SQL  VARCHAR(4000)
     ) 
    on commit preserve rows';
    --判断临时表是否存在不存在就创建
    select count(1) into TABLEEXIST from user_tables where table_name = 'EXPORT_SQL_TABLE';
    if TABLEEXIST=0 then 
      --创建临时表
      execute immediate str_sql;
    else
     --删除临时表数据
      execute immediate 'delete  EXPORT_SQL_TABLE';
    end if;
  insert into EXPORT_SQL_TABLE  VALUES(row_index,'','set define off;');
/*=================================导出页面配置=================================================*/
 --需要导出的表名
  TABLE_NAME := 'UDP_PAGE';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
--查询语句
  if IS_COPY=1 then
   SQL_STR:='  select ID ,LAYOUT_TEMPLATE_ID ,CREATED ,CREATOR_ID ,CREATOR ,MODIFIED ,MODIFIER_ID ,MODIFIER ,FUNCTION_ID ,TITLE ,WINDOW_WIDTH ,WINDOW_HEIGHT ,''《''||ID||''》复制配置信息'' REMARK  from '||TABLE_NAME||' where ID='''||PAGEID||'''';
  else
   SQL_STR:='  select * from '||TABLE_NAME||' where ID='''||PAGEID||'''';
  end if;
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--页面基础信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
 /*=================================导出组件配置=================================================*/
  select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  --查询页面显示组件的id的集合
    SQL_STR:='select * from udp_component where  page_id='''||PAGEID||''' UNION select * from udp_component where  page_id in ';
    SQL_STR:=SQL_STR||'(select ID from UDP_COMPONENT_TABS_ITEM where component_tabs_id in  (select id from udp_component where  page_id='''||PAGEID||''' and component_type=''TemplateTabs''))';
    SQL_STR:=SQL_STR||' UNION ';
    SQL_STR:=SQL_STR||' select * from udp_component WHERE page_id IN (select ID from (select * from udp_component where page_id='''||PAGEID||''' ';
    SQL_STR:=SQL_STR||' UNION  ';
    SQL_STR:=SQL_STR||' select * from udp_component where  page_id in ';
    SQL_STR:=SQL_STR||' (select ID from UDP_COMPONENT_TABS_ITEM where component_tabs_id in  ';
    SQL_STR:=SQL_STR||'(select id from udp_component where  page_id='''||PAGEID||''' and component_type=''TemplateTabs''))) tab1';
    SQL_STR:=SQL_STR||' where tab1.COMPONENT_TYPE=''TemplateDropdown'')';
    SELECT_COMPONENT_BY_PAGEID:='select t.ID from ('||SQL_STR||') t';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--组件基础信息初始化' ,
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出组件布局配置=================================================*/
 select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_LAYOUT';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
   SQL_STR:='  select * from '||TABLE_NAME||' where COMPONENT_ID  in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--组件布局信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出组件监听配置=================================================*/
 select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_EVENT_MONITORING';
 --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  SQL_STR:='  select *  from '||TABLE_NAME||' where component_id in ('||SELECT_COMPONENT_BY_PAGEID||') and TARGET_COMPONENT_ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--组件监听信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出按钮组件配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_BUTTON';
 --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--按钮组件基础信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出按钮组件事件配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_BUTTON_EVENT';
 --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_COMPONENT_BUTTON_EVENT';
  SQL_STR:=' select *  from '||TABLE_NAME||' where COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--按钮组件事件信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '|| EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
--/*=================================导出table列表组件事件配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_TABLE';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--table列表组件基础信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出table组件列配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_TABLE_COLUMN';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_COMPONENT_TABLE_COLUMN';
  SQL_STR:=' select *  from '||TABLE_NAME||' where COMPONENT_TABLE_ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--table列表组件显示列信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出tabs组件配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_TABS';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--tabs选项卡组件基础信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出tabs组件items配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_TABS_ITEM';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_COMPONENT_TABS_ITEM';
  SQL_STR:=' select *  from '||TABLE_NAME||' where COMPONENT_TABS_ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--tabs选项卡组件items项信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出UDP_COMPONENT_TREE_SELECT组件配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_TREE_SELECT';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_COMPONENT_TREE_SELECT';
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--树下拉选择器组件基础信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出UDP_COMPONENT_DATE_PICKER组件配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_DATE_PICKER';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_COMPONENT_DATE_PICKER';
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--时间选择器组件基础信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出udp_component_data_source组件数据源配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_DATA_SOURCE';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_COMPONENT_SOURCE';
  if IS_COPY=1 then
    SELECT_COL:='  s. id, s.data_source, s.data_source_type, s.parent_field, s.pk_field, s.lable_field, s.created, s.creator_id,s.creator,s.modified, s.modifier_id,s.modifier,s.child_field, s.code,s.is_checked_last_stage, s.is_check, s.default_value, ''《''||s.id||''》复制配置信息'' remark';
    else
    SELECT_COL:='  s.* ';
    end if;
  SQL_STR:='select '||SELECT_COL||' FROM udp_component c RIGHT join udp_component_data_source s on c.component_data_source_id=s.id where c.id in ('||SELECT_COMPONENT_BY_PAGEID||') UNION ';
  SQL_STR:=SQL_STR||'select '||SELECT_COL||' from (SELECT case when instr(s.data_source,''?'',1,1) <>0 then  substr(s.data_source,instr(s.data_source,''?'',1,1)+1)||''&''  end conten  FROM udp_component c RIGHT join udp_component_data_source s on c.component_data_source_id=s.id where c.id in (';
  SQL_STR:=SQL_STR||SELECT_COMPONENT_BY_PAGEID||')';
 SQL_STR:=SQL_STR||' and  s.data_source LIKE ''/api/udp/getDataSource%'')  tab,udp_component_data_source s where  tab.conten   like ''%code=''||s.code||''&%'' ';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--数据源信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出组件数据源存储过程配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_PROCEDURE_REGISTRATION';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_PROCEDURE_REGISTRATION';
    if IS_COPY=1 then
    SELECT_COL:=' r.ID ,r.NAME ,r.CODE ,r.STATE ,r.CREATED ,r.CREATOR_ID ,r.CREATOR ,r.MODIFIED ,r.MODIFIER_ID ,r.MODIFIER,''《''||r.ID||''》复制配置信息'' REMARK';
    else
    SELECT_COL:=' r.*';
    end if;
SQL_STR:='select '||SELECT_COL||' from UDP_PROCEDURE_REGISTRATION r where r.code in (select s.data_source from  (select component_data_source_id from UDP_COMPONENT where ID  in   ('||SELECT_COMPONENT_BY_PAGEID||') ';
SQL_STR:=SQL_STR||' and component_data_source_id is not null) d left join UDP_COMPONENT_DATA_SOURCE s on d.component_data_source_id=s.id where s.data_source_type=''procedure'') ';
SQL_STR:=SQL_STR|| ' UNION ';
SQL_STR:=SQL_STR||'select '||SELECT_COL||' from ( select  case when instr(s.data_source,''?'',1,1) <>0 then  substr(s.data_source,instr(s.data_source,''?'',1,1)+1)||''&''  end conten ';
SQL_STR:=SQL_STR||'from  (select component_data_source_id from UDP_COMPONENT where ID in  ('||SELECT_COMPONENT_BY_PAGEID||') ';
SQL_STR:=SQL_STR||'and component_data_source_id is not null) d left join UDP_COMPONENT_DATA_SOURCE s on d.component_data_source_id=s.id ';
SQL_STR:=SQL_STR||'where s.data_source LIKE ''/api/udp/getExecuteProcedureResult%'' or  s.data_source LIKE ''/api/udp/getRegisterResult%'' or  s.data_source LIKE ''/api/public/udp/getRegisterResult%'' )tab , UDP_PROCEDURE_REGISTRATION r ';
SQL_STR:=SQL_STR||'where tab.conten like ''%code=''||r.code||''&%'' ';
SQL_STR:=SQL_STR||' UNION ';
SQL_STR:=SQL_STR||'select '||SELECT_COL||' from (select case when instr(EXECUTE_CONTENT,''?'',1,1) <>0 then  substr(EXECUTE_CONTENT,instr(EXECUTE_CONTENT,''?'',1,1)+1)||''&''  end conten   from UDP_COMPONENT_BUTTON_EVENT where COMPONENT_BUTTON_ID in   ('||SELECT_COMPONENT_BY_PAGEID||') ';
SQL_STR:=SQL_STR||'and EXECUTE_CONTENT LIKE ''/api/udp/getExecuteProcedureResult%'' or  EXECUTE_CONTENT LIKE ''/api/udp/getRegisterResult%'' or  EXECUTE_CONTENT LIKE ''/api/public/udp/getRegisterResult%'' ) tab, UDP_PROCEDURE_REGISTRATION r ';
    SQL_STR:=SQL_STR||'where tab.conten like ''%code=''||r.code||''&%'' ';
execute immediate ' select WMSYS.WM_CONCAT(t.ID)  from ('||SQL_STR||') t' INTO  REGISTRATION_IDS;
if REGISTRATION_IDS is not null then  REGISTRATION_IDS:=replace(REGISTRATION_IDS,',',''','''); end if;
REGISTRATION_IDS:=''''||REGISTRATION_IDS||'''';
SQL_STR:='select * from '||TABLE_NAME||' where ID in ('||REGISTRATION_IDS||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--存储过程注册信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出组件数据源存储过程参数配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_PROCEDURE_PARAMETER';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_PROCEDURE_PARAMETER';
  SQL_STR:='select * from '||TABLE_NAME||' where PROCEDURE_REGISTRATION_ID in ('||' select ID  from ('||SQL_STR||') '||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--存储过程参数信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出UDP_EXPORT_EXCEL表导出配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_EXPORT_EXCEL';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
    if IS_COPY=1 then
    SELECT_COL:=' ID ,FILE_NAME ,CREATED ,CREATOR_ID ,CREATOR ,MODIFIED ,MODIFIER_ID ,MODIFIER ,''《''||ID||''》复制配置信息'' REMARK';
    else
    SELECT_COL:=' *';
    end if;
  SQL_STR:=' select '||SELECT_COL||' from  '||TABLE_NAME||' where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') )';
  SQL_STR:=SQL_STR||' UNION  select '||SELECT_COL||' from '||TABLE_NAME||' where ID in  (select EXCEL_ID from  UDP_EXPORT_SHEET  where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') ) )';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--导出excel基础信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出UDP_EXPORT_SHEET表sheet导出配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_EXPORT_SHEET';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  SQL_STR:=' select * from  '||TABLE_NAME||' where EXCEL_ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') )';
  SQL_STR:=SQL_STR||' UNION  select * from '||TABLE_NAME||' where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') ) ';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--导出sheet基础信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出UDP_EXPORT_SHEET_FIELD表sheet导出字段配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_EXPORT_SHEET_FIELD';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_EXPORT_SHEET_FIELD';
  SQL_STR:=' select * from '||TABLE_NAME||' where  EXPORT_SHEET_ID in（select ID from  UDP_EXPORT_SHEET  where EXCEL_ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') )';
  SQL_STR:=SQL_STR||' UNION select ID from  UDP_EXPORT_SHEET  where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') ) )';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--导出sheet字段信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出字段配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_EXPORT_FIELD';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  SQL_STR:=' select * from UDP_EXPORT_FIELD where ID in (select EXPORT_FIELD_ID from UDP_EXPORT_SHEET_FIELD where  EXPORT_SHEET_ID in（select ID from  UDP_EXPORT_SHEET  where EXCEL_ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') )';
  SQL_STR:=SQL_STR||' UNION select ID from  UDP_EXPORT_SHEET  where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') ) ) )';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--导出字段配置信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================查询导出的sql语句信息=================================================*/
 if IS_COPY is not null and IS_COPY <> 0 then
  open EXPORT_SQL_LIST for 'select ID,TABLE_NAME,
  CASE 
  WHEN TABLE_NAME IS NOT NULL
  THEN
   substr(substr(SQL,instr(SQL,'') values ('',1,1)+11,length(SQL)),0,
    instr( substr(SQL,instr(SQL,'') values ('',1,1)+11,length(SQL)) ,'','',1,1)-2
   )
  END  PKID,SQL from EXPORT_SQL_TABLE where  TABLE_NAME is null or  instr(TABLE_NAME,''(DELETE)'',1,1)=0   order by ID';
  else
     open EXPORT_SQL_LIST for 'select replace(replace(SQL,''''''$("time")$'',''to_date(''''''),''$("timeend")$'''''','''''',''''yyyy-mm-dd hh24:mi:ss'''')'') SQL from EXPORT_SQL_TABLE order by ID';
  end if;
  commit;
end P_UDP_EXPORT_SQL_BY_PAGEID;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_EXPORT_SQL_BY_PROCODE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_UDP_EXPORT_SQL_BY_PROCODE" (CODE in VARCHAR2, EXPORT_SQL_LIST OUT SYS_REFCURSOR)  AUTHID current_user
as
str_sql VARCHAR2(4000);
TEMP_TABLE_NAME VARCHAR2(200);
TABLE_NAME VARCHAR2(200);
SQL_STR VARCHAR2(4000);
EXPORT_SQL CLOB :='';
row_index NUMBER;
TABLEEXIST NUMBER;
begin
    row_index:=1;
     str_sql := 'create global temporary table EXPORT_SQL_TABLE  (
        ID INT,
        TABLE_NAME VARCHAR(1000),
        SQL  VARCHAR(4000)
     )
    on commit preserve rows';
    --判断临时表是否存在存在就删除
    select count(1) into TABLEEXIST from user_tables where table_name = 'EXPORT_SQL_TABLE';
    if TABLEEXIST=0 then
     --创建临时表
    execute immediate str_sql;
    else
    execute immediate 'delete EXPORT_SQL_TABLE';
    end if;

  insert into EXPORT_SQL_TABLE VALUES(row_index,'','set define off;');
/*=================================存储过程注册信息配置=================================================*/
 --需要导出的表名
  TABLE_NAME := 'UDP_PROCEDURE_REGISTRATION';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_PROCEDURE_REGISTRATION';
--查询语句
  SQL_STR:='  select * from '||TABLE_NAME||' where CODE='''||CODE||'''  and  STATE=1';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--存储过程注册信息初始化',
    SQL_STR => EXPORT_SQL
  );
    --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
  /*=================================存储过程参数注册信息配置=================================================*/
  select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_PROCEDURE_PARAMETER';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_PROCEDURE_PARAMETER';
  --查询页面显示组件的id的集合
  SQL_STR:=' select * from '||TABLE_NAME||' WHERE PROCEDURE_REGISTRATION_ID IN (select ID from UDP_PROCEDURE_REGISTRATION where CODE='''||CODE||''' and  STATE=1)';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--存储过程参数注册信息初始化' ,
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
  /*=================================数据源信息配置=================================================*/
  select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_DATA_SOURCE';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_COMPONENT_DATA_SOURCE';
  --查询页面显示组件的id的集合
  SQL_STR:=' select * from '||TABLE_NAME||' WHERE DATA_SOURCE ='''||CODE||''' and  DATA_SOURCE_TYPE=''procedure''  and rownum=1';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--数据源信息初始化' ,
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
  /*=================================查询导出的sql语句信息=================================================*/
  open EXPORT_SQL_LIST for 'select replace(replace(SQL,''''''$("time")$'',''to_date(''''''),''$("timeend")$'''''','''''',''''yyyy-mm-dd hh24:mi:ss'''')'') SQL from EXPORT_SQL_TABLE order by ID';
  commit;
end  P_UDP_EXPORT_SQL_BY_PROCODE;


/
--------------------------------------------------------
--  DDL for Procedure P_UDP_EXPORT_SQL_BY_TABLE_NAME
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_UDP_EXPORT_SQL_BY_TABLE_NAME" (temp_table_name in VARCHAR2,tablename  in VARCHAR2,row_index in NUMBER,WHERE_SQL_STR  in VARCHAR2,COMMENT_STR in VARCHAR2 ,sql_str out  CLOB)  AUTHID current_user 
as
sqlstr  VARCHAR2(4000);
sqlstr1 VARCHAR2(4000);
sqlstr2 VARCHAR2(4000);
colimns VARCHAR2(4000);
TABLE_NAME  VARCHAR2(4000);
ROW_NUMBER NUMBER;
ROW_COUNT NUMBER;
WHERE_SQL  VARCHAR2(4000);
TABLE_NAME_STR VARCHAR2(4000);
begin
   TABLE_NAME:=upper(tablename);
    P_UDP_CREATE_TEMP_TABLE(
     TEMP_TABLE_NAME => TEMP_TABLE_NAME,
     TABLENAME => TABLE_NAME,
     SQL_STR=>WHERE_SQL_STR
    );
    execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd hh24:mi:ss''';
    TABLE_NAME_STR:=''''||TABLE_NAME||''',';
    ROW_NUMBER:=row_index+1;
    sqlstr:='';
    ROW_COUNT:=0;
    if WHERE_SQL_STR is not null
    then 
    WHERE_SQL:=replace(WHERE_SQL_STR,'''','''''');
     execute immediate ' select COUNT(1)  from ('||WHERE_SQL_STR||') t' INTO  ROW_COUNT;
    end if;
    if COMMENT_STR is not null AND ROW_COUNT<>0 
    then 
    --拼接sql注释
    sqlstr:=' select '||ROW_NUMBER||','''','''||COMMENT_STR||''' from dual  UNION ';
    ROW_NUMBER:=ROW_NUMBER+1;
    sqlstr:=sqlstr||' select '||ROW_NUMBER||','||''''||TABLE_NAME||'(DELETE)'''||',''delete '||TABLE_NAME||' where ID in  (select t.ID from ('||WHERE_SQL||') t );'' from dual  UNION ';
    end if;
     --拼接插入数据语句
     sql_str:='select '||ROW_NUMBER||'+ROWNUM, '||TABLE_NAME_STR||'  ''insert into '||upper(tablename);
     SELECT WMSYS.WM_CONCAT(t.column_name) INTO colimns  FROM USER_TAB_COLUMNS t where t.TABLE_NAME=upper(temp_table_name);
     sqlstr2:='('||colimns||') values (';
     SELECT  WMSYS.WM_CONCAT(t.col) into sqlstr1
	 FROM (
    SELECT  CASE a.data_type 
    WHEN 'NUMBER'
    THEN  '''||case when '||a.column_name||' is null then ''0''  else to_char('||a.column_name ||')  end || '''
    WHEN 'DATE'
    THEN    '''''''||case when '||a.column_name||' is  not  null then  ''$("time")$''||replace('||a.column_name||','''''''','''''''''''')||''$("timeend")$''' || 'end || '''''''
    else 
    '''''''||case when '||a.column_name||' is  not  null then replace('||a.column_name||','''''''','''''''''''')' || 'end || '''''''
    END AS COL,a.column_id,a.column_name FROM USER_TAB_COLUMNS a where a.TABLE_NAME=upper(temp_table_name)
     ) t ORDER BY column_id;
     sqlstr1:=replace(sqlstr1,'||,','||'',');
     sqlstr1:=sqlstr1||');''';
     sql_str:=sqlstr||sql_str||sqlstr2||sqlstr1||' from '||upper(temp_table_name);
end P_UDP_EXPORT_SQL_BY_TABLE_NAME;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_PAGE_COMPONENTS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_UDP_PAGE_COMPONENTS" (containerGuid in varchar,pageComponents OUT sys_refcursor,treeSelect OUT sys_refcursor,tabs OUT sys_refcursor,tableColumn OUT sys_refcursor,buttoneEvent OUT sys_refcursor,eventMonitoring OUT sys_refcursor,datePicker OUT sys_refcursor)
AS  
haspage INTEGER;
BEGIN  
select count(1) into haspage  from UDP_PAGE where ID=containerGuid;
if haspage=1
then
open pageComponents for  
select   c.ID componentId,                                 --组件ID
c.COMPONENT_HIGH componentHeight,                          --组件高度
c.COMPONENT_WIDE componentWidth,                            --组件宽度
p.TITLE  pageTitle,                                                                    --页面标题
p.WINDOW_WIDTH  windowWidth,                                      --打开窗口宽度
p.WINDOW_HEIGHT windowHeight,                                     --打开窗口高度
c.COMPONENT_ORDER,                                                           --展示顺序 
c.COMPONENT_NAME componentName,                           --组件名称
c.COMPONENT_LABLE lable,                                                   --组件展示标题
c.COMPONENT_TYPE componentType,                                --组件类型
c.PLACEHOLDER placeholder,                                                 --展示水印文字
p.LAYOUT_TEMPLATE_ID templateName,                              --使用模板名称
l.LAYOUT_AREA_TEMPLATE_ID regionMark,                        --使用区域标识名称
s.IS_CHECK,                                                                                 --是否能够多选
s.IS_CHECKED_LAST_STAGE,                                                    --是否只能选中最末级
'' default_value,                                                                           --默认值
s.DATA_SOURCE_TYPE,                                                             --数据源类型
s.DATA_SOURCE componentSource,                                      --组件数据源
s.PK_FIELD,                                                                                    --主键字段
s.LABLE_FIELD,                                                                              --展示字段
c.DATA_SOURCE                                                                          --展示数据(TemplateHyperText、TemplateContainer)
 from  UDP_LAYOUT l  
 left join UDP_PAGE P on  l.page_id=p.ID
 left join UDP_COMPONENT c on  l.COMPONENT_ID=c.ID 
left join UDP_COMPONENT_DATA_SOURCE s on c.COMPONENT_DATA_SOURCE_ID=s.ID
where l.PAGE_ID=containerGuid and l.page_id=c.page_id order by c.COMPONENT_ORDER asc;
else
open pageComponents for  
select   c.ID componentId,                                                      --组件ID
c.COMPONENT_HIGH componentHeight,                          --组件高度
c.COMPONENT_WIDE componentWidth,                            --组件宽度
''  pageTitle,                                                                              --页面标题
''  windowWidth,                                                                       --打开窗口宽度
'' windowHeight,                                                                       --打开窗口高度
c.COMPONENT_ORDER ,                                                         --展示顺序 
c.COMPONENT_NAME componentName,                           --组件名称
c.COMPONENT_LABLE lable,                                                  --组件展示标题
c.COMPONENT_TYPE componentType,                               --组件类型
c.PLACEHOLDER placeholder,                                                --展示水印文字
'' templateName,                                                                        --模板名称
l.LAYOUT_AREA_TEMPLATE_ID regionMark,                       --使用区域标识名称
s.IS_CHECK,                                                                                --是否能够多选
s.IS_CHECKED_LAST_STAGE,                                                   --是否只能选中最末级
'' default_value,                                                                          --默认值
s.DATA_SOURCE_TYPE,                                                             --数据源类型
s.DATA_SOURCE componentSource,                                      --组件数据源
s.PK_FIELD,                                                                                    --主键字段
s.LABLE_FIELD,                                                                              --展示字段
c.DATA_SOURCE                                                                       --展示数据(TemplateHyperText、TemplateContainer)
from UDP_COMPONENT c
left join UDP_LAYOUT l on  l.COMPONENT_ID=c.ID 
left join UDP_COMPONENT_DATA_SOURCE s on c.COMPONENT_DATA_SOURCE_ID=s.ID
where c.PAGE_ID=containerGuid order by c.COMPONENT_ORDER asc;
end if;

open treeSelect for  
select  
c.id componentId,                                                                     --组件ID
t.default_expanded,                                                                  --默认展开
t.default_checked,                                                                      --默认选中
t.IS_CHECKED_LAST_STAGE                                                      --是否只能选中最末级
from  UDP_COMPONENT c 
left join UDP_COMPONENT_TREE_SELECT t on t.ID=c.id
where c.page_id=containerGuid and (c.component_type='TemplateTreeSelect') ;


open tabs for  
select  
c.id componentId,                                                               --组件ID
t.default_tabsitem,                                                              --默认选中项
t.layout_style,                                                                       --默认样式
i.ITEM_VALUE,                                                                       --tabs组件的项具体值
i.ITEM_LABLE,                                                                        --tabs组件的项展示值
i.ID                                                                                          --tabs组件的项ID
from  UDP_COMPONENT c 
left join UDP_COMPONENT_TABS t on t.ID=c.id
left join UDP_COMPONENT_TABS_ITEM i on t.ID=i.COMPONENT_TABS_ID
where c.page_id=containerGuid and (c.component_type='TemplateTabs') order by i.item_order;

open tableColumn for
select 
n.ID,
c.ID componentId,                                                     --组件ID
n.COLUMN_LABLE,                                                     --列标题
n.COLUMN_FIELD  ,                                                    --列字段名
n.COLUMN_WIDE ,                                                     --列宽度
n.COLUMN_ALIGN ,                                                   --列对齐
n.COLUMN_FIXED ,                                                    --浮动反方向（left,right）
2 COLUMN_NUMBER_FLOAT,                               --小数字段保留几位
n.COLUMN_DATA_TYPE ,                                         --数据类型
n.is_show_total,                                                          --是否显示合计
n.parent_column_id,                                                  --父级列主键
n.is_use_sort,                                                              --是否使用排序
d.IS_CHECK,                                                                 --是否复选
t.detail_url,                                                                   --双击行跳转地址
d.PK_FIELD,                                                                  --主键字段
n.JUMP_URL,                                                               --点击列跳转地址
n.OPEN_MODE,                                                           --点击列打开页面方式
t.OPEN_MODE DETAIL_MODE,                                 --双击行打开页面方式
n.WINDOW_WIDTH,                                                   --单击列打开弹窗的宽度
n.WINDOW_HEIGHT,                                                   --单击列打开弹窗的高度
n.DEAL_WITH_MODE,                                                  --单击列处理的模式
t.WINDOW_WIDTH as "ROW_WINDOW_WIDTH",  --双击行打开弹窗的宽度
t.WINDOW_HEIGHT as "ROW_WINDOW_WIDTH",  --双击行打开弹窗的高度
n.IS_USE_HTML,
'' is_show_stripe from UDP_COMPONENT c 
left join UDP_COMPONENT_TABLE_COLUMN n on c.ID=n.component_table_id
left join UDP_COMPONENT_TABLE  t on c.ID=t.ID
left join UDP_COMPONENT_DATA_SOURCE  d on d.ID=c.COMPONENT_DATA_SOURCE_ID
where c.page_id=containerGuid and (lower(c.component_type)='templatetable' or lower(c.component_type)='templatetreetable' )
and n.STATE=1
order by n.COLUMN_ORDER asc;
open buttoneEvent for
SELECT
    e.COMPONENT_BUTTON_ID,                                 --按钮组件ID
    b.TRADE_ID,                                                               --权限点ID
    b.icon,                                                                         --按钮图标
    e.EVENT_TYPE ,                                                          --按钮事件类型
    e.EXECUTE_TYPE ,                                                      --按钮执行类型
    e.EXECUTE_CONTENT,                                              --按钮执行内容
    e.DIALOG_TITLE,                                                        --点击弹窗标题
    e.DIALOG_CONTEN,                                                   --点击弹窗内容
    e.WINDOW_WIDTH,                                                   --打开弹窗的宽度
    e.WINDOW_HEIGHT                                                   --打开弹窗的高度
FROM
    UDP_COMPONENT c 
    left join UDP_COMPONENT_BUTTON_EVENT e  on c.ID=e.COMPONENT_BUTTON_ID
    left join udp_component_button b  on c.ID=b.ID
    where c.PAGE_ID=containerGuid and  e.COMPONENT_BUTTON_ID  is not null;

open eventMonitoring for
select 
m.ID,                                                                              --事件监听主键
m.COMPONENT_ID ,                                                   --组件ID
m.TARGET_COMPONENT_ID ,                                   --被监听组件ID
c.COMPONENT_TYPE ,                                                --组件类型
m.IS_MUST_MONITORING   from UDP_EVENT_MONITORING m 
left join UDP_COMPONENT c on m.TARGET_COMPONENT_ID=c.ID
where m.component_id in (select  c.ID   from UDP_COMPONENT c where  c.PAGE_ID=containerGuid);

open datePicker for
select 
c.ID componentId,                                                     --组件ID
d.START_TIME,                                                           --开始时间
d.END_TIME,                                                               --结束时间
d.DEFAULT_VALUE,                                                   --默认时间
d.VALUE_FORMAT                                                    --时间格式
from  UDP_COMPONENT c 
left join UDP_COMPONENT_DATE_PICKER d on c.ID=d.ID
where  c.PAGE_ID=containerGuid and (lower(c.component_type)='templatedatepicker' or lower(c.component_type)='templatedatetimepicker' );
END P_UDP_PAGE_COMPONENTS;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_PROCEDURE_CONFIG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_UDP_PROCEDURE_CONFIG" (procedure_code in varchar,procedureConfigs OUT sys_refcursor)
AS  
BEGIN  
open procedureConfigs for  
SELECT
    r.id,                                                                                 --存储过程配置信息表主键
    r.name,                                                                          --存储过程名
    r.code,                                                                            --配置标识code
    r.state,                                                                            --是否启用
    p.parameter_name,                                                      --存储过程参数名
    p.data_source_keyword,                                              --参数数据来源的关键字标识
    p.parameter_default,                                                    --参数默认值
    case  sys.IN_OUT                                                           --是否为输出参数
    when 'IN' then 1
    else 0 
    end as is_input_parameter,                                          --是否为输入参数
    sys.DATA_TYPE as parameter_type,                           --参数类型
    sys.SEQUENCE as sort                                                  --参数排序
FROM
    udp_procedure_registration r left join UDP_PROCEDURE_PARAMETER p on r.ID=p.PROCEDURE_REGISTRATION_ID
    left join sys.user_arguments sys on upper(r.name)=sys.OBJECT_NAME and upper(p.parameter_name)=sys.ARGUMENT_NAME
    where code=procedure_code;
END p_UDP_Procedure_Config;


/
--------------------------------------------------------
--  DDL for Procedure P_UDP_SET_COLUMN_STATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_UDP_SET_COLUMN_STATE" (
    TABLE_ID IN VARCHAR2,--调整的table表
    ENABLE_COLUMNS IN CLOB,--启用列的列
    IS_SUCCESS OUT NUMBER--是否成功
) AS
    ROWCOUNT NUMBER;
BEGIN
    SELECT COUNT(1) INTO ROWCOUNT FROM UDP_COMPONENT_TABLE_COLUMN  WHERE COMPONENT_TABLE_ID=TABLE_ID;
    IF ROWCOUNT<>0  and ENABLE_COLUMNS is not null THEN
        --调整字段的启用状态
        Update UDP_COMPONENT_TABLE_COLUMN SET STATE=1
        WHERE ID in  (
            SELECT ID FROM UDP_COMPONENT_TABLE_COLUMN COLS
                               INNER JOIN (
                SELECT COLUMN_VALUE FROM table (split(ENABLE_COLUMNS,'|'))
            ) ENABLE_COLS ON COLS.COLUMN_FIELD=ENABLE_COLS.COLUMN_VALUE
        );
        --调整字段的禁用状态
        Update UDP_COMPONENT_TABLE_COLUMN SET STATE=0
        WHERE ID IN  (
            SELECT ID FROM UDP_COMPONENT_TABLE_COLUMN COLS
                               LEFT JOIN (
                SELECT COLUMN_VALUE FROM table (split(ENABLE_COLUMNS,'|'))
            ) ENABLE_COLS ON COLS.COLUMN_FIELD=ENABLE_COLS.COLUMN_VALUE
            WHERE ENABLE_COLS.COLUMN_VALUE IS NULL AND COMPONENT_TABLE_ID=TABLE_ID
        );
        --调整有子集显示的父级为启用状态
        update UDP_COMPONENT_TABLE_COLUMN set STATE = 1
        where ID in (
            select COLS.PARENT_COLUMN_ID from UDP_COMPONENT_TABLE_COLUMN COLS
            where COLS.COMPONENT_TABLE_ID = TABLE_ID AND COLS.STATE = 1
        );
        IS_SUCCESS:=1;
    ELSE
        IS_SUCCESS:=0;
    END IF;
exception
    when others then
        IS_SUCCESS:=0;
END P_UDP_SET_COLUMN_STATE;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_SET_EXCEL_COLUMN_STATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_UDP_SET_EXCEL_COLUMN_STATE" (
    EXCELID IN VARCHAR2,--调整的excel表主键
    EXPORT_SHEET_ID IN VARCHAR2,--调整的UDP_EXPORT_SHEET表主键
    ENABLE_COLUMNS IN CLOB,--启用列的列
    IS_SUCCESS OUT NUMBER--是否成功
) AS
ROWCOUNT NUMBER;
BEGIN
 dbms_output.put_line(124);
    SELECT count(1) into ROWCOUNT FROM UDP_EXPORT_EXCEL LEFT JOIN UDP_EXPORT_SHEET on UDP_EXPORT_EXCEL.id=UDP_EXPORT_SHEET.EXCEL_ID
    left join UDP_EXPORT_SHEET_FIELD on UDP_EXPORT_SHEET.id=UDP_EXPORT_SHEET_FIELD.EXPORT_SHEET_ID
    WHERE UDP_EXPORT_EXCEL.ID=EXCELID and UDP_EXPORT_SHEET.id=EXPORT_SHEET_ID ;
     dbms_output.put_line(ROWCOUNT);
    IF ROWCOUNT<>0 and ENABLE_COLUMNS is not null THEN
    --调整字段的启用状态
  Update UDP_EXPORT_SHEET_FIELD SET STATE=1
    WHERE ID in (SELECT UDP_EXPORT_SHEET_FIELD.id  FROM UDP_EXPORT_EXCEL LEFT JOIN UDP_EXPORT_SHEET on UDP_EXPORT_EXCEL.id=UDP_EXPORT_SHEET.EXCEL_ID
    left join UDP_EXPORT_SHEET_FIELD on UDP_EXPORT_SHEET.id=UDP_EXPORT_SHEET_FIELD.EXPORT_SHEET_ID LEFT JOIN UDP_EXPORT_FIELD ON UDP_EXPORT_FIELD.id=udp_export_sheet_field.export_field_id
    WHERE UDP_EXPORT_EXCEL.ID=EXCELID and UDP_EXPORT_SHEET.id=EXPORT_SHEET_ID AND UDP_EXPORT_FIELD.FIELD IN (SELECT COLUMN_VALUE
    FROM table (split(ENABLE_COLUMNS,'|'))) );
    --调整字段的禁用状态
    Update UDP_EXPORT_SHEET_FIELD SET STATE=0
    WHERE ID IN
    (SELECT UDP_EXPORT_SHEET_FIELD.id  FROM UDP_EXPORT_EXCEL LEFT JOIN UDP_EXPORT_SHEET on UDP_EXPORT_EXCEL.id=UDP_EXPORT_SHEET.EXCEL_ID
    left join UDP_EXPORT_SHEET_FIELD on UDP_EXPORT_SHEET.id=UDP_EXPORT_SHEET_FIELD.EXPORT_SHEET_ID LEFT JOIN UDP_EXPORT_FIELD ON UDP_EXPORT_FIELD.id=udp_export_sheet_field.export_field_id
    WHERE UDP_EXPORT_EXCEL.ID=EXCELID and UDP_EXPORT_SHEET.id=EXPORT_SHEET_ID AND UDP_EXPORT_FIELD.FIELD NOT IN (SELECT COLUMN_VALUE
    FROM table (split(ENABLE_COLUMNS,'|')))  );

        IS_SUCCESS:=1;
    ELSE
        IS_SUCCESS:=0;
    END IF;
exception
when others then
  IS_SUCCESS:=0;
 dbms_output.put_line(sqlcode||'--'||sqlerrm);
END P_UDP_SET_EXCEL_COLUMN_STATE;


/
--------------------------------------------------------
--  DDL for Procedure P_UDP_SET_EXCEL_FILED_STATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_UDP_SET_EXCEL_FILED_STATE" (
    i_excel_id  varchar2,---excel的id
    i_sheet_id  varchar2,---excel的sheet id
    i_enable_filed in  varchar2,---启用列名;多个|分隔
    o_result out varchar2--提示消息
) AS
    --excel列禁用显示设置
    --作者：陈丽
    --日期：2020-07-22
    EXCEL_ID VARCHAR2(200);
    ENABLE_COLUMNS CLOB;
    IS_SUCCESS NUMBER;
BEGIN
    --open o_result for select '成功' id from dual;
    BEGIN
        EXCEL_ID := i_excel_id;
        ENABLE_COLUMNS := i_enable_filed;
        if EXCEL_ID = 'ac198548-6343-7e51-e053-0100007f215c' then
            ENABLE_COLUMNS := replace(ENABLE_COLUMNS, 'warning', 'warningText');
        end if;
        P_UDP_SET_EXCEL_COLUMN_STATE(
                EXCELID  => EXCEL_ID,
                EXPORT_SHEET_ID  => i_sheet_id,
                ENABLE_COLUMNS => ENABLE_COLUMNS,
                IS_SUCCESS => IS_SUCCESS
            );
    END;
    if IS_SUCCESS=1 then
        o_result:='成功';
    else
        o_result:='失败';
    end if;
END P_UDP_SET_EXCEL_FILED_STATE;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_SET_FILED_STATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_UDP_SET_FILED_STATE" (
    i_table_id  varchar2,---excel的id
    i_excel_id  varchar2,---excel的id
    i_sheet_id  varchar2,---excel的sheet id
    i_enable_filed in  varchar2,---启用列名;多个|分隔
    o_result out varchar2--提示消息
) AS
	--excel列禁用显示设置
	--作者：陈丽
	--日期：2020-07-22
 EXCEL_ID VARCHAR2(200);
  ENABLE_COLUMNS CLOB;
  IS_SUCCESS NUMBER;
  IS_SUCCESS1 NUMBER;
BEGIN
--open o_result for select '成功' id from dual;
BEGIN
  EXCEL_ID := i_excel_id;
  ENABLE_COLUMNS := i_enable_filed;
  P_UDP_SET_COLUMN_STATE(
    TABLE_ID   => i_table_id,
    ENABLE_COLUMNS => ENABLE_COLUMNS,
    IS_SUCCESS => IS_SUCCESS1
  );

  P_UDP_SET_EXCEL_COLUMN_STATE(
    EXCELID  => EXCEL_ID,
    EXPORT_SHEET_ID  => i_sheet_id,
    ENABLE_COLUMNS => ENABLE_COLUMNS,
    IS_SUCCESS => IS_SUCCESS
  );
END;
if IS_SUCCESS=1 and IS_SUCCESS1=1 then
o_result:='成功';
else
o_result:='失败';
end if;
END p_udp_set_filed_state;


/
--------------------------------------------------------
--  DDL for Procedure P_UDP_TABLE_COLUMNS_BY_TABLEID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_UDP_TABLE_COLUMNS_BY_TABLEID" (
    TABLE_ID IN VARCHAR2,--调整获取的TABLE的ID
    columnList OUT SYS_REFCURSOR
) AS
begin
open columnList for
    SELECT
    ID AS "id",
    regexp_replace(COLUMN_LABLE,'</?[^>]*>|nbsp;|&','') as "lable",
    STATE as "state",
    COLUMN_FIELD as "field",
    PARENT_COLUMN_ID as "parent_id"
    FROM UDP_COMPONENT_TABLE_COLUMN WHERE COMPONENT_TABLE_ID=TABLE_ID order by COLUMN_ORDER ;
end P_UDP_TABLE_COLUMNS_BY_TABLEID;


/
--------------------------------------------------------
--  DDL for Procedure P_USER_TREE_LAZY_LOAD
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_USER_TREE_LAZY_LOAD" (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    parentid         IN               VARCHAR2,
    data_auth_info   OUT              SYS_REFCURSOR
) AS
--获取用户树
--作者：陈丽
--日期：2020/06/18

    rulevalue        VARCHAR2(50);
    authcount        INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    spid             VARCHAR2(36);--使用临时表的批次号
    data_auth_spid   VARCHAR2(200);
    authcode         VARCHAR2(50);---- 权限编码
    v_id             VARCHAR2(100);
BEGIN
    IF parentid IS NULL THEN
        v_id := '0001';
    ELSE
        v_id := parentid;
    END IF;
  --先不健全

    OPEN data_auth_info FOR WITH base AS (
                               SELECT
                                   *
                               FROM
                                   (
                                       SELECT DISTINCT
                                           a.id           AS id,
                                           a.id           AS objid,
                                           a.org_name     AS orgname,
                                           CASE
                                               WHEN a.is_company = 1 THEN
                                                   100
                                               WHEN a.is_company = 0 THEN
                                                   110
                                           END AS orgtype,
                                           a.parent_id    AS parentid,
                                           a.order_code   AS ordercode
                                       FROM
                                           sys_business_unit a
                                       UNION ALL
                                   ----岗位
                                       SELECT
                                           id,
                                           id       AS obj_id,
                                           station_name,
                                           120 AS orgtype,
                                           org_id   AS parent_id,
                                           station_name
                                       FROM
                                           sys_station
                                       UNION ALL
                                   ----人
                                       SELECT
                                           stu.id,
                                           u.id             AS user_id,
                                           u.user_name,
                                           130 AS orgtype,
                                           stu.station_id   AS parent_id,
                                           user_code
                                       FROM
                                           sys_station_to_user   stu
                                           LEFT JOIN sys_user              u ON stu.user_id = u.id
                                   )
                           ), 计算 AS (
                               SELECT
                                   base1.id,
                                   base1.objid,
                                   base1.orgname,
                                   base1.orgtype,
                                   base1.parentid,
                                   lpad(base1.ordercode, 10, '0') AS ordercode,
                                   CASE
                                       WHEN base2.parentid IS NULL THEN
                                           1
                                       ELSE
                                           0
                                   END AS isleaf
                               FROM
                                   base base1
                                   LEFT JOIN (
                                       SELECT
                                           parentid
                                       FROM
                                           base
                                       GROUP BY
                                           parentid
                                   ) base2 ON base1.id = base2.parentid
                           )
                           SELECT
                               *
                           FROM
                               计算
                           WHERE
                               parentid = v_id
                           ORDER BY
                               ordercode;

END p_user_tree_lazy_load;

/
--------------------------------------------------------
--  DDL for Procedure P_WFI_COPY_TO_INFO
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_WFI_COPY_TO_INFO" (
    noticePersons  IN   CLOB,              --用户code多个
    noticeGroups   IN    CLOB,             --虚拟组
    noticeProjectRoles    IN     CLOB,    --项目级角色
    noticeTitle    IN     varchar2,           -- 发送通知标题
    addressParams in varchar2,           --页面参数
    workItemID  in  varchar2,               --工作项ID
    processInstID  in varchar2,             --流程实例ID
    pchost in varchar2,                         --pc端域名
    mobilehost in varchar2,                   --pc端域名
    messageType out      varchar2,       --0:门户终端消息都推送，1：只推送门户，2：只推送短信或微信
    info     OUT      SYS_REFCURSOR     --消息集合
) IS
toreadpc  varchar2(1000);
toreadmobile  varchar2(1000);
systemId  varchar2(100);
systemappId  varchar2(100);
bizMsgCategory varchar2(100);
creater varchar2(100);
processName varchar2(4000);
portalMsgType number;
formcode  varchar2(1000);
addressParamsStr varchar2(1000);
begin
  execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd hh24:mi:ss''';
  toreadpc:=pchost||'/wfi-sys/process-operation';
  toreadmobile:=mobilehost||'/wfi/process-info';
  messageType:=1;
  portalMsgType:=10;
  bizMsgCategory:='催办消息';
  if addressParams is not null then
  addressParamsStr:=replace(addressParams,'||','&');
  end if;
  select PROCESS_INST_NAME,CREATEBY,FORM_CODE into processName,creater,formcode from WFI_PROCESS_INST where Id=processInstID and rownum=1;
  select f.SYSTEM_ID,s.APP_ID into systemId,systemappId from WFI_BIZ_FORM f left join SYS_APPLICATION s on f.SYSTEM_ID=s.ID  where f.FORM_CODE=formcode;
  p_wfi_person_role_analysis(
    noticePersons => noticePersons,
    noticeGroups => noticeGroups,
    noticeProjectRoles =>noticeProjectRoles
  );
 OPEN info FOR 
    select 
    creater as "senderAccount",                        --发送人
    persons.user_code as  "recipientAccount",    --接收人
    systemId as  "systemId",--系统id
    systemappId as   "appid",--应用id
    workItemID||persons.user_code as "bizKey",--业务id--门户网站的taskId
    bizMsgCategory as "bizMsgCategory",--消息所属类别
-------------------------------------------------------------【短信微信必须】基础信息 ------------------------------------------------------------
    '' as "msgChannel", --使用消息渠道 多个，逗号分隔   tjWeChat：铁建微信,tjSMS：铁建短信
    '' as "smsTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID  --{1}您好，{2}对您负责的任务“{3}”进行了催办，请及时到门户网站查看待办并在《计划管理系统》中反馈任务进度{4}。
    '[]' AS "smsParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
    ''  as "mobile",--短信接收人电话
    '' AS "wechatTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID
    '[]' AS "wechatParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
    '' AS "wechatJumplinkUrl",--微信打开地址，程序调用发消息前需要编码
    '' AS "title",--消息标题
    '' AS "bizSourceCategory",
-------------------------------------------------------------【门户消息必须】基础信息 ------------------------------------------------------------
    portalMsgType as "portalMsgType",
    CASE 
    when addressParamsStr is not null then
    toreadpc||'?'||addressParamsStr
    else 
    toreadpc end as "url",--pc端的url地址
    case when addressParamsStr is not null then
    toreadmobile||'?'||addressParamsStr 
    else toreadmobile  end as "mobileUrl",--移动端的url地址
    case 
    when noticeTitle is not null then
    noticeTitle||'―'||processName
    else 
    processName end as "taskname", --任务名称，等于3、插入待阅/4、插入已阅informationname;等于插入关注的attentionname
    '计划运营' as "typename",--任务类型
    '工作流平台待阅消息推送' as "remark",
     to_char(sysdate,'yyyy-MM-dd HH24:mi:ss')  "expiretime",--expiretime	否	String	过期时间，格式yyyy-MM-dd HH:mm:ss-----过期时间，除关注都有
     1  "priority"--priority	否	Integer	优先级，除关注都有 
    from 
    (select  distinct tab1.USER_ACCOUNT as user_code from (SELECT r.USER_CODE USER_ACCOUNT from (select code from PERSON_ROLE_ANALYSIS_TABLE where  type='person') tab left join SYS_USER r on r.USER_CODE = tab.code
   union select r.USER_ACCOUNT from  (select * from PERSON_ROLE_ANALYSIS_TABLE where  type='group' and detail  is not null) tab left join SYS_ROLE_USER_RELATION_RESULT r on 
   tab.code=r.VIRTUAL_GROUP_NAME where r.role_type=40 and (r.COMPANY_ID=tab.detail or r.DEPT_ID=tab.detail)
   union select r.USER_ACCOUNT from  (select * from PERSON_ROLE_ANALYSIS_TABLE where  type='projectRole'  and detail  is not null) tab left join SYS_ROLE_USER_RELATION_RESULT r on 
   tab.code=r.role_code  where r.role_type=30 and r.PROJECT_ID=tab.detail) tab1) persons where persons.user_code is not null;
END p_wfi_copy_to_info;

/
--------------------------------------------------------
--  DDL for Procedure P_WFI_FORM_DATA_BY_BIZ_ID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_WFI_FORM_DATA_BY_BIZ_ID" (
    biz_id in VARCHAR2,                    --业务主键
    process_inst_id in VARCHAR2,       --流程实例ID
    code OUT VARCHAR2,                  --业务表单code
    formData OUT SYS_REFCURSOR,    -- 输出表单数据结果集游标
    fieldData OUT SYS_REFCURSOR      -- 输出表单字段结果集游标
  )
AS
  v_sql    VARCHAR2(4000);                               
  id_field VARCHAR2(50);
  bizId VARCHAR2(50);
BEGIN
execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd hh24:mi:ss''';
SELECT 
    form_code,biz_id  into code,bizId
FROM
    wfi_process_inst where ID=process_inst_id and ROWNUM=1;
SELECT
    d.field_name INTO id_field
FROM
    wfi_biz_form f,wfi_biz_field d 
where form_code=code and f.id=d.form_id and d.is_pk=1 and ROWNUM=1;
SELECT
    form_sql INTO v_sql
FROM
    wfi_biz_form where form_code=code and ROWNUM=1;
open fieldData for  
SELECT
   d. chinese_name,d.field_name,d.IS_SHOW
FROM
    wfi_biz_form f,wfi_biz_field d 
where form_code=code and f.id=d.form_id and form_code=code order by d.sort;
if  instr(v_sql,'{bizId}',1,1)<>0 then
   v_sql :=replace(v_sql,'{bizId}',bizId);
else 
     v_sql :=replace(v_sql,';','');
    v_sql  :='select * from (' || v_sql || ' ) where  ROWNUM=1 and   '||id_field||' =  '''|| bizId||'''';
end if;
    dbms_output.put_line(v_sql);
OPEN formData FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE formData;
END P_WFI_FORM_DATA_BY_BIZ_ID;

/
--------------------------------------------------------
--  DDL for Procedure P_WFI_PERSON_ROLE_ANALYSIS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_WFI_PERSON_ROLE_ANALYSIS" (
    noticePersons  IN   CLOB,     --用户code多个
    noticeGroups   IN    CLOB,    --虚拟组
    noticeProjectRoles    IN     CLOB --项目级角色
) IS
begin
delete PERSON_ROLE_ANALYSIS_TABLE;

if noticePersons is not null then
insert into PERSON_ROLE_ANALYSIS_TABLE (code , type ) SELECT COLUMN_VALUE ,'person' as type 
FROM table (split (noticePersons,';'));
end if;

if noticeGroups is not null then
insert into PERSON_ROLE_ANALYSIS_TABLE SELECT splitstr(COLUMN_VALUE,1) as code,splitstr(COLUMN_VALUE,2) as detail ,'group' as type 
FROM table (split (noticeGroups,';'));
end if;

if noticeProjectRoles is not null then
insert into PERSON_ROLE_ANALYSIS_TABLE SELECT splitstr(COLUMN_VALUE,1) as code,splitstr(COLUMN_VALUE,2) as detail ,'projectRole' as type 
FROM table (split (noticeProjectRoles,';'));
end if;

end p_wfi_person_role_analysis;

/
--------------------------------------------------------
--  DDL for Procedure P_WFI_SAVE_FORM_CATALOG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "P_WFI_SAVE_FORM_CATALOG" (systemId in VARCHAR2, UUID in VARCHAR2,NEWUUID in VARCHAR2,CATALOGCODE in VARCHAR2,CATALOGNAME in varchar,code OUT NUMBER,msg OUT VARCHAR2)
as
  row_count number;
  appid VARCHAR2(36);
BEGIN
  select count(1) into row_count from SYS_APPLICATION where id=systemId;
  if row_count=1 then
    select APP_ID into appid from SYS_APPLICATION where id=systemId;
    select count(1) into row_count from WFI_BIZ_FORM_CATALOG where ID=UUID;
    if row_count=0 then
        Insert into WFI_BIZ_FORM_CATALOG (ID,APP_ID,CODE,NAME) values (UUID,appid,CATALOGCODE,CATALOGNAME);
        code:=0;
        msg:='保存业务目录信息成功';
    else
        UPDATE WFI_BIZ_FORM_CATALOG SET APP_ID=appid,CODE=CATALOGCODE,NAME=CATALOGNAME,ID=NEWUUID WHERE ID=UUID;
        select count(1) into row_count from WFI_BIZ_FORM where CATALOG_UUID=UUID;
            if  row_count<>0 then
                UPDATE WFI_BIZ_FORM SET BELONG_SYSTEM=CATALOGCODE,SYSTEM_ID=systemId,CATALOG_UUID=NEWUUID WHERE CATALOG_UUID=UUID;
            end if;
           code:=0;
           msg:='保存业务目录信息成功';
    end if;
  ELSE
  code:=1000;
  msg:='保存参数无效';
  end if;
  exception 
        when DUP_VAL_ON_INDEX then 
        code:=100;
        msg:='业务目录ID重复';
        rollback;
END P_WFI_SAVE_FORM_CATALOG;

/
--------------------------------------------------------
--  DDL for Procedure POM_KEY_NODE_MY_REMINDER
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM_KEY_NODE_MY_REMINDER" 
(
    REMINDERGUID IN VARCHAR2,
    pageIndex    IN INT,
    pageSize     IN INT,
    total        OUT INT,
    items        OUT SYS_REFCURSOR
)
IS
    v_count clob;
    v_sql clob;
BEGIN
    v_sql := '
    SELECT *
    FROM (SELECT tt.*, ROWNUM AS rowno
          FROM (
            select total.* from  (
                           select
                               node.id AS "id",
                               node.original_node_id  AS "nodeOriginalId",
                               --未到期不亮灯
                               case WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
                                   --到期当天内完成反馈
                                    when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
                                        then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
                                   --到期1-5天内完成反馈
                                   when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
                                         then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                    --到期未反馈黄灯
                                    WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 0 and 5
                                             THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                    --到期超过5天未反馈红灯
                                    WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(NODE.PLAN_END_DATE)) >5)
                                             THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
                                         ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END AS "warnState",
                                    case when node.actual_end_date is not null
                                            then ''已完成''
                                        when to_char(node.plan_end_date,''YYYY-MM-DD'') >to_char(sysdate,''YYYY-MM-DD'') and node.actual_end_date is  null
                                            then ''未到期''
                                        when TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') < TO_CHAR(sysdate, ''YYYY-MM-DD'') and node.actual_end_date is  null
                                            then ''<span style="color:red">已超期</span>'' end as "taskState" ,
                                    TO_CHAR(smrb.created_time, ''YYYY-MM-DD'')  AS "urgeTime",
                                    node.node_name AS "taskName",
                                    node.node_level  AS "taskLevel",
                                    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'')  AS "planTime",
                                    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'')  AS "estimateTime",
                                    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'')  AS "realityTime",
                                    plan.plan_type AS "planType",
                                    plan.id AS "planId",
                                    nvl(sp.project_name, sps.stage_full_name) AS "originProj",
                                    plan.plan_name AS "originPlan",
                                    node.duty_department AS "dutyDept",
                                    unit.org_name AS "secondCompany"
                          from SYS_MSG_RECORD_BIZ smrb
                                   left join SYS_MSG_RECORD_SMS smrs on smrs.MSG_RECORD_BIZ_ID = smrb.ID
                                   left join sys_user sy on smrs.sender_id = sy.user_code
                                   left join pom_proj_plan_node node on smrb.BIZ_KEY = node.id
                                   left join pom_proj_plan plan on node.proj_plan_id = plan.id
                                   left join sys_project sp on plan.proj_id = sp.id
                                   left join sys_project_stage sps on plan.proj_id = sps.id
                                   left join sys_business_unit unit on plan.company_id = unit.id
                          where smrb.biz_msg_category = ''催办消息''
                            and smrb.system_id = ''71313f018a35f3a558166cba7599b5d6''
                            and plan.plan_type = ''关键节点计划''
                            and plan.approval_status = ''已审核''
                            and sy.id = '''||REMINDERGUID||'''
                            and node.is_disable = 0
                          union
                            select
                                node.id AS "id",
                                node.original_node_id  AS "nodeOriginalId",
                                --未到期不亮灯
                                case WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
                                    --到期当天内完成反馈
                                     when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
                                         then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
                                    --到期1-5天内完成反馈
                                    when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
                                         then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                --到期未反馈黄灯
                                WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 0 and 5
                                         THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                --到期超过5天未反馈红灯
                                WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(NODE.PLAN_END_DATE)) >5)
                                         THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
                                     ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END AS "warnState",
                                case when node.actual_end_date is not null
                                        then ''已完成''
                                    when to_char(node.plan_end_date,''YYYY-MM-DD'') >to_char(sysdate,''YYYY-MM-DD'') and node.actual_end_date is  null
                                        then ''未到期''
                                    when TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') < TO_CHAR(sysdate, ''YYYY-MM-DD'') and node.actual_end_date is  null
                                        then ''<span style="color:red">已超期</span>'' end as "taskState" ,
                                TO_CHAR(smrb.created_time, ''YYYY-MM-DD'')  AS "urgeTime",
                                node.node_name AS "taskName",
                                node.node_level  AS "taskLevel",
                                TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'')  AS "planTime",
                                TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'')  AS "estimateTime",
                                TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'')  AS "realityTime",
                                plan.plan_type AS "planType",
                                plan.id AS "planId",
                                nvl(sp.project_name, sps.stage_full_name) AS "originProj",
                                plan.plan_name AS "originPlan",
                                node.duty_department AS "dutyDept",
                                unit.org_name AS "secondCompany"
                          from SYS_MSG_RECORD_BIZ smrb
                              left join SYS_MSG_RECORD_WECHAT smrw on smrw.MSG_RECORD_BIZ_ID = smrb.ID
                              left join sys_user sy on smrw.sender_id = sy.user_code
                              left join pom_proj_plan_node node on smrb.BIZ_KEY = node.id
                              left join pom_proj_plan plan on node.proj_plan_id = plan.id
                              left join sys_project sp on plan.proj_id = sp.id
                              left join sys_project_stage sps on plan.proj_id = sps.id
                              left join sys_business_unit unit on plan.company_id = unit.id
                          where
                              smrb.biz_msg_category = ''催办消息''
                            and smrb.system_id = ''71313f018a35f3a558166cba7599b5d6''
                            and plan.plan_type=''关键节点计划''
                            and plan.approval_status=''已审核''
                            and sy.id='''||REMINDERGUID||'''
                            and node.is_disable = 0
                        union
                            select
                                node.id AS "id",
                                node.original_node_id  AS "nodeOriginalId",
                                --未到期不亮灯
                                case WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
                                    --到期当天内完成反馈
                                     when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
                                         then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
                                    --到期1-5天内完成反馈
                                    when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
                                         then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                --到期未反馈黄灯
                                WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 0 and 5
                                         THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                --到期超过5天未反馈红灯
                                WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(NODE.PLAN_END_DATE)) >5)
                                         THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
                                     ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END AS "warnState",
                                case when node.actual_end_date is not null
                                        then ''已完成''
                                    when to_char(node.plan_end_date,''YYYY-MM-DD'') >to_char(sysdate,''YYYY-MM-DD'') and node.actual_end_date is  null
                                        then ''未到期''
                                    when TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') < TO_CHAR(sysdate, ''YYYY-MM-DD'') and node.actual_end_date is  null
                                        then ''<span style="color:red">已超期</span>'' end as "taskState" ,
                                TO_CHAR(smc.created, ''YYYY-MM-DD'')  AS "urgeTime",
                                node.node_name AS "taskName",
                                node.node_level  AS "taskLevel",
                                TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'')  AS "planTime",
                                TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'')  AS "estimateTime",
                                TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'')  AS "realityTime",
                                plan.plan_type AS "planType",
                                plan.id AS "planId",
                                nvl(sp.project_name, sps.stage_full_name) AS "originProj",
                                plan.plan_name AS "originPlan",
                                node.duty_department AS "dutyDept",
                                unit.org_name AS "secondCompany"
                          from sys_message_center smc
                              left join sys_user sy on smc.creator_name = sy.user_code
                              left join pom_proj_plan_node node on smc.task_id = node.id
                              left join pom_proj_plan plan on node.proj_plan_id = plan.id
                              left join sys_project sp on plan.proj_id = sp.id
                              left join sys_project_stage sps on plan.proj_id = sps.id
                              left join sys_business_unit unit on plan.company_id = unit.id
                          where
                              smc.biz_msg_category = ''催办消息''
                            and plan.plan_type=''关键节点计划''
                            and plan.approval_status=''已审核''
                            and sy.id='''||REMINDERGUID||'''
                            and node.is_disable = 0
        )total order by total."planTime" asc
    ) tt
           WHERE ROWNUM <= '||pageSize||' * '||pageIndex||' )table_alias
           WHERE table_alias.rowno >= '||pageSize||' * ( '||pageIndex||' -1) + 1 ';

    v_count := 'select count(*) from  (
                           select
                               node.id AS "id",
                               node.original_node_id  AS "nodeOriginalId",
                               --未到期不亮灯
                               case WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
                                   --到期当天内完成反馈
                                    when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
                                        then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
                                   --到期1-5天内完成反馈
                                   when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
                                         then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                    --到期未反馈黄灯
                                    WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 0 and 5
                                             THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                    --到期超过5天未反馈红灯
                                    WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(NODE.PLAN_END_DATE)) >5)
                                             THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
                                         ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END AS "warnState",
                                    case when node.actual_end_date is not null
                                            then ''已完成''
                                        when to_char(node.plan_end_date,''YYYY-MM-DD'') >to_char(sysdate,''YYYY-MM-DD'') and node.actual_end_date is  null
                                            then ''未到期''
                                        when TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') < TO_CHAR(sysdate, ''YYYY-MM-DD'') and node.actual_end_date is  null
                                            then ''<span style="color:red">已超期</span>'' end as "taskState" ,
                                    TO_CHAR(smrb.created_time, ''YYYY-MM-DD'')  AS "urgeTime",
                                    node.node_name AS "taskName",
                                    node.node_level  AS "taskLevel",
                                    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'')  AS "planTime",
                                    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'')  AS "estimateTime",
                                    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'')  AS "realityTime",
                                    plan.plan_type AS "planType",
                                    plan.id AS "planId",
                                    nvl(sp.project_name, sps.stage_full_name) AS "originProj",
                                    plan.plan_name AS "originPlan",
                                    node.duty_department AS "dutyDept",
                                    unit.org_name AS "secondCompany"
                          from SYS_MSG_RECORD_BIZ smrb
                                   left join SYS_MSG_RECORD_SMS smrs on smrs.MSG_RECORD_BIZ_ID = smrb.ID
                                   left join sys_user sy on smrs.sender_id = sy.user_code
                                   left join pom_proj_plan_node node on smrb.BIZ_KEY = node.id
                                   left join pom_proj_plan plan on node.proj_plan_id = plan.id
                                   left join sys_project sp on plan.proj_id = sp.id
                                   left join sys_project_stage sps on plan.proj_id = sps.id
                                   left join sys_business_unit unit on plan.company_id = unit.id
                          where smrb.biz_msg_category = ''催办消息''
                            and smrb.system_id = ''71313f018a35f3a558166cba7599b5d6''
                            and plan.plan_type = ''关键节点计划''
                            and plan.approval_status = ''已审核''
                            and sy.id = '''||REMINDERGUID||'''
                            and node.is_disable = 0
                          union
                            select
                                node.id AS "id",
                                node.original_node_id  AS "nodeOriginalId",
                                --未到期不亮灯
                                case WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
                                    --到期当天内完成反馈
                                     when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
                                         then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
                                    --到期1-5天内完成反馈
                                    when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
                                         then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                --到期未反馈黄灯
                                WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 0 and 5
                                         THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                --到期超过5天未反馈红灯
                                WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(NODE.PLAN_END_DATE)) >5)
                                         THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
                                     ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END AS "warnState",
                                case when node.actual_end_date is not null
                                        then ''已完成''
                                    when to_char(node.plan_end_date,''YYYY-MM-DD'') >to_char(sysdate,''YYYY-MM-DD'') and node.actual_end_date is  null
                                        then ''未到期''
                                    when TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') < TO_CHAR(sysdate, ''YYYY-MM-DD'') and node.actual_end_date is  null
                                        then ''<span style="color:red">已超期</span>'' end as "taskState" ,
                                TO_CHAR(smrb.created_time, ''YYYY-MM-DD'')  AS "urgeTime",
                                node.node_name AS "taskName",
                                node.node_level  AS "taskLevel",
                                TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'')  AS "planTime",
                                TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'')  AS "estimateTime",
                                TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'')  AS "realityTime",
                                plan.plan_type AS "planType",
                                plan.id AS "planId",
                                nvl(sp.project_name, sps.stage_full_name) AS "originProj",
                                plan.plan_name AS "originPlan",
                                node.duty_department AS "dutyDept",
                                unit.org_name AS "secondCompany"
                          from SYS_MSG_RECORD_BIZ smrb
                              left join SYS_MSG_RECORD_WECHAT smrw on smrw.MSG_RECORD_BIZ_ID = smrb.ID
                              left join sys_user sy on smrw.sender_id = sy.user_code
                              left join pom_proj_plan_node node on smrb.BIZ_KEY = node.id
                              left join pom_proj_plan plan on node.proj_plan_id = plan.id
                              left join sys_project sp on plan.proj_id = sp.id
                              left join sys_project_stage sps on plan.proj_id = sps.id
                              left join sys_business_unit unit on plan.company_id = unit.id
                          where
                              smrb.biz_msg_category = ''催办消息''
                            and smrb.system_id = ''71313f018a35f3a558166cba7599b5d6''
                            and plan.plan_type=''关键节点计划''
                            and plan.approval_status=''已审核''
                            and sy.id='''||REMINDERGUID||'''
                            and node.is_disable = 0
                        union
                            select
                                node.id AS "id",
                                node.original_node_id  AS "nodeOriginalId",
                                --未到期不亮灯
                                case WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
                                    --到期当天内完成反馈
                                     when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
                                         then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
                                    --到期1-5天内完成反馈
                                    when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
                                         then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                --到期未反馈黄灯
                                WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 0 and 5
                                         THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                --到期超过5天未反馈红灯
                                WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(NODE.PLAN_END_DATE)) >5)
                                         THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
                                     ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END AS "warnState",
                                case when node.actual_end_date is not null
                                        then ''已完成''
                                    when to_char(node.plan_end_date,''YYYY-MM-DD'') >to_char(sysdate,''YYYY-MM-DD'') and node.actual_end_date is  null
                                        then ''未到期''
                                    when TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') < TO_CHAR(sysdate, ''YYYY-MM-DD'') and node.actual_end_date is  null
                                        then ''<span style="color:red">已超期</span>'' end as "taskState" ,
                                TO_CHAR(smc.created, ''YYYY-MM-DD'')  AS "urgeTime",
                                node.node_name AS "taskName",
                                node.node_level  AS "taskLevel",
                                TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'')  AS "planTime",
                                TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'')  AS "estimateTime",
                                TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'')  AS "realityTime",
                                plan.plan_type AS "planType",
                                plan.id AS "planId",
                                nvl(sp.project_name, sps.stage_full_name) AS "originProj",
                                plan.plan_name AS "originPlan",
                                node.duty_department AS "dutyDept",
                                unit.org_name AS "secondCompany"
                          from sys_message_center smc
                              left join sys_user sy on smc.creator_name = sy.user_code
                              left join pom_proj_plan_node node on smc.task_id = node.id
                              left join pom_proj_plan plan on node.proj_plan_id = plan.id
                              left join sys_project sp on plan.proj_id = sp.id
                              left join sys_project_stage sps on plan.proj_id = sps.id
                              left join sys_business_unit unit on plan.company_id = unit.id
                          where
                              smc.biz_msg_category = ''催办消息''
                            and plan.plan_type=''关键节点计划''
                            and plan.approval_status=''已审核''
                            and sy.id=:c
                            and node.is_disable = 0 )total';
     execute immediate v_count into total using REMINDERGUID;
    --dbms_output.put_line(v_sql);

     open items FOR v_sql;

END POM_KEY_NODE_MY_REMINDER;

/
--------------------------------------------------------
--  DDL for Procedure POM_KEY_NODE_MY_WATCH
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM_KEY_NODE_MY_WATCH" 
(
    WatcherID    IN VARCHAR2,
    pageIndex    IN INT,
    pageSize     IN INT,
    total        OUT INT,
    items        OUT SYS_REFCURSOR
)
    IS
    v_count clob;
    v_sql clob;
BEGIN
    v_sql := 'SELECT *
    FROM (SELECT tt.*, ROWNUM AS rowno
          FROM (
                   select
                       node.id AS "id",
                       node.node_Name AS "taskName",
                       node.original_node_id  AS "nodeOriginalId",			
                       plan.id AS "planId",
                       case
                           --未到期不亮灯
                           WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
                           --到期当天内完成反馈
                           when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
                               then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
                           --到期1-5天内完成反馈
                           when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
                               then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                           --到期未反馈黄灯
                           WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 0 and 5
                               THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                           --到期超过5天未反馈红灯
                           WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(NODE.PLAN_END_DATE)) >5)
                               THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
                           ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' end as "warnState",
                       case when node.actual_end_date is not null
                                then ''已完成''
                            when to_char(node.plan_end_date,''YYYY-MM-DD'') >to_char(sysdate,''YYYY-MM-DD'') and node.actual_end_date is  null
                                then ''未到期''
                            when TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') < TO_CHAR(sysdate, ''YYYY-MM-DD'') and node.actual_end_date is  null
                                then ''<span style="color:red">已超期</span>'' end as "taskState" ,
                       TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') AS "planTime",
                       case when feed.approval_status = ''已审核''
                            then TO_CHAR(node.ESTIMATE_END_DATE, ''YYYY-MM-DD'')
                       else '''' end AS "estimateTime",
                       TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') AS "realityTime",
                       plan.plan_type AS "planType",
                       nvl(sp.project_name, sps.stage_full_name) AS "originProj",
                       plan.plan_name AS "originPlan",
                       node.node_level AS "taskLevel",
                       node.duty_department AS "dutyDept",
                       unit.org_name AS "secondCompany"
                   from sys_biz_watch sbw
                             left join pom_proj_plan_node node on sbw.biz_id = node.id
                            left join pom_proj_plan plan on node.proj_plan_id = plan.id
                            left join pom_node_feedback feed on node.feedback_id = feed.id
                            left join sys_project sp on plan.proj_id = sp.id
                            left join sys_project_stage sps on plan.proj_id = sps.id
                            left join sys_business_unit unit on plan.company_id = unit.id
                   where is_un_watch = 0 and watcher_id = '''||WatcherID||''' and plan.plan_type=''关键节点计划'' and plan.approval_status=''已审核'' and node.is_disable = 0 order by node.plan_end_date asc
               ) tt
           WHERE ROWNUM <= '||pageSize||' * '||pageIndex||') table_alias
 WHERE table_alias.rowno >= '||pageSize||' * ('||pageIndex||'-1) + 1';
    v_count := 'select count(*) from sys_biz_watch sbw
                             left join pom_proj_plan_node node on sbw.biz_id = node.id
                            left join pom_proj_plan plan on node.proj_plan_id = plan.id
                            left join pom_node_feedback feed on node.feedback_id = feed.id
                            left join sys_project sp on plan.proj_id = sp.id
                            left join sys_project_stage sps on plan.proj_id = sps.id
                            left join sys_business_unit unit on plan.company_id = unit.id
                   where is_un_watch = 0 and watcher_id = :c and plan.plan_type=''关键节点计划'' and plan.approval_status=''已审核'' and node.is_disable = 0 order by node.plan_end_date asc';
     execute immediate v_count into total using WatcherID;
    --dbms_output.put_line(v_sql);
    open items for v_sql;
END POM_KEY_NODE_MY_WATCH;

/
--------------------------------------------------------
--  DDL for Procedure POM_KEY_NODE_SCHEDULE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM_KEY_NODE_SCHEDULE" 
(
    companyGUID IN VARCHAR2,
    items OUT SYS_REFCURSOR
)IS
    v_sql clob;
    v_id clob;
BEGIN
    IF companyGUID IS NULL THEN
        v_id := '0001';
    ELSE
        v_id := companyGUID;
    END IF;
    v_sql :='with temp_origin as (
        select connect_by_isleaf as IS_END ,org.*,project_name,nvl(validtasks,0) AS validTasks,nvl(completenum,0) AS completenum,nvl(completed,0) AS completed,nvl(unfinished,0) AS unfinished,nvl(needResult,0) AS needResult,nvl(realResult,0) AS realResult,nvl(greenLight,0) AS greenLight,
        nvl(yellowLight,0) AS yellowLight,nvl(redlight,0) AS redlight,nvl(micompletenum,0) AS micompletenum,nvl(micompleted,0) AS micompleted,nvl(miunfinished,0) AS miunfinished,
        nvl(olcompletenum,0) AS olcompletenum,nvl(olcompleted,0) AS olcompleted,nvl(olunfinished,0) AS olunfinished,completionrate,dynamicresult
        from (
        select *
        from (select id, org_name as company, org_full_name, parent_id, ''1'' as isCompany,'''' as jumpUrl,order_hierarchy_code as code
        from sys_business_unit
        where is_company = 1)
        union
        select id, project_name as company, '''' as org_full_name, unit_id as parent_id, ''0'' as isCompany,''/pom/plan-assess/node-monitoring/plan-nodes?companyid=''||proj.unit_id||''&ppid=''||proj.id||''&planType=关键节点计划'' as jumpUrl,'''' as code
        from sys_project proj
        union
        select *
        from (select stage.id, stage.stage_full_name as company, stage.stage_full_name as org_full_name, stage.project_id as parent_id, ''0'' as isCompany,''/pom/plan-assess/node-monitoring/plan-nodes?companyid=''||sysP.unit_id||''&ppid=''||stage.id||''&planType=关键节点计划'' as jumpUrl,'''' as code
        from sys_project_stage stage left join sys_project sysP on stage.project_id = sysP.id
        order by stage.sn desc)
        ) org --组织主表
        left join
        (
        select proj.*,
        case when proj.validTasks is null or proj.validTasks = 0 or proj.completed = 0 then
        ''0''
        else to_char((proj.completed / proj.validTasks)*100, ''9999999990.00'') end as completionRate,
        case when proj.needResult is null or proj.needResult = 0 or proj.realResult = 0 then
        ''0''
        else to_char((proj.realResult / proj.needResult)*100, ''9999999990.00'') end as dynamicResult
        FROM (
        select A.*,B.completeNum,C.completed,D.unfinished,N.needResult,O.realResult,E.greenLight,F.yellowLight,G.redLight,H.miCompleteNum,I.miCompleted,J.miUnfinished,
        K.olCompleteNum,L.olCompleted,M.olUnfinished
        from (
        select sp.id, sp.project_name, nvl(count(node.id), 0) as validTasks
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --有效节点
        ) A
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS completeNum
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where to_char(node.plan_end_date, ''YYYY-MM-DD'') <= to_char(sysdate, ''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --应完成
        ) B ON A.ID = B.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS completed
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.actual_end_date is not null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --已完成
        ) C ON A.ID = C.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS unfinished
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.actual_end_date is null
        and node.is_disable = 0
        and to_char(node.plan_end_date,''YYYY-MM-DD'') <= to_char(sysdate,''YYYY-MM-DD'')
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --未完成
        ) D ON A.ID = D.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS greenLight
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where (TRUNC(ACTUAL_END_DATE) - trunc(PLAN_END_DATE)) <= 0
        and actual_end_date is null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --绿灯
        ) E ON A.ID = E.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS yellowLight
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where (((TRUNC(ACTUAL_END_DATE) - trunc(PLAN_END_DATE)) BETWEEN 1 and 5) or
        ((trunc(SYSDATE) - trunc(PLAN_END_DATE)) BETWEEN 0 and 5))
        and actual_end_date is null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --黄灯
        ) F ON A.ID = F.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS redLight
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where ACTUAL_END_DATE IS NULL
        and ((trunc(SYSDATE) - trunc(NODE.PLAN_END_DATE)) > 5)
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --红灯
        ) G ON A.ID = G.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS miCompleteNum
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''里程碑''
        and to_char(node.plan_end_date, ''YYYY-MM-DD'') <= to_char(sysdate, ''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --里程碑应完成
        ) H ON A.ID = H.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS miCompleted
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''里程碑''
        and actual_end_date is not null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --里程碑已完成
        ) I ON A.ID = I.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS miUnfinished
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''里程碑''
        and to_char(node.plan_end_date,''YYYY-MM-DD'') <= to_char(sysdate,''YYYY-MM-DD'')
        and ACTUAL_END_DATE IS NULL
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --里程碑未完成
        ) J ON A.ID = J.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS olCompleteNum
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''一级节点''
        and to_char(node.plan_end_date, ''YYYY-MM-DD'') <= to_char(sysdate, ''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --一级节点应完成
        ) K ON A.ID = K.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS olCompleted
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''一级节点''
        and actual_end_date is not null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --一级节点已完成
        ) L ON A.ID = L.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS olUnfinished
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''一级节点''
        and ACTUAL_END_DATE IS NULL
        and to_char(node.plan_end_date,''YYYY-MM-DD'') <= to_char(sysdate,''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --一级节点未完成
        ) M ON A.ID = M.ID

        left join
        (
        select sp.id, sp.project_name, nvl(sum(node.standard_score), 0) AS needResult
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --应得总分
        ) N ON A.ID = N.ID
        left join
        (
        select sp.id, sp.project_name, nvl(sum(exam.standard_score), 0) AS realResult
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        left join pom_node_examination exam on node.id = exam.original_node_id
        where node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --实际得分
        ) O ON A.ID = O.ID
        )proj
        union
        select projs.*,
        case when projs.validTasks is null or projs.validTasks = 0 or projs.completed = 0 then
        ''0''
        else to_char((projs.completed / projs.validTasks)*100, ''9999999990.00'') end as completionRate,
        case when projs.needResult is null or projs.needResult = 0 or projs.realResult = 0 then
        ''0''
        else to_char((projs.realResult / projs.needResult)*100, ''9999999990.00'') end as dynamicResult
        FROM (
        select A.*,B.completeNum,C.completed,D.unfinished,N.needResult,O.realResult,E.greenLight,F.yellowLight,G.redLight,H.miCompleteNum,I.miCompleted,J.miUnfinished,
        K.olCompleteNum,L.olCompleted,M.olUnfinished
        from (
        select sp.id,sp.stage_full_name as project_name, nvl(count(node.id), 0) as validTasks
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --有效节点
        ) A
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS completeNum
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where to_char(node.plan_end_date, ''YYYY-MM-DD'') <= to_char(sysdate, ''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --应完成
        ) B ON A.ID = B.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS completed
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.actual_end_date is not null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --已完成
        ) C ON A.ID = C.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS unfinished
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.actual_end_date is null
        and node.is_disable = 0
        and to_char(node.plan_end_date,''YYYY-MM-DD'') <= to_char(sysdate,''YYYY-MM-DD'')
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --未完成
        ) D ON A.ID = D.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS greenLight
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where (TRUNC(ACTUAL_END_DATE) - trunc(PLAN_END_DATE)) <= 0
        and actual_end_date is null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --绿灯
        ) E ON A.ID = E.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS yellowLight
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where (((TRUNC(ACTUAL_END_DATE) - trunc(PLAN_END_DATE)) BETWEEN 1 and 5) or
        ((trunc(SYSDATE) - trunc(PLAN_END_DATE)) BETWEEN 0 and 5))
        and actual_end_date is null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --黄灯
        ) F ON A.ID = F.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS redLight
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where ACTUAL_END_DATE IS NULL
        and ((trunc(SYSDATE) - trunc(NODE.PLAN_END_DATE)) > 5)
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --红灯
        ) G ON A.ID = G.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS miCompleteNum
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''里程碑''
        and to_char(node.plan_end_date, ''YYYY-MM-DD'') <= to_char(sysdate, ''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --里程碑应完成
        ) H ON A.ID = H.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS miCompleted
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''里程碑''
        and actual_end_date is not null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --里程碑已完成
        ) I ON A.ID = I.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS miUnfinished
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''里程碑''
        and ACTUAL_END_DATE IS NULL
        and to_char(node.plan_end_date,''YYYY-MM-DD'') <= to_char(sysdate,''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --里程碑未完成
        ) J ON A.ID = J.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS olCompleteNum
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''一级节点''
        and to_char(node.plan_end_date, ''YYYY-MM-DD'') <= to_char(sysdate, ''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --一级节点应完成
        ) K ON A.ID = K.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS olCompleted
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''一级节点''
        and actual_end_date is not null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --一级节点已完成
        ) L ON A.ID = L.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS olUnfinished
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''一级节点''
        and ACTUAL_END_DATE IS NULL
        and to_char(node.plan_end_date,''YYYY-MM-DD'') <= to_char(sysdate,''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --一级节点未完成
        ) M ON A.ID = M.ID

        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(sum(node.standard_score), 0) AS needResult
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --应得总分
        ) N ON A.ID = N.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(sum(exam.standard_score), 0) AS realResult
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        left join pom_node_examination exam on node.id = exam.original_node_id
        where node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --实际得分
        ) O ON A.ID = O.ID
        )projs
        ) statistics on org.id = statistics.id    --节点统计
        start with org.id = '''||v_id||'''
        connect by prior org.id = parent_id
        )
    SELECT fullAll.*,CASE WHEN fullAll.ISEND =''1'' and fullAll.isCompany=''0'' then
                                  ''<span style="color:#409eff">''||company||''</span>''
                          else company end as "company"
    FROM (
             SELECT id as "id",t1.company as company,org_full_name as "fullName",parent_id as "parentId", to_char(IS_END) AS isEnd,t1.isCompany, t1.jumpUrl as "jumpUrl",
                    (select sum(validTasks) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "validTasks",
                    (select sum(completenum) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "completeNum",
                    (select sum(completed) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "completed",
                    (select sum(unfinished) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "unfinished",
                    (select sum(needResult) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "needResult",
                    (select sum(realResult) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "realResult",
                    (select sum(greenLight) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "greenLight",
                    (select sum(yellowLight) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "yellowLight",
                    (select sum(redlight) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "redLight",
                    (select sum(micompletenum) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "miCompleteNum",
                    (select sum(micompleted) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "miCompleted",
                    (select sum(miunfinished) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "miUnfinished",
                    (select sum(olcompletenum) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "olCompleteNum",
                    (select sum(olcompleted) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "olCompleted",
                    (select sum(olunfinished) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "olUnfinished",
                    case when
                                     (select sum(completeNum) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) is null or
                                     (select sum(completeNum) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) = 0 or
                                     (select sum(completed) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) = 0 then
                             ''0%''
                         else to_char(((select sum(completed) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) /
                                       (select sum(completeNum) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id))*100, ''9999999990.00'') ||''%'' end as "completionRate",
                    case when
                                     (select sum(needResult) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) is null or
                                     (select sum(needResult) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) = 0 or
                                     (select sum(realResult) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) = 0 then
                             ''0''
                         else to_char(((select sum(realResult) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) /
                                       (select sum(needResult) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id))*100, ''9999999990.00'') end as "dynamicResult",
                    (select count(validTasks) from temp_origin  where isCompany =''0''  start with t1.id=parent_id connect by prior id=parent_id ) as "childrenLength"
             FROM temp_origin t1 order by t1.code
         ) fullAll where (fullAll."childrenLength">0 and fullAll."childrenLength" is not null and fullAll.isCompany =''1'') or fullAll.isCompany = ''0''';
    open items for v_sql;

END POM_KEY_NODE_SCHEDULE;

/
