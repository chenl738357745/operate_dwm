--------------------------------------------------------
--  文件已创建 - 星期四-五月-21-2020   
--------------------------------------------------------
--------------------------------------------------------
--  DDL for Procedure CHENL_P_SYS_GET_COMPANY_TREE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."CHENL_P_SYS_GET_COMPANY_TREE" (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    data_auth_info   OUT              SYS_REFCURSOR
) AS
--获取公司树
--作者：谷国斌
--日期：2019/12/13
    rulevalue   VARCHAR2(50);
    authcount   INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    spid        VARCHAR2(36);--使用临时表的批次号
BEGIN
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;
--插入集团作为根节点

    INSERT INTO tmp_company_tree (
        id,
        org_id,
        org_name,
        org_type,
        parent_id,
        is_company,
        order_code
    )
        SELECT
            spid,
            id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_hierarchy_code
        FROM
            sys_business_unit
        WHERE
            id = '003200000000000000000000000000';

--获取隔离规则：

    SELECT
        isolation_rule_value
    INTO rulevalue
    FROM
        sys_data_auth_biz
    WHERE
        biz_obj_code = bizcode;

    IF rulevalue = '全集团' THEN
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                is_company,
                order_hierarchy_code
            FROM
                sys_business_unit
            WHERE
                is_company = 1;

    ELSE 
--插入本公司及其父级
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                is_company,
                order_hierarchy_code
            FROM
                sys_business_unit
            WHERE
                is_company = 1
            START WITH
                id = companyid
            CONNECT BY
                PRIOR parent_id = id;

--插入数据授权的数据：

        DECLARE
            ownerid     VARCHAR2(36);
            oenertype   NVARCHAR2(50);
            CURSOR cursor_company IS
            SELECT DISTINCT
                auth_owner_id,
                auth_owner_type
            FROM
                sys_data_auth
            WHERE
                auth_biz_code = bizcode
                AND is_disabled = 0;

        BEGIN   

            --打开游标
            OPEN cursor_company;
            LOOP
                FETCH cursor_company INTO
                    ownerid,
                    oenertype;
                EXIT WHEN cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                IF oenertype = '公司' OR oenertype = '集团' THEN
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                        AND id = companyid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF oenertype = '部门' THEN
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 0
                        AND id = deptid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                    INSERT INTO tmp_auth_owner (
                        id,
                        auth_owner_id,
                        auth_owner_type
                    ) VALUES (
                        spid,
                        ownerid,
                        oenertype
                    );

                END IF;

            END LOOP;

            CLOSE cursor_company;
        END;   

          --获取有权限的公司及其父级：            
        DBMS_OUTPUT.PUT_LINE('获取有权限的公司及其父级');
        DECLARE
            ownerid2 VARCHAR2(36);
            CURSOR cursor_auth IS
            SELECT
                auth_owner_id
            FROM
                tmp_auth_owner
            WHERE
                id = spid;

        BEGIN   

                    --打开游标
            OPEN cursor_auth;
            LOOP
                FETCH cursor_auth INTO ownerid2;
                
                EXIT WHEN cursor_auth%notfound;



                            --授权对象为公司：
                            --取授权公司的子级：
                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type IN (
                                    '公司',
                                    '集团'
                                )
                        )
                    CONNECT BY
                        PRIOR id = parent_id;


                            --取授权公司的父级：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type IN (
                                    '公司',
                                    '集团'
                                )
                        )
                    CONNECT BY
                        PRIOR parent_id = id;

                             --授权对应为部门：
                               --取授权部门的父级：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type = '部门'
                        )
                    CONNECT BY
                        PRIOR parent_id = id;
                --授权对应为项目：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT
                                unit_id
                            FROM
                                sys_project
                            WHERE
                                id IN (
                                    SELECT DISTINCT
                                        auth_scope_id
                                    FROM
                                        sys_data_auth
                                    WHERE
                                        auth_biz_code = bizcode
                                        AND is_disabled = 0
                                        AND auth_owner_id = ownerid2
                                        AND auth_scope_type = '项目'
                                        and auth_type='项目'
                                )
                        )
                    CONNECT BY
                        PRIOR parent_id = id;

            END LOOP;

            CLOSE cursor_auth;
        END;

    END IF;

    OPEN data_auth_info FOR SELECT DISTINCT
                               org_id       AS orgid,
                               org_name     AS orgname,
                               org_type     AS orgtype,
                               parent_id    AS parentid,
                               is_company   AS iscompany,
                               order_code   AS ordercode
                           FROM
                               tmp_company_tree
                           WHERE
                               id = spid
                           ORDER BY
                               order_code;

END chenl_p_sys_get_company_tree;

/
--------------------------------------------------------
--  DDL for Procedure P_API_ROLE_USER_RELATION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_API_ROLE_USER_RELATION" AS
BEGIN
    delete from SYS_ROLE_USER_RELATION_RESULT where ROLE_TYPE='30';
	--添加数据到目标表  
	insert into SYS_ROLE_USER_RELATION_RESULT(ID,ROLE_TYPE,ROLE_CODE,ROLE_NAME,USER_ACCOUNT,USER_NAME,PROJECT_ID,PROJECT_NAME,CREATED) 
		SELECT get_uuid(),'30',ROLECODE,ROLENAME,USERACCOUNT,USERNAME,PROJECTID,PROJECTNAME,sysdate FROM API_ROLE_USER_RELATION where USERACCOUNT is not null;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_API_TRANS_MANAGEMENT_NODE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_API_TRANS_MANAGEMENT_NODE" AS
BEGIN
	--去重，否则有可能违反主键约束。原因是发现从集团抓取的数据有重复id的情况。
	delete from API_MANAGEMENT_NODE a where (a.ID) in (
		select ID from API_MANAGEMENT_NODE group by ID having count(*) > 1) and rowid not in (
			select min(rowid) from API_MANAGEMENT_NODE group by ID having count(*)>1);
	
	--组织表
	delete from SYS_BUSINESS_UNIT;
	--新增公司
	insert into SYS_BUSINESS_UNIT(ID,ORG_NAME,PARENT_ID,ORG_TYPE,ORDER_CODE,IS_COMPANY) 
		SELECT lower(ID),NAME,lower(PID),'0' as NODETYPE,ORDERNUM as ORDER_CODE,1 as IS_COMPANY 
			FROM API_MANAGEMENT_NODE where NODETYPE = 1;
	--新增部门
	insert into SYS_BUSINESS_UNIT(ID,ORG_NAME,PARENT_ID,ORG_TYPE,ORDER_CODE,IS_COMPANY) 
		SELECT lower(ID),NAME,lower(PID),'1' as NODETYPE,ORDERNUM as ORDER_CODE,0 as IS_COMPANY 
			FROM  API_MANAGEMENT_NODE where NODETYPE = 2;
		
	
	--岗位表
	delete from SYS_STATION;
	insert into SYS_STATION(ID,STATION_NAME,ORG_ID) 
		SELECT lower(ID),NAME,lower(PID) 
			FROM API_MANAGEMENT_NODE where NODETYPE = 3;
	 
	--用户表
	delete from SYS_USER;
	--只有alpha测试环境才需要 PASSWORD 数据，默认为 123
	insert into SYS_USER(ID,USER_CODE,USER_NAME,EMAIL,PASSWORD) 
		SELECT DISTINCT lower(USERID),USERACCOUNT，NAME,EMAIL,'$2a$10$ogMzoaGWd4MFaPX6E/z7x.gzZ9CbbiaXWvnujsSVnVm2Okj10U5Gq' 
			FROM API_MANAGEMENT_NODE where NODETYPE = 4;
	
	--只有alpha测试环境才需要 admin 账号
	--insert into SYS_USER(ID,USER_CODE,USER_NAME,PASSWORD) VALUES('9604c692-e3d0-6e95-e053-0100007f8f52','admin','admin','$2a$10$ogMzoaGWd4MFaPX6E/z7x.gzZ9CbbiaXWvnujsSVnVm2Okj10U5Gq');
	 
	 --用户岗位关系表
	delete from SYS_STATION_TO_USER;
	 
	insert into SYS_STATION_TO_USER (ID,STATION_ID,USER_ID) 
		SELECT lower(get_uuid()) as STATION_TO_USER_ID,lower(PID),lower(USERID) 
			FROM API_MANAGEMENT_NODE where NODETYPE = 4;
            
   
    --计算组织层级：
     DECLARE
                    levelcount   int;
                    orgid varchar(36);
                    CURSOR cursor_calc IS
                    SELECT
                        id
                    FROM
                        sys_business_unit;

                BEGIN                                                  
                --打开游标
                    OPEN cursor_calc;
                    loop
                        fetch cursor_calc into orgid;
                        exit when cursor_calc%notfound;
                            begin
                             select count(*) into levelcount FROM  sys_business_unit  
                                 START WITH ID=orgid  CONNECT BY PRIOR  parent_id=ID;
                                exception
                                        when NO_DATA_FOUND then 
                                        levelcount:=0;
                            end;
                            update sys_business_unit set level_rank=levelcount where id=orgid;
                    end loop;

                    close cursor_calc;

                END;   
                
   
     --计算全局编码：
     DECLARE
                    
                    parentcode varchar(500);
                    orgid varchar(36);
                    CURSOR cursor_calc2 IS
                    SELECT
                        id
                    FROM
                        sys_business_unit;

                BEGIN                                                  
                --打开游标
                    OPEN cursor_calc2;
                    loop
                        fetch cursor_calc2 into orgid;
                        exit when cursor_calc2%notfound;
                        
                     
                            begin
                             select replace(wm_concat(order_code),',','.') into parentcode from (
                                    select replace(lpad(order_code,3),' ','0') as order_code FROM      sys_business_unit 
                                        START WITH ID=orgid  CONNECT BY PRIOR  parent_id=ID
                                        order by level_rank) ds;
                                exception
                                        when NO_DATA_FOUND then 
                                        parentcode:='';
                            end;
                     
                                update sys_business_unit set order_hierarchy_code=parentcode where id=orgid;

                            
                    end loop;

                    close cursor_calc2;

                END;      


--计算组织人数：
     DECLARE
                    total int;
                    orgid varchar(36);
                    CURSOR cursor_calc2 IS
                    SELECT
                        id
                    FROM
                        sys_business_unit;

                BEGIN                                                  
                --打开游标
                    OPEN cursor_calc2;
                    loop
                        fetch cursor_calc2 into orgid;
                        exit when cursor_calc2%notfound;
                        
                            begin
                              select count(distinct user_id) into total from (                                      
                                  select id FROM  sys_business_unit  
                                   START WITH ID=orgid  CONNECT BY PRIOR  ID=parent_id) ds inner join 
                                   (select org_id,user_id from sys_station a inner join SYS_STATION_TO_USER b on a.id=b.station_id) b 
                                   on ds.id=b.org_id;
                                exception
                                        when NO_DATA_FOUND then 
                                        total:=0;
                            end;
 
                                update sys_business_unit set staff_total=total where id=orgid;
                            
                    end loop;

                    close cursor_calc2;

                END;  	

UPDATE SYS_BUSINESS_UNIT A
    SET    A.ORG_FULL_NAME =
				(WITH TMP(ORGID, ORGNAME, ORGFULLNAME) AS (SELECT A1.ID, A1.ORG_NAME, A1.ORG_NAME
															FROM   SYS_BUSINESS_UNIT A1
															WHERE  A1.ID = '003200000000000000000000000000'
															UNION ALL
															SELECT B2.ID, B2.ORG_NAME, A2.ORGFULLNAME || '->' || B2.ORG_NAME
															FROM   TMP A2
															INNER  JOIN SYS_BUSINESS_UNIT B2
															ON     A2.ORGID = B2.PARENT_ID)
						SELECT ORGFULLNAME FROM TMP B WHERE A.ID = B.ORGID);
						
--调用存储过程，写入用户与岗位的关系到SYS_ROLE_USER_RELATION_RESULT 目标表
P_API_TRANS_STATION_USER();
	-----更新用户手机 chenl 2020-02-28 定时任务获取手机有问题暂时同步api表手机号码
    update sys_user  set mobile_phone=(select mobile from api_user  where api_user.USERACCOUNT = sys_user.USER_CODE);

    
     commit;                     

END P_API_TRANS_MANAGEMENT_NODE;

/
--------------------------------------------------------
--  DDL for Procedure P_API_TRANS_PROJECT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_API_TRANS_PROJECT" AS
BEGIN
		--描述：整理API_PROJECT表中从集团抓取过来的数据。
		--作者：雷吉
		--日期：2019/11/22

		DELETE FROM SYS_PROJECT;
		UPDATE API_PROJECT_NEW SET SN = '0' WHERE SN = 'null';
		--插入项目
		INSERT INTO SYS_PROJECT
				(ID, PROJECT_NAME, PROJECT_CODE, ADDRESS, VICE_PM_NAME, UNIT_NAME,
				 CORP_ID, UPDATE_USER_ID, CITY_CODE, COPR_ID, UPDATE_USER, CORP_NAME,
				 COPR_NAME, VICE_PM_ID, CITY_NAME, STRUCT_TYPE, UNIT_ID, SN,
				 PROJECT_STATE)
		
	/*			SELECT PP.ID, PP.PROJECT_NAME, PP.PROJECT_CODE, PP.PROJ_ADDRESS,
							 PP.VICE_PM_NAME, PP.COMPANY_NAME, PP.CORP_ID, PP.CREATOR_ID,
							 PP.CITY_CODE, PP.COPR_ID, PP.CREATOR, PP.CORP_NAME,
							 PP.COPR_NAME, PP.VICE_PM_ID, PP.PROVINCE_NAME, PP.STRUCT_TYPE,
							 PP.COMPANY_ID, PP.SN, PP.PROJECT_STATE
				FROM   (SELECT ROW_NUMBER() OVER(PARTITION BY P.PROJECT_ORIGINAL_ID ORDER BY P.PROJECT_VERSION) AS NUM,
												LOWER(P.PROJECT_ORIGINAL_ID) AS ID, P.PROJECT_NAME,
												P.PROJECT_CODE, P.PROJ_ADDRESS, NULL AS VICE_PM_NAME,
												P.COMPANY_NAME, NULL AS CORP_ID, P.CREATOR_ID,
												NULL AS CITY_CODE, NULL AS COPR_ID, P.CREATOR,
												P.LEGAL_PERSON_COMPANY AS CORP_NAME,
												P.LEGAL_PERSON_COMPANY AS COPR_NAME,
												NULL AS VICE_PM_ID, P.PROVINCE_NAME,
												NULL AS STRUCT_TYPE, P.COMPANY_ID, '0' AS SN,
												NULL AS PROJECT_STATE
								 FROM   MDM_PROJECT P
								 WHERE  P.APPROVAL_STATUS = '已审核') PP
				WHERE  PP.NUM = 1;*/
		        SELECT LOWER(ID), NAME, CODE, ADDRESS, VICEPMNAME, UNITNAME, CORPID,
           UPDATEUSERID, CITYCODE, COPRID, UPDATEUSER, CORPNAME,
           COPRNAME, VICEPMID, CITYNAME, STRUCTTYPE, LOWER(UNITID),
           TO_NUMBER(SN), STATE
    FROM   API_PROJECT_NEW;
		COMMIT;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_API_TRANS_PROJECT_STAGE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_API_TRANS_PROJECT_STAGE" AS
BEGIN
		--描述：整理API_PROJECT_STAGE表中从集团抓取过来的数据。
		--作者：雷吉
		--日期：2019/11/22

		DELETE FROM SYS_PROJECT_STAGE;
		UPDATE API_PROJECT_STAGE SET SN = '0' WHERE SN = 'null';
		--插入项目分期
		INSERT INTO SYS_PROJECT_STAGE

				(ID, STAGE, STAGE_NAME, SN, PROJECT_STATE, PROJECT_ID)
/*				(SELECT DISTINCT LOWER(C.ID), NULL, C.PERIOD_NAME, '0', NULL,
								LOWER(B.PROJECT_ORIGINAL_ID)
				 FROM   MDM_PROJECT A
				 INNER  JOIN MDM_PERIOD_VERSION B
				 ON     A.PROJECT_ORIGINAL_ID = B.PROJECT_ORIGINAL_ID
				 INNER  JOIN MDM_PERIOD C
				 ON     B.ID = C.PERIOD_VERSION_ID
				 INNER  JOIN (SELECT ROW_NUMBER() OVER(PARTITION BY A.PROJECT_ORIGINAL_ID ORDER BY B.PERIOD_VERSION) AS NUM,
														B.PERIOD_VERSION, B.ID
										 FROM   MDM_PROJECT A
										 INNER  JOIN MDM_PERIOD_VERSION B
										 ON     A.PROJECT_ORIGINAL_ID = B.PROJECT_ORIGINAL_ID
										 \*INNER  JOIN MDM_PERIOD C
                     ON     B.ID = C.PERIOD_VERSION_ID*\
										 WHERE  B.APPROVAL_STATUS = '已审核') P
				 ON     P.ID = B.ID AND
								P.NUM = 1
				 WHERE  B.APPROVAL_STATUS = '已审核');*/

		SELECT DISTINCT LOWER(ID), STAGE, NAME, TO_NUMBER(SN), STATE,
                    LOWER(PROJECTID)
    FROM   API_PROJECT_STAGE;
		--更新分期表fullName
		COMMIT;
		UPDATE SYS_PROJECT_STAGE C
		SET    C.STAGE_FULL_NAME =
						(SELECT (PROJECT_NAME || STAGE_NAME) AS STAGE_FULL_NAME
						 FROM   SYS_PROJECT_STAGE A
						 LEFT   JOIN SYS_PROJECT B
						 ON     A.PROJECT_ID = B.ID
						 WHERE  C.ID = A.ID);
		COMMIT;
		-- SELECT lower(ID),STAGE,NAME,TO_NUMBER(SN),STATE,lower(PROJECTID) from API_PROJECT_STAGE;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_API_TRANS_STATION_USER
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_API_TRANS_STATION_USER" AS
BEGIN
  DELETE FROM sys_role_user_relation_result where role_type='120';
  
  insert into sys_role_user_relation_result(id,role_type,user_account,user_name, station_id, station_name)
  SELECT a.id,'120',c.user_code,c.user_name,b.id,b.station_name  from SYS_STATION_TO_USER a
  left join SYS_STATION b on a.station_id=b.id
  left join SYS_USER c on a.user_id=c.id;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_API_TRANS_VIRTUAL_ORG_USER
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_API_TRANS_VIRTUAL_ORG_USER" AS
		STATIONID    VARCHAR2(36);
		ORGID        VARCHAR2(36);
		DEPTID       VARCHAR2(36);
		DEPTNAME     VARCHAR2(200);
		BUSINESSID   VARCHAR2(36);
		BUSINESSNAME VARCHAR2(200);
		CURSOR CURSOR_STATION IS
				SELECT DISTINCT B.ORG_ID, A.PID FROM API_VIRTUAL_ORG_USER_bak A INNER JOIN SYS_STATION B ON A.PID = B.ID;
BEGIN
		OPEN CURSOR_STATION;
		LOOP
				FETCH CURSOR_STATION
						INTO ORGID, STATIONID;
				EXIT WHEN CURSOR_STATION%NOTFOUND;
		
				SELECT ID, ORG_NAME
				INTO   DEPTID, DEPTNAME
				FROM   SYS_BUSINESS_UNIT
				WHERE  ORG_TYPE = 1 AND
							 ROWNUM = 1
				START  WITH ID = ORGID
				CONNECT BY PRIOR PARENT_ID = ID;
				UPDATE API_VIRTUAL_ORG_USER_BAK SET DEPT_ID = DEPTID, DEPT_NAME = DEPTNAME WHERE PID = STATIONID;
		
		
				SELECT ID, ORG_NAME
				INTO   BUSINESSID, BUSINESSNAME
				FROM   SYS_BUSINESS_UNIT
				WHERE  ORG_TYPE = 0 AND
							 ROWNUM = 1
				START  WITH ID = ORGID
				CONNECT BY PRIOR PARENT_ID = ID;
				UPDATE API_VIRTUAL_ORG_USER_BAK SET COMPANY_ID = businessid, COMPANY_NAME = businessname WHERE PID = STATIONID;
		
		END LOOP;
		CLOSE CURSOR_STATION;

		COMMIT;



		DELETE FROM SYS_ROLE_USER_RELATION_RESULT WHERE ROLE_TYPE = '40';
		INSERT INTO SYS_ROLE_USER_RELATION_RESULT
				(ID, ROLE_TYPE, USER_ACCOUNT, USER_NAME, VIRTUAL_GROUP_ID, VIRTUAL_GROUP_NAME, CREATED, DEPT_ID, DEPT_NAME, COMPANY_ID, COMPANY_NAME)
				SELECT GET_UUID(), '40', USERACCOUNT, NAME, VGUID, VNAME, SYSDATE, DEPT_ID, DEPT_NAME, COMPANY_ID, COMPANY_NAME FROM API_VIRTUAL_ORG_USER_BAK;
		COMMIT;

END;

/
--------------------------------------------------------
--  DDL for Procedure P_CHENL_TEST_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_CHENL_TEST_DATA" (
    USERID IN VARCHAR2,
    STATIONID IN VARCHAR2,
    DEPTID IN VARCHAR2,
    COMPANYID IN VARCHAR2,
    authcode in VARCHAR2,
    userInfo     OUT      SYS_REFCURSOR,--当前用户信息
    data_auth_info OUT SYS_REFCURSOR,--权限数据
    plan_test_info OUT SYS_REFCURSOR,--计划测试数据
    test_out out VARCHAR2
) AS

    bizcode          VARCHAR2(200);
    data_auth_spid   VARCHAR2(200);
    orgid            VARCHAR2(200);
BEGIN
    bizcode :=nvl(authcode,'POM.JHBZYTZ.03');
    p_sys_auth_data_rule_spid(userid => userid, stationid => stationid, deptid => deptid, companyid => companyid, bizcode => bizcode
    , data_auth_spid => data_auth_spid);
---测试多输出
 test_out:='authcode=>'||bizcode;
-- 当前用户数据

    OPEN userInfo FOR SELECT  USERID as "USERID",
    STATIONID as "STATIONID",
    DEPTID as "DEPTID",
    COMPANYID as "COMPANYID",
    bizcode as "bizcode"
                  FROM
                      dual;
----权限数据
open DATA_AUTH_INFO for
select ROWNUM as s,a.orgid,p.ORG_NAME,p.ORG_NAME,p.ORG_TYPE,u.org_name as  UNIT,u.ORDER_HIERARCHY_CODE  from (select distinct ORG_ID as orgId  
from TMP_AUTH_LIST  WHERE ID=DATA_AUTH_SPID ) a 
left join V_SYS_PROJECT  p on a.orgId=p.ORG_id
left join SYS_BUSINESS_UNIT u on a.orgId=u.id;
---计划测试数据
    OPEN plan_test_info FOR select '测试' as from dual;


END p_chenl_test_data;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_ALLFILTERCONDITION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_ALLFILTERCONDITION" (filter OUT sys_refcursor)
as
begin
open filter for
select * from(
select 'isStart' as id, 'isStart' as "value",'是否已开工' as "lable",null as ParentId,1 as "sort",1 as "isChecked"  from dual
UNION
select 'isStart-01' as id,'1' as "value",'已开工' as "lable",'isStart' as ParentId,1 as "sort",1 as "isChecked"  from dual
UNION
select 'isStart-00' as id,'0' as "value",'未开工' as "lable",'isStart' as ParentId,2 as "sort",1 as "isChecked"  from dual

UNION
select  'opening' as id, 'opening' as "value",'是否已开盘' as "lable",null as ParentId,2 as "sort",0 as "isChecked"  from dual
UNION
select 'opening-01' as id ,'1' as "value",'是' as "lable",'opening' as ParentId,1 as "sort",1 as "isChecked"  from dual
UNION
select  'opening-00' as id,'0' as "value",'否' as "lable",'opening' as ParentId,2 as "sort",0 as "isChecked"  from dual

UNION
select 'openingYear' as id,'openingYear' as "value",'项目首开年份' as "lable",null as ParentId,3 as "sort",0 as "isChecked"  from dual
UNION
select 'openingYear-<2017' as id,'<2017' as "value" ,'2017年之前' as "lable",'openingYear' as ParentId,0 as "sort",0 as "isChecked"   from dual
UNION
select 'openingYear-'||to_char(tab.year) as id,to_char(tab.year) as "value",
to_char(tab.year)||'年' as "lable",
'openingYear' as ParentId,
ROWNUM+1 as "sort",
0 as "isChecked"
from (SELECT to_number(to_char(sysdate,'yyyy'))-ROWNUM+1 year FROM DUAL
CONNECT BY LEVEL<=4 order by year asc) tab

union
select 'isOperate' as id,'isOperate' as "value",'是否操盘' as "lable",null as ParentId,4 as "sort",0 as "isChecked"  from dual
UNION
select 'isOperate-01' as id ,'1' as "value",'是' as "lable",'isOperate' as ParentId,1 as "sort",0 as "isChecked"  from dual
UNION
select  'isOperate-00' as id,'0' as "value",'否' as "lable",'isOperate' as ParentId,2 as "sort",0 as "isChecked"  from dual

union
select 'isHasExistingHouse' as id,'isHasExistingHouse' as "value",'是否有现房存货' as "lable",null as ParentId,5 as "sort",0 as "isChecked"  from dual
UNION
select 'isHasExistingHouse-01' as id ,'1' as "value",'是' as "lable",'isHasExistingHouse' as ParentId,1 as "sort",0 as "isChecked"  from dual
UNION
select  'isHasExistingHouse-00' as id,'0' as "value",'否' as "lable",'isHasExistingHouse' as ParentId,2 as "sort",0 as "isChecked"  from dual


UNION
select 'obtainYear' as id, 'obtainYear' as "value",'项目获得年份' as "lable",null as ParentId,6 as "sort",0 as "isChecked"  from dual
UNION
select
'obtainYear-'||to_char(tab.year) as id,
case when ROWNUM=1 then '<='||to_char(tab.year) else to_char(tab.year) end "value",
case when ROWNUM=1 then to_char(tab.year)||'年之前' else to_char(tab.year)||'年' end "lable",
'obtainYear' as ParentId,
ROWNUM as "sort",
0 as "isChecked"
from (SELECT to_number(to_char(sysdate,'yyyy'))-ROWNUM+1 year FROM DUAL
CONNECT BY LEVEL<=5 order by year asc) tab


UNION
select  'org' as id, 'org' as "value",'二级单位' as "lable",null as ParentId,7 as "sort",0 as "isChecked"  from dual
UNION
select  'org-'||tab."value" as id,tab."value",tab."lable",tab."ParentId",ROWNUM as "sort",tab."isChecked" from (select ID as "value" ,ORG_NAME as "lable",'org' as "ParentId",ORDER_HIERARCHY_CODE as "sort",0 as "isChecked"  from SYS_BUSINESS_UNIT where LEVEL_RANK=2 order by ORDER_HIERARCHY_CODE) tab) tab 
order by tab."sort";
end P_DWM_AllFilterCondition;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_ALLPROJECTSALERATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_ALLPROJECTSALERATE" (filter in clob,keyWord in varchar2,rowCnt in number,sortField in varchar,orderby in varchar,datalist out sys_refcursor,total out number,describe out clob,allSortField out sys_refcursor)
as
begin
delete PERSON_ROLE_ANALYSIS_TABLE;
open allSortField for
SELECT COLUMN_VALUE as "fieldName" FROM table (split ('projectName,obtainDate,firstOpenDate,foSaleRateByCount,firstOpenDurationByTl,poSaleRateByMoney,siSaleRateByMoney,ehSaleRateByMoney,poSurplusSaleMoney,ehSurplusSaleMoney,siSurplusSaleMoney'));
P_DWM_PROJECTSALERATEDATALIST(
    FILTER => filter,
    KEYWORD => keyWord,
    ROWCNT => rowCnt,
    SORTFIELD => sortField,
    ORDERBY => orderby,
    ITEMS => datalist,
    TOTAL => total
  );
   describe:='符合条件的共'||FN_DWM_FONT_COLOR(total||'个项目')||'。点击表头可再次排序；点击项目名称，可穿透查看单项目去化率分析详情。';

 end P_DWM_AllProjectSaleRate;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_BRIEFINGANDK1K2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_BRIEFINGANDK1K2" (k1DataList OUT sys_refcursor,k2DataList OUT sys_refcursor,bigData  OUT sys_refcursor,k1DataSortField OUT sys_refcursor,k2DataSortField OUT sys_refcursor,k2preparedatasortfield OUT sys_refcursor,tabitems OUT sys_refcursor,k1DataListCount out number,k2DataListCount out number,k2preparedatalistcount out number)
AS  
k1_1abstract varchar2(4000);
k1_2abstract varchar2(4000);
k2_1abstract varchar2(4000);
k2_2abstract varchar2(4000);
k2_3abstract varchar2(4000);
k2_1ListCount number;
k2_3ListCount number;
k2_3_2ListCount number;
begin
SELECT details into k1_1abstract FROM dwm_sale_rate_data_briefing where CODE='k1.1' and rownum=1;
SELECT details into k1_2abstract FROM dwm_sale_rate_data_briefing where CODE='k1.2' and rownum=1;
SELECT details into k2_1abstract FROM dwm_sale_rate_data_briefing where CODE='k2.1' and rownum=1;
SELECT details into k2_2abstract FROM dwm_sale_rate_data_briefing where CODE='k2.2' and rownum=1;
SELECT details into k2_3abstract  FROM dwm_sale_rate_data_briefing where CODE='k2.3' and rownum=1;
select Count(1) into k2_1ListCount from  dwm_sale_rate_project where FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'));
select Count(1) into k2_3ListCount from  dwm_sale_rate_project where FIRST_OPEN_DATE is null and( to_number(to_char(PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) or to_number(to_char(NEW_PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')));
select Count(1) into k2_3_2ListCount from  dwm_sale_rate_project where FIRST_OPEN_DATE is null and (to_number(to_char(PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) or to_number(to_char(NEW_PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'))) and (NEW_PLAN_FIRST_OPEN_DATE< sysdate or PLAN_FIRST_OPEN_DATE< sysdate);

select count(1) into k1DataListCount from DWM_SALE_RATE_PROJECT p left join  dwm_sale_rate_by_project fo on fo.project_id=p.project_id where  p.PROJECT_NAME is not null and to_number(to_char(p.FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'));
select count(1) into k2DataListCount from dwm_sale_rate_project where FIRST_OPEN_DATE is not null and  to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'));

k2preparedatalistcount:=k2_3ListCount;
open k1DataList for  
select * from (SELECT
    fo.project_id as "projectId",
    FN_DWM_FONT_COLOR(p.PROJECT_NAME) as "projectName",
    to_char(p.FIRST_OPEN_DATE,'yyyy-mm-dd') as "firstOpenDate",
    case when fo.fo_sale_out_count is not null then
    to_char(fo.fo_sale_out_count)||'套'else
    '0套' end as "foSaleOutCount",
    case when fo.fo_sale_count is not null then
    to_char(fo.fo_sale_count)||'套'else
    '0套' end as "foSaleCount",
    case when fo.fo_sale_rate_by_count is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo.fo_sale_rate_by_count)) else 
    FN_DWM_FONT_COLOR('0%') end as "foSaleRateByCount",
    FN_DWN_AreaTo1000Square(fo.fo_sale_out_area) as "foSaleOutArea",
    FN_DWN_AreaTo1000Square(fo.fo_sale_area) as "foSaleArea",
    case when fo.fo_sale_rate_by_area is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo.fo_sale_rate_by_area)) else
    FN_DWM_FONT_COLOR('0%') end as "foSaleRateByArea",
    FN_DWN_AmountToBillionYuan(fo.fo_sale_out_money) as "foSaleOutMoney",
    FN_DWN_AmountToBillionYuan(fo.fo_sale_money) as "foSaleMoney",
    case when fo.fo_sale_rate_by_money is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo.fo_sale_rate_by_money)) else
    FN_DWM_FONT_COLOR('0%') end as "foSaleRateByMoney",
    case when fo.fo_sale_rate_by_money  is  null then
    0 else fo.fo_sale_rate_by_money end as "fo_sale_rate_by_money"
FROM
    DWM_SALE_RATE_PROJECT p left join 
    dwm_sale_rate_by_project fo on fo.project_id=p.project_id where  p.PROJECT_NAME is not null and to_number(to_char(p.FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) ) tab where  rownum<=10  order by tab."fo_sale_rate_by_money"  desc;
open k2DataList for  
select * from (SELECT
    project_id as "projectId",
    FN_DWM_FONT_COLOR(project_name) as "projectName",
    FN_DWM_FONT_COLOR(to_char(FIRST_OPEN_DATE,'yyyy-mm-dd')) as "firstOpenDate",
    to_char(take_land_date,'yyyy-mm-dd') as "takeLandDate",
    FN_DWM_FONT_COLOR(FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_TL)) as "firstOpenDurationByTL",
    to_char(PLAN_FIRST_OPEN_DATE,'yyyy-mm-dd') as "planFirstOpenDate",
    FN_DWM_DAY_CONVERT_MONTH(first_open_duration_by_plan) as "firstOpenDurationByPlan",
   Fn_DWM_DurationDaysDeal(PLAN_FIRST_OPEN_DATE,FIRST_OPEN_DATE,'label')  as "advanceFirstOpenDate",
   FIRST_OPEN_DURATION_BY_TL
FROM
    dwm_sale_rate_project where FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'))  order by FIRST_OPEN_DURATION_BY_TL desc) tab where rownum<=10;
open bigData for SELECT
    details as "describe"
FROM
    dwm_sale_rate_data_briefing where GROUP_NAME='BigDataBriefing' order by SORT;

open k1DataSortField for
SELECT COLUMN_VALUE as "fieldName" FROM table (split ('firstOpenDate,foSaleOutCount,foSaleCount,foSaleRateByCount,foSaleOutArea,foSaleArea,foSaleRateByArea,foSaleOutMoney,foSaleMoney,foSaleRateByMoney'));

open k2DataSortField for
SELECT COLUMN_VALUE as "fieldName" FROM table (split ('firstOpenDate,takeLandDate,firstOpenDurationByTL,planFirstOpenDate,firstOpenDurationByPlan'));

open k2preparedatasortfield for
SELECT COLUMN_VALUE as "fieldName" FROM table (split ('takeLandDate,planFirstOpenDate,firstOpenDurationByPlan,advanceFirstOpenDate,newPlanFirstOpenDate'));

open tabItems for
select * from (SELECT 
'1、本年首开项目去化率排行' as  "title",
k1_1abstract as  "abstract",
'k1' as "code",
1 as "sortNum"
from dual
UNION
select
'2、首开去化率变动趋势图' as  "title",
k1_2abstract as  "abstract",
'k1' as "code",
2 as "sortNum"
from dual
UNION
select
'1、本年已首开项目（'||to_char(k2_1ListCount)||'个）' as  "title",
k2_1abstract as  "abstract",
'k2' as "code",
21 as "sortNum"
from dual
UNION
select
'2、首开时间变动趋势图' as  "title",
k2_2abstract as  "abstract",
'k2' as "code",
22 as "sortNum"
from dual
UNION
select
'<p id="cache20" style=""><span style="color: rgb(64, 64, 64);" id="cache21">3、本年待首开项目（共'||to_char(k2_3ListCount)||'个，</span><span style="color: rgb(255, 0, 0);" id="cache22">其中已延误'||to_char(k2_3_2ListCount)||'个</span><span style="color: rgb(64, 64, 64);" id="cache23">）</span></p>' as  "title",
k2_3abstract as  "abstract",
'k2' as "code",
23 as "sortNum"
from dual) tab order by  tab."sortNum";
END P_DWM_briefingAndK1K2;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_BRIEFINGUPDATEBYK1
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_BRIEFINGUPDATEBYK1" 
AS  
k1 clob;
k1_1 clob;
k1_2 clob;
k1RateByBycount clob;
k1BycountMax clob;
k1BycountMin clob;
k1ProjectCount number;
k1ProjectCountByNearly3Months  number;
k1RateByCountByNearly3Months  clob;
k1ProjectRateByNearly3Months  clob;
rowCount number;
begin
select case when sum(FO_SALE_COUNT) <> 0 then fn_ConvertDecimalToPercentage((sum(FO_SALE_OUT_COUNT))/(sum(FO_SALE_COUNT))) else  fn_ConvertDecimalToPercentage(0.0) end into k1RateByBycount
from  dwm_sale_rate_project  left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id 
where FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')); 

select case when sum(FO_SALE_COUNT) <>0 then fn_ConvertDecimalToPercentage((sum(FO_SALE_OUT_COUNT))/(sum(FO_SALE_COUNT))) else fn_ConvertDecimalToPercentage(0.0) end into k1RateByCountByNearly3Months 
from  dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id 
where FIRST_OPEN_DATE is not null  and FIRST_OPEN_DATE >= ADD_MONTHS(to_date(TO_CHAR(sysdate,'yyyy-mm-dd'),'yyyy-mm-dd'), -2) and FIRST_OPEN_DATE<=sysdate;

select count(1) into k1ProjectCount  from  dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'));
select count(1) into k1ProjectCountByNearly3Months  from   dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where FIRST_OPEN_DATE is not null  and FIRST_OPEN_DATE >= ADD_MONTHS(to_date(TO_CHAR(sysdate,'yyyy-mm-dd'),'yyyy-mm-dd'), -2) and FIRST_OPEN_DATE<=sysdate;

select fn_ConvertDecimalToPercentage(max(FO_SALE_RATE_BY_COUNT)) into k1BycountMax from dwm_sale_rate_project  left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')); 
select fn_ConvertDecimalToPercentage(min(FO_SALE_RATE_BY_COUNT)) into k1BycountMin from dwm_sale_rate_project  left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id
where FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) and FO_SALE_COUNT is not null and FO_SALE_COUNT <> 0; 

select  listagg(project_name||fn_ConvertDecimalToPercentage(FO_SALE_RATE_BY_COUNT),'、') WITHIN GROUP (ORDER BY FO_SALE_RATE_BY_COUNT desc)  into k1ProjectRateByNearly3Months  from (select dwm_sale_rate_project.project_name,case when FO_SALE_RATE_BY_COUNT is null or FO_SALE_RATE_BY_COUNT=0 then 0.0 else FO_SALE_RATE_BY_COUNT end as FO_SALE_RATE_BY_COUNT
from  dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id
where FIRST_OPEN_DATE is not null  and FIRST_OPEN_DATE >= ADD_MONTHS(to_date(TO_CHAR(sysdate,'yyyy-mm-dd'),'yyyy-mm-dd'), -2) and FIRST_OPEN_DATE<=sysdate and FO_SALE_RATE_BY_COUNT <>0 and FO_SALE_RATE_BY_COUNT is not null)tab ;
k1:='<center>
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;font-size: 36px;color: #FF9900;">'||k1RateByBycount||'</span>
        </center>
        <p style="font-size:14px;text-align:center;line-height:18px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">K1首开去化率</span>
        </p>
        <p style="font-size:11px;text-align:left;line-height:20px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >1、本年实际首开项目'||k1ProjectCount|| '个项目，首开去化率均值'||k1RateByBycount||'：</span
          ><span style="font-family:''微软雅黑'';font-weight:400;"></span
          ><span style="font-family:''微软雅黑'';font-weight:400;"></span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#00CC66;">最高值'||k1BycountMax|| '</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">，</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#FF99FF;">最低值'||k1BycountMin||'</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">。</span>
        </p>
        <p style="font-size:11px;text-align:left;line-height:20px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >2、近3个月实际首开项目'||k1ProjectCountByNearly3Months||'个项目，首开去化率均值'||k1RateByCountByNearly3Months||'：</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">'||k1ProjectRateByNearly3Months||'。</span>
        </p>';
    k1_1:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">本年首开共</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k1ProjectCount|| '个项目</span><span style="font-family:''微软雅黑'';font-weight:400;">，首开去化率</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">均值'||k1RateByBycount||'</span><span style="font-family:''微软雅黑'';font-weight:400;">，</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">最高值'||k1BycountMax||'</span><span style="font-family:''微软雅黑'';font-weight:400;">、</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">最低值'||k1BycountMin||'</span><span style="font-family:''微软雅黑'';font-weight:400;">。</span></p>';
    k1_2:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">集团整体首开去化率均值为</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k1RateByBycount||'</span><span style="font-family:''微软雅黑'';font-weight:400;color:#666666;">。</span></p>';

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k1';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k1,MODIFIED=sysdate where code='k1';
    dbms_output.put_line('update--k1----'||k1);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k1',k1,1,'BigDataBriefing',sysdate);
    dbms_output.put_line('insert---k1-----'||k1);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k1.1';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k1_1,MODIFIED=sysdate where code='k1.1';
     dbms_output.put_line('update--k1.1----'||k1_1);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k1.1',k1_1,11,'k1',sysdate);
    dbms_output.put_line('insert---k1.1---'||k1_1);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k1.2';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k1_2,MODIFIED=sysdate where code='k1.2';
      dbms_output.put_line('update---k1.2----'||k1_2);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k1.2',k1_2,12,'k1',sysdate);
     dbms_output.put_line('insert---k1.2----'||k1_2);  
end if;
commit;
end P_DWM_briefingUpdateByK1;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_BRIEFINGUPDATEBYK2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_BRIEFINGUPDATEBYK2" 
AS  
k2 clob:='';
k2str clob:='';
k2_1 clob:='';
k2_2 clob:='';
k2_3 clob:='';
k2ProjectCount number:=0;
k2MinProjectNames clob:='';
k2MaxProjectNames clob:='';
k2MinFirstOpenDurationByTl number:=0;
k2MaxFirstOpenDurationByTl number:=0;
DelayFirstOpenDurationByTl number:=0;
k2onTimeProjectCount number:=0;
DelayFirstOpen number:=0;
DelayLastFirstOpen number:=0;
rowCount number:=0;
begin
SELECT
   count(1)
   into k2ProjectCount
FROM
    dwm_sale_rate_project where  FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'));
SELECT
   to_char(trunc( (sum(FIRST_OPEN_DURATION_BY_TL)/count(1))/ 31, 1),'fm9999999990.0')
   into k2
FROM
    dwm_sale_rate_project where  FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) and TAKE_LAND_DATE is not null;
SELECT 
  min(FIRST_OPEN_DURATION_BY_TL) into k2MinFirstOpenDurationByTl
FROM
    dwm_sale_rate_project where  FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'));
    
SELECT 
   replace(WMSYS.WM_CONCAT(project_name),',','、') into k2MinProjectNames
FROM
    dwm_sale_rate_project where  FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'))  and
    FIRST_OPEN_DURATION_BY_TL=k2MinFirstOpenDurationByTl;
k2MinFirstOpenDurationByTl:=trunc(k2MinFirstOpenDurationByTl / 31, 1);

SELECT 
  max(FIRST_OPEN_DURATION_BY_TL) into k2MaxFirstOpenDurationByTl
FROM
    dwm_sale_rate_project where  FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'));
    
SELECT 
   replace(WMSYS.WM_CONCAT(project_name),',','、') into k2MaxProjectNames
FROM
    dwm_sale_rate_project where  FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'))  and
    FIRST_OPEN_DURATION_BY_TL=k2MaxFirstOpenDurationByTl;

k2MaxFirstOpenDurationByTl:=trunc(k2MaxFirstOpenDurationByTl / 31, 1);

SELECT 
  count(1) into k2onTimeProjectCount
FROM
     dwm_sale_rate_project where  FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'))  and PLAN_FIRST_OPEN_DATE>=FIRST_OPEN_DATE;

select Count(1) into DelayFirstOpen from  dwm_sale_rate_project where FIRST_OPEN_DATE is null and (to_number(to_char(PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) or to_number(to_char(NEW_PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')));
select Count(1) into DelayLastFirstOpen from  dwm_sale_rate_project where FIRST_OPEN_DATE is null and (to_number(to_char(PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) or to_number(to_char(NEW_PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'))) and (NEW_PLAN_FIRST_OPEN_DATE< sysdate or PLAN_FIRST_OPEN_DATE< sysdate);

select case when DelayFirstOpen=0 then 0 else trunc(sum(FIRST_OPEN_DURATION_BY_PLAN)/DelayFirstOpen/31,1) end  into DelayFirstOpenDurationByTl from  dwm_sale_rate_project where FIRST_OPEN_DATE is null and (to_number(to_char(PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) or to_number(to_char(NEW_PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')));
k2str:=' <center>
          <span
            style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;font-size: 36px;color: #FF9900;"
            >'||k2||'个月</span
          >
        </center>
        <p style="font-size:14px;text-align:center;line-height:18px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >K2 拿地至首开时间</span
          >
        </p>
        <p style="font-size:11px;text-align:left;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >1、本年已首开'||to_char(k2ProjectCount)||'个项目，首开平均时长'||k2||'月：</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">首开最快'||k2MinProjectNames||'，</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#33CC99;">'||to_char(k2minfirstOpenDurationByTl,'fm9999999990.0')||'个月</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">；首开最慢'||k2MaxProjectNames||'，</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#FF6666;">'||to_char(k2MaxFirstOpenDurationByTl,'fm9999999990.0')||'个月</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">。</span>
        </p>
        <p style="font-size:11px;text-align:left;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;color:#000000;"
            >2、本年按时已首开项目</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#33CC99;">'||to_char(k2onTimeProjectCount)||'个</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#000000;">，</span
          ><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;color:#000000;"
            >延迟已首开项目</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#FF6633;">'||to_char(k2ProjectCount-k2onTimeProjectCount)||'个</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#000000;">；</span>
        </p>
        <p style="font-size:11px;text-align:left;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >3、本年剩余首开项目'||to_char(DelayFirstOpen)||'个：</span
          >
        </p>
        <p style="font-size:11px;text-align:left;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑'';font-weight:400;"> </span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#FF99FF;">延迟未首开项目'||to_char(DelayLastFirstOpen)||'个</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">，未到期首开项目'||to_char(DelayFirstOpen-DelayLastFirstOpen)||'个。</span>
        </p>';
    k2_2:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">集团整体首开时长均值为</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k2||'个月</span><span style="font-family:''微软雅黑'';font-weight:400;color:#666666;">。</span></p>';
    k2_3:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">本年待首开项目'||DelayFirstOpen||'个，首开时长目标均值为</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||to_char(DelayFirstOpenDurationByTl,'fm9999999990.0')||'个月；</span><span style="font-family:''微软雅黑'';font-weight:400;">已延误首开的项目</span><span style="font-family:''微软雅黑'';font-weight:400;color:#FF0000;">共'||DelayLastFirstOpen||'个</span><span style="font-family:''微软雅黑'';font-weight:400;color:#666666;">，预计</span><span style="font-family:''微软雅黑'';font-weight:400;">。</span></p>';
    k2_1:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">本年首开项目'||to_char(k2ProjectCount)||'个，“拿地至首开”</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">平均时长'||k2||'个月</span><span style="font-family:''微软雅黑'';font-weight:400;">，首开</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">最快为'||to_char(k2MinFirstOpenDurationByTl,'fm9999999990.0')||'月</span><span style="font-family:''微软雅黑'';font-weight:400;">，首开</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">最慢'||to_char(k2MaxFirstOpenDurationByTl,'fm9999999990.0')||'个月；</span><span style="font-family:''微软雅黑'';font-weight:400;">按时首开项目</span><span style="font-family:''微软雅黑'';font-weight:400;color:#00CC66;">'||to_char(k2onTimeProjectCount)||'个</span><span style="font-family:''微软雅黑'';font-weight:400;">，延迟首开项目</span><span style="font-family:''微软雅黑'';font-weight:400;color:#E68CB2;">'||to_char(k2ProjectCount-k2onTimeProjectCount)||'个</span><span style="font-family:''微软雅黑'';font-weight:400;">。</span></p>';

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k2';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k2str,MODIFIED=sysdate where code='k2';
    dbms_output.put_line('update--k2---'||k2str);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k2',k2str,2,'BigDataBriefing',sysdate);
    dbms_output.put_line('insert---k2-----'||k2str);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k2.1';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k2_1,MODIFIED=sysdate where code='k2.1';
     dbms_output.put_line('update--k2.1----'||k2_1);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k2.1',k2_1,11,'k2',sysdate);
    dbms_output.put_line('insert--k2.1----'||k2_1);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k2.2';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k2_2,MODIFIED=sysdate where code='k2.2';
      dbms_output.put_line('update--k2.2----'||k2_2);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k2.2',k2_2,12,'k2',sysdate);
     dbms_output.put_line('inser--k2.2t----'||k2_2);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k2.3';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k2_3,MODIFIED=sysdate where code='k2.3';
      dbms_output.put_line('update----'||k2_3);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k2.3',k2_3,12,'k2',sysdate);
     dbms_output.put_line('insert----'||k2_3);  
end if;

commit;
end P_DWM_briefingUpdateByK2;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_BRIEFINGUPDATEBYK3
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_BRIEFINGUPDATEBYK3" 
AS  
k3 clob:='';
k3_1 clob:='';
k3RateByMoney clob:='';
k3RateByMoneyCout number:=0;
k3RateByMoneyOver90Cout number:=0;
k3RateByMoneyOver90Rate  varchar(50):='0%';
k3RateByMoneyOver99Cout number:=0;
k3RateByMoneyOver99Rate  varchar(50):='0%';
k3RemainingValue varchar(50):='0亿';
k3RemainingValueByParkingSpace varchar(50):='0亿';
k3RemainingValueByParkingBusin varchar(50):='0亿';
k3RemainingValueByParkingHouse varchar(50):='0亿';
ROWCOUNT number;
begin
select case when sum(FO_SALE_COUNT) <> 0 then fn_ConvertDecimalToPercentage(sum(PO_SALE_OUT_MONEY)/sum(PO_SALE_MONEY)) else  fn_ConvertDecimalToPercentage(0.0) end into  k3RateByMoney
from   DWM_SALE_RATE_BY_PROJECT; 

select count(1) into k3RateByMoneyOver90Cout
from DWM_SALE_RATE_BY_PROJECT where DWM_SALE_RATE_BY_PROJECT.PO_SALE_RATE_BY_MONEY>0.9;

select count(1) into k3RateByMoneyCout
from DWM_SALE_RATE_BY_PROJECT where DWM_SALE_RATE_BY_PROJECT.PO_SALE_RATE_BY_MONEY is not null;

select count(1) into k3RateByMoneyOver99Cout
from   DWM_SALE_RATE_BY_PROJECT  where DWM_SALE_RATE_BY_PROJECT.PO_SALE_RATE_BY_MONEY>0.99;

select case when sum(FO_SALE_COUNT) <> 0 then FN_DWN_AmountToBillionYuan(sum(PO_SURPLUS_SALE_MONEY))  else  '0亿' end into  k3RemainingValue
from   DWM_SALE_RATE_BY_PROJECT;

select case when sum(FO_SALE_COUNT) <> 0 then FN_DWN_AmountToBillionYuan(sum(PO_SURPLUS_SALE_MONEY))  else  '0亿' end into  k3RemainingValueByParkingSpace
from   DWM_SALE_RATE_BY_GRANULARITY where DATA_GRANULARITY='车位';

select case when sum(FO_SALE_COUNT) <> 0 then FN_DWN_AmountToBillionYuan(sum(PO_SURPLUS_SALE_MONEY))  else  '0亿' end into  k3RemainingValueByParkingBusin
from   DWM_SALE_RATE_BY_GRANULARITY  where DATA_GRANULARITY='商办';

select case when sum(FO_SALE_COUNT) <> 0 then FN_DWN_AmountToBillionYuan(sum(PO_SURPLUS_SALE_MONEY))  else  '0亿' end into  k3RemainingValueByParkingHouse
from   DWM_SALE_RATE_BY_GRANULARITY  where DATA_GRANULARITY='住宅';

if k3RateByMoneyCout<>0 then 
k3RateByMoneyOver90Rate:=fn_ConvertDecimalToPercentage(k3RateByMoneyOver90Cout/k3RateByMoneyCout);
end if;

if k3RateByMoneyCout<>0 then 
k3RateByMoneyOver99Rate:=fn_ConvertDecimalToPercentage(k3RateByMoneyOver99Cout/k3RateByMoneyCout);
end if;


k3:='  <center>
          <span
            style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;font-size: 36px;color: #FF9900;"
            >'||k3RateByMoney||'</span
          >
        </center>
        <p style="font-size:14px;text-align:center;line-height:18px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >K3、全案去化率</span
          >
        </p>
        <p style="font-size:11px;text-align:left;line-height:16px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >1、共'||k3RateByMoneyOver90Cout||'个项目全案去化率达90%，占所有项目的'||k3RateByMoneyOver90Rate||' ：</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">本年达到90%去化的'||k3RateByMoneyOver90Cout||'个</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#00CC66;"></span
          ><span style="font-family:''微软雅黑'';font-weight:400;">。</span>
        </p>
        <p style="font-size:11px;text-align:left;line-height:16px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >2、共'||k3RateByMoneyOver99Cout||'个项目全案去化率达99%，占所有项目的'||k3RateByMoneyOver99Rate||'：</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">本年达到99%去化的'||k3RateByMoneyOver99Cout||'个</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#00CC66;"></span
          ><span style="font-family:''微软雅黑'';font-weight:400;">。</span>
        </p>
        <p style="font-size:11px;text-align:left;line-height:16px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">3</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">、</span
          ><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >库存货值共'||k3RemainingValue||'</span
          ><span style="font-family:''微软雅黑'';font-weight:400;"
            >：住宅'||k3RemainingValueByParkingHouse||'、商业'||k3RemainingValueByParkingBusin||'、车位'||k3RemainingValueByParkingSpace||'。</span
          >
        </p>';
    k3_1:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">全案去化率达到90%的项目，本年新增</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k3RateByMoneyOver90Cout||'个</span><span style="font-family:''微软雅黑'';font-weight:400;">；全案去化率达到99%的项目，本年</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">新增'||k3RateByMoneyOver99Cout||'个</span><span style="font-family:''微软雅黑'';font-weight:400;">。</span></p>';

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k3';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k3,MODIFIED=sysdate where code='k3';
    dbms_output.put_line('update--k3----'||k3);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k3',k3,3,'BigDataBriefing',sysdate);
    dbms_output.put_line('insert--k3-----'||k3);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k3.1';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k3_1,MODIFIED=sysdate where code='k3.1';
     dbms_output.put_line('update--k3.1----'||k3_1);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k3.1',k3_1,11,'k3',sysdate);
    dbms_output.put_line('insert--k3.1----'||k3_1);  
end if;

commit;
end P_DWM_briefingUpdateByK3;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_BRIEFINGUPDATEBYK4
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_BRIEFINGUPDATEBYK4" 
AS  
k4 clob:='';
k4_1 clob:='';
k4RateByMoney clob:='';
AllEhSaleOutMoney number:=0;
AllEhSaleMoney number:=0;
AllEhSurplusSaleMoney number:=0;
ROWCOUNT number;
begin
select case when sum(EH_SALE_MONEY) <> 0 then fn_ConvertDecimalToPercentage(sum(EH_SALE_OUT_MONEY)/sum(EH_SALE_MONEY)) else  fn_ConvertDecimalToPercentage(0.0) end into  k4RateByMoney
from   DWM_SALE_RATE_BY_PROJECT; 

select sum(EH_SALE_OUT_MONEY) into  AllEhSaleOutMoney
from   DWM_SALE_RATE_BY_PROJECT; 

select sum(EH_SALE_MONEY) into  AllEhSaleMoney
from   DWM_SALE_RATE_BY_PROJECT; 

select sum(EH_SURPLUS_SALE_MONEY) into  AllEhSurplusSaleMoney
from   DWM_SALE_RATE_BY_PROJECT; 

k4:='<center>
          <span
            style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;font-size: 36px;color: #FF9900;"
            >'||k4RateByMoney||'</span>
        </center>
        <p style="font-size:14px;text-align:center;line-height:18px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >K4、现房去化率</span>
        </p>
        <p style="font-size:11px;text-align:left;line-height:16px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑'';font-weight:400;">1.竣备时未签约货值</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||FN_DWN_AmountToBillionYuan(AllEhSaleMoney)||'</span><span style="font-family:''微软雅黑'';font-weight:400;">，竣备后签约货值</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||FN_DWN_AmountToBillionYuan(AllEhSaleOutMoney)||'</span><span style="font-family:''微软雅黑'';font-weight:400;">，现房去化率</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k4RateByMoney||'</span><span style="font-family:''微软雅黑'';font-weight:400;">；剩余现房货值</span><span style="font-family:''微软雅黑'';font-weight:400;color:#E68CB2;">'||FN_DWN_AmountToBillionYuan(AllEhSurplusSaleMoney)||'</span><span style="font-family:''微软雅黑'';font-weight:400;">。</span>
        </p>';
    k4_1:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">竣备时未签约货值</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||FN_DWN_AmountToBillionYuan(AllEhSaleMoney)||'</span><span style="font-family:''微软雅黑'';font-weight:400;">，竣备后签约货值</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||FN_DWN_AmountToBillionYuan(AllEhSaleOutMoney)||'</span><span style="font-family:''微软雅黑'';font-weight:400;">，现房去化率</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k4RateByMoney||'</span><span style="font-family:''微软雅黑'';font-weight:400;">；剩余现房货值</span><span style="font-family:''微软雅黑'';font-weight:400;color:#E68CB2;">'||FN_DWN_AmountToBillionYuan(AllEhSurplusSaleMoney)||'</span><span style="font-family:''微软雅黑'';font-weight:400;">。</span></p>';

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k4';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k4,MODIFIED=sysdate where code='k4';
    dbms_output.put_line('update----'||k4);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k4',k4,4,'BigDataBriefing',sysdate);
    dbms_output.put_line('insert------'||k4);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k4.1';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k4_1,MODIFIED=sysdate where code='k4.1';
     dbms_output.put_line('update----'||k4_1);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k4.1',k4_1,11,'k4',sysdate);
    dbms_output.put_line('insert----'||k4_1);  
end if;

commit;
end P_DWM_briefingUpdateByK4;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_BRIEFINGUPDATEBYK5
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_BRIEFINGUPDATEBYK5" 
AS  
k5 clob:='';
k5_1 clob:='';
k5RateByMoney clob:='0%';
k5SaleOutByMoney varchar(50):='0亿';
k5SaleByMoney varchar(50):='0亿';
k5RemainingValue varchar(50):='0亿';
k5RemainingValueByParkingSpace varchar(50):='0亿';
k5RemainingValueByParkingBusin varchar(50):='0亿';
k5RemainingValueByParkingHouse varchar(50):='0亿';
k5ProjectNamesBySaleArea clob:='';
k5ProjectNamesBySaleOutArea clob:='';
k5ProjectNamesByRemainingValue clob:='';
k5tNamesRemainingValueByTop clob:='';
appearindex number;
ROWCOUNT number;
begin
select case when sum(SI_SALE_MONEY) <> 0 then fn_ConvertDecimalToPercentage(sum(SI_SALE_OUT_MONEY)/sum(SI_SALE_MONEY)) else  fn_ConvertDecimalToPercentage(0.0) end into  k5RateByMoney
from    dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id; 

select FN_DWN_AmountToBillionYuan(sum(SI_SALE_MONEY)) into k5SaleByMoney
from    dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id; 

select FN_DWN_AmountToBillionYuan(sum(SI_SALE_OUT_MONEY)) into k5SaleOutByMoney
from    dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id; 

select FN_DWN_AmountToBillionYuan(sum(SI_SALE_MONEY)-sum(SI_SALE_OUT_MONEY)) into k5RemainingValue
from    dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id; 

if k5SaleByMoney <> '0亿' then
select listagg(project_name||FN_DWN_AmountToBillionYuan(SI_SALE_MONEY),'、') WITHIN GROUP (ORDER BY SI_SALE_MONEY desc) into  k5ProjectNamesBySaleArea  from (select dwm_sale_rate_project.project_name,case when SI_SALE_MONEY is null or SI_SALE_MONEY=0 then 0.0 else SI_SALE_MONEY end as SI_SALE_MONEY
from  dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where SI_SALE_MONEY is not null and SI_SALE_MONEY <>0  )tab;
end if;
if k5SaleOutByMoney <> '0亿' then
select listagg(project_name||FN_DWN_AmountToBillionYuan(SI_SALE_OUT_MONEY),'、') WITHIN GROUP (ORDER BY SI_SALE_OUT_MONEY desc) into  k5ProjectNamesBySaleOutArea  from (select dwm_sale_rate_project.project_name,case when SI_SALE_OUT_MONEY is null or SI_SALE_OUT_MONEY=0 then 0.0 else SI_SALE_OUT_MONEY end as SI_SALE_OUT_MONEY
from  dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where SI_SALE_OUT_MONEY is not null and SI_SALE_OUT_MONEY <>0  )tab;
end if;
if k5RemainingValue <> '0亿' then
select listagg(project_name||FN_DWN_AmountToBillionYuan(RemainingValue),'、') WITHIN GROUP (ORDER BY RemainingValue desc)  into  k5ProjectNamesByRemainingValue from (select dwm_sale_rate_project.project_name,SI_SALE_MONEY-SI_SALE_OUT_MONEY as RemainingValue
from  dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where SI_SALE_OUT_MONEY is not null )tab where tab.RemainingValue <> 0;
end if;

if k5ProjectNamesByRemainingValue is not null then
appearindex:=INSTR(k5ProjectNamesByRemainingValue,'、');
k5tNamesRemainingValueByTop:=substr(k5ProjectNamesByRemainingValue,0,appearindex-1);
 dbms_output.put_line('----'||k5tNamesRemainingValueByTop);  
k5ProjectNamesByRemainingValue:=substr(k5ProjectNamesByRemainingValue,appearindex,length(k5ProjectNamesByRemainingValue));
 dbms_output.put_line('----'||k5ProjectNamesByRemainingValue);  
end if;

k5:='  <center>
          <span
            style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;font-size: 36px;color: #FF9900;"
            >'||k5RateByMoney||'</span
          >
        </center>
         <p style="font-size:14px;text-align:center;line-height:18px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"> K5、顽固性库存去化率</span>
        </p>
        <p style="font-size:11px;line-height:16px;margin-bottom:0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >1、年初顽固性库存为'||k5SaleByMoney||'。</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">'||k5ProjectNamesBySaleArea||'。</span>
        </p>
        <p style="font-size:11px;line-height:16px;margin-bottom:0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >2、今年已去化顽固性库存'||k5SaleOutByMoney||'，去化率'||k5RateByMoney||'：</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">'||k5ProjectNamesBySaleOutArea||'。</span>
        </p>
        <p style="font-size:11px;line-height:16px;margin-bottom:0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >3、剩余顽固性库存'||k5RemainingValue||'：</span
          >
        </p>
        <p style="font-size:11px;line-height:16px;margin-bottom:0px;">
          <span style="font-family:''微软雅黑'';font-weight:400;"> </span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#FF99CC;">'||k5tNamesRemainingValueByTop||'</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">'||k5ProjectNamesByRemainingValue||'。</span>
        </p>';
    k5_1:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">年初顽固性库存</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k5SaleByMoney||'</span><span style="font-family:''微软雅黑'';font-weight:400;">，本年已去化</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k5SaleOutByMoney||'</span><span style="font-family:''微软雅黑'';font-weight:400;">，去化率</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k5RateByMoney||'</span><span style="font-family:''微软雅黑'';font-weight:400;">；剩余顽固性库存</span><span style="font-family:''微软雅黑'';font-weight:400;color:#E68CB2;">'||k5RemainingValue||'</span><span style="font-family:''微软雅黑'';font-weight:400;">。</span></p>';

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k5';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k5,MODIFIED=sysdate where code='k5';
    dbms_output.put_line('update--k5----'||k5);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k5',k5,5,'BigDataBriefing',sysdate);
    dbms_output.put_line('insert--k5------'||k5);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k5.1';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k5_1,MODIFIED=sysdate where code='k5.1';
     dbms_output.put_line('update--k5.1----'||k5_1);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k5.1',k5_1,11,'k5',sysdate);
    dbms_output.put_line('insert--k5.1----'||k5_1);  
end if;

commit;
end P_DWM_briefingUpdateByK5;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_CHARTFILTER_K1
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_CHARTFILTER_K1" 
(
  orgFilter OUT sys_refcursor 
, typeFilter OUT sys_refcursor 
, title OUT string 
, abstract OUT string
, typeTitle  OUT string
, orgTitle  OUT string 
) AS 
BEGIN
  open orgFilter for 
        select ID as "orgId", ORG_NAME as "orgName", KEY as "isCheck" from(
        select * from (select ID, ORG_NAME, 1 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        union
        select ID, ORG_NAME, 0 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 and ID not in (
        select ID from (select ID from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        )) order by ORDER_HIERARCHY_CODE asc;
  open typeFilter for 
        select '按面积' as "name", 'area' as "typeName", 0 as "isCheck" from dual
        union
        select '按货值' as "name", 'money' as "typeName", 0 as "isCheck" from dual
        union
        select '按套数' as "name", 'count' as "typeName", 1 as "isCheck" from dual;      
   title := '首开去化率变动趋势';
   abstract := '';
   typeTitle := '去化率类型';
   orgTitle := '二级单位';
END P_DWM_CHARTFILTER_K1;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_CHARTFILTER_K2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_CHARTFILTER_K2" (orgFilter out sys_refcursor,orgTitle out varchar,title out varchar)
as
begin
orgTitle:='二级单位';
title:='“拿地至首开时间”  变动趋势      (单位：月)';

open orgFilter for 
select id "orgId" ,org_name  "orgName",
case when id='c4571e06-dc50-4780-b663-9d3d358f4888' then
1 else 0 end as "isCheck"
from SYS_BUSINESS_UNIT where LEVEL_RANK=2   order by order_hierarchy_code;

end P_DWM_ChartFilter_K2;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_CHARTFILTER_K3
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_CHARTFILTER_K3" 
(
  orgFilter OUT sys_refcursor 
, typeFilter OUT sys_refcursor 
, typeTitle OUT string 
, orgTitle  OUT string
, title  OUT string 
)  AS 
BEGIN
  open orgFilter for 
        select ID as "orgId", ORG_NAME as "orgName", KEY as "isCheck" from(
        select * from (select ID, ORG_NAME, 1 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        union
        select ID, ORG_NAME, 0 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 and ID not in (
        select ID from (select ID from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        )) order by ORDER_HIERARCHY_CODE asc;
  open typeFilter for 
        select '按面积' as "name", 'area' as "typeName", 0 as "isCheck" from dual
        union
        select '按货值' as "name", 'money' as "typeName", 1 as "isCheck" from dual
        union
        select '按套数' as "name", 'count' as "typeName", 0 as "isCheck" from dual;
   title := '"全案已取证去化率"变动趋势';
   typeTitle := '去化率类型';
   orgTitle := '二级单位';
END P_DWM_CHARTFILTER_K3;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_CHARTFILTER_K4_2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_CHARTFILTER_K4_2" 
(
  orgfilter OUT sys_refcursor 
, title OUT string 
, orgtitle OUT string 
) AS 
BEGIN
  open orgfilter for 
       select ID as "orgId", ORG_NAME as "orgName", KEY as "isCheck" from(
        select * from (select ID, ORG_NAME, 1 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        union
        select ID, ORG_NAME, 0 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 and ID not in (
        select ID from (select ID from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        )) order by ORDER_HIERARCHY_CODE asc;
  title := '现房去化率变动趋势';
  orgTitle := '二级单位';
END P_DWM_CHARTFILTER_K4_2;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_CHARTFILTER_K4_3
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_CHARTFILTER_K4_3" 
(
  orgfilter OUT sys_refcursor 
, title OUT string 
, orgtitle OUT string  
) AS 
BEGIN
  open orgfilter for 
       select ID as "orgId", ORG_NAME as "orgName", KEY as "isCheck" from(
        select * from (select ID, ORG_NAME, 1 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        union
        select ID, ORG_NAME, 0 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 and ID not in (
        select ID from (select ID from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        )) order by ORDER_HIERARCHY_CODE asc;
  title := '剩余现房货值变动趋势 (单位:亿元)';
  orgTitle := '二级单位';
END P_DWM_CHARTFILTER_K4_3;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_CHARTFILTER_K5_2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_CHARTFILTER_K5_2" 
(
  orgfilter OUT sys_refcursor 
, title OUT string 
, orgtitle OUT string 
) AS 
BEGIN
  open orgfilter for 
        select ID as "orgId", ORG_NAME as "orgName", KEY as "isCheck" from(
        select * from (select ID, ORG_NAME, 1 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        union
        select ID, ORG_NAME, 0 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 and ID not in (
        select ID from (select ID from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        )) order by ORDER_HIERARCHY_CODE asc;
  title := '顽固性库存去化率变动趋势图';
  orgTitle := '二级单位';
END P_DWM_CHARTFILTER_K5_2;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_CHARTFILTER_K5_3
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_CHARTFILTER_K5_3" 
(
  orgfilter OUT sys_refcursor 
, title OUT string 
, orgtitle OUT string 
) AS 
BEGIN
  open orgfilter for 
        select ID as "orgId", ORG_NAME as "orgName", KEY as "isCheck" from(
            select * from (select ID, ORG_NAME, 1 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
            union
            select ID, ORG_NAME, 0 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 and ID not in (
        select ID from (select ID from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        )) order by ORDER_HIERARCHY_CODE asc;
  title := '"剩余顽固性库存"变动趋势 (单位:亿元)';
  orgTitle := '二级单位';
END P_DWM_CHARTFILTER_K5_3;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_COMPANY_PROJ_SITUATION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_COMPANY_PROJ_SITUATION" (
    USERID IN VARCHAR2,
    STATIONID IN VARCHAR2,
    DEPTID IN VARCHAR2,
    COMPANYID IN VARCHAR2,
    BIZCODE IN VARCHAR2 ,
    wacthinfo OUT SYS_REFCURSOR
) AS
    --动态货值首页-项目货值概况
--作者：陈丽
--日期：2019/11/13
-- 黄伟：2019-12-26修正过本脚本
    RULEVALUE varchar2(50);
    AUTHCOUNT INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    SPID VARCHAR2(36);--使用临时表的批次号
    data_auth_spid   VARCHAR2(200);
    authCode VARCHAR2(50);---- 权限编码
BEGIN
    --权限查询
    authCode := 'DWM.DTHZGL.03';
    p_sys_get_company_tree_spid(userid => USERID, stationid => STATIONID, deptid => DEPTID, companyid => COMPANYID, bizcode
        => authCode, data_auth_spid => data_auth_spid);
    open wacthinfo for
        with tm1 as (
            select * from SYS_BUSINESS_UNIT
            where ID in (select ORG_ID from TMP_COMPANY_TREE where id = data_auth_spid)
        ), tm2 as (
            select distinct t1.*
            from tm1 t1 where not exists(select 1 from tm1 where tm1.PARENT_ID = t1.ID)
        ), tm3 as (
            select * from SYS_BUSINESS_UNIT sbu
            where sbu.IS_COMPANY=1
            start with ID in (select ID from tm2 )
            connect by prior sbu.ID = sbu.PARENT_ID
        ), tm4 as (
            select * from SYS_BUSINESS_UNIT sbu
            where sbu.IS_COMPANY=1
            start with ID in (select ID from tm2 )
            connect by prior sbu.PARENT_ID = sbu.ID
        ), tm5 as (
            SELECT
                A.order_hierarchy_code, -- 对象全路径排序编码
                A.orgId    AS id,--组织id
                A.orgName            AS orgName,--组织名称名称
                lower(A.parentId) AS parentsId,--父级id
                A.Proj_Code,
                (CASE  WHEN A.orgType = 10 THEN 1  ELSE 0  END) AS projTotal,
                round((CASE
                           WHEN X.PROJ_ID IS NOT NULL AND NVL(X.TARGET_WORTH,0)>0 THEN
                               X.TARGET_WORTH
                           WHEN Y.PROJ_ID IS NOT NULL AND NVL(Y.TARGET_WORTH,0)>0 THEN
                               Y.TARGET_WORTH
                           WHEN Z.PROJ_ID IS NOT NULL AND NVL(Z.TARGET_WORTH,0)>0 THEN
                               Z.TARGET_WORTH
                           ELSE   0  END)/10000,2)  AS newestWorth,    -- 最新目标货值
                --E.VALUE_DT_ALL,E.VALUE_IN_PROCESS,E.VALUE_STOCK,E.VALUE_HAVED_SALE
                round(DT.VALUE_DT_ALL_OPT/100000000,2) AS dynamicWorth,  -- 动态总货值
                round(DT.VALUE_RESERVE/100000000,2) AS reserveWorth,      -- 储备货值
--    round(22,2)    as InTransitWorth,  -- 在途货值
                round(nvl(DT.VALUE_IN_PROCESS,0)/100000000,2)    as InTransitWorth,  -- 在途货值
--    round(DT.VALUE_IN_PROCESS/100000000,2) as InTransitWorth,
                round(DT.VALUE_STOCK/100000000,2) AS inventoryWorth,       -- 库存货值
                round(DT.VALUE_HAVED_SALE/100000000,2) AS explaination,  -- 已售货值
                '/dwm/value-manage/dynamic-value/value-monitor' AS jumpUrl
            FROM(
                SELECT
                    t.order_hierarchy_code,-- 对象全路径排序编码
                    t.project_original_id     orgId,--组织id
                    t.project_name            AS orgName,--组织名称名称
                    t.org_type                AS orgType,--组织类型 0公司，1项目
                    t.Proj_Code,
                    lower(t.parent_id) AS parentId--父级id
                FROM(
                    SELECT
                        mdm_project.order_hierarchy_code,-- 对象全路径排序编码
                        mdm_project.project_original_id,
                            project_name||(CASE WHEN proj_cooperate='不操盘' THEN '（非操盘）' ELSE ''END) AS project_Name,
                        mdm_phase.phase_name   AS proj_phase,
                        phase.phase_id,
                        phase.id               AS proj_phase_id,
                        Project_Code AS Proj_Code,
                        10 AS org_type,
                        CASE WHEN phase.phase_id IS NULL THEN 0 ELSE 1 END AS is_exist_proj_phase,
                        company_id             AS parent_id,
                        mdm_obj_phase_index.total_site_area,
                        mdm_obj_phase_index.overall_floorage_area,
                        mdm_obj_phase_index.total_sale_area,
                        mdm_obj_phase_index.total_capacity_area
                    FROM mdm_project left JOIN (
                        SELECT t1.id, t1.phase_id, t1.proj_id, t2.phase_order
                        FROM mdm_project_phase t1 LEFT JOIN (
                            SELECT proj_id, MAX(phase_order) AS phase_order
                            FROM mdm_project_phase
                            GROUP BY proj_id
                        ) t2 ON t1.proj_id = t2.proj_id AND t1.phase_order = t2.phase_order
                        WHERE t2.phase_order IS NOT NULL
                    ) phase ON mdm_project.project_original_id = phase.proj_id
                             LEFT JOIN mdm_phase ON phase.phase_id = mdm_phase.id
                             LEFT JOIN mdm_obj_phase_index ON phase.id = mdm_obj_phase_index.obj_phase_id
                        AND mdm_obj_phase_index.obj_type = 0
                    WHERE approval_status = '已审核'
                    UNION ALL
                    SELECT
                        tm.order_hierarchy_code,-- 对象全路径排序编码
                        id,
                        org_name,
                        '' AS proj_phase,
                        '' AS phase_id,
                        '' AS proj_phase_id,
                        '' AS Proj_Code,
                        0 org_type,
                        NULL is_exist_proj_phase,
                        parent_id,
                        0 AS "totalSiteArea",
                        0 AS "overallFloorageArea",
                        0 AS "totalSalableArea",
                        0 AS "totalCapacityArea"
                    FROM (select * from tm3 union select * from tm4) tm WHERE org_type = 0
                                                                          AND (id != '000100000000000000000000000000' AND id != '000200000000000000000000000000')
                ) t
            )A LEFT JOIN (
                SELECT A.PROJ_ID,A.TARGET_WORTH
                FROM DWM_TARGET_WORTH A RIGHT JOIN (
                    SELECT D.PROJ_ID,D.TARGET_WORTH_PHASE,MAX(WORTH_V) AS WORTH_V
                    FROM DWM_TARGET_WORTH D
                    WHERE D.IS_DELETE = 0 AND D.APPROVAL_STATUS IN ('审核中', '已审核') AND D.TARGET_WORTH_PHASE = 20
                    GROUP BY D.PROJ_ID,D.TARGET_WORTH_PHASE
                )A1 ON A.PROJ_ID = A1.PROJ_ID AND A.WORTH_V = A1.WORTH_V
                    AND A.TARGET_WORTH_PHASE = A1.TARGET_WORTH_PHASE
                where a1.worth_v is not null and a.is_delete = 0
                  AND a.approval_status IN ('审核中','已审核') AND a.target_worth_phase = 20
            )X ON A.orgId = X.PROJ_ID LEFT JOIN (
                SELECT B.PROJ_ID,B.TARGET_WORTH FROM DWM_TARGET_WORTH B RIGHT JOIN (
                    SELECT D.ID,D.PROJ_ID,MAX(APPROVAL_TIME)
                    FROM DWM_TARGET_WORTH D
                    WHERE D.IS_DELETE = 0 AND D.APPROVAL_STATUS IN ('审核中', '已审核') AND D.TARGET_WORTH_PHASE = 10
                    GROUP BY D.ID,D.PROJ_ID) B1 ON B.ID = B1.ID
            )Y ON A.orgId = Y.PROJ_ID LEFT JOIN (
                SELECT C.PROJ_ID,C.TARGET_WORTH
                FROM DWM_TARGET_WORTH C  RIGHT JOIN(
                    SELECT ID,D.PROJ_ID,MAX(APPROVAL_TIME)
                    FROM DWM_TARGET_WORTH D
                    WHERE D.IS_DELETE = 0 AND D.APPROVAL_STATUS IN ('审核中', '已审核') AND D.TARGET_WORTH_PHASE = 0
                    GROUP BY D.ID,D.PROJ_ID
                ) C1 ON C.ID = C1.ID
            )Z ON A.orgId = Z.PROJ_ID LEFT JOIN (
                SELECT E.OBJ_ID,E.VALUE_DT_ALL
                     ,(E.Value_Reserve+E.VALUE_IN_PROCESS+E.VALUE_STOCK+E.VALUE_HAVED_SALE) AS VALUE_DT_ALL_OPT
                     ,E.Value_Reserve,E.VALUE_IN_PROCESS,E.VALUE_STOCK,E.VALUE_HAVED_SALE FROM DWM_DT_VALUE E
                WHERE E.Obj_Type='项目'
            )DT ON A.orgId = DT.OBJ_ID
            ORDER BY A.order_hierarchy_code,A.proj_Code
        )
        select * from tm5
        where tm5.id in (select ID from tm3 union select ID from tm4) or parentsId in (select ID from tm4);
END p_dwm_company_proj_situation;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_COMPANY_WORTH_SITUATION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_COMPANY_WORTH_SITUATION" (wacthinfo OUT sys_refcursor)
AS  
--首页-公司可售货值情况（树列表）
--作者：陈丽
--日期：2019/11/13
BEGIN  
open wacthinfo for  
select 
'A' as "id",
'' as "parentsId",
'A项目' as "orgName",
'300' as  "projTotal",
'1000' as "dynamicWorth", 
'111' as "reserveWorth", 
'111' as "wayWorth", 
'111' as "inventoryWorth",
'111' as "jumpUrl"
from dual
union all
select
'B' as "id",
'' as "parentsId",
'A项目' as "orgName",
'300' as  "projTotal",
'1000' as "dynamicWorth", 
'111' as "reserveWorth", 
'111' as "wayWorth", 
'111' as "inventoryWorth",
'111' as "jumpUrl"
from dual
union all
select 
'A1' as "id",
'A' as "parentsId",
'A项目' as "orgName",
'300' as  "projTotal",
'1000' as "dynamicWorth", 
'111' as "reserveWorth", 
'111' as "wayWorth", 
'111' as "inventoryWorth",
'111' as "jumpUrl"
from dual
union all
select 
'A2' as "id",
'A' as "parentsId",
'A项目' as "orgName",
'300' as  "projTotal",
'1000' as "dynamicWorth", 
'111' as "reserveWorth", 
'111' as "wayWorth", 
'111' as "inventoryWorth",
'111' as "jumpUrl"
from dual;
END P_DWM_COMPANY_WORTH_SITUATION;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DATALIST_K2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_DATALIST_K2" 
(
  sortField IN VARCHAR2
, orderBy IN VARCHAR2 
, rowNumber IN number
, k2DataList OUT sys_refcursor 
) AS 
whereStr varchar2(500):='';
v_sql clob :='';
-- 用于返回筛选的列
v_column clob :='';
-- 用于解决排序字段有span标签问题
sortStr varchar2(100):='';
BEGIN
  sortStr := sortField;
  if sortStr = 'firstOpenDurationByPlan' then
    sortStr := 'FIRST_OPEN_DURATION_BY_PLAN';
  elsif sortStr = 'firstOpenDate' then
    sortStr := 'FIRST_OPEN_DATE';
  elsif sortStr = 'takeLandDate' then
    sortStr := 'TAKE_LAND_DATE'; 
  elsif sortStr = 'planFirstOpenDate' then
    sortStr := 'PLAN_FIRST_OPEN_DATE';  
  elsif sortStr = 'firstOpenDurationByTL' then
    sortStr := 'FIRST_OPEN_DURATION_BY_TL';
  elsif sortStr = 'projectName' then
    sortStr := 'projectNameCopy';  
  end if;
  v_sql:='select 
        NVL(FIRST_OPEN_DURATION_BY_PLAN,0) as "FIRST_OPEN_DURATION_BY_PLAN",
        FIRST_OPEN_DATE,
        TAKE_LAND_DATE,
        PLAN_FIRST_OPEN_DATE,
        NVL(FIRST_OPEN_DURATION_BY_TL,0) as "FIRST_OPEN_DURATION_BY_TL",

        PROJECT_NAME as "projectNameCopy",
        FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_PLAN) as "firstOpenDurationByPlanCopy",
        FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_TL) as "firstOpenDurationByTLCopy",
        to_char(FIRST_OPEN_DATE,''yyyy-mm-dd'') as "firstOpenDateCopy",
        Fn_DWM_DurationDaysDeal(PLAN_FIRST_OPEN_DATE, FIRST_OPEN_DATE, ''pure'') as "advanceFirstOpenDateCopy",

        PROJECT_ID as "projectId", 
        FN_DWM_FONT_COLOR(PROJECT_NAME) as "projectName",
        FN_DWM_FONT_COLOR(FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_TL)) as "firstOpenDurationByTL",
        FN_DWM_FONT_COLOR(to_char(FIRST_OPEN_DATE,''yyyy-mm-dd'')) as "firstOpenDate",
        to_char(TAKE_LAND_DATE,''yyyy-mm-dd'') as "takeLandDate",
        to_char(PLAN_FIRST_OPEN_DATE,''yyyy-mm-dd'') as "planFirstOpenDate",
        FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_PLAN) as "firstOpenDurationByPlan",
        Fn_DWM_DurationDaysDeal(PLAN_FIRST_OPEN_DATE, FIRST_OPEN_DATE, ''label'') as "advanceFirstOpenDate"
    from DWM_SALE_RATE_PROJECT 
    where TO_DATE(trunc(sysdate,''yyyy'')) <= FIRST_OPEN_DATE';
  v_column := ' "projectId",
      "projectName",
      "firstOpenDurationByPlan",
      "firstOpenDate",
      "takeLandDate",
      "planFirstOpenDate",
      "firstOpenDurationByTL",
      "advanceFirstOpenDate",
      "projectNameCopy", 
      "firstOpenDurationByPlanCopy",
      "firstOpenDateCopy",
      "advanceFirstOpenDateCopy",
      "firstOpenDurationByTLCopy" ';
--    if rowNumber <> 0 then
--    whereStr:='where rownum<= ' || rowNumber;
--    end if;
    if sortStr is not null and orderBy is not null then
        whereStr:=whereStr||' order by tab."'||sortStr||'"  '||orderBy;
    end if;
    if whereStr is not null then
        v_sql:='select ' || v_column || ' from ('||v_sql||') tab '||whereStr;
    else
        v_sql:='select ' || v_column || ' from (' ||v_sql || ' )';
    end if;
    -- 选择前n条数据，rownum必须拼接在排序后面，不然会先运行rownum再运行排序，会导致筛选数据并不准确
    if rowNumber <> 0 then
        v_sql := 'select ' || v_column || ' from (' ||v_sql || ' )' || ' where rownum <= ' || rowNumber;
    end if;
    dbms_output.put_line(v_sql);
OPEN k2DataList FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE k2DataList;
END P_DWM_DATALIST_K2;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DATALIST_K3
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_DATALIST_K3" 
(
  sortField IN VARCHAR2
, orderBy IN VARCHAR2  
, rowNumber IN NUMBER
, appachAll IN NUMBER
, k3DataList OUT sys_refcursor
) AS
whereStr varchar2(500):='where 1 = 1 ';
v_sql clob :='';
-- 用于返回筛选的列
v_column clob :='';
-- 用于解决排序字段有span标签问题
sortStr varchar2(100):='';
BEGIN
  sortStr := sortField;
  if sortStr = 'firstOpenDate' then
    sortStr := 'FIRST_OPEN_DATE';
  elsif sortStr = 'poSaleRateByMoney' then
    sortStr := 'PO_SALE_RATE_BY_MONEY';
  elsif sortStr = 'poSaleMoney' then
    sortStr := 'PO_SALE_MONEY'; 
  elsif sortStr = 'poSaleOutMoney' then
    sortStr := 'PO_SALE_OUT_MONEY';  
  elsif sortStr = 'poSaleRateByCount' then
    sortStr := 'PO_SALE_RATE_BY_COUNT';
  elsif sortStr = 'poSaleCount' then
    sortStr := 'PO_SALE_COUNT';
  elsif sortStr = 'poSaleOutCount' then
    sortStr := 'PO_SALE_OUT_COUNT';
  elsif sortStr = 'poSaleRateByArea' then
    sortStr := 'PO_SALE_RATE_BY_AREA';
  elsif sortStr = 'poSaleArea' then
    sortStr := 'PO_SALE_AREA';
  elsif sortStr = 'poSaleOutArea' then
    sortStr := 'PO_SALE_OUT_AREA';
  elsif sortStr = 'projectName' then
    sortStr := 'projectNameCopy';  
  end if;
  v_sql:='select
        p.FIRST_OPEN_DATE as "FIRST_OPEN_DATE",
        NVL(sr.PO_SALE_RATE_BY_MONEY,0) as "PO_SALE_RATE_BY_MONEY",
        NVL(sr.PO_SALE_MONEY,0) as "PO_SALE_MONEY",
        NVL(sr.PO_SALE_OUT_MONEY,0) as "PO_SALE_OUT_MONEY",
        NVL(sr.PO_SALE_RATE_BY_COUNT,0) as "PO_SALE_RATE_BY_COUNT",
        NVL(sr.PO_SALE_COUNT,0) as "PO_SALE_COUNT",
        NVL(sr.PO_SALE_OUT_COUNT,0) as "PO_SALE_OUT_COUNT",
        NVL(sr.PO_SALE_RATE_BY_AREA,0) as "PO_SALE_RATE_BY_AREA",
        NVL(sr.PO_SALE_AREA,0) as "PO_SALE_AREA",
        NVL(sr.PO_SALE_OUT_AREA,0) as "PO_SALE_OUT_AREA",

        p.PROJECT_NAME as "projectNameCopy",
        FN_DWM_DEC_CONVERT_PCT(sr.PO_SALE_RATE_BY_MONEY) as "poSaleRateByMoneyCopy",
        FN_DWM_DEC_CONVERT_PCT(sr.PO_SALE_RATE_BY_COUNT) as "poSaleRateByCountCopy",
        FN_DWM_DEC_CONVERT_PCT(sr.PO_SALE_RATE_BY_AREA) as "poSaleRateByAreaCopy",

        p.PROJECT_ID as "projectId",
        FN_DWM_FONT_COLOR(p.PROJECT_NAME) as "projectName",
        to_char(p.FIRST_OPEN_DATE,''yyyy-mm-dd'') as "firstOpenDate",
        FN_DWM_FONT_LAYERED_COLOR(sr.PO_SALE_RATE_BY_MONEY, 0.9) as "poSaleRateByMoney",
        FN_DWM_MULTIPLE_AND_UNIT(sr.PO_SALE_MONEY, 100000000, ''亿'') as "poSaleMoney",
        FN_DWM_MULTIPLE_AND_UNIT(sr.PO_SALE_OUT_MONEY, 100000000, ''亿'') as "poSaleOutMoney",
        FN_DWM_FONT_COLOR(FN_DWM_DEC_CONVERT_PCT(sr.PO_SALE_RATE_BY_COUNT)) as "poSaleRateByCount",
        sr.PO_SALE_COUNT || ''套'' as "poSaleCount",
        sr.PO_SALE_OUT_COUNT || ''套'' as "poSaleOutCount",
        FN_DWM_FONT_COLOR(FN_DWM_DEC_CONVERT_PCT(sr.PO_SALE_RATE_BY_AREA)) as "poSaleRateByArea",
        FN_DWM_MULTIPLE_AND_UNIT(sr.PO_SALE_AREA, 10000, ''万方'') as "poSaleArea",
        FN_DWM_MULTIPLE_AND_UNIT(sr.PO_SALE_OUT_AREA, 10000, ''万方'') as "poSaleOutArea"
    from DWM_SALE_RATE_BY_PROJECT sr
    left join DWM_SALE_RATE_PROJECT p 
    on sr.PROJECT_ID = p.PROJECT_ID
    where p.PROJECT_NAME is not null';
  v_column := ' "projectId",
      "projectName",
      "firstOpenDate",
      "poSaleRateByMoney",
      "poSaleMoney",
      "poSaleOutMoney",
      "poSaleRateByCount",
      "poSaleCount",
      "poSaleOutCount", 
      "poSaleRateByArea",
      "poSaleArea",
      "poSaleOutArea",

      "projectNameCopy",
      "poSaleRateByMoneyCopy",
      "poSaleRateByCountCopy",
      "poSaleRateByAreaCopy"';
  if appachAll = 1 then
    whereStr := whereStr || ' and tab.PO_SALE_RATE_BY_MONEY <= 0.99 ';
  end if;
  if sortStr is not null and orderBy is not null then
    whereStr:=whereStr||' order by tab."'||sortStr||'"  '||orderBy;
  end if;
  if whereStr is not null then
    v_sql:='select ' || v_column || ' from ('||v_sql||') tab '||whereStr;
  else
    v_sql:='select ' || v_column || ' from (' ||v_sql || ' )';
  end if;
-- 选择前n条数据，rownum必须拼接在排序后面，不然会先运行rownum再运行排序，会导致筛选数据并不准确
  if rowNumber <> 0 then
    v_sql := 'select ' || v_column || ' from (' ||v_sql || ' )' || ' where rownum <= ' || rowNumber;
  end if;  
    dbms_output.put_line(v_sql);
OPEN k3DataList FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE k3DataList;   
END P_DWM_DATALIST_K3;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DATALIST_K4
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_DATALIST_K4" 
(
  sortField IN VARCHAR2 
, orderBy IN VARCHAR2 
, rowNumber IN number
, k4DataList OUT sys_refcursor 
) AS
whereStr varchar2(500):='where 1 = 1 ';
v_sql clob :='';
-- 用于返回筛选的列
v_column clob :='';
-- 用于解决排序字段有span标签问题
sortStr varchar2(100):='';
BEGIN
sortStr := sortField;
  if sortStr = 'completionRecordDate' then
    sortStr := 'COMPLETION_RECORD_DATE';
  elsif sortStr = 'ehSaleMoney' then
    sortStr := 'EH_SALE_MONEY';
  elsif sortStr = 'ehSaleOutMoney' then
    sortStr := 'EH_SALE_OUT_MONEY'; 
  elsif sortStr = 'ehSaleRateByMoney' then
    sortStr := 'EH_SALE_RATE_BY_MONEY';
  elsif sortStr = 'ehSurplusSaleMoney' then
    sortStr := 'EH_SURPLUS_MONEY';
  elsif sortStr = 'projectName' then
    sortStr := 'projectNameCopy';  
  end if;

  v_sql:= 'select
        p.COMPLETION_RECORD_DATE as "COMPLETION_RECORD_DATE",
        NVL(sa.EH_SALE_MONEY,0) as "EH_SALE_MONEY",
        NVL(sa.EH_SALE_OUT_MONEY,0) as "EH_SALE_OUT_MONEY",
        NVL(sa.EH_SALE_RATE_BY_MONEY,0) as "EH_SALE_RATE_BY_MONEY",
        NVL(sa.EH_SALE_MONEY - sa.EH_SALE_OUT_MONEY,0) as "EH_SURPLUS_MONEY",

        p.PROJECT_NAME as "projectNameCopy",
        FN_DWM_DEC_CONVERT_PCT(sa.EH_SALE_RATE_BY_MONEY) as "ehSaleRateByMoneyCopy",

        p.PROJECT_ID as "projectId",
        FN_DWM_FONT_COLOR(p.PROJECT_NAME) as "projectName",
        to_char(p.COMPLETION_RECORD_DATE,''yyyy-mm-dd'') as "completionRecordDate",
        FN_DWM_MULTIPLE_AND_UNIT(sa.EH_SALE_MONEY, 100000000, ''亿'') as "ehSaleMoney",
        FN_DWM_MULTIPLE_AND_UNIT(sa.EH_SALE_OUT_MONEY, 100000000, ''亿'') as "ehSaleOutMoney",
        FN_DWM_FONT_COLOR(FN_DWM_DEC_CONVERT_PCT(sa.EH_SALE_RATE_BY_MONEY)) as "ehSaleRateByMoney",
        FN_DWM_MULTIPLE_AND_UNIT((sa.EH_SALE_MONEY - sa.EH_SALE_OUT_MONEY), 100000000, ''亿'') as "ehSurplusSaleMoney"
    from DWM_SALE_RATE_PROJECT p 
    left join DWM_SALE_RATE_BY_PROJECT sa
    on sa.PROJECT_ID = p.PROJECT_ID
    where p.COMPLETION_RECORD_DATE is not null';
  v_column := ' "projectId",
      "projectName",
      "completionRecordDate",
      "ehSaleMoney",
      "ehSaleOutMoney",
      "ehSaleRateByMoney",
      "ehSurplusSaleMoney",

      "projectNameCopy",
      "ehSaleRateByMoneyCopy"';

--  if rowNumber <> 0 then
--    whereStr := whereStr || ' and rownum <= ' || rowNumber;
--  end if;
  if sortStr is not null and orderBy is not null then
    whereStr:= whereStr||' order by tab."'||sortStr||'"  '||orderBy || ' nulls last ';
  end if;
  if whereStr is not null then
    v_sql:='select ' || v_column || ' from ('||v_sql||') tab '||whereStr;
  else
    v_sql:='select ' || v_column || ' from (' ||v_sql || ' )';
  end if;
  -- 选择前n条数据，rownum必须拼接在排序后面，不然会先运行rownum再运行排序，会导致筛选数据并不准确
    if rowNumber <> 0 then
        v_sql := 'select ' || v_column || ' from (' ||v_sql || ' )' || ' where rownum <= ' || rowNumber;
    end if;
    dbms_output.put_line(v_sql);

OPEN k4DataList FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE k4DataList;
END P_DWM_DATALIST_K4;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DATALIST_K5
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_DATALIST_K5" 
(
  sortField IN VARCHAR2 
, orderBy IN VARCHAR2 
, rowNumber IN number 
, k5DataList OUT sys_refcursor 
) AS 
whereStr varchar2(500):='where 1 = 1 ';
v_sql clob :='';
-- 用于返回筛选的列
v_column clob :='';
-- 用于解决排序字段有span标签问题
sortStr varchar2(100):='';
BEGIN
sortStr := sortField;
  if sortStr = 'completionRecordDate' then
    sortStr := 'COMPLETION_RECORD_DATE';
  elsif sortStr = 'siSaleArea' then
    sortStr := 'SI_SALE_AREA';
  elsif sortStr = 'siSaleOutArea' then
    sortStr := 'SI_SALE_OUT_AREA'; 
  elsif sortStr = 'siSaleRateByArea' then
    sortStr := 'SI_SALE_RATE_BY_AREA';
  elsif sortStr = 'siSurplusSaleArea' then
    sortStr := 'SI_SURPLUS_AREA';
  elsif sortStr = 'projectName' then
    sortStr := 'projectNameCopy';
  elsif sortStr = 'siSaleMoney' then
    sortStr := 'SI_SALE_MONEY';
  elsif sortStr = 'siSaleOutMoney' then
    sortStr := 'SI_SALE_OUT_MONEY';
  elsif sortStr = 'siSaleRateByMoney' then
    sortStr := 'SI_SALE_RATE_BY_MONEY';
  elsif sortStr = 'siSurplusSaleMoney' then
    sortStr := 'SI_SURPLUS_SALE_MONEY';  
  end if;

  v_sql:= 'select
        p.COMPLETION_RECORD_DATE as "COMPLETION_RECORD_DATE",
        NVL(sa.SI_SALE_AREA,0) as "SI_SALE_AREA",
        NVL(sa.SI_SALE_OUT_AREA,0) as "SI_SALE_OUT_AREA",
        NVL(sa.SI_SALE_RATE_BY_AREA,0) as "SI_SALE_RATE_BY_AREA",
        NVL(sa.SI_SALE_AREA - sa.SI_SALE_OUT_AREA,0) as "SI_SURPLUS_AREA",
        NVL(sa.SI_SALE_MONEY,0) as "SI_SALE_MONEY",
        NVL(sa.SI_SALE_OUT_MONEY,0) as "SI_SALE_OUT_MONEY",
        NVL(sa.SI_SALE_RATE_BY_MONEY,0) as "SI_SALE_RATE_BY_MONEY",
        NVL(sa.SI_SURPLUS_SALE_MONEY,0) as "SI_SURPLUS_SALE_MONEY",

        p.PROJECT_NAME as "projectNameCopy",
        FN_DWM_DEC_CONVERT_PCT(sa.SI_SALE_RATE_BY_AREA) as "siSaleRateByAreaCopy",
        FN_DWM_DEC_CONVERT_PCT(sa.SI_SALE_RATE_BY_MONEY) as "siSaleRateByMoneyCopy",

        p.PROJECT_ID as "projectId",
        FN_DWM_FONT_COLOR(p.PROJECT_NAME) as "projectName",
        to_char(p.COMPLETION_RECORD_DATE,''yyyy-mm-dd'') as "completionRecordDate",
        FN_DWM_MULTIPLE_AND_UNIT(sa.SI_SALE_AREA, 10000, ''万方'') as "siSaleArea",
        FN_DWM_MULTIPLE_AND_UNIT(sa.SI_SALE_OUT_AREA, 10000, ''万方'') as "siSaleOutArea",
        FN_DWM_FONT_COLOR(FN_DWM_DEC_CONVERT_PCT(sa.SI_SALE_RATE_BY_AREA)) as "siSaleRateByArea",
        FN_DWM_MULTIPLE_AND_UNIT((sa.SI_SALE_AREA - sa.SI_SALE_OUT_AREA), 10000, ''万方'') as "siSurplusSaleArea",
        FN_DWM_MULTIPLE_AND_UNIT(sa.SI_SALE_MONEY, 100000000, ''亿'') as "siSaleMoney",
        FN_DWM_MULTIPLE_AND_UNIT(sa.SI_SALE_OUT_MONEY, 100000000, ''亿'') as "siSaleOutMoney",
        FN_DWM_FONT_COLOR(FN_DWM_DEC_CONVERT_PCT(sa.SI_SALE_RATE_BY_MONEY)) as "siSaleRateByMoney",
        FN_DWM_MULTIPLE_AND_UNIT(sa.SI_SURPLUS_SALE_MONEY, 100000000, ''亿'') as "siSurplusSaleMoney"
    from DWM_SALE_RATE_PROJECT p 
    left join DWM_SALE_RATE_BY_PROJECT sa
    on sa.PROJECT_ID = p.PROJECT_ID
    where p.COMPLETION_RECORD_DATE is not null';

  v_column := '"projectId",
      "projectName",
      "completionRecordDate",
      "siSaleArea",
      "siSaleOutArea",
      "siSaleRateByArea",
      "siSurplusSaleArea",
      "siSaleMoney",
      "siSaleOutMoney",
      "siSaleRateByMoney",
      "siSurplusSaleMoney",

      "projectNameCopy",
      "siSaleRateByAreaCopy",
      "siSaleRateByMoneyCopy"';

--  if rowNumber <> 0 then
--    whereStr := whereStr || ' and rownum <= ' || rowNumber;
--  end if;
  if sortStr is not null and orderBy is not null then
    whereStr:= whereStr||' order by tab."'||sortStr||'"  '||orderBy || ' nulls last ';
  end if;
  if whereStr is not null then
    v_sql:='select ' || v_column || ' from ('||v_sql||') tab '||whereStr;
  else
    v_sql:='select ' || v_column || ' from (' ||v_sql || ' )';
  end if;
  -- 选择前n条数据，rownum必须拼接在排序后面，不然会先运行rownum再运行排序，会导致筛选数据并不准确
    if rowNumber <> 0 then
        v_sql := 'select ' || v_column || ' from (' ||v_sql || ' )' || ' where rownum <= ' || rowNumber;
    end if;
  dbms_output.put_line(v_sql);

OPEN k5DataList FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE k5DataList;
END P_DWM_DATALIST_K5;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DEFAULTDATALIST_K3K4K5
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_DEFAULTDATALIST_K3K4K5" 
(
  k3DataList OUT sys_refcursor 
, k4DataList OUT sys_refcursor 
, k5DataList OUT sys_refcursor 
, k3DataSortField OUT sys_refcursor
, k4DataSortField OUT sys_refcursor
, k5DataSortField OUT sys_refcursor
, tabItems OUT sys_refcursor
, k3total OUT number
, k4total OUT number
, k5total OUT number
) AS
k3_1abstract varchar2(1000);
--k3_3abstract varchar2(1000);
--k3_4abstract varchar2(1000);
k4_1abstract varchar2(1000);
k5_1abstract varchar2(1000);
BEGIN
  select count(1) into k3total from DWM_SALE_RATE_BY_PROJECT sr
    left join DWM_SALE_RATE_PROJECT p 
    on sr.PROJECT_ID = p.PROJECT_ID
    where p.PROJECT_NAME is not null;
  select count(1) into k4total from DWM_SALE_RATE_PROJECT p 
    left join DWM_SALE_RATE_BY_PROJECT sa
    on sa.PROJECT_ID = p.PROJECT_ID
    where p.COMPLETION_RECORD_DATE is not null;
  select count(1) into k5total from DWM_SALE_RATE_PROJECT p 
    left join DWM_SALE_RATE_BY_PROJECT sa
    on sa.PROJECT_ID = p.PROJECT_ID
    where p.COMPLETION_RECORD_DATE is not null;
  SELECT
    details into k3_1abstract
  FROM
    dwm_sale_rate_data_briefing where CODE='k3.1' and rownum=1;
--  SELECT
--    details into k3_3abstract
--  FROM
--    dwm_sale_rate_data_briefing where CODE='k3.3' and rownum=1;
--  SELECT
--    details into k3_4abstract
--  FROM
--    dwm_sale_rate_data_briefing where CODE='k3.4' and rownum=1;
  SELECT
    details into k4_1abstract
  FROM
    dwm_sale_rate_data_briefing where CODE='k4.1' and rownum=1;  
  SELECT
    details into k5_1abstract
  FROM
    dwm_sale_rate_data_briefing where CODE='k5.1' and rownum=1;  

--  open k3DataList for
--    select 
--        p.PROJECT_ID as "projectId",
--        FN_DWM_FONT_COLOR(p.PROJECT_NAME) as "projectName",
--        to_char(p.FIRST_OPEN_DATE,'yyyy-mm-dd') as "firstOpenDate",
--        FN_DWM_FONT_LAYERED_COLOR(sr.PO_SALE_RATE_BY_MONEY, 0.9) as "poSaleRateByMoney",
--        FN_DWM_MULTIPLE_AND_UNIT(sr.PO_SALE_MONEY, 100000000, '亿') as "poSaleMoney",
--        FN_DWM_MULTIPLE_AND_UNIT(sr.PO_SALE_OUT_MONEY, 100000000, '亿') as "poSaleOutMoney",
--        FN_DWM_FONT_COLOR(FN_DWM_DEC_CONVERT_PCT(sr.PO_SALE_RATE_BY_COUNT)) as "poSaleRateByCount",
--        sr.PO_SALE_COUNT || '套' as "poSaleCount",
--        sr.PO_SALE_OUT_COUNT || '套' as "poSaleOutCount",
--        FN_DWM_FONT_COLOR(FN_DWM_DEC_CONVERT_PCT(sr.PO_SALE_RATE_BY_AREA)) as "poSaleRateByArea",
--        FN_DWM_MULTIPLE_AND_UNIT(sr.PO_SALE_AREA, 10000, '万方') as "poSaleArea",
--        FN_DWM_MULTIPLE_AND_UNIT(sr.PO_SALE_OUT_AREA, 10000, '万方') as "poSaleOutArea"
--    from DWM_SALE_RATE_BY_PROJECT sr
--    left join DWM_SALE_RATE_PROJECT p 
--    on sr.PROJECT_ID = p.PROJECT_ID
----  sr.PO_SALE_RATE_BY_MONEY <= 0.99 and   
--    where rowNum < 11
--    order by sr.PO_SALE_RATE_BY_MONEY desc;
  P_DWM_DATALIST_K3('poSaleRateByMoney', 'desc', 10, 0, k3DataList);
  P_DWM_DATALIST_K4('ehSaleRateByMoney', 'desc', 10, k4DataList);
  P_DWM_DATALIST_K5('siSaleRateByArea', 'desc', 10, k5DataList);


  open k3DataSortField for 
    select 'firstOpenDate' as "fieldName" from dual
    union all select 'poSaleRateByMoney' as "fieldName" from dual
    union all select 'poSaleMoney' as "fieldName" from dual
    union all select 'poSaleOutMoney' as "fieldName" from dual
    union all select 'poSaleRateByCount' as "fieldName" from dual
    union all select 'poSaleCount' as "fieldName" from dual
    union all select 'poSaleOutCount' as "fieldName" from dual
    union all select 'poSaleRateByArea' as "fieldName" from dual
    union all select 'poSaleArea' as "fieldName" from dual
    union all select 'poSaleOutArea' as "fieldName" from dual
    union all select 'projectName' as "fieldName" from dual;
  open k4DataSortField for 
    select 'completionRecordDate' as "fieldName" from dual
    union all select 'ehSaleMoney' as "fieldName" from dual
    union all select 'ehSaleOutMoney' as "fieldName" from dual
    union all select 'ehSaleRateByMoney' as "fieldName" from dual
    union all select 'ehSurplusSaleMoney' as "fieldName" from dual
    union all select 'projectName' as "fieldName" from dual;
  open k5DataSortField for 
    select 'completionRecordDate' as  "fieldName" from dual
    union all select 'siSaleArea' as "fieldName" from dual
    union all select 'siSaleOutArea' as "fieldName" from dual
    union all select 'siSaleRateByArea' as "fieldName" from dual
    union all select 'siSurplusSaleArea' as "fieldName" from dual
    union all select 'projectName' as "fieldName" from dual
    union all select 'siSaleMoney' as "fieldName" from dual
    union all select 'siSaleOutMoney' as "fieldName" from dual
    union all select 'siSaleRateByMoney' as "fieldName" from dual
    union all select 'siSurplusSaleMoney' as "fieldName" from dual;

  open tabItems for
    select '1、全案已取证去化率排行' as "title",k3_1abstract as "abstract",'k3' as "code",1 as "sort" from dual
    union
    select '2、全案已取证去化率变动趋势图' as "title",'' as "abstract",'k3' as "code",2 as "sort" from dual
--    union
--    select '3、本年新取证货值的去化率排行' as "title",k3_3abstract as "abstract",'k3' as "code",3 as "sort" from dual
--    union
--    select '4、本年新取证货值的去化率趋势图' as "title",k3_4abstract as "abstract",'k3' as "code",4 as "sort" from dual

    union
    select '1、现房去化率排行' as "title",k4_1abstract as "abstract",'k4' as "code",1 as "sort" from dual
    union
    select '2、现房去化率变动趋势图' as "title",'' as "abstract",'k4' as "code",2 as "sort" from dual
    union
    select '3、剩余现房货值变动趋势图' as "title",'' as "abstract",'k4' as "code",3 as "sort" from dual

    union
    select '1、顽固性库存去化率排行' as "title",k5_1abstract as "abstract",'k5' as "code",1 as "sort" from dual
    union
    select '2、顽固性库存去化率变动趋势图' as "title",'' as "abstract",'k5' as "code",2 as "sort" from dual
    union
    select '3、剩余顽固性库存变动趋势图' as "title",'' as "abstract",'k5' as "code",3 as "sort" from dual;
END P_DWM_DEFAULTDATALIST_K3K4K5;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DETAILBARCHARTKK3K4K5
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_DETAILBARCHARTKK3K4K5" (projectId in varchar2,tabName in varchar2,bartitle out varchar2,seriesdataName out  varchar2,saleratebycount out sys_refcursor,saleratebyarea out sys_refcursor,saleratebymoney out sys_refcursor)
AS 
SALE_OUT_COUNT_Business number(16,0):=0;
SALE_COUNT_Business number(16,0):=0;
SALE_RATE_BY_COUNT_Business number(16,4):=0;
SALE_OUT_AREA_Business number(16,2):=0;
SALE_AREA_Business number(16,2):=0;
SALE_RATE_BY_AREA_Business number(16,4):=0;
SALE_OUT_MONEY_Business number(16,2):=0;
SALE_MONEY_Business number(16,2):=0;
SALE_RATE_BY_MONEY_Business number(16,4):=0;

SALE_OUT_COUNT_House number(16,0):=0;
SALE_COUNT_House number(16,0):=0;
SALE_RATE_BY_COUNT_House number(16,4):=0;
SALE_OUT_AREA_House number(16,2):=0;
SALE_AREA_House number(16,2):=0;
SALE_RATE_BY_AREA_House number(16,4):=0;
SALE_OUT_MONEY_House number(16,2):=0;
SALE_MONEY_House number(16,2):=0;
SALE_RATE_BY_MONEY_House number(16,4):=0;

SALE_OUT_COUNT_ParkingSpace number(16,0):=0;
SALE_COUNT_ParkingSpace number(16,0):=0;
SALE_RATE_BY_COUNT_ParkingSpa number(16,4):=0;
SALE_OUT_AREA_ParkingSpace number(16,2):=0;
SALE_AREA_ParkingSpace number(16,2):=0;
SALE_RATE_BY_AREA_ParkingSpace number(16,4):=0;
SALE_OUT_MONEY_ParkingSpace number(16,2):=0;
SALE_MONEY_ParkingSpace number(16,2):=0;
SALE_RATE_BY_MONEY_ParkingSpa number(16,4):=0;

typeName varchar2(500):='';
rowcount number:=0;
series  varchar2(500):='';
begin
if tabName='k3' then
    select count(1) into rowcount  from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='商办';
    if rowcount<>0 then
    select PO_SALE_OUT_COUNT,
    PO_SALE_COUNT,
    PO_SALE_RATE_BY_COUNT,
    PO_SALE_OUT_AREA,
    PO_SALE_AREA,
    PO_SALE_RATE_BY_AREA,
    PO_SALE_OUT_MONEY,
    PO_SALE_MONEY,
    PO_SALE_RATE_BY_MONEY into  SALE_OUT_COUNT_Business,SALE_COUNT_Business,SALE_RATE_BY_COUNT_Business,SALE_OUT_AREA_Business,SALE_AREA_Business,SALE_RATE_BY_AREA_Business ,SALE_OUT_MONEY_Business ,SALE_MONEY_Business ,SALE_RATE_BY_MONEY_Business
    from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='商办';
    end if;
    select count(1) into rowcount  from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='车位';
    if rowcount<>0 then
    select PO_SALE_OUT_COUNT,
    PO_SALE_COUNT,
    PO_SALE_RATE_BY_COUNT,
    PO_SALE_OUT_AREA,
    PO_SALE_AREA,
    PO_SALE_RATE_BY_AREA,
    PO_SALE_OUT_MONEY,
    PO_SALE_MONEY,
    PO_SALE_RATE_BY_MONEY  into  SALE_OUT_COUNT_ParkingSpace,SALE_COUNT_ParkingSpace,SALE_RATE_BY_COUNT_ParkingSpa ,SALE_OUT_AREA_ParkingSpace,SALE_AREA_ParkingSpace ,SALE_RATE_BY_AREA_ParkingSpace ,SALE_OUT_MONEY_ParkingSpace ,SALE_MONEY_ParkingSpace ,SALE_RATE_BY_MONEY_ParkingSpa 
    from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='车位';
    end if;
    select count(1) into rowcount  from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='住宅';
    if rowcount<>0 then
    select PO_SALE_OUT_COUNT,
    PO_SALE_COUNT,
    PO_SALE_RATE_BY_COUNT,
    PO_SALE_OUT_AREA,
    PO_SALE_AREA,
    PO_SALE_RATE_BY_AREA,
    PO_SALE_OUT_MONEY,
    PO_SALE_MONEY,
    PO_SALE_RATE_BY_MONEY  into  SALE_OUT_COUNT_House,SALE_COUNT_House,SALE_RATE_BY_COUNT_House ,SALE_OUT_AREA_House,SALE_AREA_House ,SALE_RATE_BY_AREA_House ,SALE_OUT_MONEY_House ,SALE_MONEY_House ,SALE_RATE_BY_MONEY_House 
    from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='住宅';
    end if;
    typeName:='全案已取证';
    bartitle:='<span style="font-weight: bold;color: #333;">二、'||typeName||'去化率(%) ――按业态</span>';
    seriesdataName:='住宅,商业,车位';
    series:='已取证';
elsif tabName='k4' then
    select count(1) into rowcount  from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='商办';
    if rowcount<>0 then
    select EH_SALE_OUT_COUNT,
    EH_SALE_COUNT,
    EH_SALE_RATE_BY_COUNT,
    EH_SALE_OUT_AREA,
    EH_SALE_AREA,
    EH_SALE_RATE_BY_AREA,
    EH_SALE_OUT_MONEY,
    EH_SALE_MONEY,
    EH_SALE_RATE_BY_MONEY into  SALE_OUT_COUNT_Business,SALE_COUNT_Business,SALE_RATE_BY_COUNT_Business,SALE_OUT_AREA_Business,SALE_AREA_Business,SALE_RATE_BY_AREA_Business ,SALE_OUT_MONEY_Business ,SALE_MONEY_Business ,SALE_RATE_BY_MONEY_Business
    from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='商办';
    end if;
    select count(1) into rowcount  from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='车位';
    if rowcount<>0 then
    select EH_SALE_OUT_COUNT,
    EH_SALE_COUNT,
    EH_SALE_RATE_BY_COUNT,
    EH_SALE_OUT_AREA,
    EH_SALE_AREA,
    EH_SALE_RATE_BY_AREA,
    EH_SALE_OUT_MONEY,
    EH_SALE_MONEY,
    EH_SALE_RATE_BY_MONEY  into  SALE_OUT_COUNT_ParkingSpace,SALE_COUNT_ParkingSpace,SALE_RATE_BY_COUNT_ParkingSpa ,SALE_OUT_AREA_ParkingSpace,SALE_AREA_ParkingSpace ,SALE_RATE_BY_AREA_ParkingSpace ,SALE_OUT_MONEY_ParkingSpace ,SALE_MONEY_ParkingSpace ,SALE_RATE_BY_MONEY_ParkingSpa 
    from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='车位';
    end if;
    select count(1) into rowcount  from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='住宅';
    if rowcount<>0 then
    select EH_SALE_OUT_COUNT,
    EH_SALE_COUNT,
    EH_SALE_RATE_BY_COUNT,
    EH_SALE_OUT_AREA,
    EH_SALE_AREA,
    EH_SALE_RATE_BY_AREA,
    EH_SALE_OUT_MONEY,
    EH_SALE_MONEY,
    EH_SALE_RATE_BY_MONEY  into  SALE_OUT_COUNT_House,SALE_COUNT_House,SALE_RATE_BY_COUNT_House ,SALE_OUT_AREA_House,SALE_AREA_House ,SALE_RATE_BY_AREA_House ,SALE_OUT_MONEY_House ,SALE_MONEY_House ,SALE_RATE_BY_MONEY_House 
    from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='住宅';
    end if;
    typeName:='现房';
    bartitle:='<span style="font-weight: bold;color: #333;">二、'||typeName||'去化率(%) ――按业态</span>';
    seriesdataName:='住宅,商业,车位';
    series:='已竣备';
elsif tabName='k5' then
    select count(1) into rowcount  from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='商办';
    if rowcount<>0 then
    select SI_SALE_OUT_COUNT,
    SI_SALE_COUNT,
    SI_SALE_RATE_BY_COUNT,
    SI_SALE_OUT_AREA,
    SI_SALE_AREA,
    SI_SALE_RATE_BY_AREA,
    SI_SALE_OUT_MONEY,
    SI_SALE_MONEY,
    SI_SALE_RATE_BY_MONEY into  SALE_OUT_COUNT_Business,SALE_COUNT_Business,SALE_RATE_BY_COUNT_Business,SALE_OUT_AREA_Business,SALE_AREA_Business,SALE_RATE_BY_AREA_Business ,SALE_OUT_MONEY_Business ,SALE_MONEY_Business ,SALE_RATE_BY_MONEY_Business
    from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='商办';
    end if;
    select count(1) into rowcount  from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='车位';
    if rowcount<>0 then
    select SI_SALE_OUT_COUNT,
    SI_SALE_COUNT,
    SI_SALE_RATE_BY_COUNT,
    SI_SALE_OUT_AREA,
    SI_SALE_AREA,
    SI_SALE_RATE_BY_AREA,
    SI_SALE_OUT_MONEY,
    SI_SALE_MONEY,
    SI_SALE_RATE_BY_MONEY  into  SALE_OUT_COUNT_ParkingSpace,SALE_COUNT_ParkingSpace,SALE_RATE_BY_COUNT_ParkingSpa ,SALE_OUT_AREA_ParkingSpace,SALE_AREA_ParkingSpace ,SALE_RATE_BY_AREA_ParkingSpace ,SALE_OUT_MONEY_ParkingSpace ,SALE_MONEY_ParkingSpace ,SALE_RATE_BY_MONEY_ParkingSpa 
    from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='车位';
    end if;
    typeName:='顽固性库存';
    bartitle:='<span style="font-weight: bold;color: #333;">二、'||typeName||'去化率(%) ――按业态</span>';
    seriesdataName:='商业,车位';
    series:='顽固性库存';
end if;
open saleratebycount for
select 
 series||'套数,签约套数,去化率' as "series", 
 typeName||'去化率（按套数）' as "chartTitle",
 '' as "abstract",
  case  when  tabName<>'k5' then
      to_char(SALE_COUNT_House)||','||to_char(SALE_COUNT_Business)||','||to_char(SALE_COUNT_ParkingSpace) else
      to_char(SALE_COUNT_Business)||','||to_char(SALE_COUNT_ParkingSpace) end as "saleData",
  case  when  tabName<>'k5' then
    to_char(SALE_OUT_COUNT_House)||','||to_char(SALE_OUT_COUNT_Business)||','||to_char(SALE_OUT_COUNT_ParkingSpace) else 
    to_char(SALE_OUT_COUNT_Business)||','||to_char(SALE_OUT_COUNT_ParkingSpace) end as "saleOutData",
  case  when  tabName<>'k5' then
    to_char(trunc(SALE_RATE_BY_COUNT_House*100,2))||','||to_char(trunc(SALE_RATE_BY_COUNT_Business*100,2))||','||to_char(trunc(SALE_RATE_BY_COUNT_ParkingSpa*100,2)) else 
    to_char(trunc(SALE_RATE_BY_COUNT_Business*100,2))||','||to_char(trunc(SALE_RATE_BY_COUNT_ParkingSpa*100,2)) end as "saleRateData",
  1 as sort
from dual;
open saleratebyarea for
select 
 series||'面积,签约面积,去化率' as "series", 
 typeName||'去化率（按面积）' as "chartTitle",
 '（面积单位：m2）' as "abstract",
  case  when  tabName<>'k5' then
      to_char(SALE_AREA_House)||','||to_char(SALE_AREA_Business)||','||to_char(SALE_AREA_ParkingSpace) else 
      to_char(SALE_AREA_Business)||','||to_char(SALE_AREA_ParkingSpace) end as "saleData",
 case  when  tabName<>'k5' then
      to_char(SALE_OUT_AREA_House)||','||to_char(SALE_OUT_AREA_Business)||','||to_char(SALE_OUT_AREA_ParkingSpace) else 
      to_char(SALE_OUT_AREA_Business)||','||to_char(SALE_OUT_AREA_ParkingSpace) end as "saleOutData",
  case  when  tabName<>'k5' then
      to_char(trunc(SALE_RATE_BY_AREA_House*100,2))||','||to_char(trunc(SALE_RATE_BY_AREA_Business*100,2))||','||to_char(trunc(SALE_RATE_BY_AREA_ParkingSpace*100,2)) else
      to_char(trunc(SALE_RATE_BY_AREA_Business*100,2))||','||to_char(trunc(SALE_RATE_BY_AREA_ParkingSpace*100,2)) end as "saleRateData",
  3 as sort
from dual;
open saleratebymoney for
select 
 series||'货值,签约货值,去化率' as "series", 
 typeName||'去化率（按货值）' as "chartTitle",
 '（货值单位：万元）' as "abstract",
  case  when  tabName<>'k5' then
      to_char(trunc(SALE_MONEY_House/10000,2),'fm9999999990')||','||to_char(trunc(SALE_MONEY_Business/10000,2),'fm9999999990')||','|| to_char(trunc(SALE_MONEY_ParkingSpace/10000,2),'fm9999999990') else 
      to_char(trunc(SALE_MONEY_Business/10000,2),'fm9999999990')||','|| to_char(trunc(SALE_MONEY_ParkingSpace/10000,2),'fm9999999990') end  as "saleData",
  case  when  tabName<>'k5' then
      to_char(trunc(SALE_OUT_MONEY_House/10000,2),'fm9999999990')||','||to_char(trunc(SALE_OUT_MONEY_Business/10000,2),'fm9999999990')||','|| to_char(trunc(SALE_OUT_MONEY_ParkingSpace/10000,2),'fm9999999990') else 
      to_char(trunc(SALE_OUT_MONEY_Business/10000,2),'fm9999999990')||','|| to_char(trunc(SALE_OUT_MONEY_ParkingSpace/10000,2),'fm9999999990') end as "saleOutData",
 case  when  tabName<>'k5' then
      to_char(trunc(SALE_RATE_BY_MONEY_House*100,2))||','||to_char(trunc(SALE_RATE_BY_MONEY_Business*100,2))||','||to_char(trunc(SALE_RATE_BY_MONEY_ParkingSpa*100,2))  else
      to_char(trunc(SALE_RATE_BY_MONEY_Business*100,2))||','||to_char(trunc(SALE_RATE_BY_MONEY_ParkingSpa*100,2)) end  as "saleRateData",
 2 as sort
from dual;
end P_DWM_detailBarChartkK3k4k5;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DETAILDATAK2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_DETAILDATAK2" (projectId in varchar2,bartitle out varchar2,firstopendate out varchar2,planfirstopendate out varchar2,bardata out sys_refcursor,
listdata out sys_refcursor,nodeplantitle out varchar2,nodeplanlist out sys_refcursor,chartTitle out varchar2,chartDescription out varchar2)
AS 
firstopendateValue date;
takeLandDate date;
planfirstopendateValue date;
newPlanFirstOpenDate date;
exhibitionAreaOpenDate date;
exhibitionAreaOpenByPlan date;
planApprovalDate date;
planApprovalDateByPlan date;
rowcount number :=0;
begin
execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd''';
bartitle:='<span style="font-weight: bold;color: #333;">一、拿地至首开时间</span>';
chartTitle:='拿地至首开时间';
nodeplantitle:='<span style="font-weight: bold;color: #333;">二、首开分期“关键节点计划”</span>';
select count(1) into  rowcount  from  DWM_SALE_RATE_PROJECT where PROJECT_ID=projectId;
select FIRST_OPEN_DATE,
TAKE_LAND_DATE,
PLAN_FIRST_OPEN_DATE,
NEW_PLAN_FIRST_OPEN_DATE,
EXHIBITION_AREA_OPEN_DATE,
EXHIBITION_AREA_OPEN_BY_PLAN,
PLAN_APPROVAL_DATE,
PLAN_APPROVAL_DATE_BY_PLAN 
into 
firstopendateValue,
takeLandDate,
planfirstopendateValue,
newPlanFirstOpenDate,
exhibitionAreaOpenDate,
exhibitionAreaOpenByPlan,
planApprovalDate,
planApprovalDateByPlan
from DWM_SALE_RATE_PROJECT where PROJECT_ID=projectId;
firstopendate:='<span style="font-weight: bold;color:#333">实际首开日期：</span>';
planfirstopendate:='<span style="font-weight: bold;color:#333">计划首开日期：</span>';
if firstopendateValue is not null then
    firstopendate:='<span style="font-weight: bold;color:#333">实际首开日期：'||to_char(firstopendateValue,'yyyy-mm-dd')||'</span>';
end if;
if planfirstopendateValue is not null then
    planfirstopendate:='<span style="font-weight: bold;color:#333">计划首开日期：'||to_char(planfirstopendateValue,'yyyy-mm-dd')||'</span>';
end if;
if planfirstopendateValue is not null and firstopendateValue is not null then
    firstopendate:=firstopendate||'<span style="font-weight: bold;">     '||Fn_DWM_DurationDaysDeal(planfirstopendateValue,firstopendateValue,'label')||'';
    open bardata for
    select 
    '实际首开时间' as "seriesName",
    case when planfirstopendateValue is not null then
     trunc(months_between(firstopendateValue,takeLandDate),1)
     else 0 end as "seriesValue"
    from  dual 
    union 
    select 
    '计划首开时间' as "seriesName",
    case when planfirstopendateValue is not null then
    trunc(months_between(planfirstopendateValue,takeLandDate),1) 
    else 0 end as "seriesValue"
    from  dual;
chartDescription:=to_char(trunc(months_between(firstopendateValue,takeLandDate),1),'fm9999999990.0')||'月';
end if;

open listdata for
    select * from(select 
    '<span style="font-weight: bold;color:#333">拿地 -->方案批复</ span>' as "description",
    case when takeLandDate is not null and planApprovalDate is not null then trunc(months_between(planApprovalDate,takeLandDate),1) else null end  as "realityDuration",
    case when takeLandDate is not null and planApprovalDateByPlan is not null then trunc(months_between(planApprovalDateByPlan,takeLandDate),1) else null end  as "planDuration",
    replace(Fn_DWM_DurationDaysDeal(planApprovalDateByPlan,planApprovalDate,'label'),'首开','') as "abstract",
    1 as sort
    from  dual  union
    select 
    '<span style="font-weight: bold;color:#333">拿地 -->展示区开放</ span>' as "description",
    case when takeLandDate is not null and exhibitionAreaOpenDate is not null then trunc(months_between(exhibitionAreaOpenDate,takeLandDate),1) else null end  as "realityDuration",
    case when takeLandDate is not null and exhibitionAreaOpenByPlan is not null then trunc(months_between(exhibitionAreaOpenByPlan,takeLandDate),1) else null end  as "planDuration",
    replace(Fn_DWM_DurationDaysDeal(exhibitionAreaOpenByPlan,exhibitionAreaOpenDate,'label'),'首开','') as "abstract",
     2 as sort
    from  dual  union
    select 
    '<span style="color:#FF0000;">*</ span><span style="font-weight: bold;color:#333">拿地 -->首期开盘</ span>' as "description",
    case when takeLandDate is not null and firstopendateValue is not null then trunc(months_between(firstopendateValue,takeLandDate),1) else null end  as "realityDuration",
    case when takeLandDate is not null and planfirstopendateValue is not null then trunc(months_between(planfirstopendateValue,takeLandDate),1) else null end  as "planDuration",
    replace(Fn_DWM_DurationDaysDeal(planfirstopendateValue,firstopendateValue,'label'),'首开','') as "abstract",
     3 as sort
    from  dual) tab order by tab.sort;
open nodeplanlist for    
select 
    nodeStartSales.node_name as "nodeName",
    nodeStartSales.node_level as "nodeType",
    to_char(nodeStartSales.plan_end_Date,'yyyy-mm-dd') as "planCompletionDate",
     to_char(nodeStartSales.actual_end_date,'yyyy-mm-dd') as "actualCompletionDate",
    case when nodeStartSales.actual_end_date is not null then '<div style="display:flex"><span style="display:inline-block;background-color:#33CC99;width:15px;height:15px;border-radius:50%" ></span><span  style="margin-left:2px">已完成</span></div>' else '' end  as "status",
     to_char(nodeStartSales.ESTIMATE_END_DATE,'yyyy-mm-dd') as "expectedCompletionDate"
    from SYS_PROJECT_STAGE ps 
    --join--计划
    left join POM_PROJ_PLAN plan on ps.id=plan.proj_id
    left join POM_PROJ_PLAN_NODE  nodeStartSales on plan.id=nodeStartSales.PROJ_PLAN_ID
    where ps.PROJECT_ID=projectId and ps.STAGE_NAME in ('无分期','1期','一期')  and plan.PLAN_TYPE='关键节点计划' and plan.APPROVAL_STATUS='已审核'  and nodeStartSales.IS_DELETE<>1 and nodeStartSales.IS_DISABLE<>1;
end P_DWM_detailDatak2;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DETAILRINGCHART1K3K4K5
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_DETAILRINGCHART1K3K4K5" (projectId in varchar2,tabName in varchar2,ringTitle out clob,seriesDataName out varchar2,saleratebycount out sys_refcursor,saleratebyarea out sys_refcursor,saleratebymoney out sys_refcursor)
AS 
SALE_OUT_COUNT number(16,0):=0;
SALE_COUNT number(16,0):=0;
SALE_RATE_BY_COUNT number(16,4):=0;
SALE_OUT_AREA number(16,2):=0;
SALE_AREA number(16,2):=0;
SALE_RATE_BY_AREA number(16,4):=0;
SALE_OUT_MONEY number(16,2):=0;
SALE_MONEY number(16,2):=0;
SALE_RATE_BY_MONEY number(16,4):=0;
SURPLUS_SALE_MONEY number(16,2):=0;
typeName varchar2(500):='';
chartName varchar2(500):='';
rowcount number:=0;
begin
select count(1) into rowcount from DWM_SALE_RATE_BY_PROJECT where PROJECT_ID=projectId ;
if tabName='k1' then
ringTitle:='<span style="font-weight: bold;color: #333;">一、首开去化率</span><span style="color: #333;margin-left:10px;">注：首开的统计时间区间默认为“首次开盘后30天”。</span>';
typeName:='首开';
chartName:=typeName;
elsif  tabName='k3' then
ringTitle:='<span style="font-weight: bold;color: #333;">一、全案已取证去化率</span>';
typeName:='全案已取证';
chartName:='已取证';
elsif  tabName='k4' then
ringTitle:='<span style="font-weight: bold;color: #333;">一、现房去化率(%) </span><span style="color: #333;margin-left:10px;">注：现房指已竣备的可售资源。</span>';
typeName:='现房';
chartName:='现房';
elsif  tabName='k5' then
ringTitle:='<span style="font-weight: bold;color: #333;">一、顽固性库存去化率(%) </span><span style="color: #333;margin-left:10px;">注：顽固性库存指“本年1月1日前已竣备，且未实现签约”的可售资源。</span>';
typeName:='顽固性库存';
chartName:='共';
end if;
if tabName='k1' and rowcount <> 0 then
select FO_SALE_OUT_COUNT,
FO_SALE_COUNT,
FO_SALE_RATE_BY_COUNT,
FO_SALE_OUT_AREA,
FO_SALE_AREA,
FO_SALE_RATE_BY_AREA,
FO_SALE_OUT_MONEY,
FO_SALE_MONEY,
FO_SALE_RATE_BY_MONEY,
FO_SURPLUS_SALE_MONEY into  SALE_OUT_COUNT,SALE_COUNT,SALE_RATE_BY_COUNT ,SALE_OUT_AREA,SALE_AREA ,SALE_RATE_BY_AREA ,SALE_OUT_MONEY ,SALE_MONEY ,SALE_RATE_BY_MONEY ,SURPLUS_SALE_MONEY 
from DWM_SALE_RATE_BY_PROJECT where PROJECT_ID=projectId and rownum=1;
elsif tabName='k3' and rowcount <> 0 then
select PO_SALE_OUT_COUNT,
PO_SALE_COUNT,
PO_SALE_RATE_BY_COUNT,
PO_SALE_OUT_AREA,
PO_SALE_AREA,
PO_SALE_RATE_BY_AREA,
PO_SALE_OUT_MONEY,
PO_SALE_MONEY,
PO_SALE_RATE_BY_MONEY,
PO_SURPLUS_SALE_MONEY into  SALE_OUT_COUNT,SALE_COUNT,SALE_RATE_BY_COUNT ,SALE_OUT_AREA,SALE_AREA ,SALE_RATE_BY_AREA ,SALE_OUT_MONEY ,SALE_MONEY ,SALE_RATE_BY_MONEY ,SURPLUS_SALE_MONEY 
from DWM_SALE_RATE_BY_PROJECT where PROJECT_ID=projectId and rownum=1;
elsif tabName='k4' and rowcount <> 0 then
select EH_SALE_OUT_COUNT,
EH_SALE_COUNT,
EH_SALE_RATE_BY_COUNT,
EH_SALE_OUT_AREA,
EH_SALE_AREA,
EH_SALE_RATE_BY_AREA,
EH_SALE_OUT_MONEY,
EH_SALE_MONEY,
EH_SALE_RATE_BY_MONEY,
EH_SURPLUS_SALE_MONEY into  SALE_OUT_COUNT,SALE_COUNT,SALE_RATE_BY_COUNT ,SALE_OUT_AREA,SALE_AREA ,SALE_RATE_BY_AREA ,SALE_OUT_MONEY ,SALE_MONEY ,SALE_RATE_BY_MONEY ,SURPLUS_SALE_MONEY 
from DWM_SALE_RATE_BY_PROJECT where PROJECT_ID=projectId and rownum=1;
elsif tabName='k5' and rowcount <> 0 then
select SI_SALE_OUT_COUNT,
SI_SALE_COUNT,
SI_SALE_RATE_BY_COUNT,
SI_SALE_OUT_AREA,
SI_SALE_AREA,
SI_SALE_RATE_BY_AREA,
SI_SALE_OUT_MONEY,
SI_SALE_MONEY,
SI_SALE_RATE_BY_MONEY,
SI_SURPLUS_SALE_MONEY into  SALE_OUT_COUNT,SALE_COUNT,SALE_RATE_BY_COUNT ,SALE_OUT_AREA,SALE_AREA ,SALE_RATE_BY_AREA ,SALE_OUT_MONEY ,SALE_MONEY ,SALE_RATE_BY_MONEY ,SURPLUS_SALE_MONEY 
from DWM_SALE_RATE_BY_PROJECT where PROJECT_ID=projectId and rownum=1;
end if;
seriesDataName:='已签约,未签约';
open saleratebycount for
select 
typeName||'去化率（按套数）' as "chartTitle",
'' as "chartDescription",
fn_ConvertDecimalToPercentage(SALE_RATE_BY_COUNT) as "centerTitle",
chartName||to_char(SALE_COUNT)||'套' as "centerDescription",
to_char(SALE_OUT_COUNT)||','||to_char(SALE_COUNT-SALE_OUT_COUNT) as "seriesdata",
1 as sort
from  dual;

open saleratebymoney for
select 
typeName||'去化率（按货值）' as "chartTitle",
'（货值单位：万元）' as "chartDescription",
fn_ConvertDecimalToPercentage(SALE_RATE_BY_MONEY) as "centerTitle",
chartName||FN_DWN_AmountToBillionYuan(SALE_MONEY) as "centerDescription",
to_char(trunc(SALE_OUT_MONEY/10000,2),'fm9999999990')||','|| to_char(trunc(SURPLUS_SALE_MONEY/10000,2),'fm9999999990') as "seriesdata",
2 as sort
from  dual;
open saleratebyarea for
select 
typeName||'去化率（按面积）' as "chartTitle",
'（面积单位：m2）' as "chartDescription",
fn_ConvertDecimalToPercentage(SALE_RATE_BY_AREA) as "centerTitle",
chartName||FN_DWN_AreaTo1000Square(SALE_AREA) as "centerDescription",
 to_char(trunc(SALE_OUT_AREA,2),'fm9999999990')||','||to_char(trunc(SALE_AREA-SALE_OUT_AREA,2),'fm9999999990')  as "seriesdata",
3 as sort
from  dual;
EXCEPTION
WHEN OTHERS THEN
  CLOSE saleratebyarea;
   CLOSE saleratebycount;
    CLOSE saleratebymoney;
END P_DWM_DetailRingChart1K3k4k5;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DETAILSALERATEKLIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_DETAILSALERATEKLIST" (projectId in varchar2,tabName in varchar2,isShowAreaSection in number,listTitle out varchar2 ,tableData out sys_refcursor)
AS 
v_sql clob:='';
begin
if tabName='k1' then
listTitle:='<span style="font-weight: bold;color: #333;">二、首开去化明细情况（项目-->业态-->面积段）</span>';
v_sql:=
'SELECT
   dwm_sale_rate_by_project.PROJECT_ID as "id",
   FN_DWM_FONT_COLOR(dwm_sale_rate_project.PROJECT_NAME) as "typeName",
    fo_sale_out_count||''套'' as "saleOutCount",
    fo_sale_count||''套'' as "saleCount",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(fo_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(fo_sale_area) as "saleArea",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo_sale_rate_by_area))  as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(fo_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(fo_sale_money) as "saleMoney",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo_sale_rate_by_money))  as "saleRateByMoney",
    fo_sale_average_money as "standardPrice",
    fo_sale_out_average_money as "signPrice",
    '''' as "parentId",
    0 as "isAreaSection",
    0 as Sort
FROM
    dwm_sale_rate_by_project left join dwm_sale_rate_project on dwm_sale_rate_by_project.PROJECT_ID = dwm_sale_rate_project.PROJECT_ID where  rownum=1 and dwm_sale_rate_by_project.PROJECT_ID='''||projectId||'''
    union 
    SELECT
    id as "id",
    FN_DWM_FONT_COLOR(DATA_GRANULARITY) as "typeName",
    fo_sale_out_count||''套'' as "saleOutCount",
    fo_sale_count||''套'' as "saleCount",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(fo_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(fo_sale_area) as "saleArea",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo_sale_rate_by_area))  as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(fo_sale_out_money)  as "saleOutMoney",
   FN_DWN_AmountToBillionYuan( fo_sale_money) as "saleMoney",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo_sale_rate_by_money))  as "saleRateByMoney",
    fo_sale_average_money as "standardPrice",
    fo_sale_out_average_money as "signPrice",
    case when PARENT_ID is null then PROJECT_ID  else PARENT_ID end as "parentId",
    case when PARENT_ID is null then 0 else 1 end as "isAreaSection",
    Sort
FROM
    DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID='''||projectId||''' ' ;
    elsif  tabName='k3' then
    listTitle:='<span style="font-weight: bold;color: #333;">三、全案已取证货值去化明细表</span>';
v_sql:=
'SELECT
   dwm_sale_rate_by_project.PROJECT_ID as "id",
   FN_DWM_FONT_COLOR(dwm_sale_rate_project.PROJECT_NAME) as "typeName",
    po_sale_out_count||''套'' as "saleOutCount",
    po_sale_count||''套'' as "saleCount",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(po_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(po_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(po_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(po_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(po_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(po_sale_money) as "saleMoney",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(po_sale_rate_by_money))  as "saleRateByMoney",
    po_sale_average_money as "standardPrice",
    po_sale_out_average_money as "signPrice",
    '''' as "parentId",
    0 as "isAreaSection",
    0 as Sort
FROM
    dwm_sale_rate_by_project left join dwm_sale_rate_project on dwm_sale_rate_by_project.PROJECT_ID = dwm_sale_rate_project.PROJECT_ID where  rownum=1 and  dwm_sale_rate_by_project.PROJECT_ID='''||projectId||'''
    union 
    SELECT
    id as "id",
     FN_DWM_FONT_COLOR(DATA_GRANULARITY) as "typeName",
    po_sale_out_count||''套'' as "saleOutCount",
    po_sale_count||''套'' as "saleCount",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(po_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(po_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(po_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(po_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(po_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(po_sale_money) as "saleMoney",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(po_sale_rate_by_money))  as "saleRateByMoney",
    po_sale_average_money as "standardPrice",
    po_sale_out_average_money as "signPrice",
    case when PARENT_ID is null then PROJECT_ID  else PARENT_ID end as "parentId",
    case when PARENT_ID is null then 0 else 1 end as "isAreaSection",
    sort
FROM
    DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID='''||projectId||''' ' ;
     elsif  tabName='k4' then
    listTitle:='<span style="font-weight: bold;color: #333;">三、现房去化明细表</span>';
v_sql:=
'SELECT
   dwm_sale_rate_by_project.PROJECT_ID as "id",
   FN_DWM_FONT_COLOR(dwm_sale_rate_project.PROJECT_NAME) as "typeName",
    EH_sale_out_count||''套'' as "saleOutCount",
    EH_sale_count||''套'' as "saleCount",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(EH_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(EH_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(EH_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(EH_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(EH_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(EH_sale_money) as "saleMoney",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(EH_sale_rate_by_money))  as "saleRateByMoney",
    EH_sale_average_money as "standardPrice",
    EH_sale_out_average_money as "signPrice",
    '''' as "parentId",
    0 as "isAreaSection",
    0 as sort
FROM
    dwm_sale_rate_by_project left join dwm_sale_rate_project on dwm_sale_rate_by_project.PROJECT_ID = dwm_sale_rate_project.PROJECT_ID where  rownum=1 and  dwm_sale_rate_by_project.PROJECT_ID='''||projectId||'''
    union 
    SELECT
    id as "id",
     FN_DWM_FONT_COLOR(DATA_GRANULARITY) as "typeName",
    EH_sale_out_count||''套'' as "saleOutCount",
    EH_sale_count||''套'' as "saleCount",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(EH_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(EH_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(EH_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(EH_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(EH_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(EH_sale_money) as "saleMoney",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(EH_sale_rate_by_money))  as "saleRateByMoney",
    EH_sale_average_money as "standardPrice",
    EH_sale_out_average_money as "signPrice",
    case when PARENT_ID is null then PROJECT_ID  else PARENT_ID end as "parentId",
    case when PARENT_ID is null then 0 else 1 end as "isAreaSection",
    sort
FROM
    DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID='''||projectId||''' ' ;
elsif  tabName='k5' then
    listTitle:='<span style="font-weight: bold;color: #333;">三、已竣备货值去化明细表</span>';
v_sql:=
'SELECT
   dwm_sale_rate_by_project.PROJECT_ID as "id",
   FN_DWM_FONT_COLOR(dwm_sale_rate_project.PROJECT_NAME) as "typeName",
   SI_sale_out_count||''套'' as "saleOutCount",
   SI_sale_count||''套'' as "saleCount",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(SI_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(SI_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(SI_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(SI_sale_money) as "saleMoney",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_money))  as "saleRateByMoney",
    SI_sale_average_money as "standardPrice",
    SI_sale_out_average_money as "signPrice",
    '''' as "parentId",
    0 as "isAreaSection",
    0 as sort
FROM
    dwm_sale_rate_by_project left join dwm_sale_rate_project on dwm_sale_rate_by_project.PROJECT_ID = dwm_sale_rate_project.PROJECT_ID where  rownum=1 and  dwm_sale_rate_by_project.PROJECT_ID='''||projectId||'''
    union 
    SELECT
    id as "id",
    FN_DWM_FONT_COLOR(DATA_GRANULARITY) as "typeName",
    SI_sale_out_count||''套'' as "saleOutCount",
    SI_sale_count||''套'' as "saleCount",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(SI_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(SI_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(SI_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(SI_sale_money) as "saleMoney",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_money))  as "saleRateByMoney",
    SI_sale_average_money as "standardPrice",
    SI_sale_out_average_money as "signPrice",
    case when PARENT_ID is null then PROJECT_ID  else PARENT_ID end as "parentId",
    case when PARENT_ID is null then 0 else 1 end as "isAreaSection",
    Sort
FROM
    DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID='''||projectId||''' and  DATA_GRANULARITY <> ''住宅''   and PARENT_ID is null
    union 
    SELECT
    id as "id",
    FN_DWM_FONT_COLOR(DATA_GRANULARITY) as "typeName",
    SI_sale_out_count||''套'' as "saleOutCount",
    SI_sale_count||''套'' as "saleCount",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(SI_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(SI_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(SI_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(SI_sale_money) as "saleMoney",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_money))  as "saleRateByMoney",
    SI_sale_average_money as "standardPrice",
    SI_sale_out_average_money as "signPrice",
    case when PARENT_ID is null then PROJECT_ID  else PARENT_ID end as "parentId",
    case when PARENT_ID is null then 0 else 1 end as "isAreaSection",
    Sort
FROM
    DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID='''||projectId||''' and  PARENT_ID is not null and
    PARENT_ID not in (select Id from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID='''||projectId||''' and DATA_GRANULARITY = ''住宅'' )' ;
end if;
        dbms_output.put_line(v_sql);
    if isShowAreaSection = 0 then
         v_sql:='select * from ('||v_sql||') tab where tab."isAreaSection" = 0 order by sort';
         else
         v_sql:='select * from ('||v_sql||') tab  order by sort';
    end if;
OPEN tableData FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE tableData;
END P_DWM_DetailSaleRatekList;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DT_AREA_DTL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_DT_AREA_DTL" (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    projectid      IN             VARCHAR2, --选择公司id
    tabsindex      IN             VARCHAR2, --选择选项卡。1开始
    isoperate      IN             VARCHAR2,--是否操盘
    info           OUT            SYS_REFCURSOR
) AS
--动态货量管理-全案动态货量-穿透详情
--作者：陈丽
--日期：2019/12/17
    data_auth_spid   VARCHAR2(200);
    bizcode          VARCHAR2(200);
BEGIN
    IF tabsindex = 1 THEN
        dbms_output.put_line('所有业态!');
    ELSIF tabsindex = 2 THEN
        dbms_output.put_line('住宅及商办!');
    ELSIF tabsindex = 3 THEN
        dbms_output.put_line('住宅!');
    ELSIF tabsindex = 4 THEN
        dbms_output.put_line('商办!');
    ELSIF tabsindex = 5 THEN
        dbms_output.put_line('车位!');
    ELSe--IF tabsindex = 6 THEN
        dbms_output.put_line('剩余货量表!');
        OPEN info FOR SELECT
                          a.id             AS "id",--主键id（生成树的id，唯一可以是业务id）
                          level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '' || project_name
                              WHEN level = 2 THEN
                                  '        ' || project_name
                              WHEN level = 3 THEN
                                  '                ' || project_name
                              WHEN level = 4 THEN
                                  '                        ' || project_name
                              ELSE
                                  '                                ' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          a.parent_id      AS "parentId",--父级id（生成树父级id）
                          a.project_name   AS "orgName",--项目/分期/业态/楼栋
                          b.ZZ_area_remain AS "projWholeDwellingArea",--项目全案剩余可售货量（S=A+B+C+D）-住宅(m2)
                           b.SY_area_remain AS "projWholeBusinessArea",--项目全案剩余可售货量（S=A+B+C+D）-商业(m2)
                           b.CW_area_remain AS "projWholeCarport",--项目全案剩余可售货量（S=A+B+C+D）-车位(个)
                          b.area_remain AS "projWholeTotalArea",--项目全案剩余可售货量（S=A+B+C+D）-合计(m2)
                           b.zz_area_not_planning_permit AS "ADwellingArea",--A未取规证的可售货量-住宅(m2)
                           b.sy_area_not_planning_permit AS "ABusinessArea",--A未取规证的可售货量-商业(m2)
                           b.CW_Area_not_planning_permit AS "ACarport",--A未取规证的可售货量-车位(个)
                           b.Area_not_planning_permit AS "ATotalArea",--A未取规证的可售货量-合计(m2)
                          b.zz_area_not_construction_per AS "BDwellingArea",--B已取规证未取施工证的可售货量-住宅(m2)
                          b.SY_area_not_construction_per AS "BBusinessArea",--B已取规证未取施工证的可售货量-商业(m2)
                          b.CW_area_not_construction_per AS "BCarport",--B已取规证未取施工证的可售货量-车位(个)
                          b.area_not_construction_permit AS "BTotalArea",--B已取规证未取施工证的可售货量-合计(m2)
                          b.zz_area_not_sale_permit "CDwellingArea",--C已取规证未取预售证的可售货量-住宅(m2)
                         b.SY_area_not_sale_permit AS "CBusinessArea",--C已取规证未取预售证的可售货量-商业(m2)
                          b.CW_area_not_sale_permit AS "CCarport",--C已取规证未取预售证的可售货量-车位(个)
                          b.area_not_sale_permit AS "CTotalArea",--C已取规证未取预售证的可售货量-合计(m2)
                          b.zz_area_stock AS "DDwellingArea",--D已取预售证未售的可售货量-住宅(m2)
                          b.SY_area_stock AS "DBusinessArea",--D已取预售证未售的可售货量-商业(m2)
                          b.CW_area_stock AS "DCarport",--D已取预售证未售的可售货量-车位(个)
                          b.area_Stock AS "DTotalArea"--D已取预售证未售的可售货量-合计(m2)
                      FROM
                          (
                              SELECT
                                  id,
                                  project_name,
                                  '' AS parent_id,
                                  sn AS order_code
                              FROM
                                  sys_project
                              WHERE
                                  id = ''
                                       || projectid
                                       || ''
                              UNION ALL
--分期
                              SELECT
                                  id,
                                  stage_name,
                                  project_id AS parent_id,
                                  lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  sys_project_stage
                              WHERE
                                  project_id = ''
                                               || projectid
                                               || ''
                                  AND stage_name <> '无分期'
                              UNION ALL
--楼栋
                              SELECT
                                  mdm_build.id,
                                  build_name,
                                  (
                                      CASE
                                          WHEN mdm_period.period_name <> '无分期' THEN
                                              period_id
                                          ELSE
                                              mdm_build.proj_id
                                      END
                                  ) AS parent_id,
                                  lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  mdm_build left
                                  JOIN mdm_period ON mdm_build.period_id = mdm_period.id
                              WHERE
                                  proj_id = ''
                                            || projectid
                                            || ''
                                  AND build_state = 10--10已发布楼栋
                          ) a LEFT JOIN dwm_dt_value   b ON a.id = b.obj_id
                      START WITH
                          a.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR a.id = a.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(a.order_code, ','), 2);

    END IF;

    IF tabsindex = 1 THEN--OR tabsindex = 2-- OR tabsindex = 3 OR tabsindex = 4 OR tabsindex = 5 THEN
        OPEN info FOR SELECT
                          a.id             AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id      AS "parentId",--父级id（生成树父级id）
                          project_name   AS "orgName",--项目/分期/业态/楼栋
                          level,
                          level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '1' || project_name
                              WHEN level = 2 THEN
                                  '        2' || project_name
                              WHEN level = 3 THEN
                                  '                3' || project_name
                              WHEN level = 4 THEN
                                  '                        4' || project_name
                              ELSE
                                  '                                5' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          TO_CHAR(b.area_dt_all, '999,999,999,999,999.99') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR(b.area_dt_all, '999,999,999,999,999.99') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR(b.area_dt_all, '999,999,999,999,999.99') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR(b.area_reserve, '999,999,999,999,999.99') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR(b.area_in_process, '999,999,999,999,999.99') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR(b.area_stock, '999,999,999,999,999.99') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR(b.area_haved_sale, '999,999,999,999,999.99') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR(b.area_remain, '999,999,999,999,999.99') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR(b.area_allow_sale, '999,999,999,999,999.99') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                            CASE
                                WHEN ( b.Area_stock + b.area_haved_sale ) = 0 THEN
                                    '-'
                                ELSE
                                    TO_CHAR(b.area_haved_sale /(b.area_stock + b.area_haved_sale) * 100, '999,999,999,999,999.99'
                                    )
                                    || '%'
                            END
                        )  AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(b.area_not_planning_permit, '999,999,999,999,999.99') AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(b.area_not_construction_permit, '999,999,999,999,999.99') AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(b.area_not_sale_permit, '999,999,999,999,999.99') AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(b.area_not_completion, '999,999,999,999,999.99') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(b.area_yes_completion, '999,999,999,999,999.99') AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(b.area_yes_settlement, '999,999,999,999,999.99') AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR(b.area_dt_all, '999,999,999,999,999.99') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR(b.cw_area_reserve, '999,999,999,999,999.99') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR(b.cw_area_in_process, '999,999,999,999,999.99') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR(b.cw_area_stock, '999,999,999,999,999.99') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR(b.cw_area_haved_sale, '999,999,999,999,999.99') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR(b.cw_area_not_planning_permit, '999,999,999,999,999.99') AS "carportNoPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(b.cw_area_not_construction_per, '999,999,999,999,999.99') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(b.cw_area_not_sale_permit, '999,999,999,999,999.99') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(b.cw_area_not_completion, '999,999,999,999,999.99') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(b.cw_value_yes_completion, '999,999,999,999,999.99') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(b.cw_area_yes_settlement, '999,999,999,999,999.99') AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM
                          (
                              SELECT
                                  id,
                                  project_name,
                                  '' AS parent_id,
                                  sn AS order_code
                              FROM
                                  sys_project
                              WHERE
                                  id = ''
                                       || projectid
                                       || ''
                              UNION ALL
--分期
                              SELECT
                                  id,
                                  stage_name,
                                  project_id AS parent_id,
                                  lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  sys_project_stage
                              WHERE
                                  project_id = ''
                                               || projectid
                                               || ''
                                  AND stage_name <> '无分期'
                              UNION ALL
--楼栋
                              SELECT
                                  mdm_build.id,
                                  build_name,
                                  (
                                      CASE
                                          WHEN mdm_period.period_name <> '无分期' THEN
                                              period_id
                                          ELSE
                                              mdm_build.proj_id
                                      END
                                  ) AS parent_id,
                                  lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  mdm_build left
                                  JOIN mdm_period ON mdm_build.period_id = mdm_period.id
                              WHERE
                                  proj_id = ''
                                            || projectid
                                            || ''
                                  AND build_state = 10--10已发布楼栋
                          ) a LEFT JOIN dwm_dt_value  b ON a.id= b.obj_id
                      START WITH
                          a.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR a.id = a.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(a.order_code, ','), 2);

    END IF;
    
       IF tabsindex = 2 THEN--OR tabsindex = 4 OR tabsindex = 5 THEN
        OPEN info FOR SELECT
                          a.id             AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id      AS "parentId",--父级id（生成树父级id）
                          project_name   AS "orgName",--项目/分期/业态/楼栋
                          level,
                          level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '1' || project_name
                              WHEN level = 2 THEN
                                  '        2' || project_name
                              WHEN level = 3 THEN
                                  '                3' || project_name
                              WHEN level = 4 THEN
                                  '                        4' || project_name
                              ELSE
                                  '                                5' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          TO_CHAR(b.ZZ_area_dt_all+b.SY_area_dt_all, '999,999,999,999,999.99') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR(b.ZZ_area_dt_all+b.SY_area_dt_all, '999,999,999,999,999.99') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR(b.ZZ_area_dt_all+b.SY_area_dt_all, '999,999,999,999,999.99') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR(b.zz_area_reserve+b.SY_area_reserve, '999,999,999,999,999.99') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR(b.ZZ_area_in_process+b.SY_area_in_process, '999,999,999,999,999.99') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR(b.ZZ_area_stock+ b.sy_Area_stock, '999,999,999,999,999.99') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR(b.ZZ_area_haved_sale+b.sy_area_haved_sale, '999,999,999,999,999.99') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR(b.ZZ_area_remain+b.sy_area_remain, '999,999,999,999,999.99') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR(b.ZZ_area_allow_sale+b.SY_area_allow_sale, '999,999,999,999,999.99') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                            CASE
                                WHEN ( b.ZZ_Area_stock + b.ZZ_area_haved_sale +b.SY_Area_stock + b.SY_area_haved_sale ) = 0 THEN
                                    '-'
                                ELSE
                                    TO_CHAR((b.ZZ_area_haved_sale +b.SY_area_haved_sale)/( b.ZZ_Area_stock + b.ZZ_area_haved_sale +b.SY_Area_stock + b.SY_area_haved_sale) * 100, '999,999,999,999,999.99'
                                    )
                                    || '%'
                            END
                        )  AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(b.ZZ_area_not_planning_permit+b.SY_area_not_planning_permit, '999,999,999,999,999.99') AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(b.ZZ_area_not_construction_per+b.SY_area_not_construction_per, '999,999,999,999,999.99') AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(b.ZZ_area_not_sale_permit+b.SY_area_not_sale_permit, '999,999,999,999,999.99') AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(b.ZZ_area_not_completion+b.SY_area_not_completion, '999,999,999,999,999.99') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(b.ZZ_area_yes_completion+b.SY_area_yes_completion, '999,999,999,999,999.99') AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(b.ZZ_area_yes_settlement+b.SY_area_yes_settlement, '999,999,999,999,999.99') AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR(b.CW_area_dt_all, '999,999,999,999,999.99') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR(b.cw_area_reserve, '999,999,999,999,999.99') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR(b.cw_area_in_process, '999,999,999,999,999.99') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR(b.cw_area_stock, '999,999,999,999,999.99') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR(b.cw_area_haved_sale, '999,999,999,999,999.99') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR(b.cw_area_not_planning_permit, '999,999,999,999,999.99') AS "carportNoPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(b.cw_area_not_construction_per, '999,999,999,999,999.99') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(b.cw_area_not_sale_permit, '999,999,999,999,999.99') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(b.cw_area_not_completion, '999,999,999,999,999.99') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(b.cw_value_yes_completion, '999,999,999,999,999.99') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(b.cw_area_yes_settlement, '999,999,999,999,999.99') AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM
                          (
                              SELECT
                                  id,
                                  project_name,
                                  '' AS parent_id,
                                  sn AS order_code
                              FROM
                                  sys_project
                              WHERE
                                  id = ''
                                       || projectid
                                       || ''
                              UNION ALL
--分期
                              SELECT
                                  id,
                                  stage_name,
                                  project_id AS parent_id,
                                  lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  sys_project_stage
                              WHERE
                                  project_id = ''
                                               || projectid
                                               || ''
                                  AND stage_name <> '无分期'
                              UNION ALL
--楼栋
                              SELECT
                                  mdm_build.id,
                                  build_name,
                                  (
                                      CASE
                                          WHEN mdm_period.period_name <> '无分期' THEN
                                              period_id
                                          ELSE
                                              mdm_build.proj_id
                                      END
                                  ) AS parent_id,
                                  lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  mdm_build left
                                  JOIN mdm_period ON mdm_build.period_id = mdm_period.id
                              WHERE
                                  proj_id = ''
                                            || projectid
                                            || ''
                                  AND build_state = 10--10已发布楼栋
                          ) a LEFT JOIN dwm_dt_value  b ON a.id= b.obj_id
                      START WITH
                          a.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR a.id = a.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(a.order_code, ','), 2);

    END IF;
    
    IF tabsindex = 3 THEN--OR tabsindex = 4 OR tabsindex = 5 THEN
        OPEN info FOR SELECT
                          a.id             AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id      AS "parentId",--父级id（生成树父级id）
                          project_name   AS "orgName",--项目/分期/业态/楼栋
                          level,
                          level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '1' || project_name
                              WHEN level = 2 THEN
                                  '        2' || project_name
                              WHEN level = 3 THEN
                                  '                3' || project_name
                              WHEN level = 4 THEN
                                  '                        4' || project_name
                              ELSE
                                  '                                5' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          TO_CHAR(b.ZZ_area_dt_all, '999,999,999,999,999.99') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR(b.ZZ_area_dt_all, '999,999,999,999,999.99') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR(b.ZZ_area_dt_all, '999,999,999,999,999.99') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR(b.ZZ_area_reserve, '999,999,999,999,999.99') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR(b.ZZ_area_in_process, '999,999,999,999,999.99') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR(b.ZZ_area_stock, '999,999,999,999,999.99') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR(b.ZZ_area_haved_sale, '999,999,999,999,999.99') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR(b.ZZ_area_remain, '999,999,999,999,999.99') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR(b.ZZ_area_allow_sale, '999,999,999,999,999.99') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                            CASE
                                WHEN ( b.ZZ_Area_stock + b.ZZ_area_haved_sale ) = 0 THEN
                                    '-'
                                ELSE
                                    TO_CHAR(b.ZZ_area_haved_sale /(b.ZZ_area_stock + b.ZZ_area_haved_sale) * 100, '999,999,999,999,999.99'
                                    )
                                    || '%'
                            END
                        )  AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(b.ZZ_area_not_planning_permit, '999,999,999,999,999.99') AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(b.ZZ_area_not_construction_per, '999,999,999,999,999.99') AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(b.ZZ_area_not_sale_permit, '999,999,999,999,999.99') AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(b.ZZ_area_not_completion, '999,999,999,999,999.99') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(b.ZZ_area_yes_completion, '999,999,999,999,999.99') AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(b.ZZ_area_yes_settlement, '999,999,999,999,999.99') AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR(b.ZZ_area_dt_all, '999,999,999,999,999.99') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR(b.cw_area_reserve, '999,999,999,999,999.99') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR(b.cw_area_in_process, '999,999,999,999,999.99') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR(b.cw_area_stock, '999,999,999,999,999.99') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR(b.cw_area_haved_sale, '999,999,999,999,999.99') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR(b.cw_area_not_planning_permit, '999,999,999,999,999.99') AS "carportNoPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(b.cw_area_not_construction_per, '999,999,999,999,999.99') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(b.cw_area_not_sale_permit, '999,999,999,999,999.99') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(b.cw_area_not_completion, '999,999,999,999,999.99') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(b.cw_value_yes_completion, '999,999,999,999,999.99') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(b.cw_area_yes_settlement, '999,999,999,999,999.99') AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM
                          (
                              SELECT
                                  id,
                                  project_name,
                                  '' AS parent_id,
                                  sn AS order_code
                              FROM
                                  sys_project
                              WHERE
                                  id = ''
                                       || projectid
                                       || ''
                              UNION ALL
--分期
                              SELECT
                                  id,
                                  stage_name,
                                  project_id AS parent_id,
                                  lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  sys_project_stage
                              WHERE
                                  project_id = ''
                                               || projectid
                                               || ''
                                  AND stage_name <> '无分期'
                              UNION ALL
--楼栋
                              SELECT
                                  mdm_build.id,
                                  build_name,
                                  (
                                      CASE
                                          WHEN mdm_period.period_name <> '无分期' THEN
                                              period_id
                                          ELSE
                                              mdm_build.proj_id
                                      END
                                  ) AS parent_id,
                                  lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  mdm_build left
                                  JOIN mdm_period ON mdm_build.period_id = mdm_period.id
                              WHERE
                                  proj_id = ''
                                            || projectid
                                            || ''
                                  AND build_state = 10--10已发布楼栋
                          ) a LEFT JOIN dwm_dt_value  b ON a.id= b.obj_id
                      START WITH
                          a.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR a.id = a.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(a.order_code, ','), 2);

    END IF;
    
       IF tabsindex = 4 THEN--OR tabsindex = 4 OR tabsindex = 5 THEN
        OPEN info FOR SELECT
                          a.id             AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id      AS "parentId",--父级id（生成树父级id）
                          project_name   AS "orgName",--项目/分期/业态/楼栋
                          level,
                          level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '1' || project_name
                              WHEN level = 2 THEN
                                  '        2' || project_name
                              WHEN level = 3 THEN
                                  '                3' || project_name
                              WHEN level = 4 THEN
                                  '                        4' || project_name
                              ELSE
                                  '                                5' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          TO_CHAR(b.SY_area_dt_all, '999,999,999,999,999.99') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR(b.SY_area_dt_all, '999,999,999,999,999.99') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR(b.SY_area_dt_all, '999,999,999,999,999.99') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR(b.SY_area_reserve, '999,999,999,999,999.99') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR(b.SY_area_in_process, '999,999,999,999,999.99') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR(b.SY_area_stock, '999,999,999,999,999.99') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR(b.SY_area_haved_sale, '999,999,999,999,999.99') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR(b.SY_area_remain, '999,999,999,999,999.99') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR(b.SY_area_allow_sale, '999,999,999,999,999.99') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                            CASE
                                WHEN ( b.SY_Area_stock + b.SY_area_haved_sale ) = 0 THEN
                                    '-'
                                ELSE
                                    TO_CHAR(b.SY_area_haved_sale /(b.SY_area_stock + b.SY_area_haved_sale) * 100, '999,999,999,999,999.99'
                                    )
                                    || '%'
                            END
                        )  AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(b.SY_area_not_planning_permit, '999,999,999,999,999.99') AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(b.SY_area_not_construction_per, '999,999,999,999,999.99') AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(b.SY_area_not_sale_permit, '999,999,999,999,999.99') AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(b.SY_area_not_completion, '999,999,999,999,999.99') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(b.SY_area_yes_completion, '999,999,999,999,999.99') AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(b.SY_area_yes_settlement, '999,999,999,999,999.99') AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR(b.CW_area_dt_all, '999,999,999,999,999.99') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR(b.cw_area_reserve, '999,999,999,999,999.99') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR(b.cw_area_in_process, '999,999,999,999,999.99') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR(b.cw_area_stock, '999,999,999,999,999.99') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR(b.cw_area_haved_sale, '999,999,999,999,999.99') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR(b.cw_area_not_planning_permit, '999,999,999,999,999.99') AS "carportNoPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(b.cw_area_not_construction_per, '999,999,999,999,999.99') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(b.cw_area_not_sale_permit, '999,999,999,999,999.99') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(b.cw_area_not_completion, '999,999,999,999,999.99') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(b.cw_value_yes_completion, '999,999,999,999,999.99') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(b.cw_area_yes_settlement, '999,999,999,999,999.99') AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM
                          (
                              SELECT
                                  id,
                                  project_name,
                                  '' AS parent_id,
                                  sn AS order_code
                              FROM
                                  sys_project
                              WHERE
                                  id = ''
                                       || projectid
                                       || ''
                              UNION ALL
--分期
                              SELECT
                                  id,
                                  stage_name,
                                  project_id AS parent_id,
                                  lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  sys_project_stage
                              WHERE
                                  project_id = ''
                                               || projectid
                                               || ''
                                  AND stage_name <> '无分期'
                              UNION ALL
--楼栋
                              SELECT
                                  mdm_build.id,
                                  build_name,
                                  (
                                      CASE
                                          WHEN mdm_period.period_name <> '无分期' THEN
                                              period_id
                                          ELSE
                                              mdm_build.proj_id
                                      END
                                  ) AS parent_id,
                                  lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  mdm_build left
                                  JOIN mdm_period ON mdm_build.period_id = mdm_period.id
                              WHERE
                                  proj_id = ''
                                            || projectid
                                            || ''
                                  AND build_state = 10--10已发布楼栋
                          ) a LEFT JOIN dwm_dt_value  b ON a.id= b.obj_id
                      START WITH
                          a.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR a.id = a.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(a.order_code, ','), 2);

    END IF;
    
       IF tabsindex = 5 THEN--OR tabsindex = 4 OR tabsindex = 5 THEN
        OPEN info FOR SELECT
                          a.id             AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id      AS "parentId",--父级id（生成树父级id）
                          project_name   AS "orgName",--项目/分期/业态/楼栋
                          level,
                          level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '1' || project_name
                              WHEN level = 2 THEN
                                  '        2' || project_name
                              WHEN level = 3 THEN
                                  '                3' || project_name
                              WHEN level = 4 THEN
                                  '                        4' || project_name
                              ELSE
                                  '                                5' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          TO_CHAR(b.CW_area_dt_all, '999,999,999,999,999') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR(b.CW_area_dt_all, '999,999,999,999,999') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR(b.CW_area_dt_all, '999,999,999,999,999') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR(b.CW_area_reserve, '999,999,999,999,999') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR(b.CW_area_in_process, '999,999,999,999,999') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR(b.CW_area_stock, '999,999,999,999,999') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR(b.CW_area_haved_sale, '999,999,999,999,999') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR(b.CW_area_remain, '999,999,999,999,999') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR(b.CW_area_allow_sale, '999,999,999,999,999') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                            CASE
                                WHEN ( b.CW_Area_stock + b.CW_area_haved_sale ) = 0 THEN
                                    '-'
                                ELSE
                                    TO_CHAR(b.CW_area_haved_sale /(b.CW_area_stock + b.CW_area_haved_sale) * 100, '999,999,999,999,999'
                                    )
                                    || '%'
                            END
                        )  AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(b.CW_area_not_planning_permit, '999,999,999,999,999') AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(b.CW_area_not_construction_per, '999,999,999,999,999') AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(b.CW_area_not_sale_permit, '999,999,999,999,999') AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(b.CW_area_not_completion, '999,999,999,999,999') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(b.CW_area_yes_completion, '999,999,999,999,999') AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(b.CW_area_yes_settlement, '999,999,999,999,999') AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR(b.CW_area_dt_all, '999,999,999,999,999') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR(b.cw_area_reserve, '999,999,999,999,999') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR(b.cw_area_in_process, '999,999,999,999,999') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR(b.cw_area_stock, '999,999,999,999,999') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR(b.cw_area_haved_sale, '999,999,999,999,999') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR(b.cw_area_not_planning_permit, '999,999,999,999,999') AS "carportNoPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(b.cw_area_not_construction_per, '999,999,999,999,999') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(b.cw_area_not_sale_permit, '999,999,999,999,999') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(b.cw_area_not_completion, '999,999,999,999,999') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(b.cw_value_yes_completion, '999,999,999,999,999') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(b.cw_area_yes_settlement, '999,999,999,999,999') AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM
                          (
                              SELECT
                                  id,
                                  project_name,
                                  '' AS parent_id,
                                  sn AS order_code
                              FROM
                                  sys_project
                              WHERE
                                  id = ''
                                       || projectid
                                       || ''
                              UNION ALL
--分期
                              SELECT
                                  id,
                                  stage_name,
                                  project_id AS parent_id,
                                  lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  sys_project_stage
                              WHERE
                                  project_id = ''
                                               || projectid
                                               || ''
                                  AND stage_name <> '无分期'
                              UNION ALL
--楼栋
                              SELECT
                                  mdm_build.id,
                                  build_name,
                                  (
                                      CASE
                                          WHEN mdm_period.period_name <> '无分期' THEN
                                              period_id
                                          ELSE
                                              mdm_build.proj_id
                                      END
                                  ) AS parent_id,
                                  lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  mdm_build left
                                  JOIN mdm_period ON mdm_build.period_id = mdm_period.id
                              WHERE
                                  proj_id = ''
                                            || projectid
                                            || ''
                                  AND build_state = 10--10已发布楼栋
                          ) a LEFT JOIN dwm_dt_value  b ON a.id= b.obj_id
                      START WITH
                          a.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR a.id = a.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(a.order_code, ','), 2);

    END IF;

END p_dwm_dt_area_dtl;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DT_AREA_LIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_DT_AREA_LIST" (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    unitid         IN             VARCHAR2, --选择公司id
    isoperate      IN             VARCHAR2,--是否操盘
    tabsindex      IN             INT, --选择选项卡。1开始
    info           OUT            SYS_REFCURSOR--返回结果
) AS
--动态货量管理-全案动态货量
--作者：陈丽
--日期：2019/12/17
    data_auth_spid   VARCHAR2(200);
    bizcode          VARCHAR2(200);
BEGIN 
    --权限编码
    bizcode := 'DWM.DTHZGL.03';
    p_sys_get_company_proj_spid(userid => userid, stationid => stationid, deptid => departmentid, companyid => companyid, bizcode
    => bizcode, data_auth_spid => data_auth_spid);

    IF tabsindex = 1 THEN
        dbms_output.put_line('所有业态!');
    ELSIF tabsindex = 2 THEN
        dbms_output.put_line('住宅及商办!');
    ELSIF tabsindex = 3 THEN
        dbms_output.put_line('住宅!');
    ELSIF tabsindex = 4 THEN
        dbms_output.put_line('商办!');
    ELSIF tabsindex = 5 THEN
        dbms_output.put_line('车位!');
    ELSIF tabsindex = 6 THEN
        dbms_output.put_line('剩余货量表!');
        OPEN info FOR SELECT
                          a.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id   AS "parentId",--父级id（生成树父级id）
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/value-project/detail?code=area_dtl&isOperate='
                                  || proj_cooperate
                                  || '&projectId='
                                  || a.id
                                  || '&projectName='
                                  || org_name
                                  || '&projectDate='
                                  || take_date
                                  || '&tabIndex='
                                  || tabsindex
                                  || '&pageTitle='
                                  || org_name--页面标题名称
                              ELSE
                                  ''
                          END AS "openUrl",--详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/dynamic-volume/circular?companyId='
                                  || a.parent_id
                                  || '&projectId='
                                  || a.id
                                  || '&type=2'--companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
                              ELSE
                                  ''
                          END AS "openVisualUrl",--打开可视化地址
                          level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '' || org_name
                              WHEN level = 2 THEN
                                  '        ' || org_name
                              WHEN level = 3 THEN
                                  '                ' || org_name
                              WHEN level = 4 THEN
                                  '                        ' || org_name
                              ELSE
                                  '                                '|| org_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          org_name      AS "orgName",--公司/项目
                          TO_CHAR((SELECT SUM(DDV.zz_area_remain)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "projWholeDwellingArea",--项目全案剩余可售货量（S=A+B+C+D）-住宅(m2)
                          TO_CHAR((SELECT SUM(DDV.sy_area_remain)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "projWholeBusinessArea",--项目全案剩余可售货量（S=A+B+C+D）-商业(m2)
                          TO_CHAR((SELECT SUM(DDV.cw_area_remain)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "projWholeCarport",--项目全案剩余可售货量（S=A+B+C+D）-车位(个)
                          TO_CHAR((SELECT SUM(DDV.cw_area_remain)+SUM(DDV.sy_area_remain)+SUM(DDV.zz_area_remain)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "projWholeTotalArea",--项目全案剩余可售货量（S=A+B+C+D）-合计(m2)
                          TO_CHAR((SELECT SUM(DDV.zz_area_not_planning_permit)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "ADwellingArea",--A未取规证的可售货量-住宅(m2)
                          TO_CHAR((SELECT SUM(DDV.sy_area_not_planning_permit)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "ABusinessArea",--A未取规证的可售货量-商业(m2)
                          TO_CHAR((SELECT SUM(DDV.cw_area_not_planning_permit)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "ACarport",--A未取规证的可售货量-车位(个)
                          TO_CHAR((SELECT SUM(DDV.zz_area_not_planning_permit)+SUM(DDV.sy_area_not_planning_permit)+SUM(DDV.cw_area_not_planning_permit)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99'
                          ) AS "ATotalArea",--A未取规证的可售货量-合计(m2)
                          TO_CHAR((SELECT SUM(DDV.zz_area_not_construction_per)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "BDwellingArea",--B已取规证未取施工证的可售货量-住宅(m2)
                          TO_CHAR((SELECT SUM(DDV.sy_area_not_construction_per)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "BBusinessArea",--B已取规证未取施工证的可售货量-商业(m2)
                          TO_CHAR((SELECT SUM(DDV.cw_area_not_construction_per)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "BCarport",--B已取规证未取施工证的可售货量-车位(个)
                          TO_CHAR((SELECT SUM(DDV.zz_area_not_construction_per)+SUM(DDV.sy_area_not_construction_per)+SUM(DDV.cw_area_not_construction_per)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99'
                          ) AS "BTotalArea",--B已取规证未取施工证的可售货量-合计(m2)
                          TO_CHAR((SELECT SUM(DDV.zz_area_not_sale_permit)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "CDwellingArea",--C已取规证未取预售证的可售货量-住宅(m2)
                          TO_CHAR((SELECT SUM(DDV.sy_area_not_sale_permit)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "CBusinessArea",--C已取规证未取预售证的可售货量-商业(m2)
                          TO_CHAR((SELECT SUM(DDV.cw_area_not_sale_permit)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "CCarport",--C已取规证未取预售证的可售货量-车位(个)
                          TO_CHAR((SELECT SUM(DDV.zz_area_not_sale_permit)+SUM(DDV.sy_area_not_sale_permit)+SUM(DDV.cw_area_not_sale_permit)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "CTotalArea"
                          ,--C已取规证未取预售证的可售货量-合计(m2)
                          TO_CHAR((SELECT SUM(DDV.zz_area_stock)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "DDwellingArea",--D已取预售证未售的可售货量-住宅(m2)
                          TO_CHAR((SELECT SUM(DDV.sy_area_stock)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "DBusinessArea",--D已取预售证未售的可售货量-商业(m2)
                          TO_CHAR((SELECT SUM(DDV.cw_area_stock)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "DCarport",--D已取预售证未售的可售货量-车位(个)
                          TO_CHAR((SELECT SUM(DDV.zz_area_stock)+SUM(DDV.sy_area_stock)+SUM(DDV.cw_area_stock)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "DTotalArea"--D已取预售证未售的可售货量-合计(m2)
                      FROM
                          (
                              SELECT
                                  *
                              FROM
                                  (
                                      SELECT DISTINCT
                                          org_id       AS id,
                                          org_name     AS org_name,
                                          order_code   AS order_code,
                                          parent_id    AS parent_id,
                                          1 AS is_company,
                                          '' AS take_date,
                                          '' AS proj_cooperate
                                      FROM
                                          tmp_company_tree
                                      WHERE
                                          id = data_auth_spid
                                          AND org_id IN (
                                              SELECT DISTINCT
                                                  id
                                              FROM
                                                  sys_business_unit
                                              START WITH
                                                  id IN (
                                                      SELECT
                                                          id
                                                      FROM
                                                          (
                                                              SELECT
                                                                  unit_id AS id
                                                              FROM
                                                                  sys_project
                                                              UNION
                                                              SELECT
                                                                  subordinate_company_id AS id
                                                              FROM
                                                                  cdb_feasible_project_config
                                                          ) ds
                                                  )
                                              CONNECT BY
                                                  PRIOR parent_id = id
                                          )
                                      UNION ALL
                                      SELECT
                                          project_original_id   AS id,
                                          project_name
                                          || (
                                              CASE
                                                  WHEN proj_cooperate = '不操盘' THEN
                                                      '（不操盘）'
                                                  ELSE
                                                      ''
                                              END
                                          ) AS projname,
                                          project_code          AS ordercode,
                                          company_id            AS parentid,
                                          0 AS is_company,
                                          TO_CHAR(project_get_time, 'yyyy-mm-dd') AS take_date,
                                          mdm_project.proj_cooperate
                                      FROM
                                          mdm_project
                                      WHERE
                                          approval_status = '已审核'
                                          AND is_delete = 0
                                          AND proj_cooperate = (
                                              CASE
                                                  WHEN isoperate = '操盘'    THEN
                                                      '操盘'
                                                  WHEN isoperate = '非操盘'   THEN
                                                      '不操盘'
                                                  ELSE
                                                      proj_cooperate
                                              END
                                          )--'操盘'
                                  ) t
                          ) a
                          LEFT JOIN dwm_dt_value b ON a.id = b.obj_id
                      START WITH
                          a.id = ''
                                 || unitid
                                 || ''
                      CONNECT BY
                          PRIOR a.id = a.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(a.order_code, ','), 2);

    END IF;

    IF tabsindex = 1 OR tabsindex = 2  THEN
        OPEN info FOR SELECT
                          a.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id   AS "parentId",--父级id（生成树父级id）
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/area-project/detail?code=area_dtl&isOperate='
                                  || proj_cooperate
                                  || '&projectId='
                                  || a.id--项目id
                                  || '&projectName='
                                  || org_name---项目名称
                                  || '&projectDate='
                                  || take_date--项目获取时间
                                  || '&tabIndex='
                                  || tabsindex--选中的tabindex
                                  || '&pageTitle='
                                  || org_name--页面标题名称
                              ELSE
                                  ''
                          END AS "openUrl",--详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/dynamic-volume/circular?companyId='
                                  || a.parent_id---公司id
                                  || '&projectId='
                                  || a.id---项目id
                                  || '&type=1'--companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
                              ELSE
                                  ''
                          END AS "openVisualUrl",--打开可视化地址
                          level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '' || org_name
                              WHEN level = 2 THEN
                                  '        ' || org_name
                              WHEN level = 3 THEN
                                  '                ' || org_name
                              WHEN level = 4 THEN
                                  '                        ' || org_name
                              ELSE
                                  '                                '|| org_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          org_name      AS "orgName",--项目/分期/业态/楼栋
                          TO_CHAR((SELECT SUM(DDV.area_dt_all)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR((SELECT SUM(DDV.area_dt_all)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR((SELECT SUM(DDV.area_dt_all)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR((SELECT SUM(DDV.area_reserve)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR((SELECT SUM(DDV.AREA_IN_PROCESS)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR((SELECT SUM(DDV.area_stock)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR((SELECT SUM(DDV.area_haved_sale)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR((SELECT SUM(DDV.area_remain)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR((SELECT SUM(DDV.area_allow_sale)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                              CASE
                                  WHEN (SELECT SUM(DDV.area_stock)+SUM(DDV.area_haved_sale)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) = 0 THEN
                                      '-'
                                  ELSE
                                      TO_CHAR((SELECT SUM(DDV.area_haved_sale)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) /(SELECT SUM(DDV.area_stock)+SUM(DDV.area_haved_sale)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) * 100, '999,999,999,999,999.99'
                                      )
                                      || '%'
                              END
                          ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR((SELECT SUM(DDV.zz_area_not_planning_permit)+SUM(DDV.sy_area_not_planning_permit)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99'
                          ) AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR((SELECT SUM(DDV.zz_area_not_construction_per)+SUM(DDV.sy_area_not_construction_per)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99'
                          ) AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR((SELECT SUM(DDV.zz_area_not_sale_permit)+SUM(DDV.sy_area_not_sale_permit)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99'
                          ) AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR((SELECT SUM(DDV.area_not_completion)/*SUM(DDV.zz_area_not_sale_permit)+SUM(DDV.sy_area_not_sale_permit)-SUM(DDV.zz_area_yes_completion)-SUM(DDV.sy_area_yes_completion)*/
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID)/*nvl(b.zz_area_not_sale_permit, 0) + nvl(b.sy_area_not_sale_permit, 0) - nvl(b.zz_area_yes_completion
                          , 0) - nvl(b.sy_area_yes_completion, 0)*/, '999,999,999,999,999.99') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR((SELECT SUM(DDV.zz_area_yes_completion)+SUM(DDV.sy_area_yes_completion)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99'
                          ) AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          '-' AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR((SELECT SUM(DDV.cw_area_dt_all)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR((SELECT SUM(DDV.cw_value_reserve)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR((SELECT SUM(DDV.cw_area_in_process)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR((SELECT SUM(DDV.cw_area_stock)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR((SELECT SUM(DDV.cw_area_haved_sale)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR((SELECT SUM(DDV.area_not_planning_permit)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportNoPermitObtainedPhase"
                          ,--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR((SELECT SUM(DDV.area_not_construction_permit)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR((SELECT SUM(DDV.area_not_sale_permit)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR((SELECT SUM(DDV.area_not_completion)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR((SELECT SUM(DDV.area_yes_completion)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          '-' AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM
                          (
                              SELECT
                                  *
                              FROM
                                  (
                                      SELECT DISTINCT
                                          org_id       AS id,
                                          org_name     AS org_name,
                                          order_code   AS order_code,
                                          parent_id    AS parent_id,
                                          1 AS is_company,
                                          '' AS take_date,
                                          '' AS proj_cooperate
                                      FROM
                                          tmp_company_tree
                                      WHERE
                                          id = data_auth_spid
                                          AND org_id IN (
                                              SELECT DISTINCT
                                                  id
                                              FROM
                                                  sys_business_unit
                                              START WITH
                                                  id IN (
                                                      SELECT
                                                          id
                                                      FROM
                                                          (
                                                              SELECT
                                                                  unit_id AS id
                                                              FROM
                                                                  sys_project
                                                              UNION
                                                              SELECT
                                                                  subordinate_company_id AS id
                                                              FROM
                                                                  cdb_feasible_project_config
                                                          ) ds
                                                  )
                                              CONNECT BY
                                                  PRIOR parent_id = id
                                          )
                                      UNION ALL
                                      SELECT
                                          project_original_id   AS id,
                                          project_name
                                          || (
                                              CASE
                                                  WHEN proj_cooperate = '不操盘' THEN
                                                      '（不操盘）'
                                                  ELSE
                                                      ''
                                              END
                                          ) AS projname,
                                          project_code          AS ordercode,
                                          company_id            AS parentid,
                                          0 AS is_company,
                                          TO_CHAR(project_get_time, 'yyyy-mm-dd') AS take_date,
                                          mdm_project.proj_cooperate
                                      FROM
                                          mdm_project
                                      WHERE
                                          approval_status = '已审核'
                                          AND is_delete = 0
                                          AND proj_cooperate = (
                                              CASE
                                                  WHEN isoperate = '操盘'    THEN
                                                      '操盘'
                                                  WHEN isoperate = '非操盘'   THEN
                                                      '不操盘'
                                                  ELSE
                                                      proj_cooperate
                                              END
                                          )--'操盘'
                                  ) t
                          ) a
                          LEFT JOIN dwm_dt_value b ON a.id = b.obj_id
                      START WITH
                          a.id = ''
                                 || unitid
                                 || ''
                      CONNECT BY
                          PRIOR a.id = a.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(a.order_code, ','), 2);


    ELSIF tabsindex = 3  THEN
        OPEN info FOR SELECT
                          a.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id   AS "parentId",--父级id（生成树父级id）
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/area-project/detail?code=area_dtl&isOperate='
                                  || proj_cooperate
                                  || '&projectId='
                                  || a.id--项目id
                                  || '&projectName='
                                  || org_name---项目名称
                                  || '&projectDate='
                                  || take_date--项目获取时间
                                  || '&tabIndex='
                                  || tabsindex--选中的tabindex
                                  || '&pageTitle='
                                  || org_name--页面标题名称
                              ELSE
                                  ''
                          END AS "openUrl",--详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/dynamic-volume/circular?companyId='
                                  || a.parent_id---公司id
                                  || '&projectId='
                                  || a.id---项目id
                                  || '&type=1'--companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
                              ELSE
                                  ''
                          END AS "openVisualUrl",--打开可视化地址
                          level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '' || org_name
                              WHEN level = 2 THEN
                                  '        ' || org_name
                              WHEN level = 3 THEN
                                  '                ' || org_name
                              WHEN level = 4 THEN
                                  '                        ' || org_name
                              ELSE
                                  '                                '|| org_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          org_name      AS "orgName",--项目/分期/业态/楼栋
                          TO_CHAR((SELECT SUM(DDV.zz_area_dt_all)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR((SELECT SUM(DDV.zz_area_dt_all)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR((SELECT SUM(DDV.zz_area_dt_all)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR((SELECT SUM(DDV.zz_area_reserve)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR((SELECT SUM(DDV.zz_AREA_IN_PROCESS)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR((SELECT SUM(DDV.zz_area_stock)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR((SELECT SUM(DDV.zz_area_haved_sale)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR((SELECT SUM(DDV.zz_area_remain)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR((SELECT SUM(DDV.zz_area_allow_sale)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                              CASE
                                  WHEN (SELECT SUM(DDV.zz_area_stock)+SUM(DDV.zz_area_haved_sale)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) = 0 THEN
                                      '-'
                                  ELSE
                                      TO_CHAR((SELECT SUM(DDV.zz_area_haved_sale)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) /(SELECT SUM(DDV.zz_area_stock)+SUM(DDV.zz_area_haved_sale)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) * 100, '999,999,999,999,999.99'
                                      )
                                      || '%'
                              END
                          ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR((SELECT SUM(DDV.zz_area_not_planning_permit)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99'
                          ) AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR((SELECT SUM(DDV.zz_area_not_construction_per)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99'
                          ) AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR((SELECT SUM(DDV.zz_area_not_sale_permit)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99'
                          ) AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR((SELECT SUM(DDV.zz_area_not_completion)/*SUM(DDV.zz_area_not_sale_permit)+SUM(DDV.sy_area_not_sale_permit)-SUM(DDV.zz_area_yes_completion)-SUM(DDV.sy_area_yes_completion)*/
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID)/*nvl(b.zz_area_not_sale_permit, 0) + nvl(b.sy_area_not_sale_permit, 0) - nvl(b.zz_area_yes_completion
                          , 0) - nvl(b.sy_area_yes_completion, 0)*/, '999,999,999,999,999.99') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR((SELECT SUM(DDV.zz_area_yes_completion)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99'
                          ) AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          '-' AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR((SELECT SUM(DDV.cw_area_dt_all)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR((SELECT SUM(DDV.cw_value_reserve)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR((SELECT SUM(DDV.cw_area_in_process)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR((SELECT SUM(DDV.cw_area_stock)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR((SELECT SUM(DDV.cw_area_haved_sale)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR((SELECT SUM(DDV.zz_area_not_planning_permit)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportNoPermitObtainedPhase"
                          ,--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR((SELECT SUM(DDV.zz_area_not_construction_per)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR((SELECT SUM(DDV.zz_area_not_sale_permit)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR((SELECT SUM(DDV.zz_area_not_completion)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR((SELECT SUM(DDV.zz_area_yes_completion)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          '-' AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM
                          (
                              SELECT
                                  *
                              FROM
                                  (
                                      SELECT DISTINCT
                                          org_id       AS id,
                                          org_name     AS org_name,
                                          order_code   AS order_code,
                                          parent_id    AS parent_id,
                                          1 AS is_company,
                                          '' AS take_date,
                                          '' AS proj_cooperate
                                      FROM
                                          tmp_company_tree
                                      WHERE
                                          id = data_auth_spid
                                          AND org_id IN (
                                              SELECT DISTINCT
                                                  id
                                              FROM
                                                  sys_business_unit
                                              START WITH
                                                  id IN (
                                                      SELECT
                                                          id
                                                      FROM
                                                          (
                                                              SELECT
                                                                  unit_id AS id
                                                              FROM
                                                                  sys_project
                                                              UNION
                                                              SELECT
                                                                  subordinate_company_id AS id
                                                              FROM
                                                                  cdb_feasible_project_config
                                                          ) ds
                                                  )
                                              CONNECT BY
                                                  PRIOR parent_id = id
                                          )
                                      UNION ALL
                                      SELECT
                                          project_original_id   AS id,
                                          project_name
                                          || (
                                              CASE
                                                  WHEN proj_cooperate = '不操盘' THEN
                                                      '（不操盘）'
                                                  ELSE
                                                      ''
                                              END
                                          ) AS projname,
                                          project_code          AS ordercode,
                                          company_id            AS parentid,
                                          0 AS is_company,
                                          TO_CHAR(project_get_time, 'yyyy-mm-dd') AS take_date,
                                          mdm_project.proj_cooperate
                                      FROM
                                          mdm_project
                                      WHERE
                                          approval_status = '已审核'
                                          AND is_delete = 0
                                          AND proj_cooperate = (
                                              CASE
                                                  WHEN isoperate = '操盘'    THEN
                                                      '操盘'
                                                  WHEN isoperate = '非操盘'   THEN
                                                      '不操盘'
                                                  ELSE
                                                      proj_cooperate
                                              END
                                          )--'操盘'
                                  ) t
                          ) a
                          LEFT JOIN dwm_dt_value b ON a.id = b.obj_id
                      START WITH
                          a.id = ''
                                 || unitid
                                 || ''
                      CONNECT BY
                          PRIOR a.id = a.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(a.order_code, ','), 2);
ELSIF tabsindex = 4  THEN
        OPEN info FOR SELECT
                          a.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id   AS "parentId",--父级id（生成树父级id）
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/area-project/detail?code=area_dtl&isOperate='
                                  || proj_cooperate
                                  || '&projectId='
                                  || a.id--项目id
                                  || '&projectName='
                                  || org_name---项目名称
                                  || '&projectDate='
                                  || take_date--项目获取时间
                                  || '&tabIndex='
                                  || tabsindex--选中的tabindex
                                  || '&pageTitle='
                                  || org_name--页面标题名称
                              ELSE
                                  ''
                          END AS "openUrl",--详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/dynamic-volume/circular?companyId='
                                  || a.parent_id---公司id
                                  || '&projectId='
                                  || a.id---项目id
                                  || '&type=1'--companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
                              ELSE
                                  ''
                          END AS "openVisualUrl",--打开可视化地址
                          level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '' || org_name
                              WHEN level = 2 THEN
                                  '        ' || org_name
                              WHEN level = 3 THEN
                                  '                ' || org_name
                              WHEN level = 4 THEN
                                  '                        ' || org_name
                              ELSE
                                  '                                '|| org_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          org_name      AS "orgName",--项目/分期/业态/楼栋
                          TO_CHAR((SELECT SUM(DDV.sy_area_dt_all)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR((SELECT SUM(DDV.sy_area_dt_all)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR((SELECT SUM(DDV.sy_area_dt_all)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR((SELECT SUM(DDV.sy_area_reserve)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR((SELECT SUM(DDV.sy_AREA_IN_PROCESS)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR((SELECT SUM(DDV.sy_area_stock)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR((SELECT SUM(DDV.sy_area_haved_sale)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR((SELECT SUM(DDV.sy_area_remain)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR((SELECT SUM(DDV.sy_area_allow_sale)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                              CASE
                                  WHEN (SELECT SUM(DDV.sy_area_stock)+SUM(DDV.sy_area_haved_sale)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) = 0 THEN
                                      '-'
                                  ELSE
                                      TO_CHAR((SELECT SUM(DDV.sy_area_haved_sale)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) /(SELECT SUM(DDV.sy_area_stock)+SUM(DDV.sy_area_haved_sale)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) * 100, '999,999,999,999,999.99'
                                      )
                                      || '%'
                              END
                          ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR((SELECT SUM(DDV.sy_area_not_planning_permit)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99'
                          ) AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR((SELECT SUM(DDV.sy_area_not_construction_per)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99'
                          ) AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR((SELECT SUM(DDV.sy_area_not_sale_permit)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99'
                          ) AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR((SELECT SUM(DDV.sy_area_not_completion)/*SUM(DDV.sy_area_not_sale_permit)+SUM(DDV.sy_area_not_sale_permit)-SUM(DDV.sy_area_yes_completion)-SUM(DDV.sy_area_yes_completion)*/
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID)/*nvl(b.sy_area_not_sale_permit, 0) + nvl(b.sy_area_not_sale_permit, 0) - nvl(b.sy_area_yes_completion
                          , 0) - nvl(b.sy_area_yes_completion, 0)*/, '999,999,999,999,999.99') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR((SELECT SUM(DDV.sy_area_yes_completion)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99'
                          ) AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          '-' AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR((SELECT SUM(DDV.cw_area_dt_all)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR((SELECT SUM(DDV.cw_value_reserve)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR((SELECT SUM(DDV.cw_area_in_process)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR((SELECT SUM(DDV.cw_area_stock)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR((SELECT SUM(DDV.cw_area_haved_sale)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR((SELECT SUM(DDV.sy_area_not_planning_permit)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportNoPermitObtainedPhase"
                          ,--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR((SELECT SUM(DDV.sy_area_not_construction_per)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR((SELECT SUM(DDV.sy_area_not_sale_permit)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR((SELECT SUM(DDV.sy_area_not_completion)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR((SELECT SUM(DDV.sy_area_yes_completion)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          '-' AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM
                          (
                              SELECT
                                  *
                              FROM
                                  (
                                      SELECT DISTINCT
                                          org_id       AS id,
                                          org_name     AS org_name,
                                          order_code   AS order_code,
                                          parent_id    AS parent_id,
                                          1 AS is_company,
                                          '' AS take_date,
                                          '' AS proj_cooperate
                                      FROM
                                          tmp_company_tree
                                      WHERE
                                          id = data_auth_spid
                                          AND org_id IN (
                                              SELECT DISTINCT
                                                  id
                                              FROM
                                                  sys_business_unit
                                              START WITH
                                                  id IN (
                                                      SELECT
                                                          id
                                                      FROM
                                                          (
                                                              SELECT
                                                                  unit_id AS id
                                                              FROM
                                                                  sys_project
                                                              UNION
                                                              SELECT
                                                                  subordinate_company_id AS id
                                                              FROM
                                                                  cdb_feasible_project_config
                                                          ) ds
                                                  )
                                              CONNECT BY
                                                  PRIOR parent_id = id
                                          )
                                      UNION ALL
                                      SELECT
                                          project_original_id   AS id,
                                          project_name
                                          || (
                                              CASE
                                                  WHEN proj_cooperate = '不操盘' THEN
                                                      '（不操盘）'
                                                  ELSE
                                                      ''
                                              END
                                          ) AS projname,
                                          project_code          AS ordercode,
                                          company_id            AS parentid,
                                          0 AS is_company,
                                          TO_CHAR(project_get_time, 'yyyy-mm-dd') AS take_date,
                                          mdm_project.proj_cooperate
                                      FROM
                                          mdm_project
                                      WHERE
                                          approval_status = '已审核'
                                          AND is_delete = 0
                                          AND proj_cooperate = (
                                              CASE
                                                  WHEN isoperate = '操盘'    THEN
                                                      '操盘'
                                                  WHEN isoperate = '非操盘'   THEN
                                                      '不操盘'
                                                  ELSE
                                                      proj_cooperate
                                              END
                                          )--'操盘'
                                  ) t
                          ) a
                          LEFT JOIN dwm_dt_value b ON a.id = b.obj_id
                      START WITH
                          a.id = ''
                                 || unitid
                                 || ''
                      CONNECT BY
                          PRIOR a.id = a.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(a.order_code, ','), 2);

ELSIF tabsindex = 5  THEN
        OPEN info FOR SELECT
                          a.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id   AS "parentId",--父级id（生成树父级id）
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/area-project/detail?code=area_dtl&isOperate='
                                  || proj_cooperate
                                  || '&projectId='
                                  || a.id--项目id
                                  || '&projectName='
                                  || org_name---项目名称
                                  || '&projectDate='
                                  || take_date--项目获取时间
                                  || '&tabIndex='
                                  || tabsindex--选中的tabindex
                                  || '&pageTitle='
                                  || org_name--页面标题名称
                              ELSE
                                  ''
                          END AS "openUrl",--详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/dynamic-volume/circular?companyId='
                                  || a.parent_id---公司id
                                  || '&projectId='
                                  || a.id---项目id
                                  || '&type=1'--companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
                              ELSE
                                  ''
                          END AS "openVisualUrl",--打开可视化地址
                          level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '' || org_name
                              WHEN level = 2 THEN
                                  '        ' || org_name
                              WHEN level = 3 THEN
                                  '                ' || org_name
                              WHEN level = 4 THEN
                                  '                        ' || org_name
                              ELSE
                                  '                                '|| org_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          org_name      AS "orgName",--项目/分期/业态/楼栋
                          TO_CHAR((SELECT SUM(DDV.cw_area_dt_all)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR((SELECT SUM(DDV.cw_area_dt_all)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR((SELECT SUM(DDV.cw_area_dt_all)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR((SELECT SUM(DDV.Cw_Area_Reserve)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR((SELECT SUM(DDV.cw_AREA_IN_PROCESS)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR((SELECT SUM(DDV.cw_area_stock)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR((SELECT SUM(DDV.cw_area_haved_sale)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR((SELECT SUM(DDV.cw_area_remain)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR((SELECT SUM(DDV.cw_area_allow_sale)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                              CASE
                                  WHEN (SELECT SUM(DDV.cw_area_stock)+SUM(DDV.cw_area_haved_sale)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) = 0 THEN
                                      '-'
                                  ELSE
                                      TO_CHAR((SELECT SUM(DDV.cw_area_haved_sale)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) /(SELECT SUM(DDV.cw_area_stock)+SUM(DDV.cw_area_haved_sale)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) * 100, '999,999,999,999,999.99'
                                      )
                                      || '%'
                              END
                          ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR((SELECT SUM(DDV.cw_area_not_planning_permit)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99'
                          ) AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR((SELECT SUM(DDV.cw_area_not_construction_per)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99'
                          ) AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR((SELECT SUM(DDV.cw_area_not_sale_permit)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99'
                          ) AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR((SELECT SUM(DDV.cw_area_not_completion)/*SUM(DDV.cw_area_not_sale_permit)+SUM(DDV.cw_area_not_sale_permit)-SUM(DDV.cw_area_yes_completion)-SUM(DDV.cw_area_yes_completion)*/
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID)/*nvl(b.cw_area_not_sale_permit, 0) + nvl(b.cw_area_not_sale_permit, 0) - nvl(b.cw_area_yes_completion
                          , 0) - nvl(b.cw_area_yes_completion, 0)*/, '999,999,999,999,999.99') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR((SELECT SUM(DDV.cw_area_yes_completion)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99'
                          ) AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          '-' AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR((SELECT SUM(DDV.cw_area_dt_all)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR((SELECT SUM(DDV.Cw_Area_Reserve)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR((SELECT SUM(DDV.cw_area_in_process)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR((SELECT SUM(DDV.cw_area_stock)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR((SELECT SUM(DDV.cw_area_haved_sale)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR((SELECT SUM(DDV.cw_area_not_planning_permit)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportNoPermitObtainedPhase"
                          ,--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR((SELECT SUM(DDV.cw_area_not_construction_per)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR((SELECT SUM(DDV.cw_area_not_sale_permit)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR((SELECT SUM(DDV.cw_area_not_completion)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR((SELECT SUM(DDV.cw_area_yes_completion)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          '-' AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM
                          (
                              SELECT
                                  *
                              FROM
                                  (
                                      SELECT DISTINCT
                                          org_id       AS id,
                                          org_name     AS org_name,
                                          order_code   AS order_code,
                                          parent_id    AS parent_id,
                                          1 AS is_company,
                                          '' AS take_date,
                                          '' AS proj_cooperate
                                      FROM
                                          tmp_company_tree
                                      WHERE
                                          id = data_auth_spid
                                          AND org_id IN (
                                              SELECT DISTINCT
                                                  id
                                              FROM
                                                  sys_business_unit
                                              START WITH
                                                  id IN (
                                                      SELECT
                                                          id
                                                      FROM
                                                          (
                                                              SELECT
                                                                  unit_id AS id
                                                              FROM
                                                                  sys_project
                                                              UNION
                                                              SELECT
                                                                  subordinate_company_id AS id
                                                              FROM
                                                                  cdb_feasible_project_config
                                                          ) ds
                                                  )
                                              CONNECT BY
                                                  PRIOR parent_id = id
                                          )
                                      UNION ALL
                                      SELECT
                                          project_original_id   AS id,
                                          project_name
                                          || (
                                              CASE
                                                  WHEN proj_cooperate = '不操盘' THEN
                                                      '（不操盘）'
                                                  ELSE
                                                      ''
                                              END
                                          ) AS projname,
                                          project_code          AS ordercode,
                                          company_id            AS parentid,
                                          0 AS is_company,
                                          TO_CHAR(project_get_time, 'yyyy-mm-dd') AS take_date,
                                          mdm_project.proj_cooperate
                                      FROM
                                          mdm_project
                                      WHERE
                                          approval_status = '已审核'
                                          AND is_delete = 0
                                          AND proj_cooperate = (
                                              CASE
                                                  WHEN isoperate = '操盘'    THEN
                                                      '操盘'
                                                  WHEN isoperate = '非操盘'   THEN
                                                      '不操盘'
                                                  ELSE
                                                      proj_cooperate
                                              END
                                          )--'操盘'
                                  ) t
                          ) a
                          LEFT JOIN dwm_dt_value b ON a.id = b.obj_id
                      START WITH
                          a.id = ''
                                 || unitid
                                 || ''
                      CONNECT BY
                          PRIOR a.id = a.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(a.order_code, ','), 2);
    END IF;
		

END p_dwm_dt_area_list;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DT_EXCEL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_DT_EXCEL" (
    userid          IN              VARCHAR2, --当前用户id
    stationid       IN              VARCHAR2, --当前用户岗位id
    departmentid    IN              VARCHAR2, --当前用户部门id
    companyid       IN              VARCHAR2, --当前用户公司id
    unitid          IN              VARCHAR2, --选择公司id
    isoperate       IN              VARCHAR2,--是否操盘
    dttype          IN              VARCHAR2,--类型： dt_value:货值，dt_area:货量，value_dtl:货值，area_dtl:货量
    tabsindex       IN              INT, --选择选项卡。1开始
    colorfiled      OUT             VARCHAR2,--excel 指定颜色字段名称
    exceldescribe   OUT             VARCHAR2,--excel 顶部描述，空不显示对应区域
    excelname       OUT             VARCHAR2,--excel导出文件名，已弃用
    excelfileds     OUT             SYS_REFCURSOR,--excel需要导出的列及中文列名，及表头颜色
    info            OUT             SYS_REFCURSOR--返回结果
) AS
--动态货量管理-全案动态货量
--作者：陈丽
--日期：2019/12/17

    data_auth_spid   VARCHAR2(200);
    bizcode          VARCHAR2(200);
    v_sql            CLOB;
    v_tab1_sql       CLOB;
    v_build_sql      CLOB;
    v_tab2_sql       CLOB;
    v_tab3_sql       CLOB;
    v_pub_sql        CLOB;
    v_sql_exec       CLOB;
BEGIN
    exceldescribe := '全案动态表';--excel 顶部描述，空不显示对应区域
    excelname := '';--excel导出文件名，已弃用
    colorfiled := 'excelRowBgColor';
    v_build_sql := 'SELECT
                           2  as "order",
                           get_uuid() AS "id",
                             '''' AS "parentId",
                            ''newestBuildArea'' AS "filed",
                            ''最新建筑面积'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION '
    ;
    v_pub_sql := 'SELECT
                           1 as "order",
                             get_uuid() AS "id",
                             '''' AS "parentId",
                            ''excelRowTextTreeOrgName'' AS "filed",
                          case when '''
                 || dttype
                 || ''' = ''dt_value'' or '''
                 || dttype
                 || ''' = ''dt_area'' then ''公司/项目'' else ''项目/分期/业态/楼栋'' end AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                            UNION 
                        '
                 ;
    IF ( dttype = 'dt_area' OR dttype = 'area_dtl' ) THEN
        IF ( dttype = 'dt_area' ) THEN
            p_dwm_dt_area_list(userid => userid, stationid => stationid, departmentid => departmentid, companyid => companyid, unitid
            => unitid, isoperate => isoperate, tabsindex => tabsindex, info => info);
        ELSE
            p_dwm_dt_area_dtl(userid => userid, stationid => stationid, departmentid => departmentid, companyid => companyid, projectid
            => unitid, isoperate => isoperate, tabsindex => tabsindex, info => info);
        END IF;

        v_tab1_sql := '  
                        SELECT
                             3  as "order",
                             get_uuid() AS "id",
                             '''' AS "parentId",
                            ''newestSalesArea'' AS "filed",
                            ''最新可售面积（不含车位）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                            UNION
                            SELECT
                            4  as "order",
                            ''1'' AS "id",
                            '''' AS "parentId",
                            ''noCarportDynamicCargo'' AS "filed",
                            ''动态货量（不含车位）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                            4.1  as "order",
                            get_uuid() AS "id",
                             ''1'' AS "parentId",
                            ''dynamicCargo'' AS "filed",
                            ''动态货量'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor" --表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                         4.2  as "order",
                         get_uuid() AS "id",
                             ''1'' AS "parentId",
                            ''reserveCargo'' AS "filed",
                            ''储备货量(A1)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        4.3  as "order",
                         get_uuid() AS "id",
                             ''1'' AS "parentId",
                            ''inProcessTotalCargo'' AS "filed",
                            ''在途货量(A2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        4.4 as "order",
                         get_uuid() AS "id",
                             ''1'' AS "parentId",
                            ''stockCargo'' AS "filed",
                            ''库存货量(A3)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        4.5  as "order",
                         get_uuid() AS "id",
                             ''1'' AS "parentId",
                            ''alreadySalesCargo'' AS "filed",
                            ''已售货量(A4)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        5  as "order",
                              ''2'' AS "id",
                            '''' AS "parentId",
                            ''noPermitObtainedPhase'' AS "filed",
                            ''动态货量的各阶段分布（不含车位）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                          SELECT
                          5.1 as "order",
                            get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''noPermitObtainedPhase'' AS "filed",
                            ''0未取规证'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                          5.2  as "order",
                        get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''PermitObtainedOhase'' AS "filed",
                            ''1规划许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                          SELECT
                          5.3  as "order",
                          get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''constructionPermitOhase'' AS "filed",
                            ''2施工许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                         5.4  as "order",
                         get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''PreSalePermitPhase'' AS "filed",
                            ''3预售许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                          5.5 as "order",
                         get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''completedRecordPhase'' AS "filed",
                            ''4竣备阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                          5.6  as "order",
                         get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''carryDownPhase'' AS "filed",
                            ''5结转阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual'

        ;
        v_tab2_sql := ' 
                        SELECT
                           6  as "order",
                            ''3'' AS "id",
                            '''' AS "parentId",
                            ''dynamicCargo'' AS "filed",
                            ''动态货量（车位按“个”）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        6.1 as "order",
                            get_uuid() AS "id",
                             ''3'' AS "parentId",
                            ''carportDynamicCargo'' AS "filed",
                            ''动态货量'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor" --表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        6.2 as "order",
                         get_uuid() AS "id",
                             ''3'' AS "parentId",
                            ''carportReserveCargo'' AS "filed",
                            ''储备货量(A1)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        6.3  as "order",
                         get_uuid() AS "id",
                             ''3'' AS "parentId",
                            ''carportInProcessTotalCargo'' AS "filed",
                            ''在途货量(A2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        6.4  as "order",
                         get_uuid() AS "id",
                             ''3'' AS "parentId",
                            ''carportStockCargo'' AS "filed",
                            ''库存货量(A3)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        6.5  as "order",
                         get_uuid() AS "id",
                             ''3'' AS "parentId",
                            ''carportAlreadySalesCargo'' AS "filed",
                            ''已售货量(A4)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        7  as "order",
                              ''4'' AS "id",
                            '''' AS "parentId",
                            ''permitObtainedPhase'' AS "filed",
                            ''动态货量的各阶段分布（车位按“个”）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                          SELECT
                          7.1  as "order",
                            get_uuid() AS "id",
                             ''4'' AS "parentId",
                            ''carportNoPermitObtainedPhase'' AS "filed",
                            ''0未取规证'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        7.2  as "order",
                        get_uuid() AS "id",
                             ''4'' AS "parentId",
                            ''carportPermitObtainedOhase'' AS "filed",
                            ''1规划许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                          SELECT
                         7.3  as "order",
                          get_uuid() AS "id",
                             ''4'' AS "parentId",
                            ''carportConstructionPermitOhase'' AS "filed",
                            ''2施工许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                         7.4  as "order",
                         get_uuid() AS "id",
                             ''4'' AS "parentId",
                            ''carportPreSalePermitPhase'' AS "filed",
                            ''3预售许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                         7.5 as "order",
                         get_uuid() AS "id",
                             ''4'' AS "parentId",
                            ''carportCompletedRecordPhase'' AS "filed",
                            ''4竣备阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor" --表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                        7.6 as "order",
                         get_uuid() AS "id",
                             ''4'' AS "parentId",
                            ''carportCarryDownPhase'' AS "filed",
                            ''5结转阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual'
        ;
        v_tab3_sql := ' 
                        SELECT
                       8  as "order",
                            ''5'' AS "id",
                             '''' AS "parentId",
                            ''projSurplusArea'' AS "filed",
                            ''项目全案剩余可售货量（S=A+B+C+D）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                         8.1  as "order",
                             get_uuid() AS "id",
                             ''5'' AS "parentId",
                            ''projWholeDwellingArea'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                            UNION
                            SELECT
                            8.2 as "order",
                             get_uuid() AS "id",
                            ''5'' AS "parentId",
                            ''projWholeBusinessArea'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                         8.3 as "order",
                            get_uuid() AS "id",
                             ''5'' AS "parentId",
                            ''projWholeCarport'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor" --表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                         8.4  as "order",
                         get_uuid() AS "id",
                             ''5'' AS "parentId",
                            ''projWholeTotalArea'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                         9  as "order",
                         ''6'' AS "id",
                             '''' AS "parentId",
                            ''noA'' AS "filed",
                            ''A未取规证的可售货量'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        9.1  as "order",
                         get_uuid() AS "id",
                             ''6'' AS "parentId",
                            ''ADwellingArea'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                         9.2  as "order",
                         get_uuid() AS "id",
                             ''6'' AS "parentId",
                            ''ABusinessArea'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        9.3  as "order",
                             get_uuid() AS "id",
                            ''6'' AS "parentId",
                            ''ACarport'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                          SELECT
                           9.4 as "order",
                            get_uuid() AS "id",
                             ''6'' AS "parentId",
                            ''ATotalArea'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual

                            UNION
                        SELECT
                         10  as "order",
                         ''7'' AS "id",
                             '''' AS "parentId",
                            ''noB1'' AS "filed",
                            ''B已取规证未取施工证的可售货量'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        10.1  as "order",
                         get_uuid() AS "id",
                             ''7'' AS "parentId",
                            ''BDwellingArea'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                         10.2 as "order",
                         get_uuid() AS "id",
                             ''7'' AS "parentId",
                            ''BBusinessArea'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                         10.3  as "order",
                             get_uuid() AS "id",
                            ''7'' AS "parentId",
                            ''BCarport'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                          SELECT
                           10.4  as "order",
                            get_uuid() AS "id",
                             ''7'' AS "parentId",
                            ''BTotalArea'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual   
                        UNION
                        SELECT
                         11 as "order",
                        ''8'' AS "id",
                             '''' AS "parentId",
                            ''CA'' AS "filed",
                            ''C已取施工证未取预售证的可售货量'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                          SELECT
                            11.1 as "order",
                          get_uuid() AS "id",
                             ''8'' AS "parentId",
                            ''CDwellingArea'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                           11.2 as "order",
                         get_uuid() AS "id",
                             ''8'' AS "parentId",
                            ''CBusinessArea'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                           11.3 as "order",
                         get_uuid() AS "id",
                             ''8'' AS "parentId",
                            ''CCarport'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                          11.4 as "order",
                         get_uuid() AS "id",
                             ''8'' AS "parentId",
                            ''CTotalArea'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                             UNION
                         SELECT
                          12 as "order",
                         ''9'' AS "id",
                             '''' AS "parentId",
                            ''DA'' AS "filed",
                            ''D已取预售证未售的可售货量'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                            UNION
                         SELECT
                           12.1 as "order",
                         get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''DDwellingArea'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                             UNION
                         SELECT
                           12.2 as "order",
                         get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''DBusinessArea'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                             UNION
                         SELECT
                           12.3 as "order",
                         get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''DCarport'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                              UNION
                         SELECT
                          12.4 as "order",
                         get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''DTotalArea'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                            '
        ;
        IF ( tabsindex = 1 ) THEN
            v_sql := v_pub_sql
                     || v_build_sql
                     || v_tab1_sql
                     || ' UNION '
                     || v_tab2_sql;
        ELSIF ( tabsindex = 2 OR tabsindex = 3 OR tabsindex = 4 ) THEN
            v_sql := v_pub_sql
                     || v_build_sql
                     || v_tab1_sql;
        ELSIF ( tabsindex = 5 ) THEN
            v_sql := v_pub_sql
                     || v_build_sql
                     || v_tab2_sql;
        ELSIF ( tabsindex = 6 ) THEN
            v_sql := v_pub_sql || v_tab3_sql;
        ELSE
            v_sql := v_pub_sql
                     || v_build_sql
                     || v_tab2_sql;
        END IF;

        v_sql_exec := 'select  level,
                             a."id",
                            a."parentId",
                            a."filed",
                            a."filedName",
                            a."filedTitleBgColor",
                            a."filedTitleColor"  from ('
                      || v_sql
                      || ') a   START WITH
                            "parentId" IS NULL
                        CONNECT BY
                            PRIOR "id" = "parentId"  order by a."order"'
                      ;
        dbms_output.put_line(v_sql_exec);
        OPEN excelfileds FOR v_sql_exec;

    ELSE
        IF ( dttype = 'dt_value' ) THEN
            p_dwm_dt_value_list(userid => userid, stationid => stationid, departmentid => departmentid, companyid => companyid, unitid
            => unitid, isoperate => isoperate, tabsindex => tabsindex, info => info);
        ELSE
            p_dwm_dt_value_dtl(userid => userid, stationid => stationid, departmentid => departmentid, companyid => companyid, projectid
            => unitid, isoperate => isoperate, tabsindex => tabsindex, info => info);
        END IF;

        v_tab1_sql := ' SELECT
                          3 as "order",
                          ''2'' AS "id",
                             '''' AS "parentId",
                            ''A1'' AS "filed",
                            ''目标总货值（A）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                            SELECT
                              3.1 as "order",
                         get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''targetFeasibleWorth'' AS "filed",
                            ''可研版(A1)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                              SELECT
                                3.2 as "order",
                         get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''targetWholeWorth'' AS "filed",
                            ''全盘版(A2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               3.3 as "order",
                         get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''targetDynamicWorth'' AS "filed",
                            ''动态版(A3)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               3.4 as "order",
                         get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''targetNewestWorth'' AS "filed",
                            ''最新版(A4)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               4 as "order",
                         ''3'' AS "id",
                             '''' AS "parentId",
                            ''dynamicTotalWorth'' AS "filed",
                            ''动态总货值(B)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                              5 as "order",
                         ''4'' AS "id",
                             '''' AS "parentId",
                            ''dynamicTotalWorthDifference'' AS "filed",
                            ''总货值差额(B-A)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                               6 as "order",
                           ''5'' AS "id",
                             '''' AS "parentId",
                            ''dt'' AS "filed",
                            ''动态总货值构成（B=B1+B2+B3+B4）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               6.1 as "order",
                           get_uuid() AS "id",
                             ''5'' AS "parentId",
                            ''reserveTotalWorth'' AS "filed",
                            ''储备货值(B1)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                              6.2 as "order",
                           get_uuid() AS "id",
                             ''5'' AS "parentId",
                            ''inProcessTotalWorth'' AS "filed",
                            ''在途货值(B2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                               UNION
                             SELECT
                              6.3 as "order",
                           get_uuid() AS "id",
                             ''5'' AS "parentId",
                            ''stockWorth'' AS "filed",
                            ''库存货值(B3)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                             SELECT
                              6.4 as "order",
                           get_uuid() AS "id",
                             ''5'' AS "parentId",
                            ''alreadySalesWorth'' AS "filed",
                            ''已售货值(B4)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                              7 as "order",
                           ''6'' AS "id",
                             '''' AS "parentId",
                            ''residueWorth'' AS "filed",
                            ''剩余货值(C=B1+B2+B3)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                               8 as "order",
                           ''7'' AS "id",
                             '''' AS "parentId",
                            ''getWorth'' AS "filed",
                            ''已领证货值(D=B3+B4)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               9 as "order",
                           ''8'' AS "id",
                             '''' AS "parentId",
                            ''salesRate'' AS "filed",
                            ''去化率(E=B4/D)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                               10 as "order",
                           ''9'' AS "id",
                             '''' AS "parentId",
                            ''noPlanningPermitObtainedPhase'' AS "filed",
                            ''F、动态货值的各阶段分布'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               10.1 as "order",
                              get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''noPlanningPermitObtainedPhase'' AS "filed",
                            ''F0未取规证'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                               UNION
                             SELECT
                               10.2 as "order",
                              get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''planningPermitObtainedOhase'' AS "filed",
                            ''F1规划许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                               10.3 as "order",
                              get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''constructionPermitOhase'' AS "filed",
                            ''F2施工许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                              10.4 as "order",
                              get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''PreSalePermitPhase'' AS "filed",
                            ''F3预售许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                                10.5 as "order",
                              get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''completedRecordPhase'' AS "filed",
                            ''F4竣备阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                               UNION
                             SELECT
                                10.6 as "order",
                              get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''carryDownPhase'' AS "filed",
                            ''F5结转阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                               UNION
                             SELECT
                                11 as "order",
                             ''10'' AS "id",
                             '''' AS "parentId",
                            ''G1'' AS "filed",
                            ''G1、储备货值的量价情况'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               11.1 as "order",
                             get_uuid() AS "id",
                             ''10'' AS "parentId",
                            ''reserveWorth'' AS "filed",
                            ''货值（G1=a1*b1）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                               11.2 as "order",
                             get_uuid() AS "id",
                             ''10'' AS "parentId",
                            ''reserveCargo'' AS "filed",
                            ''货值(a1)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                               11.3 as "order",
                             get_uuid() AS "id",
                             ''10'' AS "parentId",
                            ''reservePrice'' AS "filed",
                            ''单价(b1)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               12 as "order",
                             ''11'' AS "id",
                             '''' AS "parentId",
                            ''reservePrice'' AS "filed",
                            ''G2、在途货值的量价情况'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               12.1 as "order",
                             get_uuid() AS "id",
                             ''11'' AS "parentId",
                            ''inTransitWorth'' AS "filed",
                            ''货值（G2=a2*b2）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                               12.2 as "order",
                             get_uuid() AS "id",
                             ''11'' AS "parentId",
                            ''inTransitCargo'' AS "filed",
                            ''货值(a2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               12.3 as "order",
                             get_uuid() AS "id",
                             ''11'' AS "parentId",
                            ''inTransitPrice'' AS "filed",
                            ''单价(b2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                               13 as "order",
                             ''12'' AS "id",
                             '''' AS "parentId",
                            ''G3'' AS "filed",
                            ''G3、库存货值的量价情况'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                                  13.1 as "order",
                             get_uuid() AS "id",
                             ''12'' AS "parentId",
                            ''stockWorth'' AS "filed",
                            ''货值（G3=a3*b3）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                               UNION
                             SELECT
                                  13.2 as "order",
                             get_uuid() AS "id",
                             ''12'' AS "parentId",
                            ''stockCargo'' AS "filed",
                            ''货值(a3)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                                  13.3 as "order",
                             get_uuid() AS "id",
                             ''12'' AS "parentId",
                            ''stockPrice'' AS "filed",
                            ''单价(b3)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                                  14 as "order",
                             ''13'' AS "id",
                             '''' AS "parentId",
                            ''G4'' AS "filed",
                            ''G4、已售货值的量价情况'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                                14.1 as "order",
                            get_uuid() AS "id",
                             ''13'' AS "parentId",
                            ''soldWorth'' AS "filed",
                            ''货值（G4=a4*b4）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                                14.2 as "order",
                            get_uuid() AS "id",
                             ''13'' AS "parentId",
                            ''soldCargo'' AS "filed",
                            ''货值(a4)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                             SELECT
                                14.3 as "order",
                            get_uuid() AS "id",
                             ''13'' AS "parentId",
                            ''soldPrice'' AS "filed",
                            ''单价(b4)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual '

        ;
        v_tab2_sql := ' SELECT
                              15 as "order",
                            ''14'' AS "id",
                             '''' AS "parentId",
                            ''S1'' AS "filed",
                            ''项目全案剩余可售货值（万元）（S=A+B+C+D）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                            SELECT
                            15.1 as "order",
                          get_uuid() AS "id",
                             ''14'' AS "parentId",
                            ''projWholeDwellingValue'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                               SELECT
                                   15.2 as "order",
                          get_uuid() AS "id",
                             ''14'' AS "parentId",
                            ''projWholeBusinessValue'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                 SELECT
                                   15.3 as "order",
                          get_uuid() AS "id",
                             ''14'' AS "parentId",
                            ''projWholeCarportValue'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                  SELECT
                                    15.4 as "order",
                          get_uuid() AS "id",
                             ''14'' AS "parentId",
                            ''projWholeTotalValue'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                            SELECT
                              16 as "order",
                            ''15'' AS "id",
                             '''' AS "parentId",
                            ''S2'' AS "filed",
                            ''A未取规证的可售货值（万元）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                            SELECT
                              16.1 as "order",
                          get_uuid() AS "id",
                             ''15'' AS "parentId",
                            ''ADwellingValue'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                               SELECT
                               16.2 as "order",
                          get_uuid() AS "id",
                             ''15'' AS "parentId",
                            ''ABusinessValue'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                 SELECT
                                 16.3 as "order",
                          get_uuid() AS "id",
                             ''15'' AS "parentId",
                            ''ACarportValue'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                  SELECT
                                  16.4 as "order",
                          get_uuid() AS "id",
                             ''15'' AS "parentId",
                            ''ATotalValue'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                             SELECT
                             17 as "order",
                            ''16'' AS "id",
                             '''' AS "parentId",
                            ''S3'' AS "filed",
                            ''B已取规证未取施工证的可售货值（万元）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                            SELECT
                              17.1 as "order",
                          get_uuid() AS "id",
                             ''16'' AS "parentId",
                            ''BDwellingValue'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                               SELECT
                                  17.2 as "order",
                          get_uuid() AS "id",
                             ''16'' AS "parentId",
                            ''BBusinessValue'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                 SELECT
                                   17.3 as "order",
                          get_uuid() AS "id",
                             ''16'' AS "parentId",
                            ''BCarportValue'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                  SELECT
                                    17.4 as "order",
                          get_uuid() AS "id",
                             ''16'' AS "parentId",
                            ''BTotalValue'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                SELECT
                                  18 as "order",
                            ''17'' AS "id",
                             '''' AS "parentId",
                            ''S4'' AS "filed",
                            ''C已取施工证未取预售证的可售货值（万元）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                            SELECT
                            18.1 as "order",
                          get_uuid() AS "id",
                             ''17'' AS "parentId",
                            ''CDwellingValue'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                               SELECT
                               18.2 as "order",
                          get_uuid() AS "id",
                             ''17'' AS "parentId",
                            ''CBusinessValue'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                 SELECT
                                 18.3 as "order",
                          get_uuid() AS "id",
                             ''17'' AS "parentId",
                            ''CCarportValue'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                  SELECT
                                  18.4 as "order",
                          get_uuid() AS "id",
                             ''17'' AS "parentId",
                            ''CTotalValue'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                               SELECT
                               19 as "order",
                            ''18'' AS "id",
                             '''' AS "parentId",
                            ''S5'' AS "filed",
                            ''D已取预售证未售的可售货值（万元）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                            SELECT
                                19.1 as "order",
                          get_uuid() AS "id",
                             ''18'' AS "parentId",
                            ''DDwellingValue'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                               SELECT
                                  19.2 as "order",
                          get_uuid() AS "id",
                             ''18'' AS "parentId",
                            ''DBusinessValue'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                 SELECT
                                          19.3 as "order",
                          get_uuid() AS "id",
                             ''18'' AS "parentId",
                            ''DCarportValue'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                  SELECT
                                           19.4 as "order",
                          get_uuid() AS "id",
                             ''18'' AS "parentId",
                            ''DTotalValue'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual '
        ;
        IF ( tabsindex = 1 OR tabsindex = 2 OR tabsindex = 3 OR tabsindex = 4 OR tabsindex = 5 ) THEN
            v_sql := v_pub_sql || v_tab1_sql;
        ELSIF ( tabsindex = 6 ) THEN
            v_sql := v_pub_sql || v_tab2_sql;
        END IF;

        v_sql_exec := 'select  level,
                              a."id",
                            a."parentId",
                            a."filed",
                            a."filedName",
                            a."filedTitleBgColor",
                            a."filedTitleColor"  from ('
                      || v_sql
                      || ') a   START WITH
                            "parentId" IS NULL
                        CONNECT BY
                            PRIOR "id" = "parentId" order by a."order" '
                      ;
        OPEN excelfileds FOR v_sql_exec;

    END IF;

END p_dwm_dt_excel;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DT_VALUE_DTL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_DT_VALUE_DTL" (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    projectid      IN             VARCHAR2, --选择公司id
    tabsindex      IN             VARCHAR2, --选择选项卡。1开始
    isoperate      IN             VARCHAR2,--是否操盘
    info           OUT            SYS_REFCURSOR
) AS
--动态货值管理-全案动态货值-详情
--作者：陈丽
--日期：2019/12/17
BEGIN
 IF tabsindex = 1 THEN
        dbms_output.put_line('所有业态!');
    ELSIF tabsindex = 2 THEN
        dbms_output.put_line('住宅及商办!');
    ELSIF tabsindex = 3 THEN
        dbms_output.put_line('住宅!');
    ELSIF tabsindex = 4 THEN
        dbms_output.put_line('商办!');
    ELSIF tabsindex = 5 THEN
        dbms_output.put_line('车位!');
    ELSIF tabsindex = 6 THEN
        dbms_output.put_line('剩余货量表!');
        OPEN info FOR SELECT
                          t.id             AS "id",--主键id（生成树的id，唯一可以是业务id）
                           level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '' || project_name
                              WHEN level = 2 THEN
                                  '        ' || project_name
                              WHEN level = 3 THEN
                                  '                ' || project_name
                              WHEN level = 4 THEN
                                  '                        ' || project_name
                              ELSE
                                  '                                ' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          t.parent_id      AS "parentId",--父级id（生成树父级id）
                          project_name   AS "orgName",--项目/分期/业态/楼栋
                          TO_CHAR(round(b.zz_value_remain/10000,2), '999,999,999,999.99') AS "projWholeDwellingValue",--项目全案剩余可售货值（S=A+B+C+D）-住宅(m2)
                          TO_CHAR(round(b.SY_value_remain/10000,2), '999,999,999,999.99') AS "projWholeBusinessValue",--项目全案剩余可售货值（S=A+B+C+D）-商业(m2)
                          TO_CHAR(round(b.CW_value_remain/10000,2), '999,999,999,999.99') AS "projWholeCarportValue",--项目全案剩余可售货值（S=A+B+C+D）-车位(个)
                          TO_CHAR(round((b.zz_value_remain+b.SY_value_remain+b.CW_value_remain)/10000,2), '999,999,999,999.99') AS "projWholeTotalValue",--项目全案剩余可售货值（S=A+B+C+D）-合计(m2)
                          
                          TO_CHAR(round(b.zz_value_not_planning_permit/10000,2), '999,999,999,999.99') AS "ADwellingValue",--A未取规证的可售货值-住宅(m2)
                          TO_CHAR(round(b.SY_value_not_planning_permit/10000,2), '999,999,999,999.99') AS "ABusinessValue",--A未取规证的可售货值-商业(m2)
                          TO_CHAR(round(b.CW_value_not_planning_permit/10000,2), '999,999,999,999.99') AS "ACarportValue",--A未取规证的可售货值-车位(个)
                          TO_CHAR(round((b.ZZ_value_not_planning_permit+b.SY_value_not_planning_permit+b.CW_value_not_planning_permit)/10000,2), '999,999,999,999.99') AS "ATotalValue",--A未取规证的可售货值-合计(m2)
                          
                          TO_CHAR(round(b.zz_value_not_construction_per/10000,2), '999,999,999,999.99') AS "BDwellingValue",--B已取规证未取施工证的可售货值-住宅(m2)
                          TO_CHAR(round(b.SY_value_not_construction_per/10000,2), '999,999,999,999.99') AS "BBusinessValue",--B已取规证未取施工证的可售货值-商业(m2)
                          TO_CHAR(round(b.CW_value_not_construction_per/10000,2), '999,999,999,999.99') AS "BCarportValue",--B已取规证未取施工证的可售货值-车位(个)
                          TO_CHAR(round((b.zz_value_not_construction_per+b.SY_value_not_construction_per+b.CW_value_not_construction_per)/10000,2), '999,999,999,999.99') AS "BTotalValue",--B已取规证未取施工证的可售货值-合计(m2)
                          
                          TO_CHAR(round(b.zz_value_not_sale_permit/10000,2), '999,999,999,999.99') AS "CDwellingValue",--C已取施工证未取预售证的可售货值-住宅(m2)
                          TO_CHAR(round(b.sy_value_not_sale_permit/10000,2), '999,999,999,999.99') AS "CBusinessValue",--C已取施工证未取预售证的可售货值-商业(m2)
                          TO_CHAR(round(b.cw_value_not_sale_permit/10000,2), '999,999,999,999.99') AS "CCarportValue",--C已取施工证未取预售证的可售货值-车位(个)
                         TO_CHAR( round((b.zz_value_not_sale_permit+b.sy_value_not_sale_permit+b.Cw_value_not_sale_permit)/10000,2), '999,999,999,999.99') AS "CTotalValue",--C已取施工证未取预售证的可售货值-合计(m2)
                          
                          TO_CHAR(round(b.zz_value_stock/10000,2), '999,999,999,999.99') AS "DDwellingValue",--D已取预售证未售的可售货值-住宅(m2)
                        TO_CHAR(round(b.sy_value_stock/10000,2), '999,999,999,999.99') AS "DBusinessValue",--D已取预售证未售的可售货值-商业(m2)
                         TO_CHAR(round(b.cw_value_stock/10000,2), '999,999,999,999.99') AS "DCarportValue",--D已取预售证未售的可售货值-车位(个)
                          TO_CHAR(round((b.zz_value_stock+b.sy_value_stock+b.cw_value_stock)/10000,2), '999,999,999,999.99') AS "DTotalValue"--D已取预售证未售的可售货值-合计(m2)
                       FROM
                          (
                              SELECT
                                  id,
                                  project_name,
                                  '' AS parent_id,
                                  sn AS order_code
                              FROM
                                  sys_project
                              WHERE
                                  id = ''
                                       || projectid
                                       || ''
                              UNION ALL
--分期
                              SELECT
                                  id,
                                  stage_name,
                                  project_id AS parent_id,
                                  lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  sys_project_stage
                              WHERE
                                  project_id = ''
                                               || projectid
                                               || ''  AND stage_name<>'无分期'
                              UNION ALL
--楼栋
                              SELECT
                                  mdm_build.id,
                                  mdm_build.build_name||'（'||v_MDM_BUILDING.Permit_Status||'）' AS BuildName,
                              (CASE WHEN mdm_period.period_name<>'无分期' THEN  period_id ELSE mdm_build.proj_id END)  AS parent_id,
                                  lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  mdm_build LEFT JOIN mdm_period ON mdm_build.period_id=mdm_period.id
                                  LEFT JOIN v_MDM_BUILDING ON mdm_build.id=v_MDM_BUILDING.BUILDINGID
                              WHERE
                                  mdm_build.proj_id = ''
                                            || projectid
                                            || ''
                                  AND build_state = 10--10已发布楼栋
                          ) t LEFT JOIN dwm_dt_value   b ON t.id = b.obj_id
                       START WITH
                          t.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR t.id = t.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(t.order_code, ','), 2);

    END IF;

    IF tabsindex = 1 THEN
    OPEN info FOR SELECT
                      t.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                       level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '' || project_name
                              WHEN level = 2 THEN
                                  '        ' || project_name
                              WHEN level = 3 THEN
                                  '                ' || project_name
                              WHEN level = 4 THEN
                                  '                        ' || project_name
                              ELSE
                                  '                                ' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                      t.parent_id   AS "parentId",--父级id（生成树父级id）
                      project_name    AS "orgName",--公司/项目
                        TO_CHAR(b.area_dt_all, '999,999,999,999,999.99') AS "newestBuildArea",--最新建筑面积
                        TO_CHAR(nvl(b.area_dt_all, 0), '999,999,999,999,999.99') AS "targetSalesArea",--最新可售面积（不含车位）
                        (CASE WHEN b.obj_type='楼栋' THEN '-' ELSE TO_CHAR(nvl(c1.target_worth, 0), '999,999,999,999,999.99') END)AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
                        (CASE WHEN b.obj_type='楼栋' THEN '-' ELSE TO_CHAR(nvl(c2.target_worth, 0), '999,999,999,999,999.99') END) AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
                        TO_CHAR((CASE WHEN t.obj_type='项目' THEN  nvl(c3.target_worth, 0) ELSE NVL(d.worth, 0)  END), '999,999,999,999,999.99') AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
                        TO_CHAR((CASE WHEN t.obj_type='项目' THEN  nvl(c4.target_worth, 0) ELSE NVL(d.worth, 0)  END), '999,999,999,999,999.99') AS "targetNewestWorth",--目标总货值（A）-最新版(A)
                        TO_CHAR(b.value_dt_all / 10000, '999,999,999,999,999.99') AS "dynamicTotalWorth",--动态总货值(B)
                       (CASE WHEN round(b.value_dt_all / 10000 - (CASE WHEN t.obj_type='项目' THEN  nvl(c4.target_worth, 0) ELSE NVL(d.worth, 0)  END),2)<0 
                         THEN  '<font color=red>'||TO_CHAR(b.value_dt_all / 10000 - (CASE WHEN t.obj_type='项目' THEN  nvl(c4.target_worth, 0) ELSE NVL(d.worth, 0)  END), '999,999,999,999,999.99')||'</font>'
                         ELSE  '<font color=green>'||TO_CHAR(b.value_dt_all / 10000 - (CASE WHEN t.obj_type='项目' THEN  nvl(c4.target_worth, 0) ELSE NVL(d.worth, 0)  END), '999,999,999,999,999.99')||'</font>'
                         END  ) AS "dynamicTotalWorthDifference"
                        ,--总货值差额(B-A)
                        TO_CHAR(b.value_reserve / 10000, '999,999,999,999,999.99') AS "reserveTotalWorth",--动态总货值构成（B=B1+B2+B3+B4）---动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1) 
                        TO_CHAR(b.value_in_process / 10000, '999,999,999,999,999.99') AS "inProcessTotalWorth",--动态总货值构成（B=B1+B2+B3+B4）-在途货值(B2)
                        TO_CHAR(b.value_stock/10000 , '999,999,999,999,999.99') AS "stockWorth",--动态总货值构成（B=B1+B2+B3+B4）-库存货值(B3)
                        TO_CHAR(b.value_haved_sale / 10000, '999,999,999,999,999.99') AS "alreadySalesWorth",--动态总货值构成（B=B1+B2+B3+B4）-已售货值(B4)
                        TO_CHAR((b.value_remain) / 10000, '999,999,999,999,999.99') AS "residueWorth",---剩余货值(C=B1+B2+B3)
                        TO_CHAR((b.value_stock + b.value_haved_sale) / 10000, '999,999,999,999,999.99') AS "getWorth",--已领证货值(D=B3+B4)
                        (
                            CASE
                                WHEN ( b.value_stock + b.value_haved_sale ) = 0 THEN
                                    '-'
                                ELSE
                                    TO_CHAR(b.value_haved_sale /(b.value_stock + b.value_haved_sale) * 100, '999,999,999,999,999.99'
                                    )
                                    || '%'
                            END
                        ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(b.value_not_planning_permit / 10000, '999,999,999,999,999.99') AS "noPlanningPermitObtainedPhase",--F、动态货值的各阶段分布-F0未取规证
                          TO_CHAR(b.value_not_construction_permit / 10000, '999,999,999,999,999.99') AS "planningPermitObtainedOhase",--F、动态货值的各阶段分布-F1规划许可证阶段
                          TO_CHAR(b.value_not_sale_permit / 10000, '999,999,999,999,999.99') AS "constructionPermitOhase",--F、动态货值的各阶段分布-F2施工许可证阶段
                          TO_CHAR(b.value_not_completion / 10000, '999,999,999,999,999.99') AS "PreSalePermitPhase",--F、动态货值的各阶段分布-F3预售许可证阶段
                          --TO_CHAR(b.value_yes_completion / 10000, '999,999,999,999,999.99') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          TO_CHAR(b.value_yes_completion / 10000, '999,999,999,999,999.99') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          '-' AS "carryDownPhase",--F、动态货值的各阶段分布-F5结转阶段
                          
                          TO_CHAR(b.value_reserve / 10000, '999,999,999,999,999.99') AS "reserveWorth",--G1、储备货值的量价情况-货值（G1=a1*b1）
                          TO_CHAR(b.zz_area_reserve+b.SY_area_reserve, '999,999,999,999,999.99') AS "reserveCargo",--G1、储备货值的量价情况-货量(a1)
                          '-' AS "reservePrice",--G1、储备货值的量价情况-单价(b1)
                          TO_CHAR(b.value_in_process / 10000, '999,999,999,999,999.99') AS "inTransitWorth",--G2、在途货值的量价情况-货值（G2=a2*b2）
                          TO_CHAR(b.zz_area_in_process+b.SY_area_in_process, '999,999,999,999,999.99') AS "inTransitCargo",--G2、在途货值的量价情况-货量(a2)
                          '-' AS "inTransitPrice",--G2、在途货值的量价情况-单价(b2)
                          TO_CHAR(b.value_stock / 10000, '999,999,999,999,999.99') AS "stockWorth",--G3、库存货值的量价情况-货值（G3=a3*b3）
                          TO_CHAR(b.zz_area_stock+b.sy_area_stock, '999,999,999,999,999.99') AS "stockCargo",--G3、库存货值的量价情况-货量(a3)
                          '-' AS "stockPrice",--G3、库存货值的量价情况-单价(b3)
                          TO_CHAR(b.value_haved_sale / 10000, '999,999,999,999,999.99') AS "soldWorth",--G4、已售货值的量价情况-货值（G4=a4*b4）
                          TO_CHAR(b.zz_area_haved_sale+b.sy_area_haved_sale, '999,999,999,999,999.99') AS "soldCargo",--G4、已售货值的量价情况-货量(a4)
                          '-' AS "soldPrice"--G4、已售货值的量价情况-单价(b4)
                  FROM
                      (
                          SELECT
                              id,
                              project_name,
                              '' AS parent_id,
                              sn AS order_code,
                              '项目' AS Obj_Type
                          FROM
                              sys_project
                          WHERE
                              id = ''
                                   || projectid
                                   || ''
                          UNION ALL
--分期
                          SELECT
                              id,
                              stage_name,
                              project_id AS parent_id,
                              lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code,
                              '分期' AS Obj_Type
                          FROM
                              sys_project_stage
                          WHERE
                              project_id = ''|| projectid|| '' AND stage_name<>'无分期'
                                      
                          UNION ALL
--楼栋
                          SELECT
                              mdm_build.id,
                               mdm_build.build_name||'（'||v_MDM_BUILDING.Permit_Status||'）' AS BuildName,
                              (CASE WHEN mdm_period.period_name<>'无分期' THEN  period_id ELSE mdm_build.proj_id END)  AS parent_id,
                              lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code,
                              '楼栋' AS Obj_Type
                          FROM
                              mdm_build LEFT JOIN mdm_period ON mdm_build.period_id=mdm_period.id
                              LEFT JOIN v_MDM_BUILDING ON mdm_build.id=v_MDM_BUILDING.BUILDINGID
                          WHERE
                              mdm_build.proj_id = ''
                                        || projectid
                                        || ''
                              AND build_state = 10--10已发布楼栋
                      ) t LEFT JOIN dwm_dt_value  b ON t.id= b.obj_id
                          LEFT JOIN dwm_target_worth c1 ON b.obj_id = c1.proj_id  AND c1.target_worth_phase = 0 
                               AND c1.approval_status IN ('已审核','审核中')
                          LEFT JOIN dwm_target_worth c2 ON b.obj_id = c2.proj_id AND c2.target_worth_phase = 10
                                AND c2.approval_status IN ('已审核','审核中')
                          LEFT JOIN dwm_target_worth c3 ON b.obj_id = c3.proj_id AND c3.target_worth_phase = 20
                               AND c3.approval_status IN ('已审核','审核中') AND c3.id IN (SELECT id FROM V_DWM_TARGET_WORTH_NOW)
                          LEFT JOIN v_dwm_target_worth_now c4 ON b.obj_id= c4.proj_id
                               AND c4.approval_status IN ('已审核','审核中')
                          LEFT JOIN v_dwm_target_worth_dtl_now d ON b.obj_id=d.obj_id AND d.obj_type=30
                   START WITH
                          t.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR t.id = t.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(t.order_code, ','), 2);
    END IF;
    
    IF tabsindex = 2 THEN--OR tabsindex = 3 OR tabsindex = 4 OR tabsindex = 5 
    OPEN info FOR SELECT
                      t.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                       level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '' || project_name
                              WHEN level = 2 THEN
                                  '        ' || project_name
                              WHEN level = 3 THEN
                                  '                ' || project_name
                              WHEN level = 4 THEN
                                  '                        ' || project_name
                              ELSE
                                  '                                ' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                      t.parent_id   AS "parentId",--父级id（生成树父级id）
                      project_name    AS "orgName",--公司/项目
                        TO_CHAR(b.area_dt_all, '999,999,999,999,999.99') AS "newestBuildArea",--最新建筑面积
                        TO_CHAR(nvl(b.area_dt_all, 0), '999,999,999,999,999.99') AS "targetSalesArea",--最新可售面积（不含车位）
                        (CASE WHEN b.obj_type='楼栋' THEN '-' ELSE TO_CHAR(nvl(c1.target_worth, 0), '999,999,999,999,999.99') END)AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
                        (CASE WHEN b.obj_type='楼栋' THEN '-' ELSE TO_CHAR(nvl(c2.target_worth, 0), '999,999,999,999,999.99') END) AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
                        TO_CHAR(nvl(c3.target_worth, 0), '999,999,999,999,999.99') AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
                        TO_CHAR(nvl(c4.target_worth, 0), '999,999,999,999,999.99') AS "targetNewestWorth",--目标总货值（A）-最新版(A)
                        TO_CHAR(b.value_dt_all / 10000, '999,999,999,999,999.99') AS "dynamicTotalWorth",--动态总货值(B)
                       (CASE WHEN b.value_dt_all / 10000 - nvl(c4.target_worth, 0)<0 
                         THEN  '<font color=red>'||TO_CHAR(b.value_dt_all / 10000 - nvl(c4.target_worth, 0), '999,999,999,999,999.99')||'</font>'
                         ELSE  '<font color=green>'||TO_CHAR(b.value_dt_all / 10000 - nvl(c4.target_worth, 0), '999,999,999,999,999.99')||'</font>'
                         END  ) AS "dynamicTotalWorthDifference"
                        ,--总货值差额(B-A)
                          TO_CHAR((b.ZZ_value_reserve+b.SY_value_reserve) / 10000, '999,999,999,999,999.99') AS "reserveTotalWorth",----动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1) 20200101 修正字段reserveWorth=》reserveTotalWorth
                          TO_CHAR((b.ZZ_value_in_process+b.SY_value_in_process) / 10000, '999,999,999,999,999.99') AS "inProcessTotalWorth",--在途货值(B2)
                          TO_CHAR((b.ZZ_value_stock+b.SY_value_stock)/10000 , '999,999,999,999,999.99') AS "stockWorth",--库存货值(B3)
                          TO_CHAR((b.ZZ_value_haved_sale+b.SY_value_haved_sale) / 10000, '999,999,999,999,999.99') AS "alreadySalesWorth",--已售货值(B4)
                          TO_CHAR((b.ZZ_value_remain+b.SY_value_remain) / 10000, '999,999,999,999,999.99') AS "residueWorth",--剩余货值(C=B1+B2+B3)
                          TO_CHAR((b.ZZ_value_stock + b.ZZ_value_haved_sale+b.SY_value_stock + b.SY_value_haved_sale) / 10000, '999,999,999,999,999.99') AS "getWorth",--已领证货值(D=B3+B4)
                          (
                              CASE
                                  WHEN (b.ZZ_value_stock + b.ZZ_value_haved_sale+b.SY_value_stock + b.SY_value_haved_sale ) = 0 THEN
                                      '-'
                                  ELSE
                                      TO_CHAR((b.ZZ_value_haved_sale+b.SY_value_haved_sale) /(b.ZZ_value_stock + b.ZZ_value_haved_sale+b.SY_value_stock + b.SY_value_haved_sale) * 100, '999,999,999,999,999.99'
                                      )
                                      || '%'
                              END
                          ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR((b.ZZ_value_not_planning_permit+b.SY_value_not_planning_permit) / 10000, '999,999,999,999,999.99') AS "noPlanningPermitObtainedPhase",--F、动态货值的各阶段分布-F0未取规证
                          TO_CHAR((b.ZZ_value_not_construction_per+b.SY_value_not_construction_per) / 10000, '999,999,999,999,999.99') AS "planningPermitObtainedOhase",--F、动态货值的各阶段分布-F1规划许可证阶段
                          TO_CHAR((b.ZZ_value_not_sale_permit+b.SY_value_not_sale_permit) / 10000, '999,999,999,999,999.99') AS "constructionPermitOhase",--F、动态货值的各阶段分布-F2施工许可证阶段
                          TO_CHAR((b.ZZ_value_not_completion+b.SY_value_not_completion) / 10000, '999,999,999,999,999.99') AS "PreSalePermitPhase",--F、动态货值的各阶段分布-F3预售许可证阶段
                          --TO_CHAR(b.value_yes_completion / 10000, '999,999,999,999,999.99') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          TO_CHAR((b.ZZ_value_yes_completion+b.SY_value_yes_completion) / 10000, '999,999,999,999,999.99') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          '-' AS "carryDownPhase",--F、动态货值的各阶段分布-F5结转阶段
                          
                          TO_CHAR((b.ZZ_value_reserve +b.SY_value_reserve )/ 10000, '999,999,999,999,999.99') AS "reserveWorth",--G1、储备货值的量价情况-货值（G1=a1*b1）
                          TO_CHAR((b.zz_area_reserve+b.SY_area_reserve), '999,999,999,999,999.99') AS "reserveCargo",--G1、储备货值的量价情况-货量(a1)
                          (CASE WHEN (b.zz_area_reserve+b.SY_area_reserve)=0 THEN '-' ELSE To_CHAR((b.ZZ_value_reserve +b.SY_value_reserve )/(b.zz_area_reserve+b.SY_area_reserve),'999,999,999.99') END) AS "reservePrice",--G1、储备货值的量价情况-单价(b1)
                          TO_CHAR((b.ZZ_value_in_process+b.SY_value_in_process) / 10000, '999,999,999,999,999.99') AS "inTransitWorth",--G2、在途货值的量价情况-货值（G2=a2*b2）
                          TO_CHAR((b.zz_area_in_process+b.SY_area_in_process), '999,999,999,999,999.99') AS "inTransitCargo",--G2、在途货值的量价情况-货量(a2)
                          (CASE WHEN (b.zz_area_in_process+b.SY_area_in_process)=0 THEN '-' 
                              ELSE To_CHAR((b.ZZ_value_in_process+b.SY_value_in_process)/(b.zz_area_in_process+b.SY_area_in_process),'999,999,999.99') 
                            END) AS "inTransitPrice",--G2、在途货值的量价情况-单价(b2)
                          TO_CHAR((b.ZZ_value_stock+b.SY_value_stock) / 10000, '999,999,999,999,999.99') AS "stockWorth",--G3、库存货值的量价情况-货值（G3=a3*b3）
                          TO_CHAR(b.ZZ_area_stock+b.SY_area_stock, '999,999,999,999,999.99') AS "stockCargo",--G3、库存货值的量价情况-货量(a3)
                          (CASE WHEN (b.ZZ_area_stock+b.SY_area_stock)=0 THEN '-' 
                              ELSE To_CHAR((b.ZZ_value_stock+b.SY_value_stock)/(b.ZZ_area_stock+b.SY_area_stock),'999,999,999.99') 
                            END) AS "stockPrice",--G3、库存货值的量价情况-单价(b3)
                          TO_CHAR((b.ZZ_value_haved_sale+b.SY_value_haved_sale) / 10000, '999,999,999,999,999.99') AS "soldWorth",--G4、已售货值的量价情况-货值（G4=a4*b4）
                          TO_CHAR(b.zz_area_haved_sale+b.sy_area_haved_sale, '999,999,999,999,999.99') AS "soldCargo",--G4、已售货值的量价情况-货量(a4)
                          (CASE WHEN (b.zz_area_haved_sale+b.sy_area_haved_sale)=0 THEN '-' 
                              ELSE To_CHAR((b.ZZ_value_haved_sale+b.SY_value_haved_sale)/(b.zz_area_haved_sale+b.sy_area_haved_sale),'999,999,999.99') 
                            END) AS "soldPrice"--G4、已售货值的量价情况-单价(b4)
                  FROM
                      (
                          SELECT
                              id,
                              project_name,
                              '' AS parent_id,
                              sn AS order_code
                          FROM
                              sys_project
                          WHERE
                              id = ''
                                   || projectid
                                   || ''
                          UNION ALL
--分期
                          SELECT
                              id,
                              stage_name,
                              project_id AS parent_id,
                              lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                          FROM
                              sys_project_stage
                          WHERE
                              project_id = ''|| projectid|| '' AND stage_name<>'无分期'
                                      
                          UNION ALL
--楼栋
                          SELECT
                              mdm_build.id,
                              build_name,
                              (CASE WHEN mdm_period.period_name<>'无分期' THEN  period_id ELSE mdm_build.proj_id END)  AS parent_id,
                              lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                          FROM
                              mdm_build LEFT JOIN mdm_period ON mdm_build.period_id=mdm_period.id
                          WHERE
                              mdm_build.proj_id = ''
                                        || projectid
                                        || ''
                              AND build_state = 10--10已发布楼栋
                      ) t LEFT JOIN dwm_dt_value  b ON t.id= b.obj_id
                          LEFT JOIN dwm_target_worth c1 ON b.obj_id = c1.proj_id  AND c1.target_worth_phase = 0 
                               AND c1.approval_status IN ('已审核','审核中')
                          LEFT JOIN dwm_target_worth c2 ON b.obj_id = c2.proj_id AND c2.target_worth_phase = 10
                                AND c2.approval_status IN ('已审核','审核中')
                          LEFT JOIN dwm_target_worth c3 ON b.obj_id = c3.proj_id AND c3.target_worth_phase = 20
                               AND c3.approval_status IN ('已审核','审核中') AND c3.id IN (SELECT id FROM V_DWM_TARGET_WORTH_NOW)
                          LEFT JOIN v_dwm_target_worth_now c4 ON b.obj_id= c4.proj_id
                               AND c4.approval_status IN ('已审核','审核中')
                    START WITH
                          t.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR t.id = t.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(t.order_code, ','), 2);
    END IF;
    
    IF tabsindex = 3 THEN  
    OPEN info FOR SELECT
                      t.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                       level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '' || project_name
                              WHEN level = 2 THEN
                                  '        ' || project_name
                              WHEN level = 3 THEN
                                  '                ' || project_name
                              WHEN level = 4 THEN
                                  '                        ' || project_name
                              ELSE
                                  '                                ' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                      t.parent_id   AS "parentId",--父级id（生成树父级id）
                      project_name    AS "orgName",--公司/项目
                        TO_CHAR(b.area_dt_all, '999,999,999,999,999.99') AS "newestBuildArea",--最新建筑面积
                        TO_CHAR(nvl(b.area_dt_all, 0), '999,999,999,999,999.99') AS "targetSalesArea",--最新可售面积（不含车位）
                        (CASE WHEN b.obj_type='楼栋' THEN '-' ELSE TO_CHAR(nvl(c1.target_worth, 0), '999,999,999,999,999.99') END)AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
                        (CASE WHEN b.obj_type='楼栋' THEN '-' ELSE TO_CHAR(nvl(c2.target_worth, 0), '999,999,999,999,999.99') END) AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
                        TO_CHAR(nvl(c3.target_worth, 0), '999,999,999,999,999.99') AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
                        TO_CHAR(nvl(c4.target_worth, 0), '999,999,999,999,999.99') AS "targetNewestWorth",--目标总货值（A）-最新版(A)
                        TO_CHAR(b.value_dt_all / 10000, '999,999,999,999,999.99') AS "dynamicTotalWorth",--动态总货值(B)
                       (CASE WHEN b.value_dt_all / 10000 - nvl(c4.target_worth, 0)<0 
                         THEN  '<font color=red>'||TO_CHAR(b.value_dt_all / 10000 - nvl(c4.target_worth, 0), '999,999,999,999,999.99')||'</font>'
                         ELSE  '<font color=green>'||TO_CHAR(b.value_dt_all / 10000 - nvl(c4.target_worth, 0), '999,999,999,999,999.99')||'</font>'
                         END  ) AS "dynamicTotalWorthDifference"
                        ,--总货值差额(B-A)
                          TO_CHAR((b.ZZ_value_reserve) / 10000, '999,999,999,999,999.99') AS "reserveTotalWorth",----动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
                          TO_CHAR((b.ZZ_value_in_process) / 10000, '999,999,999,999,999.99') AS "inProcessTotalWorth",--在途货值(B2)
                          TO_CHAR((b.ZZ_value_stock)/10000 , '999,999,999,999,999.99') AS "stockWorth",--库存货值(B3)
                          TO_CHAR((b.ZZ_value_haved_sale) / 10000, '999,999,999,999,999.99') AS "alreadySalesWorth",--已售货值(B4)
                          TO_CHAR((b.ZZ_value_remain) / 10000, '999,999,999,999,999.99') AS "residueWorth",--剩余货值(C=B1+B2+B3)
                          TO_CHAR((b.ZZ_value_stock + b.ZZ_value_haved_sale) / 10000, '999,999,999,999,999.99') AS "getWorth",--已领证货值(D=B3+B4)
                          (
                              CASE
                                  WHEN (b.ZZ_value_stock + b.ZZ_value_haved_sale) = 0 THEN
                                      '-'
                                  ELSE
                                      TO_CHAR((b.ZZ_value_haved_sale) /(b.ZZ_value_stock + b.ZZ_value_haved_sale) * 100, '999,999,999,999,999.99'
                                      )
                                      || '%'
                              END
                          ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR((b.ZZ_value_not_planning_permit) / 10000, '999,999,999,999,999.99') AS "noPlanningPermitObtainedPhase",--F、动态货值的各阶段分布-F0未取规证
                          TO_CHAR((b.ZZ_value_not_construction_per) / 10000, '999,999,999,999,999.99') AS "planningPermitObtainedOhase",--F、动态货值的各阶段分布-F1规划许可证阶段
                          TO_CHAR((b.ZZ_value_not_sale_permit) / 10000, '999,999,999,999,999.99') AS "constructionPermitOhase",--F、动态货值的各阶段分布-F2施工许可证阶段
                          TO_CHAR((b.ZZ_value_not_completion) / 10000, '999,999,999,999,999.99') AS "PreSalePermitPhase",--F、动态货值的各阶段分布-F3预售许可证阶段
                          --TO_CHAR(b.value_yes_completion / 10000, '999,999,999,999,999.99') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          TO_CHAR((b.ZZ_value_yes_completion) / 10000, '999,999,999,999,999.99') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          '-' AS "carryDownPhase",--F、动态货值的各阶段分布-F5结转阶段
                          
                          TO_CHAR((b.ZZ_value_reserve)/ 10000, '999,999,999,999,999.99') AS "reserveWorth",--G1、储备货值的量价情况-货值（G1=a1*b1）
                          TO_CHAR((b.zz_area_reserve), '999,999,999,999,999.99') AS "reserveCargo",--G1、储备货值的量价情况-货量(a1)
                          (CASE WHEN (b.zz_area_reserve)=0 THEN '-' ELSE To_CHAR((b.ZZ_value_reserve)/(b.zz_area_reserve),'999,999,999.99') END) AS "reservePrice",--G1、储备货值的量价情况-单价(b1)
                          TO_CHAR((b.ZZ_value_in_process) / 10000, '999,999,999,999,999.99') AS "inTransitWorth",--G2、在途货值的量价情况-货值（G2=a2*b2）
                          TO_CHAR((b.zz_area_in_process), '999,999,999,999,999.99') AS "inTransitCargo",--G2、在途货值的量价情况-货量(a2)
                          (CASE WHEN (b.zz_area_in_process)=0 THEN '-' 
                              ELSE To_CHAR((b.ZZ_value_in_process)/(b.zz_area_in_process),'999,999,999.99') 
                            END) AS "inTransitPrice",--G2、在途货值的量价情况-单价(b2)
                          TO_CHAR((b.ZZ_value_stock) / 10000, '999,999,999,999,999.99') AS "stockWorth",--G3、库存货值的量价情况-货值（G3=a3*b3）
                          TO_CHAR(b.ZZ_area_stock, '999,999,999,999,999.99') AS "stockCargo",--G3、库存货值的量价情况-货量(a3)
                          (CASE WHEN (b.ZZ_area_stock)=0 THEN '-' 
                              ELSE To_CHAR((b.ZZ_value_stock)/(b.ZZ_area_stock),'999,999,999.99') 
                            END) AS "stockPrice",--G3、库存货值的量价情况-单价(b3)
                          TO_CHAR((b.ZZ_value_haved_sale) / 10000, '999,999,999,999,999.99') AS "soldWorth",--G4、已售货值的量价情况-货值（G4=a4*b4）
                          TO_CHAR(b.zz_area_haved_sale, '999,999,999,999,999.99') AS "soldCargo",--G4、已售货值的量价情况-货量(a4)
                          (CASE WHEN (b.zz_area_haved_sale)=0 THEN '-' 
                              ELSE To_CHAR((b.ZZ_value_haved_sale)/(b.zz_area_haved_sale),'999,999,999.99') 
                            END) AS "soldPrice"--G4、已售货值的量价情况-单价(b4)
                  FROM
                      (
                          SELECT
                              id,
                              project_name,
                              '' AS parent_id,
                              sn AS order_code
                          FROM
                              sys_project
                          WHERE
                              id = ''
                                   || projectid
                                   || ''
                          UNION ALL
--分期
                          SELECT
                              id,
                              stage_name,
                              project_id AS parent_id,
                              lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                          FROM
                              sys_project_stage
                          WHERE
                              project_id = ''|| projectid|| '' AND stage_name<>'无分期'
                                      
                          UNION ALL
--楼栋
                          SELECT
                              mdm_build.id,
                              build_name,
                              (CASE WHEN mdm_period.period_name<>'无分期' THEN  period_id ELSE mdm_build.proj_id END)  AS parent_id,
                              lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                          FROM
                              mdm_build LEFT JOIN mdm_period ON mdm_build.period_id=mdm_period.id
                          WHERE
                              mdm_build.proj_id = ''
                                        || projectid
                                        || ''
                              AND build_state = 10--10已发布楼栋
                      ) t LEFT JOIN dwm_dt_value  b ON t.id= b.obj_id
                          LEFT JOIN dwm_target_worth c1 ON b.obj_id = c1.proj_id  AND c1.target_worth_phase = 0 
                               AND c1.approval_status IN ('已审核','审核中')
                          LEFT JOIN dwm_target_worth c2 ON b.obj_id = c2.proj_id AND c2.target_worth_phase = 10
                                AND c2.approval_status IN ('已审核','审核中')
                          LEFT JOIN dwm_target_worth c3 ON b.obj_id = c3.proj_id AND c3.target_worth_phase = 20
                               AND c3.approval_status IN ('已审核','审核中') AND c3.id IN (SELECT id FROM V_DWM_TARGET_WORTH_NOW)
                          LEFT JOIN v_dwm_target_worth_now c4 ON b.obj_id= c4.proj_id
                               AND c4.approval_status IN ('已审核','审核中')
                    START WITH
                          t.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR t.id = t.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(t.order_code, ','), 2);
    END IF;
    
    IF tabsindex = 4 THEN  
    OPEN info FOR SELECT
                      t.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                       level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '' || project_name
                              WHEN level = 2 THEN
                                  '        ' || project_name
                              WHEN level = 3 THEN
                                  '                ' || project_name
                              WHEN level = 4 THEN
                                  '                        ' || project_name
                              ELSE
                                  '                                ' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                      t.parent_id   AS "parentId",--父级id（生成树父级id）
                      project_name    AS "orgName",--公司/项目
                        TO_CHAR(b.area_dt_all, '999,999,999,999,999.99') AS "newestBuildArea",--最新建筑面积
                        TO_CHAR(nvl(b.area_dt_all, 0), '999,999,999,999,999.99') AS "targetSalesArea",--最新可售面积（不含车位）
                        (CASE WHEN b.obj_type='楼栋' THEN '-' ELSE TO_CHAR(nvl(c1.target_worth, 0), '999,999,999,999,999.99') END)AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
                        (CASE WHEN b.obj_type='楼栋' THEN '-' ELSE TO_CHAR(nvl(c2.target_worth, 0), '999,999,999,999,999.99') END) AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
                        TO_CHAR(nvl(c3.target_worth, 0), '999,999,999,999,999.99') AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
                        TO_CHAR(nvl(c4.target_worth, 0), '999,999,999,999,999.99') AS "targetNewestWorth",--目标总货值（A）-最新版(A)
                        TO_CHAR(b.value_dt_all / 10000, '999,999,999,999,999.99') AS "dynamicTotalWorth",--动态总货值(B)
                       (CASE WHEN b.value_dt_all / 10000 - nvl(c4.target_worth, 0)<0 
                         THEN  '<font color=red>'||TO_CHAR(b.value_dt_all / 10000 - nvl(c4.target_worth, 0), '999,999,999,999,999.99')||'</font>'
                         ELSE  '<font color=green>'||TO_CHAR(b.value_dt_all / 10000 - nvl(c4.target_worth, 0), '999,999,999,999,999.99')||'</font>'
                         END  ) AS "dynamicTotalWorthDifference"
                        ,--总货值差额(B-A)
                          TO_CHAR((b.SY_value_reserve) / 10000, '999,999,999,999,999.99') AS "reserveTotalWorth",----动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
                          TO_CHAR((b.SY_value_in_process) / 10000, '999,999,999,999,999.99') AS "inProcessTotalWorth",--在途货值(B2)
                          TO_CHAR((b.SY_value_stock)/10000 , '999,999,999,999,999.99') AS "stockWorth",--库存货值(B3)
                          TO_CHAR((b.SY_value_haved_sale) / 10000, '999,999,999,999,999.99') AS "alreadySalesWorth",--已售货值(B4)
                          TO_CHAR((b.SY_value_remain) / 10000, '999,999,999,999,999.99') AS "residueWorth",--剩余货值(C=B1+B2+B3)
                          TO_CHAR((b.SY_value_stock + b.SY_value_haved_sale) / 10000, '999,999,999,999,999.99') AS "getWorth",--已领证货值(D=B3+B4)
                          (
                              CASE
                                  WHEN (b.SY_value_stock + b.SY_value_haved_sale ) = 0 THEN
                                      '-'
                                  ELSE
                                      TO_CHAR((b.SY_value_haved_sale) /(b.SY_value_stock + b.SY_value_haved_sale) * 100, '999,999,999,999,999.99'
                                      )
                                      || '%'
                              END
                          ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR((b.SY_value_not_planning_permit) / 10000, '999,999,999,999,999.99') AS "noPlanningPermitObtainedPhase",--F、动态货值的各阶段分布-F0未取规证
                          TO_CHAR((b.SY_value_not_construction_per) / 10000, '999,999,999,999,999.99') AS "planningPermitObtainedOhase",--F、动态货值的各阶段分布-F1规划许可证阶段
                          TO_CHAR((b.SY_value_not_sale_permit) / 10000, '999,999,999,999,999.99') AS "constructionPermitOhase",--F、动态货值的各阶段分布-F2施工许可证阶段
                          TO_CHAR((b.SY_value_not_completion) / 10000, '999,999,999,999,999.99') AS "PreSalePermitPhase",--F、动态货值的各阶段分布-F3预售许可证阶段
                          --TO_CHAR(b.value_yes_completion / 10000, '999,999,999,999,999.99') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          TO_CHAR((b.SY_value_yes_completion) / 10000, '999,999,999,999,999.99') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          '-' AS "carryDownPhase",--F、动态货值的各阶段分布-F5结转阶段
                          
                          TO_CHAR((b.SY_value_reserve )/ 10000, '999,999,999,999,999.99') AS "reserveWorth",--G1、储备货值的量价情况-货值（G1=a1*b1）
                          TO_CHAR((b.SY_area_reserve), '999,999,999,999,999.99') AS "reserveCargo",--G1、储备货值的量价情况-货量(a1)
                          (CASE WHEN (b.SY_area_reserve)=0 THEN '-' ELSE To_CHAR((b.SY_value_reserve )/(b.SY_area_reserve),'999,999,999.99') END) AS "reservePrice",--G1、储备货值的量价情况-单价(b1)
                          TO_CHAR((b.SY_value_in_process) / 10000, '999,999,999,999,999.99') AS "inTransitWorth",--G2、在途货值的量价情况-货值（G2=a2*b2）
                          TO_CHAR((b.SY_area_in_process), '999,999,999,999,999.99') AS "inTransitCargo",--G2、在途货值的量价情况-货量(a2)
                          (CASE WHEN (b.SY_area_in_process)=0 THEN '-' 
                              ELSE To_CHAR((b.SY_value_in_process)/(b.SY_area_in_process),'999,999,999.99') 
                            END) AS "inTransitPrice",--G2、在途货值的量价情况-单价(b2)
                          TO_CHAR((b.SY_value_stock) / 10000, '999,999,999,999,999.99') AS "stockWorth",--G3、库存货值的量价情况-货值（G3=a3*b3）
                          TO_CHAR(b.SY_area_stock, '999,999,999,999,999.99') AS "stockCargo",--G3、库存货值的量价情况-货量(a3)
                          (CASE WHEN (b.SY_area_stock)=0 THEN '-' 
                              ELSE To_CHAR((b.SY_value_stock)/(b.SY_area_stock),'999,999,999.99') 
                            END) AS "stockPrice",--G3、库存货值的量价情况-单价(b3)
                          TO_CHAR((b.SY_value_haved_sale) / 10000, '999,999,999,999,999.99') AS "soldWorth",--G4、已售货值的量价情况-货值（G4=a4*b4）
                          TO_CHAR(b.sy_area_haved_sale, '999,999,999,999,999.99') AS "soldCargo",--G4、已售货值的量价情况-货量(a4)
                          (CASE WHEN (b.sy_area_haved_sale)=0 THEN '-' 
                              ELSE To_CHAR((b.SY_value_haved_sale)/(b.sy_area_haved_sale),'999,999,999.99') 
                            END) AS "soldPrice"--G4、已售货值的量价情况-单价(b4)
                  FROM
                      (
                          SELECT
                              id,
                              project_name,
                              '' AS parent_id,
                              sn AS order_code
                          FROM
                              sys_project
                          WHERE
                              id = ''
                                   || projectid
                                   || ''
                          UNION ALL
--分期
                          SELECT
                              id,
                              stage_name,
                              project_id AS parent_id,
                              lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                          FROM
                              sys_project_stage
                          WHERE
                              project_id = ''|| projectid|| '' AND stage_name<>'无分期'
                                      
                          UNION ALL
--楼栋
                          SELECT
                              mdm_build.id,
                              build_name,
                              (CASE WHEN mdm_period.period_name<>'无分期' THEN  period_id ELSE mdm_build.proj_id END)  AS parent_id,
                              lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                          FROM
                              mdm_build LEFT JOIN mdm_period ON mdm_build.period_id=mdm_period.id
                          WHERE
                              mdm_build.proj_id = ''
                                        || projectid
                                        || ''
                              AND build_state = 10--10已发布楼栋
                      ) t LEFT JOIN dwm_dt_value  b ON t.id= b.obj_id
                          LEFT JOIN dwm_target_worth c1 ON b.obj_id = c1.proj_id  AND c1.target_worth_phase = 0 
                               AND c1.approval_status IN ('已审核','审核中')
                          LEFT JOIN dwm_target_worth c2 ON b.obj_id = c2.proj_id AND c2.target_worth_phase = 10
                                AND c2.approval_status IN ('已审核','审核中')
                          LEFT JOIN dwm_target_worth c3 ON b.obj_id = c3.proj_id AND c3.target_worth_phase = 20
                               AND c3.approval_status IN ('已审核','审核中') AND c3.id IN (SELECT id FROM V_DWM_TARGET_WORTH_NOW)
                          LEFT JOIN v_dwm_target_worth_now c4 ON b.obj_id= c4.proj_id
                               AND c4.approval_status IN ('已审核','审核中')
                    START WITH
                          t.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR t.id = t.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(t.order_code, ','), 2);
    END IF;
    
    IF tabsindex = 5 THEN  
    OPEN info FOR SELECT
                      t.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                       level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '' || project_name
                              WHEN level = 2 THEN
                                  '        ' || project_name
                              WHEN level = 3 THEN
                                  '                ' || project_name
                              WHEN level = 4 THEN
                                  '                        ' || project_name
                              ELSE
                                  '                                ' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                      t.parent_id   AS "parentId",--父级id（生成树父级id）
                      project_name    AS "orgName",--公司/项目
                        TO_CHAR(b.area_dt_all, '999,999,999,999,999.99') AS "newestBuildArea",--最新建筑面积
                        TO_CHAR(nvl(b.area_dt_all, 0), '999,999,999,999,999.99') AS "targetSalesArea",--最新可售面积（不含车位）
                        (CASE WHEN b.obj_type='楼栋' THEN '-' ELSE TO_CHAR(nvl(c1.target_worth, 0), '999,999,999,999,999.99') END)AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
                        (CASE WHEN b.obj_type='楼栋' THEN '-' ELSE TO_CHAR(nvl(c2.target_worth, 0), '999,999,999,999,999.99') END) AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
                        TO_CHAR(nvl(c3.target_worth, 0), '999,999,999,999,999.99') AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
                        TO_CHAR(nvl(c4.target_worth, 0), '999,999,999,999,999.99') AS "targetNewestWorth",--目标总货值（A）-最新版(A)
                        TO_CHAR(b.value_dt_all / 10000, '999,999,999,999,999.99') AS "dynamicTotalWorth",--动态总货值(B)
                       (CASE WHEN b.value_dt_all / 10000 - nvl(c4.target_worth, 0)<0 
                         THEN  '<font color=red>'||TO_CHAR(b.value_dt_all / 10000 - nvl(c4.target_worth, 0), '999,999,999,999,999.99')||'</font>'
                         ELSE  '<font color=green>'||TO_CHAR(b.value_dt_all / 10000 - nvl(c4.target_worth, 0), '999,999,999,999,999.99')||'</font>'
                         END  ) AS "dynamicTotalWorthDifference"
                        ,--总货值差额(B-A)
                          TO_CHAR((b.CW_value_reserve) / 10000, '999,999,999,999,999.99') AS "reserveTotalWorth",----动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
                          TO_CHAR((b.CW_value_in_process) / 10000, '999,999,999,999,999.99') AS "inProcessTotalWorth",--在途货值(B2)
                          TO_CHAR((b.CW_value_stock)/10000 , '999,999,999,999,999.99') AS "stockWorth",--库存货值(B3)
                          TO_CHAR((b.CW_value_haved_sale) / 10000, '999,999,999,999,999.99') AS "alreadySalesWorth",--已售货值(B4)
                          TO_CHAR((b.CW_value_remain) / 10000, '999,999,999,999,999.99') AS "residueWorth",--剩余货值(C=B1+B2+B3)
                          TO_CHAR((b.CW_value_stock + b.CW_value_haved_sale) / 10000, '999,999,999,999,999.99') AS "getWorth",--已领证货值(D=B3+B4)
                          (
                              CASE
                                  WHEN (b.CW_value_stock + b.CW_value_haved_sale ) = 0 THEN
                                      '-'
                                  ELSE
                                      TO_CHAR((b.CW_value_haved_sale) /(b.CW_value_stock + b.CW_value_haved_sale) * 100, '999,999,999,999,999.99'
                                      )
                                      || '%'
                              END
                          ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR((b.CW_value_not_planning_permit) / 10000, '999,999,999,999,999.99') AS "noPlanningPermitObtainedPhase",--F、动态货值的各阶段分布-F0未取规证
                          TO_CHAR((b.CW_value_not_construction_per) / 10000, '999,999,999,999,999.99') AS "planningPermitObtainedOhase",--F、动态货值的各阶段分布-F1规划许可证阶段
                          TO_CHAR((b.CW_value_not_sale_permit) / 10000, '999,999,999,999,999.99') AS "constructionPermitOhase",--F、动态货值的各阶段分布-F2施工许可证阶段
                          TO_CHAR((b.CW_value_not_completion) / 10000, '999,999,999,999,999.99') AS "PreSalePermitPhase",--F、动态货值的各阶段分布-F3预售许可证阶段
                          --TO_CHAR(b.value_yes_completion / 10000, '999,999,999,999,999.99') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          TO_CHAR((b.CW_value_yes_completion) / 10000, '999,999,999,999,999.99') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          '-' AS "carryDownPhase",--F、动态货值的各阶段分布-F5结转阶段
                          
                          TO_CHAR((b.CW_value_reserve )/ 10000, '999,999,999,999,999.99') AS "reserveWorth",--G1、储备货值的量价情况-货值（G1=a1*b1）
                          TO_CHAR((b.CW_area_reserve), '999,999,999,999,999') AS "reserveCargo",--G1、储备货值的量价情况-货量(a1)
                          (CASE WHEN (b.CW_area_reserve)=0 THEN '-' ELSE To_CHAR((b.CW_value_reserve)/(b.CW_area_reserve),'999,999,999.99') END) AS "reservePrice",--G1、储备货值的量价情况-单价(b1)
                          TO_CHAR((b.CW_value_in_process) / 10000, '999,999,999,999,999.99') AS "inTransitWorth",--G2、在途货值的量价情况-货值（G2=a2*b2）
                          TO_CHAR((b.CW_area_in_process), '999,999,999,999,999') AS "inTransitCargo",--G2、在途货值的量价情况-货量(a2)
                          (CASE WHEN (b.CW_area_in_process)=0 THEN '-' 
                              ELSE To_CHAR((b.CW_value_in_process)/(b.CW_area_in_process),'999,999,999.99') 
                            END) AS "inTransitPrice",--G2、在途货值的量价情况-单价(b2)
                          TO_CHAR((b.CW_value_stock) / 10000, '999,999,999,999,999.99') AS "stockWorth",--G3、库存货值的量价情况-货值（G3=a3*b3）
                          TO_CHAR(b.CW_area_stock, '999,999,999,999,999') AS "stockCargo",--G3、库存货值的量价情况-货量(a3)
                          (CASE WHEN (b.CW_area_stock)=0 THEN '-' 
                              ELSE To_CHAR((b.CW_value_stock)/(b.CW_area_stock),'999,999,999.99') 
                            END) AS "stockPrice",--G3、库存货值的量价情况-单价(b3)
                          TO_CHAR((b.CW_value_haved_sale) / 10000, '999,999,999,999,999.99') AS "soldWorth",--G4、已售货值的量价情况-货值（G4=a4*b4）
                          TO_CHAR(b.CW_area_haved_sale, '999,999,999,999,999') AS "soldCargo",--G4、已售货值的量价情况-货量(a4)
                          (CASE WHEN (b.CW_area_haved_sale)=0 THEN '-' 
                              ELSE To_CHAR((b.CW_value_haved_sale)/(b.CW_area_haved_sale),'999,999,999.99') 
                            END) AS "soldPrice"--G4、已售货值的量价情况-单价(b4)
                  FROM
                      (
                          SELECT
                              id,
                              project_name,
                              '' AS parent_id,
                              sn AS order_code
                          FROM
                              sys_project
                          WHERE
                              id = ''
                                   || projectid
                                   || ''
                          UNION ALL
--分期
                          SELECT
                              id,
                              stage_name,
                              project_id AS parent_id,
                              lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                          FROM
                              sys_project_stage
                          WHERE
                              project_id = ''|| projectid|| '' AND stage_name<>'无分期'
                                      
                          UNION ALL
--楼栋
                          SELECT
                              mdm_build.id,
                              build_name,
                              (CASE WHEN mdm_period.period_name<>'无分期' THEN  period_id ELSE mdm_build.proj_id END)  AS parent_id,
                              lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                          FROM
                              mdm_build LEFT JOIN mdm_period ON mdm_build.period_id=mdm_period.id
                          WHERE
                              mdm_build.proj_id = ''
                                        || projectid
                                        || ''
                              AND build_state = 10--10已发布楼栋
                      ) t LEFT JOIN dwm_dt_value  b ON t.id= b.obj_id
                          LEFT JOIN dwm_target_worth c1 ON b.obj_id = c1.proj_id  AND c1.target_worth_phase = 0 
                               AND c1.approval_status IN ('已审核','审核中')
                          LEFT JOIN dwm_target_worth c2 ON b.obj_id = c2.proj_id AND c2.target_worth_phase = 10
                                AND c2.approval_status IN ('已审核','审核中')
                          LEFT JOIN dwm_target_worth c3 ON b.obj_id = c3.proj_id AND c3.target_worth_phase = 20
                               AND c3.approval_status IN ('已审核','审核中') AND c3.id IN (SELECT id FROM V_DWM_TARGET_WORTH_NOW)
                          LEFT JOIN v_dwm_target_worth_now c4 ON b.obj_id= c4.proj_id
                               AND c4.approval_status IN ('已审核','审核中')
                  START WITH
                          t.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR t.id = t.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(t.order_code, ','), 2);
    END IF;
    
END p_dwm_dt_value_dtl;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_DT_VALUE_LIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_DT_VALUE_LIST" 
(
		USERID       IN VARCHAR2 --当前用户id
	 ,STATIONID    IN VARCHAR2 --当前用户岗位id
	 ,DEPARTMENTID IN VARCHAR2 --当前用户部门id
	 ,COMPANYID    IN VARCHAR2 --当前用户公司id
	 ,UNITID       IN VARCHAR2 --选择公司id
	 ,ISOPERATE    IN VARCHAR2 --是否操盘
	 ,TABSINDEX    IN INT --选择选项卡。1开始
	 ,INFO         OUT SYS_REFCURSOR
) AS
		--动态货值管理-全案动态货值-主列表
		--作者：陈丽
		--日期：2019/12/17
		DATA_AUTH_SPID VARCHAR2(200);
		BIZCODE        VARCHAR2(200);
BEGIN
		--权限编码
		BIZCODE := 'DWM.DTHZGL.03';
		P_SYS_GET_COMPANY_PROJ_SPID(USERID         => USERID,
																STATIONID      => STATIONID,
																DEPTID         => DEPARTMENTID,
																COMPANYID      => COMPANYID,
																BIZCODE        => BIZCODE,
																DATA_AUTH_SPID => DATA_AUTH_SPID);

		IF TABSINDEX = 1 THEN
				DBMS_OUTPUT.PUT_LINE('所有业态!');
		ELSIF TABSINDEX = 2 THEN
				DBMS_OUTPUT.PUT_LINE('住宅及商办!');
		ELSIF TABSINDEX = 3 THEN
				DBMS_OUTPUT.PUT_LINE('住宅!');
		ELSIF TABSINDEX = 4 THEN
				DBMS_OUTPUT.PUT_LINE('商办!');
		ELSIF TABSINDEX = 5 THEN
				DBMS_OUTPUT.PUT_LINE('车位!');
		ELSIF TABSINDEX = 6 THEN
				DBMS_OUTPUT.PUT_LINE('剩余货值表!');
				OPEN INFO FOR
						SELECT A.ID AS "id",
									 --主键id（生成树的id，唯一可以是业务id）
									 A.PARENT_ID AS "parentId",
									 --父级id（生成树父级id）
									 CASE
											 WHEN A.IS_COMPANY = 0 THEN
												'/dwm/value-manage/value-project/detail?code=value_dtl&isOperate=' ||
												A.PROJ_COOPERATE || '&projectId=' || A.ID ||
												'&projectName=' || A.ORG_NAME || '&projectDate=' ||
												A.TAKE_DATE || '&tabIndex=' || TABSINDEX ||
												'&pageTitle=' || A.ORG_NAME --页面标题名称
											 ELSE
												''
									 END AS "openUrl",
									 --详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
									 CASE
											 WHEN A.IS_COMPANY = 0 THEN
												'/dwm/value-manage/dynamic-volume/circular?companyId=' ||
												A.PARENT_ID || '&projectId=' || A.ID || '&type=2' --companyId加载项目的公司id，项目id：默认选中的项目id，type：货值是1，货值是2
											 ELSE
												''
									 END AS "openVisualUrl",
									 --打开可视化地址
									 LEVEL,
									 CASE
											 WHEN LEVEL = 1 THEN
												'#eaf6ff'
											 WHEN LEVEL = 2 THEN
												'#ecfbee'
											 WHEN LEVEL = 3 THEN
												'#f2eed4'
											 ELSE
												''
									 END AS "excelRowBgColor",
									 --数据行导出excel背景色
									 CASE
											 WHEN LEVEL = 1 THEN
												'' || ORG_NAME
											 WHEN LEVEL = 2 THEN
												'        ' || ORG_NAME
											 WHEN LEVEL = 3 THEN
												'                ' || ORG_NAME
											 WHEN LEVEL = 4 THEN
												'                        ' || ORG_NAME
											 ELSE
												'                                ' || ORG_NAME
									 END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
									 A.ORG_NAME AS "orgName",--公司/项目
									 TO_CHAR(ROUND((SELECT SUM(DDV.ZZ_VALUE_REMAIN)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000, 2),'999,999,999,999.99') AS "projWholeDwellingValue",--项目全案剩余可售货值（S=A+B+C+D）-住宅(m2)
									 TO_CHAR(ROUND((SELECT SUM(DDV.SY_VALUE_REMAIN)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000, 2),'999,999,999,999.99') AS "projWholeBusinessValue",--项目全案剩余可售货值（S=A+B+C+D）-商业(m2)
									 TO_CHAR(ROUND((SELECT SUM(DDV.CW_VALUE_REMAIN)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000, 2),'999,999,999,999.99') AS "projWholeCarportValue",--项目全案剩余可售货值（S=A+B+C+D）-车位(个)
									 TO_CHAR(ROUND((SELECT SUM(DDV.ZZ_VALUE_REMAIN)+SUM(DDV.CW_VALUE_REMAIN)+SUM(DDV.SY_VALUE_REMAIN)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,2),'999,999,999,999.99') AS "projWholeTotalValue",
									 --项目全案剩余可售货值（S=A+B+C+D）-合计(m2)

									 TO_CHAR(ROUND((SELECT SUM(DDV.ZZ_VALUE_NOT_PLANNING_PERMIT)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000, 2),'999,999,999,999.99') AS "ADwellingValue",--A未取规证的可售货值-住宅(m2)
									 TO_CHAR(ROUND((SELECT SUM(DDV.SY_VALUE_NOT_PLANNING_PERMIT)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000, 2),'999,999,999,999.99') AS "ABusinessValue",--A未取规证的可售货值-商业(m2)
									 TO_CHAR(ROUND((SELECT SUM(DDV.CW_VALUE_NOT_PLANNING_PERMIT)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000, 2),'999,999,999,999.99') AS "ACarportValue",--A未取规证的可售货值-车位(个)
									 TO_CHAR(ROUND((SELECT SUM(DDV.ZZ_VALUE_NOT_PLANNING_PERMIT)+SUM(DDV.CW_VALUE_NOT_PLANNING_PERMIT)+SUM(DDV.SY_VALUE_NOT_PLANNING_PERMIT)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,2),'999,999,999,999.99') AS "ATotalValue",--A未取规证的可售货值-合计(m2)
									 TO_CHAR(ROUND((SELECT SUM(DDV.ZZ_VALUE_NOT_CONSTRUCTION_PER)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000, 2),'999,999,999,999.99') AS "BDwellingValue",--B已取规证未取施工证的可售货值-住宅(m2)
									 TO_CHAR(ROUND((SELECT SUM(DDV.SY_VALUE_NOT_CONSTRUCTION_PER)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000, 2),'999,999,999,999.99') AS "BBusinessValue",--B已取规证未取施工证的可售货值-商业(m2)
									 TO_CHAR(ROUND((SELECT SUM(DDV.CW_VALUE_NOT_CONSTRUCTION_PER)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000, 2),'999,999,999,999.99') AS "BCarportValue",--B已取规证未取施工证的可售货值-车位(个)
									 TO_CHAR(ROUND((SELECT SUM(DDV.ZZ_VALUE_NOT_CONSTRUCTION_PER)+SUM(DDV.SY_VALUE_NOT_CONSTRUCTION_PER) + SUM(DDV.CW_VALUE_NOT_CONSTRUCTION_PER)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,2),'999,999,999,999.99') AS "BTotalValue",--B已取规证未取施工证的可售货值-合计(m2)

									 TO_CHAR(ROUND((SELECT SUM(DDV.ZZ_VALUE_NOT_SALE_PERMIT)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000, 2),'999,999,999,999.99') AS "CDwellingValue",--C已取施工证未取预售证的可售货值-住宅(m2)
									 TO_CHAR(ROUND((SELECT SUM(DDV.SY_VALUE_NOT_SALE_PERMIT)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000, 2),'999,999,999,999.99') AS "CBusinessValue",--C已取施工证未取预售证的可售货值-商业(m2)
									 TO_CHAR(ROUND((SELECT SUM(DDV.CW_VALUE_NOT_SALE_PERMIT)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000, 2),'999,999,999,999.99') AS "CCarportValue",--C已取施工证未取预售证的可售货值-车位(个)
									 TO_CHAR(ROUND((SELECT SUM(DDV.ZZ_VALUE_NOT_SALE_PERMIT)+SUM(DDV.SY_VALUE_NOT_SALE_PERMIT)+SUM(DDV.CW_VALUE_NOT_SALE_PERMIT)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,2),'999,999,999,999.99') AS "CTotalValue",--C已取施工证未取预售证的可售货值-合计(m2)

									 TO_CHAR(ROUND((SELECT SUM(DDV.ZZ_VALUE_STOCK)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000, 2),'999,999,999,999.99') AS "DDwellingValue",--D已取预售证未售的可售货值-住宅(m2)
									 TO_CHAR(ROUND((SELECT SUM(DDV.SY_VALUE_STOCK)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000, 2),'999,999,999,999.99') AS "DBusinessValue",--D已取预售证未售的可售货值-商业(m2)
									 TO_CHAR(ROUND((SELECT SUM(DDV.CW_VALUE_STOCK)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000, 2),'999,999,999,999.99') AS "DCarportValue",--D已取预售证未售的可售货值-车位(个)
									 TO_CHAR(ROUND((SELECT SUM(DDV.ZZ_VALUE_STOCK)+SUM(DDV.SY_VALUE_STOCK)+SUM(DDV.CW_VALUE_STOCK)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,2),'999,999,999,999.99') AS "DTotalValue" --D已取预售证未售的可售货值-合计(m2)
						FROM   (SELECT *
										 FROM   (SELECT DISTINCT ORG_ID AS ID, ORG_NAME AS ORG_NAME,
																							ORDER_CODE AS ORDER_CODE,
																							PARENT_ID AS PARENT_ID,
																							1 AS IS_COMPANY, '' AS TAKE_DATE,
																							'' AS PROJ_COOPERATE
															FROM   TMP_COMPANY_TREE
															WHERE  ID = DATA_AUTH_SPID AND
																		 ORG_ID IN
																		 (SELECT DISTINCT ID
																			FROM   SYS_BUSINESS_UNIT
																			START  WITH ID IN
																									(SELECT ID
																									 FROM   (SELECT UNIT_ID AS ID
																														FROM   SYS_PROJECT
																														UNION
																														SELECT SUBORDINATE_COMPANY_ID AS ID
																														FROM   CDB_FEASIBLE_PROJECT_CONFIG) DS)
																			CONNECT BY PRIOR PARENT_ID = ID)
															UNION ALL
															SELECT PROJECT_ORIGINAL_ID AS ID,
																		 PROJECT_NAME || (CASE WHEN PROJ_COOPERATE = '不操盘' THEN '（不操盘）' ELSE '' END) AS PROJNAME,
																		 PROJECT_CODE AS ORDERCODE,
																		 COMPANY_ID AS PARENTID, 0 AS IS_COMPANY,
																		 TO_CHAR(PROJECT_GET_TIME, 'yyyy-mm-dd') AS TAKE_DATE,
																		 MDM_PROJECT.PROJ_COOPERATE
															FROM   MDM_PROJECT
															WHERE  APPROVAL_STATUS = '已审核' AND
																		 IS_DELETE = 0 AND
																		 PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)--'操盘'
															) T
                       ) A 
            LEFT   JOIN DWM_DT_VALUE B ON  A.ID = B.OBJ_ID
						START  WITH A.ID = '' || UNITID || ''
						CONNECT BY PRIOR A.ID = A.PARENT_ID
						ORDER  BY SUBSTR(SYS_CONNECT_BY_PATH(A.ORDER_CODE, ','), 2);

		END IF;

		IF TABSINDEX = 1   THEN
				OPEN INFO FOR
						SELECT A.ID AS "id",
									 --主键id（生成树的id，唯一可以是业务id）
									 A.PARENT_ID AS "parentId",
									 --父级id（生成树父级id）
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/value-project/detail?code=value_dtl&isOperate=' ||
												 A.PROJ_COOPERATE || '&projectId=' || A.ID || '&projectName=' ||
												 A.ORG_NAME || '&projectDate=' || A.TAKE_DATE || '&tabIndex=' ||
												 TABSINDEX || '&pageTitle=' || A.ORG_NAME --页面标题名称
												ELSE
												 ''
										END) AS "openUrl",
									 --详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/dynamic-volume/circular?companyId=' || A.PARENT_ID ||
												 '&projectId=' || A.ID || '&type=2' --companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
												ELSE
												 ''
										END) AS "openVisualUrl",
									 --打开可视化地址
									 LEVEL,
									 CASE
												WHEN LEVEL = 1 THEN
												 '#eaf6ff'
												WHEN LEVEL = 2 THEN
												 '#ecfbee'
												WHEN LEVEL = 3 THEN
												 '#f2eed4'
												ELSE
												 ''
										END AS "excelRowBgColor",
									 --数据行导出excel背景色
									 CASE
												WHEN LEVEL = 1 THEN
												 '' || ORG_NAME
												WHEN LEVEL = 2 THEN
												 '        ' || ORG_NAME
												WHEN LEVEL = 3 THEN
												 '                ' || ORG_NAME
												WHEN LEVEL = 4 THEN
												 '                        ' || ORG_NAME
												ELSE
												 '                                ' || ORG_NAME
										END AS "excelRowTextTreeOrgName",
									 --文本前面加空格模仿树
									 A.ORG_NAME AS "orgName",--公司/项目
									 --TO_CHAR(b.area_dt_all, '999,999,999,999,999.99') AS "newestBuildArea",--最新建筑面积
									 TO_CHAR((SELECT SUM(DDV.AREA_DT_ALL)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "targetSalesArea",--最新可售面积（不含车位）
									 TO_CHAR((SELECT SUM(DDV.TARGET_A1_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99') AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
									 TO_CHAR((SELECT SUM(DDV.TARGET_A2_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99') AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
									 TO_CHAR((SELECT SUM(DDV.TARGET_A3_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99') AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
									  TO_CHAR((SELECT SUM(DDV.TARGET_A_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99') AS "targetNewestWorth",--目标总货值（A）-最新版(A)

/*                   TO_CHAR((SELECT SUM(DDV.Target_Now)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN v_DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID)
                            ,'999,999,999,999,999.99') AS "targetNewestWorth",--目标总货值（A）-最新版(A)*/

									 TO_CHAR((SELECT SUM(DDV.value_dt_all)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "dynamicTotalWorth",--动态总货值(B)
									 (CASE
												WHEN round((SELECT SUM(DDV.value_dt_all)/10000-SUM(DDV.TARGET_A_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),2) < -1 THEN
												 '<font color=red>' ||TO_CHAR((SELECT SUM(DDV.value_dt_all)/10000-SUM(DDV.TARGET_A_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99') || '</font>'
												ELSE
												 '<font color=green>' ||TO_CHAR((SELECT SUM(DDV.value_dt_all)/10000-SUM(DDV.TARGET_A_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99') || '</font>'
										END) AS "dynamicTotalWorthDifference",--总货值差额(B-A)
									 TO_CHAR((SELECT SUM(DDV.VALUE_RESERVE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "reserveTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
									 TO_CHAR((SELECT SUM(DDV.VALUE_IN_PROCESS)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "inProcessTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-在途货值(B2)--修改字段holdConstructionPermit=》inTransitWorth
									 TO_CHAR( (SELECT SUM(nvl(DDV.VALUE_REMAIN,0))/*+SUM(DDV.VALUE_HAVED_SALE)*/
                                FROM   SYS_BUSINESS_UNIT SBU
                                LEFT   JOIN mdm_PROJECT mp 
                                ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                                LEFT   JOIN DWM_DT_VALUE DDV
                                ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                                WHERE mp.PROJ_COOPERATE = (CASE 
                                                           WHEN ISOPERATE = '操盘' THEN  '操盘'
                                                            WHEN ISOPERATE = '非操盘' THEN'不操盘'
                                                            ELSE PROJ_COOPERATE 
                                                            END)
                                START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                                CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000
                      ,'999,999,999,999,999.99') AS "stockWorth",  --动态总货值构成（B=B1+B2+B3+B4）-库存货值(B3)
									 TO_CHAR((SELECT SUM(DDV.VALUE_HAVED_SALE)
                              FROM   SYS_BUSINESS_UNIT SBU
                              LEFT   JOIN mdm_PROJECT mp 
                              ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                              LEFT   JOIN V_DWM_DT_VALUE DDV
                              ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                              WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                              START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                              CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "alreadySalesWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-已售货值(B4)
									 TO_CHAR((SELECT SUM(DDV.VALUE_REMAIN)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "residueWorth",
									 --剩余货值(C=B1+B2+B3)
									 TO_CHAR( (SELECT SUM(DDV.Value_Stock)+SUM(DDV.VALUE_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID)/10000,
														'999,999,999,999,999.99') AS "getWorth",
									 --已领证货值(D=B3+B4)
									 (CASE
												WHEN (SELECT SUM(DDV.VALUE_STOCK)+SUM(DDV.VALUE_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) = 0 
                        THEN  '-'
												ELSE
												 TO_CHAR((SELECT SUM(DDV.VALUE_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / (SELECT SUM(DDV.VALUE_STOCK)+SUM(DDV.VALUE_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) * 100,
																 '999,999,999,999,999.99') || '%'
										END) AS "salesRate",
									 --去化率(E=B4/D)
									 TO_CHAR((SELECT SUM(DDV.VALUE_NOT_PLANNING_PERMIT)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "noPlanningPermitObtainedPhase",
									 --F、动态货值的各阶段分布-F0未取规证
									 TO_CHAR((SELECT SUM(DDV.VALUE_NOT_CONSTRUCTION_PERMIT)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "planningPermitObtainedOhase",
									 --F、动态货值的各阶段分布-F1规划许可证阶段
									 TO_CHAR((SELECT SUM(DDV.VALUE_NOT_SALE_PERMIT)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "constructionPermitOhase",
									 --F、动态货值的各阶段分布-F2施工许可证阶段
									 TO_CHAR((SELECT SUM(DDV.VALUE_NOT_COMPLETION)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "PreSalePermitPhase",
									 --F、动态货值的各阶段分布-F3预售许可证阶段
									 --TO_CHAR(b.value_yes_completion / 10000, '999,999,999,999,999.99') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
									 TO_CHAR((SELECT SUM(DDV.VALUE_YES_COMPLETION)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "completedRecordPhase",
									 --F、动态货值的各阶段分布-F4竣备阶段
									 '-' AS "carryDownPhase",
									 --F、动态货值的各阶段分布-F5结转阶段

									 TO_CHAR((SELECT SUM(DDV.VALUE_RESERVE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "reserveWorth",
									 --G1、储备货值的量价情况-货值（G1=a1*b1）
									 TO_CHAR((SELECT SUM(DDV.ZZ_AREA_RESERVE)+SUM(DDV.SY_AREA_RESERVE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
														'999,999,999,999,999.99') AS "reserveCargo",
									 --G1、储备货值的量价情况-货量(a1)
									 '-' AS "reservePrice",
									 --G1、储备货值的量价情况-单价(b1)
									 TO_CHAR((SELECT SUM(DDV.value_RESERVE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "inTransitWorth",
									 --G2、在途货值的量价情况-货值（G2=a2*b2）
									 TO_CHAR((SELECT SUM(DDV.ZZ_AREA_IN_PROCESS)+SUM(DDV.SY_AREA_IN_PROCESS)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
														'999,999,999,999,999.99') AS "inTransitCargo",
									 --G2、在途货值的量价情况-货量(a2)
									 '-' AS "inTransitPrice",
									 --G2、在途货值的量价情况-单价(b2)
									 TO_CHAR((SELECT SUM(VALUE_STOCK)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000, '999,999,999,999,999.99') AS "stockWorth",
									 --G3、库存货值的量价情况-货值（G3=a3*b3）
									 TO_CHAR((SELECT SUM(DDV.ZZ_AREA_STOCK) + SUM(DDV.SY_AREA_STOCK)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
														'999,999,999,999,999.99') AS "stockCargo",
									 --G3、库存货值的量价情况-货量(a3)
									 '-' AS "stockPrice",
									 --G3、库存货值的量价情况-单价(b3)
									 TO_CHAR((SELECT SUM(VALUE_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "soldWorth",
									 --G4、已售货值的量价情况-货值（G4=a4*b4）
									 TO_CHAR((SELECT SUM(DDV.ZZ_AREA_HAVED_SALE)+SUM(DDV.SY_AREA_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
														'999,999,999,999,999.99') AS "soldCargo",
									 --G4、已售货值的量价情况-货量(a4)
									 '-' AS "soldPrice" --G4、已售货值的量价情况-单价(b4)
						FROM   (SELECT *
										 FROM   (SELECT DISTINCT ORG_ID AS ID, ORG_NAME AS ORG_NAME,
																							ORDER_CODE AS ORDER_CODE,
																							PARENT_ID AS PARENT_ID,
																							1 AS IS_COMPANY, '' AS TAKE_DATE,
																							'' AS PROJ_COOPERATE
															FROM   TMP_COMPANY_TREE
															WHERE  ID = DATA_AUTH_SPID AND
																		 ORG_ID IN
																		 (SELECT DISTINCT ID
																			FROM   SYS_BUSINESS_UNIT
																			START  WITH ID IN
																									(SELECT ID
																									 FROM   (SELECT UNIT_ID AS ID
																														FROM   SYS_PROJECT
																														UNION
																														SELECT SUBORDINATE_COMPANY_ID AS ID
																														FROM   CDB_FEASIBLE_PROJECT_CONFIG) DS)
																			CONNECT BY PRIOR PARENT_ID = ID)
															UNION ALL
															SELECT PROJECT_ORIGINAL_ID AS ID,
																		 PROJECT_NAME || (CASE WHEN PROJ_COOPERATE = '不操盘' THEN  '（不操盘）' ELSE  '' END) AS PROJNAME,
																		 PROJECT_CODE AS ORDERCODE,
																		 COMPANY_ID AS PARENTID, 0 AS IS_COMPANY,
																		 TO_CHAR(PROJECT_GET_TIME, 'yyyy-mm-dd') AS TAKE_DATE,
																		 MDM_PROJECT.PROJ_COOPERATE
															FROM   MDM_PROJECT
															WHERE  APPROVAL_STATUS = '已审核' AND
																		 IS_DELETE = 0 AND
																		 PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)--'操盘'
															) T) A
						LEFT   JOIN Dwm_Dt_Value B ON     A.ID = B.OBJ_ID
						START  WITH A.ID = '' || UNITID || ''
						CONNECT BY PRIOR A.ID = A.PARENT_ID
						ORDER  BY SUBSTR(SYS_CONNECT_BY_PATH(A.ORDER_CODE, ','), 2);
		END IF;

		IF TABSINDEX = 2 THEN
				OPEN INFO FOR
						SELECT A.ID AS "id",
									 --主键id（生成树的id，唯一可以是业务id）
									 A.PARENT_ID AS "parentId",
									 --父级id（生成树父级id）
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/value-project/detail?code=value_dtl&isOperate=' ||
												 A.PROJ_COOPERATE || '&projectId=' || A.ID || '&projectName=' ||
												 A.ORG_NAME || '&projectDate=' || A.TAKE_DATE || '&tabIndex=' ||
												 TABSINDEX || '&pageTitle=' || A.ORG_NAME --页面标题名称
												ELSE
												 ''
										END) AS "openUrl",
									 --详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/dynamic-volume/circular?companyId=' || A.PARENT_ID ||
												 '&projectId=' || A.ID || '&type=2' --companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
												ELSE
												 ''
										END) AS "openVisualUrl",
									 --打开可视化地址
									 LEVEL,
									 CASE
												WHEN LEVEL = 1 THEN
												 '#eaf6ff'
												WHEN LEVEL = 2 THEN
												 '#ecfbee'
												WHEN LEVEL = 3 THEN
												 '#f2eed4'
												ELSE
												 ''
										END AS "excelRowBgColor",
									 --数据行导出excel背景色
									 CASE
												WHEN LEVEL = 1 THEN
												 '' || ORG_NAME
												WHEN LEVEL = 2 THEN
												 '        ' || ORG_NAME
												WHEN LEVEL = 3 THEN
												 '                ' || ORG_NAME
												WHEN LEVEL = 4 THEN
												 '                        ' || ORG_NAME
												ELSE
												 '                                ' || ORG_NAME
										END AS "excelRowTextTreeOrgName",
									 --文本前面加空格模仿树
									 A.ORG_NAME AS "orgName",--公司/项目
									 --TO_CHAR(b.area_dt_all, '999,999,999,999,999.99') AS "newestBuildArea",--最新建筑面积
									 TO_CHAR((SELECT SUM(DDV.ZZ_AREA_DT_ALL)+SUM(DDV.SY_AREA_DT_ALL)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "targetSalesArea",--最新可售面积（不含车位）
									 /*TO_CHAR((SELECT SUM(DDV.TARGET_A1_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99')*/'-' AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
									 /*TO_CHAR((SELECT SUM(DDV.TARGET_A2_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99')*/'-' AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
									 /*TO_CHAR((SELECT SUM(DDV.TARGET_A3_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99')*/'-' AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
									  /*TO_CHAR((SELECT SUM(DDV.TARGET_A_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99')*/'-' AS "targetNewestWorth",--目标总货值（A）-最新版(A)

/*                   TO_CHAR((SELECT SUM(DDV.Target_Now)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN v_DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID)
                            ,'999,999,999,999,999.99') AS "targetNewestWorth",--目标总货值（A）-最新版(A)*/

									 /*TO_CHAR((SELECT SUM(DDV.value_dt_all)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99')*/'-' AS "dynamicTotalWorth",--动态总货值(B)
									 /*(CASE
												WHEN round((SELECT SUM(DDV.value_dt_all)/10000-SUM(DDV.TARGET_A_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),2) < -1 THEN
												 '<font color=red>' ||TO_CHAR((SELECT SUM(DDV.value_dt_all)/10000-SUM(DDV.TARGET_A_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99') || '</font>'
												ELSE
												 '<font color=green>' ||TO_CHAR((SELECT SUM(DDV.value_dt_all)/10000-SUM(DDV.TARGET_A_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99') || '</font>'
										END)*/'-' AS "dynamicTotalWorthDifference",--总货值差额(B-A)
									 TO_CHAR((SELECT SUM(DDV.ZZ_VALUE_RESERVE)+SUM(DDV.SY_VALUE_RESERVE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "reserveTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
									 TO_CHAR((SELECT SUM(DDV.ZZ_VALUE_IN_PROCESS) +SUM(DDV.SY_VALUE_IN_PROCESS)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "inProcessTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-在途货值(B2)--修改字段holdConstructionPermit=》inTransitWorth
									 TO_CHAR( (SELECT SUM(nvl(DDV.ZZ_VALUE_REMAIN,0))+SUM(nvl(DDV.SY_VALUE_REMAIN,0))/*+SUM(DDV.VALUE_HAVED_SALE)*/
                                FROM   SYS_BUSINESS_UNIT SBU
                                LEFT   JOIN mdm_PROJECT mp 
                                ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                                LEFT   JOIN DWM_DT_VALUE DDV
                                ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                                WHERE mp.PROJ_COOPERATE = (CASE 
                                                           WHEN ISOPERATE = '操盘' THEN  '操盘'
                                                            WHEN ISOPERATE = '非操盘' THEN'不操盘'
                                                            ELSE PROJ_COOPERATE 
                                                            END)
                                START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                                CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000
                      ,'999,999,999,999,999.99') AS "stockWorth",  --动态总货值构成（B=B1+B2+B3+B4）-库存货值(B3)
									 TO_CHAR((SELECT SUM(DDV.ZZ_VALUE_HAVED_SALE) + SUM(DDV.SY_VALUE_HAVED_SALE)
                              FROM   SYS_BUSINESS_UNIT SBU
                              LEFT   JOIN mdm_PROJECT mp 
                              ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                              LEFT   JOIN V_DWM_DT_VALUE DDV
                              ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                              WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                              START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                              CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "alreadySalesWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-已售货值(B4)
									 TO_CHAR((SELECT SUM(DDV.ZZ_VALUE_REMAIN) + SUM(DDV.SY_VALUE_REMAIN)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "residueWorth",
									 --剩余货值(C=B1+B2+B3)
									 TO_CHAR( (SELECT SUM(DDV.ZZ_VALUE_Stock)+SUM(DDV.ZZ_VALUE_HAVED_SALE) +SUM(DDV.SY_VALUE_STOCK)+SUM(DDV.SY_VALUE_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID)/10000,
														'999,999,999,999,999.99') AS "getWorth",
									 --已领证货值(D=B3+B4)
									 (CASE
												WHEN (SELECT SUM(DDV.ZZ_VALUE_STOCK)+SUM(DDV.ZZ_VALUE_HAVED_SALE) + SUM(DDV.SY_VALUE_STOCK)+SUM(DDV.SY_VALUE_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) = 0 
                        THEN  '-'
												ELSE
												 TO_CHAR((SELECT SUM(DDV.ZZ_VALUE_HAVED_SALE) + SUM(DDV.SY_VALUE_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / (SELECT SUM(DDV.ZZ_VALUE_STOCK)+SUM(DDV.ZZ_VALUE_HAVED_SALE) + SUM(DDV.SY_VALUE_STOCK)+SUM(DDV.SY_VALUE_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) * 100,
																 '999,999,999,999,999.99') || '%'
										END) AS "salesRate",
									 --去化率(E=B4/D)
									 TO_CHAR((SELECT SUM(DDV.ZZ_VALUE_NOT_PLANNING_PERMIT) + SUM(DDV.SY_VALUE_NOT_PLANNING_PERMIT)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "noPlanningPermitObtainedPhase",
									 --F、动态货值的各阶段分布-F0未取规证
									 TO_CHAR((SELECT SUM(DDV.ZZ_VALUE_NOT_CONSTRUCTION_PER) + SUM(DDV.SY_VALUE_NOT_CONSTRUCTION_PER)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "planningPermitObtainedOhase",
									 --F、动态货值的各阶段分布-F1规划许可证阶段
									 TO_CHAR((SELECT SUM(DDV.ZZ_VALUE_NOT_SALE_PERMIT) + SUM(DDV.SY_VALUE_NOT_SALE_PERMIT)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "constructionPermitOhase",
									 --F、动态货值的各阶段分布-F2施工许可证阶段
									 TO_CHAR((SELECT SUM(DDV.ZZ_VALUE_NOT_COMPLETION) + SUM(DDV.SY_VALUE_NOT_COMPLETION)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "PreSalePermitPhase",
									 --F、动态货值的各阶段分布-F3预售许可证阶段
									 --TO_CHAR(b.value_yes_completion / 10000, '999,999,999,999,999.99') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
									 TO_CHAR((SELECT SUM(DDV.ZZ_VALUE_YES_COMPLETION) + SUM(DDV.SY_VALUE_YES_COMPLETION)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "completedRecordPhase",
									 --F、动态货值的各阶段分布-F4竣备阶段
									 '-' AS "carryDownPhase",
									 --F、动态货值的各阶段分布-F5结转阶段

									 TO_CHAR((SELECT SUM(DDV.ZZ_VALUE_RESERVE) + SUM(DDV.SY_VALUE_RESERVE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "reserveWorth",
									 --G1、储备货值的量价情况-货值（G1=a1*b1）
									 TO_CHAR((SELECT SUM(DDV.ZZ_AREA_RESERVE) + SUM(DDV.SY_AREA_RESERVE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
														'999,999,999,999,999.99') AS "reserveCargo",
									 --G1、储备货值的量价情况-货量(a1)
									 '-' AS "reservePrice",
									 --G1、储备货值的量价情况-单价(b1)
									 TO_CHAR((SELECT SUM(DDV.ZZ_value_RESERVE) + SUM(DDV.SY_value_RESERVE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "inTransitWorth",
									 --G2、在途货值的量价情况-货值（G2=a2*b2）
									 TO_CHAR((SELECT SUM(DDV.ZZ_AREA_IN_PROCESS) + SUM(DDV.SY_AREA_IN_PROCESS)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
														'999,999,999,999,999.99') AS "inTransitCargo",
									 --G2、在途货值的量价情况-货量(a2)
									 '-' AS "inTransitPrice",
									 --G2、在途货值的量价情况-单价(b2)
									 TO_CHAR((SELECT SUM(ZZ_VALUE_STOCK) + SUM(SY_VALUE_STOCK)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000, '999,999,999,999,999.99') AS "stockWorth",
									 --G3、库存货值的量价情况-货值（G3=a3*b3）
									 TO_CHAR((SELECT SUM(DDV.ZZ_AREA_STOCK) + SUM(DDV.SY_AREA_STOCK)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
														'999,999,999,999,999.99') AS "stockCargo",
									 --G3、库存货值的量价情况-货量(a3)
									 '-' AS "stockPrice",
									 --G3、库存货值的量价情况-单价(b3)
									 TO_CHAR((SELECT SUM(ZZ_VALUE_HAVED_SALE) + SUM(SY_VALUE_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "soldWorth",
									 --G4、已售货值的量价情况-货值（G4=a4*b4）
									 TO_CHAR((SELECT SUM(DDV.ZZ_AREA_HAVED_SALE)+SUM(DDV.SY_AREA_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
														'999,999,999,999,999.99') AS "soldCargo",
									 --G4、已售货值的量价情况-货量(a4)
									 '-' AS "soldPrice" --G4、已售货值的量价情况-单价(b4)
						FROM   (SELECT *
										 FROM   (SELECT DISTINCT ORG_ID AS ID, ORG_NAME AS ORG_NAME,
																							ORDER_CODE AS ORDER_CODE,
																							PARENT_ID AS PARENT_ID,
																							1 AS IS_COMPANY, '' AS TAKE_DATE,
																							'' AS PROJ_COOPERATE
															FROM   TMP_COMPANY_TREE
															WHERE  ID = DATA_AUTH_SPID AND
																		 ORG_ID IN
																		 (SELECT DISTINCT ID
																			FROM   SYS_BUSINESS_UNIT
																			START  WITH ID IN
																									(SELECT ID
																									 FROM   (SELECT UNIT_ID AS ID
																														FROM   SYS_PROJECT
																														UNION
																														SELECT SUBORDINATE_COMPANY_ID AS ID
																														FROM   CDB_FEASIBLE_PROJECT_CONFIG) DS)
																			CONNECT BY PRIOR PARENT_ID = ID)
															UNION ALL
															SELECT PROJECT_ORIGINAL_ID AS ID,
																		 PROJECT_NAME || (CASE WHEN PROJ_COOPERATE = '不操盘' THEN  '（不操盘）' ELSE  '' END) AS PROJNAME,
																		 PROJECT_CODE AS ORDERCODE,
																		 COMPANY_ID AS PARENTID, 0 AS IS_COMPANY,
																		 TO_CHAR(PROJECT_GET_TIME, 'yyyy-mm-dd') AS TAKE_DATE,
																		 MDM_PROJECT.PROJ_COOPERATE
															FROM   MDM_PROJECT
															WHERE  APPROVAL_STATUS = '已审核' AND
																		 IS_DELETE = 0 AND
																		 PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)--'操盘'
															) T) A
						LEFT   JOIN Dwm_Dt_Value B ON     A.ID = B.OBJ_ID
						START  WITH A.ID = '' || UNITID || ''
						CONNECT BY PRIOR A.ID = A.PARENT_ID
						ORDER  BY SUBSTR(SYS_CONNECT_BY_PATH(A.ORDER_CODE, ','), 2);
		END IF;

		IF TABSINDEX = 3 --OR tabsindex = 4 OR tabsindex = 5 
		 THEN
				OPEN INFO FOR
						SELECT A.ID AS "id",
									 --主键id（生成树的id，唯一可以是业务id）
									 A.PARENT_ID AS "parentId",
									 --父级id（生成树父级id）
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/value-project/detail?code=value_dtl&isOperate=' ||
												 A.PROJ_COOPERATE || '&projectId=' || A.ID || '&projectName=' ||
												 A.ORG_NAME || '&projectDate=' || A.TAKE_DATE || '&tabIndex=' ||
												 TABSINDEX || '&pageTitle=' || A.ORG_NAME --页面标题名称
												ELSE
												 ''
										END) AS "openUrl",
									 --详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/dynamic-volume/circular?companyId=' || A.PARENT_ID ||
												 '&projectId=' || A.ID || '&type=2' --companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
												ELSE
												 ''
										END) AS "openVisualUrl",
									 --打开可视化地址
									 LEVEL,
									 CASE
												WHEN LEVEL = 1 THEN
												 '#eaf6ff'
												WHEN LEVEL = 2 THEN
												 '#ecfbee'
												WHEN LEVEL = 3 THEN
												 '#f2eed4'
												ELSE
												 ''
										END AS "excelRowBgColor",
									 --数据行导出excel背景色
									 CASE
												WHEN LEVEL = 1 THEN
												 '' || ORG_NAME
												WHEN LEVEL = 2 THEN
												 '        ' || ORG_NAME
												WHEN LEVEL = 3 THEN
												 '                ' || ORG_NAME
												WHEN LEVEL = 4 THEN
												 '                        ' || ORG_NAME
												ELSE
												 '                                ' || ORG_NAME
										END AS "excelRowTextTreeOrgName",
									 --文本前面加空格模仿树
									 A.ORG_NAME AS "orgName",--公司/项目
									 --TO_CHAR(b.area_dt_all, '999,999,999,999,999.99') AS "newestBuildArea",--最新建筑面积
									 TO_CHAR((SELECT SUM(DDV.ZZ_AREA_DT_ALL)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "targetSalesArea",--最新可售面积（不含车位）
									 /*TO_CHAR((SELECT SUM(DDV.TARGET_A1_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99')*/'-' AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
									 /*TO_CHAR((SELECT SUM(DDV.TARGET_A2_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99')*/'-' AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
									 /*TO_CHAR((SELECT SUM(DDV.TARGET_A3_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99')*/'-' AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
									  /*TO_CHAR((SELECT SUM(DDV.TARGET_A_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99')*/'-' AS "targetNewestWorth",--目标总货值（A）-最新版(A)

/*                   TO_CHAR((SELECT SUM(DDV.Target_Now)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN v_DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID)
                            ,'999,999,999,999,999.99') AS "targetNewestWorth",--目标总货值（A）-最新版(A)*/

									 /*TO_CHAR((SELECT SUM(DDV.value_dt_all)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99')*/'-' AS "dynamicTotalWorth",--动态总货值(B)
									 /*(CASE
												WHEN round((SELECT SUM(DDV.value_dt_all)/10000-SUM(DDV.TARGET_A_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),2) < -1 THEN
												 '<font color=red>' ||TO_CHAR((SELECT SUM(DDV.value_dt_all)/10000-SUM(DDV.TARGET_A_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99') || '</font>'
												ELSE
												 '<font color=green>' ||TO_CHAR((SELECT SUM(DDV.value_dt_all)/10000-SUM(DDV.TARGET_A_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99') || '</font>'
										END)*/'-' AS "dynamicTotalWorthDifference",--总货值差额(B-A)
									 TO_CHAR((SELECT SUM(DDV.ZZ_VALUE_RESERVE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "reserveTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
									 TO_CHAR((SELECT SUM(DDV.ZZ_VALUE_IN_PROCESS)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "inProcessTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-在途货值(B2)--修改字段holdConstructionPermit=》inTransitWorth
									 TO_CHAR( (SELECT SUM(nvl(DDV.ZZ_VALUE_REMAIN,0))/*+SUM(DDV.VALUE_HAVED_SALE)*/
                                FROM   SYS_BUSINESS_UNIT SBU
                                LEFT   JOIN mdm_PROJECT mp 
                                ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                                LEFT   JOIN DWM_DT_VALUE DDV
                                ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                                WHERE mp.PROJ_COOPERATE = (CASE 
                                                           WHEN ISOPERATE = '操盘' THEN  '操盘'
                                                            WHEN ISOPERATE = '非操盘' THEN'不操盘'
                                                            ELSE PROJ_COOPERATE 
                                                            END)
                                START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                                CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000
                      ,'999,999,999,999,999.99') AS "stockWorth",  --动态总货值构成（B=B1+B2+B3+B4）-库存货值(B3)
									 TO_CHAR((SELECT SUM(DDV.ZZ_VALUE_HAVED_SALE)
                              FROM   SYS_BUSINESS_UNIT SBU
                              LEFT   JOIN mdm_PROJECT mp 
                              ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                              LEFT   JOIN V_DWM_DT_VALUE DDV
                              ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                              WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                              START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                              CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "alreadySalesWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-已售货值(B4)
									 TO_CHAR((SELECT SUM(DDV.ZZ_VALUE_REMAIN)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "residueWorth",
									 --剩余货值(C=B1+B2+B3)
									 TO_CHAR( (SELECT SUM(DDV.ZZ_VALUE_Stock)+SUM(DDV.ZZ_VALUE_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID)/10000,
														'999,999,999,999,999.99') AS "getWorth",
									 --已领证货值(D=B3+B4)
									 (CASE
												WHEN (SELECT SUM(DDV.ZZ_VALUE_STOCK)+SUM(DDV.ZZ_VALUE_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) = 0 
                        THEN  '-'
												ELSE
												 TO_CHAR((SELECT SUM(DDV.ZZ_VALUE_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / (SELECT SUM(DDV.ZZ_VALUE_STOCK)+SUM(DDV.ZZ_VALUE_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) * 100,
																 '999,999,999,999,999.99') || '%'
										END) AS "salesRate",
									 --去化率(E=B4/D)
									 TO_CHAR((SELECT SUM(DDV.ZZ_VALUE_NOT_PLANNING_PERMIT)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "noPlanningPermitObtainedPhase",
									 --F、动态货值的各阶段分布-F0未取规证
									 TO_CHAR((SELECT SUM(DDV.ZZ_VALUE_NOT_CONSTRUCTION_PER)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "planningPermitObtainedOhase",
									 --F、动态货值的各阶段分布-F1规划许可证阶段
									 TO_CHAR((SELECT SUM(DDV.ZZ_VALUE_NOT_SALE_PERMIT)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "constructionPermitOhase",
									 --F、动态货值的各阶段分布-F2施工许可证阶段
									 TO_CHAR((SELECT SUM(DDV.ZZ_VALUE_NOT_COMPLETION)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "PreSalePermitPhase",
									 --F、动态货值的各阶段分布-F3预售许可证阶段
									 --TO_CHAR(b.value_yes_completion / 10000, '999,999,999,999,999.99') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
									 TO_CHAR((SELECT SUM(DDV.ZZ_VALUE_YES_COMPLETION)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "completedRecordPhase",
									 --F、动态货值的各阶段分布-F4竣备阶段
									 '-' AS "carryDownPhase",
									 --F、动态货值的各阶段分布-F5结转阶段

									 TO_CHAR((SELECT SUM(DDV.ZZ_VALUE_RESERVE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "reserveWorth",
									 --G1、储备货值的量价情况-货值（G1=a1*b1）
									 TO_CHAR((SELECT SUM(DDV.ZZ_AREA_RESERVE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
														'999,999,999,999,999.99') AS "reserveCargo",
									 --G1、储备货值的量价情况-货量(a1)
									 '-' AS "reservePrice",
									 --G1、储备货值的量价情况-单价(b1)
									 TO_CHAR((SELECT SUM(DDV.ZZ_value_RESERVE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "inTransitWorth",
									 --G2、在途货值的量价情况-货值（G2=a2*b2）
									 TO_CHAR((SELECT SUM(DDV.ZZ_AREA_IN_PROCESS)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
														'999,999,999,999,999.99') AS "inTransitCargo",
									 --G2、在途货值的量价情况-货量(a2)
									 '-' AS "inTransitPrice",
									 --G2、在途货值的量价情况-单价(b2)
									 TO_CHAR((SELECT SUM(ZZ_VALUE_STOCK)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000, '999,999,999,999,999.99') AS "stockWorth",
									 --G3、库存货值的量价情况-货值（G3=a3*b3）
									 TO_CHAR((SELECT SUM(DDV.ZZ_AREA_STOCK) 
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
														'999,999,999,999,999.99') AS "stockCargo",
									 --G3、库存货值的量价情况-货量(a3)
									 '-' AS "stockPrice",
									 --G3、库存货值的量价情况-单价(b3)
									 TO_CHAR((SELECT SUM(ZZ_VALUE_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "soldWorth",
									 --G4、已售货值的量价情况-货值（G4=a4*b4）
									 TO_CHAR((SELECT SUM(DDV.ZZ_AREA_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
														'999,999,999,999,999.99') AS "soldCargo",
									 --G4、已售货值的量价情况-货量(a4)
									 '-' AS "soldPrice" --G4、已售货值的量价情况-单价(b4)
						FROM   (SELECT *
										 FROM   (SELECT DISTINCT ORG_ID AS ID, ORG_NAME AS ORG_NAME,
																							ORDER_CODE AS ORDER_CODE,
																							PARENT_ID AS PARENT_ID,
																							1 AS IS_COMPANY, '' AS TAKE_DATE,
																							'' AS PROJ_COOPERATE
															FROM   TMP_COMPANY_TREE
															WHERE  ID = DATA_AUTH_SPID AND
																		 ORG_ID IN
																		 (SELECT DISTINCT ID
																			FROM   SYS_BUSINESS_UNIT
																			START  WITH ID IN
																									(SELECT ID
																									 FROM   (SELECT UNIT_ID AS ID
																														FROM   SYS_PROJECT
																														UNION
																														SELECT SUBORDINATE_COMPANY_ID AS ID
																														FROM   CDB_FEASIBLE_PROJECT_CONFIG) DS)
																			CONNECT BY PRIOR PARENT_ID = ID)
															UNION ALL
															SELECT PROJECT_ORIGINAL_ID AS ID,
																		 PROJECT_NAME || (CASE WHEN PROJ_COOPERATE = '不操盘' THEN  '（不操盘）' ELSE  '' END) AS PROJNAME,
																		 PROJECT_CODE AS ORDERCODE,
																		 COMPANY_ID AS PARENTID, 0 AS IS_COMPANY,
																		 TO_CHAR(PROJECT_GET_TIME, 'yyyy-mm-dd') AS TAKE_DATE,
																		 MDM_PROJECT.PROJ_COOPERATE
															FROM   MDM_PROJECT
															WHERE  APPROVAL_STATUS = '已审核' AND
																		 IS_DELETE = 0 AND
																		 PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)--'操盘'
															) T) A
						LEFT   JOIN Dwm_Dt_Value B ON     A.ID = B.OBJ_ID
						START  WITH A.ID = '' || UNITID || ''
						CONNECT BY PRIOR A.ID = A.PARENT_ID
						ORDER  BY SUBSTR(SYS_CONNECT_BY_PATH(A.ORDER_CODE, ','), 2);
		END IF;

		IF TABSINDEX = 4 THEN
				OPEN INFO FOR
						SELECT A.ID AS "id",
									 --主键id（生成树的id，唯一可以是业务id）
									 A.PARENT_ID AS "parentId",
									 --父级id（生成树父级id）
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/value-project/detail?code=value_dtl&isOperate=' ||
												 A.PROJ_COOPERATE || '&projectId=' || A.ID || '&projectName=' ||
												 A.ORG_NAME || '&projectDate=' || A.TAKE_DATE || '&tabIndex=' ||
												 TABSINDEX || '&pageTitle=' || A.ORG_NAME --页面标题名称
												ELSE
												 ''
										END) AS "openUrl",
									 --详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/dynamic-volume/circular?companyId=' || A.PARENT_ID ||
												 '&projectId=' || A.ID || '&type=2' --companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
												ELSE
												 ''
										END) AS "openVisualUrl",
									 --打开可视化地址
									 LEVEL,
									 CASE
												WHEN LEVEL = 1 THEN
												 '#eaf6ff'
												WHEN LEVEL = 2 THEN
												 '#ecfbee'
												WHEN LEVEL = 3 THEN
												 '#f2eed4'
												ELSE
												 ''
										END AS "excelRowBgColor",
									 --数据行导出excel背景色
									 CASE
												WHEN LEVEL = 1 THEN
												 '' || ORG_NAME
												WHEN LEVEL = 2 THEN
												 '        ' || ORG_NAME
												WHEN LEVEL = 3 THEN
												 '                ' || ORG_NAME
												WHEN LEVEL = 4 THEN
												 '                        ' || ORG_NAME
												ELSE
												 '                                ' || ORG_NAME
										END AS "excelRowTextTreeOrgName",
									 --文本前面加空格模仿树
									 A.ORG_NAME AS "orgName",--公司/项目
									 --TO_CHAR(b.area_dt_all, '999,999,999,999,999.99') AS "newestBuildArea",--最新建筑面积
									 TO_CHAR((SELECT SUM(DDV.SY_AREA_DT_ALL)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "targetSalesArea",--最新可售面积（不含车位）
									 /*TO_CHAR((SELECT SUM(DDV.TARGET_A1_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99')*/'-' AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
									 /*TO_CHAR((SELECT SUM(DDV.TARGET_A2_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99')*/'-' AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
									 /*TO_CHAR((SELECT SUM(DDV.TARGET_A3_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99')*/'-' AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
									  /*TO_CHAR((SELECT SUM(DDV.TARGET_A_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99')*/'-' AS "targetNewestWorth",--目标总货值（A）-最新版(A)

/*                   TO_CHAR((SELECT SUM(DDV.Target_Now)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN v_DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID)
                            ,'999,999,999,999,999.99') AS "targetNewestWorth",--目标总货值（A）-最新版(A)*/

									 /*TO_CHAR((SELECT SUM(DDV.value_dt_all)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99')*/'-' AS "dynamicTotalWorth",--动态总货值(B)
									 /*(CASE
												WHEN round((SELECT SUM(DDV.value_dt_all)/10000-SUM(DDV.TARGET_A_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),2) < -1 THEN
												 '<font color=red>' ||TO_CHAR((SELECT SUM(DDV.value_dt_all)/10000-SUM(DDV.TARGET_A_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99') || '</font>'
												ELSE
												 '<font color=green>' ||TO_CHAR((SELECT SUM(DDV.value_dt_all)/10000-SUM(DDV.TARGET_A_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99') || '</font>'
										END)*/'-' AS "dynamicTotalWorthDifference",--总货值差额(B-A)
									 TO_CHAR((SELECT SUM(DDV.SY_VALUE_RESERVE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "reserveTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
									 TO_CHAR((SELECT SUM(DDV.SY_VALUE_IN_PROCESS)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "inProcessTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-在途货值(B2)--修改字段holdConstructionPermit=》inTransitWorth
									 TO_CHAR( (SELECT SUM(nvl(DDV.SY_VALUE_REMAIN,0))/*+SUM(DDV.VALUE_HAVED_SALE)*/
                                FROM   SYS_BUSINESS_UNIT SBU
                                LEFT   JOIN mdm_PROJECT mp 
                                ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                                LEFT   JOIN DWM_DT_VALUE DDV
                                ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                                WHERE mp.PROJ_COOPERATE = (CASE 
                                                           WHEN ISOPERATE = '操盘' THEN  '操盘'
                                                            WHEN ISOPERATE = '非操盘' THEN'不操盘'
                                                            ELSE PROJ_COOPERATE 
                                                            END)
                                START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                                CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000
                      ,'999,999,999,999,999.99') AS "stockWorth",  --动态总货值构成（B=B1+B2+B3+B4）-库存货值(B3)
									 TO_CHAR((SELECT SUM(DDV.SY_VALUE_HAVED_SALE)
                              FROM   SYS_BUSINESS_UNIT SBU
                              LEFT   JOIN mdm_PROJECT mp 
                              ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                              LEFT   JOIN V_DWM_DT_VALUE DDV
                              ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                              WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                              START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                              CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "alreadySalesWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-已售货值(B4)
									 TO_CHAR((SELECT SUM(DDV.SY_VALUE_REMAIN)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "residueWorth",
									 --剩余货值(C=B1+B2+B3)
									 TO_CHAR( (SELECT SUM(DDV.SY_VALUE_Stock)+SUM(DDV.SY_VALUE_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID)/10000,
														'999,999,999,999,999.99') AS "getWorth",
									 --已领证货值(D=B3+B4)
									 (CASE
												WHEN (SELECT SUM(DDV.SY_VALUE_STOCK)+SUM(DDV.SY_VALUE_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) = 0 
                        THEN  '-'
												ELSE
												 TO_CHAR((SELECT SUM(DDV.SY_VALUE_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / (SELECT SUM(DDV.SY_VALUE_STOCK)+SUM(DDV.SY_VALUE_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) * 100,
																 '999,999,999,999,999.99') || '%'
										END) AS "salesRate",
									 --去化率(E=B4/D)
									 TO_CHAR((SELECT SUM(DDV.SY_VALUE_NOT_PLANNING_PERMIT)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "noPlanningPermitObtainedPhase",
									 --F、动态货值的各阶段分布-F0未取规证
									 TO_CHAR((SELECT SUM(DDV.SY_VALUE_NOT_CONSTRUCTION_PER)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "planningPermitObtainedOhase",
									 --F、动态货值的各阶段分布-F1规划许可证阶段
									 TO_CHAR((SELECT SUM(DDV.SY_VALUE_NOT_SALE_PERMIT)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "constructionPermitOhase",
									 --F、动态货值的各阶段分布-F2施工许可证阶段
									 TO_CHAR((SELECT SUM(DDV.SY_VALUE_NOT_COMPLETION)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "PreSalePermitPhase",
									 --F、动态货值的各阶段分布-F3预售许可证阶段
									 --TO_CHAR(b.value_yes_completion / 10000, '999,999,999,999,999.99') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
									 TO_CHAR((SELECT SUM(DDV.SY_VALUE_YES_COMPLETION)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "completedRecordPhase",
									 --F、动态货值的各阶段分布-F4竣备阶段
									 '-' AS "carryDownPhase",
									 --F、动态货值的各阶段分布-F5结转阶段

									 TO_CHAR((SELECT SUM(DDV.SY_VALUE_RESERVE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "reserveWorth",
									 --G1、储备货值的量价情况-货值（G1=a1*b1）
									 TO_CHAR((SELECT SUM(DDV.SY_AREA_RESERVE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
														'999,999,999,999,999.99') AS "reserveCargo",
									 --G1、储备货值的量价情况-货量(a1)
									 '-' AS "reservePrice",
									 --G1、储备货值的量价情况-单价(b1)
									 TO_CHAR((SELECT SUM(DDV.SY_value_RESERVE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "inTransitWorth",
									 --G2、在途货值的量价情况-货值（G2=a2*b2）
									 TO_CHAR((SELECT SUM(DDV.SY_AREA_IN_PROCESS)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
														'999,999,999,999,999.99') AS "inTransitCargo",
									 --G2、在途货值的量价情况-货量(a2)
									 '-' AS "inTransitPrice",
									 --G2、在途货值的量价情况-单价(b2)
									 TO_CHAR((SELECT SUM(SY_VALUE_STOCK)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000, '999,999,999,999,999.99') AS "stockWorth",
									 --G3、库存货值的量价情况-货值（G3=a3*b3）
									 TO_CHAR((SELECT SUM(DDV.SY_AREA_STOCK) 
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
														'999,999,999,999,999.99') AS "stockCargo",
									 --G3、库存货值的量价情况-货量(a3)
									 '-' AS "stockPrice",
									 --G3、库存货值的量价情况-单价(b3)
									 TO_CHAR((SELECT SUM(SY_VALUE_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "soldWorth",
									 --G4、已售货值的量价情况-货值（G4=a4*b4）
									 TO_CHAR((SELECT SUM(DDV.SY_AREA_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
														'999,999,999,999,999.99') AS "soldCargo",
									 --G4、已售货值的量价情况-货量(a4)
									 '-' AS "soldPrice" --G4、已售货值的量价情况-单价(b4)
						FROM   (SELECT *
										 FROM   (SELECT DISTINCT ORG_ID AS ID, ORG_NAME AS ORG_NAME,
																							ORDER_CODE AS ORDER_CODE,
																							PARENT_ID AS PARENT_ID,
																							1 AS IS_COMPANY, '' AS TAKE_DATE,
																							'' AS PROJ_COOPERATE
															FROM   TMP_COMPANY_TREE
															WHERE  ID = DATA_AUTH_SPID AND
																		 ORG_ID IN
																		 (SELECT DISTINCT ID
																			FROM   SYS_BUSINESS_UNIT
																			START  WITH ID IN
																									(SELECT ID
																									 FROM   (SELECT UNIT_ID AS ID
																														FROM   SYS_PROJECT
																														UNION
																														SELECT SUBORDINATE_COMPANY_ID AS ID
																														FROM   CDB_FEASIBLE_PROJECT_CONFIG) DS)
																			CONNECT BY PRIOR PARENT_ID = ID)
															UNION ALL
															SELECT PROJECT_ORIGINAL_ID AS ID,
																		 PROJECT_NAME || (CASE WHEN PROJ_COOPERATE = '不操盘' THEN  '（不操盘）' ELSE  '' END) AS PROJNAME,
																		 PROJECT_CODE AS ORDERCODE,
																		 COMPANY_ID AS PARENTID, 0 AS IS_COMPANY,
																		 TO_CHAR(PROJECT_GET_TIME, 'yyyy-mm-dd') AS TAKE_DATE,
																		 MDM_PROJECT.PROJ_COOPERATE
															FROM   MDM_PROJECT
															WHERE  APPROVAL_STATUS = '已审核' AND
																		 IS_DELETE = 0 AND
																		 PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)--'操盘'
															) T) A
						LEFT   JOIN Dwm_Dt_Value B ON     A.ID = B.OBJ_ID
						START  WITH A.ID = '' || UNITID || ''
						CONNECT BY PRIOR A.ID = A.PARENT_ID
						ORDER  BY SUBSTR(SYS_CONNECT_BY_PATH(A.ORDER_CODE, ','), 2);
		END IF;

		IF TABSINDEX = 5 THEN
				OPEN INFO FOR
						SELECT A.ID AS "id",
									 --主键id（生成树的id，唯一可以是业务id）
									 A.PARENT_ID AS "parentId",
									 --父级id（生成树父级id）
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/value-project/detail?code=value_dtl&isOperate=' ||
												 A.PROJ_COOPERATE || '&projectId=' || A.ID || '&projectName=' ||
												 A.ORG_NAME || '&projectDate=' || A.TAKE_DATE || '&tabIndex=' ||
												 TABSINDEX || '&pageTitle=' || A.ORG_NAME --页面标题名称
												ELSE
												 ''
										END) AS "openUrl",
									 --详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/dynamic-volume/circular?companyId=' || A.PARENT_ID ||
												 '&projectId=' || A.ID || '&type=2' --companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
												ELSE
												 ''
										END) AS "openVisualUrl",
									 --打开可视化地址
									 LEVEL,
									 CASE
												WHEN LEVEL = 1 THEN
												 '#eaf6ff'
												WHEN LEVEL = 2 THEN
												 '#ecfbee'
												WHEN LEVEL = 3 THEN
												 '#f2eed4'
												ELSE
												 ''
										END AS "excelRowBgColor",
									 --数据行导出excel背景色
									 CASE
												WHEN LEVEL = 1 THEN
												 '' || ORG_NAME
												WHEN LEVEL = 2 THEN
												 '        ' || ORG_NAME
												WHEN LEVEL = 3 THEN
												 '                ' || ORG_NAME
												WHEN LEVEL = 4 THEN
												 '                        ' || ORG_NAME
												ELSE
												 '                                ' || ORG_NAME
										END AS "excelRowTextTreeOrgName",
									 --文本前面加空格模仿树
									 A.ORG_NAME AS "orgName",--公司/项目
									 --TO_CHAR(b.area_dt_all, '999,999,999,999,999.99') AS "newestBuildArea",--最新建筑面积
									 TO_CHAR((SELECT SUM(DDV.CW_AREA_DT_ALL)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), '999,999,999,999,999.99') AS "targetSalesArea",--最新可售面积（不含车位）
									 /*TO_CHAR((SELECT SUM(DDV.TARGET_A1_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99')*/'-' AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
									 /*TO_CHAR((SELECT SUM(DDV.TARGET_A2_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99')*/'-' AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
									 /*TO_CHAR((SELECT SUM(DDV.TARGET_A3_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99')*/'-' AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
									  /*TO_CHAR((SELECT SUM(DDV.TARGET_A_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99')*/'-' AS "targetNewestWorth",--目标总货值（A）-最新版(A)

/*                   TO_CHAR((SELECT SUM(DDV.Target_Now)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN v_DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID)
                            ,'999,999,999,999,999.99') AS "targetNewestWorth",--目标总货值（A）-最新版(A)*/

									 /*TO_CHAR((SELECT SUM(DDV.value_dt_all)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99')*/'-' AS "dynamicTotalWorth",--动态总货值(B)
									 /*(CASE
												WHEN round((SELECT SUM(DDV.value_dt_all)/10000-SUM(DDV.TARGET_A_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),2) < -1 THEN
												 '<font color=red>' ||TO_CHAR((SELECT SUM(DDV.value_dt_all)/10000-SUM(DDV.TARGET_A_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99') || '</font>'
												ELSE
												 '<font color=green>' ||TO_CHAR((SELECT SUM(DDV.value_dt_all)/10000-SUM(DDV.TARGET_A_VALUE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV ON DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),'999,999,999,999,999.99') || '</font>'
										END)*/'-' AS "dynamicTotalWorthDifference",--总货值差额(B-A)
									 TO_CHAR((SELECT SUM(DDV.CW_VALUE_RESERVE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "reserveTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
									 TO_CHAR((SELECT SUM(DDV.CW_VALUE_IN_PROCESS)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "inProcessTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-在途货值(B2)--修改字段holdConstructionPermit=》inTransitWorth
									 TO_CHAR( (SELECT SUM(nvl(DDV.CW_VALUE_REMAIN,0))/*+SUM(DDV.VALUE_HAVED_SALE)*/
                                FROM   SYS_BUSINESS_UNIT SBU
                                LEFT   JOIN mdm_PROJECT mp 
                                ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                                LEFT   JOIN DWM_DT_VALUE DDV
                                ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                                WHERE mp.PROJ_COOPERATE = (CASE 
                                                           WHEN ISOPERATE = '操盘' THEN  '操盘'
                                                            WHEN ISOPERATE = '非操盘' THEN'不操盘'
                                                            ELSE PROJ_COOPERATE 
                                                            END)
                                START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                                CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000
                      ,'999,999,999,999,999.99') AS "stockWorth",  --动态总货值构成（B=B1+B2+B3+B4）-库存货值(B3)
									 TO_CHAR((SELECT SUM(DDV.CW_VALUE_HAVED_SALE)
                              FROM   SYS_BUSINESS_UNIT SBU
                              LEFT   JOIN mdm_PROJECT mp 
                              ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                              LEFT   JOIN V_DWM_DT_VALUE DDV
                              ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                              WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                              START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                              CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "alreadySalesWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-已售货值(B4)
									 TO_CHAR((SELECT SUM(DDV.CW_VALUE_REMAIN)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "residueWorth",
									 --剩余货值(C=B1+B2+B3)
									 TO_CHAR( (SELECT SUM(DDV.CW_VALUE_Stock)+SUM(DDV.CW_VALUE_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID)/10000,
														'999,999,999,999,999.99') AS "getWorth",
									 --已领证货值(D=B3+B4)
									 (CASE
												WHEN (SELECT SUM(DDV.CW_VALUE_STOCK)+SUM(DDV.CW_VALUE_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) = 0 
                        THEN  '-'
												ELSE
												 TO_CHAR((SELECT SUM(DDV.CW_VALUE_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / (SELECT SUM(DDV.CW_VALUE_STOCK)+SUM(DDV.CW_VALUE_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) * 100,
																 '999,999,999,999,999.99') || '%'
										END) AS "salesRate",
									 --去化率(E=B4/D)
									 TO_CHAR((SELECT SUM(DDV.CW_VALUE_NOT_PLANNING_PERMIT)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "noPlanningPermitObtainedPhase",
									 --F、动态货值的各阶段分布-F0未取规证
									 TO_CHAR((SELECT SUM(DDV.CW_VALUE_NOT_CONSTRUCTION_PER)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "planningPermitObtainedOhase",
									 --F、动态货值的各阶段分布-F1规划许可证阶段
									 TO_CHAR((SELECT SUM(DDV.CW_VALUE_NOT_SALE_PERMIT)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "constructionPermitOhase",
									 --F、动态货值的各阶段分布-F2施工许可证阶段
									 TO_CHAR((SELECT SUM(DDV.CW_VALUE_NOT_COMPLETION)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "PreSalePermitPhase",
									 --F、动态货值的各阶段分布-F3预售许可证阶段
									 --TO_CHAR(b.value_yes_completion / 10000, '999,999,999,999,999.99') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
									 TO_CHAR((SELECT SUM(DDV.CW_VALUE_YES_COMPLETION)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "completedRecordPhase",
									 --F、动态货值的各阶段分布-F4竣备阶段
									 '-' AS "carryDownPhase",
									 --F、动态货值的各阶段分布-F5结转阶段

									 TO_CHAR((SELECT SUM(DDV.CW_VALUE_RESERVE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "reserveWorth",
									 --G1、储备货值的量价情况-货值（G1=a1*b1）
									 TO_CHAR((SELECT SUM(DDV.CW_AREA_RESERVE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
														'999,999,999,999,999.99') AS "reserveCargo",
									 --G1、储备货值的量价情况-货量(a1)
									 '-' AS "reservePrice",
									 --G1、储备货值的量价情况-单价(b1)
									 TO_CHAR((SELECT SUM(DDV.CW_value_RESERVE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "inTransitWorth",
									 --G2、在途货值的量价情况-货值（G2=a2*b2）
									 TO_CHAR((SELECT SUM(DDV.CW_AREA_IN_PROCESS)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
														'999,999,999,999,999.99') AS "inTransitCargo",
									 --G2、在途货值的量价情况-货量(a2)
									 '-' AS "inTransitPrice",
									 --G2、在途货值的量价情况-单价(b2)
									 TO_CHAR((SELECT SUM(CW_VALUE_STOCK)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000, '999,999,999,999,999.99') AS "stockWorth",
									 --G3、库存货值的量价情况-货值（G3=a3*b3）
									 TO_CHAR((SELECT SUM(DDV.CW_AREA_STOCK) 
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
														'999,999,999,999,999.99') AS "stockCargo",
									 --G3、库存货值的量价情况-货量(a3)
									 '-' AS "stockPrice",
									 --G3、库存货值的量价情况-单价(b3)
									 TO_CHAR((SELECT SUM(CW_VALUE_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) / 10000,
														'999,999,999,999,999.99') AS "soldWorth",
									 --G4、已售货值的量价情况-货值（G4=a4*b4）
									 TO_CHAR((SELECT SUM(DDV.CW_AREA_HAVED_SALE)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp 
                            ON     SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN DWM_DT_VALUE DDV
                            ON     DDV.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE =(CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
														'999,999,999,999,999.99') AS "soldCargo",
									 --G4、已售货值的量价情况-货量(a4)
									 '-' AS "soldPrice" --G4、已售货值的量价情况-单价(b4)
						FROM   (SELECT *
										 FROM   (SELECT DISTINCT ORG_ID AS ID, ORG_NAME AS ORG_NAME,
																							ORDER_CODE AS ORDER_CODE,
																							PARENT_ID AS PARENT_ID,
																							1 AS IS_COMPANY, '' AS TAKE_DATE,
																							'' AS PROJ_COOPERATE
															FROM   TMP_COMPANY_TREE
															WHERE  ID = DATA_AUTH_SPID AND
																		 ORG_ID IN
																		 (SELECT DISTINCT ID
																			FROM   SYS_BUSINESS_UNIT
																			START  WITH ID IN
																									(SELECT ID
																									 FROM   (SELECT UNIT_ID AS ID
																														FROM   SYS_PROJECT
																														UNION
																														SELECT SUBORDINATE_COMPANY_ID AS ID
																														FROM   CDB_FEASIBLE_PROJECT_CONFIG) DS)
																			CONNECT BY PRIOR PARENT_ID = ID)
															UNION ALL
															SELECT PROJECT_ORIGINAL_ID AS ID,
																		 PROJECT_NAME || (CASE WHEN PROJ_COOPERATE = '不操盘' THEN  '（不操盘）' ELSE  '' END) AS PROJNAME,
																		 PROJECT_CODE AS ORDERCODE,
																		 COMPANY_ID AS PARENTID, 0 AS IS_COMPANY,
																		 TO_CHAR(PROJECT_GET_TIME, 'yyyy-mm-dd') AS TAKE_DATE,
																		 MDM_PROJECT.PROJ_COOPERATE
															FROM   MDM_PROJECT
															WHERE  APPROVAL_STATUS = '已审核' AND
																		 IS_DELETE = 0 AND
																		 PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)--'操盘'
															) T) A
						LEFT   JOIN Dwm_Dt_Value B ON     A.ID = B.OBJ_ID
						START  WITH A.ID = '' || UNITID || ''
						CONNECT BY PRIOR A.ID = A.PARENT_ID
						ORDER  BY SUBSTR(SYS_CONNECT_BY_PATH(A.ORDER_CODE, ','), 2);
		END IF;

END P_DWM_DT_VALUE_LIST;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_EXPLANATIONBYCODE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_EXPLANATIONBYCODE" (keycode in varchar2,Explanation out clob)
as
keycodeStr varchar2(100):='';
begin
Explanation:='';
    if keycode is not null then
     keycodeStr:=keycode||'.explanation';
     end if;
    select DETAILS into Explanation from DWM_SALE_RATE_DATA_BRIEFING where code=keycodeStr and rownum=1;
end P_DWM_ExplanationByCode;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_GET_BLD_VALUE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_GET_BLD_VALUE" 
IS
/*
      --CreateBy:Wangck
      --CreateDate:20200406
      --Note:用于计算DWM_DT_VALUR表中所有楼栋的“车位、住宅、商业”的动态货量
    */
    --取车位楼栋
    CURSOR CUR_CW_BLD_LIST IS
SELECT A.OBJ_ID AS BLD_ID, A.OBJ_NAME AS BLD_NAME, C.PHASE_ID, C.PHASE_NAME AS PHASE_NAME, C.ID AS OBJ_PHASE_ID, D.ID AS PT_INDEX_ID, D.OPERATE_ATTRIBUTE_NAME
FROM   DWM_DT_VALUE A
INNER  JOIN MDM_BUILD B
ON     A.OBJ_ID = B.ID
INNER  JOIN MDM_BUILD_PHASE C
ON     B.ID = C.BUILD_ID AND
			 C.PHASE_ORDER = (SELECT MAX(P.PHASE_ORDER)
												FROM   MDM_BUILD_PHASE P
												WHERE  P.BUILD_ID = C.BUILD_ID /*AND
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       P.PHASE_STATE >= 19*/
												)
INNER  JOIN MDM_OBJ_PHASE_PT_INDEX D
ON     C.ID = D.OBJ_PHASE_ID
WHERE  D.PRODUCT_TYPE_JSON = '{"isCarport":1}';

ITEM_CW_BLD_LIST CUR_CW_BLD_LIST%ROWTYPE;

--取住宅楼栋
CURSOR CUR_ZZ_BLD_LIST IS
		SELECT A.OBJ_ID AS BLD_ID, A.OBJ_NAME AS BLD_NAME, C.PHASE_ID, C.PHASE_NAME AS PHASE_NAME, C.ID AS OBJ_PHASE_ID, D.ID AS PT_INDEX_ID, D.OPERATE_ATTRIBUTE_NAME
		FROM   DWM_DT_VALUE A
		INNER  JOIN MDM_BUILD B
		ON     A.OBJ_ID = B.ID
		INNER  JOIN MDM_BUILD_PHASE C
		ON     B.ID = C.BUILD_ID AND
					 C.PHASE_ORDER = (SELECT MAX(P.PHASE_ORDER)
														FROM   MDM_BUILD_PHASE P
														WHERE  P.BUILD_ID = C.BUILD_ID /*AND
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               P.PHASE_STATE >= 19*/
														)
		INNER  JOIN MDM_OBJ_PHASE_PT_INDEX D
		ON     C.ID = D.OBJ_PHASE_ID
		WHERE  D.PRODUCT_TYPE_NAME LIKE '住宅/%';

ITEM_ZZ_BLD_LIST CUR_ZZ_BLD_LIST%ROWTYPE;

--取商业楼栋
CURSOR CUR_SY_BLD_LIST IS
		SELECT A.OBJ_ID AS BLD_ID, A.OBJ_NAME AS BLD_NAME, C.PHASE_ID, C.PHASE_NAME AS PHASE_NAME, C.ID AS OBJ_PHASE_ID, D.ID AS PT_INDEX_ID, D.OPERATE_ATTRIBUTE_NAME
		FROM   DWM_DT_VALUE A
		INNER  JOIN MDM_BUILD B
		ON     A.OBJ_ID = B.ID
		INNER  JOIN MDM_BUILD_PHASE C
		ON     B.ID = C.BUILD_ID AND
					 C.PHASE_ORDER = (SELECT MAX(P.PHASE_ORDER)
														FROM   MDM_BUILD_PHASE P
														WHERE  P.BUILD_ID = C.BUILD_ID /*AND
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               P.PHASE_STATE >= 19*/
														)
		INNER  JOIN MDM_OBJ_PHASE_PT_INDEX D
		ON     C.ID = D.OBJ_PHASE_ID
		WHERE  D.PRODUCT_TYPE_NAME LIKE '商办产业/%';

ITEM_SY_BLD_LIST CUR_SY_BLD_LIST%ROWTYPE;
--房间表汇总
CURSOR CUR_ROOM_LIST IS
		SELECT B.BUILDING_ID, A.ORDER_HIERARCHY_CODE, B.PROJECT_NAME, B.PROJECT_ID AS PROJ_ID,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE <> '签约' THEN
												ROUND(B.BZ_PRICE * NVL(B.NEW_BLD_AREA, 0), 2)
											 ELSE
												0
									 END), 0)) AS ALL库存货值_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE = '签约' THEN
												NVL(B.TRADE_TOTAL, 0)
											 ELSE
												0
									 END), 0)) AS ALL已售货值_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE <> '签约' THEN
												ROUND(B.BZ_PRICE * NVL(B.NEW_BLD_AREA, 0), 2)
											 ELSE
												0
									 END), 0)) + SUM(NVL((CASE
																					 WHEN B.SALE_STATE = '签约' THEN
																						NVL(B.TRADE_TOTAL, 0)
																					 ELSE
																						0
																			 END), 0)) AS ALL库存及已售总货值

					,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE <> '签约' THEN
												NVL(B.NEW_BLD_AREA, 0)
											 ELSE
												0
									 END), 0)) AS ALL库存面积_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE = '签约' THEN
												NVL(B.NEW_BLD_AREA, 0)
											 ELSE
												0
									 END), 0)) AS ALL已售面积_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE <> '签约' THEN
												1
											 ELSE
												0
									 END), 0)) AS ALL库存套数_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE = '签约' THEN
												1
											 ELSE
												0
									 END), 0)) AS ALL已售套数_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE <> '签约'
														AND B.PRODUCT_NAME IN ('住宅', '商办') THEN
												NVL(B.NEW_BLD_AREA, 0)
											 ELSE
												0
									 END), 0)) AS ALL库存货量_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE = '签约'
														AND B.PRODUCT_NAME IN ('住宅', '商办') THEN
												NVL(B.NEW_BLD_AREA, 0)
											 ELSE
												0
									 END), 0)) AS ALL已售货量_房间合计,
					 SUM(NVL((CASE
											 WHEN B.PRODUCT_NAME IN ('住宅', '商办') THEN
												B.ACTUAL_BLD_AREA
											 ELSE
												0
									 END), 0)) AS ALL竣备面积_房间合计,
					 SUM(NVL((CASE
											 WHEN NVL(B.ACTUAL_BLD_AREA, 0) <> 0
														AND B.SALE_STATE = '签约' THEN
												B.TRADE_TOTAL
											 WHEN NVL(B.ACTUAL_BLD_AREA, 0) <> 0
														AND B.SALE_STATE <> '签约' THEN
												B.BZ_TOTAL
											 ELSE
												0
									 END), 0)) AS ALL竣备货值_房间合计,
					 SUM(NVL((CASE
											 WHEN B.IS_INDIRECT = 1 THEN
												B.TRADE_TOTAL
											 ELSE
												0
									 END), 0)) AS ALL结转货值_房间合计,
					 SUM(NVL((CASE
											 WHEN B.IS_INDIRECT = 1 THEN
												B.ACTUAL_BLD_AREA
											 ELSE
												0
									 END), 0)) AS ALL结转货量_房间合计

					,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE <> '签约'
														AND B.PRODUCT_NAME = '住宅' THEN
												ROUND(B.BZ_PRICE * NVL(B.NEW_BLD_AREA, 0), 2)
											 ELSE
												0
									 END), 0)) AS ZZ库存货值_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE = '签约'
														AND B.PRODUCT_NAME = '住宅' THEN
												NVL(B.TRADE_TOTAL, 0)
											 ELSE
												0
									 END), 0)) AS ZZ已售货值_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE <> '签约'
														AND B.PRODUCT_NAME = '住宅' THEN
												NVL(B.NEW_BLD_AREA, 0)
											 ELSE
												0
									 END), 0)) AS ZZ库存面积_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE = '签约'
														AND B.PRODUCT_NAME = '住宅' THEN
												NVL(B.NEW_BLD_AREA, 0)
											 ELSE
												0
									 END), 0)) AS ZZ已售面积_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE <> '签约'
														AND B.PRODUCT_NAME = '住宅' THEN
												1
											 ELSE
												0
									 END), 0)) AS ZZ库存套数_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE = '签约'
														AND B.PRODUCT_NAME = '住宅' THEN
												1
											 ELSE
												0
									 END), 0)) AS ZZ已售套数_房间合计,
					 SUM(NVL((CASE
											 WHEN B.PRODUCT_NAME = '住宅' THEN
												B.ACTUAL_BLD_AREA
											 ELSE
												0
									 END), 0)) AS ZZ竣备面积_房间合计,
					 SUM(NVL((CASE
											 WHEN B.PRODUCT_NAME = '住宅'
														AND B.SALE_STATE = '签约'
														AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0 THEN
												B.TRADE_TOTAL
											 WHEN B.PRODUCT_NAME = '住宅'
														AND B.SALE_STATE <> '签约'
														AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0 THEN
												B.BZ_TOTAL
											 ELSE
												0
									 END), 0)) AS ZZ竣备货值_房间合计,
					 SUM(NVL((CASE
											 WHEN B.PRODUCT_NAME = '住宅'
														AND B.IS_INDIRECT = 1 THEN
												B.TRADE_TOTAL
											 ELSE
												0
									 END), 0)) AS ZZ结转货值_房间合计,
					 SUM(NVL((CASE
											 WHEN B.PRODUCT_NAME = '住宅'
														AND B.IS_INDIRECT = 1 THEN
												B.ACTUAL_BLD_AREA
											 ELSE
												0
									 END), 0)) AS ZZ结转货量_房间合计

					,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE <> '签约'
														AND B.PRODUCT_NAME = '商办' THEN
												ROUND(B.BZ_PRICE * NVL(B.NEW_BLD_AREA, 0), 2)
											 ELSE
												0
									 END), 0)) AS SY库存货值_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE = '签约'
														AND B.PRODUCT_NAME = '商办' THEN
												NVL(B.TRADE_TOTAL, 0)
											 ELSE
												0
									 END), 0)) AS SY已售货值_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE <> '签约'
														AND B.PRODUCT_NAME = '商办' THEN
												NVL(B.NEW_BLD_AREA, 0)
											 ELSE
												0
									 END), 0)) AS SY库存面积_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE = '签约'
														AND B.PRODUCT_NAME = '商办' THEN
												NVL(B.NEW_BLD_AREA, 0)
											 ELSE
												0
									 END), 0)) AS SY已售面积_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE <> '签约'
														AND B.PRODUCT_NAME = '商办' THEN
												1
											 ELSE
												0
									 END), 0)) AS SY库存套数_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE = '签约'
														AND B.PRODUCT_NAME = '商办' THEN
												1
											 ELSE
												0
									 END), 0)) AS SY已售套数_房间合计,
					 SUM(NVL((CASE
											 WHEN B.PRODUCT_NAME = '商办' THEN
												B.ACTUAL_BLD_AREA
											 ELSE
												0
									 END), 0)) AS SY竣备面积_房间合计,
					 SUM(NVL((CASE
											 WHEN B.PRODUCT_NAME = '商办'
														AND B.SALE_STATE = '签约'
														AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0 THEN
												B.TRADE_TOTAL
											 WHEN B.PRODUCT_NAME = '商办'
														AND B.SALE_STATE <> '签约'
														AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0 THEN
												B.BZ_TOTAL
											 ELSE
												0
									 END), 0)) AS SY竣备货值_房间合计,
					 SUM(NVL((CASE
											 WHEN B.PRODUCT_NAME = '商办'
														AND B.IS_INDIRECT = 1 THEN
												B.TRADE_TOTAL
											 ELSE
												0
									 END), 0)) AS SY结转货值_房间合计,
					 SUM(NVL((CASE
											 WHEN B.PRODUCT_NAME = '商办'
														AND B.IS_INDIRECT = 1 THEN
												B.ACTUAL_BLD_AREA
											 ELSE
												0
									 END), 0)) AS SY结转货量_房间合计

					,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE <> '签约'
														AND B.PRODUCT_NAME IN ('住宅', '商办') THEN
												ROUND(B.BZ_PRICE * NVL(B.NEW_BLD_AREA, 0), 2)
											 ELSE
												0
									 END), 0)) AS ZS库存货值_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE = '签约'
														AND B.PRODUCT_NAME IN ('住宅', '商办') THEN
												NVL(B.TRADE_TOTAL, 0)
											 ELSE
												0
									 END), 0)) AS ZS已售货值_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE <> '签约'
														AND B.PRODUCT_NAME IN ('住宅', '商办') THEN
												NVL(B.NEW_BLD_AREA, 0)
											 ELSE
												0
									 END), 0)) AS ZS库存面积_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE = '签约'
														AND B.PRODUCT_NAME IN ('住宅', '商办') THEN
												NVL(B.NEW_BLD_AREA, 0)
											 ELSE
												0
									 END), 0)) AS ZS已售面积_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE <> '签约'
														AND B.PRODUCT_NAME IN ('住宅', '商办') THEN
												1
											 ELSE
												0
									 END), 0)) AS ZS库存套数_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE = '签约'
														AND B.PRODUCT_NAME IN ('住宅', '商办') THEN
												1
											 ELSE
												0
									 END), 0)) AS ZS已售套数_房间合计,
					 SUM(NVL((CASE
											 WHEN B.PRODUCT_NAME IN ('住宅', '商办') THEN
												B.ACTUAL_BLD_AREA
											 ELSE
												0
									 END), 0)) AS ZS竣备面积_房间合计,
					 SUM(NVL((CASE
											 WHEN B.PRODUCT_NAME IN ('住宅', '商办')
														AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0
														AND B.SALE_STATE = '签约' THEN
												B.TRADE_TOTAL
											 WHEN B.PRODUCT_NAME IN ('住宅', '商办')
														AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0
														AND B.SALE_STATE <> '签约' THEN
												B.BZ_TOTAL
											 ELSE
												0
									 END), 0)) AS ZS竣备货值_房间合计,
					 SUM(NVL((CASE
											 WHEN B.PRODUCT_NAME IN ('住宅', '商办')
														AND B.IS_INDIRECT = 1 THEN
												B.TRADE_TOTAL
											 ELSE
												0
									 END), 0)) AS ZS结转货值_房间合计,
					 SUM(NVL((CASE
											 WHEN B.PRODUCT_NAME IN ('住宅', '商办')
														AND B.IS_INDIRECT = 1 THEN
												B.ACTUAL_BLD_AREA
											 ELSE
												0
									 END), 0)) AS ZS结转货量_房间合计

					,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE <> '签约'
														AND B.PRODUCT_NAME = '车位' THEN
												ROUND(B.BZ_PRICE * NVL(B.NEW_BLD_AREA, 0), 2)
											 ELSE
												0
									 END), 0)) AS CW库存货值_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE = '签约'
														AND B.PRODUCT_NAME = '车位' THEN
												NVL(B.TRADE_TOTAL, 0)
											 ELSE
												0
									 END), 0)) AS CW已售货值_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE <> '签约'
														AND B.PRODUCT_NAME = '车位' THEN
												NVL(B.NEW_BLD_AREA, 0)
											 ELSE
												0
									 END), 0)) AS CW库存面积_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE = '签约'
														AND B.PRODUCT_NAME = '车位' THEN
												NVL(B.NEW_BLD_AREA, 0)
											 ELSE
												0
									 END), 0)) AS CW已售面积_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE <> '签约'
														AND B.PRODUCT_NAME = '车位' THEN
												1
											 ELSE
												0
									 END), 0)) AS CW库存套数_房间合计,
					 SUM(NVL((CASE
											 WHEN B.SALE_STATE = '签约'
														AND B.PRODUCT_NAME = '车位' THEN
												1
											 ELSE
												0
									 END), 0)) AS CW已售套数_房间合计,
					 SUM(CASE
									 WHEN B.PRODUCT_NAME = '车位'
												AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0 THEN
										1
									 ELSE
										0
							 END) AS CW已竣备套数_房间合计,
					 SUM(CASE
									 WHEN B.PRODUCT_NAME = '车位'
												AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0
												AND B.SALE_STATE = '签约' THEN
										B.TRADE_TOTAL
									 WHEN B.PRODUCT_NAME = '车位'
												AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0
												AND B.SALE_STATE <> '签约' THEN
										B.BZ_TOTAL
									 ELSE
										0
							 END) AS CW已竣备货值_房间合计,
					 SUM(NVL((CASE
											 WHEN B.PRODUCT_NAME = '车位'
														AND B.IS_INDIRECT = 1 THEN
												B.TRADE_TOTAL
											 ELSE
												0
									 END), 0)) AS CW结转货值_房间合计,
					 SUM(NVL((CASE
											 WHEN B.PRODUCT_NAME = '车位'
														AND B.IS_INDIRECT = 1 THEN
												B.ACTUAL_BLD_AREA
											 ELSE
												0
									 END), 0)) AS CW结转货量_房间合计

		FROM   MDM_ROOM B
		LEFT   JOIN MDM_BUILD A
		ON     A.ID = B.BUILDING_ID
		-- WHERE b.project_name='佛山领秀公馆（北区）'
		GROUP  BY B.PROJECT_NAME, B.PROJECT_ID, B.BUILDING_ID, A.ORDER_HIERARCHY_CODE;

ITEM_ROOM_LIST CUR_ROOM_LIST%ROWTYPE;

--取DWM_DT_VALUE表中所有楼栋数据
CURSOR CUR_BLD_LIST IS
		SELECT A.ID, A.OBJ_ID AS BLD_ID, A.OBJ_NAME AS BLD_NAME, C.PHASE_ID, C.PHASE_NAME AS PHASE_NAME, C.ID AS OBJ_PHASE_ID, A.VALUE_ALLOW_SALE, A.AREA_NOT_PLANNING_PERMIT,
					 A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT
		FROM   DWM_DT_VALUE A
		INNER  JOIN MDM_BUILD B
		ON     A.OBJ_ID = B.ID
		INNER  JOIN MDM_BUILD_PHASE C
		ON     B.ID = C.BUILD_ID AND
					 C.PHASE_ORDER = (SELECT MAX(P.PHASE_ORDER) FROM MDM_BUILD_PHASE P WHERE P.BUILD_ID = C.BUILD_ID /*AND P.PHASE_STATE >= 19*/
														);
ITEM_BLD_LIST CUR_BLD_LIST%ROWTYPE;

--计数器
I NUMBER(10, 0) := 1;
--楼栋均价
V_TARGET_PRICE NUMBER(18, 2) := 0;

BEGIN
		/*
      --楼栋级对象，所有值设置为0
    */

		UPDATE DWM_DT_VALUE A
		SET    VALUE_DT_ALL = 0, VALUE_REMAIN = 0, VALUE_HAVED_SALE = 0, VALUE_RESERVE = 0, VALUE_IN_PROCESS = 0, VALUE_ALLOW_SALE = 0, VALUE_STOCK = 0, VALUE_NOT_PLANNING_PERMIT = 0,
					 VALUE_NOT_CONSTRUCTION_PERMIT = 0, VALUE_NOT_SALE_PERMIT = 0, VALUE_NOT_COMPLETION = 0, VALUE_YES_COMPLETION = 0, VALUE_YES_SETTLEMENT = 0, AREA_DT_ALL = 0, AREA_REMAIN = 0,
					 AREA_HAVED_SALE = 0, AREA_RESERVE = 0, AREA_IN_PROCESS = 0, AREA_ALLOW_SALE = 0, AREA_STOCK = 0, AREA_NOT_PLANNING_PERMIT = 0, AREA_NOT_CONSTRUCTION_PERMIT = 0, AREA_NOT_SALE_PERMIT = 0,
					 AREA_NOT_COMPLETION = 0, AREA_YES_COMPLETION = 0, AREA_YES_SETTLEMENT = 0, TMP_1KY_VALUE = 0, TMP_1KY_AREA = 0, TMP_1KY_PRICE = 0, TMP_2QP_VALUE = 0, TMP_2QP_AREA = 0, TMP_2QP_PRICE = 0,
					 CW_VALUE_DT_ALL = 0, CW_VALUE_REMAIN = 0, CW_VALUE_HAVED_SALE = 0, CW_VALUE_RESERVE = 0, CW_VALUE_IN_PROCESS = 0, CW_VALUE_ALLOW_SALE = 0, CW_VALUE_STOCK = 0,
					 CW_VALUE_NOT_PLANNING_PERMIT = 0, CW_VALUE_NOT_CONSTRUCTION_PER = 0, CW_VALUE_NOT_SALE_PERMIT = 0, CW_VALUE_NOT_COMPLETION = 0, CW_VALUE_YES_COMPLETION = 0, CW_VALUE_YES_SETTLEMENT = 0,
					 CW_AREA_DT_ALL = 0, CW_AREA_REMAIN = 0, CW_AREA_HAVED_SALE = 0, CW_AREA_RESERVE = 0, CW_AREA_IN_PROCESS = 0, CW_AREA_ALLOW_SALE = 0, CW_AREA_STOCK = 0, CW_AREA_NOT_PLANNING_PERMIT = 0,
					 CW_AREA_NOT_CONSTRUCTION_PER = 0, CW_AREA_NOT_SALE_PERMIT = 0, CW_AREA_NOT_COMPLETION = 0, CW_AREA_YES_COMPLETION = 0, CW_AREA_YES_SETTLEMENT = 0, ZZ_VALUE_DT_ALL = 0, ZZ_VALUE_REMAIN = 0,
					 ZZ_VALUE_HAVED_SALE = 0, ZZ_VALUE_RESERVE = 0, ZZ_VALUE_IN_PROCESS = 0, ZZ_VALUE_ALLOW_SALE = 0, ZZ_VALUE_STOCK = 0, ZZ_VALUE_NOT_PLANNING_PERMIT = 0, ZZ_VALUE_NOT_CONSTRUCTION_PER = 0,
					 ZZ_VALUE_NOT_SALE_PERMIT = 0, ZZ_VALUE_NOT_COMPLETION = 0, ZZ_VALUE_YES_COMPLETION = 0, ZZ_VALUE_YES_SETTLEMENT = 0, ZZ_AREA_DT_ALL = 0, ZZ_AREA_REMAIN = 0, ZZ_AREA_HAVED_SALE = 0,
					 ZZ_AREA_RESERVE = 0, ZZ_AREA_IN_PROCESS = 0, ZZ_AREA_ALLOW_SALE = 0, ZZ_AREA_STOCK = 0, ZZ_AREA_NOT_PLANNING_PERMIT = 0, ZZ_AREA_NOT_CONSTRUCTION_PER = 0, ZZ_AREA_NOT_SALE_PERMIT = 0,
					 ZZ_AREA_NOT_COMPLETION = 0, ZZ_AREA_YES_COMPLETION = 0, ZZ_AREA_YES_SETTLEMENT = 0, SY_VALUE_DT_ALL = 0, SY_VALUE_REMAIN = 0, SY_VALUE_HAVED_SALE = 0, SY_VALUE_RESERVE = 0,
					 SY_VALUE_IN_PROCESS = 0, SY_VALUE_ALLOW_SALE = 0, SY_VALUE_STOCK = 0, SY_VALUE_NOT_PLANNING_PERMIT = 0, SY_VALUE_NOT_CONSTRUCTION_PER = 0, SY_VALUE_NOT_SALE_PERMIT = 0,
					 SY_VALUE_NOT_COMPLETION = 0, SY_VALUE_YES_COMPLETION = 0, SY_VALUE_YES_SETTLEMENT = 0, SY_AREA_DT_ALL = 0, SY_AREA_REMAIN = 0, SY_AREA_HAVED_SALE = 0, SY_AREA_RESERVE = 0,
					 SY_AREA_IN_PROCESS = 0, SY_AREA_ALLOW_SALE = 0, SY_AREA_STOCK = 0, SY_AREA_NOT_PLANNING_PERMIT = 0, SY_AREA_NOT_CONSTRUCTION_PER = 0, SY_AREA_NOT_SALE_PERMIT = 0, SY_AREA_NOT_COMPLETION = 0,
					 SY_AREA_YES_COMPLETION = 0, SY_AREA_YES_SETTLEMENT = 0
		WHERE  A.OBJ_TYPE = '楼栋';
		/*
      -- 车位相关属性及货量更新
      -- Wangck,20200406
    */
		OPEN CUR_CW_BLD_LIST;
		LOOP
				FETCH CUR_CW_BLD_LIST
						INTO ITEM_CW_BLD_LIST;

				I := I + 1;
				DBMS_OUTPUT.PUT_LINE('【' || TO_CHAR(I) || '】' || ITEM_CW_BLD_LIST.BLD_ID || 'WORKED');
				EXIT WHEN CUR_CW_BLD_LIST%NOTFOUND;
				--规划许可证阶段货量更新
				IF ITEM_CW_BLD_LIST.PHASE_ID = '987b3331-8b68-3c60-e053-0100007fd322'
				THEN
						UPDATE DWM_DT_VALUE A
						SET    (A.CW_AREA_IN_PROCESS, A.CW_AREA_NOT_CONSTRUCTION_PER) =
										(SELECT P.UNDERGROUND_TOTAL_SALE_CARPORT, P.UNDERGROUND_TOTAL_SALE_CARPORT FROM MDM_OBJ_PHASE_INDEX P WHERE P.OBJ_PHASE_ID = ITEM_CW_BLD_LIST.OBJ_PHASE_ID)
						WHERE  A.OBJ_ID = ITEM_CW_BLD_LIST.BLD_ID;
						--施工许可证阶段货量更新
				ELSIF ITEM_CW_BLD_LIST.PHASE_ID = '987b3331-8b69-3c60-e053-0100007fd322'
				THEN
						UPDATE DWM_DT_VALUE A
						SET    (A.CW_AREA_IN_PROCESS, A.CW_AREA_NOT_SALE_PERMIT) =
										(SELECT P.UNDERGROUND_TOTAL_SALE_CARPORT, P.UNDERGROUND_TOTAL_SALE_CARPORT FROM MDM_OBJ_PHASE_INDEX P WHERE P.OBJ_PHASE_ID = ITEM_CW_BLD_LIST.OBJ_PHASE_ID)
						WHERE  A.OBJ_ID = ITEM_CW_BLD_LIST.BLD_ID;
						--预售许可证阶段货量更新
				ELSIF ITEM_CW_BLD_LIST.PHASE_ID = '987b3331-8b6a-3c60-e053-0100007fd322'
				THEN
						UPDATE DWM_DT_VALUE A
						SET    (A.CW_AREA_ALLOW_SALE, A.CW_AREA_NOT_COMPLETION) =
										(SELECT P.UNDERGROUND_TOTAL_SALE_CARPORT, P.UNDERGROUND_TOTAL_SALE_CARPORT FROM MDM_OBJ_PHASE_INDEX P WHERE P.OBJ_PHASE_ID = ITEM_CW_BLD_LIST.OBJ_PHASE_ID)
						WHERE  A.OBJ_ID = ITEM_CW_BLD_LIST.BLD_ID;
						--竣工备案证阶段货量更新
				ELSIF ITEM_CW_BLD_LIST.PHASE_ID = '987b3331-8b6b-3c60-e053-0100007fd322'
				THEN
						UPDATE DWM_DT_VALUE A
						SET    (A.CW_AREA_ALLOW_SALE, A.CW_AREA_YES_COMPLETION) =
										(SELECT P.UNDERGROUND_TOTAL_SALE_CARPORT, P.UNDERGROUND_TOTAL_SALE_CARPORT FROM MDM_OBJ_PHASE_INDEX P WHERE P.OBJ_PHASE_ID = ITEM_CW_BLD_LIST.OBJ_PHASE_ID)
						WHERE  A.OBJ_ID = ITEM_CW_BLD_LIST.BLD_ID;
						--结转阶段货量更新
				ELSIF ITEM_CW_BLD_LIST.PHASE_ID = '987b3331-8b6c-3c60-e053-0100007fd322'
				THEN
						UPDATE DWM_DT_VALUE A
						SET    (A.CW_AREA_ALLOW_SALE, A.CW_AREA_YES_SETTLEMENT) =
										(SELECT P.UNDERGROUND_TOTAL_SALE_CARPORT, P.UNDERGROUND_TOTAL_SALE_CARPORT FROM MDM_OBJ_PHASE_INDEX P WHERE P.OBJ_PHASE_ID = ITEM_CW_BLD_LIST.OBJ_PHASE_ID)
						WHERE  A.OBJ_ID = ITEM_CW_BLD_LIST.BLD_ID;
				ELSE
						DBMS_OUTPUT.PUT_LINE(ITEM_CW_BLD_LIST.BLD_ID || 'Worng');
				END IF;

				--是否车位属性更新
				UPDATE DWM_DT_VALUE A SET A.OBJ_IS_PARKING = '是' WHERE A.OBJ_ID = ITEM_CW_BLD_LIST.BLD_ID;
				--是否可售属性更新
				IF ITEM_CW_BLD_LIST.OPERATE_ATTRIBUTE_NAME = '可售'
				THEN
						UPDATE DWM_DT_VALUE A SET A.OBJ_IS_SALE = '是' WHERE A.OBJ_ID = ITEM_CW_BLD_LIST.BLD_ID;
				ELSIF ITEM_CW_BLD_LIST.OPERATE_ATTRIBUTE_NAME <> '可售'
				THEN
						UPDATE DWM_DT_VALUE A SET A.OBJ_IS_SALE = '否' WHERE A.OBJ_ID = ITEM_CW_BLD_LIST.BLD_ID;
				END IF;
				--是否自持属性更新
				IF ITEM_CW_BLD_LIST.OPERATE_ATTRIBUTE_NAME = '自持'
				THEN
						UPDATE DWM_DT_VALUE A SET A.OBJ_IS_HOLD = '是' WHERE A.OBJ_ID = ITEM_CW_BLD_LIST.BLD_ID;
				ELSIF ITEM_CW_BLD_LIST.OPERATE_ATTRIBUTE_NAME = '持有'
				THEN
						UPDATE DWM_DT_VALUE A SET A.OBJ_IS_HOLD = '是' WHERE A.OBJ_ID = ITEM_CW_BLD_LIST.BLD_ID;
				ELSE
						UPDATE DWM_DT_VALUE A SET A.OBJ_IS_HOLD = '否' WHERE A.OBJ_ID = ITEM_CW_BLD_LIST.BLD_ID;
				END IF;
		END LOOP;
		CLOSE CUR_CW_BLD_LIST;
		COMMIT;

		/*
        住宅相关属性及货量更新
        Wangck,20200406
    */
		OPEN CUR_ZZ_BLD_LIST;
		LOOP
				FETCH CUR_ZZ_BLD_LIST
						INTO ITEM_ZZ_BLD_LIST;
				EXIT WHEN CUR_ZZ_BLD_LIST%NOTFOUND;

				--规证阶段货量更新

				IF ITEM_ZZ_BLD_LIST.PHASE_ID = '987b3331-8b68-3c60-e053-0100007fd322'
				THEN
						UPDATE DWM_DT_VALUE A
						SET    (A.ZZ_AREA_NOT_CONSTRUCTION_PER, A.ZZ_AREA_IN_PROCESS) =
										(SELECT P.TOTAL_SALE_AREA, P.TOTAL_SALE_AREA FROM MDM_OBJ_PHASE_INDEX P WHERE P.OBJ_PHASE_ID = ITEM_ZZ_BLD_LIST.OBJ_PHASE_ID)
						WHERE  A.OBJ_ID = ITEM_ZZ_BLD_LIST.BLD_ID;
						--施工许可证阶段货量更新
				ELSIF ITEM_ZZ_BLD_LIST.PHASE_ID = '987b3331-8b69-3c60-e053-0100007fd322'
				THEN
						UPDATE DWM_DT_VALUE A
						SET    (A.ZZ_AREA_NOT_SALE_PERMIT, A.ZZ_AREA_IN_PROCESS) =
										(SELECT P.TOTAL_SALE_AREA, P.TOTAL_SALE_AREA FROM MDM_OBJ_PHASE_INDEX P WHERE P.OBJ_PHASE_ID = ITEM_ZZ_BLD_LIST.OBJ_PHASE_ID)
						WHERE  A.OBJ_ID = ITEM_ZZ_BLD_LIST.BLD_ID;
						--预售许可证阶段货量更新
				ELSIF ITEM_ZZ_BLD_LIST.PHASE_ID = '987b3331-8b6a-3c60-e053-0100007fd322'
				THEN
						UPDATE DWM_DT_VALUE A
						SET    (A.ZZ_AREA_NOT_COMPLETION, A.ZZ_AREA_ALLOW_SALE) =
										(SELECT P.TOTAL_SALE_AREA, P.TOTAL_SALE_AREA FROM MDM_OBJ_PHASE_INDEX P WHERE P.OBJ_PHASE_ID = ITEM_ZZ_BLD_LIST.OBJ_PHASE_ID)
						WHERE  A.OBJ_ID = ITEM_ZZ_BLD_LIST.BLD_ID;
						----竣工备案证阶段货量更新
				ELSIF ITEM_ZZ_BLD_LIST.PHASE_ID = '987b3331-8b6b-3c60-e053-0100007fd322'
				THEN
						UPDATE DWM_DT_VALUE A
						SET    (A.ZZ_AREA_YES_COMPLETION, A.ZZ_AREA_ALLOW_SALE) =
										(SELECT P.TOTAL_SALE_AREA, P.TOTAL_SALE_AREA FROM MDM_OBJ_PHASE_INDEX P WHERE P.OBJ_PHASE_ID = ITEM_ZZ_BLD_LIST.OBJ_PHASE_ID)
						WHERE  A.OBJ_ID = ITEM_ZZ_BLD_LIST.BLD_ID;
						----结转阶段货量更新
				ELSIF ITEM_ZZ_BLD_LIST.PHASE_ID = '987b3331-8b6c-3c60-e053-0100007fd322'
				THEN
						UPDATE DWM_DT_VALUE A
						SET    (A.ZZ_AREA_YES_SETTLEMENT, A.ZZ_AREA_ALLOW_SALE) =
										(SELECT P.TOTAL_SALE_AREA, P.TOTAL_SALE_AREA FROM MDM_OBJ_PHASE_INDEX P WHERE P.OBJ_PHASE_ID = ITEM_ZZ_BLD_LIST.OBJ_PHASE_ID)
						WHERE  A.OBJ_ID = ITEM_ZZ_BLD_LIST.BLD_ID;
				ELSE
						CONTINUE;
				END IF;

				--是否车位属性更新
				UPDATE DWM_DT_VALUE A SET A.OBJ_IS_PARKING = '否' WHERE A.OBJ_ID = ITEM_ZZ_BLD_LIST.BLD_ID;
				--是否可售属性更新
				IF ITEM_ZZ_BLD_LIST.OPERATE_ATTRIBUTE_NAME = '可售'
				THEN
						UPDATE DWM_DT_VALUE A SET A.OBJ_IS_SALE = '是' WHERE A.OBJ_ID = ITEM_ZZ_BLD_LIST.BLD_ID;
				ELSIF ITEM_ZZ_BLD_LIST.OPERATE_ATTRIBUTE_NAME <> '可售'
				THEN
						UPDATE DWM_DT_VALUE A SET A.OBJ_IS_SALE = '否' WHERE A.OBJ_ID = ITEM_ZZ_BLD_LIST.BLD_ID;
				END IF;
				--是否自持属性更新
				IF ITEM_ZZ_BLD_LIST.OPERATE_ATTRIBUTE_NAME = '自持'
				THEN
						UPDATE DWM_DT_VALUE A SET A.OBJ_IS_HOLD = '是' WHERE A.OBJ_ID = ITEM_ZZ_BLD_LIST.BLD_ID;
				ELSIF ITEM_ZZ_BLD_LIST.OPERATE_ATTRIBUTE_NAME = '持有'
				THEN
						UPDATE DWM_DT_VALUE A SET A.OBJ_IS_HOLD = '是' WHERE A.OBJ_ID = ITEM_ZZ_BLD_LIST.BLD_ID;
				ELSE
						UPDATE DWM_DT_VALUE A SET A.OBJ_IS_HOLD = '否' WHERE A.OBJ_ID = ITEM_ZZ_BLD_LIST.BLD_ID;
				END IF;

		END LOOP;
		COMMIT;
		CLOSE CUR_ZZ_BLD_LIST;

		/*
        商业相关属性及货量更新
        Wangck,20200406
    */

		OPEN CUR_SY_BLD_LIST;
		LOOP
				FETCH CUR_SY_BLD_LIST
						INTO ITEM_SY_BLD_LIST;
				EXIT WHEN CUR_SY_BLD_LIST%NOTFOUND;

				IF ITEM_SY_BLD_LIST.PHASE_ID = '987b3331-8b68-3c60-e053-0100007fd322'
				THEN
						UPDATE DWM_DT_VALUE A
						SET    (A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_IN_PROCESS) =
										(SELECT P.TOTAL_SALE_AREA, P.TOTAL_SALE_AREA FROM MDM_OBJ_PHASE_INDEX P WHERE P.OBJ_PHASE_ID = ITEM_SY_BLD_LIST.OBJ_PHASE_ID)
						WHERE  A.OBJ_ID = ITEM_SY_BLD_LIST.BLD_ID;
						--施工许可证阶段货量更新
				ELSIF ITEM_SY_BLD_LIST.PHASE_ID = '987b3331-8b69-3c60-e053-0100007fd322'
				THEN
						UPDATE DWM_DT_VALUE A
						SET    (A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_IN_PROCESS) =
										(SELECT P.TOTAL_SALE_AREA, P.TOTAL_SALE_AREA FROM MDM_OBJ_PHASE_INDEX P WHERE P.OBJ_PHASE_ID = ITEM_SY_BLD_LIST.OBJ_PHASE_ID)
						WHERE  A.OBJ_ID = ITEM_SY_BLD_LIST.BLD_ID;
						--预售许可证阶段货量更新
				ELSIF ITEM_SY_BLD_LIST.PHASE_ID = '987b3331-8b6a-3c60-e053-0100007fd322'
				THEN
						UPDATE DWM_DT_VALUE A
						SET    (A.SY_AREA_NOT_COMPLETION, A.SY_AREA_ALLOW_SALE) =
										(SELECT P.TOTAL_SALE_AREA, P.TOTAL_SALE_AREA FROM MDM_OBJ_PHASE_INDEX P WHERE P.OBJ_PHASE_ID = ITEM_SY_BLD_LIST.OBJ_PHASE_ID)
						WHERE  A.OBJ_ID = ITEM_SY_BLD_LIST.BLD_ID;
						----竣工备案证阶段货量更新
				ELSIF ITEM_SY_BLD_LIST.PHASE_ID = '987b3331-8b6b-3c60-e053-0100007fd322'
				THEN
						UPDATE DWM_DT_VALUE A
						SET    (A.SY_AREA_YES_COMPLETION, A.SY_AREA_ALLOW_SALE) =
										(SELECT P.TOTAL_SALE_AREA, P.TOTAL_SALE_AREA FROM MDM_OBJ_PHASE_INDEX P WHERE P.OBJ_PHASE_ID = ITEM_SY_BLD_LIST.OBJ_PHASE_ID)
						WHERE  A.OBJ_ID = ITEM_SY_BLD_LIST.BLD_ID;
						----结转阶段货量更新
				ELSIF ITEM_SY_BLD_LIST.PHASE_ID = '987b3331-8b6c-3c60-e053-0100007fd322'
				THEN
						UPDATE DWM_DT_VALUE A
						SET    (A.SY_AREA_YES_SETTLEMENT, A.SY_AREA_ALLOW_SALE) =
										(SELECT P.TOTAL_SALE_AREA, P.TOTAL_SALE_AREA FROM MDM_OBJ_PHASE_INDEX P WHERE P.OBJ_PHASE_ID = ITEM_SY_BLD_LIST.OBJ_PHASE_ID)
						WHERE  A.OBJ_ID = ITEM_SY_BLD_LIST.BLD_ID;
				ELSE
						CONTINUE;
				END IF;

				--是否车位属性更新
				UPDATE DWM_DT_VALUE A SET A.OBJ_IS_PARKING = '否' WHERE A.OBJ_ID = ITEM_SY_BLD_LIST.BLD_ID;
				--是否可售属性更新
				IF ITEM_SY_BLD_LIST.OPERATE_ATTRIBUTE_NAME = '可售'
				THEN
						UPDATE DWM_DT_VALUE A SET A.OBJ_IS_SALE = '是' WHERE A.OBJ_ID = ITEM_SY_BLD_LIST.BLD_ID;
				ELSIF ITEM_SY_BLD_LIST.OPERATE_ATTRIBUTE_NAME <> '可售'
				THEN
						UPDATE DWM_DT_VALUE A SET A.OBJ_IS_SALE = '否' WHERE A.OBJ_ID = ITEM_SY_BLD_LIST.BLD_ID;
				END IF;
				--是否自持属性更新
				IF ITEM_SY_BLD_LIST.OPERATE_ATTRIBUTE_NAME = '自持'
				THEN
						UPDATE DWM_DT_VALUE A SET A.OBJ_IS_HOLD = '是' WHERE A.OBJ_ID = ITEM_SY_BLD_LIST.BLD_ID;
				ELSIF ITEM_SY_BLD_LIST.OPERATE_ATTRIBUTE_NAME = '持有'
				THEN
						UPDATE DWM_DT_VALUE A SET A.OBJ_IS_HOLD = '是' WHERE A.OBJ_ID = ITEM_SY_BLD_LIST.BLD_ID;
				ELSE
						UPDATE DWM_DT_VALUE A SET A.OBJ_IS_HOLD = '否' WHERE A.OBJ_ID = ITEM_SY_BLD_LIST.BLD_ID;
				END IF;

		END LOOP;
		COMMIT;

		CLOSE CUR_SY_BLD_LIST;
		--楼栋货量更新
		UPDATE DWM_DT_VALUE A
		SET    A.AREA_ALLOW_SALE = NVL(A.CW_AREA_ALLOW_SALE, 0) + NVL(A.ZZ_AREA_ALLOW_SALE, 0) + NVL(A.SY_AREA_ALLOW_SALE, 0),
					 A.AREA_IN_PROCESS = NVL(A.CW_AREA_IN_PROCESS, 0) + NVL(A.ZZ_AREA_IN_PROCESS, 0) + NVL(A.SY_AREA_IN_PROCESS, 0),
					 A.AREA_NOT_CONSTRUCTION_PERMIT = NVL(A.CW_AREA_NOT_CONSTRUCTION_PER, 0) + NVL(A.ZZ_AREA_NOT_CONSTRUCTION_PER, 0) + NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0),
					 A.AREA_NOT_SALE_PERMIT = NVL(A.CW_AREA_NOT_SALE_PERMIT, 0) + NVL(A.ZZ_AREA_NOT_SALE_PERMIT, 0) + NVL(A.SY_AREA_NOT_SALE_PERMIT, 0),
					 A.AREA_NOT_COMPLETION = NVL(A.CW_AREA_NOT_COMPLETION, 0) + NVL(A.ZZ_AREA_NOT_COMPLETION, 0) + NVL(A.SY_AREA_NOT_COMPLETION, 0),
					 A.AREA_YES_COMPLETION = NVL(A.CW_AREA_YES_COMPLETION, 0) + NVL(A.ZZ_AREA_YES_COMPLETION, 0) + NVL(A.SY_AREA_YES_COMPLETION, 0),
					 A.AREA_YES_SETTLEMENT = NVL(A.CW_AREA_YES_SETTLEMENT, 0) + NVL(A.ZZ_AREA_YES_SETTLEMENT, 0) + NVL(A.SY_AREA_YES_SETTLEMENT, 0)
		WHERE  A.OBJ_TYPE = '楼栋';

		OPEN CUR_ROOM_LIST;
		LOOP
				FETCH CUR_ROOM_LIST
						INTO ITEM_ROOM_LIST;
				EXIT WHEN CUR_ROOM_LIST%NOTFOUND;
				--楼栋可售货量、货值更新
				UPDATE DWM_DT_VALUE P
				SET    --车位可售面积、货值更新
									 P.CW_VALUE_HAVED_SALE = ITEM_ROOM_LIST.CW已售货值_房间合计, P.CW_VALUE_STOCK = ITEM_ROOM_LIST.CW库存货值_房间合计, P.CW_AREA_HAVED_SALE = ITEM_ROOM_LIST.CW已售套数_房间合计,
							 P.CW_AREA_STOCK = ITEM_ROOM_LIST.CW库存套数_房间合计, P.CW_VALUE_ALLOW_SALE = NVL(ITEM_ROOM_LIST.CW已售货值_房间合计, 0) + NVL(ITEM_ROOM_LIST.CW库存货值_房间合计, 0),
							 P.CW_AREA_ALLOW_SALE = NVL(ITEM_ROOM_LIST.CW已售套数_房间合计, 0) + NVL(ITEM_ROOM_LIST.CW库存套数_房间合计, 0),
							 P.CW_VALUE_NOT_COMPLETION = NVL(ITEM_ROOM_LIST.CW库存货值_房间合计, 0) + NVL(ITEM_ROOM_LIST.CW已售货值_房间合计, 0) - NVL(ITEM_ROOM_LIST.CW结转货值_房间合计, 0) - NVL(ITEM_ROOM_LIST.CW已竣备货值_房间合计, 0),
							 P.CW_VALUE_YES_COMPLETION = ITEM_ROOM_LIST.CW已竣备货值_房间合计, P.CW_VALUE_YES_SETTLEMENT = NVL(ITEM_ROOM_LIST.CW结转货值_房间合计, 0),
							 P.CW_AREA_NOT_COMPLETION = NVL(ITEM_ROOM_LIST.CW库存套数_房间合计, 0) + NVL(ITEM_ROOM_LIST.CW已售套数_房间合计, 0) - NVL(ITEM_ROOM_LIST.CW已竣备套数_房间合计, 0) - NVL(ITEM_ROOM_LIST.CW结转货量_房间合计, 0),
							 P.CW_AREA_YES_COMPLETION = NVL(ITEM_ROOM_LIST.CW已竣备套数_房间合计, 0), P.CW_AREA_YES_SETTLEMENT = NVL(ITEM_ROOM_LIST.CW结转货量_房间合计, 0),
							 --住宅可售面积、货值更新
							 P.ZZ_VALUE_HAVED_SALE = ITEM_ROOM_LIST.ZZ已售货值_房间合计, P.ZZ_VALUE_STOCK = ITEM_ROOM_LIST.ZZ库存货值_房间合计, P.ZZ_AREA_HAVED_SALE = ITEM_ROOM_LIST.ZZ已售面积_房间合计,
							 P.ZZ_AREA_STOCK = ITEM_ROOM_LIST.ZZ库存面积_房间合计, P.ZZ_VALUE_ALLOW_SALE = NVL(ITEM_ROOM_LIST.ZZ已售货值_房间合计, 0) + NVL(ITEM_ROOM_LIST.ZZ库存货值_房间合计, 0),
							 P.ZZ_AREA_ALLOW_SALE = NVL(ITEM_ROOM_LIST.ZZ已售面积_房间合计, 0) + NVL(ITEM_ROOM_LIST.ZZ库存面积_房间合计, 0),
							 P.ZZ_VALUE_NOT_COMPLETION = NVL(ITEM_ROOM_LIST.ZZ库存货值_房间合计, 0) + NVL(ITEM_ROOM_LIST.ZZ已售货值_房间合计, 0) - NVL(ITEM_ROOM_LIST.ZZ竣备货值_房间合计, 0) - NVL(ITEM_ROOM_LIST.ZZ结转货值_房间合计, 0),
							 P.ZZ_VALUE_YES_COMPLETION = NVL(ITEM_ROOM_LIST.ZZ竣备货值_房间合计, 0), P.ZZ_VALUE_YES_SETTLEMENT = NVL(ITEM_ROOM_LIST.ZZ结转货值_房间合计, 0),
							 P.ZZ_AREA_NOT_COMPLETION = NVL(ITEM_ROOM_LIST.ZZ库存面积_房间合计, 0) + NVL(ITEM_ROOM_LIST.ZZ已售货值_房间合计, 0) - NVL(ITEM_ROOM_LIST.ZZ结转货量_房间合计, 0) - NVL(ITEM_ROOM_LIST.ZZ竣备面积_房间合计, 0),
							 P.ZZ_AREA_YES_COMPLETION = NVL(ITEM_ROOM_LIST.ZZ竣备面积_房间合计, 0), P.ZZ_AREA_YES_SETTLEMENT = NVL(ITEM_ROOM_LIST.ZZ结转货量_房间合计, 0),
							 --商业可售面积、货值更新
							 P.SY_VALUE_HAVED_SALE = ITEM_ROOM_LIST.SY已售货值_房间合计, P.SY_VALUE_STOCK = ITEM_ROOM_LIST.SY库存货值_房间合计, P.SY_AREA_HAVED_SALE = ITEM_ROOM_LIST.SY已售面积_房间合计,
							 P.SY_AREA_STOCK = ITEM_ROOM_LIST.SY库存面积_房间合计, P.SY_VALUE_ALLOW_SALE = NVL(ITEM_ROOM_LIST.SY已售货值_房间合计, 0) + NVL(ITEM_ROOM_LIST.SY库存货值_房间合计, 0),
							 P.SY_AREA_ALLOW_SALE = NVL(ITEM_ROOM_LIST.SY库存面积_房间合计, 0) + NVL(ITEM_ROOM_LIST.SY已售面积_房间合计, 0),
							 P.SY_VALUE_NOT_COMPLETION = NVL(ITEM_ROOM_LIST.SY已售货值_房间合计, 0) + NVL(ITEM_ROOM_LIST.SY库存货值_房间合计, 0) - NVL(ITEM_ROOM_LIST.SY竣备货值_房间合计, 0) - NVL(ITEM_ROOM_LIST.SY结转货值_房间合计, 0),
							 P.SY_VALUE_YES_COMPLETION = NVL(ITEM_ROOM_LIST.SY竣备货值_房间合计, 0), P.SY_VALUE_YES_SETTLEMENT = NVL(ITEM_ROOM_LIST.SY结转货值_房间合计, 0),
							 P.SY_AREA_NOT_COMPLETION = NVL(ITEM_ROOM_LIST.SY已售面积_房间合计, 0) + NVL(ITEM_ROOM_LIST.SY库存面积_房间合计, 0) - NVL(ITEM_ROOM_LIST.SY竣备面积_房间合计, 0) - NVL(ITEM_ROOM_LIST.SY结转货量_房间合计, 0),
							 P.SY_AREA_YES_COMPLETION = NVL(ITEM_ROOM_LIST.SY竣备面积_房间合计, 0), P.SY_AREA_YES_SETTLEMENT = NVL(ITEM_ROOM_LIST.SY结转货量_房间合计, 0),
							 --可售面积、货值更新
							 P.VALUE_HAVED_SALE = NVL(ITEM_ROOM_LIST.CW已售货值_房间合计, 0) + NVL(ITEM_ROOM_LIST.ZZ已售货值_房间合计, 0) + NVL(ITEM_ROOM_LIST.SY已售货值_房间合计, 0),
							 P.VALUE_STOCK = NVL(ITEM_ROOM_LIST.CW库存货值_房间合计, 0) + NVL(ITEM_ROOM_LIST.ZZ库存货值_房间合计, 0) + NVL(ITEM_ROOM_LIST.SY库存货值_房间合计, 0),
							 P.AREA_HAVED_SALE = NVL(ITEM_ROOM_LIST.ZZ已售面积_房间合计, 0) + NVL(ITEM_ROOM_LIST.SY已售面积_房间合计, 0), P.AREA_STOCK = NVL(ITEM_ROOM_LIST.ZZ库存面积_房间合计, 0) + NVL(ITEM_ROOM_LIST.SY库存面积_房间合计, 0),
							 P.VALUE_ALLOW_SALE = NVL(ITEM_ROOM_LIST.CW已售货值_房间合计, 0) + NVL(ITEM_ROOM_LIST.ZZ已售货值_房间合计, 0) + NVL(ITEM_ROOM_LIST.SY已售货值_房间合计, 0) + NVL(ITEM_ROOM_LIST.CW库存货值_房间合计, 0) +
																		 NVL(ITEM_ROOM_LIST.ZZ库存货值_房间合计, 0) + NVL(ITEM_ROOM_LIST.SY库存货值_房间合计, 0),
							 P.AREA_ALLOW_SALE = NVL(ITEM_ROOM_LIST.ZZ已售面积_房间合计, 0) + NVL(ITEM_ROOM_LIST.SY已售面积_房间合计, 0) + NVL(ITEM_ROOM_LIST.ZZ库存面积_房间合计, 0) + NVL(ITEM_ROOM_LIST.SY库存面积_房间合计, 0),
							 P.VALUE_NOT_COMPLETION = NVL(ITEM_ROOM_LIST.ZZ库存货值_房间合计, 0) + NVL(ITEM_ROOM_LIST.ZZ已售货值_房间合计, 0) - NVL(ITEM_ROOM_LIST.ZZ竣备货值_房间合计, 0) - NVL(ITEM_ROOM_LIST.ZZ结转货值_房间合计, 0) +
																				 NVL(ITEM_ROOM_LIST.CW库存货值_房间合计, 0) + NVL(ITEM_ROOM_LIST.CW已售货值_房间合计, 0) - NVL(ITEM_ROOM_LIST.CW结转货值_房间合计, 0) - NVL(ITEM_ROOM_LIST.CW已竣备货值_房间合计, 0) +
																				 NVL(ITEM_ROOM_LIST.SY已售货值_房间合计, 0) + NVL(ITEM_ROOM_LIST.SY库存货值_房间合计, 0) - NVL(ITEM_ROOM_LIST.SY竣备货值_房间合计, 0) - NVL(ITEM_ROOM_LIST.SY结转货值_房间合计, 0),
							 P.VALUE_YES_COMPLETION = NVL(ITEM_ROOM_LIST.CW已竣备货值_房间合计, 0) + NVL(ITEM_ROOM_LIST.ZZ竣备货值_房间合计, 0) + NVL(ITEM_ROOM_LIST.SY竣备货值_房间合计, 0),
							 P.VALUE_YES_SETTLEMENT = NVL(ITEM_ROOM_LIST.CW结转货值_房间合计, 0) + NVL(ITEM_ROOM_LIST.ZZ结转货值_房间合计, 0) + NVL(ITEM_ROOM_LIST.SY结转货值_房间合计, 0),
							 P.AREA_NOT_COMPLETION = NVL(ITEM_ROOM_LIST.CW库存套数_房间合计, 0) + NVL(ITEM_ROOM_LIST.CW已售套数_房间合计, 0) - NVL(ITEM_ROOM_LIST.CW已竣备套数_房间合计, 0) - NVL(ITEM_ROOM_LIST.CW结转货量_房间合计, 0) +
																				NVL(ITEM_ROOM_LIST.ZZ库存面积_房间合计, 0) + NVL(ITEM_ROOM_LIST.ZZ已售货值_房间合计, 0) - NVL(ITEM_ROOM_LIST.ZZ结转货量_房间合计, 0) - NVL(ITEM_ROOM_LIST.ZZ竣备面积_房间合计, 0) +
																				NVL(ITEM_ROOM_LIST.SY已售面积_房间合计, 0) + NVL(ITEM_ROOM_LIST.SY库存面积_房间合计, 0) - NVL(ITEM_ROOM_LIST.SY竣备面积_房间合计, 0) - NVL(ITEM_ROOM_LIST.SY结转货量_房间合计, 0),
							 P.AREA_YES_COMPLETION = NVL(ITEM_ROOM_LIST.CW已竣备套数_房间合计, 0) + NVL(ITEM_ROOM_LIST.ZZ竣备面积_房间合计, 0) + NVL(ITEM_ROOM_LIST.SY竣备面积_房间合计, 0),
							 P.AREA_YES_SETTLEMENT = NVL(ITEM_ROOM_LIST.CW结转货量_房间合计, 0) + NVL(ITEM_ROOM_LIST.ZZ结转货量_房间合计, 0) + NVL(ITEM_ROOM_LIST.SY结转货量_房间合计, 0)
				WHERE  P.OBJ_ID = ITEM_ROOM_LIST.BUILDING_ID;
		END LOOP;
		COMMIT;
		CLOSE CUR_ROOM_LIST;

		UPDATE DWM_DT_VALUE P
		SET    P.CW_AREA_REMAIN = NVL(P.CW_AREA_IN_PROCESS, 0) + NVL(P.CW_AREA_STOCK, 0), P.ZZ_AREA_REMAIN = NVL(P.ZZ_AREA_IN_PROCESS, 0) + NVL(P.ZZ_AREA_STOCK, 0),
					 P.SY_AREA_REMAIN = NVL(P.SY_AREA_IN_PROCESS, 0) + NVL(P.SY_AREA_STOCK, 0)
		WHERE  P.OBJ_TYPE = '楼栋';
		COMMIT;
		/*
    楼栋各阶段货值更新，注：预售证之后货值，1、若从《销售系统》中同步的数据无楼栋，则按照：货量*均价 的方式处理；2、若有楼栋数据，则按照《销售系统》中数据处理
    */
		OPEN CUR_BLD_LIST;
		LOOP
				FETCH CUR_BLD_LIST
						INTO ITEM_BLD_LIST;
				EXIT WHEN CUR_BLD_LIST%NOTFOUND;

				SELECT NVL(CASE
											 WHEN A.TARGET_NOW_NAME = '20' THEN
												A.TMP_3DT_TARGETPRICE
											 WHEN A.TARGET_NOW_NAME = '10' THEN
												A.TMP_2QP_PRICE
											 WHEN A.TARGET_NOW_NAME = '0' THEN
												A.TMP_1KY_PRICE
											 ELSE
												NULL
									 END, 0)
				INTO   V_TARGET_PRICE
				FROM   DWM_DT_VALUE A
				WHERE  A.ID = ITEM_BLD_LIST.ID;

				IF NVL(ITEM_BLD_LIST.VALUE_ALLOW_SALE, 0) = 0
				THEN
						UPDATE DWM_DT_VALUE A
						SET    --货值更新
											 A.VALUE_ALLOW_SALE = A.AREA_ALLOW_SALE * V_TARGET_PRICE, A.VALUE_IN_PROCESS = A.AREA_IN_PROCESS * V_TARGET_PRICE,
									 A.VALUE_NOT_CONSTRUCTION_PERMIT = A.AREA_NOT_CONSTRUCTION_PERMIT * V_TARGET_PRICE, A.VALUE_NOT_SALE_PERMIT = A.AREA_NOT_SALE_PERMIT * V_TARGET_PRICE,
									 A.VALUE_NOT_COMPLETION = A.AREA_NOT_COMPLETION * V_TARGET_PRICE, A.VALUE_YES_COMPLETION = A.AREA_YES_COMPLETION * V_TARGET_PRICE,
									 A.VALUE_YES_SETTLEMENT = A.AREA_YES_SETTLEMENT * V_TARGET_PRICE,
									 --车位货值更新
									 A.CW_VALUE_ALLOW_SALE = A.CW_AREA_ALLOW_SALE * V_TARGET_PRICE

									, A.CW_VALUE_IN_PROCESS = A.CW_AREA_IN_PROCESS * V_TARGET_PRICE,

									 A.CW_VALUE_NOT_CONSTRUCTION_PER = A.CW_AREA_NOT_CONSTRUCTION_PER * V_TARGET_PRICE, A.CW_VALUE_NOT_SALE_PERMIT = A.CW_AREA_NOT_SALE_PERMIT * V_TARGET_PRICE,

									 A.CW_VALUE_NOT_COMPLETION = A.CW_AREA_NOT_COMPLETION * V_TARGET_PRICE, A.CW_VALUE_YES_COMPLETION = A.CW_AREA_YES_COMPLETION * V_TARGET_PRICE,

									 A.CW_VALUE_YES_SETTLEMENT = A.CW_AREA_YES_SETTLEMENT * V_TARGET_PRICE,
									 --住宅货值更新
									 A.ZZ_VALUE_ALLOW_SALE = A.ZZ_AREA_ALLOW_SALE * V_TARGET_PRICE, A.ZZ_VALUE_IN_PROCESS = A.ZZ_AREA_IN_PROCESS * V_TARGET_PRICE,
									 A.ZZ_VALUE_NOT_CONSTRUCTION_PER = A.ZZ_AREA_NOT_CONSTRUCTION_PER * V_TARGET_PRICE, A.ZZ_VALUE_NOT_SALE_PERMIT = A.ZZ_AREA_NOT_SALE_PERMIT * V_TARGET_PRICE,
									 A.ZZ_VALUE_NOT_COMPLETION = A.ZZ_AREA_NOT_COMPLETION * V_TARGET_PRICE, A.ZZ_VALUE_YES_COMPLETION = A.ZZ_AREA_YES_COMPLETION * V_TARGET_PRICE,
									 A.ZZ_VALUE_YES_SETTLEMENT = A.ZZ_AREA_YES_SETTLEMENT * V_TARGET_PRICE,
									 --商业货值更新
									 A.SY_VALUE_ALLOW_SALE = A.SY_AREA_ALLOW_SALE * V_TARGET_PRICE, A.SY_VALUE_IN_PROCESS = A.SY_AREA_IN_PROCESS * V_TARGET_PRICE,
									 A.SY_VALUE_NOT_CONSTRUCTION_PER = A.SY_AREA_NOT_CONSTRUCTION_PER * V_TARGET_PRICE, A.SY_VALUE_NOT_SALE_PERMIT = A.SY_AREA_NOT_SALE_PERMIT * V_TARGET_PRICE,
									 A.SY_VALUE_NOT_COMPLETION = A.SY_AREA_NOT_COMPLETION * V_TARGET_PRICE, A.SY_VALUE_YES_COMPLETION = A.SY_AREA_YES_COMPLETION * V_TARGET_PRICE,
									 A.SY_VALUE_YES_SETTLEMENT = A.SY_AREA_YES_SETTLEMENT * V_TARGET_PRICE
						WHERE  A.ID = ITEM_BLD_LIST.ID;
				ELSIF NVL(ITEM_BLD_LIST.VALUE_ALLOW_SALE, 0) <> 0
				THEN
						/*--预售许可证阶段数据更新
            IF ITEM_BLD_LIST.PHASE_ID = '987b3331-8b6a-3c60-e053-0100007fd322'
            THEN
                UPDATE DWM_DT_VALUE A SET A.VALUE_NOT_SALE_PERMIT = ITEM_BLD_LIST.VALUE_ALLOW_SALE WHERE A.ID = ITEM_BLD_LIST.ID;
            END IF;*/

						UPDATE DWM_DT_VALUE A
						SET    --货值、货量数据处理
											 A.VALUE_IN_PROCESS = 0, A.VALUE_NOT_CONSTRUCTION_PERMIT = 0, A.VALUE_NOT_SALE_PERMIT = 0, A.AREA_IN_PROCESS = 0, A.AREA_NOT_CONSTRUCTION_PERMIT = 0, A.AREA_NOT_SALE_PERMIT = 0,
									 --车位货值、货量数据处理
									 A.CW_VALUE_IN_PROCESS = 0, A.CW_VALUE_NOT_CONSTRUCTION_PER = 0, A.CW_VALUE_NOT_SALE_PERMIT = 0, A.CW_AREA_IN_PROCESS = 0, A.CW_AREA_NOT_CONSTRUCTION_PER = 0,
									 A.CW_AREA_NOT_SALE_PERMIT = 0,
									 --住宅货值、货量数据处理
									 A.ZZ_VALUE_IN_PROCESS = 0, A.ZZ_VALUE_NOT_CONSTRUCTION_PER = 0, A.ZZ_VALUE_NOT_SALE_PERMIT = 0, A.ZZ_AREA_IN_PROCESS = 0, A.ZZ_AREA_NOT_CONSTRUCTION_PER = 0,
									 A.ZZ_AREA_NOT_SALE_PERMIT = 0,
									 --商业货值、货量数据处理
									 A.SY_VALUE_IN_PROCESS = 0, A.SY_VALUE_NOT_CONSTRUCTION_PER = 0, A.SY_VALUE_NOT_SALE_PERMIT = 0, A.SY_AREA_IN_PROCESS = 0, A.SY_AREA_NOT_CONSTRUCTION_PER = 0,
									 A.SY_AREA_NOT_SALE_PERMIT = 0
						WHERE  A.ID = ITEM_BLD_LIST.ID;
				END IF;
		END LOOP;
		COMMIT;
		CLOSE CUR_BLD_LIST;

		UPDATE DWM_DT_VALUE A
		SET    /*A.VALUE_DT_ALL = NVL(A.VALUE_REMAIN, 0) + NVL(A.VALUE_HAVED_SALE, 0), A.AREA_DT_ALL = NVL(A.AREA_REMAIN, 0) + NVL(A.AREA_HAVED_SALE, 0)*/ A.VALUE_REMAIN = NVL(A.VALUE_IN_PROCESS, 0) +
																																																																																						NVL(A.VALUE_STOCK, 0),
					 A.VALUE_DT_ALL = NVL(A.VALUE_IN_PROCESS, 0) + NVL(A.VALUE_STOCK, 0) + NVL(A.VALUE_HAVED_SALE, 0),
					 A.CW_VALUE_DT_ALL = NVL(A.CW_VALUE_IN_PROCESS, 0) + NVL(A.CW_VALUE_STOCK, 0) + NVL(A.CW_VALUE_HAVED_SALE, 0), A.CW_VALUE_REMAIN = NVL(A.CW_VALUE_IN_PROCESS, 0) + NVL(A.CW_VALUE_STOCK, 0),
					 A.ZZ_VALUE_DT_ALL = NVL(A.ZZ_VALUE_IN_PROCESS, 0) + NVL(A.ZZ_VALUE_STOCK, 0) + NVL(A.ZZ_VALUE_HAVED_SALE, 0), A.ZZ_VALUE_REMAIN = NVL(A.ZZ_VALUE_IN_PROCESS, 0) + NVL(A.ZZ_VALUE_STOCK, 0),
					 A.SY_VALUE_DT_ALL = NVL(A.SY_VALUE_IN_PROCESS, 0) + NVL(A.SY_VALUE_STOCK, 0) + NVL(A.SY_VALUE_HAVED_SALE, 0), A.SY_VALUE_REMAIN = NVL(A.SY_VALUE_IN_PROCESS, 0) + NVL(A.SY_VALUE_STOCK, 0)
		WHERE  A.OBJ_TYPE = '楼栋';

		COMMIT;

END;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_GET_OBJ_INFO
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_GET_OBJ_INFO" 
AS
BEGIN
INSERT INTO DWM_DT_VALUE
		(ID, OBJ_ID, OBJ_NAME, OBJ_TYPE, OBJ_IS_PARKING, OBJ_IS_SALE, OBJ_IS_HOLD, OBJ_LEVEL, PARENT_ID, PROJ_ID)
SELECT GET_UUID, A.ID, A.BUILD_NAME, '楼栋', NULL, NULL, NULL, 3, A.PERIOD_ID, A.PROJ_ID
FROM   MDM_BUILD A
WHERE  NOT EXISTS (SELECT 1
				FROM   DWM_DT_VALUE P
				WHERE  A.ID = P.OBJ_ID AND
							 P.OBJ_TYPE = '楼栋') AND
			 A.BUILD_STATE = 10;
COMMIT;

INSERT INTO DWM_DT_VALUE
		(ID, OBJ_ID, OBJ_NAME, OBJ_TYPE, OBJ_LEVEL, PARENT_ID, PROJ_ID)
		SELECT GET_UUID, A.ID, A.PROJECT_NAME, '项目', 1, NULL, A.ID
		FROM   MDM_PROJECT A
		WHERE  NOT EXISTS (SELECT 1
						FROM   DWM_DT_VALUE P
						WHERE  A.ID = P.OBJ_ID AND
									 P.OBJ_TYPE = '项目') AND
					 A.APPROVAL_STATUS = '已审核' AND
					 A.PROJECT_VERSION = (SELECT MAX(PROJECT_VERSION)
																FROM   MDM_PROJECT O
																WHERE  O.PROJECT_ORIGINAL_ID = A.PROJECT_ORIGINAL_ID AND
																			 O.APPROVAL_STATUS = '已审核');
COMMIT;

INSERT INTO DWM_DT_VALUE
		(ID, OBJ_ID, OBJ_NAME, OBJ_TYPE, OBJ_LEVEL, PARENT_ID, PROJ_ID)
		SELECT GET_UUID, C.ID, C.PERIOD_NAME, '分期', 2, A.ID, A.ID
		FROM   MDM_PROJECT A
		INNER  JOIN MDM_PERIOD_VERSION B
		ON     A.ID = B.PROJECT_ID AND
					 B.PERIOD_VERSION = (SELECT MAX(P.PERIOD_VERSION)
															 FROM   MDM_PERIOD_VERSION P
															 WHERE  B.PROJECT_ID = P.PROJECT_ID AND
																			P.APPROVAL_STATUS = '已审核')
		INNER  JOIN MDM_PERIOD C
		ON     B.ID = C.PERIOD_VERSION_ID
		WHERE  NOT EXISTS (SELECT 1 FROM DWM_DT_VALUE O WHERE O.OBJ_ID = C.ID);
COMMIT;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_GET_OBJ_TARGET_VALUE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_GET_OBJ_TARGET_VALUE" AS
		/*
      CreateBy:Wangck
      CreateDate:20200406
      Note:更新DWM_DT_VALUE表中“项目、分期、楼栋”的目标货值
    */
		CURSOR CUR_OBJ_LIST IS
				SELECT A.ID, A.OBJ_TYPE, A.OBJ_ID FROM DWM_DT_VALUE A;

		ITEM_OBJ_LIST CUR_OBJ_LIST%ROWTYPE;

		V_TARGET_ID VARCHAR(50);

BEGIN
		/*
    --可研目标货值ID更新
    UPDATE DWM_DT_VALUE P
    SET    P.TARGET_A1_ID =
            (SELECT B.ID
             FROM   DWM_DT_VALUE A
             INNER  JOIN DWM_TARGET_WORTH B
             ON     A.PROJ_ID = B.PROJ_ID AND
                    B.IS_DELETE = 0
             WHERE  B.TARGET_WORTH_PHASE = 0 AND
                    P.ID = A.ID)
    WHERE  P.TARGET_A1_ID IS NULL;
    --全盘目标货值ID更新
    UPDATE DWM_DT_VALUE P
    SET    P.TARGET_A2_ID =
            (SELECT B.ID
             FROM   DWM_DT_VALUE A
             INNER  JOIN DWM_TARGET_WORTH B
             ON     A.PROJ_ID = B.PROJ_ID AND
                    B.IS_DELETE = 0
             WHERE  B.TARGET_WORTH_PHASE = 10 AND
                    P.ID = A.ID)
    WHERE  P.TARGET_A2_ID IS NULL;
    
    --动态版目标货值ID更新
    UPDATE DWM_DT_VALUE P
    SET    P.TARGET_A3_ID =
            (SELECT B.ID
             FROM   DWM_DT_VALUE A
             INNER  JOIN DWM_TARGET_WORTH B
             ON     A.PROJ_ID = B.PROJ_ID AND
                    B.IS_DELETE = 0 AND
                    B.TARGET_WORTH_PHASE = 20 AND
                    B.WORTH_V = (SELECT MAX(O.WORTH_V)
                                 FROM   DWM_TARGET_WORTH O
                                 WHERE  O.PROJ_ID = B.PROJ_ID AND
                                        O.TARGET_WORTH_PHASE = 20)
             WHERE  P.ID = A.ID)
    WHERE  P.TARGET_A3_ID IS NULL;
    
    COMMIT;*/
		--更新动态货值ID

		--更新可研版目标货值
		UPDATE DWM_DT_VALUE PP
		SET    (PP.TMP_1KY_VALUE, PP.TMP_1KY_AREA, PP.TMP_1KY_PRICE, PP.TARGET_A1_VALUE, PP.TARGET_A1_ID) =
						(SELECT C.WORTH * 10000, C.TOTAL_SALES_AREA,
										CASE
												WHEN NVL(C.TOTAL_SALES_AREA, 0) = 0 THEN
												 0
												ELSE
												 ROUND(C.WORTH * 10000 / C.TOTAL_SALES_AREA, 2)
										END, C.WORTH, C.TARGET_WORTH_ID
						 FROM   DWM_DT_VALUE A
						 INNER  JOIN DWM_TARGET_WORTH B
						 ON     A.TARGET_A1_ID = B.ID AND
										B.IS_DELETE = 0
						 INNER  JOIN DWM_TARGET_WORTH_DTL C
						 ON     B.ID = C.TARGET_WORTH_ID AND
										A.OBJ_ID = C.OBJ_ID AND
										C.OBJ_TYPE <> 40
						 WHERE  B.TARGET_WORTH_PHASE = 0 AND
										PP.ID = A.ID)
		WHERE  PP.OBJ_TYPE = '项目' AND
					 EXISTS (SELECT 1
						FROM   DWM_TARGET_WORTH_DTL OO
						WHERE  OO.TARGET_WORTH_ID = PP.TARGET_A1_ID AND
									 OO.OBJ_ID = PP.OBJ_ID);
		--更新全盘版目标货值

		UPDATE DWM_DT_VALUE PP
		SET    (PP.TMP_2QP_VALUE, PP.TMP_2QP_AREA, PP.TMP_2QP_PRICE, PP.TARGET_A2_VALUE, PP.TARGET_A2_ID) =
						(SELECT C.WORTH * 10000, C.TOTAL_SALES_AREA,
										CASE
												WHEN NVL(C.TOTAL_SALES_AREA, 0) = 0 THEN
												 0
												ELSE
												 ROUND(C.WORTH * 10000 / C.TOTAL_SALES_AREA, 2)
										END, C.WORTH, C.TARGET_WORTH_ID
						 FROM   DWM_DT_VALUE A
						 INNER  JOIN DWM_TARGET_WORTH B
						 ON     A.TARGET_A2_ID = B.ID AND
										B.IS_DELETE = 0
						 INNER  JOIN DWM_TARGET_WORTH_DTL C
						 ON     B.ID = C.TARGET_WORTH_ID AND
										A.OBJ_ID = C.OBJ_ID AND
										C.OBJ_TYPE <> 40
						 WHERE  B.TARGET_WORTH_PHASE = 10 AND
										PP.ID = A.ID)
		WHERE  PP.OBJ_TYPE IN ('项目', '分期');

		--更新动态版目标货值

		UPDATE DWM_DT_VALUE PP
		SET    (PP.TMP_3DT_TARGETVALUE, PP.TMP_3DT_TARGETAREA, PP.TMP_3DT_TARGETPRICE, PP.TARGET_A3_VALUE, PP.TARGET_A3_ID) =
						(SELECT C.WORTH * 10000, C.TOTAL_SALES_AREA,
										CASE
												WHEN NVL(C.TOTAL_SALES_AREA, 0) = 0 THEN
												 0
												ELSE
												 ROUND(C.WORTH * 10000 / C.TOTAL_SALES_AREA, 2)
										END, C.WORTH, C.TARGET_WORTH_ID
						 FROM   DWM_DT_VALUE A
						 INNER  JOIN DWM_TARGET_WORTH B
						 ON     A.TARGET_A3_ID = B.ID AND
										B.WORTH_V = (SELECT MAX(A1.WORTH_V)
																 FROM   DWM_TARGET_WORTH A1
																 WHERE  A1.PROJ_ID = B.PROJ_ID AND
																				A1.TARGET_WORTH_PHASE = 20 AND
																				A1.APPROVAL_STATUS = '已审核') AND
										B.IS_DELETE = 0
						 INNER  JOIN DWM_TARGET_WORTH_DTL C
						 ON     B.ID = C.TARGET_WORTH_ID AND
										A.OBJ_ID = C.OBJ_ID AND
										C.OBJ_TYPE <> 40
						 WHERE  B.TARGET_WORTH_PHASE = 20 AND
										PP.ID = A.ID)
		WHERE  EXISTS (SELECT 1
						FROM   (SELECT A.ID, C.WORTH * 10000, C.TOTAL_SALES_AREA,
														CASE
																WHEN NVL(C.TOTAL_SALES_AREA, 0) = 0 THEN
																 0
																ELSE
																 ROUND(C.WORTH * 10000 / C.TOTAL_SALES_AREA, 2)
														END, C.WORTH
										 FROM   DWM_DT_VALUE A
										 INNER  JOIN DWM_TARGET_WORTH B
										 ON     A.TARGET_A3_ID = B.ID AND
														B.WORTH_V = (SELECT MAX(A1.WORTH_V)
																				 FROM   DWM_TARGET_WORTH A1
																				 WHERE  A1.PROJ_ID = B.PROJ_ID AND
																								A1.TARGET_WORTH_PHASE = 20)
										 INNER  JOIN DWM_TARGET_WORTH_DTL C
										 ON     B.ID = C.TARGET_WORTH_ID AND
														A.OBJ_ID = C.OBJ_ID AND
														C.OBJ_TYPE <> 40
										 WHERE  B.TARGET_WORTH_PHASE = 20) OO
						WHERE  OO.ID = PP.ID);
		--最新版目标货值更新
		UPDATE DWM_DT_VALUE PP
		SET    PP.TARGET_A_VALUE =
						(SELECT B.WORTH
						 FROM   DWM_DT_VALUE A
						 INNER  JOIN DWM_TARGET_WORTH_DTL B
						 ON     A.TARGET_A_ID = B.TARGET_WORTH_ID AND
										A.OBJ_ID = B.OBJ_ID AND
										B.OBJ_TYPE <> 40
						 WHERE  A.ID = PP.ID)
		WHERE  EXISTS (SELECT 1
						FROM   DWM_TARGET_WORTH_DTL O
						WHERE  O.TARGET_WORTH_ID = PP.TARGET_A_ID AND
									 O.OBJ_ID = PP.OBJ_ID);

		COMMIT;

		OPEN CUR_OBJ_LIST;
		LOOP
				FETCH CUR_OBJ_LIST
						INTO ITEM_OBJ_LIST;
				EXIT WHEN CUR_OBJ_LIST%NOTFOUND;
				SELECT NVL(A.TARGET_A3_ID, '') INTO V_TARGET_ID FROM DWM_DT_VALUE A WHERE A.ID = ITEM_OBJ_LIST.ID;
				IF LENGTH(V_TARGET_ID) <> 0
				THEN
						UPDATE DWM_DT_VALUE A SET A.TARGET_NOW_NAME = 20, A.TARGET_A_ID = V_TARGET_ID WHERE A.ID = ITEM_OBJ_LIST.ID;
				ELSE
						SELECT NVL(A.TARGET_A2_ID, '') INTO V_TARGET_ID FROM DWM_DT_VALUE A WHERE A.ID = ITEM_OBJ_LIST.ID;
						IF LENGTH(V_TARGET_ID) <> 0
						THEN
								UPDATE DWM_DT_VALUE A SET A.TARGET_NOW_NAME = 10, A.TARGET_A_ID = V_TARGET_ID WHERE A.ID = ITEM_OBJ_LIST.ID;
						ELSE
								SELECT NVL(A.TARGET_A1_ID, '') INTO V_TARGET_ID FROM DWM_DT_VALUE A WHERE A.ID = ITEM_OBJ_LIST.ID;
								IF LENGTH(V_TARGET_ID) <> 0
								THEN
										UPDATE DWM_DT_VALUE A SET A.TARGET_NOW_NAME = 0, A.TARGET_A_ID = V_TARGET_ID WHERE A.ID = ITEM_OBJ_LIST.ID;
								ELSE
										UPDATE DWM_DT_VALUE A SET A.TARGET_NOW_NAME = NULL, A.TARGET_A_ID = NULL WHERE A.ID = ITEM_OBJ_LIST.ID;
								END IF;
						END IF;
				END IF;
		
		END LOOP;
		COMMIT;
		CLOSE CUR_OBJ_LIST;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_GET_PROJ_VALUE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_GET_PROJ_VALUE" 

/*

  --CreatedBy:Wangck
  --CreatedDate:20200408
  --note:计算分期、项目的动态货值、动态货量
*/

IS

BEGIN
		--更新“项目”及“项目三大业态”的库存货量、已售货量、已领证货量、 库存货值、已售货值、已领证货值、在途货值、在途货量
		UPDATE DWM_DT_VALUE A
		SET    (ZZ_AREA_STOCK, ZZ_AREA_HAVED_SALE, A.ZZ_AREA_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_HAVED_SALE, A.SY_AREA_ALLOW_SALE, SY_VALUE_STOCK,
						 SY_VALUE_HAVED_SALE, SY_VALUE_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_HAVED_SALE, A.CW_AREA_ALLOW_SALE, CW_VALUE_STOCK, CW_VALUE_HAVED_SALE, CW_VALUE_ALLOW_SALE, AREA_STOCK, AREA_HAVED_SALE,
						 AREA_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_HAVED_SALE, A.VALUE_ALLOW_SALE, A.ZZ_VALUE_IN_PROCESS, A.SY_VALUE_IN_PROCESS, A.CW_VALUE_IN_PROCESS, A.ZZ_VALUE_NOT_CONSTRUCTION_PER,
						 A.SY_VALUE_NOT_CONSTRUCTION_PER, A.CW_VALUE_NOT_CONSTRUCTION_PER, A.VALUE_IN_PROCESS,A.AREA_IN_PROCESS,A.ZZ_AREA_IN_PROCESS,A.SY_AREA_IN_PROCESS,A.CW_AREA_IN_PROCESS,A.AREA_NOT_CONSTRUCTION_PERMIT,A.ZZ_AREA_NOT_CONSTRUCTION_PER,A.SY_AREA_NOT_CONSTRUCTION_PER,A.CW_AREA_NOT_CONSTRUCTION_PER) =
						(SELECT SUM(NVL(B.ZZ_AREA_STOCK, 0)) AS ZZ库存货量_房间合计, SUM(NVL(B.ZZ_AREA_HAVED_SALE, 0)) AS ZZ已售货量_房间合计, SUM(NVL(B.ZZ_AREA_STOCK, 0)) + SUM(NVL(B.ZZ_AREA_HAVED_SALE, 0)) AS ZZ领证货量_房间合计,
										SUM(NVL(B.ZZ_VALUE_STOCK, 0)) AS ZZ库存货值_房间合计, SUM(NVL(B.ZZ_VALUE_HAVED_SALE, 0)) AS ZZ已售货值_房间合计, SUM(NVL(B.ZZ_VALUE_STOCK, 0)) + SUM(NVL(B.ZZ_VALUE_HAVED_SALE, 0)) AS ZZ领证货值_房间合计

									 , SUM(NVL(B.SY_AREA_STOCK, 0)) AS SY库存货量_房间合计, SUM(NVL(B.SY_AREA_HAVED_SALE, 0)) AS SY已售货量_房间合计, SUM(NVL(B.SY_AREA_STOCK, 0)) + SUM(NVL(B.SY_AREA_HAVED_SALE, 0)) AS SY领证货量_房间合计,
										SUM(NVL(B.SY_VALUE_STOCK, 0)) AS SY库存货值_房间合计, SUM(NVL(B.SY_VALUE_HAVED_SALE, 0)) AS SY已售货值_房间合计, SUM(NVL(B.SY_VALUE_STOCK, 0)) + SUM(NVL(B.SY_VALUE_HAVED_SALE, 0)) AS SY领证货值_房间合计

									 , SUM(NVL(B.CW_AREA_STOCK, 0)) AS CW库存货量_房间合计, SUM(NVL(B.CW_AREA_HAVED_SALE, 0)) AS CW已售货量_房间合计, SUM(NVL(B.CW_AREA_STOCK, 0)) + SUM(NVL(B.CW_AREA_HAVED_SALE, 0)) AS CW领证货量_房间合计,
										SUM(NVL(B.CW_VALUE_STOCK, 0)) AS CW库存货值_房间合计, SUM(NVL(B.CW_VALUE_HAVED_SALE, 0)) AS CW已售货值_房间合计, SUM(NVL(B.CW_VALUE_STOCK, 0)) + SUM(NVL(B.CW_VALUE_HAVED_SALE, 0)) AS CW领证货值_房间合计

									 , SUM(NVL(B.ZZ_AREA_STOCK, 0)) + SUM(NVL(B.SY_AREA_STOCK, 0)) AS ZS库存货量_房间合计, SUM(NVL(B.ZZ_AREA_HAVED_SALE, 0)) + SUM(NVL(B.SY_AREA_HAVED_SALE, 0)) AS ZS已售货量_房间合计,
										SUM(NVL(B.ZZ_AREA_STOCK, 0)) + SUM(NVL(B.SY_AREA_STOCK, 0)) + SUM(NVL(B.ZZ_AREA_HAVED_SALE, 0)) + SUM(NVL(B.SY_AREA_HAVED_SALE, 0)) AS ZS领证货量_房间合计,
										SUM(NVL(B.ZZ_VALUE_STOCK, 0)) + SUM(NVL(B.SY_VALUE_STOCK, 0)) + SUM(NVL(B.CW_VALUE_STOCK, 0)) AS ALL库存货值_房间合计,
										SUM(NVL(B.ZZ_VALUE_HAVED_SALE, 0)) + SUM(NVL(B.SY_VALUE_HAVED_SALE, 0)) + SUM(NVL(B.CW_VALUE_HAVED_SALE, 0)) AS ALL已售货值_房间合计,
										SUM(NVL(B.ZZ_VALUE_STOCK, 0)) + SUM(NVL(B.SY_VALUE_STOCK, 0)) + SUM(NVL(B.CW_VALUE_STOCK, 0)) + SUM(NVL(B.ZZ_VALUE_HAVED_SALE, 0)) + SUM(NVL(B.SY_VALUE_HAVED_SALE, 0)) +
										 SUM(NVL(B.CW_VALUE_HAVED_SALE, 0)) AS ALL领证货值_房间合计, SUM(B.ZZ_VALUE_IN_PROCESS), SUM(B.SY_VALUE_IN_PROCESS), SUM(B.CW_VALUE_IN_PROCESS), SUM(B.ZZ_VALUE_NOT_CONSTRUCTION_PER),
										SUM(SY_VALUE_NOT_CONSTRUCTION_PER), SUM(CW_VALUE_NOT_CONSTRUCTION_PER), SUM(B.VALUE_IN_PROCESS),SUM(B.AREA_IN_PROCESS),SUM(B.ZZ_AREA_IN_PROCESS),SUM(B.SY_AREA_IN_PROCESS),SUM(B.CW_AREA_IN_PROCESS),SUM(B.AREA_NOT_CONSTRUCTION_PERMIT),SUM(B.ZZ_AREA_NOT_CONSTRUCTION_PER),SUM(B.SY_AREA_NOT_CONSTRUCTION_PER),SUM(B.CW_AREA_NOT_CONSTRUCTION_PER)

						 FROM   DWM_DT_VALUE B
						 WHERE  B.OBJ_TYPE = '楼栋' AND
										A.PROJ_ID = B.PROJ_ID
						 GROUP  BY B.PROJ_ID)
		WHERE  A.OBJ_TYPE = '项目';
		--更新“分期”及“分期三大业态”的库存货量、已售货量、已领证货量、 库存货值、已售货值、已领证货值、在途货值
		UPDATE DWM_DT_VALUE A
		SET    (ZZ_AREA_STOCK, ZZ_AREA_HAVED_SALE, A.ZZ_AREA_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_HAVED_SALE, A.SY_AREA_ALLOW_SALE, SY_VALUE_STOCK,
						 SY_VALUE_HAVED_SALE, SY_VALUE_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_HAVED_SALE, A.CW_AREA_ALLOW_SALE, CW_VALUE_STOCK, CW_VALUE_HAVED_SALE, CW_VALUE_ALLOW_SALE, AREA_STOCK, AREA_HAVED_SALE,
						 AREA_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_HAVED_SALE, A.VALUE_ALLOW_SALE, A.ZZ_VALUE_IN_PROCESS, A.SY_VALUE_IN_PROCESS, A.CW_VALUE_IN_PROCESS, A.ZZ_VALUE_NOT_CONSTRUCTION_PER,
						 A.SY_VALUE_NOT_CONSTRUCTION_PER, A.CW_VALUE_NOT_CONSTRUCTION_PER, A.VALUE_IN_PROCESS, A.VALUE_NOT_CONSTRUCTION_PERMIT,A.AREA_IN_PROCESS,A.ZZ_AREA_IN_PROCESS,A.SY_AREA_IN_PROCESS,A.CW_AREA_IN_PROCESS,A.AREA_NOT_CONSTRUCTION_PERMIT,A.ZZ_AREA_NOT_CONSTRUCTION_PER,A.SY_AREA_NOT_CONSTRUCTION_PER,A.CW_AREA_NOT_CONSTRUCTION_PER) =
						(SELECT SUM(NVL(B.ZZ_AREA_STOCK, 0)) AS ZZ库存货量_房间合计, SUM(NVL(B.ZZ_AREA_HAVED_SALE, 0)) AS ZZ已售货量_房间合计, SUM(NVL(B.ZZ_AREA_STOCK, 0)) + SUM(NVL(B.ZZ_AREA_HAVED_SALE, 0)) AS ZZ领证货量_房间合计,
										SUM(NVL(B.ZZ_VALUE_STOCK, 0)) AS ZZ库存货值_房间合计, SUM(NVL(B.ZZ_VALUE_HAVED_SALE, 0)) AS ZZ已售货值_房间合计, SUM(NVL(B.ZZ_VALUE_STOCK, 0)) + SUM(NVL(B.ZZ_VALUE_HAVED_SALE, 0)) AS ZZ领证货值_房间合计

									 , SUM(NVL(B.SY_AREA_STOCK, 0)) AS SY库存货量_房间合计, SUM(NVL(B.SY_AREA_HAVED_SALE, 0)) AS SY已售货量_房间合计, SUM(NVL(B.SY_AREA_STOCK, 0)) + SUM(NVL(B.SY_AREA_HAVED_SALE, 0)) AS SY领证货量_房间合计,
										SUM(NVL(B.SY_VALUE_STOCK, 0)) AS SY库存货值_房间合计, SUM(NVL(B.SY_VALUE_HAVED_SALE, 0)) AS SY已售货值_房间合计, SUM(NVL(B.SY_VALUE_STOCK, 0)) + SUM(NVL(B.SY_VALUE_HAVED_SALE, 0)) AS SY领证货值_房间合计

									 , SUM(NVL(B.CW_AREA_STOCK, 0)) AS CW库存货量_房间合计, SUM(NVL(B.CW_AREA_HAVED_SALE, 0)) AS CW已售货量_房间合计, SUM(NVL(B.CW_AREA_STOCK, 0)) + SUM(NVL(B.CW_AREA_HAVED_SALE, 0)) AS CW领证货量_房间合计,
										SUM(NVL(B.CW_VALUE_STOCK, 0)) AS CW库存货值_房间合计, SUM(NVL(B.CW_VALUE_HAVED_SALE, 0)) AS CW已售货值_房间合计, SUM(NVL(B.CW_VALUE_STOCK, 0)) + SUM(NVL(B.CW_VALUE_HAVED_SALE, 0)) AS CW领证货值_房间合计

									 , SUM(NVL(B.ZZ_AREA_STOCK, 0)) + SUM(NVL(B.SY_AREA_STOCK, 0)) AS ZS库存货量_房间合计, SUM(NVL(B.ZZ_AREA_HAVED_SALE, 0)) + SUM(NVL(B.SY_AREA_HAVED_SALE, 0)) AS ZS已售货量_房间合计,
										SUM(NVL(B.ZZ_AREA_STOCK, 0)) + SUM(NVL(B.SY_AREA_STOCK, 0)) + SUM(NVL(B.ZZ_AREA_HAVED_SALE, 0)) + SUM(NVL(B.SY_AREA_HAVED_SALE, 0)) AS ZS领证货量_房间合计,
										SUM(NVL(B.ZZ_VALUE_STOCK, 0)) + SUM(NVL(B.SY_VALUE_STOCK, 0)) + SUM(NVL(B.CW_VALUE_STOCK, 0)) AS ALL库存货值_房间合计,
										SUM(NVL(B.ZZ_VALUE_HAVED_SALE, 0)) + SUM(NVL(B.SY_VALUE_HAVED_SALE, 0)) + SUM(NVL(B.CW_VALUE_HAVED_SALE, 0)) AS ALL已售货值_房间合计,
										SUM(NVL(B.ZZ_VALUE_STOCK, 0)) + SUM(NVL(B.SY_VALUE_STOCK, 0)) + SUM(NVL(B.CW_VALUE_STOCK, 0)) + SUM(NVL(B.ZZ_VALUE_HAVED_SALE, 0)) + SUM(NVL(B.SY_VALUE_HAVED_SALE, 0)) +
										 SUM(NVL(B.CW_VALUE_HAVED_SALE, 0)) AS ALL领证货值_房间合计, SUM(B.ZZ_VALUE_IN_PROCESS), SUM(B.SY_VALUE_IN_PROCESS), SUM(B.CW_VALUE_IN_PROCESS), SUM(B.ZZ_VALUE_NOT_CONSTRUCTION_PER),
										SUM(B.SY_VALUE_NOT_CONSTRUCTION_PER), SUM(B.CW_VALUE_NOT_CONSTRUCTION_PER), SUM(B.VALUE_IN_PROCESS), SUM(B.VALUE_NOT_CONSTRUCTION_PERMIT),SUM(B.AREA_IN_PROCESS),SUM(B.ZZ_AREA_IN_PROCESS),SUM(B.SY_AREA_IN_PROCESS),SUM(B.CW_AREA_IN_PROCESS),SUM(B.AREA_NOT_CONSTRUCTION_PERMIT),SUM(B.ZZ_AREA_NOT_CONSTRUCTION_PER),SUM(B.SY_AREA_NOT_CONSTRUCTION_PER),SUM(B.CW_AREA_NOT_CONSTRUCTION_PER)

						 FROM   DWM_DT_VALUE B
						 WHERE  B.OBJ_TYPE = '楼栋' AND
										A.OBJ_ID = B.PARENT_ID
						 GROUP  BY B.PROJ_ID)
		WHERE  A.OBJ_TYPE = '分期';
		--更新“项目”及“项目三大业态”的已领证货值、已领证货量、已竣备货值、已竣备货量
		UPDATE DWM_DT_VALUE A
		SET    (VALUE_YES_COMPLETION, AREA_YES_COMPLETION， A.VALUE_NOT_COMPLETION, A.AREA_NOT_COMPLETION,

						 A.ZZ_VALUE_YES_COMPLETION, A.ZZ_AREA_YES_COMPLETION, A.ZZ_VALUE_NOT_COMPLETION, A.ZZ_AREA_NOT_COMPLETION,

						 A.SY_VALUE_YES_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_VALUE_NOT_COMPLETION, A.SY_AREA_NOT_COMPLETION,

						 A.CW_VALUE_YES_COMPLETION, A.CW_AREA_YES_COMPLETION, A.CW_VALUE_NOT_COMPLETION, A.CW_AREA_NOT_COMPLETION) =
						(SELECT SUM(NVL(B.VALUE_YES_COMPLETION, 0)) AS ALL已竣备货值, SUM(NVL(B.AREA_YES_COMPLETION, 0)) AS ALL已竣备货量, SUM(NVL(B.VALUE_NOT_COMPLETION, 0)) AS ALL预售证阶段货值,
										SUM(NVL(B.AREA_NOT_COMPLETION, 0)) AS ALL预售证阶段货量

									 , SUM(NVL(B.ZZ_VALUE_YES_COMPLETION, 0)) AS ZZ已竣备货值, SUM(NVL(B.ZZ_AREA_YES_COMPLETION, 0)) AS ZZ已竣备货量, SUM(NVL(B.ZZ_VALUE_NOT_COMPLETION, 0)) AS ZZ预售证阶段货值,
										SUM(NVL(B.ZZ_AREA_NOT_COMPLETION, 0)) AS ZZ预售证阶段货量

									 , SUM(NVL(B.SY_VALUE_YES_COMPLETION, 0)) AS SY已竣备货值, SUM(NVL(B.SY_AREA_YES_COMPLETION, 0)) AS SY已竣备货量, SUM(NVL(B.SY_VALUE_NOT_COMPLETION, 0)) AS SY预售证阶段货值,
										SUM(NVL(B.SY_AREA_NOT_COMPLETION, 0)) AS SY预售证阶段货量

									 , SUM(NVL(B.CW_VALUE_YES_COMPLETION, 0)) AS CW已竣备货值, SUM(NVL(B.CW_AREA_YES_COMPLETION, 0)) AS CW已竣备货量, SUM(NVL(B.CW_VALUE_NOT_COMPLETION, 0)) AS CW预售证阶段货值,
										SUM(NVL(B.CW_AREA_NOT_COMPLETION, 0)) AS CW预售证阶段货量
						 FROM   DWM_DT_VALUE B
						 WHERE  B.OBJ_TYPE = '楼栋' AND
										A.PROJ_ID = B.PROJ_ID
						 GROUP  BY B.PROJ_ID)
		WHERE  A.OBJ_TYPE = '项目';
		--更新“分期”及“分期三大业态”的已领证货值、已领证货量、已竣备货值、已竣备货量
		UPDATE DWM_DT_VALUE A
		SET    (VALUE_YES_COMPLETION, AREA_YES_COMPLETION， A.VALUE_NOT_COMPLETION, A.AREA_NOT_COMPLETION,

						 A.ZZ_VALUE_YES_COMPLETION, A.ZZ_AREA_YES_COMPLETION, A.ZZ_VALUE_NOT_COMPLETION, A.ZZ_AREA_NOT_COMPLETION,

						 A.SY_VALUE_YES_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_VALUE_NOT_COMPLETION, A.SY_AREA_NOT_COMPLETION,

						 A.CW_VALUE_YES_COMPLETION, A.CW_AREA_YES_COMPLETION, A.CW_VALUE_NOT_COMPLETION, A.CW_AREA_NOT_COMPLETION) =
						(SELECT SUM(NVL(B.VALUE_YES_COMPLETION, 0)) AS ALL已竣备货值, SUM(NVL(B.AREA_YES_COMPLETION, 0)) AS ALL已竣备货量, SUM(NVL(B.VALUE_NOT_COMPLETION, 0)) AS ALL预售证阶段货值,
										SUM(NVL(B.AREA_NOT_COMPLETION, 0)) AS ALL预售证阶段货量

									 , SUM(NVL(B.ZZ_VALUE_YES_COMPLETION, 0)) AS ZZ已竣备货值, SUM(NVL(B.ZZ_AREA_YES_COMPLETION, 0)) AS ZZ已竣备货量, SUM(NVL(B.ZZ_VALUE_NOT_COMPLETION, 0)) AS ZZ预售证阶段货值,
										SUM(NVL(B.ZZ_AREA_NOT_COMPLETION, 0)) AS ZZ预售证阶段货量

									 , SUM(NVL(B.SY_VALUE_YES_COMPLETION, 0)) AS SY已竣备货值, SUM(NVL(B.SY_AREA_YES_COMPLETION, 0)) AS SY已竣备货量, SUM(NVL(B.SY_VALUE_NOT_COMPLETION, 0)) AS SY预售证阶段货值,
										SUM(NVL(B.SY_AREA_NOT_COMPLETION, 0)) AS SY预售证阶段货量

									 , SUM(NVL(B.CW_VALUE_YES_COMPLETION, 0)) AS CW已竣备货值, SUM(NVL(B.CW_AREA_YES_COMPLETION, 0)) AS CW已竣备货量, SUM(NVL(B.CW_VALUE_NOT_COMPLETION, 0)) AS CW预售证阶段货值,
										SUM(NVL(B.CW_AREA_NOT_COMPLETION, 0)) AS CW预售证阶段货量
						 FROM   DWM_DT_VALUE B
						 WHERE  B.OBJ_TYPE = '楼栋' AND
										A.OBJ_ID = B.PARENT_ID
						 GROUP  BY B.PROJ_ID)
		WHERE  A.OBJ_TYPE = '分期';

		-- 更新“项目”及“项目三大业态”的“剩余货值、剩余货量”
		UPDATE DWM_DT_VALUE A
		SET    (VALUE_REMAIN, AREA_REMAIN， A.ZZ_VALUE_REMAIN, A.ZZ_AREA_REMAIN, A.SY_VALUE_REMAIN, A.SY_AREA_REMAIN, A.CW_VALUE_REMAIN, A.CW_AREA_REMAIN) =
						(SELECT SUM(NVL(B.VALUE_REMAIN, 0)) AS ALL剩余货值, SUM(NVL(B.AREA_REMAIN, 0)) AS ALL剩余货量

									 , SUM(NVL(B.ZZ_VALUE_REMAIN, 0)) AS ZZ剩余货值, SUM(NVL(B.ZZ_AREA_REMAIN, 0)) AS ZZ剩余货量

									 , SUM(NVL(B.SY_VALUE_REMAIN, 0)) AS SY剩余货值, SUM(NVL(B.SY_AREA_REMAIN, 0)) AS SY剩余货量

									 , SUM(NVL(B.CW_VALUE_REMAIN, 0)) AS CW剩余货值, SUM(NVL(B.CW_AREA_REMAIN, 0)) AS CW剩余货量

						 FROM   DWM_DT_VALUE B
						 WHERE  B.OBJ_TYPE = '楼栋' AND
										A.PROJ_ID = B.PROJ_ID
						 GROUP  BY B.PROJ_ID)
		WHERE  A.OBJ_TYPE = '项目';

		-- 更新“分期”及“分期三大业态”的剩余货值、剩余货量
		UPDATE DWM_DT_VALUE A
		SET    (VALUE_REMAIN, AREA_REMAIN， A.ZZ_VALUE_REMAIN, A.ZZ_AREA_REMAIN, A.SY_VALUE_REMAIN, A.SY_AREA_REMAIN, A.CW_VALUE_REMAIN, A.CW_AREA_REMAIN) =
						(SELECT SUM(NVL(B.VALUE_REMAIN, 0)) AS ALL剩余货值, SUM(NVL(B.AREA_REMAIN, 0)) AS ALL剩余货量

									 , SUM(NVL(B.ZZ_VALUE_REMAIN, 0)) AS ZZ剩余货值, SUM(NVL(B.ZZ_AREA_REMAIN, 0)) AS ZZ剩余货量

									 , SUM(NVL(B.SY_VALUE_REMAIN, 0)) AS SY剩余货值, SUM(NVL(B.SY_AREA_REMAIN, 0)) AS SY剩余货量

									 , SUM(NVL(B.CW_VALUE_REMAIN, 0)) AS CW剩余货值, SUM(NVL(B.CW_AREA_REMAIN, 0)) AS CW剩余货量

						 FROM   DWM_DT_VALUE B
						 WHERE  B.OBJ_TYPE = '楼栋' AND
										A.OBJ_ID = B.PARENT_ID
						 GROUP  BY B.PROJ_ID)
		WHERE  A.OBJ_TYPE = '分期';
		-- 更新“项目”及“项目三大业态”的动态货值、动态货量
		UPDATE DWM_DT_VALUE A
		SET    (VALUE_DT_ALL, AREA_DT_ALL， ZZ_VALUE_DT_ALL, A.ZZ_AREA_DT_ALL, SY_VALUE_DT_ALL, A.SY_AREA_DT_ALL, CW_VALUE_DT_ALL, A.CW_AREA_DT_ALL) =
						(SELECT SUM(NVL(B.VALUE_DT_ALL, 0)) AS ALL动态货值, SUM(NVL(B.AREA_DT_ALL, 0)) AS ALL动态货量

									 , SUM(NVL(B.ZZ_VALUE_DT_ALL, 0)) AS ZZ动态货值, SUM(NVL(B.ZZ_AREA_DT_ALL, 0)) AS ZZ动态货量

									 , SUM(NVL(B.SY_VALUE_DT_ALL, 0)) AS SY动态货值, SUM(NVL(B.SY_AREA_DT_ALL, 0)) AS SY动态货量

									 , SUM(NVL(B.CW_VALUE_DT_ALL, 0)) AS CW动态货值, SUM(NVL(B.CW_AREA_DT_ALL, 0)) AS CW动态货量

						 FROM   DWM_DT_VALUE B
						 WHERE  B.OBJ_TYPE = '楼栋' AND
										A.PROJ_ID = B.PROJ_ID
						 GROUP  BY B.PROJ_ID)
		WHERE  A.OBJ_TYPE = '项目';
		--更新“分期”及“分期三大业态”的动态货值、动态货量
		UPDATE DWM_DT_VALUE A
		SET    (VALUE_DT_ALL, AREA_DT_ALL， ZZ_VALUE_DT_ALL, A.ZZ_AREA_DT_ALL, SY_VALUE_DT_ALL, A.SY_AREA_DT_ALL, CW_VALUE_DT_ALL, A.CW_AREA_DT_ALL) =
						(SELECT SUM(NVL(B.VALUE_DT_ALL, 0)) AS ALL动态货值, SUM(NVL(B.AREA_DT_ALL, 0)) AS ALL动态货量

									 , SUM(NVL(B.ZZ_VALUE_DT_ALL, 0)) AS ZZ动态货值, SUM(NVL(B.ZZ_AREA_DT_ALL, 0)) AS ZZ动态货量

									 , SUM(NVL(B.SY_VALUE_DT_ALL, 0)) AS SY动态货值, SUM(NVL(B.SY_AREA_DT_ALL, 0)) AS SY动态货量

									 , SUM(NVL(B.CW_VALUE_DT_ALL, 0)) AS CW动态货值, SUM(NVL(B.CW_AREA_DT_ALL, 0)) AS CW动态货量

						 FROM   DWM_DT_VALUE B
						 WHERE  B.OBJ_TYPE = '楼栋' AND
										A.OBJ_ID = B.PARENT_ID
						 GROUP  BY B.PROJ_ID)
		WHERE  A.OBJ_TYPE = '分期';

		UPDATE DWM_DT_VALUE P
		SET    (P.VALUE_NOT_PLANNING_PERMIT, P.VALUE_NOT_CONSTRUCTION_PERMIT, P.VALUE_NOT_SALE_PERMIT, P.VALUE_NOT_COMPLETION, P.VALUE_YES_COMPLETION, P.VALUE_YES_SETTLEMENT, P.VALUE_IN_PROCESS) =
						(SELECT SUM(A.VALUE_NOT_PLANNING_PERMIT) AS VALUE_NOT_PLANNING_PERMIT, SUM(A.VALUE_NOT_CONSTRUCTION_PERMIT), SUM(A.VALUE_NOT_SALE_PERMIT), SUM(A.VALUE_NOT_COMPLETION),
										SUM(A.VALUE_YES_COMPLETION), SUM(A.VALUE_YES_SETTLEMENT), SUM(A.VALUE_IN_PROCESS)
						 FROM   DWM_DT_VALUE A
						 WHERE  A.OBJ_TYPE = '楼栋' AND
										P.PROJ_ID = A.PROJ_ID
						 GROUP  BY A.PROJ_ID)
		WHERE  P.OBJ_TYPE = '项目';
    COMMIT;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_GLOBAL_WORK_AMOUNT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_GLOBAL_WORK_AMOUNT" (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
     unitid         IN             VARCHAR2, --选择公司id
    projectid      IN             VARCHAR2,--项目id()
    info           OUT            SYS_REFCURSOR
) AS
--动态货值管理-全案动态货值
--作者：陈丽
--日期：2019/12/17
 P_ID VARCHAR2(36) :='3e7507a3-b76a-48c5-bd81-2820958ed919';
BEGIN
--  P_ID :=projectid;
   SELECT t.ID INTO P_ID  FROM  Mdm_Project t WHERE t.project_Name='佛山领秀公馆（南区）' AND t.is_delete=0;
    OPEN info FOR

SELECT
  b.OBJ_ID AS ID,
  null AS PARENT_ID,
  ''  AS WORK_CODE,
  NVL(b.obj_name,'XX项目') AS WORK_NAME,      -- 项目/分期/业态/楼栋
  to_char(b.AREA_DT_ALL,'999,999,999,999,999.99') AS RECENT_FLOORAGE_AREA,              -- 最新建筑面积
  to_char(b.AREA_DT_ALL,'999,999,999,999,999.99') AS RECENT_SALE_AREA,                  -- 最新可售面积
  to_char(c1.target_worth,'999,999,999,999,999.99') AS FIRST_PHASE,                       -- 可研版(A1)
  to_char(c2.target_worth,'999,999,999,999,999.99')  AS NEXT_PHASE,                        -- 全盘版(A2)
  to_char(c3.target_worth,'999,999,999,999,999.99')  AS ACT_PHASE,                         -- 动态版(A3)
  to_char(c9.target_worth,'999,999,999,999,999.99')  AS RECENT_AREA,                       -- 最新版(A)


  to_char(b.VALUE_DT_ALL/10000,'999,999,999,999,999.99') AS TOTAL_GLOBAL_WORK_VALUE,           -- 动态总货值(B)
  to_char((c9.target_worth-b.VALUE_DT_ALL)/10000,'999,999,999,999,999.99') AS TOTAL_WORK_VALUE_MINUS,            -- 总货值差额(B-A)
  to_char(b.VALUE_RESERVE/10000,'999,999,999,999,999.99') AS STORE_VALUE,                       -- 储备货值(B1)
  to_char(b.VALUE_IN_PROCESS/10000,'999,999,999,999,999.99') AS TRANSIT_VALUE,                     -- 在途货值(B2)
  to_char(b.VALUE_STOCK/10000,'999,999,999,999,999.99') AS REPERTORY_VALUE,                   -- 库存货值(B3)
  to_char(b.VALUE_HAVED_SALE/10000,'999,999,999,999,999.99') AS SALE_VALUE,                        -- 已售货值(B4)
  to_char(b.VALUE_REMAIN/10000,'999,999,999,999,999.99') AS REMAIN_VALUE,                      -- 剩余货值(C=B1+B2+B3)
  to_char(b.VALUE_ALLOW_SALE/10000,'999,999,999,999,999.99') AS HOLD_VALUE,                        -- 已领证货值(D=B3+B4)
  to_char((CASE WHEN b.VALUE_ALLOW_SALE=0 THEN 0 ELSE b.VALUE_HAVED_SALE/b.VALUE_ALLOW_SALE*100 END)
                ,'999,999,999,999,999.99') AS RID_RATE,                          -- 去化率(E=B4/D)

  to_char(b.AREA_DT_ALL/10000,'999,999,999,999,999.99') AS NO_PLAN_PERMIT,                    -- F0未取规证
  to_char(b.AREA_DT_ALL/10000,'999,999,999,999,999.99') AS PLAN_PERMIT_PHASE,                 -- F1规划许可证阶段
  to_char(b.AREA_DT_ALL/10000,'999,999,999,999,999.99') AS CONSTRUCTION_PERMIT_PHASE,         -- F2施工许可证阶段
  to_char(b.AREA_DT_ALL/10000,'999,999,999,999,999.99') AS PRE_SALE_PERMIT_PHASE,             -- F3预售许可证阶段
  to_char(b.AREA_DT_ALL/10000,'999,999,999,999,999.99') AS COMPLETED_PERMIT_PHASE,            -- F4竣工备案阶段
  to_char(b.AREA_DT_ALL/10000,'999,999,999,999,999.99') AS CARRY_FORWARD_PHASE                -- F5结转阶段

FROM   dual a
LEFT JOIN dwm_dt_value b ON 1=1 AND b.obj_type='项目' --AND b.obj_id=P_ID --AND b.is_delete=0
LEFT JOIN dwm_target_worth c1 ON b.obj_id=c1.proj_id AND c1.target_worth_phase=0 AND c1.APPROVAL_STATUS = '已审核'
LEFT JOIN dwm_target_worth c2 ON b.obj_id=c2.proj_id AND c2.target_worth_phase=10 AND c2.APPROVAL_STATUS = '已审核'
LEFT JOIN dwm_target_worth c3 ON b.obj_id=c3.proj_id AND c3.target_worth_phase=20 AND c3.APPROVAL_STATUS = '已审核'
LEFT JOIN dwm_target_worth c9 ON b.obj_id=c9.proj_id AND c9.target_worth_phase=20 AND c9.APPROVAL_STATUS = '已审核'
LEFT JOIN MDM_PROJECT d on b.obj_id=d.id and d.is_delete=0

ORDER BY d.PROJECT_CODE
;

END p_dwm_global_work_amount;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_GLOBAL_WORK_VALUE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_GLOBAL_WORK_VALUE" (
  userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    unitid         IN             VARCHAR2, --选择公司id
    projectid      IN             VARCHAR2,--项目id()
    info           OUT            SYS_REFCURSOR) AS
--动态货值管理-全案动态货量
--作者：陈丽
--日期：2019/12/17

/*
SELECT
  '1' AS "编码",
  '1' AS  "分期/业态/楼栋" ,
  '1' AS "最新建筑面积" ,
  '1' AS "最新可售面积" ,
  '1' AS "动态货量" ,
  '1' AS "A1" ,
  '1' AS "A2" ,
  '1' AS "A3" ,
  '1' AS "1_" ,
  '1' AS "2_" ,
  '1' AS "3_" ,
  '1' AS "货量(a)" , A2
  '1' AS "均价(b)" , A2
  '1' AS "货值(c)" , A2
  '1' AS 货量(a) , A3
  '1' AS 均价(b) , A3
  '1' AS 货值(c) , A3
  '1' AS 0未取规证 ,
  '1' AS 1规划许可证阶段 ,
  '1'AS 2施工许可证阶段 ,
  '1' AS 3预售许可证阶段 ,
  '1' AS 4竣工备案阶段 ,
  '1' AS 5结转阶段 ,

FROM
  dual  ;
*/
/*
id  主键
parentId  父
workCode  编码
workName  期/业态/楼栋
recentFloorageArea  最新建筑面积
recentSaleArea  最新可售面积
globalWorkValue 动态货量
noPushValue A1未推货量
noSaleValue A2已推未售货量
saleValue A3已批准已售货量
noPlanPermit  1_未拿规证
holdPlanPermit  2_已拿规证
holdConstructionPermit  3_已经施证
workValueOne  货量(a)
averageValueOne 均价(b)
workAmountOne 货值(c)
workValueTwo  货量(a)
averageValueTwo 均价(b)
workAmountTwo 货值(c)
noSavePlanPermit  0未取规证
planPermitPhase 1规划许可证阶段
constructionPermitPhase 2施工许可证阶段
preSalePermitPhase  3预售许可证阶段
completedPermitPhase  4竣工备案阶段
carryForwardPhase 5结转阶段

*/
 P_ID VARCHAR2(36) :='3e7507a3-b76a-48c5-bd81-2820958ed919';


BEGIN
--  P_ID :=projectid;
SELECT T.ID
INTO   P_ID
FROM   MDM_PROJECT T
WHERE  T.PROJECT_NAME = '佛山领秀公馆（南区）' AND
			 T.IS_DELETE = 0;
OPEN INFO FOR
--  P_ID   :='3e7507a3-b76a-48c5-bd81-2820958ed919';
		SELECT C.PROJECT_CODE AS ID, '' AS PARENT_ID,
					 C.PROJECT_CODE AS WORK_CODE,
            NVL(B.OBJ_NAME, 'XX项目') AS WORK_NAME,

					 TO_CHAR(B.AREA_DT_ALL, '999,999,999,999,999.99') AS RECENT_FLOORAGE_AREA,
						--  最新建筑面积
					 TO_CHAR(B.AREA_DT_ALL, '999,999,999,999,999.99') AS RECENT_SALE_AREA,
						-- 最新可售面积
					 TO_CHAR(B.AREA_REMAIN + B.AREA_HAVED_SALE + B.AREA_STOCK,
										'999,999,999,999,999.99') AS GLOBAL_WORK_VALUE,
						--      动态货量
					 -- to_char(b.AREA_DT_ALL,'999,999,999,999,999.99') AS GLOBAL_WORK_VALUE, --      动态货量
					 TO_CHAR(B.AREA_REMAIN, '999,999,999,999,999.99') AS NO_PUSH_VALUE,
						-- A1未推货量
					 TO_CHAR(B.AREA_HAVED_SALE, '999,999,999,999,999.99') AS NO_SALE_VALUE,
						-- A2已推未售货量
					 TO_CHAR(B.AREA_STOCK, '999,999,999,999,999.99') AS SALE_VALUE,
						-- A3已推已售货量

					 TO_CHAR(B.AREA_NOT_PLANNING_PERMIT, '999,999,999,999,999.99') AS NO_PLAN_PERMIT,
						-- 未推货量分布1_未拿规证
					 TO_CHAR(B.AREA_NOT_CONSTRUCTION_PERMIT, '999,999,999,999,999.99') AS HOLD_PLAN_PERMIT,
						-- 未推货量分布2_已拿规证
					 TO_CHAR(B.AREA_NOT_SALE_PERMIT, '999,999,999,999,999.99') AS HOLD_CONSTRUCTION_PERMIT,
						-- 未推货量分布3_已取施证

					 TO_CHAR(B.AREA_HAVED_SALE, '999,999,999,999,999.99') AS WORK_VALUE_ONE,
						-- 已推已售情况_货量(a)
					 TO_CHAR((CASE
											 WHEN AREA_HAVED_SALE = 0 THEN
												0
											 ELSE
												B.VALUE_HAVED_SALE / B.AREA_HAVED_SALE
									 END), '999,999,999,999,999.99') AS AVERAGE_VALUE_ONE,
						-- 已推已售情况_均价(b)
					 TO_CHAR(B.VALUE_HAVED_SALE / 10000, '999,999,999,999,999.99') AS WORK_AMOUNT_ONE,
						-- 已推已售情况_货值(c)

					 TO_CHAR(B.AREA_STOCK, '999,999,999,999,999.99') AS WORK_VALUE_TWO,
						-- 已推未售情况_货量(a)
					 TO_CHAR((CASE
											 WHEN AREA_STOCK = 0 THEN
												0
											 ELSE
												B.VALUE_STOCK / B.AREA_STOCK
									 END), '999,999,999,999,999.99') AS AVERAGE_VALUE_TWO,
						-- 已推未售情况_均价(b)
					 TO_CHAR(B.VALUE_STOCK / 10000, '999,999,999,999,999.99') AS WORK_AMOUNT_TWO,
						-- 已推未售情况_货值(c)

					 TO_CHAR(B.AREA_NOT_PLANNING_PERMIT, '999,999,999,999,999.99') AS NO_SAVE_PLAN_PERMIT,
						--0未取规证
					 TO_CHAR(B.AREA_NOT_CONSTRUCTION_PERMIT, '999,999,999,999,999.99') AS PLAN_PERMIT_PHASE,
						-- 1规划许可证阶段
					 TO_CHAR(B.AREA_NOT_SALE_PERMIT, '999,999,999,999,999.99') AS CONSTRUCTION_PERMIT_PHASE,
						-- 2施工许可证阶段
					 TO_CHAR(B.AREA_NOT_COMPLETION, '999,999,999,999,999.99') AS PRE_SALE_PERMIT_PHASE,
						-- 3预售许可证阶段
					 TO_CHAR(B.AREA_YES_COMPLETION, '999,999,999,999,999.99') AS COMPLETED_PERMIT_PHASE,
						-- 4竣工备案阶段
					 TO_CHAR(B.AREA_YES_SETTLEMENT, '999,999,999,999,999.99') AS CARRY_FORWARD_PHASE -- 5结转阶段
		FROM   DUAL A
		LEFT   JOIN DWM_DT_VALUE B
		ON     1 = 1 AND
					 B.OBJ_TYPE = '项目' -- AND b.obj_id=P_ID --AND b.is_delete=0
		LEFT   JOIN MDM_PROJECT C
		ON     B.OBJ_ID = C.ID AND
					 C.IS_DELETE = 0
		ORDER  BY C.PROJECT_CODE

		/*

      -- 楼栋
    UNION ALL
    SELECT
      to_char(ROWNUM+1) AS ID,
      '1' AS PARENT_ID,
      to_char(ROWNUM)AS WORK_CODE,
      b.obj_name AS WORK_NAME,

           to_char(b.AREA_DT_ALL,'999,999,999,999,999.99')  AS RECENT_FLOORAGE_AREA,      --  最新建筑面积
           to_char(b.AREA_DT_ALL,'999,999,999,999,999.99') AS RECENT_SALE_AREA, -- 最新可售面积
            to_char(b.AREA_DT_ALL,'999,999,999,999,999.99') AS GLOBAL_WORK_VALUE, --      动态货量
            to_char(b.AREA_RESERVE+b.area_in_process,'999,999,999,999,999.99') AS NO_PUSH_VALUE,  -- A1未推货量
            to_char(b.AREA_STOCK,'999,999,999,999,999.99') AS NO_SALE_VALUE,            -- A2已推未售货量
            to_char(b.AREA_HAVED_SALE,'999,999,999,999,999.99') AS SALE_VALUE,               -- A3已推已售货量

            to_char(b.AREA_NOT_PLANNING_PERMIT,'999,999,999,999,999.99') AS NO_PLAN_PERMIT,           -- 未推货量分布1_未拿规证
            to_char(b.AREA_NOT_CONSTRUCTION_PERMIT,'999,999,999,999,999.99') AS HOLD_PLAN_PERMIT,         -- 未推货量分布2_已拿规证
            to_char(b.AREA_NOT_SALE_PERMIT,'999,999,999,999,999.99') AS HOLD_CONSTRUCTION_PERMIT, -- 未推货量分布3_已取施证

            to_char(b.AREA_HAVED_SALE,'999,999,999,999,999.99') AS WORK_VALUE_ONE,           -- 已推已售情况_货量(a)
            to_char((CASE WHEN AREA_HAVED_SALE=0 THEN 0 ELSE b.VALUE_HAVED_SALE/b.AREA_HAVED_SALE END ),'999,999,999,999,999.99') AS AVERAGE_VALUE_ONE,        -- 已推已售情况_均价(b)
            to_char(b.VALUE_HAVED_SALE/10000,'999,999,999,999,999.99') AS WORK_AMOUNT_ONE,          -- 已推已售情况_货值(c)

            to_char(b.AREA_STOCK,'999,999,999,999,999.99') AS WORK_VALUE_TWO,           -- 已推未售情况_货量(a)
            to_char((CASE WHEN AREA_STOCK=0 THEN 0 ELSE b.VALUE_STOCK/b.AREA_STOCK END ),'999,999,999,999,999.99') AS AVERAGE_VALUE_TWO,        -- 已推未售情况_均价(b)
            to_char(b.VALUE_STOCK/10000,'999,999,999,999,999.99') AS WORK_AMOUNT_TWO,          -- 已推未售情况_货值(c)

            to_char(b.AREA_NOT_PLANNING_PERMIT,'999,999,999,999,999.99') AS NO_SAVE_PLAN_PERMIT,      --0未取规证
            to_char(b.AREA_NOT_CONSTRUCTION_PERMIT,'999,999,999,999,999.99') AS PLAN_PERMIT_PHASE,        -- 1规划许可证阶段
            to_char(b.AREA_NOT_SALE_PERMIT,'999,999,999,999,999.99') AS CONSTRUCTION_PERMIT_PHASE,   -- 2施工许可证阶段
            to_char(b.AREA_NOT_COMPLETION,'999,999,999,999,999.99') AS PRE_SALE_PERMIT_PHASE,       -- 3预售许可证阶段
            to_char(b.AREA_YES_COMPLETION,'999,999,999,999,999.99') AS COMPLETED_PERMIT_PHASE,      -- 4竣工备案阶段
            to_char(b.AREA_YES_SETTLEMENT,'999,999,999,999,999.99') AS CARRY_FORWARD_PHASE          -- 5结转阶段
    FROM   dual a
    LEFT JOIN dwm_dt_value b ON 1=1 AND b.obj_id IN (SELECT t.id FROM mdm_build t WHERE t.proj_id=P_ID) --AND b.is_delete=0
    AND ROWNUM=1
    --ORDER BY b.obj_name
    */

		/*
      UNION ALL
    SELECT
      '3' AS ID,
      '2' AS PARENT_ID,
      '1' AS WORK_CODE,
      '1#' AS WORK_NAME,
      '1' AS RECENT_FLOORAGE_AREA,
      '1' AS RECENT_SALE_AREA,
      '1' AS GLOBAL_WORK_VALUE,
      '1' AS NO_PUSH_VALUE,
      '1' AS NO_SALE_VALUE,
      '1' AS SALE_VALUE,
      '1' AS NO_PLAN_PERMIT,
      '1' AS HOLD_PLAN_PERMIT,
      '1' AS HOLD_CONSTRUCTION_PERMIT,
      '1' AS WORK_VALUE_ONE,
      '1' AS AVERAGE_VALUE_ONE,
      '1' AS WORK_AMOUNT_ONE,
      '1' AS WORK_VALUE_TWO,
      '1' AS AVERAGE_VALUE_TWO,
      '1' AS WORK_AMOUNT_TWO,
      '1' AS NO_SAVE_PLAN_PERMIT,
      '1' AS PLAN_PERMIT_PHASE,
      '1' AS CONSTRUCTION_PERMIT_PHASE,
      '1' AS PRE_SALE_PERMIT_PHASE,
      '1' AS COMPLETED_PERMIT_PHASE,
      '1' AS CARRY_FORWARD_PHASE
      ,'' AS Obj_ID
    FROM
      dual a
    WHERE rownum=1

      UNION ALL
    SELECT
      '4' AS ID,
      '2' AS PARENT_ID,
      '2' AS WORK_CODE,
      '黄伟的楼栋' AS WORK_NAME,
      '1' AS RECENT_FLOORAGE_AREA,
      '1' AS RECENT_SALE_AREA,
      '1' AS GLOBAL_WORK_VALUE,
      '1' AS NO_PUSH_VALUE,
      '1' AS NO_SALE_VALUE,
      '1' AS SALE_VALUE,
      '1' AS NO_PLAN_PERMIT,
      '1' AS HOLD_PLAN_PERMIT,
      '1' AS HOLD_CONSTRUCTION_PERMIT,
      '1' AS WORK_VALUE_ONE,
      '1' AS AVERAGE_VALUE_ONE,
      '1' AS WORK_AMOUNT_ONE,
      '1' AS WORK_VALUE_TWO,
      '1' AS AVERAGE_VALUE_TWO,
      '1' AS WORK_AMOUNT_TWO,
      '1' AS NO_SAVE_PLAN_PERMIT,
      '1' AS PLAN_PERMIT_PHASE,
      '1' AS CONSTRUCTION_PERMIT_PHASE,
      '1' AS PRE_SALE_PERMIT_PHASE,
      '1' AS COMPLETED_PERMIT_PHASE,
      '1' AS CARRY_FORWARD_PHASE
      ,'' AS Obj_ID
    FROM
      dual
       */
		;

END P_DWM_GLOBAL_WORK_VALUE;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_K1DATALIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_K1DATALIST" 
(
rowNum number
,sortField varchar2 default 'foSaleRateByMoney'
,orderBy varchar2 default 'desc'
,k1DataList OUT sys_refcursor
)
AS  
v_sql clob :='';
whereStr varchar2(500):='';
-- 用于返回筛选的列
v_column clob :='';
-- 用于解决排序字段有span标签问题
sortStr varchar2(100):='';
begin
sortStr := sortField;
  if sortStr = 'firstOpenDate' then
    sortStr := 'FIRST_OPEN_DATE';
  elsif sortStr = 'foSaleRateByMoney' then
    sortStr := 'fo_sale_rate_by_money';
  elsif sortStr = 'foSaleMoney' then
    sortStr := 'fo_sale_money'; 
  elsif sortStr = 'foSaleOutMoney' then
    sortStr := 'fo_sale_out_money';
  elsif sortStr = 'foSaleRateByCount' then
    sortStr := 'fo_sale_rate_by_count';
  elsif sortStr = 'foSaleCount' then
    sortStr := 'fo_sale_count';
  elsif sortStr = 'foSaleOutCount' then
    sortStr := 'fo_sale_out_count';
  elsif sortStr = 'foSaleRateByArea' then
    sortStr := 'fo_sale_rate_by_area';
  elsif sortStr = 'foSaleArea' then
    sortStr := 'fo_sale_area';
  elsif sortStr = 'foSaleOutArea' then
    sortStr := 'fo_sale_out_area';
  elsif sortStr = 'projectName' then
    sortStr := 'projectNameCopy';  
  end if;
--execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd''';
v_sql:='
SELECT
    p.FIRST_OPEN_DATE as "FIRST_OPEN_DATE",
    NVL(fo.fo_sale_rate_by_money,0) as "fo_sale_rate_by_money",
    NVL(fo.fo_sale_money,0) as "fo_sale_money",
    NVL(fo.fo_sale_out_money,0) as "fo_sale_out_money",
    NVL(fo.fo_sale_rate_by_count,0) as "fo_sale_rate_by_count",
    NVL(fo.fo_sale_count,0) as "fo_sale_count",
    NVL(fo.fo_sale_out_count,0) as "fo_sale_out_count",
    NVL(fo.fo_sale_rate_by_area,0) as "fo_sale_rate_by_area",
    NVL(fo.fo_sale_area,0) as "fo_sale_area",
    NVL(fo.fo_sale_out_area,0) as "fo_sale_out_area",

    p.PROJECT_NAME as "projectNameCopy",
    case when fo.fo_sale_rate_by_money is not null then
    FN_DWM_DEC_CONVERT_PCT(fo.fo_sale_rate_by_money) else ''0%'' end as "foSaleRateByMoneyCopy",
    case when fo.fo_sale_rate_by_count is not null then
    FN_DWM_DEC_CONVERT_PCT(fo.fo_sale_rate_by_count) else ''0%'' end as "foSaleRateByCountCopy",
    case when fo.fo_sale_rate_by_area is not null then
    FN_DWM_DEC_CONVERT_PCT(fo.fo_sale_rate_by_area) else ''0%'' end as "foSaleRateByAreaCopy",

    p.project_id as "projectId",
    FN_DWM_FONT_COLOR(p.PROJECT_NAME) as "projectName",
    to_char(p.FIRST_OPEN_DATE,''yyyy-mm-dd'')  as "firstOpenDate",
    case when fo.fo_sale_rate_by_money is not null then
    FN_DWM_FONT_COLOR(FN_DWM_DEC_CONVERT_PCT(fo.fo_sale_rate_by_money)) else FN_DWM_FONT_COLOR(''0%'') end as "foSaleRateByMoney",
    FN_DWM_MULTIPLE_AND_UNIT(fo.fo_sale_money, 100000000, ''亿'') as "foSaleMoney",
    FN_DWM_MULTIPLE_AND_UNIT(fo.fo_sale_out_money, 100000000, ''亿'') as "foSaleOutMoney",
    case when fo.fo_sale_rate_by_count is not null then
    FN_DWM_FONT_COLOR(FN_DWM_DEC_CONVERT_PCT(fo.fo_sale_rate_by_count)) else FN_DWM_FONT_COLOR(''0%'') end as "foSaleRateByCount",
    case when fo.fo_sale_count is not null then
    fo.fo_sale_count || ''套'' else ''0套'' end as "foSaleCount",
    case when fo.fo_sale_out_count is not null then
    fo.fo_sale_out_count || ''套'' else ''0套'' end  as "foSaleOutCount",
    case when fo.fo_sale_rate_by_area is not null then
    FN_DWM_FONT_COLOR(FN_DWM_DEC_CONVERT_PCT(fo.fo_sale_rate_by_area)) else FN_DWM_FONT_COLOR(''0%'') end as "foSaleRateByArea",
    FN_DWM_MULTIPLE_AND_UNIT(fo.fo_sale_area, 10000, ''万方'') as "foSaleArea",
    FN_DWM_MULTIPLE_AND_UNIT(fo.fo_sale_out_area, 10000, ''万方'') as "foSaleOutArea"
FROM
    dwm_sale_rate_by_project fo right join 
    DWM_SALE_RATE_PROJECT p on fo.project_id=p.project_id  
    where p.PROJECT_NAME is not null and TO_DATE(trunc(sysdate,''yyyy'')) <= p.FIRST_OPEN_DATE';
v_column := ' "projectId",
      "projectName",
      "firstOpenDate",
      "foSaleRateByMoney",
      "foSaleMoney",
      "foSaleOutMoney",
      "foSaleRateByCount",
      "foSaleCount",
      "foSaleOutCount",
      "foSaleRateByArea",
      "foSaleArea",
      "foSaleOutArea",

      "projectNameCopy",
      "foSaleRateByMoneyCopy",
      "foSaleRateByCountCopy",
      "foSaleRateByAreaCopy"';    
--    if rowNum <> 0 then
--    whereStr:='where rownum<= ' || rowNum;
--    end if;
    if sortStr is not null and orderBy is not null then
        whereStr:=whereStr||' order by tab."'||sortStr|| '"  '||orderBy || ' nulls last ';
    end if;
    if whereStr is not null then
        v_sql:='select ' || v_column || ' from ('||v_sql||') tab '||whereStr;
    else
        v_sql:='select ' || v_column || ' from (' ||v_sql || ' )';
    end if;
    -- 选择前n条数据，rownum必须拼接在排序后面，不然会先运行rownum再运行排序，会导致筛选数据并不准确
    if rowNum <> 0 then
        v_sql := 'select ' || v_column || ' from (' ||v_sql || ' )' || ' where rownum <= ' || rowNum;
    end if; 
    dbms_output.put_line(v_sql);
OPEN k1DataList FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE k1DataList;
END P_DWM_K1DataList;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_PREPARE_DATALIST_K2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_PREPARE_DATALIST_K2" 
(
  sortField IN VARCHAR2
, orderBy IN VARCHAR2 
, rowNumber IN number
, k2PrepareDataList OUT sys_refcursor 
) AS
whereStr varchar2(500):='';
v_sql clob :='';
-- 用于返回筛选的列
v_column clob :='';
-- 用于解决排序字段有span标签问题
sortStr varchar2(100):='';
BEGIN
  sortStr := sortField;
  if sortStr = 'takeLandDate' then
    sortStr := 'TAKE_LAND_DATE';
  elsif sortStr = 'planFirstOpenDate' then
    sortStr := 'PLAN_FIRST_OPEN_DATE';
  elsif sortStr = 'firstOpenDurationByPlan' then
    sortStr := 'FIRST_OPEN_DURATION_BY_PLAN'; 
  elsif sortStr = 'newPlanFirstOpenDate' then
    sortStr := 'NEW_PLAN_FIRST_OPEN_DATE';   
  end if;
  v_sql:='select
        TAKE_LAND_DATE,
        PLAN_FIRST_OPEN_DATE,
        NVL(FIRST_OPEN_DURATION_BY_PLAN,0) as "FIRST_OPEN_DURATION_BY_PLAN",
        NEW_PLAN_FIRST_OPEN_DATE,

        PROJECT_NAME as "projectNameCopy",
        FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_PLAN) as "firstOpenDurationByPlanCopy",
        Fn_DWM_RiskSummaryDeal(PLAN_FIRST_OPEN_DATE,NEW_PLAN_FIRST_OPEN_DATE,''pure'') as "risKAbstractCopy",

        PROJECT_ID as "projectId", 
        FN_DWM_FONT_COLOR(PROJECT_NAME) as "projectName",
        to_char(TAKE_LAND_DATE,''yyyy-mm-dd'') as "takeLandDate",
        to_char(PLAN_FIRST_OPEN_DATE,''yyyy-mm-dd'') as "planFirstOpenDate",  
        FN_DWM_FONT_COLOR(FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_PLAN)) as "firstOpenDurationByPlan",
        to_char(NEW_PLAN_FIRST_OPEN_DATE,''yyyy-mm-dd'') as "newPlanFirstOpenDate",
        Fn_DWM_RiskSummaryDeal(PLAN_FIRST_OPEN_DATE,NEW_PLAN_FIRST_OPEN_DATE,''label'') as "risKAbstract"
    from DWM_SALE_RATE_PROJECT
    where (to_number(to_char(PLAN_FIRST_OPEN_DATE,''yyyy'')) = to_number(to_char(sysdate,''yyyy'')) or to_number(to_char(NEW_PLAN_FIRST_OPEN_DATE,''yyyy'')) = to_number(to_char(sysdate,''yyyy'')))  and FIRST_OPEN_DATE is null';
  v_column := ' "projectId",
      "projectName",
      "projectNameCopy",
      "takeLandDate",
      "planFirstOpenDate",
      "firstOpenDurationByPlan",
      "firstOpenDurationByPlanCopy",
      "newPlanFirstOpenDate",
      "risKAbstract",
      "risKAbstractCopy" ';
--    if rowNumber <> 0 then
--    whereStr:='where rownum<= ' || rowNumber;
--    end if;
    if sortStr is not null and orderBy is not null then
    whereStr:=whereStr||' order by tab."'||sortStr||'"  '||orderBy;
    end if;
    if whereStr is not null then
    v_sql:='select ' || v_column || ' from ('||v_sql||') tab '||whereStr;
    else
    v_sql:='select ' || v_column || ' from (' ||v_sql || ' )';
    end if;
    -- 选择前n条数据，rownum必须拼接在排序后面，不然会先运行rownum再运行排序，会导致筛选数据并不准确
    if rowNumber <> 0 then
        v_sql := 'select ' || v_column || ' from (' ||v_sql || ' )' || ' where rownum <= ' || rowNumber;
    end if;
  dbms_output.put_line(v_sql);  
  OPEN k2PrepareDataList FOR v_sql;
  EXCEPTION
    WHEN OTHERS THEN
  CLOSE k2PrepareDataList;
END P_DWM_PREPARE_DATALIST_K2;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_PROJECTSALERATEDATALIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_PROJECTSALERATEDATALIST" (filter in clob,keyWord in varchar2,rowCnt in number,sortField in varchar,orderby in varchar,items out sys_refcursor,total out number)
as
groupName varchar2(200);
v_sql  clob:='';
v_where clob:='';
v_org_where clob:='';
filterItemStr clob:='';
hasAll number;
ItemStr varchar(1000);
orderbyStr  varchar(1000);
sortFieldStr varchar(1000);
yearStr varchar(1000);
v_count_sql clob:='';
top_str  varchar(100);
RowCount number;
detailstr clob:='';
begin
delete PERSON_ROLE_ANALYSIS_TABLE;
 if filter is not null then
insert into PERSON_ROLE_ANALYSIS_TABLE (code,detail,type )  SELECT  SYS_GUID(),COLUMN_VALUE ,'filter' FROM table (split (filter,';'));
        for item in ( SELECT code,detail FROM  PERSON_ROLE_ANALYSIS_TABLE where type='filter' ) loop
               if INSTR(item.detail,':')<>0 then
                    groupName:= SUBSTR(item.detail,0,INSTR(item.detail,':')-1);
                    detailstr:=REPLACE(item.detail,groupName||':','');
                    if detailstr is not null then
                        update PERSON_ROLE_ANALYSIS_TABLE set detail= REPLACE(item.detail,groupName||':',''),type=groupName  where code=item.code;
                    end if;
                else
                    delete PERSON_ROLE_ANALYSIS_TABLE where code=item.code;
               end if;
      end loop;    
end if;

select count(1) into  RowCount from PERSON_ROLE_ANALYSIS_TABLE where  type='isStart';
if RowCount<>0 then
    select detail into filterItemStr from PERSON_ROLE_ANALYSIS_TABLE where  type='isStart' and rownum=1;
    if filterItemStr is not null then
        SELECT count(1) into hasAll  FROM table (split (filterItemStr,',')) where COLUMN_VALUE='all' ;
        if hasAll=0 then
            v_where:=' and tab."isConstructionBegan" in ('||filterItemStr||')';
        end if;
    end if;
end if;

select count(1) into  RowCount from PERSON_ROLE_ANALYSIS_TABLE where  type='opening';
if RowCount<>0 then
    select detail into filterItemStr from PERSON_ROLE_ANALYSIS_TABLE where  type='opening' and rownum=1;
    if filterItemStr is not null then
        SELECT count(1) into hasAll  FROM table (split (filterItemStr,',')) where COLUMN_VALUE='all' ;
        if hasAll=0 then
            v_where:=v_where||' and tab."hasFirstOpenDate" in ('||filterItemStr||')';
        end if;
    end if;
end if;

select count(1) into  RowCount from PERSON_ROLE_ANALYSIS_TABLE where  type='isOperate';
if RowCount<>0 then
    select detail into filterItemStr from PERSON_ROLE_ANALYSIS_TABLE where  type='isOperate' and rownum=1;
    if filterItemStr is not null then
        SELECT count(1) into hasAll  FROM table (split (filterItemStr,',')) where COLUMN_VALUE='all' ;
        if hasAll=0 then
            v_where:=v_where||' and tab."isOperate" in ('||filterItemStr||')';
        end if;
    end if;
end if;

select count(1) into  RowCount from PERSON_ROLE_ANALYSIS_TABLE where  type='isHasExistingHouse';
if RowCount<>0 then
    select detail into filterItemStr from PERSON_ROLE_ANALYSIS_TABLE where  type='isHasExistingHouse' and rownum=1;
    if filterItemStr is not null then
        SELECT count(1) into hasAll  FROM table (split (filterItemStr,',')) where COLUMN_VALUE='all' ;
        if hasAll=0 then
            v_where:=v_where||' and tab."isHasExistingHouse" in ('||filterItemStr||')';
        end if;
    end if;
end if;

select count(1) into  RowCount from PERSON_ROLE_ANALYSIS_TABLE where  type='openingYear';
if RowCount<>0 then
    select detail into filterItemStr from PERSON_ROLE_ANALYSIS_TABLE where  type='openingYear' and rownum=1;
    if filterItemStr is not null then
        SELECT count(1) into hasAll  FROM table (split (filterItemStr,',')) where COLUMN_VALUE='all' ;
        if hasAll=0 then
             v_where:=v_where||' and ( ';
                 for item in (  SELECT COLUMN_VALUE as detail FROM table (split (filterItemStr)) ) loop
                        if INSTR(item.detail,'<')<>0 then
                                if yearStr is null then 
                                    yearStr:=yearStr||' to_number(to_char(tab."firstOpenDateValue",''yyyy''))<'||REPLACE(item.detail,'<','');
                                else
                                    yearStr:=yearStr||' or to_number(to_char(tab."firstOpenDateValue",''yyyy''))<'||REPLACE(item.detail,'<','');
                                end if;
                        else
                                  if yearStr is null then 
                                    yearStr:=yearStr||' to_number(to_char(tab."firstOpenDateValue",''yyyy''))='||item.detail;
                                else
                                    yearStr:=yearStr||' or to_number(to_char(tab."firstOpenDateValue",''yyyy''))='||item.detail;
                                end if;
                        end if;
                  end loop;   
                  if yearStr is null then
                    yearStr:=' 1=1 ';
                  end if;
               v_where:=v_where||yearStr||')';
        end if;
    end if;
end if;

select count(1) into  RowCount from PERSON_ROLE_ANALYSIS_TABLE where  type='obtainYear';
if RowCount<>0 then
    select detail into filterItemStr from PERSON_ROLE_ANALYSIS_TABLE where  type='obtainYear' and rownum=1;
    if filterItemStr is not null then
        SELECT count(1) into hasAll  FROM table (split (filterItemStr,',')) where COLUMN_VALUE='all' ;
        if hasAll=0 then
             v_where:=v_where||' and ( ';
                 for item in (  SELECT COLUMN_VALUE as detail FROM table (split (filterItemStr)) ) loop
                        if INSTR(item.detail,'<')<>0 then
                                if yearStr is null then 
                                    yearStr:=yearStr||' to_number(to_char(tab."obtainDateValue",''yyyy''))<'||REPLACE(item.detail,'<','');
                                else
                                    yearStr:=yearStr||' or to_number(to_char(tab."obtainDateValue",''yyyy''))<'||REPLACE(item.detail,'<','');
                                end if;
                        else
                                  if yearStr is null then 
                                    yearStr:=yearStr||' to_number(to_char(tab."obtainDateValue",''yyyy''))='||item.detail;
                                else
                                    yearStr:=yearStr||' or to_number(to_char(tab."obtainDateValue",''yyyy''))='||item.detail;
                                end if;
                        end if;
                  end loop;   
                  if yearStr is null then
                    yearStr:=' 1=1 ';
                  end if;
              v_where:=v_where||yearStr||')';
        end if;
    end if;
end if;

select count(1) into  RowCount from PERSON_ROLE_ANALYSIS_TABLE where  type='org';
if RowCount<>0 then
    select detail into filterItemStr from PERSON_ROLE_ANALYSIS_TABLE where  type='org' and rownum=1;
    if filterItemStr is not null then
        SELECT count(1) into hasAll  FROM table (split (filterItemStr,',')) where COLUMN_VALUE='all' ;
        if hasAll=0 then
               v_org_where:=' inner join 
               (select id from SYS_BUSINESS_UNIT m start with m.id in (SELECT COLUMN_VALUE FROM table (split ('''||filterItemStr||''','',''))) 
               connect by m.PARENT_ID=prior m.id) unit
               on unit.id=tab.org_id ';
        end if;
    end if;
end if;

if sortField is null then
sortFieldStr:='foSaleRateByCountValue';
else
sortFieldStr:=sortField||'Value';
end if;
if orderby is null then
orderbyStr:='desc';
else
orderbyStr:=orderby;
end if;

if rowcnt=30 or rowcnt is null  then
    top_str:=' rownum<=30 ';
end if;

if keyWord is not null then
    v_where:=v_where||' and tab."projectName"  like  ''%'||keyWord||'%'' ';
end if;

 dbms_output.put_line(v_where);

v_sql:='select * from(SELECT
    proj.project_id as "project_id", 
    proj.project_name as "projectNameValue",
    FN_DWM_FONT_COLOR(proj.project_name) as "projectName",
    proj.org_id,
    proj.IS_OPERATE as "isOperate",
    case when rate.si_surplus_sale_money is not null and rate.si_surplus_sale_money <> 0 then 1 else 0 end as "isHasExistingHouse",
    case when proj.FIRST_OPEN_DATE is not null then 1 else 0 end as "hasFirstOpenDate",
    proj.IS_CONSTRUCTION_BEGAN as "isConstructionBegan",
    proj.FIRST_OPEN_DURATION_BY_TL as "firstOpenDurationByTlValue",
    FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_TL) as "firstOpenDurationByTlText",
    FN_DWM_FONT_COLOR(FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_TL)) as "firstOpenDurationByTl",
    proj.OBTAIN_DATE as "obtainDateValue",
    to_char(proj.OBTAIN_DATE,''yyyy-mm-dd'') as "obtainDate",
    proj.FIRST_OPEN_DATE  as "firstOpenDateValue",
    to_char(proj.FIRST_OPEN_DATE,''yyyy-mm-dd'')  as "firstOpenDate",
    case when rate.fo_sale_rate_by_count is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(rate.fo_sale_rate_by_count)) else 
    FN_DWM_FONT_COLOR(''0%'') end as "foSaleRateByCount",

   case when rate.fo_sale_rate_by_count is not null then
   rate.fo_sale_rate_by_count*100 else 
   0 end as "foSaleRateByCountValue",

   case when rate.fo_sale_rate_by_count is not null then
   fn_ConvertDecimalToPercentage(rate.fo_sale_rate_by_count) else 
   ''0%'' end as "foSaleRateByCountText",

    case when rate.po_sale_rate_by_money is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(rate.po_sale_rate_by_money)) else 
    FN_DWM_FONT_COLOR(''0%'') end as "poSaleRateByMoney",

    case when rate.po_sale_rate_by_money is not null then
   rate.po_sale_rate_by_money*100 else 
    0 end as "poSaleRateByMoneyValue",

     case when rate.po_sale_rate_by_money is not null then
    fn_ConvertDecimalToPercentage(rate.po_sale_rate_by_money) else 
    ''0%'' end as "poSaleRateByMoneyText",

    case when rate.eh_sale_rate_by_money is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(rate.eh_sale_rate_by_money)) else 
    FN_DWM_FONT_COLOR(''0%'') end as "ehSaleRateByMoney",

    case when rate.eh_sale_rate_by_money is not null then
    fn_ConvertDecimalToPercentage(rate.eh_sale_rate_by_money) else 
    ''0%'' end as "ehSaleRateByMoneyText",

    case when rate.eh_sale_rate_by_money is not null then
    rate.eh_sale_rate_by_money*100 else 
    0 end as "ehSaleRateByMoneyValue",


    case when rate.si_sale_rate_by_money is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(rate.si_sale_rate_by_money)) else 
    FN_DWM_FONT_COLOR(''0%'') end as "siSaleRateByMoney",

    case when rate.si_sale_rate_by_money is not null then
    rate.si_sale_rate_by_money*100 else 
    0 end as "siSaleRateByMoneyValue",

    case when rate.si_sale_rate_by_money is not null then
    fn_ConvertDecimalToPercentage(rate.si_sale_rate_by_money) else 
    ''0%'' end as "siSaleRateByMoneyText",

    case when rate.po_surplus_sale_money is not null then
    FN_DWN_AmountToBillionYuan(rate.po_surplus_sale_money) else 
    ''0.00亿'' end as "poSurplusSaleMoney",

    case when rate.eh_surplus_sale_money is not null then
    FN_DWN_AmountToBillionYuan(rate.eh_surplus_sale_money) else 
    ''0.00亿'' end as "ehSurplusSaleMoney",

     case when rate.si_surplus_sale_money is not null then
    FN_DWN_AmountToBillionYuan(rate.si_surplus_sale_money) else 
    ''0.00亿'' end as "siSurplusSaleMoney",

     case when rate.po_surplus_sale_money is not null then
     rate.po_surplus_sale_money   else 
    0 end as "poSurplusSaleMoneyValue",

      case when rate.eh_surplus_sale_money is not null then
     rate.eh_surplus_sale_money   else 
    0 end as "ehSurplusSaleMoneyValue",

      case when rate.si_surplus_sale_money is not null then
     rate.si_surplus_sale_money   else 
    0 end as "siSurplusSaleMoneyValue"

FROM
   DWM_SALE_RATE_PROJECT proj left join dwm_sale_rate_by_project rate on proj.project_id=rate.project_id) tab';
   v_sql:=v_sql||v_org_where||' where 1=1 '|| v_where;
   v_count_sql:='select count(1) FROM ('||v_sql||') tabCount';
   if top_str is not null then
    v_sql:='select * from ('||v_sql||' order by tab."'||sortFieldStr||'" '||orderbyStr||') list where '||top_str ;
   else
    v_sql:=v_sql||' order by tab."'||sortFieldStr||'" '||orderbyStr;
   end if;
 dbms_output.put_line(v_sql);
   execute immediate v_count_sql into total;  
    OPEN items FOR v_sql;
    EXCEPTION
    WHEN OTHERS THEN
      CLOSE items;
 end P_DWM_ProjectSaleRateDataList;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_SALE_RATE_BY_GRANULARITY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_SALE_RATE_BY_GRANULARITY" (
    spid_info   OUT  SYS_REFCURSOR,
    t_room_info   OUT  SYS_REFCURSOR ,
    spid_tree_info   OUT  SYS_REFCURSOR
) AS
		--业态面积段颗粒度去化率；作用=》定时任务拍照
		--作者：陈丽
		--日期：2020-04-10
  PROJ_BASE_SPID VARCHAR2(2000);
  sys_created date:=sysdate;
  spid VARCHAR2(360); --使用临时表的批次号
  spid_tree VARCHAR2(360); --使用临时表的批次号
  dwm_REMARK VARCHAR2(200):='测试-chenl';
  ----------------------
  v_sql clob;
  v_sql_start VARCHAR2(2000):= ' case ';
  v_sql_content clob:= '';
  v_sql_end VARCHAR2(2000):= '  else ''主数据面积段外'' end  ';
BEGIN
delete TMP_ROOM;
delete TMP_SALE_RATE_BY_GRANULARITY;
---------------------------
--------------------------------------------------------创建临时表批次号
    SELECT
        get_uuid(),get_uuid()
    INTO spid,spid_tree
    FROM
        dual;  
---------------------------------------------计算业态面积段1.拼接查询语句
 FOR item IN (
   select 
    ' when '||l.lower_limit_value||l.lower_limit_type||'room.NEW_BLD_AREA and room.NEW_BLD_AREA '||l.upper_limit_type||l.upper_limit_value
    ||' and (case when room.PRODUCT_NAME<>''住宅'' then ''商铺及其他'' else ''住宅'' end)='''||p.attribute_name||''' then ''' ||l.attribute_name||''' ' as aa,
    l.upper_limit_type,
    l.lower_limit_type,
    l.upper_limit_value,
    p.attribute_name as ptype from mdm_attribute_area_level l
    left join mdm_attribute_area_level p on l.parent_id=p.id 
    where p.id is not null
        ) LOOP 
    ---拼接字符串
         v_sql_content := v_sql_content||item.aa;
        END LOOP;
    --规则内容大于0才拼规则语句
        IF length(v_sql_content) > 0 THEN
            v_sql := v_sql_start
                     || v_sql_content
                     || v_sql_end;
        ELSE
            v_sql := '''''';
        END IF;

       v_sql:= 'INSERT INTO TMP_ROOM(id,room_ID,BLD_AREA,ROOM_NAME,PRODUCT_NAME,AREA_LEVEL) select '''||spid||''',id,NEW_BLD_AREA,room_name,case when room.product_name<>''住宅'' then ''商铺及其他'' else ''住宅'' end,'
       ||v_sql|| ' as NODE_WARNING from mdm_room room';
         dbms_output.put_line(v_sql);
       execute immediate v_sql;

        OPEN t_room_info FOR select * from TMP_ROOM;  
-----------------------------------------------项目基本信息
BEGIN
  P_DWM_SALE_RATE_PROJ(0,
    PROJ_BASE_SPID => PROJ_BASE_SPID
  );
    END;
 ------------------------------------------------------------业态面积段树拼接 spid_tree
 INSERT INTO TMP_SALE_RATE_BY_GRANULARITY (ID---【1】主键
,"SORT"
,GRANULARITY_ID--颗粒度id
,PROJECT_ID---【2】项目ID
,PROJECT_NAME--项目名称
,PARENT_ID---父级id
,DATA_GRANULARITY--颗粒度名称
)
-----业态
select spid_tree
,b.order_code
,proj.PROJECT_ID||b."业态" as GRANULARITY_ID
,proj.PROJECT_ID as projectId
,proj.PROJECT_NAME
,null as parentId 
,b."业态" as text   
 from (select * from tmp_proj_base where id = PROJ_BASE_SPID) proj cross join
(select 
   case when l.attribute_name<>'住宅' then '商铺及其他' else '住宅' end  as "业态",order_code  from mdm_attribute_area_level l where parent_id is null) b
   union all
-----面积段
select spid_tree
,a.order_code
,proj.PROJECT_ID||ptype||a.areaStage as GRANULARITY_ID
,proj.PROJECT_ID as projectId
,proj.PROJECT_NAME
,proj.PROJECT_ID||ptype as parentId 
,a.areaStage as text
from  (select * from tmp_proj_base where id = PROJ_BASE_SPID) proj cross join
( select 
    l.attribute_name as areaStage,l.order_code,case when p.attribute_name<>'住宅' then '商铺及其他' else '住宅' end  as ptype from mdm_attribute_area_level l
    left join mdm_attribute_area_level p on l.parent_id=p.id 
    where p.id is not null) a;

OPEN spid_tree_info FOR select * from TMP_SALE_RATE_BY_GRANULARITY where id=spid_tree;  
------------------------------------------------------面积段数据 spid

 INSERT INTO TMP_SALE_RATE_BY_GRANULARITY (ID---【1】主键
,GRANULARITY_ID
,PROJECT_ID---【2】项目ID
,PROJECT_NAME
,FO_SALE_OUT_COUNT---【3】首开去化套数
,FO_SALE_COUNT---【4】首开推售套数
,FO_SALE_RATE_BY_COUNT---【5】首开去化率(按套数)（3/4）
,FO_SALE_OUT_AREA---【6】首开去化面积
,FO_SALE_AREA---【7】首开推售面积
,FO_SALE_RATE_BY_AREA---【8】首开去化率(按面积)（6/7）
,FO_SALE_OUT_MONEY---【9】首开去化货值
,FO_SALE_MONEY---【10】首开推售货值
,FO_SALE_RATE_BY_MONEY---【11】首开去化率(按货值)（9/10）
,FO_SURPLUS_SALE_MONEY---【12】首开剩余货值(10-9)
,FO_SALE_AVERAGE_MONEY---【13】首开标准均价(10/7)
,FO_SALE_OUT_AVERAGE_MONEY---【14】首开签约均价(9/6)
,PO_SALE_OUT_COUNT---【15】全案去化套数
,PO_SALE_COUNT---【16】全案推售套数
,PO_SALE_RATE_BY_COUNT---【17】全案去化率(按套数)(15/16)
,PO_SALE_OUT_AREA---【18】全案去化面积
,PO_SALE_AREA---【19】全案推售面积
,PO_SALE_RATE_BY_AREA---【20】全案去化率(按面积)(18/19)
,PO_SALE_OUT_MONEY---【21】全案去化货值
,PO_SALE_MONEY---【22】全案推售货值
,PO_SALE_RATE_BY_MONEY---【23】全案去化率(按货值)(21/22)
,PO_SURPLUS_SALE_MONEY---【24】全案剩余货值(22-21)
,PO_SALE_AVERAGE_MONEY---【25】全案标准均价(22/19)
,PO_SALE_OUT_AVERAGE_MONEY---【26】全案签约均价(21/18)
,EH_SALE_OUT_COUNT---【27】现房去化套数
,EH_SALE_COUNT---【28】现房推售套数
,EH_SALE_RATE_BY_COUNT---【29】现房去化率(按套数)(27/28)
,EH_SALE_OUT_AREA---【30】现房去化面积
,EH_SALE_AREA---【31】现房推售面积
,EH_SALE_RATE_BY_AREA---【32】现房去化率(按面积)(30/31)
,EH_SALE_OUT_MONEY---【33】现房去化货值
,EH_SALE_MONEY---【34】现房推售货值
,EH_SALE_RATE_BY_MONEY---【35】现房去化率(按货值)(33/34)
,EH_SURPLUS_SALE_MONEY---【36】现房剩余货值(34-33)
,EH_SALE_AVERAGE_MONEY---【37】现房标准均价(34/31)
,EH_SALE_OUT_AVERAGE_MONEY---【38】现房签约均价(33/30)
,SI_SALE_OUT_COUNT---【39】顽固性库存去化套数
,SI_SALE_COUNT---【40】顽固性库存推售套数
,SI_SALE_RATE_BY_COUNT---【41】顽固性库存去化率(按套数)(39/40)
,SI_SALE_OUT_AREA---【42】顽固性库存去化面积
,SI_SALE_AREA---【43】顽固性库存推售面积
,SI_SALE_RATE_BY_AREA---【44】顽固性库存去化率(按面积)(42/43)
,SI_SALE_OUT_MONEY---【45】顽固性库存去化货值
,SI_SALE_MONEY---【46】顽固性库存推售货值
,SI_SALE_RATE_BY_MONEY---【47】顽固性库存去化率(按货值)(45/46)
,SI_SURPLUS_SALE_MONEY---【48】顽固性库存剩余货值(46-45)
,SI_SALE_AVERAGE_MONEY---【49】顽固性库存标准均价(46/43)
,SI_SALE_OUT_AVERAGE_MONEY---【50】顽固性库存签约均价(45/42)
,PARENT_ID  
,DATA_GRANULARITY
,PRODUCT_NAME
,CREATED---【51】创建日期
,REMARK
)select 
spid as ID---【1】主键
,project_id||PRODUCT_NAME||AREA_LEVEL
,project_id as PROJECT_ID---【2】项目ID
,project_name
-----------------------------------K1、首开去化率开始--------------------
,"首开去化套数" as FO_SALE_OUT_COUNT---【3】首开去化套数
,"首开推售套数" as FO_SALE_COUNT---【4】首开推售套数
,case when 首开推售套数=0 then 0 else round("首开去化套数"/"首开推售套数",4)  end as FO_SALE_RATE_BY_COUNT---【5】首开去化率(按套数)（3/4）
,"首开去化面积" as FO_SALE_OUT_AREA---【6】首开去化面积
,"首开推售面积" as FO_SALE_AREA---【7】首开推售面积
,case when 首开推售面积=0 then 0 else round("首开去化面积"/"首开推售面积",4)  end as FO_SALE_RATE_BY_AREA---【8】首开去化率(按面积)（6/7）
,"首开去化货值" as FO_SALE_OUT_MONEY---【9】首开去化货值
,"首开推售货值" as FO_SALE_MONEY---【10】首开推售货值
,case when 首开推售货值=0 then 0 else round("首开去化货值"/"首开推售货值",4)  end as FO_SALE_RATE_BY_MONEY---【11】首开去化率(按货值)（9/10）
,"首开推售货值"-"首开去化货值" as FO_SURPLUS_SALE_MONEY---【12】首开剩余货值(10-9)
,case when 首开推售面积=0 then 0 else round("首开推售货值"/"首开推售面积",4)  end  as FO_SALE_AVERAGE_MONEY---【13】首开标准均价(10/7)
,case when 首开去化面积=0 then 0 else round("首开去化货值"/"首开去化面积",4)  end as FO_SALE_OUT_AVERAGE_MONEY---【14】首开签约均价(9/6)
-----------------------------------K3、全案去化率 （单位：%）--------------------
,"全案已去化套数" as PO_SALE_OUT_COUNT---【15】全案去化套数
,"全案已领证套数" as PO_SALE_COUNT---【16】全案推售套数
,case when 全案已领证套数=0 then 0 else round("全案已去化套数"/"全案已领证套数",4)  end as PO_SALE_RATE_BY_COUNT---【17】全案去化率(按套数)(15/16)
,"全案已去化面积" as PO_SALE_OUT_AREA---【18】全案去化面积
,"全案已领证面积" as PO_SALE_AREA---【19】全案推售面积
,case when 全案已领证面积=0 then 0 else round("全案已去化面积"/"全案已领证面积",4)  end as PO_SALE_RATE_BY_AREA---【20】全案去化率(按面积)(18/19)
,"全案已去化货值" as PO_SALE_OUT_MONEY---【21】全案去化货值
,"全案已领证货值" as PO_SALE_MONEY---【22】全案推售货值
,case when 全案已领证货值=0 then 0 else round("全案已去化货值"/"全案已领证货值",4)  end  as PO_SALE_RATE_BY_MONEY---【23】全案去化率(按货值)(21/22)
,"全案已领证货值"-"全案已去化货值" as PO_SURPLUS_SALE_MONEY---【24】全案剩余货值(22-21)
,case when 全案已领证面积=0 then 0 else round("全案已领证货值"/"全案已领证面积",4)  end  as PO_SALE_AVERAGE_MONEY---【25】全案标准均价(22/19)
,case when 全案已去化面积=0 then 0 else round("全案已去化货值"/"全案已去化面积",4)  end   PO_SALE_OUT_AVERAGE_MONEY---【26】全案签约均价(21/18)
-----------------------------------K4、现房去化率 （单位：%）--------------------
,"现房去化套数" as EH_SALE_OUT_COUNT---【27】现房去化套数
,"现房推售套数" as EH_SALE_COUNT---【28】现房推售套数
,case when 现房推售套数=0 then 0 else  round("现房去化套数"/"现房推售套数",4) end as EH_SALE_RATE_BY_COUNT---【29】现房去化率(按套数)(27/28)
,"现房去化面积" as EH_SALE_OUT_AREA---【30】现房去化面积
,"现房推售面积" as EH_SALE_AREA---【31】现房推售面积
,case when 现房推售面积=0 then 0 else  round("现房去化面积"/"现房推售面积",4) end as EH_SALE_RATE_BY_AREA---【32】现房去化率(按面积)(30/31)
,"现房去化金额" as EH_SALE_OUT_MONEY---【33】现房去化货值
,"现房推售金额" as EH_SALE_MONEY---【34】现房推售货值
,case when 现房推售金额=0 then 0 else  round("现房去化金额"/"现房推售金额",4) end as EH_SALE_RATE_BY_MONEY---【35】现房去化率(按货值)(33/34)
,"现房推售金额"-"现房去化金额" as EH_SURPLUS_SALE_MONEY---【36】现房剩余货值(34-33)
,case when 现房推售面积=0 then 0 else  round("现房推售金额"/"现房推售面积",4) end  as EH_SALE_AVERAGE_MONEY---【37】现房标准均价(34/31)
,case when 现房去化面积=0 then 0 else  round("现房去化金额"/"现房去化面积",4) end  as EH_SALE_OUT_AVERAGE_MONEY---【38】现房签约均价(33/30)
-----------------------------------K5、顽固性库存去化率 （单位：%）--------------------
,"顽固去化套数" as SI_SALE_OUT_COUNT---【39】顽固性库存去化套数
,"顽固推售套数" as SI_SALE_COUNT---【40】顽固性库存推售套数
,case when 顽固推售套数=0 then 0 else  round("顽固去化套数"/"顽固推售套数",4) end as SI_SALE_RATE_BY_COUNT---【41】顽固性库存去化率(按套数)(39/40)
,"顽固去化面积" as SI_SALE_OUT_AREA---【42】顽固性库存去化面积
,"顽固推售面积" as SI_SALE_AREA---【43】顽固性库存推售面积
,case when 顽固推售面积=0 then 0 else  round("顽固去化面积"/"顽固推售面积",4) end  as SI_SALE_RATE_BY_AREA---【44】顽固性库存去化率(按面积)(42/43)
,"顽固去化金额" as SI_SALE_OUT_MONEY---【45】顽固性库存去化货值
,"顽固推售金额" as SI_SALE_MONEY---【46】顽固性库存推售货值
,case when 顽固推售金额=0 then 0 else  round("顽固去化金额"/"顽固推售金额",4) end as SI_SALE_RATE_BY_MONEY---【47】顽固性库存去化率(按货值)(45/46)
,"顽固推售金额"-"顽固去化金额" SI_SURPLUS_SALE_MONEY---【48】顽固性库存剩余货值(46-45)
,case when 顽固推售面积=0 then 0 else  round("顽固推售金额"/"顽固推售面积",4) end as SI_SALE_AVERAGE_MONEY---【49】顽固性库存标准均价(46/43)
,case when 顽固推售面积=0 then 0 else  round("顽固去化金额"/"顽固推售面积",4) end as SI_SALE_OUT_AVERAGE_MONEY---【50】顽固性库存签约均价(45/42)
-------------------- 业态面积段特有 start
,project_id||PRODUCT_NAME  as PARENT_ID  
,AREA_LEVEL as DATA_GRANULARITY
,PRODUCT_NAME    
,sys_created as CREATED---【51】创建日期
,dwm_REMARK
-------------------- 业态面积段特有 end
from 
(select 
------首次开盘30天内的签约金额（首开去化货值）: 
---------->房间“合同成交总价”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约
sum(case when room.SALE_STATE='签约' and proj.first_open_date<build.GET_PRE_SALE_PERMIT_DATE and build.GET_PRE_SALE_PERMIT_DATE<proj.first_open_date +30 then room.TRADE_TOTAL else 0 end ) as "首开去化货值"
------首次开盘已取证货值（首开推售货值）：
---------->房间“面价标准总价”:在计算“货值去化率”时，对已签约房间（有可能出现优惠打折），分子分母均按“签约金额”计算“货值去化率”。
---------->房间所属“楼栋预售许可证获取日期”<"项目开盘"的实际完成日期 
,sum(case when room.SALE_STATE='签约' and build.GET_PRE_SALE_PERMIT_DATE<proj.first_open_date then room.TRADE_TOTAL 
when build.GET_PRE_SALE_PERMIT_DATE<proj.first_open_date then room.BZ_TOTAL else 0 end )  as "首开推售货值"
------首次开盘30天内的签约面积（首开去化面积）:
---------->房间“最新建筑面积”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' and proj.first_open_date<build.GET_PRE_SALE_PERMIT_DATE and build.GET_PRE_SALE_PERMIT_DATE<proj.first_open_date +30  then room.NEW_BLD_AREA else 0 end ) as "首开去化面积"
------首次开盘的已取证面积（首开推售面积）:
---------->房间“最新建筑面积”
---------->房间所属“楼栋预售许可证获取日期”<"项目开盘"的实际完成日期 
,sum(case when build.GET_PRE_SALE_PERMIT_DATE<proj.first_open_date then room.NEW_BLD_AREA  else 0 end )  as "首开推售面积"
------首次开盘30天内的签约套数（首开去化套数）:
---------->房间“汇总”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' and proj.first_open_date<build.GET_PRE_SALE_PERMIT_DATE and build.GET_PRE_SALE_PERMIT_DATE<proj.first_open_date +30 then 1 else 0 end ) as "首开去化套数"
------首次开盘的已取证套数（首开推售套数）:
---------->房间“汇总”
---------->房间所属“楼栋预售许可证获取日期”<"项目开盘"的实际完成日期 
,sum(case when build.GET_PRE_SALE_PERMIT_DATE<proj.first_open_date then 1 else 0 end )  as "首开推售套数"

------全案------全案------全案------全案------全案------全案------全案 
------全案（已去化货值）: 
---------->房间“合同成交总价”
---------->房间“销售状态”=签约
,sum(case when room.SALE_STATE='签约' then room.TRADE_TOTAL else 0 end ) as "全案已去化货值"
------全案（已领证货值）：
---------->房间“面价标准总价”:在计算“货值去化率”时，对已签约房间（有可能出现优惠打折），分子分母均按“签约金额”计算“货值去化率”。
,sum(case when room.SALE_STATE='签约'  then room.TRADE_TOTAL  
when room.SALE_STATE<>'签约' and build.GET_PRE_SALE_PERMIT_DATE is not null then room.BZ_TOTAL else 0 end )  as "全案已领证货值"
------全案（已去化面积）:
---------->房间“最新建筑面积”
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约'  then room.NEW_BLD_AREA else 0 end ) as "全案已去化面积"
------全案（已领证面积）:
---------->房间“最新建筑面积”
,sum(case when room.SALE_STATE='签约' or build.GET_PRE_SALE_PERMIT_DATE is not null then room.NEW_BLD_AREA  else 0 end )  as "全案已领证面积"
------全案（已去化套数):
---------->房间“汇总”
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' then 1 else 0 end ) as "全案已去化套数"
------全案（已领证套数):
---------->房间“汇总”
,sum(case when room.SALE_STATE='签约' or build.GET_PRE_SALE_PERMIT_DATE is not null then 1 else 0 end )  as "全案已领证套数"
------现房------现房------现房------现房------现房------现房------现房------现房------现房
----现房去化面积
,sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE = '签约' and build.GET_PRE_SALE_PERMIT_DATE>proj.COMPLETION_RECORD_DATE then  room.NEW_BLD_AREA else 0 end) as "现房去化面积" ,
----现房推售面积
sum(case when  proj.COMPLETION_RECORD_DATE is not null and  (room.SALE_STATE <> '签约' or (room.SALE_STATE = '签约' and build.GET_PRE_SALE_PERMIT_DATE>proj.COMPLETION_RECORD_DATE) )  then room.NEW_BLD_AREA else 0 end) as 现房推售面积,
----现房去化金额
sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE = '签约' and build.GET_PRE_SALE_PERMIT_DATE>proj.COMPLETION_RECORD_DATE then  room.TRADE_TOTAL else 0 end) as  现房去化金额,
--推售金额需要根据房间是否已经签约来判断取签约金额还是标准金额
----现房推售金额
sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE <> '签约'   then room.BZ_TOTAL  when room.SALE_STATE = '签约' and proj.COMPLETION_RECORD_DATE is not null and  build.GET_PRE_SALE_PERMIT_DATE>proj.COMPLETION_RECORD_DATE then room.TRADE_TOTAL else 0 end) as 现房推售金额,
----现房去化套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE = '签约' and build.GET_PRE_SALE_PERMIT_DATE>proj.COMPLETION_RECORD_DATE then  1 else 0 end) as  现房去化套数,
----现房推售套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null and  (room.SALE_STATE <> '签约' or  (room.SALE_STATE = '签约' and build.GET_PRE_SALE_PERMIT_DATE>proj.COMPLETION_RECORD_DATE) )  then 1 else 0 end) as 现房推售套数
------顽固性库存------顽固性库存------顽固性库存------顽固性库存------顽固性库存------顽固性库存------顽固性库存
----顽固推售面积
,sum(case when  proj.COMPLETION_RECORD_DATE is not null  and room.SALE_STATE = '签约' and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and build.GET_PRE_SALE_PERMIT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  build.GET_PRE_SALE_PERMIT_DATE<sysdate then  room.NEW_BLD_AREA else 0 end) as 顽固去化面积,
----顽固去化面积
sum(case when  proj.COMPLETION_RECORD_DATE is not null  and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and ((TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  build.GET_PRE_SALE_PERMIT_DATE<sysdate  and room.SALE_STATE = '签约') or  room.SALE_STATE <> '签约') then room.NEW_BLD_AREA else 0 end) as 顽固推售面积,
----顽固去化金额
sum(case when  proj.COMPLETION_RECORD_DATE is not null  and room.SALE_STATE = '签约' and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and build.GET_PRE_SALE_PERMIT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  build.GET_PRE_SALE_PERMIT_DATE<sysdate  then  room.TRADE_TOTAL else 0 end) as  顽固去化金额,
--推售金额需要根据房间是否已经签约来判断取签约金额还是标准金额
----顽固推售金额
sum(case  when  proj.COMPLETION_RECORD_DATE is not null  and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and (TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  build.GET_PRE_SALE_PERMIT_DATE<sysdate  and room.SALE_STATE = '签约') then room.TRADE_TOTAL  --已经在今年签约的算签约金额
 when  proj.COMPLETION_RECORD_DATE is not null  and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  room.SALE_STATE <> '签约' then room.BZ_TOTAL  else 0 end) as 顽固推售金额,  --未签约的算校准总价
----顽固去化套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null  and room.SALE_STATE = '签约' and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and build.GET_PRE_SALE_PERMIT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  build.GET_PRE_SALE_PERMIT_DATE<sysdate then  1 else 0 end) as  顽固去化套数,
----顽固推售套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null  and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and ((TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  build.GET_PRE_SALE_PERMIT_DATE<sysdate  and room.SALE_STATE = '签约') or  room.SALE_STATE <> '签约') then 1 else 0 end) as 顽固推售套数
,proj.project_id,
proj.project_name,
proj.org_id,
proj.org_name,
proj.first_open_date,
proj.obtain_date,
proj.COMPLETION_RECORD_DATE,
proj.take_land_date,
proj.plan_first_open_date,
proj.first_open_duration_by_tl,
proj.first_open_duration_by_plan,
proj.new_plan_first_open_date,
proj.exhibition_area_open_date,
proj.plan_approval_date,
proj.is_operate,
proj.is_construction_began
,t_room.AREA_LEVEL
,t_room.PRODUCT_NAME 
from tmp_proj_base proj
left join MDM_ROOM room  on proj.project_id=room.project_id  and  proj.id = PROJ_BASE_SPID
left join TMP_ROOM t_room on  room.id=t_room.room_id
left join  mdm_build build on room.BUILDING_ID=build.id 
group by proj.project_id
-------------------- 业态面积段特有 start
    ,t_room.AREA_LEVEL
    ,t_room.PRODUCT_NAME
----------------------业态面积段特有 end
    ,proj.project_name,
    proj.org_id,
    proj.org_name,
    proj.first_open_date,
    proj.obtain_date,
    proj.COMPLETION_RECORD_DATE,
    proj.take_land_date,
    proj.plan_first_open_date,
    proj.first_open_duration_by_tl,
    proj.first_open_duration_by_plan,
    proj.new_plan_first_open_date,
    proj.exhibition_area_open_date,
    proj.plan_approval_date,
    proj.is_operate,
    proj.is_construction_began
    ) result 
-------------------- 业态面积段特有 start
   where  PRODUCT_NAME  is not null
----------------------业态面积段特有 end
;

OPEN spid_info FOR select * from TMP_SALE_RATE_BY_GRANULARITY where id=spid;  
------------------------------------------------------数据移入历史表;
INSERT INTO  dwm_sale_rate_gran_history (
    id,
    project_id,
    fo_sale_out_count,
    fo_sale_count,
    fo_sale_rate_by_count,
    fo_sale_out_area,
    fo_sale_area,
    fo_sale_rate_by_area,
    fo_sale_out_money,
    fo_sale_money,
    fo_sale_rate_by_money,
    fo_surplus_sale_money,
    fo_sale_average_money,
    fo_sale_out_average_money,
    po_sale_out_count,
    po_sale_count,
    po_sale_rate_by_count,
    po_sale_out_area,
    po_sale_area,
    po_sale_rate_by_area,
    po_sale_out_money,
    po_sale_money,
    po_sale_rate_by_money,
    po_surplus_sale_money,
    po_sale_average_money,
    po_sale_out_average_money,
    eh_sale_out_count,
    eh_sale_count,
    eh_sale_rate_by_count,
    eh_sale_out_area,
    eh_sale_area,
    eh_sale_rate_by_area,
    eh_sale_out_money,
    eh_sale_money,
    eh_sale_rate_by_money,
    eh_surplus_sale_money,
    eh_sale_average_money,
    eh_sale_out_average_money,
    si_sale_out_count,
    si_sale_count,
    si_sale_rate_by_count,
    si_sale_out_area,
    si_sale_area,
    si_sale_rate_by_area,
    si_sale_out_money,
    si_sale_money,
    si_sale_rate_by_money,
    si_surplus_sale_money,
    si_sale_average_money,
    si_sale_out_average_money,
    parent_id,
    data_granularity,
    created,
    remark,
    sort
)
SELECT
    id,
    project_id,
    fo_sale_out_count,
    fo_sale_count,
    fo_sale_rate_by_count,
    fo_sale_out_area,
    fo_sale_area,
    fo_sale_rate_by_area,
    fo_sale_out_money,
    fo_sale_money,
    fo_sale_rate_by_money,
    fo_surplus_sale_money,
    fo_sale_average_money,
    fo_sale_out_average_money,
    po_sale_out_count,
    po_sale_count,
    po_sale_rate_by_count,
    po_sale_out_area,
    po_sale_area,
    po_sale_rate_by_area,
    po_sale_out_money,
    po_sale_money,
    po_sale_rate_by_money,
    po_surplus_sale_money,
    po_sale_average_money,
    po_sale_out_average_money,
    eh_sale_out_count,
    eh_sale_count,
    eh_sale_rate_by_count,
    eh_sale_out_area,
    eh_sale_area,
    eh_sale_rate_by_area,
    eh_sale_out_money,
    eh_sale_money,
    eh_sale_rate_by_money,
    eh_surplus_sale_money,
    eh_sale_average_money,
    eh_sale_out_average_money,
    si_sale_out_count,
    si_sale_count,
    si_sale_rate_by_count,
    si_sale_out_area,
    si_sale_area,
    si_sale_rate_by_area,
    si_sale_out_money,
    si_sale_money,
    si_sale_rate_by_money,
    si_surplus_sale_money,
    si_sale_average_money,
    si_sale_out_average_money,
    parent_id,
    data_granularity,
    created,
    remark,
    sort
FROM
    dwm_sale_rate_by_granularity;
commit;
------------------------------------------------------删除已移入历史表树；
DELETE FROM DWM_SALE_RATE_BY_GRANULARITY ;--where REMARK=dwm_REMARK;
commit;
--------------------------------------------------------新增拍照数据;
INSERT INTO DWM_SALE_RATE_BY_GRANULARITY (
ID---【1】主键
,sort
,PROJECT_ID---【2】项目ID
,FO_SALE_OUT_COUNT---【3】首开去化套数
,FO_SALE_COUNT---【4】首开推售套数
,FO_SALE_RATE_BY_COUNT---【5】首开去化率(按套数)（3/4）
,FO_SALE_OUT_AREA---【6】首开去化面积
,FO_SALE_AREA---【7】首开推售面积
,FO_SALE_RATE_BY_AREA---【8】首开去化率(按面积)（6/7）
,FO_SALE_OUT_MONEY---【9】首开去化货值
,FO_SALE_MONEY---【10】首开推售货值
,FO_SALE_RATE_BY_MONEY---【11】首开去化率(按货值)（9/10）
,FO_SURPLUS_SALE_MONEY---【12】首开剩余货值(10-9)
,FO_SALE_AVERAGE_MONEY---【13】首开标准均价(10/7)
,FO_SALE_OUT_AVERAGE_MONEY---【14】首开签约均价(9/6)
,PO_SALE_OUT_COUNT---【15】全案去化套数
,PO_SALE_COUNT---【16】全案推售套数
,PO_SALE_RATE_BY_COUNT---【17】全案去化率(按套数)(15/16)
,PO_SALE_OUT_AREA---【18】全案去化面积
,PO_SALE_AREA---【19】全案推售面积
,PO_SALE_RATE_BY_AREA---【20】全案去化率(按面积)(18/19)
,PO_SALE_OUT_MONEY---【21】全案去化货值
,PO_SALE_MONEY---【22】全案推售货值
,PO_SALE_RATE_BY_MONEY---【23】全案去化率(按货值)(21/22)
,PO_SURPLUS_SALE_MONEY---【24】全案剩余货值(22-21)
,PO_SALE_AVERAGE_MONEY---【25】全案标准均价(22/19)
,PO_SALE_OUT_AVERAGE_MONEY---【26】全案签约均价(21/18)
,EH_SALE_OUT_COUNT---【27】现房去化套数
,EH_SALE_COUNT---【28】现房推售套数
,EH_SALE_RATE_BY_COUNT---【29】现房去化率(按套数)(27/28)
,EH_SALE_OUT_AREA---【30】现房去化面积
,EH_SALE_AREA---【31】现房推售面积
,EH_SALE_RATE_BY_AREA---【32】现房去化率(按面积)(30/31)
,EH_SALE_OUT_MONEY---【33】现房去化货值
,EH_SALE_MONEY---【34】现房推售货值
,EH_SALE_RATE_BY_MONEY---【35】现房去化率(按货值)(33/34)
,EH_SURPLUS_SALE_MONEY---【36】现房剩余货值(34-33)
,EH_SALE_AVERAGE_MONEY---【37】现房标准均价(34/31)
,EH_SALE_OUT_AVERAGE_MONEY---【38】现房签约均价(33/30)
,SI_SALE_OUT_COUNT---【39】顽固性库存去化套数
,SI_SALE_COUNT---【40】顽固性库存推售套数
,SI_SALE_RATE_BY_COUNT---【41】顽固性库存去化率(按套数)(39/40)
,SI_SALE_OUT_AREA---【42】顽固性库存去化面积
,SI_SALE_AREA---【43】顽固性库存推售面积
,SI_SALE_RATE_BY_AREA---【44】顽固性库存去化率(按面积)(42/43)
,SI_SALE_OUT_MONEY---【45】顽固性库存去化货值
,SI_SALE_MONEY---【46】顽固性库存推售货值
,SI_SALE_RATE_BY_MONEY---【47】顽固性库存去化率(按货值)(45/46)
,SI_SURPLUS_SALE_MONEY---【48】顽固性库存剩余货值(46-45)
,SI_SALE_AVERAGE_MONEY---【49】顽固性库存标准均价(46/43)
,SI_SALE_OUT_AVERAGE_MONEY---【50】顽固性库存签约均价(45/42)
,PARENT_ID  
,DATA_GRANULARITY 
,CREATED---【51】创建日期
,REMARK---【52】备注信息
        )
   select  tree.GRANULARITY_ID--颗粒度id---【1】主键
   ,tree.sort
,tree.PROJECT_ID,---【2】项目ID
nvl(apdata.fo_sale_out_count,0),
nvl(apdata.fo_sale_count,0),
nvl(apdata.fo_sale_rate_by_count,0),
nvl(apdata.fo_sale_out_area,0),
nvl(apdata.fo_sale_area,0),
nvl(apdata.fo_sale_rate_by_area,0),
nvl(apdata.fo_sale_out_money,0),
nvl(apdata.fo_sale_money,0),
nvl(apdata.fo_sale_rate_by_money,0),
nvl(apdata.fo_surplus_sale_money,0),
nvl(apdata.fo_sale_average_money,0),
nvl(apdata.fo_sale_out_average_money,0),
nvl(apdata.po_sale_out_count,0),
nvl(apdata.po_sale_count,0),
nvl(apdata.po_sale_rate_by_count,0),
nvl(apdata.po_sale_out_area,0),
nvl(apdata.po_sale_area,0),
nvl(apdata.po_sale_rate_by_area,0),
nvl(apdata.po_sale_out_money,0),
nvl(apdata.po_sale_money,0),
nvl(apdata.po_sale_rate_by_money,0),
nvl(apdata.po_surplus_sale_money,0),
nvl(apdata.po_sale_average_money,0),
nvl(apdata.po_sale_out_average_money,0),
nvl(apdata.eh_sale_out_count,0),
nvl(apdata.eh_sale_count,0),
nvl(apdata.eh_sale_rate_by_count,0),
nvl(apdata.eh_sale_out_area,0),
nvl(apdata.eh_sale_area,0),
nvl(apdata.eh_sale_rate_by_area,0),
nvl(apdata.eh_sale_out_money,0),
nvl(apdata.eh_sale_money,0),
nvl(apdata.eh_sale_rate_by_money,0),
nvl(apdata.eh_surplus_sale_money,0),
nvl(apdata.eh_sale_average_money,0),
nvl(apdata.eh_sale_out_average_money,0),
nvl(apdata.si_sale_out_count,0),
nvl(apdata.si_sale_count,0),
nvl(apdata.si_sale_rate_by_count,0),
nvl(apdata.si_sale_out_area,0),
nvl(apdata.si_sale_area,0),
nvl(apdata.si_sale_rate_by_area,0),
nvl(apdata.si_sale_out_money,0),
nvl(apdata.si_sale_money,0),
nvl(apdata.si_sale_rate_by_money,0),
nvl(apdata.si_surplus_sale_money,0),
nvl(apdata.si_sale_average_money,0),
nvl(apdata.si_sale_out_average_money,0)
,tree.PARENT_ID---父级id
,tree.DATA_GRANULARITY--颗粒度名称
,sys_created
,dwm_REMARK
from 
( select * from TMP_SALE_RATE_BY_GRANULARITY where id=spid_tree) tree
left join 
( 
    select  parent_id||data_granularity as id,
    project_id,
    fo_sale_out_count,
    fo_sale_count,
    fo_sale_rate_by_count,
    fo_sale_out_area,
    fo_sale_area,
    fo_sale_rate_by_area,
    fo_sale_out_money,
    fo_sale_money,
    fo_sale_rate_by_money,
    fo_surplus_sale_money,
    fo_sale_average_money,
    fo_sale_out_average_money,
    po_sale_out_count,
    po_sale_count,
    po_sale_rate_by_count,
    po_sale_out_area,
    po_sale_area,
    po_sale_rate_by_area,
    po_sale_out_money,
    po_sale_money,
    po_sale_rate_by_money,
    po_surplus_sale_money,
    po_sale_average_money,
    po_sale_out_average_money,
    eh_sale_out_count,
    eh_sale_count,
    eh_sale_rate_by_count,
    eh_sale_out_area,
    eh_sale_area,
    eh_sale_rate_by_area,
    eh_sale_out_money,
    eh_sale_money,
    eh_sale_rate_by_money,
    eh_surplus_sale_money,
    eh_sale_average_money,
    eh_sale_out_average_money,
    si_sale_out_count,
    si_sale_count,
    si_sale_rate_by_count,
    si_sale_out_area,
    si_sale_area,
    si_sale_rate_by_area,
    si_sale_out_money,
    si_sale_money,
    si_sale_rate_by_money,
    si_surplus_sale_money,
    si_sale_average_money,
    si_sale_out_average_money
 from  TMP_SALE_RATE_BY_GRANULARITY where id=spid
union all 
select  project_id||PRODUCT_NAME
,project_id,
sum(FO_SALE_OUT_COUNT),--【3】首开去化套数
sum(FO_SALE_COUNT),--【4】首开推售套数 
case when sum(FO_SALE_COUNT)=0 then 0 else  round(sum(FO_SALE_OUT_COUNT)/sum(FO_SALE_COUNT),4) end,--【5】首开去化率(按套数)（3/4）
sum(FO_SALE_OUT_AREA),--【6】首开去化面积
sum(FO_SALE_AREA),--【7】首开推售面积
case when sum(FO_SALE_AREA)=0 then 0 else  round(sum(FO_SALE_OUT_AREA)/sum(FO_SALE_AREA),4) end,--【8】首开去化率(按面积)（6/7）
sum(FO_SALE_OUT_MONEY),--【9】首开去化货值
sum(FO_SALE_MONEY),--【10】首开推售货值
case when sum(FO_SALE_MONEY)=0 then 0 else  round(sum(FO_SALE_OUT_MONEY)/sum(FO_SALE_MONEY),4) end,--【11】首开去化率(按货值)（9/10）
sum(FO_SURPLUS_SALE_MONEY),--【12】首开剩余货值(10-9)
case when sum(FO_SALE_AREA)=0 then 0 else  round(sum(FO_SALE_MONEY)/sum(FO_SALE_AREA),4) end,--【13】首开标准均价(10/7)
case when sum(FO_SALE_OUT_AREA)=0 then 0 else  round(sum(FO_SALE_OUT_MONEY)/sum(FO_SALE_OUT_AREA),4) end,--【14】首开签约均价(9/6)
sum(PO_SALE_OUT_COUNT),--【15】全案去化套数
sum(PO_SALE_COUNT),--【16】全案推售套数
case when sum(PO_SALE_COUNT)=0 then 0 else  round(sum(PO_SALE_OUT_COUNT)/sum(PO_SALE_COUNT),4) end,--【17】全案去化率(按套数)(15/16)
sum(PO_SALE_OUT_AREA),--【18】全案去化面积
sum(PO_SALE_AREA),--【19】全案推售面积
case when sum(PO_SALE_AREA)=0 then 0 else  round(sum(PO_SALE_OUT_AREA)/sum(PO_SALE_AREA),4) end,--【20】全案去化率(按面积)(18/19)
sum(PO_SALE_OUT_MONEY),--【21】全案去化货值
sum(PO_SALE_MONEY),--【22】全案推售货值
case when sum(PO_SALE_MONEY)=0 then 0 else  round(sum(PO_SALE_OUT_MONEY)/sum(PO_SALE_MONEY),4) end,--【23】全案去化率(按货值)(21/22)
sum(PO_SURPLUS_SALE_MONEY),--【24】全案剩余货值(22-21)
case when sum(PO_SALE_AREA)=0 then 0 else  round(sum(PO_SALE_MONEY)/sum(PO_SALE_AREA),4) end,--【25】全案标准均价(22/19)
case when sum(PO_SALE_OUT_AREA)=0 then 0 else  round(sum(PO_SALE_OUT_MONEY)/sum(PO_SALE_OUT_AREA),4) end,--【26】全案签约均价(21/18)
sum(EH_SALE_OUT_COUNT),--【27】现房去化套数
sum(EH_SALE_COUNT),--【28】现房推售套数
case when sum(EH_SALE_COUNT)=0 then 0 else  round(sum(EH_SALE_OUT_COUNT)/sum(EH_SALE_COUNT),4) end,--【29】现房去化率(按套数)(27/28)
sum(EH_SALE_OUT_AREA),--【30】现房去化面积
sum(EH_SALE_AREA),--【31】现房推售面积
case when sum(EH_SALE_AREA)=0 then 0 else  round(sum(EH_SALE_OUT_AREA)/sum(EH_SALE_AREA),4) end,--【32】现房去化率(按面积)(30/31)
sum(EH_SALE_OUT_MONEY),--【33】现房去化货值
sum(EH_SALE_MONEY),--【34】现房推售货值
case when sum(EH_SALE_MONEY)=0 then 0 else  round(sum(EH_SALE_OUT_MONEY)/sum(EH_SALE_MONEY),4) end,--【35】现房去化率(按货值)(33/34)
sum(EH_SURPLUS_SALE_MONEY),--【36】现房剩余货值(34-33)
case when sum(EH_SALE_AREA)=0 then 0 else  round(sum(EH_SALE_MONEY)/sum(EH_SALE_AREA),4) end,--【37】现房标准均价(34/31)
case when sum(EH_SALE_OUT_AREA)=0 then 0 else  round(sum(EH_SALE_OUT_MONEY)/sum(EH_SALE_OUT_AREA),4) end,--【38】现房签约均价(33/30)
sum(SI_SALE_OUT_COUNT),--【39】顽固性库存去化套数
sum(SI_SALE_COUNT),--【40】顽固性库存推售套数
case when sum(SI_SALE_COUNT)=0 then 0 else  round(sum(SI_SALE_OUT_COUNT)/sum(SI_SALE_COUNT),4) end,--【41】顽固性库存去化率(按套数)(39/40)
sum(SI_SALE_OUT_AREA),--【42】顽固性库存去化面积
sum(SI_SALE_AREA),--【43】顽固性库存推售面积
case when sum(SI_SALE_AREA)=0 then 0 else  round(sum(SI_SALE_OUT_AREA)/sum(SI_SALE_AREA),4) end,--【44】顽固性库存去化率(按面积)(42/43)
sum(SI_SALE_OUT_MONEY),--【45】顽固性库存去化货值
sum(SI_SALE_MONEY),--【46】顽固性库存推售货值
case when sum(SI_SALE_MONEY)=0 then 0 else  round(sum(SI_SALE_OUT_MONEY)/sum(SI_SALE_MONEY),4) end,--【47】顽固性库存去化率(按货值)(45/46)
sum(SI_SURPLUS_SALE_MONEY),--【48】顽固性库存剩余货值(46-45)
case when sum(SI_SALE_AREA)=0 then 0 else  round(sum(SI_SALE_MONEY)/sum(SI_SALE_AREA),4) end,--【49】顽固性库存标准均价(46/43)
case when sum(SI_SALE_OUT_AREA)=0 then 0 else  round(sum(SI_SALE_OUT_MONEY)/sum(SI_SALE_OUT_AREA),4) end--【50】顽固性库存签约均价(45/42)
 from  TMP_SALE_RATE_BY_GRANULARITY where id=spid group by project_id,
 parent_id,PRODUCT_NAME) apdata  
on tree.GRANULARITY_ID=apdata.id order by apdata.project_id;
commit;

END P_DWM_SALE_RATE_BY_GRANULARITY;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_SALE_RATE_BY_ORG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_SALE_RATE_BY_ORG" AS
		--公司颗粒度去化率；作用=》定时任务拍照
		--作者：陈丽
		--日期：2020-04-10

    PROJ_SPID NVARCHAR2(200);
    sys_created       DATE := SYSDATE;
    spid_tree              VARCHAR2(360); --使用临时表的批次号
    spid_sum              VARCHAR2(360); --使用临时表的批次号
    spid_result              VARCHAR2(360); --使用临时表的批次号
    dwm_remark        VARCHAR2(200) := '测试-chenl';
    p_X_AXIS_PERIOD  VARCHAR2(200):=to_char(sysdate, 'yyyy') ||'-'||to_char(sysdate, 'MM' );
BEGIN
delete tmp_sale_rate_by_org;
--------创建临时表批次号
    SELECT
        get_uuid(),get_uuid(),get_uuid()
    INTO spid_tree,spid_sum,spid_result
    FROM
        dual;  

------项目基本信息
BEGIN
  P_DWM_SALE_RATE_BY_PROJ(0,
    PROJ_SPID => PROJ_SPID
  );
END;

----组装树
INSERT INTO tmp_sale_rate_by_org (
        id,
        org_id,--【  2】项目ID
        org_name,--【  3】项目名称
        parent_id,
        IS_COMPANY,
        LEVEL_RANK,
        fo_sale_out_count,--【  4】首开去化套数
        fo_sale_count,--【  5】首开推售套数
        fo_sale_out_area,--【  7】首开去化面积
        fo_sale_area,--【  8】首开推售面积
        fo_sale_out_money,--【 10】首开去化货值
        fo_sale_money,--【 11】首开推售货值
        fo_surplus_sale_money,--【 13】首开剩余货值
        po_sale_out_count,--【 14】全案去化套数
        po_sale_count,--【 15】全案推售套数
        po_sale_out_area,--【 17】全案去化面积
        po_sale_area,--【 18】全案推售面积
        po_sale_out_money,--【 20】全案去化货值
        po_sale_money,--【 21】全案推售货值
        po_surplus_sale_money,--【 23】全案剩余货值
        eh_sale_out_count,--【 24】现房去化套数
        eh_sale_count,--【 25】现房推售套数
        eh_sale_out_area,--【 27】现房去化面积
        eh_sale_area,--【 28】现房推售面积
        eh_sale_out_money,--【 30】现房去化货值
        eh_sale_money,--【 31】现房推售货值
        eh_surplus_sale_money,--【 33】现房剩余货值
        si_sale_out_count,--【 34】顽固性库存去化套数
        si_sale_count,--【 35】顽固性库存推售套数
        si_sale_out_area,--【 37】顽固性库存去化面积
        si_sale_area,--【 38】顽固性库存推售面积
        si_sale_out_money,--【 40】顽固性库存去化货值
        si_sale_money,--【 41】顽固性库存推售货值
        si_surplus_sale_money--【 43】顽固性库存剩余货值
    )
        SELECT
            spid_tree,
            id AS org_id,
            org_name,
            parent_id,
            IS_COMPANY,
            LEVEL_RANK,
            0 AS fo_sale_out_count,--【  4】首开去化套数
            0 AS fo_sale_count,--【  5】首开推售套数
            0 AS fo_sale_out_area,--【  7】首开去化面积
            0 AS fo_sale_area,--【  8】首开推售面积
            0 AS fo_sale_out_money,--【 10】首开去化货值
            0 AS fo_sale_money,--【 11】首开推售货值
            0 AS fo_surplus_sale_money,--【 13】首开剩余货值
            0 AS po_sale_out_count,--【 14】全案去化套数
            0 AS po_sale_count,--【 15】全案推售套数
            0 AS po_sale_out_area,--【 17】全案去化面积
            0 AS po_sale_area,--【 18】全案推售面积
            0 AS po_sale_out_money,--【 20】全案去化货值
            0 AS po_sale_money,--【 21】全案推售货值
            0 AS po_surplus_sale_money,--【 23】全案剩余货值
            0 AS eh_sale_out_count,--【 24】现房去化套数
            0 AS eh_sale_count,--【 25】现房推售套数
            0 AS eh_sale_out_area,--【 27】现房去化面积
            0 AS eh_sale_area,--【 28】现房推售面积
            0 AS eh_sale_out_money,--【 30】现房去化货值
            0 AS eh_sale_money,--【 31】现房推售货值
            0 AS eh_surplus_sale_money,--【 33】现房剩余货值
            0 AS si_sale_out_count,--【 34】顽固性库存去化套数
            0 AS si_sale_count,--【 35】顽固性库存推售套数
            0 AS si_sale_out_area,--【 37】顽固性库存去化面积
            0 AS si_sale_area,--【 38】顽固性库存推售面积
            0 AS si_sale_out_money,--【 40】顽固性库存去化货值
            0 AS si_sale_money,--【 41】顽固性库存推售货值
            0 AS si_surplus_sale_money--【 43】顽固性库存剩余货值
        FROM
            sys_business_unit where IS_COMPANY=1
        UNION ALL
        SELECT
            spid_tree,
            project_id,
            org_name,
            org_id AS parent_id,
            0,
            null,
            fo_sale_out_count,--【  4】首开去化套数
            fo_sale_count,--【  5】首开推售套数
            fo_sale_out_area,--【  7】首开去化面积
            fo_sale_area,--【  8】首开推售面积
            fo_sale_out_money,--【 10】首开去化货值
            fo_sale_money,--【 11】首开推售货值
            fo_surplus_sale_money,--【 13】首开剩余货值
            po_sale_out_count,--【 14】全案去化套数
            po_sale_count,--【 15】全案推售套数
            po_sale_out_area,--【 17】全案去化面积
            po_sale_area,--【 18】全案推售面积
            po_sale_out_money,--【 20】全案去化货值
            po_sale_money,--【 21】全案推售货值
            po_surplus_sale_money,--【 23】全案剩余货值
            eh_sale_out_count,--【 24】现房去化套数
            eh_sale_count,--【 25】现房推售套数
            eh_sale_out_area,--【 27】现房去化面积
            eh_sale_area,--【 28】现房推售面积
            eh_sale_out_money,--【 30】现房去化货值
            eh_sale_money,--【 31】现房推售货值
            eh_surplus_sale_money,--【 33】现房剩余货值
            si_sale_out_count,--【 34】顽固性库存去化套数
            si_sale_count,--【 35】顽固性库存推售套数
            si_sale_out_area,--【 37】顽固性库存去化面积
            si_sale_area,--【 38】顽固性库存推售面积
            si_sale_out_money,--【 40】顽固性库存去化货值
            si_sale_money,--【 41】顽固性库存推售货值
            si_surplus_sale_money--【 43】顽固性库存剩余货值
        FROM
            tmp_sale_rate_by_project where id=proj_spid;           
----汇总          
INSERT INTO tmp_sale_rate_by_org (
        id,
        org_id,--【  2】项目ID
        org_name,--【  3】项目名称
        parent_id,
        IS_COMPANY,
        LEVEL_RANK,
        fo_sale_out_count,--【  4】首开去化套数
        fo_sale_count,--【  5】首开推售套数
        fo_sale_out_area,--【  7】首开去化面积
        fo_sale_area,--【  8】首开推售面积
        fo_sale_out_money,--【 10】首开去化货值
        fo_sale_money,--【 11】首开推售货值
        fo_surplus_sale_money,--【 13】首开剩余货值
        po_sale_out_count,--【 14】全案去化套数
        po_sale_count,--【 15】全案推售套数
        po_sale_out_area,--【 17】全案去化面积
        po_sale_area,--【 18】全案推售面积
        po_sale_out_money,--【 20】全案去化货值
        po_sale_money,--【 21】全案推售货值
        po_surplus_sale_money,--【 23】全案剩余货值
        eh_sale_out_count,--【 24】现房去化套数
        eh_sale_count,--【 25】现房推售套数
        eh_sale_out_area,--【 27】现房去化面积
        eh_sale_area,--【 28】现房推售面积
        eh_sale_out_money,--【 30】现房去化货值
        eh_sale_money,--【 31】现房推售货值
        eh_surplus_sale_money,--【 33】现房剩余货值
        si_sale_out_count,--【 34】顽固性库存去化套数
        si_sale_count,--【 35】顽固性库存推售套数
        si_sale_out_area,--【 37】顽固性库存去化面积
        si_sale_area,--【 38】顽固性库存推售面积
        si_sale_out_money,--【 40】顽固性库存去化货值
        si_sale_money,--【 41】顽固性库存推售货值
        si_surplus_sale_money--【 43】顽固性库存剩余货值
    )
 select spid_sum,org_id,org_name,parent_id,IS_COMPANY,LEVEL_RANK
,(select sum(FO_SALE_OUT_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FO_SALE_OUT_COUNT
,(select sum(FO_SALE_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FO_SALE_COUNT
,(select sum(FO_SALE_OUT_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FO_SALE_OUT_AREA
,(select sum(FO_SALE_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FO_SALE_AREA
,(select sum(FO_SALE_OUT_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FO_SALE_OUT_MONEY
,(select sum(FO_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FO_SALE_MONEY
,(select sum(FO_SURPLUS_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FO_SURPLUS_SALE_MONEY
,(select sum(PO_SALE_OUT_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) PO_SALE_OUT_COUNT
,(select sum(PO_SALE_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) PO_SALE_COUNT
,(select sum(PO_SALE_OUT_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) PO_SALE_OUT_AREA
,(select sum(PO_SALE_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) PO_SALE_AREA
,(select sum(PO_SALE_OUT_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) PO_SALE_OUT_MONEY
,(select sum(PO_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) PO_SALE_MONEY
,(select sum(PO_SURPLUS_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) PO_SURPLUS_SALE_MONEY
,(select sum(EH_SALE_OUT_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) EH_SALE_OUT_COUNT
,(select sum(EH_SALE_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) EH_SALE_COUNT
,(select sum(EH_SALE_OUT_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) EH_SALE_OUT_AREA
,(select sum(EH_SALE_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) EH_SALE_AREA
,(select sum(EH_SALE_OUT_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) EH_SALE_OUT_MONEY
,(select sum(EH_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) EH_SALE_MONEY
,(select sum(EH_SURPLUS_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) EH_SURPLUS_SALE_MONEY
,(select sum(SI_SALE_OUT_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) SI_SALE_OUT_COUNT
,(select sum(SI_SALE_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) SI_SALE_COUNT
,(select sum(SI_SALE_OUT_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) SI_SALE_OUT_AREA
,(select sum(SI_SALE_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) SI_SALE_AREA
,(select sum(SI_SALE_OUT_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) SI_SALE_OUT_MONEY
,(select sum(SI_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) SI_SALE_MONEY
,(select sum(SI_SURPLUS_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) SI_SURPLUS_SALE_MONEY
from tmp_sale_rate_by_org s where id=spid_tree
order by org_id  ; 
----计算率
INSERT INTO tmp_sale_rate_by_org (
ID,--【1】主键
ORG_ID,--【2】项目ID
ORG_NAME,--【3】项目名称
LEVEL_RANK,
FO_SALE_OUT_COUNT,--【4】首开去化套数
FO_SALE_COUNT,--【5】首开推售套数
FO_SALE_RATE_BY_COUNT,--【6】首开去化率(按套数)
FO_SALE_OUT_AREA,--【7】首开去化面积
FO_SALE_AREA,--【8】首开推售面积
FO_SALE_RATE_BY_AREA,--【9】首开去化率(按面积)
FO_SALE_OUT_MONEY,--【10】首开去化货值
FO_SALE_MONEY,--【11】首开推售货值
FO_SALE_RATE_BY_MONEY,--【12】首开去化率(按货值)
FO_SURPLUS_SALE_MONEY,--【13】首开剩余货值
PO_SALE_OUT_COUNT,--【14】全案去化套数
PO_SALE_COUNT,--【15】全案推售套数
PO_SALE_RATE_BY_COUNT,--【16】全案去化率(按套数)
PO_SALE_OUT_AREA,--【17】全案去化面积
PO_SALE_AREA,--【18】全案推售面积
PO_SALE_RATE_BY_AREA,--【19】全案去化率(按面积)
PO_SALE_OUT_MONEY,--【20】全案去化货值
PO_SALE_MONEY,--【21】全案推售货值
PO_SALE_RATE_BY_MONEY,--【22】全案去化率(按货值)
PO_SURPLUS_SALE_MONEY,--【23】全案剩余货值
EH_SALE_OUT_COUNT,--【24】现房去化套数
EH_SALE_COUNT,--【25】现房推售套数
EH_SALE_RATE_BY_COUNT,--【26】现房去化率(按套数)
EH_SALE_OUT_AREA,--【27】现房去化面积
EH_SALE_AREA,--【28】现房推售面积
EH_SALE_RATE_BY_AREA,--【29】现房去化率(按面积)
EH_SALE_OUT_MONEY,--【30】现房去化货值
EH_SALE_MONEY,--【31】现房推售货值
EH_SALE_RATE_BY_MONEY,--【32】现房去化率(按货值)
EH_SURPLUS_SALE_MONEY,--【33】现房剩余货值
SI_SALE_OUT_COUNT,--【34】顽固性库存去化套数
SI_SALE_COUNT,--【35】顽固性库存推售套数
SI_SALE_RATE_BY_COUNT,--【36】顽固性库存去化率(按套数)
SI_SALE_OUT_AREA,--【37】顽固性库存去化面积
SI_SALE_AREA,--【38】顽固性库存推售面积
SI_SALE_RATE_BY_AREA,--【39】顽固性库存去化率(按面积)
SI_SALE_OUT_MONEY,--【40】顽固性库存去化货值
SI_SALE_MONEY,--【41】顽固性库存推售货值
SI_SALE_RATE_BY_MONEY,--【42】顽固性库存去化率(按货值)
SI_SURPLUS_SALE_MONEY,--【43】顽固性库存剩余货值
X_AXIS_PERIOD,--【44】时间（横坐标）
CREATED,--【45】创建时间
"REMARK" )
select spid_result,ORG_ID,--【2】项目ID
ORG_NAME,--【3】项目名称
LEVEL_RANK,
FO_SALE_OUT_COUNT,--【4】首开去化套数
FO_SALE_COUNT,--【5】首开推售套数
case when FO_SALE_COUNT=0 then 0 else  round(FO_SALE_OUT_COUNT/FO_SALE_COUNT,4) end as  FO_SALE_RATE_BY_COUNT,--【6】首开去化率(按套数)
FO_SALE_OUT_AREA,--【7】首开去化面积
FO_SALE_AREA,--【8】首开推售面积
case when FO_SALE_AREA=0 then 0 else  round(FO_SALE_OUT_AREA/FO_SALE_AREA,4) end as  FO_SALE_RATE_BY_AREA,--【9】首开去化率(按面积)
FO_SALE_OUT_MONEY,--【10】首开去化货值
FO_SALE_MONEY,--【11】首开推售货值
case when FO_SALE_MONEY=0 then 0 else  round(FO_SALE_OUT_MONEY/FO_SALE_MONEY,4) end as FO_SALE_RATE_BY_MONEY,--【12】首开去化率(按货值)
FO_SALE_MONEY-FO_SALE_OUT_MONEY as FO_SURPLUS_SALE_MONEY,--【13】首开剩余货值
PO_SALE_OUT_COUNT,--【14】全案去化套数
PO_SALE_COUNT,--【15】全案推售套数
case when FO_SALE_MONEY=0 then 0 else  round(PO_SALE_OUT_COUNT/PO_SALE_COUNT,4) end as PO_SALE_RATE_BY_COUNT,--【16】全案去化率(按套数)
PO_SALE_OUT_AREA,--【17】全案去化面积
PO_SALE_AREA,--【18】全案推售面积
case when PO_SALE_AREA=0 then 0 else  round(PO_SALE_OUT_AREA/PO_SALE_AREA,4) end as PO_SALE_RATE_BY_AREA,--【19】全案去化率(按面积)
PO_SALE_OUT_MONEY,--【20】全案去化货值
PO_SALE_MONEY,--【21】全案推售货值
case when PO_SALE_AREA=0 then 0 else  round(PO_SALE_OUT_MONEY/PO_SALE_MONEY,4) end as PO_SALE_RATE_BY_MONEY,--【22】全案去化率(按货值)
PO_SALE_MONEY-PO_SALE_OUT_MONEY as PO_SURPLUS_SALE_MONEY,--【23】全案剩余货值
EH_SALE_OUT_COUNT,--【24】现房去化套数
EH_SALE_COUNT,--【25】现房推售套数
case when EH_SALE_COUNT=0 then 0 else  round(EH_SALE_OUT_COUNT/EH_SALE_COUNT,4) end as EH_SALE_RATE_BY_COUNT,--【26】现房去化率(按套数)
EH_SALE_OUT_AREA,--【27】现房去化面积
EH_SALE_AREA,--【28】现房推售面积
case when EH_SALE_AREA=0 then 0 else  round(EH_SALE_OUT_AREA/EH_SALE_AREA,4) end  as EH_SALE_RATE_BY_AREA,--【29】现房去化率(按面积)
EH_SALE_OUT_MONEY,--【30】现房去化货值
EH_SALE_MONEY,--【31】现房推售货值
case when EH_SALE_MONEY=0 then 0 else  round(EH_SALE_OUT_MONEY/EH_SALE_MONEY,4) end  as EH_SALE_RATE_BY_MONEY,--【32】现房去化率(按货值)
EH_SALE_MONEY-EH_SALE_OUT_MONEY as EH_SURPLUS_SALE_MONEY,--【33】现房剩余货值
SI_SALE_OUT_COUNT,--【34】顽固性库存去化套数
SI_SALE_COUNT,--【35】顽固性库存推售套数
case when SI_SALE_COUNT=0 then 0 else  round(SI_SALE_OUT_COUNT/SI_SALE_COUNT,4) end  as SI_SALE_RATE_BY_COUNT,--【36】顽固性库存去化率(按套数)
SI_SALE_OUT_AREA,--【37】顽固性库存去化面积
SI_SALE_AREA,--【38】顽固性库存推售面积
case when SI_SALE_AREA=0 then 0 else  round(SI_SALE_OUT_AREA/SI_SALE_AREA,4) end  as SI_SALE_RATE_BY_AREA,--【39】顽固性库存去化率(按面积)
SI_SALE_OUT_MONEY,--【40】顽固性库存去化货值
SI_SALE_MONEY,--【41】顽固性库存推售货值
case when SI_SALE_MONEY=0 then 0 else  round(SI_SALE_OUT_MONEY/SI_SALE_MONEY,4) end  as SI_SALE_RATE_BY_MONEY,--【42】顽固性库存去化率(按货值)
SI_SALE_MONEY-SI_SALE_OUT_MONEY as SI_SURPLUS_SALE_MONEY,--【43】顽固性库存剩余货值
p_X_AXIS_PERIOD,--【44】时间（横坐标）
sys_created,--【45】创建时间
dwm_remark--【46】备注信息
from tmp_sale_rate_by_org where IS_COMPANY=1 and id=spid_sum and LEVEL_RANK<=2
;
----插入到目标表

   DELETE FROM dwm_sale_rate_by_org where  X_AXIS_PERIOD=p_X_AXIS_PERIOD;
   --and REMARK=dwm_REMARK;

   INSERT INTO dwm_sale_rate_by_org (
ID,--【1】主键
ORG_ID,--【2】项目ID
ORG_NAME,--【3】项目名称
FO_SALE_OUT_COUNT,--【4】首开去化套数
FO_SALE_COUNT,--【5】首开推售套数
FO_SALE_RATE_BY_COUNT,--【6】首开去化率(按套数)
FO_SALE_OUT_AREA,--【7】首开去化面积
FO_SALE_AREA,--【8】首开推售面积
FO_SALE_RATE_BY_AREA,--【9】首开去化率(按面积)
FO_SALE_OUT_MONEY,--【10】首开去化货值
FO_SALE_MONEY,--【11】首开推售货值
FO_SALE_RATE_BY_MONEY,--【12】首开去化率(按货值)
FO_SURPLUS_SALE_MONEY,--【13】首开剩余货值
PO_SALE_OUT_COUNT,--【14】全案去化套数
PO_SALE_COUNT,--【15】全案推售套数
PO_SALE_RATE_BY_COUNT,--【16】全案去化率(按套数)
PO_SALE_OUT_AREA,--【17】全案去化面积
PO_SALE_AREA,--【18】全案推售面积
PO_SALE_RATE_BY_AREA,--【19】全案去化率(按面积)
PO_SALE_OUT_MONEY,--【20】全案去化货值
PO_SALE_MONEY,--【21】全案推售货值
PO_SALE_RATE_BY_MONEY,--【22】全案去化率(按货值)
PO_SURPLUS_SALE_MONEY,--【23】全案剩余货值
EH_SALE_OUT_COUNT,--【24】现房去化套数
EH_SALE_COUNT,--【25】现房推售套数
EH_SALE_RATE_BY_COUNT,--【26】现房去化率(按套数)
EH_SALE_OUT_AREA,--【27】现房去化面积
EH_SALE_AREA,--【28】现房推售面积
EH_SALE_RATE_BY_AREA,--【29】现房去化率(按面积)
EH_SALE_OUT_MONEY,--【30】现房去化货值
EH_SALE_MONEY,--【31】现房推售货值
EH_SALE_RATE_BY_MONEY,--【32】现房去化率(按货值)
EH_SURPLUS_SALE_MONEY,--【33】现房剩余货值
SI_SALE_OUT_COUNT,--【34】顽固性库存去化套数
SI_SALE_COUNT,--【35】顽固性库存推售套数
SI_SALE_RATE_BY_COUNT,--【36】顽固性库存去化率(按套数)
SI_SALE_OUT_AREA,--【37】顽固性库存去化面积
SI_SALE_AREA,--【38】顽固性库存推售面积
SI_SALE_RATE_BY_AREA,--【39】顽固性库存去化率(按面积)
SI_SALE_OUT_MONEY,--【40】顽固性库存去化货值
SI_SALE_MONEY,--【41】顽固性库存推售货值
SI_SALE_RATE_BY_MONEY,--【42】顽固性库存去化率(按货值)
SI_SURPLUS_SALE_MONEY,--【43】顽固性库存剩余货值
X_AXIS_PERIOD,--【44】时间（横坐标）
CREATED,--【45】创建时间
"REMARK" )
select get_uuid,--【1】主键
ORG_ID,--【2】项目ID
ORG_NAME,--【3】项目名称
FO_SALE_OUT_COUNT,--【4】首开去化套数
FO_SALE_COUNT,--【5】首开推售套数
FO_SALE_RATE_BY_COUNT,--【6】首开去化率(按套数)
FO_SALE_OUT_AREA,--【7】首开去化面积
FO_SALE_AREA,--【8】首开推售面积
FO_SALE_RATE_BY_AREA,--【9】首开去化率(按面积)
FO_SALE_OUT_MONEY,--【10】首开去化货值
FO_SALE_MONEY,--【11】首开推售货值
FO_SALE_RATE_BY_MONEY,--【12】首开去化率(按货值)
FO_SURPLUS_SALE_MONEY,--【13】首开剩余货值
PO_SALE_OUT_COUNT,--【14】全案去化套数
PO_SALE_COUNT,--【15】全案推售套数
PO_SALE_RATE_BY_COUNT,--【16】全案去化率(按套数)
PO_SALE_OUT_AREA,--【17】全案去化面积
PO_SALE_AREA,--【18】全案推售面积
PO_SALE_RATE_BY_AREA,--【19】全案去化率(按面积)
PO_SALE_OUT_MONEY,--【20】全案去化货值
PO_SALE_MONEY,--【21】全案推售货值
PO_SALE_RATE_BY_MONEY,--【22】全案去化率(按货值)
PO_SURPLUS_SALE_MONEY,--【23】全案剩余货值
EH_SALE_OUT_COUNT,--【24】现房去化套数
EH_SALE_COUNT,--【25】现房推售套数
EH_SALE_RATE_BY_COUNT,--【26】现房去化率(按套数)
EH_SALE_OUT_AREA,--【27】现房去化面积
EH_SALE_AREA,--【28】现房推售面积
EH_SALE_RATE_BY_AREA,--【29】现房去化率(按面积)
EH_SALE_OUT_MONEY,--【30】现房去化货值
EH_SALE_MONEY,--【31】现房推售货值
EH_SALE_RATE_BY_MONEY,--【32】现房去化率(按货值)
EH_SURPLUS_SALE_MONEY,--【33】现房剩余货值
SI_SALE_OUT_COUNT,--【34】顽固性库存去化套数
SI_SALE_COUNT,--【35】顽固性库存推售套数
SI_SALE_RATE_BY_COUNT,--【36】顽固性库存去化率(按套数)
SI_SALE_OUT_AREA,--【37】顽固性库存去化面积
SI_SALE_AREA,--【38】顽固性库存推售面积
SI_SALE_RATE_BY_AREA,--【39】顽固性库存去化率(按面积)
SI_SALE_OUT_MONEY,--【40】顽固性库存去化货值
SI_SALE_MONEY,--【41】顽固性库存推售货值
SI_SALE_RATE_BY_MONEY,--【42】顽固性库存去化率(按货值)
SI_SURPLUS_SALE_MONEY,--【43】顽固性库存剩余货值
X_AXIS_PERIOD,--【44】时间（横坐标）
CREATED,--【45】创建时间
"REMARK"
from tmp_sale_rate_by_org where id=spid_result;
commit;  
END p_dwm_sale_rate_by_org;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_SALE_RATE_BY_PROJ
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_SALE_RATE_BY_PROJ" (
    IS_PHOTOGRAPH in number:=0,
    proj_SPID  out NVARCHAR2
    
) AS
		--项目颗粒度去化率拍照；作用=》定时拍照
        --调用范围=》P_DWM_SALE_RATE_BY_ORG
		--作者：陈丽
		--日期：2020-04-10
  PROJ_BASE_INFO SYS_REFCURSOR;
  PROJ_DATE_INFO SYS_REFCURSOR;
  PROJ_BASE_SPID VARCHAR2(2000);
  sys_created date:=sysdate;
  spid VARCHAR2(360); --使用临时表的批次号
  dwm_REMARK VARCHAR2(200):='测试-chenl';
BEGIN
delete TMP_SALE_RATE_BY_PROJECT;
commit;
--------创建临时表批次号
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;  
proj_SPID:=spid;
------项目基本信息
BEGIN

  P_DWM_SALE_RATE_PROJ(0,
    PROJ_BASE_SPID => PROJ_BASE_SPID
  );
    END;
 ----- 
 INSERT INTO TMP_SALE_RATE_BY_PROJECT (ID---【1】主键
,PROJECT_ID---【2】项目ID
,PROJECT_NAME
,ORG_ID
,ORG_NAME
,FO_SALE_OUT_COUNT---【3】首开去化套数
,FO_SALE_COUNT---【4】首开推售套数
,FO_SALE_RATE_BY_COUNT---【5】首开去化率(按套数)（3/4）
,FO_SALE_OUT_AREA---【6】首开去化面积
,FO_SALE_AREA---【7】首开推售面积
,FO_SALE_RATE_BY_AREA---【8】首开去化率(按面积)（6/7）
,FO_SALE_OUT_MONEY---【9】首开去化货值
,FO_SALE_MONEY---【10】首开推售货值
,FO_SALE_RATE_BY_MONEY---【11】首开去化率(按货值)（9/10）
,FO_SURPLUS_SALE_MONEY---【12】首开剩余货值(10-9)
,FO_SALE_AVERAGE_MONEY---【13】首开标准均价(10/7)
,FO_SALE_OUT_AVERAGE_MONEY---【14】首开签约均价(9/6)
,PO_SALE_OUT_COUNT---【15】全案去化套数
,PO_SALE_COUNT---【16】全案推售套数
,PO_SALE_RATE_BY_COUNT---【17】全案去化率(按套数)(15/16)
,PO_SALE_OUT_AREA---【18】全案去化面积
,PO_SALE_AREA---【19】全案推售面积
,PO_SALE_RATE_BY_AREA---【20】全案去化率(按面积)(18/19)
,PO_SALE_OUT_MONEY---【21】全案去化货值
,PO_SALE_MONEY---【22】全案推售货值
,PO_SALE_RATE_BY_MONEY---【23】全案去化率(按货值)(21/22)
,PO_SURPLUS_SALE_MONEY---【24】全案剩余货值(22-21)
,PO_SALE_AVERAGE_MONEY---【25】全案标准均价(22/19)
,PO_SALE_OUT_AVERAGE_MONEY---【26】全案签约均价(21/18)
,EH_SALE_OUT_COUNT---【27】现房去化套数
,EH_SALE_COUNT---【28】现房推售套数
,EH_SALE_RATE_BY_COUNT---【29】现房去化率(按套数)(27/28)
,EH_SALE_OUT_AREA---【30】现房去化面积
,EH_SALE_AREA---【31】现房推售面积
,EH_SALE_RATE_BY_AREA---【32】现房去化率(按面积)(30/31)
,EH_SALE_OUT_MONEY---【33】现房去化货值
,EH_SALE_MONEY---【34】现房推售货值
,EH_SALE_RATE_BY_MONEY---【35】现房去化率(按货值)(33/34)
,EH_SURPLUS_SALE_MONEY---【36】现房剩余货值(34-33)
,EH_SALE_AVERAGE_MONEY---【37】现房标准均价(34/31)
,EH_SALE_OUT_AVERAGE_MONEY---【38】现房签约均价(33/30)
,SI_SALE_OUT_COUNT---【39】顽固性库存去化套数
,SI_SALE_COUNT---【40】顽固性库存推售套数
,SI_SALE_RATE_BY_COUNT---【41】顽固性库存去化率(按套数)(39/40)
,SI_SALE_OUT_AREA---【42】顽固性库存去化面积
,SI_SALE_AREA---【43】顽固性库存推售面积
,SI_SALE_RATE_BY_AREA---【44】顽固性库存去化率(按面积)(42/43)
,SI_SALE_OUT_MONEY---【45】顽固性库存去化货值
,SI_SALE_MONEY---【46】顽固性库存推售货值
,SI_SALE_RATE_BY_MONEY---【47】顽固性库存去化率(按货值)(45/46)
,SI_SURPLUS_SALE_MONEY---【48】顽固性库存剩余货值(46-45)
,SI_SALE_AVERAGE_MONEY---【49】顽固性库存标准均价(46/43)
,SI_SALE_OUT_AVERAGE_MONEY---【50】顽固性库存签约均价(45/42)
,CREATED---【51】创建日期
)select 
spid as ID---【1】主键
,project_id as PROJECT_ID---【2】项目ID
,project_name
,ORG_ID
,ORG_NAME
-----------------------------------K1、首开去化率开始--------------------
,"首开去化套数" as FO_SALE_OUT_COUNT---【3】首开去化套数
,"首开推售套数" as FO_SALE_COUNT---【4】首开推售套数
,case when 首开推售套数=0 then 0 else round("首开去化套数"/"首开推售套数",4)  end as FO_SALE_RATE_BY_COUNT---【5】首开去化率(按套数)（3/4）
,"首开去化面积" as FO_SALE_OUT_AREA---【6】首开去化面积
,"首开推售面积" as FO_SALE_AREA---【7】首开推售面积
,case when 首开推售面积=0 then 0 else round("首开去化面积"/"首开推售面积",4)  end as FO_SALE_RATE_BY_AREA---【8】首开去化率(按面积)（6/7）
,"首开去化货值" as FO_SALE_OUT_MONEY---【9】首开去化货值
,"首开推售货值" as FO_SALE_MONEY---【10】首开推售货值
,case when 首开推售货值=0 then 0 else round("首开去化货值"/"首开推售货值",4)  end as FO_SALE_RATE_BY_MONEY---【11】首开去化率(按货值)（9/10）
,"首开推售货值"-"首开去化货值" as FO_SURPLUS_SALE_MONEY---【12】首开剩余货值(10-9)
,case when 首开推售面积=0 then 0 else round("首开推售货值"/"首开推售面积",4)  end  as FO_SALE_AVERAGE_MONEY---【13】首开标准均价(10/7)
,case when 首开去化面积=0 then 0 else round("首开去化货值"/"首开去化面积",4)  end as FO_SALE_OUT_AVERAGE_MONEY---【14】首开签约均价(9/6)
-----------------------------------K3、全案去化率 （单位：%）--------------------
,"全案已去化套数" as PO_SALE_OUT_COUNT---【15】全案去化套数
,"全案已领证套数" as PO_SALE_COUNT---【16】全案推售套数
,case when 全案已领证套数=0 then 0 else round("全案已去化套数"/"全案已领证套数",4)  end as PO_SALE_RATE_BY_COUNT---【17】全案去化率(按套数)(15/16)
,"全案已去化面积" as PO_SALE_OUT_AREA---【18】全案去化面积
,"全案已领证面积" as PO_SALE_AREA---【19】全案推售面积
,case when 全案已领证面积=0 then 0 else round("全案已去化面积"/"全案已领证面积",4)  end as PO_SALE_RATE_BY_AREA---【20】全案去化率(按面积)(18/19)
,"全案已去化货值" as PO_SALE_OUT_MONEY---【21】全案去化货值
,"全案已领证货值" as PO_SALE_MONEY---【22】全案推售货值
,case when 全案已领证货值=0 then 0 else round("全案已去化货值"/"全案已领证货值",4)  end  as PO_SALE_RATE_BY_MONEY---【23】全案去化率(按货值)(21/22)
,"全案已领证货值"-"全案已去化货值" as PO_SURPLUS_SALE_MONEY---【24】全案剩余货值(22-21)
,case when 全案已领证面积=0 then 0 else round("全案已领证货值"/"全案已领证面积",4)  end  as PO_SALE_AVERAGE_MONEY---【25】全案标准均价(22/19)
,case when 全案已去化面积=0 then 0 else round("全案已去化货值"/"全案已去化面积",4)  end   PO_SALE_OUT_AVERAGE_MONEY---【26】全案签约均价(21/18)
-----------------------------------K4、现房去化率 （单位：%）--------------------
,"现房去化套数" as EH_SALE_OUT_COUNT---【27】现房去化套数
,"现房推售套数" as EH_SALE_COUNT---【28】现房推售套数
,case when 现房推售套数=0 then 0 else  round("现房去化套数"/"现房推售套数",4) end as EH_SALE_RATE_BY_COUNT---【29】现房去化率(按套数)(27/28)
,"现房去化面积" as EH_SALE_OUT_AREA---【30】现房去化面积
,"现房推售面积" as EH_SALE_AREA---【31】现房推售面积
,case when 现房推售面积=0 then 0 else  round("现房去化面积"/"现房推售面积",4) end as EH_SALE_RATE_BY_AREA---【32】现房去化率(按面积)(30/31)
,"现房去化金额" as EH_SALE_OUT_MONEY---【33】现房去化货值
,"现房推售金额" as EH_SALE_MONEY---【34】现房推售货值
,case when 现房推售金额=0 then 0 else  round("现房去化金额"/"现房推售金额",4) end as EH_SALE_RATE_BY_MONEY---【35】现房去化率(按货值)(33/34)
,"现房推售金额"-"现房去化金额" as EH_SURPLUS_SALE_MONEY---【36】现房剩余货值(34-33)
,case when 现房推售面积=0 then 0 else  round("现房推售金额"/"现房推售面积",4) end  as EH_SALE_AVERAGE_MONEY---【37】现房标准均价(34/31)
,case when 现房去化面积=0 then 0 else  round("现房去化金额"/"现房去化面积",4) end  as EH_SALE_OUT_AVERAGE_MONEY---【38】现房签约均价(33/30)
-----------------------------------K5、顽固性库存去化率 （单位：%）--------------------
,"顽固去化套数" as SI_SALE_OUT_COUNT---【39】顽固性库存去化套数
,"顽固推售套数" as SI_SALE_COUNT---【40】顽固性库存推售套数
,case when 顽固推售套数=0 then 0 else  round("顽固去化套数"/"顽固推售套数",4) end as SI_SALE_RATE_BY_COUNT---【41】顽固性库存去化率(按套数)(39/40)
,"顽固去化面积" as SI_SALE_OUT_AREA---【42】顽固性库存去化面积
,"顽固推售面积" as SI_SALE_AREA---【43】顽固性库存推售面积
,case when 顽固推售面积=0 then 0 else  round("顽固去化面积"/"顽固推售面积",4) end  as SI_SALE_RATE_BY_AREA---【44】顽固性库存去化率(按面积)(42/43)
,"顽固去化金额" as SI_SALE_OUT_MONEY---【45】顽固性库存去化货值
,"顽固推售金额" as SI_SALE_MONEY---【46】顽固性库存推售货值
,case when 顽固推售金额=0 then 0 else  round("顽固去化金额"/"顽固推售金额",4) end as SI_SALE_RATE_BY_MONEY---【47】顽固性库存去化率(按货值)(45/46)
,"顽固推售金额"-"顽固去化金额" SI_SURPLUS_SALE_MONEY---【48】顽固性库存剩余货值(46-45)
,case when 顽固推售面积=0 then 0 else  round("顽固推售金额"/"顽固推售面积",4) end as SI_SALE_AVERAGE_MONEY---【49】顽固性库存标准均价(46/43)
,case when 顽固推售面积=0 then 0 else  round("顽固去化金额"/"顽固推售面积",4) end as SI_SALE_OUT_AVERAGE_MONEY---【50】顽固性库存签约均价(45/42)
,sys_created as CREATED---【51】创建日期
from 
(select 
------首次开盘30天内的签约金额（首开去化货值）: 
---------->房间“合同成交总价”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约
sum(case when room.SALE_STATE='签约' and proj.first_open_date<build.GET_PRE_SALE_PERMIT_DATE and build.GET_PRE_SALE_PERMIT_DATE<proj.first_open_date +30 then room.TRADE_TOTAL else 0 end ) as "首开去化货值"
------首次开盘已取证货值（首开推售货值）：
---------->房间“面价标准总价”:在计算“货值去化率”时，对已签约房间（有可能出现优惠打折），分子分母均按“签约金额”计算“货值去化率”。
---------->房间所属“楼栋预售许可证获取日期”<"项目开盘"的实际完成日期 
,sum(case when room.SALE_STATE='签约' and build.GET_PRE_SALE_PERMIT_DATE<proj.first_open_date then room.TRADE_TOTAL 
when build.GET_PRE_SALE_PERMIT_DATE<proj.first_open_date then room.BZ_TOTAL else 0 end )  as "首开推售货值"
------首次开盘30天内的签约面积（首开去化面积）:
---------->房间“最新建筑面积”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' and proj.first_open_date<build.GET_PRE_SALE_PERMIT_DATE and build.GET_PRE_SALE_PERMIT_DATE<proj.first_open_date +30  then room.NEW_BLD_AREA else 0 end ) as "首开去化面积"
------首次开盘的已取证面积（首开推售面积）:
---------->房间“最新建筑面积”
---------->房间所属“楼栋预售许可证获取日期”<"项目开盘"的实际完成日期 
,sum(case when build.GET_PRE_SALE_PERMIT_DATE<proj.first_open_date then room.NEW_BLD_AREA  else 0 end )  as "首开推售面积"
------首次开盘30天内的签约套数（首开去化套数）:
---------->房间“汇总”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' and proj.first_open_date<build.GET_PRE_SALE_PERMIT_DATE and build.GET_PRE_SALE_PERMIT_DATE<proj.first_open_date +30 then 1 else 0 end ) as "首开去化套数"
------首次开盘的已取证套数（首开推售套数）:
---------->房间“汇总”
---------->房间所属“楼栋预售许可证获取日期”<"项目开盘"的实际完成日期 
,sum(case when build.GET_PRE_SALE_PERMIT_DATE<proj.first_open_date then 1 else 0 end )  as "首开推售套数"

------全案------全案------全案------全案------全案------全案------全案 
------全案（已去化货值）: 
---------->房间“合同成交总价”
---------->房间“销售状态”=签约
,sum(case when room.SALE_STATE='签约' then room.TRADE_TOTAL else 0 end ) as "全案已去化货值"
------全案（已领证货值）：
---------->房间“面价标准总价”:在计算“货值去化率”时，对已签约房间（有可能出现优惠打折），分子分母均按“签约金额”计算“货值去化率”。
,sum(case when room.SALE_STATE='签约'  then room.TRADE_TOTAL  
when room.SALE_STATE<>'签约' and build.GET_PRE_SALE_PERMIT_DATE is not null then room.BZ_TOTAL else 0 end )  as "全案已领证货值"
------全案（已去化面积）:
---------->房间“最新建筑面积”
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约'  then room.NEW_BLD_AREA else 0 end ) as "全案已去化面积"
------全案（已领证面积）:
---------->房间“最新建筑面积”
,sum(case when room.SALE_STATE='签约' or build.GET_PRE_SALE_PERMIT_DATE is not null then room.NEW_BLD_AREA  else 0 end )  as "全案已领证面积"
------全案（已去化套数):
---------->房间“汇总”
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' then 1 else 0 end ) as "全案已去化套数"
------全案（已领证套数):
---------->房间“汇总”
,sum(case when room.SALE_STATE='签约' or build.GET_PRE_SALE_PERMIT_DATE is not null then 1 else 0 end )  as "全案已领证套数"
------现房------现房------现房------现房------现房------现房------现房------现房------现房
----现房去化面积
,sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE = '签约' and build.GET_PRE_SALE_PERMIT_DATE>proj.COMPLETION_RECORD_DATE then  room.NEW_BLD_AREA else 0 end) as "现房去化面积" ,
----现房推售面积
sum(case when  proj.COMPLETION_RECORD_DATE is not null and  (room.SALE_STATE <> '签约' or (room.SALE_STATE = '签约' and build.GET_PRE_SALE_PERMIT_DATE>proj.COMPLETION_RECORD_DATE) )  then room.NEW_BLD_AREA else 0 end) as 现房推售面积,
----现房去化金额
sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE = '签约' and build.GET_PRE_SALE_PERMIT_DATE>proj.COMPLETION_RECORD_DATE then  room.TRADE_TOTAL else 0 end) as  现房去化金额,
--推售金额需要根据房间是否已经签约来判断取签约金额还是标准金额
----现房推售金额
sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE <> '签约'   then room.BZ_TOTAL  when room.SALE_STATE = '签约' and proj.COMPLETION_RECORD_DATE is not null and  build.GET_PRE_SALE_PERMIT_DATE>proj.COMPLETION_RECORD_DATE then room.TRADE_TOTAL else 0 end) as 现房推售金额,
----现房去化套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE = '签约' and build.GET_PRE_SALE_PERMIT_DATE>proj.COMPLETION_RECORD_DATE then  1 else 0 end) as  现房去化套数,
----现房推售套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null and  (room.SALE_STATE <> '签约' or  (room.SALE_STATE = '签约' and build.GET_PRE_SALE_PERMIT_DATE>proj.COMPLETION_RECORD_DATE) )  then 1 else 0 end) as 现房推售套数
------顽固性库存------顽固性库存------顽固性库存------顽固性库存------顽固性库存------顽固性库存------顽固性库存
----顽固推售面积
,sum(case when  proj.COMPLETION_RECORD_DATE is not null  and room.SALE_STATE = '签约' and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and build.GET_PRE_SALE_PERMIT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  build.GET_PRE_SALE_PERMIT_DATE<sysdate then  room.NEW_BLD_AREA else 0 end) as 顽固去化面积,
----顽固去化面积
sum(case when  proj.COMPLETION_RECORD_DATE is not null  and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and ((TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  build.GET_PRE_SALE_PERMIT_DATE<sysdate  and room.SALE_STATE = '签约') or  room.SALE_STATE <> '签约') then room.NEW_BLD_AREA else 0 end) as 顽固推售面积,
----顽固去化金额
sum(case when  proj.COMPLETION_RECORD_DATE is not null  and room.SALE_STATE = '签约' and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and build.GET_PRE_SALE_PERMIT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  build.GET_PRE_SALE_PERMIT_DATE<sysdate  then  room.TRADE_TOTAL else 0 end) as  顽固去化金额,
--推售金额需要根据房间是否已经签约来判断取签约金额还是标准金额
----顽固推售金额
sum(case  when  proj.COMPLETION_RECORD_DATE is not null  and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and (TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  build.GET_PRE_SALE_PERMIT_DATE<sysdate  and room.SALE_STATE = '签约') then room.TRADE_TOTAL  --已经在今年签约的算签约金额
 when  proj.COMPLETION_RECORD_DATE is not null  and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  room.SALE_STATE <> '签约' then room.BZ_TOTAL  else 0 end) as 顽固推售金额,  --未签约的算校准总价
----顽固去化套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null  and room.SALE_STATE = '签约' and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and build.GET_PRE_SALE_PERMIT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  build.GET_PRE_SALE_PERMIT_DATE<sysdate then  1 else 0 end) as  顽固去化套数,
----顽固推售套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null  and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and ((TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  build.GET_PRE_SALE_PERMIT_DATE<sysdate  and room.SALE_STATE = '签约') or  room.SALE_STATE <> '签约') then 1 else 0 end) as 顽固推售套数
,proj.project_id,
proj.project_name,
proj.org_id,
proj.org_name,
proj.first_open_date,
proj.obtain_date,
proj.COMPLETION_RECORD_DATE,
proj.take_land_date,
proj.plan_first_open_date,
proj.first_open_duration_by_tl,
proj.first_open_duration_by_plan,
proj.new_plan_first_open_date,
proj.exhibition_area_open_date,
proj.plan_approval_date,
proj.is_operate,
proj.is_construction_began
from tmp_proj_base proj left join  MDM_ROOM room  
on proj.project_id=room.project_id  and  proj.id = PROJ_BASE_SPID
left join  mdm_build build on room.BUILDING_ID=build.id 
group by proj.project_id
    ,proj.project_name,
    proj.org_id,
    proj.org_name,
    proj.first_open_date,
    proj.obtain_date,
    proj.COMPLETION_RECORD_DATE,
    proj.take_land_date,
    proj.plan_first_open_date,
    proj.first_open_duration_by_tl,
    proj.first_open_duration_by_plan,
    proj.new_plan_first_open_date,
    proj.exhibition_area_open_date,
    proj.plan_approval_date,
    proj.is_operate,
    proj.is_construction_began) result  order by "全案已去化货值" asc
;

-- 
IF is_photograph <> 0 THEN
----先将表数据移入，历史的项目数据，后插入新的数据
------------------------------------------------------数据移入历史表;
INSERT INTO dwm_sale_rate_by_proj_history (
    id,
    project_id,
    fo_sale_out_count,
    fo_sale_count,
    fo_sale_rate_by_count,
    fo_sale_out_area,
    fo_sale_area,
    fo_sale_rate_by_area,
    fo_sale_out_money,
    fo_sale_money,
    fo_sale_rate_by_money,
    fo_surplus_sale_money,
    fo_sale_average_money,
    fo_sale_out_average_money,
    po_sale_out_count,
    po_sale_count,
    po_sale_rate_by_count,
    po_sale_out_area,
    po_sale_area,
    po_sale_rate_by_area,
    po_sale_out_money,
    po_sale_money,
    po_sale_rate_by_money,
    po_surplus_sale_money,
    po_sale_average_money,
    po_sale_out_average_money,
    eh_sale_out_count,
    eh_sale_count,
    eh_sale_rate_by_count,
    eh_sale_out_area,
    eh_sale_area,
    eh_sale_rate_by_area,
    eh_sale_out_money,
    eh_sale_money,
    eh_sale_rate_by_money,
    eh_surplus_sale_money,
    eh_sale_average_money,
    eh_sale_out_average_money,
    si_sale_out_count,
    si_sale_count,
    si_sale_rate_by_count,
    si_sale_out_area,
    si_sale_area,
    si_sale_rate_by_area,
    si_sale_out_money,
    si_sale_money,
    si_sale_rate_by_money,
    si_surplus_sale_money,
    si_sale_average_money,
    si_sale_out_average_money,
    created,
    remark
)
SELECT
    id,
    project_id,
    fo_sale_out_count,
    fo_sale_count,
    fo_sale_rate_by_count,
    fo_sale_out_area,
    fo_sale_area,
    fo_sale_rate_by_area,
    fo_sale_out_money,
    fo_sale_money,
    fo_sale_rate_by_money,
    fo_surplus_sale_money,
    fo_sale_average_money,
    fo_sale_out_average_money,
    po_sale_out_count,
    po_sale_count,
    po_sale_rate_by_count,
    po_sale_out_area,
    po_sale_area,
    po_sale_rate_by_area,
    po_sale_out_money,
    po_sale_money,
    po_sale_rate_by_money,
    po_surplus_sale_money,
    po_sale_average_money,
    po_sale_out_average_money,
    eh_sale_out_count,
    eh_sale_count,
    eh_sale_rate_by_count,
    eh_sale_out_area,
    eh_sale_area,
    eh_sale_rate_by_area,
    eh_sale_out_money,
    eh_sale_money,
    eh_sale_rate_by_money,
    eh_surplus_sale_money,
    eh_sale_average_money,
    eh_sale_out_average_money,
    si_sale_out_count,
    si_sale_count,
    si_sale_rate_by_count,
    si_sale_out_area,
    si_sale_area,
    si_sale_rate_by_area,
    si_sale_out_money,
    si_sale_money,
    si_sale_rate_by_money,
    si_surplus_sale_money,
    si_sale_average_money,
    si_sale_out_average_money,
    created,
    remark
FROM
    dwm_sale_rate_by_proj_history;
commit;
------------------------------------------------------删除已移入历史表树；
DELETE FROM DWM_SALE_RATE_BY_PROJECT ;
    --where REMARK=dwm_REMARK;
commit;
--------------------------------------------------------新增拍照数据;
INSERT INTO DWM_SALE_RATE_BY_PROJECT (
ID---【1】主键
,PROJECT_ID---【2】项目ID
,FO_SALE_OUT_COUNT---【3】首开去化套数
,FO_SALE_COUNT---【4】首开推售套数
,FO_SALE_RATE_BY_COUNT---【5】首开去化率(按套数)（3/4）
,FO_SALE_OUT_AREA---【6】首开去化面积
,FO_SALE_AREA---【7】首开推售面积
,FO_SALE_RATE_BY_AREA---【8】首开去化率(按面积)（6/7）
,FO_SALE_OUT_MONEY---【9】首开去化货值
,FO_SALE_MONEY---【10】首开推售货值
,FO_SALE_RATE_BY_MONEY---【11】首开去化率(按货值)（9/10）
,FO_SURPLUS_SALE_MONEY---【12】首开剩余货值(10-9)
,FO_SALE_AVERAGE_MONEY---【13】首开标准均价(10/7)
,FO_SALE_OUT_AVERAGE_MONEY---【14】首开签约均价(9/6)
,PO_SALE_OUT_COUNT---【15】全案去化套数
,PO_SALE_COUNT---【16】全案推售套数
,PO_SALE_RATE_BY_COUNT---【17】全案去化率(按套数)(15/16)
,PO_SALE_OUT_AREA---【18】全案去化面积
,PO_SALE_AREA---【19】全案推售面积
,PO_SALE_RATE_BY_AREA---【20】全案去化率(按面积)(18/19)
,PO_SALE_OUT_MONEY---【21】全案去化货值
,PO_SALE_MONEY---【22】全案推售货值
,PO_SALE_RATE_BY_MONEY---【23】全案去化率(按货值)(21/22)
,PO_SURPLUS_SALE_MONEY---【24】全案剩余货值(22-21)
,PO_SALE_AVERAGE_MONEY---【25】全案标准均价(22/19)
,PO_SALE_OUT_AVERAGE_MONEY---【26】全案签约均价(21/18)
,EH_SALE_OUT_COUNT---【27】现房去化套数
,EH_SALE_COUNT---【28】现房推售套数
,EH_SALE_RATE_BY_COUNT---【29】现房去化率(按套数)(27/28)
,EH_SALE_OUT_AREA---【30】现房去化面积
,EH_SALE_AREA---【31】现房推售面积
,EH_SALE_RATE_BY_AREA---【32】现房去化率(按面积)(30/31)
,EH_SALE_OUT_MONEY---【33】现房去化货值
,EH_SALE_MONEY---【34】现房推售货值
,EH_SALE_RATE_BY_MONEY---【35】现房去化率(按货值)(33/34)
,EH_SURPLUS_SALE_MONEY---【36】现房剩余货值(34-33)
,EH_SALE_AVERAGE_MONEY---【37】现房标准均价(34/31)
,EH_SALE_OUT_AVERAGE_MONEY---【38】现房签约均价(33/30)
,SI_SALE_OUT_COUNT---【39】顽固性库存去化套数
,SI_SALE_COUNT---【40】顽固性库存推售套数
,SI_SALE_RATE_BY_COUNT---【41】顽固性库存去化率(按套数)(39/40)
,SI_SALE_OUT_AREA---【42】顽固性库存去化面积
,SI_SALE_AREA---【43】顽固性库存推售面积
,SI_SALE_RATE_BY_AREA---【44】顽固性库存去化率(按面积)(42/43)
,SI_SALE_OUT_MONEY---【45】顽固性库存去化货值
,SI_SALE_MONEY---【46】顽固性库存推售货值
,SI_SALE_RATE_BY_MONEY---【47】顽固性库存去化率(按货值)(45/46)
,SI_SURPLUS_SALE_MONEY---【48】顽固性库存剩余货值(46-45)
,SI_SALE_AVERAGE_MONEY---【49】顽固性库存标准均价(46/43)
,SI_SALE_OUT_AVERAGE_MONEY---【50】顽固性库存签约均价(45/42)
,CREATED---【51】创建日期
,REMARK---【52】备注信息
        )
            SELECT
PROJECT_ID      ID---【1】主键
,PROJECT_ID---【2】项目ID
,FO_SALE_OUT_COUNT---【3】首开去化套数
,FO_SALE_COUNT---【4】首开推售套数
,FO_SALE_RATE_BY_COUNT---【5】首开去化率(按套数)（3/4）
,FO_SALE_OUT_AREA---【6】首开去化面积
,FO_SALE_AREA---【7】首开推售面积
,FO_SALE_RATE_BY_AREA---【8】首开去化率(按面积)（6/7）
,FO_SALE_OUT_MONEY---【9】首开去化货值
,FO_SALE_MONEY---【10】首开推售货值
,FO_SALE_RATE_BY_MONEY---【11】首开去化率(按货值)（9/10）
,FO_SURPLUS_SALE_MONEY---【12】首开剩余货值(10-9)
,FO_SALE_AVERAGE_MONEY---【13】首开标准均价(10/7)
,FO_SALE_OUT_AVERAGE_MONEY---【14】首开签约均价(9/6)
,PO_SALE_OUT_COUNT---【15】全案去化套数
,PO_SALE_COUNT---【16】全案推售套数
,PO_SALE_RATE_BY_COUNT---【17】全案去化率(按套数)(15/16)
,PO_SALE_OUT_AREA---【18】全案去化面积
,PO_SALE_AREA---【19】全案推售面积
,PO_SALE_RATE_BY_AREA---【20】全案去化率(按面积)(18/19)
,PO_SALE_OUT_MONEY---【21】全案去化货值
,PO_SALE_MONEY---【22】全案推售货值
,PO_SALE_RATE_BY_MONEY---【23】全案去化率(按货值)(21/22)
,PO_SURPLUS_SALE_MONEY---【24】全案剩余货值(22-21)
,PO_SALE_AVERAGE_MONEY---【25】全案标准均价(22/19)
,PO_SALE_OUT_AVERAGE_MONEY---【26】全案签约均价(21/18)
,EH_SALE_OUT_COUNT---【27】现房去化套数
,EH_SALE_COUNT---【28】现房推售套数
,EH_SALE_RATE_BY_COUNT---【29】现房去化率(按套数)(27/28)
,EH_SALE_OUT_AREA---【30】现房去化面积
,EH_SALE_AREA---【31】现房推售面积
,EH_SALE_RATE_BY_AREA---【32】现房去化率(按面积)(30/31)
,EH_SALE_OUT_MONEY---【33】现房去化货值
,EH_SALE_MONEY---【34】现房推售货值
,EH_SALE_RATE_BY_MONEY---【35】现房去化率(按货值)(33/34)
,EH_SURPLUS_SALE_MONEY---【36】现房剩余货值(34-33)
,EH_SALE_AVERAGE_MONEY---【37】现房标准均价(34/31)
,EH_SALE_OUT_AVERAGE_MONEY---【38】现房签约均价(33/30)
,SI_SALE_OUT_COUNT---【39】顽固性库存去化套数
,SI_SALE_COUNT---【40】顽固性库存推售套数
,SI_SALE_RATE_BY_COUNT---【41】顽固性库存去化率(按套数)(39/40)
,SI_SALE_OUT_AREA---【42】顽固性库存去化面积
,SI_SALE_AREA---【43】顽固性库存推售面积
,SI_SALE_RATE_BY_AREA---【44】顽固性库存去化率(按面积)(42/43)
,SI_SALE_OUT_MONEY---【45】顽固性库存去化货值
,SI_SALE_MONEY---【46】顽固性库存推售货值
,SI_SALE_RATE_BY_MONEY---【47】顽固性库存去化率(按货值)(45/46)
,SI_SURPLUS_SALE_MONEY---【48】顽固性库存剩余货值(46-45)
,SI_SALE_AVERAGE_MONEY---【49】顽固性库存标准均价(46/43)
,SI_SALE_OUT_AVERAGE_MONEY---【50】顽固性库存签约均价(45/42)
,CREATED---【51】创建日期
,dwm_REMARK---【52】备注信息
            FROM
                TMP_SALE_RATE_BY_PROJECT where id=spid;
commit;
    END IF;
END P_DWM_SALE_RATE_BY_PROJ;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_SALE_RATE_PROJ
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_SALE_RATE_PROJ" (
    is_photograph    IN               NUMBER ,
    proj_base_spid   OUT              VARCHAR2
) AS
		--去化率项目基础数据刷新;作用=>去化率数据定时更新。
        --调用范围：P_DWM_SALE_RATE_BY_PROJ,P_DWM_SALE_RATE_BY_GRANULARITY,根据proj_base_spid使用tmp_proj_base数据
		--作者：陈丽
		--日期：2020-04-10
    spid VARCHAR2(36); --使用临时表的批次号
    plan_stage VARCHAR2(360):= '1期,一期,无分期';
node_exhibit_open_type VARCHAR2(50):='node_exhibit_open';
node_plan_approval_type VARCHAR2(50):='node_plan_approval';
node_get_land_type VARCHAR2(50):='node_get_land';
node_start_work_type VARCHAR2(50):='node_start_work';
node_completed_permit_type VARCHAR2(50):='node_completed_permit';
node_project_open_type VARCHAR2(50):='node_project_open';

node_exhibit_open VARCHAR2(50):='988e38a7-77ef-77eb-e053-0100007f3dda';	--备注--展示区开放（含售楼部、样板间）
node_plan_approval VARCHAR2(50):='988e38a7-77fa-77eb-e053-0100007f3dda';	--备注--规划方案批复
node_get_land VARCHAR2(50):='988e38a7-77c3-77eb-e053-0100007f3dda';	--备注--土地获取
node_start_work VARCHAR2(50):='988e38a7-7813-77eb-e053-0100007f3dda';	--备注--首开楼栋基础开工
node_completed_permit VARCHAR2(50):='988e38a7-7878-77eb-e053-0100007f3dda';	--备注--竣工备案
node_project_open VARCHAR2(50):='988e38a7-7827-77eb-e053-0100007f3dda';	--备注--项目开盘
dwm_REMARK VARCHAR2(200):='测试-chenl';
sys_created date:=sysdate;
BEGIN
delete tmp_proj_related_date;
delete tmp_proj_base;
commit;
--------创建临时表批次号
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;  

------------------------------------------------备注------------------------------------------------备注--展示区开放（含售楼部、样板间）
  INSERT INTO tmp_proj_related_date (id,project_id,project_date_type,plan_end_date,actual_end_date,estimate_end_date,remark)
    SELECT spid,ps.project_id,node_exhibit_open_type,plan_end_date,actual_end_date,estimate_end_date,nodestartsales.node_name
    FROM   pom_proj_plan plan 
    LEFT JOIN pom_proj_plan_node  nodestartsales ON plan.id = nodestartsales.PROJ_PLAN_ID  AND nodestartsales.standard_node_id = node_exhibit_open                           
    left join sys_project_stage  ps ON ps.id = plan.proj_id  AND stage_name IN (SELECT column_value FROM TABLE ( split(plan_stage) ))                           
        WHERE   plan.approval_status = '已审核'   AND plan.plan_type = '关键节点计划'
        GROUP BY ps.project_id,plan_end_date,actual_end_date,estimate_end_date,node_name;  ------------------------------------------------备注
------------------------------------------------备注------------------------------------------------备注--规划方案批复
  INSERT INTO tmp_proj_related_date (id,project_id,project_date_type,plan_end_date,actual_end_date,estimate_end_date,remark)
    SELECT spid,ps.project_id,node_plan_approval_type,plan_end_date,actual_end_date,estimate_end_date,nodestartsales.node_name
    FROM   pom_proj_plan plan 
    LEFT JOIN pom_proj_plan_node  nodestartsales ON plan.id = nodestartsales.PROJ_PLAN_ID  AND nodestartsales.standard_node_id = node_plan_approval                           
    left join sys_project_stage  ps ON ps.id = plan.proj_id  AND stage_name IN (SELECT column_value FROM TABLE ( split(plan_stage) ))                           
        WHERE   plan.approval_status = '已审核'   AND plan.plan_type = '关键节点计划'
        GROUP BY ps.project_id,plan_end_date,actual_end_date,estimate_end_date,node_name;  ------------------------------------------------备注
------------------------------------------------备注------------------------------------------------备注--土地获取
  INSERT INTO tmp_proj_related_date (id,project_id,project_date_type,plan_end_date,actual_end_date,estimate_end_date,remark)
    SELECT spid,ps.project_id,node_get_land_type,plan_end_date,actual_end_date,estimate_end_date,nodestartsales.node_name
    FROM   pom_proj_plan plan 
    LEFT JOIN pom_proj_plan_node  nodestartsales ON plan.id = nodestartsales.PROJ_PLAN_ID  AND nodestartsales.standard_node_id = node_get_land                           
    left join sys_project_stage  ps ON ps.id = plan.proj_id  AND stage_name IN (SELECT column_value FROM TABLE ( split(plan_stage) ))                           
        WHERE   plan.approval_status = '已审核'   AND plan.plan_type = '关键节点计划'
        GROUP BY ps.project_id,plan_end_date,actual_end_date,estimate_end_date,node_name;  ------------------------------------------------备注
------------------------------------------------备注------------------------------------------------备注--首开楼栋基础开工
  INSERT INTO tmp_proj_related_date (id,project_id,project_date_type,plan_end_date,actual_end_date,estimate_end_date,remark)
    SELECT spid,ps.project_id,node_start_work_type,plan_end_date,actual_end_date,estimate_end_date,nodestartsales.node_name
    FROM   pom_proj_plan plan 
    LEFT JOIN pom_proj_plan_node  nodestartsales ON plan.id = nodestartsales.PROJ_PLAN_ID  AND nodestartsales.standard_node_id = node_start_work                           
    left join sys_project_stage  ps ON ps.id = plan.proj_id  AND stage_name IN (SELECT column_value FROM TABLE ( split(plan_stage) ))                           
        WHERE   plan.approval_status = '已审核'   AND plan.plan_type = '关键节点计划'
        GROUP BY ps.project_id,plan_end_date,actual_end_date,estimate_end_date,node_name;  ------------------------------------------------备注
------------------------------------------------备注------------------------------------------------备注--竣工备案
  INSERT INTO tmp_proj_related_date (id,project_id,project_date_type,plan_end_date,actual_end_date,estimate_end_date,remark)
    SELECT spid,ps.project_id,node_completed_permit_type,plan_end_date,actual_end_date,estimate_end_date,nodestartsales.node_name
    FROM   pom_proj_plan plan 
    LEFT JOIN pom_proj_plan_node  nodestartsales ON plan.id = nodestartsales.PROJ_PLAN_ID  AND nodestartsales.standard_node_id = node_completed_permit                           
    left join sys_project_stage  ps ON ps.id = plan.proj_id  AND stage_name IN (SELECT column_value FROM TABLE ( split(plan_stage) ))                           
        WHERE   plan.approval_status = '已审核'   AND plan.plan_type = '关键节点计划'
        GROUP BY ps.project_id,plan_end_date,actual_end_date,estimate_end_date,node_name;  ------------------------------------------------备注
------------------------------------------------备注------------------------------------------------备注--项目开盘
  INSERT INTO tmp_proj_related_date (id,project_id,project_date_type,plan_end_date,actual_end_date,estimate_end_date,remark)
    SELECT spid,ps.project_id,node_project_open_type,plan_end_date,actual_end_date,estimate_end_date,nodestartsales.node_name
    FROM   pom_proj_plan plan 
    LEFT JOIN pom_proj_plan_node  nodestartsales ON plan.id = nodestartsales.PROJ_PLAN_ID  AND nodestartsales.standard_node_id = node_project_open                           
    left join sys_project_stage  ps ON ps.id = plan.proj_id  AND stage_name IN (SELECT column_value FROM TABLE ( split(plan_stage) ))                           
        WHERE   plan.approval_status = '已审核'   AND plan.plan_type = '关键节点计划'
        GROUP BY ps.project_id,plan_end_date,actual_end_date,estimate_end_date,node_name;  ------------------------------------------------备注




    INSERT INTO tmp_proj_base (
        ID,--主键
        PROJECT_ID,--项目ID
        PROJECT_NAME,--项目名称
        ORG_ID,--所属事业部ID
        ORG_NAME,--所属事业部
        FIRST_OPEN_DATE,--首开日期
        OBTAIN_DATE,--项目获得日期
        COMPLETION_RECORD_DATE,--首次竣备日期
        TAKE_LAND_DATE,--拿地日期
        PLAN_FIRST_OPEN_DATE,--计划首开日期
        FIRST_OPEN_DURATION_BY_PLAN,--原计划首开时长(10-9)
        FIRST_OPEN_DURATION_BY_TL,--拿地至首开时长(6-9)
        NEW_PLAN_FIRST_OPEN_DATE,--最新预计首开日期
        EXHIBITION_AREA_OPEN_DATE,--展示区开放日期
        EXHIBITION_AREA_OPEN_BY_PLAN,--展示区开放计划日期
        PLAN_APPROVAL_DATE,--方案批复日期
        PLAN_APPROVAL_DATE_BY_PLAN,--方案批复计划日期
        IS_OPERATE,--是否操盘
        IS_CONSTRUCTION_BEGAN,--是否已开工
        CREATED,--创建日期
        REMARK--备注信息
    )
        SELECT
            spid                          AS id,
            project.project_original_id   AS project_id,--项目ID
            project.project_name          AS project_name,--项目名称
            project.company_id            AS org_id,--所属事业部ID
            project.company_name          AS org_name,--所属事业部
            node_project_open1.actual_end_date     AS first_open_date,--实际首开时间----1
            node_get_land1.actual_end_date      AS obtain_date,--项目获取日期
            node_completed_permit1.actual_end_date     AS first_completion_record_date,--首次竣备日期------2
            node_get_land1.actual_end_date     AS take_land_date,--拿地日期----3
            node_project_open1.plan_end_date     AS plan_first_open_date,--计划首开日期-----4
            node_project_open1.plan_end_date - node_get_land1.actual_end_date AS first_open_duration_by_plan,--原计划首开时长
            node_project_open1.actual_end_date - node_get_land1.actual_end_date AS first_open_duration_by_tl,--拿地至首开时间
            node_project_open1.estimate_end_date      AS new_plan_first_open_date,--最新预计首开日期----5
            node_exhibit_open1.actual_end_date     AS exhibition_area_open_date,--实际展示区开放时间---6
            node_exhibit_open1.plan_end_date ,--计划展示区开放时间----7
            node_plan_approval1.actual_end_date     AS plan_approval_date,--方案批复时间----7
            node_plan_approval1.plan_end_date  ,--计划方案批复时间----7 
            CASE
                WHEN project.proj_cooperate = '操盘' THEN
                    1
                ELSE
                    0
            END AS is_operate,--as project.PROJ_COOPERATE 是否操盘
            CASE
                WHEN node_start_work1.actual_end_date is not null THEN
                    1
                ELSE
                    0
            END     AS is_construction_began,--是否开工----7
            sys_created,
            '测试' AS remark
        FROM
            mdm_project             project  
--备注--展示区开放（含售楼部、样板间）	
LEFT JOIN tmp_proj_related_date   node_exhibit_open1 ON project.project_original_id = node_exhibit_open1.project_id AND node_exhibit_open1.project_date_type = node_exhibit_open_type
--备注--规划方案批复	
LEFT JOIN tmp_proj_related_date   node_plan_approval1 ON project.project_original_id = node_plan_approval1.project_id AND node_plan_approval1.project_date_type = node_plan_approval_type
--备注--土地获取	
LEFT JOIN tmp_proj_related_date   node_get_land1 ON project.project_original_id = node_get_land1.project_id AND node_get_land1.project_date_type = node_get_land_type
--备注--首开楼栋基础开工	
LEFT JOIN tmp_proj_related_date   node_start_work1 ON project.project_original_id = node_start_work1.project_id AND node_start_work1.project_date_type = node_start_work_type
--备注--竣工备案	
LEFT JOIN tmp_proj_related_date   node_completed_permit1 ON project.project_original_id = node_completed_permit1.project_id AND node_completed_permit1.project_date_type = node_completed_permit_type
--备注--项目开盘	
LEFT JOIN tmp_proj_related_date   node_project_open1 ON project.project_original_id = node_project_open1.project_id AND node_project_open1.project_date_type = node_project_open_type
WHERE project.approval_status = '已审核';

    IF is_photograph <> 0 THEN
--先删除，历史的项目数据，后插入新的数据
        DELETE FROM dwm_sale_rate_project  where CREATED<sys_created;

        INSERT INTO dwm_sale_rate_project (
            ID,--主键
        PROJECT_ID,--项目ID
        PROJECT_NAME,--项目名称
        ORG_ID,--所属事业部ID
        ORG_NAME,--所属事业部
        FIRST_OPEN_DATE,--首开日期
        OBTAIN_DATE,--项目获得日期
        COMPLETION_RECORD_DATE,--首次竣备日期
        TAKE_LAND_DATE,--拿地日期
        PLAN_FIRST_OPEN_DATE,--计划首开日期
        FIRST_OPEN_DURATION_BY_PLAN,--原计划首开时长(10-9)
        FIRST_OPEN_DURATION_BY_TL,--拿地至首开时长(6-9)
        NEW_PLAN_FIRST_OPEN_DATE,--最新预计首开日期
        EXHIBITION_AREA_OPEN_DATE,--展示区开放日期
        EXHIBITION_AREA_OPEN_BY_PLAN,--展示区开放计划日期
        PLAN_APPROVAL_DATE,--方案批复日期
        PLAN_APPROVAL_DATE_BY_PLAN,--方案批复计划日期
        IS_OPERATE,--是否操盘
        IS_CONSTRUCTION_BEGAN,--是否已开工
        CREATED,--创建日期
        REMARK--备注信息
        )
            SELECT
        get_uuid,
        PROJECT_ID,--项目ID
        PROJECT_NAME,--项目名称
        ORG_ID,--所属事业部ID
        ORG_NAME,--所属事业部
        FIRST_OPEN_DATE,--首开日期
        OBTAIN_DATE,--项目获得日期
        COMPLETION_RECORD_DATE,--首次竣备日期
        TAKE_LAND_DATE,--拿地日期
        PLAN_FIRST_OPEN_DATE,--计划首开日期
        FIRST_OPEN_DURATION_BY_PLAN,--原计划首开时长(10-9)
        FIRST_OPEN_DURATION_BY_TL,--拿地至首开时长(6-9)
        NEW_PLAN_FIRST_OPEN_DATE,--最新预计首开日期
        EXHIBITION_AREA_OPEN_DATE,--展示区开放日期
        EXHIBITION_AREA_OPEN_BY_PLAN,--展示区开放计划日期
        PLAN_APPROVAL_DATE,--方案批复日期
        PLAN_APPROVAL_DATE_BY_PLAN,--方案批复计划日期
        IS_OPERATE,--是否操盘
        IS_CONSTRUCTION_BEGAN,--是否已开工
        CREATED,--创建日期
        dwm_REMARK--备注信息
            FROM
                tmp_proj_base
            WHERE
                id = spid;
    commit;
    END IF;


    proj_base_spid := spid;
END P_DWM_SALE_RATE_PROJ;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_SALERATEDETAILPROJECT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_SALERATEDETAILPROJECT" (projectId in varchar2,projectName out varchar2,obtainDate out varchar2,firstOpenDate out varchar2,orgName out varchar2)
AS 
begin
execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd''';
select PROJECT_NAME,to_char(OBTAIN_DATE,'yyyy-mm-dd'),to_char(FIRST_OPEN_DATE,'yyyy-mm-dd'),ORG_NAME into projectName,obtainDate,firstOpenDate,orgName  from DWM_SALE_RATE_PROJECT where PROJECT_ID=projectId;
END P_DWM_SaleRateDetailProject;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_TARGET_VALUE_LIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_TARGET_VALUE_LIST" (
    companyid     IN            VARCHAR2,--当前用户公司
    stationid     IN            VARCHAR2,---当前用户的岗位
    deptid        IN            VARCHAR2,---当前用户的部门
    bizcode       IN            VARCHAR2,---权限code
    userid        IN            VARCHAR2,---当前用户id
    projectid   IN              VARCHAR2,---、所选项目
    searchparam   IN            VARCHAR2,--筛选条件
    selectCompanyId IN          VARCHAR2,--当前选中的公司
    info         OUT            SYS_REFCURSOR
) IS
--目标货值管理
--作者：鲜晓勇
--日期：2020/2/09

    v_sql_exec         CLOB;
    v_sql         CLOB;
    v_spid             VARCHAR2(200);---数据验证spid
    v_where            VARCHAR2(4000):=' and 1=1 ';
    v_search           VARCHAR2(4000):=' and 1=1 ';  ---搜素sql
    v_license          VARCHAR2(4000):=' AND 1=1';
    v_project          VARCHAR2(4000);
    v_type             VARCHAR2(4000);
    v_auth_sql         VARCHAR2(4000) :=' where 1=1';
BEGIN
    BEGIN
    --执行数据权限存储过程。拿到零时表id 用户连临时表鉴权
 --调用查询数据权限的存储过程,返回spid 
       P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
           STATIONID => stationid,
          DEPTID => deptid,
           COMPANYID => companyid,
          BIZCODE => bizcode,
          DATA_AUTH_SPID => v_spid
      );
	v_auth_sql:='left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') ta on ta.orgid=dtw.PROJ_ID  where ta.orgid is not null ';
    if(selectCompanyId is not null)THEN
     v_where:='  AND mp.COMPANY_ID = '''||selectCompanyId||'''';
    end if;
    if(projectid is not null)THEN 
     v_where:=v_where||' AND dtw.PROJ_ID='''||projectid||'''';
    END if;
    if(searchParam is not null)THEN
        v_search:=' AND (t."version" like ''%'
                       || searchparam
                       || '%'' or t."projName" like ''%'
                       || searchparam
                       || '%'')';
    END IF;
    v_sql := '
     SELECT t.* FROM (
        SELECT
        dtw.ID as "id",
        dtw.PROJ_ID as "projId",
        dtw.PROJ_NAME as "projName",
        dtw.TARGET_WORTH_PHASE as "targetWorthPhase",
        dtw.TARGET_WORTH as "targetWorth",
        dtw.REMARK as "remark",
        dtw.APPROVAL_STATUS as "approvalStatus",
        dtw.APPROVER_ID as "approverId",
        dtw.APPROVAL_TIME as "approvalTime",
        mp.Project_code as "projectCode",
        dtw.WORTH_V as "worthV",
        dtw.CREATED as "created",
        dtw.PREVIOUS_V_WORTH as "previousVWorth",
        dtw.PREVIOUS_V_INCREMENT "previousVIncrement",
        dtw.FULL_V_WORTH as "fullVWorth",
        dtw.FULL_V_INCREMENT as "fullVIncrement",
        dtw.FEASIBILITY_STUDY_V_WORTH as "feasibilityStudyVWorth",
        dtw.FEASIBILITY_STUDY_V_INCREMENT as "feasibilityStudyVIncrement",
        dtw.IS_DELETE as "isDelete",
        dtw.APPROVER as "approver",
        dtwd.TOTAL_SALES_AREA AS "totalSalesArea",
        dtwd.TOTAL_CARPORT AS "totalCarport",
        CASE WHEN dtw.TARGET_WORTH_PHASE = 0 THEN
        ''可研版目标货值''
        WHEN dtw.TARGET_WORTH_PHASE = 10 THEN
        ''全盘开发计划版目标货值''
        WHEN dtw.TARGET_WORTH_PHASE = 20 THEN
        ''动态版目标货值(V''|| dtw.WORTH_V ||''.0)''
        END "version"
        FROM DWM_TARGET_WORTH dtw
        LEFT JOIN DWM_TARGET_WORTH_DTL dtwd ON dtw.ID = dtwd.TARGET_WORTH_ID AND dtwd.OBJ_TYPE = 0
        LEFT JOIN MDM_PROJECT mp ON dtw.PROJ_ID = mp.ID
        '||v_auth_sql||'
         AND dtw.IS_DELETE = 0
        '||v_where||'
        )t
        WHERE 1= 1 AND t."isDelete" = 0
        '||v_search||'
         ORDER BY t."projectCode" ASC';
--        v_sql_exec := '
--                select a.* from ( '
--                  || v_sql
--                  || ' AND rownum <= '
--                  || pageindex * pagesizes
--                  || ' ) a where a.rowno >= '
--                  || pagesizes * ( pageindex - 1 )
--                  || '';

    dbms_output.put_line(v_sql);
   OPEN info FOR v_sql;
END;
END P_DWM_TARGET_VALUE_LIST;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_TARGET_WORTH_DTL_M
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_TARGET_WORTH_DTL_M" (
    targetWorthId         IN             VARCHAR2 --目标货值id
) AS
--修正目标货值错误数据存储修正。之前数据逻辑存储错误，保存时修改正。临时处理。
--作者：陈丽
--日期：2020/05/09
BEGIN
---复制OBJ_ID  
  update DWM_TARGET_WORTH_DTL a set a.OLD_OBJ_ID=(select OBJ_ID from DWM_TARGET_WORTH_DTL b where a.id=b.id) where target_Worth_Id=targetWorthId;
  commit;
---修正OBJ_PARENT_ID
   update DWM_TARGET_WORTH_DTL a set a.OBJ_PARENT_ID=(select OBJ_PARENT_ID from (SELECT
        d.ID,
        d.OBJ_NAME,
        d.OBJ_ID,
        d.OPERATE_ATTRIBUTE_ID,
        d.OPERATE_ATTRIBUTE_NAME,
        d.TOTAL_BUILD_AREA,
        d.TOTAL_VOLUME_AREA,
        d.TOTAL_SALES_AREA,
        d.GROUND_CAN_SELL_AREA,
        d.UNDERGROUND_CAN_SELL_AREA,
        d.TOTAL_CARPORT,
        d.GROUND_CARPORT,
        d.UNDERGROUND_CARPORT,
        d.AVERAGE_PRICE,
        d.WORTH,
        d.TARGET_WORTH_ID,
        d.OBJ_TYPE,
        d.CREATOR_ID,
        d.CREATED,
        d.CREATOR,
        d.MODIFIED,
        d.MODIFIER_ID,
        d.MODIFIER,
        d.OBJ_PHASE_ID,
        CASE WHEN d.OBJ_TYPE = 0 THEN
        NULL
        WHEN d.OBJ_TYPE = 10 THEN
        mp2.PROJECT_ID
        WHEN d.OBJ_TYPE = 20 THEN
        mpv.PROJECT_ID
        WHEN d.OBJ_TYPE = 30 THEN
        mb.PERIOD_ID
        ELSE d.OBJ_ID
        END  OBJ_PARENT_ID
        FROM DWM_TARGET_WORTH_DTL d
        LEFT JOIN MDM_PROJECT mp1 ON d.OBJ_ID = mp1.ID
        LEFT JOIN MDM_PARCEL mp2 ON d.OBJ_ID = mp2.ID
        LEFT JOIN MDM_PERIOD mp3 ON d.OBJ_ID = mp3.ID
        LEFT JOIN MDM_PERIOD_VERSION mpv ON mpv.ID = mp3.PERIOD_VERSION_ID
        AND mpv.APPROVAL_STATUS = '已审核'
        LEFT JOIN MDM_BUILD mb ON d.OBJ_ID = mb.ID) b where a.id=b.id) where target_Worth_Id=targetWorthId;
   commit;

---修正OBJ_ID  
  update DWM_TARGET_WORTH_DTL a set a.OBJ_ID=(select id from MDM_BUILD_PRODUCT_TYPE b where a.OBJ_NAME=b.PRODUCT_TYPE_NAME) 
  where target_Worth_Id=targetWorthId and a.OBJ_TYPE=40;
  commit;
END P_DWM_TARGET_WORTH_DTL_M;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_TRENDMAP_K1
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_TRENDMAP_K1" 
(
  orgIds IN clob 
, rateTye IN VARCHAR2 default 'count'
, pointsData  OUT sys_refcursor
, numerator  OUT sys_refcursor
, denominator  OUT sys_refcursor
, sellRate  OUT sys_refcursor
) AS 
BEGIN
   if rateTye IS NOT NULL AND rateTye = 'count' then
     open pointsData for 
--     SELECT 
--        ORG_NAME as "orgName",
--        FO_SALE_OUT_COUNT as "numerator",
--        FO_SALE_COUNT as "denominator",
--        FN_DWM_MULTIPLE_AND_UNIT(FO_SALE_RATE_BY_COUNT, 0.01, '') as "sellRate",
--        to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--        ORG_ID as "orgId",
--        RN as "rn"
--        FROM(
--            SELECT ORG_NAME, FO_SALE_OUT_COUNT, FO_SALE_COUNT, FO_SALE_RATE_BY_COUNT, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--            ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, FO_SALE_OUT_COUNT, FO_SALE_COUNT, FO_SALE_RATE_BY_COUNT, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--            ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--            (SELECT COLUMN_VALUE FROM table (split (orgIds))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--   WHERE RN <= 12);
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.FO_SALE_COUNT is null then 0 else  tab.FO_SALE_COUNT end  as "denominator",
             case when tab.FO_SALE_OUT_COUNT is null then 0 else  tab.FO_SALE_OUT_COUNT end  as "numerator",
             case when tab.FO_SALE_RATE_BY_COUNT is null then 0 else  trunc(tab.FO_SALE_RATE_BY_COUNT*100 ,2)end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, FO_SALE_OUT_COUNT, FO_SALE_COUNT, FO_SALE_RATE_BY_COUNT, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.FO_SALE_COUNT,rateTable.FO_SALE_RATE_BY_COUNT,rateTable.FO_SALE_OUT_COUNT
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '首开去化套数' as "prefix", '套' as "suffix" from dual;
        open denominator for select '首开推售套数' as "prefix", '套' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
        ELSIF rateTye IS NOT NULL AND rateTye = 'area' THEN
        open pointsData for 
--        SELECT 
--            ORG_NAME as "orgName",
--            FN_DWM_MULTIPLE_AND_UNIT(FO_SALE_OUT_AREA, 10000, '') as "numerator",
--            FN_DWM_MULTIPLE_AND_UNIT(FO_SALE_AREA, 10000, '') as "denominator",
--            FN_DWM_MULTIPLE_AND_UNIT(FO_SALE_RATE_BY_AREA, 0.01, '') as "sellRate",
--            to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--            ORG_ID as "orgId",
--            RN as "rn"
--        FROM(
--            SELECT ORG_NAME, FO_SALE_OUT_AREA, FO_SALE_AREA, FO_SALE_RATE_BY_AREA, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--            ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, FO_SALE_OUT_AREA, FO_SALE_AREA, FO_SALE_RATE_BY_AREA, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--            ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--            (SELECT COLUMN_VALUE FROM table (split (orgIds))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--   WHERE RN <= 12);
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.FO_SALE_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FO_SALE_AREA, 10000, '') end  as "denominator",
             case when tab.FO_SALE_OUT_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FO_SALE_OUT_AREA, 10000, '') end  as "numerator",
             case when tab.FO_SALE_RATE_BY_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FO_SALE_RATE_BY_AREA, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, FO_SALE_OUT_AREA, FO_SALE_AREA, FO_SALE_RATE_BY_AREA, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.FO_SALE_AREA,rateTable.FO_SALE_RATE_BY_AREA,rateTable.FO_SALE_OUT_AREA
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '首开去化面积' as "prefix", '万方' as "suffix" from dual;
        open denominator for select '首开推售面积' as "prefix", '万方' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
    ELSIF rateTye IS NOT NULL AND rateTye = 'money' THEN
        open pointsData for 
--        SELECT 
--            ORG_NAME as "orgName",
--            FN_DWM_MULTIPLE_AND_UNIT(FO_SALE_OUT_MONEY, 100000000, '') as "numerator",
--            FN_DWM_MULTIPLE_AND_UNIT(FO_SALE_MONEY, 100000000, '') as "denominator",
--            FN_DWM_MULTIPLE_AND_UNIT(FO_SALE_RATE_BY_MONEY, 0.01, '') as "sellRate",
--            to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--            ORG_ID as "orgId",
--            RN as "rn"
--        FROM(
--            SELECT ORG_NAME, FO_SALE_OUT_MONEY, FO_SALE_MONEY, FO_SALE_RATE_BY_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--            ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, FO_SALE_OUT_MONEY, FO_SALE_MONEY, FO_SALE_RATE_BY_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--            ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--            (SELECT COLUMN_VALUE FROM table (split (orgIds))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--   WHERE RN <= 12);
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.FO_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FO_SALE_MONEY, 100000000, '') end  as "denominator",
             case when tab.FO_SALE_OUT_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FO_SALE_OUT_MONEY, 100000000, '') end  as "numerator",
             case when tab.FO_SALE_RATE_BY_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FO_SALE_RATE_BY_MONEY, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, FO_SALE_OUT_MONEY, FO_SALE_MONEY, FO_SALE_RATE_BY_MONEY, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.FO_SALE_MONEY,rateTable.FO_SALE_RATE_BY_MONEY,rateTable.FO_SALE_OUT_MONEY
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '首开去化货值' as "prefix", '亿元' as "suffix" from dual;
        open denominator for select '首开推售货值' as "prefix", '亿元' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
   end if;

EXCEPTION
WHEN OTHERS THEN
  CLOSE pointsData;
  CLOSE numerator;
  CLOSE denominator;
  CLOSE sellRate;   
END P_DWM_TRENDMAP_K1;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_TRENDMAP_K2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_TRENDMAP_K2" (orgIds in clob,pointsData out sys_refcursor,numerator out sys_refcursor,denominator out sys_refcursor,sellRate out sys_refcursor)
as
numeratorVlue number :=200;
sellRateValue number :=10;
orgIdsStr clob :='';
indexNum number:=0;
begin
delete DWM_RATE_TRENDMAP;
if orgIds is not null then 
orgIdsStr:=orgIds;
    for item in ( SELECT id,org_name FROM
    sys_business_unit where id in (SELECT COLUMN_VALUE FROM table (split (orgIdsStr)))) loop
            insert into DWM_RATE_TRENDMAP(x_xAxisPeriod,denominator,numerator,sellRate,orgId,orgName,sort)
            select 
            mm as "x_xAxisPeriod", 
            case when "denominator" is null then 0 else "denominator" end as "denominator" ,
            case when "numerator" is null then 0 else "numerator" end as "numerator",
            case when "sellRate" is null then 0 else "sellRate" end as "sellRate",
            item.id,
            item.org_name,
            months."index"
           from (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab) months
            left join (
            select tab1."denominator",trunc(tab1."numerator"/31,1) as "numerator",tab1."month", trunc(tab1."numerator"/tab1."denominator"/31,1) as "sellRate"
            from (
            select count(1) as "denominator",sum(FIRST_OPEN_DURATION_BY_TL) as "numerator","month" from
            (select proj.*,to_char(proj.first_open_date,'yyyy-mm') as "month" from DWM_SALE_RATE_PROJECT proj inner join
            (select * from SYS_BUSINESS_UNIT m start with m.id =item.id connect by m.parent_id=prior m.id) orgs
            on proj.org_id=orgs.id where proj.first_open_date is not null ) tab 
            group by tab."month") tab1 ) tab2
            on months.mm=tab2."month";
      end loop;    
      OPEN pointsData FOR select  to_char(to_date(x_xAxisPeriod||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"')  as "xAxisPeriod",denominator as "denominator",numerator as "numerator",sellRate as "sellRate",
      orgId as "orgId",orgName as "orgName",sort as "rn"
      from DWM_RATE_TRENDMAP order by sort;
end if;
  open numerator for select 
  '总计拿地至首开时长' as "prefix",
  '月' as "suffix"
  from  dual;
   open denominator for select 
  '首开项目数量' as "prefix",
  '个' as "suffix"
  from  dual;
   open sellRate for select 
  '平均拿地至首开时长' as "prefix",
  '月' as "suffix"
  from  dual;

EXCEPTION
WHEN OTHERS THEN
  CLOSE pointsData;
  CLOSE numerator;
  CLOSE denominator;
  CLOSE sellRate;
end P_DWM_TRENDMAP_K2;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_TRENDMAP_K3
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_TRENDMAP_K3" 
(
  rateTye IN VARCHAR2 default 'count'
, orgIds IN clob 
, pointsData OUT sys_refcursor
, numerator OUT sys_refcursor 
, denominator OUT sys_refcursor
, sellRate OUT sys_refcursor 
) AS 
BEGIN
  if rateTye IS NOT NULL AND rateTye = 'count' then
     open pointsData for 
--     SELECT 
--        ORG_NAME as "orgName",
--        PO_SALE_OUT_COUNT as "numerator",
--        PO_SALE_COUNT as "denominator",
--        FN_DWM_MULTIPLE_AND_UNIT(PO_SALE_RATE_BY_COUNT, 0.01, '') as "sellRate",
--        to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--        ORG_ID as "orgId",
--        RN as "rn"
--        FROM(
--            SELECT ORG_NAME, PO_SALE_OUT_COUNT, PO_SALE_COUNT, PO_SALE_RATE_BY_COUNT, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, PO_SALE_OUT_COUNT, PO_SALE_COUNT, PO_SALE_RATE_BY_COUNT, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--                (SELECT COLUMN_VALUE FROM table (split (orgIds))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--       WHERE RN <= 12
--        );
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.PO_SALE_COUNT is null then 0 else  tab.PO_SALE_COUNT end  as "denominator",
             case when tab.PO_SALE_OUT_COUNT is null then 0 else  tab.PO_SALE_OUT_COUNT end  as "numerator",
             case when tab.PO_SALE_RATE_BY_COUNT is null then '0' else  FN_DWM_MULTIPLE_AND_UNIT(tab.PO_SALE_RATE_BY_COUNT, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, PO_SALE_OUT_COUNT, PO_SALE_COUNT, PO_SALE_RATE_BY_COUNT, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.PO_SALE_COUNT,rateTable.PO_SALE_RATE_BY_COUNT,rateTable.PO_SALE_OUT_COUNT
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '全案去化套数' as "prefix", '套' as "suffix" from dual;
        open denominator for select '全案推售套数' as "prefix", '套' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
   ELSIF rateTye IS NOT NULL AND rateTye = 'area' THEN
        open pointsData for 
--        SELECT 
--            ORG_NAME as "orgName",
--            FN_DWM_MULTIPLE_AND_UNIT(PO_SALE_OUT_AREA, 10000, '') as "numerator",
--            FN_DWM_MULTIPLE_AND_UNIT(PO_SALE_AREA, 10000, '') as "denominator",
--            FN_DWM_MULTIPLE_AND_UNIT(PO_SALE_RATE_BY_AREA, 0.01, '') as "sellRate",
--            to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--            ORG_ID as "orgId",
--            RN as "rn"
--        FROM(
--            SELECT ORG_NAME, PO_SALE_OUT_AREA, PO_SALE_AREA, PO_SALE_RATE_BY_AREA, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, PO_SALE_OUT_AREA, PO_SALE_AREA, PO_SALE_RATE_BY_AREA, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--                (SELECT COLUMN_VALUE FROM table (split (orgIds))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--       WHERE RN <= 12
--        );
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.PO_SALE_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.PO_SALE_AREA, 10000, '') end  as "denominator",
             case when tab.PO_SALE_OUT_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.PO_SALE_OUT_AREA, 10000, '') end  as "numerator",
             case when tab.PO_SALE_RATE_BY_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.PO_SALE_RATE_BY_AREA, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, PO_SALE_OUT_AREA, PO_SALE_AREA, PO_SALE_RATE_BY_AREA, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.PO_SALE_AREA,rateTable.PO_SALE_RATE_BY_AREA,rateTable.PO_SALE_OUT_AREA
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '全案去化面积' as "prefix", '万方' as "suffix" from dual;
        open denominator for select '全案推售面积' as "prefix", '万方' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
    ELSIF rateTye IS NOT NULL AND rateTye = 'money' THEN
        open pointsData for 
--        SELECT 
--            ORG_NAME as "orgName",
--            FN_DWM_MULTIPLE_AND_UNIT(PO_SALE_OUT_MONEY, 100000000, '') as "numerator",
--            FN_DWM_MULTIPLE_AND_UNIT(PO_SALE_MONEY, 100000000, '') as "denominator",
--            FN_DWM_MULTIPLE_AND_UNIT(PO_SALE_RATE_BY_MONEY, 0.01, '') as "sellRate",
--            to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--            ORG_ID as "orgId",
--            RN as "rn"
--        FROM(
--            SELECT ORG_NAME, PO_SALE_OUT_MONEY, PO_SALE_MONEY, PO_SALE_RATE_BY_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, PO_SALE_OUT_MONEY, PO_SALE_MONEY, PO_SALE_RATE_BY_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--                (SELECT COLUMN_VALUE FROM table (split (orgIds))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--       WHERE RN <= 12
--        );
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.PO_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.PO_SALE_MONEY, 100000000, '') end  as "denominator",
             case when tab.PO_SALE_OUT_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.PO_SALE_OUT_MONEY, 100000000, '') end  as "numerator",
             case when tab.PO_SALE_RATE_BY_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.PO_SALE_RATE_BY_MONEY, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, PO_SALE_OUT_MONEY, PO_SALE_MONEY, PO_SALE_RATE_BY_MONEY, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.PO_SALE_MONEY,rateTable.PO_SALE_RATE_BY_MONEY,rateTable.PO_SALE_OUT_MONEY
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '全案去化货值' as "prefix", '亿元' as "suffix" from dual;
        open denominator for select '全案推售货值' as "prefix", '亿元' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;     
   end if;
   EXCEPTION
WHEN OTHERS THEN
  CLOSE pointsData;
  CLOSE numerator;
  CLOSE denominator;
 CLOSE sellRate;
END P_DWM_TRENDMAP_K3;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_TRENDMAP_K4_2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_TRENDMAP_K4_2" 
(
  orgId IN clob 
, pointsData OUT sys_refcursor
, numerator OUT sys_refcursor 
, denominator OUT sys_refcursor
, sellRate OUT sys_refcursor
, abscissa OUT sys_refcursor
) AS 
BEGIN
open pointsData for 
--SELECT 
--        ORG_NAME as "orgName",
--        FN_DWM_MULTIPLE_AND_UNIT(EH_SALE_OUT_MONEY, 100000000, '') as "numerator",
--        FN_DWM_MULTIPLE_AND_UNIT(EH_SALE_MONEY, 100000000, '') as "denominator",
--        FN_DWM_MULTIPLE_AND_UNIT(EH_SALE_RATE_BY_MONEY, 0.01, '') as "sellRate",
--        to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--        ORG_ID as "orgId",
--        RN as "rn"
--        FROM(
--            SELECT ORG_NAME, EH_SALE_OUT_MONEY, EH_SALE_MONEY, EH_SALE_RATE_BY_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, EH_SALE_OUT_MONEY, EH_SALE_MONEY, EH_SALE_RATE_BY_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--                (SELECT COLUMN_VALUE FROM table (split (orgId))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--       WHERE RN <= 12
--        );
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.EH_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.EH_SALE_MONEY, 100000000, '') end  as "denominator",
             case when tab.EH_SALE_OUT_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.EH_SALE_OUT_MONEY, 100000000, '') end  as "numerator",
             case when tab.EH_SALE_RATE_BY_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.EH_SALE_RATE_BY_MONEY, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, EH_SALE_OUT_MONEY, EH_SALE_MONEY, EH_SALE_RATE_BY_MONEY, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.EH_SALE_MONEY,rateTable.EH_SALE_RATE_BY_MONEY,rateTable.EH_SALE_OUT_MONEY
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgId)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= TO_NUMBER(TO_CHAR(sysdate,'mm'))) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= TO_NUMBER(TO_CHAR(sysdate,'mm'))) tab;  
        open abscissa for select to_char(TO_DATE(TO_CHAR(ADD_MONTHS(trunc(sysdate,'yyyy'), (ROWNUM-1)), 'yyyy-mm'),'yyyy-mm'),'yyyy"年"mm"月"') as "date" from DUAL connect by ROWNUM <= 12;    
        open numerator for select '竣备后签约货值' as "prefix", '亿元' as "suffix" from dual;
        open denominator for select '竣备时未签约货值' as "prefix", '亿元' as "suffix" from dual;
        open sellRate for select '现房去化率' as "prefix", '%' as "suffix" from dual;
EXCEPTION
WHEN OTHERS THEN
  CLOSE pointsData;
  CLOSE numerator;
  CLOSE denominator;
 CLOSE sellRate;
 CLOSE abscissa;
END P_DWM_TRENDMAP_K4_2;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_TRENDMAP_K4_3
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_TRENDMAP_K4_3" 
(
  orgId IN clob 
, pointsData OUT sys_refcursor
, numerator OUT sys_refcursor 
, denominator OUT sys_refcursor
, sellRate OUT sys_refcursor
, abscissa OUT sys_refcursor
) AS 
BEGIN
 open pointsData for 
-- SELECT 
--        ORG_NAME as "orgName",
--        FN_DWM_MULTIPLE_AND_UNIT(EH_SALE_OUT_MONEY, 100000000, '') as "numerator",
--        FN_DWM_MULTIPLE_AND_UNIT(EH_SALE_MONEY, 100000000, '') as "denominator",
--        FN_DWM_MULTIPLE_AND_UNIT(EH_SURPLUS_SALE_MONEY, 100000000, '') as "sellRate",
--        to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--        ORG_ID as "orgId",
--        RN as "rn"
--        FROM(
--            SELECT ORG_NAME, EH_SALE_OUT_MONEY, EH_SALE_MONEY, EH_SURPLUS_SALE_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, EH_SALE_OUT_MONEY, EH_SALE_MONEY, EH_SURPLUS_SALE_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--                (SELECT COLUMN_VALUE FROM table (split (orgId))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--       WHERE RN <= 12
--        );
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.EH_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.EH_SALE_MONEY, 100000000, '') end  as "denominator",
             case when tab.EH_SALE_OUT_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.EH_SALE_OUT_MONEY, 100000000, '') end  as "numerator",
             case when tab.EH_SURPLUS_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.EH_SURPLUS_SALE_MONEY, 100000000, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, EH_SALE_OUT_MONEY, EH_SALE_MONEY, EH_SURPLUS_SALE_MONEY, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.EH_SALE_MONEY,rateTable.EH_SURPLUS_SALE_MONEY,rateTable.EH_SALE_OUT_MONEY
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgId)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= TO_NUMBER(TO_CHAR(sysdate,'mm'))) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= TO_NUMBER(TO_CHAR(sysdate,'mm'))) tab;
        open abscissa for select to_char(TO_DATE(TO_CHAR(ADD_MONTHS(trunc(sysdate,'yyyy'), (ROWNUM-1)), 'yyyy-mm'),'yyyy-mm'),'yyyy"年"mm"月"') as "date" from DUAL connect by ROWNUM <= 12;
        open numerator for select '竣备后签约货值' as "prefix", '亿元' as "suffix" from dual;
        open denominator for select '竣备时未签约货值' as "prefix", '亿元' as "suffix" from dual;
        open sellRate for select '剩余现房货值' as "prefix", '亿元' as "suffix" from dual;
EXCEPTION
WHEN OTHERS THEN
  CLOSE pointsData;
  CLOSE numerator;
  CLOSE denominator;
 CLOSE sellRate;
 CLOSE abscissa;        
END P_DWM_TRENDMAP_K4_3;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_TRENDMAP_K5_2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_TRENDMAP_K5_2" 
(
  orgId IN clob 
, pointsData OUT sys_refcursor
, numerator OUT sys_refcursor 
, denominator OUT sys_refcursor
, sellRate OUT sys_refcursor
, abscissa OUT sys_refcursor
) AS 
BEGIN
open pointsData for 
--SELECT 
--        ORG_NAME as "orgName",
--        FN_DWM_MULTIPLE_AND_UNIT(SI_SALE_OUT_MONEY, 100000000, '') as "numerator",
--        FN_DWM_MULTIPLE_AND_UNIT(SI_SALE_MONEY, 100000000, '') as "denominator",
--        FN_DWM_MULTIPLE_AND_UNIT(SI_SALE_RATE_BY_MONEY, 0.01, '') as "sellRate",
--        to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--        ORG_ID as "orgId",
--        RN as "rn"
--        FROM(
--             SELECT ORG_NAME, SI_SALE_OUT_MONEY, SI_SALE_MONEY, SI_SALE_RATE_BY_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, SI_SALE_OUT_MONEY, SI_SALE_MONEY, SI_SALE_RATE_BY_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--                (SELECT COLUMN_VALUE FROM table (split (orgId))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--       WHERE RN <= 12
--        );
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.SI_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.SI_SALE_MONEY, 100000000, '') end  as "denominator",
             case when tab.SI_SALE_OUT_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.SI_SALE_OUT_MONEY, 100000000, '')  end  as "numerator",
             case when tab.SI_SALE_RATE_BY_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.SI_SALE_RATE_BY_MONEY, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, SI_SALE_OUT_MONEY, SI_SALE_MONEY, SI_SALE_RATE_BY_MONEY, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.SI_SALE_MONEY,rateTable.SI_SALE_RATE_BY_MONEY,rateTable.SI_SALE_OUT_MONEY
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgId)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= TO_NUMBER(TO_CHAR(sysdate,'mm'))) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= TO_NUMBER(TO_CHAR(sysdate,'mm'))) tab;
        open abscissa for select to_char(TO_DATE(TO_CHAR(ADD_MONTHS(trunc(sysdate,'yyyy'), (ROWNUM-1)), 'yyyy-mm'),'yyyy-mm'),'yyyy"年"mm"月"') as "date" from DUAL connect by ROWNUM <= 12;
        open numerator for select '本年已去化货值' as "prefix", '亿元' as "suffix" from dual;
        open denominator for select '年初顽固性库存货值' as "prefix", '亿元' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
EXCEPTION
WHEN OTHERS THEN
  CLOSE pointsData;
  CLOSE numerator;
  CLOSE denominator;
 CLOSE sellRate;
 CLOSE abscissa;
END P_DWM_TRENDMAP_K5_2;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_TRENDMAP_K5_3
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_TRENDMAP_K5_3" 
(
  orgId IN clob 
, pointsData OUT sys_refcursor
, numerator OUT sys_refcursor 
, denominator OUT sys_refcursor
, sellRate OUT sys_refcursor 
, abscissa OUT sys_refcursor
) AS 
BEGIN
open pointsData for 
--SELECT 
--        ORG_NAME as "orgName",
--        FN_DWM_MULTIPLE_AND_UNIT(SI_SALE_OUT_MONEY, 100000000, '') as "numerator",
--        FN_DWM_MULTIPLE_AND_UNIT(SI_SALE_MONEY, 100000000, '') as "denominator",
--        FN_DWM_MULTIPLE_AND_UNIT(SI_SURPLUS_SALE_MONEY, 100000000, '') as "sellRate",
--        to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--        ORG_ID as "orgId",
--        RN as "rn"
--        FROM(
--            SELECT ORG_NAME, SI_SALE_OUT_MONEY, SI_SALE_MONEY, SI_SURPLUS_SALE_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, SI_SALE_OUT_MONEY, SI_SALE_MONEY, SI_SURPLUS_SALE_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--                (SELECT COLUMN_VALUE FROM table (split (orgId))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--       WHERE RN <= 12
--        );
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.SI_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.SI_SALE_MONEY, 100000000, '')  end  as "denominator",
             case when tab.SI_SALE_OUT_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.SI_SALE_OUT_MONEY, 100000000, '')  end  as "numerator",
             case when tab.SI_SURPLUS_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.SI_SURPLUS_SALE_MONEY, 100000000, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, SI_SALE_OUT_MONEY, SI_SALE_MONEY, SI_SURPLUS_SALE_MONEY, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.SI_SALE_MONEY,rateTable.SI_SURPLUS_SALE_MONEY,rateTable.SI_SALE_OUT_MONEY
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgId)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= TO_NUMBER(TO_CHAR(sysdate,'mm'))) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= TO_NUMBER(TO_CHAR(sysdate,'mm'))) tab;
        open abscissa for select to_char(TO_DATE(TO_CHAR(ADD_MONTHS(trunc(sysdate,'yyyy'), (ROWNUM-1)), 'yyyy-mm'),'yyyy-mm'),'yyyy"年"mm"月"') as "date" from DUAL connect by ROWNUM <= 12;
        open numerator for select '本年已去化货值' as "prefix", '亿元' as "suffix" from dual;
        open denominator for select '年初顽固性库存货值' as "prefix", '亿元' as "suffix" from dual;
        open sellRate for select '剩余顽固性库存货值' as "prefix", '亿元' as "suffix" from dual;
EXCEPTION
WHEN OTHERS THEN
  CLOSE pointsData;
  CLOSE numerator;
  CLOSE denominator;
 CLOSE sellRate;
 CLOSE abscissa;
END P_DWM_TRENDMAP_K5_3;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_VALUE_PROJECT_SCOPE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_VALUE_PROJECT_SCOPE" (
    userid         IN             VARCHAR2 --当前用户id
    ,
    stationid      IN             VARCHAR2 --当前用户岗位id
    ,
    departmentid   IN             VARCHAR2 --当前用户部门id
    ,
    companyid      IN             VARCHAR2 --当前用户公司id
    ,
    projtreeinfo   OUT            SYS_REFCURSOR--项目树
) AS 
--货值数据项目树
--作者：鲜晓勇
--日期：2020/01/13
--输入变量：用户ID
    data_auth_spid   VARCHAR2(200);
    bizcode          VARCHAR2(200);
BEGIN
    bizcode := 'DWM.DTHZGL.01';
    p_sys_get_company_tree_spid(userid => userid, stationid => stationid, deptid => departmentid, companyid => companyid, bizcode
    => bizcode, data_auth_spid => data_auth_spid);

    OPEN projtreeinfo FOR SELECT
                             orgid      "orgId",
                             orgname    AS "orgName",
                             parentid   AS "parentId",
                             userid  as userid,
                             stationid as stationid,
                             departmentid as departmentid,
                             companyid as companyid,
                             orgtype    AS "orgType"
                         FROM
                             (
                                 SELECT DISTINCT
                                     org_id       AS orgid,
                                     org_name     AS orgname,
                                     order_code   AS ordercode,
                                     parent_id    AS parentid,
                                     org_type     AS orgtype
                                     
                                 FROM
                                     tmp_company_tree
                                 WHERE
                                     id = data_auth_spid
                                     AND org_id IN (
                                         SELECT DISTINCT
                                             id
                                         FROM
                                             sys_business_unit
                                         START WITH
                                             id IN (
                                                 SELECT
                                                     id
                                                 FROM
                                                     (
                                                         SELECT
                                                             unit_id AS id
                                                         FROM
                                                             sys_project
                                                         UNION
                                                         SELECT
                                                             subordinate_company_id AS id
                                                         FROM
                                                             cdb_feasible_project_config
                                                     ) ds
                                             )
                                         CONNECT BY
                                             PRIOR parent_id = id
                                     )
                                 UNION ALL
                                 SELECT
                                     id             AS projid,
                                     project_name   AS projname,
                                     project_code   AS ordercode,
                                     unit_id        AS parentid,
                                     '10' AS orgtype
                                 FROM
                                     sys_project
                             ) t
                         ORDER BY
                             ordercode;

END p_dwm_value_project_scope;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_COMPANY_WORTH
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_W_COMPANY_WORTH" (title out VARCHAR2, wacthinfo OUT sys_refcursor)
AS
 --动态货值监控-7公司可售货值货量监控（树列表）
--作者：陈丽
--日期：2019/11/13
-- 黄伟20191222：【动态货值监控】第1个Tab页的右下方树列表。问题：展示不出多个区域公司。
-- 韩金明20200507: 更改查询逻辑 支持查询带项目的所有公司
BEGIN
    open wacthinfo FOR
        with t1 as(
            select sbu.ID, sbu.ORG_NAME, sum(ddv.area_dt_all) salesArea,
                    SUM(NVL(ddv.ZZ_Value_Dt_All,0)) + SUM(NVL(ddv.SY_Value_Dt_All,0)) +
                    SUM(NVL(ddv.CW_Value_Dt_All,0)) as salesWorth, nvl(count(*), 0) cnt
            from SYS_BUSINESS_UNIT sbu
                     left join  MDM_PROJECT mp on sbu.ID = mp.COMPANY_ID
                     left join (select * from DWM_DT_VALUE where OBJ_TYPE = '项目') ddv on ddv.OBJ_ID = mp.ID
            where mp.IS_DELETE = 0 and APPROVAL_STATUS='已审核'
            group by sbu.ID, sbu.ORG_NAME
        ), t2 as (
            select tt.ID, tt.PARENT_ID, rootId, tt.ORG_NAME, salesArea, salesWorth,
                   ORDER_HIERARCHY_CODE, cnt
            from (
                select sbu.ID, sbu.PARENT_ID, sbu.ORG_NAME, connect_by_root(sbu.ID) rootId,
                       ORDER_HIERARCHY_CODE
                from SYS_BUSINESS_UNIT sbu
                start with id in (select id from t1 where id = sbu.id)
                connect by prior sbu.PARENT_ID = sbu.ID
            ) tt left join t1 on tt.rootId = t1.ID
        )select
             id,
             PARENT_ID "parentsId",
             ORG_NAME "companyName",
                 sum(cnt)||'' "projTotal",
             round(sum(nvl(salesArea, 0))/10000,2) "salesArea",
             round(sum(nvl(salesWorth,0))/100000000,2) "salesWorth",
             ORDER_HIERARCHY_CODE||'' "orderCode"
        from t2 group by id, PARENT_ID, ORG_NAME, ORDER_HIERARCHY_CODE
        order by ORDER_HIERARCHY_CODE;
    title:='货值排行榜（面积单位：万平方   货值单位：亿元）';
END p_dwm_w_company_worth;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_PHASE_LAYOUT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_W_PHASE_LAYOUT" (
    orgid          IN             VARCHAR2 --组织id 公司id，项目id
    ,
    orgtype        IN             VARCHAR2 ---组织类型 公司，项目
    ,
    wdescription   OUT            VARCHAR2 -------描述
    ,
    title          OUT            VARCHAR2 --显示标题
    ,
    unit           OUT            VARCHAR2---单位
    ,
    unitcolor      OUT            VARCHAR2   ---单位颜色
    ,
    wacthinfo      OUT            SYS_REFCURSOR --监控信息（根据页面图
) AS
		--动态货值监控-货值阶段分布tab
		--作者：陈丽
		--日期：2019/12/07

    color_wqz    VARCHAR2(100); -- 未取证
    color_gz     VARCHAR2(100); --规证阶段
    color_sgz    VARCHAR2(100); --施工证阶段
    color_ysz    VARCHAR2(100); --预售许可证
    color_jgba   VARCHAR2(100); --竣工备案证
    color_jz     VARCHAR2(100); --结转阶段
BEGIN
    unit := '亿元';
    unitcolor := '#333333';
    title := '可售货值阶段分布';
		/*WDESCRIPTION := '说明：可再穿透至项目';*/
		/*
    SELECT COLOR_FIRST, COLOR_SECOND, COLOR_THIRD
    INTO   COLOR_ZZ, COLOR_CW, COLOR_SY
    FROM   SYS_COLOR_SET SAMPLE(80)
    WHERE  GROUP_NAME IN ('轻快、华丽、动感', '回味、女性化、优雅', '运动型、轻快') AND
           COLOR_FIRST NOT LIKE '#FFFF%' AND
           COLOR_SECOND NOT LIKE '#FFFF%' AND
           COLOR_THIRD NOT LIKE '#FFFF%' AND
           ROWNUM = 1;*/
    OPEN wacthinfo FOR WITH tmp_proj_value (
                           org_id,
                           orgname,
                           parent_id,
                           order_hierarchy_code,
                           zz_value_allow_sale,
                           cw_value_allow_sale,
                           sy_value_allow_sale,
                           value_not_planning_permit,
                           value_not_construction_permit,
                           value_not_sale_permit,
                           value_not_completion,
                           value_yes_completion,
                           value_yes_settlement,
                           proj_con,
                           orgtype
                       ) AS (
					--子集
                           SELECT
                               a1.id             AS org_id,
                               a1.project_name   AS orgname,
                               a1.unit_id        AS parent_id,
                               a1.order_hierarchy_code,
                               nvl(b1.zz_value_allow_sale, 0) zz_value_allow_sale,
                               nvl(b1.cw_value_allow_sale, 0) cw_value_allow_sale,
                               nvl(b1.sy_value_allow_sale, 0) sy_value_allow_sale,
                               nvl(b1.value_not_planning_permit, 0) AS value_not_planning_permit,
                               nvl(b1.value_not_construction_permit, 0) AS value_not_construction_permit,
                               nvl(b1.value_not_sale_permit, 0) value_not_sale_permit,
                               nvl(b1.value_not_completion, 0) AS value_not_completion,
                               nvl(b1.value_yes_completion, 0) AS value_yes_completion,
                               nvl(b1.value_yes_settlement, 0) AS value_yes_settlement,
                               1 AS proj_con,
                               '1' AS orgtype
                           FROM
                               sys_project    a1
                               INNER JOIN dwm_dt_value   b1 ON a1.id = b1.obj_id
                                                             AND b1.obj_type = '项目'
					--父级
                           UNION ALL
                           SELECT
                               b2.id,
                               b2.org_name,
                               b2.parent_id,
                               b2.order_hierarchy_code,
                               nvl(a2.zz_value_allow_sale, 0),
                               nvl(a2.cw_value_allow_sale, 0),
                               nvl(a2.sy_value_allow_sale, 0),
                               nvl(a2.value_not_planning_permit, 0) AS value_not_planning_permit,
                               nvl(a2.value_not_construction_permit, 0) AS value_not_construction_permit,
                               nvl(a2.value_not_sale_permit, 0) value_not_sale_permit,
                               nvl(a2.value_not_completion, 0) AS value_not_completion,
                               nvl(a2.value_yes_completion, 0) AS value_yes_completion,
                               nvl(a2.value_yes_settlement, 0) AS value_yes_settlement,
                               a2.proj_con,
                               '0' AS orgtype
                           FROM
                               tmp_proj_value      a2
                               INNER JOIN sys_business_unit   b2 ON a2.parent_id = b2.id
                       )
				--/dwm/value-manage/dynamic-value/value-phase?orgid={组织id}&orgtype=0 
                       SELECT
                           1 AS "groupId",
                           '未取证 单位（亿元）' AS "groupName",
                           '#83b5ea' AS "groupColor",
                           300 AS "groupHigh",
                           p.orgname AS "itemName",
                           CASE
                               WHEN p.orgtype = 1 THEN
                                   ''
                               ELSE
                                   '/dwm/value-manage/dynamic-value/value-phase?orgid='
                                   || TO_CHAR(nvl(p.org_id, ''))
                                   || CHR(38)
                                   || 'orgtype=0'
                           END AS "itemOpenUrl",
                           round(SUM(p.value_not_planning_permit) / 100000000, 2) AS "statistics",
                           p.order_hierarchy_code
                       FROM
                           tmp_proj_value p
                       WHERE
                           p.parent_id = orgid
                       GROUP BY
                           p.orgname,
                           p.orgtype,
                           p.org_id,
                           p.order_hierarchy_code
                       UNION ALL
                       SELECT
                           2 AS "groupId",
                           '已取规划许可证 单位（亿元）' AS "groupName",
                           '#666699' AS "groupColor",
                           300 AS "groupHigh",
                           p.orgname AS "itemName",
                           CASE
                               WHEN p.orgtype = 1 THEN
                                   ''
                               ELSE
                                   '/dwm/value-manage/dynamic-value/value-phase?orgid='
                                   || TO_CHAR(nvl(p.org_id, ''))
                                   || CHR(38)
                                   || 'orgtype=0'
                           END AS "itemOpenUrl",
                           round(SUM(p.value_not_construction_permit) / 100000000, 2) AS "statistics",
                           p.order_hierarchy_code
                       FROM
                           tmp_proj_value p
                       WHERE
                           p.parent_id = orgid
                       GROUP BY
                           p.orgname,
                           p.orgtype,
                           p.org_id,
                           p.order_hierarchy_code
                       UNION ALL
                       SELECT
                           3 AS "groupId",
                           '已取施工许可证 单位（亿元）' AS "groupName",
                           '#663300' AS "groupColor",
                           300 AS "groupHigh",
                           p.orgname AS "itemName",
                           CASE
                               WHEN p.orgtype = 1 THEN
                                   ''
                               ELSE
                                   '/dwm/value-manage/dynamic-value/value-phase?orgid='
                                   || TO_CHAR(nvl(p.org_id, ''))
                                   || CHR(38)
                                   || 'orgtype=0'
                           END AS "itemOpenUrl",
                           round(SUM(p.value_not_sale_permit) / 100000000, 2) AS "statistics",
                           p.order_hierarchy_code
                       FROM
                           tmp_proj_value p
                       WHERE
                           p.parent_id = orgid
                       GROUP BY
                           p.orgname,
                           p.orgtype,
                           p.org_id,
                           p.order_hierarchy_code
                       UNION ALL
                       SELECT
                           4 AS "groupId",
                           '已取预售许可证 单位（亿元）' AS "groupName",
                           '#006633' AS "groupColor",
                           300 AS "groupHigh",
                           p.orgname AS "itemName",
                           CASE
                               WHEN p.orgtype = 1 THEN
                                   ''
                               ELSE
                                   '/dwm/value-manage/dynamic-value/value-phase?orgid='
                                   || TO_CHAR(nvl(p.org_id, ''))
                                   || CHR(38)
                                   || 'orgtype=0'
                           END AS "itemOpenUrl",
                           round(SUM(p.value_not_completion) / 100000000, 2) AS "statistics",
                           p.order_hierarchy_code
                       FROM
                           tmp_proj_value p
                       WHERE
                           p.parent_id = orgid
                       GROUP BY
                           p.orgname,
                           p.orgtype,
                           p.org_id,
                           p.order_hierarchy_code
                       UNION ALL
                       SELECT
                           5 AS "groupId",
                           '已取竣工备案证 单位（亿元）' AS "groupName",
                           '#CC9900' AS "groupColor",
                           300 AS "groupHigh",
                           p.orgname AS "itemName",
                           CASE
                               WHEN p.orgtype = 1 THEN
                                   ''
                               ELSE
                                   '/dwm/value-manage/dynamic-value/value-phase?orgid='
                                   || TO_CHAR(nvl(p.org_id, ''))
                                   || CHR(38)
                                   || 'orgtype=0'
                           END AS "itemOpenUrl",
                           round(SUM(p.value_yes_completion) / 100000000, 2) AS "statistics",
                           p.order_hierarchy_code
                       FROM
                           tmp_proj_value p
                       WHERE
                           p.parent_id = orgid
                       GROUP BY
                           p.orgname,
                           p.orgtype,
                           p.org_id,
                           p.order_hierarchy_code
                       UNION ALL
                       SELECT
                           6 AS "groupId",
                           '已结转 单位（亿元）' AS "groupName",
                           '#CC3366' AS "groupColor",
                           300 AS "groupHigh",
                           p.orgname AS "itemName",
                           CASE
                               WHEN p.orgtype = 1 THEN
                                   ''
                               ELSE
                                   '/dwm/value-manage/dynamic-value/value-phase?orgid='
                                   || TO_CHAR(nvl(p.org_id, ''))
                                   || CHR(38)
                                   || 'orgtype=0'
                           END AS "itemOpenUrl",
                           round(SUM(p.value_yes_settlement) / 100000000, 2) AS "statistics",
                           p.order_hierarchy_code
                       FROM
                           tmp_proj_value p
                       WHERE
                           p.parent_id = orgid
                       GROUP BY
                           p.orgname,
                           p.orgtype,
                           p.org_id,
                           p.order_hierarchy_code
                       ORDER BY
                           1,
                           8;

END p_dwm_w_phase_layout;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_PRESALE_PERMIT_WORTH
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_W_PRESALE_PERMIT_WORTH" 
(
		TITLE     OUT VARCHAR2
	 ,BARTYPE   OUT VARCHAR2
	 ,UNIT      OUT VARCHAR2
	 ,WACTHINFO OUT SYS_REFCURSOR
) AS
		--动态货值监控-4已取预售证的货值情况
		--作者：陈丽
		--日期：2019/11/13
BEGIN
		OPEN WACTHINFO FOR
				SELECT '已售货值' AS NAME, round(SUM(A.VALUE_HAVED_SALE)/100000000,2) AS TOTAL,
							 '#37cd69' AS "color"
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '未售货值' AS NAME, round(SUM(A.VALUE_STOCK)/100000000,2) AS TOTAL,
							 '#E68CB2' AS "color"
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目';
		TITLE   := '已领预售证的货值情况';
		UNIT    := '亿元';
		BARTYPE := 'column';
END P_DWM_W_PRESALE_PERMIT_WORTH;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_PRODUCT_TYPE_LAYOUT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_W_PRODUCT_TYPE_LAYOUT" 
(
		ORGID        IN VARCHAR2 --组织id 公司id，项目id
	 ,ORGTYPE      IN VARCHAR2 ---组织类型 公司，项目
	 ,WDESCRIPTION OUT VARCHAR2 -------描述
	 ,TITLE        OUT VARCHAR2 --显示标题
      ,unit          OUT VARCHAR2 ---单位
    ,unitcolor    OUT VARCHAR2   ---单位颜色
	 ,WACTHINFO    OUT SYS_REFCURSOR --监控信息（根据页面图
) AS
		--动态货值监控-货值业态分布tab
		--作者：陈丽
		--日期：2019/12/07

		COLOR_ZZ VARCHAR2(100);
		COLOR_CW VARCHAR2(100);
		COLOR_SY VARCHAR2(100);

BEGIN
		TITLE := '各项目可售货值业态分布';
		/*WDESCRIPTION := '说明：可再穿透至项目';*/
  unit := '亿元';
    unitcolor := '#333333';
		SELECT COLOR_FIRST, COLOR_SECOND, COLOR_THIRD
		INTO   COLOR_ZZ, COLOR_CW, COLOR_SY
		FROM   SYS_COLOR_SET SAMPLE(80)
		WHERE  GROUP_NAME IN ('轻快、华丽、动感','回味、女性化、优雅','运动型、轻快') AND
					 COLOR_FIRST NOT LIKE '#FFFF%' AND
					 COLOR_SECOND NOT LIKE '#FFFF%' AND
					 COLOR_THIRD NOT LIKE '#FFFF%' AND
					 ROWNUM = 1;

		OPEN WACTHINFO FOR
		
				WITH TMP_PROJ_VALUE(ORG_ID,
				ORGNAME,
				PARENT_ID,
				ORDER_HIERARCHY_CODE,
				ZZ_VALUE_ALLOW_SALE,
				CW_VALUE_ALLOW_SALE,
				SY_VALUE_ALLOW_SALE,
				PROJ_CON,
				ORGTYPE) AS
				 (
					--子集
					SELECT A1.ID AS ORG_ID, A1.PROJECT_NAME AS ORGNAME,
									A1.UNIT_ID AS PARENT_ID, A1.ORDER_HIERARCHY_CODE,
									NVL(B1.ZZ_VALUE_ALLOW_SALE, 0) ZZ_VALUE_ALLOW_SALE,
									NVL(B1.CW_VALUE_ALLOW_SALE, 0) CW_VALUE_ALLOW_SALE,
									NVL(B1.SY_VALUE_ALLOW_SALE, 0) SY_VALUE_ALLOW_SALE,
									1 AS PROJ_CON, '1' AS ORGTYPE
					FROM   SYS_PROJECT A1
					INNER  JOIN DWM_DT_VALUE B1
					ON     A1.ID = B1.OBJ_ID AND
								 B1.OBJ_TYPE = '项目'
					--父级
					UNION ALL
					SELECT B2.ID, B2.ORG_NAME, B2.PARENT_ID, B2.ORDER_HIERARCHY_CODE,
									NVL(A2.ZZ_VALUE_ALLOW_SALE, 0),
									NVL(A2.CW_VALUE_ALLOW_SALE, 0),
									NVL(A2.SY_VALUE_ALLOW_SALE, 0), A2.PROJ_CON, '0' AS ORGTYPE
					FROM   TMP_PROJ_VALUE A2
					INNER  JOIN SYS_BUSINESS_UNIT B2
					ON     A2.PARENT_ID = B2.ID)
				--/dwm/plan-worth/distribution-format?orgid=003200000000000000000000000000&orgtype=0
				SELECT 1 AS "groupId", '住宅 单位（亿元）' AS "groupName",
							 COLOR_ZZ AS "groupColor", 300 AS "groupHigh",
							 P.ORGNAME AS "itemName",
							 CASE
									 WHEN P.ORGTYPE = 1 THEN
										''
									 ELSE
										'/dwm/value-manage/dynamic-value/distributed?orgid=' ||
										TO_CHAR(NVL(P.ORG_ID, '')) || CHR(38) || 'orgtype=0'
							 END AS "itemOpenUrl",
							 ROUND(SUM(P.ZZ_VALUE_ALLOW_SALE) / 100000000, 2) AS "statistics",
							 P.ORDER_HIERARCHY_CODE
				FROM   TMP_PROJ_VALUE P
				WHERE  P.PARENT_ID = ORGID
				GROUP  BY P.ORGNAME, P.ORG_ID, P.ORGTYPE, P.ORDER_HIERARCHY_CODE
				UNION ALL
				SELECT 2 AS "groupId", '车位 单位（亿元）' AS "groupName",
								COLOR_CW AS "groupColor", 300 AS "groupHigh",
								P.ORGNAME AS "itemName",
								CASE
										 WHEN P.ORGTYPE = 1 THEN
											''
										 ELSE
											'/dwm/value-manage/dynamic-value/distributed?orgid=' ||
											TO_CHAR(NVL(P.ORG_ID, '')) || CHR(38) || 'orgtype=0'
								 END AS "itemOpenUrl",
								ROUND(SUM(P.CW_VALUE_ALLOW_SALE) / 100000000, 2) AS "statistics",
								P.ORDER_HIERARCHY_CODE
				FROM   TMP_PROJ_VALUE P
				WHERE  P.PARENT_ID = ORGID
				GROUP  BY P.ORGNAME, P.ORG_ID, P.ORGTYPE, P.ORDER_HIERARCHY_CODE
				UNION ALL
				SELECT 3 AS "groupId", '商业 单位（亿元）' AS "groupName",
								 COLOR_SY AS "groupColor", 300 AS "groupHigh",
								 P.ORGNAME AS "itemName",
								 CASE
											WHEN P.ORGTYPE = 1 THEN
											 ''
											ELSE
											 '/dwm/value-manage/dynamic-value/distributed?orgid=' ||
											 TO_CHAR(NVL(P.ORG_ID, '')) || CHR(38) || 'orgtype=0'
									END AS "itemOpenUrl",
								 ROUND(SUM(P.SY_VALUE_ALLOW_SALE) / 100000000, 2) AS "statistics",
								 P.ORDER_HIERARCHY_CODE
				FROM   TMP_PROJ_VALUE P
				WHERE  P.PARENT_ID = ORGID
				GROUP  BY P.ORGNAME, P.ORG_ID, P.ORGTYPE, P.ORDER_HIERARCHY_CODE
				ORDER  BY 8;

END P_DWM_W_PRODUCT_TYPE_LAYOUT;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_PRODUCT_TYPE_WORTH
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_W_PRODUCT_TYPE_WORTH" (title out VARCHAR2,bartype out VARCHAR2,unit out VARCHAR2,carport out INT,wacthinfo OUT sys_refcursor,classificationRatio out sys_refcursor)
AS  
--动态货值监控-6各产品类型可售货值的业态分布图
--作者：陈丽
--日期：2019/11/13
-- 黄伟2020-01-02修改过
BEGIN
open wacthinfo for
select
'住宅' as  "name",
round(SUM(NVL(a.Zz_Value_Dt_All,0))/100000000,2) as "total" ,
'#37cd69' as "color"
from Dwm_Dt_Value a
WHERE a.obj_type='项目'
UNION

/*select
'住宅(库存)' as  "name",
round(SUM(NVL(a.zz_value_stock,0))/100000000,2) as "total" ,
'#37cd69' as "color"
from Dwm_Dt_Value a
WHERE a.obj_type='项目'
UNION*/

select
'商业' as  "name",
round(SUM(NVL(a.SY_Value_Dt_All,0))/100000000,2) as "total" ,
'#37cd69' as "color"
from Dwm_Dt_Value a
WHERE a.obj_type='项目'

/*UNION
select
'商业(库存)' as  "name",
round(SUM(NVL(a.SY_Value_STOCK,0))/100000000,2) as "total" ,
'#37cd69' as "color"
from Dwm_Dt_Value a
WHERE a.obj_type='项目'*/

union
select
'车位' as  "name",
round(SUM(NVL(a.CW_Value_Dt_All,0))/100000000,2) as "total" ,
'#37cd69' as "color"
from Dwm_Dt_Value a
WHERE a.obj_type='项目'

/*union
select
'车位(库存)' as  "name",
round(SUM(NVL(a.CW_Value_STOCK,0))/100000000,2) as "total" ,
'#37cd69' as "color"
from Dwm_Dt_Value a
WHERE a.obj_type='项目'*/
;
title:='各产品类型总可售货值的业态分布图';
unit:='亿元';
bartype:='column';
carport:=10000;
SELECT SUM(NVL(a.CW_AREA_Dt_All,0)) INTO carport from Dwm_Dt_Value a
WHERE a.obj_type='项目'
;


open classificationRatio for
select
'住宅' as  "name",
to_Char(round(SUM(NVL(a.ZZ_Value_Dt_All,0))/(SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))*100,2),'99.99')||'%' as "total" 
from Dwm_Dt_Value a
WHERE a.obj_type='项目'
union
select
'商业' as  "name",
to_Char(round(SUM(NVL(a.SY_Value_Dt_All,0))/(SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))*100,2),'99.99')||'%' as "total" 
from Dwm_Dt_Value a
WHERE a.obj_type='项目'
union
select
'车位' as  "name",
to_Char(round(SUM(NVL(a.CW_Value_Dt_All,0))/(SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))*100,2),'99.99')||'%' as "total" 
from Dwm_Dt_Value a
WHERE a.obj_type='项目'

;

END p_dwm_w_product_type_worth;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_REPERTORY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_W_REPERTORY" 
(
		USERID        IN VARCHAR2 --当前用户id
	 ,STATIONID     IN VARCHAR2 --当前用户岗位id
	 ,DEPARTMENTID  IN VARCHAR2 --当前用户部门id
	 ,COMPANYID     IN VARCHAR2 --当前用户公司id
	 ,ORGID         IN VARCHAR2 --组织id 公司id，项目id
	 ,ORGTYPE       IN VARCHAR2 ---组织类型 0:公司，1:项目
	 ,SCOPEYEAR     IN VARCHAR2 --监控范围段 年
	 ,SCOPEMONTH    IN VARCHAR2 --监控范围 月
	 ,REPERTORYTYPE IN VARCHAR2 --库存类型 各区域库存业态分析图：productType ，各区域库存货龄分析图：age
      ,UNIT          OUT VARCHAR2 ---- 单位
     ,UNITCOLOR     OUT VARCHAR2 --单位颜色
	 ,TITLE         OUT VARCHAR2 --显示标题
	 ,ISSHOWVALUE   OUT INT --是否显示数字 1显示，0不显示
	 ,WACTHINFO     OUT SYS_REFCURSOR --监控信息（根据页面图）
) AS
		--动态货值监控-库存监控tab
		--作者：陈丽
		--日期：2019/12/07
BEGIN
  unit := '亿元';
    unitcolor := '#333333';
		IF REPERTORYTYPE = 'productType' THEN
				TITLE := '区域库存业态分析图';
		ELSE
				TITLE := '区域库存货龄分析图';
		END IF;
		ISSHOWVALUE := 1;
		IF REPERTORYTYPE = 'productType' THEN
				OPEN WACTHINFO FOR
						WITH TMP_PROJ_VALUE(ORG_ID,
						ORGNAME,
						PARENT_ID,
						ORDER_HIERARCHY_CODE,
						ZZ_VALUE_ALLOW_SALE,
						CW_VALUE_ALLOW_SALE,
						SY_VALUE_ALLOW_SALE,
						VALUE_NOT_PLANNING_PERMIT,
						VALUE_NOT_CONSTRUCTION_PERMIT,
						VALUE_NOT_SALE_PERMIT,
						VALUE_NOT_COMPLETION,
						VALUE_YES_COMPLETION,
						VALUE_YES_SETTLEMENT,
						ZZ_VALUE_STOCK,
						CW_VALUE_STOCK,
						SY_VALUE_STOCK,
						PROJ_CON,
						ORGTYPE) AS
						 (
							--子集
							SELECT A1.ID AS ORG_ID, A1.PROJECT_NAME AS ORGNAME, A1.UNIT_ID AS PARENT_ID, A1.ORDER_HIERARCHY_CODE, NVL(B1.ZZ_VALUE_ALLOW_SALE, 0) ZZ_VALUE_ALLOW_SALE,
											NVL(B1.CW_VALUE_ALLOW_SALE, 0) CW_VALUE_ALLOW_SALE, NVL(B1.SY_VALUE_ALLOW_SALE, 0) SY_VALUE_ALLOW_SALE, NVL(B1.VALUE_NOT_PLANNING_PERMIT, 0) AS VALUE_NOT_PLANNING_PERMIT,
											NVL(B1.VALUE_NOT_CONSTRUCTION_PERMIT, 0) AS VALUE_NOT_CONSTRUCTION_PERMIT, NVL(B1.VALUE_NOT_SALE_PERMIT, 0) VALUE_NOT_SALE_PERMIT,
											NVL(B1.VALUE_NOT_COMPLETION, 0) AS VALUE_NOT_COMPLETION, NVL(B1.VALUE_YES_COMPLETION, 0) AS VALUE_YES_COMPLETION, NVL(B1.VALUE_YES_SETTLEMENT, 0) AS VALUE_YES_SETTLEMENT,
											NVL(B1.ZZ_VALUE_STOCK, 0) ZZ_VALUE_STOCK, NVL(B1.CW_VALUE_STOCK, 0) CW_VALUE_STOCK, NVL(B1.SY_VALUE_STOCK, 0) AS SY_VALUE_STOCK, 1 AS PROJ_CON, '1' AS ORGTYPE
							FROM   SYS_PROJECT A1
							INNER  JOIN DWM_DT_VALUE B1
							ON     A1.ID = B1.OBJ_ID AND
										 B1.OBJ_TYPE = '项目'
							--父级
							UNION ALL
							SELECT B2.ID, B2.ORG_NAME, B2.PARENT_ID, B2.ORDER_HIERARCHY_CODE, NVL(A2.ZZ_VALUE_ALLOW_SALE, 0), NVL(A2.CW_VALUE_ALLOW_SALE, 0), NVL(A2.SY_VALUE_ALLOW_SALE, 0),
											NVL(A2.VALUE_NOT_PLANNING_PERMIT, 0) AS VALUE_NOT_PLANNING_PERMIT, NVL(A2.VALUE_NOT_CONSTRUCTION_PERMIT, 0) AS VALUE_NOT_CONSTRUCTION_PERMIT,
											NVL(A2.VALUE_NOT_SALE_PERMIT, 0) VALUE_NOT_SALE_PERMIT, NVL(A2.VALUE_NOT_COMPLETION, 0) AS VALUE_NOT_COMPLETION, NVL(A2.VALUE_YES_COMPLETION, 0) AS VALUE_YES_COMPLETION,
											NVL(A2.VALUE_YES_SETTLEMENT, 0) AS VALUE_YES_SETTLEMENT, NVL(A2.ZZ_VALUE_STOCK, 0) ZZ_VALUE_STOCK, NVL(A2.CW_VALUE_STOCK, 0) CW_VALUE_STOCK,
											NVL(A2.SY_VALUE_STOCK, 0) AS SY_VALUE_STOCK, A2.PROJ_CON, '0' AS ORGTYPE
							FROM   TMP_PROJ_VALUE A2
							INNER  JOIN SYS_BUSINESS_UNIT B2
							ON     A2.PARENT_ID = B2.ID)
						
						SELECT '1' AS "repertoryTypeId", '住宅' AS "repertoryTypeName", A.ORGNAME AS "orgName", ROUND(SUM(A.ZZ_VALUE_STOCK) / 100000000, 2) AS "statistics", 1 AS "orderId",
									 CASE
												WHEN A.ORGTYPE = 1 THEN
												 ''
												ELSE
												 '/dwm/value-manage/dynamic-value/monitorStock?orgid=' || TO_CHAR(NVL(A.ORG_ID, '')) || CHR(38) || 'orgtype=0'
										END AS "openUrl", A.ORDER_HIERARCHY_CODE
						FROM   TMP_PROJ_VALUE A
						WHERE  A.PARENT_ID = ORGID
						GROUP  BY A.ORGNAME, A.ORG_ID, A.ORGTYPE, A.ORDER_HIERARCHY_CODE
						UNION ALL
						SELECT '2' AS "repertoryTypeId", '车位' AS "repertoryTypeName", A.ORGNAME AS "orgName", ROUND(SUM(A.CW_VALUE_STOCK) / 100000000, 2) AS "statistics", 1 AS "orderId",
										CASE
												 WHEN A.ORGTYPE = 1 THEN
													''
												 ELSE
													'/dwm/value-manage/dynamic-value/monitorStock?orgid=' || TO_CHAR(NVL(A.ORG_ID, '')) || CHR(38) || 'orgtype=0'
										 END AS "openUrl", A.ORDER_HIERARCHY_CODE
						FROM   TMP_PROJ_VALUE A
						WHERE  A.PARENT_ID = ORGID
						GROUP  BY A.ORGNAME, A.ORG_ID, A.ORGTYPE, A.ORDER_HIERARCHY_CODE
						UNION ALL
						SELECT '3' AS "repertoryTypeId", '商业' AS "repertoryTypeName", A.ORGNAME AS "orgName", ROUND(SUM(A.SY_VALUE_STOCK) / 100000000, 2) AS "statistics", 1 AS "orderId",
										 CASE
													WHEN A.ORGTYPE = 1 THEN
													 ''
													ELSE
													 '/dwm/value-manage/dynamic-value/monitorStock?orgid=' || TO_CHAR(NVL(A.ORG_ID, '')) || CHR(38) || 'orgtype=0'
											END AS "openUrl", A.ORDER_HIERARCHY_CODE
						FROM   TMP_PROJ_VALUE A
						WHERE  A.PARENT_ID = ORGID
						GROUP  BY A.ORGNAME, A.ORG_ID, A.ORGTYPE, A.ORDER_HIERARCHY_CODE
						ORDER  BY 7;
		
		ELSIF REPERTORYTYPE = 'age' THEN
				OPEN WACTHINFO FOR
						WITH TMP_STOCK_VALUE(ORG_ID,
						ORGNAME,
						PARENTID,
						ORDER_HIERARCHY_CODE,
						ORGTYPE,
						SIX_MONTH_IN,
						SIX_TO_TWELVE_MONTH,
						TWELVE_TO_EIGHTEEN_MONTH,
						EIGHTEEN_MONTH_ABOVE,
						TOTAL) AS
						 (
							--子集
							SELECT A1.ID AS ORG_ID, A1.PROJECT_NAME AS ORGNAME, A1.UNIT_ID AS PARENT_ID, A1.ORDER_HIERARCHY_CODE, '1' AS ORGTYPE,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) <= 5 THEN
																B1.BZ_PRICE * B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS SIX_MONTH_IN,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) BETWEEN 6 AND 12 THEN
																B1.BZ_PRICE * B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS SIX_TO_TWELVE_MONTH,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) BETWEEN 12 AND 18 THEN
																B1.BZ_PRICE * B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS TWELVE_TO_EIGHTEEN_MONTH,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) > 18 OR C1.GET_PRE_SALE_PERMIT_DATE IS NULL THEN
																B1.BZ_PRICE * B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS EIGHTEEN_MONTH_ABOVE, SUM(B1.BZ_PRICE * B1.PRE_BLD_AREA) AS TOTAL
							FROM   SYS_PROJECT A1
							LEFT   JOIN MDM_ROOM B1
							ON     A1.ID = B1.PROJECT_ID AND
										 B1.SALE_STATE <> '签约'
							LEFT   JOIN MDM_BUILD C1
							ON     B1.BUILDING_ID = C1.ID
							GROUP  BY A1.ID, A1.PROJECT_NAME, A1.UNIT_ID, A1.ORDER_HIERARCHY_CODE
							--父级
							UNION ALL
							SELECT B2.ID, B2.ORG_NAME, B2.PARENT_ID, B2.ORDER_HIERARCHY_CODE, '0' AS ORGTYPE, SIX_MONTH_IN, SIX_TO_TWELVE_MONTH, TWELVE_TO_EIGHTEEN_MONTH, EIGHTEEN_MONTH_ABOVE, TOTAL
							FROM   TMP_STOCK_VALUE A2
							INNER  JOIN SYS_BUSINESS_UNIT B2
							ON     A2.PARENTID = B2.ID)
						
						SELECT 1 AS "repertoryTypeId", '6个月以内' AS "repertoryTypeName", P.ORGNAME AS "orgName", ROUND(SUM(P.SIX_MONTH_IN) / 100000000, 2) AS "statistics", 1 AS ORDERID,
									 CASE
												WHEN P.ORGTYPE = 1 THEN
												 ''
												ELSE
												 '/dwm/value-manage/dynamic-value/monitorStock?orgid=' || TO_CHAR(NVL(P.ORG_ID, '')) || CHR(38) || 'orgtype=0'
										END AS "openUrl", P.ORDER_HIERARCHY_CODE
						FROM   TMP_STOCK_VALUE P
						WHERE  P.PARENTID = ORGID
						GROUP  BY P.ORGNAME, P.ORGTYPE, P.ORG_ID, P.ORDER_HIERARCHY_CODE
						UNION ALL
						SELECT 2 AS "repertoryTypeId", '6-12个月' AS "repertoryTypeName", P.ORGNAME AS "orgName", ROUND(SUM(P.SIX_TO_TWELVE_MONTH) / 100000000, 2) AS "statistics", 2 AS ORDERID,
										CASE
												 WHEN P.ORGTYPE = 1 THEN
													''
												 ELSE
													'/dwm/value-manage/dynamic-value/monitorStock?orgid=' || TO_CHAR(NVL(P.ORG_ID, '')) || CHR(38) || 'orgtype=0'
										 END AS "openUrl", P.ORDER_HIERARCHY_CODE
						FROM   TMP_STOCK_VALUE P
						WHERE  P.PARENTID = ORGID
						GROUP  BY P.ORGNAME, P.ORGTYPE, P.ORG_ID, P.ORDER_HIERARCHY_CODE
						UNION ALL
						SELECT 3 AS "repertoryTypeId", '12-18个月' AS "repertoryTypeName", P.ORGNAME AS "orgName", ROUND(SUM(P.TWELVE_TO_EIGHTEEN_MONTH) / 100000000, 2) AS "statistics", 3 AS ORDERID,
										 CASE
													WHEN P.ORGTYPE = 1 THEN
													 ''
													ELSE
													 '/dwm/value-manage/dynamic-value/monitorStock?orgid=' || TO_CHAR(NVL(P.ORG_ID, '')) || CHR(38) || 'orgtype=0'
											END AS "openUrl", P.ORDER_HIERARCHY_CODE
						FROM   TMP_STOCK_VALUE P
						WHERE  P.PARENTID = ORGID
						GROUP  BY P.ORGNAME, P.ORGTYPE, P.ORG_ID, P.ORDER_HIERARCHY_CODE
						UNION ALL
						SELECT 4 AS "repertoryTypeId", '18个月以上' AS "repertoryTypeName", P.ORGNAME AS "orgName", ROUND(SUM(P.EIGHTEEN_MONTH_ABOVE) / 100000000, 2) AS "statistics", 4 AS ORDERID,
											CASE
													 WHEN P.ORGTYPE = 1 THEN
														''
													 ELSE
														'/dwm/value-manage/dynamic-value/monitorStock?orgid=' || TO_CHAR(NVL(P.ORG_ID, '')) || CHR(38) || 'orgtype=0'
											 END AS "openUrl", P.ORDER_HIERARCHY_CODE
						FROM   TMP_STOCK_VALUE P
						WHERE  P.PARENTID = ORGID
						GROUP  BY P.ORGNAME, P.ORGTYPE, P.ORG_ID, P.ORDER_HIERARCHY_CODE
						ORDER  BY 7;
		END IF;

END P_DWM_W_REPERTORY;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_SALES_RATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_W_SALES_RATE" 
(
		SCOPEYEAR  IN VARCHAR2 --监控时间段 年
	 ,SCOPEMONTH IN VARCHAR2 --监控时间段 月
	 ,ORGID      IN VARCHAR2 --组织id 公司id，项目id
	 ,ORGTYPE    IN VARCHAR2 ---组织类型 0:公司，1:项目
      ,unit          OUT VARCHAR2 ---- 单位
     ,unitcolor     OUT VARCHAR2 --单位颜色
	 ,TITLE      OUT VARCHAR2 --显示标题
	 ,WACTHINFO  OUT SYS_REFCURSOR --监控信息（根据页面图
) AS
		--动态货值监控-货值去化率监控tab
		--作者：陈丽
		--日期：2019/12/07
BEGIN
		TITLE := '可售货值去化率';
         unit := '亿元';
    unitcolor := '#333333';
		OPEN WACTHINFO FOR
				WITH TMP_SALERATE(ORG_ID,
				ORGNAME,
				PARENTID,
				ORDER_HIERARCHY_CODE,
				CONTRACTAMOUNT,
				SALEWORTH,
				ORGTYPE) AS
				 (SELECT A1.ID AS ORG_ID, A1.PROJECT_NAME AS ORGNAME, A1.UNIT_ID AS PARENTID, A1.ORDER_HIERARCHY_CODE, NVL(B1.VALUE_HAVED_SALE, 0) AS CONTRACTAMOUNT,
								 NVL(B1.VALUE_STOCK, 0) + NVL(B1.VALUE_HAVED_SALE, 0) AS SALEWORTH, 1 AS ORGTYPE
					FROM   SYS_PROJECT A1
					INNER  JOIN DWM_DT_VALUE B1
					ON     A1.ID = B1.OBJ_ID AND
								 B1.OBJ_TYPE = '项目'
					UNION ALL
					
					SELECT B2.ID, B2.ORG_NAME, B2.PARENT_ID, B2.ORDER_HIERARCHY_CODE, A2.CONTRACTAMOUNT, A2.SALEWORTH, 0
					FROM   TMP_SALERATE A2
					INNER  JOIN SYS_BUSINESS_UNIT B2
					ON     A2.PARENTID = B2.ID
					
					)
				
				SELECT P.ORGNAME AS "orgName", ROUND(SUM(P.SALEWORTH) / 100000000, 2) AS "salesWorth", ROUND(SUM(P.CONTRACTAMOUNT) / 100000000, 2) AS "contractAmount",
							 CASE
									 WHEN P.ORGTYPE = 1 THEN
										''
									 ELSE
										'/dwm/value-manage/dynamic-value/sales-value?orgid=' || P.ORG_ID || CHR(38) || 'orgtype=0'
							 END AS "openUrl",
							 CASE
									 WHEN SUM(P.SALEWORTH) = 0 THEN
										0
									 ELSE
										ROUND(SUM(P.CONTRACTAMOUNT) / SUM(P.SALEWORTH) * 100, 2)
							 END AS "salesRate"
				FROM   TMP_SALERATE P
				WHERE  P.PARENTID = ORGID
				GROUP  BY P.ORGNAME, P.ORGTYPE, P.ORG_ID, P.ORDER_HIERARCHY_CODE
				ORDER  BY P.ORDER_HIERARCHY_CODE
				
				;

END P_DWM_W_SALES_RATE;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_SALES_WORTH_AREA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_W_SALES_WORTH_AREA" (title out VARCHAR2,wacthinfo OUT sys_refcursor)
AS
--动态货值监控-5可售货值区域分布(中国地图）
--作者：陈丽
--日期：2019/11/13
-- 黄伟20191222：【动态货值监控】第1个Tab页的底部。

BEGIN
open wacthinfo FOR

-- 1 华南区域:广州市
-- 2 北方区域：北京
-- 3 华东区域：上海市
-- 4 西南区域：成都市
-- 5 华中公司：西安市
-- 6 中南区域：武汉市
-- 7 东北区域：沈阳市

-- 1 华南区域:广州市
select a."place",a."totalworth",a."proportion",b."salesArea",b."projName",b."salesWorth" from (

select
'1' as "indexid",
'广州市' as "place",
to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2))  as  "totalworth",
'100%' as "proportion"

    from dwm_dt_value a
    LEFT JOIN mdm_project b ON a.obj_id=b.id
    WHERE a.obj_type='项目' AND a.ORDER_HIERARCHY_CODE LIKE '001.004.%'

-- 2 北方区域：北京
union all
select
'2' as "indexid",
'北京' as "place",
'0' as  "totalworth",
'0%' as "proportion"
from dual



-- 3 华东区域：上海市
union all
select
'3' as "indexid",
'上海' as "place",
'0' as  "totalworth",
'0%' as "proportion"
from dual

-- 4 西南区域：成都市
union all
select
'4' as "indexid",
'成都市' as "place",
'0' as  "totalworth",
'0%' as "proportion"
from dual

-- 5 华中公司：西安市
union all
select
'5' as "indexid",
'西安市' as "place",
'0' as  "totalworth",
'0%' as "proportion"
from dual

-- 6 中南区域：武汉市
union all
select
'6' as "indexid",
'武汉市' as "place",
'0' as  "totalworth",
'0%' as "proportion"
from dual

-- 7 东北区域：沈阳市
union all
select
'7' as "indexid",
'沈阳市' as "place",
'0' as  "totalworth",
'0%' as "proportion"
from dual
) a

left join
(

-- 1 华南区域:广州市
      SELECT 
        '1' as "indexid",
        c.org_name as  "projName",
        to_char(round(SUM(nvl(a.area_dt_all,0))/10000,2)) as "salesArea",
        to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2)) as "salesWorth"
    from dwm_dt_value a
    LEFT JOIN mdm_project b ON a.obj_id=b.id
    LEFT JOIN sys_business_unit c ON b.company_id=c.id
    WHERE a.obj_type='项目' AND a.ORDER_HIERARCHY_CODE LIKE '001.004.%'
    GROUP BY C.ORDER_HIERARCHY_CODE,c.org_name

-- 2 北方区域：北京
union all
select
'2' as "indexid",
'北京：0个' as  "projName",
'-' as "salesArea",
'-' as "salesWorth"
from dual


union all
select
'2' as "indexid",
'天津：0个' as  "projName",
'-' as "salesArea",
'-' as "salesWorth"
from dual

union all
select
'2' as "indexid",
'济南：0个' as  "projName",
'-' as "salesArea",
'-' as "salesWorth"
from dual

-- 3 华东区域：上海
union all
select
'3' as "indexid",
'上海：0个' as  "projName",
'-' as "salesArea",
'-' as "salesWorth"
from dual

union all
select
'3' as "indexid",
'杭州：0个' as  "projName",
'-' as "salesArea",
'-' as "salesWorth"
from dual


union all
select
'3' as "indexid",
'南京：0个' as  "projName",
'-' as "salesArea",
'-' as "salesWorth"
from dual


union all
select
'3' as "indexid",
'合肥：0个' as  "projName",
'-' as "salesArea",
'-' as "salesWorth"
from dual


-- 4 西南区域：成都市
union all
select
'4' as "indexid",
'成都：0个' as  "projName",
'-' as "salesArea",
'-' as "salesWorth"
from dual

union all
select
'4' as "indexid",
'重庆：0个' as  "projName",
'-' as "salesArea",
'-' as "salesWorth"
from dual

union all
select
'4' as "indexid",
'昆明：0个' as  "projName",
'-' as "salesArea",
'-' as "salesWorth"
from dual

union all
select
'4' as "indexid",
'贵阳：0个' as  "projName",
'-' as "salesArea",
'-' as "salesWorth"
from dual

union all
select
'4' as "indexid",
'达州：0个' as  "projName",
'-' as "salesArea",
'-' as "salesWorth"
from dual

-- 5 华中公司：西安市
union all
select
'5' as "indexid",
'西安：0个' as  "projName",
'-' as "salesArea",
'-' as "salesWorth"
from dual

union all
select
'5' as "indexid",
'太原：0个' as  "projName",
'-' as "salesArea",
'-' as "salesWorth"
from dual


union all
select
'5' as "indexid",
'石家庄：0个' as  "projName",
'-' as "salesArea",
'-' as "salesWorth"
from dual

union all
select
'5' as "indexid",
'郑州：0个' as  "projName",
'-' as "salesArea",
'-' as "salesWorth"
from dual


-- 6 中南区域：武汉市
union all
select
'6' as "indexid",
'武汉：0个' as  "projName",
'-' as "salesArea",
'-' as "salesWorth"
from dual

union all
select
'6' as "indexid",
'长沙：0个' as  "projName",
'-' as "salesArea",
'-' as "salesWorth"
from dual


-- 7 东北区域：沈阳市
union all
SELECT
'7' as "indexid",
'沈阳：0个' as  "projName",
'-' as "salesArea",
'-' as "salesWorth"
from dual

union all
SELECT
'7' as "indexid",
'长春：0个' as  "projName",
'-' as "salesArea",
'-' as "salesWorth"
from dual


union all
SELECT
'7' as "indexid",
'哈尔滨：0个' as  "projName",
'-' as "salesArea",
'-' as "salesWorth"
from dual

)b on a."indexid"=b."indexid";


title:='可售货值区域分布';
END p_dwm_w_sales_worth_area;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_TOTAL_WORTH
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_W_TOTAL_WORTH" 
(
		TITLE     OUT VARCHAR2
	 ,BARTYPE   OUT VARCHAR2
	 ,UNIT      OUT VARCHAR2
	 ,WACTHINFO OUT SYS_REFCURSOR
) AS
		--动态货值监控-2总货值情况：目标货值 vs 动态货值
		--作者：陈丽
		--日期：2019/11/13

		V_KY_TARGET_VALUE NUMBER(18, 2); --可研版
		V_QP_TARGET_VALUE NUMBER(18, 2);
		V_DT_TARGET_VALUE NUMBER(18, 2);
		V_NOW_TARGET_VALUE NUMBER(18, 2);
		V_DT_VALUE        NUMBER(18, 2);

BEGIN
 /*
		SELECT ROUND(SUM(B.TMP_1KY_VALUE) / 10000, 2)
		INTO   V_KY_TARGET_VALUE
		FROM   SYS_PROJECT A
		INNER  JOIN DWM_DT_VALUE B
		ON     A.ID = B.PROJ_ID AND b.OBJ_TYPE = '项目'
		\*WHERE  B.APPROVAL_STATUS = '已审核' AND
					 B.TARGET_WORTH_PHASE = 0*\;

		SELECT ROUND(SUM(B.TMP_2QP_VALUE) / 10000, 2)
		INTO   V_QP_TARGET_VALUE
		FROM   SYS_PROJECT A
		INNER  JOIN DWM_DT_VALUE B
		ON     A.ID = B.PROJ_ID AND b.OBJ_TYPE = '项目'
		\*WHERE  B.APPROVAL_STATUS = '已审核' AND
					 B.TARGET_WORTH_PHASE = 10*\;

		SELECT ROUND(SUM(B.TMP_3DT_TARGETVALUE) / 10000, 2)
		INTO   V_DT_TARGET_VALUE
		FROM   SYS_PROJECT A
		INNER  JOIN DWM_DT_VALUE B
		ON     A.ID = B.PROJ_ID  AND b.OBJ_TYPE = '项目';
		

		SELECT ROUND((SUM(NVL(B.VALUE_RESERVE,0))+SUM(NVL(B.VALUE_IN_PROCESS,0))+SUM(NVL(B.VALUE_STOCK,0))+SUM(NVL(B.VALUE_HAVED_SALE,0)))  / 100000000, 2)
		INTO   V_DT_VALUE
		FROM   SYS_PROJECT A
		INNER  JOIN DWM_DT_VALUE B
		ON     A.ID = B.OBJ_ID AND
					 B.OBJ_TYPE = '项目';*/
      SELECT ROUND(SUM(a.target_worth)/10000,2) 
           INTO V_KY_TARGET_VALUE 
      FROM dwm_target_worth a
      WHERE ID IN (SELECT t1.A1_可研版目标货值ID  FROM v_dwm_target_worth_idlist t1)
      ;
      SELECT ROUND(SUM(a.target_worth)/10000,2) 
             INTO V_QP_TARGET_VALUE 
      FROM dwm_target_worth a
      WHERE ID IN (SELECT t1.A2_全盘版目标货值ID  
      FROM v_dwm_target_worth_idlist t1)
      ;
      
      SELECT ROUND(SUM(a.target_worth)/10000,2) 
             INTO V_DT_TARGET_VALUE 
      FROM dwm_target_worth a
      WHERE ID IN (SELECT t1.A3_动态版目标货值ID  
      FROM v_dwm_target_worth_idlist t1)
      ;
     SELECT ROUND(SUM(a.target_worth)/10000,2) 
             INTO V_NOW_TARGET_VALUE --V_NEW_TARGET_VALUE 
      FROM dwm_target_worth a
      WHERE ID IN (SELECT t1.A_当前最新版ID  FROM v_dwm_target_worth_idlist t1)
      ;      
      SELECT ROUND(SUM(a.value_dt_all)/100000000,2) 
             INTO V_DT_VALUE 
      FROM dwm_dt_value a
      WHERE a.Obj_Type='项目'
      ;

		OPEN WACTHINFO FOR
				SELECT '可研版目标货值' AS "name", V_KY_TARGET_VALUE AS "total",
							 '#33CCCC' AS "color",'1'
				FROM   DUAL
				UNION
				SELECT '全盘版目标货值' AS "name", V_QP_TARGET_VALUE AS "total",
							 '#33CCCC' AS "color",'2'
				FROM   DUAL
				UNION
				SELECT '动态版目标货值' AS "name", V_DT_TARGET_VALUE AS "total",
							 '#33CCCC' AS "color",'3'
				FROM   DUAL
        UNION
        SELECT '最新版目标货值' AS "name", V_NOW_TARGET_VALUE AS "total",
               '#00b2df' AS "color",'4'
        FROM   DUAL
				UNION
				SELECT '动态货值' AS "name", V_DT_VALUE AS "total",
							 '#37cd71' AS "color",'4'
				FROM   DUAL
				ORDER  BY 4 DESC;
		TITLE   := '总货值情况：目标货值 vs 动态货值';
		UNIT    := '亿元';
		BARTYPE := 'column';
END P_DWM_W_TOTAL_WORTH;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_VISUAL_LAYOUT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_W_VISUAL_LAYOUT" 
(
		PROJID     IN VARCHAR2
	 , --项目分期id
		VISUALTYPE IN VARCHAR2
	 , --类别，1：动态货量，2：动态货值
		DATEPOINT  IN DATE
	 , ---数据点,选中时间
		WACTHINFO  OUT SYS_REFCURSOR --监控信息（根据页面图
) AS
		--动态货值-可视化分析
		--作者：陈丽
		--日期：2019/12/07
BEGIN
		IF VISUALTYPE = 2 THEN
		
				OPEN WACTHINFO FOR
						WITH TMP_PROJ_VALUE(ORG_ID,
						ORGNAME,
						PARENT_ID,
						ORDER_HIERARCHY_CODE,
						ZZ_VALUE_ALLOW_SALE,
						CW_VALUE_ALLOW_SALE,
						SY_VALUE_ALLOW_SALE,
						VALUE_NOT_PLANNING_PERMIT,
						VALUE_NOT_CONSTRUCTION_PERMIT,
						VALUE_NOT_SALE_PERMIT,
						VALUE_NOT_COMPLETION,
						VALUE_YES_COMPLETION,
						VALUE_YES_SETTLEMENT,
						ZZ_VALUE_STOCK,
						SY_VALUE_STOCK,
						CW_VALUE_STOCK,
						PROJ_CON,
						ORGTYPE) AS
						 (
							--子集
							SELECT A1.ID AS ORG_ID, A1.PROJECT_NAME AS ORGNAME, A1.UNIT_ID AS PARENT_ID, A1.ORDER_HIERARCHY_CODE, NVL(B1.ZZ_VALUE_ALLOW_SALE, 0) ZZ_VALUE_ALLOW_SALE,
											NVL(B1.CW_VALUE_ALLOW_SALE, 0) CW_VALUE_ALLOW_SALE, NVL(B1.SY_VALUE_ALLOW_SALE, 0) SY_VALUE_ALLOW_SALE, NVL(B1.VALUE_NOT_PLANNING_PERMIT, 0) AS VALUE_NOT_PLANNING_PERMIT,
											NVL(B1.VALUE_NOT_CONSTRUCTION_PERMIT, 0) AS VALUE_NOT_CONSTRUCTION_PERMIT, NVL(B1.VALUE_NOT_SALE_PERMIT, 0) VALUE_NOT_SALE_PERMIT,
											NVL(B1.VALUE_NOT_COMPLETION, 0) AS VALUE_NOT_COMPLETION, NVL(B1.VALUE_YES_COMPLETION, 0) AS VALUE_YES_COMPLETION, NVL(B1.VALUE_YES_SETTLEMENT, 0) AS VALUE_YES_SETTLEMENT,
											NVL(B1.ZZ_VALUE_STOCK, 0) ZZ_VALUE_STOCK, NVL(B1.SY_VALUE_STOCK, 0) SY_VALUE_STOCK, NVL(B1.CW_VALUE_STOCK, 0) CW_VALUE_STOCK, 1 AS PROJ_CON, '1' AS ORGTYPE
							FROM   SYS_PROJECT A1
							INNER  JOIN DWM_DT_VALUE B1
							ON     A1.ID = B1.OBJ_ID AND
										 B1.OBJ_TYPE = '项目'
							--父级
							UNION ALL
							SELECT B2.ID, B2.ORG_NAME, B2.PARENT_ID, B2.ORDER_HIERARCHY_CODE, NVL(A2.ZZ_VALUE_ALLOW_SALE, 0), NVL(A2.CW_VALUE_ALLOW_SALE, 0), NVL(A2.SY_VALUE_ALLOW_SALE, 0),
											NVL(A2.VALUE_NOT_PLANNING_PERMIT, 0) AS VALUE_NOT_PLANNING_PERMIT, NVL(A2.VALUE_NOT_CONSTRUCTION_PERMIT, 0) AS VALUE_NOT_CONSTRUCTION_PERMIT,
											NVL(A2.VALUE_NOT_SALE_PERMIT, 0) VALUE_NOT_SALE_PERMIT, NVL(A2.VALUE_NOT_COMPLETION, 0) AS VALUE_NOT_COMPLETION, NVL(A2.VALUE_YES_COMPLETION, 0) AS VALUE_YES_COMPLETION,
											NVL(A2.VALUE_YES_SETTLEMENT, 0) AS VALUE_YES_SETTLEMENT, NVL(A2.ZZ_VALUE_STOCK, 0), NVL(A2.SY_VALUE_STOCK, 0), NVL(A2.CW_VALUE_STOCK, 0), A2.PROJ_CON, '0' AS ORGTYPE
							FROM   TMP_PROJ_VALUE A2
							INNER  JOIN SYS_BUSINESS_UNIT B2
							ON     A2.PARENT_ID = B2.ID),
						TMP_STOCK_VALUE(ORG_ID,
						ORGNAME,
						PARENTID,
						ORDER_HIERARCHY_CODE,
						ORGTYPE,
						SIX_MONTH_IN,
						SIX_TO_TWELVE_MONTH,
						TWELVE_TO_EIGHTEEN_MONTH,
						EIGHTEEN_MONTH_ABOVE,
						TOTAL) AS
						 (
							--子集
							SELECT A1.ID AS ORG_ID, A1.PROJECT_NAME AS ORGNAME, A1.UNIT_ID AS PARENT_ID, A1.ORDER_HIERARCHY_CODE, '1' AS ORGTYPE,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) <= 5 THEN
																B1.BZ_PRICE * B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS SIX_MONTH_IN,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) BETWEEN 6 AND 12 THEN
																B1.BZ_PRICE * B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS SIX_TO_TWELVE_MONTH,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) BETWEEN 12 AND 18 THEN
																B1.BZ_PRICE * B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS TWELVE_TO_EIGHTEEN_MONTH,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) > 18 OR C1.GET_PRE_SALE_PERMIT_DATE IS NULL THEN
																B1.BZ_PRICE * B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS EIGHTEEN_MONTH_ABOVE, SUM(B1.BZ_PRICE * B1.PRE_BLD_AREA) AS TOTAL
							FROM   SYS_PROJECT A1
							LEFT   JOIN MDM_ROOM B1
							ON     A1.ID = B1.PROJECT_ID AND
										 B1.SALE_STATE <> '签约'
							LEFT   JOIN MDM_BUILD C1
							ON     B1.BUILDING_ID = C1.ID
							GROUP  BY A1.ID, A1.PROJECT_NAME, A1.UNIT_ID, A1.ORDER_HIERARCHY_CODE
							--父级
							UNION ALL
							SELECT B2.ID, B2.ORG_NAME, B2.PARENT_ID, B2.ORDER_HIERARCHY_CODE, '0' AS ORGTYPE, SIX_MONTH_IN, SIX_TO_TWELVE_MONTH, TWELVE_TO_EIGHTEEN_MONTH, EIGHTEEN_MONTH_ABOVE, TOTAL
							FROM   TMP_STOCK_VALUE A2
							INNER  JOIN SYS_BUSINESS_UNIT B2
							ON     A2.PARENTID = B2.ID)
						
						SELECT *
						FROM   (SELECT 1 AS "groupId", '1:各阶段货值分布' AS "groupName", '#4472C4' AS "itemColor", '未取证' AS "itemName", ROUND(P.VALUE_NOT_PLANNING_PERMIT / 100000000, 2) AS "statistics"
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 1 AS "groupId", '1:各阶段货值分布', '#ED7D31' AS "itemColor", '已取规划许可证' AS "itemName", ROUND(P.VALUE_NOT_CONSTRUCTION_PERMIT / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 1 AS "groupId", '1:各阶段货值分布', '#A5A5A5' AS "itemColor", '已取施工许可证' AS "itemName", ROUND(P.VALUE_NOT_SALE_PERMIT / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 1 AS "groupId", '1:各阶段货值分布', '#FFC000' AS "itemColor", '已取预售许可证' AS "itemName", ROUND(P.VALUE_NOT_COMPLETION / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 1 AS "groupId", '1:各阶段货值分布', '#5B9BD5' AS "itemColor", '已取竣工备案证' AS "itemName", ROUND(P.VALUE_YES_COMPLETION / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 1 AS "groupId", '1:各阶段货值分布', '#00CED1' AS "itemColor", '已结转' AS "itemName", ROUND(P.VALUE_YES_SETTLEMENT / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 2, '2:各业态货值分布', '#5B9BD5', '住宅', ROUND(P.ZZ_VALUE_ALLOW_SALE / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 2, '2:各业态货值分布', '#4472C4', '车位', ROUND(P.CW_VALUE_ALLOW_SALE / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 2, '2:各业态货值分布', '#FFC000', '商业', ROUND(P.SY_VALUE_ALLOW_SALE / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 3, '3:已推未售货值分布', '#5B9BD5', '住宅', ROUND(P.ZZ_VALUE_STOCK / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 3, '3:已推未售货值分布', '#FFC000', '商业', ROUND(P.SY_VALUE_STOCK / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 3, '3:已推未售货值分布', '#4472C4', '车位', ROUND(P.CW_VALUE_STOCK / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 4, '4:库存货龄分布', '#4472C4', '6个月以内', ROUND(SUM(P.SIX_MONTH_IN) / 100000000, 2)
										 FROM   TMP_STOCK_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 4, '4:库存货龄分布', '#FFC000', '6-12个月', ROUND(SUM(P.SIX_TO_TWELVE_MONTH) / 100000000, 2)
										 FROM   TMP_STOCK_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 4, '4:库存货龄分布', '#5B9BD5', '12-18个月', ROUND(SUM(P.TWELVE_TO_EIGHTEEN_MONTH) / 100000000, 2)
										 FROM   TMP_STOCK_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 4, '4:库存货龄分布', '#A5A5A5', '18个月以上', ROUND(SUM(P.EIGHTEEN_MONTH_ABOVE) / 100000000, 2)
										 FROM   TMP_STOCK_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 
										 ) M
						WHERE  m."statistics" <> 0;
		
		END IF;

		IF VISUALTYPE = 1 THEN
				--- 货量
				OPEN WACTHINFO FOR
						WITH TMP_PROJ_AREA(ORG_ID,
						ORGNAME,
						PARENT_ID,
						ORDER_HIERARCHY_CODE,
						ZZ_AREA_ALLOW_SALE,
						CW_AREA_ALLOW_SALE,
						SY_AREA_ALLOW_SALE,
						AREA_NOT_PLANNING_PERMIT,
						AREA_NOT_CONSTRUCTION_PERMIT,
						AREA_NOT_SALE_PERMIT,
						AREA_NOT_COMPLETION,
						AREA_YES_COMPLETION,
						AREA_YES_SETTLEMENT,
						ZZ_AREA_STOCK,
						SY_AREA_STOCK,
						CW_AREA_STOCK,
						PROJ_CON,
						ORGTYPE) AS
						 (
							--子集
							SELECT A1.ID AS ORG_ID, A1.PROJECT_NAME AS ORGNAME, A1.UNIT_ID AS PARENT_ID, A1.ORDER_HIERARCHY_CODE, NVL(B1.ZZ_AREA_ALLOW_SALE, 0) ZZ_AREA_ALLOW_SALE,
											NVL(B1.CW_AREA_ALLOW_SALE, 0) CW_AREA_ALLOW_SALE, NVL(B1.SY_AREA_ALLOW_SALE, 0) SY_AREA_ALLOW_SALE,
											NVL(B1.ZZ_AREA_NOT_PLANNING_PERMIT, 0) + NVL(B1.SY_AREA_NOT_PLANNING_PERMIT, 0) AS AREA_NOT_PLANNING_PERMIT,
											NVL(B1.ZZ_AREA_NOT_CONSTRUCTION_PER, 0) + NVL(B1.SY_AREA_NOT_CONSTRUCTION_PER, 0) AS AREA_NOT_CONSTRUCTION_PERMIT,
											NVL(B1.ZZ_AREA_NOT_SALE_PERMIT, 0) + NVL(B1.SY_AREA_NOT_SALE_PERMIT, 0) AREA_NOT_SALE_PERMIT,
											NVL(B1.ZZ_AREA_NOT_COMPLETION, 0) + NVL(B1.SY_AREA_NOT_COMPLETION, 0) AS AREA_NOT_COMPLETION,
											NVL(B1.ZZ_AREA_YES_COMPLETION, 0) + NVL(B1.SY_AREA_YES_COMPLETION, 0) AS AREA_YES_COMPLETION,
											NVL(B1.ZZ_AREA_YES_SETTLEMENT, 0) + NVL(B1.SY_AREA_YES_SETTLEMENT, 0) AS AREA_YES_SETTLEMENT, NVL(B1.ZZ_AREA_STOCK, 0) ZZ_AREA_STOCK, NVL(B1.SY_AREA_STOCK, 0) SY_AREA_STOCK,
											NVL(B1.CW_AREA_STOCK, 0) CW_AREA_STOCK, 1 AS PROJ_CON, '1' AS ORGTYPE
							FROM   SYS_PROJECT A1
							INNER  JOIN DWM_DT_VALUE B1
							ON     A1.ID = B1.OBJ_ID AND
										 B1.OBJ_TYPE = '项目'
							--父级
							UNION ALL
							SELECT B2.ID, B2.ORG_NAME, B2.PARENT_ID, B2.ORDER_HIERARCHY_CODE, NVL(A2.ZZ_AREA_ALLOW_SALE, 0), NVL(A2.CW_AREA_ALLOW_SALE, 0), NVL(A2.SY_AREA_ALLOW_SALE, 0),
											NVL(A2.AREA_NOT_PLANNING_PERMIT, 0) AS AREA_NOT_PLANNING_PERMIT, NVL(A2.AREA_NOT_CONSTRUCTION_PERMIT, 0) AS AREA_NOT_CONSTRUCTION_PERMIT,
											NVL(A2.AREA_NOT_SALE_PERMIT, 0) AREA_NOT_SALE_PERMIT, NVL(A2.AREA_NOT_COMPLETION, 0) AS AREA_NOT_COMPLETION, NVL(A2.AREA_YES_COMPLETION, 0) AS AREA_YES_COMPLETION,
											NVL(A2.AREA_YES_SETTLEMENT, 0) AS AREA_YES_SETTLEMENT, NVL(A2.ZZ_AREA_STOCK, 0), NVL(A2.SY_AREA_STOCK, 0), NVL(A2.CW_AREA_STOCK, 0), A2.PROJ_CON, '0' AS ORGTYPE
							FROM   TMP_PROJ_AREA A2
							INNER  JOIN SYS_BUSINESS_UNIT B2
							ON     A2.PARENT_ID = B2.ID),
						
						--库存
						TMP_STOCK_VALUE(ORG_ID,
						ORGNAME,
						PARENTID,
						ORDER_HIERARCHY_CODE,
						ORGTYPE,
						SIX_MONTH_IN,
						SIX_TO_TWELVE_MONTH,
						TWELVE_TO_EIGHTEEN_MONTH,
						EIGHTEEN_MONTH_ABOVE,
						TOTAL) AS
						 (
							--子集
							SELECT A1.ID AS ORG_ID, A1.PROJECT_NAME AS ORGNAME, A1.UNIT_ID AS PARENT_ID, A1.ORDER_HIERARCHY_CODE, '1' AS ORGTYPE,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) <= 5 THEN
																B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS SIX_MONTH_IN,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) BETWEEN 6 AND 12 THEN
																B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS SIX_TO_TWELVE_MONTH,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) BETWEEN 12 AND 18 THEN
																B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS TWELVE_TO_EIGHTEEN_MONTH,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) > 18 OR C1.GET_PRE_SALE_PERMIT_DATE IS NULL THEN
																B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS EIGHTEEN_MONTH_ABOVE, SUM( B1.PRE_BLD_AREA) AS TOTAL
							FROM   SYS_PROJECT A1
							LEFT   JOIN MDM_ROOM B1
							ON     A1.ID = B1.PROJECT_ID AND
										 B1.SALE_STATE <> '签约'
							LEFT   JOIN MDM_BUILD C1
							ON     B1.BUILDING_ID = C1.ID
							GROUP  BY A1.ID, A1.PROJECT_NAME, A1.UNIT_ID, A1.ORDER_HIERARCHY_CODE
							--父级
							UNION ALL
							SELECT B2.ID, B2.ORG_NAME, B2.PARENT_ID, B2.ORDER_HIERARCHY_CODE, '0' AS ORGTYPE, SIX_MONTH_IN, SIX_TO_TWELVE_MONTH, TWELVE_TO_EIGHTEEN_MONTH, EIGHTEEN_MONTH_ABOVE, TOTAL
							FROM   TMP_STOCK_VALUE A2
							INNER  JOIN SYS_BUSINESS_UNIT B2
							ON     A2.PARENTID = B2.ID)
						
						SELECT *
						FROM   (SELECT 11 AS "groupId", '1:各阶段货量分布' AS "groupName", '#4472C4' AS "itemColor", '未取证' AS "itemName", P.AREA_NOT_PLANNING_PERMIT AS "statistics"
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 11 AS "groupId", '1:各阶段货量分布', '#ED7D31' AS "itemColor", '已取规划许可证' AS "itemName", P.AREA_NOT_CONSTRUCTION_PERMIT
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 11 AS "groupId", '1:各阶段货量分布', '#A5A5A5' AS "itemColor", '已取施工许可证' AS "itemName", P.AREA_NOT_SALE_PERMIT
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 11 AS "groupId", '1:各阶段货量分布', '#FFC000' AS "itemColor", '已取预售许可证' AS "itemName", P.AREA_NOT_COMPLETION
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 11 AS "groupId", '1:各阶段货量分布', '#5B9BD5' AS "itemColor", '已取竣工备案证' AS "itemName", P.AREA_YES_COMPLETION
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 11 AS "groupId", '1:各阶段货量分布', '#00CED1' AS "itemColor", '已结转' AS "itemName", P.AREA_YES_SETTLEMENT
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 12, '2:各业态货量分布', '#5B9BD5', '住宅', P.ZZ_AREA_ALLOW_SALE
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										  UNION ALL
                     SELECT 12, '2:各业态货量分布', '#4472C4', '车位', P.CW_AREA_ALLOW_SALE
                     FROM   TMP_PROJ_AREA P
                     WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 12, '2:各业态货量分布', '#FFC000', '商业', P.SY_AREA_ALLOW_SALE
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 13, '3:已推未售货量分布', '#5B9BD5', '住宅', P.ZZ_AREA_STOCK
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 13, '3:已推未售货量分布', '#FFC000', '商业', P.SY_AREA_STOCK
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
                     SELECT 13, '3:已推未售货量分布', '#4472C4', '车位', p.CW_AREA_STOCK
                     FROM   TMP_PROJ_AREA P
                     WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 14, '4:库存货龄分布', '#4472C4', '6个月以内', SUM(P.SIX_MONTH_IN)
										 FROM   TMP_STOCK_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 14, '4:库存货龄分布', '#FFC000', '6-12个月', SUM(P.SIX_TO_TWELVE_MONTH)
										 FROM   TMP_STOCK_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 14, '4:库存货龄分布', '#5B9BD5', '12-18个月', SUM(P.TWELVE_TO_EIGHTEEN_MONTH) 
										 FROM   TMP_STOCK_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 14, '4:库存货龄分布', '#FA8072', '18个月以上', SUM(P.EIGHTEEN_MONTH_ABOVE) 
										 FROM   TMP_STOCK_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 
										 ) M
						WHERE  m."statistics" <> 0;
				
		
		END IF;

END P_DWM_W_VISUAL_LAYOUT;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_WORTH_BIG_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_W_WORTH_BIG_DATA" 
(
		ORGID        IN VARCHAR2
	 ,ORGTYPE      IN VARCHAR2
	 ,TARGETWORTH  OUT SYS_REFCURSOR
	 ,DYNAMICWORTH OUT SYS_REFCURSOR
	 ,DESCRIPTION  OUT CLOB
) AS
		--动态货值监控-tab货值大数据
		--作者：陈丽
		--修改者：谢松宏
		--日期：2020-03-31
		V_DT_VALUE_ALL      NUMBER(18, 2); --动态总货值
		V_DT_SYHZ_VALUE_ALL NUMBER(18, 2); --剩余货值
		V_DT_YSHZ_VALUE     NUMBER(18, 2); --已售货值
		V_DT_CBHZ_VALUE     NUMBER(18, 2); --储备货值
		V_DT_ZTHZ_VALUE     NUMBER(18, 2); --在途货值
		V_DT_YQZHZ_VALUE    NUMBER(18, 2); --已取证货值
		V_DT_KCHZ_VALUE     NUMBER(18, 2); --库存货值
		V_DT_WQGZHZ_VALUE   NUMBER(18, 2); --未取规证货值
		V_DT_GHXKZHZ_VALUE  NUMBER(18, 2); --规划许可证货值
		V_DT_SGXKZHZ_VALUE  NUMBER(18, 2); --施工许可证货值
		V_DT_YSXKZHZ_VALUE  NUMBER(18, 2); --预售许可证货值
		V_DT_JGBAHZ_VALUE   NUMBER(18, 2); --竣工备案货值
		V_DT_JZHZ_VALUE     NUMBER(18, 2); --结转货值
BEGIN
		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_DT_ALL) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), 0) + NVL((SELECT ROUND(P.VALUE_DT_ALL / 100000000, 2)
																																	 FROM   DWM_DT_VALUE P
																																	 WHERE  P.OBJ_ID = AA.ID AND
																																					P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_VALUE_ALL
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_REMAIN) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), 0) + NVL((SELECT ROUND(P.VALUE_REMAIN / 100000000, 2)
																																	 FROM   DWM_DT_VALUE P
																																	 WHERE  P.OBJ_ID = AA.ID AND
																																					P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_SYHZ_VALUE_ALL
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_REMAIN) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), 0) + NVL((SELECT ROUND(P.VALUE_REMAIN / 100000000, 2)
																																	 FROM   DWM_DT_VALUE P
																																	 WHERE  P.OBJ_ID = AA.ID AND
																																					P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_SYHZ_VALUE_ALL
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_HAVED_SALE) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), 0) + NVL((SELECT ROUND(P.VALUE_HAVED_SALE / 100000000, 2)
																																	 FROM   DWM_DT_VALUE P
																																	 WHERE  P.OBJ_ID = AA.ID AND
																																					P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_YSHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_RESERVE) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), 0) + NVL((SELECT ROUND(P.VALUE_RESERVE / 100000000, 2)
																																	 FROM   DWM_DT_VALUE P
																																	 WHERE  P.OBJ_ID = AA.ID AND
																																					P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_CBHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_IN_PROCESS) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), 0) + NVL((SELECT ROUND(P.VALUE_IN_PROCESS / 100000000, 2)
																																	 FROM   DWM_DT_VALUE P
																																	 WHERE  P.OBJ_ID = AA.ID AND
																																					P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_ZTHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_STOCK) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), 0) + NVL((SELECT ROUND(P.VALUE_STOCK / 100000000, 2)
																																	 FROM   DWM_DT_VALUE P
																																	 WHERE  P.OBJ_ID = AA.ID AND
																																					P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_YQZHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_NOT_CONSTRUCTION_PERMIT) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), 0) + NVL((SELECT ROUND(P.VALUE_NOT_CONSTRUCTION_PERMIT / 100000000, 2)
																																	 FROM   DWM_DT_VALUE P
																																	 WHERE  P.OBJ_ID = AA.ID AND
																																					P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_GHXKZHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_STOCK) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), 0) + NVL((SELECT ROUND(P.VALUE_STOCK / 100000000, 2)
																																	 FROM   DWM_DT_VALUE P
																																	 WHERE  P.OBJ_ID = AA.ID AND
																																					P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_KCHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		V_DT_YQZHZ_VALUE := V_DT_YSHZ_VALUE + V_DT_KCHZ_VALUE;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_NOT_PLANNING_PERMIT) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), 0) + NVL((SELECT ROUND(P.VALUE_NOT_PLANNING_PERMIT / 100000000, 2)
																																	 FROM   DWM_DT_VALUE P
																																	 WHERE  P.OBJ_ID = AA.ID AND
																																					P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_WQGZHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_NOT_SALE_PERMIT) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), 0) + NVL((SELECT ROUND(P.VALUE_NOT_SALE_PERMIT / 100000000, 2)
																																	 FROM   DWM_DT_VALUE P
																																	 WHERE  P.OBJ_ID = AA.ID AND
																																					P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_SGXKZHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_NOT_COMPLETION) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), 0) + NVL((SELECT ROUND(P.VALUE_NOT_COMPLETION / 100000000, 2)
																																	 FROM   DWM_DT_VALUE P
																																	 WHERE  P.OBJ_ID = AA.ID AND
																																					P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_YSXKZHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_YES_COMPLETION) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), 0) + NVL((SELECT ROUND(P.VALUE_YES_COMPLETION / 100000000, 2)
																																	 FROM   DWM_DT_VALUE P
																																	 WHERE  P.OBJ_ID = AA.ID AND
																																					P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_JGBAHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_YES_SETTLEMENT) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), 0) + NVL((SELECT ROUND(P.VALUE_YES_SETTLEMENT / 100000000, 2)
																																	 FROM   DWM_DT_VALUE P
																																	 WHERE  P.OBJ_ID = AA.ID AND
																																					P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_JZHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		OPEN TARGETWORTH FOR
				SELECT '10' AS "minPercentage", RESULT.*
				FROM   (SELECT '目标总货值' AS "id", NULL AS "parentsId", '目标总货值' AS "name", NULL AS "value", '#009900' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
								 FROM   SYS_BUSINESS_UNIT AA
								 WHERE  AA.IS_COMPANY = 1 AND
												AA.ID = '003200000000000000000000000000'
								 UNION ALL
								 SELECT AA.ID AS "id", '目标总货值' AS "parentsId", 'A1可研版目标货值' AS "name",
												NVL((SELECT ROUND(SUM(DDV.TARGET_A1_VALUE) / 10000, 2)
														 FROM   SYS_BUSINESS_UNIT SBU
														 LEFT   JOIN SYS_PROJECT SP
														 ON     SBU.ID = SP.UNIT_ID
														 LEFT   JOIN DWM_DT_VALUE DDV
														 ON     DDV.OBJ_ID = SP.ID
														 WHERE  SBU.IS_COMPANY = 1
														 START  WITH SBU.ID = AA.ID
														 CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), 0) + NVL((SELECT ROUND(P.TARGET_A1_VALUE / 10000, 2)
																																								FROM   DWM_DT_VALUE P
																																								WHERE  P.OBJ_ID = AA.ID AND
																																											 P.OBJ_TYPE = '项目'), 0) AS "value", '#009900' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor",
												0 "isNesting", 0 "layout"
								 FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
								 WHERE  AA.ID = ORGID
								 UNION ALL
								 SELECT AA.ID, '目标总货值', 'A2全盘版目标货值',
												NVL((SELECT ROUND(SUM(DDV.TARGET_A2_VALUE) / 10000, 2)
														 FROM   SYS_BUSINESS_UNIT SBU
														 LEFT   JOIN SYS_PROJECT SP
														 ON     SBU.ID = SP.UNIT_ID
														 LEFT   JOIN DWM_DT_VALUE DDV
														 ON     DDV.OBJ_ID = SP.ID
														 WHERE  SBU.IS_COMPANY = 1
														 START  WITH SBU.ID = AA.ID
														 CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), 0) + NVL((SELECT ROUND(P.TARGET_A2_VALUE / 10000, 2)
																																								FROM   DWM_DT_VALUE P
																																								WHERE  P.OBJ_ID = AA.ID AND
																																											 P.OBJ_TYPE = '项目'), 0), '#009900' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting",
												0 "layout"
								 FROM   ((SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP)) AA
								 WHERE  AA.ID = ORGID
								 UNION ALL
								 SELECT AA.ID, '目标总货值', 'A3动态版目标货值',
												NVL((SELECT ROUND(SUM(DDV.TARGET_A3_VALUE) / 10000, 2)
														 FROM   SYS_BUSINESS_UNIT SBU
														 LEFT   JOIN SYS_PROJECT SP
														 ON     SBU.ID = SP.UNIT_ID
														 LEFT   JOIN DWM_DT_VALUE DDV
														 ON     DDV.OBJ_ID = SP.ID
														 WHERE  SBU.IS_COMPANY = 1
														 START  WITH SBU.ID = AA.ID
														 CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), 0) + NVL((SELECT ROUND(P.TARGET_A3_VALUE / 10000, 2)
																																								FROM   DWM_DT_VALUE P
																																								WHERE  P.OBJ_ID = AA.ID AND
																																											 P.OBJ_TYPE = '项目'), 0), '#009900' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting",
												0 "layout"
								 FROM   ((SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP)) AA
								 WHERE  AA.ID = ORGID
								 UNION ALL
								 SELECT AA.ID, '目标总货值', '最新版目标货值' AS FLAG,
												NVL((SELECT ROUND(SUM(DDV.TARGET_WORTH) / 10000, 2)
														 FROM   SYS_BUSINESS_UNIT SBU
														 LEFT   JOIN SYS_PROJECT SP
														 ON     SBU.ID = SP.UNIT_ID
														 LEFT   JOIN V_DWM_TARGET_WORTH_NOW DDV
														 ON     DDV.PROJ_ID = SP.ID
														 WHERE  SBU.IS_COMPANY = 1
														 START  WITH SBU.ID = AA.ID
														 CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID), 0) + NVL((SELECT ROUND(P.TARGET_WORTH / 10000, 2) FROM V_DWM_TARGET_WORTH_NOW P WHERE P.PROJ_ID = AA.ID), 0), '#FFA500' AS "color",
												'#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
								 FROM   ((SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP)) AA
								 WHERE  AA.ID = ORGID) RESULT;

		OPEN DYNAMICWORTH FOR
				SELECT '10' AS "minPercentage", "id", "parentsId", "name", "value", "color" AS "color", "bgColor" AS "bgColor", "nameColor" AS "nameColor",
							 CASE "name"
										WHEN '已取证货值' THEN
										 1
										ELSE
										 0
								END AS "isNesting", 0 "layout"
				FROM   (SELECT '动态总货值' AS "id", '' AS "parentsId", '动态总货值' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_VALUE_ALL, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 --- 动态总货值
								 UNION ALL
								 SELECT '0' AS "id", '动态总货值' AS "parentsId", '动态总货值' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_VALUE_ALL, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '1' AS "id", '动态总货值' AS "parentsId", '' AS "name", '#ffffff' AS "color", '#00BFFF' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_VALUE_ALL, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '剩余货值' AS "id", '1' AS "parentsId", '剩余货值' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_SYHZ_VALUE_ALL, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '已售货值（E2）' AS "id", '1' AS "parentsId", '已售货值（E2）' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_YSHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 ------2
								 UNION ALL
								 SELECT '2' AS "id", '动态总货值' AS "parentsId", '' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_VALUE_ALL, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '储备货值（c=b0）' AS "id", '2' AS "parentsId", '储备货值（c=b0）' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_CBHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '在途货值（d）' AS "id", '2' AS "parentsId", '在途货值（d）' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_ZTHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '已取证货值' AS "id", '2' AS "parentsId", '已取证货值' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_YQZHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '库存货值' AS "id", '已取证货值' AS "parentsId", '库存货值' AS "name", '#ffffff' AS "color", '#e46c0a' AS "bgColor", '#666666' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_KCHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '已售货值1' AS "id", '已取证货值' AS "parentsId", '已售货值' AS "name", '#ffffff' AS "color", '#00b050' AS "bgColor", '#d7d7d7' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_YSHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 --------------------3
								 UNION ALL
								 SELECT '3' AS "id", '动态总货值' AS "parentsId", '' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#666666' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_VALUE_ALL, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '未取规证' AS "id", '3' AS "parentsId", '未取规证' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_WQGZHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '规划许可证阶段' AS "id", '3' AS "parentsId", '规划许可证阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor",
												RTRIM(TO_CHAR(NVL(V_DT_GHXKZHZ_VALUE, 0), 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '施工许可证阶段' AS "id", '3' AS "parentsId", '施工许可证阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_SGXKZHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '预售许可证阶段' AS "id", '3' AS "parentsId", '预售许可证阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_YSXKZHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '竣工备案阶段' AS "id", '3' AS "parentsId", '竣工备案阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_JGBAHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '结转阶段' AS "id", '3' AS "parentsId", '结转阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_JZHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL) A;

		DESCRIPTION := '<span style="font-size:14px;color:#333333"><span style="font-weight:bold">最新版目标总货值： </span>若有"动态版目标货值"，则取"动态版目标货值"；若无"动态版目标货值"，则取"全盘版目标货值"；若无"全盘版目标货值"，则取"可研版目标货值。</span></br>
<span style="font-size:14px;color:#333333"><span style="font-weight:bold">动态总货值</span> =剩余货值+已售货值=储备货值+在途货值+库存货值+已售货值。</span></br>
<span style="font-size:14px;color:#333333"><span style="font-weight:bold">剩余货值</span> =储备货值+在途货值+库存货值。</span></br>
<span style="font-size:14px;color:#333333"><span style="font-weight:bold">已售货值：</span> 已拿预售许可证且已签约的货值，取《销售系统》中的签约金额。。</span></br>
<span style="font-size:14px;color:#333333"><span style="font-weight:bold">储备货值(即未取规证货值)： </span>面积取主数据中“未取规证的面积”，价格按业态取最新的目标均价。</span></br>
<span style="font-size:14px;color:#333333"><span style="font-weight:bold">在途货值： </span>面积取主数据中“已取规证未取预售许可证的面积”，价格按业态取最新的目标均价。</span></br>
<span style="font-size:14px;color:#333333"><span style="font-weight:bold">已取证货值： </span>已拿预售许可证货值，包括“未签约、已签约”。</span></br>
<span style="font-size:14px;color:#333333"><span style="font-weight:bold">库存货值： </span>已拿预售许可证但未签约的货值，取《销售系统》中的底价。</span>';
END P_DWM_W_WORTH_BIG_DATA;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_WORTH_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_W_WORTH_DATA" 
(
		ORGID        IN VARCHAR2
	 ,ORGTYPE      IN VARCHAR2
	 ,TARGETWORTH  OUT SYS_REFCURSOR
	 ,DYNAMICWORTH OUT SYS_REFCURSOR
) AS
		--动态货值监控-tab货值大数据
		--作者：陈丽
		--日期：2019/11/13
		V_DT_VALUE_ALL      NUMBER(18, 2); --动态总货值
		V_DT_SYHZ_VALUE_ALL NUMBER(18, 2); --剩余货值
		V_DT_YSHZ_VALUE     NUMBER(18, 2); --已售货值
		V_DT_CBHZ_VALUE     NUMBER(18, 2); --储备货值
		V_DT_ZTHZ_VALUE     NUMBER(18, 2); --在途货值
		V_DT_YQZHZ_VALUE    NUMBER(18, 2); --已取证货值
		V_DT_KCHZ_VALUE     NUMBER(18, 2); --库存货值
		V_DT_WQGZHZ_VALUE   NUMBER(18, 2); --未取规证货值
		V_DT_GHXKZHZ_VALUE  NUMBER(18, 2); --规划许可证货值
		V_DT_SGXKZHZ_VALUE  NUMBER(18, 2); --施工许可证货值
		V_DT_YSXKZHZ_VALUE  NUMBER(18, 2); --预售许可证货值
		V_DT_JGBAHZ_VALUE   NUMBER(18, 2); --竣工备案货值
		V_DT_JZHZ_VALUE     NUMBER(18, 2); --结转货值
BEGIN
		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_DT_ALL) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_DT_ALL/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_VALUE_ALL
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_REMAIN) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_REMAIN/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_SYHZ_VALUE_ALL
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_REMAIN) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_REMAIN/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_SYHZ_VALUE_ALL
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_HAVED_SALE) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_HAVED_SALE/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_YSHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_RESERVE) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_RESERVE/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_CBHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_IN_PROCESS) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_IN_PROCESS/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_ZTHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_STOCK) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_STOCK/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_YQZHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_STOCK) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_STOCK/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_KCHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE 
					 AA.ID = ORGID;

		V_DT_YQZHZ_VALUE := V_DT_YSHZ_VALUE + V_DT_KCHZ_VALUE;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_NOT_PLANNING_PERMIT) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_NOT_PLANNING_PERMIT/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_WQGZHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_NOT_SALE_PERMIT) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_NOT_SALE_PERMIT/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_SGXKZHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_NOT_COMPLETION) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_NOT_COMPLETION/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_YSXKZHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_YES_COMPLETION) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_YES_COMPLETION/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_JGBAHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_YES_SETTLEMENT) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_YES_SETTLEMENT/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_JZHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		OPEN TARGETWORTH FOR
				SELECT '目标总货值' AS "id", NULL AS "parentsId", '目标总货值' AS "name", NULL AS "value", '#009900' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
				FROM   SYS_BUSINESS_UNIT AA
				WHERE  AA.IS_COMPANY = 1 AND
							 AA.ID = '003200000000000000000000000000'
				UNION ALL
				SELECT AA.ID AS "id", '目标总货值' AS "parentsId", 'A1可研版目标货值' AS "name",
							 NVL((SELECT ROUND(SUM(DDV.TARGET_A1_VALUE) / 10000, 2)
								 FROM   SYS_BUSINESS_UNIT SBU
								 LEFT   JOIN SYS_PROJECT SP
								 ON     SBU.ID = SP.UNIT_ID
								 LEFT   JOIN DWM_DT_VALUE DDV
								 ON     DDV.OBJ_ID = SP.ID
								 WHERE  SBU.IS_COMPANY = 1
								 START  WITH SBU.ID = AA.ID
								 CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),0)+NVL((SELECT round(P.TARGET_A1_VALUE/10000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0) AS "value", '#009900' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
				FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
				WHERE  
							 AA.ID = ORGID
				UNION ALL
				SELECT AA.ID, '目标总货值', 'A2全盘版目标货值',
							 NVL((SELECT ROUND(SUM(DDV.TARGET_A2_VALUE) / 10000, 2)
								 FROM   SYS_BUSINESS_UNIT SBU
								 LEFT   JOIN SYS_PROJECT SP
								 ON     SBU.ID = SP.UNIT_ID
								 LEFT   JOIN DWM_DT_VALUE DDV
								 ON     DDV.OBJ_ID = SP.ID
								 WHERE  SBU.IS_COMPANY = 1
								 START  WITH SBU.ID = AA.ID
								 CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),0)+NVL((SELECT round(P.TARGET_A2_VALUE/10000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0), '#009900' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
				FROM   ((SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP)) AA
				WHERE  
							 AA.ID = ORGID
				UNION ALL
				SELECT AA.ID, '目标总货值', 'A3动态版目标货值',
							 NVL((SELECT ROUND(SUM(DDV.TARGET_A3_VALUE) / 10000, 2)
								 FROM   SYS_BUSINESS_UNIT SBU
								 LEFT   JOIN SYS_PROJECT SP
								 ON     SBU.ID = SP.UNIT_ID
								 LEFT   JOIN DWM_DT_VALUE DDV
								 ON     DDV.OBJ_ID = SP.ID
								 WHERE  SBU.IS_COMPANY = 1
								 START  WITH SBU.ID = AA.ID
								 CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),0)+NVL((SELECT round(P.TARGET_A3_VALUE/10000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0), '#009900' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
				FROM   ((SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP)) AA
				WHERE  
							 AA.ID = ORGID
				UNION ALL
				SELECT AA.ID, '目标总货值', '最新版目标货值' AS FLAG,
							 NVL((SELECT ROUND(SUM(DDV.TARGET_WORTH) / 10000, 2)
								 FROM   SYS_BUSINESS_UNIT SBU
								 LEFT   JOIN SYS_PROJECT SP
								 ON     SBU.ID = SP.UNIT_ID
								 LEFT   JOIN V_DWM_TARGET_WORTH_NOW DDV
								 ON     DDV.PROJ_ID = SP.ID
								 WHERE  SBU.IS_COMPANY = 1
								 START  WITH SBU.ID = AA.ID
								 CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),0)+NVL((SELECT round(P.TARGET_WORTH/10000,2)
												 FROM   V_DWM_TARGET_WORTH_NOW P
												 WHERE  P.proj_id = AA.ID ),
												 0), '#FFA500' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
				FROM   ((SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP)) AA
				WHERE 
							 AA.ID = ORGID;

		OPEN DYNAMICWORTH FOR
				SELECT "id", "parentsId", "name", "value", "color" AS "color", "bgColor" AS "bgColor", "nameColor" AS "nameColor",
							 CASE "name"
										WHEN '已取证货值' THEN
										 1
										ELSE
										 0
								END AS "isNesting", 1 "layout"
				FROM   (SELECT '动态总货值' AS "id", '' AS "parentsId", '动态总货值' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_VALUE_ALL AS "value"
								 FROM   DUAL
								 --- 动态总货值
								 UNION ALL
								 SELECT '0' AS "id", '动态总货值' AS "parentsId", '动态总货值' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_VALUE_ALL AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '1' AS "id", '动态总货值' AS "parentsId", '' AS "name", '#ffffff' AS "color", '#00BFFF' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_VALUE_ALL AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '剩余货值' AS "id", '1' AS "parentsId", '剩余货值' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_SYHZ_VALUE_ALL AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '已售货值（E2）' AS "id", '1' AS "parentsId", '已售货值（E2）' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_YSHZ_VALUE AS "value"
								 FROM   DUAL
								 ------2
								 UNION ALL
								 SELECT '2' AS "id", '动态总货值' AS "parentsId", '' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_VALUE_ALL AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '储备货值（c=b0）' AS "id", '2' AS "parentsId", '储备货值（c=b0）' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_CBHZ_VALUE AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '在途货值（d）' AS "id", '2' AS "parentsId", '在途货值（d）' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_ZTHZ_VALUE AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '已取证货值' AS "id", '2' AS "parentsId", '已取证货值' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_YQZHZ_VALUE AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '库存货值' AS "id", '已取证货值' AS "parentsId", '库存货值' AS "name", '#ffffff' AS "color", '#e46c0a' AS "bgColor", '#666666' AS "nameColor", V_DT_KCHZ_VALUE AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '已售货值1' AS "id", '已取证货值' AS "parentsId", '已售货值' AS "name", '#ffffff' AS "color", '#00b050' AS "bgColor", '#d7d7d7' AS "nameColor", V_DT_YSHZ_VALUE AS "value"
								 FROM   DUAL
								 --------------------3
								 UNION ALL
								 SELECT '3' AS "id", '动态总货值' AS "parentsId", '' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#666666' AS "nameColor", V_DT_VALUE_ALL AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '未取规证' AS "id", '3' AS "parentsId", '未取规证' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor", V_DT_WQGZHZ_VALUE AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '规划许可证阶段' AS "id", '3' AS "parentsId", '规划许可证阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor", NVL(V_DT_GHXKZHZ_VALUE, 0) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '施工许可证阶段' AS "id", '3' AS "parentsId", '施工许可证阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor", V_DT_SGXKZHZ_VALUE AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '预售许可证阶段' AS "id", '3' AS "parentsId", '预售许可证阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor", V_DT_YSXKZHZ_VALUE AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '竣工备案阶段' AS "id", '3' AS "parentsId", '竣工备案阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor", V_DT_JGBAHZ_VALUE AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '结转阶段' AS "id", '3' AS "parentsId", '结转阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor", V_DT_JZHZ_VALUE AS "value"
								 FROM   DUAL) A;

END P_DWM_W_WORTH_DATA;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_WORTH_LAYOUT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_W_WORTH_LAYOUT" 
(
    TITLE     OUT VARCHAR2
   ,WACTHINFO OUT SYS_REFCURSOR
) AS
    --动态货值监控-1布局动态
    --作者：陈丽
    --日期：2019/11/13
    V_PROJECT_TOTAL  NUMBER(5, 0) := 20;
    V_CITY_TOTAL     NUMBER(5, 0) := 4;
    V_BUSINESS_TOTAL NUMBER(5, 0) := 3;
    V_REGION_TOTAL   NUMBER(5, 0) := 1;
BEGIN
SELECT COUNT(1) INTO V_PROJECT_TOTAL FROM SYS_PROJECT;

SELECT COUNT(1) INTO V_BUSINESS_TOTAL FROM (SELECT COUNT(*) FROM SYS_PROJECT GROUP BY UNIT_ID);

SELECT COUNT(1)
INTO   V_REGION_TOTAL
FROM   (SELECT DISTINCT (SELECT O.ORG_NAME FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH A.UNIT_ID = O.ID CONNECT BY PRIOR O.PARENT_ID = O.ID) ORG_NAME --,A.ID,A.PROJECT_NAME
         FROM   SYS_PROJECT A);

SELECT COUNT(1) INTO V_CITY_TOTAL FROM (SELECT COUNT(1) FROM SYS_PROJECT GROUP BY CITY_NAME);

OPEN WACTHINFO FOR
    SELECT '区域总数' AS "name", V_REGION_TOTAL AS "value", '/dwm/icon/区域总数@1x.png' AS "icon"
    FROM   DUAL
    UNION
    SELECT '事业部总数' AS "name", V_BUSINESS_TOTAL AS "value", '/dwm/icon/事业部总数@1x.png' AS "icon"
    FROM   DUAL
    UNION
    SELECT '城市总数' AS "name", V_CITY_TOTAL AS "value", '/dwm/icon/城市总数@1x.png' AS "icon"
    FROM   DUAL
    UNION
    SELECT '项目总数' AS "name", V_PROJECT_TOTAL AS "value", '/dwm/icon/项目总数@1x.png' AS "icon"
    FROM   DUAL;
TITLE := '布局动态';
END P_DWM_W_WORTH_LAYOUT;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_W_WORTH_PHASE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_W_WORTH_PHASE" 
(
		TITLE     OUT VARCHAR2
	 ,MOREURL   OUT VARCHAR2
	 ,WACTHINFO OUT SYS_REFCURSOR
) AS
		--动态货值监控-3动态货值所处阶段
		--作者：陈丽
		--日期：2019/11/13
BEGIN
		OPEN WACTHINFO FOR
    SELECT * FROM (
				SELECT ' 未取规证' AS "NAME", 'B0' AS TOPLEFTCORNER,
							 '#C8CFD8' AS "color", '可售面积' AS TOTALNAME,
							 ROUND(SUM(NVL(A.AREA_NOT_PLANNING_PERMIT,0)) / 10000, 2) AS TOTALVALUE,
							 '万方' AS UNIT, 1 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT ' 未取规证' AS "NAME", 'B0' AS TOPLEFTCORNER,
							 '#C8CFD8' AS "color", '可售车位' AS TOTALNAME,
							 SUM(NVL(A.Cw_Area_Not_Planning_Permit,0)) AS TOTALVALUE,
                '个' AS UNIT,
							 2 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
        SELECT ' 未取规证' AS "NAME", 'B0' AS TOPLEFTCORNER,
               '#C8CFD8' AS "color", '可售货值' AS TOTALNAME,
               ROUND(SUM(NVL(A.VALUE_NOT_PLANNING_PERMIT,0)) / 100000000, 2) AS TOTALVALUE,
               '亿元' AS UNIT, 3 AS ORDER_CODE
        FROM   DWM_DT_VALUE A
        WHERE  A.OBJ_TYPE = '项目'
        UNION ALL

				SELECT '已取规证未取施证' AS "NAME", 'B1' AS TOPLEFTCORNER,
							 '#1D88C0' AS "color", '可售面积' AS TOTALNAME,
							 ROUND(SUM(NVL(A.AREA_NOT_CONSTRUCTION_PERMIT,0)) / 10000, 2) AS TOTALVALUE,
							 '万方' AS UNIT, 1 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已取规证未取施证' AS "NAME", 'B1' AS TOPLEFTCORNER,
							 '#1D88C0' AS "color", '可售车位' AS TOTALNAME,
							 trunc(SUM(NVL(A.CW_AREA_NOT_CONSTRUCTION_PER,0))) AS TOTALVALUE,
							 '个' AS UNIT, 2 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
        SELECT '已取规证未取施证' AS "NAME", 'B1' AS TOPLEFTCORNER,
               '#1D88C0' AS "color", '可售货值' AS TOTALNAME,
               ROUND(SUM(NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT,0)) / 100000000, 2) AS TOTALVALUE,
               '亿元' AS UNIT, 3 AS ORDER_CODE
        FROM   DWM_DT_VALUE A
        WHERE  A.OBJ_TYPE = '项目'
        UNION ALL
				SELECT '已取施证未取预售证' AS "NAME", 'B2' AS TOPLEFTCORNER,
							 '#1D88C0' AS "color", '可售货值' AS TOTALNAME,
							 ROUND(SUM(NVL(A.VALUE_NOT_SALE_PERMIT,0)) / 100000000, 2) AS TOTALVALUE,
							 '亿元' AS UNIT, 3 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已取施证未取预售证' AS "NAME", 'B2' AS TOPLEFTCORNER,
							 '#1D88C0' AS "color", '可售面积' AS TOTALNAME,
							 ROUND(SUM(NVL(A.AREA_NOT_SALE_PERMIT,0)) / 10000, 2) AS TOTALVALUE,
							 '万方' AS UNIT, 1 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已取施证未取预售证' AS "NAME", 'B2' AS TOPLEFTCORNER,
							 '#1D88C0' AS "color", '可售车位' AS TOTALNAME,
							 SUM(NVL(A.CW_AREA_NOT_SALE_PERMIT,0)) AS TOTALVALUE,
                '个' AS UNIT,
							 2 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已取预售证未售' AS "NAME", 'B3' AS TOPLEFTCORNER,
							 '#E68CB2' AS "color", '可售货值' AS TOTALNAME,
							 ROUND(SUM(NVL(A.VALUE_STOCK,0)) / 100000000, 2) AS TOTALVALUE,
							 '亿元' AS UNIT, 3 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已取预售证未售' AS "NAME", 'B3' AS TOPLEFTCORNER,
							 '#E68CB2' AS "color", '可售面积' AS TOTALNAME,
							 ROUND(SUM(NVL(A.AREA_STOCK,0)) / 10000, 2) AS TOTALVALUE,
							 '万方' AS UNIT, 1 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已取预售证未售' AS "NAME", 'B3' AS TOPLEFTCORNER,
							 '#E68CB2' AS "color", '可售车位' AS TOTALNAME,
							 SUM(NVL(A.CW_AREA_STOCK,0)) AS TOTALVALUE,
                '个' AS UNIT,
							 2 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
        UNION ALL
        SELECT ' 已售未竣备' AS "NAME", 'B4' AS TOPLEFTCORNER,
               '#00CC66' AS "color", '可售货值' AS TOTALNAME,
               ROUND((SUM(NVL(A.VALUE_NOT_COMPLETION,0))) / 100000000, 2) AS TOTALVALUE,
               '亿元' AS UNIT, 3 AS ORDER_CODE
        FROM   DWM_DT_VALUE A
        WHERE  A.OBJ_TYPE = '项目'
        UNION ALL
        SELECT ' 已售未竣备' AS "NAME", 'B4' AS TOPLEFTCORNER,
               '#00CC66' AS "color", '可售面积' AS TOTALNAME,
               ROUND((SUM(NVL(A.AREA_NOT_COMPLETION,0))) / 10000, 2) AS TOTALVALUE,
               '万方' AS UNIT, 1 AS ORDER_CODE
        FROM   DWM_DT_VALUE A
        WHERE  A.OBJ_TYPE = '项目'
        UNION ALL
        SELECT ' 已售未竣备' AS "NAME", 'B4' AS TOPLEFTCORNER,
               '#00CC66' AS "color", '可售车位' AS TOTALNAME,
               SUM(NVL(A.CW_AREA_NOT_COMPLETION,0)) AS TOTALVALUE,
                '个' AS UNIT,
               2 AS ORDER_CODE
        FROM   DWM_DT_VALUE A
        WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已售已竣备' AS "NAME", 'B5' AS TOPLEFTCORNER,
							 '#00CC66' AS "color", '可售货值' AS TOTALNAME,
							 ROUND(SUM(NVL(A.VALUE_YES_COMPLETION,0)) / 100000000, 2) AS TOTALVALUE,
							 '亿元' AS UNIT, 3 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已售已竣备' AS "NAME", 'B5' AS TOPLEFTCORNER,
							 '#00CC66' AS "color", '可售面积' AS TOTALNAME,
							 ROUND(SUM(NVL(A.AREA_YES_COMPLETION,0)) / 10000, 2) AS TOTALVALUE,
							 '万方' AS UNIT, 1 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已售已竣备' AS "NAME", 'B5' AS TOPLEFTCORNER,
							 '#00CC66' AS "color", '可售车位' AS TOTALNAME,
							 SUM(NVL(A.CW_AREA_YES_COMPLETION,0)) AS TOTALVALUE,
                '个' AS UNIT,
							 2 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
/*				UNION ALL
				SELECT '结转阶段' AS "NAME", '05' AS TOPLEFTCORNER, '#37cd69' AS "color",
							 '可售货值' AS TOTALNAME,
							 ROUND(SUM(A.VALUE_YES_SETTLEMENT) / 100000000, 2) AS TOTALVALUE,
							 '亿元' AS UNIT, 3 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '结转阶段' AS "NAME", '05' AS TOPLEFTCORNER, '#37cd69' AS "color",
							 '可售面积' AS TOTALNAME,
							 ROUND(SUM(A.AREA_YES_SETTLEMENT) / 100000000, 2) AS TOTALVALUE,
							 '万方' AS UNIT, 1 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '结转阶段' AS "NAME", '05' AS TOPLEFTCORNER, '#37cd69' AS "color",
							 '可售车位' AS TOTALNAME,
							 SUM(A.CW_AREA_YES_SETTLEMENT) AS TOTALVALUE, '个' AS UNIT,
							 2 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'*/
        ) t
        ORDER  BY TOPLEFTCORNER,ORDER_CODE
        ;

		MOREURL := '';

		TITLE := '动态货值阶段分布';
END P_DWM_W_WORTH_PHASE;

/
--------------------------------------------------------
--  DDL for Procedure P_DWM_云徙联合项目组
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_DWM_云徙联合项目组" 
(
INFO OUT SYS_REFCURSOR
) AS
BEGIN

   OPEN INFO FOR 
      WITH basedata AS(
    ---末级业态，关联得到顶级业态。及末级业态所属对象关联(楼栋/项目/分期)
    select 
    proj.id  as 项目id
    ,proj.PROJECT_NAME as 项目名称
    ,w.TARGET_WORTH_PHASE as 阶段类型
    ,case when proj_stage.id is null then build_proj_stage.id else proj_stage.id end as 分期id
    ,case when proj_stage.id is null then build_proj_stage.STAGE_NAME else proj_stage.STAGE_NAME end as 分期名称
    ,build.id as 楼栋id
    ,build.BUILD_NAME as 楼栋名称
    ,objtype.OBJ_TYPE as 业态对象父级类型
    ,dtl.obj_id||GET_UUID() as 末级业态id
    ,dtl.obj_name as 末级业态全路径
    ,dtl.TOTAL_SALES_AREA as 总可售面积
    ,dtl.WORTH as 总货值
    ,product_type.id as 顶级业态id
    ,product_type.product_type_short_name as 顶级业态
    ,dtl.obj_parent_id as 业态对象父级id
    from (select * from DWM_TARGET_WORTH_DTL where OBJ_TYPE=40) dtl
    --关联业态 找到业态顶级
    left join MDM_BUILD_PRODUCT_TYPE PRODUCT_TYPE 
    on substr(dtl.obj_name,1,instr(dtl.obj_name,'/',1,1)-1)=PRODUCT_TYPE.product_type_name
    --关联自身找到业态的父级对象 类型
    left join DWM_TARGET_WORTH_DTL objtype on dtl.obj_parent_id=objtype.obj_id
    --关联主表建立用于与项目建立关联
    left join DWM_TARGET_WORTH w on dtl.TARGET_WORTH_ID=w.id
    --关联项目获得项目id
    left join sys_project proj on w.PROJ_ID=proj.id
    --关联楼栋获取业态的父级对象为楼栋的楼栋数据
    left join mdm_build build on dtl.obj_parent_id=build.id
    left join SYS_PROJECT_STAGE build_proj_stage on build.PERIOD_ID=build_proj_stage.id
    --关联分期获取业态的父级对象为分期的分期数据
    left join SYS_PROJECT_STAGE proj_stage on dtl.obj_parent_id=proj_stage.id
    --只获取已审核的目标货值
    where w.APPROVAL_STATUS='已审核' and w.is_delete=0
    order by objtype.OBJ_TYPE )

   ,可研 as(
    --可研:项目-业态顶级-末级业态 
    select ID,NAME,PARENT_ID,0 as 套,0 as 面积,0 as 金额,0 as 均价  from (
    select id||'|可研' id,project_name name,'可研' PARENT_ID  from SYS_PROJECT
    union all
    --业态顶级id：项目id|分期id|业态顶级id
    select proj.id||'|'||PRODUCT_TYPE.id as  id
    ,proj.project_NAME||'-'||PRODUCT_TYPE.PRODUCT_TYPE_NAME as name
    ,proj.ID||'|可研' as parent_id 
    from  SYS_PROJECT proj cross join (select * from
    MDM_BUILD_PRODUCT_TYPE where product_type_level=1) PRODUCT_TYPE)  
    union all 
    select 项目id||'|'||顶级业态id||'|'||末级业态id as id
    ,末级业态全路径
    ,项目id||'|'||顶级业态id as parent_id
    ,0 as 套
    ,总可售面积 as 面积
    ,总货值 as 金额
    ,0 as 均价 from basedata 
    where 阶段类型=0)

    ,全盘 as(
    --全盘:项目-分期-业态顶级-末级业态 
    select ID,NAME,PARENT_ID,0 as 套,10 as 面积,0 as 金额,0 as 均价  from (
    select id||'|全盘' as id,project_name name,'全盘' PARENT_ID  from SYS_PROJECT
    union all
    select proj_stage.PROJECT_ID||'|'||proj_stage.id  as Id
    ,proj_stage.STAGE_FULL_NAME as NAME
    ,proj_stage.PROJECT_ID||'|全盘' as PARENT_ID
    from SYS_PROJECT_STAGE PROJ_STAGE
    union all
    --业态顶级id：项目id|分期id|业态顶级id
    select proj_stage.PROJECT_ID||'|'||proj_stage.id||'|'||PRODUCT_TYPE.id as  id
    ,proj_stage.STAGE_FULL_NAME||'-'||PRODUCT_TYPE.PRODUCT_TYPE_NAME as name
    ,proj_stage.PROJECT_ID||'|'||proj_stage.id as parent_id 
    from  SYS_PROJECT_STAGE proj_stage cross join (select * from
    MDM_BUILD_PRODUCT_TYPE where product_type_level=1) PRODUCT_TYPE)  
    union all 
    select 项目id||'|'||分期id||'|'||顶级业态id||'|'||末级业态id as id
    ,末级业态全路径
    ,项目id||'|'||分期id||'|'||顶级业态id as parent_id
    ,0 as 套
    ,总可售面积 as 面积
    ,总货值 as 金额
    ,0 as 均价 from basedata 
    where 阶段类型=10)

     ,动态 as(
    --全盘:项目-分期-业态顶级-楼栋-末级业态
    select ID,NAME,PARENT_ID,20 as 套,0 as 面积,0 as 金额,0 as 均价  from (
    select id||'|动态' as id,project_name name,'动态' PARENT_ID  from SYS_PROJECT
    union all
    select proj_stage.PROJECT_ID||'|'||proj_stage.id||'|动态'  as Id
    ,proj_stage.STAGE_FULL_NAME as NAME
    ,proj_stage.PROJECT_ID||'|动态' as PARENT_ID
    from SYS_PROJECT_STAGE PROJ_STAGE
    union all
    --业态顶级id：项目id|分期id|业态顶级id
    select proj_stage.PROJECT_ID||'|'||proj_stage.id||'|'||PRODUCT_TYPE.id||'|动态' as  id
    ,proj_stage.STAGE_FULL_NAME||'-'||PRODUCT_TYPE.PRODUCT_TYPE_NAME as name
    ,proj_stage.PROJECT_ID||'|'||proj_stage.id||'|动态' as parent_id 
    from  SYS_PROJECT_STAGE proj_stage cross join (select * from
    MDM_BUILD_PRODUCT_TYPE where product_type_level=1) PRODUCT_TYPE)  
    --楼栋级：
    union all
    select 项目id||'|'||分期id||'|'||顶级业态id||'|'||楼栋id as id
    ,楼栋名称
    ,项目id||'|'||分期id||'|'||顶级业态id||'|动态' as parent_id
    ,0 as 套
    ,0 as 面积
    ,0 as 金额
    ,0 as 均价 from basedata 
    where 阶段类型=20 group by 楼栋id,项目id,分期id,顶级业态id,楼栋名称
    union all 
    select 项目id||'|'||分期id||'|'||顶级业态id||'|'||楼栋id||'|'||末级业态id as id
    ,末级业态全路径
    ,项目id||'|'||分期id||'|'||顶级业态id||'|'||楼栋id as parent_id
    ,0 as 套
    ,总可售面积 as 面积
    ,总货值 as 金额
    ,0 as 均价 from basedata 
    where 阶段类型=20)

   ,结果 as ( 
   select '可研' as id, '可研' as NAME,null PARENT_ID
    ,0 as 套,0 as 面积,0 as 金额,0 as 均价 from dual
    union all
   select '全盘' as id,'全盘' as NAME,null PARENT_ID
    ,0 as 套,0 as 面积,0 as 金额,0 as 均价 from dual
   union all
   select '动态' as id,'动态' as NAME,null PARENT_ID
    ,0 as 套,0 as 面积,0 as 金额,0 as 均价 from dual
   union all
   select ID,NAME,PARENT_ID,套,面积,金额,均价 from 可研
   union all
   select ID,NAME,PARENT_ID,套,面积,金额,均价 from 全盘
   union all 
   select  ID,NAME,PARENT_ID,套,面积,金额,均价 from 动态
   )

select ID,NAME,PARENT_ID,套,面积,金额
--,(select sum(面积) from 结果 m start with m.id=s.id connect by prior m.id=m.parent_id ) 面积
--,(select sum(金额) from 结果 start with id=s.id connect by prior id=parent_id  ) 金额
 from 结果 s ;

END P_DWM_云徙联合项目组;



/
--------------------------------------------------------
--  DDL for Procedure P_GET_COMPANY_TREE_PROJ_SPID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_GET_COMPANY_TREE_PROJ_SPID" (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    data_auth_spid  OUT                VARCHAR2         
) AS
--获取有项目的公司树
--作者：谷国斌
--日期：2019/12/13
    rulevalue   VARCHAR2(50);
    authcount   INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    spid        VARCHAR2(36);--使用临时表的批次号
BEGIN
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;
--插入集团作为根节点
    INSERT INTO tmp_company_tree (id, org_id, org_name, org_type, parent_id, is_company, order_code)
        SELECT spid, id, org_name, org_type, parent_id, is_company, order_hierarchy_code
        FROM sys_business_unit
        WHERE id = '003200000000000000000000000000';
--获取隔离规则：

    SELECT isolation_rule_value INTO rulevalue
    FROM sys_data_auth_biz
    WHERE biz_obj_code = bizcode;

    IF rulevalue = '全集团' THEN
        INSERT INTO tmp_company_tree (id, org_id, org_name, org_type, parent_id, is_company, order_code)
            SELECT spid, id, org_name, org_type, parent_id, is_company, order_hierarchy_code
            FROM sys_business_unit
            WHERE is_company = 1;
    ELSE
--插入本公司及其父级
        INSERT INTO tmp_company_tree (id, org_id, org_name, org_type, parent_id, is_company, order_code)
            SELECT spid, id, org_name, org_type, parent_id, is_company, order_hierarchy_code
            FROM sys_business_unit
            WHERE is_company = 1
            START WITH id = companyid
            CONNECT BY PRIOR parent_id = id;

--插入数据授权的数据：
        DECLARE
            ownerid     VARCHAR2(36);
            oenertype   NVARCHAR2(50);
            CURSOR cursor_company IS
                SELECT DISTINCT auth_owner_id, auth_owner_type
                FROM sys_data_auth
                WHERE auth_biz_code = bizcode AND is_disabled = 0;
        BEGIN
            --打开游标
            OPEN cursor_company;
            LOOP
                FETCH cursor_company INTO ownerid, oenertype;
                EXIT WHEN cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                IF oenertype = '公司' OR oenertype = '集团' THEN
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司
                    SELECT COUNT(*) INTO authcount
                    FROM sys_business_unit
                    WHERE is_company = 1 AND id = companyid
                    START WITH id = ownerid
                    CONNECT BY PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (id, auth_owner_id, auth_owner_type)
                        VALUES (spid, ownerid, oenertype);
                    END IF;
                END IF;

                IF oenertype = '部门' THEN
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门
                    SELECT COUNT(*) INTO authcount
                    FROM sys_business_unit
                    WHERE is_company = 0 AND id = deptid
                    START WITH id = ownerid
                    CONNECT BY PRIOR id = parent_id;
                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (id, auth_owner_id, auth_owner_type)
                        VALUES (spid, ownerid, oenertype);
                    END IF;
                END IF;

                IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                    INSERT INTO tmp_auth_owner (id, auth_owner_id, auth_owner_type)
                        VALUES (spid,ownerid,oenertype);
                END IF;
            END LOOP;
            CLOSE cursor_company;
        END;
        --获取有权限的公司及其父级：
        DECLARE
            ownerid2 VARCHAR2(36);
            CURSOR cursor_auth IS SELECT auth_owner_id FROM tmp_auth_owner WHERE id = spid;
        BEGIN
        --打开游标
        OPEN cursor_auth;
        LOOP
        FETCH cursor_auth INTO ownerid2;
        EXIT WHEN cursor_auth%notfound;
        --授权对象为公司：
        --取授权公司的子级：
        INSERT INTO tmp_company_tree (id, org_id, org_name, org_type, parent_id, is_company, order_code )
            SELECT spid, id, org_name, org_type, parent_id, is_company, order_hierarchy_code
            FROM sys_business_unit
            WHERE is_company = 1
            START WITH id IN (
                SELECT DISTINCT auth_scope_id
                FROM sys_data_auth
                WHERE auth_biz_code = bizcode
                    AND is_disabled = 0
                    AND auth_owner_id = ownerid2
                    AND auth_scope_type IN ('公司',  '集团')
            ) CONNECT BY PRIOR id = parent_id;
        INSERT INTO tmp_company_tree ( id, org_id, org_name, org_type, parent_id, is_company, order_code)
            SELECT spid, id, org_name, org_type, parent_id, is_company, order_hierarchy_code
                FROM sys_business_unit
                WHERE is_company = 1
                START WITH id IN (
                    SELECT DISTINCT auth_scope_id
                    FROM sys_data_auth
                    WHERE auth_biz_code = bizcode
                        AND is_disabled = 0
                        AND auth_owner_id = ownerid2
                        AND auth_scope_type IN ( '公司', '集团')
                ) CONNECT BY PRIOR parent_id = id;

                   --授权对应为部门：
                   --取授权部门的父级：


            INSERT INTO tmp_company_tree ( id, org_id, org_name, org_type, parent_id, is_company, order_code)
                    SELECT spid, id, org_name, org_type, parent_id, is_company, order_hierarchy_code
                    FROM sys_business_unit
                    WHERE is_company = 1
                    START WITH id IN (
                        SELECT DISTINCT auth_scope_id
                        FROM sys_data_auth
                        WHERE auth_biz_code = bizcode
                            AND is_disabled = 0
                            AND auth_owner_id = ownerid2
                            AND auth_scope_type = '部门'
                    ) CONNECT BY PRIOR parent_id = id;
                   --授权对应为项目：

            INSERT INTO tmp_company_tree ( id, org_id, org_name, org_type, parent_id, is_company, order_code)
                SELECT spid, id, org_name,  org_type, parent_id, is_company, order_hierarchy_code
                FROM sys_business_unit
                WHERE is_company = 1
                START WITH id IN (
                    SELECT unit_id
                    FROM sys_project
                    WHERE id IN (
                        SELECT DISTINCT auth_scope_id
                        FROM sys_data_auth
                        WHERE auth_biz_code = bizcode
                            AND is_disabled = 0
                            AND auth_owner_id = ownerid2
                            AND auth_scope_type = '项目'
                    )
                ) CONNECT BY PRIOR parent_id = id;
            END LOOP;
            CLOSE cursor_auth;
        END;
    END IF;
--    OPEN data_auth_info FOR
--        SELECT DISTINCT
--            org_id       AS orgid,
--            org_name     AS orgname,
--            org_type     AS orgtype,
--            parent_id    AS parentid,
--            1 AS iscompany,
--            order_code   AS ordercode
--        FROM tmp_company_tree
--        WHERE id = spid
--            AND org_id IN (
--               SELECT DISTINCT id
--               FROM sys_business_unit
--               START WITH id IN (
--                   SELECT id
--                   FROM (
--                       SELECT unit_id AS id
--                       FROM sys_project
--                       UNION
--                       SELECT subordinate_company_id AS id
--                       FROM cdb_feasible_project_config
--                   ) ds
--               ) CONNECT BY PRIOR parent_id = id
--            ) ORDER BY order_code;

             data_auth_spid:=SPID;
END P_GET_COMPANY_TREE_PROJ_SPID;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_BLD_PERMIT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_MDM_BLD_PERMIT" (
    companyid     IN            VARCHAR2,--当前用户公司
    stationid     IN            VARCHAR2,---当前用户的岗位
    deptid        IN            VARCHAR2,---当前用户的部门
    bizcode       IN            VARCHAR2,---权限code
    userid        IN            VARCHAR2,---当前用户id
    projectids   IN            VARCHAR2,---项目名称
    searchparam   IN            VARCHAR2,--筛选条件
    selectCompanyId  IN           VARCHAR2,---当前选中的公司
    licenseType   IN            VARCHAR2, --证照类型
    info         OUT           SYS_REFCURSOR,
    pageindex     IN            INT,
    pagesizes     IN            INT,
    total         OUT           INT

) IS
    --证照办理一栏
--作者：鲜晓勇
--日期：2020/2/09
    v_sql_exec         CLOB;
    v_sql        CLOB;
    v_spid             VARCHAR2(200);---数据验证spid
    v_where            VARCHAR2(4000):=' and 1=1 ';
    v_search           VARCHAR2(4000):=' and 1=1 ';  ---搜素sql
    v_project          VARCHAR2(4000);
    v_auth_sql         VARCHAR2(4000) :=' where 1=1';
BEGIN
    BEGIN
        --执行数据权限存储过程。拿到零时表id 用户连临时表鉴权
        --调用查询数据权限的存储过程,返回spid
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => stationid,
            DEPTID => deptid,
            COMPANYID => companyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
            );
        --    OPEN tabledata FOR select DISTINCT org_id AS orgid,node.node_name from  TMP_AUTH_LIST tal left join pom_proj_plan_node node on tal.org_id=node.company_id where tal.id = v_spid;

        -- v_auth_sql:='LEFT join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') ta on ta.orgid=MB.PROJ_ID  where ta.orgid is not null';

        if(selectCompanyId is not null and projectids is null)
        THEN
            v_where:=' AND MB.PROJ_ID IN(select * from sys_project WHERE  UNIT_ID='''||selectCompanyId||''')';
        END IF;
        if(projectids is not null)THEN
            FOR item IN (
                SELECT
                    regexp_substr(''
                                      || projectids
                                      || '', '[^,]+', 1, ROWNUM) AS id
                FROM
                    dual
                CONNECT BY
                        ROWNUM <= length(''
                        || projectids
                        || '') - length(regexp_replace(''
                                                           || projectids
                                                           || '', ',', '')) + 1
                ) LOOP
                    v_project:=v_project||''''||item.id||''',';
                END LOOP;
            v_project:=substr(v_project,1,length(v_project) -1 );
            v_where:=' AND MB.PROJ_ID IN('||v_project||')';
        END if;

        if(searchParam is not null)THEN
            v_search:=' AND (MPAR.PARCEL_NAME like ''%'
                || searchparam
                || '%'' or MB.CON_PLAN_PERMIT_NO like ''%'
                || searchparam
                || '%'' or MB.CONSTRUCTION_PERMIT_NO like ''%'
                || searchparam
                || '%'' or MB.PRE_SALE_PERMIT_NO like ''%'
                || searchparam
                || '%'' or MB.GET_COMPLETED_PERMIT_NO like ''%'
                || searchparam
                || '%'')';
        END IF;
        v_sql := 'SELECT
            rownum as rowno,
            MB.ORDER_HIERARCHY_CODE AS "orderCode",
             MB.PROJ_ID AS "projectId", MP.PROJECT_NAME AS "projectName",
			 MPAR.PARCEL_NAME AS "parcelName", MB.PARCEL_ID AS "parcelId",
			 MB.PERIOD_ID AS "stageId", MB.PERIOD_NAME AS "stageName",
			 MB.ID AS "bldId", MB.BUILD_NAME AS "bldName",MB.BUILD_NAME AS "bldCode",
			 NULL AS "productFullName", NULL AS "managementType",
              to_char(MB.GET_CON_PLAN_PERMIT_DATE,''yyyy-MM-dd'') as "planPermitDate",
			 MB.CON_PLAN_PERMIT_ID AS "planPermitId",
			 MB.CON_PLAN_PERMIT_NO AS "planPermitNo",
              to_char(MB.GET_CONSTRCUTION_PERMIT_DATE,''yyyy-MM-dd'') as "constructionPermitDate",
			 MB.CONSTRACUTION_PERMIT_ID AS "constructionPermitId",
			 MB.CONSTRUCTION_PERMIT_NO AS "constructionPermitNo",
                 to_char(MB.GET_PRE_SALE_PERMIT_DATE,''yyyy-MM-dd'') as "preSalePermitDate",
			 MB.PRE_SALE_PERMIT_ID AS "perSalePermitId",
			 MB.PRE_SALE_PERMIT_NO AS "preSalePermitNo",
                 to_char(MB.GET_COMPLETED_PERMIT_DATE,''yyyy-MM-dd'') as "completedPermitDate",
			 MB.COMPLETED_PERMIT_ID AS "complatedPerimtId",
			 MB.GET_COMPLETED_PERMIT_NO AS "completedPermitNo"
            FROM   MDM_BUILD MB
            INNER  JOIN SYS_PROJECT MP
            ON     MB.PROJ_ID = MP.id
            INNER  JOIN SYS_PROJECT_STAGE MPER
            ON     MPER.ID = MB.PERIOD_ID
            INNER  JOIN (select distinct p.parcel_name,p.PARCEL_ORIGINAL_ID from mdm_project m1 inner join MDM_PARCEL  p on m1.id=p.project_id and m1.approval_status=''已审核'' )MPAR
            on mb.Parcel_id=MPAR.PARCEL_ORIGINAL_ID
            '||v_auth_sql||' and 1=1
             '||v_where||' '||v_search||'';

        if pagesizes != 0 and pageindex != 0 then
            v_sql_exec := 'select a.* from ( '
                || v_sql
                || ' AND rownum <= '
                || pageindex * pagesizes
                || ' ) a where a.rowno > '
                || pagesizes * ( pageindex - 1 )
                || ' order by a."projectName", a."orderCode" asc';
        else
            v_sql_exec := v_sql;
        end if;


        dbms_output.put_line(v_sql_exec);
        ----获取总条数
        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
            || v_sql
            || ') a '
            INTO total;
        OPEN info FOR v_sql_exec;
    END;
END P_MDM_BLD_PERMIT;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_BUILDING_RELEASE_CB
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_MDM_BUILDING_RELEASE_CB" (
    id IN VARCHAR--楼栋表MDM_BUILD 主键id
) 
	--分期楼栋发布回调，1、创建动态货值相关版本数据//王传科实现 20191208
	--作者：陈丽
	--日期：2019/12/08	
 AS
BEGIN
    NULL;
END p_mdm_building_release_cb;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_BUILDLIST_TO_ROOM
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_MDM_BUILDLIST_TO_ROOM" (
    items OUT SYS_REFCURSOR
) IS
BEGIN
    ----因为当前数据库中的楼栋 在集团提供的查询房间的接口中无法查出房间,所以就使用了接口文档中提供的示例楼栋id用来测试
    OPEN items FOR SELECT
                       ID
                   FROM
                       mdm_build union select 'e7836cbbe38245cd9ebd0c2e91d4ff75' from dual;

END p_mdm_buildlist_to_room;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_COMPANY_PROJ_SITUATION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_MDM_COMPANY_PROJ_SITUATION" 
(
    USERID    IN VARCHAR2
   ,STATIONID IN VARCHAR2
   ,DEPTID    IN VARCHAR2
   ,COMPANYID IN VARCHAR2
   ,BIZCODE   IN VARCHAR2
   ,WACTHINFO OUT SYS_REFCURSOR
) AS
    --公司主数据项目情况-主数据首页
    --作者：陈丽
    --日期：2019/11/13
    RULEVALUE VARCHAR2(50);
    AUTHCOUNT INT; --用于判断当前公司、部门是否与数据授权的主体有关系
    SPID      VARCHAR2(36); --使用临时表的批次号
BEGIN
    -- select get_uuid() into SPID from dual;
    -- --插入集团作为根节点
    -- insert into TMP_COMPANY_TREE(ID,ORG_ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE)
    -- select SPID,ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE FROM sys_business_unit where id='003200000000000000000000000000';
    --
    -- --获取隔离规则：
    -- select isolation_rule_value into RULEVALUE from SYS_DATA_AUTH_BIZ where biz_obj_code=BIZCODE;
    -- if RULEVALUE='全集团' then
    -- insert into TMP_COMPANY_TREE(ID,ORG_ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE)
    -- select SPID,ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE FROM sys_business_unit where is_company=1;
    --
    -- insert into TMP_COMPANY_TREE(ID,ORG_ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE)
    --                             select SPID,ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE FROM
    --                             sys_business_unit where is_company=1
    --                                 START WITH ID in (
    --                                 select unit_id from sys_project where id in (select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code='CDB002'
    --                                  and is_disabled=0  and auth_scope_type='项目')
    --                                 )  CONNECT BY PRIOR  parent_id=ID;
    -- else
    -- --插入本公司及其父级
    -- insert into TMP_COMPANY_TREE(ID,ORG_ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE)
    -- select SPID,ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE FROM
    --     sys_business_unit where is_company=1 START WITH ID=COMPANYID  CONNECT BY PRIOR  parent_id=ID;
    --
    -- --插入数据授权的数据：
    --
    --         DECLARE
    --                 OWNERID  VARCHAR2(36);
    --                 OENERTYPE NVARCHAR2(50);
    --                 CURSOR cursor_company IS
    --                 select distinct auth_owner_id,auth_owner_type from SYS_DATA_AUTH where auth_biz_code=BIZCODE and is_disabled=0;
    --
    --             BEGIN
    --
    --             --打开游标
    --                 OPEN cursor_company;
    --                 loop
    --                     fetch cursor_company into OWNERID,OENERTYPE;
    --                     exit when cursor_company%notfound;
    --
    --                 --过滤当前用户有权限的授权对象：
    --                 if OENERTYPE='公司' or OENERTYPE='集团'
    --                 then
    --                    --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司
    --                      SELECT count(*) into AUTHCOUNT FROM sys_business_unit where is_company=1 and id=COMPANYID
    --                     START WITH ID=OWNERID CONNECT BY PRIOR  ID=parent_id;
    --                     if AUTHCOUNT<>0
    --                     then
    --                         insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
    --                         values(SPID,OWNERID,OENERTYPE);
    --
    --                     end if;
    --
    --                 end if;
    --
    --                  if OENERTYPE='部门'
    --                 then
    --                    --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门
    --                      SELECT count(*) into AUTHCOUNT FROM sys_business_unit where is_company=0 and id=DEPTID
    --                     START WITH ID=OWNERID CONNECT BY PRIOR  ID=parent_id;
    --                     if AUTHCOUNT<>0
    --                     then
    --                         insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
    --                         values(SPID,OWNERID,OENERTYPE);
    --
    --                     end if;
    --
    --                 end if;
    --
    --                  if (OENERTYPE='岗位' and OWNERID=STATIONID) or (OENERTYPE='人员' and OWNERID=USERID)
    --                 then
    --
    --                        insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
    --                         values(SPID,OWNERID,OENERTYPE);
    --                 end if;
    --
    --                 end loop;
    --
    --                 close cursor_company;
    --
    --             END;
    --
    --           --获取有权限的公司及其父级：
    --                 DECLARE
    --                         OWNERID2  VARCHAR2(36);
    --                         CURSOR cursor_auth IS
    --                         select auth_owner_id from TMP_AUTH_OWNER where ID=SPID;
    --
    --                     BEGIN
    --
    --                     --打开游标
    --                         OPEN cursor_auth;
    --                         loop
    --                             fetch cursor_auth into OWNERID2;
    --                             exit when cursor_auth%notfound;
    --
    --
    --                             --授权对象为公司：
    --                             --取授权公司的子级：
    --                             insert into TMP_COMPANY_TREE(ID,ORG_ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE)
    --                             select SPID,ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE FROM
    --                             sys_business_unit where is_company=1
    --                                 START WITH ID in (
    --                                 select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE
    --                                  and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type in ('公司','集团')
    --                                 )  CONNECT BY PRIOR  ID=parent_id;
    --
    --
    --                             --取授权公司的父级：
    --                             insert into TMP_COMPANY_TREE(ID,ORG_ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE)
    --                             select SPID,ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE FROM
    --                             sys_business_unit where is_company=1
    --                                 START WITH ID in (
    --                                 select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE
    --                                  and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type in ('公司','集团')
    --                                 )  CONNECT BY PRIOR  parent_id=ID;
    --
    --                              --授权对应为部门：
    --                                --取授权部门的父级：
    --
    --                                  insert into TMP_COMPANY_TREE(ID,ORG_ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE)
    --                             select SPID,ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE FROM
    --                             sys_business_unit where is_company=1
    --                                 START WITH ID in  (select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE
    --                                  and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type='部门'
    --                                 )  CONNECT BY PRIOR  parent_id=ID;
    --                                --授权对应为项目：
    --
    --                             insert into TMP_COMPANY_TREE(ID,ORG_ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE)
    --                             select SPID,ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE FROM
    --                             sys_business_unit where is_company=1
    --                                 START WITH ID in (
    --                                 select unit_id from sys_project where id in (select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE
    --                                  and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type='项目')
    --                                 )  CONNECT BY PRIOR  parent_id=ID;
    --
    --                               end loop;
    --                            close  cursor_auth;
    --                         end;
    --
    --
    --     end if;

    --  SELECT
    --  A.orgId AS id,
    --  A.parentId AS parentsId,
    --  A.orgName AS orgName,
    --  CASE
    --  WHEN A.orgType = 10 THEN
    --    1
    --  ELSE
    --    0
    -- END projTotal,
    --  CASE
    --  WHEN B.PROJ_ID IS NOT NULL THEN
    --    B.TARGET_WORTH
    --  ELSE
    --    0
    -- END dynamicWorth,
    -- '0' AS reserveWorth,
    -- '0' AS wayWorth,
    -- '0' AS inventoryWorth,
    -- '/dwm/value-manage/dynamic-value/value-monitor' AS jumpUrl FROM
    -- (select distinct ORG_ID as orgId,org_name as orgName,org_type as orgType,parent_id as parentId,1 as isCompany,order_code as orderCode
    -- from TMP_COMPANY_TREE WHERE ID=SPID AND
    -- ORG_ID in(
    --                     SELECT distinct id FROM sys_business_unit START WITH ID in (select id from (
    --                     select unit_id as id from sys_project
    --                     union
    --                     SELECT SUBORDINATE_COMPANY_ID as id FROM CDB_FEASIBLE_PROJECT_CONFIG
    --                     ) ds) CONNECT BY PRIOR parent_id = ID))A
    --  LEFT JOIN (
    -- SELECT T1.PROJ_ID,T1.PROJ_NAME,
    -- CASE WHEN T2.PROJ_ID IS NOT NULL
    -- THEN T2.TARGET_WORTH
    --  ELSE
    --    T1.TARGET_WORTH
    -- END TARGET_WORTH FROM
    -- (SELECT D.PROJ_ID,D.PROJ_NAME,D.TARGET_WORTH,MAX(D.APPROVAL_TIME)
    -- FROM DWM_TARGET_WORTH D
    --  WHERE D.IS_DELETE = 0 AND D.APPROVAL_STATUS = '已审核'
    --  GROUP BY D.PROJ_ID,D.PROJ_NAME,D.TARGET_WORTH) T1
    --  LEFT JOIN
    --  (
    --  SELECT D.PROJ_ID,D.PROJ_NAME,D.TARGET_WORTH,MAX(D.APPROVAL_TIME)
    -- FROM DWM_TARGET_WORTH D
    --  WHERE D.IS_DELETE = 0 AND D.APPROVAL_STATUS = '已审核' AND D.TARGET_WORTH_PHASE = 20
    --  GROUP BY D.PROJ_ID,D.PROJ_NAME,D.TARGET_WORTH
    --  )T2 ON T1.PROJ_ID = T2.PROJ_ID)B ON A.orgId = B.PROJ_ID;
    --
    --
    OPEN WACTHINFO FOR
        SELECT A.ORGID AS ID,
                --组织id
               A.ORGNAME || 'tt' AS ORGNAME,
                --组织名称名称
               LOWER(A.PARENTID) AS PARENTSID,
                --父级id

               CASE
                   WHEN A.ORGTYPE = 1 THEN
                    1
                   ELSE
                    0
               END PROJTOTAL,
               CASE
                   WHEN X.PROJ_ID IS NOT NULL AND NVL(X.TARGET_WORTH, 0) > 0 THEN
                    X.TARGET_WORTH
                   WHEN Y.PROJ_ID IS NOT NULL AND NVL(Y.TARGET_WORTH, 0) > 0 THEN
                    Y.TARGET_WORTH
                   WHEN Z.PROJ_ID IS NOT NULL AND NVL(Z.TARGET_WORTH, 0) > 0 THEN
                    Z.TARGET_WORTH
                   ELSE
                    0
               END NEWESTWORTH, '0' AS DYNAMICWORTH, '0' AS RESERVEWORTH,
               '0' AS INTRANSITWORTH, '0' AS INVENTORYWORTH,
               '0' AS EXPLAINATION,
               '/dwm/value-manage/dynamic-value/value-monitor' AS JUMPURL

        FROM   (SELECT ORDER_CODE,
                         --用于树形的排序
                        T.PROJECT_ORIGINAL_ID ORGID,
                         --组织id
                        T.PROJECT_NAME AS ORGNAME,
                         --组织名称名称

                        T.ORG_TYPE AS ORGTYPE,
                         --组织类型 0公司，1项目
                        LOWER(T.PARENT_ID) AS PARENTID --父级id

                 FROM   (SELECT MDM_PROJECT.PROJECT_ORIGINAL_ID,
                                 ORG.PARENT_ID || '-' ||
                                  SUBSTR('000' || ORG.ORDER_CODE, -3) ||
                                  ORG.ORDER_CODE AS ORDER_CODE,
                                  --用于树形的排序
                                 PROJECT_NAME,
                                 MDM_PHASE.PHASE_NAME AS PROJ_PHASE,
                                 PHASE.PHASE_ID, PHASE.ID AS PROJ_PHASE_ID,
                                 10 AS ORG_TYPE,
                                 CASE
                                     WHEN PHASE.PHASE_ID IS NULL THEN
                                      0
                                     ELSE
                                      1
                                 END AS IS_EXIST_PROJ_PHASE,
                                 MDM_PROJECT.COMPANY_ID AS PARENT_ID,
                                 MDM_OBJ_PHASE_INDEX.TOTAL_SITE_AREA,
                                 MDM_OBJ_PHASE_INDEX.OVERALL_FLOORAGE_AREA,
                                 MDM_OBJ_PHASE_INDEX.TOTAL_SALE_AREA,
                                 MDM_OBJ_PHASE_INDEX.TOTAL_CAPACITY_AREA
                          FROM   MDM_PROJECT
                          LEFT   JOIN (SELECT T1.ID, T1.PHASE_ID, T1.PROJ_ID,
                                             T2.PHASE_ORDER
                                      FROM   MDM_PROJECT_PHASE T1
                                      LEFT   JOIN (SELECT PROJ_ID,
                                                         MAX(PHASE_ORDER) AS PHASE_ORDER
                                                  FROM   MDM_PROJECT_PHASE
                                                  GROUP  BY PROJ_ID) T2
                                      ON     T1.PROJ_ID = T2.PROJ_ID AND
                                             T1.PHASE_ORDER = T2.PHASE_ORDER
                                      WHERE  T2.PHASE_ORDER IS NOT NULL) PHASE
                          ON     MDM_PROJECT.PROJECT_ORIGINAL_ID =
                                 PHASE.PROJ_ID
                          LEFT   JOIN MDM_PHASE
                          ON     PHASE.PHASE_ID = MDM_PHASE.ID
                          LEFT   JOIN MDM_OBJ_PHASE_INDEX
                          ON     PHASE.ID = MDM_OBJ_PHASE_INDEX.OBJ_PHASE_ID AND
                                 MDM_OBJ_PHASE_INDEX.OBJ_TYPE = 0
                          LEFT   JOIN SYS_BUSINESS_UNIT ORG
                          ON     MDM_PROJECT.COMPANY_ID = ORG.ID
                          WHERE  APPROVAL_STATUS = '已审核'
                          UNION ALL
                          SELECT ID,
                                 PARENT_ID || '-' ||
                                  SUBSTR('000' || ORDER_CODE, -3) AS ORDER_CODE,
                                  --用于树形的排序
                                 ORG_NAME, '' AS PROJ_PHASE, '' AS PHASE_ID,
                                 '' AS PROJ_PHASE_ID, 0 ORG_TYPE,
                                 NULL IS_EXIST_PROJ_PHASE, PARENT_ID,
                                 0 AS "totalSiteArea",
                                 0 AS "overallFloorageArea",
                                 0 AS "totalSalableArea",
                                 0 AS "totalCapacityArea"
                          FROM   SYS_BUSINESS_UNIT
                          WHERE  ORG_TYPE = 0 AND
                                 (ID != '000100000000000000000000000000' AND
                                 ID != '000200000000000000000000000000')) T) A
        LEFT   JOIN (SELECT A.PROJ_ID, A.TARGET_WORTH
                     FROM   DWM_TARGET_WORTH A
                     RIGHT  JOIN (SELECT D.PROJ_ID, D.TARGET_WORTH_PHASE,
                                        MAX(WORTH_V) AS WORTH_V
                                 FROM   DWM_TARGET_WORTH D
                                 WHERE  D.IS_DELETE = 0 AND
                                        D.APPROVAL_STATUS IN ('已审核', '审核中') AND
                                        D.TARGET_WORTH_PHASE = 20
                                 GROUP  BY D.PROJ_ID, D.TARGET_WORTH_PHASE) A1
                     ON     A.PROJ_ID = A1.PROJ_ID AND
                            A.WORTH_V = A1.WORTH_V AND
                            A.TARGET_WORTH_PHASE = A1.TARGET_WORTH_PHASE) X
        ON     A.ORGID = X.PROJ_ID
        LEFT   JOIN (SELECT B.PROJ_ID, B.TARGET_WORTH
                     FROM   DWM_TARGET_WORTH B
                     RIGHT  JOIN (SELECT D.ID, D.PROJ_ID, MAX(APPROVAL_TIME)
                                 FROM   DWM_TARGET_WORTH D
                                 WHERE  D.IS_DELETE = 0 AND
                                        D.APPROVAL_STATUS IN ('已审核', '审核中') AND
                                        D.TARGET_WORTH_PHASE = 10
                                 GROUP  BY D.ID, D.PROJ_ID) B1
                     ON     B.ID = B1.ID) Y
        ON     A.ORGID = Y.PROJ_ID
        LEFT   JOIN (SELECT C.PROJ_ID, C.TARGET_WORTH
                     FROM   DWM_TARGET_WORTH C
                     RIGHT  JOIN (SELECT ID, D.PROJ_ID, MAX(APPROVAL_TIME)
                                 FROM   DWM_TARGET_WORTH D
                                 WHERE  D.IS_DELETE = 0 AND
                                        D.APPROVAL_STATUS IN ('已审核', '审核中') AND
                                        D.TARGET_WORTH_PHASE = 0
                                 GROUP  BY D.ID, D.PROJ_ID) C1
                     ON     C.ID = C1.ID) Z
        ON     A.ORGID = Z.PROJ_ID
        WHERE  ROWNUM = 1
        ORDER  BY ORDER_CODE;

END P_MDM_COMPANY_PROJ_SITUATION;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_GET_BLD_DATA_BY_PLATFORM
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_MDM_GET_BLD_DATA_BY_PLATFORM" 
(
		PROJ_PERIOD_ID IN NVARCHAR2 --分期ID
	 ,PERMIT_TYPE    IN NVARCHAR2 --证照类型
	 ,BLD_ID_TABLE   OUT SYS_REFCURSOR --返回值
) AS

BEGIN
		OPEN BLD_ID_TABLE FOR
				SELECT A.ID AS "bldId", A.BUILD_NAME AS "bldName", NULL AS "bldCode", A.PERIOD_NAME AS "projectName",
							 SUBSTR(D.PRODUCT_TYPE_NAME, 1, INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 1) - 1) AS "firstProductName",
							 SUBSTR(D.PRODUCT_TYPE_NAME, INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 1) + 1, INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 2) - INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 1) - 1) AS "secondProductName",
							 SUBSTR(D.PRODUCT_TYPE_NAME, DECODE(INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 2), 0, 100, INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 2)) + 1) AS "thirdProductName",
							 D.PRODUCT_TYPE_NAME AS "productFullName", D.PRODUCT_TYPE_ID AS "productId", 
                            case when(case when PERMIT_TYPE='规划许可证' 
                             then a.IS_GET_CON_PLAN_PERMIT
                             when PERMIT_TYPE='施工许可证'
                             then a.IS_GET_CONSTRCUTION_PERMIT
                             when PERMIT_TYPE='竣工备案证'
                             then a.IS_GET_COMPLETED_PERMIT
                             when PERMIT_TYPE='预售许可证'
                             then a.IS_GET_PRE_SALE_PERMIT
                             else 
                              '' end)='1' then '是' else '否' end  AS "isGetSalePermit", D.BUILD_AREA AS "bldArea", D.GROUND_TOTAL_BUILD_AREA AS "bldAreaOn",
							 D.UNDERGROUND_TOTAL_BUILD_AREA AS "bldAreaUnder", D.TOTAL_SALE_AREA AS "saleArea", D.GROUND_SALE_AREA AS "saleAreaOn", D.UNDERGROUND_SALE_AREA AS "saleAreaUnder",
							 E.PRE_SALE_BLD_AREA AS "preSaleBldArea", E.PRE_SALE_BLD_AREA_ON AS "preSaleBldAreaOn", E.PRE_SALE_BLD_AREA_UNDER AS "preSaleBldAreaUbder", E.PRE_SALE_IN_AREA AS "preSaleInArea",
							 E.PRE_SALE_IN_AREA_ON AS "preSaleInAreaOn", E.PRE_SALE_IN_AREA_UNDER AS "preSaleInAreaUnder", E.ACTUAL_SALE_BLD_AREA AS "actualSaleBldArea",
							 E.ACTUAL_SALE_BLD_AREA_ON AS "actualSaleBldAreaOn", E.ACTUAL_SALE_BLD_AREA_UNDER AS "actualSaleBldAreaUnber", a.IS_GET_CON_PLAN_PERMIT ,a.IS_GET_CONSTRCUTION_PERMIT,a.IS_GET_PRE_SALE_PERMIT,a.IS_GET_COMPLETED_PERMIT

				FROM   MDM_BUILD A
				INNER  JOIN MDM_BUILD_PHASE B
				ON     A.ID = B.BUILD_ID AND b.PHASE_ORDER = (SELECT MAX(phase_order) FROM MDM_BUILD_PHASE mbp WHERE mbp.BUILD_ID = b.BUILD_ID )
				INNER  JOIN MDM_OBJ_PHASE_INDEX C
				ON     C.OBJ_PHASE_ID = B.ID 
				INNER  JOIN (SELECT B1.PRODUCT_TYPE_CODE, A1.* FROM MDM_OBJ_PHASE_PT_INDEX A1 INNER JOIN MDM_BUILD_PRODUCT_TYPE B1 ON A1.PRODUCT_TYPE_ID = B1.ID) D
				ON     D.OBJ_PHASE_ID = B.ID
				LEFT   JOIN (SELECT A2.BUILDING_ID, A2.BUILDING_NAME, A2.PRODUCT_CODE, SUM(A2.PRE_BLD_AREA) AS PRE_SALE_BLD_AREA,
														SUM(CASE
																		WHEN PRODUCT_IS_CW = 0 THEN
																		 A2.PRE_BLD_AREA
																		ELSE
																		 0
																END) AS PRE_SALE_BLD_AREA_ON,
														SUM(CASE
																		WHEN PRODUCT_IS_CW = 1 THEN
																		 A2.PRE_BLD_AREA
																		ELSE
																		 0
																END) AS PRE_SALE_BLD_AREA_UNDER, SUM(A2.PRE_IN_AREA) AS PRE_SALE_IN_AREA,
														SUM(CASE
																		WHEN PRODUCT_IS_CW = 0 THEN
																		 A2.PRE_IN_AREA
																		ELSE
																		 0
																END) AS PRE_SALE_IN_AREA_ON,
														SUM(CASE
																		WHEN A2.PRODUCT_IS_CW = 1 THEN
																		 A2.PRE_IN_AREA
																		ELSE
																		 0
																END) AS PRE_SALE_IN_AREA_UNDER, SUM(A2.ACTUAL_BLD_AREA) AS ACTUAL_SALE_BLD_AREA,
														SUM(CASE
																		WHEN A2.PRODUCT_IS_CW = 0 THEN
																		 A2.ACTUAL_BLD_AREA
																		ELSE
																		 0
																END) AS ACTUAL_SALE_BLD_AREA_ON,
														SUM(CASE
																		WHEN A2.PRODUCT_IS_CW = 1 THEN
																		 A2.ACTUAL_BLD_AREA
																		ELSE
																		 0
																END) AS ACTUAL_SALE_BLD_AREA_UNDER

										 FROM   MDM_ROOM A2
										 GROUP  BY A2.BUILDING_ID, A2.BUILDING_NAME, A2.PRODUCT_CODE) E
				ON     E.BUILDING_ID = A.ID AND
							 E.PRODUCT_CODE = D.PRODUCT_TYPE_CODE
				LEFT   JOIN (SELECT B3.BUILD_ID, B3.ID AS OBJ_PHASE_ID, A3.BUILD_AREA, A3.GROUND_TOTAL_BUILD_AREA, A3.UNDERGROUND_TOTAL_BUILD_AREA
										 FROM   MDM_OBJ_PHASE_PT_INDEX A3
										 INNER  JOIN MDM_BUILD_PHASE B3
										 ON     A3.OBJ_PHASE_ID = B3.ID AND
														B3.PHASE_NAME = '竣工备案证阶段') F
				ON     F.BUILD_ID = A.ID AND
							 F.OBJ_PHASE_ID = B.ID
				WHERE  EXISTS (SELECT 1
								FROM   (SELECT ROW_NUMBER() OVER(PARTITION BY A.ID ORDER BY C.PHASE_ORDER DESC) AS PRANK, A.ID BUILDID, C.PHASE_ORDER PHASEORDER, C.PHASE_NAME PHASENAME, C.ID PHASEID
												 FROM   MDM_BUILD A
												 INNER  JOIN MDM_BUILD_PHASE B
												 ON     A.ID = B.BUILD_ID
												 INNER  JOIN MDM_PHASE C
												 ON     B.PHASE_ID = C.ID) P
								WHERE  P.PRANK = 1 AND
											 P.PHASEID = B.PHASE_ID AND
											 P.BUILDID = A.ID) AND
							 A.BUILD_STATE = 10 AND
							 A.PERIOD_ID = '' || PROJ_PERIOD_ID || '' OR
							 A.PROJ_ID = '' || PROJ_PERIOD_ID || ''
				ORDER  BY BUILD_NAME;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_GET_BUILDS_BY_PROJECT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_MDM_GET_BUILDS_BY_PROJECT" 
(
		PROJECTID IN VARCHAR2
	 ,ITEMS     OUT SYS_REFCURSOR
) IS
		--从销售系统抓取房间数据 创建根据项目ID获取楼栋数据存储过程
		--作者：鲜晓勇
		--日期：2020/01/13
BEGIN
		OPEN ITEMS FOR
				SELECT mb.ID AS "id"
				FROM   (SELECT A.ID AS orgid, A.org_name AS orgname FROM sys_business_unit A WHERE A.is_company = 1 START WITH A.ID = projectid CONNECT BY PRIOR A.ID = A.parent_id) sbu
				INNER  JOIN sys_project sp
				ON     sbu.orgid = sp.unit_id
				INNER  JOIN mdm_build mb
				ON     sp.ID = mb.proj_id;


/*select '2f39f9159b5642879da1383368fb15e6' as "id" from dual; */
END P_MDM_GET_BUILDS_BY_PROJECT;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_GET_INVOLVE_PERMIT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_MDM_GET_INVOLVE_PERMIT" (
   permitType  IN NVARCHAR2 --证照类型
   ,planNodeId  IN NVARCHAR2 ---节点id
   ,items        OUT          SYS_REFCURSOR --返回值
) AS
BEGIN
    OPEN items FOR   select mp.id as "id"
           from mdm_permit mp
           inner join(select *
               from POM_NODE_FEEDBACK nf
               inner join (select id, fission_source_original_id
                   from pom_proj_plan_node a
                   start with a.id = ''||planNodeId||''
                   CONNECT BY PRIOR a.fission_source_original_id = a.id
               ) n on nf.FEEDBACK_NODE_ID = n.id and n.id is not null
           ) f on mp.id = f.PERMIT_ID;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_GET_PEMIT_BY_PROJECT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_MDM_GET_PEMIT_BY_PROJECT" (
    PROJECT_ID    IN           NVARCHAR2  --项目or 分期id
    ,
    items        OUT          SYS_REFCURSOR --返回值
) AS
    v_sql_exec         CLOB;
BEGIN
    v_sql_exec:='SELECT
                           id                AS "id",
                           permit_no         AS "permitNo",
                           permit_get_date   AS "permitGetDate",
                           created           AS "created",
                           creator           AS "creator",
                           bld_scope         AS "bldScope",
                           project_id        AS "projectId"
                       FROM
                           mdm_permit
                       WHERE
                           approval_status = ''已审核''';
	 IF ( PROJECT_ID IS NOT NULL ) THEN
    v_sql_exec:=v_sql_exec||'AND ( project_id = '''|| PROJECT_ID||'''
                                 OR stage_id = '''
                                               || PROJECT_ID
                                               || ''' )';

    ELSE
        v_sql_exec:=v_sql_exec||'AND project_id = ''11111111111111111111''';
    END IF;
     dbms_output.put_line(v_sql_exec);
    OPEN items FOR v_sql_exec;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_GET_PERMIT_BLD_REF_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_MDM_GET_PERMIT_BLD_REF_DATA" 
(
    PROJ_PERIOD_ID      IN NVARCHAR2  --分期ID
   ,PERMIT_TYPE  IN NVARCHAR2 --证照类型
   ,BLD_ID_TABLE OUT SYS_REFCURSOR --返回值
) AS

BEGIN
    /*    OPEN BLD_ID_TABLE FOR
    SELECT '75948F49-61C3-E711-AC26-000C293C2531' AS BLD_ID
         , '一号楼' AS BLD_NAME, 'Q1.001' AS BLD_CODE, '一期' AS PROJECT_NAME
         , '住宅' AS FIRST_PRODUCT_NAME, '商品住宅' AS SECOND_PRODUCT_NAME
         , '高层I' AS THIRD_PRODUCT_NAME
         , '住宅-商品住宅-高层I' AS PRODUCT_FULL_NAME
         , GET_UUID( ) AS PRODUCT_ID, '否' AS IS_GET_SALE_PERMIT
         , 100.00 AS BLD_AREA, 90.00 AS BLD_AREA_ON, 10.00 AS BLD_AREA_UNDER
         , 90.00 AS SALE_AREA, 90.00 AS SALE_AREA_ON, 0.00 AS SALE_AREA_UNDER
         , 90.00 AS PRE_SALE_BLD_AREA, 90.00 AS PRE_SALE_BLD_AREA_ON
         , 0.00 AS PRE_SALE_BLD_AREA_UBDER, 79.00 AS PRE_SALE_IN_AREA
         , 79.00 AS PRE_SALE_IN_AREA_ON, 0.00 AS PRE_SALE_IN_AREA_UNDER
         , NULL AS ACTUAL_SALE_BLD_AREA, NULL AS ACTUAL_SALE_BLD_AREA_ON
         , NULL AS ACTUAL_SALE_BLD_AREA_UNBER, NULL AS ACTUAL_BLD_AREA
         , NULL AS ACTUAL_BLD_AREA_ON, NULL AS ACTUAL_BLD_AREA_UNDER
         , 10 AS BLD_ROOM_TOTAL, 10 AS CHOOSED_ROOM_TOTAL
      FROM DUAL;*/
    OPEN BLD_ID_TABLE FOR
        SELECT A.ID AS BLD_ID, A.BUILD_NAME AS BLD_NAME, NULL AS BLD_CODE,
               A.PERIOD_NAME AS PROJECT_NAME,
               SUBSTR(D.PRODUCT_TYPE_NAME, 1,
                       INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 1) - 1) AS FIRST_PRODUCT_NAME,
               SUBSTR(D.PRODUCT_TYPE_NAME,
                       INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 1) + 1,
                       INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 2) -
                        INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 1) - 1) AS SECOND_PRODUCT_NAME,
               SUBSTR(D.PRODUCT_TYPE_NAME,
                       DECODE(INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 2), 0, 100,
                               INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 2)) + 1) AS THIRD_PRODUCT_NAME,
               D.PRODUCT_TYPE_NAME AS PRODUCT_FULL_NAME,
               D.PRODUCT_TYPE_ID AS PRODUCT_ID, '否' AS IS_GET_SALE_NAME,
               D.BUILD_AREA AS BLD_AREA,
               D.GROUND_TOTAL_BUILD_AREA AS BLD_AREA_ON,
               D.UNDERGROUND_TOTAL_BUILD_AREA AS BLD_AREA_UNDER,
               D.TOTAL_SALE_AREA AS SALE_AREA,
               D.GROUND_SALE_AREA AS SALE_AREA_ON,
               D.UNDERGROUND_SALE_AREA AS SALE_AREA_UNDER,
               E.PRE_SALE_BLD_AREA, E.PRE_SALE_BLD_AREA_ON,
               E.PRE_SALE_BLD_AREA_UNDER, E.PRE_SALE_IN_AREA,
               E.PRE_SALE_IN_AREA_ON, E.PRE_SALE_IN_AREA_UNDER,
               E.ACTUAL_SALE_BLD_AREA, E.ACTUAL_SALE_BLD_AREA_ON,
               E.ACTUAL_SALE_BLD_AREA_UNDER

        FROM   MDM_BUILD A
        INNER  JOIN MDM_BUILD_PHASE B
        ON     A.ID = B.BUILD_ID
        INNER  JOIN MDM_OBJ_PHASE_INDEX C
        ON     C.OBJ_PHASE_ID = B.ID
        INNER  JOIN (SELECT B1.PRODUCT_TYPE_CODE, A1.*
                     FROM   MDM_OBJ_PHASE_PT_INDEX A1
                     INNER  JOIN MDM_BUILD_PRODUCT_TYPE B1
                     ON     A1.PRODUCT_TYPE_ID = B1.ID) D
        ON     D.OBJ_PHASE_ID = B.ID
        LEFT   JOIN (SELECT A2.BUILDING_ID, A2.BUILDING_NAME, A2.PRODUCT_CODE, SUM(A2.PRE_BLD_AREA) AS PRE_SALE_BLD_AREA,
										SUM(CASE
														WHEN PRODUCT_IS_CW = 0 THEN
														 A2.PRE_BLD_AREA
														ELSE
														 0
												END) AS PRE_SALE_BLD_AREA_ON,
										SUM(CASE
														WHEN PRODUCT_IS_CW = 1 THEN
														 A2.PRE_BLD_AREA
														ELSE
														 0
												END) AS PRE_SALE_BLD_AREA_UNDER, SUM(A2.PRE_IN_AREA) AS PRE_SALE_IN_AREA,
										SUM(CASE
														WHEN PRODUCT_IS_CW = 0 THEN
														 A2.PRE_IN_AREA
														ELSE
														 0
												END) AS PRE_SALE_IN_AREA_ON,
										SUM(CASE
														WHEN A2.PRODUCT_IS_CW = 1 THEN
														 A2.PRE_IN_AREA
														ELSE
														 0
												END) AS PRE_SALE_IN_AREA_UNDER, SUM(A2.ACTUAL_BLD_AREA) AS ACTUAL_SALE_BLD_AREA,
										SUM(CASE
														WHEN A2.PRODUCT_IS_CW = 0 THEN
														 A2.ACTUAL_BLD_AREA
														ELSE
														 0
												END) AS ACTUAL_SALE_BLD_AREA_ON,
										SUM(CASE
														WHEN A2.PRODUCT_IS_CW = 1 THEN
														 A2.ACTUAL_BLD_AREA
														ELSE
														 0
												END) AS ACTUAL_SALE_BLD_AREA_UNDER

                     FROM   MDM_ROOM A2
                     GROUP  BY A2.BUILDING_ID, A2.BUILDING_NAME,
                               A2.PRODUCT_CODE) E
        ON     E.BUILDING_ID = A.ID AND
               E.PRODUCT_CODE = D.PRODUCT_TYPE_CODE
        LEFT   JOIN (SELECT B3.BUILD_ID, B3.ID AS OBJ_PHASE_ID, A3.BUILD_AREA,
                            A3.GROUND_TOTAL_BUILD_AREA,
                            A3.UNDERGROUND_TOTAL_BUILD_AREA
                     FROM   MDM_OBJ_PHASE_PT_INDEX A3
                     INNER  JOIN MDM_BUILD_PHASE B3
                     ON     A3.OBJ_PHASE_ID = B3.ID AND
                            B3.PHASE_NAME = '竣工备案证阶段') F
        ON     F.BUILD_ID = A.ID AND
               F.OBJ_PHASE_ID = B.ID
        WHERE  EXISTS (SELECT 1
                FROM   (SELECT ROW_NUMBER() OVER(PARTITION BY A.ID ORDER BY C.PHASE_ORDER DESC) AS PRANK,
                                A.ID BUILDID, C.PHASE_ORDER PHASEORDER,
                                C.PHASE_NAME PHASENAME, C.ID PHASEID
                         FROM   MDM_BUILD A
                         INNER  JOIN MDM_BUILD_PHASE B
                         ON     A.ID = B.BUILD_ID
                         INNER  JOIN MDM_PHASE C
                         ON     B.PHASE_ID = C.ID) P
                WHERE  P.PRANK = 1 AND
                       P.PHASEID = B.PHASE_ID AND
                       P.BUILDID = A.ID) AND A.BUILD_STATE = 10
                       AND
               (A.PERIOD_ID =''||PROJ_PERIOD_ID||''  OR A.PROJ_ID=''||PROJ_PERIOD_ID||'')
        ORDER  BY BUILD_NAME;


END;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_GET_PROJ_TJ
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_MDM_GET_PROJ_TJ" (
info   OUT         SYS_REFCURSOR
) AS
BEGIN
  OPEN info FOR 
  SELECT 
A.ID,
A.COMPANY_NAME AS COMPANY_NAME,--公司名
A.PROJECT_NAME AS PROJECT_NAME,--项目名
CASE 
  WHEN BUI.BUI_NUM IS NOT NULL AND BUI67.BUI67_NUM IS NOT NULL AND BUI.BUI_NUM = BUI67.BUI67_NUM THEN
    '竣工'
  WHEN PROJ.PROJ_NUM IS NULL THEN 
    '待建'
  WHEN BUI5.BUI5_NUM IS NOT NULL THEN 
    '在售'
  WHEN BUI5.BUI5_NUM IS NULL AND BUI34.BUI34_NUM IS NOT NULL THEN 
    '在建'
  ELSE
    '待建'
END STATUS,--项目状态
A.PROJ_COOPERATE AS PROJ_COOPERATE,--是否操盘
to_char(nvl(PAL.LAND_GET_DATE,A.PROJECT_GET_TIME),'YYYY-MM-DD') AS LAND_GET_DATE --拿地时间
FROM MDM_PROJECT A
LEFT JOIN (
SELECT B.PROJ_ID,COUNT(1) AS PROJ_NUM FROM MDM_PROJECT_PHASE B
WHERE B.PHASE_ORDER > 2
GROUP BY B.PROJ_ID
)PROJ ON A.PROJECT_ORIGINAL_ID = PROJ.PROJ_ID

LEFT JOIN (
SELECT D.PROJ_ID,COUNT(1) AS BUI5_NUM FROM MDM_BUILD_PHASE C
LEFT JOIN MDM_BUILD D ON C.BUILD_ID = D.ID AND D.BUILD_STATE = 10
WHERE C.PHASE_ORDER = 5
GROUP BY D.PROJ_ID)BUI5 ON A.PROJECT_ORIGINAL_ID = BUI5.PROJ_ID

LEFT JOIN (
SELECT D.PROJ_ID,COUNT(1) AS BUI34_NUM FROM MDM_BUILD_PHASE C
LEFT JOIN MDM_BUILD D ON C.BUILD_ID = D.ID AND D.BUILD_STATE = 10
WHERE C.PHASE_ORDER IN (3,4)
GROUP BY D.PROJ_ID)BUI34 ON A.PROJECT_ORIGINAL_ID = BUI34.PROJ_ID

LEFT JOIN (
SELECT E.PROJ_ID,COUNT(1) AS BUI67_NUM FROM （
SELECT D.PROJ_ID,C.BUILD_ID,COUNT(1) AS BUI67_NUM FROM MDM_BUILD_PHASE C
LEFT JOIN MDM_BUILD D ON C.BUILD_ID = D.ID AND D.BUILD_STATE = 10
WHERE C.PHASE_ORDER IN (6,7)
GROUP BY D.PROJ_ID,C.BUILD_ID
)E GROUP BY E.PROJ_ID)BUI67 ON A.PROJECT_ORIGINAL_ID = BUI67.PROJ_ID

LEFT JOIN (
SELECT M.PROJ_ID,COUNT(1) AS BUI_NUM  FROM MDM_BUILD M
GROUP BY M.PROJ_ID
)BUI ON A.PROJECT_ORIGINAL_ID = BUI.PROJ_ID

LEFT JOIN (
SELECT B.PROJECT_ID,B.PROJECT_ORIGINAL_ID,MIN(LAND_GET_DATE) AS LAND_GET_DATE FROM (
SELECT A.ID,A.PROJECT_ID,A.PROJECT_ORIGINAL_ID,MIN(LAND_GET_DATE) AS LAND_GET_DATE FROM MDM_PARCEL A
WHERE A.IS_DELETE = 0 
GROUP BY A.ID,A.PROJECT_ID,A.PROJECT_ORIGINAL_ID
)B GROUP BY B.PROJECT_ID,B.PROJECT_ORIGINAL_ID)PAL ON A.PROJECT_ORIGINAL_ID = PAL.PROJECT_ORIGINAL_ID AND A.ID = PAL.PROJECT_ID
WHERE A.APPROVAL_STATUS = '已审核' order by COMPANY_NAME,PROJECT_CODE;

END P_MDM_GET_PROJ_tj;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_LICENSE_REGISTRATION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_MDM_LICENSE_REGISTRATION" (
    companyid     IN            VARCHAR2,--当前用户公司
    stationid     IN            VARCHAR2,---当前用户的岗位
    deptid        IN            VARCHAR2,---当前用户的部门
    bizcode       IN            VARCHAR2,---权限code
    userid        IN            VARCHAR2,---当前用户id
    projectids   IN            VARCHAR2,---项目名称
    searchparam   IN            VARCHAR2,--筛选条件
    licenseType   IN            VARCHAR2, --证照类型
    selectCompanyId IN          VARCHAR2,--当前选中的公司
    info         OUT           SYS_REFCURSOR,
    pageindex     IN            INT,
    pagesizes     IN            INT,
    total         OUT           INT
) IS
--证照办理登记
--作者：鲜晓勇
--日期：2020/2/09

    v_sql_exec         CLOB;
    v_sql         CLOB;
    v_spid             VARCHAR2(200);---数据验证spid
    v_where            VARCHAR2(4000):=' and 1=1 ';
    v_search           VARCHAR2(4000):=' and 1=1 ';  ---搜素sql
    v_license          VARCHAR2(4000):=' AND 1=1';
    v_project          VARCHAR2(4000);
    v_type             VARCHAR2(4000);
    v_auth_sql         VARCHAR2(4000) :=' where 1=1';
BEGIN
    BEGIN
    --执行数据权限存储过程。拿到零时表id 用户连临时表鉴权
 --调用查询数据权限的存储过程,返回spid
       P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
           STATIONID => stationid,
          DEPTID => deptid,
           COMPANYID => companyid,
          BIZCODE => bizcode,
          DATA_AUTH_SPID => v_spid
      );
    --OPEN tabledata FOR select DISTINCT org_id AS orgid,node.node_name from  TMP_AUTH_LIST tal left join pom_proj_plan_node node on tal.org_id=node.company_id where tal.id = v_spid;
	--	v_auth_sql:='left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') ta on ta.orgid=mp.PROJECT_ID  where ta.orgid is not null ';
        v_auth_sql:=' left join SYS_PROJECT_STAGE projs on mp.PROJECT_ID=projs.id
                            --关联权限表结果
                            left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') org
                            on (case when projs.id is not null then projs.PROJECT_ID else mp.PROJECT_ID end)=org.orgId
                            --左连接权限字段为空表示没有权限
                            where org.orgId is not null ';
    if(selectCompanyId is not null and projectids is null)THEN
     v_where:='AND (case when ps.id  is null then mp.project_id else ps.project_id end) IN(select id from  sys_project where UNIT_ID='''||selectcompanyid||''' )';
    elsif(projectids is not null)THEN
        FOR item IN (
                SELECT
                    regexp_substr(''
                                  || projectids
                                  || '', '[^,]+', 1, ROWNUM) AS id
                FROM
                    dual
                CONNECT BY
                    ROWNUM <= length(''
                                     || projectids
                                     || '') - length(regexp_replace(''
                                                                    || projectids
                                                                    || '', ',', '')) + 1
            ) LOOP
         v_project:=v_project||''''||item.id||''',';
         END LOOP;
         v_project:=substr(v_project,1,length(v_project) -1 );
         v_where:='AND (case when ps.id  is null then mp.project_id else ps.project_id end) IN('||v_project||')';
    elsif(projectids is null and selectCompanyId is null) THEN
--           v_where:=' IN (''aaaaaaa'')';
            v_where:=' AND 1=1 ';
    END if;
    if(licenseType <>'默认')
    THEN
    FOR item IN (
                SELECT
                    regexp_substr(''
                                  || licenseType
                                  || '', '[^,]+', 1, ROWNUM) AS type
                FROM
                    dual
                CONNECT BY
                    ROWNUM <= length(''
                                     || licenseType
                                     || '') - length(regexp_replace(''
                                                                    || licenseType
                                                                    || '', ',', '')) + 1
            ) LOOP
         v_type:=v_type||''''||item.type||''',';
         END LOOP;
         v_type:=substr(v_type,1,length(v_type) -1 );
         v_license:=' AND PERMIT_TYPE IN('||v_type||')';
--       v_license:=' AND PERMIT_TYPE IN ('||licenseType||')';
    elsif licenseType='默认' THEN
      v_license:=' AND 1=1 ';
    END IF;
    if(searchParam is not null)THEN
        v_search:=' AND (mp.PROJECT_NAME like ''%'
                       || searchparam
                       || '%'' or mp.PERMIT_TYPE like ''%'
                       || searchparam
                       || '%'' or mp.PERMIT_NO like ''%'
                       || searchparam
                       || '%'')';
    END IF;
    v_sql := '
    SELECT mp.ID as "id",
        rownum as rowno,
    mp.PROJECT_ID as "projectId",
    mp.PROJECT_NAME  as "projectName",
    mp.PERMIT_TYPE as "permitType",
    mp.PERMIT_NO as "permitNo",
    mp.PERMIT_GET_DATE as "permitGetDate",
    mp.CREATOR_ID as "creatorId",
    mp.CREATOR as "creator",
    mp.CREATED as "created",
    mp.APPROVAL_STATUS as "approvalStatus",
    mp.APPROVER_ID as "approverId",
    mp.APPROVER as "approver",
    mp.APPROVAL_TIME as "approvalTime",
    mp.REMARK as "remark",
    mp.BID_SECTIONG as "bidSectiong",
    mp.CONSTRUCTION_UNTI as "constructionUnti",
    mp.CON_PLAN_PERMIT_NO as "conPlanPermitNo",
    mp.CONSTRUCTION_PERMIT_NO as "constructionPermitNo",
    mp.MODIFIER_ID as "modifierId",
    mp.MODIFIER as "modifier",
    mp.MODIFIED as "modified",
    mp.STAGE_NAME as "stageName",
    mp.BLD_SCOPE as "bldScope",
    mp.BLD_AREA as "bldArea",
    mp.SALE_AREA as "saleArea",
    mp.STAGE_ID as "stageId",
    case  when feedback.id is null
    then ''http://pmd.crccre.cn/mdm/mdm/license-handle/license-handle/registration-detil?permitType=''||mp.permit_type||''&id=''||mp.id||''&cancelType=0&action=mdm_licensehandle_insert&companyId=''||sp.unit_id||''''
    else ''http://pom.crccre.cn/pom/pom/licence-feedback/licence-detail?cancelType=0&permitType=''||mp.permit_type||''&product=''||mp.project_name||''&permitNumber=''||mp.permit_no||''&id=''||mp.id||''''
    end as "openUrl"
    FROM MDM_PERMIT mp
    left join POM_NODE_FEEDBACK feedback on mp.id=feedback.PERMIT_ID
    left join sys_project_stage ps on mp.project_id=ps.id
    left join SYS_PROJECT sp on (case when ps.id is  null then mp.project_id else ps.project_id end)=sp.id
    '||v_auth_sql||'
    '||v_where||'
    and 1=1
 '||v_license||'
 '||v_search||'';

        v_sql_exec := '
select a.* from ( '
                  || v_sql
                  || ' AND rownum <= '
                  || pageindex * pagesizes
                  || ' ) a where a.rowno >= '
                  || pagesizes * ( pageindex - 1 )
                  || '';

    dbms_output.put_line(v_sql_exec);
    ----获取总条数
    EXECUTE IMMEDIATE 'SELECT count(rowno) from('
                      || v_sql
                      || ') a '
    INTO total;
   OPEN info FOR v_sql_exec;
--    open info FOR 'SELECT '''||v_sql_exec||''' from dual';
END;
END P_MDM_LICENSE_REGISTRATION;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_MASTER_DATA_SUM
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_MDM_MASTER_DATA_SUM" 
(
    PHASEID           IN VARCHAR2 , --阶段id
    OBJTPYE           IN VARCHAR2 , --对象类型（项目、宗地、分期、楼栋）
    OBJID             IN OUT VARCHAR2 , --对象id
    PROJCOLLECTSOURCE IN VARCHAR2 --项目数据汇总来源
) AS
    -- 项目主数据汇总-- 作者：杨明-- 日期:2019/11/20
    -- change @author 韩金明 @date 2020-3-30
    periodPhaseId varchar2(36);
    phaseOrder number;
    projectPhaseId varchar(36);
BEGIN
    IF PROJCOLLECTSOURCE = '10' THEN
        --项目汇总数据来源为宗地
        IF OBJTPYE = '10' THEN
            -- 对象为宗地 需要汇总项目数据--汇总对象阶段业态指标表
            begin
                SELECT mpp.ID into projectPhaseId
                FROM MDM_PARCEL mp1
                     LEFT JOIN MDM_PROJECT mp2 ON mp2.PROJECT_ORIGINAL_ID = mp1.PROJECT_ORIGINAL_ID
                     LEFT JOIN MDM_PROJECT_PHASE mpp ON mpp.PROJ_ID = mp2.PROJECT_ORIGINAL_ID AND mp2.APPROVAL_STATUS = '已审核'
                WHERE mp1.PARCEL_ORIGINAL_ID = OBJID AND mpp.PHASE_ID = PHASEID and ROWNUM < 2;
            exception when others then
                projectPhaseId := GET_UUID();
                DBMS_OUTPUT.PUT_LINE('未获取到项目阶段id: [10:10],[' || OBJID || ',' || PHASEID || ']');
            end;
            -- 删除需要修改的业态指标数据
            DELETE FROM MDM_OBJ_PHASE_PT_INDEX B WHERE B.OBJ_PHASE_ID = projectPhaseId AND B.OBJ_TYPE = 0;
            -- 添加新的业态指标数据(全部宗地的)
            insert into MDM_OBJ_PHASE_PT_INDEX
            select
                GET_UUID() AS ID,
                M1.PRODUCT_TYPE_ID AS PRODUCT_TYPE_ID,
                M1.OPERATE_ATTRIBUTE_ID AS OPERATE_ATTRIBUTE_ID,
                M1.OPERATE_ATTRIBUTE_NAME AS OPERATE_ATTRIBUTE_NAME,
                SUM(M1.BUILD_AREA) AS BUILD_AREA,
                SUM(M1.GROUND_CAPACITY_AREA) AS GROUND_CAPACITY_AREA,
                SUM(M1.UNDERGROUND_CAPACITY_AREA) AS UNDERGROUND_CAPACITY_AREA,
                SUM(M1.GROUND_UNCAPACITY_AREA) AS GROUND_UNCAPACITY_AREA,
                SUM(M1.UNDERGROUND_UNCAPACITY_AREA) AS UNDERGROUND_UNCAPACITY_AREA,
                SUM(M1.GROUND_TOTAL_BUILD_AREA) AS GROUND_TOTAL_BUILD_AREA,
                SUM(M1.UNDERGROUND_TOTAL_BUILD_AREA) AS UNDERGROUND_TOTAL_BUILD_AREA,
                SUM(M1.REFUGE_STOREY_AREA) AS REFUGE_STOREY_AREA,
                SUM(M1.MECHANICAL_FLOOR_AREA) AS MECHANICAL_FLOOR_AREA,
                SUM(M1.EMPTY_SPACE_AREA) AS EMPTY_SPACE_AREA,
                SUM(M1.TOWER_BASEMENT_AREA) AS TOWER_BASEMENT_AREA,
                SUM(M1.UNDERGROUND_GARAGE_AREA) AS UNDERGROUND_GARAGE_AREA,
                SUM(M1.STORAGE_AREA) AS STORAGE_AREA,
                SUM(M1.STORAGE_TOTAL) AS STORAGE_TOTAL,
                SUM(M1.TOTAL_SALE_AREA) AS TOTAL_SALE_AREA,
                SUM(M1.GROUND_SALE_AREA) AS GROUND_SALE_AREA,
                SUM(M1.UNDERGROUND_SALE_AREA) AS UNDERGROUND_SALE_AREA,
                SUM(M1.TOTAL_GIVE_AREA) AS TOTAL_GIVE_AREA,
                SUM(M1.GROUND_GIVE_AREA) AS GROUND_GIVE_AREA,
                SUM(M1.UNDERGROUND_GIVE_AREA) AS UNDERGROUND_GIVE_AREA,
                SUM(M1.TOTAL_RESIDENCE) AS TOTAL_RESIDENCE,
                SUM(M1.TOTAL_BUSINESS) AS TOTAL_BUSINESS,
                SUM(M1.GROUND_CARPORT) AS GROUND_CARPORT,
                SUM(M1.RESIDENCE_BOTTOM_CARPORT) AS RESIDENCE_BOTTOM_CARPORT,
                SUM(M1.PARKING_GARAGE_CARPORT) AS PARKING_GARAGE_CARPORT,
                SUM(M1.UNDERGROUND_RFJ_CARPORT) AS UNDERGROUND_RFJ_CARPORT,
                SUM(M1.UNDERGROUND_RJ_CARPORT) AS UNDERGROUND_RJ_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_CARPORT) AS UNDERGROUND_FRFJ_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_CARPORT) AS UNDERGROUND_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_R_SALE_CARPORT) AS UNDERGROUND_R_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_SALE_CARPORT) AS UNDERGROUND_FRFJ_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_SALE_CARPORT) AS UNDERGROUND_FRJ_SALE_CARPORT,
                SUM(M1.CARPORT_TOTAL) AS CARPORT_TOTAL,
                SUM(M1.GROUND_TOTAL_CARPORT) AS GROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_CARPORT) AS UNDERGROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_RJ_CARPORT) AS UNDERGROUND_TOTAL_RJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_FRJ_CARPORT) AS UNDERGROUND_TOTAL_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_SALE_CARPORT) AS UNDERGROUND_TOTAL_SALE_CARPORT,
                aId AS OBJ_PHASE_ID, 0 AS OBJ_TYPE,
                M1.PRODUCT_TYPE_NAME AS PRODUCT_TYPE_NAME,
                M1.PRODUCT_TYPE_JSON AS PRODUCT_TYPE_JSON
            from (
                select
                    distinct moppi.id,
                    moppi.product_type_id,
                    moppi.operate_attribute_id,
                    moppi.operate_attribute_name,
                    moppi.build_area,
                    moppi.ground_capacity_area,
                    moppi.underground_capacity_area,
                    moppi.ground_uncapacity_area,
                    moppi.underground_uncapacity_area,
                    moppi.ground_total_build_area,
                    moppi.underground_total_build_area,
                    moppi.refuge_storey_area,
                    moppi.mechanical_floor_area,
                    moppi.empty_space_area,
                    moppi.tower_basement_area,
                    moppi.underground_garage_area,
                    moppi.storage_area,
                    moppi.storage_total,
                    moppi.total_sale_area,
                    moppi.ground_sale_area,
                    moppi.underground_sale_area,
                    moppi.total_give_area,
                    moppi.ground_give_area,
                    moppi.underground_give_area,
                    moppi.total_residence,
                    moppi.total_business,
                    moppi.ground_carport,
                    moppi.residence_bottom_carport,
                    moppi.parking_garage_carport,
                    moppi.underground_rfj_carport,
                    moppi.underground_rj_carport,
                    moppi.underground_frfj_carport,
                    moppi.underground_frj_carport,
                    moppi.underground_r_sale_carport,
                    moppi.underground_frfj_sale_carport,
                    moppi.underground_frj_sale_carport,
                    moppi.carport_total,
                    moppi.ground_total_carport,
                    moppi.underground_total_carport,
                    moppi.underground_total_rj_carport,
                    moppi.underground_total_frj_carport,
                    moppi.underground_total_sale_carport,
                    moppi.product_type_name,
                    moppi.product_type_json,
                    projectPhaseId as aId
                from MDM_PROJECT_PHASE mpp1
                     left join MDM_PARCEL mp1 on mp1.PROJECT_ID = mpp1.PROJ_ID
                     left join MDM_PARCEL_PHASE mpp2 on mpp2.PHASE_ID = mpp1.PHASE_ID
                    and mpp2.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
                     left join MDM_OBJ_PHASE_PT_INDEX moppi on moppi.OBJ_PHASE_ID = mpp2.ID
                where mpp1.ID=projectPhaseId and OBJ_PHASE_ID is not null
            ) M1 GROUP BY PRODUCT_TYPE_ID, OPERATE_ATTRIBUTE_ID,
                     OPERATE_ATTRIBUTE_NAME,PRODUCT_TYPE_NAME,
                     PRODUCT_TYPE_JSON, aId;
            -- 删除需要修改的业态指标数据
            DELETE FROM MDM_OBJ_PHASE_INDEX B WHERE B.OBJ_PHASE_ID = projectPhaseId AND B.OBJ_TYPE = 0;
            -- 插入汇总后的对象阶段指标表数据
            insert into MDM_OBJ_PHASE_INDEX
            select
                GET_UUID()       AS ID,
                SUM(M1.BUILD_AREA)                     AS BUILD_AREA,
                SUM(M1.GROUND_CAPACITY_AREA)           AS GROUND_CAPACITY_AREA,
                SUM(M1.UNDERGROUND_CAPACITY_AREA)      AS UNDERGROUND_CAPACITY_AREA,
                SUM(M1.GROUND_UNCAPACITY_AREA)         AS GROUND_UNCAPACITY_AREA,
                SUM(M1.UNDERGROUND_UNCAPACITY_AREA)    AS UNDERGROUND_UNCAPACITY_AREA,
                SUM(M1.GROUND_TOTAL_BUILD_AREA)        AS GROUND_TOTAL_BUILD_AREA,
                SUM(M1.UNDERGROUND_TOTAL_BUILD_AREA)   AS UNDERGROUND_TOTAL_BUILD_AREA,
                SUM(M1.REFUGE_STOREY_AREA)             AS REFUGE_STOREY_AREA,
                SUM(M1.MECHANICAL_FLOOR_AREA)          AS MECHANICAL_FLOOR_AREA,
                SUM(M1.EMPTY_SPACE_AREA)               AS EMPTY_SPACE_AREA,
                SUM(M1.TOWER_BASEMENT_AREA)            AS TOWER_BASEMENT_AREA,
                SUM(M1.UNDERGROUND_GARAGE_AREA)        AS UNDERGROUND_GARAGE_AREA,
                SUM(M1.STORAGE_AREA)                   AS STORAGE_AREA,
                SUM(M1.STORAGE_TOTAL)                  AS STORAGE_TOTAL,
                SUM(M1.TOTAL_SALE_AREA)                AS TOTAL_SALE_AREA,
                SUM(M1.GROUND_SALE_AREA)               AS GROUND_SALE_AREA,
                SUM(M1.UNDERGROUND_SALE_AREA)          AS UNDERGROUND_SALE_AREA,
                SUM(M1.TOTAL_GIVE_AREA)                AS TOTAL_GIVE_AREA,
                SUM(M1.GROUND_GIVE_AREA)               AS GROUND_GIVE_AREA,
                SUM(M1.UNDERGROUND_GIVE_AREA)          AS UNDERGROUND_GIVE_AREA,
                SUM(M1.TOTAL_RESIDENCE)                AS TOTAL_RESIDENCE,
                SUM(M1.TOTAL_BUSINESS)                 AS TOTAL_BUSINESS,
                SUM(M1.GROUND_CARPORT)                 AS GROUND_CARPORT,
                SUM(M1.RESIDENCE_BOTTOM_CARPORT)       AS RESIDENCE_BOTTOM_CARPORT,
                SUM(M1.PARKING_GARAGE_CARPORT)         AS PARKING_GARAGE_CARPORT,
                SUM(M1.UNDERGROUND_RFJ_CARPORT)        AS UNDERGROUND_RFJ_CARPORT,
                SUM(M1.UNDERGROUND_RJ_CARPORT)         AS UNDERGROUND_RJ_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_CARPORT)       AS UNDERGROUND_FRFJ_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_CARPORT)        AS UNDERGROUND_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_R_SALE_CARPORT)     AS UNDERGROUND_R_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_SALE_CARPORT)  AS UNDERGROUND_FRFJ_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_SALE_CARPORT)   AS UNDERGROUND_FRJ_SALE_CARPORT,
                SUM(M1.CARPORT_TOTAL)                  AS CARPORT_TOTAL,
                SUM(M1.GROUND_TOTAL_CARPORT)           AS GROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_CARPORT)      AS UNDERGROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_RJ_CARPORT)   AS UNDERGROUND_TOTAL_RJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_FRJ_CARPORT)  AS UNDERGROUND_TOTAL_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_SALE_CARPORT) AS UNDERGROUND_TOTAL_SALE_CARPORT,
                SUM(M1.CONSTRUCTION_LAND_AREA)         AS CONSTRUCTION_LAND_AREA,
                SUM(M1.EXPROPRIATION_GREEN_SPACE_AREA) AS EXPROPRIATION_GREEN_SPACE_AREA,
                SUM(M1.EXPROPRIATION_ROAD_AREA)        AS EXPROPRIATION_ROAD_AREA,
                SUM(M1.OTHER_EXPROPRIATION_AREA)       AS OTHER_EXPROPRIATION_AREA,
                SUM(M1.TOTAL_ROAD_AREA)                AS TOTAL_ROAD_AREA,
                SUM(M1.TOTAL_GREEN_LAND_AREA)          AS TOTAL_GREEN_LAND_AREA,
                SUM(M1.DEMONSTRATION_AREA)             AS DEMONSTRATION_AREA,
                SUM(M1.PLOT_RATIO)                     AS PLOT_RATIO,
                SUM(M1.BUILD_DENSITY)                  AS BUILD_DENSITY,
                SUM(M1.GREENING_RATE)                  AS GREENING_RATE,
                SUM(M1.SALE_RATIO)                     AS SALE_RATIO,
                SUM(M1.GROUND_ENGINE_CARPORT)          AS GROUND_ENGINE_CARPORT,
                SUM(M1.TOTAL_SITE_AREA)                AS TOTAL_SITE_AREA,
                SUM(M1.CONFISCATED_AREA)               AS CONFISCATED_AREA,
                SUM(M1.OVERALL_FLOORAGE_AREA)          AS OVERALL_FLOORAGE_AREA,
                SUM(M1.TOTAL_CAPACITY_AREA)            AS TOTAL_CAPACITY_AREA,
                SUM(M1.CONSTRUCTION_PLOT_RATIO)        AS CONSTRUCTION_PLOT_RATIO,
                SUM(M1.TOTAL_SITE_AREA_PLOT_RATIO)     AS TOTAL_SITE_AREA_PLOT_RATIO,
                SUM(M1.CONSTRUCTION_BUILD_DENSITY)     AS CONSTRUCTION_BUILD_DENSITY,
                SUM(M1.TOTAL_SITE_AREA_BUILD_DENSITY)  AS TOTAL_SITE_AREA_BUILD_DENSITY,
                SUM(M1.CONSTRUCTION_GREENING_RATE)     AS CONSTRUCTION_GREENING_RATE,
                SUM(M1.TOTAL_SITE_AREA_GREENING_RATE)  AS TOTAL_SITE_AREA_GREENING_RATE,
                SUM(M1.CARPORT_RATIO)                  AS CARPORT_RATIO,
                SUM(M1.TOTAL_HOUSEHOLDS)               AS TOTAL_HOUSEHOLDS,
                objPhaseId                             AS OBJ_PHASE_ID,
                '0'                                    AS OBJ_TYPE,
                SUM(M1.JBS_AREA)                       AS JBS_AREA
            from (
                select distinct mopi.*, mpp1.ID objPhaseId
                from MDM_PROJECT_PHASE mpp1
                     left join MDM_PARCEL mp1 on mp1.PROJECT_ID = mpp1.PROJ_ID
                     left join MDM_PARCEL_PHASE mpp2 on mpp2.PHASE_ID = mpp1.PHASE_ID
                    and mpp2.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
                     left join MDM_OBJ_PHASE_INDEX mopi on mopi.OBJ_PHASE_ID = mpp2.ID
                where mpp1.ID = projectPhaseId and OBJ_PHASE_ID is not null
            ) M1
            GROUP BY objPhaseId;
        END IF;
    END IF;
    IF PROJCOLLECTSOURCE = '20' THEN
        --项目汇总数据来源为分期
        IF OBJTPYE = '20' THEN
            begin
                select mpp.ID into projectPhaseId
                from MDM_PERIOD mp
                     left join MDM_PERIOD_VERSION mpv on mp.PERIOD_VERSION_ID = mpv.id
                     left join MDM_PROJECT_PHASE mpp on mpp.PROJ_ID = mpv.PROJECT_ORIGINAL_ID
                where mp.period_original_id=OBJID and mpp.phase_id=PHASEID and ROWNUM < 2;
            exception when others then
                projectPhaseId := GET_UUID();
                DBMS_OUTPUT.PUT_LINE('未获取到项目阶段id: [20:20],[' || OBJID || ',' || PHASEID || ']');
            end;
            -- 分期 需要汇总项目数据--需要删除项目户数表 项目业态表
            -- 删除业态数据表
            DELETE FROM MDM_OBJ_PHASE_PT_INDEX B  WHERE B.OBJ_PHASE_ID = projectPhaseId;
            -- 汇总业态数据
            insert into MDM_OBJ_PHASE_PT_INDEX
            select
                GET_UUID() AS ID,
                M1.PRODUCT_TYPE_ID AS PRODUCT_TYPE_ID,
                M1.OPERATE_ATTRIBUTE_ID AS OPERATE_ATTRIBUTE_ID,
                M1.OPERATE_ATTRIBUTE_NAME  AS OPERATE_ATTRIBUTE_NAME,
                SUM(M1.BUILD_AREA) AS BUILD_AREA,
                SUM(M1.GROUND_CAPACITY_AREA) AS GROUND_CAPACITY_AREA,
                SUM(M1.UNDERGROUND_CAPACITY_AREA) AS UNDERGROUND_CAPACITY_AREA,
                SUM(M1.GROUND_UNCAPACITY_AREA) AS GROUND_UNCAPACITY_AREA,
                SUM(M1.UNDERGROUND_UNCAPACITY_AREA) AS UNDERGROUND_UNCAPACITY_AREA,
                SUM(M1.GROUND_TOTAL_BUILD_AREA) AS GROUND_TOTAL_BUILD_AREA,
                SUM(M1.UNDERGROUND_TOTAL_BUILD_AREA) AS UNDERGROUND_TOTAL_BUILD_AREA,
                SUM(M1.REFUGE_STOREY_AREA) AS REFUGE_STOREY_AREA,
                SUM(M1.MECHANICAL_FLOOR_AREA) AS MECHANICAL_FLOOR_AREA,
                SUM(M1.EMPTY_SPACE_AREA) AS EMPTY_SPACE_AREA,
                SUM(M1.TOWER_BASEMENT_AREA) AS TOWER_BASEMENT_AREA,
                SUM(M1.UNDERGROUND_GARAGE_AREA) AS UNDERGROUND_GARAGE_AREA,
                SUM(M1.STORAGE_AREA) AS STORAGE_AREA,
                SUM(M1.STORAGE_TOTAL) AS STORAGE_TOTAL,
                SUM(M1.TOTAL_SALE_AREA) AS TOTAL_SALE_AREA,
                SUM(M1.GROUND_SALE_AREA) AS GROUND_SALE_AREA,
                SUM(M1.UNDERGROUND_SALE_AREA) AS UNDERGROUND_SALE_AREA,
                SUM(M1.TOTAL_GIVE_AREA) AS TOTAL_GIVE_AREA,
                SUM(M1.GROUND_GIVE_AREA) AS GROUND_GIVE_AREA,
                SUM(M1.UNDERGROUND_GIVE_AREA) AS UNDERGROUND_GIVE_AREA,
                SUM(M1.TOTAL_RESIDENCE) AS TOTAL_RESIDENCE,
                SUM(M1.TOTAL_BUSINESS) AS TOTAL_BUSINESS,
                SUM(M1.GROUND_CARPORT) AS GROUND_CARPORT,
                SUM(M1.RESIDENCE_BOTTOM_CARPORT) AS RESIDENCE_BOTTOM_CARPORT,
                SUM(M1.PARKING_GARAGE_CARPORT) AS PARKING_GARAGE_CARPORT,
                SUM(M1.UNDERGROUND_RFJ_CARPORT) AS UNDERGROUND_RFJ_CARPORT,
                SUM(M1.UNDERGROUND_RJ_CARPORT) AS UNDERGROUND_RJ_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_CARPORT) AS UNDERGROUND_FRFJ_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_CARPORT) AS UNDERGROUND_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_R_SALE_CARPORT) AS UNDERGROUND_R_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_SALE_CARPORT) AS UNDERGROUND_FRFJ_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_SALE_CARPORT) AS UNDERGROUND_FRJ_SALE_CARPORT,
                SUM(M1.CARPORT_TOTAL) AS CARPORT_TOTAL,
                SUM(M1.GROUND_TOTAL_CARPORT) AS GROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_CARPORT) AS UNDERGROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_RJ_CARPORT) AS UNDERGROUND_TOTAL_RJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_FRJ_CARPORT) AS UNDERGROUND_TOTAL_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_SALE_CARPORT) AS UNDERGROUND_TOTAL_SALE_CARPORT,
                hid AS OBJ_PHASE_ID,
                0 AS OBJ_TYPE,
                M1.PRODUCT_TYPE_NAME AS PRODUCT_TYPE_NAME,
                M1.PRODUCT_TYPE_JSON AS PRODUCT_TYPE_JSON
            from (
                select
                    projectPhaseId as hid,
                    PRODUCT_TYPE_ID,
                    OPERATE_ATTRIBUTE_ID,
                    OPERATE_ATTRIBUTE_NAME,
                    BUILD_AREA,
                    GROUND_CAPACITY_AREA,
                    UNDERGROUND_CAPACITY_AREA,
                    GROUND_UNCAPACITY_AREA,
                    UNDERGROUND_UNCAPACITY_AREA,
                    GROUND_TOTAL_BUILD_AREA,
                    UNDERGROUND_TOTAL_BUILD_AREA,
                    REFUGE_STOREY_AREA,
                    MECHANICAL_FLOOR_AREA,
                    EMPTY_SPACE_AREA,
                    TOWER_BASEMENT_AREA,
                    UNDERGROUND_GARAGE_AREA,
                    STORAGE_AREA,
                    STORAGE_TOTAL,
                    TOTAL_SALE_AREA,
                    GROUND_SALE_AREA,
                    UNDERGROUND_SALE_AREA,
                    TOTAL_GIVE_AREA,
                    GROUND_GIVE_AREA,
                    UNDERGROUND_GIVE_AREA,
                    TOTAL_RESIDENCE,
                    TOTAL_BUSINESS,
                    GROUND_CARPORT,
                    RESIDENCE_BOTTOM_CARPORT,
                    PARKING_GARAGE_CARPORT,
                    UNDERGROUND_RFJ_CARPORT,
                    UNDERGROUND_RJ_CARPORT,
                    UNDERGROUND_FRFJ_CARPORT,
                    UNDERGROUND_FRJ_CARPORT,
                    UNDERGROUND_R_SALE_CARPORT,
                    UNDERGROUND_FRFJ_SALE_CARPORT,
                    UNDERGROUND_FRJ_SALE_CARPORT,
                    CARPORT_TOTAL,
                    GROUND_TOTAL_CARPORT,
                    UNDERGROUND_TOTAL_CARPORT,
                    UNDERGROUND_TOTAL_RJ_CARPORT,
                    UNDERGROUND_TOTAL_FRJ_CARPORT,
                    UNDERGROUND_TOTAL_SALE_CARPORT,
                    PRODUCT_TYPE_NAME, PRODUCT_TYPE_JSON
                from MDM_PROJECT_PHASE mpp
                     left join MDM_PERIOD_VERSION mpv on mpp.PROJ_ID = mpv.PROJECT_ORIGINAL_ID
                     left join MDM_PERIOD mp on mp.PERIOD_VERSION_ID = mpv.ID
                     left join MDM_PERIOD_PHASE mpp2 on mpp2.PERIOD_ID = mp.PERIOD_ORIGINAL_ID
                    and mpp.PHASE_ID = mpp2.PHASE_ID
                     left join MDM_OBJ_PHASE_PT_INDEX moppi on moppi.OBJ_PHASE_ID = mpp2.id
                where mpp.id = projectPhaseId and mpp.PHASE_ID = PHASEID and OBJ_PHASE_ID is not null
            ) M1 group by M1.PRODUCT_TYPE_ID, M1.OPERATE_ATTRIBUTE_ID, M1.OPERATE_ATTRIBUTE_NAME,
                     M1.PRODUCT_TYPE_NAME, M1.PRODUCT_TYPE_JSON, hid;
            -- 删除指标数据
            delete from MDM_OBJ_PHASE_INDEX where OBJ_PHASE_ID = projectPhaseId;
            --汇总指标数据
            insert into MDM_OBJ_PHASE_INDEX(
                ID,
                BUILD_AREA,
                GROUND_CAPACITY_AREA,
                UNDERGROUND_CAPACITY_AREA,
                GROUND_UNCAPACITY_AREA,
                UNDERGROUND_UNCAPACITY_AREA,
                GROUND_TOTAL_BUILD_AREA,
                UNDERGROUND_TOTAL_BUILD_AREA,
                REFUGE_STOREY_AREA,
                MECHANICAL_FLOOR_AREA,
                EMPTY_SPACE_AREA,
                TOWER_BASEMENT_AREA,
                UNDERGROUND_GARAGE_AREA,
                STORAGE_AREA,
                STORAGE_TOTAL,
                TOTAL_SALE_AREA,
                GROUND_SALE_AREA,
                UNDERGROUND_SALE_AREA,
                TOTAL_GIVE_AREA,
                GROUND_GIVE_AREA,
                UNDERGROUND_GIVE_AREA,
                TOTAL_RESIDENCE,
                TOTAL_BUSINESS,
                GROUND_CARPORT,
                RESIDENCE_BOTTOM_CARPORT,
                PARKING_GARAGE_CARPORT,
                UNDERGROUND_RFJ_CARPORT,
                UNDERGROUND_RJ_CARPORT,
                UNDERGROUND_FRFJ_CARPORT,
                UNDERGROUND_FRJ_CARPORT,
                UNDERGROUND_R_SALE_CARPORT,
                UNDERGROUND_FRFJ_SALE_CARPORT,
                UNDERGROUND_FRJ_SALE_CARPORT,
                CARPORT_TOTAL,
                GROUND_TOTAL_CARPORT,
                UNDERGROUND_TOTAL_CARPORT,
                UNDERGROUND_TOTAL_RJ_CARPORT,
                UNDERGROUND_TOTAL_FRJ_CARPORT,
                UNDERGROUND_TOTAL_SALE_CARPORT,
                CONSTRUCTION_LAND_AREA,
                EXPROPRIATION_GREEN_SPACE_AREA,
                EXPROPRIATION_ROAD_AREA,
                OTHER_EXPROPRIATION_AREA,
                TOTAL_ROAD_AREA,
                TOTAL_GREEN_LAND_AREA,
                DEMONSTRATION_AREA,
                PLOT_RATIO,
                BUILD_DENSITY,
                GREENING_RATE,
                SALE_RATIO,
                GROUND_ENGINE_CARPORT,
                TOTAL_SITE_AREA,
                CONFISCATED_AREA,
                OVERALL_FLOORAGE_AREA,
                TOTAL_CAPACITY_AREA,
                CONSTRUCTION_PLOT_RATIO,
                TOTAL_SITE_AREA_PLOT_RATIO,
                CONSTRUCTION_BUILD_DENSITY,
                TOTAL_SITE_AREA_BUILD_DENSITY,
                CONSTRUCTION_GREENING_RATE,
                TOTAL_SITE_AREA_GREENING_RATE,
                CARPORT_RATIO,
                TOTAL_HOUSEHOLDS,
                JBS_AREA,
                OBJ_TYPE,
                OBJ_PHASE_ID
            )
            select
                GET_UUID() AS ID,
                SUM(M1.BUILD_AREA) AS BUILD_AREA,
                SUM(M1.GROUND_CAPACITY_AREA) AS GROUND_CAPACITY_AREA,
                SUM(M1.UNDERGROUND_CAPACITY_AREA) AS UNDERGROUND_CAPACITY_AREA,
                SUM(M1.GROUND_UNCAPACITY_AREA) AS GROUND_UNCAPACITY_AREA,
                SUM(M1.UNDERGROUND_UNCAPACITY_AREA) AS UNDERGROUND_UNCAPACITY_AREA,
                SUM(M1.GROUND_TOTAL_BUILD_AREA) AS GROUND_TOTAL_BUILD_AREA,
                SUM(M1.UNDERGROUND_TOTAL_BUILD_AREA) AS UNDERGROUND_TOTAL_BUILD_AREA,
                SUM(M1.REFUGE_STOREY_AREA) AS REFUGE_STOREY_AREA,
                SUM(M1.MECHANICAL_FLOOR_AREA) AS MECHANICAL_FLOOR_AREA,
                SUM(M1.EMPTY_SPACE_AREA) AS EMPTY_SPACE_AREA,
                SUM(M1.TOWER_BASEMENT_AREA) AS TOWER_BASEMENT_AREA,
                SUM(M1.UNDERGROUND_GARAGE_AREA) AS UNDERGROUND_GARAGE_AREA,
                SUM(M1.STORAGE_AREA) AS STORAGE_AREA,
                SUM(M1.STORAGE_TOTAL) AS STORAGE_TOTAL,
                SUM(M1.TOTAL_SALE_AREA) AS TOTAL_SALE_AREA,
                SUM(M1.GROUND_SALE_AREA) AS GROUND_SALE_AREA,
                SUM(M1.UNDERGROUND_SALE_AREA) AS UNDERGROUND_SALE_AREA,
                SUM(M1.TOTAL_GIVE_AREA) AS TOTAL_GIVE_AREA,
                SUM(M1.GROUND_GIVE_AREA) AS GROUND_GIVE_AREA,
                SUM(M1.UNDERGROUND_GIVE_AREA) AS UNDERGROUND_GIVE_AREA,
                SUM(M1.TOTAL_RESIDENCE) AS TOTAL_RESIDENCE,
                SUM(M1.TOTAL_BUSINESS) AS TOTAL_BUSINESS,
                SUM(M1.GROUND_CARPORT) AS GROUND_CARPORT,
                SUM(M1.RESIDENCE_BOTTOM_CARPORT) AS RESIDENCE_BOTTOM_CARPORT,
                SUM(M1.PARKING_GARAGE_CARPORT) AS PARKING_GARAGE_CARPORT,
                SUM(M1.UNDERGROUND_RFJ_CARPORT) AS UNDERGROUND_RFJ_CARPORT,
                SUM(M1.UNDERGROUND_RJ_CARPORT) AS UNDERGROUND_RJ_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_CARPORT) AS UNDERGROUND_FRFJ_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_CARPORT) AS UNDERGROUND_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_R_SALE_CARPORT) AS UNDERGROUND_R_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_SALE_CARPORT) AS UNDERGROUND_FRFJ_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_SALE_CARPORT) AS UNDERGROUND_FRJ_SALE_CARPORT,
                SUM(M1.CARPORT_TOTAL) AS CARPORT_TOTAL,
                SUM(M1.GROUND_TOTAL_CARPORT) AS GROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_CARPORT) AS UNDERGROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_RJ_CARPORT) AS UNDERGROUND_TOTAL_RJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_FRJ_CARPORT) AS UNDERGROUND_TOTAL_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_SALE_CARPORT) AS UNDERGROUND_TOTAL_SALE_CARPORT,
                SUM(M1.CONSTRUCTION_LAND_AREA) AS CONSTRUCTION_LAND_AREA,
                SUM(M1.EXPROPRIATION_GREEN_SPACE_AREA) AS EXPROPRIATION_GREEN_SPACE_AREA,
                SUM(M1.EXPROPRIATION_ROAD_AREA) AS EXPROPRIATION_ROAD_AREA,
                SUM(M1.OTHER_EXPROPRIATION_AREA) AS OTHER_EXPROPRIATION_AREA,
                SUM(M1.TOTAL_ROAD_AREA) AS TOTAL_ROAD_AREA,
                SUM(M1.TOTAL_GREEN_LAND_AREA) AS TOTAL_GREEN_LAND_AREA,
                SUM(M1.DEMONSTRATION_AREA) AS DEMONSTRATION_AREA,
                SUM(M1.PLOT_RATIO) AS PLOT_RATIO,
                SUM(M1.BUILD_DENSITY) AS BUILD_DENSITY,
                SUM(M1.GREENING_RATE) AS GREENING_RATE,
                SUM(M1.SALE_RATIO) AS SALE_RATIO,
                SUM(M1.GROUND_ENGINE_CARPORT) AS GROUND_ENGINE_CARPORT,
                SUM(M1.TOTAL_SITE_AREA) AS TOTAL_SITE_AREA,
                SUM(M1.CONFISCATED_AREA) AS CONFISCATED_AREA,
                SUM(M1.OVERALL_FLOORAGE_AREA) AS OVERALL_FLOORAGE_AREA,
                SUM(M1.TOTAL_CAPACITY_AREA) AS TOTAL_CAPACITY_AREA,
                SUM(M1.CONSTRUCTION_PLOT_RATIO) AS CONSTRUCTION_PLOT_RATIO,
                SUM(M1.TOTAL_SITE_AREA_PLOT_RATIO) AS TOTAL_SITE_AREA_PLOT_RATIO,
                SUM(M1.CONSTRUCTION_BUILD_DENSITY) AS CONSTRUCTION_BUILD_DENSITY,
                SUM(M1.TOTAL_SITE_AREA_BUILD_DENSITY) AS TOTAL_SITE_AREA_BUILD_DENSITY,
                SUM(M1.CONSTRUCTION_GREENING_RATE) AS CONSTRUCTION_GREENING_RATE,
                SUM(M1.TOTAL_SITE_AREA_GREENING_RATE) AS TOTAL_SITE_AREA_GREENING_RATE,
                SUM(M1.CARPORT_RATIO) AS CARPORT_RATIO,
                SUM(M1.TOTAL_HOUSEHOLDS) AS TOTAL_HOUSEHOLDS,
                SUM(M1.JBS_AREA) AS JBS_AREA,
                0 AS OBJ_TYPE,
                hid AS OBJ_PHASE_ID
            from (
                select
                    projectPhaseId as hid,
                    mopi.*
                from MDM_PROJECT_PHASE mpp
                     left join MDM_PERIOD_VERSION mpv on mpp.PROJ_ID = mpv.PROJECT_ORIGINAL_ID
                     left join MDM_PERIOD mp on mp.PERIOD_VERSION_ID = mpv.ID
                     left join MDM_PERIOD_PHASE mpp2 on mpp2.PERIOD_ID = mp.PERIOD_ORIGINAL_ID
                    and mpp.PHASE_ID = mpp2.PHASE_ID
                     left join MDM_OBJ_PHASE_INDEX mopi on mopi.OBJ_PHASE_ID = mpp2.id
                where mpp.id = projectPhaseId and mpp.PHASE_ID = PHASEID and OBJ_PHASE_ID is not null
            ) M1 group by hid;
        END IF;
        --项目汇总数据来源为宗地
        IF OBJTPYE = '30' THEN
            -- 获取分期阶段ID, 阶段号
            begin
                select mpp2.ID, mpp2.PHASE_ORDER into periodPhaseId, phaseOrder
                from MDM_BUILD_PHASE mbp
                     left join MDM_BUILD mb on mb.ID = mbp.BUILD_ID
                     left join MDM_PERIOD mp on mp.PERIOD_ORIGINAL_ID = mb.PERIOD_ID
                     left join MDM_PERIOD_PHASE mpp2 on mpp2.PERIOD_ID = mp.PERIOD_ORIGINAL_ID
                    and mpp2.PHASE_ORDER = mbp.PHASE_ORDER
                where mb.PERIOD_ID = (
                    select  PERIOD_ID from MDM_BUILD where ID =  OBJID
                ) and mbp.PHASE_ID = PHASEID and ROWNUM < 2;
            exception when others then
                DBMS_OUTPUT.PUT_LINE('未获取到分期阶段信息, [20:30], ['||OBJID || ',' || PHASEID || ']');
                periodPhaseId := GET_UUID();
                phaseOrder := -1;
            end;
            -- 删除当前分期业态数据
            DELETE FROM MDM_OBJ_PHASE_PT_INDEX B WHERE B.OBJ_PHASE_ID = periodPhaseId;
            -- 汇总数据到分期
            insert into MDM_OBJ_PHASE_PT_INDEX
            select
                GET_UUID() AS ID,
                M1.PRODUCT_TYPE_ID AS PRODUCT_TYPE_ID,
                M1.OPERATE_ATTRIBUTE_ID AS OPERATE_ATTRIBUTE_ID,
                M1.OPERATE_ATTRIBUTE_NAME AS OPERATE_ATTRIBUTE_NAME,
                SUM(M1.BUILD_AREA) AS BUILD_AREA,
                SUM(M1.GROUND_CAPACITY_AREA) AS GROUND_CAPACITY_AREA,
                SUM(M1.UNDERGROUND_CAPACITY_AREA) AS UNDERGROUND_CAPACITY_AREA,
                SUM(M1.GROUND_UNCAPACITY_AREA) AS GROUND_UNCAPACITY_AREA,
                SUM(M1.UNDERGROUND_UNCAPACITY_AREA) AS UNDERGROUND_UNCAPACITY_AREA,
                SUM(M1.GROUND_TOTAL_BUILD_AREA) AS GROUND_TOTAL_BUILD_AREA,
                SUM(M1.UNDERGROUND_TOTAL_BUILD_AREA) AS UNDERGROUND_TOTAL_BUILD_AREA,
                SUM(M1.REFUGE_STOREY_AREA) AS REFUGE_STOREY_AREA,
                SUM(M1.MECHANICAL_FLOOR_AREA) AS MECHANICAL_FLOOR_AREA,
                SUM(M1.EMPTY_SPACE_AREA) AS EMPTY_SPACE_AREA,
                SUM(M1.TOWER_BASEMENT_AREA) AS TOWER_BASEMENT_AREA,
                SUM(M1.UNDERGROUND_GARAGE_AREA) AS UNDERGROUND_GARAGE_AREA,
                SUM(M1.STORAGE_AREA) AS STORAGE_AREA,
                SUM(M1.STORAGE_TOTAL) AS STORAGE_TOTAL,
                SUM(M1.TOTAL_SALE_AREA) AS TOTAL_SALE_AREA,
                SUM(M1.GROUND_SALE_AREA) AS GROUND_SALE_AREA,
                SUM(M1.UNDERGROUND_SALE_AREA) AS UNDERGROUND_SALE_AREA,
                SUM(M1.TOTAL_GIVE_AREA) AS TOTAL_GIVE_AREA,
                SUM(M1.GROUND_GIVE_AREA) AS GROUND_GIVE_AREA,
                SUM(M1.UNDERGROUND_GIVE_AREA) AS UNDERGROUND_GIVE_AREA,
                SUM(M1.TOTAL_RESIDENCE) AS TOTAL_RESIDENCE,
                SUM(M1.TOTAL_BUSINESS) AS TOTAL_BUSINESS,
                SUM(M1.GROUND_CARPORT) AS GROUND_CARPORT,
                SUM(M1.RESIDENCE_BOTTOM_CARPORT) AS RESIDENCE_BOTTOM_CARPORT,
                SUM(M1.PARKING_GARAGE_CARPORT) AS PARKING_GARAGE_CARPORT,
                SUM(M1.UNDERGROUND_RFJ_CARPORT) AS UNDERGROUND_RFJ_CARPORT,
                SUM(M1.UNDERGROUND_RJ_CARPORT) AS UNDERGROUND_RJ_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_CARPORT) AS UNDERGROUND_FRFJ_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_CARPORT) AS UNDERGROUND_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_R_SALE_CARPORT) AS UNDERGROUND_R_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_SALE_CARPORT) AS UNDERGROUND_FRFJ_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_SALE_CARPORT) AS UNDERGROUND_FRJ_SALE_CARPORT,
                SUM(M1.CARPORT_TOTAL) AS CARPORT_TOTAL,
                SUM(M1.GROUND_TOTAL_CARPORT) AS GROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_CARPORT) AS UNDERGROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_RJ_CARPORT) AS UNDERGROUND_TOTAL_RJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_FRJ_CARPORT) AS UNDERGROUND_TOTAL_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_SALE_CARPORT) AS UNDERGROUND_TOTAL_SALE_CARPORT,
                periodPhaseId AS OBJ_PHASE_ID, 20 AS OBJ_TYPE,
                M1.PRODUCT_TYPE_NAME AS PRODUCT_TYPE_NAME,
                M1.PRODUCT_TYPE_JSON AS PRODUCT_TYPE_JSON
            from (
                select  moppi.*
                from MDM_OBJ_PHASE_PT_INDEX moppi
                     left join MDM_BUILD_PHASE mbp on moppi.OBJ_PHASE_ID = mbp.ID
                     left join MDM_BUILD mb on mb.ID = mbp.BUILD_ID
                where mb.PERIOD_ID = (
                    select distinct PERIOD_ID from MDM_BUILD where ID = OBJID
                ) and mbp.PHASE_ID = PHASEID and OBJ_PHASE_ID is not null
            ) M1 GROUP  BY M1.PRODUCT_TYPE_ID, M1.OPERATE_ATTRIBUTE_ID,
                     M1.OPERATE_ATTRIBUTE_NAME, M1.PRODUCT_TYPE_NAME,
                     M1.PRODUCT_TYPE_JSON, periodPhaseId;
            -- 删除当前(分期)阶段指标数据
            DELETE FROM MDM_OBJ_PHASE_INDEX B WHERE B.OBJ_PHASE_ID = periodPhaseId;
            --汇总对象(到当前分期)阶段指标表
            insert into MDM_OBJ_PHASE_INDEX(
                ID, BUILD_AREA,GROUND_CAPACITY_AREA,UNDERGROUND_CAPACITY_AREA,GROUND_UNCAPACITY_AREA,
                UNDERGROUND_UNCAPACITY_AREA,GROUND_TOTAL_BUILD_AREA,UNDERGROUND_TOTAL_BUILD_AREA, REFUGE_STOREY_AREA,
                MECHANICAL_FLOOR_AREA,EMPTY_SPACE_AREA,TOWER_BASEMENT_AREA,UNDERGROUND_GARAGE_AREA,STORAGE_AREA,
                STORAGE_TOTAL,TOTAL_SALE_AREA,GROUND_SALE_AREA,UNDERGROUND_SALE_AREA,TOTAL_GIVE_AREA,GROUND_GIVE_AREA,
                UNDERGROUND_GIVE_AREA,TOTAL_RESIDENCE,TOTAL_BUSINESS,GROUND_CARPORT,RESIDENCE_BOTTOM_CARPORT,
                PARKING_GARAGE_CARPORT,UNDERGROUND_RFJ_CARPORT,UNDERGROUND_RJ_CARPORT,UNDERGROUND_FRFJ_CARPORT,
                UNDERGROUND_FRJ_CARPORT,UNDERGROUND_R_SALE_CARPORT,UNDERGROUND_FRFJ_SALE_CARPORT,
                UNDERGROUND_FRJ_SALE_CARPORT,CARPORT_TOTAL,GROUND_TOTAL_CARPORT,UNDERGROUND_TOTAL_CARPORT,
                UNDERGROUND_TOTAL_RJ_CARPORT,UNDERGROUND_TOTAL_FRJ_CARPORT,UNDERGROUND_TOTAL_SALE_CARPORT,SALE_RATIO,
                GROUND_ENGINE_CARPORT,OVERALL_FLOORAGE_AREA,TOTAL_CAPACITY_AREA,CARPORT_RATIO,TOTAL_HOUSEHOLDS,
                OBJ_PHASE_ID,OBJ_TYPE,JBS_AREA
            )
            SELECT
                GET_UUID() AS ID,
                SUM(M1.BUILD_AREA) AS BUILD_AREA,
                SUM(M1.GROUND_CAPACITY_AREA) AS GROUND_CAPACITY_AREA,
                SUM(M1.UNDERGROUND_CAPACITY_AREA) AS UNDERGROUND_CAPACITY_AREA,
                SUM(M1.GROUND_UNCAPACITY_AREA) AS GROUND_UNCAPACITY_AREA,
                SUM(M1.UNDERGROUND_UNCAPACITY_AREA) AS UNDERGROUND_UNCAPACITY_AREA,
                SUM(M1.GROUND_TOTAL_BUILD_AREA) AS GROUND_TOTAL_BUILD_AREA,
                SUM(M1.UNDERGROUND_TOTAL_BUILD_AREA) AS UNDERGROUND_TOTAL_BUILD_AREA,
                SUM(M1.REFUGE_STOREY_AREA) AS REFUGE_STOREY_AREA,
                SUM(M1.MECHANICAL_FLOOR_AREA) AS MECHANICAL_FLOOR_AREA,
                SUM(M1.EMPTY_SPACE_AREA) AS EMPTY_SPACE_AREA,
                SUM(M1.TOWER_BASEMENT_AREA) AS TOWER_BASEMENT_AREA,
                SUM(M1.UNDERGROUND_GARAGE_AREA) AS UNDERGROUND_GARAGE_AREA,
                SUM(M1.STORAGE_AREA) AS STORAGE_AREA,
                SUM(M1.STORAGE_TOTAL) AS STORAGE_TOTAL,
                SUM(M1.TOTAL_SALE_AREA) AS TOTAL_SALE_AREA,
                SUM(M1.GROUND_SALE_AREA) AS GROUND_SALE_AREA,
                SUM(M1.UNDERGROUND_SALE_AREA) AS UNDERGROUND_SALE_AREA,
                SUM(M1.TOTAL_GIVE_AREA) AS TOTAL_GIVE_AREA,
                SUM(M1.GROUND_GIVE_AREA) AS GROUND_GIVE_AREA,
                SUM(M1.UNDERGROUND_GIVE_AREA) AS UNDERGROUND_GIVE_AREA,
                SUM(M1.TOTAL_RESIDENCE) AS TOTAL_RESIDENCE,
                SUM(M1.TOTAL_BUSINESS) AS TOTAL_BUSINESS,
                SUM(M1.GROUND_CARPORT) AS GROUND_CARPORT,
                SUM(M1.RESIDENCE_BOTTOM_CARPORT) AS RESIDENCE_BOTTOM_CARPORT,
                SUM(M1.PARKING_GARAGE_CARPORT) AS PARKING_GARAGE_CARPORT,
                SUM(M1.UNDERGROUND_RFJ_CARPORT) AS UNDERGROUND_RFJ_CARPORT,
                SUM(M1.UNDERGROUND_RJ_CARPORT) AS UNDERGROUND_RJ_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_CARPORT) AS UNDERGROUND_FRFJ_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_CARPORT) AS UNDERGROUND_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_R_SALE_CARPORT) AS UNDERGROUND_R_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_SALE_CARPORT) AS UNDERGROUND_FRFJ_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_SALE_CARPORT) AS UNDERGROUND_FRJ_SALE_CARPORT,
                SUM(M1.CARPORT_TOTAL) AS CARPORT_TOTAL,
                SUM(M1.GROUND_TOTAL_CARPORT) AS GROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_CARPORT) AS UNDERGROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_RJ_CARPORT) AS UNDERGROUND_TOTAL_RJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_FRJ_CARPORT) AS UNDERGROUND_TOTAL_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_SALE_CARPORT) AS UNDERGROUND_TOTAL_SALE_CARPORT,
                SUM(M1.SALE_RATIO) AS SALE_RATIO,
                SUM(M1.GROUND_ENGINE_CARPORT) AS GROUND_ENGINE_CARPORT,
                SUM(M1.OVERALL_FLOORAGE_AREA) AS OVERALL_FLOORAGE_AREA,
                SUM(M1.TOTAL_CAPACITY_AREA) AS TOTAL_CAPACITY_AREA,
                SUM(M1.CARPORT_RATIO) AS CARPORT_RATIO,
                SUM(M1.TOTAL_HOUSEHOLDS) AS TOTAL_HOUSEHOLDS,
                objPhaseId AS OBJ_PHASE_ID,
                20 AS OBJ_TYPE,
                SUM(M1.JBS_AREA) AS JBS_AREA
            from (
                select  mopi.*, periodPhaseId objPhaseId
                from MDM_OBJ_PHASE_INDEX mopi
                     left join MDM_BUILD_PHASE mbp on mopi.OBJ_PHASE_ID = mbp.ID
                     left join MDM_BUILD mb on mb.ID = mbp.BUILD_ID
                where mb.PERIOD_ID = (
                    select distinct PERIOD_ID from MDM_BUILD where ID = OBJID
                ) and mbp.PHASE_ID = PHASEID and OBJ_PHASE_ID is not null
            ) M1 GROUP BY objPhaseId;
            -- 获取项目ID;
            begin
                select mpp3.ID into projectPhaseId
                from MDM_PERIOD_PHASE mpp1
                     left join MDM_PERIOD mp1 on mp1.ID = mpp1.PERIOD_ID
                     left join MDM_PERIOD mp2 on mp2.PERIOD_VERSION_ID = mp1.PERIOD_VERSION_ID
                     left join MDM_PERIOD_PHASE mpp2 on mpp2.PERIOD_ID = mp2.ID
                    and mpp1.PHASE_ORDER = mpp2.PHASE_ORDER
                     left join MDM_PERIOD_VERSION mpv on mpv.ID = mp2.PERIOD_VERSION_ID
                     left join MDM_PROJECT_PHASE mpp3 on mpp3.PROJ_ID = mpv.PROJECT_ORIGINAL_ID
                where mpp1.ID = periodPhaseId and mpp3.PHASE_ORDER = phaseOrder and ROWNUM < 2;
            exception when others then
                DBMS_OUTPUT.PUT_LINE('未获取到项目阶段信息, [20:30], [' || OBJID || ',' || PHASEID || ']');
                projectPhaseId := GET_UUID();
            end;
            -- 删除项目业态指标数据
            DELETE FROM MDM_OBJ_PHASE_PT_INDEX where OBJ_PHASE_ID = projectPhaseId;
            -- 添加业态指标数据(从分期合并到项目)
            insert into MDM_OBJ_PHASE_PT_INDEX
            select
                GET_UUID() AS ID,
                M1.PRODUCT_TYPE_ID AS PRODUCT_TYPE_ID,
                M1.OPERATE_ATTRIBUTE_ID AS OPERATE_ATTRIBUTE_ID,
                M1.OPERATE_ATTRIBUTE_NAME AS OPERATE_ATTRIBUTE_NAME,
                SUM(M1.BUILD_AREA) AS BUILD_AREA,
                SUM(M1.GROUND_CAPACITY_AREA) AS GROUND_CAPACITY_AREA,
                SUM(M1.UNDERGROUND_CAPACITY_AREA) AS UNDERGROUND_CAPACITY_AREA,
                SUM(M1.GROUND_UNCAPACITY_AREA) AS GROUND_UNCAPACITY_AREA,
                SUM(M1.UNDERGROUND_UNCAPACITY_AREA) AS UNDERGROUND_UNCAPACITY_AREA,
                SUM(M1.GROUND_TOTAL_BUILD_AREA) AS GROUND_TOTAL_BUILD_AREA,
                SUM(M1.UNDERGROUND_TOTAL_BUILD_AREA) AS UNDERGROUND_TOTAL_BUILD_AREA,
                SUM(M1.REFUGE_STOREY_AREA) AS REFUGE_STOREY_AREA,
                SUM(M1.MECHANICAL_FLOOR_AREA) AS MECHANICAL_FLOOR_AREA,
                SUM(M1.EMPTY_SPACE_AREA) AS EMPTY_SPACE_AREA,
                SUM(M1.TOWER_BASEMENT_AREA) AS TOWER_BASEMENT_AREA,
                SUM(M1.UNDERGROUND_GARAGE_AREA) AS UNDERGROUND_GARAGE_AREA,
                SUM(M1.STORAGE_AREA) AS STORAGE_AREA,
                SUM(M1.STORAGE_TOTAL) AS STORAGE_TOTAL,
                SUM(M1.TOTAL_SALE_AREA) AS TOTAL_SALE_AREA,
                SUM(M1.GROUND_SALE_AREA) AS GROUND_SALE_AREA,
                SUM(M1.UNDERGROUND_SALE_AREA) AS UNDERGROUND_SALE_AREA,
                SUM(M1.TOTAL_GIVE_AREA) AS TOTAL_GIVE_AREA,
                SUM(M1.GROUND_GIVE_AREA) AS GROUND_GIVE_AREA,
                SUM(M1.UNDERGROUND_GIVE_AREA) AS UNDERGROUND_GIVE_AREA,
                SUM(M1.TOTAL_RESIDENCE) AS TOTAL_RESIDENCE,
                SUM(M1.TOTAL_BUSINESS) AS TOTAL_BUSINESS,
                SUM(M1.GROUND_CARPORT) AS GROUND_CARPORT,
                SUM(M1.RESIDENCE_BOTTOM_CARPORT) AS RESIDENCE_BOTTOM_CARPORT,
                SUM(M1.PARKING_GARAGE_CARPORT) AS PARKING_GARAGE_CARPORT,
                SUM(M1.UNDERGROUND_RFJ_CARPORT) AS UNDERGROUND_RFJ_CARPORT,
                SUM(M1.UNDERGROUND_RJ_CARPORT) AS UNDERGROUND_RJ_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_CARPORT) AS UNDERGROUND_FRFJ_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_CARPORT) AS UNDERGROUND_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_R_SALE_CARPORT) AS UNDERGROUND_R_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_SALE_CARPORT) AS UNDERGROUND_FRFJ_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_SALE_CARPORT) AS UNDERGROUND_FRJ_SALE_CARPORT,
                SUM(M1.CARPORT_TOTAL) AS CARPORT_TOTAL,
                SUM(M1.GROUND_TOTAL_CARPORT) AS GROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_CARPORT) AS UNDERGROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_RJ_CARPORT) AS UNDERGROUND_TOTAL_RJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_FRJ_CARPORT) AS UNDERGROUND_TOTAL_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_SALE_CARPORT) AS UNDERGROUND_TOTAL_SALE_CARPORT,
                objPhaseId AS OBJ_PHASE_ID, 0 AS OBJ_TYPE,
                M1.PRODUCT_TYPE_NAME AS PRODUCT_TYPE_NAME,
                M1.PRODUCT_TYPE_JSON AS PRODUCT_TYPE_JSON
            from (
                select moppi.*, projectPhaseId objPhaseId
                from MDM_PERIOD_PHASE mpp1
                     left join MDM_PERIOD mp1 on mp1.ID = mpp1.PERIOD_ID
                     left join MDM_PERIOD mp2 on mp2.PERIOD_VERSION_ID = mp1.PERIOD_VERSION_ID
                     left join MDM_PERIOD_PHASE mpp2 on mpp2.PERIOD_ID = mp2.ID
                    and mpp1.PHASE_ORDER = mpp2.PHASE_ORDER
                     left join MDM_OBJ_PHASE_PT_INDEX moppi on moppi.OBJ_PHASE_ID = mpp2.ID
                where mpp1.ID = periodPhaseId and OBJ_PHASE_ID is not null
            )M1 group by M1.PRODUCT_TYPE_ID, M1.OPERATE_ATTRIBUTE_ID,
                    M1.OPERATE_ATTRIBUTE_NAME, M1.PRODUCT_TYPE_NAME,
                    M1.PRODUCT_TYPE_JSON, objPhaseId;
            -- 删除项目阶段指标表
            DELETE FROM MDM_OBJ_PHASE_INDEX where OBJ_PHASE_ID = projectPhaseId;
            -- 添加阶段指标表(从分期到项目)
            insert into MDM_OBJ_PHASE_INDEX(
                ID, BUILD_AREA,GROUND_CAPACITY_AREA,UNDERGROUND_CAPACITY_AREA,GROUND_UNCAPACITY_AREA,
                UNDERGROUND_UNCAPACITY_AREA,GROUND_TOTAL_BUILD_AREA,UNDERGROUND_TOTAL_BUILD_AREA, REFUGE_STOREY_AREA,
                MECHANICAL_FLOOR_AREA,EMPTY_SPACE_AREA,TOWER_BASEMENT_AREA,UNDERGROUND_GARAGE_AREA,STORAGE_AREA,
                STORAGE_TOTAL,TOTAL_SALE_AREA,GROUND_SALE_AREA,UNDERGROUND_SALE_AREA,TOTAL_GIVE_AREA,GROUND_GIVE_AREA,
                UNDERGROUND_GIVE_AREA,TOTAL_RESIDENCE,TOTAL_BUSINESS,GROUND_CARPORT,RESIDENCE_BOTTOM_CARPORT,
                PARKING_GARAGE_CARPORT,UNDERGROUND_RFJ_CARPORT,UNDERGROUND_RJ_CARPORT,UNDERGROUND_FRFJ_CARPORT,
                UNDERGROUND_FRJ_CARPORT,UNDERGROUND_R_SALE_CARPORT,UNDERGROUND_FRFJ_SALE_CARPORT,
                UNDERGROUND_FRJ_SALE_CARPORT,CARPORT_TOTAL,GROUND_TOTAL_CARPORT,UNDERGROUND_TOTAL_CARPORT,
                UNDERGROUND_TOTAL_RJ_CARPORT,UNDERGROUND_TOTAL_FRJ_CARPORT,UNDERGROUND_TOTAL_SALE_CARPORT,SALE_RATIO,
                GROUND_ENGINE_CARPORT,OVERALL_FLOORAGE_AREA,TOTAL_CAPACITY_AREA,CARPORT_RATIO,TOTAL_HOUSEHOLDS,
                OBJ_PHASE_ID,OBJ_TYPE,JBS_AREA
            )
            SELECT
                GET_UUID() AS ID,
                SUM(M1.BUILD_AREA) AS BUILD_AREA,
                SUM(M1.GROUND_CAPACITY_AREA) AS GROUND_CAPACITY_AREA,
                SUM(M1.UNDERGROUND_CAPACITY_AREA) AS UNDERGROUND_CAPACITY_AREA,
                SUM(M1.GROUND_UNCAPACITY_AREA) AS GROUND_UNCAPACITY_AREA,
                SUM(M1.UNDERGROUND_UNCAPACITY_AREA) AS UNDERGROUND_UNCAPACITY_AREA,
                SUM(M1.GROUND_TOTAL_BUILD_AREA) AS GROUND_TOTAL_BUILD_AREA,
                SUM(M1.UNDERGROUND_TOTAL_BUILD_AREA) AS UNDERGROUND_TOTAL_BUILD_AREA,
                SUM(M1.REFUGE_STOREY_AREA) AS REFUGE_STOREY_AREA,
                SUM(M1.MECHANICAL_FLOOR_AREA) AS MECHANICAL_FLOOR_AREA,
                SUM(M1.EMPTY_SPACE_AREA) AS EMPTY_SPACE_AREA,
                SUM(M1.TOWER_BASEMENT_AREA) AS TOWER_BASEMENT_AREA,
                SUM(M1.UNDERGROUND_GARAGE_AREA) AS UNDERGROUND_GARAGE_AREA,
                SUM(M1.STORAGE_AREA) AS STORAGE_AREA,
                SUM(M1.STORAGE_TOTAL) AS STORAGE_TOTAL,
                SUM(M1.TOTAL_SALE_AREA) AS TOTAL_SALE_AREA,
                SUM(M1.GROUND_SALE_AREA) AS GROUND_SALE_AREA,
                SUM(M1.UNDERGROUND_SALE_AREA) AS UNDERGROUND_SALE_AREA,
                SUM(M1.TOTAL_GIVE_AREA) AS TOTAL_GIVE_AREA,
                SUM(M1.GROUND_GIVE_AREA) AS GROUND_GIVE_AREA,
                SUM(M1.UNDERGROUND_GIVE_AREA) AS UNDERGROUND_GIVE_AREA,
                SUM(M1.TOTAL_RESIDENCE) AS TOTAL_RESIDENCE,
                SUM(M1.TOTAL_BUSINESS) AS TOTAL_BUSINESS,
                SUM(M1.GROUND_CARPORT) AS GROUND_CARPORT,
                SUM(M1.RESIDENCE_BOTTOM_CARPORT) AS RESIDENCE_BOTTOM_CARPORT,
                SUM(M1.PARKING_GARAGE_CARPORT) AS PARKING_GARAGE_CARPORT,
                SUM(M1.UNDERGROUND_RFJ_CARPORT) AS UNDERGROUND_RFJ_CARPORT,
                SUM(M1.UNDERGROUND_RJ_CARPORT) AS UNDERGROUND_RJ_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_CARPORT) AS UNDERGROUND_FRFJ_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_CARPORT) AS UNDERGROUND_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_R_SALE_CARPORT) AS UNDERGROUND_R_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_SALE_CARPORT) AS UNDERGROUND_FRFJ_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_SALE_CARPORT) AS UNDERGROUND_FRJ_SALE_CARPORT,
                SUM(M1.CARPORT_TOTAL) AS CARPORT_TOTAL,
                SUM(M1.GROUND_TOTAL_CARPORT) AS GROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_CARPORT) AS UNDERGROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_RJ_CARPORT) AS UNDERGROUND_TOTAL_RJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_FRJ_CARPORT) AS UNDERGROUND_TOTAL_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_SALE_CARPORT) AS UNDERGROUND_TOTAL_SALE_CARPORT,
                SUM(M1.SALE_RATIO) AS SALE_RATIO,
                SUM(M1.GROUND_ENGINE_CARPORT) AS GROUND_ENGINE_CARPORT,
                SUM(M1.OVERALL_FLOORAGE_AREA) AS OVERALL_FLOORAGE_AREA,
                SUM(M1.TOTAL_CAPACITY_AREA) AS TOTAL_CAPACITY_AREA,
                SUM(M1.CARPORT_RATIO) AS CARPORT_RATIO,
                SUM(M1.TOTAL_HOUSEHOLDS) AS TOTAL_HOUSEHOLDS,
                objPhaseId AS OBJ_PHASE_ID,
                0 AS OBJ_TYPE,
                SUM(M1.JBS_AREA) AS JBS_AREA
            from (
                select moppi.*, projectPhaseId objPhaseId
                from MDM_PERIOD_PHASE mpp1
                     left join MDM_PERIOD mp1 on mp1.ID = mpp1.PERIOD_ID
                     left join MDM_PERIOD mp2 on mp2.PERIOD_VERSION_ID = mp1.PERIOD_VERSION_ID
                     left join MDM_PERIOD_PHASE mpp2 on mpp2.PERIOD_ID = mp2.ID
                    and mpp1.PHASE_ORDER = mpp2.PHASE_ORDER
                     left join MDM_OBJ_PHASE_INDEX moppi on moppi.OBJ_PHASE_ID = mpp2.ID
                where mpp1.ID = periodPhaseId and OBJ_PHASE_ID is not null
            ) M1 GROUP BY objPhaseId;
        END IF;
    END IF;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PERIOD_APPROVAL_CB
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_MDM_PERIOD_APPROVAL_CB" (
    id IN VARCHAR2--分期版本表MDM_PERIOD_VERSION 主键id
) 
	--分期审批回调，1、创建动态货值相关版本数据//王传科实现 20191208
	--作者：陈丽
	--日期：2019/12/08	
 AS
BEGIN
    NULL;
END p_mdm_period_approval_cb;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PERMIT_APPROVAL_CB
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_MDM_PERMIT_APPROVAL_CB" 
(
  permitId IN VARCHAR2 
) AS 
--证照审批回调，1、更新证照涉及楼栋数据到楼栋表
--作者：鲜晓勇
--日期：2020/04/13
    permitType VARCHAR2(200);--证照类型
    permitNo   VARCHAR(200);--证照编号
BEGIN
    --查询证照类型和证照编号
    select permit_type,permit_no into permitType,permitNo from mdm_permit where id=''||permitId||'';
        update mdm_build set IS_GET_CON_PLAN_PERMIT = case when ''||permitType||''='规划许可证' then '1' else null end,
                   GET_CON_PLAN_PERMIT_DATE = case when ''||permitType||''='规划许可证' then TO_CHAR(SYSDATE(),'YY-MM-DD') else null end,
                   CON_PLAN_PERMIT_NO = case when ''||permitType||''='规划许可证' then ''||permitNo||'' else null end,
                   CON_PLAN_PERMIT_ID = case when ''||permitType||''='规划许可证' then ''||permitId||'' else null end,

                   IS_GET_CONSTRCUTION_PERMIT = case when ''||permitType||''='施工许可证' then '1' else null end,
                   GET_CONSTRCUTION_PERMIT_DATE = case when ''||permitType||''='施工许可证' then TO_CHAR(SYSDATE(),'YY-MM-DD') else null end,
                   CONSTRUCTION_PERMIT_NO = case when ''||permitType||''='施工许可证' then ''||permitNo||'' else null end,
                   CONSTRACUTION_PERMIT_ID = case when ''||permitType||''='施工许可证' then ''||permitId||'' else null end,

                   IS_GET_PRE_SALE_PERMIT = case when ''||permitType||''='预售许可证' then '1' else null end,
                   GET_PRE_SALE_PERMIT_DATE = case when ''||permitType||''='预售许可证' then TO_CHAR(SYSDATE(),'YY-MM-DD') else null end,
                   PRE_SALE_PERMIT_NO = case when ''||permitType||''='预售许可证' then ''||permitNo||'' else null end,
                   PRE_SALE_PERMIT_ID = case when ''||permitType||''='预售许可证' then ''||permitId||'' else null end,

                   IS_GET_COMPLETED_PERMIT = case when ''||permitType||''='竣工备案证' then '1' else null end,
                   GET_COMPLETED_PERMIT_DATE = case when ''||permitType||''='竣工备案证' then TO_CHAR(SYSDATE(),'YY-MM-DD') else null end,
                   GET_COMPLETED_PERMIT_NO = case when ''||permitType||''='竣工备案证' then ''||permitNo||'' else null end,
                   COMPLETED_PERMIT_ID = case when ''||permitType||''='竣工备案证' then ''||permitId||'' else null end
                   where id in(select pb.bld_id from mdm_permit_bld pb inner join mdm_permit pt on pb.permit_id=pt.id where pt.id=''||permitid||'' and pt.APPROVAL_STATUS='已审核');
                   commit;
END p_mdm_permit_approval_cb;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PHASE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_MDM_PHASE" 
(
       projId  IN VARCHAR2 --项目id
    ,phaseinfo  OUT SYS_REFCURSOR --解析后阶段
) AS
    --阶段解析
    --作者：陈丽
    --日期：2019/12/07
             CREATE_PHASE_APPROVAL_OBJ_sql          clob;
             CREATE_PHASE_OBJ_sql          clob;
             FORM_TYPE_NAME_sql            clob;
             FORM_GROUP_CODE_sql           clob;
             MAINTAIN_BUILDING_OBJ_sql       clob;  ---楼栋维护 sql
             exec_sql          clob;
BEGIN
    --1.拼接查询语句
        FOR item IN (select id,CREATE_PHASE_OBJ,CREATE_PHASE_APPROVAL_OBJ,FORM_TYPE_NAME,FORM_GROUP_CODE,MAINTAIN_BUILDING_OBJ from MDM_PHASE)
        LOOP
          CREATE_PHASE_OBJ_sql:=CREATE_PHASE_OBJ_sql||'select a.*,'''||item.id||''' as id from ('||item.CREATE_PHASE_OBJ||') a   union all ';
          CREATE_PHASE_APPROVAL_OBJ_sql:=CREATE_PHASE_APPROVAL_OBJ_sql||'select a.*,'''||item.id||''' as id from ('||item.CREATE_PHASE_APPROVAL_OBJ||') a   union all ';
          FORM_TYPE_NAME_sql:=FORM_TYPE_NAME_sql||'select a.*,'''||item.id||''' as id from ('||item.FORM_TYPE_NAME||') a   union all ';
          FORM_GROUP_CODE_sql:=FORM_GROUP_CODE_sql||'select a.*,'''||item.id||''' as id from ('||item.FORM_GROUP_CODE||') a   union all ';
          MAINTAIN_BUILDING_OBJ_sql:=MAINTAIN_BUILDING_OBJ_sql||'select a.*,'''||item.id||''' as id from ('||item.MAINTAIN_BUILDING_OBJ||') a   union all ';
        END LOOP;
    --2.解析 替换关键字
 CREATE_PHASE_OBJ_sql:= rtrim(replace(CREATE_PHASE_OBJ_sql, '{项目ID}', ''||projId||''),'union all ');
 CREATE_PHASE_APPROVAL_OBJ_sql:= rtrim(replace(CREATE_PHASE_APPROVAL_OBJ_sql, '{项目ID}', ''||projId||''),'union all ');
 FORM_TYPE_NAME_sql:= rtrim(replace(FORM_TYPE_NAME_sql, '{项目ID}', ''||projId||''),'union all ');
 FORM_GROUP_CODE_sql:= rtrim(replace(FORM_GROUP_CODE_sql, '{项目ID}', ''||projId||''),'union all ');
 MAINTAIN_BUILDING_OBJ_sql:= rtrim(replace(MAINTAIN_BUILDING_OBJ_sql, '{项目ID}', ''||projId||''),'union all ');
exec_sql:='
select MDM_PHASE.id as "id",
    phase_name as "phaseName",
    phase_code as "phaseCode",
    phase_order as "phaseOrder",
    phase_end_obj as "phaseEndObj",
    proj_collect_source as "projCollectSource",
    is_maintain_building as "isMaintainBuilding",
    CREATE_PHASE."objType" as "createPhaseObj",
    CREATE_PHASE_APPROVAL."objType" as "createPhaseApprovalObj",
    FORM_TYPE_NAME."objType" as "formTypeName",
    FORM_GROUP_CODE."objType" as "formGroupCode",
    MAINTAIN_BUILDING."objType" as "maintainBuildingObj"
    from MDM_PHASE
    left join('||CREATE_PHASE_OBJ_sql||' a) CREATE_PHASE
    on MDM_PHASE.id=CREATE_PHASE.id
    left join ('||CREATE_PHASE_APPROVAL_OBJ_sql||' a)CREATE_PHASE_APPROVAL
    on MDM_PHASE.id=CREATE_PHASE_APPROVAL.id
    left join('||FORM_TYPE_NAME_sql||' a) FORM_TYPE_NAME
    on MDM_PHASE.id=FORM_TYPE_NAME.id
    left join('||FORM_GROUP_CODE_sql||' a) FORM_GROUP_CODE
    on MDM_PHASE.id=FORM_GROUP_CODE.id
     left join('||MAINTAIN_BUILDING_OBJ_sql||' a) MAINTAIN_BUILDING
    on MDM_PHASE.id=MAINTAIN_BUILDING.id
    order by phase_code
    '
;
DBMS_OUTPUT.PUT_LINE('INFO = ' || exec_sql);

  open phaseinfo FOR exec_sql;
END P_MDM_PHASE;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PHASE_APPROVAL_CB
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_MDM_PHASE_APPROVAL_CB" (
    id IN VARCHAR2--主数据各阶段对象实例表 MDM_PROJECT_PHASE，MDM_PARCEL_PHASE，MDM_PERIOD_PHASE，MDM_BUILD_PHASE 表 主键id
) 
	--阶段审批接口回调，1、创建动态货值相关版本数据//王传科实现 20191208
	--作者：陈丽
	--日期：2019/12/08	
 AS
BEGIN
    NULL;
END p_mdm_phase_approval_cb;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PROJ_MAINTENANCE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_MDM_PROJ_MAINTENANCE" (
    userid         IN             VARCHAR2 --当前用户id
    ,
    stationid      IN             VARCHAR2 --当前用户岗位id
    ,
    departmentid   IN             VARCHAR2 --当前用户部门id
    ,
    companyid      IN             VARCHAR2 --当前用户公司id
    ,
    projtreeinfo   OUT            SYS_REFCURSOR--项目树
) AS
--项目维护与分期维护数据源
--作者：陈丽
--日期：2019/11/13
--输入变量：用户ID
    data_auth_spid   VARCHAR2(200);
    bizcode          VARCHAR2(200);
BEGIN
    bizcode := 'MDM.XMZSJ.01';
    p_sys_get_company_tree_spid(userid => userid, stationid => stationid, deptid => departmentid, companyid => companyid, bizcode
    => bizcode, data_auth_spid => data_auth_spid);

    OPEN projtreeinfo FOR SELECT
                             orgid      "orgId",
                             orgname    AS "orgName",
                             projcode   AS "projCodeas",
                             orgtype    AS "orgType",
                             parentid   AS "parentId",
                             1 AS "levelRank",
                             cityname   AS "cityName"
                         FROM
                             (
                                 SELECT DISTINCT
                                     org_id       AS orgid,
                                     org_name     AS orgname,
                                     REPLACE(order_code, '.' ,'') AS projcode,
                                     org_type     AS orgtype,
                                     parent_id    AS parentid,
                                     is_company   AS iscompany,
                                     '' AS cityname,
                                     order_code   AS ordercode
                                 FROM
                                                tmp_company_tree
                                 WHERE
                                     id = data_auth_spid
                                 UNION ALL
                                 SELECT
                                     project_original_id   AS projid,
                                     project_name          AS projname,
                                     project_code          AS projcode,
                                     '10' AS datatype,
                                     company_id            AS parentid,
                                     1 AS levelrank,
                                     city_name             AS cityname,
                                     project_code          AS ordercode
                                 FROM
                                     mdm_project  left
                                     JOIN (
                                         SELECT
                                             MIN(project_version) AS v,
                                             project_original_id AS o
                                         FROM
                                             mdm_project
                                         GROUP BY
                                             project_original_id 
                                     ) vv ON mdm_project.project_version = vv.v
                                             AND mdm_project.project_original_id = vv.o AND mdm_project.company_id IN(
                                              SELECT DISTINCT
                                     org_id       AS orgid
                                 FROM
                                                tmp_company_tree
                                 WHERE
                                     id = data_auth_spid
                                             )
                                 WHERE
                                     vv.v IS NOT NULL 
                             ) t 
                         ORDER BY
                             projcode;

END p_mdm_proj_maintenance;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PROJ_MAINTENANCE_PHASE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_MDM_PROJ_MAINTENANCE_PHASE" (
    userid         IN             VARCHAR2 --当前用户id
    ,
    stationid      IN             VARCHAR2 --当前用户岗位id
    ,
    departmentid   IN             VARCHAR2 --当前用户部门id
    ,
    companyid      IN             VARCHAR2 --当前用户公司id
    ,
    projtreeinfo   OUT            SYS_REFCURSOR--项目树
) AS
--项目维护阶段维护数据源。
--作者：陈丽
--日期：2019/11/13
    data_auth_spid   VARCHAR2(200);
    bizcode          VARCHAR2(200);
BEGIN
    bizcode := 'MDM.XMZSJ.01';
    p_sys_get_company_tree_spid(userid => userid, stationid => stationid, deptid => departmentid, companyid => companyid, bizcode
    => bizcode, data_auth_spid => data_auth_spid);

    OPEN projtreeinfo FOR SELECT
                             project_original_id   "orgId",--组织id
                             project_name          AS "orgName",--组织名称名称
                             proj_phase            AS "projPhase",--项目阶段
                             phase_id              AS "phaseId",--阶段id
                             proj_phase_id         AS "projPhaseId",--项目阶段id
                             org_type              AS "orgType",--组织类型 0公司，1项目
                             lower(parent_id) AS "parentId",--父级id
                             nvl(total_site_area, 0) AS "totalSiteArea",--总用地面积
                             nvl(overall_floorage_area, 0) AS "overallFloorageArea",--总建组面积
                             nvl(total_sale_area, 0) AS "totalSalableArea",--总可售面积
                             nvl(total_capacity_area, 0) AS "totalCapacityArea",--计容面积
                             is_exist_proj_phase   AS "isExistProjPhase",--存在项目阶段
                             "ordercode"
                         FROM
                             (
                                 SELECT
                                     mdm_project.project_original_id,
                                     project_name,
                                     mdm_phase.phase_name   AS proj_phase,
                                     phase.phase_id,
                                     phase.id               AS proj_phase_id,
                                     10 AS org_type,
                                     CASE
                                         WHEN phase.phase_id IS NULL THEN
                                             0
                                         ELSE
                                             1
                                     END AS is_exist_proj_phase,
                                     company_id             AS parent_id,
                                     mdm_obj_phase_index.total_site_area,
                                     mdm_obj_phase_index.overall_floorage_area,
                                     mdm_obj_phase_index.total_sale_area,
                                     mdm_obj_phase_index.total_capacity_area,
                                    project_code as "ordercode"
                                 FROM
                                     mdm_project left
                                     JOIN (
                                         SELECT
                                             t1.id,
                                             t1.phase_id,
                                             t1.proj_id,
                                             t2.phase_order
                                         FROM
                                             mdm_project_phase t1
                                             LEFT JOIN (
                                                 SELECT
                                                     proj_id,
                                                     MAX(phase_order) AS phase_order
                                                 FROM
                                                     mdm_project_phase
                                                 GROUP BY
                                                     proj_id
                                             ) t2 ON t1.proj_id = t2.proj_id
                                                     AND t1.phase_order = t2.phase_order
                                         WHERE
                                             t2.phase_order IS NOT NULL
                                     ) phase ON mdm_project.project_original_id = phase.proj_id
                                     LEFT JOIN mdm_phase ON phase.phase_id = mdm_phase.id
                                     LEFT JOIN mdm_obj_phase_index ON phase.id = mdm_obj_phase_index.obj_phase_id
                                                                      AND mdm_obj_phase_index.obj_type = 0
                                 WHERE
                                     approval_status = '已审核'
                                     and mdm_project.company_id in
                                     (
                                     SELECT DISTINCT
                                    org_id   
                                FROM

                                              tmp_company_tree
                                 WHERE
                                     id = data_auth_spid
--                                     SELECT DISTINCT
--                                     org_id   
--                                 FROM
--                                              tmp_company_tree
--                                 WHERE
--                                     id = data_auth_spid
--                                     AND org_id IN (
--                                         SELECT DISTINCT
--                                             id
--                                         FROM
--                                             sys_business_unit
--                                         START WITH
--                                             id IN (
--                                                 SELECT
--                                                     id
--                                                 FROM
--                                                     (
--                                                         SELECT
--                                                             unit_id AS id
--                                                         FROM
--                                                             sys_project
--                                                         UNION
--                                                         SELECT
--                                                             subordinate_company_id AS id
--                                                         FROM
--                                                             cdb_feasible_project_config
--                                                     ) ds
--                                             )
--                                         CONNECT BY
--                                             PRIOR parent_id = id
--                                     )
                                     )
                                 UNION ALL

                                  SELECT DISTINCT
                                     org_id       AS orgid,
                                     org_name     AS orgname,
                                    -- order_code AS projcode,
                                      '' AS proj_phase,
                                     '' AS phase_id,
                                     '' AS proj_phase_id,
                                     0     AS orgtype,
                                     NULL is_exist_proj_phase,
                                     parent_id,
                                     0 AS "totalSiteArea",
                                     0 AS "overallFloorageArea",
                                     0 AS "totalSalableArea",
                                     0 AS "totalCapacityArea",
                                   order_code as "ordercode"
                                 FROM
                                              tmp_company_tree
                                 WHERE
                                     id = data_auth_spid
--                                     AND org_id IN (
--                                         SELECT DISTINCT
--                                             id
--                                         FROM
--                                             sys_business_unit
--                                         START WITH
--                                             id IN (
--                                                 SELECT
--                                                     id
--                                                 FROM
--                                                     (
--                                                         SELECT
--                                                             unit_id AS id
--                                                         FROM
--                                                             sys_project
--                                                         UNION
--                                                         SELECT
--                                                             subordinate_company_id AS id
--                                                         FROM
--                                                             cdb_feasible_project_config
--                                                     ) ds
--                                             )
--                                         CONNECT BY
--                                             PRIOR parent_id = id
--                                     )
                             ) t order by "ordercode";

END p_mdm_proj_maintenance_phase;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PROJ_SITUATION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_MDM_PROJ_SITUATION" (
   userid         IN             VARCHAR2 --当前用户id
    ,
    stationid      IN             VARCHAR2 --当前用户岗位id
    ,
    departmentid   IN             VARCHAR2 --当前用户部门id
    ,
    companyid      IN             VARCHAR2 --当前用户公司id
    ,
projtreeinfo   OUT            SYS_REFCURSOR)
AS
--主数据首页，主数据概况。
--作者：陈丽
--日期：2019/11/13
    data_auth_spid   VARCHAR2(200);
    bizcode          VARCHAR2(200);
BEGIN
    --权限查询
    bizcode := 'MDM.XMZSJ.01';
    p_sys_get_company_tree_spid(userid => userid, stationid => stationid, deptid => departmentid, companyid => companyid, bizcode
    => bizcode, data_auth_spid => data_auth_spid);
OPEN projtreeinfo FOR
SELECT DISTINCT
                                     org_id       AS id,
                                     org_name     AS orgName,
                                     tt.parent_id as parentsId,
                                      b.nums       as projTotal,
                                      nvl(c.salesArea,0) salesArea,
                                      nvl(c.salesCarport,0) salesCarport
                                 FROM
                                              tmp_company_tree tt left join(
                                              SELECT
                                                      count( b.company_id ) nums,
                                                      b.company_id
                                                    FROM
                                                      mdm_project b
                                                    WHERE
                                                      b.APPROVAL_STATUS = '已审核'
                                                    GROUP BY
                                                      b.company_id
                                                      ) b ON tt.org_id = b.company_id
                                                    left join (SELECT
                                                      company_id,
                                                      sum(mdm_obj_phase_index.total_sale_area) salesArea,
                                                      sum(mdm_obj_phase_index.underground_total_sale_carport) salesCarport
                                                    FROM
                                                      mdm_project
                                                        LEFT JOIN (
                                                    SELECT
                                                      t1.id,
                                                      t1.phase_id,
                                                      t1.proj_id,
                                                      t2.phase_order
                                                    FROM
                                                      mdm_project_phase t1
                                                      LEFT JOIN ( SELECT proj_id, MAX( phase_order ) AS phase_order FROM mdm_project_phase GROUP BY proj_id ) t2 ON t1.proj_id = t2.proj_id
                                                      AND t1.phase_order = t2.phase_order
                                                    WHERE
                                                      t2.phase_order IS NOT NULL
                                                      ) phase ON mdm_project.project_original_id = phase.proj_id
                                                        LEFT JOIN mdm_phase ON phase.phase_id = mdm_phase.id
                                                        LEFT JOIN mdm_obj_phase_index ON phase.id = mdm_obj_phase_index.obj_phase_id
                                                          AND mdm_obj_phase_index.obj_type = 0
                                                        WHERE
                                                          approval_status = '已审核'
                                                          GROUP BY company_id) c on c.company_id = tt.org_id
                                                        WHERE
                                                          tt.org_type = 0
                                                          AND ( tt.org_id != '000100000000000000000000000000' AND tt.org_id != '000200000000000000000000000000' ) 
                                     AND
                                     tt.id = data_auth_spid
                                     AND tt.org_id IN (
                                         SELECT DISTINCT
                                             id
                                         FROM
                                             sys_business_unit
                                         START WITH
                                             id IN (
                                                 SELECT
                                                     id
                                                 FROM
                                                     (
                                                         SELECT
                                                             unit_id AS id
                                                         FROM
                                                             sys_project
                                                         UNION
                                                         SELECT
                                                             subordinate_company_id AS id
                                                         FROM
                                                             cdb_feasible_project_config
                                                     ) ds
                                             )
                                         CONNECT BY
                                             PRIOR parent_id = id
                                     );
       --                                                   ORDER BY CAST(tt.order_code AS int);
END p_mdm_proj_situation;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PROJECT_APPROVAL_CB
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_MDM_PROJECT_APPROVAL_CB" (
    id IN VARCHAR2--项目表MDM_PROJECT 主键id
)
	--项目审批回调，1、创建动态货值相关版本数据//王传科实现 20191208
	--作者：陈丽
	--日期：2019/12/08
 AS
    approvalStatus varchar2(50);
BEGIN
    select APPROVAL_STATUS into approvalStatus from MDM_PROJECT mp where mp.id = 'cfe08c43-d7fc-470e-a1cc-9c4e9d0381eb';
    INSERT INTO TEST(ID, PROJ_NAME, PROJ_ID, APPROVAL_STATUS, APPROVAL_TIME)
    values (GET_UUID(), '项目回调测试', id, approvalStatus, sysdate);
END p_mdm_project_approval_cb;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_PROJECT_FROM_SERIES
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_MDM_PROJECT_FROM_SERIES" is
begin
    update MDM_PROJECT mp
    set mp.SERIES_RATIO=(
        select t.seriesRatio from T_MDM_PROJECT_SERIES_RATIO t
        where t.projectId = mp.ID
    ) where EXISTS(select 1 from T_MDM_PROJECT_SERIES_RATIO t where t.projectId = mp.ID);
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_ROOM_FROM_SMS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_MDM_ROOM_FROM_SMS" IS
   synchDate Date ;
BEGIN
--从销售系统抓取房间数据 mdm_room_from_sms 中间表数据转换到mdm_room_bak 目标表的存储过程
--作者：鲜晓勇
--日期：2020/01/13
	---初始化同步时间 
    synchDate:=sysdate();
       MERGE INTO mdm_room_bak USING (
       --数据处理  中间表中出现 多条相同数据时，去重，默认去id最大的哪条，可修改
	     -- mdm_room_from_sms 从销售系统接口抓取房间数据中间表中，存在字段 返回“无”的情况，和mdm_room_bak 目标表的数据类型无法对应。先将处理为将“无”的数据转换为 null 可修改
                                    SELECT
                                        *
                                    FROM
                                        mdm_room_from_sms x
                                    WHERE
                                        x.rowid = (
                                            SELECT
                                                MAX(y.rowid)
                                            FROM
                                                mdm_room_from_sms y
                                            WHERE  
                                                x.room_id = y.room_id
                                        )
                                )
        mdm_room_from_sms ON ( mdm_room_bak.id = mdm_room_from_sms.room_id )
        WHEN MATCHED THEN
        --修改 将中间表数据update 到 room_bak 表
        UPDATE SET
            mdm_room_bak.room_name = mdm_room_from_sms.room_name,  mdm_room_bak.room_code = CASE mdm_room_from_sms.room_code  WHEN '无' THEN  NULL  ELSE  mdm_room_from_sms.room_code END,
            mdm_room_bak.product_code=case mdm_room_from_sms.pt_code when '无' THEN  NULL ELSE mdm_room_from_sms.pt_code END,
            mdm_room_bak.product_name=case mdm_room_from_sms.pt_name when '无' THEN  NULL ELSE mdm_room_from_sms.pt_name END,
            mdm_room_bak.product_is_cw= CASE WHEN mdm_room_from_sms.pt_is_cw = '无' OR mdm_room_from_sms.pt_is_cw = '否' THEN 0 ELSE 1 END,
            mdm_room_bak.project_id=case mdm_room_from_sms.project_id when '无' THEN  NULL ELSE mdm_room_from_sms.project_id END,
            mdm_room_bak.project_code=case mdm_room_from_sms.project_code when '无' THEN  NULL ELSE mdm_room_from_sms.project_code END,
            mdm_room_bak.project_name=case mdm_room_from_sms.project_name when '无' THEN  NULL ELSE mdm_room_from_sms.project_name END,
            mdm_room_bak.building_id=case mdm_room_from_sms.building_id when '无' THEN  NULL ELSE mdm_room_from_sms.building_id END,
            mdm_room_bak.building_name=case mdm_room_from_sms.building_name when '无' THEN  NULL ELSE mdm_room_from_sms.building_name END,
            mdm_room_bak.unit_id=case mdm_room_from_sms.unit_id when '无' THEN  NULL ELSE mdm_room_from_sms.unit_id END,
            mdm_room_bak.unit_name=case mdm_room_from_sms.unit_name when '无' THEN  NULL ELSE mdm_room_from_sms.unit_name END,
            mdm_room_bak.floor_id=case mdm_room_from_sms.floor_id when '无' THEN  NULL ELSE mdm_room_from_sms.floor_id END,
            mdm_room_bak.floor_name=case mdm_room_from_sms.floor_name when '无' THEN  NULL ELSE mdm_room_from_sms.floor_name END,
            mdm_room_bak.sale_state=case mdm_room_from_sms.sale_state when '无' THEN  NULL ELSE mdm_room_from_sms.sale_state END,
            mdm_room_bak.pre_bld_area=case mdm_room_from_sms.build_area_yc when '无' THEN  NULL ELSE mdm_room_from_sms.build_area_yc END,
            mdm_room_bak.pre_in_area=case mdm_room_from_sms.inside_area_yc when '无' THEN  NULL ELSE mdm_room_from_sms.inside_area_yc END,
            mdm_room_bak.actual_bld_area=case mdm_room_from_sms.build_area_sc when '无' THEN  NULL ELSE mdm_room_from_sms.build_area_sc END,
            mdm_room_bak.actual_in_area=case mdm_room_from_sms.inside_area_sc when '无' THEN  NULL ELSE mdm_room_from_sms.inside_area_sc END,
            mdm_room_bak.new_bld_area=case mdm_room_from_sms.build_area_new when '无' THEN  NULL ELSE mdm_room_from_sms.build_area_new END,
            mdm_room_bak.new_in_area=case mdm_room_from_sms.inside_area_new when '无' THEN  NULL ELSE mdm_room_from_sms.inside_area_new END,
            mdm_room_bak.pre_sell_permit_id=case mdm_room_from_sms.preselling_card_id when '无' THEN  NULL ELSE mdm_room_from_sms.preselling_card_id END,
            mdm_room_bak.pre_sell_permit_no=case mdm_room_from_sms.preselling_card_code when '无' THEN  NULL ELSE mdm_room_from_sms.preselling_card_code END,
            mdm_room_bak.pre_sell_permit_date=case when (select is_date(''||mdm_room_from_sms.preselling_card_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.preselling_card_date, 'yyyy-MM-dd')END,
            mdm_room_bak.base_price=case mdm_room_from_sms.base_price when '无' THEN  NULL ELSE mdm_room_from_sms.base_price END,
            mdm_room_bak.base_total=case mdm_room_from_sms.base_total when '无' THEN  NULL ELSE mdm_room_from_sms.base_total END,
            mdm_room_bak.base_total_area_type=case mdm_room_from_sms.base_total_area_type when '无' THEN  NULL ELSE mdm_room_from_sms.base_total_area_type END,
            mdm_room_bak.bz_price=case mdm_room_from_sms.bz_price when '无' THEN  NULL ELSE mdm_room_from_sms.bz_price END,
            mdm_room_bak.bz_total=case mdm_room_from_sms.bz_total when '无' THEN  NULL ELSE mdm_room_from_sms.bz_total END,
            mdm_room_bak.bz_total_area_type=case mdm_room_from_sms.bz_total_area_type when '无' THEN  NULL ELSE mdm_room_from_sms.bz_total_area_type END,
            mdm_room_bak.trade_price=case mdm_room_from_sms.trade_price when '无' THEN  NULL ELSE mdm_room_from_sms.trade_price END,
            mdm_room_bak.trade_total=case mdm_room_from_sms.trade_total when '无' THEN  NULL ELSE mdm_room_from_sms.trade_total END,
            mdm_room_bak.trade_total_area_type=case mdm_room_from_sms.trade_total_area_type when '无' THEN  NULL ELSE mdm_room_from_sms.trade_total_area_type END,
            mdm_room_bak.trade_contract_date=case when (select is_date(''||mdm_room_from_sms.trade_contract_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.trade_contract_date, 'yyyy-MM-dd')END,
            mdm_room_bak.is_area_bc= CASE WHEN mdm_room_from_sms.is_area_bc = '无' OR mdm_room_from_sms.is_area_bc = '否' THEN 0 ELSE 1 END,
            mdm_room_bak.pre_after_bc_total=case mdm_room_from_sms.pre_after_bc_total when '无' THEN  NULL ELSE mdm_room_from_sms.pre_after_bc_total END,
            mdm_room_bak.actual_after_bc_total=case mdm_room_from_sms.fact_after_bc_total when '无' THEN  NULL ELSE mdm_room_from_sms.fact_after_bc_total END,
            mdm_room_bak.is_transfer= CASE WHEN mdm_room_from_sms.is_transfer = '无' OR mdm_room_from_sms.is_transfer = '否' THEN 0 ELSE 1 END,
            mdm_room_bak.pre_transfer_date=case when (select is_date(''||mdm_room_from_sms.pre_transfer_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.pre_transfer_date, 'yyyy-MM-dd')END,
            mdm_room_bak.actual_transfer_date=case when (select is_date(''||mdm_room_from_sms.fact_transfer_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.fact_transfer_date, 'yyyy-MM-dd')END,
            mdm_room_bak.is_indirect=CASE WHEN mdm_room_from_sms.is_indirect = '无' OR mdm_room_from_sms.is_indirect = '否' THEN 0 ELSE 1 END,
            mdm_room_bak.actual_indirect_date=case when (select is_date(''||mdm_room_from_sms.fact_indirect_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.fact_indirect_date, 'yyyy-MM-dd')END,
            mdm_room_bak.actual_indirect_total=case mdm_room_from_sms.fact_indirect_area when '无' THEN  NULL ELSE mdm_room_from_sms.fact_indirect_area END,
            mdm_room_bak.actual_indirect_area=case mdm_room_from_sms.fact_indirect_area when '无' THEN  NULL ELSE mdm_room_from_sms.fact_indirect_area END,
            mdm_room_bak.SYNCH_DATE=''||synchDate||''            
            WHEN NOT MATCHED THEN 
            --新增 将中间表数据 insert 到room_bak 表
       INSERT ( mdm_room_bak.id, mdm_room_bak.room_name, mdm_room_bak.room_code, mdm_room_bak.product_code,
        mdm_room_bak.product_name,
        mdm_room_bak.product_is_cw,
        mdm_room_bak.project_id,
        mdm_room_bak.project_code,
        mdm_room_bak.project_name,
        mdm_room_bak.building_id,
        mdm_room_bak.building_name,
        mdm_room_bak.unit_id,
        mdm_room_bak.unit_name,
        mdm_room_bak.floor_id,
        mdm_room_bak.floor_name,
        mdm_room_bak.sale_state,
        mdm_room_bak.pre_bld_area,
        mdm_room_bak.pre_in_area,
        mdm_room_bak.actual_bld_area,
        mdm_room_bak.actual_in_area,
        mdm_room_bak.new_bld_area,
        mdm_room_bak.new_in_area,
        mdm_room_bak.pre_sell_permit_id,
        mdm_room_bak.pre_sell_permit_no,
        mdm_room_bak.pre_sell_permit_date,
        mdm_room_bak.base_price,
        mdm_room_bak.base_total,
        mdm_room_bak.base_total_area_type,
        mdm_room_bak.bz_price,
        mdm_room_bak.bz_total,
        mdm_room_bak.bz_total_area_type,
        mdm_room_bak.trade_price,
        mdm_room_bak.trade_total,
        mdm_room_bak.trade_total_area_type,
        mdm_room_bak.trade_contract_date,
        mdm_room_bak.is_area_bc,
        mdm_room_bak.pre_after_bc_total,
        mdm_room_bak.actual_after_bc_total,
        mdm_room_bak.is_transfer,
        mdm_room_bak.pre_transfer_date,
        mdm_room_bak.actual_transfer_date,
        mdm_room_bak.is_indirect,
        mdm_room_bak.actual_indirect_date,
        mdm_room_bak.actual_indirect_total,
        mdm_room_bak.actual_indirect_area,
        mdm_room_bak.SYNCH_DATE
    ) values (mdm_room_from_sms.room_id,
       case mdm_room_from_sms.room_name when '无' THEN NULL ELSE mdm_room_from_sms.room_name END,
       case mdm_room_from_sms.room_code when '无' THEN NULL ELSE mdm_room_from_sms.room_code END,
       case mdm_room_from_sms.pt_code when '无' THEN NULL ELSE mdm_room_from_sms.pt_code END,
       case mdm_room_from_sms.pt_name when '无' THEN NULL ELSE mdm_room_from_sms.pt_name END,
       case WHEN mdm_room_from_sms.pt_is_cw='无' OR mdm_room_from_sms.pt_is_cw = '否' THEN 0 ELSE 1 END,
       case mdm_room_from_sms.project_id when '无' THEN NULL ELSE mdm_room_from_sms.project_id END,
       case mdm_room_from_sms.project_code when '无' THEN NULL ELSE mdm_room_from_sms.project_code END,
       case mdm_room_from_sms.project_name when '无' THEN NULL ELSE mdm_room_from_sms.project_name END,
       case mdm_room_from_sms.building_id when '无' THEN NULL ELSE mdm_room_from_sms.building_id END,
       case mdm_room_from_sms.building_name when '无' THEN NULL ELSE mdm_room_from_sms.building_name END,
       case mdm_room_from_sms.unit_id when '无' THEN NULL ELSE mdm_room_from_sms.unit_id END,
       case mdm_room_from_sms.unit_name when '无' THEN NULL ELSE mdm_room_from_sms.unit_name END,
       case mdm_room_from_sms.floor_id when '无' THEN NULL ELSE mdm_room_from_sms.floor_id END,
       case mdm_room_from_sms.floor_name when '无' THEN NULL ELSE mdm_room_from_sms.floor_name END,
       case mdm_room_from_sms.sale_state when '无' THEN NULL ELSE mdm_room_from_sms.sale_state END,
       case mdm_room_from_sms.build_area_yc when '无' THEN NULL ELSE mdm_room_from_sms.build_area_yc END,
       case mdm_room_from_sms.inside_area_yc when '无' THEN NULL ELSE mdm_room_from_sms.inside_area_yc END,
       case mdm_room_from_sms.build_area_sc when '无' THEN NULL ELSE mdm_room_from_sms.build_area_sc END,
       case mdm_room_from_sms.inside_area_sc when '无' THEN NULL ELSE mdm_room_from_sms.inside_area_sc END,
       case mdm_room_from_sms.build_area_new when '无' THEN NULL ELSE mdm_room_from_sms.build_area_new END,
       case mdm_room_from_sms.inside_area_new when '无' THEN NULL ELSE mdm_room_from_sms.inside_area_new END,
       case mdm_room_from_sms.preselling_card_id when '无' THEN NULL ELSE mdm_room_from_sms.preselling_card_id END,
       case mdm_room_from_sms.preselling_card_code when '无' THEN NULL ELSE mdm_room_from_sms.preselling_card_code END,
       case when (select is_date(''||mdm_room_from_sms.preselling_card_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.preselling_card_date, 'yyyy-MM-dd')END,  
       case mdm_room_from_sms.base_price when '无' THEN NULL ELSE mdm_room_from_sms.base_price END,
       case mdm_room_from_sms.base_total when '无' THEN NULL ELSE mdm_room_from_sms.base_total END,
       case mdm_room_from_sms.base_total_area_type when '无' THEN NULL ELSE mdm_room_from_sms.base_total_area_type END,
       case mdm_room_from_sms.bz_price when '无' THEN NULL ELSE mdm_room_from_sms.bz_price END,
       case mdm_room_from_sms.bz_total when '无' THEN NULL ELSE mdm_room_from_sms.bz_total END,
       case mdm_room_from_sms.bz_total_area_type when '无' THEN NULL ELSE mdm_room_from_sms.bz_total_area_type END,
       case mdm_room_from_sms.trade_price when '无' THEN NULL ELSE mdm_room_from_sms.trade_price END,
       case mdm_room_from_sms.trade_total when '无' THEN NULL ELSE mdm_room_from_sms.trade_total END,
       case mdm_room_from_sms.trade_total_area_type when '无' THEN NULL ELSE mdm_room_from_sms.trade_total_area_type END,
        case when (select is_date(''||mdm_room_from_sms.trade_contract_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.trade_contract_date, 'yyyy-MM-dd')END,  
       case WHEN mdm_room_from_sms.is_area_bc='无' OR mdm_room_from_sms.is_area_bc = '否' THEN 0 ELSE 1 END,
       case mdm_room_from_sms.pre_after_bc_total when '无' THEN NULL ELSE mdm_room_from_sms.pre_after_bc_total END,
       case mdm_room_from_sms.fact_after_bc_total when '无' THEN NULL ELSE mdm_room_from_sms.fact_after_bc_total END,
       case WHEN mdm_room_from_sms.is_transfer='无' OR mdm_room_from_sms.is_transfer = '否' THEN 0 ELSE 1 END,    
       case when (select is_date(''||mdm_room_from_sms.pre_transfer_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.pre_transfer_date, 'yyyy-MM-dd')END,  
       case when (select is_date(''||mdm_room_from_sms.fact_transfer_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.fact_transfer_date, 'yyyy-MM-dd')END,
       case WHEN mdm_room_from_sms.is_indirect='无' OR mdm_room_from_sms.is_indirect = '否' THEN 0 ELSE 1 END,
       case when (select is_date(''||mdm_room_from_sms.fact_indirect_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.fact_indirect_date, 'yyyy-MM-dd')END,
       case mdm_room_from_sms.fact_indirect_total when '无' THEN NULL ELSE mdm_room_from_sms.fact_indirect_total END,
       case mdm_room_from_sms.fact_indirect_area when '无' THEN NULL ELSE mdm_room_from_sms.fact_indirect_area END,
       synchDate
    );
    COMMIT;
end;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_VERIFY_ATTR_AREA_USE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_MDM_VERIFY_ATTR_AREA_USE" (
    attrid     IN         VARCHAR2_LIST,--输入变量：单位面积等级id集合
    attrtype   IN         INT,--0单位面积等级,10项目合作属性,20经营属性
    message    OUT        VARCHAR2,--提示消息
    isuse      OUT        INT--0未使用，1已使用
) IS
    --验证业态是否被使用
--作者：陈丽
--日期：2019/11/17
    idStr varchar2(300);
BEGIN
    BEGIN
        for i in 1..attrid.count loop
                idStr:= idStr || ',' || attrid(i);
            end loop;
        isuse := 0;
        message := '验证通过';
        --查看是否在指标表使用---先单个后期调整
        SELECT COUNT(attribute_area_level_id) INTO isuse
        FROM mdm_obj_phase_area_level
        WHERE instr(idStr, attribute_area_level_id) != -1;
        IF isuse > 0 THEN
            raise_application_error(-20000, '属性已被使用不允许删除');
        end if;
    EXCEPTION
        WHEN OTHERS THEN
            isuse := 1;
            message := '验证失败，' || sqlerrm;
    END;
END P_MDM_VERIFY_ATTR_AREA_USE;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_VERIFY_PERIOD_USE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_MDM_VERIFY_PERIOD_USE" (
    periodoriginalid   IN                 VARCHAR2_LIST,--输入变量：分期原始id
    message            OUT                VARCHAR2,--提示消息
    isuse              OUT                INT--0未使用，1已使用
) IS
--验证分期是否被使用
--作者：陈丽
--日期：2019/11/17
BEGIN
    BEGIN
        isuse := 0;      
 FOR I IN 1 .. periodoriginalid.COUNT
 LOOP
 SELECT
            COUNT(period_id)+isuse
        INTO isuse
        FROM
           mdm_period_phase
       WHERE period_id = periodoriginalid(I);
  END LOOP;    
        IF isuse > 0 THEN
            raise_application_error(-20000, '分期已存在指标数据不允许删除');
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            isuse := 1;
            message := '验证失败，' || sqlerrm;
    END;
END p_mdm_verify_period_use;

/
--------------------------------------------------------
--  DDL for Procedure P_MDM_VERIFY_PRODUCT_TYPE_USE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_MDM_VERIFY_PRODUCT_TYPE_USE" (
    ptid   IN           VARCHAR2,--输入变量：业态id。多个逗号分隔，
    message      OUT          VARCHAR2,--提示消息
    isuse        OUT          INT--0未使用，1已使用
) IS
    -- 复制于P_MDM_VERIFY_PRODUCT_TYPE_USE
--验证业态是否被使用
--作者：韩金明
--日期：2020/03/23
    nodeName varchar(50);
    projectName varchar(50);
BEGIN
    isuse := 0;
    --查看分期是否在指标表使用
    select count(*) into isuse from MDM_OBJ_PHASE_PT_INDEX
    where PRODUCT_TYPE_ID = ptid;
    IF isuse > 0 THEN
        declare
            -- 定义游标
            cursor list is
                select OBJ_PHASE_ID, OBJ_TYPE from MDM_OBJ_PHASE_PT_INDEX
                where PRODUCT_TYPE_ID = ptid;
        begin
            -- 打开游标循环遍历数据
            for item in list loop
                begin
                    -- 为项目关联业态
                    if item.OBJ_TYPE = 0 then
                        select PROJECT_NAME into projectName from MDM_PROJECT a
                        where a.id = item.OBJ_PHASE_ID and ROWNUM < 2;
                    end if;
                    -- 为宗地关联业态
                    if item.OBJ_TYPE = 10 then
                        select a.PROJECT_NAME into projectName  from MDM_PARCEL a
                        where a.id = item.OBJ_PHASE_ID and ROWNUM < 2;
                    end if;
                    -- 为分期关联业态
                    if item.OBJ_TYPE = 20 then
                        select a.PROJECT_NAME into projectName
                        from MDM_PROJECT a
                             left join MDM_PERIOD_VERSION b on a.id = b.PROJECT_ID
                             left join MDM_PERIOD c on b.id = c.PERIOD_VERSION_ID
                        where c.id = item.OBJ_PHASE_ID and ROWNUM < 2;
                    end if;
                    -- 为楼栋关联业态
                    if item.OBJ_TYPE = 30 then
                        select a.PROJECT_NAME into projectName
                        from MDM_PROJECT a
                             left join MDM_PERIOD_VERSION b on a.id = b.PROJECT_ID
                             left join MDM_PERIOD c on b.id = c.PERIOD_VERSION_ID
                             left join MDM_BUILD d on c.id = d.PERIOD_ID
                             left join MDM_BUILD_PHASE e on d.id = e.BUILD_ID
                        where e.id = item.OBJ_PHASE_ID and ROWNUM < 2;
                    end if;
                EXCEPTION
                    -- 未找到数据 置为空
                    when OTHERS then
                        projectName := null;
                end;
                -- 找到关联项目, 退出循环
                if projectName is not null then
                    -- 获取节点名称
                    select PRODUCT_TYPE_SHORT_NAME into nodeName from MDM_BUILD_PRODUCT_TYPE
                    where id = ptid;
                    isuse := 1;
                    DBMS_OUTPUT.PUT_LINE('isuse:' || isuse);
                    message := '验证失败提示：节点' || nodeName ||'已被项目' || projectName || '使用, 不允许删除。';
                    exit;
                end if;
            end loop;
        end;
    END IF;
    if message is null then
        isuse := 0;
        message := '验证通过';
        DBMS_OUTPUT.PUT_LINE('isuse2:' || isuse);
    end if;
END P_MDM_VERIFY_PRODUCT_TYPE_USE;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_CURRENT_DELAY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_CURRENT_DELAY" (planType in VARCHAR2
,dataScope in VARCHAR2
,searchKey in VARCHAR2
,orgId  in VARCHAR2
,currentDelay OUT sys_refcursor)
AS
BEGIN
open currentDelay for
SELECT
    p.company_name as  "orgName",
    proj_name as "projName",
    node_name as "nodeName",
    '' as "projOpenUrl",
    '' as "nodeOpenUrl",
    ROUND(TO_NUMBER(plan_end_date-sysdate)) as "delayDays"
FROM
    pom_proj_plan_node n
    left join
    pom_proj_plan p on  n.proj_plan_id=p.id where proj_name is not null;

END p_pom_current_delay;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_DELAY_NODE_CURRENT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_DELAY_NODE_CURRENT" 
(
		PLANTYPE     IN VARCHAR2
	 ,DATASCOPE    IN VARCHAR2
	 ,SEARCHKEY    IN VARCHAR2
	 ,ORGID        IN VARCHAR2
	 ,CURRENTDELAY OUT SYS_REFCURSOR
) AS --关键节点计划监控-当前延误节点
		--作者：陈丽
		--日期：2019/11/13
BEGIN

		IF DATASCOPE = 'thisMonth' THEN
				OPEN CURRENTDELAY FOR
						SELECT DISTINCT A.ORG_NAME AS "orgName",
														B2.PROJECTSTAGE_NAME AS "projName",
														B2.NODE_NAME AS "nodeName",
														'/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||
														 NVL(B2.COMPANY_ID, '003200000000000000000000000000') ||
														 '&ppid=' || B2.PPID || '&planType=关键节点计划' AS "projOpenUrl",
														'/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' ||
														 B2.PLANID || '&feedbackNodeId=' || NODE_ID ||
														 '&feedbackNodeOriginalId=' || ORIGINAL_NODE_ID ||
														 '&nodeSourcePlanType=0' AS "nodeOpenUrl",
														TRUNC(SYSDATE, 'dd') -
														 TRUNC(PLAN_END_DATE, 'dd') AS "delayDays"
						FROM   SYS_BUSINESS_UNIT A
						LEFT   JOIN (SELECT LEVEL, ORG_NAME, CONNECT_BY_ROOT ID AS ID,
																CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
																B.UNIT_ID, B.NODE_NAME, B.NODE_ID,
																B.ACTUAL_END_DATE, B.PLAN_END_DATE,
																B.PROJECTSTAGE_NAME, B.PPID, B.PID,
																'TYPE_ORG' AS CTYPE, B.ESTIMATE_END_DATE,
																B.PLANID, ORIGINAL_NODE_ID,B.COMPANY_ID
												 FROM   SYS_BUSINESS_UNIT A
												 LEFT   JOIN (SELECT B1.UNIT_ID, A.ID AS PLANID,A.COMPANY_ID,
																						A.PROJ_ID AS PPID, B1.ID AS PID,
																						A1.ORIGINAL_NODE_ID,
																				
																						 A.PROJ_NAME AS PROJECTSTAGE_NAME,
																						A1.NODE_NAME, A1.ID AS NODE_ID,
																						A1.ACTUAL_END_DATE,
																						A1.PLAN_END_DATE,
																						A1.ESTIMATE_END_DATE
																		 FROM   POM_PROJ_PLAN A
																		 INNER  JOIN POM_PROJ_PLAN_NODE A1
																		 ON     A.ID = A1.PROJ_PLAN_ID
																		 INNER  JOIN SYS_PROJECT_STAGE C1
																		 ON     A.PROJ_ID = C1.ID
																		 INNER  JOIN SYS_PROJECT B1
																		 ON     C1.PROJECT_ID = B1.ID
																		 WHERE  A.PLAN_TYPE = '关键节点计划' AND
																						A.APPROVAL_STATUS = '已审核' 	AND
																						A1.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||'-'||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else'12' end ||'-'||'26'  FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')  AND
 TO_DATE ((SELECT    A.铁建_本年||'-'||铁建_本月||'-'||'25' FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')  AND   
																						TRUNC(SYSDATE, 'dd') -TRUNC(PLAN_END_DATE, 'dd') > 0 AND
																						ACTUAL_END_DATE IS NULL) B
												 ON     A.ID = B.UNIT_ID
												 WHERE  ORG_TYPE = 0
												 START  WITH ID = '' || ORGID || ''
												 CONNECT BY PRIOR A.ID = A.PARENT_ID) B2
						ON     A.ID = B2.ID
						WHERE  NODE_NAME IS NOT NULL AND
									 ACTUAL_END_DATE IS NULL AND
									 TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 --分期
						UNION ALL
						SELECT DISTINCT '' AS "orgName",
													 A.PROJ_NAME AS "projName",
														A1.NODE_NAME AS "nodeName",
														'/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||
														 NVL(A.COMPANY_ID,
																 '003200000000000000000000000001') ||
														 '&ppid=' || a.PROJ_ID || '&planType=关键节点计划' AS "projOpenUrl",
														'/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || A.ID ||
														 '&feedbackNodeId=' || A1.ID ||
														 '&feedbackNodeOriginalId=' ||
														 A1.ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
														TRUNC(SYSDATE, 'dd') -
														 TRUNC(PLAN_END_DATE, 'dd') AS "delayDays"
						FROM   POM_PROJ_PLAN A
						INNER  JOIN POM_PROJ_PLAN_NODE A1
						ON     A.ID = A1.PROJ_PLAN_ID
						INNER  JOIN SYS_PROJECT_STAGE C1
						ON     A.PROJ_ID = C1.ID
						INNER  JOIN SYS_PROJECT B1
						ON     C1.PROJECT_ID = B1.ID
						WHERE  A.PLAN_TYPE = '关键节点计划' AND
									 A.APPROVAL_STATUS = '已审核'   AND
							A1.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||'-'||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else'12' end ||'-'||'26'  FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')  AND
 TO_DATE ((SELECT    A.铁建_本年||'-'||铁建_本月||'-'||'25' FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')   AND
									 TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 AND
									 ACTUAL_END_DATE IS NULL AND
									 C1.PROJECT_ID = '' || ORGID || ''
						ORDER  BY 6 DESC;
		
		ELSIF DATASCOPE = 'thisQuarter' THEN
				OPEN CURRENTDELAY FOR
						SELECT DISTINCT A.ORG_NAME AS "orgName",
														B2.PROJECTSTAGE_NAME AS "projName",
														B2.NODE_NAME AS "nodeName",
														'/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||
														 NVL(B2.COMPANY_ID,
																 '003200000000000000000000000002') ||
														 '&ppid=' || B2.PPID || '&planType=关键节点计划' AS "projOpenUrl",
														'/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' ||
														 B2.PLANID || '&feedbackNodeId=' || NODE_ID ||
														 '&feedbackNodeOriginalId=' || ORIGINAL_NODE_ID ||
														 '&nodeSourcePlanType=0' AS "nodeOpenUrl",
														TRUNC(SYSDATE, 'dd') -
														 TRUNC(PLAN_END_DATE, 'dd') AS "delayDays"
						FROM   SYS_BUSINESS_UNIT A
						LEFT   JOIN (SELECT LEVEL, ORG_NAME, CONNECT_BY_ROOT ID AS ID,
																CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
																B.UNIT_ID, B.NODE_NAME, B.NODE_ID,
																B.ACTUAL_END_DATE, B.PLAN_END_DATE,
																B.PROJECTSTAGE_NAME, B.PPID, B.PID,
																'TYPE_ORG' AS CTYPE, B.ESTIMATE_END_DATE,
																B.PLANID, ORIGINAL_NODE_ID,B.COMPANY_ID
												 FROM   SYS_BUSINESS_UNIT A
												 LEFT   JOIN (SELECT B1.UNIT_ID, A.ID AS PLANID,A.COMPANY_ID,
																						A.PROJ_ID AS PPID, B1.ID AS PID,
																						A1.ORIGINAL_NODE_ID,
																						
																						 A.PROJ_NAME AS PROJECTSTAGE_NAME,
																						A1.NODE_NAME, A1.ID AS NODE_ID,
																						A1.ACTUAL_END_DATE,
																						A1.PLAN_END_DATE,
																						A1.ESTIMATE_END_DATE
																		 FROM   POM_PROJ_PLAN A
																		 INNER  JOIN POM_PROJ_PLAN_NODE A1
																		 ON     A.ID = A1.PROJ_PLAN_ID
																		 INNER  JOIN SYS_PROJECT_STAGE C1
																		 ON     A.PROJ_ID = C1.ID
																		 INNER  JOIN SYS_PROJECT B1
																		 ON     C1.PROJECT_ID = B1.ID
																		 WHERE  A.PLAN_TYPE = '关键节点计划' AND
																						A.APPROVAL_STATUS = '已审核' --判断季度
																					 --判断季度
																					 
																						AND
																					A1.PLAN_END_DATE BETWEEN
																		 TO_DATE( 			(	SELECT A.开始年度||'-'||A.开始月份||'-26'   FROM V_POM_GETEXAMINE_QUARTER A),'YYYY-MM-DD')  AND
 TO_DATE((	SELECT A.结束年度||'-'||A.结束月份||'-25' FROM V_POM_GETEXAMINE_QUARTER A),'YYYY-MM-DD')
							AND
																						TRUNC(SYSDATE, 'dd') -
																						TRUNC(PLAN_END_DATE, 'dd') > 0 AND
																						ACTUAL_END_DATE IS NULL) B
												 ON     A.ID = B.UNIT_ID
												 WHERE  ORG_TYPE = 0
												 START  WITH ID = '' || ORGID || ''
												 CONNECT BY PRIOR A.ID = A.PARENT_ID) B2
						ON     A.ID = B2.ID
						WHERE  NODE_NAME IS NOT NULL AND
									 ACTUAL_END_DATE IS NULL AND
									 TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 --分期
						UNION ALL
						SELECT DISTINCT '' AS "orgName",
														 A.PROJ_NAME AS "projName",
														A1.NODE_NAME AS "nodeName",
														'/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||
														 NVL(A.COMPANY_ID,
																 '003200000000000000000000000000') ||
														 '&ppid=' || C1.ID || '&planType=关键节点计划' AS "projOpenUrl",
														'/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || A.ID ||
														 '&feedbackNodeId=' || A1.ID ||
														 '&feedbackNodeOriginalId=' ||
														 A1.ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
														TRUNC(SYSDATE, 'dd') -
														 TRUNC(PLAN_END_DATE, 'dd') AS "delayDays"
						FROM   POM_PROJ_PLAN A
						INNER  JOIN POM_PROJ_PLAN_NODE A1
						ON     A.ID = A1.PROJ_PLAN_ID
						INNER  JOIN SYS_PROJECT_STAGE C1
						ON     A.PROJ_ID = C1.ID
						INNER  JOIN SYS_PROJECT B1
						ON     C1.PROJECT_ID = B1.ID
						WHERE  A.PLAN_TYPE = '关键节点计划' AND
									 A.APPROVAL_STATUS = '已审核' --判断季度
									
									 AND
									 A1.PLAN_END_DATE  BETWEEN
																										 TO_DATE( 			(	SELECT A.开始年度||'-'||A.开始月份||'-26'   FROM V_POM_GETEXAMINE_QUARTER A),'YYYY-MM-DD')  AND
 TO_DATE((	SELECT A.结束年度||'-'||A.结束月份||'-25' FROM V_POM_GETEXAMINE_QUARTER A),'YYYY-MM-DD') AND
									 TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 AND
									 ACTUAL_END_DATE IS NULL AND
									 C1.PROJECT_ID = '' || ORGID || ''
						ORDER  BY 6 DESC;
		ELSIF DATASCOPE = 'thisYear' THEN
				OPEN CURRENTDELAY FOR
						SELECT DISTINCT A.ORG_NAME AS "orgName",
														B2.PROJECTSTAGE_NAME AS "projName",
														B2.NODE_NAME AS "nodeName",
														'/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||
														 NVL(B2.COMPANY_ID,
																 '003200000000000000000000000000') ||
														 '&ppid=' || B2.PPID || '&planType=关键节点计划' AS "projOpenUrl",
														'/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' ||
														 B2.PLANID || '&feedbackNodeId=' || NODE_ID ||
														 '&feedbackNodeOriginalId=' || ORIGINAL_NODE_ID ||
														 '&nodeSourcePlanType=0' AS "nodeOpenUrl",
														TRUNC(SYSDATE, 'dd') -
														 TRUNC(PLAN_END_DATE, 'dd') AS "delayDays"
						FROM   SYS_BUSINESS_UNIT A
						LEFT   JOIN (SELECT LEVEL, ORG_NAME, CONNECT_BY_ROOT ID AS ID,
																CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
																B.UNIT_ID, B.NODE_NAME, B.NODE_ID,
																B.ACTUAL_END_DATE, B.PLAN_END_DATE,
																B.PROJECTSTAGE_NAME, B.PPID, B.PID,
																'TYPE_ORG' AS CTYPE, B.ESTIMATE_END_DATE,
																B.PLANID, ORIGINAL_NODE_ID,B.COMPANY_ID
												 FROM   SYS_BUSINESS_UNIT A
												 LEFT   JOIN (SELECT B1.UNIT_ID, A.ID AS PLANID,A.COMPANY_ID,
																						A.PROJ_ID AS PPID, B1.ID AS PID,
																						A1.ORIGINAL_NODE_ID,
																						
																						 A.PROJ_NAME AS PROJECTSTAGE_NAME,
																						A1.NODE_NAME, A1.ID AS NODE_ID,
																						A1.ACTUAL_END_DATE,
																						A1.PLAN_END_DATE,
																						A1.ESTIMATE_END_DATE
																		 FROM   POM_PROJ_PLAN A
																		 INNER  JOIN POM_PROJ_PLAN_NODE A1
																		 ON     A.ID = A1.PROJ_PLAN_ID
																		 INNER  JOIN SYS_PROJECT_STAGE C1
																		 ON     A.PROJ_ID = C1.ID
																		 INNER  JOIN SYS_PROJECT B1
																		 ON     C1.PROJECT_ID = B1.ID
																		 WHERE  A.PLAN_TYPE = '关键节点计划' AND
																						A.APPROVAL_STATUS = '已审核' AND
																						PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||'-12'||'-26','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||'-12'||'-25','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH)  AND
																						TRUNC(SYSDATE, 'dd') -
																						TRUNC(PLAN_END_DATE, 'dd') > 0 AND
																						ACTUAL_END_DATE IS NULL) B
												 ON     A.ID = B.UNIT_ID
												 WHERE  ORG_TYPE = 0
												 START  WITH ID = '' || ORGID || ''
												 CONNECT BY PRIOR A.ID = A.PARENT_ID) B2
						ON     A.ID = B2.ID
						WHERE  NODE_NAME IS NOT NULL AND
									 ACTUAL_END_DATE IS NULL AND
									 TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 --分期
						UNION ALL
						SELECT DISTINCT '' AS "orgName",
														A.PROJ_NAME AS "projName",
														A1.NODE_NAME AS "nodeName",
														'/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||
														 NVL(A.COMPANY_ID,
																 '003200000000000000000000000000') ||
														 '&ppid=' || C1.ID || '&planType=关键节点计划' AS "projOpenUrl",
														'/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || A.ID ||
														 '&feedbackNodeId=' || A1.ID ||
														 '&feedbackNodeOriginalId=' ||
														 A1.ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
														TRUNC(SYSDATE, 'dd') -
														 TRUNC(PLAN_END_DATE, 'dd') AS "delayDays"
						FROM   POM_PROJ_PLAN A
						INNER  JOIN POM_PROJ_PLAN_NODE A1
						ON     A.ID = A1.PROJ_PLAN_ID
						INNER  JOIN SYS_PROJECT_STAGE C1
						ON     A.PROJ_ID = C1.ID
						INNER  JOIN SYS_PROJECT B1
						ON     C1.PROJECT_ID = B1.ID
						WHERE  A.PLAN_TYPE = '关键节点计划' AND
									 A.APPROVAL_STATUS = '已审核' AND
									PLAN_END_DATE  BETWEEN (SELECT TO_DATE( "铁建_本年"-1||'-12'||'-26','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||'-12'||'-25','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH)
										AND
									 TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 AND
									 ACTUAL_END_DATE IS NULL AND
									 C1.PROJECT_ID = '' || ORGID || ''
						ORDER  BY 6 DESC;
		END IF;

END P_POM_DELAY_NODE_CURRENT;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_DELAY_NODE_PREDICT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_DELAY_NODE_PREDICT" (
    planType IN VARCHAR2,
    dataScope IN VARCHAR2,
    searchKey IN VARCHAR2,
    orgId IN VARCHAR2,
    currentDelay OUT sys_refcursor 
  ) AS --关键节点计划监控-预计延误节点
--作者：陈丽
--日期：2019/11/13
BEGIN
  IF
    DATASCOPE = 'thisMonth' THEN
      open currentDelay FOR
      SELECT DISTINCT
      A.ORG_NAME AS "orgName",
      B2.PROJECTSTAGE_NAME AS "projName",
      B2.NODE_NAME AS "nodeName",
      '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' || A.id || '&ppid=' || B2.PPID || '&planType=关键节点计划' AS "projOpenUrl",
      '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || B2.PLANID || '&feedbackNodeId=' || NODE_ID || '&feedbackNodeOriginalId=' || ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
      TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) AS "delayDays" 
    FROM
      SYS_BUSINESS_UNIT a
      LEFT JOIN (
      SELECT LEVEL
        ,
        ORG_NAME,
        CONNECT_BY_ROOT ID AS ID,
        CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
        B.UNIT_ID,
        B.NODE_NAME,
        B.NODE_ID,
        B.ACTUAL_END_DATE,
        B.PLAN_END_DATE,
        B.PROJECTSTAGE_NAME,
        B.PPID,
        B.PID,
        'TYPE_ORG' AS CTYPE,
        B.ESTIMATE_END_DATE,
        PLANID,
        ORIGINAL_NODE_ID 
      FROM
        SYS_BUSINESS_UNIT A
        LEFT JOIN (
        SELECT
          B1.UNIT_ID,
          A.ID AS PLANID,
          A1.ORIGINAL_NODE_ID,
          A.PROJ_ID AS PPID,
          B1.ID AS PID,
           A.PROJ_NAME AS PROJECTSTAGE_NAME,
          A1.NODE_NAME,
          A1.ID AS NODE_ID,
          A1.ACTUAL_END_DATE,
          A1.PLAN_END_DATE,
          A1.ESTIMATE_END_DATE 
        FROM
          POM_PROJ_PLAN A
          INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
          INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
          INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
        WHERE
          A.PLAN_TYPE = '关键节点计划' 
          AND A.APPROVAL_STATUS = '已审核' 
          AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5)
          AND ACTUAL_END_DATE IS NULL 
          AND TO_CHAR( A1.PLAN_END_DATE, 'YYYY-MM-DD' ) BETWEEN (
          SELECT
            A.铁建_本年 || '-' || TO_CHAR( TO_NUMBER( 铁建_本月 ) - 1 ) || '-' || '26' 
          FROM
            V_POM_GETEXAMINE_MOTH A 
          ) 
          AND (
          SELECT
            A.铁建_本年 || '-' ||铁建_本月 || '-' || '25' 
          FROM
            V_POM_GETEXAMINE_MOTH A 
          ) 
        ) B ON A.ID = B.UNIT_ID 
      WHERE
        ORG_TYPE = 0 START WITH ID = '' || orgId || '' CONNECT BY PRIOR A.ID = A.PARENT_ID 
      ) B2 ON A.ID = B2.ID 
    WHERE
      NODE_NAME IS NOT NULL 
      AND ACTUAL_END_DATE IS NULL 
			--判断条件
    AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5 --5天内到期
				)
				
			--分期
    UNION ALL
    SELECT DISTINCT
      '' AS "orgName",
       A.PROJ_NAME AS "projName",
      A1.NODE_NAME AS "nodeName",
      '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||A.COMPANY_ID || '&ppid=' || A.PROJ_ID || '&planType=关键节点计划' AS "projOpenUrl",
      '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || A.ID || '&feedbackNodeId=' || A1.ID || '&feedbackNodeOriginalId=' || A1.ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
      TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) AS "delayDays" 
    FROM
      POM_PROJ_PLAN A
      INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
      INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
      INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
    WHERE
      A.PLAN_TYPE = '关键节点计划' 
      AND A.APPROVAL_STATUS = '已审核' 
      AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5)
      AND ACTUAL_END_DATE IS NULL 
      AND TO_CHAR( A1.PLAN_END_DATE, 'YYYY-MM-DD' ) BETWEEN (
      SELECT
        A.铁建_本年 || '-' || TO_CHAR( TO_NUMBER( 铁建_本月 ) - 1 ) || '-' || '26' 
      FROM
        V_POM_GETEXAMINE_MOTH A 
      ) 
      AND (
      SELECT
        A.铁建_本年 || '-' ||铁建_本月 || '-' || '25' 
      FROM
        V_POM_GETEXAMINE_MOTH A 
      ) 
      AND C1.PROJECT_ID = '' || orgId || '' 
    ORDER BY
      6 DESC;
    ELSIF
      DATASCOPE = 'thisQuarter' THEN
        open currentDelay FOR 
				SELECT DISTINCT
        A.ORG_NAME AS "orgName",
        B2.PROJECTSTAGE_NAME AS "projName",
        B2.NODE_NAME AS "nodeName",
        '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' || A.COMPANY_ID ||  '&ppid=' || B2.PPID || '&planType=关键节点计划' AS "projOpenUrl",
        '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || B2.PLANID || '&feedbackNodeId=' || NODE_ID || '&feedbackNodeOriginalId=' || ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
        TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) AS "delayDays" 
      FROM
        SYS_BUSINESS_UNIT a
        LEFT JOIN (
        SELECT LEVEL
          ,
          ORG_NAME,
          CONNECT_BY_ROOT ID AS ID,
          CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
          B.UNIT_ID,
          B.NODE_NAME,
          B.NODE_ID,
          B.ACTUAL_END_DATE,
          B.PLAN_END_DATE,
          B.PROJECTSTAGE_NAME,
          B.PPID,
          B.PID,
          'TYPE_ORG' AS CTYPE,
          B.ESTIMATE_END_DATE,
          PLANID,
          ORIGINAL_NODE_ID 
        FROM
          SYS_BUSINESS_UNIT A
          LEFT JOIN (
          SELECT
            B1.UNIT_ID,
            A.ID AS PLANID,
            A1.ORIGINAL_NODE_ID,
            A.PROJ_ID AS PPID,
            B1.ID AS PID,
            A.PROJ_NAME AS PROJECTSTAGE_NAME,
            A1.NODE_NAME,
            A1.ID AS NODE_ID,
            A1.ACTUAL_END_DATE,
            A1.PLAN_END_DATE,
            A1.ESTIMATE_END_DATE 
          FROM
            POM_PROJ_PLAN A
            INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
            INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
            INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
          WHERE
            A.PLAN_TYPE = '关键节点计划' 
            AND A.APPROVAL_STATUS = '已审核' 
           AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5)
            AND ACTUAL_END_DATE IS NULL 
            AND TO_CHAR( A1.PLAN_END_DATE, 'YYYY-MM-DD' ) BETWEEN (
            SELECT
              A.开始年度 || '-' || A.开始月份 || '-26' 
            FROM
              V_POM_GETEXAMINE_QUARTER A 
            ) 
            AND (
            SELECT
              A.结束年度 || '-' || A.结束月份 || '-25' 
            FROM
              V_POM_GETEXAMINE_QUARTER A 
            ) 
          ) B ON A.ID = B.UNIT_ID 
        WHERE
          ORG_TYPE = 0 START WITH ID = '' || orgId || '' CONNECT BY PRIOR A.ID = A.PARENT_ID 
        ) B2 ON A.ID = B2.ID 
      WHERE
        NODE_NAME IS NOT NULL 
        AND ACTUAL_END_DATE IS NULL 
        AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5)
      UNION ALL
      SELECT DISTINCT
        '' AS "orgName",
         A.PROJ_NAME AS "projName",
        A1.NODE_NAME AS "nodeName",
        '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' || A.COMPANY_ID|| '&ppid=' || C1.ID || '&planType=关键节点计划' AS "projOpenUrl",
        '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || A.ID || '&feedbackNodeId=' || A1.ID || '&feedbackNodeOriginalId=' || A1.ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
        TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) AS "delayDays" 
      FROM
        POM_PROJ_PLAN A
        INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
        INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
        INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
      WHERE
        A.PLAN_TYPE = '关键节点计划' 
        AND A.APPROVAL_STATUS = '已审核' 
        AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5)
        AND ACTUAL_END_DATE IS NULL 
        AND TO_CHAR( A1.PLAN_END_DATE, 'YYYY-MM-DD' ) BETWEEN (
        SELECT
          A.开始年度 || '-' || A.开始月份 || '-26' 
        FROM
          V_POM_GETEXAMINE_QUARTER A 
        ) 
        AND (
        SELECT
          A.结束年度 || '-' || A.结束月份 || '-25' 
        FROM
          V_POM_GETEXAMINE_QUARTER A 
        ) 
        AND C1.PROJECT_ID = '' || orgId || '' 
      ORDER BY
        6 DESC;
      ELSIF
        DATASCOPE = 'thisYear' THEN
          open currentDelay FOR SELECT DISTINCT
          A.ORG_NAME AS "orgName",
          B2.PROJECTSTAGE_NAME AS "projName",
          B2.NODE_NAME AS "nodeName",
          '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' || A.COMPANY_ID || '&ppid=' || B2.PPID || '&planType=关键节点计划' AS "projOpenUrl",
          '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || B2.PLANID || '&feedbackNodeId=' || NODE_ID || '&feedbackNodeOriginalId=' || ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
          TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) AS "delayDays" 
        FROM
          SYS_BUSINESS_UNIT a
          LEFT JOIN (
          SELECT LEVEL
            ,
            ORG_NAME,
            CONNECT_BY_ROOT ID AS ID,
            CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
            B.UNIT_ID,
            B.NODE_NAME,
            B.NODE_ID,
            B.ACTUAL_END_DATE,
            B.PLAN_END_DATE,
            B.PROJECTSTAGE_NAME,
            B.PPID,
            B.PID,
            'TYPE_ORG' AS CTYPE,
            B.ESTIMATE_END_DATE,
            PLANID,
            ORIGINAL_NODE_ID 
          FROM
            SYS_BUSINESS_UNIT A
            LEFT JOIN (
            SELECT
              B1.UNIT_ID,
              A.ID AS PLANID,
              A1.ORIGINAL_NODE_ID,
              A.PROJ_ID AS PPID,
              B1.ID AS PID,
              A.PROJ_NAME AS PROJECTSTAGE_NAME,
              A1.NODE_NAME,
              A1.ID AS NODE_ID,
              A1.ACTUAL_END_DATE,
              A1.PLAN_END_DATE,
              A1.ESTIMATE_END_DATE 
            FROM
              POM_PROJ_PLAN A
              INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
              INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
              INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
            WHERE
              A.PLAN_TYPE = '关键节点计划' 
              AND A.APPROVAL_STATUS = '已审核' 
              AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5) 
              AND ACTUAL_END_DATE IS NULL 
              AND TO_CHAR( A1.PLAN_END_DATE, 'YYYY' ) = TO_CHAR( SYSDATE, 'YYYY' ) 
            ) B ON A.ID = B.UNIT_ID 
          WHERE
            ORG_TYPE = 0 START WITH ID = '' || orgId || '' CONNECT BY PRIOR A.ID = A.PARENT_ID 
          ) B2 ON A.ID = B2.ID 
        WHERE
          NODE_NAME IS NOT NULL 
          AND ACTUAL_END_DATE IS NULL 
          AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5) --分期
        UNION ALL
        SELECT DISTINCT
          '' AS "orgName",
          A.PROJ_NAME AS "projName",
          A1.NODE_NAME AS "nodeName",
          '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' || A.COMPANY_ID || '&ppid=' || C1.ID || '&planType=关键节点计划' AS "projOpenUrl",
          '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || A.ID || '&feedbackNodeId=' || A1.ID || '&feedbackNodeOriginalId=' || A1.ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
          TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) AS "delayDays" 
        FROM
          POM_PROJ_PLAN A
          INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
          INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
          INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
        WHERE
          A.PLAN_TYPE = '关键节点计划' 
          AND A.APPROVAL_STATUS = '已审核' 
          AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5)
          AND ACTUAL_END_DATE IS NULL 
          AND TO_CHAR( A1.PLAN_END_DATE, 'YYYY' ) = TO_CHAR( SYSDATE, 'YYYY' ) 
          AND C1.PROJECT_ID = '' || orgId || '' 
        ORDER BY
          6 DESC;
      END IF;
END p_pom_delay_node_predict;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_DEPT_MONTHLY_PLAN
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_DEPT_MONTHLY_PLAN" (
    currentcompanyid     IN            VARCHAR2,--当前用户公司
    currentstationid     IN            VARCHAR2,---当前用户的岗位
    currentdeptid        IN            VARCHAR2,---当前用户的部门
    currentuserid        IN            VARCHAR2,---当前用户id 
    companyid     IN            VARCHAR2,---当前选择的公司
    deptid     IN            VARCHAR2,---当前选择的部门
    bizcode       IN            VARCHAR2,---权限code
    listtype      IN            int,---类型
    planname      IN            VARCHAR2,
    items          OUT           SYS_REFCURSOR
) IS
    v_sql_exec         CLOB;            --sql
    v_spid             VARCHAR2(200);--数据权限验证spid
    v_sheet            VARCHAR2(200);--是否查询历史数据表
    v_where            VARCHAR2(4000):=' 1=1 ';
    v_search           VARCHAR2(4000):=' 1=1 ';  ---搜素sql
BEGIN
    --调用数据权限验证存储过程
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => currentuserid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
     --根据type来确定联查哪张表
    IF (listtype =0)
        then v_sheet:='POM_DEPT_MONTHLY_PLAN A LEFT JOIN POM_DEPT_MONTHLY_PLAN_NODE B ON A.ID = B.DEPT_MONTHLY_PLAN_ID ';
    elsif (listtype =1)
        then v_sheet:='POM_DEPT_MONTHLY_PLAN_HISTORY A LEFT JOIN POM_DEPT_MONTHLY_NODE_HISTORY B ON A.ID = B.DEPT_MONTHLY_PLAN_HISTORY_ID';
    END IF;

    --添加搜索条件
    v_search:=' 1=1 ';
    IF (companyid is not null) then
            v_search:= v_search ||' And X.COMPANYID = '''||companyid||'''';
    end if;
    IF (deptid is not null) then
            v_search:= v_search ||' And X.DEPTID = '''||deptid||'''';
    end if;
    IF (planname is not null) then
            v_search:= v_search ||' And X.PLANNAME LIKE ''%'||planname||'%''';
    end if;

    v_sql_exec:='SELECT 
        X.ID as "id",
        X.PLANNAME as "planName",
        X.ORIGINALPLANID as "originalPlanId",
        X.DEPTID as "deptId",
        X.DEPTNAME as "deptName" ,
        X.COMPANYID as "companyId",
        X.COMPANYNAME as "companyName",
        X.PLANVERSION as "planVersion",
        X.BIZYEAR as  "bizYear",
        X.BIZMONTH as  "bizMonth",
        X.PLANTYPE as "planType",
        X.CREATOR as "creator",
        X.CREATORID as "creatorId",
        X.CREATETIME as "createTime1",
        X.APPROVESTATUS as "approveStatus",
        X.APPROVETIME1 as "approveTime1",
        X.APPROVERID as "approverId",
        X.APPROVER as "approver",
        X.REMARKS as "remarks",
        X.MODIFIER as "modifier",
        X.MODIFIERID as "modifierId",
        X.MODIFIEDTIME as "modifiedTime",
        X.ALTERSUBJECT as "alterSubject",
        X.ALTERREASON as "alterReason",
        X.ADJUSTSOURCEID as "adjustSourceId"
        ,
        CASE
        WHEN Y.ID IS NOT NULL THEN
        Y.CREATED
        ELSE
        X.CREATETIME
        END as "createTime",
        CASE
        WHEN Y.ID IS NOT NULL THEN
        Y.APPROVE_TIME
        ELSE
        X.APPROVETIME1
        END as "approveTime",
        CASE
        WHEN X.PLANVERSION > 1 THEN
        X.APPROVETIME1
        ELSE
        NUll
        END as "modified",
        X.TOTALNODE as "totalNode",
        X.FINISHEDNODE as "finishedNode",
        X.NOTFINISHEDNODE as "notFinishedNode"
        	FROM (
        SELECT
        A.ID as id,
        A.PLAN_NAME as planName,
        A.ORIGINAL_PLAN_ID as originalPlanId,
        A.DEPT_ID as deptId,
        A.DEPT_NAME as deptName ,
        A.COMPANY_ID as companyId,
        A.COMPANY_NAME as companyName,
        A.PLAN_VERSION as planVersion,
        A.BIZ_YEAR as  bizYear,
        A.BIZ_MONTH as  bizMonth,
        A.PLAN_TYPE as planType,
        A.CREATOR as creator,
        A.CREATOR_ID as creatorId,
        A.CREATED as createTime,
        A.APPROVE_STATUS as approveStatus,
        A.APPROVE_TIME as approveTime1,
        A.APPROVER_ID as approverId,
        A.APPROVER as approver,
        A.REMARKS as remarks,
        A.MODIFIER as modifier,
        A.MODIFIER_ID as modifierId,
        A.MODIFIED as modifiedTime,
        A.ALTER_SUBJECT as alterSubject,
        A.ALTER_REASON as alterReason,
        A.ADJUST_SOURCE_ID as adjustSourceId,
        COUNT( B.ID ) AS totalNode,
        (
        SELECT
        COUNT( NODE.ACTUAL_END_DATE )
        FROM
        POM_DEPT_MONTHLY_PLAN_NODE NODE
        LEFT JOIN POM_DEPT_MONTHLY_PLAN PLAN ON NODE.DEPT_MONTHLY_PLAN_ID = PLAN.ID
        WHERE
        PLAN.ID = A.ID
        AND
        NODE.ACTUAL_END_DATE IS NOT NULL
        ) AS finishedNode ,
        (
        SELECT
        COUNT(*)
        FROM
        POM_DEPT_MONTHLY_PLAN_NODE NODE
        LEFT JOIN POM_DEPT_MONTHLY_PLAN PLAN ON NODE.DEPT_MONTHLY_PLAN_ID = PLAN.ID
        WHERE
        PLAN.ID = A.ID
        AND
        NODE.ACTUAL_END_DATE IS NULL
        ) AS notFinishedNode
        FROM '||v_sheet||'
        GROUP BY
        A.ID,
        A.PLAN_NAME,
        A.ORIGINAL_PLAN_ID,
        A.DEPT_ID,
        A.DEPT_NAME,
        A.COMPANY_ID,
        A.COMPANY_NAME,
        A.PLAN_VERSION,
        A.BIZ_YEAR,
        A.BIZ_MONTH,
        A.PLAN_TYPE,
        A.CREATOR,
        A.CREATOR_ID,
        A.CREATED,
        A.APPROVE_STATUS,
        A.APPROVE_TIME,
        A.APPROVER_ID,
        A.APPROVER,
        A.REMARKS,
        A.MODIFIER,
        A.MODIFIER_ID,
        A.MODIFIED,
        A.ALTER_SUBJECT,
        A.ALTER_REASON,
        A.ADJUST_SOURCE_ID
        )X
        LEFT JOIN POM_DEPT_MONTHLY_PLAN_HISTORY Y
        ON X.originalPlanId = Y.ORIGINAL_PLAN_ID
        AND Y.PLAN_VERSION = 1
        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on  tal.orgid=X.COMPANYID or tal.orgid=X.DEPTID 
        WHERE '||v_search||' and (X.APPROVESTATUS =''已审核'' or (X.PLANVERSION =''1'' and X.APPROVESTATUS !=''已审核'')) and tal.orgid is not null';    



    dbms_output.put_line(v_sql_exec);
    OPEN items FOR v_sql_exec;


END p_pom_dept_monthly_plan;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_DEPT_PLAN_GET_PROJ_NODE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_DEPT_PLAN_GET_PROJ_NODE" 
 (
     I_DEPT_ID              IN VARCHAR2 := NULL
 ,I_DEPT_MONTHLY_PLAN_ID IN VARCHAR2 := NULL --传入参数_部门月度计划ID
 ,I_BIZ_YEAR             IN NUMBER := NULL --传入参数 _年份
 ,I_BIZ_MONTH            IN NUMBER := NULL --传入参数_月份
 ,O_FLAG                 OUT NUMBER --更新成功的条数
 ) AS
     V_CON          NUMBER(8, 0) := 0;
     V_PLAN_VERSION NUMBER(8, 0);
     V_BIZ_MONTH    NVARCHAR2(2);
     V_DEPT_NAME    NVARCHAR2(100);
 BEGIN
     IF I_BIZ_MONTH < 10 THEN
         V_BIZ_MONTH := '0'||I_BIZ_MONTH;
     elsif I_BIZ_MONTH >= 10 THEN
         V_BIZ_MONTH := ''||I_BIZ_MONTH;
     end if;
     BEGIN
         SELECT COUNT(1), NVL(A.PLAN_VERSION,''),  NVL(A.DEPT_NAME,'')
         INTO   V_CON, V_PLAN_VERSION, V_DEPT_NAME
         FROM   POM_DEPT_MONTHLY_PLAN A, POM_DEPT_MONTHLY_PLAN_NODE B
         WHERE  A.ID = B.DEPT_MONTHLY_PLAN_ID AND
                 B.NODE_SOURCE = '项目主项计划' AND
                 --A.APPROVE_STATUS = '已审核' AND
                 B.DUTY_DEPT_ID = I_DEPT_ID
         GROUP  BY A.PLAN_VERSION, A.DEPT_NAME;
         EXCEPTION
         WHEN NO_DATA_FOUND THEN
         O_FLAG := 0;
         --RETURN;
    END;
     IF V_CON <> 0 THEN
         DELETE FROM POM_DEPT_MONTHLY_PLAN_NODE A
         WHERE  EXISTS (SELECT 1
                        FROM   POM_DEPT_MONTHLY_PLAN B
                        LEFT JOIN POM_DEPT_MONTHLY_PLAN_NODE C
                        ON B.ID=C.DEPT_MONTHLY_PLAN_ID
                        WHERE  A.DEPT_MONTHLY_PLAN_ID = B.ID AND
                                C.DUTY_DEPT_ID = I_DEPT_ID AND
                                B.BIZ_MONTH = V_BIZ_MONTH AND
                                B.BIZ_YEAR = I_BIZ_YEAR AND
                                B.ID = I_DEPT_MONTHLY_PLAN_ID)
         /* AND
 A.NODE_SOURCE = '项目主项计划' AND
 A.ACTUAL_END_DATE IS NULL AND
 A.ACTUAL_START_DATE IS NULL AND
 A.ESTIMATE_END_DATE IS NULL AND
 A.ESTIMATE_START_DATE IS NULL;*/
         ;
     END IF;

     INSERT INTO POM_DEPT_MONTHLY_PLAN_NODE
     (ID, ORIGINAL_NODE_ID, DEPT_MONTHLY_PLAN_ID, PLAN_VERSION,
      NODE_NAME, NODE_CODE, NODE_SOURCE, NODE_TYPE, STAND_SCORE,
      PLAN_START_DATE, PLAN_END_DATE, ACTUAL_START_DATE, ACTUAL_END_DATE,
      ESTIMATE_START_DATE, ESTIMATE_END_DATE, RELATED_DEPT_ID,
      RELATED_DEPT, DUTY_DEPT_ID, DUTY_DEPT_NAME, SOURCE_PLAN_ID,
      SOUCE_NODE_ID, SOUCE_NODE_LEVEL, SOUCE_NODE_SCORE,
      COMPLETION_RESULTS_REMARK, COMPLETION_STANDARD, REMARKS)
     SELECT GET_UUID, NULL, I_DEPT_MONTHLY_PLAN_ID, A.plan_version,
            B.NODE_NAME, NULL, '项目主项计划', NULL, NULL, B.PLAN_START_DATE,
            B.PLAN_END_DATE, B.ACTUAL_START_DATE, B.ACTUAL_END_DATE, NULL,
            NULL, NULL, NULL, I_DEPT_ID, b.duty_department, A.ID, B.ID,
            B.NODE_LEVEL, B.STANDARD_SCORE, B.COMPLETION_RESULTS_REMARK,
            B.COMPLETION_STANDARD, NULL
     FROM   POM_PROJ_PLAN A
                INNER  JOIN POM_PROJ_PLAN_NODE B
                            ON     A.ID = B.PROJ_PLAN_ID
     WHERE  A.APPROVAL_STATUS = '已审核' AND
             B.DUTY_DEPARTMENT_ID = I_DEPT_ID AND
             TO_CHAR(B.PLAN_END_DATE, 'MM') = V_BIZ_MONTH AND
             TO_CHAR(B.PLAN_END_DATE, 'YYYY') = I_BIZ_YEAR;

     O_FLAG := SQL%ROWCOUNT;
     COMMIT;

 END P_POM_DEPT_PLAN_GET_PROJ_NODE;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_DM_PERFORM_DYNAMIC
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_DM_PERFORM_DYNAMIC" 
(
		IN_ORG_ID    IN VARCHAR2
	 ,DATASCOPE    IN VARCHAR2
	 ,IN_PLAN_TYPE IN VARCHAR2
	 ,IN_PROJID  IN VARCHAR2 
	 ,PAGEINDEX    IN INT
	 ,PAGESIZES    IN INT
	 ,P_PAGETYPE  IN INT
	 ,ITEMS        OUT SYS_REFCURSOR
	 ,TOTAL        OUT INT
) AS
		--传入的参数有三个，1：IN_ORG_ID（公司ID）
		--，2：DATASCOPE（统计期间，3个值“THIS_MONTH、THIS_QUARTER、THIS_YEAR"）
		--，3：PLAN_TYPE（计划类型，预留，估计后面会用的到）
		--，4：P_PAGETYPE（页面类型：1：已延误 2：已完成 3：应完成）//alterby 李小聪
		--关键节点计划-执行动态查询（wangck需要）
		--作者：陈丽
		--日期：2019/12/07

		CURSOR CUR_COMPANY_LIST(V_ORG_ID SYS_BUSINESS_UNIT.ID%TYPE) IS
				SELECT P.ID, P.PARENT_ID, P.ORG_NAME FROM SYS_BUSINESS_UNIT P WHERE P.IS_COMPANY = 1 START WITH P.ID = V_ORG_ID CONNECT BY PRIOR P.ID = P.PARENT_ID;
		V_SQL_TOTAL     CLOB := ' ';
		V_SQL           CLOB := ' ';
		V_SQL_DATASCOPE CLOB := ' ';
		V_COMPANY_LIST  CLOB := ' ';

BEGIN

  dbms_output.put_line('开始');
--月度
--已延误
		IF DATASCOPE = 'thisMonth' AND P_PAGETYPE=1  THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL   AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';
--月度
--已完成
		ELSIF DATASCOPE = 'thisMonth' AND P_PAGETYPE=2  THEN
				V_SQL_DATASCOPE := ' AND  PN.ACTUAL_END_DATE IS  NOT NULL  AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';

--月度
--应完成

		ELSIF DATASCOPE = 'thisMonth' AND P_PAGETYPE=3  THEN
				V_SQL_DATASCOPE := 'AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';

--季度
--已延误
	ELSIF DATASCOPE = 'thisQuarter' AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := ' AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL    AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((	SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((	SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
--季度
--已完成
	ELSIF DATASCOPE = 'thisQuarter' AND P_PAGETYPE=2 THEN
				V_SQL_DATASCOPE := 'AND  PN.ACTUAL_END_DATE IS  NOT NULL AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((	SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((	SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
--季度
--季度应完成
	ELSIF DATASCOPE = 'thisQuarter' AND P_PAGETYPE=3 THEN
				V_SQL_DATASCOPE := '  AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((	SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((	SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
--年度
--已延误
		ELSIF DATASCOPE = 'thisYear'AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL  
			 AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) ';
--年度
--已完成
		ELSIF DATASCOPE = 'thisYear'AND P_PAGETYPE=2 THEN
				V_SQL_DATASCOPE := 'AND  PN.ACTUAL_END_DATE IS  NOT NULL  
				 AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH)  ';
--年度
--应完成
		ELSIF DATASCOPE = 'thisYear' AND P_PAGETYPE=3 THEN
				V_SQL_DATASCOPE := ' AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) ';
--全部，没有时间限
--已延误
	ELSIF DATASCOPE = 'thisAll' AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL ';
--计划所有节点
	ELSIF DATASCOPE = 'thisAll' AND P_PAGETYPE=2 THEN
				V_SQL_DATASCOPE := ' AND   1=1 ';



		END IF;

		FOR ITEM_COMPANY_LIST IN CUR_COMPANY_LIST(IN_ORG_ID)
		LOOP
				/*DBMS_OUTPUT.PUT_LINE(ITEM_COMPANY_LIST.ORG_NAME || ',PARENT_ID' ||
        ITEM_COMPANY_LIST.PARENT_ID || ',ID:' ||
        ITEM_COMPANY_LIST.ID);*/
				V_COMPANY_LIST := V_COMPANY_LIST || '''' || ITEM_COMPANY_LIST.ID || '''' || ',';
		END LOOP;
-- 	dbms_output.put_line(V_COMPANY_LIST);
		V_COMPANY_LIST := '('  || SUBSTR(V_COMPANY_LIST, 1, LENGTH(V_COMPANY_LIST) - 1) || ')';
-- 		dbms_output.put_line(V_COMPANY_LIST);
IF  V_COMPANY_LIST='()'
	 THEN  V_COMPANY_LIST := '('''||IN_ORG_ID||''')';
END  IF;
-- 	dbms_output.put_line(V_COMPANY_LIST);
		V_SQL := V_SQL ||
						 'SELECT PP.COMPANY_ID, PP.COMPANY_NAME AS COMPANY_NAME,PP.PROJ_name AS PROJ_NAME,PP.PLAN_NAME AS PLAN_NAME, PN.ID,PN.PROJ_PLAN_ID,PN.ORIGINAL_NODE_ID,CASE WHEN PN.IS_DISABLE = 0 THEN	PN.NODE_NAME ELSE	''【禁用】'' || PN.NODE_NAME END AS NODE_NAME, PN.NODE_CODE, PN.NODE_LEVEL, PN.PROJ_STAGE, PN.MAIN_RESPONSIBILITY, PN.DUTY_DEPARTMENT, TO_CHAR(PN.PLAN_START_DATE, ''yyyy-MM-dd'') AS PLAN_START_DATE, TO_CHAR(PN.PLAN_END_DATE, ''yyyy-MM-dd'') AS PLAN_END_DATE, PN.IS_DISABLE, PN.COMPLETION_STANDARD, PN.COMPLETION_RESULTS_REMARK, TO_CHAR(PN.ACTUAL_END_DATE, ''yyyy-MM-dd'') AS ACTUAL_END_DATE
	, case 
 --未到期不亮灯
 WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
 --到期当天内完成反馈
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
 then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
  --到期1-5天内完成反馈
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
 then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
 --到期未反馈黄灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE)) >0
 THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>'' 
  --到期超过5天未反馈红灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(PLAN_END_DATE)) >5) THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' 
 ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END
  AS PLAN_STATUS,PN.ESTIMATE_END_DATE,	nps.CHARGE_PERSON
	FROM  pom_proj_plan_node pn 
LEFT JOIN pom_proj_plan pp ON pn.proj_plan_id = pp.id 
LEFT JOIN  SYS_PROJECT_STAGE ps on  ps.id=pp.proj_id
LEFT JOIN SYS_PROJECT pj on  ps.PROJECT_ID =pj.id
LEFT JOIN(	SELECT  NODE_ID, listagg(CHARGE_PERSON,'','') WITHIN GROUP (ORDER BY CHARGE_PERSON )  as CHARGE_PERSON
	FROM POM_NODE_CHARGE_PERSON 
	GROUP BY NODE_ID) nps on  nps.NODE_ID=pn.id
	WHERE  PP.PLAN_TYPE = ''部门月度计划''  AND APPROVAL_STATUS = ''已审核'' AND 1=1 
	and  ((pp.proj_id ='''||IN_PROJID||''' or pn.proj_plan_id='''||IN_PROJID||'''  OR  pj.id='''||IN_PROJID||''' )
	OR PP.COMPANY_ID IN ' || V_COMPANY_LIST ||' ) '|| V_SQL_DATASCOPE || '  ORDER BY PN.PROJ_PLAN_ID,  PN.NODE_CODE';

		DBMS_OUTPUT.PUT_LINE(V_SQL);
			V_SQL_TOTAL := V_SQL_TOTAL|| 				 'SELECT  TO_CHAR(COUNT(pn.ID))
	FROM  pom_proj_plan_node pn 
LEFT JOIN pom_proj_plan pp ON pn.proj_plan_id = pp.id 
LEFT JOIN  SYS_PROJECT_STAGE ps on  ps.id=pp.proj_id
LEFT JOIN SYS_PROJECT pj on  ps.PROJECT_ID =pj.id
LEFT JOIN(	SELECT  NODE_ID, listagg(CHARGE_PERSON,'','') WITHIN GROUP (ORDER BY CHARGE_PERSON )  as CHARGE_PERSON
	FROM POM_NODE_CHARGE_PERSON 
	GROUP BY NODE_ID) nps on  nps.NODE_ID=pn.id
	WHERE  PP.PLAN_TYPE = ''部门月度计划''  AND APPROVAL_STATUS = ''已审核'' AND 1=1 
	and  ((pp.proj_id ='''||IN_PROJID||''' or pn.proj_plan_id='''||IN_PROJID||'''  OR  pj.id='''||IN_PROJID||''' )
	OR PP.COMPANY_ID IN ' || V_COMPANY_LIST ||' ) '|| V_SQL_DATASCOPE || '  ORDER BY PN.PROJ_PLAN_ID,  PN.NODE_CODE';

		--DBMS_OUTPUT.PUT_LINE(V_SQL_TOTAL);
		 execute immediate V_SQL_TOTAL into TOTAL; 
	--	 DBMS_OUTPUT.PUT_LINE(TOTAL);

		OPEN ITEMS FOR V_SQL;

END P_POM_DM_PERFORM_DYNAMIC;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_FEEDBACK_APPROVAL_CB
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_FEEDBACK_APPROVAL_CB" (
    feedbackid IN VARCHAR2 --反馈id
) AS 
--反馈审批回调，只有审批通过才执行操作
--作者：陈丽
--日期：2019/11/13

    approvalstatus           NVARCHAR2(100);--审核状态
    feedbacktype             NVARCHAR2(100);--反馈类型（0：过程反馈，1：完成反馈，2：到期未完成反馈）
    feedbacknodeoriginalid   NVARCHAR2(100); --反馈节点原始id
    plantype                 NVARCHAR2(100);--节点所属计划类型(0：关键节点计划，1：项目主项计划、2：专项计划、3：部门月度计划）
    actualstarttime          DATE;--实际开始时间
    actualendtime            DATE;--实际结束时间
    estimatestarttime        DATE;--预计开始时间
    estimateendtime          DATE;--预计结束时间
BEGIN
    BEGIN
          --o、获取反馈信息
        SELECT
            approval_status,
            node_source_plan_type,
            feedback_type,
            feedback_node_original_id,
            actual_start_time,
            actual_end_time,
            estimate_start_time,
            estimate_end_time
        INTO
            approvalstatus,
            plantype,
            feedbacktype,
            feedbacknodeoriginalid,
            actualstarttime,
            actualendtime,
            estimatestarttime,
            estimateendtime
        FROM
            pom_node_feedback
        WHERE
            id = feedbackid;
						
						--KEY_NODE：关键节点计划，MAIN_ITEM：项目主项计划、SPECIAL：专项计划、DEPARTMENT:部门月度计划
						--PROCESS：过程反馈，CARRY_OUT：完成反馈，EXPIRED：到期未完成反馈
--1、更新反馈对应节点，【完成反馈】更新节点实际开始时间和实际完成时间，【未完成反馈】【过程反馈】更新节点预计开始时间和预计完成时间。
  dbms_output.put_line('feedbacktype='||feedbacktype);
  dbms_output.put_line('plantype='||plantype);
	  dbms_output.put_line('approvalstatus='||approvalstatus);
        IF feedbacktype = 'PROCESS' OR feedbacktype = 'EXPIRED' and approvalstatus='已审核'   THEN--过程反馈，到期未完成反馈
            BEGIN
                IF plantype = 'KEY_NODE' OR plantype = 'MAIN_ITEM' and approvalstatus='已审核'  THEN--0：关键节点计划，1：项目主项计划,【未完成反馈】【过程反馈】更新节点预计开始时间和预计完成时间。
                    dbms_output.put_line('--0：关键节点计划，1：项目主项计划,【未完成反馈】【过程反馈】');
                    UPDATE pom_proj_plan_node
                    SET
                        estimate_start_date = estimatestarttime,
                        estimate_end_date = estimateendtime,
                        feedback_id = feedbackid
                    WHERE
                        original_node_id = feedbacknodeoriginalid;

                ELSIF feedbacktype = 'SPECIAL' and approvalstatus='已审核'  THEN--2：专项计划
                    UPDATE pom_special_plan_node
                    SET
                        PREDICT_BEGIN_DATE = estimatestarttime,
                        predict_end_date = estimateendtime,
                        feedback_id = feedbackid
                    WHERE
                        original_node_id = feedbacknodeoriginalid;

                ELSIF feedbacktype = 'DEPARTMENT' and approvalstatus='已审核'  THEN--3：部门月度计划
                    UPDATE pom_dept_monthly_plan_node
                    SET
                        estimate_start_date = estimatestarttime,
                        estimate_end_date = estimateendtime,
                        feedback_id = feedbackid
                    WHERE
                        original_node_id = feedbacknodeoriginalid;

                END IF;

            END;

        ELSIF feedbacktype = 'CARRY_OUT'and approvalstatus='已审核'   THEN--完成反馈，【完成反馈】更新节点实际开始时间和实际完成时间
            BEGIN
                IF plantype = 'KEY_NODE' OR plantype = 'MAIN_ITEM'and approvalstatus='已审核'   THEN--0：关键节点计划，1：项目主项计划,【未完成反馈】【过程反馈】更新节点预计开始时间和预计完成时间。
                    UPDATE pom_proj_plan_node
                    SET
                        actual_start_date = actualstarttime,
                        actual_end_date = actualendtime,
                        feedback_id = feedbackid
                    WHERE
                        original_node_id = feedbacknodeoriginalid;

                ELSIF plantype = 'SPECIAL' and approvalstatus='已审核' THEN--2：专项计划
                    UPDATE pom_special_plan_node
                    SET
                        PREDICT_BEGIN_DATE = actualstarttime,
                        actual_end_date = actualendtime,
                        feedback_id = feedbackid
                    WHERE
                        original_node_id = feedbacknodeoriginalid;

                ELSIF plantype = 'DEPARTMENT'and approvalstatus='已审核'   THEN--3：部门月度计划
                    UPDATE pom_dept_monthly_plan_node
                    SET
                        actual_start_date = actualstarttime,
                        actual_end_date = actualendtime,
                        feedback_id = feedbackid
                    WHERE
                        original_node_id = feedbacknodeoriginalid;

                END IF;

            END;
        END IF;
--2、项目主项计划反馈时，更新月度计划引入的项目主项计划节点，【完成反馈】更新节点实际开始时间和实际完成时间，【未完成反馈】【过程反馈】更新节点预计开始时间和预计完成时间。

        IF feedbacktype = 'CARRY_OUT' AND plantype = 'MAIN_ITEM' and approvalstatus='已审核'   THEN --项目主项计划，完成反馈
                --更新月度计划，引入项目的未完成节点，条件 实际完成日期为空
            UPDATE pom_proj_plan_node
            SET
                actual_start_date = estimatestarttime,
                actual_end_date = estimateendtime,
                feedback_id = feedbackid
            WHERE
                original_node_id = feedbacknodeoriginalid
                AND actual_end_date IS NULL;

        ELSIF ( feedbacktype = 'PROCESS' OR feedbacktype = 'CARRY_OUT' ) AND plantype = 'MAIN_ITEM' and approvalstatus='已审核'   THEN --项目主项计划，过程反馈，未完成反馈
            UPDATE pom_proj_plan_node
            SET
                estimate_start_date = estimatestarttime,
                estimate_end_date = estimateendtime,
                feedback_id = feedbackid
            WHERE
                original_node_id = feedbacknodeoriginalid
                AND actual_end_date IS NULL;
                --更新月度计划，引入项目的未完成节点

        END IF;

--3、关键节点计划、项目主项计划、部门月度计划。完成反馈，根据考核规则计算得分，生成数据到考核表。

    EXCEPTION
        WHEN OTHERS THEN
           return;
    END;
END p_pom_feedback_approval_cb;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_FEEDBACK_APPROVAL_CODE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_FEEDBACK_APPROVAL_CODE" 
(
		FEEDBACKID    IN VARCHAR2 --反馈id
	 ,FORMCODE      OUT VARCHAR2 --表单编码
	 ,FORMGROUPCODE OUT VARCHAR2 --表单分组编码
) AS
		--反馈工作流审批时获取审批需要的表单编码和分组编码
		--作者：陈丽
		--日期：2019/11/13
		V_NODE_TYPE VARCHAR2(100);
BEGIN

		SELECT A.NODE_SOURCE_PLAN_TYPE INTO V_NODE_TYPE FROM POM_NODE_FEEDBACK A WHERE A.ID = FEEDBACKID;

		IF V_NODE_TYPE = 'KEY_NODE' THEN
				FORMCODE := 'pom_feedback_key_nodes';
		ELSIF V_NODE_TYPE = 'MAIN_ITEM' THEN
				FORMCODE := 'pom_feedback_main_nodes';
		ELSE
				FORMCODE := 'pom_feedback_key_nodes';
		END IF;
/*		FORMCODE := 'pom_feedback_key_nodes';*/
		FORMGROUPCODE := '';
END P_POM_FEEDBACK_APPROVAL_CODE;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_GET_PORTAL_COMPLETE_MSG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_GET_PORTAL_COMPLETE_MSG" (
    bizid   IN      VARCHAR2,--业务id-即反馈id
    info    OUT     SYS_REFCURSOR--消息集合
) IS
--已办/已阅/取关消息获取，即（0：待办，10：待阅，20：关注）的已处理数据
--作者：陈丽
--日期：2020/01/09

    nodeid           VARCHAR2(36);
    nodeoriginalid   VARCHAR2(36);
    feedbackerid     VARCHAR2(36);
    ownercode        VARCHAR2(50);
BEGIN

--查询节点id 推送已办消息
  
  --要和传科沟通调整为原始id，不容易出错
    SELECT
        feedback_node_id,
        feedbacker_id,
        feedback_node_original_id
    INTO
        nodeid,
        feedbackerid,
        nodeoriginalid
    FROM
        pom_node_feedback
    WHERE
        id = bizid;

    dbms_output.put_line('打印' || nodeoriginalid);
    OPEN info FOR SELECT
                      '0' "msgType",--任务类型（0：待办，10：待阅，20：关注）
                      nodeid            AS "taskId",--任务ID
                      b1.user_account   AS "ownerName",--拥有人
                      'v-xufeng' AS "creatorName",--创建人
                      'http://pom.crccre.cn/pom/pom/middle?originalUrl='
                      || url_encode('http://pom.crccre.cn/pom/pom/mission-center-feedback/my-responsible-task?cancelType=0'
                                    || CHR(38)
                                    || 'id='
                                    || a.proj_plan_id
                                    || CHR(38)
                                    || 'feedbackNodeId='
                                    || a.id
                                    || CHR(38)
                                    || 'feedbackNodeOriginalId='
                                    || a.original_node_id
                                    || CHR(38)
                                    || 'nodeSourcePlanType=1') AS "pcUrl",--应用系统的url地址
                      'https://www.baidu.com' AS "mobileUrl",--应用系统的手机端url地址
                      SYSDATE           AS "created",--创建时间
                      SYSDATE           AS "expireTime",--创建时间
                      SYSDATE           AS "completeTime",--完成时间
                      trunc(SYSDATE) + 1 AS "expireTime",
                      '【节点超期预警】【'
                      || a.proj_name
                      || '-'
                      || a.plan_type
                      || '-'
                      || a.node_name
                      || '】超期'
                      || TO_CHAR(trunc(SYSDATE) - a.plan_end_date)
                      || '天预警' AS "taskName",--任务名称
                      '计划运营' AS "typeName",--任务类型
                      '1' AS "priority",--优先级
                      '测试计划运营推送已办到门户' AS "remark",--备注
                      'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "sourceAppId"--应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段
                  FROM
                      v_pom_node_dt                   a
                      LEFT JOIN sys_role_user_relation_result   b1 ON b1.dept_id = a.duty_department_id
                                                                    AND b1.virtual_group_name = '部门计划专员'
                  WHERE
                      original_node_id = ''
                                         || nodeoriginalid
                                         || '';

--    OPEN info FOR SELECT
--                     '0' "msgType",--任务类型（0：待办，10：待阅，20：关注）
--                     '32' AS "taskId",--任务ID
--                     'yuzheng1' AS "ownerName",--拥有人
--                     'v-xufeng' AS "creatorName",--创建人
--                     'https://www.baidu.com' AS "pcUrl",--应用系统的url地址
--                     'https://www.baidu.com' AS "mobileUrl",--应用系统的手机端url地址
--                     SYSDATE   AS "created",--创建时间
--                     SYSDATE   AS "expireTime",--创建时间
--                     SYSDATE   AS "completeTime",--完成时间
--                     trunc(SYSDATE) + 1 AS "expireTime",
--                     '计划运营-测试' AS "taskName",--任务名称
--                     '计划运营' AS "typeName",--任务类型
--                     '1' AS "priority",--优先级
--                     '测试计划运营推送已办到门户' AS "remark",--备注
--                     'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "sourceAppId"--应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段
--                 FROM
--                     dual;

END p_pom_get_portal_complete_msg;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_GET_PUSH_PORTAL_MSG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_GET_PUSH_PORTAL_MSG" (INFO OUT SYS_REFCURSOR --消息集合
																											) IS
		--待办/待阅/关注消息获取 废弃使用【p_pom_portal_msg】
		--作者：陈丽
		--日期：2020/01/09
BEGIN
		OPEN INFO FOR
		
		--超期任务提醒
				SELECT 0 AS "msgType", A.ORIGINAL_NODE_ID AS "taskId", B1.USER_ACCOUNT AS "ownerName", 'v-xufeng' AS "creatorName",
							 'http://pom.crccre.cn/pom/pom/middle?originalUrl=' ||
								URL_ENCODE('http://pom.crccre.cn/pom/pom/mission-center-feedback/my-responsible-task?cancelType=0' || CHR(38) || 'id=' || A.PROJ_PLAN_ID || CHR(38) || 'feedbackNodeId=' || A.ID ||
													 CHR(38) || 'feedbackNodeOriginalId=' || A.ORIGINAL_NODE_ID || CHR(38) || 'nodeSourcePlanType=1') AS "pcUrl", '' AS "mobileUrl", SYSDATE AS "created",
							 TRUNC(SYSDATE) + 1 AS "expireTime", '【节点超期预警】【' || A.PROJ_NAME || '-' || A.PLAN_TYPE || '-' || A.NODE_NAME || '】超期' || TO_CHAR(TRUNC(SYSDATE) - A.PLAN_END_DATE) || '天预警' AS "taskName",
							 '计划运营' AS "typeName",1 AS "priority", '' AS "remark"
, 'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "sourceAppId",meg.MESSAGE_MSG_TYPE AS "messageMsgType"
				FROM   V_POM_NODE_DT A
				LEFT   JOIN SYS_ROLE_USER_RELATION_RESULT B1
				ON     B1.DEPT_ID = A.DUTY_DEPARTMENT_ID AND
							 B1.VIRTUAL_GROUP_NAME = '部门计划专员'
				LEFT JOIN SYS_MESSAGE_CENTER meg
				ON meg.TASK_ID=A.id AND meg.CREATED-SYSDATE=0
				WHERE  A.FINISH_NO_STATUS_TYPE = '超期未完成' AND
							 NOT EXISTS (SELECT 1
								FROM   SYS_MESSAGE_CENTER_PUSH_RECORD P
								WHERE  P.RESPONSE_RESULTS LIKE '%{"errcode":0%' AND
											 TRUNC(SYSDATE) - TRUNC(P.REQUEST_TIME) = 0 AND
											 A.ID = P.TASK_ID AND
											 B1.USER_ACCOUNT = P.OWNER_NAME) AND
							 B1.USER_ACCOUNT IS NOT NULL AND b1.USER_ACCOUNT = 'zhangzhuohan';


/*		SELECT '0' "msgType",
            --任务类型（0：待办，10：待阅，20：关注）
           '32' AS "taskId",
            --任务ID
           'yuzheng1' AS "ownerName",
            --拥有人
           'v-xufeng' AS "creatorName",
            --创建人
           'http://pom.crccre.cn/pom/pom/middle?originalUrl='||url_encode('http://pom.crccre.cn/pom/pom/mission-center-feedback/my-responsible-task?cancelType=0&id=d209390c-3471-4b98-a719-219f6da5c609&feedbackNodeId=00c63db3-6bca-494f-b74a-e62e6b540f3a&feedbackNodeOriginalId=00c63db3-6bca-494f-b74a-e62e6b540f3a&nodeSourcePlanType=1') AS "pcUrl",
            --应用系统的url地址 不用改变这串字符（http://pom.crccre.cn/pom//pom/middle?originalUrl=），注意只能打开计划系统，如要打开其他系统需要开发  
           'https://www.baidu.com' AS "mobileUrl",
            --应用系统的手机端url地址
           SYSDATE AS "created",
            --创建时间
           SYSDATE AS "expireTime",
            --过期时间
           'huangw衡泽-测试-待办' || TO_CHAR(SYSDATE, 'yyyy-mm-ddhh24:mi:ss') AS "taskName",
            --任务名称
           '计划运营' AS "typeName",
            --任务类型
           '1' AS "priority",
            --优先级
           '测试计划运营推送待办到门户' AS "remark",
            --备注
           'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "sourceAppId" --应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段
    FROM   DUAL;*/

END P_POM_GET_PUSH_PORTAL_MSG;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_JUDGE_FISSION_RESULT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_JUDGE_FISSION_RESULT" 
(
    projectId      IN NVARCHAR2  --项目or 分期id
   ,permitType  IN NVARCHAR2 --证照类型
   ,planNodeId  IN NVARCHAR2 ---节点id
   ,result OUT INT --返回值
) AS
BEGIN
   DECLARE  
    v_count INT :=0;
    BEGIN
    select count(*) INTO result
from mdm_permit_bld mb
inner join (select *
   from mdm_permit mp
   inner join(select *
       from POM_NODE_FEEDBACK nf
       inner join (select id, fission_source_original_id
           from pom_proj_plan_node a
           start with a.id = ''||planNodeId||''
           CONNECT BY PRIOR a.fission_source_original_id = a.id
       ) n on nf.FEEDBACK_NODE_ID = n.id and n.id is not null
   ) f on mp.id = f.PERMIT_ID and mp.approval_status='已审核'
) m on mb.permit_id = m.id and mb.id is not null
right join (
        SELECT A.id 
        FROM   MDM_BUILD A
        INNER  JOIN MDM_BUILD_PHASE B
        ON     A.ID = B.BUILD_ID
        INNER  JOIN MDM_OBJ_PHASE_INDEX C
        ON     C.OBJ_PHASE_ID = B.ID
        INNER  JOIN (SELECT B1.PRODUCT_TYPE_CODE, A1.*
                     FROM   MDM_OBJ_PHASE_PT_INDEX A1
                     INNER  JOIN MDM_BUILD_PRODUCT_TYPE B1
                     ON     A1.PRODUCT_TYPE_ID = B1.ID) D
        ON     D.OBJ_PHASE_ID = B.ID
        LEFT   JOIN (SELECT B3.BUILD_ID, B3.ID AS OBJ_PHASE_ID, A3.BUILD_AREA,
                            A3.GROUND_TOTAL_BUILD_AREA,
                            A3.UNDERGROUND_TOTAL_BUILD_AREA
                     FROM   MDM_OBJ_PHASE_PT_INDEX A3
                     INNER  JOIN MDM_BUILD_PHASE B3
                     ON     A3.OBJ_PHASE_ID = B3.ID AND
                            B3.PHASE_NAME = '竣工备案证阶段') F
        ON     F.BUILD_ID = A.ID AND
               F.OBJ_PHASE_ID = B.ID
        WHERE  EXISTS (SELECT 1
                FROM   (SELECT ROW_NUMBER() OVER(PARTITION BY A.ID ORDER BY C.PHASE_ORDER DESC) AS PRANK,
                                A.ID BUILDID, C.PHASE_ORDER PHASEORDER,
                                C.PHASE_NAME PHASENAME, C.ID PHASEID
                         FROM   MDM_BUILD A
                         INNER  JOIN MDM_BUILD_PHASE B
                         ON     A.ID = B.BUILD_ID
                         INNER  JOIN MDM_PHASE C
                         ON     B.PHASE_ID = C.ID) P
                WHERE  P.PRANK = 1 AND
                       P.PHASEID = B.PHASE_ID AND
                       P.BUILDID = A.ID) AND A.BUILD_STATE = 10
                      AND   A.PERIOD_ID =''||projectId||''  OR A.PROJ_ID=''||projectId||''
        ORDER  BY BUILD_NAME
) t on mb.bld_id = t.id
where mb.bld_id is null;
    END;
end;
--==========================项目主项计划监控解析计划专员===================

/
--------------------------------------------------------
--  DDL for Procedure P_POM_KEY_NODE_ALREADY_DELAY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_KEY_NODE_ALREADY_DELAY" (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    orgid          IN             VARCHAR2,--组织id(）
    title          OUT            VARCHAR2,
    info           OUT            SYS_REFCURSOR--需要程序组装树,并汇总子级数据
) AS
--关键节点计划监控-当前一出现延误项目
--作者：陈丽
--日期：2019/11/13
BEGIN
    OPEN info FOR SELECT
                      '西南公司' AS "orgName",--组织名
                      '1' AS "orgId",---组织id
                      '' AS "parentId",--父级id
                      '100' AS "projDelay",--已延误项目数量
                      '1' AS "periodDelay",--已延误分期数量
                      '1' AS "nodeDelay",--已延误节点数量
                      '1' AS "startWorkDelay",--开工节点延误数量
                      '10' AS "openPlateDelay",--开盘节点延误数量
                      '' AS "openUrl"--打开地址，无数据不打开
                  FROM
                      dual
                  UNION ALL
                  SELECT
                      '华南公司' AS "orgName",--组织名
                      '2' AS "orgId",---组织id
                      '' AS "parentId",--父级id
                      '100' AS "projDelay",--已延误项目数量
                      '1' AS "periodDelay",--已延误分期数量
                      '1' AS "nodeDelay",--已延误节点数量
                      '1' AS "startWorkDelay",--开工节点延误数量
                      '10' AS "openPlateDelay",--开盘节点延误数量
                      '' AS "openUrl"--打开地址
                  FROM
                      dual
                  UNION ALL
                  SELECT
                      '华东公司' AS "orgName",--组织名
                      '3' AS "orgId",---组织id
                      '' AS "parentId",--父级id
                      '100' AS "projDelay",--已延误项目数量
                      '1' AS "periodDelay",--已延误分期数量
                      '1' AS "nodeDelay",--已延误节点数量
                      '1' AS "startWorkDelay",--开工节点延误数量
                      '10' AS "openPlateDelay",--开盘节点延误数量
                      '' AS "openUrl"--打开地址
                  FROM
                      dual
                  UNION ALL
                  SELECT
                      '北方公司' AS "orgName",--组织名
                      '4' AS "orgId",---组织id
                      '' AS "parentId",--父级id
                      '100' AS "projDelay",--已延误项目数量
                      '1' AS "periodDelay",--已延误分期数量
                      '1' AS "nodeDelay",--已延误节点数量
                      '1' AS "startWorkDelay",--开工节点延误数量
                      '10' AS "openPlateDelay",--开盘节点延误数量
                      '' AS "openUrl"--打开地址
                  FROM
                      dual
                  UNION ALL
                  SELECT
                      '事业部1' AS "orgName",--组织名
                      '5' AS "orgId",---组织id
                      '1' AS "parentId",--父级id
                      '100' AS "projDelay",--已延误项目数量
                      '1' AS "periodDelay",--已延误分期数量
                      '1' AS "nodeDelay",--已延误节点数量
                      '1' AS "startWorkDelay",--开工节点延误数量
                      '10' AS "openPlateDelay",--开盘节点延误数量
                      '' AS "openUrl"--打开地址
                  FROM
                      dual
                  UNION ALL
                  SELECT
                      '事业部1' AS "orgName",--组织名
                      '6' AS "orgId",---组织id
                      '5' AS "parentId",--父级id
                      '100' AS "projDelay",--已延误项目数量
                      '1' AS "periodDelay",--已延误分期数量
                      '1' AS "nodeDelay",--已延误节点数量
                      '1' AS "startWorkDelay",--开工节点延误数量
                      '10' AS "openPlateDelay",--开盘节点延误数量
                      '' AS "openUrl"--打开地址
                  FROM
                      dual;

END p_pom_key_node_already_delay;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_KEY_NODE_COMPLETION_RATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_KEY_NODE_COMPLETION_RATE" 
(
		ORGID          IN VARCHAR2 := '003200000000000000000000000000'
	 ,DATASCOPE      IN VARCHAR2
	 ,PLANTYPE       IN VARCHAR2
	 ,SEARCHKEY      IN VARCHAR2
	 ,COMPLETIONRATE OUT SYS_REFCURSOR
) AS
		--关键节点计划监控-关键节点完成率查询
		--作者：陈丽
		--日期：2019/11/13
		--查询2级单位SELECT * from  SYS_BUSINESS_UNIT A WHERE  A.COMPANY_TYPE='5' AND  PARENT_ID='003200000000000000000000000000'
    

		
BEGIN

		IF DATASCOPE = 'thisMonth' THEN
				OPEN COMPLETIONRATE FOR
				--月份
						SELECT 
						   CASE WHEN A.LEVEL_RANK=1 THEN '集团'  WHEN A.LEVEL_RANK=2 THEN '二级'  WHEN A.LEVEL_RANK=3 THEN '三级'  WHEN A.LEVEL_RANK=4 THEN '项目'  ELSE '项目'   END  AS "rightLable",--角标
										ISDELAY AS "delayedTotal",--已延误
										TO_CHAR(ISFINISHTOTAL)||'/'||	TO_CHAR(NODESUM) AS "completionRateDescription",
										ISFINISHTOTAL AS "completedTotal",--已完成
										NODESUM AS "shouldComplete",--应完成
									 CASE 
									 WHEN A.CTYPE = 'TYPE_PROJLAST'
									 THEN 	'/smart/dialog/page?height=75%25&width=1220&title=本月已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=1&planType=XXX'  
									 WHEN CTYPE='TYPE_ORG' 
									 THEN '/smart/dialog/page?height=75%25&width=1220&title=本月已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=1&planType=XXX'  
								ELSE	 '/smart/dialog/page?height=75%25&width=1220&title=本月已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=1&planType=XXX'  
									END  AS "delayedTotalUrl",--已延误 跳转地址为空前端不做跳转，只需要调整项目id
  	 CASE WHEN A.CTYPE = 'TYPE_PROJLAST'
		 THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本月已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=2&planType=XXX'  
		 WHEN CTYPE='TYPE_ORG' THEN   '/smart/dialog/page?height=75%25&width=1220&title=本月已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=2&planType=XXX'  
		ELSE'/smart/dialog/page?height=75%25&width=1220&title=本月已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=2&planType=XXX'  
	END  AS "completedTotalUrl",--已完成 跳转地址为空前端不做跳转
            	 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' 
											THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本月应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=3&planType=XXX'  						 WHEN CTYPE='TYPE_ORG'
											THEN '/smart/dialog/page?height=75%25&width=1220&title=本月应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=3&planType=XXX'  
				ELSE '/smart/dialog/page?height=75%25&width=1220&title=本月应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=3&planType=XXX'  
				END   AS "shouldCompleteUrl",--应完成 跳转地址为空前端不做跳转
									 --右上角显示排序
									 NVL(A.ID, ORGID) AS "orgId",
									 --ID
									 A.ORG_NAME AS "orgName",
									 --显示名称
									 A.FINLISHRATE AS "completionRate",
									 --完成率
									 A.DELAYFINISHTOTAL AS "delayCompleteTotal",
									 --延迟完成
									 A.ADVANCEFINISHTOTAL AS "advanceCompleteTotal",
									 --提前完成
									 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN
									  '/pom/plan-assess/node-monitoring/plan-nodes?companyid='||COMPANY_ID||'&ppid='||a.ID||'&planType=关键节点计划'
									ELSE
									 '' || ORGID || ''
							END  AS "clickOperationTypeContent",
									 --穿透ID
									 '#00e18f' AS "completionRateColor",
									 --颜色
									 CASE
												WHEN  A.CTYPE = 'TYPE_PROJLAST' THEN
												 '2'
												ELSE
												 '1'
										END AS "clickOperationType",
									 --穿透类型
									 0 AS "isRoot", '' || ORGID || '' AS "parentId"
									 --父级ID
									 , 'ThisMoth' AS "dataScope" --范围
						--A表项目计划主表计划类别通过TYPE判断
						FROM   V_POM_PJMOTHPLAN_STATISTICS A
						WHERE  PARENT_ID = '' || ORGID || '' AND
									 NODESUM > 0 /*AND a.ORG_NAME NOT LIKE '%无分期%'*/
						--AND  dataScope='thisMonth'
						
						UNION ALL
						SELECT  CASE WHEN A.LEVEL_RANK=1 THEN '集团'  WHEN A.LEVEL_RANK=2 THEN '二级'  WHEN A.LEVEL_RANK=3 THEN '三级'  WHEN A.LEVEL_RANK=4 THEN '项目'  ELSE '项目'   END AS "rightLable", 
                                          ISDELAY AS "delayedTotal",--已延误
																		TO_CHAR(ISFINISHTOTAL)||'/'||	TO_CHAR(NODESUM) AS "completionRateDescription",
                                    ISFINISHTOTAL AS "completedTotal",--已完成
                                    NODESUM AS "shouldComplete",--应完成
                                   CASE 
																			WHEN A.CTYPE = 'TYPE_PROJLAST'
																				THEN 	'/smart/dialog/page?height=75%25&width=1220&title=本月已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=1&planType=XXX'  
																			WHEN CTYPE='TYPE_ORG'
																				THEN '/smart/dialog/page?height=75%25&width=1220&title=本月已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=1&planType=XXX' 
		ELSE	'/smart/dialog/page?height=75%25&width=1220&title=本月已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=1&planType=XXX'   END  AS "delayedTotalUrl",--已延误 跳转地址为空前端不做跳转，只需要调整项目id
																	CASE WHEN A.CTYPE = 'TYPE_PROJLAST'
																			THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本月已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=2&planType=XXX' 
																			WHEN CTYPE='TYPE_ORG' 
																				THEN  '/smart/dialog/page?height=75%25&width=1220&title=本月已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=2&planType=XXX' 
																			ELSE '/smart/dialog/page?height=75%25&width=1220&title=本月已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=2&planType=XXX' 
		END  AS "completedTotalUrl",--已完成 跳转地址为空前端不做跳转
            	 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本月应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=3&planType=XXX' 
							 WHEN CTYPE='TYPE_ORG' THEN  '/smart/dialog/page?height=75%25&width=1220&title=本月应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=3&planType=XXX' 
						ELSE 	 '/smart/dialog/page?height=75%25&width=1220&title=本月应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=3&planType=XXX' 
							END   AS "shouldCompleteUrl",--应完成 跳转地址为空前端不做跳转
                                        NVL(A.ID, ORGID) AS "orgId",
									 A.ORG_NAME AS "orgName",
									 A.FINLISHRATE AS "completionRate",
									 A.DELAYFINISHTOTAL AS "delayCompleteTotal",
									 A.ADVANCEFINISHTOTAL AS "advanceCompleteTotal",
									 -------------------chenl集团点击时还是加载集团下的数据
									 CASE
												WHEN ID = '003200000000000000000000000000' THEN
												'003200000000000000000000000000'
												ELSE
												  A.PARENT_ID
										END AS "clickOperationTypeContent",
                                    -------------------chenl集团点击时还是加载集团下的数据
									 '#00e18f' AS "completionRateColor",
									 '1' AS "clickOperationType", 1 AS "isRoot",
									 CASE
												WHEN ID = '003200000000000000000000000000' THEN
												 NULL
												ELSE
												 PARENT_ID
										END AS "parentId", 'ThisMoth' AS "dataScope"
						FROM   V_POM_PJMOTHPLAN_STATISTICS A
						WHERE  ID = '' || ORGID || '' AND
									 NODESUM > 0
								ORDER BY 11  desc 	
									/*AND a.ORG_NAME NOT LIKE '%无分期%'*/; --AND  dataScope='thisMonth';

		ELSIF DATASCOPE = 'thisQuarter' THEN
				OPEN COMPLETIONRATE FOR
				--季度
						SELECT --TO_CHAR(RANK)
					CASE WHEN A.LEVEL_RANK=1 THEN '集团'  WHEN A.LEVEL_RANK=2 THEN '二级'  WHEN A.LEVEL_RANK=3 THEN '三级'  WHEN A.LEVEL_RANK=4 THEN '项目'  ELSE '项目'   END  	AS "rightLable",
						 --右上角显示排序
                          ISDELAY AS "delayedTotal",--已延误
													TO_CHAR(ISFINISHTOTAL)||'/'||	TO_CHAR(NODESUM) AS "completionRateDescription",
                                    ISFINISHTOTAL AS "completedTotal",--已完成
                                    NODESUM AS "shouldComplete",--应完成
									 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	'/smart/dialog/page?height=75%25&width=1220&title=本季度已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=1&planType=XXX'   WHEN CTYPE='TYPE_ORG' THEN '/smart/dialog/page?height=75%25&width=1220&title=本季度已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=1&planType=XXX' 
	ELSE	'/smart/dialog/page?height=75%25&width=1220&title=本季度已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=1&planType=XXX' 
									END  AS "delayedTotalUrl",--已延误 跳转地址为空前端不做跳转，只需要调整项目id
  	 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本季度已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=2&planType=XXX'  WHEN CTYPE='TYPE_ORG' THEN   '/smart/dialog/page?height=75%25&width=1220&title=本季度已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=2&planType=XXX' 
else	 	'/smart/dialog/page?height=75%25&width=1220&title=本季度已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=2&planType=XXX' 
	
	END  AS "completedTotalUrl",--已完成 跳转地址为空前端不做跳转
            	 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本季度应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=3&planType=XXX'   WHEN CTYPE='TYPE_ORG' THEN '/smart/dialog/page?height=75%25&width=1220&title=本季度应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=3&planType=XXX'
		else		'/smart/dialog/page?height=75%25&width=1220&title=本季度应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=3&planType=XXX'
					END   AS "shouldCompleteUrl",--应完成 跳转地址为空前端不做跳转
									 --右上角显示排序
						 NVL(A.ID, ORGID) AS "orgId",
						 --ID
						 A.ORG_NAME AS "orgName",
						 --显示名称
						 A.FINLISHRATE AS "completionRate",
						 --完成率
						 A.DELAYFINISHTOTAL AS "delayCompleteTotal",
						 --延迟完成
						 A.ADVANCEFINISHTOTAL AS "advanceCompleteTotal",
						 --提前完成
						 CASE WHEN ID = '003200000000000000000000000000' OR A.CTYPE = 'TYPE_PROJLAST' THEN
									 '/pom/plan-assess/node-monitoring/plan-nodes?companyid='||COMPANY_ID||'&ppid='||a.ID||'&planType=关键节点计划'
									ELSE
									 '' || ORGID || ''
							END  AS "clickOperationTypeContent",
						 --穿透ID
						 '#00e18f' AS "completionRateColor",
						 --颜色
						 CASE
									WHEN ID = '003200000000000000000000000000' OR A.CTYPE = 'TYPE_PROJLAST' THEN
									 '2'
									ELSE
									 '1'
							END AS "clickOperationType",
						 --穿透类型
						 0 AS "isRoot", '' || ORGID || '' AS "parentId"
						 --父级ID
						 , 'ThisQuarter' AS "dataScope" --范围
						--A表项目计划主表计划类别通过TYPE判断
						
						FROM   V_POM_PJQUARTERPLAN_STATISTICS A
						WHERE  PARENT_ID = '' || ORGID || '' AND
									 NODESUM > 0 /*AND a.ORG_NAME NOT LIKE '%无分期%'*/ --AND  dataScope='thisQuarter'
						
						UNION ALL
						SELECT  CASE WHEN A.LEVEL_RANK=1 THEN '集团'  WHEN A.LEVEL_RANK=2 THEN '二级'  WHEN A.LEVEL_RANK=3 THEN '三级'  WHEN A.LEVEL_RANK=4 THEN '项目'  ELSE '项目'   END   AS "rightLable",
                                         ISDELAY AS "delayedTotal",--已延误
																				 	TO_CHAR(ISFINISHTOTAL)||'/'||	TO_CHAR(NODESUM) AS "completionRateDescription",
                                    ISFINISHTOTAL AS "completedTotal",--已完成
								NODESUM AS "shouldComplete",--应完成
								CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	'/smart/dialog/page?height=75%25&width=1220&title=本季度已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=1&planType=XXX' WHEN CTYPE='TYPE_ORG' THEN  '/smart/dialog/page?height=75%25&width=1220&title=本季度已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=1&planType=XXX' 
						ELSE 	'/smart/dialog/page?height=75%25&width=1220&title=本季度已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=1&planType=XXX' 
							END  AS "delayedTotalUrl",--已延误 跳转地址为空前端不做跳转，只需要调整项目id
  	 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本季度已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=2&planType=XXX'  WHEN CTYPE='TYPE_ORG' THEN  '/smart/dialog/page?height=75%25&width=1220&title=本季度已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=2&planType=XXX'  ELSE  '/smart/dialog/page?height=75%25&width=1220&title=本季度已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=2&planType=XXX'  END  AS "completedTotalUrl",--已完成 跳转地址为空前端不做跳转
            	 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本季度应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=3&planType=XXX' WHEN CTYPE='TYPE_ORG' THEN  '/smart/dialog/page?height=75%25&width=1220&title=本季度应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=3&planType=XXX'  ELSE '/smart/dialog/page?height=75%25&width=1220&title=本季度应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=3&planType=XXX'  END   AS "shouldCompleteUrl",--应完成 跳转地址为空前端不做跳转
                                    NVL(A.ID, ORGID) AS "orgId",
									 A.ORG_NAME AS "orgName",
									 A.FINLISHRATE AS "completionRate",
									 A.DELAYFINISHTOTAL AS "delayCompleteTotal",
									 A.ADVANCEFINISHTOTAL AS "advanceCompleteTotal",
									 -------------------chenl集团点击时还是加载集团下的数据
									 CASE
												WHEN ID = '003200000000000000000000000000' THEN
												'003200000000000000000000000000'
												ELSE
												  A.PARENT_ID
										END AS "clickOperationTypeContent",
                                    -------------------chenl集团点击时还是加载集团下的数据
									 '#00e18f' AS "completionRateColor",
									 CASE
												WHEN ID = '003200000000000000000000000000' OR A.CTYPE = 'TYPE_PROJLAST' THEN
												 '2'
												ELSE
												 '1'
										END AS "clickOperationType", 1 AS "isRoot",
									 CASE
												WHEN ID = '003200000000000000000000000000' THEN
												 NULL
												ELSE
												 PARENT_ID
										END AS "parentId", 'ThisQuarter' AS "dataScope"
						FROM   V_POM_PJQUARTERPLAN_STATISTICS A
						WHERE  ID = '' || ORGID || '' AND
									 NODESUM > 0 
									 ORDER BY 11 desc 	
									 /*AND a.ORG_NAME NOT LIKE '%无分期%'*/; --AND  dataScope='thisQuarter';
		ELSIF DATASCOPE = 'thisYear' THEN
				OPEN COMPLETIONRATE FOR
				--年度
						SELECT
						CASE WHEN A.LEVEL_RANK=1 THEN '集团'  WHEN A.LEVEL_RANK=2 THEN '二级'  WHEN A.LEVEL_RANK=3 THEN '三级'  WHEN A.LEVEL_RANK=4 THEN '项目'  ELSE '项目'   END   AS "rightLable",
						 --右上角显示排序
                          ISDELAY AS "delayedTotal",--已延误
														TO_CHAR(ISFINISHTOTAL)||'/'||	TO_CHAR(NODESUM) AS "completionRateDescription",
                                    ISFINISHTOTAL AS "completedTotal",--已完成
                                    NODESUM AS "shouldComplete",--应完成
									 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	'/smart/dialog/page?height=75%25&width=1220&title=本年已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=1&planType=XXX'  WHEN CTYPE='TYPE_ORG' THEN '/smart/dialog/page?height=75%25&width=1220&title=本年已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=1&planType=XXX'
								ELSE 	 '/smart/dialog/page?height=75%25&width=1220&title=本年已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=1&planType=XXX'
									END  AS "delayedTotalUrl",--已延误 跳转地址为空前端不做跳转，只需要调整项目id
  	 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本年已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=2&planType=XXX'  WHEN CTYPE='TYPE_ORG' THEN   '/smart/dialog/page?height=75%25&width=1220&title=本年已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=2&planType=XXX'   ELSE '/smart/dialog/page?height=75%25&width=1220&title=本年已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=2&planType=XXX'   END  AS "completedTotalUrl",--已完成 跳转地址为空前端不做跳转
            	 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本年应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=3&planType=XXX'  WHEN CTYPE='TYPE_ORG' THEN '/smart/dialog/page?height=75%25&width=1220&title=本年应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=3&planType=XXX' ELSE '/smart/dialog/page?height=75%25&width=1220&title=本年应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=3&planType=XXX' END   AS "shouldCompleteUrl",--应完成 跳转地址为空前端不做跳转
									 --右上角显示排序
						 NVL(A.ID, ORGID) AS "orgId",
						 --ID
						 A.ORG_NAME AS "orgName",
						 --显示名称
						 A.FINLISHRATE AS "completionRate",
						 --完成率
						 A.DELAYFINISHTOTAL AS "delayCompleteTotal",
						 --延迟完成
						 A.ADVANCEFINISHTOTAL AS "advanceCompleteTotal",
						 --提前完成
						 CASE WHEN ID = '003200000000000000000000000000' OR A.CTYPE = 'TYPE_PROJLAST' THEN
									 '/pom/plan-assess/node-monitoring/plan-nodes?companyid='||COMPANY_ID||'&ppid='||a.ID||'&planType=关键节点计划'
									ELSE
									 '' || ORGID || ''
							END  AS "clickOperationTypeContent",
						 --穿透ID
						 '#00e18f' AS "completionRateColor",
						 --颜色
						 CASE
									WHEN ID = '003200000000000000000000000000' OR A.CTYPE = 'TYPE_PROJLAST' THEN
									 '2'
									ELSE
									 '1'
							END AS "clickOperationType",
						 --穿透类型
						 0 AS "isRoot", '' || ORGID || '' AS "parentId"
						 --父级ID
						 , 'ThisYear' AS "dataScope" --范围
						--A表项目计划主表计划类别通过TYPE判断
						
						FROM   V_POM_PJYEARPLAN_STATISTICS A
						WHERE  PARENT_ID = '' || ORGID || '' AND
									 NODESUM > 0 /*AND a.ORG_NAME NOT LIKE '%无分期%'*/ --AND  dataScope='thisYear'
						
						UNION ALL
						SELECT CASE WHEN A.LEVEL_RANK=1 THEN '集团'  WHEN A.LEVEL_RANK=2 THEN '二级'  WHEN A.LEVEL_RANK=3 THEN '三级'  WHEN A.LEVEL_RANK=4 THEN '项目'  ELSE '项目'   END   AS "rightLable", 
                                         ISDELAY AS "delayedTotal",--已延误
																				 	TO_CHAR(ISFINISHTOTAL)||'/'||	TO_CHAR(NODESUM) AS "completionRateDescription",
                                    ISFINISHTOTAL AS "completedTotal",--已完成
                                    NODESUM AS "shouldComplete",--应完成
							 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	'/smart/dialog/page?height=75%25&width=1220&title=本年已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=1&planType=XXX'  WHEN CTYPE='TYPE_ORG' THEN  '/smart/dialog/page?height=75%25&width=1220&title=本年已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=1&planType=XXX'  ELSE'/smart/dialog/page?height=75%25&width=1220&title=本年已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=1&planType=XXX' END  AS "delayedTotalUrl",--已延误 跳转地址为空前端不做跳转，只需要调整项目id
  	 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本年已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=2&planType=XXX'  WHEN CTYPE='TYPE_ORG' THEN  '/smart/dialog/page?height=75%25&width=1220&title=本年已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=2&planType=XXX' ELSE '/smart/dialog/page?height=75%25&width=1220&title=本年已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=2&planType=XXX'   END  AS "completedTotalUrl",--已完成 跳转地址为空前端不做跳转
            	 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本年应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=3&planType=XXX'  WHEN CTYPE='TYPE_ORG' THEN  '/smart/dialog/page?height=75%25&width=1220&title=本年应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=3&planType=XXX' else '/smart/dialog/page?height=75%25&width=1220&title=本年应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=3&planType=XXX'END   AS "shouldCompleteUrl",--应完成 跳转地址为空前端不做跳转
                                        NVL(A.ID, ORGID) AS "orgId",
									 A.ORG_NAME AS "orgName",
									 A.FINLISHRATE AS "completionRate",
									 A.DELAYFINISHTOTAL AS "delayCompleteTotal",
									 A.ADVANCEFINISHTOTAL AS "advanceCompleteTotal",
                                     -------------------chenl集团点击时还是加载集团下的数据
									 CASE
												WHEN ID = '003200000000000000000000000000' THEN
												'003200000000000000000000000000'
												ELSE
												  A.PARENT_ID
										END AS "clickOperationTypeContent",
                                    -------------------chenl集团点击时还是加载集团下的数据
									 '#00e18f' AS "completionRateColor",
									 CASE
												WHEN ID = '003200000000000000000000000000' OR A.CTYPE = 'TYPE_PROJLAST' THEN
												 '2'
												ELSE
												 '1'
										END AS "clickOperationType", 1 AS "isRoot",
									 CASE
												WHEN ID = '003200000000000000000000000000' THEN
												 NULL
												ELSE
												 PARENT_ID
										END AS "parentId", 'ThisYear' AS "dataScope"
						FROM   V_POM_PJYEARPLAN_STATISTICS A
						WHERE  ID = '' || ORGID || '' AND
									 NODESUM > 0 
									 ORDER BY 11 desc 	
									 /*AND a.ORG_NAME NOT LIKE '%无分期%'*/;
		END IF;
		
		
		
		
		
END P_POM_KEY_NODE_COMPLETION_RATE;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_KEY_NODE_CONDITIONS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_KEY_NODE_CONDITIONS" (planType in VARCHAR2
,searchText out VARCHAR2
,promptInfo out VARCHAR2
,description  out VARCHAR2
,dateScope OUT sys_refcursor)
AS  
--关键节点计划监控-关键节点计划条件
--作者：陈丽
--日期：2019/11/13
BEGIN
open dateScope for
select 'thisMonth' as "id",'本月' as "name" from dual
union all
select 'thisQuarter' as "id",'本季' as "name" from dual
union all
select 'thisYear' as "id",'本年' as "name" from dual;
description:= '项目计划按时完成率排名榜';
searchText:='';
promptInfo:='请输入公司名称';
END p_pom_key_node_conditions;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_KEY_NODE_CONDITIONS1
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_KEY_NODE_CONDITIONS1" (planType in VARCHAR2
,searchText out VARCHAR2
,promptInfo out VARCHAR2
,description  out VARCHAR2
,dateScope OUT sys_refcursor)
AS  
--关键节点计划监控-关键节点计划条件
--作者：陈丽
--日期：2019/11/13
BEGIN
open dateScope for
select 'thisMonth' as "id",'本月' as "name" from dual
union all
select 'thisQuarter' as "id",'本季' as "name" from dual
union all
select 'thisYear' as "id",'本年' as "name" from dual;
description:= '项目计划按时完成率排名榜';
searchText:='';
promptInfo:='请输入公司名称';
END p_pom_key_node_conditions1;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_KEY_NODE_DELAY_PROJ
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_KEY_NODE_DELAY_PROJ" 
(
		USERID       IN VARCHAR2
	 , --当前用户id
		STATIONID    IN VARCHAR2
	 , --当前用户岗位id
		DEPARTMENTID IN VARCHAR2
	 , --当前用户部门id
		COMPANYID    IN VARCHAR2
	 , --当前用户公司id
		ORGID        IN VARCHAR2
	 , --组织id(）
		TITLE        OUT VARCHAR2
	 ,INFO         OUT SYS_REFCURSOR --需要程序组装树,并汇总子级数据
) AS
		--关键节点计划监控-当前已出现延误项目
		--作者：陈丽
		--日期：2019/11/13
BEGIN
		OPEN INFO FOR
		WITH TMP_PRO_NODE(ORG_ID,ORGNAME,PARENTID,ORDER_HIERARCHY_CODE,not_finish_node,NO_FINISH_KG_NODE,NO_FINISH_KP_NODE,orgtype,period_delay,project_delay) 
		AS (
			SELECT a.id AS org_id
-- 		,a.id as PPID
			,a.STAGE_NAME AS orgname,a.PROJECT_ID AS parentid,NULL AS ORDER_HIERARCHY_CODE,SUM(CASE WHEN TRUNC(SYSDATE) >= c.PLAN_END_DATE AND c.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END) AS not_finish_node,SUM(CASE WHEN TRUNC(SYSDATE) >= c.PLAN_END_DATE AND c.ACTUAL_END_DATE IS NULL AND C.NODE_NAME = '首开楼栋基础开工' THEN 1 ELSE 0 END) AS NO_FINISH_KG_NODE,SUM(CASE WHEN TRUNC(SYSDATE) >= c.PLAN_END_DATE AND c.ACTUAL_END_DATE IS NULL AND C.NODE_NAME = '首开楼栋达到预售条件' THEN 1 ELSE 0 END) AS NO_FINISH_KP_NODE,'2' AS orgtype,CASE WHEN SUM(CASE WHEN TRUNC(SYSDATE) >= c.PLAN_END_DATE AND c.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END) <> 0 THEN 1 ELSE 0 END AS period_delay,0 AS project_delay
				FROM SYS_PROJECT_STAGE a
				INNER JOIN POM_PROJ_PLAN b ON a.ID = b.PROJ_ID AND b.APPROVAL_STATUS = '已审核' AND b.PLAN_TYPE = '关键节点计划'
				INNER JOIN POM_PROJ_PLAN_NODE c ON b.id = c.PROJ_PLAN_ID
				
				where  c.IS_DISABLE=0 --20200326lxc调整
				GROUP BY a.id,a.STAGE_NAME,a.PROJECT_ID
			UNION ALL
			SELECT A2.ORG_ID,A2.ORGNAME,A2.PARENT_ID,A2.ORDER_HIERARCHY_CODE,A1.not_finish_node,A1.NO_FINISH_KG_NODE,A1.NO_FINISH_KP_NODE,a2.orgtype,a1.period_delay,CASE WHEN/* a1.orgtype<>'2' AND*/ a1.period_delay <> 0 THEN 1 ELSE 0 END  AS project_delay
				FROM TMP_PRO_NODE A1
				INNER JOIN (SELECT a.id AS ORG_ID
-- 				,c.PROJ_ID as ppid
				,A.PROJECT_NAME AS ORGNAME,A.UNIT_ID AS PARENT_ID,A.ORDER_HIERARCHY_CODE,'1' AS orgtype
				FROM SYS_PROJECT A
-- 				INNER JOIN SYS_PROJECT_STAGE b on a.id=b.PROJECT_ID
-- 				INNER JOIN POM_PROJ_PLAN c on c.PROJ_ID=b.id  or c.PROJ_ID=a.id
				--where  c.IS_DISABLE=0 --20200326lxc调整
				UNION ALL 
				SELECT A.ID,A.ORG_NAME,A.PARENT_ID,A.ORDER_HIERARCHY_CODE,'0' AS orgtype
				FROM SYS_BUSINESS_UNIT A
				WHERE A.IS_COMPANY = 1) A2 ON A1.PARENTID = A2.ORG_ID
			 
		)
SELECT *
FROM (		
		SELECT  P.ORGNAME AS "orgName",p.org_id AS "orgId",p.parentid AS "parentId",SUM(p.project_delay) AS "projDelay",SUM(p.period_delay) AS "periodDelay",SUM(p.not_finish_node) AS "nodeDelay",SUM(p.NO_FINISH_KG_NODE) AS "startWorkDelay",SUM(p.NO_FINISH_KP_NODE) AS "openPlateDelay"
		,CASE WHEN p.orgtype = '1' 
			THEN 	'/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||NVL(p.parentid,'003200000000000000000000000002')||'&ppid='|| p.ORG_ID ||'&planType=关键节点计划' 
		WHEN p.orgtype='0' 
			THEN '/smart/dialog/page?functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&companyId='||p.ORG_ID||'&dataScope=thisAll&planType=XXX&pageType=1' END "openUrl"
		FROM TMP_PRO_NODE P
		WHERE p.orgname <> '无分期'
		GROUP BY p.orgname,p.parentid,p.orgtype,p.org_id
		HAVING SUM(p.not_finish_node) > 0
		) aa
		START WITH aa."orgId"=ORGID
		CONNECT BY PRIOR aa."orgId"=aa."parentId"
				;
				

END P_POM_KEY_NODE_DELAY_PROJ;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_KEY_NODE_ORBITAL_WACTH
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_KEY_NODE_ORBITAL_WACTH" 
(
		PROJECTID       IN VARCHAR2
	 ,PROJECTPERIODID IN VARCHAR2
	 ,PLANTYPE        IN VARCHAR2_LIST
	 ,DESCRIPTION     OUT VARCHAR2
	 ,STATES          OUT SYS_REFCURSOR
	 ,ORBITALNODE     OUT SYS_REFCURSOR
) AS
		--关键节点计划监控-轨道图
		--作者：陈丽
		--日期：2019/11/13

		V_SQL CLOB := ''; --拼接SQL字符串
		/*    V_CON    NUMBER(2, 0);*/
		V_PROJECTID VARCHAR2(36);
		V_FLAG      VARCHAR2(10);
		V_PERIODID  VARCHAR2(36);

BEGIN
		OPEN STATES FOR
				SELECT '按时完成' AS "stateDescription", '#60955a' AS "stateColor", 'punctualityComplete' AS "state"
				FROM   DUAL
				UNION ALL
				SELECT '超期5天内完成' AS "stateDescription", '#ff9933' AS "stateColor", 'BeyondComplete' AS "state"
				FROM   DUAL
				UNION ALL
				SELECT '超期5天' AS "stateDescription", '#f00' AS "stateColor", 'beyondUncomplete' AS "state"
				FROM   DUAL
				UNION ALL
				SELECT '未开始' AS "stateDescription", '#ccc' AS "stateColor", 'uncomplete' AS "state"
				FROM   DUAL;

		/*  OPEN ORBITALNODE FOR
    SELECT CASE
             WHEN PLAN_END_DATE < SYSDATE THEN
              'punctualityComplete'
             WHEN PLAN_END_DATE > SYSDATE THEN
              'BeyondComplete'
             ELSE
              'unComplete'
           END AS "nodeState", NODE_NAME AS "nodeName",
           NODE_CODE AS "nodeContent",
           PLAN_END_DATE || '<br/>' || PLAN_END_DATE AS "nodeTime",
           '计划完成日期' || PLAN_END_DATE || '<br/>实际完成日期' || ACTUAL_END_DATE ||
            '<br/>相差天数0' AS "nodeDescription",
           '/basic-settings/standard-node/standard-node?action=Create' "nodeUrl"
    FROM   POM_PROJ_PLAN_NODE;*/

		/*
        遍历PLANTYPE数组
    */
		SELECT P.FLAG INTO V_FLAG FROM (SELECT '项目' AS FLAG FROM SYS_PROJECT_STAGE A WHERE A.PROJECT_ID = PROJECTPERIODID UNION ALL SELECT DISTINCT '分期' FROM SYS_PROJECT_STAGE B WHERE B.ID = PROJECTPERIODID) P;

		IF V_FLAG = '项目' THEN
				SELECT Q.ID
				INTO   V_PERIODID
				FROM   MDM_PROJECT P
				INNER  JOIN MDM_PERIOD_VERSION O
				ON     O.PROJECT_ORIGINAL_ID = P.PROJECT_ORIGINAL_ID AND
							 O.APPROVAL_STATUS = '已审核' AND
							 O.PERIOD_VERSION = (SELECT MAX(PERIOD_VERSION)
																	 FROM   MDM_PERIOD_VERSION
																	 WHERE  PROJECT_ORIGINAL_ID = O.PROJECT_ORIGINAL_ID AND
																					APPROVAL_STATUS = '已审核'
																	 GROUP  BY PROJECT_ORIGINAL_ID)
				INNER  JOIN MDM_PERIOD Q
				ON     O.ID = Q.PERIOD_VERSION_ID
				WHERE  P.PROJECT_ORIGINAL_ID = PROJECTPERIODID AND p.APPROVAL_STATUS = '已审核';
		
		ELSIF V_FLAG = '分期' THEN
				V_PERIODID := PROJECTPERIODID;
		END IF;

		IF V_FLAG = '项目' THEN
		
				V_PROJECTID := PROJECTPERIODID;
		
		ELSIF V_FLAG = '分期' THEN
				SELECT B.PROJECT_ORIGINAL_ID
				INTO   V_PROJECTID
				FROM   MDM_PERIOD A
				INNER  JOIN MDM_PERIOD_VERSION B
				ON     A.PERIOD_VERSION_ID = B.ID AND
							 B.PERIOD_VERSION = (SELECT MAX(PERIOD_VERSION)
																	 FROM   MDM_PERIOD_VERSION
																	 WHERE  PROJECT_ORIGINAL_ID = B.PROJECT_ORIGINAL_ID AND
																					APPROVAL_STATUS = '已审核'
																	 GROUP  BY PROJECT_ORIGINAL_ID)
				WHERE  A.ID = PROJECTPERIODID AND
							 B.APPROVAL_STATUS = '已审核';
		END IF;

		FOR I IN 1 .. PLANTYPE.COUNT
		LOOP
				IF PLANTYPE(I) = '可研计划' THEN
						V_SQL := V_SQL || '
SELECT CASE
					 WHEN B.ACTUAL_END_DATE IS NOT NULL THEN
						(CASE
								WHEN B.ACTUAL_END_DATE - B.PLAN_END_DATE > 5 THEN
								 ''beyondUncomplete''
								 WHEN  B.ACTUAL_END_DATE - B.PLAN_END_DATE <= 5 and B.ACTUAL_END_DATE - B.PLAN_END_DATE > 0 THEN
								 ''BeyondComplete''
								ELSE
								 ''punctualityComplete''
						END)
					 WHEN B.ACTUAL_END_DATE IS NULL THEN
						(CASE
								WHEN SYSDATE - B.PLAN_END_DATE > 5 THEN
								 ''beyondUncomplete''
								ELSE
								 ''uncomplete''
						END)
			 END AS "nodeState", B.NODE_NAME AS "nodeName",
			 B.NODE_CODE AS "nodeContent",
			 ''<div style="
    color: #696969;
">计划完成日期''||''    ''||TO_CHAR(B.PLAN_END_DATE,''YYYY-MM-DD'') || ''<br/>'' ||''实际完成日期''||''    ''||TO_CHAR(NVL(B.ACTUAL_END_DATE, ''''),''YYYY-MM-DD'')|| ''<br/>'' || NVL(''审核完成日期''||''    ''||TO_CHAR(nvl(C.APPROVAL_TIME,B.ACTUAL_END_DATE),''YYYY-MM-DD''), '''')||''</div>'' AS "nodeTime",
			 ''计划完成日期'' ||TO_CHAR( NVL(B.PLAN_END_DATE, SYSDATE),''YYYY-MM-DD'') || ''<br/>实际完成日期'' ||
				NVL(B.ACTUAL_END_DATE, '''') || ''<br/>相差天数'' ||
				NVL(TO_DATE(B.PLAN_END_DATE) - TO_DATE(B.ACTUAL_END_DATE), '''') AS "nodeDescription",
			 ''/pom/mission-center-feedback/my-responsible-task/view-task-information?planId='' || A.ID ||
				CHR(38) || ''nodeSourcePlanType='' || A.PLAN_TYPE || CHR(38) ||
				''feedbackNodeOriginalId='' || B.ORIGINAL_NODE_ID || CHR(38) ||
				''feedbackNodeId='' || B.ID AS "nodeUrl", B.ID AS "nodeId",
			 B.ORIGINAL_NODE_ID AS "originalNodeId"
				FROM   POM_PROJ_PLAN A, POM_PROJ_PLAN_NODE B
				WHERE  A.ID = B.PROJ_PLAN_ID AND
							 A.PROJ_ID = ''' || PROJECTID || '''AND
							 A.PLAN_TYPE = ''' || PLANTYPE(I) || ''' UNION ALL ';
				ELSE
						V_SQL := V_SQL || 'SELECT CASE
					 WHEN B.ACTUAL_END_DATE IS NOT NULL THEN
						(CASE
								WHEN B.ACTUAL_END_DATE - B.PLAN_END_DATE > 5 THEN
								 ''beyondUncomplete''
								 WHEN  B.ACTUAL_END_DATE - B.PLAN_END_DATE <= 5 and B.ACTUAL_END_DATE - B.PLAN_END_DATE > 0 THEN
								 ''BeyondComplete''
								ELSE
								 ''punctualityComplete''
						END)
					 WHEN B.ACTUAL_END_DATE IS NULL THEN
						(CASE
								WHEN SYSDATE - B.PLAN_END_DATE > 5 THEN
								 ''beyondUncomplete''
								 WHEN SYSDATE - B.PLAN_END_DATE <= 5 and SYSDATE - B.PLAN_END_DATE >0  THEN
								 ''beyondcomplete''
								ELSE
								 ''uncomplete''
						END)
			 END AS "nodeState", B.NODE_NAME AS "nodeName",
			 B.NODE_CODE AS "nodeContent",
			 ''<div style="
    color: #696969;
">计划完成日期''||''    ''||TO_CHAR(B.PLAN_END_DATE,''YYYY-MM-DD'') || ''<br/>'' || NVL(''实际完成日期''||''    ''||TO_CHAR(B.ACTUAL_END_DATE,''YYYY-MM-DD''), '''')|| ''<br/>'' || NVL(''审核完成日期''||''    ''||TO_CHAR(nvl(C.APPROVAL_TIME,B.ACTUAL_END_DATE),''YYYY-MM-DD''), '''')||''</div>'' AS "nodeTime",
			 ''计划完成日期'' || to_char(NVL(B.PLAN_END_DATE, SYSDATE),''yyyy-mm-dd'') || ''<br/>实际完成日期'' ||
				to_char(NVL(B.ACTUAL_END_DATE, ''''),''yyyy-mm-dd'') || ''<br/>相差天数'' ||
				NVL(TO_DATE(B.PLAN_END_DATE) - TO_DATE(B.ACTUAL_END_DATE), '''') AS "nodeDescription",
			 ''/pom/mission-center-feedback/my-responsible-task/view-task-information?planId='' || A.ID ||
				CHR(38) || ''nodeSourcePlanType='' || A.PLAN_TYPE || CHR(38) ||
				''feedbackNodeOriginalId='' || B.ORIGINAL_NODE_ID || CHR(38) ||
				''feedbackNodeId='' || B.ID AS "nodeUrl", B.ID AS "nodeId",
			 B.ORIGINAL_NODE_ID AS "originalNodeId"
				FROM   POM_PROJ_PLAN A
				INNER JOIN POM_PROJ_PLAN_NODE B ON A.ID = B.PROJ_PLAN_ID 
				LEFT JOIN POM_NODE_FEEDBACK c ON b.ID = c.FEEDBACK_NODE_ID AND c.FEEDBACK_TYPE = ''CARRY_OUT'' AND c.APPROVAL_STATUS = ''已审核''
        WHERE  b.is_disable = 0 and 
							 A.PROJ_ID = ''' || V_PERIODID || '''AND
							 A.PLAN_TYPE = ''' || PLANTYPE(I) || ''' UNION ALL ';
				END IF;
		END LOOP;

		V_SQL := RTRIM(V_SQL, 'UNION ALL') || ' ORDER BY 3';

		DBMS_OUTPUT.PUT_LINE(V_SQL);

		OPEN ORBITALNODE FOR V_SQL;

		DESCRIPTION := '*节点下方时间取值说明：若任务已完成，取完成时间，若未完成，取计划时间';
END P_POM_KEY_NODE_ORBITAL_WACTH;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_KEY_NODE_SCHEDULE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_KEY_NODE_SCHEDULE" 
(
    companyGUID IN VARCHAR2,
    USERID VARCHAR2,
    STATIONID VARCHAR2,
    DEPTID VARCHAR2,
    COMPANYID VARCHAR2,
    items OUT SYS_REFCURSOR
)IS
    v_sql clob;
    v_id varchar2(100);
    --当前日期
    nowdate date:=trunc(sysdate);
    BIZCODE VARCHAR2(200):='POM.JHJKYKHPH.01';
    DATA_AUTH_SPID VARCHAR2(200);
BEGIN
    IF companyGUID IS NULL THEN
        v_id := '003200000000000000000000000000';
    ELSE
        v_id := companyGUID;
    END IF;

    DECLARE


BEGIN
  P_SYS_GET_COMPANY_PROJ_SPID(
    USERID => USERID,
    STATIONID => STATIONID,
    DEPTID => DEPTID,
    COMPANYID => COMPANYID,
    BIZCODE => BIZCODE,
    DATA_AUTH_SPID => DATA_AUTH_SPID
  );
END;

    -- 轨道图地址
    --/pom/plan-assess/node-monitoring/plan-nodes?companyid=''|| sp.unit_id ||''&ppid=''|| sp.id ||''&planType=关键节点计划''
    open items for   
    WITH
     分期 as(
     select ps.id,ps.STAGE_NAME,ps.PROJECT_ID,proj.PROJECT_NAME,UNIT_ID,to_char(ps.sn,'0.0') as sn
     ,case when 无分期数量=1 and 总分期数量=1 then 1 else 0 end 是无分期 
     from SYS_PROJECT_STAGE ps
     left join SYS_PROJECT proj on ps.PROJECT_ID=proj.id
     left join (select PROJECT_ID,sum(case when STAGE_NAME='无分期' then 1 else 0 end) as 无分期数量,count(PROJECT_ID) as 总分期数量 from SYS_PROJECT_STAGE group by PROJECT_ID)  pcount
     on proj.id=pcount.PROJECT_ID
     )
    ,basedata AS(
    ---查询已审核的分期 关键节点计划 基础信息
   select 
   plan.PROJ_ID
   -- 所有未删除，未禁用的节点
   ,count(node.id) as 有效节点数
   ---
   ,sum(case when  node.PLAN_END_DATE<=nowdate then node.STANDARD_SCORE else 0 end) as 应得总分

--    case 
-- --未到期不亮灯
-- WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<=0  THEN ''
-- --到期当天内完成反馈
-- when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
-- then '<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>'
--  --到期1-5天内完成反馈
-- when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
-- then '<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>'
-- --到期未反馈黄灯 
-- WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 1 and 5
-- THEN  '<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>' 
--  --到期超过5天未反馈红灯 
-- WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(PLAN_END_DATE)) >5) 
-- THEN  '<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>' 
-- ELSE '<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>' END

   --绿灯：到期当天内完成反馈；红灯：①到期超过5天未反馈②超期反馈

   ,sum( case 
     --未到期不亮灯
     WHEN  node.ACTUAL_END_DATE IS NULL AND  TRUNC(SYSDATE)-trunc(node.PLAN_END_DATE)<=0  THEN 0
     --到期当天内完成反馈
     when  node.ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( node.ACTUAL_END_DATE)-trunc(node.PLAN_END_DATE)) <= 0
     then 1
     ELSE  0 END
     ) as 绿灯
     --1-5天内反馈 黄灯：①到期1-5天内完成反馈、②到期15天内未反馈；
   ,sum(    case 
     --未到期不亮灯
     WHEN  node.ACTUAL_END_DATE IS  not  NULL   and  (TRUNC(node.ACTUAL_END_DATE)-trunc(node.PLAN_END_DATE))   BETWEEN 1 and 5
     then 1
     --到期未反馈黄灯 
     WHEN  node.ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(node.PLAN_END_DATE))  BETWEEN 1 and 5
     THEN  1 
     ELSE  0 END
     ) as 黄灯
   -- 超期五天反馈，或超期五天未反馈
   ,sum(    case 
     --未到期不亮灯
     WHEN  node.ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(node.PLAN_END_DATE)) >5 
     THEN  1
     ELSE  0 END
     ) as 红灯

   -- 里程碑节点、计划完成时间<=当天年月日 如 2020-05-25
   ,sum(case when node.NODE_LEVEL='里程碑' and node.PLAN_END_DATE<=nowdate then 1 else 0 end) as 里程碑应完成
   -- 里程碑节点、实际完成时间不为空
   ,sum(case when node.NODE_LEVEL='里程碑' and node.ACTUAL_END_DATE is not null then 1 else 0 end) as 里程碑已完成
   -- 里程碑节点 and 计划完成时间<=当天年月日 and 实际完成时间为空
   ,sum(case when node.NODE_LEVEL='里程碑' and node.PLAN_END_DATE<=nowdate and node.ACTUAL_END_DATE is null then 1 else 0 end) as 里程碑未完成

   ,sum(case when node.NODE_LEVEL='一级节点' and node.PLAN_END_DATE<=nowdate then 1 else 0 end) as 一级应完成
   ,sum(case when node.NODE_LEVEL='一级节点' and node.ACTUAL_END_DATE is not null then 1 else 0 end) as 一级已完成
   ,sum(case when node.NODE_LEVEL='一级节点' and node.PLAN_END_DATE<=nowdate and node.ACTUAL_END_DATE is null then 1 else 0 end) as 一级未完成


   from  POM_PROJ_PLAN_NODE node
   left join POM_PROJ_PLAN plan on node.PROJ_PLAN_ID=plan.id
   --- 未考虑一个节点重复考核情况
   left join POM_NODE_EXAMINATION nodee on node.ORIGINAL_NODE_ID=nodee.ORIGINAL_NODE_ID

   ---已审核、关键节点计划、未禁用节点
   where plan.APPROVAL_STATUS='已审核' 
   and plan.PLAN_TYPE='关键节点计划'
   and node.id is not null
   and node.IS_DISABLE=0
   and node.IS_DELETE=0
   group by plan.PROJ_ID )


   ,项目_分期 as(
   select basedata.PROJ_ID
   ,case when 分期.是无分期=1 then 分期.PROJECT_NAME else 分期.PROJECT_NAME||'-'||分期.STAGE_NAME end as name 
    --统计的父级字段处理，无分期项目父级是公司，有分期项目父级是项目
   ,case when 分期.是无分期=1 then 分期.UNIT_ID else PROJECT_ID end parent_id
   ,有效节点数,应得总分
   ,绿灯,黄灯,红灯
   ,里程碑应完成,里程碑已完成,里程碑未完成
   ,一级应完成,一级已完成,一级未完成
   ,'/pom/plan-assess/node-monitoring/plan-nodes?companyid='|| 分期.UNIT_ID ||'&ppid='|| case when 分期.是无分期=1 then PROJECT_ID else 分期.id end ||'&planType=关键节点计划' as url
   ,分期.UNIT_ID
   ,分期.sn
   from basedata
   left join 分期 on basedata.PROJ_ID=分期.id
   union all 
   select proj.id
   ,proj.project_name as name
   ,proj.UNIT_ID  as parent_id
   ,0 有效节点数,0 应得总分
   ,0 绿灯,0 黄灯,0 红灯
   ,0 里程碑应完成,0 里程碑已完成,0 里程碑未完成
   ,0 一级应完成,0 一级已完成,0 一级未完成
   ,'' as url
   ,proj.UNIT_ID
   ,proj.sn
   from sys_project proj
   left join (select * from 分期 where 是无分期=1) s on proj.id=s.project_id
   where s.id is null
   )

   ,拼接项目公司树 as(
   SELECT DISTINCT
   org_id       AS id,
   org_name     AS name,
   parent_id    AS parent_id,
   0 有效节点数,0 应得总分
   ,0 绿灯,0 黄灯,0 红灯
   ,0 里程碑应完成,0 里程碑已完成,0 里程碑未完成
   ,0 一级应完成,0 一级已完成,0 一级未完成
   ,'' url
   ,order_code as sn
                           FROM
                               tmp_company_tree
                           WHERE
                               id = DATA_AUTH_SPID
                               AND org_id IN (
                                   SELECT DISTINCT
                                       id
                                   FROM
                                       sys_business_unit
                                   START WITH
                                       id IN (
                                           SELECT
                                               id
                                           FROM
                                               (
                                                   SELECT
                                                       unit_id AS id
                                                   FROM
                                                       sys_project
                                                   UNION
                                                   SELECT
                                                       subordinate_company_id AS id
                                                   FROM
                                                       cdb_feasible_project_config
                                               ) ds
                                       )
                                   CONNECT BY
                                       PRIOR parent_id = id
                               )

   union all
    select PROJ_ID as id
   ,name
   ,parent_id
   ,有效节点数,应得总分
   ,绿灯,黄灯,红灯
   ,里程碑应完成,里程碑已完成,里程碑未完成
   ,一级应完成,一级已完成,一级未完成,url,sn FROM 项目_分期)
   --start with id=v_id connect by prior id=parent_id

--    
   ,汇总 as(select 
   id
   ,name
   ,parent_id
   ,url
   ,sn
  -- ,有效节点数,应得总分
,(select sum(有效节点数) from 拼接项目公司树 start with id=s.id connect by prior id=parent_id ) 有效节点数
,(select sum(应得总分) from 拼接项目公司树 start with id=s.id connect by prior id=parent_id ) 应得总分
--,绿灯,黄灯,红灯
,(select sum(绿灯) from 拼接项目公司树 start with id=s.id connect by prior id=parent_id ) 绿灯
,(select sum(黄灯) from 拼接项目公司树 start with id=s.id connect by prior id=parent_id ) 黄灯
,(select sum(红灯) from 拼接项目公司树 start with id=s.id connect by prior id=parent_id ) 红灯

--,里程碑应完成,里程碑已完成,里程碑未完成
,(select sum(里程碑应完成) from 拼接项目公司树 start with id=s.id connect by prior id=parent_id ) 里程碑应完成
,(select sum(里程碑已完成) from 拼接项目公司树 start with id=s.id connect by prior id=parent_id ) 里程碑已完成
,(select sum(里程碑未完成) from 拼接项目公司树 start with id=s.id connect by prior id=parent_id ) 里程碑未完成

--,一级应完成,一级已完成,一级未完成
,(select sum(一级应完成) from 拼接项目公司树 start with id=s.id connect by prior id=parent_id ) 一级应完成
,(select sum(一级已完成) from 拼接项目公司树 start with id=s.id connect by prior id=parent_id ) 一级已完成
,(select sum(一级未完成) from 拼接项目公司树 start with id=s.id connect by prior id=parent_id ) 一级未完成
 from 拼接项目公司树 s)
--    
  ,计算 as(select '' from dual)

   select  id as "id"
   ,case when url is not null then  '<span style="color:#409eff">'||name||'</span>' else   name end as "company"
   ,url as "jumpUrl"
   ,parent_id as "parentId"
   ,case when (里程碑应完成+一级应完成)=0 then 0 else  round((里程碑已完成+一级已完成)/(里程碑应完成+一级应完成),4)*100 end||'%'  as "completionRate"
   ,有效节点数 as "validTasks" 
   ,里程碑应完成+一级应完成 as "completeNum"
   ,里程碑已完成+一级已完成 as "completed"
   ,里程碑未完成+一级未完成 as "unfinished"

   ,应得总分 as "needResult",0 "dynamicResult",0 "realResult"
   ,绿灯 as "greenLight",黄灯 as "yellowLight",红灯 as  "redLight"
   ,里程碑应完成 as "miCompleteNum",里程碑已完成 as "miCompleted",里程碑未完成 as "miUnfinished"
   ,一级应完成 as "olCompleteNum",一级已完成 as "olCompleted",一级未完成 as "olUnfinished"
   from 汇总 where id<>'a0d1ec37-fa4c-346a-e053-8606160a788a' and 有效节点数>0 

   start with id=v_id connect by prior id=parent_id
   order by sn
   ;

END P_POM_KEY_NODE_SCHEDULE;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_KEYNODE_TASK_LIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_KEYNODE_TASK_LIST" (
     tabType VARCHAR2,
     planType VARCHAR2,
     businessId VARCHAR2,
     currentcompanyid   IN                 VARCHAR2,--当前用户的公司
     userid             IN                 VARCHAR2,--用户id用于过滤关注的任务
     currentstationid   IN                 VARCHAR2,---当前用户的岗位
     currentdeptid      IN                 VARCHAR2,---当前用户的部门
     bizcode            IN                 VARCHAR2,---权限code
     pageRows INTEGER,
     pageIndex INTEGER,
     taskList  OUT SYS_REFCURSOR
) IS 
--项目主项计划监控项目完成率前排行榜详情列表
--作者：谢松宏
--修改：叶丁荣//数据权限过滤
--日期：2020/03/20
v_condition varchar2(4000);
v_sql clob;
v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN 
v_condition:= ' AND 1=1';
IF(tabType is not null) THEN
    IF(tabType='超期任务')
        then  v_condition:=' and  to_char(node.plan_end_date, ''yyyy-MM-dd'') <  to_char(sysdate, ''yyyy-MM-dd'') and node.actual_end_date is null order by node.plan_end_date desc'; 
    ELSIF(tabType='今日完成')
        then  v_condition:=' and  to_char(node.plan_end_date, ''yyyy-MM-dd'') = to_char(sysdate, ''yyyy-MM-dd'') and node.actual_end_date is not null  order by node.actual_end_date desc'; 
    ELSIF(tabType='今日待办')
        then  v_condition:=' and  to_char(node.plan_end_date, ''yyyy-MM-dd'') = to_char(sysdate, ''yyyy-MM-dd'') and node.actual_end_date is null order by node.plan_end_date desc'; 
    END IF;
END IF;

--调用数据权限验证存储过程
    p_sys_auth_data_rule_spid(userid => userid, stationid => currentstationid, deptid => currentdeptid, companyid => currentcompanyid
    , bizcode => bizcode, data_auth_spid => v_spid);

v_sql:='SELECT *
  FROM (SELECT tt.*, ROWNUM AS rowno
    FROM (  
        select 
        node.id as "nodeId", 
        node.original_node_id as "nodeOriginalId",
        node.node_name as "nodeName",
        plan.plan_type as "nodePlanType",
        case 
            when '''||tabType||'''=''超期任务'' then to_char(node.plan_end_date, ''yyyy-MM-dd'')
            when '''||tabType||'''=''今日完成'' then to_char(node.actual_end_date, ''yyyy-MM-dd'')
            when '''||tabType||'''=''今日待办'' then to_char(node.plan_end_date, ''yyyy-MM-dd'')
        end  as "nodeTime",
        case 
            when (to_char(node.plan_end_date, ''yyyy-MM-dd'') < to_char(sysdate, ''yyyy-MM-dd'') and node.actual_end_date is null) then ''已超期''
            when (to_char(node.plan_end_date, ''yyyy-MM-dd'') = to_char(sysdate, ''yyyy-MM-dd'') and node.actual_end_date is not null) then ''已完成''
            when (to_char(node.plan_end_date, ''yyyy-MM-dd'') = to_char(sysdate, ''yyyy-MM-dd'') and node.actual_end_date is null) then ''未完成''
        end as "nodeStatus"
        from pom_proj_plan_node node 
        left join pom_proj_plan plan on node.proj_plan_id = plan.id 
        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
        on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
        where tal.orgid is not null AND node.is_disable = 0 and plan_type='''||planType||''' and plan.proj_id = '''||businessId||''' and plan.approval_status = ''已审核'''||v_condition||') tt
    WHERE ROWNUM <= '||pageRows||' * '||pageIndex||') table_alias
 WHERE table_alias.rowno >= '||pageRows||' * ('||pageIndex||'-1) + 1';
 dbms_output.put_line(v_sql);
open taskList for v_sql;
END P_POM_KEYNODE_TASK_LIST;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_KN_PERFORM_DYNAMIC
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_KN_PERFORM_DYNAMIC" 
(
		IN_ORG_ID    IN VARCHAR2
	 ,DATASCOPE    IN VARCHAR2
	 ,IN_PLAN_TYPE IN VARCHAR2
	 ,IN_PROJID  IN VARCHAR2 
	 ,PAGEINDEX    IN INT
	 ,PAGESIZES    IN INT
	 ,P_PAGETYPE  IN INT
	 ,ITEMS        OUT SYS_REFCURSOR
	 ,TOTAL        OUT INT
) AS
		--传入的参数有三个，1：IN_ORG_ID（公司ID）
		--，2：DATASCOPE（统计期间，3个值“THIS_MONTH、THIS_QUARTER、THIS_YEAR"）
		--，3：PLAN_TYPE（计划类型，预留，估计后面会用的到）
		--，4：P_PAGETYPE（页面类型：1：已延误 2：已完成 3：应完成）//alterby 李小聪
		--关键节点计划-执行动态查询（wangck需要）
		--作者：陈丽
		--日期：2019/12/07
-- 20200326:晓聪修订

		CURSOR CUR_COMPANY_LIST(V_ORG_ID SYS_BUSINESS_UNIT.ID%TYPE) IS
				SELECT P.ID, P.PARENT_ID, P.ORG_NAME FROM SYS_BUSINESS_UNIT P WHERE P.IS_COMPANY = 1 START WITH P.ID = V_ORG_ID CONNECT BY PRIOR P.ID = P.PARENT_ID;
		V_SQL_TOTAL     CLOB := ' ';
		V_SQL           CLOB := ' ';
		V_SQL_DATASCOPE CLOB := ' ';
		V_COMPANY_LIST  CLOB := ' ';

BEGIN

  dbms_output.put_line('开始');
--月度
--已延误
		IF DATASCOPE = 'thisMonth' AND P_PAGETYPE=1  THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL   AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';
--月度
--已完成
		ELSIF DATASCOPE = 'thisMonth' AND P_PAGETYPE=2  THEN
				V_SQL_DATASCOPE := ' AND  PN.ACTUAL_END_DATE IS  NOT NULL  AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';

--月度
--应完成

		ELSIF DATASCOPE = 'thisMonth' AND P_PAGETYPE=3  THEN
				V_SQL_DATASCOPE := 'AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';

--季度
--已延误
	ELSIF DATASCOPE = 'thisQuarter' AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := ' AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL    AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((	SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((	SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
--季度
--已完成
	ELSIF DATASCOPE = 'thisQuarter' AND P_PAGETYPE=2 THEN
				V_SQL_DATASCOPE := 'AND  PN.ACTUAL_END_DATE IS  NOT NULL AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((	SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((	SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
--季度
--季度应完成
	ELSIF DATASCOPE = 'thisQuarter' AND P_PAGETYPE=3 THEN
				V_SQL_DATASCOPE := '  AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((	SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((	SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
--年度
--已延误
		ELSIF DATASCOPE = 'thisYear'AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL  
			 AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) ';
--年度
--已完成
		ELSIF DATASCOPE = 'thisYear'AND P_PAGETYPE=2 THEN
				V_SQL_DATASCOPE := 'AND  PN.ACTUAL_END_DATE IS  NOT NULL  
				 AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH)  ';
--年度
--应完成
		ELSIF DATASCOPE = 'thisYear' AND P_PAGETYPE=3 THEN
				V_SQL_DATASCOPE := ' AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) ';
--全部，没有时间限
--已延误
	ELSIF DATASCOPE = 'thisAll' AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL ';
--计划所有节点
	ELSIF DATASCOPE = 'thisAll' AND P_PAGETYPE=2 THEN
				V_SQL_DATASCOPE := ' AND   1=1 ';
				
			

		END IF;
		
		FOR ITEM_COMPANY_LIST IN CUR_COMPANY_LIST(IN_ORG_ID)
		LOOP
				/*DBMS_OUTPUT.PUT_LINE(ITEM_COMPANY_LIST.ORG_NAME || ',PARENT_ID' ||
        ITEM_COMPANY_LIST.PARENT_ID || ',ID:' ||
        ITEM_COMPANY_LIST.ID);*/
				V_COMPANY_LIST := V_COMPANY_LIST || '''' || ITEM_COMPANY_LIST.ID || '''' || ',';
		END LOOP;
-- 	dbms_output.put_line(V_COMPANY_LIST);
		V_COMPANY_LIST := '('  || SUBSTR(V_COMPANY_LIST, 1, LENGTH(V_COMPANY_LIST) - 1) || ')';
-- 		dbms_output.put_line(V_COMPANY_LIST);
IF  V_COMPANY_LIST='()'
	 THEN  V_COMPANY_LIST := '('''||IN_ORG_ID||''')';
END  IF;
-- 	dbms_output.put_line(V_COMPANY_LIST);
		V_SQL := V_SQL ||
						 'SELECT PP.COMPANY_ID, PP.COMPANY_NAME AS COMPANY_NAME,PP.PROJ_name AS PROJ_NAME,PP.PLAN_NAME AS PLAN_NAME, PN.ID,PN.PROJ_PLAN_ID,PN.ORIGINAL_NODE_ID,CASE WHEN PN.IS_DISABLE = 0 THEN	PN.NODE_NAME ELSE	''【禁用】'' || PN.NODE_NAME END AS NODE_NAME, PN.NODE_CODE, PN.NODE_LEVEL, PN.PROJ_STAGE, PN.MAIN_RESPONSIBILITY, PN.DUTY_DEPARTMENT, TO_CHAR(PN.PLAN_START_DATE, ''yyyy-MM-dd'') AS PLAN_START_DATE, TO_CHAR(PN.PLAN_END_DATE, ''yyyy-MM-dd'') AS PLAN_END_DATE, PN.IS_DISABLE, PN.COMPLETION_STANDARD, PN.COMPLETION_RESULTS_REMARK, TO_CHAR(PN.ACTUAL_END_DATE, ''yyyy-MM-dd'') AS ACTUAL_END_DATE
	, case 
 --未到期不亮灯
 WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
 --到期当天内完成反馈
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
 then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
  --到期1-5天内完成反馈
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
 then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
 --到期未反馈黄灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 1 and 4
 THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>'' 
  --到期超过5天未反馈红灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(PLAN_END_DATE)) >5) THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' 
 ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END
  AS PLAN_STATUS, TO_CHAR(PN.ESTIMATE_END_DATE,''YYYY-MM-DD'') AS "ESTIMATE_END_DATE" ,	nps.CHARGE_PERSON
	FROM  pom_proj_plan_node pn 
LEFT JOIN pom_proj_plan pp ON pn.proj_plan_id = pp.id 
LEFT JOIN  SYS_PROJECT_STAGE ps on  ps.id=pp.proj_id
LEFT JOIN SYS_PROJECT pj on  ps.PROJECT_ID =pj.id
LEFT JOIN(	SELECT  NODE_ID, listagg(CHARGE_PERSON,'','') WITHIN GROUP (ORDER BY CHARGE_PERSON )  as CHARGE_PERSON
	FROM POM_NODE_CHARGE_PERSON 
	GROUP BY NODE_ID) nps on  nps.NODE_ID=pn.id
	WHERE   PP.PLAN_TYPE = ''关键节点计划'' AND PN.IS_DISABLE=0  AND APPROVAL_STATUS = ''已审核'' AND 1=1 
	and  ((pp.proj_id ='''||IN_PROJID||''' or pn.proj_plan_id='''||IN_PROJID||'''  OR  pj.id='''||IN_PROJID||''' )
	OR PP.COMPANY_ID IN ' || V_COMPANY_LIST ||' ) '|| V_SQL_DATASCOPE || '  ORDER BY PN.PROJ_PLAN_ID,  PN.NODE_CODE';

		DBMS_OUTPUT.PUT_LINE(V_SQL);
			V_SQL_TOTAL := V_SQL_TOTAL|| 				 'SELECT  TO_CHAR(COUNT(pn.ID))
	FROM  pom_proj_plan_node pn 
LEFT JOIN pom_proj_plan pp ON pn.proj_plan_id = pp.id 
LEFT JOIN  SYS_PROJECT_STAGE ps on  ps.id=pp.proj_id
LEFT JOIN SYS_PROJECT pj on  ps.PROJECT_ID =pj.id
LEFT JOIN(	SELECT  NODE_ID, listagg(CHARGE_PERSON,'','') WITHIN GROUP (ORDER BY CHARGE_PERSON )  as CHARGE_PERSON
	FROM POM_NODE_CHARGE_PERSON 
	GROUP BY NODE_ID) nps on  nps.NODE_ID=pn.id
	WHERE  PP.PLAN_TYPE = ''关键节点计划''  AND APPROVAL_STATUS = ''已审核'' AND 1=1 
	and  ((pp.proj_id ='''||IN_PROJID||''' or pn.proj_plan_id='''||IN_PROJID||'''  OR  pj.id='''||IN_PROJID||''' )
	OR PP.COMPANY_ID IN ' || V_COMPANY_LIST ||' ) '|| V_SQL_DATASCOPE || '  ORDER BY PN.PROJ_PLAN_ID,  PN.NODE_CODE';

		--DBMS_OUTPUT.PUT_LINE(V_SQL_TOTAL);
		 execute immediate V_SQL_TOTAL into TOTAL; 
	--	 DBMS_OUTPUT.PUT_LINE(TOTAL);

		OPEN ITEMS FOR V_SQL;

END P_POM_KN_PERFORM_DYNAMIC;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MAIN_PLAN_MONITOR
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_MAIN_PLAN_MONITOR" (
    userid                 IN                     VARCHAR2,--用户id
    planid                 IN                     VARCHAR2,--计划id
    timeout_info           OUT                    SYS_REFCURSOR,--超期未完成任务 
    timeout_title          OUT                    VARCHAR2,--标题 超期未完成任务：共0项
    expect_timeout_info    OUT                    SYS_REFCURSOR,--四、预计超期任务 
    expect_timeout_title   OUT                    VARCHAR2,--标题预计超期任务：共0项
    completion_level_rate_title   OUT                    VARCHAR2,---一、按任务级别统计完成率 (%)
    pandect_info           out SYS_REFCURSOR,       --计划明细一览表
    completion_level_rate  out SYS_REFCURSOR---按任务等级统计完成率
) AS
--项目主项计划监控，详情页 ：超期未完成任务,预计超期任务
--作者：陈丽定义，李小聪实现
--日期：2020/02/26
  v_timeout_count VARCHAR2(20):='';
  v_expect_timeout_count VARCHAR2(20):='';
BEGIN
completion_level_rate_title:='一、按任务级别统计完成率 (%)';
 OPEN timeout_info FOR
      SELECT   a.*,nvl(b.IS_UN_WATCH,1)  as  IS_UN_WATCH ,b.UN_WATCH_TIME  ,b.WATCH_TIME  
      FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' --and   b.WATCH_TIME is  not   null
      WHERE     a.PLAN_ID=''||planid||''
      AND  TRUNC( a.PLAN_END_DATE)-TRUNC(SYSDATE)<0  and  a.ACTUAL_END_DATE  is null   ;
 OPEN expect_timeout_info FOR 
          SELECT   a.*,nvl(b.IS_UN_WATCH,1)  as  IS_UN_WATCH ,b.UN_WATCH_TIME  ,b.WATCH_TIME  
      FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND   TRUNC( a.ESTIMATE_END_DATE)-TRUNC(SYSDATE)<0   and  a.ACTUAL_END_DATE  is null ;


SELECT  (SELECT  TO_CHAR(COUNT(NODE_ID))        FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND  TRUNC( PLAN_END_DATE)-TRUNC(SYSDATE)<0  and  ACTUAL_END_DATE  is null   )  
INTO v_timeout_count  FROM  DUAL;
SELECT  (SELECT  TO_CHAR(COUNT(NODE_ID))        FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND   TRUNC( ESTIMATE_END_DATE)-TRUNC(SYSDATE)<0  and  ACTUAL_END_DATE  is null ) 
INTO v_expect_timeout_count  FROM  DUAL;
    timeout_title := '超期未完成任务：共'||v_timeout_count||'项';
    expect_timeout_title := '预计超期任务：共'||v_expect_timeout_count||'项';

    ----计划明细一览表
    OPEN pandect_info FOR
         SELECT   a.*,nvl(b.IS_UN_WATCH,1)  as  IS_UN_WATCH ,b.UN_WATCH_TIME  ,b.WATCH_TIME  
      FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' --and   b.WATCH_TIME is  not   null
      WHERE     a.PLAN_ID=''||planid||'' ORDER BY NODE_CODE asc ;
     
    --按任务等级统计完成率
    OPEN Completion_level_rate FOR
--      SELECT  '里程碑' as "nodeName",1 as "percentage" from dual
--      UNION all 
--      SELECT  '一级节点' as "nodeName",1 as "percentage" from dual
--     UNION all 
--      SELECT  '二级节点' as "nodeName",1 as "percentage" from dual;
		SELECT   NODE_LEVEL  as "nodeName",	ROUND(SUM( CASE WHEN   B.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END) /COUNT(b.id),2)  AS "percentage" 
			FROM POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE B ON A.ID=B.PROJ_PLAN_ID
			INNER JOIN SYS_PROJECT_STAGE C ON C.ID=PROJ_ID
			INNER JOIN SYS_PROJECT D ON D.ID=C.PROJECT_ID
			WHERE     A.PLAN_TYPE='项目主项计划' AND A.APPROVAL_STATUS='已审核' AND B.IS_DISABLE=0  AND B.PLAN_END_DATE<=SYSDATE and  a.id=''||planid||''
			GROUP BY NODE_LEVEL    ORDER BY   CASE  WHEN   NODE_LEVEL='里程碑' THEN  0 WHEN   NODE_LEVEL='一级节点' THEN  1 WHEN   NODE_LEVEL='二级节点' THEN  3   WHEN   NODE_LEVEL='三级节点' THEN  4  WHEN   NODE_LEVEL='四级节点' THEN  5 else 6 END asc;
		 
		 
		 
		 

END p_pom_main_plan_monitor;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MAIN_PLAN_W_OVERDUE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_MAIN_PLAN_W_OVERDUE" (
    userid                 IN                     VARCHAR2,--用户id
    planid                 IN                     VARCHAR2,--计划id
    timeout_info           OUT                    SYS_REFCURSOR,--三、超期未完成任务 
    timeout_title          OUT                    VARCHAR2,--标题 超期未完成任务：共0项
    expect_timeout_info    OUT                    SYS_REFCURSOR,--四、预计超期任务 
    expect_timeout_title   OUT                    VARCHAR2--标题预计超期任务：共0项
) AS
--项目主项计划监控，详情页 ：超期未完成任务,预计超期任务
--作者：陈丽定义，李小聪实现
--日期：2020/02/26
  v_timeout_count VARCHAR2(20):='';
  v_expect_timeout_count VARCHAR2(20):='';
BEGIN
 OPEN timeout_info FOR
      SELECT   a.*,nvl(b.IS_UN_WATCH,1)  as  IS_UN_WATCH ,b.UN_WATCH_TIME  ,b.WATCH_TIME  
      FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' --and   b.WATCH_TIME is  not   null
      WHERE     a.PLAN_ID=''||planid||''
      AND  TRUNC( a.PLAN_END_DATE)-TRUNC(SYSDATE)<0  and  a.ACTUAL_END_DATE  is null   ;
 OPEN expect_timeout_info FOR 
          SELECT   a.*,nvl(b.IS_UN_WATCH,1)  as  IS_UN_WATCH ,b.UN_WATCH_TIME  ,b.WATCH_TIME  
      FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND   TRUNC( a.ESTIMATE_END_DATE)-TRUNC(SYSDATE)<0   and  a.ACTUAL_END_DATE  is null ;


SELECT  (SELECT  TO_CHAR(COUNT(NODE_ID))        FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND  TRUNC( PLAN_END_DATE)-TRUNC(SYSDATE)<0  and  ACTUAL_END_DATE  is null   )  
INTO v_timeout_count  FROM  DUAL;
SELECT  (SELECT  TO_CHAR(COUNT(NODE_ID))        FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND   TRUNC( ESTIMATE_END_DATE)-TRUNC(SYSDATE)<0  and  ACTUAL_END_DATE  is null ) 
INTO v_expect_timeout_count  FROM  DUAL;
    timeout_title := '超期未完成任务：共'||v_timeout_count||'项';
    expect_timeout_title := '预计超期任务：共'||v_expect_timeout_count||'项';



END p_pom_main_plan_w_overdue;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_MD_SITUATION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_MD_SITUATION" (
    projtreeinfo OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN projtreeinfo FOR SELECT
                              a.id,
                              a.parent_id   parentsid,
                              a.org_name    orgname,
                              b.nums        projtotal,
                              nvl(c.salesarea, 0) salesarea,
                              nvl(c.salescarport, 0) salescarport
                          FROM
                              sys_business_unit a
                              INNER JOIN (
                                  SELECT
                                      COUNT(b.company_id) nums,
                                      b.company_id
                                  FROM
                                      mdm_project b
                                  WHERE
                                      b.approval_status = '已审核'
                                  GROUP BY
                                      b.company_id
                              ) b ON a.id = b.company_id
                              LEFT JOIN (
                                  SELECT
                                      company_id,
                                      SUM(mdm_obj_phase_index.total_sale_area) salesarea,
                                      SUM(mdm_obj_phase_index.underground_total_sale_carport) salescarport
                                  FROM
                                      mdm_project left
                                      JOIN (
                                          SELECT
                                              t1.id,
                                              t1.phase_id,
                                              t1.proj_id,
                                              t2.phase_order
                                          FROM
                                              mdm_project_phase                                                                  t1
                                              LEFT JOIN (
                                                  SELECT
                                                      proj_id,
                                                      MAX(phase_order) AS phase_order
                                                  FROM
                                                      mdm_project_phase
                                                  GROUP BY
                                                      proj_id
                                              ) t2 ON t1.proj_id = t2.proj_id
                                                      AND t1.phase_order = t2.phase_order
                                          WHERE
                                              t2.phase_order IS NOT NULL
                                      ) phase ON mdm_project.project_original_id = phase.proj_id
                                      LEFT JOIN mdm_phase ON phase.phase_id = mdm_phase.id
                                      LEFT JOIN mdm_obj_phase_index ON phase.id = mdm_obj_phase_index.obj_phase_id
                                                                       AND mdm_obj_phase_index.obj_type = 0
                                  WHERE
                                      approval_status = '已审核'
                                  GROUP BY
                                      company_id
                              ) c ON c.company_id = a.id
                          WHERE
                              a.org_type = 0
                              AND ( a.id != '000100000000000000000000000000'
                                    AND a.id != '000200000000000000000000000000' );

END p_pom_md_situation;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MD_SITUATION_ODL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_MD_SITUATION_ODL" (
    projtreeinfo OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN projtreeinfo FOR SELECT
                              a.id,
                              a.parent_id   parentsid,
                              a.org_name    orgname,
                              b.nums        projtotal,
                              nvl(c.salesarea, 0) salesarea,
                              nvl(c.salescarport, 0) salescarport
                          FROM
                              sys_business_unit a
                              INNER JOIN (
                                  SELECT
                                      COUNT(b.company_id) nums,
                                      b.company_id
                                  FROM
                                      mdm_project b
                                  WHERE
                                      b.approval_status = '已审核'
                                  GROUP BY
                                      b.company_id
                              ) b ON a.id = b.company_id
                              LEFT JOIN (
                                  SELECT
                                      company_id,
                                      SUM(mdm_obj_phase_index.total_sale_area) salesarea,
                                      SUM(mdm_obj_phase_index.underground_total_sale_carport) salescarport
                                  FROM
                                      mdm_project left
                                      JOIN (
                                          SELECT
                                              t1.id,
                                              t1.phase_id,
                                              t1.proj_id,
                                              t2.phase_order
                                          FROM
                                              mdm_project_phase                                                                  t1
                                              LEFT JOIN (
                                                  SELECT
                                                      proj_id,
                                                      MAX(phase_order) AS phase_order
                                                  FROM
                                                      mdm_project_phase
                                                  GROUP BY
                                                      proj_id
                                              ) t2 ON t1.proj_id = t2.proj_id
                                                      AND t1.phase_order = t2.phase_order
                                          WHERE
                                              t2.phase_order IS NOT NULL
                                      ) phase ON mdm_project.project_original_id = phase.proj_id
                                      LEFT JOIN mdm_phase ON phase.phase_id = mdm_phase.id
                                      LEFT JOIN mdm_obj_phase_index ON phase.id = mdm_obj_phase_index.obj_phase_id
                                                                       AND mdm_obj_phase_index.obj_type = 0
                                  WHERE
                                      approval_status = '已审核'
                                  GROUP BY
                                      company_id
                              ) c ON c.company_id = a.id
                          WHERE
                              a.org_type = 0
                              AND ( a.id != '000100000000000000000000000000'
                                    AND a.id != '000200000000000000000000000000' );

END p_pom_md_situation_odl;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MESSAGE_TYPE_LIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_MESSAGE_TYPE_LIST" (
     systemId VARCHAR2,
     userId VARCHAR2,
     MESSAGETYPEINFO  OUT SYS_REFCURSOR
) AS
 v_sys_code VARCHAR2 (50);
 v_get_code_sql VARCHAR2 (2000);
 v_sql Clob;
BEGIN 
      v_get_code_sql := 'select user_code from sys_user where id=:sys_code';

      EXECUTE IMMEDIATE v_get_code_sql INTO v_sys_code  using userId;

    v_sql := 'SELECT 
    BASE.M_TYPE as "msgType",
    S_RESULT.TOTAL  as "msgTypeUnreadCount",
    S_RESULT.TITLE as "fristMsg",
    S_RESULT.ID as "id"
FROM (
(SELECT ''预警消息'' as "M_TYPE" FROM dual UNION ALL SELECT ''提醒消息'' as "M_TYPE" FROM dual UNION ALL SELECT ''催办消息'' as "M_TYPE" FROM dual) BASE
LEFT JOIN (
SELECT A.BIZ_MSG_CATEGORY,TOTAL,TITLE,A.ID FROM (
    (select SMRB.CREATED_TIME, SMRB.BIZ_MSG_CATEGORY, SMRB.ID
      from (
        SELECT CREATED_TIME,  
                   BIZ_MSG_CATEGORY,  
                   biz.ID,
                   dense_rank() over(partition by BIZ_MSG_CATEGORY order by CREATED_TIME desc) rank  
              FROM SYS_MSG_RECORD_BIZ biz
			  LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
			  LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID  
              WHERE BIZ.SYSTEM_ID='''||systemId||''' AND
              ((sms.receiver_id = '''||v_sys_code||''') or (wechat.receiver_id = '''||v_sys_code||''' and sms.receiver_id is not null))
      )SMRB 
     where SMRB.rank = 1)A 
     LEFT JOIN 
     (
        select count(*) AS "TOTAL",BIZ_MSG_CATEGORY from SYS_MSG_RECORD_BIZ smrb 
        LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON smrb.ID = wechat.MSG_RECORD_BIZ_ID
         LEFT JOIN SYS_MSG_RECORD_SMS sms ON smrb.ID = sms.MSG_RECORD_BIZ_ID
        left join SYS_MSG_READ_RECORD smrr on smrb.ID  = smrr.MSG_RECORD_BIZ_GUID --未阅读条数及分
        where SMRB.SYSTEM_ID='''||systemId||'''
            and smrb.BIZ_MSG_CATEGORY is not null
            and smrr.ID is null
            AND ((sms.receiver_id = '''||v_sys_code||''') or (wechat.receiver_id = '''||v_sys_code||''' and smrr.reader_id is not null))
        GROUP BY BIZ_MSG_CATEGORY 
     )B ON A.BIZ_MSG_CATEGORY = B.BIZ_MSG_CATEGORY
     LEFT JOIN 
     (
       SELECT  WECHAT_MSG_TYPE,TITLE,MSG_RECORD_BIZ_ID FROM SYS_MSG_RECORD_WECHAT
     )C ON C.MSG_RECORD_BIZ_ID = A.ID
    )) S_RESULT ON BASE.M_TYPE = S_RESULT.BIZ_MSG_CATEGORY )';

           DBMS_OUTPUT.PUT_LINE(v_sql);  
    OPEN MESSAGETYPEINFO FOR v_sql;

END P_POM_MESSAGE_TYPE_LIST;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MOBILE_CENTER_MESSAGE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_MOBILE_CENTER_MESSAGE" (
    MESSAGEINFO  OUT SYS_REFCURSOR
)
IS
a clob;
b clob;
c clob;
BEGIN
 a:='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAF62lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDIgNzkuMTYwOTI0LCAyMDE3LzA3LzEzLTAxOjA2OjM5ICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgKFdpbmRvd3MpIiB4bXA6Q3JlYXRlRGF0ZT0iMjAyMC0wMi0xMVQxMDoyMToyMCswODowMCIgeG1wOk1ldGFkYXRhRGF0ZT0iMjAyMC0wMi0xMVQxMDoyMToyMCswODowMCIgeG1wOk1vZGlmeURhdGU9IjIwMjAtMDItMTFUMTA6MjE6MjArMDg6MDAiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MDQ0MDI1MzItZTc0NS0yOTQzLTkzODEtM2Y1NDJkYTAyNWFmIiB4bXBNTTpEb2N1bWVudElEPSJhZG9iZTpkb2NpZDpwaG90b3Nob3A6MzljMTUyZmUtY2FmZi05YzRjLTkwZjgtNjU3YTFkMDM1ZjdjIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YjQ5Y2FjYzctZWY2Yy02NDRjLTk3NjctMTVlMjFhMjQzODdhIiBkYzpmb3JtYXQ9ImltYWdlL3BuZyIgcGhvdG9zaG9wOkNvbG9yTW9kZT0iMyIgcGhvdG9zaG9wOklDQ1Byb2ZpbGU9InNSR0IgSUVDNjE5NjYtMi4xIj4gPHhtcE1NOkhpc3Rvcnk+IDxyZGY6U2VxPiA8cmRmOmxpIHN0RXZ0OmFjdGlvbj0iY3JlYXRlZCIgc3RFdnQ6aW5zdGFuY2VJRD0ieG1wLmlpZDpiNDljYWNjNy1lZjZjLTY0NGMtOTc2Ny0xNWUyMWEyNDM4N2EiIHN0RXZ0OndoZW49IjIwMjAtMDItMTFUMTA6MjE6MjArMDg6MDAiIHN0RXZ0OnNvZnR3YXJlQWdlbnQ9IkFkb2JlIFBob3Rvc2hvcCBDQyAoV2luZG93cykiLz4gPHJkZjpsaSBzdEV2dDphY3Rpb249InNhdmVkIiBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOjA0NDAyNTMyLWU3NDUtMjk0My05MzgxLTNmNTQyZGEwMjVhZiIgc3RFdnQ6d2hlbj0iMjAyMC0wMi0xMVQxMDoyMToyMCswODowMCIgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWRvYmUgUGhvdG9zaG9wIENDIChXaW5kb3dzKSIgc3RFdnQ6Y2hhbmdlZD0iLyIvPiA8L3JkZjpTZXE+IDwveG1wTU06SGlzdG9yeT4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7KrSW+AAAL8ElEQVR42u1daWwU5xken3uADw7b4BpIisvV/nCTBpo6Tbn8Iw6kIa3VBqlRkdI/KZQiNUp6h9I2OEpLRIKbVk2AOCUSBX4UpYGEVCKHGyVFKWpsRG0otSvbsWzjYK+9xsbu80zmRaPNzto7O7Mzs8wrvZpjd2e+73ve+/tmNmtyclLxyT2U7Q+BD4hPPiA+ID75gPiA+OQD4gPikw+ID4hPPiA++YD4gPjkA5IBlGv0wc6dO1O68LVr15Tx8XGlrq5O6e3tVbq7u5VAIKBMTEwoUvLnNicnR4lEIsro6OjckpKSqrGxsc9nZ2fPxmfkPHxtAHwF+61ZWVnvYnsBn0/w9zhWr8dtXl6eMjIyol6PJOcLCgoUfF9xcpphw4YNqQOSJvocgLs3FAqtDwaDKwFGSMDkYOpJO57E9iK2r4BPgf/CczeEhthMNeAdGNy7ZLDJIsWxYOhxAS/G97ZiuxXbNvBeaEADfnPN9yFJkDbIn8EAHsX2VfBd8hmBMGlSKsF78dtmmMc6H5ApSHwEbThs+jdgiv6J0/dZDTTusxSAHMZ9DmasyaJTTNWpExD4BV7r59h/LA0a+AB4Oe5F7evLKEAkWkllgMLhsNLa2kobvy0/Pz9dfboN/A64GtyTMYCUlZWZNlM0UQQD21/BlGzjcQJHbYe20Le8Cb4F+5GM8CES+Zjl3Nzcb4J/RE1LJxg6WgI+7rVlToYawmTNDDH5Q15RgYH4U6p+yAJnv2Z4ePinSA53OZ0cpgxIbW2tqQt2dXUply5dasSAZLthABBc/CIajb6I9vzH04AsXbrUrGTWtLS0rKamOE2SbAKQp6EhGxQPkCEgR48eNeXQIZGPFxcXu6aDGih3w5etACgtbtcSQ0B6enqSBiMvL+8WRFe30pG7reOI9nYAkO94FpBkTQ47ilxjixvB0KrCLK1sg9BE3QyKISAzZ85MutOs3Lq1sxCwov7+/hrwcZbqb4TSyWcBRoWbzQGE5iswW8cZAnsOEBOS/gU3gzE6Oqog2KgqLy9XPGmykqllaTb65ngTS24h9mdsbKzy/Pnz2WjnRDrbacmMoQmTVe5WMHRUBnNVCA0ZcKvZsnLGsMjNSNBMQWDyFi5cWITtgOdMlsPXss2vQ/Nd3U5LGqdlw8MeAGR8ZGRk0JNOnQ46GXMAm3zZzT6EPgPZeqSjo+MKlyd5zockI0XaIoV2NwPCIAUg/G/BggVRT5qs3NykrdkHHihv/9vNWXpCQEyo9N9h5sbd6typvTBV79FcuVmTDQePDU8yrPwIHX0LvNqtYS+E7FXPakiyU7i00cFg8BB4tZNTt4nMFYTlfbu0I3b1peMaQkJIeQgNeioMSiZKS4d25OTkPGvn1MDVq1ft1ZB169aZuV6ks7Nz38WLFx8OhUJu8h+cA3nWjJBNwwyqzOKlVg2wB5AlS5aYbeSvm5ubvwdAAi4CZBfaNWIVCEZBkK2AHDlyxNQFYaoGZs2a9X3s/s4leHRSSKzIY6zyE6YAGRoaMnVB2mnaa9jU+7CtYT7jVH5CqY1Go3Vg05m5BCiMzrgcNtUltqYBKSpKrXiLDnwN2tKGDpWmO+6nAFAQAoHAw2hDEx3udAGRtjIoIfM6BELCZbuFyxCQjRs3pnrtwZaWlrVNTU3/ArhZ6QSDPDg4uLe7u/tJ7scmg5T6eKG5mCMCgfBdmTNnjrrYg+fSFcpbWTr5BKEzzZCs1YhAXoGqhylldksYBxUCsK+1tXV7R0eHOrCiHRxUPh7BQY4XAotT5rqy2bNnq5qhfybSUUBOnz4dz2Grq1H4IKU8/8EO0EbPnz9fKS0tVaVRQl6Cis/eqKysXAVQXobULrQrF5BnUebNm/fY8uXLd547d069vyz2Zns5wAg4lMLCQoVz6/rcQR4gZV8ECCdyKUNADh8+/IlzjLUrKiqURYsWqftsNDvMjs2YMUPtyOXLl5WqqipVyvr7+1XbW1ZW9kFfX9/Knp6ePwCse6wufWuJXyfaw+juzxxI3oP31mvl4sWL1WMIhhKrrWKuCCr741S9yxAQSnu8bJR2lRLGfUmMpCMst1BDLly4oO4zMKDmIFHk5x+ik1/FoP0Eg7fLSi3BdVswwFwT1grglTNnzqiCA225PrAUHmo2hUSkX68BAojTZZ9cCyVU1RACw4d1JEyUMgy4BuZuE7671mqThcEsgalpxHWP4XAfhCVC3yF5g64NitvJ9lI5Bud+SN12aNIqu6QPQJQQFPAqHG7H9incqxEa0K3XEC9QtsUDc90uA4CvQyLfh685hMFYlcY+laMNT1Aj9X7AirKG5zSEHQYQn8buHvA9+kQrzYnhk7hvo95ceeXRNssA0cLdBxDjN8BUzHCwT7vAP9OH6qId+sRP71+cEhzbTBYjLTj1BuwexL6TYNQLGJJ7SFGQhIDjfuQmv0dw8SXRGuF0J4C2aQg6UYYOH0FH73CyQ7g3wXhUJF9CWgEDgvIIANnN6A/7tchFbqICxYa9TmtLqoDwefC/oSMLHBYsFQy9A4/xbY9gs1tnsvjqJ8bkI7G/cdp0pQLITWh8E7YlToOBwZwSjJjfRHDelV7erA8pBL/lNjDiRH3xwPBmlBVv0p71Ky1COYHDT7kJDDE1OtOTCAx+KeopQOLVskgFBQVPI0K53SHHrVZwwfWIilQHrr1tKFYzfozNL9PVLiv9jiEgLMzFDgYilHXo/FYOghPOj2AgOmoYGBh4lPtsh5TTdcnfdMAoRvtfYyQMTmVONo8LBGE19mF7yoooc1pLSbUwMhdm7CWnIhEWL9GG/3Z1dX23vb1dBYdzGixk6szUjmlqBiOs9VZpLYT0XrRnEQ7bbQMkTha7x0knzjmMZcuWNVZXV6smihpx9uzZ634NNAf8Wyfapr396FZs7QNEr34YAL49dKuTMbrWnkvUFJkJpMkiINoChDG7V4RM3UQbTRanMmWeA1zvdMLEyaW2trZiTs1Kx3lOZ7KugDdj/5BDWmLJABkCMnfuXBWMoaGhmyORSK0Vix5SIZqp/Pz8uwOBwG+k73HGgD4uDFD+mG7thQU5YysgNAeac/+Bi+YR1qDztRCUvyYwsc+hvRM4fj7BdZhkvWEmytJPW/PN22jLRxCWBgQ8ljxBZggIbTMcaQg325KO5TtJ0DG05U4Myrv6+lPMu3/3szQC2m9wjQF8VmO2AbGFS/FdVgBiWDrh2wdWrFixaXh4OOSyyZ0AIqw3ISgr9QMgy310bT2A4y125EJcKEGBFTNu5WykoYacPHmSoeXmZN8KlCYHmk9QMCBfFk2RAETmNrQ86oAG0v44ghhMtnwik1uhUOg2WI0f4vgdHD+hSolFb9AzBKSvry+Im6xxcrF0sqCIphAM3XtX4oESNJtv4Dq5hYWFxwB6Be6xSfn4ffT1VvXL0GRBCu7g8k83z0ULKGK+pK3i83TrrgjKt3U/7cXxKH8jACZTLtHmU2QaeLdWyLRXQ9DQaje/3Wcq80VQZFWlRgfx3Tb0qQaafwI8KRm/LPqbZl+JOh/ADOvOyeRXvW2AoLHLvLBsxggUSj0Lj3xtrZgynH8bu29LpETHLIvnLOirJaAk0tUqxUMkoGBAbteHwfpHEWTBgyx7lap1kmBEFeM/kUnZfCUCpEjxHhGUJvBaASXegMv8iU3vO0kJlET1EM7GHfSYlqggwCe8Dh/xII6f08zTepish3BczOw8BfPEKIGVzGK7zFciQF4Av4eLVmqlBi+91X4WtGBcy024tPQ1B6JFgjKK+z6D/XErACGd09hzRHNEP4EB+aKDr2LaA8FoxfZlqwBRvAqGPH4gf7HnBGk+LKlqQMYBonfi2oBkOZXc4tabwa/fsIDIc4L69bygf6T7H360tjyIzUvJCkPGaYj8w6hOSzrC4TCfFXkIn3G1yVgql9eirDuVjxdKGIHBKvMBq8NeT5usmNL8KauW6Wj3+BCbUqvBmCoxzBhKlw9JFYwbBhCLKRhv3KwAI2PDXjvMYBxQLAfD1xBzNAru1YHxLavA8DVkmlFbrEtCkPA4Qmn+Y88JAPKipS9B8NofL2Y6+SbLB8QnHxAP0f8BZ5KgB0Puc50AAAAASUVORK5CYII=';
 b:='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAecUlEQVR4Xu1dC5gcRbU+p6eHR5KFKILsGhSMQeDyRnzrJSCoYAgBHLardhMBEVEUvRdBxEe8ihfF9wsQJbKZql5GICbR4Duo+AKfKF4IoKgYiCiJeUpmps/9Tr7eONmd3eme6e7p7qn6vvk2MFXn8Vf9U11dVecgmGIQMAhMigAabAwCBoHJETAEiXl0VCqV3arV6mGFQmE/z/P6iKgPEfmzNxFNG/tv/gsAeyOi3cSkzQCwFgAe9f+uJaK1nuetfeihh9YtXrzYi9mNnhVvCBJR11cqlf3r9fohAHAIET137C8iHggAceJcB4DHiOiviPh/iHi353l3F4vFX5dKpe0RudezYuLsuFyCunjxYus5z3nOIYj4fAB4PiIeTURHIuL0NDlMRFUA+DUA/BwA7iKiu6SUTCBKk51pt8UQJEAPLV26tN+yrDMAgD8vSRsZArgwVoUf1X4CAN8jom8LIX5pCDM1eoYgk+CjlHoWIp4FAPx5UcyPSSHGeHRViegfTBZEvN3zvFuHhoY2Ric9H5IMQRr6sVKpHFSr1c4morP9R6h89HIAL/iRDBG/DQC3ENFXpZTrAzTLfZWeJ0ilUtm7VqtJIlrUa6SYYnTz4v6rRHSDEOK7vfwY1rME0Vq/FAAuAIDXAsCeuf8pbN/BhwHgi/wRQqxrX0w2W/YUQVavXm0/9thjJc/zrkTEw7LZZV2z+kkAGCGiq6WUf+iaFQkr7gmCjIyMTC8UCucDwDsQcVbCGOdKHRF5iLiciK6SUv4iV841cSbXBFFKPQUALkbEtwHAU/PemUn7R0S3FQqFKwYHB9ckrTspfbkkiOu6A57nvR0ALsrwnkVSY6BTPbyTfxMiLnYc5y+dCktb+1wRxD/3dCkAvAcR90gb2Hm2h4j+hYif9Dzvf/O0n5IbgmitTwSALwDA7DwPxLT75m8+fmDz5s2fv/DCC/m4S6ZL5gkyMjKyX6FQ+AQiikz3RP6Mf4iILpBSrs6ya5klCBGh1voCRPwIHxPPcifk2XYi0oh4iRDi71n0M5MEGR0dPbRer9+IiC/MIui9ZjMRrbcs61LHcW7Mmu+ZIog/a7zVnzV2yxrYxt4dx1fOy9I5r8wQxF9r8HR9khlo2UWAiPhWpMzK2iQTBFFKvRIAFCLuk92hYSxvQIAvbV29Zs2ad6f9unCqCXL99dcX+/r6ruIjImZ45RKB73metyDN+yapJYjrugd4nrcMEY/L5dAwTo0h8FC9Xj9teHj4/jRCkkqCaK1fBQCj5vVtGodM9DYR0RYAKEkpV0UvvTOJqSOIUuq1iOgCQKEz10zrLCHAp4QB4FIp5SfSZHeqCKKU4sOFn08TQMaWxBFYYtv2BaVSiQ9Bdr2khiBKqasQ8V1dR8QYkAYEvler1U5fuHAhP3p1tXSdILz557ouX+k8r6tIGOWpQoCIfkFEJ3b7DVdXCcJB2ObMmTOCiDJVvWOMSQsC91Sr1RMXLVrE4Ym6UrpGEL4fvnbt2lsQcX5XPDdKs4LAAwDwsm4FjOgKQZgcjz766K0AcHpWesnY2VUE7t1zzz1fumDBgg1JW5E4QQw5ku7ifOgjoru3b9/+8nPPPfdfSXqUKEEMOZLs2vzpIqJvDQwMnDZ37txaUt4lRhD/bdVX/Fi3SfmXFT0cyfAJInoCEXlBut7/9xMAUCOiZyLiswCAP/15jBMctKOIaFRK6QSt32m9xAiitf4wAFzWqcEZb09ExBHVv0VEnIrgQdu2HyyVSo8H9csPTPGsQqFwkOd5BxHR4Yh4CgAcHFRGDupdLYS4Igk/EiGIUup8ROS9jp4rRLTBJ8TtxWLx62HIEAascrk8q1AozPc872QAOBkRp4Vpn7W6RHShlJKDdMRaYieIUupUAFiJiFasnqRLOD8ucayo5f39/T9K8pmZYViyZMkexWJxrmVZ5wDAUB7Ptflnt+bFfcAxVoKMjo7O9jyPsxzNSNf4jccaXkRalnXDxo0bl6cl5A2ndKhWq+8EgHMRsRiP512Turlerx8zPDz8YFwWxEaQlStXTtu4cSM/b3O+vryX+wDgjUKI76fVUdd1DySiLwEAxw/LU7mvr6/vuHnz5m2Nw6nYCKKUuhURz4zD6LTIJCLOyHRlsVi8Ni2nT1th47ouJwj6FAAMtKqboe9vEUJwGovISywE0VpfCADXRW5tugRWbNu+OK5Fd5yuLlu2bObWrVs/jYjDcepJUjYiXuQ4TuRjLnKC8LqjXq//Lq+xcTnGEy98414cJjG4XNc9nfcV8pBAiGMDFwqF4wcHB38XJXaREsQ/nXtXXu+RE9FPPc87c3h4mEPX5KK4rvtiz/NuR8S9cuDQmieffPKoKI+jREoQpdTliHh1DoBu5sLHbNu+PCtrjTB9oJQ62s92y/lUMl2I6AtSSn7Ej6RERpByuXyYZVm/AoA8Rjz8HyHE+yJBPKVCRkdHj6/X63fkYYMREV/jOM7Xo4A6EoL4dzv4le4RURiVJhlE9GUp5blpsikuW1zXPYGIOBW0HZeOJOQS0SPFYvHQUqm0uVN9kRBEKbUYEfP4C3vrmjVrSmmP/tfpIGhsn6PAGZ8RQry1U2w6JojW+kgA4GSOmf7VGQ8kEd1fLBaPLJVKfNK2p4rW+msAcFrGneaDocd3mmi0I4L40db5lW7eUipv9zzveUNDQ7/N+CBpy3w/+em9iMhH67Nc7rFt+9hOXqx0RBDXdc/zjy9kGcRmtl8mhLgmb06F8Ucp9TpEXBKmTRrrIuLFjuN8rl3b2ibIqlWrdt+wYQNnNd23XeUpbXen4zgvR0SOQN7TRWv9SwA4Jssg+Bu7s9vNSdI2QbTW7wWA92cZvGa2e553ZK8+Wo3HQyn1CkTkt1qZLp3sjbRFED+ZzR/z8M68seeJ6DYp5VmZHg0RG6+1/j0AHBqx2KTFked5R7Xzw9cWQZRSH0fEtyftZZz6+AKO53mHpTUMf5y+TyU7L+vMdn/8QhOkUqnsX61WefbYo1udFodeIlJSSr59Z0oDArzWXL9+/d/ycFYLEY91HIdPewQuoQmilPosIr45sIaMVEzL2oOzau29995HENFeiLjF87w/dyuq4FjXKaXKeQgPS0Rfk1LOCzMkQxFk6dKl/YVC4eG8nbfiQMlSyueFAS6qunwltlar8WWf44joUH9PaZfcKH7iy9FCoXBj1Me5g/ihtT4DAJYFqZv2OmFnkVAE0Vp/DAD+K+0ghLWPiN4kpbw2bLt261cqlUKtVjuXiC5AxOeHlLMSAN4thLgnZLu2q/uhhv6Zk8fqshAi8EWxwARZvnx535YtW9bl4XLNuJHyZK1W2yepXBTlcvkIy7Ju7vDN0JOI+BbHcW5oe9SHbKi1/gEHkQ7ZLI3VOSrjrKCPrYEJopR6FyJyxtlcFSLSnLQ7Cae01vz8y9Eld49I3zVCiESC8SmlrkbEyyOyu6tiiOiDUsr3BDEiEEF4iq3Vao/kcNecMRoWQpSDgNVJHT8x6fKo129EdKWU8kOd2BakrU/uFUHqZqDOEzNnzhw49dRTn2xlayCCaK359efSVsKy+H2tVnv6woUL/xan7f5lpB/E+Ax/ihAi1h3vSqXyDP9HMk6oEpNNRIuklCOtFAYlyB0A8J+thGXw+zVCiFjjdvGCvFqtrkHEZ8eIz19t255TKpW2xagDtNaceiCqx8M4TQ0i+2dCiBe2qtiSIJVK5Zm1Wu1PrQRl8Xsiuk5KeVGctiulLkHET8apg2XHFfam0W6tNUfJPCpuXxKUf7gQ4t6p9LUkSJ6jshORI6XksDexFI6Ru9tuuz2CiPvEomBXod8XQpwQpx6tNb9gODtOHQnLvlEIcX7bBPEvRD2GiPslbHhS6lr+gnRiSMLXV/kG3T7tHusO4qfW+tMA8JYgdTNSZ5tt2zOnujU65QyiteY4rt/NiLOhzZw5c+YeQd5khBbsN9Ba/xQAXtBu+7DtLMs6enBw8Ddh2wWt77ru+4hocdD6WajH4XEdx5n0lEArgnD+hQuy4GhYG4noD1LK2WHbBa3vH8tZG7R+FPU8zzt1aGjo9ihkNZOhlLoYET8Tl/xuyG11SHVSgvhvXx5HxMwHE5sE+G8IIV4dV6copc5ERM7km1ghooVSythexyulBhHRTcyhBBRxAPJisbjvZI9ZkxKEE98gYiTBtxLwM7QKIvq0lPKS0A0DNujGznPcM4jrugv4XkVACDJTbapAc5MSRGvNkbIjC+GYNrQQ8T2O43wwLruUUl9FxPlxyZ9E7lFxHmL0g13zaYC8leuFEG9s5tRUM8hfEHFW3pBo8OftQojY9ie01hwy6PCk8COifwgh9o0z2ERenyo4EqOU8oDABFm6dOlzC4UCZ03KbSGi10spOeNSLEUpxSmdk1y/tXyn36mjeT5yNNkbwKYzSFK7v512WCftEXHQcRw+dh5L0VrzQbjEAnnH/YqXQdJa8yPplbEA1n2hfMdmwmn1pgTRWvPinLPT5rZEGQF8PEicJ+Xggw+uJwjeCiFE7OudPKfVI6IfSSlfOr7PJhDE79x/9kBmWr6Rx9mi4iic8jqpy0WxZ3odA0gpldt1KRFVN2/ePH18duIJBBkdHT3W8zwORm1KBhCIcyZsdN+/CZnYNd9uQI+IL3Ec58eNuicQRCn1dkT8eDcMNDrDIZDUZSm2ynXddxPRB8JZmLnaE2IyTyCI1prPpXAUC1NSjAARfU5KeXFSJiqlfp7X3JNjGBLRcinlLmO/GUEeA4CnJwW80RMeASK6WQjhxLnn0WiVnwMmtkOQ4RGIrcU6IcT+kz5icf7sbdu2xbVwjc2rHhO8wrbtMzvJeREWr7wEjgvit23b+5RKpSfG6u4yg+T9eHsQgFJeZ0V/f/9Zc+fO5dA1iRQOVG7b9l/zlkFsMvAsy3rl4ODgt5oSpBc2CBMZVTEoIaKvDAwMiCTJwW5orT8CAO+IwaW0itxloT5+BuFAZK9Pq+W9ahffWeBogEmtOcZwVkrNQUROf5Cr/JNTjaPx90PGEyQv0fNywyU+li+EeFvS5ODr1q7r/iTJG5Ep6bRdop3sQpA875SmBPwwZvBRFT5x3JUbfAnfpw+DS9x1d3mTtZMgfkDlxBZ/cXuZZfl8yw0RTxdCfL8bfriue6DnefcgYl839Hdbp23b08ZijO0kSC8cce828AH18z32k4QQXbluwPlJ+vr67s5Z/KuA0O+sdugY/jsJUi6XX21Z1qqwkkz9SBFYZ1nWywcHB9dEKjWEsByG9gnh/c6qrxZCfIP/aydBlFLnI+IX25Fm2nSOABH9sVAonDw4OPhQ59Lak5DXG4NtoHGeEGJHjvhGglyOiFe3Icw06RyBBxDxBMdxEg0T1Gi267rHeJ73Q0Sc3rk7mZewcy+kkSDXIOKlmXctew7cU61WT1y0aNE/umU6x1+uVqu/TChEarfcDKP3I0KIHblQGgmyBBFfF0aKqdsZApwbkYhOHBoa2tiZpPZb33TTTfvYtn1XzNHn2zewOy133u9vJMhKvnzTHXt6UuuPa7XaKUmlfmuG8MjIyPRCobAaEY/vyR6Y3OmdV5h3EkRrzTF4ORavKfEj8DARHRtnoOlWLvDJ7a1bt34n73c8WuHQ7Hsi+q6U8hXjH7Hu5CuH7Qg0bYIjwJuAAPA8KeUDwVtFW9N/rOKMV4dFKzk30u4UQuyIKdA4g/DmUFdyhecG1taO8PER3gTsyg45m+cfX78TAOa0Nrc3axDR3VLKHem5GwmSaCTAXoQ+6Xzs4zEeHR09ql6vL0PEg3oR/xA+3yOE2JFJq5EgvHtrflVCoBimKhHdLqXsWqwxrfVbiOhjiFgMY3cv1iWi+6WUh4wnCJ/7P7QXAYnbZ1531Ov1OXFn023mh1LqKYjIKRFOi9vPvMgnot9LKf9jPEHylqAxNf1FROdKKb+ctEH+qdw7EPFZSevOsj4i+rWU8phdCKKU4s0i8z48+p79nhDipOjFTi2xXC7PQsSf5DxCfyywEtFdUsodqfMa1yA/BIAJsUljsaB3hNZ4h9pxnL8k6bJPDn5tb2aO9oD/oRDi5eMJYjYK2wNzqlY3CSESPb6jtX46Ef3MkKP9zmy6UWgiKrYP6CQtybKsQ5K828GXnWbMmMEzx453+Ka0jcAyIcSZ49cgX0TEKZOqt62uBxs2C2MZNwxaa34RsChuPT0g/4tCiB3ZnRvXIB8GgMt6wPlEXOQXHo7j/DwRZQBgYppFivTVQogrxhOEycEkMaVzBHYJHdO5uKkl8GUnPh4BAIW4dfWCfCJ6h5Tyo+MfscyV24h6n4gukVJ+OiJxLcX0QuT1liBEW2HilVsTtCEyhAkA+oUQ6yKTOIUgpdTrEHHH/WlTokGgMT7vzjXI6OjooZ7n8XETUzpAgIhWSykTuVezfPnyvi1btvwBAJ7Wgcmm6TgELMt67tjbx50EWbly5bRNmzZtMWh1hgARXSil/EJnUoK11lqbdWMwqELVsm3bHksvMT427+Pm1ygUlhMq27a9X6lUYhxjLRw7V2v9MCI+M1ZFvSf8r0KIWWNuj4/Nm/s0WzH398NCiETuWoyOjp7ied43Y/anF8XvPGbCzo8nyAgiDvciKlH4zDk8pJSlKGS1kqG1vg0AFrSqZ74PjcDnhRBvnmwGuRQRrwkt0jTYgUDj+/M4IVm1atXuGzZs2NxLeTvixHOc7DcKIa5vShCt9ckAsDP9VIJG5UXVCUncN3dd9yQi+k5eQEuTH57nvWhoaOinkxGEs9tylltT2kBg+vTpe82fP39TG01DNdFafxAArgzVyFQOhEBfX9/0efPmbW1KEP6fSql1iLhfIGmmUiMCm4UQieTT0Fr/CABebOCPFgEielBKuUtchmZ50pcDwOnRqs6/NCL6g5RydhKeaq03AMDeSejqMR0jQohdTkNPIIhSykR5b2NUENFPpZQvaqNpqCZ+gpvtoRqZykER2GWBzo0mEMR13ZcRESfzNCUcAjvjuYZrFq42B2LgXCLhWpnaQRDwPO/IoaEhjg+3s0wgSKVS2bNarf7TxE8KAum/6xDRl6SUsafQLpfLL7Qsi7PPmhIhAkS06YEHHpi5ePFib0qC8JdKKROnNzz4Nwgh3hC+WbgWJgtUOLyC1iair0kp542vP2EG8QnyLkS8KqhwU28HAmUhROynELTWfFKYA2yYEiECiHix4zifC0qQoxHxVxHqz70oIrpNSnlW3I66rvsCfiEQt55ek09EBzeLuN90BmFwtNZ/A4B9ew2odv1NKvZuuVw+wrKse9q107SbiAARPSKlPKAZNlMRhO807IjsYEogBO4QQswNVLODSkqpZyNi1zLhdmB6apsS0XVSyotCEcQsBlPbn8awiBEgoldJKZteHZh0BqlUKrtVq9XHEXGviO0x4gwCqUGAiNYXi8V9x24QBlqkj1VSSilEFKnxxhhiEIgegeuFEG+cTOykM4i/UOe3MrdEb5ORaBBIBwKchltKubotgvi76n9HxGnpcMdYYRCIFIHHHMcZQEQO1dS0TDmD+LPIDQAQ+xGKSN02wgwCARAgog9JKae8VxOEIJyK6ncB9JkqBoFMIUBEB0op/zSV0S0J4s8ivHO7I+OOKQaBPCAQNMBfUILwJZLEc+zloSOMD+lEABGl4zi6lXWBCOJH0VgLAE9tJdB8bxDIAAKP27Y9q1Qqtbx4Fogg7LBS6gOI+O4MON8tEznt2TuTUE5EKwFgRhK6cqrjCiHE1UF8C0wQzn0HAI+YWEzNYU3qsKL/Y7UeEWcG6WBTZ1cE+GLUjBkznhE0+kxggvgdY3bWJxlxhiCZoeLHhBCXBrU2FEH8TEa/DCq8l+oZgmSit7fX6/UDh4eHHw1qbSiCsFCt9QoAmHA1MajCvNYzBMlEz35KCPG2MJaGJoiZRcwaJMwAS0tdIvpXrVabtWjRon+EsSk0QfxZxEQWH4eymUHCDLuu1A219hizsC2C+Nc+f9MsrlZXXE+BUkOQFHTC5C9Qttbr9YMWLlzI18hDlbYI4s8i5hBjA9SGIKHGXaKVEfE9juNwwO/QpW2CVCqVfavV6kOImEjA5tCeJdzAECRhwIOre3zmzJkHnHrqqU8Gb/Lvmm0ThEUopS5BxE+2ozhvbQxB0tmjiHi+4zg3tmtdRwSpVCqFarV6DyIe1q4BeWlnCJLKnrzXcZwjproQ1crqjgjir0U4ojnnq+hYVitj0/y9IUjqeqcGAMcJITqKIRbJoNZac8jGN6UOogQNMgRJEOwAqojo/VLKxQGqTlklEoJUKpUZtVrtAQDYv1ODstreECQ9PUdEvx0YGDh27ty5PIt0VCIhCFvguu7pRMTZqXqyGIKkptu3W5Z13ODgYCTXxCMjiP9W63pEjD0FQGq6osEQQ5DU9MplQojIUplHSpAlS5bssfvuu/MO+8GpgSshQwxBEgJ6CjVE9AshxPGdvLUaLz5SgrDw0dHRwz3P+wUA7NZ9yJKzwBAkOaybaeLDiIVC4fDBwcFIA3tHThA2XmvNb7QmJCPpLoTxajcEiRffVtIR8SLHca5rVS/s97EQxCfJVwDg7LAGZbW+IUj3ei7O5EWxEWTlypXTNm3axI9ah3QPuuQ0G4Ikh3WjJiK6f6+99jp23rx5W+OwIDaCsLFLly59jmVZv+mF2L6GIHEMz5YyN1uWdXTU645GrbEShBW5rnua53krENFq6W6GKxiCJNt5RORZlnW64zhfj1Nz7ARh45VSb0DE6+N0pNuyiehBdjUhOy5HxD0S0pVKNUR0oZSS0wTGWhIhiE+SaxAxcLiVWL02wrOOwEeEEJcn4URiBCEidF230ktvtpLowB7UcYvjOKUoNwOnwjAxgrARq1evth999NFvA8AJPdixxuXOEVhh2/aZk+UT7Fz8RAmJEoTV8+vfjRs33oGIx8fhkJGZWwRW9Pf3nxXFCd0wCCVOEDZu2bJlM7dt23YnAHByHlMMAq0Q6Ao52KiuEIQVVyqV/avVKs8kz22Fjvm+dxEgoq8MDAyIpGeOMcS7RhA2QGv9NCL6NiIe3btDwHg+GQJEpIQQw0ktyJvZ0VWCsEHlcnkvRPyOWZMYojQiQETXCiHe3E1ydPURqxEMvrJbrVa/iognmWFiECCiD0gp35sGJLo+g4yBwCGEarXatQBwQRqAMTZ0BQEiordKKT/bFe1NlKaGIGO2aa3/GwD4ymTqbEtLp+XUjhoRDUspR9PkXyoHYblcfo1lWa7Jw5emoRKrLf8konOklN+MVUsbwlNJEP8NF98juR0ADmzDL9MkIwjwPXLLshY4jvOXNJqcWoIwWEqpp/CWCSK+Io3gGZs6QoAA4OP9/f3v7NYeRxDrU00QdmDx4sXWnDlzPoSIl5l1SZAuTX8dIuIsTzKNj1Tj0Us9QcYMVkrN5UkFEfvTPwSMhZMhQETfrdfrop1kNt1ANTMEGXvkQsSlAHBaN8AyOjtCYDsAXCGE+HhHUhJunCmCNMwmr+PnV0TkNYop6Ufgh0R0vpSS4zdnqmSSIIzwyMjIfrZtc/IeJ1OI95CxRLTBsqzLHMfhdH2ZLJklyBjao6Ojp3ie93kAmJ3JHsip0US0tF6vX5qVtcZk3ZB5grBjlUplt2q1ehG/9ELEmTkdc1lx6yEiOk9K+YOsGDyVnbkgyJiDlUpl71qt9i4+z9PrUT+6MDi3AcBVtm1fUyqVeEGei5Irgoz1SLlcnoWIPJvwYr6Qi55KqRNEtAkAOO3FR4UQ61JqZttm5ZIgY2horQ8hoqsQ8cy2ETINmyLgb/Z9atq0aZ9ZsGDBhrzClGuCNCzkj/c87woAOMPsxnc2lInoT/yKvVgs3lAqlfixKtelJwjSQJSDPc/j4HWLei1/SQSj+DdEdE2xWBxNMuxOBHZ3JKKnCNKwmN+/Xq+/nog4XdwBHSGY78Y8Q3AaixuEEByFpudKTxJkrJc52uPNN998sud5fIuRH7/snhsBTRwmorsQ8abp06cvnT9/Pi/Ce7b0NEEae52P1iPiGUT0WkQ8udfI4pPiFtu2by6VSn/uWUaMc9wQpMlI8PdT+M3Xq4jolJxuPvL97x8DwK0AcJuUkhffphiChBsD/n2UY3hWIaKTEPGFGb4KvJmIfoSIK2q12i1ZPwYSrifbq21mkJC48bpFKXUoIj4fAPjzPAA4GhGLIUXFXX0zAPwWAH4FAHdZlnXXOeecc1+340zF7XTU8g1BIkB01apVu69fv/4oy7KOJyL+HIaIAwCwf5w7+ZxlCQD+hIj3A8C9iMhJfO4rFAr3lUqlxyJwredFGILEOAT48Wz27NlPt237GUTUzx8AGPDJ8wwAmN5E/XY+voGI/DjEfzf5xzk287/543kev1laVywWf5+nc08xdkXbog1B2obONOwFBAxBeqGXjY9tI/D/JrWhbrQpc7gAAAAASUVORK5CYII=';
 c:='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAeqElEQVR4Xu1dCbxVVdVf69x7QeNJaGn4RAVNTTFt1swBh0pxwKnLu3s/ULDCyuxrMj8zwtLUUj/r04oyKXh7n8fNMkTRzML4nBrQyLB6mKko4AjKQ5N771nfb+FFn/CGM98z7P37vV8Da6/hv/f/nnP2sBaCaQYBg8CACKDBxiBgEBgYAUMQMzsMAoMgYAhipodBwBDEzAGDgD8EzBPEH26mV04QMATJyUCbMP0hYAjiDzfTKycIGILkZKBNmP4QMATxh5vplRMEDEEiGuhFixYNX7t27S4AMMayrDFEtDsRtSPiGP7/mn9vA4ChxoAA4GkiegIANv+t5P+OiE8Q0cre3t6VM2bMqEUUSq7VDjU4uQbHTfBEhPPnzx/faDQORMTxALA/EY1HxHEuJr8bE25kiIj+jYjLAWA5Ef2tUCgsmzx58nJEZIKZ5hMBQxCPwC1evLi4Zs2aDzqOcxgiHgIAhwLAmz2qiUWciNYi4r0AcA8iLhk9evS9Rx55ZD0W4xkxYgjiYiDnzp27U6FQOBYAJgLAcYg40kW3JIq8QES3I+ItAHCLEOLZJDqZJJ8MQQYYjQULFmzX29t7GgBIADgKEa0kDVxQX4jIAYDFANBVKpVuKJfLvUF1ZrG/IUifUW2+Pn2UiCQRnYKI22Rx0LeMiYj+g4g3IqIqFAq3lcvlRh7idhOjIQgAdHd3v8dxnKnNp8Vb3QCXVRkiehoRNSLOrVQqD2Q1Trdx5ZYgs2fPLo0cOfJjjuOcj4jvdAtYzuT+TERX9/b2VvO6jJw7gtx4442jXn755c8Q0bmIuFPOJryvcIloNSJeu+222157yimnrPOlJKWdckMQ/uh+6aWXPuc4zpdTvArV0mlGROssy7qyUChcnZeP+swThHe0161bdw4AXAAAO7R0hmXH+PMA8K1Ro0ZdM3HixFeyE9bWkWSaILZtH+84zrWIuHuWB7GFsT1KRGdLKX/dQh8iNZ1JgiilmBA/QcSjI0XPKN+EABHdbFnWZyuVyqNZgyRTBKlWq8MajcZ5RHQhAAzP2mAlOR7eS+HXrlKpdHm5XN6YZF+9+JYZgiilDkfE6wFgTy8AGNnQEfgXEU2XUi4JXXMLFKaeIM2P8B8AwLQW4GdMDozAnGKxeHbanyapJki1Wt2tVqvdbDb6EsvTB4rF4snlcvnxxHo4hGOpJYhS6hhEvCGpR83TOiEi8JtPEJ8upbwjAt2Rq0wdQfhA4erVq2c19zVS53/kI5pAA82Tw5eVSqWZaTsImaoJZtv2ro7jVBHx4ATOA+PSEAgQ0X2WZZUrlQpfGU5FSw1BtNZ8YanbvFKlYl4N5uQLANAhhLgtDZGkgiBKqQ5EnAcAxTSAanwcEoE6EU2RUvIPXqJb4gmilDoHEb8XYwKERA9YhpzjRBPnSimvSXJMiSaIUuoSRORDhqZlF4FLhBB88iGRLZEE4ctMbW1tcxGxI5GoGadCRYCIVG9v77QkXspKHEGq1WpbvV6/tZlOJ9SBMMqSiwARLWlrazth0qRJ65PkZaIIwpeaNmzY8H8AcGCSQDK+xIbAshEjRhyWJJIkhiB8Erder3MaGk7GZlp+EbirWCwenZQzXIkgSLVaLdRqtV8h4gn5nRcm8j4I3FQsFk9Nwq57IgiiteZj6uY0bjgceYCIbrAsa1mhUHiw70HBarW6Q6PReDcRvR8ApgPAXuGYjETLHCEE+9jS1nKCaK1nAsBFLUUh/cZ5T+HHRHRNZ2fng27D0Vp/mIguRsQPuO0Ts9zXhRDfiNnmG8y1lCC2bU8mosTvprZygIayTUQPFQqFKR0dHfcPJdvfv8+aNcvaZ599PkVE3wGAbf3oiLIPL/VXKpX5UdoYTHfLCMI3AAHgDkQstSr4tNslolt7e3snhbF/0N3d/RHHcTipdaKO8xAR1z05plU3FFtCEK3124iIa1e8Je2TtFX+E9HP29vbRZjlDGzbPp31tiqmgewS0XOlUunAcrn8ZNy+xU6Q5n0Ovq/8wbiDzYo9Irp7xYoVh8+aNYsztIfalFLfR8RPhao0BGVEtLS9vf3gMH8Q3LgVO0G01lcAwBfdOGdktkaAsxsi4juEEE9Fgc+cOXO2GT58OF+R3TEK/QF1Xi2E+HxAHZ66x0qQrq6uEyzLWujJQyP8BgSI6Awp5dwoYVFKXYWIsU5ED/GcJISIbQ7FRpBqtTq6Vqs9hIjbewDDiL4Rgad23nnnMVG/ZjTLQSxNIvhcVq5UKu1XLpfXxOFfLAThQpda6zsRkVeuTPOJABHNlFJ+02d31934ZEO9XuecuwXXnWIU5IONQogJcRQojYUgSqkvISKvs5sWAIFGo7HXlClTHg6gwnVXrfXfAeAdrjvELEhEX5ZS8vdspC1ygnR3d+/pOM5DADAs0kgyrpyXOqWUsVW/UkrdhYgfSjCsGxuNxviofzAiJQjv0u611173ISKf/TEtGAI3CiFODabCfW+t9Z8A4H3ue8QvSUR/LJVKh0R5qDFSgmitzweAS+OHLnsWiegHUspPxxWZ1vpvADA+LnsB7Py3EOKyAP0H7RoZQTiHFRGtMFnWQxu62PYAmpu5Lyft2MkASG4sFot7RZXeNDKCaK1vAoATQ5seRtFVQohYNlht2z6Ik7ylCPKbhBCTovA3EoLYtn00EaUyF2sUIIehk4h+KaU8LQxdQ+lQSn0eEa8aSi5J/05ER0RxoDF0gjRvB/Yg4h5JAjDtvvCxdillLN8ESql/IOI+acKM8SmVSgeE/cEeOkGUUmch4nVpAjclvjbq9Xr71KlTn47SX631UQDw2yhtRKWbiD4upfxJmPpDJQh/3K1atepfiLhbmE4aXa8h8CUhxJVR4qG15sQZE6K0EZVuInq8vb19zzCP4oRKEPP0iGroX9VLRI9s3Lhx/LRp07geYOgtCycewn6KhEYQ8/QIfb4OpHC2EOLssK1prfl+Dt/TSdSNQq9xhv0UCY0gtm0LTiHpNSAj7x0BIpompfyp957991BK8RJpNyJuE5bOFusRQgg7DB9CI4jWehkAHBCGU0bH4Ag0KzZNlVIG+kHiZH21Wu1riJjY5NE+58JfhRChZOcMhSBpXvnwOQCJ6MYZYRqNxuf8rGxlvWw2ER0lpeQFh0AtFIIopRYh4nGBPDGdfSFARBsQ8WdEdLWUko/2DNiUUnxZjYsRnQEAB/kymJ5Oi4QQxwd1NzBBuBRzvV5/1BS4CToUwfsT0WOIyJkV+XoBp8vhVuJNPyLanzMpIqIV3FIqNFCxWBwb9IxWYIJorS8HgPNSAZlxMm8IfFsI8ZUgQQciSHNpd43JbxVkCEzfqBDgS2bt7e2jg2wcBiKI1roCADqqAI1eg0AICARa8g1KEE5VOTGEIIwKg0BUCNwihPBdVsM3QbgaVG9v73Mmt24k40oA8CIArG0miusFgJEAsD0RjULE7SKxmk2lG0eMGPFWv1WrfBNEKXUmIs7JJqaxR8WbrH9CxKX8x7U9BquwVK1Wt3UcZ3/+4xSuRMRLt4Y0Aw/bmUKIn/kZ1SAEMXsffhB/9dDhBgBYgIi3c8FSPxt9fU3PnTt3RLFY5Doa55jsMf0Oiu89EV8EWbhw4ZtefPFFzhFrShd4I0kPEX2/ra3ter+P/MHMKaW4YtSchKfr8YZYCNJcQqHRaGw/depU/mHy1HwRRGt9MgDc6MlSvoX/DABfE0LcFjUMnGpp77335lffqVHbSpN+IjpZSrnAq8++CKKUmo2In/RqLIfyyxBxZqVS4QQWsbVmhnauOLVvbEYTboiIfiSlnOHVTV8E0VpzIZN2r8byIk9EnB6Unxjz48gf2x+uWutDAYBrzpv26nffE1LKXb2C4ZkgXV1d+1mWtdyroZzIP8sJptvb238cZPc2LKy01py6J+uHEl3D5TjO+M7OTj6n5rp5Joht22dzlj/XFnIiSESLEbESVWEbPzAqpc5BxP/10zejfc4WQsz2EptngiilFCIKL0YyLlvn16lKpXJ5q16nBsJXa81pgjiFqGmvvmYpKWWnFzA8E0RrvRoARnsxkmHZZxzHOamzszORWQi7urpGWpb1Qobx9xraKiHELl46eSJI8+7HY14MZFj2nmKxeNpglY74ghIilgFAAgB/NPPxkQuEEN+PCxetNRf69DTOcfnWCjvFYnF3L3dEPAFn2/ZJROR5LbkVQERpk4i+VSqVZg6Uxa9JjK8DAGcfGb6lL0T0binlX6L0kXVzZS/btkOvhBu13xHr91Tj0BNBtNZfBYCLIw4gseqbR0Q4WcIvB3Jy3rx5by8UCr8BgLEDyRDRp6WUkS90zJ07d6disRhJNdzEDtLQjl0ohLhkaLFXJTwRRCnFqWEmu1WeMbnniejogX75+de6u7t7huM4VyDiiMFiJ6KKlLI7any6uro+ZFnWXVHbSZN+Ipovpexw67MngmiteQ05d7uzRPRvAPjoQEkReOd62LBh/OPhJgX/RgDYRQjxrNtB8itn2/ZniOgav/2z2M9rEnCvBOFEAKnOvOdj0Fcg4oRKpbKqv77VarWtXq9zehm35cpiK4Sjtebbnnzr07TXEahXKpVhbpfkXRPEtu2xzV/S3IBNRP9ExEMH+rVvLqPe7na3moheLJVK48rl8vNRg9j8QF8LAG+O2lba9BPRWCmlq9VYLwSZwLvFaQMjgL+ruPjoIE+OXWq12u2IuJ8HG7zEG0vNxmZiuN978C03ooh4ZKVSudNNwK4JorWeBgDXu1GaBRkiOkhK+cf+Ypk3b94+hUKBa2h42XR66pVXXhkbVWb2Lf3UWnOdjOlZGIsIYpguhHB1G9YLQS4CgJkROJs4lYMdjdZaH0BEv/OR6ugTQohYCgvxDcNCofDUUKtpiQM+JoeI6JtSSldz2QtBfggAns/TxxRzmGYGzMjHry0AsBAROYGCl9bT09Oz76xZs2LZtLNt+xNMci8O5kzWdQkJ1wRRSv0CEWMrZN+qAePrmVLKYVvat217OhHxSVDPq3h+b7P5xSCvy/Ee8PqFEOJ0N/JeCPJ7RORf0Mw33s/YfAuQl3FrtdqFiOgrhSURLZVSul0CDoyt1vrDAMAra6YNgAARLZFSHuEGINcEydOvEhGttyzrPMdx2prEeKsbMPuTcRzn0M7Ozrv99vfaz2TaHxoxL5uFXgjyhMdVm6E9zbgEH+yUUnKCi1iaUupdnN09FmPpNvKkEGKMmxC8EITLD+/oRqmR2XSS1ikUCvt2dHT0xIWHUuo2RPxoXPZSbOcZIcRObvx3TRCl1As+Vm/c+JBVmeuEEJ+IKzjbtg8iokRe3IoLA7d2+ESDlNLVCQPXBNFac+nhre42uHUqT3JE9B9EHBvn/XSl1B2IeHSecPYbK4+PlHJbN/29EIQTKpvmDoFLhRAXuBMNLmWeHt4xFEK4mvuuhNi8UqqRo/Jd3hF/vcfzjuOM6+zs5Ou1sTSlVG6W4MMAlL8PpZQFN7q8EOTlDNXRdoONLxki+oKU8n98dfbRyVQY9g5aJK9Y5iPd1UA8uX79+nEzZszYXEDTVacgQiY5nHf0ovpIfwYAfG+YeQ8jlT2mCCG64vK8u7v7I47j/Douexmy86wQwtWWhetXLK212SgcZIYQ0YNSygPinETm6eEbbdf5sbwQ5EEA4IpGpvWDABEdK6WM7ddcKTUREblGpGkeEfDyY+aFIHybcIJHX/Iifo8Q4kNxBquUegAR3xWnzQzZulMIcaSbeLwQ5AYAOM2N0rzJENH7pJRL44rbJPALjPQNQoiPudHihSB5uTDlBrfXZLzmWfKkfABh8/QIjGIkF6ZmISKn0zTtdQQaxWJxr3K5zHmzYmlKqVMR8RexGMuoESK6SEo5y014Xp4guUra4AY8TsompfysG9mwZPJ0LycszLbUQ0TTpJQ/daPfNUGUUkci4u/cKM2DDOfpLZVKu8WR42oznlprzhQ/Pw/4RhljJGl/qtXquHq9/kiUjqdM99eFEFybPJbWrF7LxXByl/o1bIARcVylUnnUjV7XT5DFixcXV69ezUfeXR3ycmM8xTJP1ev1Pf3U3fYbs23bgisk+e1v+r2GQGPnnXfexm0NSdcEYfVKqeUeMwlmclziKl+wGbzm04NvJu6ZSUDjDWq5EML1hrdXguS5/MGmYeT8xKVSiVeuGnGNq1JqKiL+LC57WbbjdVneE0Fs276Qs9JlGUAXsU0WQlRdyIUiUq1WC/V6/Z/m6REKnKwk0gI6kxDxV6G5mjJFfOdbCHGI29T5YYTXTFjHeXZNCwEBr0n8vD5B2onoyRD8TKUKRHxPpVKJLa1O8+nBm5C7phKwBDrdaDTap0yZwpWaXTVPBGl+qD+KiLu70p4toVuEECfEGZJS6pOI6KnwfZz+pc0WET0mpRywdmR/8fghSBciclnj3LRmjqv9Ozo6/h5X0NVqdVi9Xn/YPD1CRbxLCDHFi0bPBLFt+2wiirxCq5cgYpCdK4Q4IwY7r5nQWn8aAK6N02YObJ0thPD0RPZMkO7u7n0dx+FinnlphIh7uN15DQOU5tODS4SNDkOf0fEqAo7jjO/s7PQ0dz0TpPkdshIRXeU2zcDguE6VH1asSqlzEfG7YekzejYh4PqabV+8/BJkNiJ+MifA7y+EWB5XrFxSevjw4bxyZZ4eIYI+WNWwwcz4Ioht26cQ0S9D9D+pqhYJIY6P0zmt9RcA4Mo4bebE1ilCCM97eL4IwjXwisUilzLeqhJTlsCOe9+Dnx7Dhg17wkf9wyzBHnosXDVs5MiRo0488cSXvCr3RRA2orW+GQBi/XX1GlxA+d8JIWJNBq21Pg8ALvfrNxFxoZ57AWCaIdkbUPS9h+WbIEqpMxHRVSldvwPeyn5ejyQE9bVZmfYxPxOb92kQ8fJKpfJVPgbTTGbNRPE9vkHjSVj/M4UQvg57+gZwwYIF223YsGFtFu+HENHDK1as2CeuqrTNlcFvIOLXvE4sIuLCRh+TUi7p21drzXXcj/KqL4PyjREjRmw/adKk9X5i802Q5qAuQsTj/BhOeJ/YapozDtVqdcdarfZvH3XNlyHixEqlsmpLPHPwCuxqChHRrVLKia6E+xEKRJCM3pF+Yf369TvGmYBaKfVdRDzX4yD+wXGcj/RXZqH5sf+UqQi2CdFA1xMCEWT27Nml7bbbjn+9MpPUmoi+J6X8nMfJ6lu8q6trDCI+goglt0qI6I6NGzeeOG3aNL4CvVXzSTi35lMjR0TPtbe3j3Z7vba/wAIRpPmadZnfGuJJRNqyrPd2dHTcH5dvWmuuJfJfHuzN7enpmTbQ95FS6hhE/I0HfZkVJaLLpZTnBwkwDILsjoi88xtYV5BAwuhLRI9IKWO7971o0aLha9eufdrNqxCvVAHA56WU3xsoVqXUHojI5HZVoDIMzBKsg4rF4thyufx4EB9DmdRZ+SBExFmVSuWiIIB66evhrnkvEU2WUi4ahBz8Q8X7ILt48SGrskR0s5TyxKDxhUKQrCSVsyzrXR0dHcuCguq2v9Z6yITgRPQ41z4XQvxjIL3d3d17Oo7ze0OO1xHykhxusPEKhSDNb5G0p+P3ddrTLRm2lCMitG2b95EGfB0ioj/V6/XjzjjjjOcGsqO1fgcRcRHPnfz6ksF+fxVCHBhGXGESRCJibOXHwgi+rw4iulZKeU7YegfSV61Wd6jX6/1O/ObO+LfXr18/c7DlZqXUBwDg14g4Ki6/02CHb7xWKhUdhq+hEYQzL65aterhFN9X93XaM8ggaK05nc/em3U0iXGLZVlfGep6L69WAcBCU3n4jSPAr6QrVqwYF9YpiNAIwm5qrdOcAX60EOKpIBPea1+t9XgA4Dxj2yPinYVC4bpyuTxk1hilVEfzaW3SwG4N+nQhRGhnBEMlSIqfIr1CiO28TvC45avV6rb1ep33TWbEbTsN9vjp0d7evmeQjcEt4wyVIM2P9bMQ8bo0ANrHx2VCiETX++vq6nonIv4cEfdJGbaxuUtEH5dShppkL3SCcLKzWq32D0R8e2zIBDf0ByHEwcHVhK+Bn8pr1qw533GcmV6Oo4TvSbI1EtFDpVLpgLBzJodOEIYxhQXu7xJCHJa0KcBPDcuy5gFAKEuWSYsvTH+I6Igtj/yHoT8SgjRftXiFJdZMhAEAWSmE2C1A/1C7Lly48E3r16/nepBfzOJ9m1DBelXZQiHESRHoje781Lx5895eKBS4ItLwKBwPW2exWBxVLpdfCFuvV31aaz4ewQnjTD5ed+C90mg09p8yZQpnoQy9RfYEYU+11nyS8tLQvY5AIRHNkFL+KALVrlRqrQ8lou8gYiK/hVwF0Rqh/xZCXBaV6UgJ0sxOvjQN79BEdL+U8r1RAT2Q3q6uroP5kCSft4rbdgbs/bWnp+fdYW0K9odHpARhg11dXftZlsUlAxKfIoiIviylvCKOiWOIERjljc3DpZEmFI+cIM1XLf7YjGXiBYS9DgBThRB2QD39dq9Wq2+u1+unsg0AmBCFjbzojOvHLBaCNE+uLgaAI9IwgER0RalUmlkul18O6m8zlSivsFQAgJMHJP5JGjTmqPsT0RIpZSxzKRaCMGDz5s3b2bIsrpK7fdQAhqSfz2VdRUR3lkqlpV42oJRSHOPhnI4HEScBQFtIPuVeDRGtLZVK+5XL5TVxgBEbQZqvWryEeVMcgYVpg4heQkRebLiPiFYj4vOO4zxnWdYriLgDHzZ0HGdHANgPEd9vCm6Gif5Wuk4SQiyM1EIf5bESpEkSTszMCZpNMwh4ReBKIcSXvHYKIh87QZonfu9p/tIG8d30zRECRLS0vb394DBP6rqBL3aCsFPVanWXWq3GWQHf4sZJI5NvBDi/ValUOtDNXZmwkWoJQTgI27YnOI5zuzmhGvaQZksfly5AxA8LITgpReytZQRpkkQQkYo9amMwNQggYkelUpnfKodbShAOWin1NUT8RqsAMHaTiwARzZRS8pXklrWWE4Qj11rzLbDpLUPBGE4iAtcLIc5qtWOJIEjzUCNXrDq21YAY+61HgLMilkqlk71szkbldSIIwsE1j2Rw0uVDowrW6E0FAvcUi8Ujy+XyxiR4mxiCMBhctaq3t3cJIiY6gUISBi6LPhDRX9ra2g73Ww0qCkwSRZA+JLkZEfksk2k5QYBrnrS1tZ2aJHIw9IkjCDvFhXna2trmcArJnMyPXIfJS/2lUumMJHxzbDkQiSTIZie11hcDwFdzPXuyH/wlQogLkxpmognCoCmlzkFELhqTeF+TOsgJ9YuI6Fwp5TUJ9W+TW6mYdM1ctJwfqphkMI1vrhGoE9EUKWW36x4tEkwFQRgbrTXvkTCgprxYiyZLSGY5tVKHEOK2kPRFqiY1BGEUbNve1XGcqkmNE+mciEw5Ed1nWVa5UqmsjMxIyIpTRRCOvXmf5GJEPC8tr4ghj1ka1REAXF4sFi9M4krVYICmjiCbg1FKcR6pblNdKfF8eYGITpdS3pF4T/txMLUEaa5wcWXXBWlITJfGyRHUZyJ6sFQqnRC0FHNQP4L0TzVBOPBmrfFrEbHlJz+DDEQG+84ZNWrUpyZOnPhKmmNLPUH6vHIdjojXm4wiLZ+O/yKi6VGUImhFZJkhCINXrVaH1et1Tph9QVqyyrdi0KOwSUT/QcRLi8XiZUk5iRtGnJkiSJ+nyR6IeDUAcB4u0yJGgO9vAMA5UsrHIjYVu/pMEqTvShci/hAAxsaObA4MEtFjlmWdValUfpvVcDNNkM0f8evWrTuLiM5LcQ33RM0/JgYifnvUqFE/SftH+FDAZp4gmwFoFhc9tbnB+L6hgDH/vjUCRPRHRLyyp6fnhihrciQJ+9wQpC/otm0fTUSzzPVe11PxLi7yk+VXqYGQyCVB+nyjHAMA3zRnu/qfHkR0NwDMSusuuGv6DyKYa4JsxqW7u/s9juNwUZspAMDZ2vPcnuHD05Zlze3o6Lg/z0Bw7IYgfWYAH4R88sknj7UsizM+noKI2+RhgjT3MG50HEcPGzbs1rQdKIxyjAxBBkC3q6trpGVZpwFAJxFNQEQryoGIWzcROYh4J5eRLBaLPy+Xy71x+5AGe4YgLkapWq3uWKvVjkPE44noWEQc6aJbEkX4ZC0nDL8FAG4RQjybRCeT5JMhiMfR4NewNWvWfNBxnMMQ8ZDmSlgibzkS0ToAuBcR70bEJaNHj7437voaHuFNnLghSMAh4QKl8+fPH99oNA5ExP0BYDwRjUfEcTF+43EChEcR8W8AsJz/LMv6y+TJk7kmJF9WMs0nAoYgPoEbqhsfnKzVamMAYIxlWWOIaHciakfETf9f8+9tLkjEE5wLij7Bf0S06T/5DxH5f6/s7e1dOWPGjNpQPpl/946AIYh3zEyPHCFgCJKjwTahekfAEMQ7ZqZHjhAwBMnRYJtQvSNgCOIdM9MjRwgYguRosE2o3hEwBPGOmemRIwQMQXI02CZU7wgYgnjHzPTIEQKGIDkabBOqdwT+H2yVV24xe7jFAAAAAElFTkSuQmCC';
    OPEN MESSAGEINFO FOR
    SELECT
    '' AS aboutphone,
    '' AS aboutdescription,
    '20px' AS lineheight,
     a AS lefticon,
    'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAKb0lEQVR4Xu2dv4ul1RnHzxmWGS6kmdtYxGLDWlikiI0mpAoLiiKsYLyJzeiAm/dNBkK6NAkZ0sTOQpb7vnsXEm2yJEZsrDbFElZd3SaQNmVg5g9IwMjc+4ZrZmEd58d7nvOc857zno+tz49zPt/z4e4dZ9Ea/oEABM4kYGEDAQicTQBBeB0QOIcAgvA8IIAgvAEIyAjwCSLjRlchBBCkkKC5powAgsi40VUIAQQpJGiuKSOAIDJudBVCAEEKCZprygggiIwbXYUQQJBCguaaMgIIIuNGVyEEEKSQoLmmjACCyLjRVQgBBCkkaK4pI4AgMm50FUKgSEEWi8Xjq9Vqxxiz2XXdf5fL5e/39vYOC8mcazoQKE6Qtm0Xxpg3TjLquu7tuq5/7sCO0gIIFCVI0zQfWGuvnZVr13Xv1XX9SgG5c8WeBIoRpGmaX1pr37yIC5JcRKisf1+EILdu3ZoeHR39y1o76RMvkvShVEZNEYI0TbNjrX3HJVIkcaE13toiBGnb9tfGmN+6xogkrsTGV1+KIL8wxrwljO8vVVX9UNhLW+YEihBksVh8d7VafeKR1Yfb29vXZrPZ0mMGrRkSKEKQdS5N0/zDWvttj4yQxANerq3FCDKfzy9vbGz81RhzRRpW13Xv13X9srSfvvwIFCPIOprFYvHYarW6Z4x5wiMqPkk84OXWWpQgSJLb8xz+vMUJgiTDP7qcTlCkIEiS0xMd9qzFCoIkwz68XLYXLQiS5PJMhztn8YIgyXCPL4fNCHKcEj8CzuG5xj8jgjzCHEniP8DUNyLIiYSQJPUnG/d8CHIKby1JDg4OXtrf3z+KGynbNAkgyBk0NSTpuu7O4eHhC0ii+WTjzkKQc3gjSdzHmOI2BLkgFSRJ8dnGOxOC9GCNJD0gjbQEQXoGiyQ9QY2sDEEcAkUSB1gjKUUQxyCRxBFY5uUIIggQSQTQMm1BEGFwSCIEl1kbgngEhiQe8DJpRRDPoJDEE2Di7QiiEBCSKEBMdASCKAWDJEogExuDIIqBIIkizERGIYhyEFqSTKfTF2ez2RfKx2OcIwEEcQTWp1xJkrvT6fQ5JOlDPFwNggRiiySBwEYeiyABgSNJQLiRRiNIYNBIEhhw4PEIEhjwejySRIAcaAWCBAJ7ciySRAKtvAZBlIGeNw5JIsJWWoUgSiD7jkGSvqTSqEOQAXJAkgGgC1ciiBCcbxuS+BKM048gcTifugVJBoTfczWC9AQVqgxJQpHVmYsgOhy9piCJF76gzQgSFG//4UjSn1XMSgSJSfuCXVqSbG1tPb+7u/t5QlfL9igIklh0GpIYYz7e3Ny8iiT+4SKIP0P1CUiijlQ8EEHE6MI2riVZLpf3rbWXPTbxSeIBb92KIJ4AQ7bP5/NvWmvvIUlIyufPRpDh2PfajCS9MAUrQpBgaPUGI4keS9dJCOJKbKB6JBkGPIIMw120FUlE2LyaEMQLX/xmJInLHEHi8lbZhiQqGHsNQZBemNIrQpI4mSBIHM5BtiBJEKxfGYog4RkH3YAkQfHyX9LD4o0zHUnCceYTJBzbqJO1JJlMJs/u7Oz8J+rhE16GIAmH43o0JUkeTCaTHyDJ/+kjiOsrTLweSXQDQhBdnklMQxK9GBBEj2VSk5BEJw4E0eGY5BQk8Y8FQfwZJj0BSfziQRA/fll0I4k8JgSRs8uqE0lkcSGIjFuWXUjiHhuCuDPLugNJ3OJDEDdeo6heLBaPr1arvxljviW9UNd1ny2Xy6t7e3v/ls7IoQ9BckgpwBmVJHmvrutXAhwvmZEIkkwU8Q+iJMmzdV3fiX/6OBsRJA7nZLcoSHK7qqpXk72g58EQxBPgGNo9v7j/vaqqp8bA4bQ7IMhYk3W4l6cgD6qqetphXValCJJVXPqH9ZTDdF3X1HX9U/2TpTERQdLIYZBTHH//uGuMuSI9wMbGxveuX79+X9qfeh+CpJ5QoPNpyNF13bt1Xb8W6IhJjEWQJGKIewgNOYwxn04mk6tj/6u5CBL3bQ6+zfc7x/EFivl76wgy+JONdwDkcGeNIO7MsuxADllsCCLjllUXcsjjQhA5uyw6kcMvJgTx45d0N3L4x4Mg/gyTnIAcOrEgiA7HpKYgh14cCKLHMolJyKEbA4Lo8hx0GnLo40cQfaaDTESOMNgRJAzXqFOV5PiY/zfI12NDkKhPWX+Zlhybm5tXd3d3P9c/Yd4TESTj/JAjfHgIEp5xkA3IEQTr14YiSBzOqluQQxXnucMQJB5rlU3IoYKx9xAE6Y1q+ELkiJ8BgsRnLtqIHCJs3k0I4o0w/ADkCM/4rA0IMhz7XpuRoxemYEUIEgyt/2Dk8GfoOwFBfAkG6keOQGAdxyKII7AY5cgRg3K/HQjSj1O0KuSIhrrXIgTphSlOkYYcXdfd3draep5fPNTJDEF0OHpP0ZJjOp0+N5vNvvA+EAO+JIAgCTwE5EgghDOOgCADZ4McAwdwwXoEGTCfxWLx2HK5vG+tvSw9xvo7B3+sktK7uA9BLmYUpGItx2q1umeMeUK6ADmk5Pr3IUh/VmqVyKGGMvggBAmO+KsLkCMycM91COIJ0KUdOVxopVGLIJFyQI5IoJXXIIgy0NPGIUcEyIFWIEggsA/HIkdgwIHHI0hAwMgREG6k0QgSCLSSHHem0+mL/G5VoJB6jEWQHpBcS7TkODw8fGF/f//IdT/1egQQRI/ll5OQQxnowOMQRDEA5FCEmcgoBFEKAjmUQCY2BkEUAkEOBYiJjkAQz2CQwxNg4u0I4hEQcnjAy6QVQYRBIYcQXGZtCCIIDDkE0DJtQRDH4JDDEVjm5QjiECByOMAaSSmC9AwSOXqCGlkZgvQIFDl6QBppCYJcEKyGHMaYDw8ODl7iFw/zswhBzslMS47t7e1rs9lsmd/z4MQIcsYbQA7kWBNAkFPeAXIgx0MCCHLiLSAHcjxKAEEeoYEcyHGSAIIcE0EO5DiNAIIo/TXZ9Y9y+WnV+CQrXhA+Ocb3qDVvVLQgyKH5lMY5q1hBkGOcD1r7VkUKghzaz2i884oTBDnG+5hD3KwoQZAjxBMa98xiBLlx48Y3Ll269MAY86RHpH+uqmrm0U9rZgSKEaRt2z8YY17zyAc5PODl2lqEIG3bXjHG/NMjJOTwgJdzaxGCNE3zM2vtDUlQXdf9qa7rH0l66cmfQBGCtG27b4z5jSAuPjkE0MbUUoQgTdP8xFrbOgaHHI7AxlhehCCu30H4Y9UYn7rsTkUIskbTtu1tY0yf7xK3q6p6VYaTrrERKEaQY0n+aIz58TkhvlNV1etjC5n7yAkUJcga082bN1/uuu5XxpjvPMTWdd1n1trfVVX1gRwlnWMkUJwgD0Ocz+fft9Y+Y639qKqqT8cYLnfyJ1CsIP7omFACAQQpIWXuKCaAIGJ0NJZAAEFKSJk7igkgiBgdjSUQQJASUuaOYgIIIkZHYwkEEKSElLmjmACCiNHRWAIBBCkhZe4oJoAgYnQ0lkAAQUpImTuKCSCIGB2NJRBAkBJS5o5iAggiRkdjCQQQpISUuaOYAIKI0dFYAgEEKSFl7igm8D/F3QsjHGil9QAAAABJRU5ErkJggg==' AS righttext,
    '岗位切换' AS describe,
    'Link' AS itemtype,
    '' AS beforewarningmsg,
    '' msgtitle,
    'pom-station-list' dataurl
FROM
    dual
UNION ALL
SELECT
    '' AS aboutphone,
    '' AS aboutdescription,
    '20px' AS lineheight,
     b AS lefticon,
    'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAKb0lEQVR4Xu2dv4ul1RnHzxmWGS6kmdtYxGLDWlikiI0mpAoLiiKsYLyJzeiAm/dNBkK6NAkZ0sTOQpb7vnsXEm2yJEZsrDbFElZd3SaQNmVg5g9IwMjc+4ZrZmEd58d7nvOc857zno+tz49zPt/z4e4dZ9Ea/oEABM4kYGEDAQicTQBBeB0QOIcAgvA8IIAgvAEIyAjwCSLjRlchBBCkkKC5powAgsi40VUIAQQpJGiuKSOAIDJudBVCAEEKCZprygggiIwbXYUQQJBCguaaMgIIIuNGVyEEEKSQoLmmjACCyLjRVQgBBCkkaK4pI4AgMm50FUKgSEEWi8Xjq9Vqxxiz2XXdf5fL5e/39vYOC8mcazoQKE6Qtm0Xxpg3TjLquu7tuq5/7sCO0gIIFCVI0zQfWGuvnZVr13Xv1XX9SgG5c8WeBIoRpGmaX1pr37yIC5JcRKisf1+EILdu3ZoeHR39y1o76RMvkvShVEZNEYI0TbNjrX3HJVIkcaE13toiBGnb9tfGmN+6xogkrsTGV1+KIL8wxrwljO8vVVX9UNhLW+YEihBksVh8d7VafeKR1Yfb29vXZrPZ0mMGrRkSKEKQdS5N0/zDWvttj4yQxANerq3FCDKfzy9vbGz81RhzRRpW13Xv13X9srSfvvwIFCPIOprFYvHYarW6Z4x5wiMqPkk84OXWWpQgSJLb8xz+vMUJgiTDP7qcTlCkIEiS0xMd9qzFCoIkwz68XLYXLQiS5PJMhztn8YIgyXCPL4fNCHKcEj8CzuG5xj8jgjzCHEniP8DUNyLIiYSQJPUnG/d8CHIKby1JDg4OXtrf3z+KGynbNAkgyBk0NSTpuu7O4eHhC0ii+WTjzkKQc3gjSdzHmOI2BLkgFSRJ8dnGOxOC9GCNJD0gjbQEQXoGiyQ9QY2sDEEcAkUSB1gjKUUQxyCRxBFY5uUIIggQSQTQMm1BEGFwSCIEl1kbgngEhiQe8DJpRRDPoJDEE2Di7QiiEBCSKEBMdASCKAWDJEogExuDIIqBIIkizERGIYhyEFqSTKfTF2ez2RfKx2OcIwEEcQTWp1xJkrvT6fQ5JOlDPFwNggRiiySBwEYeiyABgSNJQLiRRiNIYNBIEhhw4PEIEhjwejySRIAcaAWCBAJ7ciySRAKtvAZBlIGeNw5JIsJWWoUgSiD7jkGSvqTSqEOQAXJAkgGgC1ciiBCcbxuS+BKM048gcTifugVJBoTfczWC9AQVqgxJQpHVmYsgOhy9piCJF76gzQgSFG//4UjSn1XMSgSJSfuCXVqSbG1tPb+7u/t5QlfL9igIklh0GpIYYz7e3Ny8iiT+4SKIP0P1CUiijlQ8EEHE6MI2riVZLpf3rbWXPTbxSeIBb92KIJ4AQ7bP5/NvWmvvIUlIyufPRpDh2PfajCS9MAUrQpBgaPUGI4keS9dJCOJKbKB6JBkGPIIMw120FUlE2LyaEMQLX/xmJInLHEHi8lbZhiQqGHsNQZBemNIrQpI4mSBIHM5BtiBJEKxfGYog4RkH3YAkQfHyX9LD4o0zHUnCceYTJBzbqJO1JJlMJs/u7Oz8J+rhE16GIAmH43o0JUkeTCaTHyDJ/+kjiOsrTLweSXQDQhBdnklMQxK9GBBEj2VSk5BEJw4E0eGY5BQk8Y8FQfwZJj0BSfziQRA/fll0I4k8JgSRs8uqE0lkcSGIjFuWXUjiHhuCuDPLugNJ3OJDEDdeo6heLBaPr1arvxljviW9UNd1ny2Xy6t7e3v/ls7IoQ9BckgpwBmVJHmvrutXAhwvmZEIkkwU8Q+iJMmzdV3fiX/6OBsRJA7nZLcoSHK7qqpXk72g58EQxBPgGNo9v7j/vaqqp8bA4bQ7IMhYk3W4l6cgD6qqetphXValCJJVXPqH9ZTDdF3X1HX9U/2TpTERQdLIYZBTHH//uGuMuSI9wMbGxveuX79+X9qfeh+CpJ5QoPNpyNF13bt1Xb8W6IhJjEWQJGKIewgNOYwxn04mk6tj/6u5CBL3bQ6+zfc7x/EFivl76wgy+JONdwDkcGeNIO7MsuxADllsCCLjllUXcsjjQhA5uyw6kcMvJgTx45d0N3L4x4Mg/gyTnIAcOrEgiA7HpKYgh14cCKLHMolJyKEbA4Lo8hx0GnLo40cQfaaDTESOMNgRJAzXqFOV5PiY/zfI12NDkKhPWX+Zlhybm5tXd3d3P9c/Yd4TESTj/JAjfHgIEp5xkA3IEQTr14YiSBzOqluQQxXnucMQJB5rlU3IoYKx9xAE6Y1q+ELkiJ8BgsRnLtqIHCJs3k0I4o0w/ADkCM/4rA0IMhz7XpuRoxemYEUIEgyt/2Dk8GfoOwFBfAkG6keOQGAdxyKII7AY5cgRg3K/HQjSj1O0KuSIhrrXIgTphSlOkYYcXdfd3draep5fPNTJDEF0OHpP0ZJjOp0+N5vNvvA+EAO+JIAgCTwE5EgghDOOgCADZ4McAwdwwXoEGTCfxWLx2HK5vG+tvSw9xvo7B3+sktK7uA9BLmYUpGItx2q1umeMeUK6ADmk5Pr3IUh/VmqVyKGGMvggBAmO+KsLkCMycM91COIJ0KUdOVxopVGLIJFyQI5IoJXXIIgy0NPGIUcEyIFWIEggsA/HIkdgwIHHI0hAwMgREG6k0QgSCLSSHHem0+mL/G5VoJB6jEWQHpBcS7TkODw8fGF/f//IdT/1egQQRI/ll5OQQxnowOMQRDEA5FCEmcgoBFEKAjmUQCY2BkEUAkEOBYiJjkAQz2CQwxNg4u0I4hEQcnjAy6QVQYRBIYcQXGZtCCIIDDkE0DJtQRDH4JDDEVjm5QjiECByOMAaSSmC9AwSOXqCGlkZgvQIFDl6QBppCYJcEKyGHMaYDw8ODl7iFw/zswhBzslMS47t7e1rs9lsmd/z4MQIcsYbQA7kWBNAkFPeAXIgx0MCCHLiLSAHcjxKAEEeoYEcyHGSAIIcE0EO5DiNAIIo/TXZ9Y9y+WnV+CQrXhA+Ocb3qDVvVLQgyKH5lMY5q1hBkGOcD1r7VkUKghzaz2i884oTBDnG+5hD3KwoQZAjxBMa98xiBLlx48Y3Ll269MAY86RHpH+uqmrm0U9rZgSKEaRt2z8YY17zyAc5PODl2lqEIG3bXjHG/NMjJOTwgJdzaxGCNE3zM2vtDUlQXdf9qa7rH0l66cmfQBGCtG27b4z5jSAuPjkE0MbUUoQgTdP8xFrbOgaHHI7AxlhehCCu30H4Y9UYn7rsTkUIskbTtu1tY0yf7xK3q6p6VYaTrrERKEaQY0n+aIz58TkhvlNV1etjC5n7yAkUJcga082bN1/uuu5XxpjvPMTWdd1n1trfVVX1gRwlnWMkUJwgD0Ocz+fft9Y+Y639qKqqT8cYLnfyJ1CsIP7omFACAQQpIWXuKCaAIGJ0NJZAAEFKSJk7igkgiBgdjSUQQJASUuaOYgIIIkZHYwkEEKSElLmjmACCiNHRWAIBBCkhZe4oJoAgYnQ0lkAAQUpImTuKCSCIGB2NJRBAkBJS5o5iAggiRkdjCQQQpISUuaOYAIKI0dFYAgEEKSFl7igm8D/F3QsjHGil9QAAAABJRU5ErkJggg==' AS righttext,
    '帮助中心' AS describe,
    'Link' AS itemtype,
    '' AS beforewarningmsg,
    '' msgtitle,
    'question-list' dataurl
FROM
    dual
UNION ALL
SELECT
    '18590769090' AS aboutphone,
    '系统名称：计划运营管理系统</br>服务顾问：王传科</br>咨询电话：185-9076-9090' AS aboutdescription,
    '20px' AS lineheight,
     c AS lefticon,
    '' AS righttext,
    '关于我们' AS describe,
    'Info' AS itemtype,
    '' AS beforewarningmsg,
    '' msgtitle,
    '' dataurl
FROM
    dual;
END P_POM_MOBILE_CENTER_MESSAGE;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MOBILE_DELAY_NODE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_MOBILE_DELAY_NODE" (
    currentuserid IN VARCHAR2,
    currentstationid IN VARCHAR2,
    currentdeptid IN VARCHAR2,
    currentcompanyid IN VARCHAR2,
    bizcode IN VARCHAR2,
    plantype       IN             VARCHAR2,
    orgid          IN             VARCHAR2,
    title          OUT            VARCHAR2,
    pageindex     IN            INT,
    pagesizes     IN            INT,
    titleicon      OUT            VARCHAR2,
    currentdelay   OUT            SYS_REFCURSOR
) IS 
v_spid              VARCHAR2(200);

--关键节点计划监控-当前延误节点
		--作者：鲜晓勇
		--日期：2020/03/20
BEGIN
    title := '当前延误节点';
    --图标库地址 https://element.eleme.cn/#/zh-CN/component/icon
    titleicon := 'el-icon-tickets';

    --调用数据权限验证存储过程
     P_SYS_AUTH_DATA_RULE_SPID(
                USERID => currentuserid,
                STATIONID => currentstationid,
                DEPTID => currentdeptid,
                COMPANYID => currentcompanyid,
                BIZCODE => bizcode,
                DATA_AUTH_SPID => v_spid
            );
				OPEN CURRENTDELAY FOR
						SELECT t.* from (
                        SELECT DISTINCT                 
                                                        '已超期' as "nodeStatus",
                                                        B2.PLAN_END_DATE AS "nodeTime",
                                                        B2.ORIGINAL_PLAN_ID as "nodeOriginalId",
                                                        ''||plantype||'' as "nodePlanType",
                                                        rownum as rowno,
                                                        A.ORG_NAME AS "orgName",
														B2.PROJECTSTAGE_NAME AS "projName",
                                                         '【'||B2.PROJECTSTAGE_NAME||'】'||B2.NODE_NAME AS "nodeName",
                                                        NODE_ID as "nodeId",
                                                        ORIGINAL_NODE_ID as "nodeOriginId",
														'' AS "projOpenUrl",
														'' AS "nodeOpenUrl",
														 '已延期'
																||TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd'))
																||'天' 			AS "delayDays",
                                                            TO_NUMBER(nvl(TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd')),0)) as days
						FROM   SYS_BUSINESS_UNIT A
						LEFT   JOIN (SELECT LEVEL, ORG_NAME, CONNECT_BY_ROOT ID AS ID,
																CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
																B.UNIT_ID, B.NODE_NAME, B.NODE_ID,
																B.ACTUAL_END_DATE, B.PLAN_END_DATE,
																B.PROJECTSTAGE_NAME, B.PPID, B.PID,
																'TYPE_ORG' AS CTYPE, B.ESTIMATE_END_DATE,
																B.PLANID, ORIGINAL_NODE_ID,B.COMPANY_ID,
                                                                ORIGINAL_PLAN_ID
												 FROM   SYS_BUSINESS_UNIT A
												 LEFT   JOIN (SELECT B1.UNIT_ID, A.ID AS PLANID,A.COMPANY_ID,
																						B1.ID AS PPID, B1.ID AS PID,
																						A1.ORIGINAL_NODE_ID,
                                                                                        A1.ORIGINAL_PLAN_ID,
																						 A.PROJ_NAME AS PROJECTSTAGE_NAME,
																						A1.NODE_NAME, A1.ID AS NODE_ID,
																						A1.ACTUAL_END_DATE,
																						A1.PLAN_END_DATE,
																						A1.ESTIMATE_END_DATE
																		 FROM   POM_PROJ_PLAN A
																		 INNER  JOIN POM_PROJ_PLAN_NODE A1
																		 ON     A.ID = A1.PROJ_PLAN_ID
																		 INNER  JOIN SYS_PROJECT_STAGE C1
																		 ON     A.PROJ_ID = C1.ID
																		 INNER  JOIN SYS_PROJECT B1
																		 ON     C1.PROJECT_ID = B1.ID
																		 WHERE  A.PLAN_TYPE = ''||plantype||'' AND
																						A.APPROVAL_STATUS = '已审核' 	AND

																						TRUNC(SYSDATE, 'dd') -TRUNC(PLAN_END_DATE, 'dd') > 0 AND
																						ACTUAL_END_DATE IS NULL) B
												 ON     A.ID = B.UNIT_ID
												 WHERE  ORG_TYPE = 0
												 START  WITH ID = '' || ORGID || ''
												 CONNECT BY PRIOR A.ID = A.PARENT_ID) B2
						ON     A.ID = B2.ID
                         LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=B2.PLANID or tal.orgid=B2.COMPANY_ID
						WHERE  NODE_NAME IS NOT NULL AND
                         tal.orgid is not null AND
									 ACTUAL_END_DATE IS NULL AND
									 TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 --分期
--                                     AND rownum <=  ''|| pageindex * pagesizes||''
						UNION 
						SELECT DISTINCT              
                                                      '已超期' as "nodeStatus",
                                                        PLAN_END_DATE AS "nodeTime",
                                                        A1.ORIGINAL_PLAN_ID as "nodeOriginalId",
                                                        ''||plantype||'' as "nodePlanType",
                                                    rownum as rowno,
                                                     '' AS "orgName",
													 A.PROJ_NAME AS "projName",
														'【'||A.PROJ_NAME||'】'||A1.NODE_NAME AS "nodeName",
                                                         A1.ID as "nodeId",
                                                        A1.ORIGINAL_NODE_ID as "nodeOriginId",
														'' AS "projOpenUrl",
														'' AS "nodeOpenUrl",
														  '已延期'
																||TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd'))
																||'天' 			AS "delayDays",
                                                                 TO_NUMBER(nvl(TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd')),0)) as days

						FROM   POM_PROJ_PLAN A
						INNER  JOIN POM_PROJ_PLAN_NODE A1
						ON     A.ID = A1.PROJ_PLAN_ID
						INNER  JOIN SYS_PROJECT_STAGE C1
						ON     A.PROJ_ID = C1.ID
						INNER  JOIN SYS_PROJECT B1
						ON     C1.PROJECT_ID = B1.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal 
                        on tal.orgid=C1.PROJECT_ID or tal.orgid=A1.COMPANY_ID
						WHERE  A.PLAN_TYPE = ''||plantype||'' AND
									 A.APPROVAL_STATUS = '已审核'   AND
                                     tal.orgid is not null AND
									 TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 AND
									 ACTUAL_END_DATE IS NULL AND
									 C1.PROJECT_ID = '' || ORGID || ''
--                                     AND rownum <=  ''|| pageindex * pagesizes||''
						order by days desc
                        )t  where  rownum <=  ''|| pageindex * pagesizes||'' AND t.rowno >= ''|| pagesizes * ( pageindex - 1 )||'';
END p_pom_mobile_delay_node;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MOBILE_DELAY_NODE_MORE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_MOBILE_DELAY_NODE_MORE" (
    currentuserid IN VARCHAR2,
    currentstationid IN VARCHAR2,
    currentdeptid IN VARCHAR2,
    currentcompanyid IN VARCHAR2,
    bizcode IN VARCHAR2,
    plantype       IN             VARCHAR2,
    orgid          IN             VARCHAR2,
    pageIndex     IN            INT,
    pageRows     IN            INT,
    currentdelay   OUT            SYS_REFCURSOR
) IS 
v_spid              VARCHAR2(200);
        --关键节点计划监控-当前延误节点
		--作者：鲜晓勇
		--日期：2020/03/20
BEGIN

--调用数据权限验证存储过程
     P_SYS_AUTH_DATA_RULE_SPID(
                USERID => currentuserid,
                STATIONID => currentstationid,
                DEPTID => currentdeptid,
                COMPANYID => currentcompanyid,
                BIZCODE => bizcode,
                DATA_AUTH_SPID => v_spid
            );

				OPEN CURRENTDELAY FOR
						SELECT t.* from (
                        SELECT DISTINCT                 
                                                        '已超期' as "nodeStatus",
                                                        to_char(B2.PLAN_END_DATE,'yyyy-MM-dd') as "nodeTime",
                                                        B2.ORIGINAL_PLAN_ID as "planOriginalId",
                                                        ''||plantype||'' as "nodePlanType",
                                                        rownum as rowno,
                                                        A.ORG_NAME AS "orgName",
														B2.PROJECTSTAGE_NAME AS "projName",
                                                        '【'||B2.PROJECTSTAGE_NAME||'】'||B2.NODE_NAME AS "nodeName",
                                                        NODE_ID as "nodeId",
                                                        ORIGINAL_NODE_ID as "nodeOriginalId",
														'' AS "projOpenUrl",
														'' AS "nodeOpenUrl",
														 '已延期'
																||TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd'))
																||'天' 			AS "delayDays",
                                                    TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd')) days
						FROM   SYS_BUSINESS_UNIT A
						LEFT   JOIN (SELECT LEVEL, ORG_NAME, CONNECT_BY_ROOT ID AS ID,
																CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
																B.UNIT_ID, B.NODE_NAME, B.NODE_ID,
																B.ACTUAL_END_DATE, B.PLAN_END_DATE,
																B.PROJECTSTAGE_NAME, B.PPID, B.PID,
																'TYPE_ORG' AS CTYPE, B.ESTIMATE_END_DATE,
																B.PLANID, ORIGINAL_NODE_ID,B.COMPANY_ID,
                                                                ORIGINAL_PLAN_ID
												 FROM   SYS_BUSINESS_UNIT A
												 LEFT   JOIN (SELECT B1.UNIT_ID, A.ID AS PLANID,A.COMPANY_ID,
																						B1.ID AS PPID, B1.ID AS PID,
																						A1.ORIGINAL_NODE_ID,
                                                                                        A1.ORIGINAL_PLAN_ID,
																						 A.PROJ_NAME AS PROJECTSTAGE_NAME,
																						A1.NODE_NAME, A1.ID AS NODE_ID,
																						A1.ACTUAL_END_DATE,
																						A1.PLAN_END_DATE,
																						A1.ESTIMATE_END_DATE
																		 FROM   POM_PROJ_PLAN A
																		 INNER  JOIN POM_PROJ_PLAN_NODE A1
																		 ON     A.ID = A1.PROJ_PLAN_ID
																		 INNER  JOIN SYS_PROJECT_STAGE C1
																		 ON     A.PROJ_ID = C1.ID
																		 INNER  JOIN SYS_PROJECT B1
																		 ON     C1.PROJECT_ID = B1.ID
																		 WHERE  A.PLAN_TYPE = ''||plantype||'' AND
																						A.APPROVAL_STATUS = '已审核' 	AND

																						TRUNC(SYSDATE, 'dd') -TRUNC(PLAN_END_DATE, 'dd') > 0 AND
																						ACTUAL_END_DATE IS NULL) B
												 ON     A.ID = B.UNIT_ID
												 WHERE  ORG_TYPE = 0
												 START  WITH ID = '' || ORGID || ''
												 CONNECT BY PRIOR A.ID = A.PARENT_ID) B2
						ON     A.ID = B2.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=B2.PLANID or tal.orgid=B2.COMPANY_ID
						WHERE  NODE_NAME IS NOT NULL AND
                                     tal.orgid IS NOT NULL AND
									 ACTUAL_END_DATE IS NULL AND
									 TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 --分期
                                     AND rownum <=  ''|| pageIndex * pageRows||''
						UNION 
						SELECT DISTINCT              
                                                      '已超期' as "nodeStatus",
                                                         to_char(PLAN_END_DATE,'yyyy-MM-dd') as "nodeTime",
                                                        A1.ORIGINAL_PLAN_ID as "planOriginalId",
                                                        ''||plantype||'' as "nodePlanType",
                                                    rownum as rowno,
                                                     '' AS "orgName",
													 A.PROJ_NAME AS "projName",
														'【'||A.PROJ_NAME||'】'||A1.NODE_NAME AS "nodeName",
                                                         A1.ID as "nodeId",
                                                        A1.ORIGINAL_NODE_ID as "nodeOriginalId",
														'' AS "projOpenUrl",
														'' AS "nodeOpenUrl",
														  '已延期'
																||TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd'))
																||'天' 			AS "delayDays",
                                                                 TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd')) days
						FROM   POM_PROJ_PLAN A
						INNER  JOIN POM_PROJ_PLAN_NODE A1
						ON     A.ID = A1.PROJ_PLAN_ID
						INNER  JOIN SYS_PROJECT_STAGE C1
						ON     A.PROJ_ID = C1.ID
						INNER  JOIN SYS_PROJECT B1
						ON     C1.PROJECT_ID = B1.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal 
                        on tal.orgid=C1.PROJECT_ID or tal.orgid=A1.COMPANY_ID
						WHERE  A.PLAN_TYPE = ''||plantype||'' AND
									 A.APPROVAL_STATUS = '已审核'   AND
                                     tal.orgid is not null AND
									 TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 AND
									 ACTUAL_END_DATE IS NULL AND
									 C1.PROJECT_ID = '' || ORGID || ''
                                     AND rownum <=  ''|| pageIndex * pageRows||''
						order by days desc
                        )t where t.rowno > ''|| pageRows * ( pageIndex - 1 )||'' order by t.days desc;
END p_pom_mobile_delay_node_more;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MOBILE_DELAY_NODE_PRED
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_MOBILE_DELAY_NODE_PRED" (
    plantype       IN             VARCHAR2,
    ctype           IN             INT, ---0 查询 近五天内到期或预计延误   1 查询预计延误  2 查询近五天内到期
    orgid          IN             VARCHAR2,
    pageindex      IN              INT,
    pagesizes      IN              INT,
    userid  IN             VARCHAR2,
    currentstationid  IN          VARCHAR2,
    currentdeptid  IN       VARCHAR2,
    currentcompanyid  IN          VARCHAR2,
    bizcode  IN             VARCHAR2,
    title          OUT            VARCHAR2,
    titleicon      OUT            VARCHAR2,
    predictdelay   OUT            SYS_REFCURSOR
) AS -- 移动端 关键节点计划监控-预计延误节点
		--作者：鲜晓勇
		--日期：2020/03/20
    v_sql   CLOB;
    v_sql_exec CLOB;
    v_caseSql  CLOB;
    v_whereSql CLOB;
    v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN
    title := '预计延误及5天内到期节点';
    titleicon := '';
    IF ctype=0 THEN
    v_whereSql:=' AND (TRUNC(ESTIMATE_END_DATE , ''dd'' ) - TRUNC(PLAN_END_DATE , ''dd'' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, ''dd'' ) - TRUNC( SYSDATE, ''dd'' )  BETWEEN 0 AND 5)';
    v_caseSql:='	CASE  WHEN TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ) > 0   THEN
						''预计延误''||TO_CHAR( TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ))||''天'' 
								WHEN  TRUNC(SYSDATE, ''dd'') - TRUNC(PLAN_END_DATE)=0 THEN 
						''今天到期'' 
								ELSE ''余''
																||TO_CHAR(TRUNC(PLAN_END_DATE, ''dd'')-TRUNC(SYSDATE, ''dd''))
																||''天到期'' 	 END				
														AS "delayDays"';
    ELSIF ctype=1 THEN
    v_whereSql:=' AND (TRUNC(ESTIMATE_END_DATE , ''dd'' ) - TRUNC(PLAN_END_DATE , ''dd'' ) > 0 )';
    v_caseSql:='CASE  WHEN TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ) > 0   THEN
						''预计延误''||TO_CHAR( TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ))||''天'' END AS "delayDays"';
    ELSE
    v_whereSql:=' AND ( TRUNC( PLAN_END_DATE, ''dd'' ) - TRUNC( SYSDATE, ''dd'' )  BETWEEN 0 AND 5)';
    v_caseSql:='CASE	WHEN  TRUNC(SYSDATE, ''dd'') - TRUNC(PLAN_END_DATE)=0 THEN 
						''今天到期'' 
								ELSE ''余''
																||TO_CHAR(TRUNC(PLAN_END_DATE, ''dd'')-TRUNC(SYSDATE, ''dd''))
																||''天到期'' 	 END				
														AS "delayDays"';
    END IF;

    --调用数据权限验证存储过程
    p_sys_auth_data_rule_spid(userid => userid, stationid => currentstationid, deptid => currentdeptid, companyid => currentcompanyid
    , bizcode => bizcode, data_auth_spid => v_spid);

    v_sql:='SELECT DISTINCT
      ''未完成'' as "nodeStatus",
      B2.ORIGINAL_PLAN_ID as "planOriginalId",
      '''||plantype||''' as "nodePlanType",
      rownum as rowno,
      to_char(B2.PLAN_END_DATE,''yyyy-MM-dd'') as "nodeTime",
      A.ORG_NAME AS "orgName",
      B2.PROJECTSTAGE_NAME AS "projName",
      B2.NODE_NAME AS "nodeName",
      ''【''||B2.PROJECTSTAGE_NAME||''】''||B2.NODE_NAME AS "allNodeName",
      NODE_ID as "nodeId",
      ORIGINAL_NODE_ID as "nodeOriginalId",
      '''' AS "projOpenUrl",
      '''' AS "nodeOpenUrl",
      '||v_caseSql||'
    FROM
      SYS_BUSINESS_UNIT a
      LEFT JOIN (
      SELECT LEVEL,
        ORG_NAME,
        CONNECT_BY_ROOT ID AS ID,
        CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
        B.UNIT_ID,
        B.COMPANY_ID,
        B.NODE_NAME,
        B.ORIGINAL_PLAN_ID,
        B.NODE_ID,
        B.ACTUAL_END_DATE,
        B.PLAN_END_DATE,
        B.PROJECTSTAGE_NAME,
        B.PPID,
        B.PID,
        ''TYPE_ORG'' AS CTYPE,
        B.ESTIMATE_END_DATE,
        PLANID,
        ORIGINAL_NODE_ID 
      FROM
        SYS_BUSINESS_UNIT A
        LEFT JOIN (
        SELECT
          B1.UNIT_ID,
          A.ID AS PLANID,
          A1.ORIGINAL_NODE_ID,
          A.PROJ_ID AS PPID,
          B1.ID AS PID,
           A.PROJ_NAME AS PROJECTSTAGE_NAME,
           A1.ORIGINAL_PLAN_ID,
          A1.NODE_NAME,
          A1.ID AS NODE_ID,
          A1.ACTUAL_END_DATE,
          A1.PLAN_END_DATE,
          A1.ESTIMATE_END_DATE,
          A.COMPANY_ID
        FROM
          POM_PROJ_PLAN A
          INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
          INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
          INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
        WHERE
          A.PLAN_TYPE = '''||plantype||''' 
          AND A.APPROVAL_STATUS = ''已审核'' 
          '||v_whereSql||'
          AND ACTUAL_END_DATE IS NULL 

        ) B ON A.ID = B.UNIT_ID 
      WHERE
        ORG_TYPE = 0 START WITH ID = ''' || orgId || ''' CONNECT BY PRIOR A.ID = A.PARENT_ID 
      ) B2 ON A.ID = B2.ID 
       LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=B2.PLANID or tal.orgid=B2.COMPANY_ID
    WHERE
      NODE_NAME IS NOT NULL 
      AND tal.orgid is not null AND
      ACTUAL_END_DATE IS NULL 
			--判断条件
    AND (TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, ''dd'' ) - TRUNC( SYSDATE, ''dd'' )  BETWEEN 0 AND 5 --5天内到期
				)
			--分期
    UNION ALL
    SELECT DISTINCT
       ''未完成'' as "nodeStatus",
      A1.ORIGINAL_PLAN_ID as "planOriginalId",
      '''||plantype||''' as "nodePlanType",
        rownum as rowno,
         to_char(A1.PLAN_END_DATE,''yyyy-MM-dd'') as "nodeTime",
      '''' AS "orgName",
       A.PROJ_NAME AS "projName",
      A1.NODE_NAME AS "nodeName",
      ''【''||A.PROJ_NAME||''】''||A1.NODE_NAME AS "allNodeName",
        A1.ID as "nodeId",
      A1.ORIGINAL_NODE_ID as "nodeOriginalId",
      '''' AS "projOpenUrl",
      '''' AS "nodeOpenUrl",
    '||v_caseSql||'
    FROM
      POM_PROJ_PLAN A
      INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
      INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
      INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
      LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal 
      on tal.orgid=C1.PROJECT_ID or tal.orgid=A1.COMPANY_ID
    WHERE
      A.PLAN_TYPE = '''||plantype||''' 
      AND A.APPROVAL_STATUS = ''已审核'' 
      AND tal.orgid is not null
      ' ||v_whereSql||'
      AND ACTUAL_END_DATE IS NULL 

      AND C1.PROJECT_ID = ''' || orgId || '''
    ORDER BY
      6 DESC';
       v_sql_exec := '
select t.* from ( '
                  || v_sql

                  || ' ) t where t.rowno <= '
                  || pagesizes
                  || '';
       dbms_output.put_line(v_sql_exec);
   open predictdelay FOR v_sql_exec;


END p_pom_mobile_delay_node_pred;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MOBILE_ES_DEL_NODE_MORE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_MOBILE_ES_DEL_NODE_MORE" (
    plantype       IN             VARCHAR2,
    ctype           IN             INT, ---0 查询 近五天内到期或预计延误   1 查询预计延误  2 查询近五天内到期
    orgid          IN             VARCHAR2,
    pageIndex      IN              INT,
    pageRows      IN              INT,
    predictdelay   OUT            SYS_REFCURSOR
) AS -- 移动端 关键节点计划监控-预计延误节点
		--作者：鲜晓勇
		--日期：2020/03/20
    v_sql   CLOB;
    v_sql_exec CLOB;
    v_caseSql  CLOB;
    v_whereSql CLOB;
BEGIN
    IF ctype=0 THEN
    v_whereSql:=' AND (TRUNC(ESTIMATE_END_DATE , ''dd'' ) - TRUNC(PLAN_END_DATE , ''dd'' ) > 0  OR
							 TRUNC( PLAN_END_DATE, ''dd'' ) - TRUNC( SYSDATE, ''dd'' )  BETWEEN 0 AND 5)
                              AND TRUNC( PLAN_END_DATE, ''dd'' )>TRUNC( SYSDATE, ''dd'' )
                             ';
    v_caseSql:='	CASE  WHEN TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ) > 0   THEN
						''预计延误''||TO_CHAR( TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ))||''天''
								WHEN  TRUNC(SYSDATE, ''dd'') - TRUNC(PLAN_END_DATE)=0 THEN
						''今天到期''
								ELSE ''余''
																||TO_CHAR(TRUNC(PLAN_END_DATE, ''dd'')-TRUNC(SYSDATE, ''dd''))
																||''天到期'' 	 END
														AS "delayDays"';
    ELSIF ctype=1 THEN
    v_whereSql:=' AND (TRUNC(ESTIMATE_END_DATE , ''dd'' ) - TRUNC(PLAN_END_DATE , ''dd'' ) > 0 ) AND TRUNC( PLAN_END_DATE, ''dd'' )>TRUNC( SYSDATE, ''dd'' )';
    v_caseSql:='CASE  WHEN TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ) > 0   THEN
						''预计延误''||TO_CHAR( TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ))||''天'' END AS "delayDays"';
    ELSE
    v_whereSql:=' AND TRUNC( PLAN_END_DATE, ''dd'' )>TRUNC( SYSDATE, ''dd'' )  AND ( TRUNC( PLAN_END_DATE, ''dd'' ) - TRUNC( SYSDATE, ''dd'' )  BETWEEN 0 AND 5)';
    v_caseSql:='CASE	WHEN  TRUNC(SYSDATE, ''dd'') - TRUNC(PLAN_END_DATE)=0 THEN
						''今天到期''
								ELSE ''余''
																||TO_CHAR(TRUNC(PLAN_END_DATE, ''dd'')-TRUNC(SYSDATE, ''dd''))
																||''天到期'' 	 END
														AS "delayDays"';
    END IF;
    v_sql:='select a.* From 
    (SELECT DISTINCT
      ''未完成'' as "nodeStatus",
      B2.ORIGINAL_PLAN_ID as "originalPlanId",
      '''||plantype||''' as "nodePlanType",
      rownum as rowno,
      to_char(B2.PLAN_END_DATE,''yyyy-MM-dd'') as "nodeTime",
      A.ORG_NAME AS "orgName",
      B2.PROJECTSTAGE_NAME AS "projName",
      B2.NODE_NAME||''【''||B2.PROJECTSTAGE_NAME||''】'' AS "nodeName",
      NODE_ID as "nodeId",
      ORIGINAL_NODE_ID as "nodeOriginId",
      '''' AS "projOpenUrl",
      '''' AS "nodeOpenUrl",
      '||v_caseSql||'
    FROM
      SYS_BUSINESS_UNIT a
      LEFT JOIN (
      SELECT LEVEL,
        ORG_NAME,
        CONNECT_BY_ROOT ID AS ID,
        CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
        B.UNIT_ID,
        B.NODE_NAME,
        B.ORIGINAL_PLAN_ID,
        B.NODE_ID,
        B.ACTUAL_END_DATE,
        B.PLAN_END_DATE,
        B.PROJECTSTAGE_NAME,
        B.PPID,
        B.PID,
        ''TYPE_ORG'' AS CTYPE,
        B.ESTIMATE_END_DATE,
        PLANID,
        ORIGINAL_NODE_ID
      FROM
        SYS_BUSINESS_UNIT A
        LEFT JOIN (
        SELECT
          B1.UNIT_ID,
          A.ID AS PLANID,
          A1.ORIGINAL_NODE_ID,
          A.PROJ_ID AS PPID,
          B1.ID AS PID,
           A.PROJ_NAME AS PROJECTSTAGE_NAME,
           A1.ORIGINAL_PLAN_ID,
          A1.NODE_NAME,
          A1.ID AS NODE_ID,
          A1.ACTUAL_END_DATE,
          A1.PLAN_END_DATE,
          A1.ESTIMATE_END_DATE
        FROM
          POM_PROJ_PLAN A
          INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
          INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
          INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID
        WHERE
          A.PLAN_TYPE = '''||plantype||'''
          AND A.APPROVAL_STATUS = ''已审核''
          '||v_whereSql||'
          AND ACTUAL_END_DATE IS NULL
          ORDER BY PLAN_END_DATE  ASC
        ) B ON A.ID = B.UNIT_ID
      WHERE
        ORG_TYPE = 0 START WITH ID = ''' || orgId || ''' CONNECT BY PRIOR A.ID = A.PARENT_ID
      ) B2 ON A.ID = B2.ID
    WHERE
      NODE_NAME IS NOT NULL
      AND ACTUAL_END_DATE IS NULL
			--判断条件
    AND (TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ) > 0  OR
							 TRUNC( PLAN_END_DATE, ''dd'' ) - TRUNC( SYSDATE, ''dd'' )  BETWEEN 0 AND 5 --5天内到期

				)
			--分期
    UNION ALL
    SELECT DISTINCT
       ''未完成'' as "nodeStatus",
      A1.ORIGINAL_PLAN_ID as "originalPlanId",
      '''||plantype||''' as "nodePlanType",
        rownum as rowno,
         to_char(A1.PLAN_END_DATE,''yyyy-MM-dd'') as "nodeTime",
      '''' AS "orgName",
       A.PROJ_NAME AS "projName",
      A1.NODE_NAME||''【''||A.PROJ_NAME||''】'' AS "nodeName",
        A1.ID as "nodeId",
      A1.ORIGINAL_NODE_ID as "nodeOriginId",
      '''' AS "projOpenUrl",
      '''' AS "nodeOpenUrl",
    '||v_caseSql||'
    FROM
      POM_PROJ_PLAN A
      INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
      INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
      INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID
    WHERE
      A.PLAN_TYPE = '''||plantype||'''
      AND A.APPROVAL_STATUS = ''已审核''
      ' ||v_whereSql||'
      AND ACTUAL_END_DATE IS NULL

      AND C1.PROJECT_ID = ''' || orgId || ''' order by "nodeTime") a';
       v_sql_exec := 'select t.* from ( '
                  || v_sql
                    || ' WHERE rownum <= '
                         || pageIndex * pageRows
                         || ' ) t where t.rowno > '
                         || pageRows * ( pageIndex - 1 )
                         || '';

       dbms_output.put_line(v_sql_exec);
   open predictdelay FOR v_sql_exec;


END p_pom_mobile_es_del_node_more;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MOBILE_HELP_CENTER
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_MOBILE_HELP_CENTER" (
    HELPINFO  OUT SYS_REFCURSOR
) IS BEGIN 

    OPEN HELPINFO FOR 
		SELECT
			ID as "id" ,
			Question as "question",
			Answer as "answer",
			System_ID as "systemId",
			Category as "category",
			Usable as "usable",
			Useless as "useless",
			CREATOR_ID as "creatorId",
			CREATED as "created",
			CREATOR as "creator",
			MODIFIER_ID as "modifierId",
			MODIFIER as "modifier",
			MODIFIED as "modified"
		FROM
			POM_FAQ;
END P_POM_MOBILE_HELP_CENTER;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MOBILE_HELP_MESSAGE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_MOBILE_HELP_MESSAGE" (
    FAQID POM_FAQ.ID%TYPE,
    HELPINFO  OUT SYS_REFCURSOR
) IS BEGIN 

    OPEN HELPINFO FOR 
		SELECT
			ID as "id" ,
			Question as "question",
			Answer as "answer",
			System_ID as "systemId",
			Category as "category",
			Usable as "usable",
			Useless as "useless",
			CREATOR_ID as "creatorId",
			CREATED as "created",
			CREATOR as "creator",
			MODIFIER_ID as "modifierId",
			MODIFIER as "modifier",
			MODIFIED as "modified"
		FROM
			POM_FAQ
        WHERE
            ID = FAQID;
END P_POM_MOBILE_HELP_MESSAGE;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MOBILE_KEY_NODE_RATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_MOBILE_KEY_NODE_RATE" 
(
      ORGID          IN VARCHAR2 := '003200000000000000000000000000'
	 ,DATASCOPE      IN VARCHAR2
	 ,PLANTYPE       IN VARCHAR2
     ,LEVEL_RANK     IN  INT
	 ,COMPLETIONRATE OUT SYS_REFCURSOR
     ,USERID         IN  VARCHAR2
     ,STATIONID      IN  VARCHAR2
     ,DEPTID         IN  VARCHAR2
     ,COMPANYID      IN  VARCHAR2
     ,BIZCODE        IN  VARCHAR2
     ,AUTHORGS       out clob
) AS
		--移动端关键节点计划监控-关键节点完成率查询
		--作者：鲜晓勇
		--日期：2020/03/20
		--查询2级单位SELECT * from  SYS_BUSINESS_UNIT A WHERE  A.COMPANY_TYPE='5' AND  PARENT_ID='003200000000000000000000000000'
    v_sql              CLOB;
    v_spid             VARCHAR2(200);---数据验证spid
    v_viewName         VARCHAR2(50);
    v_levelSql         CLOB;
    v_whereSql         CLOB:='where 1=1 ';
    v_unionSql         CLOB :=' AND 1=1 ';
    v_exectSql          CLOB:='';
    v_parentSql        CLOB :='''' || ORGID ||''' AS "parentId"';
BEGIN

        IF DATASCOPE='thisMonth' THEN
            IF PLANTYPE='关键节点计划'THEN
                 v_viewName:='V_POM_KEYNODE_M_STATISTICS';
            ELSE 
                 v_viewName:='V_POM_MAIN_PLAN_M_STATISTICS';
            END IF;
        ELSIF DATASCOPE='thisQuarter'THEN
            IF PLANTYPE='关键节点计划'THEN
                v_viewName:='V_POM_KEY_NODE_Q_STATISTICS';
            ELSE 
                v_viewName:='V_POM_MAIN_PLAN_Q_STATISTICS';
            END IF;
        ELSIF DATASCOPE='thisYear' THEN
            IF PLANTYPE='关键节点计划'THEN
                v_viewName:='V_POM_KEY_NODE_Y_STATISTICS';
            ELSE
                v_viewName:='V_POM_MAIN_PLAN_Y_STATISTICS';
            END IF;
        END IF;
        IF(LEVEL_RANK=3)THEN 
        P_SYS_GET_PROJ_TREE_SPID(
            USERID => USERID,
            STATIONID => STATIONID,
            DEPTID => DEPTID,
            COMPANYID => COMPANYID,
            BIZCODE => BIZCODE,
            AUTH_SPID => v_spid
          );
          --AUTHORGS:= 
          SELECT WM_CONCAT(
              TO_CHAR(   
                     t.org_id  ) 

                ) into AUTHORGS  FROM tmp_proj_tree t  
          WHERE t.ID=''||v_spid||''  --and t.org_id=''||orgid||''
          START WITH t.org_id=''||orgid||'' 
                        CONNECT BY PRIOR t.org_id=t.PARENT_ID;


            v_parentsql:='
             CASE
												WHEN ID = ''003200000000000000000000000000'' THEN
												 NULL
                                                WHEN ID='''||ORGID||'''
                                                THEN A.PARENT_ID
												ELSE
												 '''||ORGID||'''
										END AS "parentId"
            ';
            v_whereSql:='  AND 1=1 ';
            v_levelSql:='	FROM   '||v_viewName||' A
                        START WITH A.ID='''||ORGID||''' 
                        CONNECT BY PRIOR A.ID=A.PARENT_ID ';
        ELSE 
        --查询有权限的数据
         P_GET_COMPANY_TREE_PROJ_SPID(
            USERID => USERID,
            STATIONID => STATIONID,
            DEPTID => DEPTID,
            COMPANYID => COMPANYID,
            BIZCODE => BIZCODE,
            data_auth_spid => v_spid
          );
          --AUTHORGS
         SELECT DISTINCT
               WM_CONCAT(
              TO_CHAR(   
                     org_id  ) 
                )  into AUTHORGS
        FROM tmp_company_tree
        WHERE id = ''||v_spid||''  
            AND org_id IN (
               SELECT DISTINCT id
               FROM sys_business_unit
               START WITH id IN (
                   SELECT id
                   FROM (
                       SELECT unit_id AS id
                       FROM sys_project
                       UNION
                       SELECT subordinate_company_id AS id
                       FROM cdb_feasible_project_config
                   ) ds
               ) CONNECT BY PRIOR parent_id = id
            );
            v_whereSql:='WHERE  PARENT_ID = ''' || ORGID || '''';
            v_levelSql:='FROM   '||v_viewName||' A ';
            v_unionSql:='UNION 
                        SELECT
                                     A.CTYPE  AS   "ctype",
                                     A. LEVEL_RANK AS "levelRank",
                                     NVL(case when A.CTYPE=''TYPE_PROJLAST'' THEN A.STAGEID END,A.PARENT_ID) AS "clickOperationTypeContent",
                                      CASE
												WHEN  A.CTYPE = ''TYPE_PROJLAST'' THEN
												 ''2''
                                                WHEN  '''||ORGID||'''=''003200000000000000000000000000''
                                                THEN ''0''
												ELSE
												 ''1''
										END AS "clickOperationType" ,
                                    ISFINISHTOTAL AS "completedTotal",--已完成
                                    NODESUM AS "shouldComplete",--应完成
                                    NVL(NVL(CASE WHEN A.CTYPE=''TYPE_PROJLAST'' THEN A.STAGEID END,A.ID), '''||ORGID||''') AS "orgId",
									 A.ORG_NAME AS "orgName",
									 A.FINLISHRATE AS "completionRate",
									 CASE
												WHEN ID = ''003200000000000000000000000000'' THEN
												 NULL
												ELSE
												 PARENT_ID
										END AS "parentId", ''ThisMoth'' AS "dataScope"
						'||v_levelSql||'
						WHERE  ID = ''' || ORGID || ''' AND
									 NODESUM > 0';
        END IF;
        v_sql:='SELECT 
                                    A.CTYPE  AS   "ctype",
                                    A. LEVEL_RANK AS "levelRank",
                                     NVL(case when A.CTYPE=''TYPE_PROJLAST'' THEN A.STAGEID END,A.PARENT_ID) AS "clickOperationTypeContent",
                                     CASE
												WHEN  A.CTYPE = ''TYPE_PROJLAST'' THEN
												 ''2''
												ELSE
												 ''1''
										END AS "clickOperationType",
                                     ISFINISHTOTAL AS "completedTotal",--已完成
                                     NODESUM AS "shouldComplete",--应完成
									 --右上角显示排序
									  NVL(NVL(CASE WHEN A.CTYPE=''TYPE_PROJLAST'' THEN A.STAGEID END,A.ID), '''||ORGID||''') AS "orgId",
									 --ID
									 A.ORG_NAME AS "orgName",
									 --显示名称
									 A.FINLISHRATE AS "completionRate",
									 --完成率
									 '||v_parentSql||'
									 --父级ID
									 , ''ThisMoth'' AS "dataScope" --范围
						--A表项目计划主表计划类别通过TYPE判断
						'||v_levelSql||'
                        '||v_whereSql||'
                         AND
									 NODESUM > 0 
                        '||v_unionSql||'
                         ';
                        -- v_sql:=v_sql||' order by "completionRate"  desc';

                      IF LEVEL_RANK=3 THEN 
                      v_exectSql:='select   LPAD(rownum-1,2,''0'') as "rightLable",t.* from ('||v_sql||') t  where t."ctype"!=''TYPE_PROJTOP'' START WITH t."orgId"='''||ORGID||''' 
                        CONNECT BY PRIOR t."orgId"=t."parentId" order SIBLINGS by t."completionRate" desc';
                      ELSE
                      v_exectSql:='select LPAD(rownum-1,2,''0'') as "rightLable",t.* from ('||v_sql||') t  START WITH t."orgId"='''||ORGID||''' 
                        CONNECT BY PRIOR t."orgId"=t."parentId" order SIBLINGS by t."completionRate" desc';
                      END IF;
                            dbms_output.put_line(v_exectSql);
                                     OPEN COMPLETIONRATE FOR v_exectSql;
END P_POM_MOBILE_KEY_NODE_RATE;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_MONTHLY_ASSESSMENT_DTL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_MONTHLY_ASSESSMENT_DTL" ( year IN VARCHAR2, --年
		month IN VARCHAR2, --月
		companyid IN VARCHAR2, --当前用户公司id
		plantype in  INT ,--计划类型30 关键节点计划、40主项计划
		baseInfo OUT SYS_REFCURSOR, --基本信息
		detailInfo OUT SYS_REFCURSOR --明细信息
	) AS --公司月度考核排行详情
--作者：叶丁荣
--日期：2019/12/05
BEGIN
		OPEN baseInfo FOR SELECT
		'华南区域公司' AS "checkObject",--考核对象
		'2019-9-25 23:59:59' AS "sataGenerationTime",--数据生成日期
		'2019-8-26' AS "assessmentStartDate",--考核开始日期
		'2019-09-25' AS "assessmentEndDate",--考核结束日期
		'80%' AS "percentageComplete",--完成率(P=N/N*100)
		5 AS "assessmentTasksCount",--考核任务数量(M)
		4 AS "missionsCompleted",--已完成任务(N)
		77.69 AS "assessmentScore",--考核得分S=(B/A)*100
		520 AS "assessmentStandardNodeScore",--∑考核期内节点标准分(A)
		404 AS "assessmentActualNodeScore"--∑考核期内节点实际得分(B)
	FROM
		dual;
	
OPEN detailInfo FOR SELECT
	'red' AS "alertStatus",--预警状态
	'未完成' "completionStatus",--完成状态
	'首开楼栋总包单位定标0' AS "taskName",--任务名称
	'项目5_一期关键节点计划' AS "planName",--计划名称
	'华南公司' AS "area",--区域
	'广佛事业部' AS "businessDivision",--事业部
	'项目5_一期' AS "project", --项目
	'成本合约部' AS "department",--主责部门
	'一级' AS "tasnkLevel",--任务级别
	'2020-01-01' AS "planEndDate",--计划完成日期
	'2020-01-15' AS "FactEndDate",--实际完成日期
	'2020-01-15' AS "auditCompletionDate",--核完成日期
	15 AS "standardScore",--标准分值
	'100%' AS "scoringPercentage",--得分比例
	15 AS "actualScore" --实际得分
	
	FROM
		dual UNION ALL
	SELECT
		'green' AS "alertStatus",--预警状态
		'已完成' AS "completionStatus",--完成状态
		'首开楼栋总包单位定标1' AS "taskName",--任务名称
		'项目5_一期关键节点计划' AS "planName",--计划名称
		'华南公司' AS "area",--区域
		'广佛事业部' AS "businessDivision",--事业部
		'项目5_一期' AS "project", --项目
		'成本合约部' AS "department",--主责部门
		'一级' AS "tasnkLevel",--任务级别
		'2020-01-01' AS "planEndDate",--计划完成日期
		'2020-01-15' AS "FactEndDate",--实际完成日期
		'2020-01-15' AS "auditCompletionDate",--核完成日期
		15 AS "standardScore",--标准分值
		'100%' AS "scoringPercentage",--得分比例
		15 AS "actualScore" --实际得分
		
	FROM
		dual UNION ALL
	SELECT
		'green' AS "alertStatus",--预警状态
		'已完成' AS "completionStatus",--完成状态
		'首开楼栋总包单位定标2' AS "taskName",--任务名称
		'项目5_一期关键节点计划' AS "planName",--计划名称
		'华南公司' AS "area",--区域
		'广佛事业部' AS "businessDivision",--事业部
		'项目5_一期' AS "project", --项目
		'成本合约部' AS "department",--主责部门
		'一级' AS "tasnkLevel",--任务级别
		'2020-01-01' AS "planEndDate",--计划完成日期
		'2020-01-15' AS "FactEndDate",--实际完成日期
		'2020-01-15' AS "auditCompletionDate",--核完成日期
		15 AS "standardScore",--标准分值
		'100%' AS "scoringPercentage",--得分比例
		15 AS "actualScore" --实际得分
		
	FROM
		dual UNION ALL
	SELECT
		'green' AS "alertStatus",--预警状态
		'已完成' AS "completionStatus",--完成状态
		'首开楼栋总包单位定标3' AS "taskName",--任务名称
		'项目5_一期关键节点计划' AS "planName",--计划名称
		'华南公司' AS "area",--区域
		'广佛事业部' AS "businessDivision",--事业部
		'项目5_一期' AS "project" ,--项目
		'成本合约部' AS "department",--主责部门
		'一级' AS "tasnkLevel",--任务级别
		'2020-01-01' AS "planEndDate",--计划完成日期
		'2020-01-15' AS "FactEndDate",--实际完成日期
		'2020-01-15' AS "auditCompletionDate",--核完成日期
		15 AS "standardScore",--标准分值
		'100%' AS "scoringPercentage",--得分比例
		15 AS "actualScore" --实际得分
		
	FROM
		dual UNION ALL
	SELECT
		'green' AS "alertStatus",--预警状态
		'已完成' AS "completionStatus",--完成状态
		'首开楼栋总包单位定标4' AS "taskName",--任务名称
		'项目5_一期关键节点计划' AS "planName",--计划名称
		'华南公司' AS "area",--区域
		'广佛事业部' AS "businessDivision",--事业部
		'项目5_一期' AS "project", --项目
		'成本合约部' AS "department",--主责部门
		'一级' AS "tasnkLevel",--任务级别
		'2020-01-01' AS "planEndDate",--计划完成日期
		'2020-01-15' AS "FactEndDate",--实际完成日期
		'2020-01-15' AS "auditCompletionDate",--核完成日期
		15 AS "standardScore",--标准分值
		'100%' AS "scoringPercentage",--得分比例
		15 AS "actualScore" --实际得分
		
	FROM
		dual;
	

END p_pom_monthly_assessment_dtl;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MSG_LIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_MSG_LIST" ( msgType IN VARCHAR2,
systemId IN VARCHAR2,
isRead IN NUMBER, 
msgList OUT SYS_REFCURSOR ) AS 
--?????????б?
--??????????
--?????2019/12/12
BEGIN
                --CASE WHEN (sms.SMS_CONTENT IS NULL) THEN
					--wechat.TITLE
				--WHEN (sms.SMS_CONTENT IS NOT NULL) THEN
					--sms.SMS_CONTENT END msg_title,
 		IF (isRead=1) THEN
			OPEN msgList FOR SELECT
			 	biz.ID AS  id,
				wechat.TITLE AS msg_title,
				CASE WHEN (sms.SMS_CONTENT IS NULL) THEN
					wechat.JUMP_LINK_URL
				WHEN (sms.SMS_CONTENT IS NOT NULL) THEN
					NULL END jump_link_url,	
				biz.CREATED_TIME AS msg_push_time,
				'true' AS is_read
			FROM
				SYS_MSG_RECORD_BIZ biz
				LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
				LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
			WHERE
				biz.BIZ_MSG_CATEGORY = ''||msgType||''
				AND biz.SYSTEM_ID=''||systemId||''
				AND biz.ID IN (SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD );

		ELSE 
                --CASE WHEN (sms.SMS_CONTENT IS NULL) THEN
					--wechat.TITLE
				--WHEN (sms.SMS_CONTENT IS NOT NULL) THEN
					--sms.SMS_CONTENT END msg_title,
 			OPEN msgList FOR SELECT
			 	biz.ID AS  id,
				wechat.TITLE AS msg_title,
				CASE WHEN (sms.SMS_CONTENT IS NULL) THEN
					wechat.JUMP_LINK_URL
				WHEN (sms.SMS_CONTENT IS NOT NULL) THEN
					NULL END jump_link_url,	
				biz.CREATED_TIME AS msg_push_time,
				CASE WHEN (biz.ID IN (SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD )) THEN
				'true'
				WHEN (biz.ID NOT IN (SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD )) THEN
					'false' END is_read
			FROM
				SYS_MSG_RECORD_BIZ biz
				LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
				LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
			WHERE
				biz.BIZ_MSG_CATEGORY = ''||msgType||''
				AND biz.SYSTEM_ID=''||systemId||'';

		END IF;



END p_pom_msg_list;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MSG_LIST_ADJUSTMENT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_MSG_LIST_ADJUSTMENT" ( msgType IN VARCHAR2,
systemId IN VARCHAR2,
userId IN VARCHAR2,
isRead IN NUMBER, 
msgList OUT SYS_REFCURSOR ) AS 
 v_sys_code VARCHAR2 (50);
 v_sql CLOB;
 v_isIn varchar2 (100);
 v_get_code_sql VARCHAR2 (2000);
BEGIN
      v_get_code_sql := 'select user_code from sys_user where id=:sys_code';

      EXECUTE IMMEDIATE v_get_code_sql INTO v_sys_code  using userId;


 		IF (isRead=1) THEN
			v_isIn := ' and 1=1';
		ELSE 
            v_isIn := ' and biz.id not in (SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD )';
		END IF;

        v_sql := '
        select biz.ID AS  id,
            nvl(wechat.TITLE,biz.biz_source_category) AS msg_title,
            CASE WHEN (sms.SMS_CONTENT IS NULL) THEN
                wechat.JUMP_LINK_URL
            WHEN (sms.SMS_CONTENT IS NOT NULL) THEN
                NULL END jump_link_url,	
            biz.CREATED_TIME AS msg_push_time,
            to_char((biz.CREATED_TIME), ''yyyy-MM-dd hh24:mi:ss'') AS msg_push_time_str,
            CASE WHEN (biz.ID IN (SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD)) THEN
                ''true''
            WHEN (biz.ID NOT IN (SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD)) THEN
                ''false''
            end is_read
            from SYS_MSG_RECORD_BIZ biz  
            left join sys_msg_read_record rr on biz.id = rr.msg_record_biz_guid 
            left join SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
            left join SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
            where  biz_msg_category = '''||msgType||'''
            and biz.system_id ='''||systemId||'''
            and (sms.receiver_id = '''||v_sys_code||''' or wechat.receiver_id = '''||v_sys_code||''')'||v_isIn||' order by msg_push_time desc ';

                     dbms_output.put_line(v_sql);
        OPEN msgList FOR v_sql;

END P_POM_MSG_LIST_ADJUSTMENT;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MSGTYPE_LIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_MSGTYPE_LIST" ( systemId IN VARCHAR2, msgTypeList OUT SYS_REFCURSOR, unreadCount OUT VARCHAR2 ) AS 
--移动端消息类型列表
--作者：叶丁荣
--日期：2019/12/12
	v_COUNT NUMBER;
BEGIN
		OPEN msgTypeList FOR SELECT
		'57b55283-ce3a-4fc4-a70d-8240e66a1254' AS id,
		'提醒消息' AS msg_type,
		(
		SELECT
			* 
		FROM
			(
			SELECT
				wechat.TITLE 
			FROM
				SYS_MSG_RECORD_BIZ biz
				LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
				LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
			WHERE
				biz.BIZ_MSG_CATEGORY = '提醒消息' 
			AND biz.SYSTEM_ID=''||systemId||''
			ORDER BY
				biz.CREATED_TIME DESC 
			) 
		WHERE
			ROWNUM = 1 
		) AS frist_msg,
		(
		SELECT
			COUNT( * ) 
		FROM
			SYS_MSG_RECORD_BIZ biz
			LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
			LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
		WHERE
			biz.BIZ_MSG_CATEGORY = '提醒消息' 
			AND biz.ID NOT IN ( SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD ) 
			AND biz.SYSTEM_ID=''||systemId||''
		) AS msg_type_unreadcount 
	FROM
		dual UNION ALL
	SELECT
		'58055283-ce3a-4fc4-a70d-8240e66a1254' AS id,
		'预警消息' AS msg_type,
		(
		SELECT
			* 
		FROM
			(
			SELECT
				wechat.TITLE 
			FROM
				SYS_MSG_RECORD_BIZ biz
				LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
				LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
			WHERE
				biz.BIZ_MSG_CATEGORY = '预警消息' 
				AND biz.SYSTEM_ID=''||systemId||''
			ORDER BY
				biz.CREATED_TIME DESC 
			) 
		WHERE
			ROWNUM = 1 
		) AS frist_msg,
		(
		SELECT
			COUNT( * ) 
		FROM
			SYS_MSG_RECORD_BIZ biz
			LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
			LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
		WHERE
			biz.BIZ_MSG_CATEGORY = '预警消息' 
			AND biz.ID NOT IN ( SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD ) 
			AND biz.SYSTEM_ID=''||systemId||''
		) AS msg_type_unreadcount 
	FROM
		dual UNION ALL
	SELECT
		'58055283-ce3a-4fc4-a70d-8240e66a1254' AS id,
		'催办消息' AS msg_type,
		(
		SELECT
			* 
		FROM
			(
			SELECT
				wechat.TITLE 
			FROM
				SYS_MSG_RECORD_BIZ biz
				LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
				LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
			WHERE
				biz.BIZ_MSG_CATEGORY = '催办消息' 
				AND biz.SYSTEM_ID=''||systemId||''
			ORDER BY
				biz.CREATED_TIME DESC 
			) 
		WHERE
			ROWNUM = 1 
		) AS frist_msg,
		(
		SELECT
			COUNT( * ) 
		FROM
			SYS_MSG_RECORD_BIZ biz
			LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
			LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
		WHERE
			biz.BIZ_MSG_CATEGORY = '催办消息' 
			AND biz.ID NOT IN ( SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD ) 
			AND biz.SYSTEM_ID=''||systemId||''
		) AS msg_type_unreadcount 
	FROM
		dual;


		SELECT
	(
	SELECT
		COUNT( * ) 
	FROM
		SYS_MSG_RECORD_BIZ biz
		LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
		LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
	WHERE
		( biz.BIZ_MSG_CATEGORY = '提醒消息' OR biz.BIZ_MSG_CATEGORY = '预警消息' OR biz.BIZ_MSG_CATEGORY = '催办消息' ) 
		AND biz.ID NOT IN ( SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD ) -- 			AND biz.SYSTEM_ID=''||systemId||''

	)  INTO v_COUNT 
FROM
	dual;



	unreadCount := v_COUNT;

END p_pom_msgType_list;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MY_DUTY_NODE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_MY_DUTY_NODE" 
(
	USERID               IN VARCHAR2 --当前用户ID
 ,STATISTICALBEGINDATA IN DATE -- 开始日期
 ,STATISTICALENDDATA   IN DATE --结束日期
 ,CURRENTDATE          IN DATE --当前日期
 ,CALENDARSCOPETYPE    IN NVARCHAR2 -- 查看范围（本月到期OR本周到期），传入的值为，currentWeek：本周到期、currentMonth：本月到期
 ,ISONLYLOOKME         IN VARCHAR2 --是否只看本人
 ,NODEINFO             OUT SYS_REFCURSOR --返回的任务信息
) AS
	--计划首页-我的任务节点
	--作者：陈丽
	--日期：2019/11/15
BEGIN
	--/pom/mission-center-feedback/my-responsible-task?id=xxx&nodeSourcePlanType=XXX&feedbackNodeOriginalId=XXX&feedbackNodeId=XXX
	IF CALENDARSCOPETYPE = 'currentWeek' THEN
		OPEN NODEINFO FOR
			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
						 B.NODE_LEVEL AS NODELEVEL,
						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
							CHR(38) || 'nodeSourcePlanType=' || CASE
								WHEN A.PLAN_TYPE = '关键节点计划' THEN
								 '0'
								WHEN A.PLAN_TYPE = '项目主项计划' THEN
								 '1'
								WHEN A.PLAN_TYPE = '专项计划' THEN
								 '2'
							END || CHR(38) || 'feedbackNodeOriginalId=' ||
							B.ORIGINAL_NODE_ID || CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
						 B.PLAN_END_DATE AS PLANENDDATE
			FROM   POM_PROJ_PLAN A
			INNER  JOIN POM_PROJ_PLAN_NODE B
			ON     A.ID = B.PROJ_PLAN_ID
			LEFT   JOIN POM_NODE_CHARGE_PERSON C
			ON     B.ID = C.NODE_ID
			WHERE  C.CHARGE_PERSON_ID = ''|| USERID||''
						  AND TRUNC(CURRENTDATE, 'd') = TRUNC(B.PLAN_END_DATE, 'D')
			UNION ALL
			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
						 '' AS NODELEVEL,
						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
							CHR(38) || 'nodeSourcePlanType=2' || CHR(38) ||
							'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID || CHR(38) ||
							'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
						 B.PLAN_END_DATE AS PLANENDDATE
			FROM   POM_SPECIAL_PLAN A
			INNER  JOIN POM_SPECIAL_PLAN_NODE B
			ON     A.ID = B.PLAN_ID
			LEFT   JOIN POM_NODE_CHARGE_PERSON C
			ON     B.ID = C.NODE_ID
			WHERE  C.CHARGE_PERSON_ID = ''|| USERID||''  AND
						 TRUNC(CURRENTDATE, 'd') = TRUNC(B.PLAN_END_DATE, 'D')
			UNION ALL
			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
						 B.NODE_TYPE AS NODELEVEL,
						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
							CHR(38) || 'nodeSourcePlanType=3' || CHR(38) ||
							'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID || CHR(38) ||
							'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
						 B.PLAN_END_DATE AS PLANENDDATE
			FROM   POM_DEPT_MONTHLY_PLAN A
			INNER  JOIN POM_DEPT_MONTHLY_PLAN_NODE B
			ON     A.ID = B.DEPT_MONTHLY_PLAN_ID
			LEFT   JOIN POM_NODE_CHARGE_PERSON C
			ON     B.ID = C.NODE_ID
			WHERE  B.SOURCE_PLAN_ID IS NULL AND
						 C.CHARGE_PERSON_ID = ''|| USERID||''  AND
						 TRUNC(CURRENTDATE, 'd') = TRUNC(B.PLAN_END_DATE, 'D');

	ELSIF CALENDARSCOPETYPE = 'currentMonth' THEN
		OPEN NODEINFO FOR
			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
						 B.NODE_LEVEL AS NODELEVEL,
						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
							CHR(38) || 'nodeSourcePlanType=' || CASE
								WHEN A.PLAN_TYPE = '关键节点计划' THEN
								 '0'
								WHEN A.PLAN_TYPE = '项目主项计划' THEN
								 '1'
								WHEN A.PLAN_TYPE = '专项计划' THEN
								 '2'
							END || CHR(38) || 'feedbackNodeOriginalId=' ||
							B.ORIGINAL_NODE_ID || CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
						 B.PLAN_END_DATE AS PLANENDDATE
			FROM   POM_PROJ_PLAN A
			INNER  JOIN POM_PROJ_PLAN_NODE B
			ON     A.ID = B.PROJ_PLAN_ID
			LEFT   JOIN POM_NODE_CHARGE_PERSON C
			ON     B.ID = C.NODE_ID
			WHERE  C.CHARGE_PERSON_ID = ''|| USERID||'' AND
						 TRUNC(CURRENTDATE, 'mm') = TRUNC(B.PLAN_END_DATE, 'mm')
			UNION ALL
			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
						 '' AS NODELEVEL,
						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
							CHR(38) || 'nodeSourcePlanType=2' || CHR(38) ||
							'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID || CHR(38) ||
							'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
						 B.PLAN_END_DATE AS PLANENDDATE
			FROM   POM_SPECIAL_PLAN A
			INNER  JOIN POM_SPECIAL_PLAN_NODE B
			ON     A.ID = B.PLAN_ID
			LEFT   JOIN POM_NODE_CHARGE_PERSON C
			ON     B.ID = C.NODE_ID
			WHERE  C.CHARGE_PERSON_ID = ''|| USERID||''  AND
						 TRUNC(CURRENTDATE, 'mm') = TRUNC(B.PLAN_END_DATE, 'mm')
			UNION ALL
			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
						 B.NODE_TYPE AS NODELEVEL,
						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
							CHR(38) || 'nodeSourcePlanType=3' || CHR(38) ||
							'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID || CHR(38) ||
							'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
						 B.PLAN_END_DATE AS PLANENDDATE
			FROM   POM_DEPT_MONTHLY_PLAN A
			INNER  JOIN POM_DEPT_MONTHLY_PLAN_NODE B
			ON     A.ID = B.DEPT_MONTHLY_PLAN_ID
			LEFT   JOIN POM_NODE_CHARGE_PERSON C
			ON     B.ID = C.NODE_ID
			WHERE  B.SOURCE_PLAN_ID IS NULL AND
						 C.CHARGE_PERSON_ID = ''|| USERID||''  AND
						 TRUNC(CURRENTDATE, 'mm') = TRUNC(B.PLAN_END_DATE, 'mm');

	ELSE  --在没有勾选本周/本月时间范围的时候默认全部查询By Yedr//2020-01-07
		OPEN NODEINFO FOR
			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
						 B.NODE_LEVEL AS NODELEVEL,
						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
							CHR(38) || 'nodeSourcePlanType=' || CASE
								WHEN A.PLAN_TYPE = '关键节点计划' THEN
								 '0'
								WHEN A.PLAN_TYPE = '项目主项计划' THEN
								 '1'
								WHEN A.PLAN_TYPE = '专项计划' THEN
								 '2'
							END || CHR(38) || 'feedbackNodeOriginalId=' ||
							B.ORIGINAL_NODE_ID || CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
						 B.PLAN_END_DATE AS PLANENDDATE
			FROM   POM_PROJ_PLAN A
			INNER  JOIN POM_PROJ_PLAN_NODE B
			ON     A.ID = B.PROJ_PLAN_ID
			LEFT   JOIN POM_NODE_CHARGE_PERSON C
			ON     B.ID = C.NODE_ID
			WHERE  C.CHARGE_PERSON_ID = ''|| USERID||''
-- 						  AND TRUNC(CURRENTDATE, 'd') = TRUNC(B.PLAN_END_DATE, 'D')
			UNION ALL
			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
						 '' AS NODELEVEL,
						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
							CHR(38) || 'nodeSourcePlanType=2' || CHR(38) ||
							'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID || CHR(38) ||
							'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
						 B.PLAN_END_DATE AS PLANENDDATE
			FROM   POM_SPECIAL_PLAN A
			INNER  JOIN POM_SPECIAL_PLAN_NODE B
			ON     A.ID = B.PLAN_ID
			LEFT   JOIN POM_NODE_CHARGE_PERSON C
			ON     B.ID = C.NODE_ID
			WHERE  C.CHARGE_PERSON_ID = ''|| USERID||''  
-- 						AND TRUNC(CURRENTDATE, 'd') = TRUNC(B.PLAN_END_DATE, 'D')
			UNION ALL
			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
						 B.NODE_TYPE AS NODELEVEL,
						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
							CHR(38) || 'nodeSourcePlanType=3' || CHR(38) ||
							'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID || CHR(38) ||
							'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
						 B.PLAN_END_DATE AS PLANENDDATE
			FROM   POM_DEPT_MONTHLY_PLAN A
			INNER  JOIN POM_DEPT_MONTHLY_PLAN_NODE B
			ON     A.ID = B.DEPT_MONTHLY_PLAN_ID
			LEFT   JOIN POM_NODE_CHARGE_PERSON C
			ON     B.ID = C.NODE_ID
			WHERE  B.SOURCE_PLAN_ID IS NULL AND
						 C.CHARGE_PERSON_ID = ''|| USERID||''  ;
-- 						 AND TRUNC(CURRENTDATE, 'd') = TRUNC(B.PLAN_END_DATE, 'D');
	END IF;

END P_POM_MY_DUTY_NODE;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MY_MESSAGE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_MY_MESSAGE" 
(
    USERID      IN VARCHAR2
   ,MESSAGETYPE IN VARCHAR2
   ,TOTAL       OUT INT
   , --消息总数
    MESSAGEINFO OUT SYS_REFCURSOR
) AS
    --计划首页-我的消息
    --作者：陈丽
    --日期：2019/11/15
BEGIN
    TOTAL := -1;
    OPEN MESSAGEINFO FOR
         SELECT  *  FROM (  SELECT
           plan.PLAN_NAME AS "messageContent",
           node.NODE_LEVEL AS "nodeLevel",
           msg.ACTUAL_CREATED AS "messageArrivalTime", 
           msg.pc_url AS "openUrl",
           CASE
            WHEN node.PLAN_END_DATE - SYSDATE < 0 THEN
                '超期'
            WHEN node.PLAN_END_DATE - SYSDATE > 0 THEN
                '正常'
           END AS  "nodeState",
           node.PLAN_END_DATE AS "planEndDate"
           FROM          
           POM_PROJ_PLAN_NODE node
           LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID 
           LEFT JOIN SYS_MESSAGE_CENTER msg ON msg.TASK_ID = node.ID
           LEFT JOIN SYS_USER u ON msg.owner_name=u.user_code where msg.TASK_ID = node.ID and  msg.TASK_STATE = 0 AND u.ID=''||USERID||''
           AND msg.biz_msg_category=''||MESSAGETYPE||'' ORDER BY "messageArrivalTime" DESC) WHERE ROWNUM <= 20 ;
END P_POM_MY_MESSAGE;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MY_NODE_CALENDAR
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_MY_NODE_CALENDAR" 
(
		USERID               IN VARCHAR2 --传入用户ID
	 ,STATISTICALBEGINDATA IN DATE --日历中每月开始日期
	 ,STATISTICALENDDATA   IN DATE --日历中每月结束日期
	 ,CURRENTDATE          IN DATE --日历中当前选中日期
	 ,CALENDARSCOPETYPE    IN VARCHAR2 --查看范围（本月到期OR本周到期），传入的值为，0：本周到期、1：本月到期
	 ,ISONLYLOOKME         IN VARCHAR2 --是否只看自己
	 ,STATISTICALINFO      OUT SYS_REFCURSOR --返回值
) AS
		--计划首页-首页日历
		--作者：陈丽
    --日期：2019/11/15
BEGIN
    /*    OPEN STATISTICALINFO FOR
    SELECT PLAN_END_DATE AS "date", COUNT(PLAN_END_DATE) "total"
    FROM   POM_PROJ_PLAN_NODE
    GROUP  BY PLAN_END_DATE;*/
    OPEN STATISTICALINFO FOR
        SELECT to_char(PLAN_END_DATE,'yyyy-mm-dd'), COUNT(NODE_NAME)
        FROM   (SELECT A.PLAN_TYPE, B.NODE_NAME, B.PLAN_END_DATE
                 FROM   POM_PROJ_PLAN A
                 INNER  JOIN POM_PROJ_PLAN_NODE B
                 ON     A.ID = B.PROJ_PLAN_ID
                 INNER  JOIN POM_NODE_CHARGE_PERSON C
                 ON     B.ID = C.NODE_ID
                 WHERE  B.ACTUAL_END_DATE IS NULL AND
                        C.CHARGE_PERSON_ID = USERID AND
                        B.PLAN_END_DATE BETWEEN STATISTICALBEGINDATA AND
                        STATISTICALENDDATA
                 UNION ALL
                 SELECT '专项计划', B.NODE_NAME, B.PLAN_END_DATE
                 FROM   POM_SPECIAL_PLAN A
                 INNER  JOIN POM_SPECIAL_PLAN_NODE B
                 ON     A.ID = B.PLAN_ID
                 INNER  JOIN POM_NODE_CHARGE_PERSON C
                 ON     B.ID = C.NODE_ID
                 WHERE  B.ACTUAL_END_DATE IS NULL AND
                        C.CHARGE_PERSON_ID = USERID AND
                        B.PLAN_END_DATE BETWEEN STATISTICALBEGINDATA AND
                        STATISTICALENDDATA
                 UNION ALL
                 SELECT '部门月度计划', B.NODE_NAME, B.PLAN_END_DATE
                 FROM   POM_DEPT_MONTHLY_PLAN A
                 INNER  JOIN POM_DEPT_MONTHLY_PLAN_NODE B
                 ON     A.ID = B.DEPT_MONTHLY_PLAN_ID
                 INNER  JOIN POM_NODE_CHARGE_PERSON C
                 ON     B.ID = C.NODE_ID
                 WHERE  B.ACTUAL_END_DATE IS NULL AND
                        B.SOURCE_PLAN_ID IS NULL AND
                        C.CHARGE_PERSON_ID = USERID AND
                        B.PLAN_END_DATE BETWEEN STATISTICALBEGINDATA AND
                        STATISTICALENDDATA)
        GROUP  BY PLAN_END_DATE;

END P_POM_MY_NODE_CALENDAR;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_MY_WACTH_NODE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_MY_WACTH_NODE" 
(
		USERID               IN NVARCHAR2 --当前用户ID
	 ,STATISTICALBEGINDATA IN DATE --日历中选中日期对应本月开始日期
	 ,STATISTICALENDDATA   IN DATE --日历中选中日期对应本月结束日期
	 ,CURRENTDATE          IN DATE --日历中当前选择日期 
	 ,CALENDARSCOPETYPE    IN VARCHAR2 --查看范围，currentWeek：本周，currentMonth：本月
	 ,ISONLYLOOKME         IN VARCHAR2 --是否只查看我的，0：否，1：是
	 ,NODEINFO             OUT SYS_REFCURSOR --返回值
) AS
		--计划首页-关注的节点
		--作者：陈丽
		--日期：2019/11/15
		--调整存储过程为根据CALENDARSCOPETYPE（日期范围）判断查询数据。默认全部查询，前端勾选了日期范围在根据前端传递日期范围查询  By Yedr 2020-01-07
BEGIN
		/*OPEN NODEINFO FOR
    SELECT POM_PROJ_PLAN.PLAN_NAME AS "planName",
           POM_PROJ_PLAN_NODE.NODE_NAME AS "nodeName",
           POM_PROJ_PLAN_NODE.NODE_LEVEL AS "nodeLevel", '' AS "openUrl",
           PLAN_END_DATE "planEndDate", '正常' "nodeState"
    FROM   POM_PROJ_PLAN_NODE
    LEFT   JOIN POM_PROJ_PLAN
    ON     POM_PROJ_PLAN_NODE.PROJ_PLAN_ID = POM_PROJ_PLAN.ID;*/

--		IF ISONLYLOOKME = 1 THEN
--				RETURN;
--		ELSE
			IF CALENDARSCOPETYPE='currentWeek' THEN
				OPEN NODEINFO FOR
				--关键节点计划、项目主项计划
						SELECT C.PLAN_NAME AS "planName", B.NODE_NAME AS "nodeName",
									 B.NODE_LEVEL AS "nodeLevel",
									 '/pom/mission-center-feedback/my-responsible-task/view-task-information?planId=' || C.ID ||
									 CHR(38) || 'nodeSourcePlanType=' || CASE
											 WHEN C.PLAN_TYPE = '关键节点计划' THEN
												'0'
											 WHEN C.PLAN_TYPE = '项目主项计划' THEN
												'1'
											 WHEN C.PLAN_TYPE = '专项计划' THEN
												'2'
											 ELSE
												NULL
									 END || CHR(38) || 'feedbackNodeOriginalId=' ||
									 B.ORIGINAL_NODE_ID || CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS "openUrl",
									 B.PLAN_END_DATE AS "planEndDate",
									 CASE
											 WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN
												'正常'
											 WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN
												'已超期'
											 ELSE
												NULL
									 END AS "nodeState"
						FROM   SYS_BIZ_WATCH A
						INNER  JOIN POM_PROJ_PLAN_NODE B
						ON     A.BIZ_ID = B.ORIGINAL_NODE_ID
						INNER  JOIN POM_PROJ_PLAN C
						ON     B.PROJ_PLAN_ID = C.ID
						WHERE  A.WATCHER_ID =''|| USERID||''
                   AND c.APPROVAL_STATUS='已审核'
									 AND TRUNC(CURRENTDATE, 'd') = TRUNC(B.PLAN_END_DATE, 'D')
									 --AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')
						UNION ALL
						--专项计划
						SELECT C.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
									 '' AS NODELEVEL,
									 '/pom/mission-center-feedback/my-responsible-task/view-task-information?planId=' || C.ID ||
										CHR(38) || 'nodeSourcePlanType=' || '2' || CHR(38) ||
										'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID ||
										CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
									 B.PLAN_END_DATE AS PLANENDDATE,
									 CASE
												WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN
												 '正常'
												WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN
												 '已超期'
												ELSE
												 NULL
										END AS NODESTATE
						FROM   SYS_BIZ_WATCH A
						INNER  JOIN POM_SPECIAL_PLAN_NODE B
						ON     A.BIZ_ID = B.ORIGINAL_NODE_ID
						INNER  JOIN POM_SPECIAL_PLAN C
						ON     B.PLAN_ID = C.ID
						WHERE  A.WATCHER_ID = ''|| USERID||''
									 and c.APPROVAL_STATUS='已审核'
									 AND TRUNC(CURRENTDATE, 'd') = TRUNC(B.PLAN_END_DATE, 'D')
									-- AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')
						UNION ALL
						--部门月度计划            
						SELECT C.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
									 B.NODE_TYPE AS NODELEVEL,
									 '/pom/mission-center-feedback/my-responsible-task/view-task-information?planId=' || C.ID ||
										CHR(38) || 'nodeSourcePlanType=' || '3' || CHR(38) ||
										'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID ||
										CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
									 B.PLAN_END_DATE AS PLANENDDATE,
									 CASE
												WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN
												 '正常'
												WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN
												 '已超期'
												ELSE
												 NULL
										END AS NODESTATE
						FROM   SYS_BIZ_WATCH A
						INNER  JOIN POM_DEPT_MONTHLY_PLAN_NODE B
						ON     A.BIZ_ID =  B.ORIGINAL_NODE_ID
						INNER  JOIN POM_DEPT_MONTHLY_PLAN C
						ON     B.DEPT_MONTHLY_PLAN_ID = C.ID
						WHERE  A.WATCHER_ID = ''|| USERID||''
									 AND TRUNC(CURRENTDATE, 'd') = TRUNC(B.PLAN_END_DATE, 'D');
-- 									 AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')   ;

			ELSIF CALENDARSCOPETYPE='currentMonth' THEN
				OPEN NODEINFO FOR
				--关键节点计划、项目主项计划
						SELECT C.PLAN_NAME AS "planName", B.NODE_NAME AS "nodeName",
									 B.NODE_LEVEL AS "nodeLevel",
									 '/pom/mission-center-feedback/my-responsible-task/view-task-information?planId=' || C.ID ||
									 CHR(38) || 'nodeSourcePlanType=' || CASE
											 WHEN C.PLAN_TYPE = '关键节点计划' THEN
												'0'
											 WHEN C.PLAN_TYPE = '项目主项计划' THEN
												'1'
											 WHEN C.PLAN_TYPE = '专项计划' THEN
												'2'
											 ELSE
												NULL
									 END || CHR(38) || 'feedbackNodeOriginalId=' ||
									 B.ORIGINAL_NODE_ID || CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS "openUrl",
									 B.PLAN_END_DATE AS "planEndDate",
									 CASE
											 WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN
												'正常'
											 WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN
												'已超期'
											 ELSE
												NULL
									 END AS "nodeState"
						FROM   SYS_BIZ_WATCH A
						INNER  JOIN POM_PROJ_PLAN_NODE B
						ON     A.BIZ_ID = B.ORIGINAL_NODE_ID
						INNER  JOIN POM_PROJ_PLAN C
						ON     B.PROJ_PLAN_ID = C.ID
						WHERE  A.WATCHER_ID =''|| USERID||''
                   AND c.APPROVAL_STATUS='已审核'
									 AND TRUNC(CURRENTDATE, 'mm') = TRUNC(B.PLAN_END_DATE, 'mm')
									  --AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')
						UNION ALL
						--专项计划
						SELECT C.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
									 '' AS NODELEVEL,
									 '/pom/mission-center-feedback/my-responsible-task/view-task-information?planId=' || C.ID ||
										CHR(38) || 'nodeSourcePlanType=' || '2' || CHR(38) ||
										'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID ||
										CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
									 B.PLAN_END_DATE AS PLANENDDATE,
									 CASE
												WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN
												 '正常'
												WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN
												 '已超期'
												ELSE
												 NULL
										END AS NODESTATE
						FROM   SYS_BIZ_WATCH A
						INNER  JOIN POM_SPECIAL_PLAN_NODE B
						ON     A.BIZ_ID = B.ORIGINAL_NODE_ID
						INNER  JOIN POM_SPECIAL_PLAN C
						ON     B.PLAN_ID = C.ID
						WHERE  A.WATCHER_ID = ''|| USERID||''
									 AND c.APPROVAL_STATUS='已审核'
									 AND TRUNC(CURRENTDATE, 'mm') = TRUNC(B.PLAN_END_DATE, 'mm')
									  --AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')
						UNION ALL
						--部门月度计划            
						SELECT C.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
									 B.NODE_TYPE AS NODELEVEL,
									 '/pom/mission-center-feedback/my-responsible-task/view-task-information?planId=' || C.ID ||
										CHR(38) || 'nodeSourcePlanType=' || '3' || CHR(38) ||
										'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID ||
										CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
									 B.PLAN_END_DATE AS PLANENDDATE,
									 CASE
												WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN
												 '正常'
												WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN
												 '已超期'
												ELSE
												 NULL
										END AS NODESTATE
						FROM   SYS_BIZ_WATCH A
						INNER  JOIN POM_DEPT_MONTHLY_PLAN_NODE B
						ON     A.BIZ_ID =  B.ORIGINAL_NODE_ID
						INNER  JOIN POM_DEPT_MONTHLY_PLAN C
						ON     B.DEPT_MONTHLY_PLAN_ID = C.ID
						WHERE  A.WATCHER_ID = ''|| USERID||''
									 AND TRUNC(CURRENTDATE, 'mm') = TRUNC(B.PLAN_END_DATE, 'mm');
									-- AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')   ;
			ELSE
				OPEN NODEINFO FOR
				--关键节点计划、项目主项计划
						SELECT C.PLAN_NAME AS "planName", B.NODE_NAME AS "nodeName",
									 B.NODE_LEVEL AS "nodeLevel",
									 '/pom/mission-center-feedback/my-responsible-task/view-task-information?planId=' || C.ID ||
									 CHR(38) || 'nodeSourcePlanType=' || CASE
											 WHEN C.PLAN_TYPE = '关键节点计划' THEN
												'0'
											 WHEN C.PLAN_TYPE = '项目主项计划' THEN
												'1'
											 WHEN C.PLAN_TYPE = '专项计划' THEN
												'2'
											 ELSE
												NULL
									 END || CHR(38) || 'feedbackNodeOriginalId=' ||
									 B.ORIGINAL_NODE_ID || CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS "openUrl",
									 B.PLAN_END_DATE AS "planEndDate",
									 CASE
											 WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN
												'正常'
											 WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN
												'已超期'
											 ELSE
												NULL
									 END AS "nodeState"
						FROM   SYS_BIZ_WATCH A
						INNER  JOIN POM_PROJ_PLAN_NODE B
						ON     A.BIZ_ID = B.ORIGINAL_NODE_ID
						INNER  JOIN POM_PROJ_PLAN C
						ON     B.PROJ_PLAN_ID = C.ID
						WHERE  A.WATCHER_ID =''|| USERID||''
									 --AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')
                                    and c.APPROVAL_STATUS='已审核'
						UNION ALL
						--专项计划
						SELECT C.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
									 '' AS NODELEVEL,
									 '/pom/mission-center-feedback/my-responsible-task/view-task-information?planId=' || C.ID ||
										CHR(38) || 'nodeSourcePlanType=' || '2' || CHR(38) ||
										'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID ||
										CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
									 B.PLAN_END_DATE AS PLANENDDATE,
									 CASE
												WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN
												 '正常'
												WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN
												 '已超期'
												ELSE
												 NULL
										END AS NODESTATE
						FROM   SYS_BIZ_WATCH A
						INNER  JOIN POM_SPECIAL_PLAN_NODE B
						ON     A.BIZ_ID = B.ORIGINAL_NODE_ID
						INNER  JOIN POM_SPECIAL_PLAN C
						ON     B.PLAN_ID = C.ID
						WHERE  A.WATCHER_ID = ''|| USERID||''
									 --AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')
                                     and c.APPROVAL_STATUS='已审核'
						UNION ALL
						--部门月度计划            
						SELECT C.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
									 B.NODE_TYPE AS NODELEVEL,
									 '/pom/mission-center-feedback/my-responsible-task/view-task-information?planId=' || C.ID ||
										CHR(38) || 'nodeSourcePlanType=' || '3' || CHR(38) ||
										'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID ||
										CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
									 B.PLAN_END_DATE AS PLANENDDATE,
									 CASE
												WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN
												 '正常'
												WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN
												 '已超期'
												ELSE
												 NULL
										END AS NODESTATE
						FROM   SYS_BIZ_WATCH A
						INNER  JOIN POM_DEPT_MONTHLY_PLAN_NODE B
						ON     A.BIZ_ID =  B.ORIGINAL_NODE_ID
						INNER  JOIN POM_DEPT_MONTHLY_PLAN C
						ON     B.DEPT_MONTHLY_PLAN_ID = C.ID
						WHERE  A.WATCHER_ID = ''|| USERID||'';
									-- AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')   ;
			END IF;

--		END IF;
		/*/pom/mission-center-feedback/my-responsible-task/view-task-information;

		所需参数:{

		planId: String, //计划id
		nodeSourcePlanType: String, //计划类型
		feedbackNodeOriginalId: String, //任务原始id
		feedbackNodeId: String //任务id

		}*/
END P_POM_MY_WACTH_NODE;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_NODE_EXAMINATION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_NODE_EXAMINATION" 
(
		ORIGINALNODEID  IN VARCHAR2
	 ,EXAMINATIONINFO OUT SYS_REFCURSOR
) AS
		--查看反馈，考核信息查看列表
		--作者：陈丽
		--日期：2019/11/15
BEGIN
		OPEN EXAMINATIONINFO FOR
				SELECT NULL AS "projName",
							 --项目名称
							 A.NODE_NAME AS "nodeName",
							 --任务名称
							 A.NODE_LEVEL AS "nodeLevel",
							 --任务级别
							 A.DUTY_DEPT AS "dutyDepartment",
							 --主责部门
							 NULL AS "dutyPerson",
							 --主责人
							 NULL AS "planEndDate",
								--计划完成日期
							 NULL AS "actualEndDate",
								--时间完成日期
							 NULL AS "examinationScore",
								--考核得分
							 NULL AS "planStartDate",
								--计划开始日期
							 NULL AS "estimateEndDate",
								--预计完成日期
							 NULL AS "standardScore" ---，标准分值
				FROM   POM_NODE_EXAMINATION A
				WHERE a.ORIGINAL_NODE_ID = ORIGINALNODEID;

END P_POM_NODE_EXAMINATION;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_NODE_EXAMINATION_CREATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_NODE_EXAMINATION_CREATE" 
AS
--考核数据生成 1、根据设置的范围，创建考核范围数据。2、已经如表的本次考核范围数据，只更新修改时间
--作者：陈丽
--日期：2019/11/13
BEGIN
null;
END p_pom_node_examination_create;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_NODE_FEEDBACK_RESULTS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_NODE_FEEDBACK_RESULTS" (
    unitid         IN             VARCHAR2,--所属公司
    projectid      IN             VARCHAR2,--所属项目
    filename       IN             VARCHAR2,--文件名称
    nodename       IN             VARCHAR2,--计划节点
    filecreator    IN             VARCHAR2,---上传人
    begindate      IN             VARCHAR2,--范围开始时间
    beginend       IN             VARCHAR2,----范围结束日期
    userid         IN             VARCHAR2,--用户id(用户当前）
    stationid      IN             VARCHAR2,--岗位id(用户当前）
    departmentid   IN             VARCHAR2,--部门id(用户当前）
    companyid      IN             VARCHAR2,--公司id(用户所在公司)
    bizcode        IN             VARCHAR2,-- 权限编码
    pageindex      IN             INT,--页码
    pagesizes      IN             INT,--每页条数
    total          OUT            INT,--总数
    items          OUT            SYS_REFCURSOR--项
)
	--任务成功查询//鲜晓勇负责实现
	--作者：陈丽
	--日期：2019/12/08
 AS
    v_sql        CLOB;
    v_sql_exec   CLOB;
    v_where      VARCHAR2(500) := ' and 1=1 ';
    testmsg             NVARCHAR2(4000);
    v_spid      NVARCHAR2(4000);
    v_auth_sql         VARCHAR2(4000) :=' ';
    v_pcount int;
    v_proj  VARCHAR2(4000) :=' ';
BEGIN


    BEGIN
        total := 1000;

            --执行数据权限存储过程。拿到零时表id 用户连临时表鉴权
 --调用查询数据权限的存储过程,返回spid
--        P_SYS_AUTH_DATA_RULE_SPID(
--            USERID => userid,
--            STATIONID => stationid,
--            DEPTID => departmentid,
--            COMPANYID => companyid,
--            BIZCODE => bizcode,
--            DATA_AUTH_SPID => v_spid
--        );
         --V_AUTH_SQL:='left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||V_SPID||''') ta on ta.orgid=pp.company_id or ta.orgid=pp.proj_id  where ta.orgid is not null ';
       --展示去掉权限取数 chenl
        V_AUTH_SQL:=' where 1=1';
        --如果查询不到项目就是分期，暂时这样紧急处理，升级
                dbms_output.put_line(11111);
select count(proj_id) into v_pcount from POM_PROJ_PLAN where proj_id=projectid;
if v_pcount=0  then
select id into v_proj from SYS_PROJECT_STAGE where PROJECT_ID=projectid;
else
v_proj:=projectid;
end if;


testmsg := 'unitid:'
               || unitid
               || '；pageindex:'
               || pageindex
               || '；pagesizes:'
               || pagesizes
               || '；projectid:'
               || projectid
               || '；begindate:'
               || begindate
               || '；beginend:'
               || beginend;
        -------------------------------------------条件

        IF ( begindate <> NULL ) THEN
            v_where := v_where
                       || 'and  to_char(sa.created,''yyyy-MM-dd'')>='
                       || begindate
                       || '';
        END IF;

        IF ( beginend <> NULL ) THEN
            v_where := v_where
                       || ' and  to_char(sa.created,''yyyy-MM-dd'')<='
                       || beginend
                       || '';
        END IF;

    --------------------------------------拼接完整的sql

        v_sql := '
    SELECT
    rownum as rowno,
    pf.id             as "bizId",
    pn.node_name      AS "nodeName",
    sa.id             AS "attachmentId",
    sa.file_origin_name as "fileName",
    TO_CHAR(sa.file_size/(1024*1024),''FM99990.99'')||''M'' as "fileSize",
    1 AS "isAllowDownload",--是否允许下载，1允许。0不允许
    to_char(sa.created ,''yyyy-MM-dd'') as "created",
    sa.creator        AS "fileCreator",
    pp.plan_name      AS "planName",
    pp.company_id     AS "companyId",
    pp.proj_id        as "projId",
    pp.plan_type      AS "planType"
FROM
    pom_node_feedback    pf
    LEFT JOIN pom_proj_plan_node   pn ON pf.FEEDBACK_NODE_ORIGINAL_ID = pn.original_node_id
    LEFT JOIN pom_proj_plan        pp ON pn.proj_plan_id = pp.id
    LEFT JOIN sys_attachment       sa ON sa.biz_id = pf.id
    '||v_auth_sql||'
    --AND
    --pn.actual_end_date IS NOT NULL
    AND sa.file_origin_name is not null
    AND pp.approval_status = ''已审核''
    AND pp.proj_id='''||v_proj||'''
    and pp.company_id='''||unitid||'''
    and (file_origin_name like ''%'
                 || filename
                 || '%'' and node_name like ''%'
                 || nodename
                 || '%'' and sa.creator like ''%'
                 || filecreator
                 || '%'')'
                 || v_where;


    ----------------------------------------分页

        v_sql_exec := '
select a.* from ( '
                      || v_sql
                      || ' AND rownum <= '
                      || pageindex * pagesizes
                      || ' ) a where a.rowno >= '
                      || pagesizes * ( pageindex - 1 )
                      || '';

        dbms_output.put_line(v_sql_exec);
----获取总条数
        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
                          || v_sql
                          || ') a '
        INTO total;
-- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN items FOR v_sql_exec;
    EXCEPTION
        WHEN OTHERS THEN
            testmsg := sqlerrm || testmsg;
            OPEN items FOR SELECT
                               '失败咯'
                           FROM
                               dual;

            dbms_output.put_line(sqlerrm);
    END;

END p_pom_node_feedback_results;
--=================================本公司负责的任务Start=========================

/
--------------------------------------------------------
--  DDL for Procedure P_POM_NODE_FEEDBACK_RESULTS_C
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_NODE_FEEDBACK_RESULTS_C" (
    unitid         IN             VARCHAR2,--所属公司
    projectid      IN             VARCHAR2,--所属项目
    filename       IN             VARCHAR2,--文件名称
    nodename       IN             VARCHAR2,--计划节点
    filecreator    IN             VARCHAR2,---上传人
    begindate      IN             VARCHAR2,--范围开始时间
    beginend       IN             VARCHAR2,----范围结束日期
    userid         IN             VARCHAR2,--用户id(用户当前）
    stationid      IN             VARCHAR2,--岗位id(用户当前）
    departmentid   IN             VARCHAR2,--部门id(用户当前）
    companyid      IN             VARCHAR2,--公司id(用户所在公司)
    bizcode        IN             VARCHAR2,-- 权限编码
    pageindex      IN             INT,--页码
    pagesizes      IN             INT,--每页条数
    total          OUT            INT,--总数
    items_test          OUT            SYS_REFCURSOR,--项
    items          OUT            SYS_REFCURSOR--项
) 
	--任务成功查询//鲜晓勇负责实现
	--作者：陈丽
	--日期：2019/12/08	
 AS
    v_sql        CLOB;
    v_sql_exec   CLOB;
    v_where      VARCHAR2(500) := ' and 1=1 ';
    testmsg             NVARCHAR2(4000);
    v_spid      NVARCHAR2(4000);
    v_auth_sql         VARCHAR2(4000) :=' ';
    v_pcount int;
    v_proj  VARCHAR2(4000) :=' ';
     v_unitid               VARCHAR2(4000) :=' ';--所属公司
BEGIN


    BEGIN
        total := 1000;

            --执行数据权限存储过程。拿到零时表id 用户连临时表鉴权
 --调用查询数据权限的存储过程,返回spid 
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => stationid,
            DEPTID => departmentid,
            COMPANYID => companyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
        V_AUTH_SQL:='left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||V_SPID||''') ta on ta.orgid=pp.company_id or ta.orgid=p.id  where ta.orgid is not null ';        
       --展示去掉权限取数 chenl 
        --V_AUTH_SQL:=' where 1=1';
        --如果查询不到项目就是分期，暂时这样紧急处理，升级
                dbms_output.put_line(11111);
  OPEN items_test FOR select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = V_SPID;
 ---查找项目的分期
       if projectid is null then
            v_proj:=''' or ''1''=''1';
        else
          select id into v_proj from SYS_PROJECT_STAGE where PROJECT_ID=projectid;
        end if;

  ---查找项目的分期
       if unitid is null then
            v_unitid:=''' or ''1''=''1';
        else
          v_unitid:=unitid;
        end if;


testmsg := 'unitid:'
               || unitid
               || '；pageindex:'
               || pageindex
               || '；pagesizes:'
               || pagesizes
               || '；projectid:'
               || projectid
               || '；begindate:'
               || begindate
               || '；beginend:'
               || beginend;
        -------------------------------------------条件

        IF ( begindate <> NULL ) THEN
            v_where := v_where
                       || 'and  to_char(sa.created,''yyyy-MM-dd'')>='
                       || begindate
                       || '';
        END IF;

        IF ( beginend <> NULL ) THEN
            v_where := v_where
                       || ' and  to_char(sa.created,''yyyy-MM-dd'')<='
                       || beginend
                       || '';
        END IF;

    --------------------------------------拼接完整的sql

        v_sql := '
    SELECT
    rownum as rowno,
    pf.id             as "bizId",
    pn.node_name      AS "nodeName",
    sa.id             AS "attachmentId",
    sa.file_origin_name as "fileName",
    TO_CHAR(sa.file_size/(1024*1024),''FM99990.99'')||''M'' as "fileSize",
    1 AS "isAllowDownload",--是否允许下载，1允许。0不允许
    to_char(sa.created ,''yyyy-MM-dd'') as "created",
    sa.creator        AS "fileCreator",
    pp.plan_name      AS "planName",
    pp.company_id     AS "companyId",
    pp.proj_id        as "projId",
    pp.plan_type      AS "planType",
p.PROJECT_NAME,
ta.orgid
FROM
    pom_node_feedback    pf
    LEFT JOIN pom_proj_plan_node   pn ON pf.FEEDBACK_NODE_ORIGINAL_ID = pn.original_node_id
    LEFT JOIN pom_proj_plan        pp ON pn.proj_plan_id = pp.id
    LEFT JOIN sys_attachment       sa ON sa.biz_id = pf.id 
      left join SYS_PROJECT_STAGE ps on ps.id=pp.proj_id
      left join sys_project p on ps.PROJECT_ID=p.id

    '||v_auth_sql||'
    AND
    pn.actual_end_date IS NOT NULL 
    AND sa.file_origin_name is not null 
    AND pp.approval_status = ''已审核''
    AND (pp.proj_id='''||v_proj||''')
    and (pp.company_id='''||v_unitid||''')
    and (file_origin_name like ''%'
                 || filename
                 || '%'' and node_name like ''%'
                 || nodename
                 || '%'' and sa.creator like ''%'
                 || filecreator
                 || '%'')'
                 || v_where;


    ----------------------------------------分页

        v_sql_exec := '
select a.* from ( '
                      || v_sql
                      || ' AND rownum <= '
                      || pageindex * pagesizes
                      || ' ) a where a.rowno >= '
                      || pagesizes * ( pageindex - 1 )
                      || '';

        dbms_output.put_line(v_sql_exec);
----获取总条数
        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
                          || v_sql
                          || ') a '
        INTO total;

-- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN items FOR v_sql_exec;
    EXCEPTION
        WHEN OTHERS THEN
            testmsg := sqlerrm || testmsg;
            OPEN items FOR SELECT
                               testmsg
                           FROM
                               dual;

            dbms_output.put_line(sqlerrm);
    END;

END p_pom_node_feedback_results_c;
--=================================本公司负责的任务Start=========================

--=================================本公司负责的任务Start=========================

/
--------------------------------------------------------
--  DDL for Procedure P_POM_NODE_MESSAGE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_NODE_MESSAGE" 
(
  originalNodeId IN VARCHAR2,
  messageInfo OUT sys_refcursor
) AS 
--查看反馈，任务相关消息列表查询
--作者：陈丽
--日期：2019/11/15
BEGIN
 open messageInfo for
  select * from(    
  SELECT 
  biz.BIZ_SOURCE_CATEGORY  AS    "title"--消息标题
  ,node.NODE_NAME ||'-'|| node.NODE_LEVEL  AS  "nodeInfo"--任务信息
  ,nvl(UR.USER_NAME,URS.USER_NAME) AS "recipient"
  ,cast(nvl(MSG.SEND_DATE,msgs.SEND_DATE) as timestamp)   AS   "executionTime"
  --,to_timestamp(nvl(MSG.SEND_DATE,msgs.SEND_DATE),'yyyy-mm-dd hh24:mi:ss') AS   "executionTime"
  ,nvl(BIZ_MSG_CATEGORY,BIZ_SOURCE_CATEGORY)   AS  "msgType"
      FROM
      POM_PROJ_PLAN_NODE node  
      LEFT JOIN SYS_MSG_RECORD_BIZ biz ON node.ID = biz.BIZ_KEY
      LEFT JOIN SYS_MSG_RECORD_WECHAT msg ON biz.id = msg.MSG_RECORD_BIZ_ID 
      left join SYS_MSG_RECORD_SMS msgs on biz.id = msgs.MSG_RECORD_BIZ_ID 
      LEFT JOIN  SYS_USER UR ON UR.user_code=MSG.RECEIVER_ID
      LEFT JOIN  SYS_USER URS ON URS.user_code=msgs.RECEIVER_ID
    WHERE
      node.id = biz.biz_key  and  node.id=''||originalNodeId||''
      AND biz.ID NOT IN ( SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD ) ) a order by "executionTime" desc;
    
--  SELECT 
--  MSG.TITLE  AS    "title"--消息标题
--  ,node.NODE_NAME ||'-'|| node.NODE_LEVEL  AS  "nodeInfo"--任务信息
--  ,UR.USER_NAME AS "recipient"
--  ,MSG.SEND_DATE  AS   "executionTime"
--  ,MSG.ACTUAL_EXECUTE_TYPE   AS  "msgType"
--      FROM
--      POM_PROJ_PLAN_NODE node  
--      LEFT JOIN SYS_MSG_RECORD_BIZ biz ON node.ID = biz.BIZ_KEY
--      LEFT JOIN SYS_MSG_RECORD_WECHAT msg ON biz.id = msg.MSG_RECORD_BIZ_ID 
--      LEFT JOIN  SYS_USER UR ON UR.ID=MSG.RECEIVER_ID
--    WHERE
--      node.id = biz.biz_key  and  node.id=''||originalNodeId||''
--      AND biz.ID NOT IN ( SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD ) ;
      
        
END p_pom_node_message;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_NODE_MESSAGE_ADJUSTMENT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_NODE_MESSAGE_ADJUSTMENT" 
(
  originalNodeId IN VARCHAR2,
  messageInfo OUT sys_refcursor
) AS 
--查看反馈，任务相关消息列表查询
--作者：谢松宏
--日期：2020/03/13
BEGIN
 open messageInfo for
Select * from (
select 
	nvl(MSG.TITLE, biz.BIZ_SOURCE_CATEGORY)  AS    "title"--消息标题
	,node.NODE_NAME ||'-'|| node.NODE_LEVEL  AS  "nodeInfo"--任务信息
	,nvl(UR.USER_NAME,URS.USER_NAME) AS "recipient"
	,nvl(MSG.SEND_DATE, sms.SEND_DATE)  AS   "executionTime"
    ,to_char(nvl(MSG.SEND_DATE, sms.SEND_DATE), 'yyyy-MM-dd hh24:mi:ss') AS "executionTimeString" --添加一个返回字段用于将操作时间转换为字符串格式。
	,nvl(msg.WECHAT_MSG_TYPE, BIZ.BIZ_MSG_CATEGORY) AS  "msgType"
 from 
(select * from POM_PROJ_PLAN_NODE where  proj_plan_id = (select id from (select * from POM_PROJ_PLAN plan where plan.id in (select proj_plan_id from POM_PROJ_PLAN_NODE where original_node_id=''||originalNodeId||'') and approval_status='已审核'))) node 
LEFT JOIN SYS_MSG_RECORD_BIZ biz ON node.ID = biz.BIZ_KEY
LEFT JOIN SYS_MSG_RECORD_WECHAT msg ON biz.id = msg.MSG_RECORD_BIZ_ID 
LEFT JOIN SYS_MSG_RECORD_SMS sms on biz.id = sms.MSG_RECORD_BIZ_ID
LEFT JOIN  SYS_USER UR ON UR.ID=msg.RECEIVER_ID
LEFT JOIN  SYS_USER URS ON URS.user_code=sms.RECEIVER_ID
where 
node.id = biz.biz_key  and
original_node_id = ''||originalNodeId||''
AND biz.ID NOT IN ( SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD )) order by "executionTime" desc;

END p_pom_node_message_adjustment;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_OUT_EXCEL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_OUT_EXCEL" 
(
    PROJID      IN VARCHAR2
   , -- 输入变量：项目
    CURRENTTYPE IN VARCHAR2
   , --完成节点类型(本月任务,超期未完成任务,所有未完成任务,所有已完成任务,所有任务,次月任务,本季度任务,本年任务)
    ITEMS       OUT SYS_REFCURSOR
   ,TOTAL       OUT INT
) IS

    V_SQL_START       CLOB;
    V_SQL_END         CLOB;
    V_SQL_CONTENT     CLOB;
    V_SQL             CLOB;
    V_SQL_EXEC        CLOB;
    V_SQL_EXEC_PAGING CLOB;
    V_WHERE           VARCHAR2(500);
    TESTMSG           NVARCHAR2(200);
BEGIN
    ----------------------------------------------------统一解析
    TESTMSG := 'projid:' || PROJID || '；currenttype:' || CURRENTTYPE;

    BEGIN
        TOTAL         := 1000;
        V_SQL_START   := ' case ';
        V_SQL_CONTENT := '';
        V_SQL_END     := '  else '''' end  ';


        --1.拼接查询语句
        FOR ITEM IN (SELECT S.EXPRESSION, VV.NODE_LEVEL, VV.PLAN_TYPE
                     FROM   POM_RULE_SET S
                     LEFT   JOIN (SELECT MAX(S.CREATED_TIME) AS T, NODE_LEVEL, PLAN_TYPE
                                 FROM   POM_RULE_SET S
                                 LEFT   JOIN POM_RULE_SET_PLAN_TYPE PT
                                 ON     S.ID = PT.RULE_ID
                                 WHERE  RULE_TYPE = '亮灯规则'
                                       -- AND plan_type != '关键节点计划'
                                        AND
                                        S.IS_DISABLE = 0
                                 GROUP  BY NODE_LEVEL, PLAN_TYPE) VV
                     ON     S.CREATED_TIME = VV.T AND
                            S.NODE_LEVEL = VV.NODE_LEVEL
                     WHERE  VV.T IS NOT NULL)
        LOOP
            ---拼接字符串
            V_SQL_CONTENT := V_SQL_CONTENT || '  when plan_type=''' || CASE ITEM.PLAN_TYPE
                                 WHEN '项目全景计划' THEN
                                  '项目主项计划'
                                 ELSE
                                  ITEM.PLAN_TYPE
                             END || ''' and node_level=''' || ITEM.NODE_LEVEL || ''' then (' || ITEM.EXPRESSION || ')';
        END LOOP;

        --dbms_output.put_line('123333');
        --dbms_output.put_line(v_sql_content);
        --规则内容大于0才拼规则语句

        IF LENGTH(V_SQL_CONTENT) > 0
        THEN
            V_SQL := V_SQL_START || V_SQL_CONTENT || V_SQL_END;
        ELSE
            --无规则亮灯显示空
            V_SQL := '''''';
        END IF;

        -------------------------------------------------------------------------------------------内容


        IF CURRENTTYPE = '本月任务'
        THEN
            V_WHERE := ' and ACTUAL_END_DATE is null and (PLAN_END_DATE>=trunc(sysdate, ''month'') and PLAN_END_DATE<=trunc(last_day(sysdate))) ';
        ELSIF CURRENTTYPE = '超期未完成任务'
        THEN
            V_WHERE := ' and TRUNC(SYSDATE) > PLAN_END_DATE and ACTUAL_END_DATE is null';
        ELSIF CURRENTTYPE = '所有未完成任务'
        THEN
            V_WHERE := ' and ACTUAL_END_DATE is null ';
        ELSIF CURRENTTYPE = '所有已完成任务'
        THEN
            V_WHERE := ' and ACTUAL_END_DATE is not null ';
        ELSIF CURRENTTYPE = '所有任务'
        THEN
            V_WHERE := ' ';
        ELSIF CURRENTTYPE = '次月任务'
        THEN
            V_WHERE := ' and (PLAN_END_DATE>last_day(trunc(sysdate))+1 and PLAN_END_DATE<last_day(last_day(trunc(sysdate))+1))';
        ELSIF CURRENTTYPE = '本季度任务'
        THEN
            V_WHERE := ' and (PLAN_END_DATE>trunc(sysdate, ''Q'') and PLAN_END_DATE<add_months(trunc(sysdate, ''Q''), 3) - 1) ';
        ELSIF CURRENTTYPE = '本年任务'
        THEN
            V_WHERE := ' and (PLAN_END_DATE>trunc(sysdate, ''yyyy'') and PLAN_END_DATE<add_months(trunc(sysdate, ''yyyy''), 12) - 1)  ';
        ELSE
            V_WHERE := ' and 1=2';
        END IF;

        --3.拼接完整语句
        V_SQL_EXEC := ' select  rownum as rowno,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
    NODE_LEVEL,
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,w_Url,' || V_SQL || ' as NODE_WARNING from (select n.*,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE IS NOT NULL THEN NULL 
ELSE ''催办'' END as HASTEN
,case when w.IS_UN_WATCH=0 then ''/api/pom/planfollow/unfollow?cancelType=0=724=300=''||ORIGINAL_NODE_ID else ''/pom/biz-watch/bizwatch-setting?cancelType=0=724=300==''||ORIGINAL_NODE_ID end as w_Url

                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门

    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n LEFT
    JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID WHERE   p.PLAN_TYPE=''关键节点计划'' AND NVL(n.IS_DISABLE,0) <> 1 and APPROVAL_STATUS=''已审核''
    AND (p.PROJ_ID=''' || PROJID || ''' OR p.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''' || PROJID || '''))  ' || V_WHERE || '
)n
    left join SYS_BIZ_WATCH w on n.ORIGINAL_NODE_ID=w.BIZ_ID  ) a ';
        -------------------------------------------------------------------------------------------内容

        V_SQL_EXEC_PAGING := '
select a.* from ( ' || V_SQL_EXEC || ')a';

        DBMS_OUTPUT.PUT_LINE(V_SQL_EXEC_PAGING);
        ----获取总条数
        EXECUTE IMMEDIATE 'SELECT count(rowno) from(' || V_SQL_EXEC || ') a '
            INTO TOTAL;

        -- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN ITEMS FOR V_SQL_EXEC_PAGING;
        --SELECT '' A FROM DUAL;

    EXCEPTION
        WHEN OTHERS THEN
            TESTMSG := SQLERRM || TESTMSG;
            OPEN ITEMS FOR
                SELECT '失败咯' || TESTMSG PLAN_NAME FROM DUAL;

            DBMS_OUTPUT.PUT_LINE(SQLERRM);
    END;

END p_pom_out_excel;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_PERMIT_ID_LIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_PERMIT_ID_LIST" (
    info out SYS_REFCURSOR,
    originNodeId in varchar2
) is
--根据裂变原始节点Id查询所有节点所关联的证照id
--作者：韩金明
--日期：2010/02/28
--输入变量：裂变原始节点Id
begin
    open info for
        select fb.PERMIT_ID
        from POM_NODE_FEEDBACK fb
        left join POM_PROJ_PLAN_NODE node on fb.id = node.FISSION_SOURCE_ORIGINAL_ID
        left join POM_PROJ_PLAN plan on node.PROJ_PLAN_ID = plan.id
        where plan.ORIGINAL_PLAN_ID = originNodeId;
    -- 将原始节点id传入POM_PROJ_PLAN查询所有裂变计划
    -- 关联计划节点id
end P_POM_PERMIT_ID_LIST;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_PLAN_COMPLETIONRANKING
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_PLAN_COMPLETIONRANKING" (
    companyid          IN                 VARCHAR2,--公司id
    currentcompanyid   IN                 VARCHAR2,--当前用户的公司
    userid             IN                 VARCHAR2,--用户id用于过滤关注的任务
    currentstationid   IN                 VARCHAR2,---当前用户的岗位
    currentdeptid      IN                 VARCHAR2,---当前用户的部门
    bizcode            IN                 VARCHAR2,---权限code
    authdata           OUT                SYS_REFCURSOR,--有权限数据的ID集合
    datasource              OUT                SYS_REFCURSOR --亮灯信息
) AS
--项目主项计划监控项目完成率前排行榜
--作者：叶丁荣
--日期：2020/03/20
    v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN
--调用数据权限验证存储过程
    p_sys_auth_data_rule_spid(userid => userid, stationid => currentstationid, deptid => currentdeptid, companyid => currentcompanyid
    , bizcode => bizcode, data_auth_spid => v_spid);

    OPEN datasource FOR SELECT
                      ROWNUM,
                      b1."fullName",
                      b1."competationRate",
                      b1."projtId"
                  FROM
                      sys_business_unit a1
                      LEFT JOIN (
                          SELECT
                              '【'
                              || a.company_name
                              || '】'
                              || d.project_name
                              ||
                                  CASE
                                      WHEN c.stage_name NOT LIKE '%无分期%' THEN
                                          '_' || c.stage_name
                                      ELSE
                                          NULL
                                  END
                              AS "fullName",
                              c.id   AS "projtId",
                              a.company_id,
                              COUNT(b.id) AS "TOTALNODECOUNT",
                              SUM(
                                  CASE
                                      WHEN b.actual_end_date IS NOT NULL THEN
                                          1
                                      ELSE
                                          0
                                  END
                              ) AS "actualEndNodeCount",
                              round(SUM(
                                  CASE
                                      WHEN b.actual_end_date IS NOT NULL THEN
                                          1
                                      ELSE
                                          0
                                  END
                              ) /(

                                   CASE
                                      WHEN COUNT(b.id) = 0 THEN
                                          1
                                      ELSE
                                          COUNT(b.id)
                                  END

                              ),4) AS "competationRate"
--完成率说明：截止当前完成节点数量/截止当前应完成任务数量    亮灯规则说明：1）绿灯：完成率≥95% 2）黄灯：95%>完成率≥90% 3）红灯：完成率＜90%
                          FROM
                              pom_proj_plan        a
                              INNER JOIN pom_proj_plan_node   b ON a.id = b.proj_plan_id
                              INNER JOIN sys_project_stage    c ON c.id = proj_id
                              INNER JOIN sys_project          d ON d.id = c.project_id
                          WHERE
                              a.plan_type = '项目主项计划'
                              AND a.approval_status = '已审核'
                              AND b.is_disable = 0
                              AND b.plan_end_date is not null
                              AND b.plan_end_date <= SYSDATE
                          GROUP BY
                              '【'
                              || a.company_name
                              || '】'
                              || d.project_name
                              ||
                                  CASE
                                      WHEN c.stage_name NOT LIKE '%无分期%' THEN
                                          '_' || c.stage_name
                                      ELSE
                                          NULL
                                  END,
                              a.company_id,
                              a.company_name,
                              c.id
                      ) b1 ON b1.company_id = a1.id
                      LEFT JOIN (
                          SELECT
                              wm_concat(user_name) AS user_name,
                              project_id
                          FROM
                              sys_role_user_relation_result
                          WHERE
                              role_code = 'pom_project_plan_manager'
                          GROUP BY
                              project_id
                      ) c1 ON c1.project_id = b1."projtId"
                  WHERE
                      nvl(b1.totalnodecount, 0) > 0
                      AND ROWNUM <= 10
                      AND CONNECT_BY_ROOT id = ''
                                               || companyid
                                               || ''
                  CONNECT BY
                      PRIOR a1.id = a1.parent_id
                  ORDER BY
                      b1."competationRate" DESC;

    OPEN authdata FOR SELECT
                      b1."projtId"
                  FROM
                      sys_business_unit a1
                      LEFT JOIN (
                          SELECT
                              c.id   AS "projtId",
                              a.company_id,
                              COUNT(b.id) AS "TOTALNODECOUNT"
                          FROM
                              pom_proj_plan        a
                              INNER JOIN pom_proj_plan_node   b ON a.id = b.proj_plan_id
                              INNER JOIN sys_project_stage    c ON c.id = proj_id
                              INNER JOIN sys_project          d ON d.id = c.project_id
                              LEFT  JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                              on (case when c.id is not null then c.PROJECT_ID else a.proj_id end)=tal.orgId
                            WHERE
                              a.plan_type = '项目主项计划'
                              AND a.approval_status = '已审核'
                              AND b.is_disable = 0
                              AND b.plan_end_date <= SYSDATE
                          GROUP BY
                              a.company_id,
                              a.company_name,
                              c.id
                      ) b1 ON b1.company_id = a1.id
                      LEFT JOIN (
                          SELECT
                              wm_concat(user_name) AS user_name,
                              project_id
                          FROM
                              sys_role_user_relation_result
                          WHERE
                              role_code = 'pom_project_plan_manager'
                          GROUP BY
                              project_id
                      ) c1 ON c1.project_id = b1."projtId"
                  WHERE
                      nvl(b1.totalnodecount, 0) > 0
                      AND ROWNUM <= 10
                      AND CONNECT_BY_ROOT id = ''
                                               || companyid
                                               || ''
                                                CONNECT BY
                      PRIOR a1.id = a1.parent_id
                ;

END p_pom_plan_completionranking;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_PLAN_MONITOR_LIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_PLAN_MONITOR_LIST" (
    plantype    IN          VARCHAR2, --输入变量：计划类型
    currentcompanyid   IN                 VARCHAR2,--当前用户的公司
    userid             IN                 VARCHAR2,--用户id用于过滤关注的任务
    currentstationid   IN                 VARCHAR2,---当前用户的岗位
    currentdeptid      IN                 VARCHAR2,---当前用户的部门
    bizcode            IN                 VARCHAR2,---权限code
    pageindex   IN          VARCHAR2,--输入变量：页码
    pagesizes    IN          VARCHAR2,--输入面临：页面条数
    items       OUT         SYS_REFCURSOR
) IS
    v_where              CLOB;
    v_sql_exec          CLOB;
    v_sql_exec_paging   CLOB;
    v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN
    --调用数据权限验证存储过程
    p_sys_auth_data_rule_spid(userid => userid, stationid => currentstationid, deptid => currentdeptid, companyid => currentcompanyid
    , bizcode => bizcode, data_auth_spid => v_spid);

  execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd hh24:mi:ss''';
    IF plantype = '关键节点计划' THEN
        v_where:= 'AND plan.PLAN_TYPE = ''关键节点计划''';
    ELSE
        v_where := 'AND plan.PLAN_TYPE = ''项目主项计划''';
    END IF;


v_sql_exec:='SELECT  rownum as "rowno","userName", "executionTime","executionContent", "executionType" from
(select "userName","executionTime","executionContent","executionType" from (
SELECT
    back.FEEDBACKER AS "userName",
    back.CREATED AS "executionTime",
    case when  FEEDBACK_TYPE=''PROCESS'' then
    ''<span style="color:#A2A2A2">反馈了任务:</span> ''|| ( ''【'' || stage.STAGE_FULL_NAME || ''】''|| node.node_name )
    when FEEDBACK_TYPE=''CARRY_OUT'' then
    ''<span style="color:#A2A2A2">完成了任务:</span>''|| ( ''【'' || stage.STAGE_FULL_NAME || ''】''|| node.node_name ) 

     else 
     ''<span style="color:#A2A2A2">反馈了超期未完成任务:</span>''|| ( ''【'' || stage.STAGE_FULL_NAME || ''】''|| node.node_name ) 
     end  AS "executionContent",
	case when  FEEDBACK_TYPE=''PROCESS'' then
        ''feedback''
     when FEEDBACK_TYPE=''CARRY_OUT'' then
        ''complete''
     else
        ''overdu''
     end AS "executionType"
--     to_char(back.CREATED,''yyyy-mm-dd'') as "groupDate"
    FROM
	pom_proj_plan_node node
	LEFT JOIN pom_proj_plan plan ON node.proj_plan_id = plan.id
    LEFT JOIN SYS_PROJECT_STAGE stage on plan.proj_id=stage.id
    LEFT JOIN SYS_PROJECT proj
    on (case when stage.id is not null then stage.ID else plan.proj_id end)=proj.id
    INNER join pom_node_feedback back on back.FEEDBACK_NODE_ORIGINAL_ID=node.original_node_id
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    ON (case when stage.id is not null then stage.PROJECT_ID else plan.proj_id end)=tal.orgId
    where plan.ID is not null and plan.APPROVAL_STATUS=''已审核'' '|| v_where||'
    UNION ALL
   SELECT
    message.user_name AS "userName",
      message.created_time AS "executionTime",
    ''<span style="color:#A2A2A2">催办了任务:</span>''|| ( ''【'' || stage.STAGE_FULL_NAME || ''】''|| node.node_name )   AS "executionContent",
    ''urge'' AS "executionType"
FROM
    pom_proj_plan_node   node
    LEFT JOIN pom_proj_plan        plan ON node.proj_plan_id = plan.id
    LEFT JOIN sys_project_stage    stage ON plan.proj_id = stage.id
    LEFT JOIN sys_project          proj ON (
        CASE
            WHEN stage.id IS NOT NULL THEN
                stage.ID
            ELSE
                plan.proj_id
        END
    ) = proj.id
    INNER JOIN (
         SELECT
            msg.biz_key,
            msg.biz_msg_category,
            msg.created_time,
            sms.sender_id      AS "sms_sender_id",
            sms.sms_content,
            wechat.sender_id   AS "wechat_sender_id",
            wechat.title,
            suser.user_name
        FROM
            sys_msg_record_biz      msg
            LEFT JOIN sys_msg_record_sms      sms ON sms.msg_record_biz_id = msg.id
            LEFT JOIN sys_msg_record_wechat   wechat ON wechat.msg_record_biz_id = msg.id
            INNER JOIN sys_user suser on suser.user_code=sms.sender_id OR suser.id=wechat.sender_id
        WHERE
            msg.biz_msg_category = ''催办消息'' 
    ) message ON message.biz_key = node.original_node_id
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    ON (case when stage.id is not null then stage.PROJECT_ID else plan.proj_id end)=tal.orgId
    WHERE  plan.APPROVAL_STATUS=''已审核'' '|| v_where||'
    UNION ALL
    select
    '''' AS "userName",
    to_date(  to_char("executionTime",''yyyy-mm-dd'')||'' 23:59:59'' ) AS "executionTime",
    ''''  AS "executionContent",
    to_char("executionTime",''mm"月"dd"日"'') "executionType" from (
SELECT
    back.FEEDBACKER AS "userName",
    back.CREATED AS "executionTime",
    case when  FEEDBACK_TYPE=''PROCESS'' then
    ''反馈了任务 ''|| ( ''【'' || stage.STAGE_FULL_NAME || ''】''|| node.node_name )
    when FEEDBACK_TYPE=''CARRY_OUT'' then
    ''完成了任务''|| ( ''【'' || stage.STAGE_FULL_NAME || ''】''|| node.node_name ) 

     else 
     ''反馈了超期未完成任务''|| ( ''【'' || stage.STAGE_FULL_NAME || ''】''|| node.node_name ) 
     end  AS "executionContent",
  case when  FEEDBACK_TYPE=''PROCESS'' then
        ''feedback''
     when FEEDBACK_TYPE=''CARRY_OUT'' then
        ''overdu''
     else
        ''complete''
     end AS "executionType"
--     to_char(back.CREATED,''yyyy-mm-dd'') as "groupDate"
    FROM
  pom_proj_plan_node node
  LEFT JOIN pom_proj_plan plan ON node.proj_plan_id = plan.id
    LEFT JOIN SYS_PROJECT_STAGE stage on plan.proj_id=stage.id
    LEFT JOIN SYS_PROJECT proj
    on (case when stage.id is not null then stage.ID else plan.proj_id end)=proj.id
    INNER join pom_node_feedback back on back.FEEDBACK_NODE_ORIGINAL_ID=node.original_node_id
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    ON (case when stage.id is not null then stage.PROJECT_ID else plan.proj_id end)=tal.orgId
    where plan.ID is not null and plan.APPROVAL_STATUS=''已审核'' '|| v_where||'
    UNION ALL
   SELECT
     message.user_name AS "userName",
      message.created_time AS "executionTime",
    ''催办了任务:''|| ( ''【'' || stage.STAGE_FULL_NAME || ''】''|| node.node_name )   AS "executionContent",
    ''urge'' AS "executionType"
FROM
    pom_proj_plan_node   node
    LEFT JOIN pom_proj_plan        plan ON node.proj_plan_id = plan.id
    LEFT JOIN sys_project_stage    stage ON plan.proj_id = stage.id
    LEFT JOIN sys_project          proj ON (
        CASE
            WHEN stage.id IS NOT NULL THEN
                stage.ID
            ELSE
                plan.proj_id
        END
    ) = proj.id
    INNER JOIN (
         SELECT
            msg.biz_key,
            msg.biz_msg_category,
            msg.created_time,
            sms.sender_id      AS "sms_sender_id",
            sms.sms_content,
            wechat.sender_id   AS "wechat_sender_id",
            wechat.title,
            suser.user_name
        FROM
            sys_msg_record_biz      msg
            LEFT JOIN sys_msg_record_sms      sms ON sms.msg_record_biz_id = msg.id
            LEFT JOIN sys_msg_record_wechat   wechat ON wechat.msg_record_biz_id = msg.id
            INNER JOIN sys_user suser on suser.user_code=sms.sender_id OR suser.id=wechat.sender_id
        WHERE
            msg.biz_msg_category = ''催办消息'' 
    ) message ON message.biz_key = node.original_node_id   WHERE  plan.APPROVAL_STATUS=''已审核'' '|| v_where||')a
    group by to_char("executionTime",''mm"月"dd"日"'')
    , to_date(  to_char("executionTime",''yyyy-mm-dd'')||'' 23:59:59'' )) order BY "executionTime" DESC)   ';







      v_sql_exec_paging := '
select a.* from ( '
                         || v_sql_exec
                         || ' where rownum <= '
                         || pageIndex * pageSizes
                         || ' ) a where a."rowno" > '
                         || pagesizes * ( pageindex - 1 )
                         || '';

    dbms_output.put_line(v_sql_exec_paging);
    OPEN items FOR v_sql_exec_paging;

END p_pom_plan_monitor_list;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_PLAN_MONITOR_TASK_COUNT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_PLAN_MONITOR_TASK_COUNT" ( plantype IN VARCHAR2, --输入变量：计划类型
    currentcompanyid   IN                 VARCHAR2,--当前用户的公司
    userid             IN                 VARCHAR2,--用户id用于过滤关注的任务
    currentstationid   IN                 VARCHAR2,---当前用户的岗位
    currentdeptid      IN                 VARCHAR2,---当前用户的部门
    bizcode            IN                 VARCHAR2,---权限code
	beyondtask OUT VARCHAR2,
    completedtodaytask OUT VARCHAR2,
    todotodaytask OUT VARCHAR2 )
 IS
    v_where CLOB;
    v_beyondtask_sql  CLOB;
    v_completedtodaytask_sql  CLOB;
    v_todotodaytask_sql  CLOB;
    v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN
--调用数据权限验证存储过程
    p_sys_auth_data_rule_spid(userid => userid, stationid => currentstationid, deptid => currentdeptid, companyid => currentcompanyid
    , bizcode => bizcode, data_auth_spid => v_spid);

	IF
		plantype = '关键节点计划' THEN
			v_where := 'AND plan.PLAN_TYPE = ''关键节点计划''';
		ELSE v_where := 'AND plan.PLAN_TYPE = ''项目主项计划''';

	END IF;
	--超期任务
    v_beyondtask_sql:=	'SELECT COUNT( * ) FROM POM_PROJ_PLAN_NODE node LEFT JOIN
    POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID 
    LEFT JOIN sys_project_stage    c ON c.id = plan.proj_id
    LEFT JOIN sys_project          d ON d.id = c.project_id
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    on (case when c.id is not null then c.PROJECT_ID else plan.proj_id end)=tal.orgId
    WHERE plan.APPROVAL_STATUS=''已审核'' AND node.PLAN_END_DATE IS NOT NULL
    AND ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE ' ||v_where;
    EXECUTE IMMEDIATE  v_beyondtask_sql into beyondtask;
	--今日待办
	 v_completedtodaytask_sql:='SELECT COUNT( * ) FROM POM_PROJ_PLAN_NODE node LEFT JOIN
	 POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID 
     LEFT JOIN sys_project_stage    c ON c.id = plan.proj_id
    LEFT JOIN sys_project          d ON d.id = c.project_id
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    on (case when c.id is not null then c.PROJECT_ID else plan.proj_id end)=tal.orgId
     WHERE plan.APPROVAL_STATUS=''已审核'' AND node.PLAN_END_DATE IS NOT NULL
     AND ACTUAL_END_DATE IS NULL AND SYSDATE = node.PLAN_END_DATE ' || v_where;
--     dbms_output.put_line(v_where);
--     dbms_output.put_line(v_completedtodaytask_sql);
     EXECUTE IMMEDIATE  v_completedtodaytask_sql into completedtodaytask;
	--今日完成
	v_todotodaytask_sql:='SELECT COUNT( * ) FROM POM_PROJ_PLAN_NODE node LEFT JOIN
    POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID 
    LEFT JOIN sys_project_stage    c ON c.id = plan.proj_id
    LEFT JOIN sys_project          d ON d.id = c.project_id
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    on (case when c.id is not null then c.PROJECT_ID else plan.proj_id end)=tal.orgId
    WHERE plan.APPROVAL_STATUS=''已审核''
	AND	SYSDATE = ACTUAL_END_DATE ' || v_where;
    EXECUTE IMMEDIATE  v_todotodaytask_sql into todotodaytask;
--    dbms_output.put_line(v_where);

END P_POM_PLAN_MONITOR_TASK_COUNT;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_PLAN_MONITOR_TASK_LIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_PLAN_MONITOR_TASK_LIST" (
    plantype    IN          VARCHAR2, --输入变量：计划类型
    tabtype     IN          VARCHAR2, --输入变量：查询类型//超期任务、今日待办、 今日完成
    pageIndex   IN          VARCHAR2,
    pageRows    IN          VARCHAR2,
    currentcompanyid   IN                 VARCHAR2,--当前用户的公司
    userid             IN                 VARCHAR2,--用户id用于过滤关注的任务
    currentstationid   IN                 VARCHAR2,---当前用户的岗位
    currentdeptid      IN                 VARCHAR2,---当前用户的部门
    bizcode            IN                 VARCHAR2,---权限code
    items       OUT         SYS_REFCURSOR
) IS
    v_whre              CLOB;
    v_sql_exec          CLOB;
    nodestatus          VARCHAR2(20);
    v_nodeTime          CLOB;
    v_sql_exec_paging   CLOB;
    v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN
    --调用数据权限验证存储过程
    p_sys_auth_data_rule_spid(userid => userid, stationid => currentstationid, deptid => currentdeptid, companyid => currentcompanyid
    , bizcode => bizcode, data_auth_spid => v_spid);

    IF tabtype = '超期任务' THEN
        v_whre := ' AND ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE AND plan.PLAN_TYPE ='''
                  || plantype
                  || '''';
        v_nodeTime:='TO_CHAR(node.PLAN_END_DATE,''yyyy-mm-dd'') AS "nodeTime"';
        nodestatus := '已超期';
    ELSIF tabtype = '今日待办' THEN
        v_whre := 'AND ACTUAL_END_DATE IS NULL AND SYSDATE = node.PLAN_END_DATE AND plan.PLAN_TYPE ='''
                  || plantype
                  || '''';
        v_nodeTime:='TO_CHAR(node.PLAN_END_DATE,''yyyy-mm-dd'') AS "nodeTime"';
        nodestatus := '未完成';
    ELSE
        v_whre := 'AND SYSDATE = ACTUAL_END_DATE AND plan.PLAN_TYPE ='''
                  || plantype
                  || '''';
        v_nodeTime:='TO_CHAR(node.ACTUAL_END_DATE,''yyyy-mm-dd'') AS "nodeTime"';
        nodestatus := '已完成';
    END IF;

    v_sql_exec := ' SELECT
    rownum as rowno,
	node.id AS "nodeId",
	node.ORIGINAL_NODE_ID AS "nodeOriginalId",
	--plan.plan_name,
	'''
                  || nodestatus
                  || ''' AS "nodeStatus",
	(node.node_name || ''【'' || stage.STAGE_FULL_NAME || ''】'') AS "nodeName",
    plan.plan_type as "nodePlanType",
	'||v_nodeTime||'

    FROM
	pom_proj_plan_node node
	LEFT JOIN pom_proj_plan plan ON node.proj_plan_id = plan.id
    LEFT JOIN SYS_PROJECT_STAGE stage on plan.proj_id=stage.id
    LEFT JOIN SYS_PROJECT proj
    on (case when stage.id is not null then stage.ID else plan.proj_id end)=proj.id
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    ON (case when stage.id is not null then stage.PROJECT_ID else plan.proj_id end)=tal.orgId
where plan.ID is not null and plan.APPROVAL_STATUS=''已审核'''
                  || v_whre;
    v_sql_exec_paging := '
select a.* from ( '
                         || v_sql_exec
                         || ' and rownum <= '
                         || pageIndex * pageRows
                         || ' ) a where a.rowno > '
                         || pageRows * ( pageIndex - 1 )
                         || '';

    dbms_output.put_line(v_sql_exec_paging);
    OPEN items FOR v_sql_exec_paging;

END p_pom_plan_monitor_task_list;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_PLAN_PERFROM_DYNAMIC
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_PLAN_PERFROM_DYNAMIC" 
(
		IN_ORG_ID    IN VARCHAR2
	 ,DATASCOPE    IN VARCHAR2
	 ,IN_PLAN_TYPE IN VARCHAR2
	 ,IN_PROJID    IN VARCHAR2
	 ,PAGEINDEX    IN INT
	 ,PAGESIZES    IN INT
	 ,P_PAGETYPE   IN INT
	 ,ITEMS        OUT SYS_REFCURSOR
	 ,TOTAL        OUT INT
) AS
		--传入的参数有三个，1：IN_ORG_ID（公司ID）
		--，2：DATASCOPE（统计期间，3个值“THIS_MONTH、THIS_QUARTER、THIS_YEAR"）
		--，3：PLAN_TYPE（计划类型，预留，估计后面会用的到）
		--，4：P_PAGETYPE（页面类型：1：已延误 2：已完成 3：应完成）//alterby 李小聪
		--关键节点计划-执行动态查询（wangck需要）
		--作者：陈丽
		--日期：2019/12/07
		CURSOR CUR_COMPANY_LIST(V_ORG_ID SYS_BUSINESS_UNIT.ID%TYPE) IS
				SELECT P.ID, P.PARENT_ID, P.ORG_NAME FROM SYS_BUSINESS_UNIT P WHERE P.IS_COMPANY = 1 START WITH P.ID = V_ORG_ID CONNECT BY PRIOR P.ID = P.PARENT_ID;
		V_SQL_TOTAL     CLOB := ' ';
		V_SQL           CLOB := ' ';
		V_SQL_DATASCOPE CLOB := ' ';
		V_COMPANY_LIST  CLOB := ' ';
BEGIN

		DBMS_OUTPUT.PUT_LINE('开始');
		--月度
		--已延误
		IF DATASCOPE = 'thisMonth'
			 AND P_PAGETYPE = 1
		THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL   AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';
				--月度
				--已完成
		ELSIF DATASCOPE = 'thisMonth'
					AND P_PAGETYPE = 2
		THEN
				V_SQL_DATASCOPE := ' AND  PN.ACTUAL_END_DATE IS  NOT NULL  AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';

				--月度
				--应完成

		ELSIF DATASCOPE = 'thisMonth'
					AND P_PAGETYPE = 3
		THEN
				V_SQL_DATASCOPE := 'AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';

				--季度
				--已延误
		ELSIF DATASCOPE = 'thisQuarter'
					AND P_PAGETYPE = 1
		THEN
				V_SQL_DATASCOPE := ' AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL    AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((  SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((  SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
				--季度
				--已完成
		ELSIF DATASCOPE = 'thisQuarter'
					AND P_PAGETYPE = 2
		THEN
				V_SQL_DATASCOPE := 'AND  PN.ACTUAL_END_DATE IS  NOT NULL AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((  SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((  SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
				--季度
				--季度应完成
		ELSIF DATASCOPE = 'thisQuarter'
					AND P_PAGETYPE = 3
		THEN
				V_SQL_DATASCOPE := '  AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((  SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((  SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
				--年度
				--已延误
		ELSIF DATASCOPE = 'thisYear'
					AND P_PAGETYPE = 1
		THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL  
			 AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) ';
				--年度
				--已完成
		ELSIF DATASCOPE = 'thisYear'
					AND P_PAGETYPE = 2
		THEN
				V_SQL_DATASCOPE := 'AND  PN.ACTUAL_END_DATE IS  NOT NULL  
				 AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH)  ';
				--年度
				--应完成
		ELSIF DATASCOPE = 'thisYear'
					AND P_PAGETYPE = 3
		THEN
				V_SQL_DATASCOPE := ' AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) ';
				--全部，没有时间限
				--已延误
		ELSIF DATASCOPE = 'thisAll'
					AND P_PAGETYPE = 1
		THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL ';
				--计划所有节点
		ELSIF DATASCOPE = 'thisAll'
					AND P_PAGETYPE = 2
		THEN
				V_SQL_DATASCOPE := ' AND   1=1 ';



		END IF;

		FOR ITEM_COMPANY_LIST IN CUR_COMPANY_LIST(IN_ORG_ID)
		LOOP
				/*DBMS_OUTPUT.PUT_LINE(ITEM_COMPANY_LIST.ORG_NAME || ',PARENT_ID' ||
        ITEM_COMPANY_LIST.PARENT_ID || ',ID:' ||
        ITEM_COMPANY_LIST.ID);*/
				V_COMPANY_LIST := V_COMPANY_LIST || '''' || ITEM_COMPANY_LIST.ID || '''' || ',';
		END LOOP;
		--   dbms_output.put_line(V_COMPANY_LIST);
		V_COMPANY_LIST := '(' || SUBSTR(V_COMPANY_LIST, 1, LENGTH(V_COMPANY_LIST) - 1) || ')';
		--     dbms_output.put_line(V_COMPANY_LIST);
		IF V_COMPANY_LIST = '()'
		THEN
				V_COMPANY_LIST := '(''' || IN_ORG_ID || ''')';
		END IF;
		--   dbms_output.put_line(V_COMPANY_LIST);
		V_SQL := V_SQL || 'SELECT PP.COMPANY_ID, PP.COMPANY_NAME AS COMPANY_NAME,PP.PROJ_name AS PROJ_NAME,PP.PLAN_NAME AS PLAN_NAME, PN.ID,PN.PROJ_PLAN_ID,PN.ORIGINAL_NODE_ID,CASE WHEN PN.IS_DISABLE = 0 THEN  PN.NODE_NAME ELSE  ''【禁用】'' || PN.NODE_NAME END AS NODE_NAME, PN.NODE_CODE, PN.NODE_LEVEL, PN.PROJ_STAGE, PN.MAIN_RESPONSIBILITY, PN.DUTY_DEPARTMENT, TO_CHAR(PN.PLAN_START_DATE, ''yyyy-MM-dd'') AS PLAN_START_DATE, TO_CHAR(PN.PLAN_END_DATE, ''yyyy-MM-dd'') AS PLAN_END_DATE, PN.IS_DISABLE, PN.COMPLETION_STANDARD, PN.COMPLETION_RESULTS_REMARK, TO_CHAR(PN.ACTUAL_END_DATE, ''yyyy-MM-dd'') AS ACTUAL_END_DATE
	, case 
 --未到期不亮灯
 WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
 --到期当天内完成反馈
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
 then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
	--到期1-5天内完成反馈
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
 then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
 --到期未反馈黄灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE)) >0
 THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>'' 
	--到期超过5天未反馈红灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(PLAN_END_DATE)) >5) THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' 
 ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END
	AS PLAN_STATUS,PN.ESTIMATE_END_DATE,  nps.CHARGE_PERSON
	FROM  pom_proj_plan_node pn 
LEFT JOIN pom_proj_plan pp ON pn.proj_plan_id = pp.id 
LEFT JOIN  SYS_PROJECT_STAGE ps on  ps.id=pp.proj_id
LEFT JOIN SYS_PROJECT pj on  ps.PROJECT_ID =pj.id
LEFT JOIN(  SELECT  NODE_ID, listagg(CHARGE_PERSON,'','') WITHIN GROUP (ORDER BY CHARGE_PERSON )  as CHARGE_PERSON
	FROM POM_NODE_CHARGE_PERSON 
	GROUP BY NODE_ID) nps on  nps.NODE_ID=pn.id
	WHERE  PP.PLAN_TYPE = ''项目主项计划''  AND APPROVAL_STATUS = ''已审核'' AND 1=1 AND PN.IS_DISABLE = 0 
	and  ((pp.proj_id =''' || IN_PROJID || ''' or pn.proj_plan_id=''' || IN_PROJID || '''  OR  pj.id=''' || IN_PROJID || ''' )
	OR PP.COMPANY_ID IN ' || V_COMPANY_LIST || ' ) ' || V_SQL_DATASCOPE || '  ORDER BY PN.PROJ_PLAN_ID,  PN.NODE_CODE';

		DBMS_OUTPUT.PUT_LINE(V_SQL);
		V_SQL_TOTAL := V_SQL_TOTAL || 'SELECT  TO_CHAR(COUNT(pn.ID))
	FROM  pom_proj_plan_node pn 
LEFT JOIN pom_proj_plan pp ON pn.proj_plan_id = pp.id 
LEFT JOIN  SYS_PROJECT_STAGE ps on  ps.id=pp.proj_id
LEFT JOIN SYS_PROJECT pj on  ps.PROJECT_ID =pj.id
LEFT JOIN(  SELECT  NODE_ID, listagg(CHARGE_PERSON,'','') WITHIN GROUP (ORDER BY CHARGE_PERSON )  as CHARGE_PERSON
	FROM POM_NODE_CHARGE_PERSON 
	GROUP BY NODE_ID) nps on  nps.NODE_ID=pn.id
	WHERE  PP.PLAN_TYPE = ''项目主项计划''  AND APPROVAL_STATUS = ''已审核'' AND 1=1 
	and  ((pp.proj_id =''' || IN_PROJID || ''' or pn.proj_plan_id=''' || IN_PROJID || '''  OR  pj.id=''' || IN_PROJID || ''' )
	OR PP.COMPANY_ID IN ' || V_COMPANY_LIST || ' ) ' || V_SQL_DATASCOPE || '  ORDER BY PN.PROJ_PLAN_ID,  PN.NODE_CODE';

		--DBMS_OUTPUT.PUT_LINE(V_SQL_TOTAL);
		EXECUTE IMMEDIATE V_SQL_TOTAL
				INTO TOTAL;
		--   DBMS_OUTPUT.PUT_LINE(TOTAL);
		OPEN ITEMS FOR V_SQL;
END P_POM_PLAN_PERFROM_DYNAMIC;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_PMP_NODE_COMP_RATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_PMP_NODE_COMP_RATE" (
     tabType VARCHAR2,
     planType VARCHAR2,
     companyId VARCHAR2,
     nodeLevel VARCHAR2,
     currentcompanyid   IN                 VARCHAR2,--当前用户的公司
     userid             IN                 VARCHAR2,--用户id用于过滤关注的任务
     currentstationid   IN                 VARCHAR2,---当前用户的岗位
     currentdeptid      IN                 VARCHAR2,---当前用户的部门
     bizcode            IN                 VARCHAR2,---权限code
     pageRows INTEGER,
     pageIndex INTEGER,
     nodeList  OUT SYS_REFCURSOR
) IS 
v_condition varchar2(4000);
v_sql clob;
v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN 
v_condition:= ' AND 1=1';
IF(tabType is not null) THEN
    IF(tabType='超期任务')
        then  v_condition:=' and to_char(node.plan_end_date, ''yyyy-MM-dd'') <  to_char(sysdate, ''yyyy-MM-dd'') and node.actual_end_date is null order by node.plan_end_date desc'; 
    ELSIF(tabType='已完成')
        then  v_condition:=' and node.actual_end_date is not null order by node.actual_end_date desc'; 
    END IF;
END IF;

--调用数据权限验证存储过程
    p_sys_auth_data_rule_spid(userid => userid, stationid => currentstationid, deptid => currentdeptid, companyid => currentcompanyid
    , bizcode => bizcode, data_auth_spid => v_spid);

v_sql:='SELECT *
  FROM (SELECT tt.*, ROWNUM AS rowno
    FROM (  
        select 
            node.id as "nodeId",
            node.original_node_id as "nodeOriginalId",
            node.node_name||''【''|| nvl(proj.project_name, projs.stage_full_name)  ||''】''  as "nodeName",
			plan.plan_type as "nodePlanType",
            case 
                when '''||tabType||'''=''超期任务'' then to_char(node.plan_end_date, ''yyyy-MM-dd'')
                when '''||tabType||'''=''已完成'' then to_char(node.actual_end_date, ''yyyy-MM-dd'')
            end  as "nodeTime",
            case 
                when (to_char(node.plan_end_date, ''yyyy-MM-dd'') <  to_char(sysdate, ''yyyy-MM-dd'') and node.actual_end_date is null) then ''已超期''
                when (node.actual_end_date is not null) then ''已完成''
            end  as "nodeStatus"
        from pom_proj_plan_node node
        left join pom_proj_plan plan on node.proj_plan_id = plan.id
        left join sys_project proj on plan.proj_id = proj.id 
        left join sys_project_stage projs on plan.proj_id = projs.id
        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=proj.id or tal.orgid=plan.company_id or tal.orgid = projs.id
        where tal.orgid is not null and  plan_type='''||planType||''' and plan.company_id in (select id from sys_business_unit unit start with unit.id='''||companyId||''' connect by prior unit.id=unit.parent_id) and node.node_level = '''||nodeLevel||''' and plan.approval_status = ''已审核'''||v_condition||') tt
    WHERE ROWNUM <= '||pageRows||' * '||pageIndex||') table_alias
 WHERE table_alias.rowno >= '||pageRows||' * ('||pageIndex||'-1) + 1';
--dbms_output.put_line(v_sql);
open nodeList for v_sql;

END P_POM_PMP_NODE_COMP_RATE;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_PORTAL_ALREADY_MSG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_PORTAL_ALREADY_MSG" (
    bizid  in varchar2,
    info     OUT      SYS_REFCURSOR--消息集合
) IS
--门户推送数据，发送微信、短信消息记录获取
--作者：陈丽
--日期：2020/02/13
BEGIN
    OPEN info FOR SELECT
                ------------------------------------------------------------基础必须信息             
                      '71313f018a35f3a558166cba7599b5d6' AS "systemId",--系统id
                      'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "appid",--应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段，
                 ------------------------------------------------------------业务变动必须信息   
                      'bizid' AS "bizKey",--业务id
                       'tjWeChat,tjSMS' AS "msgChannel",--使用消息渠道 多个，逗号分隔   tjWeChat：铁建微信,tjSMS：铁建短信
                     ------------------------------------------------------------短信必须参数
                      '40010' AS "smsTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID
                      '["1","2","3","4"]' AS "smsParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》说明{1}为您的登录验证码，请于{2}分钟内填写，如非本人操作，请忽略本短信。
                      '13896186104' as "mobile",--短信接收人电话
                      ------------------------------------------------------------微信必须参数
                      '40011' AS "wechatTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID
                      '["1","2","3","4"]' AS "wechatParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》说明{1}为您的登录验证码，请于{2}分钟内填写，如非本人操作，请忽略本短信。
                       '///' AS "wechatJumplinkUrl",--微信打开地址，程序调用发消息前需要编码
                      'v-xufeng' AS "recipientAccount",--接收人usercode如：a-xiexuhua
                 ------------------------------------------------------------消息记录方追溯信息
                       '部门月度计划流程预警' AS "title",--消息标题
                      'v-xufeng' AS "senderAccount",--发送人usercode如：a-xiexuhua
                      '月度计划' AS "bizSourceCategory",--业务所属类别=》 （由业务系统自定义，方便根据业务回溯，同一类别下有很多个类似业务，如月度计划）
                      '预警消息' AS "bizMsgCategory"--消息所属类别=》 （由业务系统自定义，方便根据业务回溯，同一业务主键，有多个分类，如预警消息，提醒消息）
                  FROM
                      dual;

END p_pom_portal_already_msg;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_PORTAL_MSG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_PORTAL_MSG" (
    messagetype   OUT           VARCHAR2,     --0:门户终端消息都推送，1：只推送门户，2：只推送短信或微信
    info          OUT           SYS_REFCURSOR--消息集合
) IS
BEGIN
    messagetype := 0;
    OPEN info FOR
    
--    --超期任务提醒
--				SELECT 0 AS "msgType", A.ORIGINAL_NODE_ID AS "taskId", B1.USER_ACCOUNT AS "ownerName", 'v-xufeng' AS "creatorName",
--							 'http://pom.crccre.cn/pom/pom/middle?originalUrl=' ||
--								URL_ENCODE('http://pom.crccre.cn/pom/pom/mission-center-feedback/my-responsible-task?cancelType=0' || CHR(38) || 'id=' || A.PROJ_PLAN_ID || CHR(38) || 'feedbackNodeId=' || A.ID ||
--													 CHR(38) || 'feedbackNodeOriginalId=' || A.ORIGINAL_NODE_ID || CHR(38) || 'nodeSourcePlanType=1') AS "pcUrl", '' AS "mobileUrl", SYSDATE AS "created",
--							 TRUNC(SYSDATE) + 1 AS "expireTime", '【节点超期预警】【' || A.PROJ_NAME || '-' || A.PLAN_TYPE || '-' || A.NODE_NAME || '】超期' || TO_CHAR(TRUNC(SYSDATE) - A.PLAN_END_DATE) || '天预警' AS "taskName",
--							 '计划运营' AS "typeName",1 AS "priority", '' AS "remark"
--, 'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "sourceAppId",meg.MESSAGE_MSG_TYPE AS "messageMsgType"
--				FROM   V_POM_NODE_DT A
--				LEFT   JOIN SYS_ROLE_USER_RELATION_RESULT B1
--				ON     B1.DEPT_ID = A.DUTY_DEPARTMENT_ID AND
--							 B1.VIRTUAL_GROUP_NAME = '部门计划专员'
--				LEFT JOIN SYS_MESSAGE_CENTER meg
--				ON meg.TASK_ID=A.id AND meg.CREATED-SYSDATE=0
--				WHERE  A.FINISH_NO_STATUS_TYPE = '超期未完成' AND
--							 NOT EXISTS (SELECT 1
--								FROM   SYS_MESSAGE_CENTER_PUSH_RECORD P
--								WHERE  P.RESPONSE_RESULTS LIKE '%{"errcode":0%' AND
--											 TRUNC(SYSDATE) - TRUNC(P.REQUEST_TIME) = 0 AND
--											 A.ID = P.TASK_ID AND
--											 B1.USER_ACCOUNT = P.OWNER_NAME) AND
--							 B1.USER_ACCOUNT IS NOT NULL AND b1.USER_ACCOUNT = 'zhangzhuohan';

     SELECT
            ------------------------------------------------------------基础配置数据【必须】（集团门户网站和设备消息都必须配置）------------------------------------------------------------ 
                      'v-xufeng'   AS "senderAccount",--发送人usercode如：a-xiexuhua,---门户网站的creatorName
                      B1.USER_ACCOUNT       AS "recipientAccount",--接收人usercode如：a-xiexuhua--门户网站的ownerName
                      'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "appid",--应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段---门户网站的sourceAppId
                      '71313f018a35f3a558166cba7599b5d6' AS "systemId",--系统id
                      A.ORIGINAL_NODE_ID||B1.USER_ACCOUNT   AS "bizKey",--业务id--门户网站的taskId
                      '超期预警' AS "bizMsgCategory",--消息所属类别=》 （由业务系统自定义，方便根据业务回溯，同一业务主键，有多个分类，如预警消息，提醒消息）
            ------------------------------------------------------------设备消息配置开始------------------------------------------------------------ 
            ------------------------------------------------------------【短信微信必须】基础信息
                      'tjSMS,tjWeChat' AS "msgChannel",--使用消息渠道 多个，逗号分隔   tjWeChat：铁建微信,tjSMS：铁建短信
                        ------------【短信必须】参数
                      '400013' AS "smsTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID  
                      --{1}您好，您负责的任务“{2}”已超期{3}天，请及时到门户网站查看待办并在《计划管理系统》中反馈任务进度{4}。
                      '["'
                      || B1.USER_NAME
                      || '","'
                      || A.PROJ_NAME || '-' || A.PLAN_TYPE || '-' || A.NODE_NAME
                      || '","'
                      || TO_CHAR(TRUNC(SYSDATE) - A.PLAN_END_DATE) 
                      || '",""]' AS "smsParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
                      MOBILE_PHONE   AS "mobile",--短信接收人电话
                        ------------【微信必须】参数
                      '400013' AS "wechatTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID
                      '["'
                      || B1.USER_NAME
                      || '","'
                      || A.PROJ_NAME || '-' || A.PLAN_TYPE || '-' || A.NODE_NAME
                      || '","'
                      || TO_CHAR(TRUNC(SYSDATE) - A.PLAN_END_DATE) 
                      || '",""]' AS "wechatParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
                      'http://pom.crccre.cn/pom/wfi/bridge?jumpUrl=http%3a%2f%2fpom.crccre.cn%2fpom-h5%2fwfi%2fhow-to-read%3FinformationId%3D1786238shizebin%26bizUrl%3D'
                      || url_encode('http://pom.crccre.cn/pom-h5/pom/task-details?feedbackNodeId='||A.ORIGINAL_NODE_ID||'%26nodeSourcePlanType=KEY_NODE%26feedbackNodeOriginalId='||A.ORIGINAL_NODE_ID||'')||'&remoteUrl=aHR0cDovL3BvbS5jcmNjcmUuY24vcG9t'  AS "wechatJumplinkUrl",--微信打开地址，程序调用发消息前需要编码
                        ------------消息记录方便追溯信息
                      '【节点超期预警】【' || A.PROJ_NAME || '-' || A.PLAN_TYPE || '-' || A.NODE_NAME || '】超期' || TO_CHAR(TRUNC(SYSDATE) - A.PLAN_END_DATE) || '天预警' AS "title",--消息标题
                      '【节点超期预警】【' || A.PROJ_NAME || '-' || A.PLAN_TYPE || '-' || A.NODE_NAME || '】超期' || TO_CHAR(TRUNC(SYSDATE) - A.PLAN_END_DATE) || '天预警' AS "bizSourceCategory",--业务所属类别=》 （由业务系统自定义，方便根据业务回溯，同一类别下有很多个类似业务，如月度计划）
            ------------------------------------------------------------设备消息配置结束------------------------------------------------------------ 
            ------------------------------------------------------------集团门户网站信息------------------------------------------------------------ 
                --taskid	是	String	任务ID---------------------共有门户网站的1、插入待办/2、插入已办taskid，3、插入待阅/4、插入已阅informationid，5、插入我的关注的informationid
                --creatorname	是	String	创建人
                --ownername	是	String	拥有人
                --sourceAppId	是	String	推送应用的appId
                      0 "portalMsgType", --集团门户网站消息类型（0：待办,1:已办，10：待阅，11:已阅，20：关注）--已办，需要先根据bizKey删除待办，已阅接口需要根据bizKey调用集团待阅删除接口
                      'http://pom.crccre.cn/pom/pom/middle?originalUrl=' ||
								URL_ENCODE('http://pom.crccre.cn/pom/pom/mission-center-feedback/my-responsible-task?cancelType=0' || CHR(38) || 'id=' || A.PROJ_PLAN_ID || CHR(38) || 'feedbackNodeId=' || A.ID ||
													 CHR(38) || 'feedbackNodeOriginalId=' || A.ORIGINAL_NODE_ID || CHR(38) || 'nodeSourcePlanType=1') "url",--url	是	String	应用系统的url地址
                    --http://pom.crccre.cn/pom/wfi/bridge?jumpUrl=http%3A%2F%2Fpom.crccre.cn%2Fpom-h5%2Fwfi%2Fhow-to-read%3FinformationId%3D1786238shizebin%26bizUrl%3Dhttp%253A%252F%252Fpom.crccre.cn%252Fpom-h5%252Fwfi%252Fprocess-info%253FrootProcInstId%253D288110%2526item_id%253Dd6c370aa-ddd6-40b9-95de-6fc25fdef1f0%2526actInstID%253D1990892%2526procInstId%253D288110%2526workItemId%253D1786238&remoteUrl=aHR0cDovL3BvbS5jcmNjcmUuY24vcG9t
                      'http://pom.crccre.cn/pom/wfi/bridge?jumpUrl=http%3a%2f%2fpom.crccre.cn%2fpom-h5%2fwfi%2fhow-to-read%3FinformationId%3D1786238shizebin%26bizUrl%3D'
                      || url_encode('http://pom.crccre.cn/pom-h5/pom/task-details?feedbackNodeId='||A.ORIGINAL_NODE_ID||'%26nodeSourcePlanType=KEY_NODE%26feedbackNodeOriginalId='||A.ORIGINAL_NODE_ID||'')||'&remoteUrl=aHR0cDovL3BvbS5jcmNjcmUuY24vcG9t' as "mobileUrl",--mobileUrl	否	String	应用系统的手机端url地址
                       '【节点超期预警】【' || A.PROJ_NAME || '-' || A.PLAN_TYPE || '-' || A.NODE_NAME || '】超期' || TO_CHAR(TRUNC(SYSDATE) - A.PLAN_END_DATE) || '天预警' as "taskname",--taskname	是	String	任务名称，等于3、插入待阅/4、插入已阅informationname;等于插入关注的attentionname
                      '计划运营' "typename",--typename	是	String	任务类型
                      A.ORIGINAL_NODE_ID||B1.USER_ACCOUNT         "remark",--remark	否	String	备注

              ----------------------------------------------
              -----除【关注外特有】
                      SYSDATE          "expiretime",--expiretime	否	String	过期时间，格式yyyy-MM-dd HH:mm:ss-----过期时间，除关注都有
                      1 "priority"--priority	否	Integer	优先级，除关注都有
                      FROM   V_POM_NODE_DT A
				LEFT   JOIN SYS_ROLE_USER_RELATION_RESULT B1
				ON     B1.DEPT_ID = A.DUTY_DEPARTMENT_ID AND
							 B1.VIRTUAL_GROUP_NAME = '部门计划专员'
				LEFT JOIN SYS_MESSAGE_CENTER meg
				ON meg.TASK_ID=A.id AND meg.CREATED-SYSDATE=0
                left join sys_user u on  B1.USER_ACCOUNT=u.USER_CODE
				WHERE  A.FINISH_NO_STATUS_TYPE = '超期未完成' AND
							 NOT EXISTS (SELECT 1
								FROM   SYS_MESSAGE_CENTER_PUSH_RECORD P
								WHERE  P.RESPONSE_RESULTS LIKE '%{"errcode":0%' AND
											 TRUNC(SYSDATE) - TRUNC(P.REQUEST_TIME) = 0 AND
											 A.ID = P.TASK_ID AND
											 B1.USER_ACCOUNT = P.OWNER_NAME)
                                             AND
							 B1.USER_ACCOUNT IS NOT NULL 
                             --AND b1.USER_ACCOUNT = 'zhangzhuohan'
                             ;

END p_pom_portal_msg;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_PREDICT_DELAY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_PREDICT_DELAY" (planType in VARCHAR2
,dataScope in VARCHAR2
,searchKey in VARCHAR2
,orgId  in VARCHAR2
,currentDelay OUT sys_refcursor)
AS
BEGIN
open currentDelay for
SELECT
    p.COMPANY_NAME as  "orgName",
    proj_name as "projName",
    node_name as "nodeName",
    '' as "projOpenUrl",
    '' as "nodeOpenUrl",
    ROUND(TO_NUMBER(plan_end_date-sysdate)) as "delayDays"
FROM
    pom_proj_plan_node n
    left join
    pom_proj_plan p  on  n.proj_plan_id=p.id where proj_name is not null;


END p_pom_predict_delay;




/
--------------------------------------------------------
--  DDL for Procedure P_POM_PROJ_PLAN_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_PROJ_PLAN_DATA" (
    condition     IN            VARCHAR2,--输入变量;项目或部门id   专项计划传入部门id 其他计划传入项目id
    companyid     IN            VARCHAR2,--当前用户公司
    stationid     IN            VARCHAR2,---当前用户的岗位
    deptid        IN            VARCHAR2,---当前用户的部门
    bizcode       IN            VARCHAR2,---权限code
    userid        IN            VARCHAR2,---当前用户id
    pageindex     IN            INT,
    search1       IN            VARCHAR2, --输入变量 查询条件
    pagesizes     IN            INT,
    currenttype   IN            INT,--
    plantype      IN            VARCHAR2, --计划类型
    items         OUT           SYS_REFCURSOR,
    total         OUT           INT
  --  tabledata          OUT           SYS_REFCURSOR
) IS
--专项计划，可研计划，全盘开发计划，项目主项计划列表配置
--作者：鲜晓勇
--日期：2019/12/11

--更改：纪海龙
--日期：2020/4/14

    v_sql              CLOB;
    v_sql_exec         CLOB;
    v_spid             VARCHAR2(200);---数据验证spid
    v_where            VARCHAR2(4000);
    testmsg            NVARCHAR2(4000);
    v_maintable        NVARCHAR2(100);
    v_subtable         NVARCHAR2(100);
    v_middlesql        VARCHAR2(4000);   --非专项计划使用。用于区分调整表与计划表字段差异的拼接
    v_middlesql2       VARCHAR2(4000);
    quarantine_rule   VARCHAR2(50) :='';
    v_auth_sql         VARCHAR2(4000) :=' where 1=1';
    v_isneed_proj      VARCHAR2(200);  --是否需要proj进行排序
BEGIN
     OPEN items FOR select ''||companyid||'' as companyid,
    ''||stationid||'' as  stationid,
    ''||deptid||'' as  deptid,
     ''||condition||'' as  condition,
      ''||userid||'' as  userid
    from dual;

----------------------------------------------------统一解析
    testmsg := 'condition:'
               || condition
               || '；pageindex:'
               || pageindex
               || '；pagesizes:'
               || pagesizes
               || '；currenttype:'
               || currenttype;

    BEGIN
        total := 1000;


    --执行数据权限存储过程。拿到零时表id 用户连临时表鉴权
 --调用查询数据权限的存储过程,返回spid 
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => stationid,
            DEPTID => deptid,
            COMPANYID => companyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
--        OPEN tabledata FOR select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = v_spid;
       -- OPEN tabledata FOR select * from SYS_PROJECT_STAGE sps   inner join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') ta on sps.project_id=ta.orgid;
        --拼接权限验证sql
        v_auth_sql:=' left join SYS_PROJECT_STAGE projs on pp.proj_id=projs.id
                    --关联权限表结果
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') org
                    on (case when projs.id is not null then projs.PROJECT_ID else pp.proj_id end)=org.orgId
                    --左连接权限字段为空表示没有权限
                    where org.orgId is not null ';
         -- v_auth_sql:=' inner join SYS_PROJECT_STAGE sps on pp.proj_id=sps.id inner join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') ta on sps.project_id=ta.orgid or pp.proj_id=ta.orgid where ta.orgid is not null '; 

    IF ( plantype <> '专项计划' ) THEN 
--      IF(quarantine_rule='集团')THEN
--        v_auth_sql:=v_auth_sql||' proj_id='''||companyid||'''';
--    END IF;

          v_isneed_proj := ',a.proj_name';

    --项目主项计划，可研计划，标准节点计划，全盘开发计划
        IF ( currenttype = 0 ) THEN  
    --当前使用版本
            v_maintable := 'POM_PROJ_PLAN ';
            v_subtable := 'POM_PROJ_PLAN_NODE';
            v_middlesql := ' ps.cnt1 as finish_count,
    ps.cnt2 as not_ebd_count,
    ps.cnt3 as template_node_count,
    ps.cnt4 as user_add_node_count,
    ps.cnt6-ps.cnt7 as valid_node_count,
    ps.cnt6 as node_count,
    ps.cnt7 as disable_count,'
            ;
            v_middlesql2 := ' left join(   select proj_plan_id,
    sum(case when n.ACTUAL_END_DATE is not null and n.IS_DISABLE=0 then 1  else 0 end) as cnt1, --已完成
    sum(case when n.ACTUAL_END_DATE is null and n.IS_DISABLE=0  then 1 else 0 end) as cnt2,--未完成
    sum(case when n.TEMPLATE_NODE_ID is not null then 1 else 0 end) as cnt3,--模板节点
    sum(case when n.STANDARD_NODE_ID is null and n.TEMPLATE_NODE_ID is null then 1 else 0 end) as cnt4,--新增节点
    sum(case when n.TEMPLATE_NODE_ID is not null then 1 else 0 end) + sum(case when n.STANDARD_NODE_ID is null and n.TEMPLATE_NODE_ID is null then 1 else 0 end) as cnt5,
    count(*) as cnt6,--任务节点
    sum(case when n.IS_DISABLE=1 then 1 else 0 end) cnt7
    from '
                            || v_subtable
                            || '  n GROUP by proj_plan_id )ps on pp.id=ps.proj_plan_id '||v_auth_sql;


            v_where := ' and (Approval_Status = ''已审核'' or (Approval_Status != ''已审核'' and plan_version =''1''))and plan_type='''
                       || plantype
                       || '''  and (plan_name like ''%'
                       || search1
                       || '%'' or creator like ''%'
                       || search1
                       || '%'')';
            IF(condition!='默认')THEN
               v_where:=v_where||' and COMPANY_ID='''
                       || condition
                       || '''';
            END IF;
        ELSE 
    --历史调整版本
            v_maintable := 'POM_PROJ_PLAN_HISTORY';
            v_subtable := 'POM_PROJ_PLAN_NODE_HISTORY';
            v_where := ' and COMPANY_ID='''
                       || condition
                       || ''' and plan_type='''
                       || plantype
                       || '''  and (plan_name like ''%'
                       || search1
                       || '%'' or creator like ''%'
                       || search1
                       || '%'')';

            v_middlesql := ' ps.cnt6 as node_count,';
    --暂时未查询 调整新增数量，调整修改数量，调整 禁用数量
            v_middlesql2 := ' left join(   select proj_plan_id,
    count(*) as cnt6 --任务节点
    from '
                            || v_subtable
                            || '  n GROUP by proj_plan_id )ps on pp.id=ps.proj_plan_id '||v_auth_sql;
        END IF;

        v_sql := 'SELECT
    rownum as rowno,
    pp.id as id,
    original_plan_id,
    template_id,
    plan_name,
    plan_version,
     (''v'' || to_char(plan_version,''0.0'')) verson,
    company_id,
    company_name,
    proj_id,
    proj_name,
    plan_type,
    approval_status,
    approver_id,
    to_char(approval_time,''yyyy-MM-dd'') as approval_time,
    other_remark,
    to_char(created,''yyyy-MM-dd'') as created,
     case plan_version when plan_version then (plan_version-1) end as adjuest_Number,
    creator_id,
    creator,
    to_char(modified,''yyyy-MM-dd'') as modified,
    modifier_id,
    modifier,
    adjust_source_id,
    adjust_subject,
    adjust_remark, 
    '
                 || v_middlesql
                 || ' approver FROM '
                 || v_maintable
                 || ' pp '
                 || v_middlesql2
                 || v_where
                 || '' ;

    ELSE  
    --专项计划
        IF ( currenttype = 0 ) THEN
--          IF(quarantine_rule='集团')THEN
--             v_auth_sql:=v_auth_sql||' and (company_id='''||companyid||''' or department_id='''||deptid||''')';
--          END IF;

          v_isneed_proj := '';

          --当前使用版本
            v_where := ' and DEPARTMENT_ID='''
                       || condition
                       || ''' and (plan_name like ''%'
                       || search1
                       || '%'' or creator like ''%'
                       || search1
                       || '%'')';
            v_maintable := 'POM_SPECIAL_PLAN';
            v_subtable := 'POM_SPECIAL_PLAN_NODE';
        ELSE
            --历史调整版本
            v_where := ' and DEPARTMENT_ID='''
                       || condition
                       || ''' and (plan_name like ''%'
                       || search1
                       || '%'' or creator like ''%'
                       || search1
                       || '%'')';

            v_maintable := 'POM_SPECIAL_PLAN_HIST';
            v_subtable := 'POM_SPECIAL_PLAN_NODE_HIST';
        END IF;

        v_sql := '
    select 
    distinct
    rownum as rowno,
    ps.id,
    template_id,
    plan_name,
    plan_subclass,
    (''v'' || to_char(plan_version,''0.0'')) verson,
    company_id,
    company_name,
    department_id,
    department_name,
    remark,
    approval_status,
    approver_id,
    to_char(approval_time,''yyyy-MM-dd'') as approval_time,
    to_char(created,''yyyy-MM-dd'') as created,
    creator_id,
    creator,
    to_char(modified,''yyyy-MM-dd'') as modified,
    modifier_id,
    modifier,
    approver,
    original_plan_id,
    plan_version,
    adjust_theme,
    adjust_remark,
    is_delete,
    case plan_version when plan_version then (plan_version-1) end as adjuest_Number,
    case when  pn.cnt1 is null then 0 else pn.cnt1 end as finish_count,
    case when  pn.cnt2 is null then 0 else pn.cnt2 end as not_ebd_count,
    case when  pn.cnt3 is null then 0 else pn.cnt3 end as node_count 
    FROM '
                 || v_maintable
                 || '
     ps left join ( 
    SELECT
    plan_id,
     sum(case  when n.ACTUAL_END_DATE is not null then 1 else 0 end) as cnt1,--完成数量
     sum(case  when n.ACTUAL_END_DATE is null then 1 else 0 end) as cnt2,--未数量,
         count(*) as cnt3
FROM
    '
                 || v_subtable
                 || ' n 
    group by plan_id) pn on ps.id=pn.plan_id  where 1=1 '
                 || v_where
                 || '';

    END IF;             


v_sql_exec := '
            select s1.order_hierarchy_code as sort_code, a.* from ( '
                  || v_sql
                  || ' AND rownum <= '
                  || pageindex * pagesizes
                  || ' ) a left join SYS_BUSINESS_UNIT s1 on a.company_id = s1.id
                  where a.rowno >= '
                  || pagesizes * ( pageindex - 1 )
                  || ' order by sort_code '
                  || v_isneed_proj;


    dbms_output.put_line(v_sql_exec);
----获取总条数
    EXECUTE IMMEDIATE 'SELECT count(rowno) from('
                      || v_sql_exec
                      || ') a '
    INTO total;

-- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
    OPEN items FOR v_sql_exec;

EXCEPTION
    WHEN OTHERS THEN
        testmsg := sqlerrm || testmsg;
        OPEN items FOR SELECT
                           '失败'
                       FROM
                           dual;

        dbms_output.put_line(sqlerrm);
        end;
END p_pom_proj_plan_data;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_PROJ_PLAN_DTL_CONDITION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_PROJ_PLAN_DTL_CONDITION" (
    userid                 IN                     VARCHAR2,--用户id
    planid                 IN                     VARCHAR2,--计划id
    conditiontype          IN                     VARCHAR2,--条件类型0:节点级别1：公司ID
    condition              IN                     VARCHAR2,--条件：公司ID；节点级别
    total                  out              number,
    pageindex     IN            INT,
    pagesizes     IN            INT,
    items           out SYS_REFCURSOR      --计划明细一览表
) AS
--项目主项计划监控，详情页 ：明细
--作者：叶丁荣
--日期：2020/04/15
v_sql_exec   CLOB;
v_sql_exec_paging  CLOB;
BEGIN
----计划明细一览表
total:=100;
    IF conditiontype='0' THEN
      v_sql_exec:= '
        SELECT   
          rownum,
         a.PROJ_ID AS "PROJ_ID"
         ,a.PROJ_NAME AS "PROJ_NAME"
         ,a.PROJ_PLAN_ID AS "PROJ_PLAN_ID"
         ,a.NODE_ID AS "NODE_ID"
         ,a.PLAN_ID AS "PLAN_ID"
         ,a.PLAN_TYPE AS "PLAN_TYPE"
         ,a.ORIGINAL_NODE_ID AS "ORIGINAL_NODE_ID"
         ,CASE a.WARNING_STATUS 
         WHEN ''红灯'' THEN 
            ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
         WHEN ''绿灯'' THEN
            ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
         WHEN ''黄灯'' THEN
            ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
        ELSE NULL
         END AS "WARNING_STATUS"
         ,case when b.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as "IS_UN_WATCH"
        ,case when a.ACTUAL_END_DATE is null then ''催办'' else null end as "HASTEN"
         ,a.NODE_CODE AS "NODE_CODE"
         ,a.NODE_NAME AS "NODE_NAME"
         ,a.NODE_LEVEL AS "NODE_LEVEL"
         ,a.DUTY_DEPARTMENT AS "DUTY_DEPARTMENT"
         ,a.DUTY_MANS AS "DUTY_MANS"
         ,a.FINISH_STATUS AS "FINISH_STATUS"
         ,a.STANDARD_SCORE AS "STANDARD_SCORE"
         ,a.PLAN_START_DATE AS "PLAN_START_DATE"
         ,a.PLAN_END_DATE AS "PLAN_END_DATE"
         ,a.ACTUAL_START_DATE AS "ACTUAL_START_DATE"
         ,a.ACTUAL_END_DATE AS "ACTUAL_END_DATE"
         ,a.ESTIMATE_END_DATE AS "ESTIMATE_END_DATE"
         ,a.PROCESS_FEED_BACK_CON AS "PROCESS_FEED_BACK_CON"
         ,a.FINISH_FEED_BACK_CON AS "FINISH_FEED_BACK_CON"
         ,a.OVERDUE_FEED_BACK_CON AS "OVERDUE_FEED_BACK_CON"
         ,a.NODE_FLAG AS "NODE_FLAG"
         ,a.ESTIMATE_BEYOND_NODE_FLAG AS "ESTIMATE_BEYOND_NODE_FLAG"
         ,a.COMPLETION_STANDARD AS "COMPLETION_STANDARD"
         ,a.COMPLETION_RESULTS_REMARK AS "COMPLETION_RESULTS_REMARK"
         --,nvl(b.IS_UN_WATCH,1) as  "IS_UN_WATCH"
         ,to_char(a.PLAN_START_DATE, ''YYYY-mm-dd hh24:mi:ss'') as "PLAN_START_TIME"
         ,to_char(a.PLAN_END_DATE, ''YYYY-mm-dd hh24:mi:ss'') as "PLAN_END_TIME"
         ,to_char(a.ACTUAL_START_DATE, ''YYYY-mm-dd hh24:mi:ss'') as "ACTUAL_START_TIME"
         ,to_char(a.ACTUAL_END_DATE, ''YYYY-mm-dd hh24:mi:ss'') as "ACTUAL_END_TIME"
         ,to_char(a.ESTIMATE_END_DATE, ''YYYY-mm-dd hh24:mi:ss'') as "ESTIMATE_END_TIME"
          ,b.UN_WATCH_TIME  ,b.WATCH_TIME  
      FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID='''||userid||''' --and   b.WATCH_TIME is  not   null
      WHERE     a.PLAN_ID='''||planid||''' AND a.NODE_LEVEL='''||condition||'''    ' ;
    ELSE
   v_sql_exec:= '
         SELECT   
         rownum,
         a.PROJ_ID AS "PROJ_ID"
         ,a.PROJ_NAME AS "PROJ_NAME"
         ,a.PROJ_PLAN_ID AS "PROJ_PLAN_ID"
         ,a.NODE_ID AS "NODE_ID"
         ,a.PLAN_ID AS "PLAN_ID"
         ,a.PLAN_TYPE AS "PLAN_TYPE"
         ,a.ORIGINAL_NODE_ID AS "ORIGINAL_NODE_ID"
         ,CASE a.WARNING_STATUS 
         WHEN ''红灯'' THEN 
            ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
         WHEN ''绿灯'' THEN
            ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
         WHEN ''黄灯'' THEN
            ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
        ELSE NULL
         END AS "WARNING_STATUS"
         ,case when b.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as "IS_UN_WATCH"
        ,case when a.ACTUAL_END_DATE is null then ''催办'' else null end as  "HASTEN"
         ,a.NODE_CODE AS "NODE_CODE"
         ,a.NODE_NAME AS "NODE_NAME"
         ,a.NODE_LEVEL AS "NODE_LEVEL"
         ,a.DUTY_DEPARTMENT AS "DUTY_DEPARTMENT"
         ,a.DUTY_MANS AS "DUTY_MANS"
         ,a.FINISH_STATUS AS "FINISH_STATUS"
         ,a.STANDARD_SCORE AS "STANDARD_SCORE"
         ,a.PLAN_START_DATE AS "PLAN_START_DATE"
         ,a.PLAN_END_DATE AS "PLAN_END_DATE"
         ,a.ACTUAL_START_DATE AS "ACTUAL_START_DATE"
         ,a.ACTUAL_END_DATE AS "ACTUAL_END_DATE"
         ,a.ESTIMATE_END_DATE AS "ESTIMATE_END_DATE"
         ,a.PROCESS_FEED_BACK_CON AS "PROCESS_FEED_BACK_CON"
         ,a.FINISH_FEED_BACK_CON AS "FINISH_FEED_BACK_CON"
         ,a.OVERDUE_FEED_BACK_CON AS "OVERDUE_FEED_BACK_CON"
         ,a.NODE_FLAG AS "NODE_FLAG"
         ,a.ESTIMATE_BEYOND_NODE_FLAG AS "ESTIMATE_BEYOND_NODE_FLAG"
         ,a.COMPLETION_STANDARD AS "COMPLETION_STANDARD"
         ,a.COMPLETION_RESULTS_REMARK AS "COMPLETION_RESULTS_REMARK"
         --,nvl(b.IS_UN_WATCH,1) as  "IS_UN_WATCH"
         ,to_char(a.PLAN_START_DATE, ''YYYY-mm-dd hh24:mi:ss'') as "PLAN_START_TIME"
         ,to_char(a.PLAN_END_DATE, ''YYYY-mm-dd hh24:mi:ss'') as "PLAN_END_TIME"
         ,to_char(a.ACTUAL_START_DATE, ''YYYY-mm-dd hh24:mi:ss'') as "ACTUAL_START_TIME"
         ,to_char(a.ACTUAL_END_DATE, ''YYYY-mm-dd hh24:mi:ss'') as "ACTUAL_END_TIME"
         ,to_char(a.ESTIMATE_END_DATE, ''YYYY-mm-dd hh24:mi:ss'') as "ESTIMATE_END_TIME"
          ,b.UN_WATCH_TIME  ,b.WATCH_TIME  
      FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID='''||userid||''' --and   b.WATCH_TIME is  not   null
      WHERE     a.PLAN_ID='''||planid||''' AND a.DUTY_DEPARTMENT='''||condition||'''  ' ;
    END IF;


     v_sql_exec_paging := '
select f.* from ( '
                             || v_sql_exec
                             || '  AND rownum <= '
                             || pageindex * pagesizes 
                             ||' order by node_code asc'|| ' ) f where rownum >= '
                             || pagesizes * ( pageindex - 1 )
                             || '';
    dbms_output.put_line(v_sql_exec_paging);
    EXECUTE IMMEDIATE 'SELECT count(rownum) from('
                          || v_sql_exec
                          || ') a '
        INTO total;
      OPEN items FOR v_sql_exec_paging;                       
END p_pom_proj_plan_dtl_condition;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_PUSH_WATCH_MESSAGE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_PUSH_WATCH_MESSAGE" (bizId in varchar,message OUT sys_refcursor)
AS  
--任务关注后推送相关消息
--作者：陈丽
--日期：2019/11/15
BEGIN  
open message for  
select 
'消息描述' as  "msgDescription",
'接收人id' as "RecipientId" ,
bizId as "bizKey" ,
'发送人id' as "senderId",
'业务类型' as "bizSourceCategory" ,
'消息业务类型' as "bizMsgCategory" ,
'系统id' as "systemId" ,
'微信跳转url'  as "wechatJumplinkUrl"
from dual;

END p_pom_Push_watch_message;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_QUARTER_ASSESSMENT_DTL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_QUARTER_ASSESSMENT_DTL" ( year IN VARCHAR2, --年
		quarter IN VARCHAR2, --季度
		companyid IN VARCHAR2, --当前用户公司id
		baseInfo OUT SYS_REFCURSOR, --基本信息
		detailInfo OUT SYS_REFCURSOR --明细信息
	) AS
	--公司月度考核排行详情
--作者：叶丁荣
--日期：2019/12/05
BEGIN
		OPEN baseInfo FOR SELECT
		'华南区域公司' AS "checkObject",--考核对象
		'2019-9-25 23:59:59' AS "sataGenerationTime",--数据生成日期
		'2019-8-26' AS "assessmentStartDate",--考核开始日期
		'2019-09-25' AS "assessmentEndDate",--考核结束日期
		'80%' AS "percentageComplete",--完成率(P=N/N*100)
		5 AS "assessmentTasksCount",--考核任务数量(M)
		4 AS "missionsCompleted",--已完成任务(N)
		77.69 AS "assessmentScore",--考核得分S=(B/A)*100
		520 AS "assessmentStandardNodeScore",--∑考核期内节点标准分(A)
		404 AS "assessmentActualNodeScore"--∑考核期内节点实际得分(B)
	FROM
		dual;

	OPEN detailInfo FOR SELECT
	'red' AS "alertStatus",--预警状态
	'未完成' "completionStatus",--完成状态
	'首开楼栋总包单位定标0' AS "taskName",--任务名称
	'项目5_一期关键节点计划' AS "planName",--计划名称
	'华南公司' AS "area",--区域
	'广佛事业部' AS "businessDivision",--事业部
	'项目5_一期' AS "project", --项目
	'成本合约部' AS "department",--主责部门
	'一级' AS "tasnkLevel",--任务级别
	'2020-01-01' AS "planEndDate",--计划完成日期
	'2020-01-15' AS "FactEndDate",--实际完成日期
	'2020-01-15' AS "auditCompletionDate",--核完成日期
	15 AS "standardScore",--标准分值
	'100%' AS "scoringPercentage",--得分比例
	15 AS "actualScore" --实际得分

	FROM
		dual UNION ALL
	SELECT
		'green' AS "alertStatus",--预警状态
		'已完成' "completionStatus",--完成状态
		'首开楼栋总包单位定标1' AS "taskName",--任务名称
		'项目5_一期关键节点计划' AS "planName",--计划名称
		'华南公司' AS "area",--区域
		'广佛事业部' AS "businessDivision",--事业部
		'项目5_一期' AS "project" ,--项目
		'成本合约部' AS "department",--主责部门
		'一级' AS "tasnkLevel",--任务级别
		'2020-01-01' AS "planEndDate",--计划完成日期
		'2020-01-15' AS "FactEndDate",--实际完成日期
		'2020-01-15' AS "auditCompletionDate",--核完成日期
		15 AS "standardScore",--标准分值
		'100%' AS "scoringPercentage",--得分比例
		15 AS "actualScore" --实际得分

	FROM
		dual UNION ALL
	SELECT
		'green' AS "alertStatus",--预警状态
		'已完成' "completionStatus",--完成状态
		'首开楼栋总包单位定标2' AS "taskName",--任务名称
		'项目5_一期关键节点计划' AS "planName",--计划名称
		'华南公司' AS "area",--区域
		'广佛事业部' AS "businessDivision",--事业部
		'项目5_一期' AS "project", --项目
		'成本合约部' AS "department",--主责部门
		'一级' AS "tasnkLevel",--任务级别
		'2020-01-01' AS "planEndDate",--计划完成日期
		'2020-01-15' AS "FactEndDate",--实际完成日期
		'2020-01-15' AS "auditCompletionDate",--核完成日期
		15 AS "standardScore",--标准分值
		'100%' AS "scoringPercentage",--得分比例
		15 AS "actualScore" --实际得分

	FROM
		dual UNION ALL
	SELECT
		'green' AS "alertStatus",--预警状态
		'已完成' "completionStatus",--完成状态
		'首开楼栋总包单位定标3' AS "taskName",--任务名称
		'项目5_一期关键节点计划' AS "planName",--计划名称
		'华南公司' AS "area",--区域
		'广佛事业部' AS "businessDivision",--事业部
		'项目5_一期' AS "project", --项目
		'成本合约部' AS "department",--主责部门
		'一级' AS "tasnkLevel",--任务级别
		'2020-01-01' AS "planEndDate",--计划完成日期
		'2020-01-15' AS "FactEndDate",--实际完成日期
		'2020-01-15' AS "auditCompletionDate",--核完成日期
		15 AS "standardScore",--标准分值
		'100%' AS "scoringPercentage",--得分比例
		15 AS "actualScore" --实际得分

	FROM
		dual UNION ALL
	SELECT
		'green' AS "alertStatus",--预警状态
		'已完成' "completionStatus",--完成状态
		'首开楼栋总包单位定标4' AS "taskName",--任务名称
		'项目5_一期关键节点计划' AS "planName",--计划名称
		'华南公司' AS "area",--区域
		'广佛事业部' AS "businessDivision",--事业部
		'项目5_一期' AS "project", --项目
		'成本合约部' AS "department",--主责部门
		'一级' AS "tasnkLevel",--任务级别
		'2020-01-01' AS "planEndDate",--计划完成日期
		'2020-01-15' AS "FactEndDate",--实际完成日期
		'2020-01-15' AS "auditCompletionDate",--核完成日期
		15 AS "standardScore",--标准分值
		'100%' AS "scoringPercentage",--得分比例
		15 AS "actualScore" --实际得分

	FROM
		dual;

END p_pom_quarter_assessment_dtl;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_RANK_EXAMINATION_DTL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_RANK_EXAMINATION_DTL" (
    rangetype   IN          INT,--时间范围类型（10:月度，20季度）
    rangeval    IN          VARCHAR2,--范围值，月度：2019|09。季度：2019|04
    orgid       IN          VARCHAR2,--组织id(关键节点计划传空,项目主项计划传）
    title       OUT         VARCHAR2,
    bartype     OUT         VARCHAR2,
    unit        OUT         VARCHAR2,
    wacthinfo   OUT         SYS_REFCURSOR
) AS
--考核排行详情
--作者：陈丽
--日期：2019/11/13
BEGIN
    OPEN wacthinfo FOR SELECT
                           '广佛事业部-项目A' AS "name",
                           '100' AS "total",
                           '#37cd69' AS "color"
                       FROM
                           dual
                       UNION
                       SELECT
                           '南宁事业部-项目B' AS "name",
                           '25' AS "total",
                           '#37cd69' AS "color"
                       FROM
                           dual
                       UNION
                       SELECT
                           '广佛事业部-项目C' AS "name",
                           '25' AS "total",
                           '#37cd69' AS "color"
                       FROM
                           dual
                       UNION
                       SELECT
                           '福州地产-项目D' AS "name",
                           '25' AS "total",
                           '#37cd69' AS "color"
                       FROM
                           dual;

    title := '项目主项计划考核_项目排行榜：';
    unit := '%';
    bartype := 'column';
END p_pom_rank_examination_dtl;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_RANK_ORG_EXAM_DTL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_RANK_ORG_EXAM_DTL" (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    rangetype   IN          INT,--时间范围类型（10:月度，20季度）
  --计划类型  30关键节点计划，40项目主项计划
    rangeval    IN          VARCHAR2,--范围值，月度：2019|09。季度：2019|04
    orgid       IN          VARCHAR2,--组织id(关键节点计划传空,项目主项计划传）
    title       OUT         VARCHAR2,
    info   OUT         SYS_REFCURSOR
) AS
--公司考核排行详情
--作者：陈丽
--日期：2019/11/13
BEGIN
  IF rangetype=10
      THEN
    OPEN info FOR
SELECT A.ORG_NAME AS "company", A.ID AS "ORGID",
			 TO_CHAR(ROUND(CASE
												 WHEN SUM(CASE
																			WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR THEN
																			 应完成
																			ELSE
																			 0
																	END) > 0 THEN
													SUM(CASE
																	WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR THEN
																	 已完成
																	ELSE
																	 0
															END) / SUM(CASE
																						 WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR THEN
																							应完成
																						 ELSE
																							0
																				 END) * 100
												 ELSE
													0
										 END, 2)) AS "yearPercentageComplete",
			 TO_CHAR(SUM(CASE
											 WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR THEN
												应完成
											 ELSE
												0
									 END)) AS "yearShouldComplete"
				--本年应完成数
			 ,
			 TO_CHAR(SUM(CASE
											 WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR THEN
												已完成
											 ELSE
												0
									 END)) AS "yearDone"
				--本年已完成数
			 ,
			 TO_CHAR(SUM(CASE
											 WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR THEN
												应完成
											 ELSE
												0
									 END) - SUM(CASE
																	WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR THEN
																	 已完成
																	ELSE
																	 0
															END)) AS "yearUnfinished"
				--本年未完成数
			 ,
			 TO_CHAR(ROUND(CASE
												 WHEN SUM(CASE
																			WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
																			 SUMNODESCORE
																			ELSE
																			 0
																	END) > 0 THEN
													SUM(CASE
																	WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
																	 动态得分
																	ELSE
																	 0
															END) / SUM(CASE
																						 WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
																							SUMNODESCORE
																						 ELSE
																							0
																				 END) * 100
												 ELSE
													0
										 END, 2)) AS "dynamicScoring"
				--本月、季度动态得分
			 ,
			 TO_CHAR(SUM(CASE
											 WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
												应完成
											 ELSE
												0
									 END)) AS "monthShouldComplete"
				--本月、季度应完成数
			 ,
       TO_CHAR(SUM(CASE
											 WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
												SUMNODESCORE
											 ELSE
												0
									 END)) AS "monthShouldCompleteScore"
				--本月应完成总分
        ,
			 TO_CHAR(SUM(CASE
											 WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
												已完成
											 ELSE
												0
									 END)) AS "monthdDone"
				--本月、季度已完成数
			 ,
       TO_CHAR(SUM(CASE
           WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
            已完成总分
           ELSE
            0
        END)) AS "monthdDoneScore"
				--本月已完成总分
			 ,
			 TO_CHAR(SUM(CASE
											 WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
												应完成
											 ELSE
												0
									 END) - SUM(CASE
																	WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
																	 已完成
																	ELSE
																	 0
															END)) AS "monthUnfinished"
				--本月未完成数
			 ,
			 TO_CHAR(SUM(CASE
											 WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
												里程碑红灯
											 ELSE
												0
									 END) + SUM(CASE
																	WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
																	 一级节点红灯
																	ELSE
																	 0
															END) + SUM(CASE
																						 WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
																							二级节点红灯 + 三级节点红灯
																						 ELSE
																							0
																				 END)) AS "red"
				--红灯数
			 ,
			 TO_CHAR(SUM(CASE
											 WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
												里程碑黄灯
											 ELSE
												0
									 END) + SUM(CASE
																	WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
																	 一级节点黄灯
																	ELSE
																	 0
															END) + SUM(CASE
																						 WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
																							二级节点黄灯 + 三级节点黄灯
																						 ELSE
																							0
																				 END)) AS "yellow"
				--黄灯数
			 ,
			 TO_CHAR(SUM(CASE
											 WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
												里程碑绿灯
											 ELSE
												0
									 END) + SUM(CASE
																	WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
																	 一级节点绿灯
																	ELSE
																	 0
															END) + SUM(CASE
																						 WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
																							二级节点绿灯 + 三级节点绿灯
																						 ELSE
																							0
																				 END)) AS "green"
				--绿灯数
			 ,
			 TO_CHAR(SUM(CASE
											 WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
												里程碑应完成
											 ELSE
												0
									 END)) AS "milestoneShouldComplete"
				--里程碑应完成数
			 ,
			 TO_CHAR(SUM(CASE
											 WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
												里程碑已完成
											 ELSE
												0
									 END)) AS "milestoneDone"
				--里程碑已完成数
			 ,
			 TO_CHAR(SUM(CASE
											 WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
												里程碑应完成
											 ELSE
												0
									 END) - SUM(CASE
																	WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
																	 里程碑已完成
																	ELSE
																	 0
															END)) AS "milestoneUnfinished"
				--里程碑未完成数
			 ,
			 TO_CHAR(SUM(CASE
											 WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
												一级节点应完成
											 ELSE
												0
									 END)) AS "oneLevelNodeShouldComplete"
				--一级节点应完成数
			 ,
			 TO_CHAR(SUM(CASE
											 WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
												一级节点已完成
											 ELSE
												0
									 END)) AS "oneLevelNodeDone"
				--一级节点已完成数
			 ,
			 TO_CHAR(SUM(CASE
											 WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
												一级节点应完成
											 ELSE
												0
									 END) - SUM(CASE
																	WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
																	 一级节点已完成
																	ELSE
																	 0
															END)) AS "oneLevelNodeUnfinished"
				--一级节点未完成数
			 , 'WWW.BAIDU.COM' AS "openUrl" --打开地址

FROM   V_POM_PJPLANRANK A
WHERE  A.应完成 > 0 AND
			 A.PLAN_TYPE = '关键节点计划' AND
			 CTYPE = 'TYPE_ORG' AND
			 A.PARENT_ID = '' || ORGID || '' AND
			 SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR
GROUP  BY A.ORG_NAME, A.ID
ORDER  BY 3 DESC;
ELSIF RANGETYPE = 20 THEN OPEN INFO FOR SELECT

A.ORG_NAME AS "company", A.ID AS "ORGID", ROUND(CASE WHEN SUM(CASE WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR THEN 应完成 ELSE 0 END) > 0 THEN SUM(CASE WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR THEN 已完成 ELSE 0 END)
/ SUM(CASE WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR THEN 应完成 ELSE 0 END) * 100 ELSE 0 END, 2) AS "yearPercentageComplete", SUM(CASE WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR THEN 应完成 ELSE 0 END) AS "yearShouldComplete" --本年应完成数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR THEN 已完成 ELSE 0 END) AS "yearDone" --本年已完成数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR THEN 应完成 ELSE 0 END) - SUM(CASE WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR THEN 已完成 ELSE 0 END) AS "yearUnfinished" --本年未完成数
, TO_CHAR(ROUND(CASE WHEN SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN SUMNODESCORE ELSE 0 END) > 0 THEN SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN 动态得分 ELSE 0 END)
/ SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN SUMNODESCORE ELSE 0 END) * 100 ELSE 0 END, 2)) AS "dynamicScoring" --本月、季度动态得分
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN 应完成 ELSE 0 END) AS "quarterShouldComplete" --本月、季度应完成数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN SUMNODESCORE ELSE 0 END) AS "quarterShouldCompleteScore" --本月、季度应完成分数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN 已完成 ELSE 0 END) AS "quarterDone" --本月、季度已完成数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN 已完成总分 ELSE 0 END) AS "quarterDoneScore" --本月、季度已完成分数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN 应完成 ELSE 0 END) - SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN 已完成 ELSE 0 END) AS "quarterUnfinished" --本月未完成数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN 里程碑红灯 ELSE 0 END) + SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN 一级节点红灯 ELSE 0 END) + SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN 二级节点红灯 + 三级节点红灯 ELSE 0 END) AS "red" --红灯数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN 里程碑黄灯 ELSE 0 END) + SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN 一级节点黄灯 ELSE 0 END) + SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN 二级节点黄灯 + 三级节点黄灯 ELSE 0 END) AS "yellow" --黄灯数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN 里程碑绿灯 ELSE 0 END) + SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN 一级节点绿灯 ELSE 0 END) + SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN 二级节点绿灯 + 三级节点绿灯 ELSE 0 END) AS "green" --绿灯数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN 里程碑应完成 ELSE 0 END) AS "milestoneShouldComplete" --里程碑应完成数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN 里程碑已完成 ELSE 0 END) AS "milestoneDone" --里程碑已完成数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN 里程碑应完成 ELSE 0 END) - SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN 里程碑已完成 ELSE 0 END) AS "milestoneUnfinished" --里程碑未完成数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN 一级节点应完成 ELSE 0 END) AS "oneLevelNodeShouldComplete" --一级节点应完成数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN 一级节点已完成 ELSE 0 END) AS "oneLevelNodeDone" --一级节点已完成数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN 一级节点应完成 ELSE 0 END) - SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN 一级节点已完成 ELSE 0 END) AS "oneLevelNodeUnfinished" --一级节点未完成数
, '' AS "openUrl" --打开地址

FROM V_POM_PJPLANRANK A WHERE A.应完成 > 0 AND A.PLAN_TYPE = '项目主项计划' AND CTYPE = 'TYPE_ORG' AND SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND A.PARENT_ID = '' || ORGID || '' GROUP BY A.ORG_NAME, A.ID ORDER BY 3 DESC;

END IF; TITLE := '月度考核排行榜_明细数据统计'; END P_POM_RANK_ORG_EXAM_DTL;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_RANK_ORG_EXAMINATION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_RANK_ORG_EXAMINATION" (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    rankype        IN             INT,--时间范围类型（10:月度，20季度）
    plantype       IN             INT,--计划类型（30：关键节点计划，40：项目主项计划）
    rankval        IN             VARCHAR2,--范围值，月度：2019|09。季度：2019|04
    orgid          IN             VARCHAR2,--组织id(传前端选择的公司）
    title          OUT            VARCHAR2,
    bartype        OUT            VARCHAR2,
    unit           OUT            VARCHAR2,
    info      OUT            SYS_REFCURSOR
) AS
--考核排行-组织排行，包括月度排行的 关键节点和项目主项计划。季度排行的关键节点和项目主项计划
--作者：陈丽
--日期：2019/11/13
BEGIN

IF rankype=10  AND plantype=30
THEN
OPEN info FOR
SELECT   A.ORG_NAME   AS "name"
  , TO_CHAR(
   CASE WHEN  SUM(
                  CASE
                  WHEN SUBSTR( rankval, 0, 4 ) = A.PLANYEAR
                  AND SUBSTR( rankval, 6, 2 ) = A.PLANMOTH THEN
                  SUMNODESCORE ELSE 0
                    END
                )>0
        THEN   ROUND(
              SUM(
                  CASE

                      WHEN SUBSTR( rankval, 0, 4 ) = A.PLANYEAR
                      AND SUBSTR( rankval, 6, 2 ) = A.PLANMOTH THEN
                        FINISHEXMSOCRE ELSE 0
                      END
                        ) / SUM(
                      CASE

                  WHEN SUBSTR( rankval, 0, 4 ) = A.PLANYEAR
                  AND SUBSTR( rankval, 6, 2 ) = A.PLANMOTH THEN
                    SUMNODESCORE ELSE 0
                  END
                ) * 100,
                2
              )
          ELSE  0 END
            )
           AS "total" --,'90 'AS "total"
     , '#37cd69' AS "color"
     FROM    V_POM_PJPLAN_EXM_SOCRE  A
     INNER JOIN SYS_BUSINESS_UNIT B ON  A.ID=B.ID
     WHERE A.PARENT_ID=''||orgid||'' AND A.CTYPE='TYPE_ORG'
     AND SUBSTR( rankval, 0, 4 ) = A.PLANYEAR
     AND SUBSTR( rankval, 6, 2 ) = A.PLANMOTH
     AND  A.PLAN_TYPE=  '关键节点计划'
--      AND   B.COMPANY_TYPE='5'
      GROUP BY A.ORG_NAME;



ELSIF rankype=10  AND plantype=40
THEN
OPEN info FOR
SELECT   A.ORG_NAME   AS "name"
  , TO_CHAR(
   CASE WHEN  SUM(
                  CASE
                  WHEN SUBSTR( rankval, 0, 4 ) = A.PLANYEAR
                  AND SUBSTR( rankval, 6, 2 ) = A.PLANMOTH THEN
                  SUMNODESCORE ELSE 0
                    END
                )>0
        THEN   ROUND(
              SUM(
                  CASE

                      WHEN SUBSTR( rankval, 0, 4 ) = A.PLANYEAR
                      AND SUBSTR( rankval, 6, 2 ) = A.PLANMOTH THEN
                        FINISHEXMSOCRE ELSE 0
                      END
                        ) / SUM(
                      CASE

                  WHEN SUBSTR( rankval, 0, 4 ) = A.PLANYEAR
                  AND SUBSTR( rankval, 6, 2 ) = A.PLANMOTH THEN
                    SUMNODESCORE ELSE 0
                  END
                ) * 100,
                2
              )
          ELSE  0 END
            )
           AS "total" --,'90 'AS "total"
     , '#37cd69' AS "color"
     FROM    V_POM_PJPLAN_EXM_SOCRE  A
     INNER JOIN SYS_BUSINESS_UNIT B ON  A.ID=B.ID
     WHERE A.PARENT_ID=''||orgid||''AND A.CTYPE='TYPE_ORG'
     AND  A.PLAN_TYPE= '项目主项计划'
     AND SUBSTR( rankval, 0, 4 ) = A.PLANYEAR
     AND SUBSTR( rankval, 6, 2 ) = A.PLANMOTH
      GROUP BY A.ORG_NAME;




ELSIF rankype=20    AND plantype=30
THEN
OPEN info FOR
SELECT   A.ORG_NAME   AS "name"
  , TO_CHAR(
   CASE WHEN  SUM(
                  CASE
                  WHEN SUBSTR( rankval, 0, 4 ) = A.PLANYEAR
                  AND SUBSTR( rankval, 6, 2 ) = A.PLANQUATOR THEN
                  SUMNODESCORE ELSE 0
                    END
                )>0
        THEN   ROUND(
              SUM(
                  CASE

                      WHEN SUBSTR( rankval, 0, 4 ) = A.PLANYEAR
                      AND SUBSTR( rankval, 6, 2 ) = A.PLANQUATOR THEN
                        FINISHEXMSOCRE ELSE 0
                      END
                        ) / SUM(
                      CASE

                  WHEN SUBSTR( rankval, 0, 4 ) = A.PLANYEAR
                  AND SUBSTR( rankval, 6, 2 ) = A.PLANQUATOR THEN
                    SUMNODESCORE ELSE 0
                  END
                ) * 100,
                2
              )
          ELSE  0 END
            )
           AS "total" --,'90 'AS "total"
     , '#37cd69' AS "color"
     FROM    V_POM_PJPLAN_EXM_SOCRE  A
     INNER JOIN SYS_BUSINESS_UNIT B ON  A.ID=B.ID
     WHERE A.PARENT_ID=''||orgid||'' AND A.CTYPE='TYPE_ORG'
     AND  A.PLAN_TYPE=  '关键节点计划'
     AND SUBSTR( rankval, 0, 4 ) = A.PLANYEAR
     AND SUBSTR( rankval, 6, 2 ) = A.PLANQUATOR
--      AND   B.COMPANY_TYPE='5'
      GROUP BY A.ORG_NAME;

ELSIF rankype=20    AND plantype=40
THEN
OPEN info FOR
SELECT   A.ORG_NAME   AS "name"
  , TO_CHAR(
   CASE WHEN  SUM(
                  CASE
                  WHEN SUBSTR( rankval, 0, 4 ) = A.PLANYEAR
                  AND SUBSTR( rankval, 6, 2 ) = A.PLANQUATOR THEN
                  SUMNODESCORE ELSE 0
                    END
                )>0
        THEN   ROUND(
              SUM(
                  CASE

                      WHEN SUBSTR( rankval, 0, 4 ) = A.PLANYEAR
                      AND SUBSTR( rankval, 6, 2 ) = A.PLANQUATOR THEN
                        FINISHEXMSOCRE ELSE 0
                      END
                        ) / SUM(
                      CASE

                  WHEN SUBSTR( rankval, 0, 4 ) = A.PLANYEAR
                  AND SUBSTR( rankval, 6, 2 ) = A.PLANQUATOR THEN
                    SUMNODESCORE ELSE 0
                  END
                ) * 100,
                2
              )
          ELSE  0 END
            )
           AS "total" --,'90 'AS "total"
     , '#37cd69' AS "color"

     FROM    V_POM_PJPLAN_EXM_SOCRE  A
     INNER JOIN SYS_BUSINESS_UNIT B ON  A.ID=B.ID
     WHERE A.PARENT_ID=''||orgid||'' AND A.CTYPE='TYPE_ORG'
     AND SUBSTR( rankval, 0, 4 ) = A.PLANYEAR
     AND SUBSTR( rankval, 6, 2 ) = A.PLANQUATOR
     AND  A.PLAN_TYPE= '关键节点计划'

      GROUP BY A.ORG_NAME;
  END IF ;



    title :=   CASE WHEN  plantype=40 THEN '项目主项计划' ELSE '关键节点计划'  END  ||'考核排行榜：按照考核得分进行排行统计，展示二级单位的排行';
    unit := '';
    bartype := 'column';
END p_pom_rank_org_examination;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_RANK_ORG_GETDTL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_RANK_ORG_GETDTL" 
(
		PLANTYPE  IN VARCHAR2
	 , --计划类型
		RANGETYPE IN INT
	 , --时间范围类型（10:月度，20季度）
		RANGEVAL  IN VARCHAR2
	 , --范围值，月度：2019|09。季度：2019|04
		RANKDTL   OUT SYS_REFCURSOR
) AS
BEGIN
		IF RANGETYPE = 10 THEN
				OPEN RANKDTL FOR
						SELECT ROW_NUMBER() OVER(PARTITION BY A.PARENT_ID ORDER BY ROUND(CASE
											 WHEN NVL(B.本年应完成, 0) > 0 THEN
												NVL(本年已完成, 0) / NVL(B.本年应完成, 0)
											 ELSE
												0
									 END * 100, 2) DESC) AS RANK, A.ID, A.PARENT_ID,
									 A.ORG_NAME, NVL(B.本年应完成, 0) AS 本年应完成,
									 NVL(B.本年已完成, 0) AS 本年已完成
									 --     ,NVL(B.本季度应完成,0) AS 本季度应完成
									 --     ,NVL(B.本季度已完成,0) AS 本季度已完成
									, NVL(B.本月应完成, 0) AS 本月应完成, NVL(B.本月已完成, 0) AS 本月已完成
									 /*动态得分情况*/, NVL(B.本月动态得分, 0) AS 本月动态得分
									 --     ,NVL(B.本季度动态得分,0) AS 本季度动态得分
									 /*里程碑、一级节点完成情况*/, NVL(B.本月里程碑应完成, 0) AS 本月里程碑应完成,
									 NVL(B.本月里程碑已完成, 0) AS 本月里程碑已完成,
									 NVL(B.本月一级节点应完成, 0) AS 本月一级节点应完成,
									 NVL(B.本月一级节点已完成, 0) AS 本月一级节点已完成
									 --     ,NVL(B.本季度里程碑应完成,0) AS 本季度里程碑应完成
									 --     ,NVL(B.本季度里程碑已完成,0) AS 本季度里程碑已完成
									 --     ,NVL(B.本季度一级节点应完成,0) AS 本季度一级节点应完成
									 --     ,NVL(B.本季度一级节点已完成,0) AS 本季度一级节点已完成
									 /*亮点情况*/, NVL(B.本月里程碑绿灯, 0) AS 本月里程碑绿灯,
									 NVL(B.本月里程碑黄灯, 0) AS 本月里程碑黄灯,
									 NVL(B.本月里程碑红灯, 0) AS 本月里程碑红灯,
									 NVL(B.本月一级节点绿灯, 0) AS 本月一级节点绿灯,
									 NVL(B.本月一级节点黄灯, 0) AS 本月一级节点黄灯,
									 NVL(B.本月一级节点红灯, 0) AS 本月一级节点红灯,
									 NVL(B.本月二三级节点绿灯, 0) AS 本月二三级节点绿灯,
									 NVL(B.本月二三级节点黄灯, 0) AS 本月二三级节点黄灯,
									 NVL(B.本月二三级节点红灯, 0) AS 本月二三级节点红灯
									 --     ,NVL(B.本季度里程碑绿灯,0) AS 本季度里程碑绿灯
									 --     ,NVL(B.本季度里程碑黄灯,0) AS 本季度里程碑黄灯
									 --     ,NVL(B.本季度里程碑红灯,0) AS 本季度里程碑红灯
									 --     ,NVL(B.本季度一级节点绿灯,0) AS 本季度一级节点绿灯
									 --     ,NVL(B.本季度一级节点黄灯,0) AS 本季度一级节点黄灯
									 --     ,NVL(B.本季度一级节点红灯,0) AS 本季度一级节点红灯
									 --     ,NVL(B.本季度二三级节点绿灯,0) AS 本季度二三级节点绿灯
									 --     ,NVL(B.本季度二三级节点黄灯,0) AS 本季度二三级节点黄灯
									 --     ,NVL(B.本季度二三级节点红灯,0) AS 本季度二三级节点红灯
									 
									, 'TYPE_ORG' AS CTYPE
						FROM   SYS_BUSINESS_UNIT A
						LEFT   JOIN (SELECT AB.ID, AB.PARENT_ID, SUM(AB.本年应完成) AS 本年应完成,
																SUM(AB.本年已完成) AS 本年已完成
																--     ,SUM(AB.本季度应完成) AS 本季度应完成
																--     ,SUM(AB.本季度已完成) AS 本季度已完成
															 , SUM(AB.本月应完成) AS 本月应完成,
																SUM(AB.本月已完成) AS 本月已完成
																/*动态得分情况*/, SUM(AB.本月动态得分) AS 本月动态得分
																--     ,SUM(AB.本季度动态得分) AS 本季度动态得分
																/*里程碑、一级节点完成情况*/,
																SUM(AB.本月里程碑应完成) AS 本月里程碑应完成,
																SUM(AB.本月里程碑已完成) AS 本月里程碑已完成,
																SUM(AB.本月一级节点应完成) AS 本月一级节点应完成,
																SUM(AB.本月一级节点已完成) AS 本月一级节点已完成
																--     ,SUM(AB.本季度里程碑应完成) AS 本季度里程碑应完成
																--     ,SUM(AB.本季度里程碑已完成) AS 本季度里程碑已完成
																--     ,SUM(AB.本季度一级节点应完成) AS 本季度一级节点应完成
																--     ,SUM(AB.本季度一级节点已完成) AS 本季度一级节点已完成
																/*亮点情况*/, SUM(AB.本月里程碑绿灯) AS 本月里程碑绿灯,
																SUM(AB.本月里程碑黄灯) AS 本月里程碑黄灯,
																SUM(AB.本月里程碑红灯) AS 本月里程碑红灯,
																SUM(AB.本月一级节点绿灯) AS 本月一级节点绿灯,
																SUM(AB.本月一级节点黄灯) AS 本月一级节点黄灯,
																SUM(AB.本月一级节点红灯) AS 本月一级节点红灯,
																SUM(AB.本月二三级节点绿灯) AS 本月二三级节点绿灯,
																SUM(AB.本月二三级节点黄灯) AS 本月二三级节点黄灯,
																SUM(AB.本月二三级节点红灯) AS 本月二三级节点红灯
												 --     ,SUM(AB.本季度里程碑绿灯) AS 本季度里程碑绿灯
												 --     ,SUM(AB.本季度里程碑黄灯) AS 本季度里程碑黄灯
												 --     ,SUM(AB.本季度里程碑红灯) AS 本季度里程碑红灯
												 --     ,SUM(AB.本季度一级节点绿灯) AS 本季度一级节点绿灯
												 --     ,SUM(AB.本季度一级节点黄灯) AS 本季度一级节点黄灯
												 --     ,SUM(AB.本季度一级节点红灯) AS 本季度一级节点红灯
												 --     ,SUM(AB.本季度二三级节点绿灯) AS 本季度二三级节点绿灯
												 --     ,SUM(AB.本季度二三级节点黄灯) AS 本季度二三级节点黄灯
												 --     ,SUM(AB.本季度二三级节点红灯) AS 本季度二三级节点红灯
												 FROM   (
																	--  11
																	
																	SELECT
																	/*完成情况*/
																	 NVL(B.本年应完成, 0) AS 本年应完成,
																		NVL(B.本年已完成, 0) AS 本年已完成
																		--                    ,NVL(B.本季度应完成,0) AS 本季度应完成
																		--                    ,NVL(B.本季度已完成,0) AS 本季度已完成
																	, NVL(B.本月应完成, 0) AS 本月应完成,
																		NVL(B.本月已完成, 0) AS 本月已完成
																		/*动态得分情况*/, NVL(B.本月动态得分, 0) AS 本月动态得分
																		--                    ,NVL(B.本季度动态得分,0) AS 本季度动态得分
																		/*里程碑、一级节点完成情况*/,
																		NVL(B.本月里程碑应完成, 0) AS 本月里程碑应完成,
																		NVL(B.本月里程碑已完成, 0) AS 本月里程碑已完成,
																		NVL(B.本月一级节点应完成, 0) AS 本月一级节点应完成,
																		NVL(B.本月一级节点已完成, 0) AS 本月一级节点已完成
																		--                    ,NVL(B.本季度里程碑应完成,0) AS 本季度里程碑应完成
																		--                    ,NVL(B.本季度里程碑已完成,0) AS 本季度里程碑已完成
																		--                    ,NVL(B.本季度一级节点应完成,0) AS 本季度一级节点应完成
																		--                    ,NVL(B.本季度一级节点已完成,0) AS 本季度一级节点已完成
																		/*亮点情况*/, NVL(B.本月里程碑绿灯, 0) AS 本月里程碑绿灯,
																		NVL(B.本月里程碑黄灯, 0) AS 本月里程碑黄灯,
																		NVL(B.本月里程碑红灯, 0) AS 本月里程碑红灯,
																		NVL(B.本月一级节点绿灯, 0) AS 本月一级节点绿灯,
																		NVL(B.本月一级节点黄灯, 0) AS 本月一级节点黄灯,
																		NVL(B.本月一级节点红灯, 0) AS 本月一级节点红灯,
																		NVL(B.本月二三级节点绿灯, 0) AS 本月二三级节点绿灯,
																		NVL(B.本月二三级节点黄灯, 0) AS 本月二三级节点黄灯,
																		NVL(B.本月二三级节点红灯, 0) AS 本月二三级节点红灯
																		--                    ,NVL(B.本季度里程碑绿灯,0) AS 本季度里程碑绿灯
																		--                    ,NVL(B.本季度里程碑黄灯,0) AS 本季度里程碑黄灯
																		--                    ,NVL(B.本季度里程碑红灯,0) AS 本季度里程碑红灯
																		--                    ,NVL(B.本季度一级节点绿灯,0) AS 本季度一级节点绿灯
																		--                    ,NVL(B.本季度一级节点黄灯,0) AS 本季度一级节点黄灯
																		--                    ,NVL(B.本季度一级节点红灯,0) AS 本季度一级节点红灯
																		--                    ,NVL(B.本季度二三级节点绿灯,0) AS 本季度二三级节点绿灯
																		--                    ,NVL(B.本季度二三级节点黄灯,0) AS 本季度二三级节点黄灯
																		--                    ,NVL(B.本季度二三级节点红灯,0) AS 本季度二三级节点红灯
																	, CONNECT_BY_ROOT ID AS ID,
																		CONNECT_BY_ROOT PARENT_ID AS PARENT_ID
																	FROM   SYS_BUSINESS_UNIT A
																	LEFT   JOIN (
																							 
																							 SELECT B1.UNIT_ID,
																											 COUNT(A1.ID) AS "NODESUM",
																											 SUM(STANDARD_SCORE) AS "SUMNODESCORE"
																											 --完成规则
																											 
																											 ------------------
																											 /*本年任务*/
																											 ------------------
																											 ------
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.PLAN_END_DATE, 'YYYY') = TO_CHAR(SYSDATE, 'YYYY') THEN
																																 1
																																ELSE
																																 0
																														END
																														
																														) AS "本年应完成",
																											 SUM((CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本年
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY') = TO_CHAR(SYSDATE, 'YYYY')
																																--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																 THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本年已完成"
																											 
																											 ------------------
																											 /*本月任务*/
																											 ------------------
																											 ------
																											 ,
																											 SUM((CASE
																																WHEN TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																			FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本月应完成",
																											 SUM((CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																 THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本月已完成"
																											 
																											 ,
																											 SUM((CASE
																														--按时完成
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(A1.PLAN_END_DATE, 'DD') - TRUNC(D.APPROVAL_TIME, 'DD')) BETWEEN 0 AND 29 THEN
																																 A1.STANDARD_SCORE * 1
																														--提前一个月完成
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL --判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(A1.PLAN_END_DATE, 'DD') - TRUNC(D.APPROVAL_TIME, 'DD')) >= 30 AND
																																		 A1.NODE_LEVEL = '里程碑' THEN
																																 A1.STANDARD_SCORE * 1.2
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(A1.PLAN_END_DATE, 'DD') - TRUNC(D.APPROVAL_TIME, 'DD')) >= 30 AND
																																		 A1.NODE_LEVEL = '一级节点' THEN
																																 A1.STANDARD_SCORE * 1.1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(A1.PLAN_END_DATE, 'DD') - TRUNC(D.APPROVAL_TIME, 'DD')) >= 30 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 A1.STANDARD_SCORE * 1.0
																														--延时完成
																														--里程碑、一级节点3天
																														--二三级节点5天
																														--延时完成
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('里程碑', '一级节点') THEN
																																 A1.STANDARD_SCORE * 0.6
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 3 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 A1.STANDARD_SCORE * 1.0
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 4 AND 7 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 A1.STANDARD_SCORE * 0.6
																														--红灯
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('里程碑', '一级节点') THEN
																																 A1.STANDARD_SCORE * 0
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 8 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 A1.STANDARD_SCORE * 0
																																ELSE
																																 0
																														END)) AS "本月动态得分"
																											 
																											 ------------------
																											 /*-里程碑完成情况*/
																											 ------------------
																											 ,
																											 SUM((CASE
																																WHEN A1. NODE_LEVEL = '里程碑' AND
																																		 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																			FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本月里程碑应完成",
																											 SUM((CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL AND A1.
																																 NODE_LEVEL = '里程碑' AND
																																		 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																			FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本月里程碑已完成"
																											 ------------------
																											 /*-一级节点完成情况*/
																											 ------------------
																											 ,
																											 SUM((CASE
																																WHEN A1. NODE_LEVEL = '一级节点' AND
																																		 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																			FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本月一级节点应完成",
																											 SUM((CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL AND A1.
																																 NODE_LEVEL = '一级节点' AND
																																		 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																			FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本月一级节点已完成"
																											 
																											 ------------------
																											 /*-里程碑本月亮灯情况*/
																											 ------------------
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) <= 0 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月里程碑绿灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月里程碑黄灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月里程碑红灯"
																											 
																											 ------------------
																											 /*一级节点本月亮灯情况*/
																											 ------------------
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) <= 0 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月一级节点绿灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月一级节点黄灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月一级节点红灯"
																											 
																											 ------------------
																											 /*二三级节点本月亮灯情况*/
																											 ------------------
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) <= 2 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月二三级节点绿灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 3 AND 7 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 3 AND 7 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月二三级节点黄灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 8 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 8 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月二三级节点红灯"
																							 
																							 FROM   POM_PROJ_PLAN A
																							 INNER  JOIN POM_PROJ_PLAN_NODE A1
																							 ON     A.ID = A1.PROJ_PLAN_ID
																							 INNER  JOIN SYS_PROJECT_STAGE C1
																							 ON     A.PROJ_ID = C1.ID
																							 INNER  JOIN SYS_PROJECT B1
																							 ON     C1.PROJECT_ID = B1.ID
																							 LEFT   JOIN POM_NODE_FEEDBACK D
																							 ON     D.FEEDBACK_NODE_ID = A1.ID AND
																											FEEDBACK_TYPE = '完成反馈' AND
																											D.APPROVAL_STATUS = '已审核'
																							 WHERE  A.PLAN_TYPE = '项目主项计划' AND
																											A.APPROVAL_STATUS = '已审核'
																							 GROUP  BY B1.UNIT_ID) B
																	ON     A.ID = B.UNIT_ID
																	WHERE  NVL(B.NODESUM, 0) > 0
																	CONNECT BY PRIOR A.ID = A.PARENT_ID) AB
												 GROUP  BY AB.ID, AB.PARENT_ID) B
						ON     A.ID = B.ID
						WHERE  A.ORG_TYPE = 0 AND
									 A.COMPANY_TYPE = '5' AND
									 A.PARENT_ID = '003200000000000000000000000000';
		
		ELSIF RANGETYPE = 20 THEN
				OPEN RANKDTL FOR
						SELECT ROW_NUMBER() OVER(PARTITION BY A.PARENT_ID ORDER BY ROUND(CASE
											 WHEN NVL(B.本年应完成, 0) > 0 THEN
												NVL(本年已完成, 0) / NVL(B.本年应完成, 0)
											 ELSE
												0
									 END * 100, 2) DESC) AS RANK, A.ID, A.PARENT_ID,
									 A.ORG_NAME, NVL(B.本年应完成, 0) AS 本年应完成,
									 NVL(B.本年已完成, 0) AS 本年已完成, NVL(B.本季度应完成, 0) AS 本季度应完成,
									 NVL(B.本季度已完成, 0) AS 本季度已完成
									 --     ,NVL(B.本月应完成,0) AS 本月应完成
									 --     ,NVL(B.本月已完成,0) AS 本月已完成
									 /*动态得分情况*/
									 --     ,NVL(B.本月动态得分,0) AS 本月动态得分
									, NVL(B.本季度动态得分, 0) AS 本季度动态得分
									 /*里程碑、一级节点完成情况*/
									 --     ,NVL(B.本月里程碑应完成,0) AS 本月里程碑应完成
									 --     ,NVL(B.本月里程碑已完成,0) AS 本月里程碑已完成
									 --     ,NVL(B.本月一级节点应完成,0) AS 本月一级节点应完成
									 --     ,NVL(B.本月一级节点已完成,0) AS 本月一级节点已完成
									, NVL(B.本季度里程碑应完成, 0) AS 本季度里程碑应完成,
									 NVL(B.本季度里程碑已完成, 0) AS 本季度里程碑已完成,
									 NVL(B.本季度一级节点应完成, 0) AS 本季度一级节点应完成,
									 NVL(B.本季度一级节点已完成, 0) AS 本季度一级节点已完成
									 /*亮点情况*/
									 --     ,NVL(B.本月里程碑绿灯,0) AS 本月里程碑绿灯
									 --     ,NVL(B.本月里程碑黄灯,0) AS 本月里程碑黄灯
									 --     ,NVL(B.本月里程碑红灯,0) AS 本月里程碑红灯
									 --     ,NVL(B.本月一级节点绿灯,0) AS 本月一级节点绿灯
									 --     ,NVL(B.本月一级节点黄灯,0) AS 本月一级节点黄灯
									 --     ,NVL(B.本月一级节点红灯,0) AS 本月一级节点红灯
									 --     ,NVL(B.本月二三级节点绿灯,0) AS 本月二三级节点绿灯
									 --     ,NVL(B.本月二三级节点黄灯,0) AS 本月二三级节点黄灯
									 --     ,NVL(B.本月二三级节点红灯,0) AS 本月二三级节点红灯
									, NVL(B.本季度里程碑绿灯, 0) AS 本季度里程碑绿灯,
									 NVL(B.本季度里程碑黄灯, 0) AS 本季度里程碑黄灯,
									 NVL(B.本季度里程碑红灯, 0) AS 本季度里程碑红灯,
									 NVL(B.本季度一级节点绿灯, 0) AS 本季度一级节点绿灯,
									 NVL(B.本季度一级节点黄灯, 0) AS 本季度一级节点黄灯,
									 NVL(B.本季度一级节点红灯, 0) AS 本季度一级节点红灯,
									 NVL(B.本季度二三级节点绿灯, 0) AS 本季度二三级节点绿灯,
									 NVL(B.本季度二三级节点黄灯, 0) AS 本季度二三级节点黄灯,
									 NVL(B.本季度二三级节点红灯, 0) AS 本季度二三级节点红灯
									 
									, 'TYPE_ORG' AS CTYPE
						FROM   SYS_BUSINESS_UNIT A
						LEFT   JOIN (SELECT AB.ID, AB.PARENT_ID, SUM(AB.本年应完成) AS 本年应完成,
																SUM(AB.本年已完成) AS 本年已完成,
																SUM(AB.本季度应完成) AS 本季度应完成,
																SUM(AB.本季度已完成) AS 本季度已完成
																--     ,SUM(AB.本月应完成) AS 本月应完成
																--     ,SUM(AB.本月已完成) AS 本月已完成
																/*动态得分情况*/
																--     ,SUM(AB.本月动态得分) AS 本月动态得分
															 , SUM(AB.本季度动态得分) AS 本季度动态得分
																/*里程碑、一级节点完成情况*/
																--     ,SUM(AB.本月里程碑应完成) AS 本月里程碑应完成
																--     ,SUM(AB.本月里程碑已完成) AS 本月里程碑已完成
																--     ,SUM(AB.本月一级节点应完成) AS 本月一级节点应完成
																--     ,SUM(AB.本月一级节点已完成) AS 本月一级节点已完成
															 , SUM(AB.本季度里程碑应完成) AS 本季度里程碑应完成,
																SUM(AB.本季度里程碑已完成) AS 本季度里程碑已完成,
																SUM(AB.本季度一级节点应完成) AS 本季度一级节点应完成,
																SUM(AB.本季度一级节点已完成) AS 本季度一级节点已完成
																/*亮点情况*/
																--     ,SUM(AB.本月里程碑绿灯) AS 本月里程碑绿灯
																--     ,SUM(AB.本月里程碑黄灯) AS 本月里程碑黄灯
																--     ,SUM(AB.本月里程碑红灯) AS 本月里程碑红灯
																--     ,SUM(AB.本月一级节点绿灯) AS 本月一级节点绿灯
																--     ,SUM(AB.本月一级节点黄灯) AS 本月一级节点黄灯
																--     ,SUM(AB.本月一级节点红灯) AS 本月一级节点红灯
																--     ,SUM(AB.本月二三级节点绿灯) AS 本月二三级节点绿灯
																--     ,SUM(AB.本月二三级节点黄灯) AS 本月二三级节点黄灯
																--     ,SUM(AB.本月二三级节点红灯) AS 本月二三级节点红灯
															 , SUM(AB.本季度里程碑绿灯) AS 本季度里程碑绿灯,
																SUM(AB.本季度里程碑黄灯) AS 本季度里程碑黄灯,
																SUM(AB.本季度里程碑红灯) AS 本季度里程碑红灯,
																SUM(AB.本季度一级节点绿灯) AS 本季度一级节点绿灯,
																SUM(AB.本季度一级节点黄灯) AS 本季度一级节点黄灯,
																SUM(AB.本季度一级节点红灯) AS 本季度一级节点红灯,
																SUM(AB.本季度二三级节点绿灯) AS 本季度二三级节点绿灯,
																SUM(AB.本季度二三级节点黄灯) AS 本季度二三级节点黄灯,
																SUM(AB.本季度二三级节点红灯) AS 本季度二三级节点红灯
												 FROM   (
																	--  11
																	
																	SELECT
																	/*完成情况*/
																	 NVL(B.本年应完成, 0) AS 本年应完成,
																		NVL(B.本年已完成, 0) AS 本年已完成,
																		NVL(B.本季度应完成, 0) AS 本季度应完成,
																		NVL(B.本季度已完成, 0) AS 本季度已完成
																		--                    ,NVL(B.本月应完成,0) AS 本月应完成
																		--                    ,NVL(B.本月已完成,0) AS 本月已完成
																		/*动态得分情况*/
																		--                    ,NVL(B.本月动态得分,0) AS 本月动态得分
																	, NVL(B.本季度动态得分, 0) AS 本季度动态得分
																		/*里程碑、一级节点完成情况*/
																		--                    ,NVL(B.本月里程碑应完成,0) AS 本月里程碑应完成
																		--                    ,NVL(B.本月里程碑已完成,0) AS 本月里程碑已完成
																		--                    ,NVL(B.本月一级节点应完成,0) AS 本月一级节点应完成
																		--                    ,NVL(B.本月一级节点已完成,0) AS 本月一级节点已完成
																	, NVL(B.本季度里程碑应完成, 0) AS 本季度里程碑应完成,
																		NVL(B.本季度里程碑已完成, 0) AS 本季度里程碑已完成,
																		NVL(B.本季度一级节点应完成, 0) AS 本季度一级节点应完成,
																		NVL(B.本季度一级节点已完成, 0) AS 本季度一级节点已完成
																		/*亮点情况*/
																		--                    ,NVL(B.本月里程碑绿灯,0) AS 本月里程碑绿灯
																		--                    ,NVL(B.本月里程碑黄灯,0) AS 本月里程碑黄灯
																		--                    ,NVL(B.本月里程碑红灯,0) AS 本月里程碑红灯
																		--                    ,NVL(B.本月一级节点绿灯,0) AS 本月一级节点绿灯
																		--                    ,NVL(B.本月一级节点黄灯,0) AS 本月一级节点黄灯
																		--                    ,NVL(B.本月一级节点红灯,0) AS 本月一级节点红灯
																		--                    ,NVL(B.本月二三级节点绿灯,0) AS 本月二三级节点绿灯
																		--                    ,NVL(B.本月二三级节点黄灯,0) AS 本月二三级节点黄灯
																		--                    ,NVL(B.本月二三级节点红灯,0) AS 本月二三级节点红灯
																	, NVL(B.本季度里程碑绿灯, 0) AS 本季度里程碑绿灯,
																		NVL(B.本季度里程碑黄灯, 0) AS 本季度里程碑黄灯,
																		NVL(B.本季度里程碑红灯, 0) AS 本季度里程碑红灯,
																		NVL(B.本季度一级节点绿灯, 0) AS 本季度一级节点绿灯,
																		NVL(B.本季度一级节点黄灯, 0) AS 本季度一级节点黄灯,
																		NVL(B.本季度一级节点红灯, 0) AS 本季度一级节点红灯,
																		NVL(B.本季度二三级节点绿灯, 0) AS 本季度二三级节点绿灯,
																		NVL(B.本季度二三级节点黄灯, 0) AS 本季度二三级节点黄灯,
																		NVL(B.本季度二三级节点红灯, 0) AS 本季度二三级节点红灯,
																		CONNECT_BY_ROOT ID AS ID,
																		CONNECT_BY_ROOT PARENT_ID AS PARENT_ID
																	FROM   SYS_BUSINESS_UNIT A
																	LEFT   JOIN (
																							 
																							 SELECT B1.UNIT_ID,
																											 COUNT(A1.ID) AS "NODESUM",
																											 SUM(STANDARD_SCORE) AS "SUMNODESCORE"
																											 --完成规则
																											 
																											 ------------------
																											 /*本年任务*/
																											 ------------------
																											 ------
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.PLAN_END_DATE, 'YYYY') = TO_CHAR(SYSDATE, 'YYYY') THEN
																																 1
																																ELSE
																																 0
																														END
																														
																														) AS "本年应完成",
																											 SUM((CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本年
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY') = TO_CHAR(SYSDATE, 'YYYY')
																																--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																 THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本年已完成"
																											 
																											 ------------------
																											 /*本季度任务*/
																											 ------------------
																											 ------
																											 ,
																											 SUM((CASE
																																WHEN
																																--判断季度
																																 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																 (SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																	FROM   V_POM_GETEXAMINE_QUARTER A) AND
																																 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																	FROM   V_POM_GETEXAMINE_QUARTER A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本季度应完成",
																											 SUM((CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																 THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本季度已完成"
																											 
																											 ,
																											 SUM((CASE
																														--按时完成
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(A1.PLAN_END_DATE, 'DD') - TRUNC(D.APPROVAL_TIME, 'DD')) BETWEEN 0 AND 29 THEN
																																 A1.STANDARD_SCORE * 1
																														
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL --判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(A1.PLAN_END_DATE, 'DD') - TRUNC(D.APPROVAL_TIME, 'DD')) >= 30 AND
																																		 A1.NODE_LEVEL = '里程碑' THEN
																																 A1.STANDARD_SCORE * 1.2
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(A1.PLAN_END_DATE, 'DD') - TRUNC(D.APPROVAL_TIME, 'DD')) >= 30 AND
																																		 A1.NODE_LEVEL = '一级节点' THEN
																																 A1.STANDARD_SCORE * 1.1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(A1.PLAN_END_DATE, 'DD') - TRUNC(D.APPROVAL_TIME, 'DD')) >= 30 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 A1.STANDARD_SCORE * 1.0
																														--延时完成
																														--里程碑、一级节点3天
																														--二三级节点5天
																														--延时完成
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('里程碑', '一级节点') THEN
																																 A1.STANDARD_SCORE * 0.6
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 3 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 A1.STANDARD_SCORE * 1.0
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 4 AND 7 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 A1.STANDARD_SCORE * 0.6
																														--红灯
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('里程碑', '一级节点') THEN
																																 A1.STANDARD_SCORE * 0
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 8 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 A1.STANDARD_SCORE * 0
																																ELSE
																																 0
																														END)) AS "本季度动态得分"
																											 
																											 ------------------
																											 /*-里程碑完成情况*/
																											 ------------------
																											 ,
																											 SUM((CASE
																																WHEN A1. NODE_LEVEL = '里程碑' AND
																																		 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																			 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本季度里程碑应完成",
																											 SUM((CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL AND A1.
																																 NODE_LEVEL = '里程碑' AND
																																		 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本季度里程碑已完成"
																											 ------------------
																											 /*-一级节点完成情况*/
																											 ------------------
																											 ,
																											 SUM((CASE
																																WHEN A1. NODE_LEVEL = '一级节点' AND
																																		 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																			 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本季度一级节点应完成",
																											 SUM((CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL AND A1.
																																 NODE_LEVEL = '一级节点' AND
																																		 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本季度一级节点已完成"
																											 
																											 ------------------
																											 /*-里程碑本季度亮灯情况*/
																											 ------------------
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) <= 0 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度里程碑绿灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度里程碑黄灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度里程碑红灯"
																											 
																											 ------------------
																											 /*一级节点本季度亮灯情况*/
																											 ------------------
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) <= 0 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度一级节点绿灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度一级节点黄灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度一级节点红灯"
																											 
																											 ------------------
																											 /*二三级节点本季度亮灯情况*/
																											 ------------------
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) <= 2 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度二三级节点绿灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 3 AND 7 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 3 AND 7 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度二三级节点黄灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 8 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 8 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度二三级节点红灯"
																							 
																							 FROM   POM_PROJ_PLAN A
																							 INNER  JOIN POM_PROJ_PLAN_NODE A1
																							 ON     A.ID = A1.PROJ_PLAN_ID
																							 INNER  JOIN SYS_PROJECT_STAGE C1
																							 ON     A.PROJ_ID = C1.ID
																							 INNER  JOIN SYS_PROJECT B1
																							 ON     C1.PROJECT_ID = B1.ID
																							 LEFT   JOIN POM_NODE_FEEDBACK D
																							 ON     D.FEEDBACK_NODE_ID = A1.ID AND
																											FEEDBACK_TYPE = '完成反馈' AND
																											D.APPROVAL_STATUS = '已审核'
																							 WHERE  A.PLAN_TYPE = '项目主项计划' AND
																											A.APPROVAL_STATUS = '已审核'
																							 GROUP  BY B1.UNIT_ID) B
																	ON     A.ID = B.UNIT_ID
																	WHERE  NVL(B.NODESUM, 0) > 0
																	CONNECT BY PRIOR A.ID = A.PARENT_ID) AB
												 GROUP  BY AB.ID, AB.PARENT_ID) B
						ON     A.ID = B.ID
						WHERE  A.ORG_TYPE = 0 AND
									 A.COMPANY_TYPE = '5' AND
									 A.PARENT_ID = '003200000000000000000000000000';
		END IF;

END P_POM_RANK_ORG_GETDTL;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_RANK_PROJ_EXAM_DTL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_RANK_PROJ_EXAM_DTL" (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    rangetype      IN             INT,--时间范围类型（10:月度，20季度）
    rangeval       IN             VARCHAR2,--范围值，月度：2019|09。季度：2019|04
    orgid          IN             VARCHAR2,--组织id(关键节点计划传空,项目主项计划传）
    title          OUT            VARCHAR2,
    info           OUT            SYS_REFCURSOR--需要程序组装树
) AS
--公司考核排行详情
--作者：陈丽
--日期：2019/11/13
BEGIN




IF rangetype=10 then
    OPEN info FOR

  SELECT
  A.ORG_NAME  AS "company"
     ,  A.ID AS "orgId"
		 , CASE  WHEN  A.ID=''||orgid||''  THEN NULL ELSE A.PARENT_ID END    AS "parentId"
    --,TO_CHAR(ROUND(CASE WHEN SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=A.PLANYEAR  THEN  应完成  ELSE 0 END )>0 THEN   SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=A.PLANYEAR  THEN  已完成  ELSE 0 END)/SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=A.PLANYEAR  THEN  应完成  ELSE 0 END )*100  ELSE 0 END,2) )   AS  "yearPercentageComplete"
    ,TO_CHAR(SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=A.PLANYEAR  THEN  应完成  ELSE 0 END)) AS "yearShouldComplete"--本年应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=A.PLANYEAR  THEN  已完成  ELSE 0 END) AS "yearDone"--本年已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=A.PLANYEAR  THEN  应完成  ELSE 0 END) - SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=A.PLANYEAR  THEN  已完成  ELSE 0 END) AS "yearUnfinished"--本年未完成数
    , CASE  WHEN SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  SUMNODESCORE  ELSE 0 END)  >0 THEN  ROUND(SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  动态得分  ELSE 0 END)/SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  SUMNODESCORE  ELSE 0 END)*100,2) ELSE 0 END  AS "dynamicScoring"--本月、季度动态得分
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  应完成  ELSE 0 END) AS "monthShouldComplete"--本月、季度应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  SUMNODESCORE  ELSE 0 END) AS "monthShouldCompleteScore"--本月应完成总分
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  已完成  ELSE 0 END)  AS "monthdDone"--本月、季度已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  已完成总分  ELSE 0 END)  AS "monthdDoneScore"--本月已完成总分
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  应完成  ELSE 0 END)  - SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  已完成  ELSE 0 END)  AS "monthUnfinished"--本月未完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  里程碑红灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  一级节点红灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN   二级节点红灯 + 三级节点红灯  ELSE 0 END)  AS "red"--红灯数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  里程碑黄灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  一级节点黄灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  二级节点黄灯+三级节点黄灯  ELSE 0 END)   AS "yellow"--黄灯数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  里程碑绿灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  一级节点绿灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  二级节点绿灯+三级节点绿灯  ELSE 0 END)  AS "green"--绿灯数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  里程碑应完成  ELSE 0 END)  AS "milestoneShouldComplete"--里程碑应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  里程碑已完成  ELSE 0 END) AS "milestoneDone"--里程碑已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  里程碑应完成  ELSE 0 END)-SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  里程碑已完成  ELSE 0 END) AS "milestoneUnfinished"--里程碑未完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  一级节点应完成  ELSE 0 END) AS "oneLevelNodeShouldComplete"--一级节点应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  一级节点已完成  ELSE 0 END)  AS "oneLevelNodeDone"--一级节点已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  一级节点应完成  ELSE 0 END) -SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  一级节点已完成  ELSE 0 END)   AS "oneLevelNodeUnfinished"--一级节点未完成数

    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  二级节点应完成  ELSE 0 END) AS "twoLevelNodeShouldComplete"--二级节点应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  二级节点已完成  ELSE 0 END)  AS "twoLevelNodeDone"--二级节点已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  二级节点应完成  ELSE 0 END) -SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  二级节点已完成  ELSE 0 END)   AS "twoLevelNodeUnfinished"--二级节点未完成数
      ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  三级节点应完成  ELSE 0 END) AS "threeLevelNodeShouldComplete"--三级节点应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  三级节点已完成  ELSE 0 END)  AS "threeLevelNodeDone"--三级节点已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  三级节点应完成  ELSE 0 END) -SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  三级节点已完成  ELSE 0 END)   AS "threeLevelNodeUnfinished"--三级节点未完成数
    ,    '' as  "openUrl"--打开地址

FROM  V_POM_PJPLANRANK A
WHERE A.应完成>0 AND  A.PLAN_TYPE='项目主项计划'  --AND  CTYPE='TYPE_ORG'
AND SUBSTR(rangeval, 0, 4)=A.PLANYEAR
AND( A.PARENT_ID  IN (  SELECT a.ID
	from   SYS_BUSINESS_UNIT A
	where  1=1 and    IS_COMPANY=1
	START WITH a.id=''||orgid||''
	CONNECT  by PRIOR   A.ID= A.PARENT_ID	)
	OR A.ID=''||orgid||'')

GROUP BY A.ORG_NAME   ,A.ID,A.PARENT_ID   ORDER BY 4 DESC     ;

ELSIF rangetype=20 then
    OPEN info FOR


  SELECT
  A.ORG_NAME  AS "company"
    ,  A.ID AS "orgId"
		, CASE  WHEN  A.ID=''||orgid||''  THEN NULL ELSE A.PARENT_ID END    AS "parentId"
    ,ROUND(CASE WHEN SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=A.PLANYEAR  THEN  应完成  ELSE 0 END )>0 THEN   SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=A.PLANYEAR  THEN  已完成  ELSE 0 END)/SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=A.PLANYEAR  THEN  应完成  ELSE 0 END )*100  ELSE 0 END,2)    AS  "yearShouldComplete"
    ,SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=A.PLANYEAR  THEN  应完成  ELSE 0 END) AS "yearShouldComplete"--本年应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=A.PLANYEAR  THEN  已完成  ELSE 0 END) AS "yearDone"--本年已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=A.PLANYEAR  THEN  应完成  ELSE 0 END) - SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=A.PLANYEAR  THEN  已完成  ELSE 0 END) AS "yearUnfinished"--本年未完成数
    , CASE WHEN SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN   SUMNODESCORE  ELSE 0 END) >0 THEN ROUND(SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  动态得分  ELSE 0 END) / SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN   SUMNODESCORE  ELSE 0 END)*100,2)  ELSE 0 END AS "dynamicScoring"--本月、季度动态得分
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  应完成  ELSE 0 END) AS "quarterShouldComplete"--本月、季度应完成数
    ,SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN SUMNODESCORE ELSE 0 END) AS "quarterShouldCompleteScore" --本月、季度应完成分数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  已完成  ELSE 0 END)  AS "quarterDone"--本月、季度已完成数
    ,SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN 已完成总分 ELSE 0 END) AS "quarterDoneScore" --本月、季度已完成分数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  应完成  ELSE 0 END)  - SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  已完成  ELSE 0 END)  AS "quarterUnfinished"--本月未完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  里程碑红灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  一级节点红灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN   二级节点红灯 + 三级节点红灯  ELSE 0 END)  AS "red"--红灯数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  里程碑黄灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  一级节点黄灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  二级节点黄灯+三级节点黄灯  ELSE 0 END)   AS "yellow"--黄灯数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  里程碑绿灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  一级节点绿灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  二级节点绿灯+三级节点绿灯  ELSE 0 END)  AS "green"--绿灯数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  里程碑应完成  ELSE 0 END)  AS "milestoneShouldComplete"--里程碑应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  里程碑已完成  ELSE 0 END) AS "milestoneDone"--里程碑已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  里程碑应完成  ELSE 0 END)-SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  里程碑已完成  ELSE 0 END) AS "milestoneUnfinished"--里程碑未完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  一级节点应完成  ELSE 0 END) AS "oneLevelNodeShouldComplete"--一级节点应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  一级节点已完成  ELSE 0 END)  AS "oneLevelNodeDone"--一级节点已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  一级节点应完成  ELSE 0 END) -SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  一级节点已完成  ELSE 0 END)   AS "oneLevelNodeUnfinished"--一级节点未完成数

    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  二级节点应完成  ELSE 0 END) AS "twoLevelNodeShouldComplete"--二级节点应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  二级节点已完成  ELSE 0 END)  AS "twoLevelNodeDone"--二级节点已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  二级节点应完成  ELSE 0 END) -SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  二级节点已完成  ELSE 0 END)   AS "twoLevelNodeUnfinished"--二级节点未完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  三级节点应完成  ELSE 0 END) AS "threeLevelNodeShouldComplete"--三级节点应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  三级节点已完成  ELSE 0 END)  AS "threeLevelNodeDone"--三级节点已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  三级节点应完成  ELSE 0 END) -SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=A.PLANMOTH  THEN  三级节点已完成  ELSE 0 END)   AS "threeLevelNodeUnfinished"--三级节点未完成数
    ,  '' as  "openUrl"--打开地址

FROM  V_POM_PJPLANRANK A
WHERE A.应完成>0 AND  A.PLAN_TYPE='项目主项计划'  --AND  CTYPE='TYPE_ORG'
AND SUBSTR(rangeval, 0, 4)=A.PLANYEAR
AND( A.PARENT_ID  IN (  SELECT a.ID
	from   SYS_BUSINESS_UNIT A
	where  1=1 and    IS_COMPANY=1
	START WITH a.id=''||orgid||''
	CONNECT  by PRIOR   A.ID= A.PARENT_ID	)
	OR A.ID=''||orgid||'')

GROUP BY A.ORG_NAME   ,A.ID,A.PARENT_ID   ORDER BY 4 DESC     ;
END  IF;
    title := '考核排行榜_主项目计划明细数据统计';
END p_pom_rank_proj_exam_dtl;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_RANK_PROJ_EXAM_DTLTEST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_RANK_PROJ_EXAM_DTLTEST" 
(
orgid   IN  VARCHAR2,
info           OUT            SYS_REFCURSOR
)
AS
BEGIN

OPEN info FOR
SELECT
  row_number() over( PARTITION  BY A.PARENT_ID  order by ROUND( CASE WHEN NVL(B.应完成,0)>0 THEN nvl(已完成,0)/NVL(B.应完成,0) ELSE 0 END *100,2) desc) as rank ,
  '项目主项计划'AS  PLAN_TYPE,A.ID,A.PARENT_ID,A.ORG_NAME ,B.PLANYEAR  ,B.PLANQUATOR,B.PLANMOTH
--     ,NVL(B.本季度应完成,0) AS 本季度应完成
--     ,NVL(B.本季度已完成,0) AS 本季度已完成
    ,NVL(B.应完成,0) AS 应完成
    ,NVL(B.已完成,0) AS 已完成
    /*动态得分情况*/
    , NVL(B.动态得分,0) AS 动态得分
    ,NVL(B.SUMNODESCORE,0) AS SUMNODESCORE
--     ,NVL(B.本季度动态得分,0) AS 本季度动态得分
    /*里程碑、一级节点完成情况*/
    ,NVL(B.里程碑应完成,0) AS 里程碑应完成
    ,NVL(B.里程碑已完成,0) AS 里程碑已完成
    ,NVL(B.一级节点应完成,0) AS 一级节点应完成
    ,NVL(B.一级节点已完成,0) AS 一级节点已完成
    ,NVL(B.二级节点应完成,0) AS 二级节点应完成
    ,NVL(B.二级节点已完成,0) AS 二级节点已完成
    ,NVL(B.三级节点应完成,0) AS 三级节点应完成
    ,NVL(B.三级节点已完成,0) AS 三级节点已完成
--     ,NVL(B.本季度里程碑应完成,0) AS 本季度里程碑应完成
--     ,NVL(B.本季度里程碑已完成,0) AS 本季度里程碑已完成
--     ,NVL(B.本季度一级节点应完成,0) AS 本季度一级节点应完成
--     ,NVL(B.本季度一级节点已完成,0) AS 本季度一级节点已完成
    /*亮点情况*/
    ,NVL(B.里程碑绿灯,0) AS 里程碑绿灯
    ,NVL(B.里程碑黄灯,0) AS 里程碑黄灯
    ,NVL(B.里程碑红灯,0) AS 里程碑红灯
    ,NVL(B.一级节点绿灯,0) AS 一级节点绿灯
    ,NVL(B.一级节点黄灯,0) AS 一级节点黄灯
    ,NVL(B.一级节点红灯,0) AS 一级节点红灯
    ,NVL(B.二级节点绿灯,0) AS 二级节点绿灯
    ,NVL(B.二级节点黄灯,0) AS 二级节点黄灯
    ,NVL(B.二级节点红灯,0) AS 二级节点红灯
    ,NVL(B.三级节点绿灯,0) AS 三级节点绿灯
    ,NVL(B.三级节点黄灯,0) AS 三级节点黄灯
    ,NVL(B.三级节点红灯,0) AS 三级节点红灯

--     ,NVL(B.本季度里程碑绿灯,0) AS 本季度里程碑绿灯
--     ,NVL(B.本季度里程碑黄灯,0) AS 本季度里程碑黄灯
--     ,NVL(B.本季度里程碑红灯,0) AS 本季度里程碑红灯
--     ,NVL(B.本季度一级节点绿灯,0) AS 本季度一级节点绿灯
--     ,NVL(B.本季度一级节点黄灯,0) AS 本季度一级节点黄灯
--     ,NVL(B.本季度一级节点红灯,0) AS 本季度一级节点红灯
--     ,NVL(B.本季度二三级节点绿灯,0) AS 本季度二三级节点绿灯
--     ,NVL(B.本季度二三级节点黄灯,0) AS 本季度二三级节点黄灯
--     ,NVL(B.本季度二三级节点红灯,0) AS 本季度二三级节点红灯

  ,'TYPE_ORG' AS CTYPE
FROM SYS_BUSINESS_UNIT A LEFT JOIN  (
 SELECT AB.ID,AB.PARENT_ID
 ,AB.PLANYEAR  ,AB.PLANQUATOR,AB.PLANMOTH
--     ,SUM(AB.本季度应完成) AS 本季度应完成
--     ,SUM(AB.本季度已完成) AS 本季度已完成
    ,SUM(AB.应完成) AS 应完成
    ,SUM(AB.已完成) AS 已完成
    /*动态得分情况*/
    ,SUM(AB.动态得分) AS 动态得分
    ,SUM(AB.SUMNODESCORE) AS SUMNODESCORE
--     ,SUM(AB.本季度动态得分) AS 本季度动态得分
    /*里程碑、一级节点完成情况*/
    ,SUM(AB.里程碑应完成) AS 里程碑应完成
     ,SUM(AB.里程碑已完成) AS 里程碑已完成
     ,SUM(AB.一级节点应完成) AS 一级节点应完成
     ,SUM(AB.一级节点已完成) AS 一级节点已完成
     ,SUM(AB.二级节点应完成) AS 二级节点应完成
     ,SUM(AB.二级节点已完成) AS 二级节点已完成
     ,SUM(AB.三级节点应完成) AS 三级节点应完成
     ,SUM(AB.三级节点已完成) AS 三级节点已完成
  --                    ,NVL(B.本季度里程碑应完成,0) AS 本季度里程碑应完成
  --                    ,NVL(B.本季度里程碑已完成,0) AS 本季度里程碑已完成
  --                    ,NVL(B.本季度一级节点应完成,0) AS 本季度一级节点应完成
  --                    ,NVL(B.本季度一级节点已完成,0) AS 本季度一级节点已完成
     /*亮点情况*/
     ,SUM(AB.里程碑绿灯) AS 里程碑绿灯
     ,SUM(AB.里程碑黄灯) AS 里程碑黄灯
     ,SUM(AB.里程碑红灯) AS 里程碑红灯
     ,SUM(AB.一级节点绿灯) AS 一级节点绿灯
     ,SUM(AB.一级节点黄灯) AS 一级节点黄灯
     ,SUM(AB.一级节点红灯) AS 一级节点红灯
     ,SUM(AB.二级节点绿灯) AS 二级节点绿灯
     ,SUM(AB.二级节点黄灯) AS 二级节点黄灯
     ,SUM(AB.二级节点红灯) AS 二级节点红灯
     ,SUM(AB.三级节点绿灯) AS 三级节点绿灯
     ,SUM(AB.三级节点黄灯) AS 三级节点黄灯
     ,SUM(AB.三级节点红灯) AS 三级节点红灯

--     ,SUM(AB.本季度里程碑绿灯) AS 本季度里程碑绿灯
--     ,SUM(AB.本季度里程碑黄灯) AS 本季度里程碑黄灯
--     ,SUM(AB.本季度里程碑红灯) AS 本季度里程碑红灯
--     ,SUM(AB.本季度一级节点绿灯) AS 本季度一级节点绿灯
--     ,SUM(AB.本季度一级节点黄灯) AS 本季度一级节点黄灯
--     ,SUM(AB.本季度一级节点红灯) AS 本季度一级节点红灯
--     ,SUM(AB.本季度二三级节点绿灯) AS 本季度二三级节点绿灯
--     ,SUM(AB.本季度二三级节点黄灯) AS 本季度二三级节点黄灯
--     ,SUM(AB.本季度二三级节点红灯) AS 本季度二三级节点红灯
     FROM  (
--  11

                   SELECT
                  /*完成情况*/
--                    ,NVL(B.本季度应完成,0) AS 本季度应完成
--                    ,NVL(B.本季度已完成,0) AS 本季度已完成
                    B.PLANYEAR
                    ,B.PLANQUATOR
                    ,B.PLANMOTH
                   ,NVL(B.应完成,0) AS 应完成
                   ,NVL(B.已完成,0) AS 已完成
                   /*动态得分情况*/
                   ,NVL(B.SUMNODESCORE,0)  AS "SUMNODESCORE"
                   ,NVL(B.动态得分,0) AS 动态得分
--                    ,NVL(B.本季度动态得分,0) AS 本季度动态得分
                   /*里程碑、一级节点完成情况*/
                   ,NVL(B.里程碑应完成,0) AS 里程碑应完成
                   ,NVL(B.里程碑已完成,0) AS 里程碑已完成
                   ,NVL(B.一级节点应完成,0) AS 一级节点应完成
                   ,NVL(B.一级节点已完成,0) AS 一级节点已完成
                   ,NVL(B.二级节点应完成,0) AS 二级节点应完成
                   ,NVL(B.二级节点已完成,0) AS 二级节点已完成
                   ,NVL(B.三级节点应完成,0) AS 三级节点应完成
                   ,NVL(B.三级节点已完成,0) AS 三级节点已完成
--                    ,NVL(B.本季度里程碑应完成,0) AS 本季度里程碑应完成
--                    ,NVL(B.本季度里程碑已完成,0) AS 本季度里程碑已完成
--                    ,NVL(B.本季度一级节点应完成,0) AS 本季度一级节点应完成
--                    ,NVL(B.本季度一级节点已完成,0) AS 本季度一级节点已完成
                   /*亮点情况*/
                   ,NVL(B.里程碑绿灯,0) AS 里程碑绿灯
                   ,NVL(B.里程碑黄灯,0) AS 里程碑黄灯
                   ,NVL(B.里程碑红灯,0) AS 里程碑红灯
                   ,NVL(B.一级节点绿灯,0) AS 一级节点绿灯
                   ,NVL(B.一级节点黄灯,0) AS 一级节点黄灯
                   ,NVL(B.一级节点红灯,0) AS 一级节点红灯
                   ,NVL(B.二级节点绿灯,0) AS 二级节点绿灯
                   ,NVL(B.二级节点黄灯,0) AS 二级节点黄灯
                   ,NVL(B.二级节点红灯,0) AS 二级节点红灯
                   ,NVL(B.三级节点绿灯,0) AS 三级节点绿灯
                   ,NVL(B.三级节点黄灯,0) AS 三级节点黄灯
                   ,NVL(B.三级节点红灯,0) AS 三级节点红灯

--                    ,NVL(B.本季度里程碑绿灯,0) AS 本季度里程碑绿灯
--                    ,NVL(B.本季度里程碑黄灯,0) AS 本季度里程碑黄灯
--                    ,NVL(B.本季度里程碑红灯,0) AS 本季度里程碑红灯
--                    ,NVL(B.本季度一级节点绿灯,0) AS 本季度一级节点绿灯
--                    ,NVL(B.本季度一级节点黄灯,0) AS 本季度一级节点黄灯
--                    ,NVL(B.本季度一级节点红灯,0) AS 本季度一级节点红灯
--                    ,NVL(B.本季度二三级节点绿灯,0) AS 本季度二三级节点绿灯
--                    ,NVL(B.本季度二三级节点黄灯,0) AS 本季度二三级节点黄灯
--                    ,NVL(B.本季度二三级节点红灯,0) AS 本季度二三级节点红灯
                   ,CONNECT_BY_ROOT ID AS  ID ,CONNECT_BY_ROOT PARENT_ID  AS  PARENT_ID
                   from   SYS_BUSINESS_UNIT A  LEFT JOIN
                   (


                   SELECT  B1.UNIT_ID ,COUNT(A1.ID) AS "NODESUM"

                , TO_CHAR(A1.PLAN_END_DATE,'YYYY')   AS  "PLANYEAR"
                , CASE WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '12-26'  AND '03-25'  THEN 1
                       WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '03-26'  AND '06-25'  THEN 2
                       WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '06-26'  AND '09-25'  THEN 3
                       WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '09-26'  AND '12-25'  THEN 4  END
                      AS "PLANQUATOR"
                ,CASE
                        WHEN
                        CASE
                            WHEN TO_CHAR( PLAN_END_DATE, 'DD' ) > 25 THEN
                            TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) )
                          END > 12 THEN
                    1 ELSE
                  CASE
                      WHEN TO_CHAR( PLAN_END_DATE, 'DD' ) > 25 THEN
                      TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) )
                    END
                    END AS "PLANMOTH"
                  ,SUM(STANDARD_SCORE)   AS "SUMNODESCORE"
                   --完成规则




                   ------------------
                   /*任务*/
                   ------------------
                   ------
                  , SUM(
                    (CASE
                      WHEN
                        TO_CHAR( A1.PLAN_END_DATE, 'YYYY-MM-DD' ) IS NOT NULL

                      THEN    1
                      ELSE 0
                      END
                      )
                    ) AS "应完成"
                  ,SUM( (CASE      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                   --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                     THEN     1  ELSE    0 END))   AS "已完成"

                  ,SUM(
                  (CASE
                  --按时完成
                      WHEN
                          TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                         --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                        AND  (TRUNC( A1.PLAN_END_DATE, 'DD' ) -TRUNC( D.APPROVAL_TIME, 'DD' ) )BETWEEN 0 AND 29
                      THEN   A1.STANDARD_SCORE*1
                      --提前一个月完成
                      WHEN
                          TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
                          --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( A1.PLAN_END_DATE, 'DD' ) -TRUNC( D.APPROVAL_TIME, 'DD' ) )>= 30   AND  A1.NODE_LEVEL='里程碑'
                      THEN   A1.STANDARD_SCORE*1.2
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                         --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                        AND  (TRUNC( A1.PLAN_END_DATE, 'DD' ) -TRUNC( D.APPROVAL_TIME, 'DD' ) )>= 30   AND  A1.NODE_LEVEL='一级节点'
                      THEN   A1.STANDARD_SCORE*1.1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                         --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'

                          AND  (TRUNC( A1.PLAN_END_DATE, 'DD' ) - TRUNC( D.APPROVAL_TIME, 'DD' ) )>= 30   AND  A1.NODE_LEVEL IN ('二级节点' ,'三级节点')
                      THEN   A1.STANDARD_SCORE*1.0
                  --延时完成
                  --里程碑、一级节点3天
                  --二三级节点5天
                  --延时完成
                    WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                         --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'

                        AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC(A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 1 AND 4 AND   A1.NODE_LEVEL IN ('里程碑' ,'一级节点')
                    THEN   A1.STANDARD_SCORE*0.6
                    WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                         --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'

                        AND  ( TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC(A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 1 AND 3 AND A1.NODE_LEVEL IN ('二级节点' ,'三级节点')
                    THEN   A1.STANDARD_SCORE*1.0
                    WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                       --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                        AND  ( TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC(A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 4 AND 7 AND A1.NODE_LEVEL IN ('二级节点' ,'三级节点')
                    THEN   A1.STANDARD_SCORE*0.6
                  --红灯
                    WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                       --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'

                      AND  ( TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC(A1.PLAN_END_DATE, 'DD' )  )  >=5 AND    A1.NODE_LEVEL IN ('里程碑' ,'一级节点')
                    THEN   A1.STANDARD_SCORE*0
                    WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                       --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'

                      AND  ( TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC(A1.PLAN_END_DATE, 'DD' )  )>=8  AND  A1.NODE_LEVEL IN ('二级节点' ,'三级节点')
                    THEN   A1.STANDARD_SCORE*0
                  ELSE  0 END
                  )
                  )   AS "动态得分"

                   ------------------
                   /*-里程碑完成情况*/
                   ------------------
                  ,SUM((CASE  WHEN      A1. NODE_LEVEL='里程碑'

                              THEN   1  ELSE    0 END))   AS "里程碑应完成"
                  ,SUM((CASE  WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
                              AND A1. NODE_LEVEL='里程碑'
                              THEN   1  ELSE    0 END))   AS "里程碑已完成"
                   ------------------
                   /*-一级节点完成情况*/
                   ------------------
                  ,SUM((CASE   WHEN     A1. NODE_LEVEL='一级节点'
                                THEN   1  ELSE    0 END))   AS "一级节点应完成"
                  ,SUM((CASE   WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
                              AND A1. NODE_LEVEL='一级节点'
                                   THEN   1  ELSE    0 END))   AS "一级节点已完成"
                   ------------------
                   /*-二级节点完成情况*/
                   ------------------
                  ,SUM((CASE   WHEN     A1. NODE_LEVEL='二级节点'
                                THEN   1  ELSE    0 END))   AS "二级节点应完成"
                  ,SUM((CASE   WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
                              AND A1. NODE_LEVEL='二级节点'
                                   THEN   1  ELSE    0 END))   AS "二级节点已完成"
                     ------------------
                   /*-三级节点完成情况*/
                   ------------------
                  ,SUM((CASE   WHEN     A1. NODE_LEVEL='三级节点'
                                THEN   1  ELSE    0 END))   AS "三级节点应完成"
                  ,SUM((CASE   WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
                              AND A1. NODE_LEVEL='三年级节点'
                                   THEN   1  ELSE    0 END))   AS "三级节点已完成"

                    ------------------
                   /*-里程碑亮灯情况*/
                   ------------------
                   ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  <= 0 AND    A1.NODE_LEVEL IN ('里程碑')
                        THEN 1

                       ELSE  0  END ) AS  "里程碑绿灯"

                   ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 1 AND 4 AND    A1.NODE_LEVEL IN ('里程碑')
                        THEN 1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 1 AND 4  AND    A1.NODE_LEVEL IN ('里程碑')
                        THEN 1


                       ELSE  0  END ) AS  "里程碑黄灯"


                  ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=5 AND    A1.NODE_LEVEL IN ('里程碑')
                        THEN 1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=5 AND    A1.NODE_LEVEL IN ('里程碑')
                        THEN 1


                       ELSE  0  END ) AS  "里程碑红灯"



                    ------------------
                   /*一级节点亮灯情况*/
                   ------------------
                   ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  <= 0  AND    A1.NODE_LEVEL IN ('一级节点')
                        THEN 1

                       ELSE  0  END ) AS  "一级节点绿灯"

                   ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 1 AND 4 AND    A1.NODE_LEVEL IN ('一级节点')
                        THEN 1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 1 AND 4  AND    A1.NODE_LEVEL IN ('一级节点')
                        THEN 1


                       ELSE  0  END ) AS  "一级节点黄灯"


                  ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=5 AND    A1.NODE_LEVEL IN ('一级节点')
                        THEN 1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=5 AND    A1.NODE_LEVEL IN ('一级节点')
                        THEN 1


                       ELSE  0  END ) AS  "一级节点红灯"




                    ------------------
                   /*二级节点亮灯情况*/
                   ------------------
                   ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  <= 2 AND     A1.NODE_LEVEL IN ('二级节点')
                        THEN 1

                       ELSE  0  END ) AS  "二级节点绿灯"

                   ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 3 AND 7 AND    A1.NODE_LEVEL IN ('二级节点')
                        THEN 1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 3 AND 7  AND    A1.NODE_LEVEL IN  ('二级节点')
                        THEN 1


                       ELSE  0  END ) AS  "二级节点黄灯"


                  ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=8 AND    A1.NODE_LEVEL IN  ('二级节点')
                        THEN 1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=8 AND    A1.NODE_LEVEL IN  ('二级节点')
                        THEN 1


                    ELSE  0  END ) AS  "二级节点红灯"

                    ------------------
                   /*三级节点亮灯情况*/
                   ------------------
                   ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  <= 2 AND     A1.NODE_LEVEL IN ('三级节点')
                        THEN 1

                       ELSE  0  END ) AS  "三级节点绿灯"

                   ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 3 AND 7 AND    A1.NODE_LEVEL IN ('三级节点')
                        THEN 1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 3 AND 7  AND    A1.NODE_LEVEL IN  ('三级节点')
                        THEN 1


                       ELSE  0  END ) AS  "三级节点黄灯"


                  ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=8 AND    A1.NODE_LEVEL IN  ('三级节点')
                        THEN 1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=8 AND    A1.NODE_LEVEL IN  ('三级节点')
                        THEN 1


                    ELSE  0  END ) AS  "三级节点红灯"

                  FROM
                  POM_PROJ_PLAN A
                  INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
                  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
                  INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
                  LEFT JOIN POM_NODE_FEEDBACK D ON D.FEEDBACK_NODE_ID=A1.ID AND  FEEDBACK_TYPE='1' AND  D.APPROVAL_STATUS='已审核'
                  WHERE  A.PLAN_TYPE='项目主项计划' AND  A.APPROVAL_STATUS='已审核'
                  GROUP BY B1.UNIT_ID  , TO_CHAR(A1.PLAN_END_DATE,'YYYY')
                  , CASE WHEN CASE   WHEN TO_CHAR( PLAN_END_DATE, 'DD' ) > 25 THEN  TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) )
                        END > 12 THEN  1 ELSE  CASE    WHEN TO_CHAR( PLAN_END_DATE, 'DD' ) > 25 THEN    TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) )
                  END   END
                  , CASE WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '12-26'  AND '03-25'  THEN 1    WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '03-26'  AND '06-25'  THEN 2
                   WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '06-26'  AND '09-25'  THEN 3      WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '09-26'  AND '12-25'  THEN 4  END

                    )  B ON  A.ID=B.UNIT_ID
                    WHERE NVL(B.NODESUM,0)>0
										start with  a.id='45e9c408-dd59-4a41-8c50-7b4eaf6c1e46'
                  CONNECT  by PRIOR   A.ID= A.PARENT_ID
									
) AB
GROUP BY AB.ID,AB.PARENT_ID  ,AB.PLANYEAR  ,AB.PLANQUATOR,AB.PLANMOTH
)B  ON  A.ID=B.ID
WHERE  A.ORG_TYPE=0  ;--  AND  A.COMPANY_TYPE='5' AND  A.PARENT_ID='003200000000000000000000000000'
--

 

END p_pom_rank_proj_exam_dtltest;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_RANK_PROJ_EXAMINATION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_RANK_PROJ_EXAMINATION" (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    rangetype        IN             INT,--时间范围类型（10:月度，20季度）
     plantype       IN             INT,--计划类型（30：关键节点计划，40：项目主项计划）
    rangeval    IN          VARCHAR2,--范围值，月度：2019|09。季度：2019|04
    orgid       IN          VARCHAR2,--组织id(关键节点计划传空,项目主项计划传）
    title          OUT            VARCHAR2,--标题
    bartype        OUT            VARCHAR2,--图类型
    unit           OUT            VARCHAR2,--单位
    info      OUT            SYS_REFCURSOR--图数据
) AS
--项目考核排行
--作者：陈丽
--日期：2019/11/13
BEGIN

IF rangetype=10  AND plantype=30
THEN
OPEN info FOR
SELECT A.ORG_NAME AS "name",
			 TO_CHAR(CASE
									 WHEN SUM(CASE
																WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND
																		 SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
																 SUMNODESCORE
																ELSE
																 0
														END) > 0 THEN
										ROUND(SUM(CASE

																	WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND
																			 SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
																	 FINISHEXMSOCRE
																	ELSE
																	 0
															END) / SUM(CASE

																						 WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND
																									SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN
																							SUMNODESCORE
																						 ELSE
																							0
																				 END) * 100, 2)
									 ELSE
										0
							 END) AS "total"
				--,'90 'AS "total"
			 , '#37cd69' AS "color"
FROM   V_POM_PJPLAN_EXM_SOCRE A
INNER  JOIN SYS_BUSINESS_UNIT B
ON     A.ID = B.ID
WHERE  A.PARENT_ID = '' || ORGID || '' AND
			 A.CTYPE = 'TYPE_PROJTOP' AND
			 SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND
			 SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH AND
			 A.PLAN_TYPE = '关键节点计划'
--      AND   B.COMPANY_TYPE='5'
GROUP  BY A.ORG_NAME
ORDER  BY 2;

ELSIF RANGETYPE = 10 AND PLANTYPE = 40 THEN OPEN INFO FOR SELECT A.ORG_NAME AS "name", TO_CHAR(CASE WHEN SUM(CASE WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN SUMNODESCORE ELSE 0 END) > 0 THEN ROUND(SUM(CASE

WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN FINISHEXMSOCRE ELSE 0 END)
/ SUM(CASE

WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH THEN SUMNODESCORE ELSE 0 END) * 100, 2) ELSE 0 END) AS "total" --,'90 'AS "total"
, '#37cd69' AS "color" FROM V_POM_PJPLAN_EXM_SOCRE A INNER JOIN SYS_BUSINESS_UNIT B ON A.ID = B.ID WHERE A.ID = '' || ORGID || '' AND SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANMOTH AND A.CTYPE = 'TYPE_PROJTOP' AND A.PLAN_TYPE = '项目主项计划'

GROUP BY A.ORG_NAME ORDER BY 2;

ELSIF RANGETYPE = 20 AND PLANTYPE = 30 THEN OPEN INFO FOR SELECT A.ORG_NAME AS "name", TO_CHAR(CASE WHEN SUM(CASE WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN SUMNODESCORE ELSE 0 END) > 0 THEN ROUND(SUM(CASE

WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN FINISHEXMSOCRE ELSE 0 END)
/ SUM(CASE

WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN SUMNODESCORE ELSE 0 END) * 100, 2) ELSE 0 END) AS "total" --,'90 'AS "total"
, '#37cd69' AS "color" FROM V_POM_PJPLAN_EXM_SOCRE A INNER JOIN SYS_BUSINESS_UNIT B ON A.ID = B.ID WHERE A.ID = '' || ORGID || '' AND A.CTYPE = 'TYPE_PROJTOP' AND A.PLAN_TYPE = '关键节点计划' AND SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR
--      AND   B.COMPANY_TYPE='5'
GROUP BY A.ORG_NAME ORDER BY 2;

ELSIF RANGETYPE = 20 AND PLANTYPE = 40 THEN OPEN INFO FOR SELECT A.ORG_NAME AS "name", TO_CHAR(CASE WHEN SUM(CASE WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN SUMNODESCORE ELSE 0 END) > 0 THEN ROUND(SUM(CASE

WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN FINISHEXMSOCRE ELSE 0 END)
/ SUM(CASE

WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN SUMNODESCORE ELSE 0 END) * 100, 2) ELSE 0 END) AS "total" --,'90 'AS "total"
, '#37cd69' AS "color" FROM V_POM_PJPLAN_EXM_SOCRE A INNER JOIN SYS_BUSINESS_UNIT B ON A.ID = B.ID WHERE A.ID = '' || ORGID || '' AND SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR AND A.CTYPE = 'TYPE_PROJTOP' AND A.PLAN_TYPE = '项目主项计划'

GROUP BY A.ORG_NAME ORDER BY 2; END IF; TITLE := CASE WHEN PLANTYPE = 40 THEN '项目主项计划' ELSE '关键节点计划' END || '考核_项目排行榜：'; UNIT := '%'; BARTYPE := 'column';

END P_POM_RANK_PROJ_EXAMINATION;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_RULE_MSG_PRE_GENERATED
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_RULE_MSG_PRE_GENERATED" 
(
    RULEID        IN VARCHAR --规则ID
   ,MSGGROUPID    OUT VARCHAR --本次插入至POM_PRE_GENERATED_MESSAGE表中，唯一标识
   ,TOTAL         OUT NUMBER --本次更新的数据总数
   ,EXECUTIONTIME OUT VARCHAR --存储过程执行的时间
) AS
    --预警与提醒，消息预生成。
    --作者：陈丽
    --日期：2019/11/15

    VS_WHERE     CLOB; --SQL后面where过滤条件动态SQL
    VS_KEY_PLAN  CLOB; --关键节点计划动态SQL
    VS_PROJ_PLAN CLOB; --项目主项计划动态SQL
    VS_DEPT_PLAN CLOB; --部门月度计划动态SQL
    VS_SPEC_PLAN CLOB; --专项计划动态SQL
    VS_QUERY     CLOB; --拼接所有SQL

    V_FLAG            NUMBER(2, 0); --判断当前规则是否可执行，若判断规则设置有问题，直接RETURN
    V_RULE_TYPE       VARCHAR2(100); --记录当前规则类型
    V_PLAN_TYPE       VARCHAR(200); --存储规则类型
    V_SYSTEM_ID       VARCHAR(100); --系统ID，固定值，插入POM_PRE_GENERATED_MESSAGE表中时使用，勿改
    V_RULE_NODE_LEVEL VARCHAR(100); --存储规则的任务级别，用于拼接VS_WHERE字符串
    V_RULE_MSG        VARCHAR(200); --存储规则中定义的消息格式
    V_RULE_FERQ_TYPE  VARCHAR(200); --执行频率类别
    V_RULE_FERQ_DATE  VARCHAR(200); --哪一天执行，需根据执行类别进行判断

    V_MONTH_DAY VARCHAR(20); -- 取日期中的号
    V_WEEK_DAY  VARCHAR(20); -- 取星期几
    --定义RC_NODE_INFO类型，存储节点信息
    TYPE RC_NODE_INFO IS RECORD(
         PLAN_NAME        POM_PROJ_PLAN.PLAN_NAME%TYPE
        ,COMPANY_NAME     POM_PROJ_PLAN.COMPANY_NAME%TYPE
        ,DEPT_ID          POM_NODE_CHARGE_PERSON.CHARGE_PERSON_DEPT_ID%TYPE
        ,COMPANY_ID       POM_NODE_CHARGE_PERSON.CHARGE_PERSON_COMPANY_ID%TYPE
        ,NODE_NAME        POM_PROJ_PLAN_NODE.NODE_NAME%TYPE
        ,NODE_LEVEL       POM_PROJ_PLAN_NODE.NODE_LEVEL%TYPE
        ,PLAN_ID          POM_PROJ_PLAN_NODE.PROJ_PLAN_ID%TYPE
        ,NODE_ID          POM_PROJ_PLAN_NODE.ID%TYPE
        ,PLAN_START_DATE  VARCHAR(50)
        ,PLAN_END_DATE    VARCHAR(50)
        ,CHARGE_PERSON_ID POM_NODE_CHARGE_PERSON.ID%TYPE
        ,CHARGE_PERSON    POM_NODE_CHARGE_PERSON.CHARGE_PERSON%TYPE
        ,CURRENT_DATE     VARCHAR(50)
        ,NODE_MSG         VARCHAR(100)
        ,PROJ_ID          VARCHAR(100));
    --声明V_NODE_INFO变量

    V_NODE_INFO RC_NODE_INFO;
    --定义ref_type类型
    TYPE REF_TYPE IS REF CURSOR;
    VC_REF REF_TYPE;

    V_BUFFER VARCHAR(200); --用来存储过程中临时使用的值

BEGIN
    EXECUTIONTIME := TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MM:SS');
    MSGGROUPID    := GET_UUID();
    V_SYSTEM_ID   := '71313f018a35f3a558166cba7599b5d6';

    V_MONTH_DAY := TO_CHAR(SYSDATE, 'dd');
    V_WEEK_DAY := CASE
                      WHEN TO_CHAR(SYSDATE, 'day') = '星期一' THEN
                       1
                      WHEN TO_CHAR(SYSDATE, 'day') = '星期二' THEN
                       2
                      WHEN TO_CHAR(SYSDATE, 'day') = '星期三' THEN
                       3
                      WHEN TO_CHAR(SYSDATE, 'day') = '星期四' THEN
                       4
                      WHEN TO_CHAR(SYSDATE, 'day') = '星期五' THEN
                       5
                      WHEN TO_CHAR(SYSDATE, 'day') = '星期六' THEN
                       6
                      WHEN TO_CHAR(SYSDATE, 'day') = '星期日' THEN
                       7
                  END;

    DBMS_OUTPUT.PUT_LINE(V_WEEK_DAY || ' ,' || V_MONTH_DAY);

    BEGIN
        SELECT NVL(A.IS_DISABLE, 0)
        INTO   V_FLAG
        FROM   POM_RULE_SET A
        WHERE  A.ID = RULEID;

        SELECT COUNT(1)
        INTO   V_FLAG
        FROM   POM_RULE_SET_PLAN_TYPE A
        WHERE  A.RULE_ID = RULEID;

        IF V_FLAG = 0 THEN
            DBMS_OUTPUT.PUT_LINE('检测到【POM_RULE_SET_PLAN_TYPE】表中无数据，请检查配置信息');
            RETURN;
        END IF;

    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            V_FLAG := 0;
            DBMS_OUTPUT.PUT_LINE('该规则初始化信息有误，请检查规则配置');
    END;

    SELECT A.EXPRESSION, A.RULE_TYPE, A.NODE_LEVEL, A.MESSAGE_TEMPLATE,
           A.TIME_FREQUENCY, A.MSG_FREQUENCY_TYPE, A.DATE_FREQUENCY
    INTO   VS_WHERE, V_RULE_TYPE, V_RULE_NODE_LEVEL, V_RULE_MSG,
           EXECUTIONTIME, V_RULE_FERQ_TYPE, V_RULE_FERQ_DATE
    FROM   POM_RULE_SET A
    WHERE  A.ID = RULEID AND
           IS_DISABLE <> 1;
    /*
    WHERE条件拼接
    */
    V_RULE_NODE_LEVEL := ' AND NODE_LEVEL = ''' || V_RULE_NODE_LEVEL || '''';
    VS_WHERE          := 'WHERE 1=1 ' || ' AND ' || VS_WHERE; --1=1勿删，确保无论where后是否有条件，SQL都能执行
    VS_WHERE          := VS_WHERE || V_RULE_NODE_LEVEL;

    SELECT TO_CHAR(WM_CONCAT(A.PLAN_TYPE))
    INTO   V_PLAN_TYPE
    FROM   POM_RULE_SET_PLAN_TYPE A
    WHERE  A.RULE_ID = RULEID;

    --执行频率判断
    IF V_RULE_FERQ_TYPE = '每周' THEN
        IF V_WEEK_DAY <> V_RULE_FERQ_DATE THEN
            TOTAL := 0;
            RETURN;
        END IF;
    ELSIF V_RULE_FERQ_TYPE = '每月' THEN
        IF V_MONTH_DAY <> V_RULE_FERQ_DATE THEN
            TOTAL := 0;
            RETURN;
        END IF;
    ELSIF V_RULE_FERQ_TYPE = '提醒一次' THEN
        VS_WHERE := VS_WHERE ||
                    ' AND NOT EXISTS (SELECT 1 FROM POM_PRE_GENERATED_MESSAGE WHERE POM_PRE_GENERATED_MESSAGE.BIZ_KEY = NODE_ID) ';
    END IF;

    IF INSTR(V_PLAN_TYPE, '项目主项计划', 1, 1) <> 0 THEN
        /*
            SQL拼接，where条件中的1=1勿删，防止RTRIM时，将NULL字符删除
        */
        VS_PROJ_PLAN := ' SELECT A.PLAN_NAME, A.COMPANY_NAME,C.CHARGE_PERSON_DEPT_ID AS DEPT_ID,C.CHARGE_PERSON_COMPANY_ID AS COMPANY_ID, B.NODE_NAME,B.NODE_LEVEL AS NODE_LEVEL, A.ID AS PLAN_ID, B.ID AS NODE_ID,TO_CHAR(B.PLAN_START_DATE, ''YYYY-MM-DD'') AS PLAN_START_DATE,TO_CHAR(B.PLAN_END_DATE, ''YYYY-MM-DD'') AS PLAN_END_DATE,C.CHARGE_PERSON_ID, C.CHARGE_PERSON,TO_CHAR(SYSDATE, ''YYYY-MM-DD'') AS CURRENT_DATE,a.PROJ_ID FROM   POM_PROJ_PLAN A INNER  JOIN POM_PROJ_PLAN_NODE B ON     A.ID = B.PROJ_PLAN_ID INNER  JOIN POM_NODE_CHARGE_PERSON C ON     B.ID = C.NODE_ID WHERE  A.PLAN_TYPE = ''项目主项计划'' AND B.ACTUAL_END_DATE IS NULL AND 1=1   UNION ALL';
    ELSE
        VS_PROJ_PLAN := '';
    END IF;

    IF INSTR(V_PLAN_TYPE, '关键节点计划', 1, 1) <> 0 THEN
        VS_KEY_PLAN := ' SELECT A.PLAN_NAME, A.COMPANY_NAME, C.CHARGE_PERSON_DEPT_ID AS DEPT_ID,C.CHARGE_PERSON_COMPANY_ID AS COMPANY_ID, B.NODE_NAME,B.NODE_LEVEL AS NODE_LEVEL, A.ID AS PLAN_ID, B.ID AS NODE_ID,TO_CHAR(B.PLAN_START_DATE, ''YYYY-MM-DD'') AS PLAN_START_DATE,TO_CHAR(B.PLAN_END_DATE, ''YYYY-MM-DD'') AS PLAN_END_DATE,C.CHARGE_PERSON_ID, C.CHARGE_PERSON,TO_CHAR(SYSDATE, ''YYYY-MM-DD'') AS CURRENT_DATE,a.PROJ_ID  FROM   POM_PROJ_PLAN A INNER  JOIN POM_PROJ_PLAN_NODE B ON     A.ID = B.PROJ_PLAN_ID INNER  JOIN POM_NODE_CHARGE_PERSON C ON     B.ID = C.NODE_ID WHERE  A.PLAN_TYPE = ''关键节点计划'' AND B.ACTUAL_END_DATE IS NULL AND 1=1 UNION ALL';
    ELSE
        VS_KEY_PLAN := '';
    END IF;

    IF INSTR(V_PLAN_TYPE, '专项计划', 1, 1) <> 0 THEN
        VS_SPEC_PLAN := ' SELECT A.PLAN_NAME, A.COMPANY_NAME, C.CHARGE_PERSON_DEPT_ID AS DEPT_ID,C.CHARGE_PERSON_COMPANY_ID AS COMPANY_ID, B.NODE_NAME,NULL AS NODE_LEVEL, A.ID AS PLAN_ID, B.ID AS NODE_ID,TO_CHAR(B.PLAN_START_DATE, ''YYYY-MM-DD'') AS PLAN_START_DATE,TO_CHAR(B.PLAN_END_DATE, ''YYYY-MM-DD'') AS PLAN_END_DATE,C.CHARGE_PERSON_ID, C.CHARGE_PERSON,TO_CHAR(SYSDATE, ''YYYY-MM-DD'') AS CURRENT_DATE,null FROM   POM_SPECIAL_PLAN A INNER  JOIN POM_SPECIAL_PLAN_NODE B ON     A.ID = B.PLAN_ID INNER  JOIN POM_NODE_CHARGE_PERSON C ON     B.ID = C.NODE_ID WHERE  B.ACTUAL_END_DATE IS NULL AND 1=1 UNION ALL';
    ELSE
        VS_SPEC_PLAN := '';
    END IF;

    IF INSTR(V_PLAN_TYPE, '部门月度计划', 1, 1) <> 0 THEN
        VS_DEPT_PLAN := ' SELECT A.PLAN_NAME, A.COMPANY_NAME, C.CHARGE_PERSON_DEPT_ID AS DEPT_ID,C.CHARGE_PERSON_COMPANY_ID AS COMPANY_ID, B.NODE_NAME,B.NODE_TYPE AS NODE_LEVEL, A.ID AS PLAN_ID, B.ID AS NODE_ID,TO_CHAR(B.PLAN_START_DATE, ''YYYY-MM-DD'') AS PLAN_START_DATE,TO_CHAR(B.PLAN_END_DATE, ''YYYY-MM-DD'') AS PLAN_END_DATE,C.CHARGE_PERSON_ID, C.CHARGE_PERSON,TO_CHAR(SYSDATE, ''YYYY-MM-DD'') AS CURRENT_DATE FROM   POM_DEPT_MONTHLY_PLAN A INNER  JOIN POM_DEPT_MONTHLY_PLAN_NODE B ON     A.ID = B.DEPT_MONTHLY_PLAN_ID INNER  JOIN POM_NODE_CHARGE_PERSON C ON     B.ID = C.NODE_ID WHERE  B.ACTUAL_END_DATE IS NULL AND 1=1 UNION ALL';
    ELSE
        VS_DEPT_PLAN := '';
    END IF;

    /*    IF V_RULE_TYPE = '提醒规则' THEN
        --下方需补充提醒规则的条件

        VS_WHERE = VS_WHERE || '';

    ELSIF V_RULE_TYPE = '预警规则' THEN
        --下方补充预警规则的条件
        VS_WHERE = VS_WHERE || '';

    END IF;*/

    VS_QUERY := 'SELECT PLAN_NAME,COMPANY_NAME,DEPT_ID,COMPANY_ID,NODE_NAME,NODE_LEVEL,PLAN_ID,NODE_ID,PLAN_START_DATE,PLAN_END_DATE,CHARGE_PERSON_ID,CHARGE_PERSON, CURRENT_DATE, ' ||
                V_RULE_MSG || ' AS NODE_MSG FROM (' ||
                RTRIM(VS_PROJ_PLAN || ' ' || VS_KEY_PLAN || ' ' ||
                      VS_SPEC_PLAN || ' ' || VS_DEPT_PLAN, 'UNION ALL') || ')' || ' ' ||
                VS_WHERE;

    DBMS_OUTPUT.PUT_LINE(VS_QUERY);
    /*
        更新值至POM_PRE_GENERATED_MESSAGE表中
    */

    OPEN VC_REF FOR VS_QUERY;
    LOOP
        FETCH VC_REF
            INTO V_NODE_INFO;
        EXIT WHEN VC_REF%NOTFOUND;
        INSERT INTO POM_PRE_GENERATED_MESSAGE
        VALUES
            (GET_UUID(),MSGGROUPID, V_NODE_INFO.NODE_MSG, V_NODE_INFO.CHARGE_PERSON_ID,
             V_NODE_INFO.NODE_ID, 'wangck', '计划管理',
             CASE WHEN V_RULE_TYPE = '提醒规则' THEN '提醒消息' WHEN
              V_RULE_TYPE = '预警规则' THEN '预警消息' ELSE NULL END, V_SYSTEM_ID,
             'wechat_jumpLink_Url',V_NODE_INFO.COMPANY_ID,V_NODE_INFO.DEPT_ID,V_NODE_INFO.PROJ_ID);
    END LOOP;
    
    VS_QUERY:=' insert into POM_PRE_GENERATED_MESSAGE  '||VS_QUERY; 
    execute immediate VS_QUERY;
    TOTAL := VC_REF%ROWCOUNT;
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('更新成功，已更新数据' || TOTAL || '条');
    CLOSE VC_REF;

END P_POM_RULE_MSG_PRE_GENERATED;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_RULE_MSG_PUSH
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_RULE_MSG_PUSH" 
(
    RULEID     IN VARCHAR
   ,MSGGROUPID IN VARCHAR
   ,MESSAGE    OUT SYS_REFCURSOR
) AS
    --预警与提醒，消息推送。p_pom_rule_msg_pre_generated
    --作者：陈丽
    --日期：2019/11/15
    TYPE REF_CURSOR IS REF CURSOR;
    VC_REF_CURSOR REF_CURSOR;

    TYPE RC_PRE_MSG IS RECORD(
         ID                  POM_PRE_GENERATED_MESSAGE.ID%TYPE
        ,MSG_GROUP_ID        POM_PRE_GENERATED_MESSAGE.MSG_GROUP_ID%TYPE
        ,MSG_DESCRIPTION     POM_PRE_GENERATED_MESSAGE.MSG_DESCRIPTION%TYPE
        ,RECIPIENT_ID        POM_PRE_GENERATED_MESSAGE.RECIPIENT_ID%TYPE
        ,BIZ_KEY             POM_PRE_GENERATED_MESSAGE.BIZ_KEY%TYPE
        ,SENDER_ID           POM_PRE_GENERATED_MESSAGE.SENDER_ID%TYPE
        ,BIZ_SOURCE_CATEGORY POM_PRE_GENERATED_MESSAGE.BIZ_SOURCE_CATEGORY%TYPE
        ,BIZ_MSG_CATEGORY    POM_PRE_GENERATED_MESSAGE.BIZ_MSG_CATEGORY%TYPE
        ,SYSTEM_ID           POM_PRE_GENERATED_MESSAGE.SYSTEM_ID%TYPE
        ,WECHAT_JUMPLINK_URL POM_PRE_GENERATED_MESSAGE.WECHAT_JUMPLINK_URL%TYPE
        ,COMPANY_ID          POM_PRE_GENERATED_MESSAGE.COMPANY_ID%TYPE
        ,DEPT_ID             POM_PRE_GENERATED_MESSAGE.DEPT_ID%TYPE
        ,PROJ_ID             POM_PRE_GENERATED_MESSAGE.PROJ_ID%TYPE);
    V_RC_PRE_MSG RC_PRE_MSG;
BEGIN
    OPEN VC_REF_CURSOR FOR
        SELECT A.ID, A.MSG_GROUP_ID AS "msgGroupId",
               A.MSG_DESCRIPTION AS "msgDescription",
               A.RECIPIENT_ID AS "RecipientId", A.BIZ_KEY AS "bizKey",
               A.SENDER_ID AS "senderId",
               A.BIZ_SOURCE_CATEGORY AS "bizSourceCategory",
               A.BIZ_MSG_CATEGORY AS "bizMsgCategory",
               A.SYSTEM_ID AS "systemId",
               A.WECHAT_JUMPLINK_URL AS "wechatJumplinkUrl"
        FROM   POM_PRE_GENERATED_MESSAGE A
        INNER  JOIN POM_PROJ_PLAN_NODE B
        ON     A.BIZ_KEY = B.ID
        WHERE  MSG_GROUP_ID = MSGGROUPID AND
               B.ACTUAL_END_DATE IS NOT NULL
        UNION ALL
        SELECT A.ID, A.MSG_GROUP_ID AS "msgGroupId",
               A.MSG_DESCRIPTION AS "msgDescription",
               A.RECIPIENT_ID AS "RecipientId", A.BIZ_KEY AS "bizKey",
               A.SENDER_ID AS "senderId",
               A.BIZ_SOURCE_CATEGORY AS "bizSourceCategory",
               A.BIZ_MSG_CATEGORY AS "bizMsgCategory",
               A.SYSTEM_ID AS "systemId",
               A.WECHAT_JUMPLINK_URL AS "wechatJumplinkUrl"
        FROM   POM_PRE_GENERATED_MESSAGE A
        INNER  JOIN POM_SPECIAL_PLAN_NODE B
        ON     A.BIZ_KEY = B.ID
        WHERE  MSG_GROUP_ID = MSGGROUPID AND
               B.ACTUAL_END_DATE IS NOT NULL
        UNION ALL
        SELECT A.ID, A.MSG_GROUP_ID AS "msgGroupId",
               A.MSG_DESCRIPTION AS "msgDescription",
               A.RECIPIENT_ID AS "RecipientId", A.BIZ_KEY AS "bizKey",
               A.SENDER_ID AS "senderId",
               A.BIZ_SOURCE_CATEGORY AS "bizSourceCategory",
               A.BIZ_MSG_CATEGORY AS "bizMsgCategory",
               A.SYSTEM_ID AS "systemId",
               A.WECHAT_JUMPLINK_URL AS "wechatJumplinkUrl"
        FROM   POM_PRE_GENERATED_MESSAGE A
        INNER  JOIN POM_DEPT_MONTHLY_PLAN_NODE B
        ON     A.BIZ_KEY = B.ID
        WHERE  MSG_GROUP_ID = MSGGROUPID AND
               B.ACTUAL_END_DATE IS NOT NULL;
    LOOP
        FETCH VC_REF_CURSOR
            INTO V_RC_PRE_MSG;
        EXIT WHEN VC_REF_CURSOR%NOTFOUND;
        DELETE POM_PRE_GENERATED_MESSAGE WHERE ID = V_RC_PRE_MSG.ID;
    END LOOP;

    OPEN MESSAGE FOR
        SELECT A.ID AS "id", MSG_GROUP_ID AS "msgGroupId",
               A.MSG_DESCRIPTION AS "msgDescription",
               A.RECIPIENT_ID AS "RecipientId", A.BIZ_KEY AS "bizKey",
               A.SENDER_ID AS "senderId",
               A.BIZ_SOURCE_CATEGORY AS "bizSourceCategory",
               A.BIZ_MSG_CATEGORY AS "bizMsgCategory",
               A.SYSTEM_ID AS "systemId",
               A.WECHAT_JUMPLINK_URL AS "wechatJumplinkUrl",
               A.COMPANY_ID AS "companyId", A.DEPT_ID AS "deptId",
               A.PROJ_ID AS "projId"
        FROM   POM_PRE_GENERATED_MESSAGE A
        WHERE  MSG_GROUP_ID = MSGGROUPID;
END P_POM_RULE_MSG_PUSH;



/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_CURRENTCOMPANY_TBS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_SMART_CURRENTCOMPANY_TBS" (
        --orgtype IN VARCHAR2, --查询类型，用于判断过滤 0,公司|1,部门|2,项目|3,,本人
		condition IN VARCHAR2, --输入变量：公司id
        currentuserid        IN 			VARCHAR2,--用户id，用于过滤关注的任务
        currentcompanyid     IN            VARCHAR2,--当前用户公司
        currentdeptid        IN            VARCHAR2,--当前用户部门
        currentstationid     IN            VARCHAR2,---当前用户的岗位
        bizcode       IN            VARCHAR2,---权限code
        searchcondition IN          VARCHAR2,--模糊查询条件
        item OUT SYS_REFCURSOR ) IS --任务中心tabs任务条数统计数据源
--作者：yedr
--日期：2020/04/07

    v_spid              VARCHAR2(200);
	BEGIN
--调用数据权限验证存储过程
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => currentuserid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
		IF  condition <> '111' THEN
            OPEN item FOR SELECT
            SUM(ACOUNT) AS ACOUNT,
            SUM(BCOUNT) AS BCOUNT,
            SUM(CCOUNT) AS CCOUNT,
            SUM(DCOUNT) AS DCOUNT,
            SUM(ECOUNT) AS ECOUNT,
            SUM(FCOUNT) AS FCOUNT,
            SUM(GCOUNT) AS GCOUNT,
            SUM(HCOUNT) AS HCOUNT
            FROM(
                SELECT NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT

                FROM
                POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON node.ID=person.NODE_ID
                    LEFT JOIN SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                    ON (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.PROJ_NAME like '%'||searchcondition||'%' OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
					AND node.COMPANY_ID = ''|| condition ||''
                UNION ALL
                SELECT
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT
                FROM
                POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON node.ID=person.NODE_ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null AND node.ACTUAL_END_DATE IS NULL
					AND plan.APPROVAL_STATUS = '已审核'
					AND	node.IS_DELETE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
					AND node.COMPANY_ID = '' || condition || ''
                UNION ALL
                SELECT
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT
                FROM
                pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON node.ID=person.NODE_ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND (node.IS_DEL=0 OR node.IS_DEL=null)
                     AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.DEPT_NAME like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
					AND plan.COMPANY_ID = '' || condition || ''

            );
		ELSE
			OPEN item FOR SELECT
            SUM(ACOUNT) AS ACOUNT,
            SUM(BCOUNT) AS BCOUNT,
            SUM(CCOUNT) AS CCOUNT,
            SUM(DCOUNT) AS DCOUNT,
            SUM(ECOUNT) AS ECOUNT,
            SUM(FCOUNT) AS FCOUNT,
            SUM(GCOUNT) AS GCOUNT,
            SUM(HCOUNT) AS HCOUNT
            FROM(
                SELECT NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT

                FROM
                POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON node.ID=person.NODE_ID
                    LEFT JOIN SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                    ON (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.PROJ_NAME like '%'||searchcondition||'%' OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
					--AND node.COMPANY_ID = ''|| condition ||''
                UNION ALL
                SELECT
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT
                FROM
                POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON node.ID=person.NODE_ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null AND node.ACTUAL_END_DATE IS NULL
					AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
					AND plan.APPROVAL_STATUS = '已审核'
					AND	node.IS_DELETE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
					--AND node.COMPANY_ID = '' || condition || ''
                UNION ALL
                SELECT
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT
                FROM
                pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON node.ID=person.NODE_ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND (node.IS_DEL=0 OR node.IS_DEL=null)
                     AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.DEPT_NAME like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
					--AND plan.COMPANY_ID = '' || condition || ''

            );
		END IF;

END P_POM_SMART_CURRENTCOMPANY_TBS;



/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_CURRENTDEPT_TBS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_SMART_CURRENTDEPT_TBS" (
        --orgtype IN VARCHAR2, --查询类型，用于判断过滤 0,公司|1,部门|2,项目|3,,本人
		condition IN VARCHAR2, --输入变量：部门id
        currentuserid        IN 			VARCHAR2,--用户id，用于过滤关注的任务
        currentcompanyid     IN            VARCHAR2,--当前用户公司
        currentdeptid        IN            VARCHAR2,--当前用户部门
        currentstationid     IN            VARCHAR2,---当前用户的岗位
        bizcode       IN            VARCHAR2,---权限code
        searchcondition IN          VARCHAR2,--模糊查询条件
        item OUT SYS_REFCURSOR ) IS --任务中心tabs任务条数统计数据源
--作者：yedr
--日期：2020/04/07

    v_spid              VARCHAR2(200);
	BEGIN
--调用数据权限验证存储过程
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => currentuserid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
		IF  condition <> '111' THEN
            OPEN item FOR SELECT 
            SUM(ACOUNT) AS ACOUNT,
            SUM(BCOUNT) AS BCOUNT,
            SUM(CCOUNT) AS CCOUNT,
            SUM(DCOUNT) AS DCOUNT,
            SUM(ECOUNT) AS ECOUNT,
            SUM(FCOUNT) AS FCOUNT,
            SUM(GCOUNT) AS GCOUNT,
            SUM(HCOUNT) AS HCOUNT
            FROM(
                SELECT NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND 
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT

                FROM  
                POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON node.ID=person.NODE_ID
                    LEFT JOIN SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                    ON (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE  ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.PROJ_NAME like '%'||searchcondition||'%' OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
					AND node.DUTY_DEPARTMENT_ID = ''|| condition ||''
                UNION ALL 
                SELECT 
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND 
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT
                FROM
                POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON node.ID=person.NODE_ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE  node.ACTUAL_END_DATE IS NULL
					AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
					AND plan.APPROVAL_STATUS = '已审核'
					AND	node.IS_DELETE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
					AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
                UNION ALL 
                SELECT 
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND 
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT
                FROM
                pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON node.ID=person.NODE_ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND (node.IS_DEL=0 OR node.IS_DEL=null)
                     AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.DEPT_NAME like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
					AND plan.DEPT_ID = '' || condition || ''

            );
		ELSE
			OPEN item FOR SELECT 
            SUM(ACOUNT) AS ACOUNT,
            SUM(BCOUNT) AS BCOUNT,
            SUM(CCOUNT) AS CCOUNT,
            SUM(DCOUNT) AS DCOUNT,
            SUM(ECOUNT) AS ECOUNT,
            SUM(FCOUNT) AS FCOUNT,
            SUM(GCOUNT) AS GCOUNT,
            SUM(HCOUNT) AS HCOUNT
            FROM(
                SELECT NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND 
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT

                FROM  
                POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON node.ID=person.NODE_ID
                    LEFT JOIN SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                    ON (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.PROJ_NAME like '%'||searchcondition||'%' OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
					--AND node.DUTY_DEPARTMENT_ID = ''|| condition ||''
                UNION ALL 
                SELECT 
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND 
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT
                FROM
                POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON node.ID=person.NODE_ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE  node.ACTUAL_END_DATE IS NULL
					AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
					AND plan.APPROVAL_STATUS = '已审核'
					AND	node.IS_DELETE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
					--AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
                UNION ALL 
                SELECT 
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND 
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT
                FROM
                pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON node.ID=person.NODE_ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE  node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND (node.IS_DEL=0 OR node.IS_DEL=null)
                     AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.DEPT_NAME like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
					--AND plan.DEPT_ID = '' || condition || ''

            );
		END IF;


END P_POM_SMART_CURRENTDEPT_TBS;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_CURRENTPROJ_TBS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_SMART_CURRENTPROJ_TBS" (
        --orgtype IN VARCHAR2, --查询类型，用于判断过滤 0,公司|1,部门|2,项目|3,,本人
		condition IN VARCHAR2, --输入变量：项目id
        currentuserid        IN 			VARCHAR2,--用户id，用于过滤关注的任务
        currentcompanyid     IN            VARCHAR2,--当前用户公司
        currentdeptid        IN            VARCHAR2,--当前用户部门
        currentstationid     IN            VARCHAR2,---当前用户的岗位
        bizcode       IN            VARCHAR2,---权限code
        searchcondition IN          VARCHAR2,--模糊查询条件
        item OUT SYS_REFCURSOR ) IS --任务中心tabs任务条数统计数据源
--作者：yedr
--日期：2020/04/07

    v_spid              VARCHAR2(200);
	BEGIN
--调用数据权限验证存储过程
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => currentuserid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
		IF  condition <> '111' THEN
            OPEN item FOR SELECT
            SUM(ACOUNT) AS ACOUNT,
            SUM(BCOUNT) AS BCOUNT,
            SUM(CCOUNT) AS CCOUNT,
            SUM(DCOUNT) AS DCOUNT,
            SUM(ECOUNT) AS ECOUNT,
            SUM(FCOUNT) AS FCOUNT,
            SUM(GCOUNT) AS GCOUNT,
            SUM(HCOUNT) AS HCOUNT
            FROM(
                SELECT NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT

                FROM
                POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON node.ID=person.NODE_ID
                    LEFT JOIN SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                    ON (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.PROJ_NAME like '%'||searchcondition||'%' OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%'
                    OR person.CHARGE_PERSON like '%'||searchcondition||'%')
					AND (plan.PROJ_ID=''||condition||'' OR plan.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''||condition||''))
            );
		ELSE
			OPEN item FOR SELECT
            SUM(ACOUNT) AS ACOUNT,
            SUM(BCOUNT) AS BCOUNT,
            SUM(CCOUNT) AS CCOUNT,
            SUM(DCOUNT) AS DCOUNT,
            SUM(ECOUNT) AS ECOUNT,
            SUM(FCOUNT) AS FCOUNT,
            SUM(GCOUNT) AS GCOUNT,
            SUM(HCOUNT) AS HCOUNT
            FROM(
                SELECT NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT

                FROM
                POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON node.ID=person.NODE_ID
                    LEFT JOIN SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                    ON (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.PROJ_NAME like '%'||searchcondition||'%' OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
					--AND node.COMPANY_ID = ''|| condition ||''
  );
		END IF;

END P_POM_SMART_CURRENTPROJ_TBS;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_CURRENTPSRSON_TBS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_SMART_CURRENTPSRSON_TBS" (
		condition IN VARCHAR2, --输入变量：当前用户ID
        searchcondition IN          VARCHAR2,--模糊查询条件
        item OUT SYS_REFCURSOR ) IS --任务中心tabs任务条数统计数据源
--作者：yedr
--日期：2020/04/07

    v_spid              VARCHAR2(200);
	BEGIN
    OPEN item FOR SELECT 
            SUM(ACOUNT) AS ACOUNT,
            SUM(BCOUNT) AS BCOUNT,
            SUM(CCOUNT) AS CCOUNT
            FROM(
                SELECT 
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS ACOUNT,
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS CCOUNT
                    FROM  
                    POM_PROJ_PLAN_NODE node
                    LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
                    WHERE  plan.PLAN_TYPE = '项目主项计划' 
                    AND plan.APPROVAL_STATUS = '已审核'
                    AND node.IS_DISABLE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.PROJ_NAME like '%'||searchcondition||'%' OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
                    AND person.CHARGE_PERSON_ID = '' || condition || ''
                UNION ALL 
                SELECT 
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS ACOUNT,
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS CCOUNT
                    FROM POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
                    WHERE node.ACTUAL_END_DATE IS NULL
					AND plan.APPROVAL_STATUS = '已审核'
					AND	node.IS_DELETE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
                    AND person.CHARGE_PERSON_ID = '' || condition || ''
                UNION ALL 
                SELECT 
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS ECOUNT
                    FROM pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
                    WHERE node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND (node.IS_DEL=0 OR node.IS_DEL=null)
                    AND person.CHARGE_PERSON_ID = '' || condition || ''
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.DEPT_NAME like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')

            );

END P_POM_SMART_CURRENTPSRSON_TBS;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_DELAY_NODE_CURRENT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_SMART_DELAY_NODE_CURRENT" (
    plantype       IN             VARCHAR2,
    datascope      IN             VARCHAR2,
    orgid          IN             VARCHAR2,
    title          OUT            VARCHAR2,
    titleicon      OUT            VARCHAR2,
    currentdelay   OUT            SYS_REFCURSOR
) AS --关键节点计划监控-当前延误节点
        --作者：陈丽
        --日期：2019/11/13
BEGIN
    title := '当前延误节点';
    --图标库地址 https://element.eleme.cn/#/zh-CN/component/icon
    titleicon := 'el-icon-tickets';

                OPEN CURRENTDELAY FOR
                        SELECT DISTINCT A.ORG_NAME AS "orgName",
                                                        B2.PROJECTSTAGE_NAME AS "projName",
                                                        B2.NODE_NAME|| CASE WHEN ESTIMATE_END_DATE IS NOT NULL THEN   '(预计完成日期：'||TO_CHAR(ESTIMATE_END_DATE,'YYYY-MM-DD ')||')'END  AS "nodeName",
                                                        NODE_ID as "nodeId",
                                                        ORIGINAL_NODE_ID as "nodeOriginId",
                                                        '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||
                                                         NVL(B2.COMPANY_ID, '003200000000000000000000000000') ||
                                                         '&ppid=' || B2.PPID || '&planType=关键节点计划' AS "projOpenUrl",
                                                        '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id=' ||
                                                         B2.PLANID || '&feedbackNodeId=' || NODE_ID ||
                                                         '&feedbackNodeOriginalId=' || ORIGINAL_NODE_ID ||
                                                         '&nodeSourcePlanType=0' AS "nodeOpenUrl",
                                                          '<span class="right"> 已延误 <span style="display: inline-block;
                                                                width: 40px;
                                                                text-align: center;
                                                                border-radius: 4px;
                                                                margin: 0 4px;
                                                                background-color: rgb(248, 94, 90);
                                                                color: #fff;
                                                                font-weight: 700;">'
                                                                ||TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd'))
                                                                ||'</span> 天 </span>'             AS "delayDays"
																																,TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') as "DelayDAYsRUNK"
                        FROM   SYS_BUSINESS_UNIT A

                        LEFT   JOIN (SELECT LEVEL, ORG_NAME, CONNECT_BY_ROOT ID AS ID,
                                                                CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
                                                                B.UNIT_ID, B.NODE_NAME, B.NODE_ID,
                                                                B.ACTUAL_END_DATE, B.PLAN_END_DATE,
                                                                B.PROJECTSTAGE_NAME, B.PPID, B.PID,
                                                                'TYPE_ORG' AS CTYPE, B.ESTIMATE_END_DATE,
                                                                B.PLANID, ORIGINAL_NODE_ID,B.COMPANY_ID
                                                 FROM   SYS_BUSINESS_UNIT A
                                                 LEFT   JOIN (SELECT B1.UNIT_ID, A.ID AS PLANID,A.COMPANY_ID,
                                                                                        case when  STAGE_NAME like '%无分期%' then  B1.ID else A.PROJ_ID end   AS PPID,--20200427李小聪调整勿修改
																																												B1.ID AS PID,
                                                                                        A1.ORIGINAL_NODE_ID,

                                                                                         A.PROJ_NAME AS PROJECTSTAGE_NAME,
                                                                                        A1.NODE_NAME, A1.ID AS NODE_ID,
                                                                                        A1.ACTUAL_END_DATE,
                                                                                        A1.PLAN_END_DATE,
                                                                                        A1.ESTIMATE_END_DATE
                                                                         FROM   POM_PROJ_PLAN A
                                                                         INNER  JOIN POM_PROJ_PLAN_NODE A1
                                                                         ON     A.ID = A1.PROJ_PLAN_ID
                                                                         INNER  JOIN SYS_PROJECT_STAGE C1
                                                                         ON     A.PROJ_ID = C1.ID
                                                                         INNER  JOIN SYS_PROJECT B1
                                                                         ON     C1.PROJECT_ID = B1.ID
                                                                         WHERE  A.PLAN_TYPE = '关键节点计划' AND

                                                                                        A.APPROVAL_STATUS = '已审核'
																																									and  A1.IS_DISABLE=0
																																									AND

                                                                                        TRUNC(SYSDATE, 'dd') -TRUNC(PLAN_END_DATE, 'dd') > 0 AND
                                                                                        ACTUAL_END_DATE IS NULL) B
                                                 ON     A.ID = B.UNIT_ID
                                                 WHERE  ORG_TYPE = 0
                                                 START  WITH ID = '' || ORGID || ''
                                                 CONNECT BY PRIOR A.ID = A.PARENT_ID) B2
                        ON     A.ID = B2.ID
                        WHERE  NODE_NAME IS NOT NULL AND
                                     ACTUAL_END_DATE IS NULL AND
                                     TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 --分期
                        UNION ALL
                        SELECT DISTINCT '' AS "orgName",
                                                     A.PROJ_NAME AS "projName",
                                                        A1.NODE_NAME|| CASE WHEN ESTIMATE_END_DATE IS NOT NULL THEN   '(预计完成日期：'||TO_CHAR(ESTIMATE_END_DATE,'YYYY-MM-DD ')||')'END  AS "nodeName",
                                                         A1.ID as "nodeId",
                                                        A1.ORIGINAL_NODE_ID as "nodeOriginId",
                                                        '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||
                                                         NVL(A.COMPANY_ID,
                                                                 '003200000000000000000000000001') ||
                                                         '&ppid=' || C1.ID || '&planType=关键节点计划' AS "projOpenUrl",
                                                        '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || A.ID ||
                                                         '&feedbackNodeId=' || A1.ID ||
                                                         '&feedbackNodeOriginalId=' ||
                                                         A1.ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
                                                          '<span class="right"> 已延误 <span style="display: inline-block;
                                                                width: 40px;
                                                                text-align: center;
                                                                border-radius: 4px;
                                                                margin: 0 4px;
                                                                background-color: rgb(248, 94, 90);
                                                                color: #fff;
                                                                font-weight: 700;">'
                                                                ||TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd'))
                                                                ||'</span> 天 </span>'             AS "delayDays"
--                                                        TRUNC(SYSDATE, 'dd') -
--                                                         TRUNC(PLAN_END_DATE, 'dd') AS "delayDays"
,TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') as "DelayDAYsRUNK"

                        FROM   POM_PROJ_PLAN A
                        INNER  JOIN POM_PROJ_PLAN_NODE A1
                        ON     A.ID = A1.PROJ_PLAN_ID
                        INNER  JOIN SYS_PROJECT_STAGE C1
                        ON     A.PROJ_ID = C1.ID
                        INNER  JOIN SYS_PROJECT B1
                        ON     C1.PROJECT_ID = B1.ID
                        WHERE  A.PLAN_TYPE = '关键节点计划' AND
                                     A.APPROVAL_STATUS = '已审核'
																		 and  A1.IS_DISABLE=0
																		 AND

                                     TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 AND
                                     ACTUAL_END_DATE IS NULL AND
                                     C1.PROJECT_ID = '' || ORGID || ''
                        ORDER  BY 9 DESC,2;

END p_pom_smart_delay_node_current;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_DELAY_NODE_PREDICT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_SMART_DELAY_NODE_PREDICT" (
    plantype       IN             VARCHAR2,
    datascope      IN             VARCHAR2,
    orgid          IN             VARCHAR2,
    title          OUT            VARCHAR2,
    titleicon      OUT            VARCHAR2,
    predictdelay   OUT            SYS_REFCURSOR
) AS --关键节点计划监控-预计延误节点
		--作者：陈丽
		--日期：2019/11/13
BEGIN

    title := '预计延误及5天内到期节点';
    titleicon := '';

   open predictdelay FOR


      SELECT DISTINCT
      A.ORG_NAME AS "orgName",
      B2.PROJECTSTAGE_NAME AS "projName",
      B2.NODE_NAME ||case when  ESTIMATE_END_DATE is NOT null then '   (预计完成日期：'||  TO_CHAR(ESTIMATE_END_DATE,'yyyy-mm-dd') ||')' else  null end AS "nodeName",
      NODE_ID as "nodeId",
      ORIGINAL_NODE_ID as "nodeOriginId",
      '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' || b2.UNIT_ID ||  '&ppid=' || B2.PPID || '&planType=关键节点计划' AS "projOpenUrl",
      '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || B2.PLANID || '&feedbackNodeId=' || NODE_ID || '&feedbackNodeOriginalId=' || ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",

				CASE  WHEN TRUNC(ESTIMATE_END_DATE, 'dd' ) - TRUNC(  PLAN_END_DATE, 'dd' ) > 0   THEN
						'<span class="right"> 预计延误 <span style="display: inline-block;
																width: 40px;
																text-align: center;
																border-radius: 4px;
																margin: 0 4px;
																background-color: rgb(248, 94, 90);
																color: #fff;
																font-weight: 700;">'
																||TO_CHAR( TRUNC(ESTIMATE_END_DATE, 'dd' ) - TRUNC(  PLAN_END_DATE, 'dd' ))
																||'</span> 天 </span>'
								WHEN  TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE)=0 THEN
						'<span class="right"> 今天到期 </span>'
								ELSE
													'<span class="right"> 余  <span style="display: inline-block;
																width: 30px;
																text-align: center;
																border-radius: 4px;
																margin: 0 4px;
																background-color:  #409eff;
																color: #fff;
																font-weight: 700;">'
																||TO_CHAR(TRUNC(PLAN_END_DATE, 'dd')-TRUNC(SYSDATE, 'dd'))
																||'</span> 天到期 </span>' 	 END
														AS "delayDays"
											, case when ESTIMATE_END_DATE is not null  then  TRUNC(ESTIMATE_END_DATE, 'dd' ) - TRUNC(  PLAN_END_DATE, 'dd' )   else  TRUNC(PLAN_END_DATE, 'dd')-TRUNC(SYSDATE, 'dd')
										  end  as daycount
    FROM
      SYS_BUSINESS_UNIT a
      LEFT JOIN (
      SELECT LEVEL
        ,
        ORG_NAME,
        CONNECT_BY_ROOT ID AS ID,
        CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
        B.UNIT_ID,
        B.NODE_NAME,
        B.NODE_ID,
        B.ACTUAL_END_DATE,
        B.PLAN_END_DATE,
        B.PROJECTSTAGE_NAME,
        B.PPID,
        B.PID,
        'TYPE_ORG' AS CTYPE,
        B.ESTIMATE_END_DATE,
        PLANID,
        ORIGINAL_NODE_ID
      FROM
        SYS_BUSINESS_UNIT A
        LEFT JOIN (
        SELECT
          B1.UNIT_ID,
          A.ID AS PLANID,
          A1.ORIGINAL_NODE_ID,
         	 case when  STAGE_NAME like '%无分期%' then  B1.ID else A.PROJ_ID end   AS PPID,--20200427李小聪调整勿修改
          B1.ID AS PID,
           A.PROJ_NAME AS PROJECTSTAGE_NAME,
          A1.NODE_NAME,
          A1.ID AS NODE_ID,
          A1.ACTUAL_END_DATE,
          A1.PLAN_END_DATE,
          A1.ESTIMATE_END_DATE
        FROM
          POM_PROJ_PLAN A
          INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
          INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
          INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID
        WHERE
          A.PLAN_TYPE = '关键节点计划'
          AND A.APPROVAL_STATUS = '已审核'
					and  A1.IS_DISABLE=0
          AND (TRUNC(ESTIMATE_END_DATE , 'dd' ) - TRUNC(PLAN_END_DATE , 'dd' ) > 0  OR
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5)
          AND ACTUAL_END_DATE IS NULL

        ) B ON A.ID = B.UNIT_ID
      WHERE
        ORG_TYPE = 0 START WITH ID = '' || orgId || '' CONNECT BY PRIOR A.ID = A.PARENT_ID
      ) B2 ON A.ID = B2.ID
    WHERE
      NODE_NAME IS NOT NULL
      AND ACTUAL_END_DATE IS NULL
			--判断条件

    AND (TRUNC(ESTIMATE_END_DATE, 'dd' ) - TRUNC(  PLAN_END_DATE, 'dd' ) > 0  OR
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5 --5天内到期
				)
				--	未超期
		AND		TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') <= 0
			--分期
    UNION ALL
    SELECT DISTINCT
      '' AS "orgName",
       A.PROJ_NAME AS "projName",
      A1.NODE_NAME  ||case when  ESTIMATE_END_DATE is NOT null then '   (预计完成日期：'||  TO_CHAR(ESTIMATE_END_DATE,'yyyy-mm-dd') ||')' else  null end  AS "nodeName",
        A1.ID as "nodeId",
      A1.ORIGINAL_NODE_ID as "nodeOriginId",
      '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||A.COMPANY_ID || '&ppid=' || B1.ID || '&planType=关键节点计划' AS "projOpenUrl",
      '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || A.ID || '&feedbackNodeId=' || A1.ID || '&feedbackNodeOriginalId=' || A1.ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
			CASE  WHEN  TRUNC(ESTIMATE_END_DATE, 'dd' ) - TRUNC(  PLAN_END_DATE, 'dd' ) > 0   THEN
						'<span class="right"> 预计延误 <span style="display: inline-block;
																width: 40px;
																text-align: center;
																border-radius: 4px;
																margin: 0 4px;
																background-color: rgb(248, 94, 90);
																color: #fff;
																font-weight: 700;">'
																||TO_CHAR( TRUNC(ESTIMATE_END_DATE, 'dd' ) - TRUNC(  PLAN_END_DATE, 'dd' ))
																||'</span> 天 </span>'
								WHEN  TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE)=0 THEN
						'<span class="right"> 今天到期 </span>'
								ELSE
													'<span class="right"> 余  <span style="display: inline-block;
																width: 30px;
																text-align: center;
																border-radius: 4px;
																margin: 0 4px;
																background-color:  #409eff;
																color: #fff;
																font-weight: 700;">'
																||TO_CHAR(TRUNC(PLAN_END_DATE, 'dd')-TRUNC(SYSDATE, 'dd'))
																||'</span> 天到期 </span>' 	 END
														AS "delayDays"
				, case when ESTIMATE_END_DATE is not null  then  TRUNC(ESTIMATE_END_DATE, 'dd' ) - TRUNC(  PLAN_END_DATE, 'dd' )
				else  TRUNC(PLAN_END_DATE, 'dd')-TRUNC(SYSDATE, 'dd')
										  end  as daycount
    FROM
      POM_PROJ_PLAN A
      INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
      INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
      INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID
    WHERE
      A.PLAN_TYPE = '关键节点计划'
      AND A.APPROVAL_STATUS = '已审核'
				and  A1.IS_DISABLE=0
      AND (TRUNC(ESTIMATE_END_DATE, 'dd' ) - TRUNC(  PLAN_END_DATE, 'dd' ) > 0  OR
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5)
			AND	 TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') <= 0
      AND ACTUAL_END_DATE IS NULL

      AND C1.PROJECT_ID = '' || orgId || ''
    ORDER BY
      daycount DESC;

END p_pom_smart_delay_node_predict;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_EXAM_RUEL_DEL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_SMART_EXAM_RUEL_DEL" 
(
		RULEID  IN VARCHAR2
	 , --输入变量：规则id
		ERRMSG  OUT VARCHAR2
	 , --提示消息
		ERRCODE OUT INT --0成功，1失败
) IS
		--考核规则删除
		--作者：叶丁荣
		--日期：2019/11/22
		COUNTDTL INT;
BEGIN
		BEGIN
				COUNTDTL := 0;
				IF LENGTH(RULEID) < 32 THEN
						RAISE_APPLICATION_ERROR(-20000, '请选择要删除的规则');
				END IF;
				--循环规则id
		
				FOR ITEM IN (SELECT REGEXP_SUBSTR('' || RULEID || '', '[^,]+', 1,
																					 ROWNUM) AS ID
										 FROM   DUAL
										 CONNECT BY ROWNUM <=
																LENGTH('' || RULEID || '') -
																LENGTH(REGEXP_REPLACE('' || RULEID || '', ',',
																											'')) + 1)
				LOOP
						---删除规则
						DELETE POM_RULE_EXAMINATION WHERE ID = '' || ITEM.ID || '';
				
						COUNTDTL := COUNTDTL + 1;
				END LOOP;
		
				ERRCODE := 0;
				ERRMSG  := '删除成功！' || COUNTDTL || '条规则';
		EXCEPTION
				WHEN OTHERS THEN
						ERRCODE := 1;
						ERRMSG  := SQLERRM;
		END;
END P_POM_SMART_EXAM_RUEL_DEL;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_EXAMRULE_SET_STATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_SMART_EXAMRULE_SET_STATE" ( ruleid IN VARCHAR2, --输入变量：规则id
		statetype IN INT, --0生效，1失效
		errmsg OUT VARCHAR2, --提示消息
		errcode OUT INT --0成功，1失败
	) IS --考核规则生效失效设置
--作者：叶丁荣
--日期：2019/11/21
	typemsg VARCHAR2 ( 50 );
ruleids VARCHAR2 ( 4000 );
countdtl INT;
testmsg NVARCHAR2 ( 200 );
statuscount NUMBER;
BEGIN
	BEGIN
			testmsg := 'ruleid:' || ruleid || '.statetype:' || statetype;
		countdtl := 0;
		IF
			statetype = 0 THEN
				typemsg := '失效';
			ELSE typemsg := '生效';

		END IF;
		IF
			length( ruleid ) < 36 THEN
				raise_application_error ( - 20000, '请选择要' || typemsg || '的规则' || testmsg );

		END IF;
--循环规则id
		FOR item IN (
			SELECT
				regexp_substr( '' || ruleid || '', '[^,]+', 1, ROWNUM ) AS id 
			FROM
				dual CONNECT BY ROWNUM <= length( '' || ruleid || '' ) - length( regexp_replace( '' || ruleid || '', ',', '' ) ) + 1 
			)
			LOOP---拼接字符串
			ruleids := ruleids || item.id;
		SELECT COUNT(IS_ACTIVE) INTO statuscount  FROM POM_RULE_EXAMINATION WHERE ID='' || item.id || '' AND IS_ACTIVE=statetype ;

			IF(statuscount>0) THEN
				errcode := 1;
				errmsg := '已有'''||typemsg||'''的规则，请选择相同状态的数据进行操作';
				return;
			ELSE 
					UPDATE POM_RULE_EXAMINATION 
					SET IS_ACTIVE = statetype 
					WHERE
						id = '' || item.id || '';
					countdtl := countdtl + 1;
			END IF;

	END LOOP;

			errcode := 0;
			errmsg := typemsg || '设置成功！' || countdtl || '条规则';

EXCEPTION 
	WHEN OTHERS THEN
	errcode := 1;
errmsg := sqlerrm;

END;

END p_pom_smart_examrule_set_state;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_KEY_NODE_PLAN_PROJ
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_SMART_KEY_NODE_PLAN_PROJ" 
(
    PROJID      IN VARCHAR2
   , --输入变量：项目
    PAGEINDEX   IN INT
   ,PAGESIZES   IN INT
   ,CURRENTTYPE IN VARCHAR2
   , --完成节点类型(本月任务,超期未完成任务,所有未完成任务,所有已完成任务,所有任务,次月任务,本季度任务,本年任务)
    userid        IN            VARCHAR2,--用户id用于过滤关注的任务
    currentcompanyid     IN     VARCHAR2,--当前用户的公司
    currentstationid     IN            VARCHAR2,---当前用户的岗位
    currentdeptid        IN            VARCHAR2,---当前用户的部门
    searchcondition IN          VARCHAR2,--模糊查询条件
    bizcode       IN            VARCHAR2,---权限code
    ITEMS       OUT SYS_REFCURSOR
   ,TOTAL       OUT INT
) IS
    --本部门负责的任务
    --作者：陈丽
    --日期：2019/11/15

    V_SQL_START       CLOB;
    V_SQL_END         CLOB;
    V_SQL_CONTENT     CLOB;
    V_SQL             CLOB;
    V_SQL_EXEC        CLOB;
    V_SQL_EXEC_PAGING CLOB;
    V_WHERE           VARCHAR2(500);
    TESTMSG           NVARCHAR2(200);
    v_spid              VARCHAR2(200);--数据权限验证spid
    v_where_like       CLOB;
BEGIN
    ----------------------------------------------------统一解析
    TESTMSG := 'projid:' || PROJID || '；pageindex:' || PAGEINDEX || '；pagesizes:' || PAGESIZES || '；currenttype:' || CURRENTTYPE;

    BEGIN
        TOTAL         := 1000;
        V_SQL_START   := ' case ';
        V_SQL_CONTENT := '';
        V_SQL_END     := '  else '''' end  ';


        --调用数据权限验证存储过程
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
        --1.拼接查询语句
        FOR ITEM IN (SELECT S.EXPRESSION, VV.NODE_LEVEL, VV.PLAN_TYPE
                     FROM   POM_RULE_SET S
                     LEFT   JOIN (SELECT MAX(S.CREATED_TIME) AS T, NODE_LEVEL, PLAN_TYPE
                                 FROM   POM_RULE_SET S
                                 LEFT   JOIN POM_RULE_SET_PLAN_TYPE PT
                                 ON     S.ID = PT.RULE_ID
                                 WHERE  RULE_TYPE = '亮灯规则'
                                       -- AND plan_type != '关键节点计划'
                                        AND
                                        S.IS_DISABLE = 0
                                 GROUP  BY NODE_LEVEL, PLAN_TYPE) VV
                     ON     S.CREATED_TIME = VV.T AND
                            S.NODE_LEVEL = VV.NODE_LEVEL
                     WHERE  VV.T IS NOT NULL)
        LOOP
            ---拼接字符串
            V_SQL_CONTENT := V_SQL_CONTENT || '  when plan_type=''' || CASE ITEM.PLAN_TYPE
                                 WHEN '项目全景计划' THEN
                                  '项目主项计划'
                                 ELSE
                                  ITEM.PLAN_TYPE
                             END || ''' and node_level=''' || ITEM.NODE_LEVEL || ''' then (' || ITEM.EXPRESSION || ')';
        END LOOP;

        --dbms_output.put_line('123333');
        --dbms_output.put_line(v_sql_content);
        --规则内容大于0才拼规则语句

        IF LENGTH(V_SQL_CONTENT) > 0
        THEN
            V_SQL := V_SQL_START || V_SQL_CONTENT || V_SQL_END;
        ELSE
            --无规则亮灯显示空
            V_SQL := '''''';
        END IF;

        -------------------------------------------------------------------------------------------内容


        IF CURRENTTYPE = '本月任务'
        THEN
            V_WHERE := ' and ACTUAL_END_DATE is null and (PLAN_END_DATE>=trunc(sysdate, ''month'') and PLAN_END_DATE<=trunc(last_day(sysdate))) ';
        ELSIF CURRENTTYPE = '超期未完成任务'
        THEN
            V_WHERE := ' and TRUNC(SYSDATE) > PLAN_END_DATE and ACTUAL_END_DATE is null';
        ELSIF CURRENTTYPE = '所有未完成任务'
        THEN
            V_WHERE := ' and ACTUAL_END_DATE is null ';
        ELSIF CURRENTTYPE = '所有已完成任务'
        THEN
            V_WHERE := ' and ACTUAL_END_DATE is not null ';
        ELSIF CURRENTTYPE = '所有任务'
        THEN
            V_WHERE := ' ';
        ELSE
            V_WHERE := ' and 1=2';
        END IF;

        --当输入条件部位空时
        IF searchcondition is not null THEN
          v_where_like := 'WHERE (instr(n.NODE_NAME,'''||searchcondition||''')>0 OR instr(n.PLAN_NAME,'''||searchcondition||''')>0 
              OR instr(n.PROJ_NAME,'''||searchcondition||''')>0 OR instr(n.DUTY_DEPARTMENT,'''||searchcondition||''')>0 
              OR instr(charge_person,'''||searchcondition||''')>0 )'; 
        ELSE
          v_where_like := '';
        END IF;

        --3.拼接完整语句
        IF PROJID<>'111' THEN 
        V_SQL_EXEC := ' select  rownum as rowno,ID,
                    ORIGINAL_NODE_ID,
                    ORIGINAL_PLAN_ID,
                    PROJ_PLAN_ID as PLAN_ID,
                    PLAN_TYPE_INT,
                    NODE_NAME,
                    PLAN_NAME,
                    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
                    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
                    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
                    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
                    case when ACTUAL_END_DATE is null then ''未完成''
                    else ''已完成'' end as COMPLETION_STATUS,
                    PROJ_NAME,
                    PLAN_TYPE,
                    DUTY_DEPARTMENT,
                    CHARGE_PERSON,
                    NODE_LEVEL,
                    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,w_Url,' || V_SQL || ' as NODE_WARNING from (select n.*,w.IS_UN_WATCH
                ,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
                ,case when n.ACTUAL_END_DATE IS NOT NULL THEN NULL 
                ELSE ''催办'' END as HASTEN
                ,case when w.IS_UN_WATCH=0 then ''/api/pom/planfollow/unfollow?cancelType=0=724=300=''||ORIGINAL_NODE_ID else ''/pom/biz-watch/bizwatch-setting?cancelType=0=724=300==''||ORIGINAL_NODE_ID end as w_Url

                                      from(SELECT
                    n.ID,
                     p.ORIGINAL_PLAN_ID,
                    ORIGINAL_NODE_ID,
                    n.PROJ_PLAN_ID,
                    CASE p.PLAN_TYPE
                        WHEN ''关键节点计划''   THEN
                            0
                        WHEN ''项目主项计划''   THEN
                            1
                    END AS PLAN_TYPE_INT,

                    NODE_NAME,
                    p.PLAN_NAME,--计划名称
                    PLAN_START_DATE,
                    PLAN_END_DATE,

                    ACTUAL_END_DATE,
                    ESTIMATE_END_DATE,           --预计完成时间
                    p.PROJ_NAME,          --所属项目
                    p.PLAN_TYPE,        --计划类型显示名
                    DUTY_DEPARTMENT,          --主责部门
                    cp.CHARGE_PERSON,
                    NODE_LEVEL,           --任务等级
                    STANDARD_SCORE          --标准分值
                FROM
                    POM_PROJ_PLAN_NODE n LEFT
                    JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
                    left join (SELECT node_id,LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
                    FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID
                    LEFT JOIN SYS_PROJECT_STAGE sps on p.proj_id=sps.id 
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal 
                    ON (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
                    WHERE p.PLAN_TYPE=''关键节点计划'' AND NVL(n.IS_DISABLE,0) <> 1 and APPROVAL_STATUS=''已审核''
                    AND (p.PROJ_ID=''' || PROJID || ''' OR p.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''' || PROJID || '''))  ' || V_WHERE || '
                )n
                    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID '||v_where_like||' ORDER BY n.PLAN_END_DATE)  a ';
        ELSE
            V_SQL_EXEC := 'select  rownum as rowno,ID,
                    ORIGINAL_NODE_ID,
                    ORIGINAL_PLAN_ID,
                    PROJ_PLAN_ID as PLAN_ID,
                    PLAN_TYPE_INT,
                    NODE_NAME,
                    PLAN_NAME,
                    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
                    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
                    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
                    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
                    case when ACTUAL_END_DATE is null then ''未完成''
                    else ''已完成'' end as COMPLETION_STATUS,
                    PROJ_NAME,
                    PLAN_TYPE,
                    DUTY_DEPARTMENT,
                    CHARGE_PERSON,
                    NODE_LEVEL,
                    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,w_Url,' || V_SQL || ' as NODE_WARNING from (select n.*,w.IS_UN_WATCH
                ,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
                ,case when n.ACTUAL_END_DATE IS NOT NULL THEN NULL 
                ELSE ''催办'' END as HASTEN
                ,case when w.IS_UN_WATCH=0 then ''/api/pom/planfollow/unfollow?cancelType=0=724=300=''||ORIGINAL_NODE_ID else ''/pom/biz-watch/bizwatch-setting?cancelType=0=724=300==''||ORIGINAL_NODE_ID end as w_Url

                                      from(SELECT
                    n.ID,
                     p.ORIGINAL_PLAN_ID,
                    ORIGINAL_NODE_ID,
                    n.PROJ_PLAN_ID,
                    CASE p.PLAN_TYPE
                        WHEN ''关键节点计划''   THEN
                            0
                        WHEN ''项目主项计划''   THEN
                            1
                    END AS PLAN_TYPE_INT,

                    NODE_NAME,
                    p.PLAN_NAME,--计划名称
                    PLAN_START_DATE,
                    PLAN_END_DATE,

                    ACTUAL_END_DATE,
                    ESTIMATE_END_DATE,           --预计完成时间
                    p.PROJ_NAME,          --所属项目
                    p.PLAN_TYPE,        --计划类型显示名
                    DUTY_DEPARTMENT,          --主责部门
                    cp.CHARGE_PERSON,
                    NODE_LEVEL,           --任务等级
                    STANDARD_SCORE          --标准分值
                FROM
                    POM_PROJ_PLAN_NODE n LEFT
                    JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
                    left join (SELECT node_id,LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
                    FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID
                    LEFT JOIN SYS_PROJECT_STAGE sps on p.proj_id=sps.id 
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal 
                    ON (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
                    WHERE p.PLAN_TYPE=''关键节点计划'' AND NVL(n.IS_DISABLE,0) <> 1 and APPROVAL_STATUS=''已审核''
                     ' || V_WHERE || '
                )n
                    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID '||v_where_like||' ORDER BY n.PLAN_END_DATE) a ';
        END IF;
        -------------------------------------------------------------------------------------------内容

        V_SQL_EXEC_PAGING := '
select a.* from ( ' || V_SQL_EXEC || ' where rownum <= ' || PAGEINDEX * PAGESIZES || ' ) a where a.rowno >= ' || PAGESIZES * (PAGEINDEX - 1) || '';

        DBMS_OUTPUT.PUT_LINE(V_SQL_EXEC);
        ----获取总条数
        EXECUTE IMMEDIATE 'SELECT count(rowno) from(' || V_SQL_EXEC || ') a '
            INTO TOTAL;

        -- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN ITEMS FOR V_SQL_EXEC_PAGING;
        --SELECT '' A FROM DUAL;

    EXCEPTION
        WHEN OTHERS THEN
            TESTMSG := SQLERRM || TESTMSG;
            OPEN ITEMS FOR
                SELECT '失败咯' || TESTMSG PLAN_NAME FROM DUAL;

            DBMS_OUTPUT.PUT_LINE(SQLERRM);
    END;

END P_POM_SMART_KEY_NODE_PLAN_PROJ;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_KEY_NODE_PLAN_TBS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_SMART_KEY_NODE_PLAN_TBS" 
(
    ORGTYPE   IN VARCHAR2
   , --查询类型，用于判断过滤 0,公司|1,部门|2,项目|3,本人
    CONDITION IN VARCHAR2
   , --输入变量：公司id | 部门id | 项目id | 当前用户ID
    userid        IN            VARCHAR2,--用户id用于过滤关注的任务
    currentcompanyid     IN     VARCHAR2,--当前用户的公司
    currentstationid     IN            VARCHAR2,---当前用户的岗位
    currentdeptid        IN            VARCHAR2,---当前用户的部门
    bizcode       IN            VARCHAR2,---权限code
    searchcondition IN          VARCHAR2,--模糊查询条件
    ITEM      OUT SYS_REFCURSOR
) IS
    --任务中心tabs任务条数统计数据源
    --作者：yedr
    --日期：2019/12/25
    v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN

    --调用数据权限验证存储过程
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
    IF CONDITION<>'222' THEN
        OPEN ITEM FOR
            SELECT NVL(SUM(CASE
                               WHEN B.ACTUAL_END_DATE IS NULL
                               AND ( B.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND B.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) ) THEN
                                1
                               ELSE
                                0
                           END), 0) AS ACOUNT,
                   NVL(SUM(CASE
                               WHEN B.ACTUAL_END_DATE IS NULL
                                    AND TRUNC(SYSDATE) > B.PLAN_END_DATE THEN
                                1
                               ELSE
                                0
                           END),
                       0) AS BCOUNT,
                   NVL(SUM(CASE
                               WHEN B.ACTUAL_END_DATE IS NULL THEN
                                1
                               ELSE
                                0
                           END),
                       0) AS CCOUNT,
                   NVL(SUM(CASE
                               WHEN B.ACTUAL_END_DATE IS NOT NULL THEN
                                1
                               ELSE
                                0
                           END),
                       0) AS DCOUNT,
                   COUNT(*) AS ECOUNT
            FROM  POM_PROJ_PLAN_NODE B 
            LEFT JOIN  POM_PROJ_PLAN A ON  A.ID = B.PROJ_PLAN_ID 
            LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON B.ID=person.NODE_ID
            LEFT JOIN  SYS_PROJECT_STAGE sps on A.proj_id=sps.id 
            LEFT JOIN  (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal 
            on (case when sps.id is not null then sps.PROJECT_ID else A.proj_id end)=tal.orgId
            WHERE 
                   A.APPROVAL_STATUS = '已审核' AND
                   A.PLAN_TYPE = '关键节点计划' AND
                   NVL(B.IS_DISABLE, 0) <> 1 AND
                   (A.PROJ_ID = '' || CONDITION || '' OR A.PROJ_ID IN (SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID = '' || CONDITION || ''))
                   AND (b.node_name like '%'||searchcondition||'%' OR a.plan_name like '%'||searchcondition||'%'
                   OR a.PROJ_NAME like '%'||searchcondition||'%' OR b.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%');
        ELSE
             OPEN ITEM FOR
             SELECT NVL(SUM(CASE
                               WHEN B.ACTUAL_END_DATE IS NULL
                               AND ( B.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND B.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) ) 
                               THEN
                                1
                               ELSE
                                0
                           END), 0) AS ACOUNT,
                   NVL(SUM(CASE
                               WHEN B.ACTUAL_END_DATE IS NULL
                                    AND TRUNC(SYSDATE) > B.PLAN_END_DATE THEN
                                1
                               ELSE
                                0
                           END),
                       0) AS BCOUNT,
                   NVL(SUM(CASE
                               WHEN B.ACTUAL_END_DATE IS NULL THEN
                                1
                               ELSE
                                0
                           END),
                       0) AS CCOUNT,
                   NVL(SUM(CASE
                               WHEN B.ACTUAL_END_DATE IS NOT NULL THEN
                                1
                               ELSE
                                0
                           END),
                       0) AS DCOUNT,
                   COUNT(*) AS ECOUNT
            FROM  POM_PROJ_PLAN_NODE B 
            LEFT JOIN  POM_PROJ_PLAN A ON  A.ID = B.PROJ_PLAN_ID 
            LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON B.ID=person.NODE_ID
            LEFT JOIN  SYS_PROJECT_STAGE sps on A.proj_id=sps.id 
            LEFT JOIN  (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal 
            on (case when sps.id is not null then sps.PROJECT_ID else A.proj_id end)=tal.orgId
            WHERE 
                   A.APPROVAL_STATUS = '已审核' AND
                   A.PLAN_TYPE = '关键节点计划' AND
                   NVL(B.IS_DISABLE, 0) <> 1
                  AND (b.node_name like '%'||searchcondition||'%' OR a.plan_name like '%'||searchcondition||'%'
                   OR a.PROJ_NAME like '%'||searchcondition||'%' OR b.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%');
                  --AND (A.PROJ_ID = '' || CONDITION || '' OR A.PROJ_ID IN (SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID = '' || CONDITION || ''))
        END IF;
END P_POM_SMART_KEY_NODE_PLAN_TBS;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_KEYNODEPLAN_TBS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_SMART_KEYNODEPLAN_TBS" ( orgtype IN VARCHAR2, --查询类型，用于判断过滤 0,公司|1,部门|2,项目|3,,本人
    condition IN VARCHAR2, --输入变量：公司id | 部门id | 项目id | 当前用户ID
  item OUT SYS_REFCURSOR ) IS
  --任务中心tabs任务条数统计数据源
  --作者：yedr
  --日期：2019/12/25
BEGIN

OPEN item FOR

            POM_PROJ_PLAN_NODE node
            LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
          WHERE
            plan.PLAN_TYPE = '关键节点计划'
            AND plan.APPROVAL_STATUS = '已审核'
            AND plan.PROJ_ID ='e381dc98-c7db-4a4a-872c-02faa4c0759e'
        ) AS ACOUNT,
--超期未完成任务
        1 AS BCOUNT,
--所有未完成任务

          2
         AS CCOUNT,
--所有已完成任务

          3
         AS DCOUNT,
--所有任务

          4
         AS ECOUNT,
--次月任务

          5
        AS FCOUNT,
--本季度任务

          6
        AS GCOUNT,
--本年任务

          7
         AS HCOUNT
      FROM
        dual;

END P_POM_SMART_KEYNODEPLAN_TBS;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_MY_CURRENT_COMPANY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_SMART_MY_CURRENT_COMPANY" (
    companyid     IN            VARCHAR2,--输入变量：公司id
    currentcompanyid     IN     VARCHAR2,--当前用户的公司
	userid        IN            VARCHAR2,--用户id用于过滤关注的任务
    currentstationid     IN            VARCHAR2,---当前用户的岗位
    currentdeptid        IN            VARCHAR2,---当前用户的部门
    bizcode       IN            VARCHAR2,---权限code
    pageindex     IN            INT,
    pagesizes     IN            INT,
    currenttype   IN            VARCHAR2,--完成节点类型(本月任务,超期未完成任务,所有未完成任务,所有已完成任务,所有任务,次月任务,本季度任务,本年任务)
    searchcondition IN          VARCHAR2,--模糊查询条件
    items         OUT           SYS_REFCURSOR,
    total         OUT           INT
--  spiditems         OUT           SYS_REFCURSOR
) IS
--本部门负责的任务
--作者：陈丽
--日期：2019/11/15

    v_sql_start          CLOB;
    v_sql_end            CLOB;
    v_sql_content       CLOB;
    v_sql               CLOB;
    v_sql_exec          CLOB;
    v_sql_exec_paging   CLOB;
    v_where              CLOB;
    v_spid              VARCHAR2(200);--数据权限验证spid
    testmsg             CLOB;
    wwhere          CLOB;
    v_where_like       CLOB;

BEGIN
----------------------------------------------------统一解析
    wwhere := companyid;
    --wwhere := ''' or ''1''=''1';
    testmsg := 'companyid:'
               || companyid
               || '；pageindex:'
               || pageindex
               || '；pagesizes:'
               || pagesizes
               || '；currenttype:'
               || currenttype;

    BEGIN
        total := 1000;
        v_sql_start := ' case ';
        v_sql_content := '';
        v_sql_end := '  else '''' end  ';
--调用数据权限验证存储过程
 P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );

-- open  spiditems   for select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = v_spid;
--1.拼接查询语句
        FOR item IN (
            SELECT
                s.expression,
                vv.node_level,
                vv.plan_type
            FROM
                pom_rule_set s
                LEFT JOIN (
                    SELECT
                        MAX(s.created_time) AS t,
                        node_level,
                        plan_type
                    FROM
                        pom_rule_set             s
                        LEFT JOIN pom_rule_set_plan_type   pt ON s.id = pt.rule_id
                    WHERE
                        rule_type = '亮灯规则'
                        --AND plan_type = '关键节点计划'
                        AND s.is_disable = 0
                    GROUP BY
                        node_level,
                        plan_type
                ) vv ON s.created_time = vv.t
                        AND s.node_level = vv.node_level
            WHERE
                vv.t IS NOT NULL
        ) LOOP
    ---拼接字符串
         v_sql_content := v_sql_content
                                || '  when plan_type='''
                                ||
            CASE item.plan_type
                WHEN '项目全景计划' THEN
                    '项目主项计划'
                ELSE item.plan_type
            END
                                || ''' and node_level='''
                                || item.node_level
                                || ''' then ('
                                || item.expression
                                || ')';
        END LOOP;

    --dbms_output.put_line('123333');
    --dbms_output.put_line(v_sql_content);
    --规则内容大于0才拼规则语句

        IF length(v_sql_content) > 0 THEN
            v_sql := v_sql_start
                     || v_sql_content
                     || v_sql_end;
        ELSE
    --无规则亮灯显示空
            v_sql := '''''';
        END IF;

-------------------------------------------------------------------------------------------内容

            IF currenttype = '本月任务' THEN
            v_where := ' and ACTUAL_END_DATE is null and (PLAN_END_DATE>=trunc(sysdate, ''month'') and PLAN_END_DATE<=trunc(last_day(sysdate))) ';
        ELSIF currenttype = '超期未完成任务' THEN
            v_where := ' and sysdate>PLAN_END_DATE  and ACTUAL_END_DATE is null';
        ELSIF currenttype = '所有未完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is null ';
        ELSIF currenttype = '所有已完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is not null ';
        ELSIF currenttype = '所有任务' THEN
            v_where := ' ';
        ELSIF currenttype = '次月任务' THEN
            v_where := ' and (PLAN_END_DATE>last_day(trunc(sysdate))+1 and PLAN_END_DATE<last_day(last_day(trunc(sysdate))+1))';
        ELSIF currenttype = '本季度任务' THEN
            v_where := ' and (PLAN_END_DATE>trunc(sysdate, ''Q'') and PLAN_END_DATE<add_months(trunc(sysdate, ''Q''), 3) - 1) ';
        ELSIF currenttype = '本年任务' THEN
            v_where := ' and (PLAN_END_DATE>trunc(sysdate, ''yyyy'') and PLAN_END_DATE<add_months(trunc(sysdate, ''yyyy''), 12) - 1)  ';
        ELSE
            v_where := ' and 1=2';
        END IF;

        --当输入条件部位空时
        IF searchcondition is not null THEN
          v_where_like := 'WHERE (instr(n.NODE_NAME,'''||searchcondition||''')>0 OR instr(n.PLAN_NAME,'''||searchcondition||''')>0
              OR instr(n.PROJ_NAME,'''||searchcondition||''')>0 OR instr(n.DUTY_DEPARTMENT,'''||searchcondition||''')>0
              OR instr(charge_person,'''||searchcondition||''')>0 )';
        ELSE
          v_where_like := '';
        END IF;

--3.拼接完整语句
IF companyid <> '333' THEN
        v_sql_exec := ' select  rownum as rowno,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
		CHARGE_PERSON,
    NODE_LEVEL,
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,w_Url,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE is null then ''催办''
else null end as HASTEN
,case when w.IS_UN_WATCH=0 then ''/pom/biz-watch/bizwatch-unfollow?cancelType=0&windowWidth=400&windowHeight=70&bizId=''||ORIGINAL_NODE_ID else ''/pom/biz-watch/bizwatch-setting?cancelType=0&windowWidth=724&windowHeight=300&bizId=''||ORIGINAL_NODE_ID end as W_Url

                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    n.ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门
		cp.CHARGE_PERSON,
    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n
		LEFT JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
		left join (SELECT node_id,LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
      FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID
        left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id
        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal
        on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
        WHERE tal.orgid is not null AND (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and APPROVAL_STATUS=''已审核''
		AND	n.IS_DISABLE=0
    and n.COMPANY_ID='''
                      || wwhere
                      || ''' '
                      || v_where
                      || '
UNION ALL
SELECT
    n.ID   AS id,
     p.id as ORIGINAL_PLAN_ID,
    n.ID   AS ORIGINAL_NODE_ID,
    PLAN_ID,
    2 AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    PREDICT_END_DATE,
    ''所属项目'' AS E,
    ''专项计划'' AS F,
    DUTY_DEPARTMENT,
		cp.CHARGE_PERSON,
    ''专项计划级'' AS M,
    0 AS N
FROM
    POM_SPECIAL_PLAN_NODE n
		LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID
		left join (SELECT node_id,LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
        FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID
        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal
        on n.DUTY_DEPARTMENT_ID in tal.orgid or n.COMPANY_ID in tal.orgid or p.COMPANY_ID in tal.orgid
        WHERE tal.orgid is not null AND APPROVAL_STATUS=''已审核''  AND n.IS_DELETE=0 and n.COMPANY_ID='''
                      || wwhere
                      || ''' '
                      || v_where
                      || '
UNION ALL
    SELECT    n.id,
    p.ORIGINAL_PLAN_ID,
    n.original_node_id,
    dept_monthly_plan_id,
    4 as  PLAN_TYPE_INT,

    node_name,
    p.PLAN_NAME,
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    ''无'' as PROJ_NAME,          --所属项目
    ''部门月度计划'' as  PLAN_TYPE,        --计划类型显示名
    p.DEPT_NAME,          --主责部门
		cp.CHARGE_PERSON,
    node_Type,           --任务等级
    stand_SCORE          --标准分值
FROM
    pom_dept_monthly_plan_node n
    left join pom_dept_monthly_plan p on n.dept_monthly_plan_id=p.id
    left join (SELECT node_id,LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
    FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal
    on p.DEPT_ID in tal.orgid or p.COMPANY_ID in tal.orgid
    WHERE tal.orgid is not null AND (IS_DEL=0 OR IS_DEL=null) and APPROVE_STATUS=''已审核'' and p.COMPANY_ID='''
                      || companyid
                      || ''' '
                      || v_where
                      || ')n
    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID '||v_where_like||' ORDER BY n.PLAN_END_DATE) a ';
ELSE
v_sql_exec := ' select  rownum as rowno,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
		CHARGE_PERSON,
    NODE_LEVEL,
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,w_Url,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE is null then ''催办''
else null end as HASTEN
,case when w.IS_UN_WATCH=0 then ''/pom/biz-watch/bizwatch-unfollow?cancelType=0&windowWidth=400&windowHeight=70&bizId=''||ORIGINAL_NODE_ID else ''/pom/biz-watch/bizwatch-setting?cancelType=0&windowWidth=724&windowHeight=300&bizId=''||ORIGINAL_NODE_ID end as W_Url

                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    n.ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门
		cp.CHARGE_PERSON,
    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n
		LEFT JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
		left join (SELECT node_id,LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
        FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID
        left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id
        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal
        on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
        WHERE tal.orgid is not null AND (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and APPROVAL_STATUS=''已审核''
		AND	n.IS_DISABLE=0
         '|| v_where || '
UNION ALL
SELECT
    n.ID   AS id,
     p.id as ORIGINAL_PLAN_ID,
    n.ID   AS ORIGINAL_NODE_ID,
    PLAN_ID,
    2 AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    PREDICT_END_DATE,
    ''所属项目'' AS E,
    ''专项计划'' AS F,
    DUTY_DEPARTMENT,
		cp.CHARGE_PERSON,
    ''专项计划级'' AS M,
    0 AS N
FROM
    POM_SPECIAL_PLAN_NODE n
		LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID
		left join (SELECT node_id,LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
        FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID
        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal
        on n.DUTY_DEPARTMENT_ID in tal.orgid or n.COMPANY_ID in tal.orgid or  p.COMPANY_ID in tal.orgid
        WHERE tal.orgid is not null AND APPROVAL_STATUS=''已审核''  AND n.IS_DELETE=0 '|| v_where || '
UNION ALL
    SELECT    n.id,
    p.ORIGINAL_PLAN_ID,
    n.original_node_id,
    dept_monthly_plan_id,
    4 as  PLAN_TYPE_INT,

    node_name,
    p.PLAN_NAME,
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    ''无'' as PROJ_NAME,          --所属项目
    ''部门月度计划'' as  PLAN_TYPE,        --计划类型显示名
    p.DEPT_NAME,          --主责部门
		cp.CHARGE_PERSON,
    node_Type,           --任务等级
    stand_SCORE          --标准分值
FROM
    pom_dept_monthly_plan_node n
    left join pom_dept_monthly_plan p on n.dept_monthly_plan_id=p.id
    left join (SELECT node_id,LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
    FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal
    on p.DEPT_ID in tal.orgid or p.COMPANY_ID in tal.orgid
    WHERE tal.orgid is not null AND (IS_DEL=0 OR IS_DEL=null) and APPROVE_STATUS=''已审核'' ' || v_where|| ')n
    left join （SELECT * FROM SYS_BIZ_WATCH w WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID '||v_where_like||' ORDER BY n.PLAN_END_DATE) a  ';
END IF;
-------------------------------------------------------------------------------------------内容

        v_sql_exec_paging := '
select a.* from ( '
                             || v_sql_exec
                             || ' where rownum <= '
                             || pageindex * pagesizes
                             || ' ) a where a.rowno >= '
                             || pagesizes * ( pageindex - 1 )
                             || '';

       -- dbms_output.put_line(v_sql_exec_paging);

				dbms_output.put_line(v_sql_exec_paging);
----获取总条数
        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
                          || v_sql_exec
                          || ') a '
        INTO total;

-- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN items FOR v_sql_exec_paging;
--SELECT '' A FROM DUAL;

    EXCEPTION
        WHEN OTHERS THEN
        testmsg:=sqlerrm||testmsg;
            OPEN items FOR SELECT
                               '失败咯' || testmsg plan_name
                           FROM
                               dual;

           -- dbms_output.put_line(sqlerrm);
    END;

END p_pom_smart_my_current_company;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_MY_CURRENT_DEPT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_SMART_MY_CURRENT_DEPT" (
    userid        IN            VARCHAR,--用户id，用于过滤关注的任务
    deptid        IN            VARCHAR2,--输入变量：部门
    currentcompanyid     IN            VARCHAR2,--当前用户公司
    currentdeptid        IN            VARCHAR2,--当前用户部门
    currentstationid     IN            VARCHAR2,---当前用户的岗位
    bizcode       IN            VARCHAR2,---权限code
    pageindex     IN            INT,
    pagesizes     IN            INT,
    currenttype   IN            VARCHAR2,--完成节点类型(本月任务,超期未完成任务,所有未完成任务,所有已完成任务,所有任务,次月任务,本季度任务,本年任务)
    searchcondition IN          VARCHAR2,
    items         OUT           SYS_REFCURSOR,
    total         OUT           INT
--    auth          OUT           SYS_REFCURSOR
) IS
--本部门负责的任务
--作者：陈丽
--日期：2019/11/15

    v_sql_start          CLOB;
    v_sql_end            CLOB;
    v_sql_content        CLOB;
    v_sql               CLOB;
    v_sql_exec          CLOB;
    v_sql_exec_paging   CLOB;
    v_spid              CLOB;
    deptidwhere         CLOB;
    v_where              CLOB;
    testmsg             CLOB;
--    test_sql        CLOB;
BEGIN
----------------------------------------------------统一解析
--    IF (deptid <> '444') THEN
        deptidwhere := deptid;
--    ELSE
--        deptidwhere := '';
--    END IF;
    --deptidwhere := ''' or ''1''=''1';
    testmsg := 'deptid:'
               || deptid
               || '；pageindex:'
               || pageindex
               || '；pagesizes:'
               || pagesizes
               || '；currenttype:'
               || currenttype;

    BEGIN
        total := 1000;
        v_sql_start := ' case ';
        v_sql_content := '';
        v_sql_end := '  else '''' end  ';

--调用数据权限验证存储过程
 P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
--        test_sql:=' select n.*,orgid  FROM POM_SPECIAL_PLAN_NODE n
--        LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID
--        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=n.DUTY_DEPARTMENT_ID or tal.orgid=n.COMPANY_ID
--
--        WHERE  APPROVAL_STATUS=''已审核'' and n.IS_DELETE=0';
--
--
--        open auth for test_sql;
--1.拼接查询语句
        FOR item IN (
            SELECT
                s.expression,
                vv.node_level,
                vv.plan_type
            FROM
                pom_rule_set s
                LEFT JOIN (
                    SELECT
                        MAX(s.created_time) AS t,
                        node_level,
                        plan_type
                    FROM
                        pom_rule_set             s
                        LEFT JOIN pom_rule_set_plan_type   pt ON s.id = pt.rule_id
                    WHERE
                        rule_type = '亮灯规则'
                       -- AND plan_type != '关键节点计划'
                        AND s.is_disable = 0
                    GROUP BY
                        node_level,
                        plan_type
                ) vv ON s.created_time = vv.t
                        AND s.node_level = vv.node_level
            WHERE
                vv.t IS NOT NULL
        ) LOOP
    ---拼接字符串
         v_sql_content := v_sql_content
                                || '  when plan_type='''
                                ||
            CASE item.plan_type
                WHEN '项目全景计划' THEN
                    '项目主项计划'
                ELSE item.plan_type
            END
                                || ''' and node_level='''
                                || item.node_level
                                || ''' then ('
                                || item.expression
                                || ')';
        END LOOP;

    --dbms_output.put_line('123333');
    --dbms_output.put_line(v_sql_content);
    --规则内容大于0才拼规则语句

        IF length(v_sql_content) > 0 THEN
            v_sql := v_sql_start
                     || v_sql_content
                     || v_sql_end;
        ELSE
    --无规则亮灯显示空
            v_sql := '''''';
        END IF;

-------------------------------------------------------------------------------------------内容

       IF currenttype = '本月任务' THEN
            v_where := ' and ACTUAL_END_DATE is null  and (PLAN_END_DATE>=trunc(sysdate, ''month'') and PLAN_END_DATE<=trunc(last_day(sysdate))) ';
        ELSIF currenttype = '超期未完成任务' THEN
            v_where := ' and sysdate>PLAN_END_DATE and ACTUAL_END_DATE is null';
        ELSIF currenttype = '所有未完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is null ';
        ELSIF currenttype = '所有已完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is not null ';
        ELSIF currenttype = '所有任务' THEN
            v_where := ' ';
        ELSIF currenttype = '次月任务' THEN
            v_where := ' and (PLAN_END_DATE>last_day(trunc(sysdate))+1 and PLAN_END_DATE<last_day(last_day(trunc(sysdate))+1))';
        ELSIF currenttype = '本季度任务' THEN
            v_where := ' and (PLAN_END_DATE>trunc(sysdate, ''Q'') and PLAN_END_DATE<add_months(trunc(sysdate, ''Q''), 3) - 1) ';
        ELSIF currenttype = '本年任务' THEN
            v_where := ' and (PLAN_END_DATE>trunc(sysdate, ''yyyy'') and PLAN_END_DATE<add_months(trunc(sysdate, ''yyyy''), 12) - 1)  ';
        ELSE
            v_where := ' and 1=2';
        END IF;
--3.拼接完整语句
IF (deptid <> '444') THEN
        v_sql_exec := ' select  rownum as rowno,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
    NODE_LEVEL,
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,charge_person,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,charge_person,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE is null then ''催办''
else null end as HASTEN

                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门

    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n LEFT
    JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
   left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id
    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
    WHERE  (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and APPROVAL_STATUS=''已审核''  AND	n.IS_DISABLE=0  and DUTY_DEPARTMENT_ID='''
                      || deptidwhere
                      || ''' '
                      || v_where
                      || '
UNION ALL
SELECT
    n.ID   AS id,
     p.id as ORIGINAL_PLAN_ID,
    n.ID   AS ORIGINAL_NODE_ID,
    PLAN_ID,
    2 AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    PREDICT_END_DATE,
    ''所属项目'' AS E,
    ''专项计划'' AS F,
    DUTY_DEPARTMENT,

    ''专项计划级'' AS M,
    0 AS N
FROM
    POM_SPECIAL_PLAN_NODE n
    LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID
     LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=n.DUTY_DEPARTMENT_ID or tal.orgid=n.COMPANY_ID
     WHERE  p.APPROVAL_STATUS=''已审核'' and n.IS_DELETE=0  and n.DUTY_DEPARTMENT_ID='''
                      || deptidwhere
                      || ''' '
                      || v_where
                      || '
UNION ALL
    SELECT    n.id,
    p.ORIGINAL_PLAN_ID,
    original_node_id,
    dept_monthly_plan_id,
    4 as  PLAN_TYPE_INT,

    node_name,
    p.PLAN_NAME,
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    ''无'' as PROJ_NAME,          --所属项目
    ''部门月度计划'' as  PLAN_TYPE,        --计划类型显示名
    p.DEPT_NAME,          --主责部门

    node_Type,           --任务等级
    stand_SCORE          --标准分值
FROM
    pom_dept_monthly_plan_node n
    left join pom_dept_monthly_plan p on n.dept_monthly_plan_id=p.id
     LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=p.DEPT_ID or tal.orgid=p.COMPANY_ID
     WHERE  node_source is null and APPROVE_STATUS=''已审核''   AND n.IS_DEL=0 and DUTY_DEPT_ID='''
                      || deptidwhere
                      || ''' '
                      || v_where
                      || ')n
    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID
    left join (SELECT node_id,
     LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
      FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID WHERE (n.NODE_NAME LIKE ''%'||searchcondition||'%'' OR  n.PLAN_NAME LIKE ''%'||searchcondition||'%''
    OR n.PROJ_NAME LIKE ''%'||searchcondition||'%'' OR n. DUTY_DEPARTMENT LIKE ''%'||searchcondition||'%'' OR cp.charge_person like ''%'||searchcondition||'%'' )  ORDER BY n.PLAN_END_DATE) a ';
else
     v_sql_exec := ' select  rownum as rowno,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
    NODE_LEVEL,
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,charge_person,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,charge_person,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE is null then ''催办''
else null end as HASTEN

                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门

    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n LEFT
    JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
    left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id
    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
    WHERE (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and APPROVAL_STATUS=''已审核''  AND	n.IS_DISABLE=0 '
                      || v_where
                      || '
UNION ALL
SELECT
    n.ID   AS id,
     p.id as ORIGINAL_PLAN_ID,
    n.ID   AS ORIGINAL_NODE_ID,
    PLAN_ID,
    2 AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    PREDICT_END_DATE,
    ''所属项目'' AS E,
    ''专项计划'' AS F,
    DUTY_DEPARTMENT,

    ''专项计划级'' AS M,
    0 AS N
FROM
    POM_SPECIAL_PLAN_NODE n
    LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID
     LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=n.DUTY_DEPARTMENT_ID or tal.orgid=n.COMPANY_ID
     WHERE  APPROVAL_STATUS=''已审核'' and n.IS_DELETE=0  '
                      || v_where
                      || '
UNION ALL
    SELECT    n.id,
    p.ORIGINAL_PLAN_ID,
    original_node_id,
    dept_monthly_plan_id,
    4 as  PLAN_TYPE_INT,

    node_name,
    p.PLAN_NAME,
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    ''无'' as PROJ_NAME,          --所属项目
    ''部门月度计划'' as  PLAN_TYPE,        --计划类型显示名
    p.DEPT_NAME,          --主责部门

    node_Type,           --任务等级
    stand_SCORE          --标准分值
FROM
    pom_dept_monthly_plan_node n
    left join pom_dept_monthly_plan p on n.dept_monthly_plan_id=p.id
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=p.DEPT_ID or tal.orgid=p.COMPANY_ID
    WHERE  node_source is null and APPROVE_STATUS=''已审核''   AND n.IS_DEL=0  '
                      || v_where
                      || ')n
    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID
    left join (SELECT node_id,
    LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
    FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID WHERE (n.NODE_NAME LIKE ''%'||searchcondition||'%'' OR  n.PLAN_NAME LIKE ''%'||searchcondition||'%''
    OR n.PROJ_NAME LIKE ''%'||searchcondition||'%'' OR n.DUTY_DEPARTMENT LIKE ''%'||searchcondition||'%'' OR cp.charge_person like ''%'||searchcondition||'%'' )  ORDER BY n.PLAN_END_DATE) a ';
end if;
-------------------------------------------------------------------------------------------内容

        v_sql_exec_paging := '
select a.* from ( '
                             || v_sql_exec
                             || ' where rownum <= '
                             || pageindex * pagesizes
                             || ' ) a where a.rowno >= '
                             || pagesizes * ( pageindex - 1 )
                             || '';

        dbms_output.put_line(v_sql_exec_paging);
----获取总条数
        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
                          || v_sql_exec
                          || ') a '
        INTO total;

-- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN items FOR v_sql_exec_paging;
--SELECT '' A FROM DUAL;

    EXCEPTION
        WHEN OTHERS THEN
            testmsg := sqlerrm || testmsg;
            OPEN items FOR SELECT
                               '失败咯' || testmsg plan_name
                           FROM
                               dual;

            dbms_output.put_line(sqlerrm);
    END;

END p_pom_smart_my_current_dept;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_MY_CURRENT_PERSON
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_SMART_MY_CURRENT_PERSON" (
    userid        IN            VARCHAR2,--输入变量：用户ID
    pageindex     IN            INT,
    pagesizes     IN            INT,
    currenttype   IN            VARCHAR2,--完成节点类型（所有未完成，超期未完成，所有已完成）
    searchcondition IN          VARCHAR2,
    items         OUT           SYS_REFCURSOR,
    total         OUT           INT
) IS
--我负责的任务  关键节点计划、项目主项计划、专项计划
--作者：陈丽
--日期：2019/11/15

    v_sql_start          CLOB;
    v_sql_end           CLOB;
    v_sql_content        CLOB;
    v_sql               CLOB;
    v_sql_exec          CLOB;
    v_sql_exec_paging   CLOB;
    v_where              CLOB;
    testmsg             CLOB;
    v_where_like       CLOB;
BEGIN
    total := 1000;
    v_sql_start := ' case ';
    v_sql_content := '';
    v_sql_end := '  else '''' end  ';
    BEGIN

--1.拼接查询语句
        FOR item IN (
            SELECT
                s.expression,
                vv.node_level,
                vv.plan_type
            FROM
                pom_rule_set s
                LEFT JOIN (
                    SELECT
                        MAX(s.created_time) AS t,
                        node_level,
                        plan_type
                    FROM
                        pom_rule_set             s
                        LEFT JOIN pom_rule_set_plan_type   pt ON s.id = pt.rule_id
                    WHERE
                        rule_type = '亮灯规则'
                        --AND plan_type != '关键节点计划'
                        AND s.is_disable = 0
                    GROUP BY
                        node_level,
                        plan_type
                ) vv ON s.created_time = vv.t
                        AND s.node_level = vv.node_level
            WHERE
                vv.t IS NOT NULL
        ) LOOP 
    ---拼接字符串
         v_sql_content := v_sql_content
                                || '  when plan_type='''
                                ||
            CASE item.plan_type
                WHEN '项目全景计划' THEN
                    '项目主项计划'
                ELSE item.plan_type
            END
                                || ''' and node_level='''
                                || item.node_level
                                || ''' then ('
                                || item.expression
                                || ')';
        END LOOP;

    --dbms_output.put_line('123333');
    --dbms_output.put_line(v_sql_content);
    --规则内容大于0才拼规则语句

        IF length(v_sql_content) > 0 THEN
            v_sql := v_sql_start
                     || v_sql_content
                     || v_sql_end;
        ELSE
    --无规则亮灯显示空
            v_sql := '''''';
        END IF;
-------------------------------------------------------------------------------------------内容

        IF currenttype = '所有未完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is null';
        ELSIF currenttype = '超期未完成任务' THEN
            v_where := ' and sysdate>PLAN_END_DATE  and ACTUAL_END_DATE is null';
        ELSIF currenttype = '所有已完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is not null ';
        ELSE
            v_where := '';
        END IF;

        --当输入条件部位空时
        IF searchcondition is not null THEN
          v_where_like := 'WHERE (instr(n.NODE_NAME,'''||searchcondition||''')>0 OR instr(n.PLAN_NAME,'''||searchcondition||''')>0 
              OR instr(n.PROJ_NAME,'''||searchcondition||''')>0 OR instr(n.DUTY_DEPARTMENT,'''||searchcondition||''')>0 
              OR instr(cp.charge_person,'''||searchcondition||''')>0 )'; 
        ELSE
          v_where_like := '';
        END IF;

--3.拼接完整语句

        v_sql_exec := ' select  rownum as rowno,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,         
    PLAN_TYPE,       
    DUTY_DEPARTMENT,         
    NODE_LEVEL,  
		CHARGE_PERSON,
    STANDARD_SCORE ,WACTH,HASTEN,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,''关注'' as WACTH,''催办'' as HASTEN from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    n.ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    n.NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门
		person.CHARGE_PERSON,
    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n 
		LEFT JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
		LEFT JOIN POM_NODE_CHARGE_PERSON person ON n.ID=person.NODE_ID	
		WHERE (p.PLAN_TYPE=''项目主项计划'' OR p.PLAN_TYPE=''关键节点计划'') AND n.IS_DISABLE=0  and APPROVAL_STATUS=''已审核'' 
		AND CHARGE_PERSON_ID='''||userid||'''  '
                      || v_where
                      || '
UNION ALL
SELECT
    n.ID   AS id,
     p.id as ORIGINAL_PLAN_ID,
    n.ID   AS ORIGINAL_NODE_ID,
    PLAN_ID,
    2 AS PLAN_TYPE_INT,

    n.NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    PREDICT_END_DATE,
    ''所属项目'' AS E,
    ''专项计划'' AS F,
    DUTY_DEPARTMENT,
		person.CHARGE_PERSON,
    ''专项计划级'' AS M,
    0 AS N
FROM
    POM_SPECIAL_PLAN_NODE n 
		LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID 
		LEFT JOIN POM_NODE_CHARGE_PERSON person ON n.ID=person.NODE_ID
		where n.IS_DELETE=0 AND APPROVAL_STATUS=''已审核'' 
		AND CHARGE_PERSON_ID='''||userid||'''  '
                      || v_where
                      || '
UNION ALL
    SELECT    n.id,
    p.ORIGINAL_PLAN_ID,
    n.original_node_id,
    dept_monthly_plan_id,
    10 as  PLAN_TYPE_INT,

    n.node_name,
    p.PLAN_NAME,
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    ''无'' as PROJ_NAME,          --所属项目
    ''部门月度计划'' as  PLAN_TYPE,        --计划类型显示名
    p.DEPT_NAME,          --主责部门
		person.CHARGE_PERSON,
    node_Type,           --任务等级
    stand_SCORE          --标准分值
FROM
    pom_dept_monthly_plan_node n
    left join pom_dept_monthly_plan p on n.dept_monthly_plan_id=p.id
		LEFT JOIN POM_NODE_CHARGE_PERSON person ON n.ID=person.NODE_ID
    where node_source is null AND n.IS_DEL=0 and APPROVE_STATUS=''已审核''
		AND CHARGE_PERSON_ID='''||userid||'''  '
                      || v_where
                      || ')n '||v_where_like||'
   ORDER BY n.PLAN_END_DATE  ) a  ';-- left join POM_NODE_CHARGE_PERSON cp on n.id=cp.NODE_ID where CHARGE_PERSON_ID='''||userid||'''  
-------------------------------------------------------------------------------------------内容

       -- dbms_output.put_line(v_sql_exec);
        v_sql_exec_paging := '
select a.* from ( '
                             || v_sql_exec
                             || ' where rownum <= '
                             || pageindex * pagesizes
                             || ' ) a where a.rowno >= '
                             || pagesizes * ( pageindex - 1 )
                             || '';
----获取总条数

        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
                          || v_sql_exec
                          || ') a '
        INTO total;
        dbms_output.put_line(v_sql_exec_paging);
-- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN items FOR v_sql_exec_paging;
--SELECT '' A FROM DUAL;

    EXCEPTION
        WHEN OTHERS THEN
            OPEN items FOR SELECT
                               '失败咯' || testmsg plan_name
                           FROM
                               dual;

            dbms_output.put_line(sqlerrm);
    END;

END p_pom_smart_my_current_person;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_MY_CURRENT_PROJ
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_SMART_MY_CURRENT_PROJ" (
    projid        IN            VARCHAR2,--输入变量：项目
    userid        IN 			VARCHAR2,--用户id，用于过滤关注的任务
    currentcompanyid     IN            VARCHAR2,--当前用户公司
    currentdeptid        IN            VARCHAR2,--当前用户部门
    currentstationid     IN            VARCHAR2,---当前用户的岗位
    bizcode       IN            VARCHAR2,---权限code
    pageindex     IN            INT,
    pagesizes     IN            INT,
    currenttype   IN            VARCHAR2,--完成节点类型(本月任务,超期未完成任务,所有未完成任务,所有已完成任务,所有任务,次月任务,本季度任务,本年任务)
    searchcondition IN          VARCHAR2,--模糊查询条件
    items         OUT           SYS_REFCURSOR,
    total         OUT           INT
) IS
--本部门负责的任务
--作者：陈丽
--日期：2019/11/15

    v_sql_start          CLOB;
    v_sql_end            CLOB;
    v_sql_content        CLOB;
    v_sql               CLOB;
    v_sql_exec          CLOB;
    v_sql_exec_paging   CLOB;
    v_where              CLOB;
    v_spid              CLOB;
    testmsg              CLOB;
    v_where_like       CLOB;
BEGIN
----------------------------------------------------统一解析
    testmsg := 'projid:'
               || projid
               || '；pageindex:'
               || pageindex
               || '；pagesizes:'
               || pagesizes
               || '；currenttype:'
               || currenttype;

    BEGIN
        total := 1000;
        v_sql_start := ' case ';
        v_sql_content := '';
        v_sql_end := '  else '''' end  ';

--调用数据权限验证存储过程
 P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
--1.拼接查询语句
        FOR item IN (
            SELECT
                s.expression,
                vv.node_level,
                vv.plan_type
            FROM
                pom_rule_set s
                LEFT JOIN (
                    SELECT
                        MAX(s.created_time) AS t,
                        node_level,
                        plan_type
                    FROM
                        pom_rule_set             s
                        LEFT JOIN pom_rule_set_plan_type   pt ON s.id = pt.rule_id
                    WHERE
                        rule_type = '亮灯规则'
                       -- AND plan_type != '关键节点计划'
                        AND s.is_disable = 0
                    GROUP BY
                        node_level,
                        plan_type
                ) vv ON s.created_time = vv.t
                        AND s.node_level = vv.node_level
            WHERE
                vv.t IS NOT NULL
        ) LOOP
    ---拼接字符串
         v_sql_content := v_sql_content
                                || '  when plan_type='''
                                ||
            CASE item.plan_type
                WHEN '项目全景计划' THEN
                    '项目主项计划'
                ELSE item.plan_type
            END
                                || ''' and node_level='''
                                || item.node_level
                                || ''' then ('
                                || item.expression
                                || ')';
        END LOOP;

    --dbms_output.put_line('123333');
    --dbms_output.put_line(v_sql_content);
    --规则内容大于0才拼规则语句

        IF length(v_sql_content) > 0 THEN
            v_sql := v_sql_start
                     || v_sql_content
                     || v_sql_end;
        ELSE
    --无规则亮灯显示空
            v_sql := '''''';
        END IF;

-------------------------------------------------------------------------------------------内容


       IF currenttype = '本月任务' THEN
            v_where := ' and ACTUAL_END_DATE is null and (PLAN_END_DATE>=trunc(sysdate, ''month'') and PLAN_END_DATE<=trunc(last_day(sysdate))) ';
        ELSIF currenttype = '超期未完成任务' THEN
            v_where := ' and sysdate>PLAN_END_DATE and ACTUAL_END_DATE is null';
        ELSIF currenttype = '所有未完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is null ';
        ELSIF currenttype = '所有已完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is not null ';
        ELSIF currenttype = '所有任务' THEN
            v_where := ' ';
        ELSIF currenttype = '次月任务' THEN
            v_where := ' and (PLAN_END_DATE>last_day(trunc(sysdate))+1 and PLAN_END_DATE<last_day(last_day(trunc(sysdate))+1))';
        ELSIF currenttype = '本季度任务' THEN
            v_where := ' and (PLAN_END_DATE>trunc(sysdate, ''Q'') and PLAN_END_DATE<add_months(trunc(sysdate, ''Q''), 3) - 1) ';
        ELSIF currenttype = '本年任务' THEN
            v_where := ' and (PLAN_END_DATE>trunc(sysdate, ''yyyy'') and PLAN_END_DATE<add_months(trunc(sysdate, ''yyyy''), 12) - 1)  ';
        ELSE
            v_where := ' and 1=2';
        END IF;

        --当输入条件部位空时
        IF searchcondition is not null THEN
          v_where_like := 'WHERE (instr(n.NODE_NAME,'''||searchcondition||''')>0 OR instr(n.PLAN_NAME,'''||searchcondition||''')>0
              OR instr(n.PROJ_NAME,'''||searchcondition||''')>0 OR instr(n.DUTY_DEPARTMENT,'''||searchcondition||''')>0
              OR instr(cp.charge_person,'''||searchcondition||''')>0 )';
        ELSE
          v_where_like := '';
        END IF;

--3.拼接完整语句
if projid <> '111' then
        v_sql_exec := ' select  rownum as rowno,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
		CHARGE_PERSON,
    NODE_LEVEL,
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,w_Url,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,charge_person,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE is null then ''催办''
else null end as HASTEN
,case when w.IS_UN_WATCH=0 then ''/api/pom/planfollow/unfollow?cancelType=0&windowWidth=724&windowHeight=300&bizId=''||ORIGINAL_NODE_ID else ''/pom/biz-watch/bizwatch-setting?cancelType=0&windowWidth=724&windowHeight=300&bizId=&bizId=''||ORIGINAL_NODE_ID end as w_Url

                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    n.ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门
    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n
		LEFT JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
        left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id
        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
        on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
        WHERE tal.orgid is not null AND (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and APPROVAL_STATUS=''已审核''
		AND n.IS_DISABLE=0
		AND (p.PROJ_ID='''||projid||''' OR p.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID='''||projid||'''))  '||v_where||'
)n
    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID
    left join (SELECT node_id,
    LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
    FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID '||v_where_like||' ORDER BY n.PLAN_END_DATE) a ';
else
    v_sql_exec := ' select  rownum as rowno,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
		CHARGE_PERSON,
    NODE_LEVEL,
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,w_Url,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,charge_person,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE is null then ''催办''
else null end as HASTEN
,case when w.IS_UN_WATCH=0 then ''/api/pom/planfollow/unfollow?cancelType=0&windowWidth=724&windowHeight=300&bizId=''||ORIGINAL_NODE_ID else ''/pom/biz-watch/bizwatch-setting?cancelType=0&windowWidth=724&windowHeight=300&bizId=&bizId=''||ORIGINAL_NODE_ID end as w_Url

                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    n.ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门
    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n
		LEFT JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
		left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id
        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
        on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
        WHERE tal.orgid is not null AND (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and APPROVAL_STATUS=''已审核''
		AND n.IS_DISABLE=0
		  '||v_where||'
)n
    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID
    left join (SELECT node_id,
    LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
    FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID '||v_where_like||' ORDER BY n.PLAN_END_DATE) a ';
end if;
-------------------------------------------------------------------------------------------内容

        v_sql_exec_paging := '
select a.* from ( '
                             || v_sql_exec
                             || ' where rownum <= '
                             || pageindex * pagesizes
                             || ' ) a where a.rowno >= '
                             || pagesizes * ( pageindex - 1 )
                             || '';

        dbms_output.put_line(v_sql_exec_paging);
----获取总条数
        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
                          || v_sql_exec
                          || ') a '
        INTO total;

-- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN items FOR v_sql_exec_paging;
--SELECT '' A FROM DUAL;

    EXCEPTION
        WHEN OTHERS THEN
        testmsg:=sqlerrm||testmsg;
            OPEN items FOR SELECT
                               '失败咯' || testmsg plan_name
                           FROM
                               dual;

            dbms_output.put_line(sqlerrm);
    END;

END p_pom_smart_my_current_proj;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_PROJ_PLAN_DEL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_SMART_PROJ_PLAN_DEL" (
    planid    IN        VARCHAR2,--输入变量：规则id
    type      IN        VARCHAR2,--0删除前验证，1执行删除,2调整验证
    errmsg    OUT       VARCHAR2,--提示消息
    errcode   OUT       INT--0成功，1失败
) IS
--规则删除
--作者：鲜晓勇 
--日期：2019/11/27
    countdtl   INT;
    testmsg    NVARCHAR2(200);
    errorCount INT;
     hiddleCount INT;
BEGIN
    BEGIN
                 errorCount := 0;
        testmsg := 'planid:'
                   || planid
                   || '.type:'
                   || type;
        countdtl := 0;
        IF length(planid) < 36 THEN
            raise_application_error(-20000, '请选择要删除的计划');
        END IF;
--循环计划id
-------------------------------------------------------
-------------------------------------------------------
        IF ( type = 1 ) THEN
            FOR item IN (
                SELECT
                    regexp_substr(''
                                  || planid
                                  || '', '[^,]+', 1, ROWNUM) AS id
                FROM
                    dual
                CONNECT BY
                    ROWNUM <= length(''
                                     || planid
                                     || '') - length(regexp_replace(''
                                                                    || planid
                                                                    || '', ',', '')) + 1
            ) LOOP 
    ---删除计划
                DELETE pom_proj_plan 
                WHERE
                    id = ''
                         || item.id
                         || '';

                countdtl := countdtl + 1;
            END LOOP;
            errcode := 0;
            errmsg := '删除成功！'
                      || countdtl
                      || '条计划';
        ELSIF ( type = 0 ) THEN
               FOR item IN (
                SELECT
                    regexp_substr(''
                                  || planid
                                  || '', '[^,]+', 1, ROWNUM) AS id
                FROM
                    dual
                CONNECT BY
                    ROWNUM <= length(''
                                     || planid
                                     || '') - length(regexp_replace(''
                                                                    || planid
                                                                    || '', ',', '')) + 1
            ) LOOP          
        SELECT
            COUNT(id)
        INTO hiddleCount
        FROM
            pom_proj_Plan
        WHERE
            id = ''
                        || item.id
                        || '' and (APPROVAL_STATUS='已审核' or APPROVAL_STATUS='审核中');
               errorCount:=errorCount+hiddleCount;
            END LOOP; 
              IF errorCount > 0 THEN
              errcode := 1;
            errmsg := '该计划已发起审批，请将审批流程作废再删除！';
            ELSE
            errcode := 0;
            errmsg := '';
            END IF;

        ELSIF ( type = 2 ) THEN
        IF length(planid)>36 THEN
        errcode:=1;
        errmsg:='一次只允许调整一条计划';
        ELSE 
         SELECT COUNT(id) INTO hiddleCount FROM POM_PROJ_PLAN WHERE APPROVAL_STATUS <>'已审核' AND ID=''|| planid;
         IF hiddleCount>0 THEN
          errcode:=1;
          errmsg:='该计划还未审批,请将计划审批完成后再调整！';
          ELSE
          errcode:=0;
          errmsg:='';
          END IF;
        END IF;

    END IF;

    EXCEPTION
        WHEN OTHERS THEN
            errcode := 1;
            errmsg := sqlerrm;
    END;
END p_pom_smart_proj_plan_del;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_PROJECT_PLAN_DEL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_SMART_PROJECT_PLAN_DEL" 
(
		PLANID  IN VARCHAR2
	 , --输入变量：规则id
		TYPE    IN VARCHAR2
	 , --0删除前验证，1执行删除
		ERRMSG  OUT VARCHAR2
	 , --提示消息
		ERRCODE OUT INT --0成功，1失败
) IS
		--规则删除
		--作者：鲜晓勇
		--日期：2019/11/27
		COUNTDTL    INT;
		TESTMSG     NVARCHAR2(200);
		ERRORCOUNT  INT;
		HIDDLECOUNT INT;
BEGIN
		BEGIN
				ERRORCOUNT := 0;
				TESTMSG    := 'planid:' || PLANID || '.type:' || TYPE;
				COUNTDTL   := 0;
				IF LENGTH(PLANID) < 36 THEN
						RAISE_APPLICATION_ERROR(-20000, '请选择要删除的计划' || TESTMSG);
				END IF;
				--循环规则id
				-------------------------------------------------------
				-------------------------------------------------------
				IF (TYPE = 1) THEN
						FOR ITEM IN (SELECT REGEXP_SUBSTR('' || PLANID || '', '[^,]+', 1,
																							 ROWNUM) AS ID
												 FROM   DUAL
												 CONNECT BY ROWNUM <=
																		LENGTH('' || PLANID || '') -
																		LENGTH(REGEXP_REPLACE('' || PLANID || '',
																													',', '')) + 1)
						LOOP
								---删除计划
								DELETE POM_PROJ_PLAN WHERE ID = '' || ITEM.ID || '';
						
								COUNTDTL := COUNTDTL + 1;
						END LOOP;
						ERRCODE := 0;
						ERRMSG  := '删除成功！' || COUNTDTL || '条计划';
				ELSIF (TYPE = 0) THEN
						FOR ITEM IN (SELECT REGEXP_SUBSTR('' || PLANID || '', '[^,]+', 1,
																							 ROWNUM) AS ID
												 FROM   DUAL
												 CONNECT BY ROWNUM <=
																		LENGTH('' || PLANID || '') -
																		LENGTH(REGEXP_REPLACE('' || PLANID || '',
																													',', '')) + 1)
						LOOP
								SELECT COUNT(ID)
								INTO   HIDDLECOUNT
								FROM   POM_PROJ_PLAN
								WHERE  ID = '' || ITEM.ID || '' AND
											 APPROVAL_STATUS = '已审核';
								ERRORCOUNT := ERRORCOUNT + HIDDLECOUNT;
						END LOOP;
						IF ERRORCOUNT > 0 THEN
								ERRCODE := 1;
								ERRMSG  := '存在已审核的计划！';
						ELSE
								ERRCODE := 0;
								ERRMSG  := '验证通过！';
						END IF;
				END IF;
		
		EXCEPTION
				WHEN OTHERS THEN
						ERRCODE := 1;
						ERRMSG  := SQLERRM;
		END;
END P_POM_SMART_PROJECT_PLAN_DEL;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_RULE_SET_DEL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_SMART_RULE_SET_DEL" 
(
		RULEID  IN VARCHAR2
	 , --输入变量：规则id
		TYPE    IN VARCHAR2
	 , --0删除前验证，1执行删除
		ERRMSG  OUT VARCHAR2
	 , --提示消息
		ERRCODE OUT INT --0成功，1失败
) IS
		--规则删除
		--作者：陈丽
		--日期：2019/11/17
		COUNTDTL INT;
		TESTMSG  NVARCHAR2(4000);
BEGIN
		BEGIN
				TESTMSG  := 'ruleid:' || RULEID || '.type:' || TYPE;
				COUNTDTL := 0;
				IF LENGTH(RULEID) < 36 THEN
						RAISE_APPLICATION_ERROR(-20000, '请选择要删除的规则' || TESTMSG);
				END IF;
				--循环规则id
		
				IF (TYPE = 1) THEN
						FOR ITEM IN (SELECT REGEXP_SUBSTR('' || RULEID || '', '[^,]+', 1,
																							 ROWNUM) AS ID
												 FROM   DUAL
												 CONNECT BY ROWNUM <=
																		LENGTH('' || RULEID || '') -
																		LENGTH(REGEXP_REPLACE('' || RULEID || '',
																													',', '')) + 1)
						LOOP
								---删除规则
								DELETE POM_RULE_SET WHERE ID = '' || ITEM.ID || '';
						
								COUNTDTL := COUNTDTL + 1;
						END LOOP;
				
						ERRCODE := 0;
						ERRMSG  := '删除成功！' || COUNTDTL || '条规则';
				ELSIF (TYPE = 0) THEN
						ERRCODE := 0;
						ERRMSG  := '验证通过！';
				END IF;
		
		EXCEPTION
				WHEN OTHERS THEN
						ERRCODE := 1;
						ERRMSG  := SQLERRM;
		END;
END P_POM_SMART_RULE_SET_DEL;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_RULE_SET_STATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_SMART_RULE_SET_STATE" (
    ruleid      IN          VARCHAR2,--输入变量：规则id
    statetype   IN          INT,--0生效，1失效
    errmsg      OUT         VARCHAR2,--提示消息
    errcode     OUT         INT--0成功，1失败
) IS
--规则生效失效设置
--作者：陈丽
--日期：2019/11/17
    typemsg    VARCHAR2(50);
    ruleids    VARCHAR2(4000);
    countdtl   INT;
     testmsg NVARCHAR2(4000);
		 statuscount NUMBER;
BEGIN
    BEGIN
        testmsg:='ruleid:'||ruleid||'.statetype:'||statetype;
        countdtl := 0;
        IF statetype = 0 THEN
            typemsg := '生效';
        ELSE
            typemsg := '失效';
        END IF;

        IF length(ruleid) < 36 THEN
            raise_application_error(-20000, '请选择要'
                                            || typemsg
                                            || '的规则'||testmsg);
        END IF;



--循环规则id

        FOR item IN (
            SELECT
                regexp_substr(''
                              || ruleid
                              || '', '[^,]+', 1, ROWNUM) AS id
            FROM
                dual
            CONNECT BY
                ROWNUM <= length(''
                                 || ruleid
                                 || '') - length(regexp_replace(''
                                                                || ruleid
                                                                || '', ',', '')) + 1
        ) LOOP 
    ---拼接字符串
		  ruleids := ruleids || item.id;
			SELECT COUNT(is_disable) INTO statuscount  FROM pom_rule_set WHERE ID='' || item.id || '' AND is_disable=statetype ;
			IF(statuscount>0) THEN
				errcode := 1;
				errmsg := '已有'''||typemsg||'''的规则，请选择相同状态的数据进行操作';
				return;
			ELSE 
					UPDATE pom_rule_set 
					SET is_disable = statetype 
					WHERE
						id = '' || item.id || '';
					countdtl := countdtl + 1;
			END IF;


--             UPDATE pom_rule_set
--             SET
--                 is_disable = statetype
--             WHERE
--                 id = ''
--                      || item.id
--                      || '';
-- 
--             countdtl := countdtl + 1;
        END LOOP;

        errcode := 0;
        errmsg := typemsg
                  || '设置成功！'
                  || countdtl
                  || '条规则';
    EXCEPTION
        WHEN OTHERS THEN
            errcode := 1;
            errmsg := sqlerrm;
    END;
END p_pom_smart_rule_set_state;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_SPECIAL_PLAN_DEL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_SMART_SPECIAL_PLAN_DEL" (
    planid    IN        VARCHAR2,--输入变量：规则id
    type      IN        VARCHAR2,--0删除前验证，1执行删除,2 调整验证
    errmsg    OUT       VARCHAR2,--提示消息
    errcode   OUT       INT--0成功，1失败
) IS
--规则删除
--作者：鲜晓勇 
--日期：2019/11/27
    countdtl   INT;
    testmsg    NVARCHAR2(200);
    errorCount INT;
     hiddleCount INT;
BEGIN
    BEGIN
                 errorCount := 0;
        testmsg := 'planid:'
                   || planid
                   || '.type:'
                   || type;
        countdtl := 0;
        IF length(planid) < 36 THEN
            raise_application_error(-20000, '请选择要删除的计划');
        END IF;
--循环计划id
-------------------------------------------------------
-------------------------------------------------------
        IF ( type = 1 ) THEN
            FOR item IN (
                SELECT
                    regexp_substr(''
                                  || planid
                                  || '', '[^,]+', 1, ROWNUM) AS id
                FROM
                    dual
                CONNECT BY
                    ROWNUM <= length(''
                                     || planid
                                     || '') - length(regexp_replace(''
                                                                    || planid
                                                                    || '', ',', '')) + 1
            ) LOOP 
    ---删除计划
                DELETE POM_SPECIAL_PLAN 
                WHERE
                    id = ''
                         || item.id
                         || '';

                countdtl := countdtl + 1;
            END LOOP;
            errcode := 0;
            errmsg := '删除成功！'
                      || countdtl
                      || '条计划';
        ELSIF ( type = 0 ) THEN
               FOR item IN (
                SELECT
                    regexp_substr(''
                                  || planid
                                  || '', '[^,]+', 1, ROWNUM) AS id
                FROM
                    dual
                CONNECT BY
                    ROWNUM <= length(''
                                     || planid
                                     || '') - length(regexp_replace(''
                                                                    || planid
                                                                    || '', ',', '')) + 1
            ) LOOP          
        SELECT
            COUNT(id)
        INTO hiddleCount
        FROM
            POM_SPECIAL_PLAN
        WHERE
            id = ''
                        || item.id
                        || '' and (APPROVAL_STATUS='已审核' or APPROVAL_STATUS='审核中');
               errorCount:=errorCount+hiddleCount;
            END LOOP; 
              IF errorCount > 0 THEN
              errcode := 1;
            errmsg := '该计划已发起审批,请将审批流程作废再删除！';
            ELSE
            errcode := 0;
            errmsg := '';
            END IF;
        ELSIF ( type = 2 ) THEN
        IF length(planid)>36 THEN
        errcode:=1;
        errmsg:='一次只允许调整一条计划';
        ELSE 
         SELECT COUNT(id) INTO hiddleCount FROM POM_SPECIAL_PLAN WHERE APPROVAL_STATUS<>'已审核' AND ID=''|| planid;
         IF hiddleCount>0 THEN
          errcode:=1;
          errmsg:='该计划还未审批,请将计划审批完成再调整！';
          ELSE
          errcode:=0;
          errmsg:='';
          END IF;
        END IF;
        END IF;

    EXCEPTION
        WHEN OTHERS THEN
            errcode := 1;
            errmsg := sqlerrm;
    END;
END p_pom_smart_special_plan_del;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_SPECIALTEMP_DEL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_SMART_SPECIALTEMP_DEL" ( templateid IN VARCHAR2, --输入变量：专项计划模板ID
		type IN VARCHAR2, 
		errmsg OUT VARCHAR2, --提示消息
		errcode OUT INT --0成功，1失败
	) IS --专项计划模板删除
--作者：叶丁荣
--日期：2019/11/21
	hiddleCount INT;
BEGIN
	BEGIN
		IF
			length( templateid ) < 36 THEN
				raise_application_error ( - 20000, '请选择要删除的模板' );

		END IF;
		IF
			( type = 1 ) THEN
-- 				DELETE POM_SPECIAL_TEMPLATE 
-- 			WHERE
-- 				id = ''||templateid||'';
-- 			errcode := 0;
-- 			errmsg := '删除成功！';
-- 			


				SELECT
				COUNT( ID ) INTO hiddleCount 
			FROM
				POM_SPECIAL_TEMPLATE 
			WHERE
				ID = ''||templateid||'' 
				AND TEMPLATE_STATUS = '正式';
			IF
				( hiddleCount > 0 ) THEN
					errcode := 1;
				errmsg := '已发布的计划模板不允许删除！';
				ELSE errcode := 0;
				errmsg := '';

			END IF;
			ELSE
							DELETE POM_SPECIAL_TEMPLATE 
			WHERE
				id = ''||templateid||'';
			errcode := 0;
			errmsg := '删除成功！';


		END IF;
		EXCEPTION 
			WHEN OTHERS THEN
			errcode := 1;
		errmsg := sqlerrm;

	END;

END p_pom_smart_specialtemp_del;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_STANDARD_NODE_DEL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_SMART_STANDARD_NODE_DEL" ( nodeid IN VARCHAR2, --输入变量：任务项ID
		type IN VARCHAR2,--操作类型   0：
		errmsg OUT VARCHAR2, --提示消息
		errcode OUT INT --0成功，1失败
	) IS --标准节点库批量删除
--作者：叶丁荣
--日期：2019/11/21
    countdtl NUMBER;
		templatenodecount NUMBER;
BEGIN


 BEGIN
        countdtl := 0;
        IF length(nodeid) < 36 THEN
            raise_application_error(-20000, '请选择要删除的任务项');
        END IF;

		IF (type=1) THEN
				--循环规则id

        FOR item IN (
            SELECT
                regexp_substr(''
                              || nodeid
                              || '', '[^,]+', 1, ROWNUM) AS id
            FROM
                dual
            CONNECT BY
                ROWNUM <= length(''
                                 || nodeid
                                 || '') - length(regexp_replace(''
                                                                || nodeid
                                                                || '', ',', '')) + 1
        ) LOOP 
    ---删除任务项
            DELETE POM_STANDARD_NODE
            WHERE
                id = ''
                     || item.id
                     || '';

            countdtl := countdtl + 1;
        END LOOP;

        errcode := 0;
        errmsg := '删除成功！'
                  || countdtl
                  || '条任务项';

		ELSE
			--循环规则id

        FOR item IN (
            SELECT
                regexp_substr(''
                              || nodeid
                              || '', '[^,]+', 1, ROWNUM) AS id
            FROM
                dual
            CONNECT BY
                ROWNUM <= length(''
                                 || nodeid
                                 || '') - length(regexp_replace(''
                                                                || nodeid
                                                                || '', ',', '')) + 1
        ) LOOP 
    ---删除验证
          SELECT COUNT(ID) INTO templatenodecount FROM POM_TEMPLATE_NODE WHERE STANDARD_NODE_ID=''||item.id||'';
					IF (templatenodecount>0) THEN
						 errcode := 1;
							errmsg := '已经被模板引用的节点不允许删除';
					ELSE 
					 errcode := 0;
						errmsg := '';

					END IF;

        END LOOP;

		END IF;

    EXCEPTION
        WHEN OTHERS THEN
            errcode := 1;
            errmsg :=  '删除节点失败！';
    END;





END p_pom_smart_standard_node_del;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_SMART_TASKCENTER_TBS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_SMART_TASKCENTER_TBS" (
        orgtype IN VARCHAR2, --查询类型，用于判断过滤 0,公司|1,部门|2,项目|3,,本人
		condition IN VARCHAR2, --输入变量：公司id | 部门id | 项目id | 当前用户ID
        currentuserid        IN 			VARCHAR2,--用户id，用于过滤关注的任务
        currentcompanyid     IN            VARCHAR2,--当前用户公司
        currentdeptid        IN            VARCHAR2,--当前用户部门
        currentstationid     IN            VARCHAR2,---当前用户的岗位
        bizcode       IN            VARCHAR2,---权限code
        item OUT SYS_REFCURSOR ) IS --任务中心tabs任务条数统计数据源
--作者：yedr
--日期：2019/12/25

    v_spid              VARCHAR2(200);
	BEGIN--========================================================本公司负责的任务
--调用数据权限验证存储过程
 P_SYS_AUTH_DATA_RULE_SPID(
            USERID => currentuserid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
	IF
		( orgtype = 0 ) THEN
		IF  condition <> '111' THEN
			OPEN item FOR SELECT--本月任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NULL
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					AND node.COMPANY_ID = '' || condition || ''
                    AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NULL
					AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
					AND plan.APPROVAL_STATUS = '已审核'
					AND	node.IS_DELETE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND (node.IS_DEL=0 OR node.IS_DEL=null)
					AND node.ACTUAL_END_DATE IS NULL
					AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
					AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS ACOUNT,
--超期未完成任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND SYSDATE > node.PLAN_END_DATE
					AND node.ACTUAL_END_DATE IS NULL
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND SYSDATE > node.PLAN_END_DATE
					AND node.ACTUAL_END_DATE IS NULL
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					AND node.COMPANY_ID = '' || condition || ''
					) +(
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND SYSDATE > node.PLAN_END_DATE
					AND node.ACTUAL_END_DATE IS NULL
					AND (node.IS_DEL=0 OR node.IS_DEL=null)
					AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS BCOUNT,
--所有未完成任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NULL
                    AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NULL
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND node.IS_DEL=0
					AND ACTUAL_END_DATE IS NULL
					AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS CCOUNT,
--所有已完成任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NOT NULL
                    AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND ACTUAL_END_DATE IS NOT NULL
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND ACTUAL_END_DATE IS NOT NULL
					AND node.IS_DEL=0
					AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS DCOUNT,
--所有任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND node.IS_DEL=0
					AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS ECOUNT,
--次月任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
					)
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
					)
					AND node.IS_DELETE=0
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND node.IS_DEL=0
					AND APPROVE_STATUS = '已审核'
					AND ( PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1 AND PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 ) )
					AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS FCOUNT,
--本季度任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					)
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					)
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND ( PLAN_END_DATE > trunc( SYSDATE, 'Q' ) AND PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1 )
					AND node.IS_DEL=0
					AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS GCOUNT,
--本年任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.proj_plan_id = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					)
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					)
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					AND node.COMPANY_ID = 'condition'
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND ( PLAN_END_DATE > trunc( SYSDATE, 'yyyy' ) AND PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1 )
					AND node.IS_DEL=0
					AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS HCOUNT
		FROM
			dual;
		ELSE
				OPEN item FOR SELECT--本月任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NULL
					AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NULL
					AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
					AND plan.APPROVAL_STATUS = '已审核'
					AND	node.IS_DELETE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND (node.IS_DEL=0 OR node.IS_DEL=null)
					AND node.ACTUAL_END_DATE IS NULL
					AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
				)
			) AS ACOUNT,
--超期未完成任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND SYSDATE > node.PLAN_END_DATE
					AND node.ACTUAL_END_DATE IS NULL
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND SYSDATE > node.PLAN_END_DATE
					AND node.ACTUAL_END_DATE IS NULL
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					) +(
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND SYSDATE > node.PLAN_END_DATE
					AND node.ACTUAL_END_DATE IS NULL
					AND (node.IS_DEL=0 OR node.IS_DEL=null)
				)
			) AS BCOUNT,
--所有未完成任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NULL
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NULL
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND node.IS_DEL=0
					AND ACTUAL_END_DATE IS NULL
					--AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS CCOUNT,
--所有已完成任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NOT NULL
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND ACTUAL_END_DATE IS NOT NULL
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND ACTUAL_END_DATE IS NOT NULL
					AND node.IS_DEL=0
				)
			) AS DCOUNT,
--所有任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND node.IS_DEL=0
				)
			) AS ECOUNT,
--次月任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
					)
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
					)
					AND node.IS_DELETE=0
					AND plan.APPROVAL_STATUS = '已审核'
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND node.IS_DEL=0
					AND APPROVE_STATUS = '已审核'
					AND ( PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1 AND PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 ) )
				)
			) AS FCOUNT,
--本季度任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND(
						node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					)
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					)
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND ( PLAN_END_DATE > trunc( SYSDATE, 'Q' ) AND PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1 )
					AND node.IS_DEL=0
				)
			) AS GCOUNT,
--本年任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.proj_plan_id = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					)
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					)
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND ( PLAN_END_DATE > trunc( SYSDATE, 'yyyy' ) AND PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1 )
					AND node.IS_DEL=0
				)
			) AS HCOUNT
		FROM
			dual;
		END IF;
--========================================================本公司负责的任务END
--========================================================本部门负责的任务
		ELSIF ( orgtype = 1 ) THEN
			IF(condition <> '222') THEN
                OPEN item FOR SELECT--本月任务
			(
				(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						AND node.IS_DELETE=0
						AND plan.APPROVAL_STATUS = '已审核'
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND ACTUAL_END_DATE IS NULL
						AND node.IS_DEL=0
						AND ( PLAN_END_DATE > trunc( SYSDATE, 'month' ) AND PLAN_END_DATE < trunc( last_day( SYSDATE ) ) )
						AND DUTY_DEPT_ID = '' || condition || ''
					)
				) AS ACOUNT,
--超期未完成任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND SYSDATE > node.PLAN_END_DATE
						AND node.ACTUAL_END_DATE IS NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND SYSDATE > node.PLAN_END_DATE
						AND node.ACTUAL_END_DATE IS NULL
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND SYSDATE > PLAN_END_DATE
						AND ACTUAL_END_DATE IS NULL
						AND node.IS_DEL=0
						AND DUTY_DEPT_ID = '' || condition || ''
					)
				) AS BCOUNT,
--所有未完成任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND ACTUAL_END_DATE IS NULL
						AND node.IS_DEL=0
						AND DUTY_DEPT_ID = '' || condition || ''
					)
				) AS CCOUNT,
--所有已完成任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NOT NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND ACTUAL_END_DATE IS NOT NULL
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND ACTUAL_END_DATE IS NOT NULL
						AND node.IS_DEL=0
						AND DUTY_DEPT_ID = '' || condition || ''
					)
				) AS DCOUNT,
--所有任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND node.IS_DEL=0
						AND DUTY_DEPT_ID = '' || condition || ''
					)
				) AS ECOUNT,
--次月任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND(
							node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
							AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
							AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
						)
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND ( PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1 AND PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 ) )
						AND node.IS_DEL=0
						AND DUTY_DEPT_ID = '' || condition || ''
					)
				) AS FCOUNT,
--本季度任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
						)
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND node.IS_DEL=0
						AND ( PLAN_END_DATE > trunc( SYSDATE, 'Q' ) AND PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1 )
						AND DUTY_DEPT_ID = '' || condition || ''
					)
				) AS GCOUNT,
--本年任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
						)
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND node.IS_DEL=0
						AND ( PLAN_END_DATE > trunc( SYSDATE, 'yyyy' ) AND PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1 )
						AND DUTY_DEPT_ID = '' || condition || ''
					)
				) AS HCOUNT
			FROM
				dual;
            ELSE
                OPEN item FOR SELECT--本月任务
			(
				(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
						AND node.IS_DELETE=0
						AND plan.APPROVAL_STATUS = '已审核'
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND ACTUAL_END_DATE IS NULL
						AND node.IS_DEL=0
						AND ( PLAN_END_DATE > trunc( SYSDATE, 'month' ) AND PLAN_END_DATE < trunc( last_day( SYSDATE ) ) )
					)
				) AS ACOUNT,
--超期未完成任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND SYSDATE > node.PLAN_END_DATE
						AND node.ACTUAL_END_DATE IS NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND SYSDATE > node.PLAN_END_DATE
						AND node.ACTUAL_END_DATE IS NULL
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND SYSDATE > PLAN_END_DATE
						AND ACTUAL_END_DATE IS NULL
						AND node.IS_DEL=0
					)
				) AS BCOUNT,
--所有未完成任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND ACTUAL_END_DATE IS NULL
						AND node.IS_DEL=0
					)
				) AS CCOUNT,
--所有已完成任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NOT NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND ACTUAL_END_DATE IS NOT NULL
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND ACTUAL_END_DATE IS NOT NULL
						AND node.IS_DEL=0
					)
				) AS DCOUNT,
--所有任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND node.IS_DEL=0
					)
				) AS ECOUNT,
--次月任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
							AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
							AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
						)
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND ( PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1 AND PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 ) )
						AND node.IS_DEL=0
					)
				) AS FCOUNT,
--本季度任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND(
							node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
						)
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND node.IS_DEL=0
						AND ( PLAN_END_DATE > trunc( SYSDATE, 'Q' ) AND PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1 )
					)
				) AS GCOUNT,
--本年任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                         LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
						)
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND node.IS_DEL=0
						AND ( PLAN_END_DATE > trunc( SYSDATE, 'yyyy' ) AND PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1 )
					)
				) AS HCOUNT
			FROM
				dual;
            END IF;
--========================================================本部门负责的任务END
--========================================================本项目负责的任务
			ELSIF ( orgtype = 2 ) THEN
				IF ( condition <> '111') THEN
					OPEN item FOR SELECT--本月任务
				(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND node.ACTUAL_END_DATE IS NULL
						AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND (plan.PROJ_ID=''||condition||'' OR plan.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''||condition||''))
					) AS ACOUNT,
--超期未完成任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND SYSDATE > node.PLAN_END_DATE
						AND node.ACTUAL_END_DATE IS NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND (plan.PROJ_ID=''||condition||'' OR plan.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''||condition||''))
					) AS BCOUNT,
--所有未完成任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND (plan.PROJ_ID=''||condition||'' OR plan.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''||condition||''))
					) AS CCOUNT,
--所有已完成任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NOT NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND (plan.PROJ_ID=''||condition||'' OR plan.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''||condition||''))
					) AS DCOUNT,
--所有任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND (plan.PROJ_ID=''||condition||'' OR plan.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''||condition||''))
					) AS ECOUNT,
--次月任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
							AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND (plan.PROJ_ID=''||condition||'' OR plan.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''||condition||''))
					) AS FCOUNT,
--本季度任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND (plan.PROJ_ID=''||condition||'' OR plan.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''||condition||''))
					) AS GCOUNT,
--本年任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND (plan.PROJ_ID=''||condition||'' OR plan.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''||condition||''))
					) AS HCOUNT
				FROM
					dual;
				ELSE
					OPEN item FOR SELECT--本月任务
				(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND node.ACTUAL_END_DATE IS NULL
						AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
					) AS ACOUNT,
--超期未完成任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND SYSDATE > node.PLAN_END_DATE
						AND node.ACTUAL_END_DATE IS NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
					) AS BCOUNT,
--所有未完成任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
					) AS CCOUNT,
--所有已完成任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NOT NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
					) AS DCOUNT,
--所有任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
					) AS ECOUNT,
--次月任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
							AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
					) AS FCOUNT,
--本季度任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
					) AS GCOUNT,
--本年任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
					) AS HCOUNT
				FROM
					dual;
				END IF;
--========================================================本项目负责的任务END
--========================================================本人负责的任务
				ELSE OPEN item FOR SELECT--所有未完成任务
				(
					(
						SELECT
							COUNT( * )
						FROM
							POM_PROJ_PLAN_NODE node
							LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							node.ACTUAL_END_DATE IS NULL
							AND ( plan.PLAN_TYPE = '项目主项计划' )
							AND plan.APPROVAL_STATUS = '已审核'
							AND node.IS_DISABLE=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
							) + (
						SELECT
							COUNT( * )
						FROM
							POM_SPECIAL_PLAN_NODE node
							LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							node.ACTUAL_END_DATE IS NULL
							AND plan.APPROVAL_STATUS = '已审核'
							AND node.IS_DELETE=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
							) + (
						SELECT
							COUNT( * )
						FROM
							pom_dept_monthly_plan_node node
							LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							node_source IS NULL
							AND ACTUAL_END_DATE IS NULL
							AND APPROVE_STATUS = '已审核'
							AND node.IS_DEL=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
						)
					) AS ACOUNT,
--超期未完成任务
					(
						(
						SELECT
							COUNT( * )
						FROM
							POM_PROJ_PLAN_NODE node
							LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							SYSDATE > node.PLAN_END_DATE
							AND node.ACTUAL_END_DATE IS NULL
							AND ( plan.PLAN_TYPE = '项目主项计划' )
							AND plan.APPROVAL_STATUS = '已审核'
							AND node.IS_DISABLE=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
							) + (
						SELECT
							COUNT( * )
						FROM
							POM_SPECIAL_PLAN_NODE node
							LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							SYSDATE > node.PLAN_END_DATE
							AND node.ACTUAL_END_DATE IS NULL
							AND plan.APPROVAL_STATUS = '已审核'
							AND node.IS_DELETE=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
							) + (
						SELECT
							COUNT( * )
						FROM
							pom_dept_monthly_plan_node node
							LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							node_source IS NULL
							AND SYSDATE > PLAN_END_DATE
							AND ACTUAL_END_DATE IS NULL
							AND APPROVE_STATUS = '已审核'
							AND node.IS_DEL=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
						)
					) AS BCOUNT,
--所有已完成任务
					(
						(
						SELECT
							COUNT( * )
						FROM
							POM_PROJ_PLAN_NODE node
							LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							node.ACTUAL_END_DATE IS NOT NULL
							AND ( plan.PLAN_TYPE = '项目主项计划' )
							AND plan.APPROVAL_STATUS = '已审核'
							AND node.IS_DISABLE=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
							) + (
						SELECT
							COUNT( * )
						FROM
							POM_SPECIAL_PLAN_NODE node
							LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							ACTUAL_END_DATE IS NOT NULL
							AND plan.APPROVAL_STATUS = '已审核'
							AND node.IS_DELETE=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
							) + (
						SELECT
							COUNT( * )
						FROM
							pom_dept_monthly_plan_node node
							LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							node_source IS NULL
							AND ACTUAL_END_DATE IS NOT NULL
							AND APPROVE_STATUS = '已审核'
							AND node.IS_DEL=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
						)
					) AS CCOUNT
				FROM
					dual;
--========================================================本人负责的任务END

			END IF;

END P_POM_SMART_TASKCENTER_TBS;
--============================任务中心数据源=====================================


--============================任务中心数据源=====================================

/
--------------------------------------------------------
--  DDL for Procedure P_POM_TASKLEVELCOMPLETIONRATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_TASKLEVELCOMPLETIONRATE" (
items out SYS_REFCURSOR)
is
--项目主项计划监控任务级别完成率
--作者：叶丁荣
--日期：2020/03/20
begin
open items for select nodes.* from (select node_level as "fullName",round(SUM(
                CASE
                    WHEN node.actual_end_date IS NOT NULL THEN
                        1
                    ELSE
                        0
                END
            ) /(
                CASE
                    WHEN COUNT(node.id) = 0 THEN
                        1
                    ELSE
                        COUNT(node.id)
                END
            ), 4) AS "competationRate" FROM pom_proj_plan_node node left join pom_proj_plan plan on plan.id=node.proj_plan_id
where plan.plan_type='项目主项计划' AND plan.approval_status = '已审核'  GROUP BY node.node_level
) nodes left join sys_bizparam_option param on param.PARAM_VALUE=nodes."fullName" order by param.PARAM_CODE;
end p_pom_tasklevelcompletionrate;
--===================================项目主项计划监控任务级别完成率=========

/
--------------------------------------------------------
--  DDL for Procedure P_POM_URGE_MESSAGE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_URGE_MESSAGE" (
    originalnodeid    varchar2,     --节点原始ID
    USERID IN VARCHAR2,--当前登录人
    plantype          varchar2,     --计划类型 （关键节点计划/项目主项计划/专项计划/部门月度计划）
   
    info     OUT      SYS_REFCURSOR--消息集合
) IS
--催办消息
--作者：谢松宏
--日期：2020/02/18
  m_user         varchar2(3000); -- 催办人名称
  m_nodeid         varchar2(300); -- 节点id
  m_userName         varchar2(2000); -- 被催办人名称
  m_userId varchar2(2000); -- 被催办人id
  m_MOBILE_PHONE varchar2(2000); -- 被催办人电话
  m_nodeName         varchar2(2000); -- 催办节点
BEGIN

 begin

if plantype = '关键节点计划' or plantype = '项目主项计划' then
    dbms_output.put_line('1');
       select NODE_NAME,n.id into m_nodeName,m_nodeid from POM_PROJ_PLAN_NODE n left join 
       POM_Proj_PLAN p on n.PROJ_PLAN_ID=p.id
       where  ORIGINAL_NODE_ID=originalnodeid and p.APPROVAL_STATUS='已审核';
       dbms_output.put_line('2');
  elsif plantype = '专项计划' then
     select NODE_NAME,n.id into m_nodeName,m_nodeid from POM_SPECIAL_PLAN_NODE n left join 
       POM_SPECIAL_PLAN p on n.PLAN_ID=p.id
       where  ORIGINAL_NODE_ID=originalnodeid and p.APPROVAL_STATUS='已审核';
  elsif plantype = '部门月度计划' then
       select NODE_NAME,n.id into m_nodeName,m_nodeid from POM_DEPT_MONTHLY_PLAN_NODE n left join 
       POM_DEPT_MONTHLY_PLAN p on n.DEPT_MONTHLY_PLAN_ID=p.id
       where  ORIGINAL_NODE_ID=originalnodeid and p.APPROVE_STATUS='已审核';
end if;
 select CHARGE_PERSON,CHARGE_PERSON_ID into m_userName,m_userId from POM_NODE_CHARGE_PERSON where node_id=m_nodeid;
 select MOBILE_PHONE into m_MOBILE_PHONE from sys_user where id=m_userId;
 select user_name into m_user from sys_user where id=USERID;
   EXCEPTION
        WHEN OTHERS THEN
--           m_userName:='未知';
--           m_nodeName:='未知';
            dbms_output.put_line(sqlerrm);
    END;
    OPEN info FOR SELECT
                ------------------------------------------------------------基础必须信息
              '71313f018a35f3a558166cba7599b5d6' AS "systemId",--系统id
              'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "appid",--应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段，
            ------------------------------------------------------------业务变动必须信息
              originalnodeid AS "bizKey",--业务id
               'tjSMS' AS "msgChannel",--使用消息渠道 多个，逗号分隔   tjWeChat：铁建微信,tjSMS：铁建短信
            ------------------------------------------------------------短信必须参数
              '400014' AS "smsTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID  --{1}您好，{2}对您负责的任务“{3}”进行了催办，请及时到门户网站查看待办并在《计划管理系统》中反馈任务进度{4}。
              '["'||m_userName||'","'||m_user||'","'||m_nodeName||'",""]' AS "smsParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
              m_MOBILE_PHONE as "mobile",--短信接收人电话
            ------------------------------------------------------------微信必须参数
              '400014' AS "wechatTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID
              '["'||m_userName||'","'||m_user||'","'||m_nodeName||'",""]' AS "wechatParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
               '///' AS "wechatJumplinkUrl",--微信打开地址，程序调用发消息前需要编码
              'v-xufeng' AS "recipientAccount",--接收人usercode如：a-xiexuhua
            ------------------------------------------------------------消息记录方追溯信息
              '催办消息' AS "title",--消息标题
              'v-xufeng' AS "senderAccount",--发送人usercode如：a-xiexuhua
              ''||m_userName||'您好，'||m_user||'对您负责的任务“'||m_nodeName||'”进行了催办' AS "bizSourceCategory",--业务所属类别=》 （由业务系统自定义，方便根据业务回溯，同一类别下有很多个类似业务，如月度计划）
              '催办消息' AS "bizMsgCategory"--消息所属类别=》 （由业务系统自定义，方便根据业务回溯，同一业务主键，有多个分类，如预警消息，提醒消息）
             FROM
                      dual;

END p_pom_urge_message;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_URGE_MSG_INFO
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_URGE_MSG_INFO" (
    originalnodeid  IN   varchar2,     --节点原始ID
    USERID IN         VARCHAR2,--当前登录人
    plantype    IN       varchar2,     --计划类型 （关键节点计划/项目主项计划/专项计划/部门月度计划）
    messageType out      varchar2,     --0:门户终端消息都推送，1：只推送门户，2：只推送短信或微信
    info     OUT      SYS_REFCURSOR--消息集合
) IS
--通用推送集团门户和短信微信消息数据获取存储过程-------催办消息实例
--1、输入参数可根据存储过程注册自定义
--2、输出删除messageType和info必须，info返回结果字段名称和大小写需要严格按照定义返回
--作者：陈丽
--日期：2020/03/03
  m_user         varchar2(3000); -- 催办人名称
  m_urgeuserCode        varchar2(3000); -- 催办人code
  m_planid       varchar2(300); -- 计划id
  m_nodeid       varchar2(300); -- 节点id
  m_userName     varchar2(2000); -- 被催办人名称
  m_userCode       varchar2(2000); -- 被催办人id
  m_MOBILE_PHONE varchar2(2000); -- 被催办人电话
  m_nodeName     varchar2(2000); -- 催办节点
BEGIN
 messageType:=0;
 begin

if plantype = '关键节点计划' or plantype = '项目主项计划' then
    dbms_output.put_line('1');
       select NODE_NAME,n.id,p.id into m_nodeName,m_nodeid,m_planid from POM_PROJ_PLAN_NODE n left join 
       POM_Proj_PLAN p on n.PROJ_PLAN_ID=p.id
       where  ORIGINAL_NODE_ID=originalnodeid and p.APPROVAL_STATUS='已审核';
       dbms_output.put_line('2');
  elsif plantype = '专项计划' then
     select NODE_NAME,n.id,p.id into m_nodeName,m_nodeid,m_planid from POM_SPECIAL_PLAN_NODE n left join 
       POM_SPECIAL_PLAN p on n.PLAN_ID=p.id
       where  ORIGINAL_NODE_ID=originalnodeid and p.APPROVAL_STATUS='已审核';
  elsif plantype = '部门月度计划' then
       select NODE_NAME,n.id,p.id into m_nodeName,m_nodeid,m_planid from POM_DEPT_MONTHLY_PLAN_NODE n left join 
       POM_DEPT_MONTHLY_PLAN p on n.DEPT_MONTHLY_PLAN_ID=p.id
       where  ORIGINAL_NODE_ID=originalnodeid and p.APPROVE_STATUS='已审核';
end if;
 select CHARGE_PERSON,u.user_code,u.MOBILE_PHONE into m_userName,m_userCode,m_MOBILE_PHONE from POM_NODE_CHARGE_PERSON p
 left join  sys_user u on p.CHARGE_PERSON_ID=u.id where node_id=m_nodeid;
 select user_name,user_code into m_user,m_urgeuserCode from sys_user where id=USERID;
   EXCEPTION
        WHEN OTHERS THEN
--           m_userName:='未知';
--           m_nodeName:='未知';
            dbms_output.put_line(sqlerrm);
    END;
    OPEN info FOR SELECT
            ------------------------------------------------------------基础配置数据【必须】（集团门户网站和设备消息都必须配置）------------------------------------------------------------ 
                        m_urgeuserCode AS "senderAccount",--发送人usercode如：a-xiexuhua,---门户网站的creatorName
                        m_userCode AS "recipientAccount",--接收人usercode如：a-xiexuhua--门户网站的ownerName
                        'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "appid",--应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段---门户网站的sourceAppId
                        '71313f018a35f3a558166cba7599b5d6' AS "systemId",--系统id
                        originalnodeid AS "bizKey",--业务id--门户网站的taskId
                        '催办消息' AS "bizMsgCategory",--消息所属类别=》 （由业务系统自定义，方便根据业务回溯，同一业务主键，有多个分类，如预警消息，提醒消息）
            ------------------------------------------------------------设备消息配置开始------------------------------------------------------------ 
            ------------------------------------------------------------【短信微信必须】基础信息
                        'tjSMS,tjWeChat' AS "msgChannel",--使用消息渠道 多个，逗号分隔   tjWeChat：铁建微信,tjSMS：铁建短信
                        ------------【短信必须】参数
                        '400014' AS "smsTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID  --{1}您好，{2}对您负责的任务“{3}”进行了催办，请及时到门户网站查看待办并在《计划管理系统》中反馈任务进度{4}。
                        '["'||m_userName||'","'||m_user||'","'||m_nodeName||'",""]' AS "smsParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
                          m_MOBILE_PHONE as "mobile",--短信接收人电话
                        ------------【微信必须】参数
                        '400014' AS "wechatTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID
                        '["'||m_userName||'","'||m_user||'","'||m_nodeName||'",""]' AS "wechatParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
                        '///' AS "wechatJumplinkUrl",--微信打开地址，程序调用发消息前需要编码
                        ------------消息记录方便追溯信息
                        ''||m_userName||'您好，'||m_user||'对您负责的任务“'||m_nodeName||'”进行了催办' AS "title",--消息标题
                        ''||m_userName||'您好，'||m_user||'对您负责的任务“'||m_nodeName||'”进行了催办' AS "bizSourceCategory",--业务所属类别=》 （由业务系统自定义，方便根据业务回溯，同一类别下有很多个类似业务，如月度计划）
            ------------------------------------------------------------设备消息配置结束------------------------------------------------------------ 
            ------------------------------------------------------------集团门户网站信息------------------------------------------------------------ 
                --taskid	是	String	任务ID---------------------共有门户网站的1、插入待办/2、插入已办taskid，3、插入待阅/4、插入已阅informationid，5、插入我的关注的informationid
                --creatorname	是	String	创建人
                --ownername	是	String	拥有人
                --sourceAppId	是	String	推送应用的appId
              0  "portalMsgType", --集团门户网站消息类型（0：待办,1:已办，10：待阅，11:已阅，20：关注）--已办，需要先根据bizKey删除待办，已阅接口需要根据bizKey调用集团待阅删除接口
              'http://pom.crccre.cn/pom/pom/middle?originalUrl=' ||
								URL_ENCODE('http://pom.crccre.cn/pom/pom/mission-center-feedback/my-responsible-task?cancelType=0' || CHR(38) || 'id=' || m_planid || CHR(38) || 'feedbackNodeId=' || m_nodeid ||
													 CHR(38) || 'feedbackNodeOriginalId=' ||originalnodeid || CHR(38) || 'nodeSourcePlanType=1')   "url",--url	是	String	应用系统的url地址
              '无'  "mobileUrl",--mobileUrl	否	String	应用系统的手机端url地址
              ''||m_userName||'您好，'||m_user||'对您负责的任务“'||m_nodeName||'”进行了催办'  "taskname",--taskname	是	String	任务名称，等于3、插入待阅/4、插入已阅informationname;等于插入关注的attentionname
              '计划运营'  "typename",--typename	是	String	任务类型
              plantype  "remark",--remark	否	String	备注

              ----------------------------------------------
              -----除【关注外特有】
              sysdate  "expiretime",--expiretime	否	String	过期时间，格式yyyy-MM-dd HH:mm:ss-----过期时间，除关注都有
              1  "priority"--priority	否	Integer	优先级，除关注都有
                FROM dual;

END p_pom_urge_msg_info;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_URGED_MSG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_URGED_MSG" (
    bizid      IN         VARCHAR2,--输入变量：业务id
    biztype    IN         VARCHAR2,--业务类型：1:关键节点计划节点，2：项目主项计划节点，3：专项计划节点，4：月度计划节点
    urgedmsg   OUT        SYS_REFCURSOR--0推送消息
) IS
--点击催办按钮，获取消息信息
--作者：陈丽
--日期：2019/11/17
    testmsg    NVARCHAR2(4000);
BEGIN
    BEGIN
        OPEN urgedmsg FOR SELECT
                              sysdate||'id' AS "msgGroupId",
                              '消息描述' || sysdate AS "msgDescription",
                              '1' AS "RecipientId",
                              bizid AS "bizKey",
                              'v-xufeng' AS "senderId",
                              biztype AS "bizSourceCategory",
                              '催办消息' AS "bizMsgCategory",
                              '预警' AS "systemId",
                              '111' AS "wechatJumplinkUrl"
                          FROM
                              dual;

    EXCEPTION
        WHEN OTHERS THEN
            testmsg := sqlerrm;
    END;
END p_pom_urged_msg;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_VERIFY_ATTR_AREA_USE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_VERIFY_ATTR_AREA_USE" (
    attrid     IN         VARCHAR2_LIST,--输入变量：单位面积等级id集合
    attrtype   IN         INT,--0单位面积等级,10项目合作属性,20经营属性
    message    OUT        VARCHAR2,--提示消息
    isuse      OUT        INT--0未使用，1已使用
) IS
--验证业态是否被使用
--作者：陈丽
--日期：2019/11/17
BEGIN
    BEGIN
        isuse := 0;
        message := '验证通过';
    --查看是否在指标表使用---先单个后期调整
--        SELECT
--            COUNT(attribute_area_level_id)
--        INTO isuse
--        FROM
--            mdm_obj_phase_area_level
--        WHERE
--            attribute_area_level_id = ''
--                                      || attributeid
--                                      || '';
        IF isuse > 0 THEN
            raise_application_error(-20000, '属性已被使用不允许删除');
        END IF;

    EXCEPTION
        WHEN OTHERS THEN
            isuse := 1;
            message := '验证失败，' || sqlerrm;
    END;
END p_pom_verify_attr_area_use;



/
--------------------------------------------------------
--  DDL for Procedure P_POM_VERIFY_BUILDING_USE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_VERIFY_BUILDING_USE" 
(
		BUILDINGID IN VARCHAR2
	 , --输入变量：楼栋id
		MESSAGE    OUT VARCHAR2
	 , --提示消息
		ISUSE      OUT INT --0未使用，1已使用
) IS
		--验证楼栋是否被使用
		--作者：陈丽
		--日期：2019/11/17
BEGIN
		BEGIN
				ISUSE := 0;
				--查看分期是否在指标表使用
				SELECT COUNT(BUILD_ID)
				INTO   ISUSE
				FROM   MDM_BUILD_PHASE
				WHERE  BUILD_ID = '' || BUILDINGID || '';
				IF LENGTH(ISUSE) > 0 THEN
						RAISE_APPLICATION_ERROR(-20000, '楼栋已存在指标数据不允许删除');
				END IF;
		EXCEPTION
				WHEN OTHERS THEN
						ISUSE   := 1;
						MESSAGE := '验证失败，' || SQLERRM;
		END;
END P_POM_VERIFY_BUILDING_USE;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_VERIFY_PERIOD_USE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_VERIFY_PERIOD_USE" (
    periodoriginalid   IN                 VARCHAR2,--输入变量：分期原始id
    message            OUT                VARCHAR2,--提示消息
    isuse              OUT                INT--0未使用，1已使用
) IS
--验证分期是否被使用
--作者：陈丽
--日期：2019/11/17
BEGIN
    BEGIN
        isuse := 0;
    --查看分期是否在指标表使用
        SELECT
            COUNT(period_id)
        INTO isuse
        FROM
            mdm_period_phase
        WHERE
            period_id = ''
                        || periodoriginalid
                        || '';
        IF isuse > 0 THEN
            raise_application_error(-20000, '分期已存在指标数据不允许删除');
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            isuse := 1;
            message := '验证失败，' || sqlerrm;
    END;
END p_pom_verify_period_use;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_VERIFY_PRODUCT_TYPE_USE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_VERIFY_PRODUCT_TYPE_USE" (
    ptid   IN           VARCHAR2,--输入变量：业态id。多个逗号分隔，
    message      OUT          VARCHAR2,--提示消息
    isuse        OUT          INT--0未使用，1已使用
) IS
--验证业态是否被使用
--作者：陈丽
--日期：2019/11/17
BEGIN
  BEGIN
        isuse := 0;
    --查看分期是否在指标表使用
        SELECT
            COUNT(PRODUCT_TYPE_ID)
        INTO isuse
        FROM
            MDM_OBJ_PHASE_PT_INDEX
        WHERE
            PRODUCT_TYPE_ID = ''
                        || ptid
                        || '';
        IF isuse > 0 THEN
            raise_application_error(-20000, '业务已被使用不允许删除');
        END IF;
        message := '验证通过';
    EXCEPTION
        WHEN OTHERS THEN
            isuse := 1;
            message := '验证失败，'||isuse || sqlerrm;
    END;
END p_pom_verify_product_type_use;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_W_PROJ_MAIN_LIGHT_UP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_W_PROJ_MAIN_LIGHT_UP" (
    companyId    IN           VARCHAR2,--公司id
    info    OUT          SYS_REFCURSOR --亮灯信息
) AS  
--项目主项计划监控-亮灯集合
--作者：陈丽
--修改：联合查询SYS_ROLE_USER_RELATION_RESULT表查询出项目计划专员  ByYedr 20200309
--日期：2019/12/07
BEGIN
    OPEN info FOR                    
    SELECT DISTINCT   B1.*,B1.TOTALNODECOUNT AS "totalNodeCount"  ,'项目计划专员:'|| CASE WHEN C1.USER_NAME is null then '无' else to_char(C1.USER_NAME) end AS "projectPlanManager"  
		FROM SYS_BUSINESS_UNIT A1  LEFT JOIN(
SELECT  D.PROJECT_NAME|| CASE WHEN C.STAGE_NAME NOT LIKE '%无分期%' THEN '_'||C.STAGE_NAME ELSE NULL END    AS "projectName"
,A.ID AS "planId"
,D.ID  as  "PROJECT_ID"
,A.COMPANY_ID
,COUNT(B.ID)  AS  "TOTALNODECOUNT"
,SUM( CASE WHEN    B.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END)  AS "actualEndNodeCount" 
,ROUND(SUM( CASE WHEN    B.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END)/COUNT(B.ID),4) AS "completeRate"
--完成率说明：截止当前完成节点数量/截止当前应完成任务数量    亮灯规则说明：1）绿灯：完成率≥95% 2）黄灯：95%>完成率≥90% 3）红灯：完成率＜90%
,
case when COUNT(B.ID)>0 then 
CASE WHEN ROUND(SUM( CASE WHEN    B.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END)/COUNT(B.ID),4)*100>=95 THEN 3 
      WHEN ROUND(SUM( CASE WHEN    B.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END)/COUNT(B.ID),4)*100>=90 then 2 
      WHEN ROUND(SUM( CASE WHEN    B.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END)/COUNT(B.ID),4)*100 <90 then 1
      ELSE 1 
  END else 1 END  AS "completeStatus"
    ,SUM( CASE WHEN  B.NODE_LEVEL='里程碑'    AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END) 
    +SUM( CASE WHEN  B.NODE_LEVEL='一级节点'  AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END) 
    +SUM( CASE WHEN  B.NODE_LEVEL='二级节点'  AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END) 
    +SUM( CASE WHEN  B.NODE_LEVEL='三级节点'  AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END) 
  --  +SUM( CASE WHEN  B.NODE_LEVEL='四级节点'  AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END) 

AS "overDueNotCompletedCount"

,SUM( CASE WHEN  B.NODE_LEVEL='里程碑'  AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END)  AS "milestoneNotCompleteCount" 
,SUM( CASE WHEN  B.NODE_LEVEL='一级节点'  AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END)  AS "oneNodeNotCompleteCount" 
,SUM( CASE WHEN  B.NODE_LEVEL='二级节点'  AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END)  AS "twoNodeNotCompleteCount" 
,SUM( CASE WHEN  B.NODE_LEVEL='三级节点'  AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END)  AS "threeNodeNotCompleteCount" 
--李晓聪20200330修改排除零做除数
, case when SUM( CASE WHEN  B.NODE_LEVEL='里程碑'  THEN 1 ELSE 0 END)>0 then  ROUND(SUM( CASE WHEN  B.NODE_LEVEL='里程碑'  AND  B.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END) /SUM( CASE WHEN  B.NODE_LEVEL='里程碑'  THEN 1 ELSE 0 END),2)  else 1 end  AS "milestoneNotCompletePercent" 
,case when SUM( CASE WHEN  B.NODE_LEVEL='一级节点'  THEN 1 ELSE 0 END)>0 then ROUND(SUM( CASE WHEN  B.NODE_LEVEL='一级节点'  AND  B.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END) /SUM( CASE WHEN  B.NODE_LEVEL='一级节点'  THEN 1 ELSE 0 END),2)  else 1 end  AS "oneNodeNotCompletePercent" 
,case when SUM( CASE WHEN  B.NODE_LEVEL='二级节点'  THEN 1 ELSE 0 END)>0 then ROUND(SUM( CASE WHEN  B.NODE_LEVEL='二级节点'  AND  B.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END) /SUM( CASE WHEN  B.NODE_LEVEL='二级节点'  THEN 1 ELSE 0 END),2) else 1  end   AS "twoNodeNotCompletePercent" 
,case when SUM( CASE WHEN  B.NODE_LEVEL='三级节点'  THEN 1 ELSE 0 END)>0 then ROUND(SUM( CASE WHEN  B.NODE_LEVEL='三级节点'  AND  B.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END) /SUM( CASE WHEN  B.NODE_LEVEL='三级节点'  THEN 1 ELSE 0 END),2) else 1 end   AS "threeNodeNotCompletePercent" 

FROM POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE B ON A.ID=B.PROJ_PLAN_ID
LEFT  JOIN SYS_PROJECT_STAGE C ON C.ID=PROJ_ID
INNER JOIN SYS_PROJECT D ON (D.ID=C.PROJECT_ID or PROJ_ID=d.id) 
WHERE     A.PLAN_TYPE='项目主项计划' AND A.APPROVAL_STATUS='已审核' AND B.IS_DISABLE=0  AND B.PLAN_END_DATE<=SYSDATE
GROUP BY D.PROJECT_NAME|| CASE WHEN C.STAGE_NAME NOT LIKE '%无分期%' THEN '_'||C.STAGE_NAME ELSE NULL END,A.COMPANY_ID,A.ID,D.ID )
B1 ON B1.COMPANY_ID=A1.ID 
LEFT JOIN(SELECT wm_concat(USER_NAME) AS USER_NAME,PROJECT_ID FROM SYS_ROLE_USER_RELATION_RESULT WHERE ROLE_CODE='pom_project_plan_manager' GROUP BY PROJECT_ID) C1 ON C1.PROJECT_ID=B1.PROJECT_ID
WHERE  NVL(B1.TOTALNODECOUNT,0)>0 AND  CONNECT_BY_ROOT ID =''||companyId||''
CONNECT  by PRIOR   A1.ID= A1.PARENT_ID ;
END p_pom_w_proj_main_light_up;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_W_PROJ_PLAN_CHART
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_W_PROJ_PLAN_CHART" (
   userid                 IN                     VARCHAR2,--用户id
    planid                 IN                     VARCHAR2,--计划id
    completion_level_rate_title   OUT                    VARCHAR2,---一、按任务级别统计完成率 (%)--标题
    completion_level_rate  out SYS_REFCURSOR,---一、按任务级别统计完成率 (%)
    completion_dept_rate_title   OUT                    VARCHAR2,--- 二、按执行部门统计完成率 (%) --标题
    completion_dept_rate  out SYS_REFCURSOR---二、按执行部门统计完成率 (%)
) AS
--项目主项计划监控，详情页 ：图表
--作者：陈丽定义，李小聪实现  
--日期：2020/02/26
  v_timeout_count VARCHAR2(20):='';
  v_expect_timeout_count VARCHAR2(20):='';
BEGIN
completion_level_rate_title:='一、按任务级别统计完成率 (%)';
completion_dept_rate_title:='二、按执行部门统计完成率 (%)';

    OPEN Completion_level_rate FOR
--      SELECT  '里程碑' as "nodeName",1 as "percentage" from dual
--      UNION all 
--      SELECT  '一级节点' as "nodeName",1 as "percentage" from dual
--     UNION all 
--      SELECT  '二级节点' as "nodeName",1 as "percentage" from dual;
		SELECT   NODE_LEVEL  as "nodeName",	ROUND(SUM( CASE WHEN   B.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END) /COUNT(b.id),2)  AS "percentage" 
			FROM POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE B ON A.ID=B.PROJ_PLAN_ID
			INNER JOIN SYS_PROJECT_STAGE C ON C.ID=PROJ_ID
			INNER JOIN SYS_PROJECT D ON D.ID=C.PROJECT_ID
			WHERE     A.PLAN_TYPE='项目主项计划' AND A.APPROVAL_STATUS='已审核' AND B.IS_DISABLE=0  AND B.PLAN_END_DATE<=SYSDATE and  a.id=''||planid||''
			GROUP BY NODE_LEVEL    ORDER BY   CASE  WHEN   NODE_LEVEL='里程碑' THEN  0 WHEN   NODE_LEVEL='一级节点' THEN  1 WHEN   NODE_LEVEL='二级节点' THEN  3   WHEN   NODE_LEVEL='三级节点' THEN  4  WHEN   NODE_LEVEL='四级节点' THEN  5 else 6 END asc;

	 OPEN completion_dept_rate FOR	 

SELECT 　B.DUTY_DEPARTMENT as "department"  , TO_CHAR( ROUND ( SUM(CASE WHEN B.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END )/COUNT(B.ID),2)) AS "percentage" 
FROM  POM_PROJ_PLAN A  INNER JOIN POM_PROJ_PLAN_NODE B ON A.id=b.PROJ_PLAN_ID
where A.PLAN_TYPE='项目主项计划' AND A.APPROVAL_STATUS='已审核'  AND B.IS_DISABLE=0  AND A.ID=''||planId||''
GROUP BY   B.DUTY_DEPARTMENT_ID,B.DUTY_DEPARTMENT
ORDER BY 2 desc;

END p_pom_w_proj_plan_chart;


/
--------------------------------------------------------
--  DDL for Procedure P_POM_W_PROJ_PLAN_DEPT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_W_PROJ_PLAN_DEPT" (planId in varchar2,wacthinfo OUT sys_refcursor)
AS
--项目主项计划监控，部门排行图
--作者：陈丽
--日期：2019/11/13
BEGIN
open wacthinfo for

SELECT 　B.DUTY_DEPARTMENT as "department"  , TO_CHAR( ROUND ( SUM(CASE WHEN B.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END )/COUNT(B.ID),2)) AS "percentage" 
FROM  POM_PROJ_PLAN A  INNER JOIN POM_PROJ_PLAN_NODE B ON A.id=b.PROJ_PLAN_ID
where A.PLAN_TYPE='项目主项计划' AND A.APPROVAL_STATUS='已审核'  AND B.IS_DISABLE=0  AND A.ID=''||planId||''
GROUP BY   B.DUTY_DEPARTMENT_ID,B.DUTY_DEPARTMENT
ORDER BY 2 desc
;
 
 
END p_pom_w_proj_plan_dept;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_W_PROJ_PLAN_DTL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_W_PROJ_PLAN_DTL" (
    userid                 IN                     VARCHAR2,--用户id
    planid                 IN                     VARCHAR2,--计划id
    pandect_info           out SYS_REFCURSOR      --计划明细一览表
) AS
--项目主项计划监控，详情页 ：明细一览表
--作者：陈丽
--修改者：谢松宏
--修改时间：2020/05/08 
--添加5个时间转换为字符串后查询的字段，日期字段去掉时间格式
--日期：2020/02/26
BEGIN
----计划明细一览表
    OPEN pandect_info FOR
         SELECT   a.*,nvl(b.IS_UN_WATCH,1) as  IS_UN_WATCH
         ,to_char(a.PLAN_START_DATE, 'YYYY-mm-dd') as "PLAN_START_TIME"
         ,to_char(a.PLAN_END_DATE, 'YYYY-mm-dd') as "PLAN_END_TIME"
         ,to_char(a.ACTUAL_START_DATE, 'YYYY-mm-dd') as "ACTUAL_START_TIME"
         ,to_char(a.ACTUAL_END_DATE, 'YYYY-mm-dd') as "ACTUAL_END_TIME"
         ,to_char(a.ESTIMATE_END_DATE, 'YYYY-mm-dd') as "ESTIMATE_END_TIME"
          ,b.UN_WATCH_TIME  ,b.WATCH_TIME  
      FROM  V_POM_PROJ_MONITOR_SUMMARYLIST  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' --and   b.WATCH_TIME is  not   null
      WHERE     a.PLAN_ID=''||planid||'' ORDER BY NODE_CODE asc ;
END p_pom_w_proj_plan_dtl;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_W_PROJ_PLAN_OVERDUE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_W_PROJ_PLAN_OVERDUE" (
    userid                 IN                     VARCHAR2,--用户id
    planid                 IN                     VARCHAR2,--计划id
    timeout_info           OUT                    SYS_REFCURSOR,--三、超期未完成任务 
    timeout_title          OUT                    VARCHAR2,--标题 超期未完成任务：共0项
    expect_timeout_info    OUT                    SYS_REFCURSOR,--四、预计超期任务 
    expect_timeout_title   OUT                    VARCHAR2--标题预计超期任务：共0项
) AS
--项目主项计划监控，详情页 ：超期未完成任务,预计超期任务
--作者：陈丽定义，李小聪实现
--修改：联合查询SYS_ROLE_USER_RELATION_RESULT表查询出项目计划专员  ByYedr 20200309
--日期：2020/02/26
  v_timeout_count VARCHAR2(20):='';
  v_expect_timeout_count VARCHAR2(20):='';
  planning_specialist VARCHAR2(20):='';
BEGIN
   EXECUTE IMMEDIATE  
    'SELECT role.USER_NAME FROM POM_PROJ_PLAN plan LEFT JOIN SYS_PROJECT_STAGE stage ON plan.PROJ_ID=stage.ID
    LEFT JOIN SYS_PROJECT proj ON proj.ID=stage.PROJECT_ID
    LEFT JOIN (SELECT wm_concat(USER_NAME) AS USER_NAME,PROJECT_ID FROM SYS_ROLE_USER_RELATION_RESULT WHERE ROLE_CODE=''pom_project_plan_manager'' GROUP BY PROJECT_ID) role ON role.PROJECT_ID=stage.PROJECT_ID WHERE plan.ID='''||planid||'''' into planning_specialist;

    IF to_char(planning_specialist) is null then
        planning_specialist:='无';
    END IF;


 OPEN timeout_info FOR
      SELECT   a.*,nvl(b.IS_UN_WATCH,1)  as  IS_UN_WATCH ,b.UN_WATCH_TIME  ,b.WATCH_TIME  
      FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' --and   b.WATCH_TIME is  not   null
      WHERE     a.PLAN_ID=''||planid||''
      AND  TRUNC( a.PLAN_END_DATE)-TRUNC(SYSDATE)<0  and  a.ACTUAL_END_DATE  is null   ;
 OPEN expect_timeout_info FOR 
          SELECT   a.*,nvl(b.IS_UN_WATCH,1)  as  IS_UN_WATCH ,b.UN_WATCH_TIME  ,b.WATCH_TIME  
      FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND   TRUNC( a.ESTIMATE_END_DATE)-TRUNC(SYSDATE)<0   and  a.ACTUAL_END_DATE  is null  
			and  TRUNC( a.PLAN_END_DATE)-TRUNC(SYSDATE)>=0;


SELECT  (SELECT  TO_CHAR(COUNT(NODE_ID))        FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND  TRUNC( PLAN_END_DATE)-TRUNC(SYSDATE)<0  and  ACTUAL_END_DATE  is null   )  
INTO v_timeout_count  FROM  DUAL;
SELECT  (SELECT  TO_CHAR(COUNT(NODE_ID))        FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND   TRUNC( ESTIMATE_END_DATE)-TRUNC(SYSDATE)<0  and  ACTUAL_END_DATE  is null 	and  TRUNC( PLAN_END_DATE)-TRUNC(SYSDATE)>=0 ) 
		
INTO v_expect_timeout_count  FROM  DUAL;
    timeout_title := '超期未完成任务：共'||v_timeout_count||'项       (项目计划专员：'||planning_specialist||')';
    expect_timeout_title := '预计超期任务：共'||v_expect_timeout_count||'项';



END p_pom_w_proj_plan_overdue;
--==========================项目主项计划监控解析计划专员===================


--==========================任务中心--关键节点计划反馈====================

/
--------------------------------------------------------
--  DDL for Procedure P_POM_WARNING_MSG_LIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_WARNING_MSG_LIST" ( isread IN VARCHAR2, --0、未读1、已读
    userid IN VARCHAR2,--当前用户ID
    items OUT SYS_REFCURSOR,    
    total OUT INT ,--明细信息
    pageindex     IN            INT,
    pagesizes     IN            INT
  )IS--预警消息台账
--作者：叶丁荣
--日期：2019/12/18
--日期：2020/01/13 康文靖修改
    v_sql               CLOB;
    v_sql_exec          CLOB;
    v_sql_exec_paging   CLOB;
BEGIN
    v_sql :='SELECT
      node.ID,
      ROWNUM as rowno,
      node.DUTY_DEPARTMENT AS DEPARTMENT,--部门
      node.NODE_LEVEL AS NODE_LEVEL,--任务级别
      node.STANDARD_SCORE,--标准分值
      to_char(node.PLAN_START_DATE,''yyyy-mm-dd'')   AS PLAN_BEGIN_TIME,--计划开始时间
      to_char(node.PLAN_END_DATE,''yyyy-mm-dd'') AS PLAN_END_TIME,--计划结束时间
      to_char(msg.ACTUAL_CREATED,''yyyy-mm-dd'')  AS WARNING_TIME,--预警时间
      msg.pc_url AS URL, --跳转URL
      msg.TASK_NAME AS WARNING_INFO,--预警信息
    CASE
        WHEN node.PLAN_END_DATE - SYSDATE < 0 THEN
        ''<i style="margin-left:0.6cm;width:20px;height:20px;border-radius:50%;background-color:red;display: block"></i>''
        WHEN node.PLAN_END_DATE - SYSDATE > 0 THEN
      ''<i style="margin-left:0.6cm;width:20px;height:20px;border-radius:50%;background-color:green;display: block"></i>''
    END AS WARNING_STATUS,
    msg.biz_msg_category as WARNING_TYPE
    FROM
      POM_PROJ_PLAN_NODE node
      left JOIN SYS_MESSAGE_CENTER msg ON msg.TASK_ID = node.ID
      left JOIN SYS_USER u ON msg.owner_name=u.user_code
      where msg.TASK_ID = node.ID AND u.ID='''||userid||'''
      AND (msg.biz_msg_category=''提醒消息'' OR msg.biz_msg_category=''预警消息'')';

    IF(isread='已读消息') THEN
      v_sql_exec :=v_sql ||'  and  msg.TASK_STATE = 10 ';

    ELSE 
      v_sql_exec :=v_sql ||' and  msg.TASK_STATE = 0 ';  

    END IF;

      v_sql_exec_paging :='select a.* from ( '|| v_sql_exec|| ' and ROWNUM <= '|| pageindex * pagesizes|| ' ) a where a.rowno >= '|| pagesizes * ( pageindex - 1 )|| '';


        dbms_output.put_line(v_sql_exec);
       ----获取总条数
        EXECUTE IMMEDIATE 'SELECT count(ROWNUM) from('
                          || v_sql_exec
                          || ') a' 
                          INTO total;

        OPEN items FOR v_sql_exec_paging;

END p_pom_warning_msg_list;

/
--------------------------------------------------------
--  DDL for Procedure P_POM_WARNING_RULES_MSG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_POM_WARNING_RULES_MSG" 
(
		RULEID IN VARCHAR2 --输入变量：规则id
	 ,INFO   OUT SYS_REFCURSOR --消息集合
) IS
		--预警消息规则，获取发送消息数据
		--作者：陈丽
		--日期：2020/01/08
BEGIN
		OPEN info FOR SELECT
            ------------------------------------------------------------基础必须信息
              '71313f018a35f3a558166cba7599b5d6' AS "systemId",--系统id
              'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "appid",--应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段，
            ------------------------------------------------------------业务变动必须信息
              'bizid' AS "bizKey",--业务id
               'tjWeChat,tjSMS' AS "msgChannel",--使用消息渠道 多个，逗号分隔   tjWeChat：铁建微信,tjSMS：铁建短信
            ------------------------------------------------------------短信必须参数
              '400013' AS "smsTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID  --{1}您好，您负责的任务“{2}”已超期{3}天，请及时到门户网站查看待办并在《计划管理系统》中反馈任务进度{4}。
              '["陈丽","预售许可证","5","测试数据"]' AS "smsParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》说明{1}为您的登录验证码，请于{2}分钟内填写，如非本人操作，请忽略本短信。
              '13896186104' as "mobile",--短信接收人电话
            ------------------------------------------------------------微信必须参数
              '400013' AS "wechatTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID
              '["陈丽","预售许可证","5","测试数据"]' AS "wechatParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》说明{1}为您的登录验证码，请于{2}分钟内填写，如非本人操作，请忽略本短信。
               '///' AS "wechatJumplinkUrl",--微信打开地址，程序调用发消息前需要编码
              'v-xufeng' AS "recipientAccount",--接收人usercode如：a-xiexuhua
            ------------------------------------------------------------消息记录方追溯信息
              '部门月度计划流程预警' AS "title",--消息标题
              'v-xufeng' AS "senderAccount",--发送人usercode如：a-xiexuhua
              '月度计划' AS "bizSourceCategory",--业务所属类别=》 （由业务系统自定义，方便根据业务回溯，同一类别下有很多个类似业务，如月度计划）
              '预警消息' AS "bizMsgCategory"--消息所属类别=》 （由业务系统自定义，方便根据业务回溯，同一业务主键，有多个分类，如预警消息，提醒消息）
          FROM
              dual;

END P_POM_WARNING_RULES_MSG;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_AUTH_DATA_RULE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_SYS_AUTH_DATA_RULE" ( USERID IN VARCHAR2, STATIONID IN VARCHAR2, DEPTID IN VARCHAR2, COMPANYID IN VARCHAR2, BIZCODE IN VARCHAR2 ,
DATA_AUTH_INFO OUT sys_refcursor) 
AS
--数据鉴权，返回数据权限中有权限的项目或部门（不考虑隔离规则）
--作者：谷国斌
--日期：2019/12/13
AUTHCOUNT INT;--用于判断当前公司、部门是否与数据授权的主体有关系
SPID VARCHAR2(36);--使用临时表的批次号
BEGIN

select get_uuid() into SPID from dual;


--插入数据授权的数据：

        DECLARE
                OWNERID  VARCHAR2(36);
                OENERTYPE NVARCHAR2(50);
                CURSOR cursor_company IS
                select distinct auth_owner_id,auth_owner_type from SYS_DATA_AUTH where auth_biz_code=BIZCODE and is_disabled=0;

            BEGIN   

            --打开游标
                OPEN cursor_company;
                loop
                    fetch cursor_company into OWNERID,OENERTYPE;
                    exit when cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                if OENERTYPE='公司' or OENERTYPE='集团'
                then
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                     SELECT count(*) into AUTHCOUNT FROM sys_business_unit where is_company=1 and id=COMPANYID
                    START WITH ID=OWNERID CONNECT BY PRIOR  ID=parent_id;
                    if AUTHCOUNT<>0
                    then
                        insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
                        values(SPID,OWNERID,OENERTYPE);

                    end if;

                end if;

                 if OENERTYPE='部门'
                then
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                     SELECT count(*) into AUTHCOUNT FROM sys_business_unit where is_company=0 and id=DEPTID
                    START WITH ID=OWNERID CONNECT BY PRIOR  ID=parent_id;
                    if AUTHCOUNT<>0
                    then
                        insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
                        values(SPID,OWNERID,OENERTYPE);

                    end if;

                end if;

                 if (OENERTYPE='岗位' and OWNERID=STATIONID) or (OENERTYPE='人员' and OWNERID=USERID)
                then

                       insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
                        values(SPID,OWNERID,OENERTYPE);    
                end if;

                end loop;

                close cursor_company;

            END;   


          --获取有权限的公司及其部门：            
                DECLARE
                        OWNERID2  VARCHAR2(36);
                        CURSOR cursor_auth IS
                        select distinct auth_owner_id from TMP_AUTH_OWNER where ID=SPID;

                    BEGIN   

                    --打开游标
                        OPEN cursor_auth;
                        loop
                            fetch cursor_auth into OWNERID2;
                            exit when cursor_auth%notfound;


                            --授权对象为公司：
                            --取授权公司的子级：
                            insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,ID FROM
                            sys_business_unit where is_company=0
                                START WITH ID in (
                                select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type in ('公司','集团') and auth_type='部门'
                                )  CONNECT BY PRIOR  ID=parent_id;


                         insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,org_id FROM
                            v_sys_project where org_type<>0
                                START WITH org_id in (
                                select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type in ('公司','集团') and auth_type='项目'
                                )  CONNECT BY PRIOR  org_id=parent_id;

                           --插入可研项目     
                          insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,id FROM
                            CDB_FEASIBLE_PROJECT_CONFIG 
                            where subordinate_company_id in
                                (select id from sys_business_unit where is_company=1 START WITH id in (
                                select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type in ('公司','集团') and auth_type='项目'
                                )  CONNECT BY PRIOR  id=parent_id);       

                             --授权对象为部门：
                               --取授权部门及其子级：

                                 insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,ID FROM
                            sys_business_unit where is_company=0
                                START WITH ID in  (select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type='部门' and auth_type='部门'
                                )  CONNECT BY PRIOR  ID=parent_id;

                               --授权对象为项目： 
                            insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,org_id FROM
                            v_sys_project where org_type<>0 and project_id in 
                                 (select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type='项目' and auth_type='项目'
                                );   

                              end loop;
                           close  cursor_auth;    
                        end;

    --2020/2/20:成本数据库需要，增加
    --插入隔离规则-项目：
    insert into TMP_AUTH_LIST(ID,ORG_ID)
    select SPID,id from sys_project a inner join (
    select ISOLATION_RULE_VALUE from SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE=BIZCODE and ISOLATION_RULE_VALUE='全集团')
    on 1=1;
    --插入隔离规则-可研项目：
    insert into TMP_AUTH_LIST(ID,ORG_ID)
    select SPID,id from CDB_FEASIBLE_PROJECT_CONFIG a inner join (
    select ISOLATION_RULE_VALUE from SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE=BIZCODE and ISOLATION_RULE_VALUE='全集团')
    on 1=1;
    --插入隔离规则-项目：
    insert into TMP_AUTH_LIST(ID,ORG_ID)
    select SPID,id from sys_project a inner join (
    select ISOLATION_RULE_VALUE from SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE=BIZCODE and ISOLATION_RULE_VALUE='本公司')
    on 1=1 where a.unit_id=COMPANYID;
    --插入隔离规则-可研项目：
    insert into TMP_AUTH_LIST(ID,ORG_ID)
    select SPID,id from CDB_FEASIBLE_PROJECT_CONFIG a inner join (
    select ISOLATION_RULE_VALUE from SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE=BIZCODE and ISOLATION_RULE_VALUE='本公司')
    on 1=1 where a.subordinate_company_id=COMPANYID;



 open DATA_AUTH_INFO for
select distinct ORG_ID as orgId
from TMP_AUTH_LIST WHERE ID=SPID;

END P_SYS_AUTH_DATA_RULE;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_AUTH_DATA_RULE_SPID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_SYS_AUTH_DATA_RULE_SPID" ( USERID IN VARCHAR2, STATIONID IN VARCHAR2, DEPTID IN VARCHAR2, COMPANYID IN VARCHAR2, BIZCODE IN VARCHAR2 ,
DATA_AUTH_SPID OUT VARCHAR2) 
AS
--数据鉴权，返回数据权限中有权限的项目或部门（不考虑隔离规则）
--作者：谷国斌
--日期：2019/12/13
AUTHCOUNT INT;--用于判断当前公司、部门是否与数据授权的主体有关系
SPID VARCHAR2(36);--使用临时表的批次号
BEGIN
select get_uuid() into SPID from dual;
------------------------------------------------------开始-----------------------------------------------部门和项目 复制谷哥鉴权存储过程 
--插入数据授权的数据：

        DECLARE
                OWNERID  VARCHAR2(36);
                OENERTYPE NVARCHAR2(50);
                CURSOR cursor_company IS
                select distinct auth_owner_id,auth_owner_type from SYS_DATA_AUTH where auth_biz_code=BIZCODE and is_disabled=0;

            BEGIN   

            --打开游标
                OPEN cursor_company;
                loop
                    fetch cursor_company into OWNERID,OENERTYPE;
                    exit when cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                if OENERTYPE='公司' or OENERTYPE='集团'
                then
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                     SELECT count(*) into AUTHCOUNT FROM sys_business_unit where is_company=1 and id=COMPANYID
                    START WITH ID=OWNERID CONNECT BY PRIOR  ID=parent_id;
                    if AUTHCOUNT<>0
                    then
                        insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
                        values(SPID,OWNERID,OENERTYPE);

                    end if;

                end if;

                 if OENERTYPE='部门'
                then
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                     SELECT count(*) into AUTHCOUNT FROM sys_business_unit where is_company=0 and id=DEPTID
                    START WITH ID=OWNERID CONNECT BY PRIOR  ID=parent_id;
                    if AUTHCOUNT<>0
                    then
                        insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
                        values(SPID,OWNERID,OENERTYPE);

                    end if;

                end if;

                 if (OENERTYPE='岗位' and OWNERID=STATIONID) or (OENERTYPE='人员' and OWNERID=USERID)
                then

                       insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
                        values(SPID,OWNERID,OENERTYPE);    
                end if;

                end loop;

                close cursor_company;

            END;   


          --获取有权限的公司及其部门：            
                DECLARE
                        OWNERID2  VARCHAR2(36);
                        CURSOR cursor_auth IS
                        select distinct auth_owner_id from TMP_AUTH_OWNER where ID=SPID;

                    BEGIN   

                    --打开游标
                        OPEN cursor_auth;
                        loop
                            fetch cursor_auth into OWNERID2;
                            exit when cursor_auth%notfound;


                            --授权对象为公司：
                            --取授权公司的子级：
                            insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,ID FROM
                            sys_business_unit where is_company=0
                                START WITH ID in (
                                select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type in ('公司','集团') and auth_type='部门'
                                )  CONNECT BY PRIOR  ID=parent_id;


                         insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,org_id FROM
                            v_sys_project where org_type<>0
                                START WITH org_id in (
                                select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type in ('公司','集团') and auth_type='项目'
                                )  CONNECT BY PRIOR  org_id=parent_id;

                           --插入可研项目     
                          insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,id FROM
                            CDB_FEASIBLE_PROJECT_CONFIG 
                            where subordinate_company_id in
                                (select id from sys_business_unit where is_company=1 START WITH id in (
                                select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type in ('公司','集团') and auth_type='项目'
                                )  CONNECT BY PRIOR  id=parent_id);       

                             --授权对象为部门：
                               --取授权部门及其子级：

                                 insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,ID FROM
                            sys_business_unit where is_company=0
                                START WITH ID in  (select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type='部门' and auth_type='部门'
                                )  CONNECT BY PRIOR  ID=parent_id;

                               --授权对象为项目： 
                            insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,org_id FROM
                            v_sys_project where org_type<>0 and project_id in 
                                 (select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type='项目' and auth_type='项目'
                                );   

                              end loop;
                           close  cursor_auth;    
                        end;

    --2020/2/20:成本数据库需要，增加
    --插入隔离规则-项目：
    insert into TMP_AUTH_LIST(ID,ORG_ID)
    select SPID,id from sys_project a inner join (
    select ISOLATION_RULE_VALUE from SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE=BIZCODE and ISOLATION_RULE_VALUE='全集团')
    on 1=1;
    --插入隔离规则-可研项目：
    insert into TMP_AUTH_LIST(ID,ORG_ID)
    select SPID,id from CDB_FEASIBLE_PROJECT_CONFIG a inner join (
    select ISOLATION_RULE_VALUE from SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE=BIZCODE and ISOLATION_RULE_VALUE='全集团')
    on 1=1;
    --插入隔离规则-项目：
    insert into TMP_AUTH_LIST(ID,ORG_ID)
    select SPID,id from sys_project a inner join (
    select ISOLATION_RULE_VALUE from SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE=BIZCODE and ISOLATION_RULE_VALUE='本公司')
    on 1=1 where a.unit_id=COMPANYID;
    --插入隔离规则-可研项目：
    insert into TMP_AUTH_LIST(ID,ORG_ID)
    select SPID,id from CDB_FEASIBLE_PROJECT_CONFIG a inner join (
    select ISOLATION_RULE_VALUE from SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE=BIZCODE and ISOLATION_RULE_VALUE='本公司')
    on 1=1 where a.subordinate_company_id=COMPANYID;
------------------------------------------------------结束-----------------------------------------------部门和项目 复制谷哥鉴权存储过程 
-------------------------------------------------------开始----------------------------------------------公司、岗位、人 chenl
    --插入隔离规则-公司、岗位、人
    insert into TMP_AUTH_LIST(ID,ORG_ID)
  	SELECT SPID,
CASE 
	ISOLATION_RULE_VALUE 
	WHEN '本公司' THEN COMPANYID
	WHEN '本部门' THEN DEPTID
	WHEN '本岗位' THEN STATIONID
	WHEN '本人' THEN USERID
	ELSE ''
END AS AUTH_SCOPE_ID
FROM SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE = BIZCODE and ISOLATION_RULE_VALUE in ('本公司','本部门','本岗位','本人');


 DATA_AUTH_SPID:=SPID;
-- open DATA_AUTH_INFO for
--select distinct ORG_ID as orgId
--from TMP_AUTH_LIST WHERE ID=SPID;

END P_SYS_AUTH_DATA_RULE_SPID;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_AUTH_ISOLATION_RULE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_SYS_AUTH_ISOLATION_RULE" 
(
		USER_ID        IN VARCHAR2
	 ,STATION_ID     IN VARCHAR2
	 ,DEPT_ID        IN VARCHAR2
	 ,COMPANY_ID     IN VARCHAR2
	 ,BIZ_CODE       IN VARCHAR2
	 ,DATA_AUTH_INFO OUT SYS_REFCURSOR
) AS
		--隔离规则鉴权
		--作者：徐峰
		--日期：2019/12/14
BEGIN
		OPEN DATA_AUTH_INFO FOR
				SELECT CASE ISOLATION_RULE_VALUE
										WHEN '全集团' THEN
										 '003200000000000000000000000000'
										WHEN '本公司' THEN
										 COMPANY_ID
										WHEN '本部门' THEN
										 DEPT_ID
										WHEN '本岗位' THEN
										 STATION_ID
										WHEN '本岗位' THEN
										 USER_ID
										ELSE
										 ''
								END AS AUTH_SCOPE_ID,
							 SUBSTR(ISOLATION_RULE_VALUE, 2, LENGTH(ISOLATION_RULE_VALUE)) AS AUTH_SCOPE_TYPE
				FROM   SYS_DATA_AUTH_BIZ
				WHERE  BIZ_OBJ_CODE = BIZ_CODE;
END;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_DATA_AUTH
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_SYS_DATA_AUTH" ( USER_ID IN VARCHAR2, STATION_ID IN VARCHAR2, DEPT_ID IN VARCHAR2, COMPANY_ID IN VARCHAR2, BIZ_CODE IN VARCHAR2 ,
  DATA_AUTH_INFO OUT sys_refcursor) 
AS
--数据鉴权。包含数据权限和隔离规则的鉴权。
--作者：徐峰
--日期：2019/11/17
BEGIN
 open DATA_AUTH_INFO for
--数据权限
SELECT
	AUTH_SCOPE_ID,
	AUTH_SCOPE_TYPE,
	'数据权限' AS Auth_TYPE 
FROM
	SYS_DATA_AUTH 
WHERE
    IS_DISABLED = 0
    AND auth_biz_code = BIZ_CODE
		AND ( AUTH_OWNER_ID = USER_ID OR AUTH_OWNER_ID = STATION_ID OR AUTH_OWNER_ID = DEPT_ID OR AUTH_OWNER_ID = COMPANY_ID )
	UNION all 
--隔离规则
	SELECT
CASE
	ISOLATION_RULE_VALUE 
	WHEN '全集团' THEN '003200000000000000000000000000'
	WHEN '本公司' THEN COMPANY_ID
	WHEN '本部门' THEN DEPT_ID
	WHEN '本岗位' THEN STATION_ID
	else USER_ID
END AS AUTH_SCOPE_ID,
	SUBSTR( ISOLATION_RULE_VALUE, 2, length( ISOLATION_RULE_VALUE )) AS AUTH_SCOPE_TYPE,
	'隔离规则' AS Auth_TYPE 
FROM SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE = BIZ_CODE;
END P_SYS_DATA_AUTH;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_GET_COMPANY_PROJ_SPID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_SYS_GET_COMPANY_PROJ_SPID" 
(
		USERID         IN VARCHAR2
	 ,STATIONID      IN VARCHAR2
	 ,DEPTID         IN VARCHAR2
	 ,COMPANYID      IN VARCHAR2
	 ,BIZCODE        IN VARCHAR2
	 ,DATA_AUTH_SPID OUT VARCHAR2
) AS
		--获取有项目的公司树
		--作者：谷国斌
		--日期：2019/12/13
		RULEVALUE VARCHAR2(50);
		AUTHCOUNT INT; --用于判断当前公司、部门是否与数据授权的主体有关系
		SPID      VARCHAR2(36); --使用临时表的批次号
BEGIN

		SELECT GET_UUID() INTO SPID FROM DUAL;
		--插入集团作为根节点
		INSERT INTO TMP_COMPANY_TREE
				(ID, ORG_ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY, ORDER_CODE)
				SELECT SPID, ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
							 ORDER_CODE
				FROM   SYS_BUSINESS_UNIT
				WHERE  ID = '003200000000000000000000000000';

		--获取隔离规则：
		SELECT ISOLATION_RULE_VALUE
		INTO   RULEVALUE
		FROM   SYS_DATA_AUTH_BIZ
		WHERE  BIZ_OBJ_CODE = BIZCODE;
		IF RULEVALUE = '全集团' THEN
				INSERT INTO TMP_COMPANY_TREE
						(ID, ORG_ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
						 ORDER_CODE)
						SELECT SPID, ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
									 ORDER_CODE
						FROM   SYS_BUSINESS_UNIT
						WHERE  IS_COMPANY = 1;
		ELSE
				--插入本公司及其父级
				INSERT INTO TMP_COMPANY_TREE
						(ID, ORG_ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
						 ORDER_CODE)
						SELECT SPID, ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
									 ORDER_CODE
						FROM   SYS_BUSINESS_UNIT
						WHERE  IS_COMPANY = 1
						START  WITH ID = COMPANYID
						CONNECT BY PRIOR PARENT_ID = ID;

				--插入数据授权的数据：

				DECLARE
						OWNERID   VARCHAR2(36);
						OENERTYPE NVARCHAR2(50);
						CURSOR CURSOR_COMPANY IS
								SELECT DISTINCT AUTH_OWNER_ID, AUTH_OWNER_TYPE
								FROM   SYS_DATA_AUTH
								WHERE  AUTH_BIZ_CODE = BIZCODE AND
											 IS_DISABLED = 0;

				BEGIN

						--打开游标
						OPEN CURSOR_COMPANY;
						LOOP
								FETCH CURSOR_COMPANY
										INTO OWNERID, OENERTYPE;
								EXIT WHEN CURSOR_COMPANY%NOTFOUND;

								--过滤当前用户有权限的授权对象：
								IF OENERTYPE = '公司' OR OENERTYPE = '集团' THEN
										--AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
										SELECT COUNT(*)
										INTO   AUTHCOUNT
										FROM   SYS_BUSINESS_UNIT
										WHERE  IS_COMPANY = 1 AND
													 ID = COMPANYID
										START  WITH ID = OWNERID
										CONNECT BY PRIOR ID = PARENT_ID;
										IF AUTHCOUNT <> 0 THEN
												INSERT INTO TMP_AUTH_OWNER
														(ID, AUTH_OWNER_ID, AUTH_OWNER_TYPE)
												VALUES
														(SPID, OWNERID, OENERTYPE);

										END IF;

								END IF;

								IF OENERTYPE = '部门' THEN
										--AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
										SELECT COUNT(*)
										INTO   AUTHCOUNT
										FROM   SYS_BUSINESS_UNIT
										WHERE  IS_COMPANY = 0 AND
													 ID = DEPTID
										START  WITH ID = OWNERID
										CONNECT BY PRIOR ID = PARENT_ID;
										IF AUTHCOUNT <> 0 THEN
												INSERT INTO TMP_AUTH_OWNER
														(ID, AUTH_OWNER_ID, AUTH_OWNER_TYPE)
												VALUES
														(SPID, OWNERID, OENERTYPE);

										END IF;

								END IF;

								IF (OENERTYPE = '岗位' AND OWNERID = STATIONID) OR
									 (OENERTYPE = '人员' AND OWNERID = USERID) THEN

										INSERT INTO TMP_AUTH_OWNER
												(ID, AUTH_OWNER_ID, AUTH_OWNER_TYPE)
										VALUES
												(SPID, OWNERID, OENERTYPE);
								END IF;

						END LOOP;

						CLOSE CURSOR_COMPANY;

				END;

				--获取有权限的公司及其父级：            
				DECLARE
						OWNERID2 VARCHAR2(36);
						CURSOR CURSOR_AUTH IS
								SELECT AUTH_OWNER_ID FROM TMP_AUTH_OWNER WHERE ID = SPID;

				BEGIN

						--打开游标
						OPEN CURSOR_AUTH;
						LOOP
								FETCH CURSOR_AUTH
										INTO OWNERID2;
								EXIT WHEN CURSOR_AUTH%NOTFOUND;

								--授权对象为公司：
								--取授权公司的子级：
								INSERT INTO TMP_COMPANY_TREE
										(ID, ORG_ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
										 ORDER_CODE)
										SELECT SPID, ID, ORG_NAME, ORG_TYPE, PARENT_ID,
													 IS_COMPANY, ORDER_CODE
										FROM   SYS_BUSINESS_UNIT
										WHERE  IS_COMPANY = 1
										START  WITH ID IN
																(SELECT DISTINCT AUTH_SCOPE_ID
																 FROM   SYS_DATA_AUTH
																 WHERE  AUTH_BIZ_CODE = BIZCODE AND
																				IS_DISABLED = 0 AND
																				AUTH_OWNER_ID = OWNERID2 AND
																				AUTH_SCOPE_TYPE IN ('公司', '集团'))
										CONNECT BY PRIOR ID = PARENT_ID;

								--取授权公司的父级：
								INSERT INTO TMP_COMPANY_TREE
										(ID, ORG_ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
										 ORDER_CODE)
										SELECT SPID, ID, ORG_NAME, ORG_TYPE, PARENT_ID,
													 IS_COMPANY, ORDER_CODE
										FROM   SYS_BUSINESS_UNIT
										WHERE  IS_COMPANY = 1
										START  WITH ID IN
																(SELECT DISTINCT AUTH_SCOPE_ID
																 FROM   SYS_DATA_AUTH
																 WHERE  AUTH_BIZ_CODE = BIZCODE AND
																				IS_DISABLED = 0 AND
																				AUTH_OWNER_ID = OWNERID2 AND
																				AUTH_SCOPE_TYPE IN ('公司', '集团'))
										CONNECT BY PRIOR PARENT_ID = ID;

								--授权对应为部门：
								--取授权部门的父级：

								INSERT INTO TMP_COMPANY_TREE
										(ID, ORG_ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
										 ORDER_CODE)
										SELECT SPID, ID, ORG_NAME, ORG_TYPE, PARENT_ID,
													 IS_COMPANY, ORDER_CODE
										FROM   SYS_BUSINESS_UNIT
										WHERE  IS_COMPANY = 1
										START  WITH ID IN (SELECT DISTINCT AUTH_SCOPE_ID
																			 FROM   SYS_DATA_AUTH
																			 WHERE  AUTH_BIZ_CODE = BIZCODE AND
																							IS_DISABLED = 0 AND
																							AUTH_OWNER_ID = OWNERID2 AND
																							AUTH_SCOPE_TYPE = '部门')
										CONNECT BY PRIOR PARENT_ID = ID;
								--授权对应为项目：

								INSERT INTO TMP_COMPANY_TREE
										(ID, ORG_ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
										 ORDER_CODE)
										SELECT SPID, ID, ORG_NAME, ORG_TYPE, PARENT_ID,
													 IS_COMPANY, ORDER_CODE
										FROM   SYS_BUSINESS_UNIT
										WHERE  IS_COMPANY = 1
										START  WITH ID IN
																(SELECT UNIT_ID
																 FROM   SYS_PROJECT
																 WHERE  ID IN
																				(SELECT DISTINCT AUTH_SCOPE_ID
																				 FROM   SYS_DATA_AUTH
																				 WHERE  AUTH_BIZ_CODE = BIZCODE AND
																								IS_DISABLED = 0 AND
																								AUTH_OWNER_ID = OWNERID2 AND
																								AUTH_SCOPE_TYPE = '项目'))
										CONNECT BY PRIOR PARENT_ID = ID;

						END LOOP;
						CLOSE CURSOR_AUTH;
				END;

		END IF;
DATA_AUTH_SPID:=SPID;
--		OPEN DATA_AUTH_INFO FOR
--				SELECT DISTINCT ORG_ID AS ORGID, ORG_NAME AS ORGNAME,
--												ORG_TYPE AS ORGTYPE, PARENT_ID AS PARENTID,
--												1 AS ISCOMPANY, ORDER_CODE AS ORDERCODE
--				FROM   TMP_COMPANY_TREE
--				WHERE  ID = SPID AND
--							 ORG_ID IN (SELECT DISTINCT ID
--													FROM   SYS_BUSINESS_UNIT
--													START  WITH ID IN
--																			(SELECT ID
--																			 FROM   (SELECT UNIT_ID AS ID
--																								FROM   SYS_PROJECT
--																								UNION
--																								SELECT SUBORDINATE_COMPANY_ID AS ID
--																								FROM   CDB_FEASIBLE_PROJECT_CONFIG) DS)
--													CONNECT BY PRIOR PARENT_ID = ID)
--				ORDER  BY TO_NUMBER(ORDER_CODE);

END P_SYS_GET_COMPANY_PROJ_SPID;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_GET_COMPANY_TREE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_SYS_GET_COMPANY_TREE" (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    data_auth_info   OUT              SYS_REFCURSOR
) AS
--获取公司树
--作者：谷国斌
--日期：2019/12/13
    rulevalue   VARCHAR2(50);
    authcount   INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    spid        VARCHAR2(36);--使用临时表的批次号
BEGIN
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;
--插入集团作为根节点

    INSERT INTO tmp_company_tree (
        id,
        org_id,
        org_name,
        org_type,
        parent_id,
        is_company,
        order_code
    )
        SELECT
            spid,
            id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_hierarchy_code
        FROM
            sys_business_unit
        WHERE
            id = '003200000000000000000000000000';

--获取隔离规则：

    SELECT
        isolation_rule_value
    INTO rulevalue
    FROM
        sys_data_auth_biz
    WHERE
        biz_obj_code = bizcode;

    IF rulevalue = '全集团' THEN
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                is_company,
                order_hierarchy_code
            FROM
                sys_business_unit
            WHERE
                is_company = 1;

    ELSE 
--插入本公司及其父级
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                is_company,
                order_hierarchy_code
            FROM
                sys_business_unit
            WHERE
                is_company = 1
            START WITH
                id = companyid
            CONNECT BY
                PRIOR parent_id = id;

--插入数据授权的数据：

        DECLARE
            ownerid     VARCHAR2(36);
            oenertype   NVARCHAR2(50);
            CURSOR cursor_company IS
            SELECT DISTINCT
                auth_owner_id,
                auth_owner_type
            FROM
                sys_data_auth
            WHERE
                auth_biz_code = bizcode
                AND is_disabled = 0;

        BEGIN   

            --打开游标
            OPEN cursor_company;
            LOOP
                FETCH cursor_company INTO
                    ownerid,
                    oenertype;
                EXIT WHEN cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                IF oenertype = '公司' OR oenertype = '集团' THEN
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                        AND id = companyid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF oenertype = '部门' THEN
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 0
                        AND id = deptid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                    INSERT INTO tmp_auth_owner (
                        id,
                        auth_owner_id,
                        auth_owner_type
                    ) VALUES (
                        spid,
                        ownerid,
                        oenertype
                    );

                END IF;

            END LOOP;

            CLOSE cursor_company;
        END;   

          --获取有权限的公司及其父级：            

        DECLARE
            ownerid2 VARCHAR2(36);
            CURSOR cursor_auth IS
            SELECT
                auth_owner_id
            FROM
                tmp_auth_owner
            WHERE
                id = spid;

        BEGIN   

                    --打开游标
            OPEN cursor_auth;
            LOOP
                FETCH cursor_auth INTO ownerid2;
                EXIT WHEN cursor_auth%notfound;


                            --授权对象为公司：
                            --取授权公司的子级：
                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type IN (
                                    '公司',
                                    '集团'
                                )
                        )
                    CONNECT BY
                        PRIOR id = parent_id;


                            --取授权公司的父级：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type IN (
                                    '公司',
                                    '集团'
                                )
                        )
                    CONNECT BY
                        PRIOR parent_id = id;

                             --授权对应为部门：
                               --取授权部门的父级：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type = '部门'
                        )
                    CONNECT BY
                        PRIOR parent_id = id;
                               --授权对应为项目：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT
                                unit_id
                            FROM
                                sys_project
                            WHERE
                                id IN (
                                    SELECT DISTINCT
                                        auth_scope_id
                                    FROM
                                        sys_data_auth
                                    WHERE
                                        auth_biz_code = bizcode
                                        AND is_disabled = 0
                                        AND auth_owner_id = ownerid2
                                        --20200516 chenl 组织鉴权，按项目范围授权，单个项目 auth_scope_type 第一次保存错误"集团"，兼容改类数据
                                        AND (auth_scope_type = '项目' or auth_type='项目')
                                )
                        )
                    CONNECT BY
                        PRIOR parent_id = id;

            END LOOP;

            CLOSE cursor_auth;
        END;

    END IF;

    OPEN data_auth_info FOR SELECT DISTINCT
                               org_id       AS orgid,
                               org_name     AS orgname,
                               org_type     AS orgtype,
                               parent_id    AS parentid,
                               is_company   AS iscompany,
                               order_code   AS ordercode
                           FROM
                               tmp_company_tree
                           WHERE
                               id = spid
                           ORDER BY
                               order_code;

END p_sys_get_company_tree;

---------------------------------chenl 结束---------1389 [20200511-20200515]-16:用户只授权了项目权限，在选择项目时，不能选择公司，导致项目无法选择

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_GET_COMPANY_TREE_PROJ
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_SYS_GET_COMPANY_TREE_PROJ" (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    data_auth_info   OUT              SYS_REFCURSOR
) AS
--获取有项目的公司树
--作者：谷国斌
--日期：2019/12/13
    rulevalue   VARCHAR2(50);
    authcount   INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    spid        VARCHAR2(36);--使用临时表的批次号
BEGIN
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;
--插入集团作为根节点

    INSERT INTO tmp_company_tree (
        id,
        org_id,
        org_name,
        org_type,
        parent_id,
        is_company,
        order_code
    )
        SELECT
            spid,
            id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_hierarchy_code
        FROM
            sys_business_unit
        WHERE
            id = '003200000000000000000000000000';

--获取隔离规则：

    SELECT
        isolation_rule_value
    INTO rulevalue
    FROM
        sys_data_auth_biz
    WHERE
        biz_obj_code = bizcode;

    IF rulevalue = '全集团' THEN
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                is_company,
                order_hierarchy_code
            FROM
                sys_business_unit
            WHERE
                is_company = 1;

    ELSE 
--插入本公司及其父级
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                is_company,
                order_hierarchy_code
            FROM
                sys_business_unit
            WHERE
                is_company = 1
            START WITH
                id = companyid
            CONNECT BY
                PRIOR parent_id = id;

--插入数据授权的数据：

        DECLARE
            ownerid     VARCHAR2(36);
            oenertype   NVARCHAR2(50);
            CURSOR cursor_company IS
            SELECT DISTINCT
                auth_owner_id,
                auth_owner_type
            FROM
                sys_data_auth
            WHERE
                auth_biz_code = bizcode
                AND is_disabled = 0;

        BEGIN   

            --打开游标
            OPEN cursor_company;
            LOOP
                FETCH cursor_company INTO
                    ownerid,
                    oenertype;
                EXIT WHEN cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                IF oenertype = '公司' OR oenertype = '集团' THEN
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                        AND id = companyid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF oenertype = '部门' THEN
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 0
                        AND id = deptid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                    INSERT INTO tmp_auth_owner (
                        id,
                        auth_owner_id,
                        auth_owner_type
                    ) VALUES (
                        spid,
                        ownerid,
                        oenertype
                    );

                END IF;

            END LOOP;

            CLOSE cursor_company;
        END;   

          --获取有权限的公司及其父级：            

        DECLARE
            ownerid2 VARCHAR2(36);
            CURSOR cursor_auth IS
            SELECT
                auth_owner_id
            FROM
                tmp_auth_owner
            WHERE
                id = spid;

        BEGIN   

                    --打开游标
            OPEN cursor_auth;
            LOOP
                FETCH cursor_auth INTO ownerid2;
                EXIT WHEN cursor_auth%notfound;


                            --授权对象为公司：
                            --取授权公司的子级：
                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type IN (
                                    '公司',
                                    '集团'
                                )
                        )
                    CONNECT BY
                        PRIOR id = parent_id;


                            --取授权公司的父级：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type IN (
                                    '公司',
                                    '集团'
                                )
                        )
                    CONNECT BY
                        PRIOR parent_id = id;

                             --授权对应为部门：
                               --取授权部门的父级：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type = '部门'
                        )
                    CONNECT BY
                        PRIOR parent_id = id;
                               --授权对应为项目：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT
                                unit_id
                            FROM
                                sys_project
                            WHERE
                                id IN (
                                    SELECT DISTINCT
                                        auth_scope_id
                                    FROM
                                        sys_data_auth
                                    WHERE
                                        auth_biz_code = bizcode
                                        AND is_disabled = 0
                                        AND auth_owner_id = ownerid2
                                        --20200516 chenl 组织鉴权，按项目范围授权，单个项目 auth_scope_type 第一次保存错误"集团"，兼容改类数据
                                        AND (auth_scope_type = '项目' or auth_type='项目')
                                )
                        )
                    CONNECT BY
                        PRIOR parent_id = id;

            END LOOP;

            CLOSE cursor_auth;
        END;

    END IF;

    OPEN data_auth_info FOR SELECT DISTINCT
                               org_id       AS orgid,
                               org_name     AS orgname,
                               org_type     AS orgtype,
                               parent_id    AS parentid,
                               1 AS iscompany,
                               order_code   AS ordercode
                           FROM
                               tmp_company_tree
                           WHERE
                               id = spid
                               AND org_id IN (
                                   SELECT DISTINCT
                                       id
                                   FROM
                                       sys_business_unit
                                   START WITH
                                       id IN (
                                           SELECT
                                               id
                                           FROM
                                               (
                                                   SELECT
                                                       unit_id AS id
                                                   FROM
                                                       sys_project
                                                   UNION
                                                   SELECT
                                                       subordinate_company_id AS id
                                                   FROM
                                                       cdb_feasible_project_config
                                               ) ds
                                       )
                                   CONNECT BY
                                       PRIOR parent_id = id
                               )
                           ORDER BY
                               order_code;

END p_sys_get_company_tree_proj;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_GET_COMPANY_TREE_SPID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_SYS_GET_COMPANY_TREE_SPID" ( USERID IN VARCHAR2, STATIONID IN VARCHAR2, DEPTID IN VARCHAR2, COMPANYID IN VARCHAR2, BIZCODE IN VARCHAR2 ,
DATA_AUTH_SPID OUT varchar2) 
AS
--获取公司树
--作者：谷国斌
--日期：2019/12/13
RULEVALUE varchar2(50);
AUTHCOUNT INT;--用于判断当前公司、部门是否与数据授权的主体有关系
SPID VARCHAR2(36);--使用临时表的批次号
BEGIN
   SELECT
        get_uuid()
    INTO spid
    FROM
        dual;
--插入集团作为根节点

    INSERT INTO tmp_company_tree (
        id,
        org_id,
        org_name,
        org_type,
        parent_id,
        is_company,
        order_code
    )
        SELECT
            spid,
            id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_hierarchy_code
        FROM
            sys_business_unit
        WHERE
            id = '003200000000000000000000000000';

--获取隔离规则：

    SELECT
        isolation_rule_value
    INTO rulevalue
    FROM
        sys_data_auth_biz
    WHERE
        biz_obj_code = bizcode;

    IF rulevalue = '全集团' THEN
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                is_company,
                order_hierarchy_code
            FROM
                sys_business_unit
            WHERE
                is_company = 1;

    ELSE 
--插入本公司及其父级
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                is_company,
                order_hierarchy_code
            FROM
                sys_business_unit
            WHERE
                is_company = 1
            START WITH
                id = companyid
            CONNECT BY
                PRIOR parent_id = id;

--插入数据授权的数据：

        DECLARE
            ownerid     VARCHAR2(36);
            oenertype   NVARCHAR2(50);
            CURSOR cursor_company IS
            SELECT DISTINCT
                auth_owner_id,
                auth_owner_type
            FROM
                sys_data_auth
            WHERE
                auth_biz_code = bizcode
                AND is_disabled = 0;

        BEGIN   

            --打开游标
            OPEN cursor_company;
            LOOP
                FETCH cursor_company INTO
                    ownerid,
                    oenertype;
                EXIT WHEN cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                IF oenertype = '公司' OR oenertype = '集团' THEN
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                        AND id = companyid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF oenertype = '部门' THEN
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 0
                        AND id = deptid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                    INSERT INTO tmp_auth_owner (
                        id,
                        auth_owner_id,
                        auth_owner_type
                    ) VALUES (
                        spid,
                        ownerid,
                        oenertype
                    );

                END IF;

            END LOOP;

            CLOSE cursor_company;
        END;   

          --获取有权限的公司及其父级：            

        DECLARE
            ownerid2 VARCHAR2(36);
            CURSOR cursor_auth IS
            SELECT
                auth_owner_id
            FROM
                tmp_auth_owner
            WHERE
                id = spid;

        BEGIN   

                    --打开游标
            OPEN cursor_auth;
            LOOP
                FETCH cursor_auth INTO ownerid2;
                EXIT WHEN cursor_auth%notfound;


                            --授权对象为公司：
                            --取授权公司的子级：
                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type IN (
                                    '公司',
                                    '集团'
                                )
                        )
                    CONNECT BY
                        PRIOR id = parent_id;


                            --取授权公司的父级：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type IN (
                                    '公司',
                                    '集团'
                                )
                        )
                    CONNECT BY
                        PRIOR parent_id = id;

                             --授权对应为部门：
                               --取授权部门的父级：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type = '部门'
                        )
                    CONNECT BY
                        PRIOR parent_id = id;
                               --授权对应为项目：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT
                                unit_id
                            FROM
                                sys_project
                            WHERE
                                id IN (
                                    SELECT DISTINCT
                                        auth_scope_id
                                    FROM
                                        sys_data_auth
                                    WHERE
                                        auth_biz_code = bizcode
                                        AND is_disabled = 0
                                        AND auth_owner_id = ownerid2
                                        AND auth_scope_type = '项目'
                                )
                        )
                    CONNECT BY
                        PRIOR parent_id = id;

            END LOOP;

            CLOSE cursor_auth;
        END;

    END IF;
DATA_AUTH_SPID:=spid;
--    OPEN data_auth_info FOR SELECT DISTINCT
--                               org_id       AS orgid,
--                               org_name     AS orgname,
--                               org_type     AS orgtype,
--                               parent_id    AS parentid,
--                               is_company   AS iscompany,
--                               order_code   AS ordercode
--                           FROM
--                               tmp_company_tree
--                           WHERE
--                               id = spid
--                           ORDER BY
--                               order_code;

END P_SYS_GET_COMPANY_TREE_SPID;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_GET_DPT_TREE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_SYS_GET_DPT_TREE" (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    data_auth_info   OUT              SYS_REFCURSOR
) AS
--获取有权限的公司部门树
--作者：谷国斌
--日期：2019/12/13
    rulevalue   VARCHAR2(50);
    authcount   INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    spid        VARCHAR2(36);--使用临时表的批次号
BEGIN
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;

--IS_COMPANY在这个存储过程中调整为判断是否有权限使用，如本部门时，不能看父级部门的数据。
--获取隔离规则：

    SELECT
        isolation_rule_value
    INTO rulevalue
    FROM
        sys_data_auth_biz
    WHERE
        biz_obj_code = bizcode;

    IF rulevalue = '全集团' THEN
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                0,
                order_hierarchy_code
            FROM
                sys_business_unit;

    ELSE
        BEGIN
            IF rulevalue = '本公司' THEN
--插入本公司及其部门
                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        0,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    START WITH
                        id = companyid
                    CONNECT BY PRIOR id = parent_id
                               AND is_company = 0;

            ELSE  
--插入本公司及当前部门
                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        0,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        id = companyid;

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        CASE
                            WHEN id = deptid THEN
                                0
                            ELSE
                                1
                        END AS is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    START WITH
                        id = deptid
                    CONNECT BY PRIOR parent_id = id
                               AND is_company = 0;

            END IF;   
--插入数据授权的数据：

            DECLARE
                ownerid     VARCHAR2(36);
                oenertype   NVARCHAR2(50);
                CURSOR cursor_company IS
                SELECT DISTINCT
                    auth_owner_id,
                    auth_owner_type
                FROM
                    sys_data_auth
                WHERE
                    auth_biz_code = bizcode
                    AND is_disabled = 0
                    AND auth_type = '部门';

            BEGIN   

            --打开游标
                OPEN cursor_company;
                LOOP
                    FETCH cursor_company INTO
                        ownerid,
                        oenertype;
                    EXIT WHEN cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                    IF oenertype = '公司' OR oenertype = '集团' THEN
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                        SELECT
                            COUNT(*)
                        INTO authcount
                        FROM
                            sys_business_unit
                        WHERE
                            is_company = 1
                            AND id = companyid
                        START WITH
                            id = ownerid
                        CONNECT BY
                            PRIOR id = parent_id;

                        IF authcount <> 0 THEN
                            INSERT INTO tmp_auth_owner (
                                id,
                                auth_owner_id,
                                auth_owner_type
                            ) VALUES (
                                spid,
                                ownerid,
                                oenertype
                            );

                        END IF;

                    END IF;

                    IF oenertype = '部门' THEN
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                        SELECT
                            COUNT(*)
                        INTO authcount
                        FROM
                            sys_business_unit
                        WHERE
                            is_company = 0
                            AND id = deptid
                        START WITH
                            id = ownerid
                        CONNECT BY
                            PRIOR id = parent_id;

                        IF authcount <> 0 THEN
                            INSERT INTO tmp_auth_owner (
                                id,
                                auth_owner_id,
                                auth_owner_type
                            ) VALUES (
                                spid,
                                ownerid,
                                oenertype
                            );

                        END IF;

                    END IF;

                    IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END LOOP;

                CLOSE cursor_company;
            END;   

          --获取有权限的公司及其部门：            

            DECLARE
                ownerid2 VARCHAR2(36);
                CURSOR cursor_auth IS
                SELECT
                    auth_owner_id
                FROM
                    tmp_auth_owner
                WHERE
                    id = spid;

            BEGIN   

                    --打开游标
                OPEN cursor_auth;
                LOOP
                    FETCH cursor_auth INTO ownerid2;
                    EXIT WHEN cursor_auth%notfound;


                            --授权对象为公司：
                            --取授权公司的子级：
                    INSERT INTO tmp_company_tree (
                        id,
                        org_id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_code
                    )
                        SELECT
                            spid,
                            id,
                            org_name,
                            org_type,
                            parent_id,
                            0,
                            order_hierarchy_code
                        FROM
                            sys_business_unit
                        START WITH
                            id IN (
                                SELECT DISTINCT
                                    auth_scope_id
                                FROM
                                    sys_data_auth
                                WHERE
                                    auth_biz_code = bizcode
                                    AND is_disabled = 0
                                    AND auth_owner_id = ownerid2
                                    AND auth_scope_type IN (
                                        '公司',
                                        '集团'
                                    )
                                    AND auth_type = '部门'
                            )
                        CONNECT BY
                            PRIOR id = parent_id;


                             --授权对象为部门：
                               --取授权部门及其子级：

                    INSERT INTO tmp_company_tree (
                        id,
                        org_id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_code
                    )
                        SELECT
                            spid,
                            id,
                            org_name,
                            org_type,
                            parent_id,
                            0,
                            order_hierarchy_code
                        FROM
                            sys_business_unit
                        START WITH
                            id IN (
                                SELECT DISTINCT
                                    auth_scope_id
                                FROM
                                    sys_data_auth
                                WHERE
                                    auth_biz_code = bizcode
                                    AND is_disabled = 0
                                    AND auth_owner_id = ownerid2
                                    AND auth_scope_type = '部门'
                                    AND auth_type = '部门'
                            )
                        CONNECT BY
                            PRIOR id = parent_id;

                END LOOP;

                CLOSE cursor_auth;
            END;

        END;
    END IF;

    OPEN data_auth_info FOR SELECT DISTINCT
                               org_id       AS orgid,
                               org_name     AS orgname,
                               org_type     AS orgtype,
                               parent_id    AS parentid,
                               is_company   AS isdisable,
                               CASE
                                   WHEN org_type = 0 THEN
                                       1
                                   ELSE
                                       0
                               END AS iscompany,
                               order_code   AS ordercode
                           FROM
                               tmp_company_tree
                           WHERE
                               id = spid
                           ORDER BY
                               order_code;

END p_sys_get_dpt_tree;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_GET_HAS_PROJ_TREE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_SYS_GET_HAS_PROJ_TREE" (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    data_auth_info   OUT              SYS_REFCURSOR
) AS
    --获取有权限的公司树
    --作者：韩金明
    --日期：2020年5月9日
    ruleValue   VARCHAR2(50);
    ruleOrgId        VARCHAR2(36);--使用临时表的批次号
BEGIN
    SELECT isolation_rule_value INTO rulevalue FROM sys_data_auth_biz WHERE biz_obj_code = bizcode;
    if ruleValue = '全集团' then
        ruleOrgId := '003200000000000000000000000000';
    end if;
    if ruleValue = '本公司' then
        ruleOrgId := companyId;
    end if;
    if ruleValue = '本部门' then
        ruleOrgId := deptid;
    end if;
    open data_auth_info for with t1 as (
        -- 获取所有权限公司id
        select *
        from SYS_DATA_AUTH sda
        where instr(userId||','|| stationId || ',' || deptId || ',' || companyId, sda.AUTH_OWNER_ID) > 0
          and nvl(sda.AUTH_TYPE, '项目') = '项目' and sda.AUTH_BIZ_CODE=bizCode
    ), t2 as (
        -- 加上隔离规则id
        select AUTH_SCOPE_ID from t1
        union
        select ruleOrgId from dual
    ), t3 as (
        -- 查询公司的下面所有子公司
        select distinct *
        from SYS_BUSINESS_UNIT sbu
        where IS_COMPANY = 1
        start with sbu.id in (select AUTH_SCOPE_ID from t2)
        connect by prior sbu.id = sbu.PARENT_ID
    ), t4 as (
        --查询项目不为空的公司ID
        select t3.*, mp.id mid, mp.PROJECT_NAME, mp.COMPANY_ID mParentId,
               mp.ORDER_HIERARCHY_CODE as pCode
        from t3 left join MDM_PROJECT mp on t3.ID = mp.COMPANY_ID
        where mp.ID is not null and mp.IS_DELETE = 0
        )
        select
            distinct ID orgId,
            ORG_NAME orgName,
            ORG_TYPE orgType,
            PARENT_ID parentId,
            IS_COMPANY isCompany,
            ORDER_HIERARCHY_CODE || '' orderCode
        from SYS_BUSINESS_UNIT sbu
        start with sbu.ID in (select ID from t4)
        connect by prior sbu.PARENT_ID = sbu.ID
        union
        select
            distinct ID orgId,
            t4.PROJECT_NAME orgName,
            '10' orgType,
            t4.COMPANY_ID parentId,
            0 isCompany,
            pCode || '' orderCode
        from t4;
END P_SYS_GET_HAS_PROJ_TREE;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_GET_ISOLATION_ID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_SYS_GET_ISOLATION_ID" 
(
		USER_ID           IN VARCHAR2
	 ,STATION_ID        IN VARCHAR2
	 ,DEPT_ID           IN VARCHAR2
	 ,COMPANY_ID        IN VARCHAR2
	 ,BIZ_CODE          IN VARCHAR2
	 ,OUT_AUTH_SCOPE_ID OUT VARCHAR2
) AS
		--隔离规则鉴权
		--作者：徐峰
		--日期：2019/12/14
BEGIN

		SELECT AUTH_SCOPE_ID
		INTO   OUT_AUTH_SCOPE_ID
		FROM   (SELECT CASE ISOLATION_RULE_VALUE
												 WHEN '全集团' THEN
													'集团'
												 WHEN '本公司' THEN
													COMPANY_ID
												 WHEN '本部门' THEN
													DEPT_ID
												 WHEN '本岗位' THEN
													STATION_ID
												 WHEN '本岗位' THEN
													USER_ID
												 ELSE
													''
										 END AS AUTH_SCOPE_ID
						 FROM   SYS_DATA_AUTH_BIZ
						 WHERE  BIZ_OBJ_CODE = BIZ_CODE);

END;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_GET_PROJ_STAGE_TREE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_SYS_GET_PROJ_STAGE_TREE" (
     userid           IN               VARCHAR2,
     stationid        IN               VARCHAR2,
     deptid           IN               VARCHAR2,
     companyid        IN               VARCHAR2,
     bizcode          IN               VARCHAR2,
     data_auth_info   OUT              SYS_REFCURSOR
 ) AS
 --获取有权限的项目树
 --作者：谢松宏
 --日期：2020/04/10
     rulevalue   VARCHAR2(50);
     authcount   INT;--用于判断当前公司、部门是否与数据授权的主体有关系
     spid        VARCHAR2(36);--使用临时表的批次号
 BEGIN
     SELECT
         get_uuid()
     INTO spid
     FROM
         dual;

 --获取隔离规则：

     SELECT
         isolation_rule_value
     INTO rulevalue
     FROM
         sys_data_auth_biz
     WHERE
             biz_obj_code = bizcode;

     IF rulevalue = '全集团' THEN
         INSERT INTO tmp_proj_tree (
             id,
             org_id,
             org_name,
             org_type,
             parent_id,
             full_name,
             is_end,
             city_name,
             company_id,
             order_code
         )
         SELECT
             spid,
             org_id,
             org_name,
             org_type,
             parent_id,
             full_name,
             is_end,
             city_name,
             company_id,
             sn
         FROM
             V_SYS_PROJECT_STAGE_TREE;

     ELSE
 --插入本公司的项目
         INSERT INTO tmp_proj_tree (
             id,
             org_id,
             org_name,
             org_type,
             parent_id,
             full_name,
             is_end,
             city_name,
             company_id,
             order_code
         )
         SELECT
             spid,
             org_id,
             org_name,
             org_type,
             parent_id,
             full_name,
             is_end,
             city_name,
             company_id,
             sn
         FROM
             V_SYS_PROJECT_STAGE_TREE
         WHERE
                 company_id = companyid;

 --插入数据授权的数据：

         DECLARE
             ownerid     VARCHAR2(36);
             oenertype   NVARCHAR2(50);
             CURSOR cursor_company IS
                 SELECT DISTINCT
                     auth_owner_id,
                     auth_owner_type
                 FROM
                     sys_data_auth
                 WHERE
                         auth_biz_code = bizcode
                   AND is_disabled = 0
                   AND nvl(auth_type, '项目') = '项目';

         BEGIN

             --打开游标
             OPEN cursor_company;
             LOOP
                 FETCH cursor_company INTO
                     ownerid,
                     oenertype;
                 EXIT WHEN cursor_company%notfound;

                 --过滤当前用户有权限的授权对象：
                 IF oenertype = '公司' OR oenertype = '集团' THEN
                     --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                     SELECT
                         COUNT(*)
                     INTO authcount
                     FROM
                         sys_business_unit
                     WHERE
                             is_company = 1
                       AND id = companyid
                     START WITH
                             id = ownerid
                     CONNECT BY
                             PRIOR id = parent_id;

                     IF authcount <> 0 THEN
                         INSERT INTO tmp_auth_owner (
                             id,
                             auth_owner_id,
                             auth_owner_type
                         ) VALUES (
                                      spid,
                                      ownerid,
                                      oenertype
                                  );

                     END IF;

                 END IF;

                 IF oenertype = '部门' THEN
                     --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                     SELECT
                         COUNT(*)
                     INTO authcount
                     FROM
                         sys_business_unit
                     WHERE
                             is_company = 0
                       AND id = deptid
                     START WITH
                             id = ownerid
                     CONNECT BY
                             PRIOR id = parent_id;

                     IF authcount <> 0 THEN
                         INSERT INTO tmp_auth_owner (
                             id,
                             auth_owner_id,
                             auth_owner_type
                         ) VALUES (
                                      spid,
                                      ownerid,
                                      oenertype
                                  );

                     END IF;

                 END IF;

                 IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                     INSERT INTO tmp_auth_owner (
                         id,
                         auth_owner_id,
                         auth_owner_type
                     ) VALUES (
                                  spid,
                                  ownerid,
                                  oenertype
                              );

                 END IF;

             END LOOP;

             CLOSE cursor_company;
         END;

         --获取有权限的公司及其父级：            

         DECLARE
             ownerid2 VARCHAR2(36);
             CURSOR cursor_auth IS
                 SELECT
                     auth_owner_id
                 FROM
                     tmp_auth_owner
                 WHERE
                         id = spid;

         BEGIN

             --打开游标
             OPEN cursor_auth;
             LOOP
                 FETCH cursor_auth INTO ownerid2;
                 EXIT WHEN cursor_auth%notfound;


                 --授权对象为公司：
                 --取授权公司的子级：
                 INSERT INTO tmp_proj_tree (
                     id,
                     org_id,
                     org_name,
                     org_type,
                     parent_id,
                     full_name,
                     is_end,
                     city_name,
                     company_id,
                     order_code
                 )
                 SELECT
                     spid,
                     org_id,
                     org_name,
                     org_type,
                     parent_id,
                     full_name,
                     is_end,
                     city_name,
                     company_id,
                     sn
                 FROM
                     V_SYS_PROJECT_STAGE_TREE
                 WHERE
                         company_id IN (
                         SELECT
                             id
                         FROM
                             sys_business_unit
                         WHERE
                                 is_company = 1
                         START WITH
                                 id IN (
                                 SELECT DISTINCT
                                     auth_scope_id
                                 FROM
                                     sys_data_auth
                                 WHERE
                                         auth_biz_code = bizcode
                                   AND is_disabled = 0
                                   AND auth_owner_id = ownerid2
                                   AND auth_scope_type IN (
                                                           '公司',
                                                           '集团'
                                     )
                                   AND nvl(auth_type, '项目') = '项目'
                             )
                         CONNECT BY
                                 PRIOR id = parent_id
                     );



                 --授权对应为项目：

                 INSERT INTO tmp_proj_tree (
                     id,
                     org_id,
                     org_name,
                     org_type,
                     parent_id,
                     full_name,
                     is_end,
                     city_name,
                     company_id,
                     order_code
                 )
                 SELECT
                     spid,
                     org_id,
                     org_name,
                     org_type,
                     parent_id,
                     full_name,
                     is_end,
                     city_name,
                     company_id,
                     sn
                 FROM
                     V_SYS_PROJECT_STAGE_TREE
                 WHERE
                         project_id IN (
                         SELECT DISTINCT
                             auth_scope_id
                         FROM
                             sys_data_auth
                         WHERE
                                 auth_biz_code = bizcode
                           AND is_disabled = 0
                           AND auth_owner_id = ownerid2
                           AND auth_scope_type = '项目'
                           AND nvl(auth_type, '项目') = '项目'
                     );

             END LOOP;

             CLOSE cursor_auth;
         END;

     END IF;

     OPEN data_auth_info FOR SELECT DISTINCT
                                 a.org_id         AS orgid,
                                 a.org_name       AS orgname,
                                 a.org_type       AS orgtype,
                                 a.parent_id      AS parentid,
                                 a.full_name      AS fullname,
                                 a.is_end         AS isend,
                                 a.city_name      AS cityname,
                                 a.company_id     AS companyid,
                                 b.company_type   AS companytype,
                                 a.order_code     AS ordercode
                             FROM
                                 tmp_proj_tree       a
                                     LEFT JOIN sys_business_unit   b ON a.org_id = b.id
                             ORDER BY
                                 a.order_code;

 END p_sys_get_proj_stage_tree;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_GET_PROJ_TREE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_SYS_GET_PROJ_TREE" (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    data_auth_info   OUT              SYS_REFCURSOR
) AS
--获取有权限的项目树
--作者：谷国斌
--日期：2019/12/14
    rulevalue   VARCHAR2(50);
    authcount   INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    spid        VARCHAR2(36);--使用临时表的批次号
BEGIN
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;

--获取隔离规则：

    SELECT
        isolation_rule_value
    INTO rulevalue
    FROM
        sys_data_auth_biz
    WHERE
        biz_obj_code = bizcode;

    IF rulevalue = '全集团' THEN
        INSERT INTO tmp_proj_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            full_name,
            is_end,
            city_name,
            company_id,
            order_code
        )
            SELECT
                spid,
                org_id,
                org_name,
                org_type,
                parent_id,
                full_name,
                is_end,
                city_name,
                company_id,
                sn
            FROM
                v_sys_project;

    ELSE 
--插入本公司的项目
        INSERT INTO tmp_proj_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            full_name,
            is_end,
            city_name,
            company_id,
            order_code
        )
            SELECT
                spid,
                org_id,
                org_name,
                org_type,
                parent_id,
                full_name,
                is_end,
                city_name,
                company_id,
                sn
            FROM
                v_sys_project
            WHERE
                company_id = companyid;

--插入数据授权的数据：

        DECLARE
            ownerid     VARCHAR2(36);
            oenertype   NVARCHAR2(50);
            CURSOR cursor_company IS
            SELECT DISTINCT
                auth_owner_id,
                auth_owner_type
            FROM
                sys_data_auth
            WHERE
                auth_biz_code = bizcode
                AND is_disabled = 0
                AND nvl(auth_type, '项目') = '项目';

        BEGIN   

            --打开游标
            OPEN cursor_company;
            LOOP
                FETCH cursor_company INTO
                    ownerid,
                    oenertype;
                EXIT WHEN cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                IF oenertype = '公司' OR oenertype = '集团' THEN
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                        AND id = companyid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF oenertype = '部门' THEN
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 0
                        AND id = deptid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                    INSERT INTO tmp_auth_owner (
                        id,
                        auth_owner_id,
                        auth_owner_type
                    ) VALUES (
                        spid,
                        ownerid,
                        oenertype
                    );

                END IF;

            END LOOP;

            CLOSE cursor_company;
        END;   

          --获取有权限的公司及其父级：            

        DECLARE
            ownerid2 VARCHAR2(36);
            CURSOR cursor_auth IS
            SELECT
                auth_owner_id
            FROM
                tmp_auth_owner
            WHERE
                id = spid;

        BEGIN   

                    --打开游标
            OPEN cursor_auth;
            LOOP
                FETCH cursor_auth INTO ownerid2;
                EXIT WHEN cursor_auth%notfound;


                            --授权对象为公司：
                            --取授权公司的子级：
                INSERT INTO tmp_proj_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    full_name,
                    is_end,
                    city_name,
                    company_id,
                    order_code
                )
                    SELECT
                        spid,
                        org_id,
                        org_name,
                        org_type,
                        parent_id,
                        full_name,
                        is_end,
                        city_name,
                        company_id,
                        sn
                    FROM
                        v_sys_project
                    WHERE
                        company_id IN (
                            SELECT
                                id
                            FROM
                                sys_business_unit
                            WHERE
                                is_company = 1
                            START WITH
                                id IN (
                                    SELECT DISTINCT
                                        auth_scope_id
                                    FROM
                                        sys_data_auth
                                    WHERE
                                        auth_biz_code = bizcode
                                        AND is_disabled = 0
                                        AND auth_owner_id = ownerid2
                                        AND auth_scope_type IN (
                                            '公司',
                                            '集团'
                                        )
                                        AND nvl(auth_type, '项目') = '项目'
                                )
                            CONNECT BY
                                PRIOR id = parent_id
                        );



                               --授权对应为项目：

                INSERT INTO tmp_proj_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    full_name,
                    is_end,
                    city_name,
                    company_id,
                    order_code
                )
                    SELECT
                        spid,
                        org_id,
                        org_name,
                        org_type,
                        parent_id,
                        full_name,
                        is_end,
                        city_name,
                        company_id,
                        sn
                    FROM
                        v_sys_project
                    WHERE
                        project_id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type = '项目'
                                AND nvl(auth_type, '项目') = '项目'
                        );

            END LOOP;

            CLOSE cursor_auth;
        END;

    END IF;

    OPEN data_auth_info FOR SELECT DISTINCT
                               a.org_id         AS orgid,
                               a.org_name       AS orgname,
                               a.org_type       AS orgtype,
                               a.parent_id      AS parentid,
                               a.full_name      AS fullname,
                               a.is_end         AS isend,
                               a.city_name      AS cityname,
                               a.company_id     AS companyid,
                               b.company_type   AS companytype,
                               a.order_code     AS ordercode
                           FROM
                               tmp_proj_tree       a
                               LEFT JOIN sys_business_unit   b ON a.org_id = b.id
                           ORDER BY
                               a.order_code;

END p_sys_get_proj_tree;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_GET_PROJ_TREE_SPID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_SYS_GET_PROJ_TREE_SPID" (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    auth_spid           OUT           VARCHAR2
) AS
--获取有权限的项目树
--作者：谷国斌
--日期：2019/12/14
    rulevalue   VARCHAR2(50);
    authcount   INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    spid        VARCHAR2(36);--使用临时表的批次号
BEGIN
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;

--获取隔离规则：

    SELECT
        isolation_rule_value
    INTO rulevalue
    FROM
        sys_data_auth_biz
    WHERE
        biz_obj_code = bizcode;

    IF rulevalue = '全集团' THEN
        INSERT INTO tmp_proj_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            full_name,
            is_end,
            city_name,
            company_id,
            order_code
        )
            SELECT
                spid,
                org_id,
                org_name,
                org_type,
                parent_id,
                full_name,
                is_end,
                city_name,
                company_id,
                sn
            FROM
                v_sys_project;

    ELSE 
--插入本公司的项目
        INSERT INTO tmp_proj_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            full_name,
            is_end,
            city_name,
            company_id,
            order_code
        )
            SELECT
                spid,
                org_id,
                org_name,
                org_type,
                parent_id,
                full_name,
                is_end,
                city_name,
                company_id,
                sn
            FROM
                v_sys_project
            WHERE
                company_id = companyid;

--插入数据授权的数据：

        DECLARE
            ownerid     VARCHAR2(36);
            oenertype   NVARCHAR2(50);
            CURSOR cursor_company IS
            SELECT DISTINCT
                auth_owner_id,
                auth_owner_type
            FROM
                sys_data_auth
            WHERE
                auth_biz_code = bizcode
                AND is_disabled = 0
                AND nvl(auth_type, '项目') = '项目';

        BEGIN   

            --打开游标
            OPEN cursor_company;
            LOOP
                FETCH cursor_company INTO
                    ownerid,
                    oenertype;
                EXIT WHEN cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                IF oenertype = '公司' OR oenertype = '集团' THEN
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                        AND id = companyid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF oenertype = '部门' THEN
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 0
                        AND id = deptid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                    INSERT INTO tmp_auth_owner (
                        id,
                        auth_owner_id,
                        auth_owner_type
                    ) VALUES (
                        spid,
                        ownerid,
                        oenertype
                    );

                END IF;

            END LOOP;

            CLOSE cursor_company;
        END;   

          --获取有权限的公司及其父级：            

        DECLARE
            ownerid2 VARCHAR2(36);
            CURSOR cursor_auth IS
            SELECT
                auth_owner_id
            FROM
                tmp_auth_owner
            WHERE
                id = spid;

        BEGIN   

                    --打开游标
            OPEN cursor_auth;
            LOOP
                FETCH cursor_auth INTO ownerid2;
                EXIT WHEN cursor_auth%notfound;


                            --授权对象为公司：
                            --取授权公司的子级：
                INSERT INTO tmp_proj_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    full_name,
                    is_end,
                    city_name,
                    company_id,
                    order_code
                )
                    SELECT
                        spid,
                        org_id,
                        org_name,
                        org_type,
                        parent_id,
                        full_name,
                        is_end,
                        city_name,
                        company_id,
                        sn
                    FROM
                        v_sys_project
                    WHERE
                        company_id IN (
                            SELECT
                                id
                            FROM
                                sys_business_unit
                            WHERE
                                is_company = 1
                            START WITH
                                id IN (
                                    SELECT DISTINCT
                                        auth_scope_id
                                    FROM
                                        sys_data_auth
                                    WHERE
                                        auth_biz_code = bizcode
                                        AND is_disabled = 0
                                        AND auth_owner_id = ownerid2
                                        AND auth_scope_type IN (
                                            '公司',
                                            '集团'
                                        )
                                        AND nvl(auth_type, '项目') = '项目'
                                )
                            CONNECT BY
                                PRIOR id = parent_id
                        );



                               --授权对应为项目：

                INSERT INTO tmp_proj_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    full_name,
                    is_end,
                    city_name,
                    company_id,
                    order_code
                )
                    SELECT
                        spid,
                        org_id,
                        org_name,
                        org_type,
                        parent_id,
                        full_name,
                        is_end,
                        city_name,
                        company_id,
                        sn
                    FROM
                        v_sys_project
                    WHERE
                        project_id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type = '项目'
                                AND nvl(auth_type, '项目') = '项目'
                        );

            END LOOP;
            CLOSE cursor_auth;
        END;
    END IF;
--    OPEN data_auth_info FOR SELECT DISTINCT
--                               a.org_id         AS orgid,
--                               a.org_name       AS orgname,
--                               a.org_type       AS orgtype,
--                               a.parent_id      AS parentid,
--                               a.full_name      AS fullname,
--                               a.is_end         AS isend,
--                               a.city_name      AS cityname,
--                               a.company_id     AS companyid,
--                               b.company_type   AS companytype,
--                               a.order_code     AS ordercode
--                           FROM
--                               tmp_proj_tree       a
--                               LEFT JOIN sys_business_unit   b ON a.org_id = b.id
--                           ORDER BY
--                               a.order_code;
        auth_spid:=spid;
END p_sys_get_proj_tree_spid;

/
--------------------------------------------------------
--  DDL for Procedure P_SYS_MSG_BY_TYPE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_SYS_MSG_BY_TYPE" ( isMobile in int,msgType IN VARCHAR2,systemId IN VARCHAR2,userName IN VARCHAR2,wherestr  IN VARCHAR2,datalist OUT SYS_REFCURSOR,total out int )
as
rowcountBySystemId  int;
whereSql VARCHAR2(200);
orderSql VARCHAR2(200);
systemWhereSql VARCHAR2(2000);
appid VARCHAR2(1000);
selectSql VARCHAR2(4000);
likeWhereSql  VARCHAR2(1000);
v_sql VARCHAR2(1000);
systemIds VARCHAR2(1000);
BEGIN
likeWhereSql:=' ';
/*判断是否传入筛选语句，传入格式为%条件%*/
if wherestr is not null then
likeWhereSql:=' and ( task_name like '''||wherestr||''' or  type_name like '''||wherestr||''')';
end if;
/*判断是否传入系统id条件，加入系统筛选*/
if systemId is not null then
   if instr(systemId,',',1,1) !=0 then
         systemIds:=''''||replace(systemId, ',', ''',''')||'''';
         execute immediate ' select count(1) from  SYS_APPLICATION  s where s.id in ('||systemIds||')' INTO  rowcountBySystemId;
          if rowcountBySystemId<>0 THEN
             execute immediate '  select  WMSYS.WM_CONCAT(APP_ID)  from  SYS_APPLICATION  s  where s.id in ('||systemIds||')' INTO  appid;
             appid:=''''||replace(appid, ',', ''',''')||'''';
             systemWhereSql:=' and SOURCE_APP_ID in ('||appid||')';
          end if;
    else
        select count(1) into rowcountBySystemId  from  SYS_APPLICATION  s
        where s.id=systemId;
        if rowcountBySystemId<>0 THEN
        select APP_ID into appid  from  SYS_APPLICATION  s
        where s.id=systemId;
        systemWhereSql:=' and SOURCE_APP_ID= '''||appid||'''';
        end if;
   end if;
end if;
/*根据传入类型不同展示不同的时间列*/
if msgType='todo' then
selectSql:=' SELECT
    {url},
   created as startTime,
    task_name as processInstName,
    CREATOR_NAME as partiName,
    remark  as activityInstName,
    type_name as processChName,
    CREATOR_NAME as sender
FROM
    sys_message_center where owner_name=  '''||userName||'''';
whereSql:=' and MSG_TYPE=0 and TASK_STATE=0';
ELSIF  msgType='haveTodo' then
selectSql:=' SELECT
    {url},
    complete_time as startTime,
    task_name as processInstName,
    CREATOR_NAME as partiName,
    remark  as activityInstName,
    type_name as processChName,
    CREATOR_NAME as sender
FROM
    sys_message_center where owner_name=  '''||userName||'''';
whereSql:=' and MSG_TYPE=0 and TASK_STATE=10';
orderSql:=' order by EXPIRE_TIME desc';
ELSIF  msgType='unRead' then
selectSql:=' SELECT
    {url},
    created as startTime,
    task_name as processInstName,
    cuser.user_name as partiName,
    remark  as activityInstName,
    type_name as processChName,
    cuser.user_name as sender
FROM
    sys_message_center 
    left join sys_user cuser 
    on sys_message_center.CREATOR_NAME=cuser.user_code 
    where owner_name=  '''||userName||'''';
whereSql:=' and MSG_TYPE=10 and TASK_STATE=0';
ELSIF  msgType='haveRead' then
selectSql:=' SELECT
    {url},
    complete_time as startTime,
    task_name as processInstName,
    cuser.user_name as partiName,
    remark  as activityInstName,
    type_name as processChName,
    cuser.user_name as sender
FROM
    sys_message_center 
    left join sys_user cuser 
    on sys_message_center.CREATOR_NAME=cuser.user_code 
    where owner_name=  '''||userName||'''';
whereSql:=' and MSG_TYPE=10 and TASK_STATE=10';
else
selectSql:=' SELECT
    {url},
    complete_time as startTime,
    task_name as processInstName,
    cuser.user_name as partiName,
    remark  as activityInstName,
    type_name as processChName,
    cuser.user_name as sender
FROM
    sys_message_center 
    left join sys_user cuser 
    on sys_message_center.CREATOR_NAME=cuser.user_code 
    where owner_name=  '''||userName||'''';
whereSql:=' and MSG_TYPE=20';
end if;
dbms_output.put_line(whereSql);
/*拼接sql*/
selectSql:=selectSql||whereSql||systemWhereSql||likeWhereSql;
/*根据传入是否为移动端来打开不同的地址*/
if isMobile=1 then
selectSql:=replace(selectSql,'{url}','mobile_url as url');
else
selectSql:=replace(selectSql,'{url}','pc_url as url');
end if;
dbms_output.put_line(selectSql);
  v_sql:= 'select count(*) FROM (' || selectSql || ')';
  EXECUTE IMMEDIATE v_sql INTO total;
OPEN datalist FOR selectSql;
EXCEPTION
WHEN OTHERS THEN
 CLOSE datalist;
end p_sys_msg_by_type;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_COMPONENT_BY_PAGE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_UDP_COMPONENT_BY_PAGE" (containerGuid in varchar,pageComponents OUT sys_refcursor,treeSelect OUT sys_refcursor,tabs OUT sys_refcursor,tableColumn OUT sys_refcursor,buttoneEvent OUT sys_refcursor,eventMonitoring OUT sys_refcursor,datePicker OUT sys_refcursor)
AS  
haspage INTEGER;
BEGIN  
select count(1) into haspage  from UDP_PAGE where ID=containerGuid;
if haspage=1
then
open pageComponents for  
select   c.ID componentId,                                                      --组件ID
p.ID containerGuid,                                                                --容器ID          
c.COMPONENT_HIGH componentHeight,                          --组件高度
c.COMPONENT_WIDE componentWidth,                            --组件宽度
p.TITLE  pageTitle,                                                                    --页面标题
p.WINDOW_WIDTH  windowWidth,                                      --打开窗口宽度
p.WINDOW_HEIGHT windowHeight,                                     --打开窗口高度
c.COMPONENT_ORDER,                                                           --展示顺序 
c.COMPONENT_NAME componentName,                           --组件名称
c.COMPONENT_LABLE lable,                                                   --组件展示标题
c.COMPONENT_TYPE componentType,                                --组件类型
c.PLACEHOLDER placeholder,                                                 --展示水印文字
p.LAYOUT_TEMPLATE_ID templateName,                              --使用模板名称
l.LAYOUT_AREA_TEMPLATE_ID regionMark,                        --使用区域标识名称
s.IS_CHECK,                                                                                 --是否能够多选
s.IS_CHECKED_LAST_STAGE,                                                    --是否只能选中最末级
 s.DEFAULT_VALUE,                                                                   --默认值
s.DATA_SOURCE_TYPE,                                                             --数据源类型
s.DATA_SOURCE componentSource,                                      --组件数据源
s.PK_FIELD,                                                                                    --主键字段
s.LABLE_FIELD,                                                                              --展示字段
c.DATA_SOURCE                                                                          --展示数据(TemplateHyperText、TemplateContainer)
 from  UDP_LAYOUT l  
 left join UDP_PAGE P on  l.page_id=p.ID
 left join UDP_COMPONENT c on  l.COMPONENT_ID=c.ID 
left join UDP_COMPONENT_DATA_SOURCE s on c.COMPONENT_DATA_SOURCE_ID=s.ID
where l.PAGE_ID=containerGuid and l.page_id=c.page_id order by c.COMPONENT_ORDER asc;
else
open pageComponents for  
select   c.ID componentId,                                                      --组件ID
containerGuid containerGuid,                                                 --容器ID         
c.COMPONENT_HIGH componentHeight,                          --组件高度
c.COMPONENT_WIDE componentWidth,                            --组件宽度
''  pageTitle,                                                                              --页面标题
''  windowWidth,                                                                       --打开窗口宽度
'' windowHeight,                                                                       --打开窗口高度
c.COMPONENT_ORDER ,                                                         --展示顺序 
c.COMPONENT_NAME componentName,                           --组件名称
c.COMPONENT_LABLE lable,                                                  --组件展示标题
c.COMPONENT_TYPE componentType,                               --组件类型
c.PLACEHOLDER placeholder,                                                --展示水印文字
'' templateName,                                                                        --模板名称
l.LAYOUT_AREA_TEMPLATE_ID regionMark,                       --使用区域标识名称
s.IS_CHECK,                                                                                --是否能够多选
s.IS_CHECKED_LAST_STAGE,                                                   --是否只能选中最末级
s.DEFAULT_VALUE ,                                                                   --默认值
s.DATA_SOURCE_TYPE,                                                             --数据源类型
s.DATA_SOURCE componentSource,                                      --组件数据源
s.PK_FIELD,                                                                                    --主键字段
s.LABLE_FIELD,                                                                              --展示字段
c.DATA_SOURCE                                                                       --展示数据(TemplateHyperText、TemplateContainer)
from UDP_COMPONENT c
left join UDP_LAYOUT l on  l.COMPONENT_ID=c.ID 
left join UDP_COMPONENT_DATA_SOURCE s on c.COMPONENT_DATA_SOURCE_ID=s.ID
where c.PAGE_ID=containerGuid order by c.COMPONENT_ORDER asc;
end if;

open treeSelect for  
select  
c.id componentId,                                                                     --组件ID
containerGuid containerGuid,                                                 --容器ID       
 t.default_expanded,                                                                --默认展开
t.default_checked,                                                                      --默认选中
t.IS_CHECKED_LAST_STAGE                                                      --是否只能选中最末级
from  UDP_COMPONENT c 
left join UDP_COMPONENT_TREE_SELECT t on t.ID=c.id
where c.page_id=containerGuid and (c.component_type='TemplateTreeSelect') ;


open tabs for  
select  
c.id componentId,                                                               --组件ID
t.default_tabsitem,                                                              --默认选中项
t.layout_style,                                                                       --默认样式
i.ITEM_VALUE,                                                                       --tabs组件的项具体值
i.ITEM_LABLE,                                                                        --tabs组件的项展示值
i.ID                                                                                          --tabs组件的项ID
from  UDP_COMPONENT c 
left join UDP_COMPONENT_TABS t on t.ID=c.id
left join UDP_COMPONENT_TABS_ITEM i on t.ID=i.COMPONENT_TABS_ID
where c.page_id=containerGuid and (c.component_type='TemplateTabs') order by i.item_order;

open tableColumn for
select 
n.ID,
c.ID componentId,                                                     --组件ID
n.COLUMN_LABLE,                                                     --列标题
n.COLUMN_FIELD  ,                                                    --列字段名
n.COLUMN_WIDE ,                                                     --列宽度
n.COLUMN_ALIGN ,                                                   --列对齐
n.COLUMN_FIXED ,                                                    --浮动反方向（left,right）
2 COLUMN_NUMBER_FLOAT,                               --小数字段保留几位
n.COLUMN_DATA_TYPE ,                                         --数据类型
n.is_show_total,                                                          --是否显示合计
n.parent_column_id,                                                  --父级列主键
n.is_use_sort,                                                              --是否使用排序
d.IS_CHECK,                                                                 --是否复选
t.detail_url,                                                                   --双击行跳转地址
d.PK_FIELD,                                                                  --主键字段
n.JUMP_URL,                                                               --点击列跳转地址
n.OPEN_MODE,                                                           --点击列打开页面方式
t.OPEN_MODE DETAIL_MODE,                                          --双击行打开页面方式
n.WINDOW_WIDTH,                                                   --单击列打开弹窗的宽度
n.WINDOW_HEIGHT,                                                   --单击列打开弹窗的高度
n.DEAL_WITH_MODE,                                                  --单击列处理的模式
t.WINDOW_WIDTH as "ROW_WINDOW_WIDTH",                              --双击行打开弹窗的宽度
t.WINDOW_HEIGHT as "ROW_WINDOW_HEIGHT",                             --双击行打开弹窗的高度
n.IS_USE_HTML,                                                     --是否使用html
case  when t.IS_SHOW_PAGINATION is null
then 1 else t.IS_SHOW_PAGINATION end IS_SHOW_PAGINATION,           --是否显示分页
case  when t.IS_SHOW_BORDER is null
then 1 else t.IS_SHOW_BORDER end IS_SHOW_BORDER,                   --是否显示边框
case  when t.IS_SHOW_STRIPE is null
then 1 else t.IS_SHOW_STRIPE end is_show_stripe                    --是否显示斑马纹
from UDP_COMPONENT c 
left join UDP_COMPONENT_TABLE_COLUMN n on c.ID=n.component_table_id
left join UDP_COMPONENT_TABLE  t on c.ID=t.ID
left join UDP_COMPONENT_DATA_SOURCE  d on d.ID=c.COMPONENT_DATA_SOURCE_ID
where c.page_id=containerGuid and (lower(c.component_type)='templatetable' or lower(c.component_type)='templatetreetable' )
and n.STATE=1
order by n.COLUMN_ORDER asc;
open buttoneEvent for
SELECT
    e.COMPONENT_BUTTON_ID,                                 --按钮组件ID
    b.TRADE_ID,                                                               --权限点ID
    b.icon,                                                                         --按钮图标
    e.EVENT_TYPE ,                                                          --按钮事件类型
    e.EXECUTE_TYPE ,                                                      --按钮执行类型
    e.EXECUTE_CONTENT,                                              --按钮执行内容
    e.DIALOG_TITLE,                                                        --点击弹窗标题
    e.DIALOG_CONTEN,                                                   --点击弹窗内容
    e.WINDOW_WIDTH,                                                   --打开弹窗的宽度
    e.WINDOW_HEIGHT                                                   --打开弹窗的高度
FROM
    UDP_COMPONENT c 
    left join UDP_COMPONENT_BUTTON_EVENT e  on c.ID=e.COMPONENT_BUTTON_ID
    left join udp_component_button b  on c.ID=b.ID
    where c.PAGE_ID=containerGuid and  e.COMPONENT_BUTTON_ID  is not null;

open eventMonitoring for
select 
m.ID,                                                                              --事件监听主键
m.COMPONENT_ID ,                                                   --组件ID
m.TARGET_COMPONENT_ID ,                                   --被监听组件ID
c.COMPONENT_TYPE ,                                                --组件类型
m.IS_MUST_MONITORING   from UDP_EVENT_MONITORING m 
left join UDP_COMPONENT c on m.TARGET_COMPONENT_ID=c.ID
where m.component_id in (select  c.ID   from UDP_COMPONENT c where  c.PAGE_ID=containerGuid);

open datePicker for
select 
c.ID componentId,                                                     --组件ID
d.START_TIME,                                                           --开始时间
d.END_TIME,                                                               --结束时间
d.DEFAULT_VALUE,                                                   --默认时间
d.VALUE_FORMAT                                                    --时间格式
from  UDP_COMPONENT c 
left join UDP_COMPONENT_DATE_PICKER d on c.ID=d.ID
where  c.PAGE_ID=containerGuid and (lower(c.component_type)='templatedatepicker' or lower(c.component_type)='templatedatetimepicker' );
END P_UDP_COMPONENT_BY_PAGE;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_COMPONENT_BY_TABLE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_UDP_COMPONENT_BY_TABLE" (componentId in varchar,componentInfo OUT sys_refcursor,tableAttributes OUT sys_refcursor)
AS  
haspage INTEGER;
BEGIN  
open componentInfo for  
select   c.ID componentId,                                                      --组件ID   
c.COMPONENT_HIGH componentHeight,                          --组件高度
c.COMPONENT_WIDE componentWidth,                            --组件宽度
''  pageTitle,                                                                              --页面标题
''  windowWidth,                                                                       --打开窗口宽度
'' windowHeight,                                                                       --打开窗口高度
c.COMPONENT_ORDER ,                                                         --展示顺序 
c.COMPONENT_NAME componentName,                           --组件名称
c.COMPONENT_LABLE lable,                                                  --组件展示标题
c.COMPONENT_TYPE componentType,                               --组件类型
c.PLACEHOLDER placeholder,                                                --展示水印文字
s.IS_CHECK,                                                                                --是否能够多选
s.IS_CHECKED_LAST_STAGE,                                                   --是否只能选中最末级
s.DEFAULT_VALUE ,                                                                   --默认值
s.DATA_SOURCE_TYPE,                                                             --数据源类型
s.DATA_SOURCE componentSource,                                      --组件数据源
s.PK_FIELD,                                                                                 --主键字段
s.LABLE_FIELD,                                                                           --展示字段
c.DATA_SOURCE                                                                       --展示数据(TemplateHyperText、TemplateContainer)
from UDP_COMPONENT c
left join UDP_LAYOUT l on  l.COMPONENT_ID=c.ID 
left join UDP_COMPONENT_DATA_SOURCE s on c.COMPONENT_DATA_SOURCE_ID=s.ID
where c.ID=componentId;
open tableAttributes for
select 
n.ID,
c.ID componentId,                                                     --组件ID
n.COLUMN_LABLE,                                                     --列标题
n.COLUMN_FIELD  ,                                                    --列字段名
n.COLUMN_WIDE ,                                                     --列宽度
n.COLUMN_ALIGN ,                                                   --列对齐
n.COLUMN_FIXED ,                                                    --浮动反方向（left,right）
2 COLUMN_NUMBER_FLOAT,                               --小数字段保留几位
n.COLUMN_DATA_TYPE ,                                         --数据类型
n.is_show_total,                                                          --是否显示合计
n.parent_column_id,                                                  --父级列主键
n.is_use_sort,                                                              --是否使用排序
d.IS_CHECK,                                                                 --是否复选
t.detail_url,                                                                   --双击行跳转地址
d.PK_FIELD,                                                                  --主键字段
n.JUMP_URL,                                                               --点击列跳转地址
n.OPEN_MODE,                                                           --点击列打开页面方式
t.OPEN_MODE DETAIL_MODE,                                 --双击行打开页面方式
n.WINDOW_WIDTH,                                                   --单击列打开弹窗的宽度
n.WINDOW_HEIGHT,                                                   --单击列打开弹窗的高度
n.DEAL_WITH_MODE,                                                  --单击列处理的模式
t.WINDOW_WIDTH as "ROW_WINDOW_WIDTH",  --双击行打开弹窗的宽度
t.WINDOW_HEIGHT as "ROW_WINDOW_WIDTH",  --双击行打开弹窗的高度
n.IS_USE_HTML,                                                            --是否显示html
case  when t.IS_SHOW_PAGINATION is null
then 1 else t.IS_SHOW_PAGINATION end IS_SHOW_PAGINATION,           --是否显示分页
case  when t.IS_SHOW_BORDER is null
then 1 else t.IS_SHOW_BORDER end IS_SHOW_BORDER,                   --是否显示边框
case  when t.IS_SHOW_STRIPE is null
then 1 else t.IS_SHOW_STRIPE end is_show_stripe                    --是否显示斑马纹
from UDP_COMPONENT c 
left join UDP_COMPONENT_TABLE_COLUMN n on c.ID=n.component_table_id
left join UDP_COMPONENT_TABLE  t on c.ID=t.ID
left join UDP_COMPONENT_DATA_SOURCE  d on d.ID=c.COMPONENT_DATA_SOURCE_ID
where c.ID=componentId and (lower(c.component_type)='templatetable' or lower(c.component_type)='templatetreetable' )
and n.STATE=1
order by n.COLUMN_ORDER asc;

END P_UDP_COMPONENT_BY_TABLE;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_COMPONENT_DATA_SOURCE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_UDP_COMPONENT_DATA_SOURCE" (componentId in varchar,dataSourceInfo OUT sys_refcursor)
AS  
BEGIN  
open dataSourceInfo for  
select 
c.DATA_SOURCE ,                                                                                      --数据源配置查询语句或者存储过程标识code
c.DATA_SOURCE_TYPE ,                                                                           --数据源类型
c.PARENT_FIELD ,                                                                                       --父级字段名
c.PK_FIELD ,                                                                                                 --主键字段名
c.LABLE_FIELD,                                                                                            --展示字段名
c.CHILD_FIELD,                                                                                            --子级字段名
t.COMPONENT_TYPE
from UDP_COMPONENT t
left join UDP_COMPONENT_DATA_SOURCE c on t.COMPONENT_DATA_SOURCE_ID=c.id
where t.id=componentId;
END p_UDP_Component_Data_Source;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_CREATE_TEMP_TABLE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_UDP_CREATE_TEMP_TABLE" (temp_table_name in VARCHAR2,tablename in VARCHAR2,SQL_STR  in VARCHAR2) AUTHID current_user 
as
sqlstr VARCHAR2(4000);
sqlstr1 VARCHAR2(4000);
TABLEEXIST NUMBER;
begin
select    WMSYS.WM_CONCAT( tab.col)   into sqlstr1  from (SELECT a.column_name||'  '||a.data_type||case 
 WHEN  a.DATA_TYPE = 'NVARCHAR2' OR a.DATA_TYPE = 'VARCHAR2' or  a.DATA_TYPE ='CHAR'  THEN  '('||a.DATA_LENGTH||')' 
 WHEN  a.DATA_TYPE = 'DATE' OR a.DATA_TYPE = 'CLOB' or  a.DATA_TYPE = 'NUMBER' or   a.DATA_TYPE ='BLOB' THEN ''
 end as col
 FROM USER_TAB_COLUMNS a where a.TABLE_NAME=tablename order by a.column_id ) tab;
  select count(1) into TABLEEXIST from user_tables where table_name = upper(temp_table_name);
    if TABLEEXIST=1 then 
     execute immediate 'drop table '||upper(temp_table_name);
    end if;
 sqlstr:=' create global temporary table '||upper(temp_table_name)||'(';
 sqlstr:=sqlstr||sqlstr1||') on commit delete rows';
 --创建临时表
  execute immediate sqlstr;
--向临时表中导入数据
  if  SQL_STR is not null
  then
  execute immediate ' insert into  '||temp_table_name||' '||SQL_STR;
  end if;
end P_UDP_CREATE_TEMP_TABLE;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_DATA_SOURCE_BY_CODE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_UDP_DATA_SOURCE_BY_CODE" (code in varchar,dataSourceInfo OUT sys_refcursor)
AS  
pcode VARCHAR2(1000);
rowcountByCode int;
rowcountBySource int;
BEGIN  
pcode:=code;
select count(1) into rowcountByCode  from  UDP_COMPONENT_DATA_SOURCE c 
where c.CODE=pcode ;
select count(1) into rowcountBySource  from  UDP_COMPONENT_DATA_SOURCE c 
where c.DATA_SOURCE=pcode ;
if rowcountBySource<>0 THEN
open dataSourceInfo for  
select 
c.DATA_SOURCE ,                                                                                      --数据源配置查询语句或者存储过程标识code
c.DATA_SOURCE_TYPE ,                                                                            --数据源类型
c.PARENT_FIELD ,                                                                                       --父级字段名
c.PK_FIELD ,                                                                                                 --主键字段名
c.LABLE_FIELD,                                                                                            --展示字段名
c.CHILD_FIELD                                                                                             --子级字段名
from  UDP_COMPONENT_DATA_SOURCE c 
where c.DATA_SOURCE=pcode and rownum = 1;
ELSIF rowcountByCode<>0 then
open dataSourceInfo for  
select 
c.DATA_SOURCE ,                                                                                      --数据源配置查询语句或者存储过程标识code
c.DATA_SOURCE_TYPE ,                                                                            --数据源类型
c.PARENT_FIELD ,                                                                                       --父级字段名
c.PK_FIELD ,                                                                                                 --主键字段名
c.LABLE_FIELD,                                                                                            --展示字段名
c.CHILD_FIELD                                                                                             --子级字段名
from  UDP_COMPONENT_DATA_SOURCE c 
where c.CODE=pcode and rownum = 1;
else 
open dataSourceInfo for  
SELECT pcode as  DATA_SOURCE,
'procedure' as  DATA_SOURCE_TYPE,
'' as PARENT_FIELD,
'' as PK_FIELD,
'' as LABLE_FIELD,
'' as CHILD_FIELD
from dual;
end if;
END p_UDP_Data_Source_By_Code;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_DATA_SOURCE_BY_PAGE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_UDP_DATA_SOURCE_BY_PAGE" (
    p_pagesql  IN CLOB,                  --sql
    p_curPage  IN  NUMBER ,         --当前页
    p_pageSize IN NUMBER ,         --每页显示记录的条数
    total OUT NUMBER,                   --总记录数
    items OUT SYS_REFCURSOR     -- 输出结果集游标
  )
AS
  v_sql    CLOB;                                  --sql语句
  v_startRecord NUMBER;             --开始显示的记录数
  v_endRecord   NUMBER;             --结束显示的记录条数
BEGIN
                                                            --记录总记录条数
  v_sql:= 'select count(*) FROM (' || p_pagesql || ')';
  EXECUTE IMMEDIATE v_sql INTO total;
                                                            --实现分页查询
  v_startRecord :=(p_curPage - 1) * p_pageSize + 1;
  v_endRecord   :=p_curPage  * p_pageSize;
  v_sql         :='select * from (SELECT t.*, ROWNUM RN from (' || p_pagesql || ') t where rownum<=' || v_endRecord || ' ) where RN>=' ||v_startRecord;

  OPEN items FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE items;
END p_UDP_Data_Source_By_Page;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_DELETE_SQL_BY_EXCELID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_UDP_DELETE_SQL_BY_EXCELID" (CODE in VARCHAR2, EXPORT_SQL_LIST OUT SYS_REFCURSOR)  AUTHID current_user 
as
str_sql VARCHAR2(4000);
TEMP_TABLE_NAME VARCHAR2(200);
TABLE_NAME VARCHAR2(200);
SQL_STR VARCHAR2(4000);
EXPORT_SQL CLOB :='';
row_index NUMBER;
ROW_COUNT NUMBER;
TABLEEXIST NUMBER;
begin
    row_index:=1;
     str_sql := 'create global temporary table EXPORT_SQL_TABLE  (
        ID INT,
        TABLE_NAME VARCHAR(1000),
        SQL  VARCHAR(4000)
     ) 
    on commit preserve rows';
    --判断临时表是否存在存在就删除
    select count(1) into TABLEEXIST from user_tables where table_name = 'EXPORT_SQL_TABLE';
    if TABLEEXIST=0 then 
     --创建临时表
    execute immediate str_sql;
    else 
    execute immediate 'delete EXPORT_SQL_TABLE';
    end if;

  insert into EXPORT_SQL_TABLE VALUES(row_index,'','set define off;');
/*=================================删除字段信息配置=================================================*/
  TABLE_NAME:= 'UDP_EXPORT_FIELD';
  SQL_STR:=' select * from UDP_EXPORT_FIELD where id in (select EXPORT_FIELD_ID from  UDP_EXPORT_SHEET_FIELD where EXPORT_SHEET_ID='''||CODE||'''';
  SQL_STR:=SQL_STR||'UNION select EXPORT_FIELD_ID from  UDP_EXPORT_SHEET_FIELD where  EXPORT_SHEET_ID in (select Id from UDP_EXPORT_SHEET where EXCEL_ID='''||CODE||'''))';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除字段信息配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*=================================删除sheet配置字段信息配置=================================================*/
  TABLE_NAME:= 'UDP_EXPORT_SHEET_FIELD';
  SQL_STR:=' select * from UDP_EXPORT_SHEET_FIELD where EXPORT_SHEET_ID='''||CODE||''' UNION select * from UDP_EXPORT_SHEET_FIELD where EXPORT_SHEET_ID in (select ID from UDP_EXPORT_SHEET where EXCEL_ID='''||CODE||''' )';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除sheet配置字段信息配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*=================================删除sheet配置信息配置=================================================*/
  TABLE_NAME:= 'UDP_EXPORT_SHEET';
  SQL_STR:=' select * from UDP_EXPORT_SHEET where ID='''||CODE||''' UNION select * from UDP_EXPORT_SHEET where EXCEL_ID='''||CODE||''' ';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除sheet配置信息配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*=================================删除excel配置信息配置=================================================*/
  TABLE_NAME:= 'UDP_EXPORT_EXCEL';
  SQL_STR:='select * from UDP_EXPORT_EXCEL where ID='''||CODE||''' ';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除excel配置信息配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
  /*=================================查询导出的sql语句信息=================================================*/
  open EXPORT_SQL_LIST for 'select SQL from EXPORT_SQL_TABLE order by ID';
  commit;
end  P_UDP_DELETE_SQL_BY_EXCELID;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_DELETE_SQL_BY_PAGEID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_UDP_DELETE_SQL_BY_PAGEID" (PAGEID in VARCHAR2, EXPORT_SQL_LIST OUT SYS_REFCURSOR  )  AUTHID current_user 
as
str_sql VARCHAR2(4000);
SQL_STR CLOB :='';
row_index NUMBER;
TABLEEXIST NUMBER;
TABLE_NAME VARCHAR2(4000);
ROW_COUNT NUMBER;
SELECT_COMPONENT_BY_PAGEID CLOB :='';
BEGIN
 row_index:=1;
    str_sql := 'create global temporary table EXPORT_SQL_TABLE  (
        ID INT,
        TABLE_NAME VARCHAR(1000),
        SQL  VARCHAR(4000)
     ) 
    on commit preserve rows';
    --判断临时表是否存在不存在就创建
    select count(1) into TABLEEXIST from user_tables where table_name = 'EXPORT_SQL_TABLE';
    if TABLEEXIST=0 then 
      --创建临时表
      execute immediate str_sql;
    else
     --删除临时表数据
      execute immediate 'delete  EXPORT_SQL_TABLE';
    end if;
  insert into EXPORT_SQL_TABLE  VALUES(row_index,'','set define off;');
  SQL_STR:='select * from udp_component where  page_id='''||PAGEID||''' UNION select * from udp_component where  page_id in ';
  SQL_STR:=SQL_STR||'(select ID from UDP_COMPONENT_TABS_ITEM where component_tabs_id in  (select id from udp_component where  page_id='''||PAGEID||''' and component_type=''TemplateTabs''))';
  SQL_STR:=SQL_STR||' UNION ';
  SQL_STR:=SQL_STR||' select * from udp_component WHERE page_id IN (select ID from (select * from udp_component where page_id='''||PAGEID||''' ';
  SQL_STR:=SQL_STR||' UNION  ';
  SQL_STR:=SQL_STR||' select * from udp_component where  page_id in ';
  SQL_STR:=SQL_STR||' (select ID from UDP_COMPONENT_TABS_ITEM where component_tabs_id in  ';
  SQL_STR:=SQL_STR||'(select id from udp_component where  page_id='''||PAGEID||''' and component_type=''TemplateTabs''))) tab1';
  SQL_STR:=SQL_STR||' where tab1.COMPONENT_TYPE=''TemplateDropdown'')';
  SELECT_COMPONENT_BY_PAGEID:='select t.ID from ('||SQL_STR||') t';
/*==================================删除 UDP_EXPORT_FIELD 表字段配置================================================*/
  TABLE_NAME:= 'UDP_EXPORT_FIELD';
  SQL_STR:=' select * from '||TABLE_NAME||' where ID in (select EXPORT_FIELD_ID from UDP_EXPORT_SHEET_FIELD where  EXPORT_SHEET_ID in（select ID from  UDP_EXPORT_SHEET  where EXCEL_ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') )';
  SQL_STR:=SQL_STR||' UNION select ID from  UDP_EXPORT_SHEET  where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') ) ) )';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除字段配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_EXPORT_SHEET_FIELD 表sheet导出字段配置================================================*/
  TABLE_NAME:= 'UDP_EXPORT_SHEET_FIELD';
   SQL_STR:=' select * from '||TABLE_NAME||' where  EXPORT_SHEET_ID in（select ID from  UDP_EXPORT_SHEET  where EXCEL_ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') )';
  SQL_STR:=SQL_STR||' UNION select ID from  UDP_EXPORT_SHEET  where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') ) )';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除sheet导出字段配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_EXPORT_SHEET 表excel导出sheet配置================================================*/
  TABLE_NAME:= 'UDP_EXPORT_SHEET';
  SQL_STR:=' select * from  '||TABLE_NAME||' where EXCEL_ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') )';
  SQL_STR:=SQL_STR||' UNION  select * from '||TABLE_NAME||' where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') ) ';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除excel导出sheet配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_EXPORT_EXCEL 表excel导出配置================================================*/
  TABLE_NAME:= 'UDP_EXPORT_EXCEL';
  SQL_STR:=' select * from  '||TABLE_NAME||' where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') )';
  SQL_STR:=SQL_STR||' UNION  select * from '||TABLE_NAME||' where ID in  (select EXCEL_ID from  UDP_EXPORT_SHEET  where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') ) )';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除excel导出配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
  /*==================================删除 UDP_LAYOUT 表组件布局配置================================================*/
  TABLE_NAME:= 'UDP_LAYOUT';
  SQL_STR:='  select * from '||TABLE_NAME||' where COMPONENT_ID  in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除组件布局配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_EVENT_MONITORING 表组件监听配置================================================*/
 TABLE_NAME:= 'UDP_EVENT_MONITORING';
  SQL_STR:='  select *  from '||TABLE_NAME||' where component_id in ('||SELECT_COMPONENT_BY_PAGEID||') and TARGET_COMPONENT_ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除组件监听配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_DATE_PICKER 表存储过程参数配置================================================*/
  TABLE_NAME:= 'UDP_PROCEDURE_PARAMETER';
    SQL_STR:='select r.* from UDP_PROCEDURE_REGISTRATION r where r.code in (select s.data_source from  (select component_data_source_id from UDP_COMPONENT where ID  in   ('||SELECT_COMPONENT_BY_PAGEID||') ';
    SQL_STR:=SQL_STR||' and component_data_source_id is not null) d left join UDP_COMPONENT_DATA_SOURCE s on d.component_data_source_id=s.id where s.data_source_type=''procedure'') ';
    SQL_STR:=SQL_STR|| ' UNION ';
    SQL_STR:=SQL_STR||'select  r.* from ( select  case when instr(s.data_source,''?'',1,1) <>0 then  substr(s.data_source,instr(s.data_source,''?'',1,1)+1)||''&''  end conten ';
    SQL_STR:=SQL_STR||'from  (select component_data_source_id from UDP_COMPONENT where ID in  ('||SELECT_COMPONENT_BY_PAGEID||') ';
    SQL_STR:=SQL_STR||'and component_data_source_id is not null) d left join UDP_COMPONENT_DATA_SOURCE s on d.component_data_source_id=s.id ';
    SQL_STR:=SQL_STR||'where s.data_source LIKE ''/api/udp/getExecuteProcedureResult%'' or  s.data_source LIKE ''/api/udp/getRegisterResult%'' or  s.data_source LIKE ''/api/public/udp/getRegisterResult%'' )tab , UDP_PROCEDURE_REGISTRATION r ';
    SQL_STR:=SQL_STR||'where tab.conten like ''%code=''||r.code||''&%'' ';
    SQL_STR:=SQL_STR||' UNION ';
    SQL_STR:=SQL_STR||'select  r.*  from (select case when instr(EXECUTE_CONTENT,''?'',1,1) <>0 then  substr(EXECUTE_CONTENT,instr(EXECUTE_CONTENT,''?'',1,1)+1)||''&''  end conten   from UDP_COMPONENT_BUTTON_EVENT where COMPONENT_BUTTON_ID in   ('||SELECT_COMPONENT_BY_PAGEID||') ';
    SQL_STR:=SQL_STR||'and EXECUTE_CONTENT LIKE ''/api/udp/getExecuteProcedureResult%'' or  EXECUTE_CONTENT LIKE ''/api/udp/getRegisterResult%'' or  EXECUTE_CONTENT LIKE ''/api/public/udp/getRegisterResult%'' ) tab, UDP_PROCEDURE_REGISTRATION r ';
    SQL_STR:=SQL_STR||'where tab.conten like ''%code=''||r.code||''&%'' ';
  SQL_STR:='select * from '||TABLE_NAME||' where PROCEDURE_REGISTRATION_ID in ('||' select ID  from ('||SQL_STR||') '||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除存储过程参数配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_PROCEDURE_REGISTRATION 表存储过程配置================================================*/
  TABLE_NAME:= 'UDP_PROCEDURE_REGISTRATION';
    SQL_STR:='select r.* from UDP_PROCEDURE_REGISTRATION r where r.code in (select s.data_source from  (select component_data_source_id from UDP_COMPONENT where ID  in   ('||SELECT_COMPONENT_BY_PAGEID||') ';
    SQL_STR:=SQL_STR||' and component_data_source_id is not null) d left join UDP_COMPONENT_DATA_SOURCE s on d.component_data_source_id=s.id where s.data_source_type=''procedure'') ';
    SQL_STR:=SQL_STR|| ' UNION ';
    SQL_STR:=SQL_STR||'select  r.* from ( select  case when instr(s.data_source,''?'',1,1) <>0 then  substr(s.data_source,instr(s.data_source,''?'',1,1)+1)||''&''  end conten ';
    SQL_STR:=SQL_STR||'from  (select component_data_source_id from UDP_COMPONENT where ID in  ('||SELECT_COMPONENT_BY_PAGEID||') ';
    SQL_STR:=SQL_STR||'and component_data_source_id is not null) d left join UDP_COMPONENT_DATA_SOURCE s on d.component_data_source_id=s.id ';
    SQL_STR:=SQL_STR||'where s.data_source LIKE ''/api/udp/getExecuteProcedureResult%'' or  s.data_source LIKE ''/api/udp/getRegisterResult%'' or  s.data_source LIKE ''/api/public/udp/getRegisterResult%'' )tab , UDP_PROCEDURE_REGISTRATION r ';
    SQL_STR:=SQL_STR||'where tab.conten like ''%code=''||r.code||''&%'' ';
    SQL_STR:=SQL_STR||' UNION ';
    SQL_STR:=SQL_STR||'select  r.*  from (select case when instr(EXECUTE_CONTENT,''?'',1,1) <>0 then  substr(EXECUTE_CONTENT,instr(EXECUTE_CONTENT,''?'',1,1)+1)||''&''  end conten   from UDP_COMPONENT_BUTTON_EVENT where COMPONENT_BUTTON_ID in   ('||SELECT_COMPONENT_BY_PAGEID||') ';
    SQL_STR:=SQL_STR||'and EXECUTE_CONTENT LIKE ''/api/udp/getExecuteProcedureResult%'' or  EXECUTE_CONTENT LIKE ''/api/udp/getRegisterResult%'' or  EXECUTE_CONTENT LIKE ''/api/public/udp/getRegisterResult%'' ) tab, UDP_PROCEDURE_REGISTRATION r ';
    SQL_STR:=SQL_STR||'where tab.conten like ''%code=''||r.code||''&%'' ';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除存储过程配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_DATA_SOURCE 表数据源配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_DATA_SOURCE';
  SQL_STR:='select s.*  FROM udp_component c RIGHT join udp_component_data_source s on c.component_data_source_id=s.id where c.id in ('||SELECT_COMPONENT_BY_PAGEID||') UNION ';
  SQL_STR:=SQL_STR||'select s.*  from (SELECT case when instr(s.data_source,''?'',1,1) <>0 then  substr(s.data_source,instr(s.data_source,''?'',1,1)+1)||''&''  end conten  FROM udp_component c RIGHT join udp_component_data_source s on c.component_data_source_id=s.id where c.id in (';
  SQL_STR:=SQL_STR||SELECT_COMPONENT_BY_PAGEID||')';
  SQL_STR:=SQL_STR||' and  s.data_source LIKE ''/api/udp/getDataSource%'')  tab,udp_component_data_source s where  tab.conten   like ''%code=''||s.code||''&%'' ';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除数据源配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_BUTTON_EVENT 表按钮组件事件配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_BUTTON_EVENT';
  SQL_STR:=' select *  from '||TABLE_NAME||' where COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除按钮组件事件配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_BUTTON 表按钮组件配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_BUTTON';
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除按钮组件配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_TABLE_COLUMN 表table列表组件配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_TABLE_COLUMN';
  SQL_STR:=' select *  from '||TABLE_NAME||' where COMPONENT_TABLE_ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除table组件列配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_TABLE 表table列表组件配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_TABLE';
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除table列表组件配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_TREE_SELECT 表tree-select组件配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_TREE_SELECT';
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除tree-select组件配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_DATE_PICKER 表时间选择器组件配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_DATE_PICKER';
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除时间选择器组件配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_TABS_ITEM 表tabs组件items配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_TABS_ITEM';
  SQL_STR:=' select *  from '||TABLE_NAME||' where COMPONENT_TABS_ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除tabs组件items配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_TABS 表tabs组件配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_TABS';
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除tabs组件配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_PAGE 表配置================================================*/
  TABLE_NAME:= 'UDP_PAGE';
  SQL_STR:='  select * from '||TABLE_NAME||' where ID='''||PAGEID||'''';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除页面配置');
    row_index:=row_index+1;
     insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT 表组件配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT';
  SQL_STR:='select * from udp_component where  page_id='''||PAGEID||''' UNION select * from udp_component where  page_id in ';
  SQL_STR:=SQL_STR||'(select ID from UDP_COMPONENT_TABS_ITEM where component_tabs_id in  (select id from udp_component where  page_id='''||PAGEID||''' and component_type=''TemplateTabs''))';
  SQL_STR:=SQL_STR||' UNION ';
  SQL_STR:=SQL_STR||' select * from udp_component WHERE page_id IN (select ID from (select * from udp_component where page_id='''||PAGEID||''' ';
  SQL_STR:=SQL_STR||' UNION  ';
  SQL_STR:=SQL_STR||' select * from udp_component where  page_id in ';
  SQL_STR:=SQL_STR||' (select ID from UDP_COMPONENT_TABS_ITEM where component_tabs_id in  ';
  SQL_STR:=SQL_STR||'(select id from udp_component where  page_id='''||PAGEID||''' and component_type=''TemplateTabs''))) tab1';
  SQL_STR:=SQL_STR||' where tab1.COMPONENT_TYPE=''TemplateDropdown'')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除组件配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*=================================查询导出的sql语句信息=================================================*/
open EXPORT_SQL_LIST for 'select SQL from EXPORT_SQL_TABLE order by ID';
END P_UDP_DELETE_SQL_BY_PAGEID;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_DELETE_SQL_BY_PROCODE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_UDP_DELETE_SQL_BY_PROCODE" (CODE in VARCHAR2, EXPORT_SQL_LIST OUT SYS_REFCURSOR)  AUTHID current_user 
as
str_sql VARCHAR2(4000);
TEMP_TABLE_NAME VARCHAR2(200);
TABLE_NAME VARCHAR2(200);
SQL_STR VARCHAR2(4000);
EXPORT_SQL CLOB :='';
row_index NUMBER;
ROW_COUNT NUMBER;
TABLEEXIST NUMBER;
begin
    row_index:=1;
     str_sql := 'create global temporary table EXPORT_SQL_TABLE  (
        ID INT,
        TABLE_NAME VARCHAR(1000),
        SQL  VARCHAR(4000)
     ) 
    on commit preserve rows';
    --判断临时表是否存在存在就删除
    select count(1) into TABLEEXIST from user_tables where table_name = 'EXPORT_SQL_TABLE';
    if TABLEEXIST=0 then 
     --创建临时表
    execute immediate str_sql;
    else 
    execute immediate 'delete EXPORT_SQL_TABLE';
    end if;

  insert into EXPORT_SQL_TABLE VALUES(row_index,'','set define off;');
/*=================================删除存储过程参数信息配置=================================================*/
  TABLE_NAME:= 'UDP_PROCEDURE_PARAMETER';
  SQL_STR:=' select * from '||TABLE_NAME||' WHERE PROCEDURE_REGISTRATION_ID IN (select ID from UDP_PROCEDURE_REGISTRATION where CODE='''||CODE||''' and  STATE=1)';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除存储过程参数信息配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*=================================删除存储过程注册信息配置=================================================*/
  TABLE_NAME:= 'UDP_PROCEDURE_REGISTRATION';
  SQL_STR:='  select * from '||TABLE_NAME||' where CODE='''||CODE||'''  and  STATE=1';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除存储过程注册信息配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
  /*=================================查询导出的sql语句信息=================================================*/
  open EXPORT_SQL_LIST for 'select SQL from EXPORT_SQL_TABLE order by ID';
  commit;
end  P_UDP_DELETE_SQL_BY_PROCODE;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_EXPORT_BY_CODE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_UDP_EXPORT_BY_CODE" (code in  VARCHAR2,sheetField OUT sys_refcursor )
AS  
rowcountByExcelId  int;
rowcountByDataSource  int;
BEGIN  
select count(1) into rowcountByExcelId  from  UDP_EXPORT_EXCEL e
where e.id=code;
if rowcountByExcelId<>0 THEN
open sheetField for  
 SELECT
    e.id as excel_id,
    e.file_name,
    s.id as sheet_id,
    data_source,
    name,
    excel_title,
    ROW_BG_COLOR_FIELD,
    header_bg_color,
    header_font_color,
    sheet_order,
    f. id,
    f.lable,
    f.field,
    f.wide,
    f.align,
    f.data_type,
    f.is_show_total,
    f.field_order,
    f.TEXT_ALIGN,
    f.parent_id as PARENT_COLUMN_ID
FROM
    udp_export_sheet s
    left join UDP_EXPORT_EXCEL e on s.excel_id=e.id
    left join UDP_EXPORT_SHEET_FIELD t on  s.Id=t.export_sheet_id
    left join UDP_EXPORT_FIELD f on t.export_field_id=f.id
    where e.id=code order by f.field_order;
else
    select count(1) into rowcountByDataSource  from  udp_export_sheet s
    where s.id=code;
        if rowcountByDataSource<>0 THEN
    open sheetField for  
     SELECT
        e.id as excel_id,
        e.file_name,
        s.id as sheet_id,
        data_source,
        name,
        excel_title,
        ROW_BG_COLOR_FIELD,
        header_bg_color,
        header_font_color,
        sheet_order,
        f. id,
        f.lable,
        f.field,
        f.wide,
        f.align,
        f.data_type,
        f.is_show_total,
        f.field_order,
        f.TEXT_ALIGN,
        f.parent_id as PARENT_COLUMN_ID
    FROM
        udp_export_sheet s
        left join UDP_EXPORT_EXCEL e on s.excel_id=e.id
        left join UDP_EXPORT_SHEET_FIELD t on  s.Id=t.export_sheet_id
        left join UDP_EXPORT_FIELD f on t.export_field_id=f.id
        where s.id=code order by f.field_order;
        end if;
end if;
END P_UDP_EXPORT_BY_CODE;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_EXPORT_SQL_BY_EXCELID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_UDP_EXPORT_SQL_BY_EXCELID" (EXCELID in VARCHAR2, EXPORT_SQL_LIST OUT SYS_REFCURSOR)  AUTHID current_user 
as
str_sql VARCHAR2(4000);
TEMP_TABLE_NAME VARCHAR2(200);
TABLE_NAME VARCHAR2(200);
SQL_STR VARCHAR2(4000);
EXPORT_SQL CLOB :='';
row_index NUMBER;
TABLEEXIST NUMBER;
ROW_COUNT NUMBER;
begin
    row_index:=1;
    str_sql := 'create global temporary table EXPORT_SQL_TABLE  (
        ID INT,
        TABLE_NAME VARCHAR(1000),
        SQL  VARCHAR(4000)
     ) 
    on commit preserve rows';
    --判断临时表是否存在不存在就创建
    select count(1) into TABLEEXIST from user_tables where table_name = 'EXPORT_SQL_TABLE';
    if TABLEEXIST=0 then 
      --创建临时表
      execute immediate str_sql;
    else
     --删除临时表数据
      execute immediate 'delete  EXPORT_SQL_TABLE';
    end if;
  execute immediate 'select count(1) from UDP_EXPORT_EXCEL where id='''||EXCELID||''' '  INTO  ROW_COUNT;
  insert into EXPORT_SQL_TABLE VALUES(row_index,'','set define off;');
/*=================================EXCEL导出文件信息配置=================================================*/
 --需要导出的表名
  TABLE_NAME := 'UDP_EXPORT_EXCEL';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
--查询语句
   if ROW_COUNT = 1  then
   SQL_STR:='  select * from '||TABLE_NAME||' where ID='''||EXCELID||'''  ';
   end if;
    if ROW_COUNT = 0  then
    SQL_STR:='  select * from '||TABLE_NAME||' where ID in (SELECT EXCEL_ID FROM UDP_EXPORT_SHEET WHERE  ID= '''||EXCELID||''') ';
   end if;
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--EXCEL导出文件信息初始化',
    SQL_STR => EXPORT_SQL
  );
    --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================EXCEL导出工作簿信息配置=================================================*/
  select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_EXPORT_SHEET';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  --查询页面显示组件的id的集合
   if ROW_COUNT = 1  then
     SQL_STR:=' select * from '||TABLE_NAME||' WHERE EXCEL_ID ='''||EXCELID||''' ';
   end if;
    if ROW_COUNT = 0  then
    SQL_STR:='  select * from '||TABLE_NAME||' where ID ='''||EXCELID||''' ';
   end if;
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--EXCEL导出工作簿信息初始化' ,
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
 /*=================================EXCEL导出工作簿关联表字段信息配置=================================================*/
  select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_EXPORT_SHEET_FIELD';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_EXPORT_SHEET_FIELD';
   if ROW_COUNT = 1  then
   SQL_STR:='select * from '||TABLE_NAME||'  where EXPORT_SHEET_ID in (select ID from UDP_EXPORT_SHEET WHERE EXCEL_ID ='''||EXCELID||''' )';
   end if;
    if ROW_COUNT = 0  then
    SQL_STR:='select * from '||TABLE_NAME||'  where EXPORT_SHEET_ID ='''||EXCELID||''' ';
   end if;
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--EXCEL导出工作簿关联表字段信息初始化' ,
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
 /*=================================EXCEL导出字段信息配置=================================================*/
  select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_EXPORT_FIELD';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  --查询页面显示组件的id的集合
   if ROW_COUNT = 1  then
     SQL_STR:='select * from '||TABLE_NAME||' where ID in (select  EXPORT_FIELD_ID  from UDP_EXPORT_SHEET_FIELD  where EXPORT_SHEET_ID in (select ID from UDP_EXPORT_SHEET WHERE EXCEL_ID ='''||EXCELID||''' ))';
   end if;
    if ROW_COUNT = 0  then
     SQL_STR:='select * from '||TABLE_NAME||' where ID in (select  EXPORT_FIELD_ID  from UDP_EXPORT_SHEET_FIELD  where EXPORT_SHEET_ID  ='''||EXCELID||''' )';
   end if;
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--EXCEL导出字段信息初始化' ,
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================查询导出的sql语句信息=================================================*/
   open EXPORT_SQL_LIST for 'select replace(replace(SQL,''''''$("time")$'',''to_date(''''''),''$("timeend")$'''''','''''',''''yyyy-mm-dd hh24:mi:ss'''')'') SQL from EXPORT_SQL_TABLE order by ID';
  commit;
end  P_UDP_EXPORT_SQL_BY_EXCELID;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_EXPORT_SQL_BY_PAGEID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_UDP_EXPORT_SQL_BY_PAGEID" (PAGEID in VARCHAR2,IS_COPY in NUMBER, EXPORT_SQL_LIST OUT SYS_REFCURSOR  )  AUTHID current_user 
as
str_sql VARCHAR2(4000);
TEMP_TABLE_NAME VARCHAR2(200);
TABLE_NAME VARCHAR2(200);
SQL_STR CLOB :='';
EXPORT_SQL CLOB :='';
row_index NUMBER;
TABLEEXIST NUMBER;
REGISTRATION_IDS VARCHAR2(4000);
SELECT_COMPONENT_BY_PAGEID VARCHAR2(4000);
SELECT_COL VARCHAR2(4000);
begin
    row_index:=1;
    str_sql := 'create global temporary table EXPORT_SQL_TABLE  (
        ID INT,
        TABLE_NAME VARCHAR(1000),
        SQL  VARCHAR(4000)
     ) 
    on commit preserve rows';
    --判断临时表是否存在不存在就创建
    select count(1) into TABLEEXIST from user_tables where table_name = 'EXPORT_SQL_TABLE';
    if TABLEEXIST=0 then 
      --创建临时表
      execute immediate str_sql;
    else
     --删除临时表数据
      execute immediate 'delete  EXPORT_SQL_TABLE';
    end if;
  insert into EXPORT_SQL_TABLE  VALUES(row_index,'','set define off;');
/*=================================导出页面配置=================================================*/
 --需要导出的表名
  TABLE_NAME := 'UDP_PAGE';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
--查询语句
  if IS_COPY=1 then
   SQL_STR:='  select ID ,LAYOUT_TEMPLATE_ID ,CREATED ,CREATOR_ID ,CREATOR ,MODIFIED ,MODIFIER_ID ,MODIFIER ,FUNCTION_ID ,TITLE ,WINDOW_WIDTH ,WINDOW_HEIGHT ,''《''||ID||''》复制配置信息'' REMARK  from '||TABLE_NAME||' where ID='''||PAGEID||'''';
  else
   SQL_STR:='  select * from '||TABLE_NAME||' where ID='''||PAGEID||'''';
  end if;
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--页面基础信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
 /*=================================导出组件配置=================================================*/
  select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  --查询页面显示组件的id的集合
    SQL_STR:='select * from udp_component where  page_id='''||PAGEID||''' UNION select * from udp_component where  page_id in ';
    SQL_STR:=SQL_STR||'(select ID from UDP_COMPONENT_TABS_ITEM where component_tabs_id in  (select id from udp_component where  page_id='''||PAGEID||''' and component_type=''TemplateTabs''))';
    SQL_STR:=SQL_STR||' UNION ';
    SQL_STR:=SQL_STR||' select * from udp_component WHERE page_id IN (select ID from (select * from udp_component where page_id='''||PAGEID||''' ';
    SQL_STR:=SQL_STR||' UNION  ';
    SQL_STR:=SQL_STR||' select * from udp_component where  page_id in ';
    SQL_STR:=SQL_STR||' (select ID from UDP_COMPONENT_TABS_ITEM where component_tabs_id in  ';
    SQL_STR:=SQL_STR||'(select id from udp_component where  page_id='''||PAGEID||''' and component_type=''TemplateTabs''))) tab1';
    SQL_STR:=SQL_STR||' where tab1.COMPONENT_TYPE=''TemplateDropdown'')';
    SELECT_COMPONENT_BY_PAGEID:='select t.ID from ('||SQL_STR||') t';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--组件基础信息初始化' ,
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出组件布局配置=================================================*/
 select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_LAYOUT';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
   SQL_STR:='  select * from '||TABLE_NAME||' where COMPONENT_ID  in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--组件布局信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出组件监听配置=================================================*/
 select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_EVENT_MONITORING';
 --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  SQL_STR:='  select *  from '||TABLE_NAME||' where component_id in ('||SELECT_COMPONENT_BY_PAGEID||') and TARGET_COMPONENT_ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--组件监听信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出按钮组件配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_BUTTON';
 --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--按钮组件基础信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出按钮组件事件配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_BUTTON_EVENT';
 --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_COMPONENT_BUTTON_EVENT';
  SQL_STR:=' select *  from '||TABLE_NAME||' where COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--按钮组件事件信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '|| EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
--/*=================================导出table列表组件事件配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_TABLE';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--table列表组件基础信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出table组件列配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_TABLE_COLUMN';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_COMPONENT_TABLE_COLUMN';
  SQL_STR:=' select *  from '||TABLE_NAME||' where COMPONENT_TABLE_ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--table列表组件显示列信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出tabs组件配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_TABS';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--tabs选项卡组件基础信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出tabs组件items配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_TABS_ITEM';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_COMPONENT_TABS_ITEM';
  SQL_STR:=' select *  from '||TABLE_NAME||' where COMPONENT_TABS_ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--tabs选项卡组件items项信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出UDP_COMPONENT_TREE_SELECT组件配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_TREE_SELECT';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_COMPONENT_TREE_SELECT';
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--树下拉选择器组件基础信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出UDP_COMPONENT_DATE_PICKER组件配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_DATE_PICKER';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_COMPONENT_DATE_PICKER';
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--时间选择器组件基础信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出udp_component_data_source组件数据源配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_DATA_SOURCE';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_COMPONENT_SOURCE';
  if IS_COPY=1 then
    SELECT_COL:='  s. id, s.data_source, s.data_source_type, s.parent_field, s.pk_field, s.lable_field, s.created, s.creator_id,s.creator,s.modified, s.modifier_id,s.modifier,s.child_field, s.code,s.is_checked_last_stage, s.is_check, s.default_value, ''《''||s.id||''》复制配置信息'' remark';
    else
    SELECT_COL:='  s.* ';
    end if;
  SQL_STR:='select '||SELECT_COL||' FROM udp_component c RIGHT join udp_component_data_source s on c.component_data_source_id=s.id where c.id in ('||SELECT_COMPONENT_BY_PAGEID||') UNION ';
  SQL_STR:=SQL_STR||'select '||SELECT_COL||' from (SELECT case when instr(s.data_source,''?'',1,1) <>0 then  substr(s.data_source,instr(s.data_source,''?'',1,1)+1)||''&''  end conten  FROM udp_component c RIGHT join udp_component_data_source s on c.component_data_source_id=s.id where c.id in (';
  SQL_STR:=SQL_STR||SELECT_COMPONENT_BY_PAGEID||')';
 SQL_STR:=SQL_STR||' and  s.data_source LIKE ''/api/udp/getDataSource%'')  tab,udp_component_data_source s where  tab.conten   like ''%code=''||s.code||''&%'' ';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--数据源信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出组件数据源存储过程配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_PROCEDURE_REGISTRATION';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_PROCEDURE_REGISTRATION';
    if IS_COPY=1 then
    SELECT_COL:=' r.ID ,r.NAME ,r.CODE ,r.STATE ,r.CREATED ,r.CREATOR_ID ,r.CREATOR ,r.MODIFIED ,r.MODIFIER_ID ,r.MODIFIER,''《''||r.ID||''》复制配置信息'' REMARK';
    else
    SELECT_COL:=' r.*';
    end if;
SQL_STR:='select '||SELECT_COL||' from UDP_PROCEDURE_REGISTRATION r where r.code in (select s.data_source from  (select component_data_source_id from UDP_COMPONENT where ID  in   ('||SELECT_COMPONENT_BY_PAGEID||') ';
SQL_STR:=SQL_STR||' and component_data_source_id is not null) d left join UDP_COMPONENT_DATA_SOURCE s on d.component_data_source_id=s.id where s.data_source_type=''procedure'') ';
SQL_STR:=SQL_STR|| ' UNION ';
SQL_STR:=SQL_STR||'select '||SELECT_COL||' from ( select  case when instr(s.data_source,''?'',1,1) <>0 then  substr(s.data_source,instr(s.data_source,''?'',1,1)+1)||''&''  end conten ';
SQL_STR:=SQL_STR||'from  (select component_data_source_id from UDP_COMPONENT where ID in  ('||SELECT_COMPONENT_BY_PAGEID||') ';
SQL_STR:=SQL_STR||'and component_data_source_id is not null) d left join UDP_COMPONENT_DATA_SOURCE s on d.component_data_source_id=s.id ';
SQL_STR:=SQL_STR||'where s.data_source LIKE ''/api/udp/getExecuteProcedureResult%'' or  s.data_source LIKE ''/api/udp/getRegisterResult%'' or  s.data_source LIKE ''/api/public/udp/getRegisterResult%'' )tab , UDP_PROCEDURE_REGISTRATION r ';
SQL_STR:=SQL_STR||'where tab.conten like ''%code=''||r.code||''&%'' ';
SQL_STR:=SQL_STR||' UNION ';
SQL_STR:=SQL_STR||'select '||SELECT_COL||' from (select case when instr(EXECUTE_CONTENT,''?'',1,1) <>0 then  substr(EXECUTE_CONTENT,instr(EXECUTE_CONTENT,''?'',1,1)+1)||''&''  end conten   from UDP_COMPONENT_BUTTON_EVENT where COMPONENT_BUTTON_ID in   ('||SELECT_COMPONENT_BY_PAGEID||') ';
SQL_STR:=SQL_STR||'and EXECUTE_CONTENT LIKE ''/api/udp/getExecuteProcedureResult%'' or  EXECUTE_CONTENT LIKE ''/api/udp/getRegisterResult%'' or  EXECUTE_CONTENT LIKE ''/api/public/udp/getRegisterResult%'' ) tab, UDP_PROCEDURE_REGISTRATION r ';
    SQL_STR:=SQL_STR||'where tab.conten like ''%code=''||r.code||''&%'' ';
execute immediate ' select WMSYS.WM_CONCAT(t.ID)  from ('||SQL_STR||') t' INTO  REGISTRATION_IDS;
if REGISTRATION_IDS is not null then  REGISTRATION_IDS:=replace(REGISTRATION_IDS,',',''','''); end if;
REGISTRATION_IDS:=''''||REGISTRATION_IDS||'''';
SQL_STR:='select * from '||TABLE_NAME||' where ID in ('||REGISTRATION_IDS||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--存储过程注册信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出组件数据源存储过程参数配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_PROCEDURE_PARAMETER';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_PROCEDURE_PARAMETER';
  SQL_STR:='select * from '||TABLE_NAME||' where PROCEDURE_REGISTRATION_ID in ('||' select ID  from ('||SQL_STR||') '||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--存储过程参数信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出UDP_EXPORT_EXCEL表导出配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_EXPORT_EXCEL';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
    if IS_COPY=1 then
    SELECT_COL:=' ID ,FILE_NAME ,CREATED ,CREATOR_ID ,CREATOR ,MODIFIED ,MODIFIER_ID ,MODIFIER ,''《''||ID||''》复制配置信息'' REMARK';
    else
    SELECT_COL:=' *';
    end if;
  SQL_STR:=' select '||SELECT_COL||' from  '||TABLE_NAME||' where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') )';
  SQL_STR:=SQL_STR||' UNION  select '||SELECT_COL||' from '||TABLE_NAME||' where ID in  (select EXCEL_ID from  UDP_EXPORT_SHEET  where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') ) )';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--导出excel基础信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出UDP_EXPORT_SHEET表sheet导出配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_EXPORT_SHEET';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  SQL_STR:=' select * from  '||TABLE_NAME||' where EXCEL_ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') )';
  SQL_STR:=SQL_STR||' UNION  select * from '||TABLE_NAME||' where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') ) ';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--导出sheet基础信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出UDP_EXPORT_SHEET_FIELD表sheet导出字段配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_EXPORT_SHEET_FIELD';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_EXPORT_SHEET_FIELD';
  SQL_STR:=' select * from '||TABLE_NAME||' where  EXPORT_SHEET_ID in（select ID from  UDP_EXPORT_SHEET  where EXCEL_ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') )';
  SQL_STR:=SQL_STR||' UNION select ID from  UDP_EXPORT_SHEET  where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') ) )';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--导出sheet字段信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出字段配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_EXPORT_FIELD';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  SQL_STR:=' select * from UDP_EXPORT_FIELD where ID in (select EXPORT_FIELD_ID from UDP_EXPORT_SHEET_FIELD where  EXPORT_SHEET_ID in（select ID from  UDP_EXPORT_SHEET  where EXCEL_ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') )';
  SQL_STR:=SQL_STR||' UNION select ID from  UDP_EXPORT_SHEET  where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') ) ) )';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--导出字段配置信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================查询导出的sql语句信息=================================================*/
 if IS_COPY is not null and IS_COPY <> 0 then
  open EXPORT_SQL_LIST for 'select ID,TABLE_NAME,
  CASE 
  WHEN TABLE_NAME IS NOT NULL
  THEN
   substr(substr(SQL,instr(SQL,'') values ('',1,1)+11,length(SQL)),0,
    instr( substr(SQL,instr(SQL,'') values ('',1,1)+11,length(SQL)) ,'','',1,1)-2
   )
  END  PKID,SQL from EXPORT_SQL_TABLE where  TABLE_NAME is null or  instr(TABLE_NAME,''(DELETE)'',1,1)=0   order by ID';
  else
     open EXPORT_SQL_LIST for 'select replace(replace(SQL,''''''$("time")$'',''to_date(''''''),''$("timeend")$'''''','''''',''''yyyy-mm-dd hh24:mi:ss'''')'') SQL from EXPORT_SQL_TABLE order by ID';
  end if;
  commit;
end P_UDP_EXPORT_SQL_BY_PAGEID;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_EXPORT_SQL_BY_PROCODE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_UDP_EXPORT_SQL_BY_PROCODE" (CODE in VARCHAR2, EXPORT_SQL_LIST OUT SYS_REFCURSOR)  AUTHID current_user 
as
str_sql VARCHAR2(4000);
TEMP_TABLE_NAME VARCHAR2(200);
TABLE_NAME VARCHAR2(200);
SQL_STR VARCHAR2(4000);
EXPORT_SQL CLOB :='';
row_index NUMBER;
TABLEEXIST NUMBER;
begin
    row_index:=1;
     str_sql := 'create global temporary table EXPORT_SQL_TABLE  (
        ID INT,
        TABLE_NAME VARCHAR(1000),
        SQL  VARCHAR(4000)
     ) 
    on commit preserve rows';
    --判断临时表是否存在存在就删除
    select count(1) into TABLEEXIST from user_tables where table_name = 'EXPORT_SQL_TABLE';
    if TABLEEXIST=0 then 
     --创建临时表
    execute immediate str_sql;
    else 
    execute immediate 'delete EXPORT_SQL_TABLE';
    end if;

  insert into EXPORT_SQL_TABLE VALUES(row_index,'','set define off;');
/*=================================存储过程注册信息配置=================================================*/
 --需要导出的表名
  TABLE_NAME := 'UDP_PROCEDURE_REGISTRATION';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_PROCEDURE_REGISTRATION';
--查询语句
  SQL_STR:='  select * from '||TABLE_NAME||' where CODE='''||CODE||'''  and  STATE=1';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--存储过程注册信息初始化',
    SQL_STR => EXPORT_SQL
  );
    --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
  /*=================================存储过程参数注册信息配置=================================================*/
  select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_PROCEDURE_PARAMETER';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_PROCEDURE_PARAMETER';
  --查询页面显示组件的id的集合
  SQL_STR:=' select * from '||TABLE_NAME||' WHERE PROCEDURE_REGISTRATION_ID IN (select ID from UDP_PROCEDURE_REGISTRATION where CODE='''||CODE||''' and  STATE=1)';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--存储过程参数注册信息初始化' ,
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
  /*=================================查询导出的sql语句信息=================================================*/
  open EXPORT_SQL_LIST for 'select replace(replace(SQL,''''''$("time")$'',''to_date(''''''),''$("timeend")$'''''','''''',''''yyyy-mm-dd hh24:mi:ss'''')'') SQL from EXPORT_SQL_TABLE order by ID';
  commit;
end  P_UDP_EXPORT_SQL_BY_PROCODE;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_EXPORT_SQL_BY_TABLE_NAME
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_UDP_EXPORT_SQL_BY_TABLE_NAME" (temp_table_name in VARCHAR2,tablename  in VARCHAR2,row_index in NUMBER,WHERE_SQL_STR  in VARCHAR2,COMMENT_STR in VARCHAR2 ,sql_str out  CLOB)  AUTHID current_user 
as
sqlstr  VARCHAR2(4000);
sqlstr1 VARCHAR2(4000);
sqlstr2 VARCHAR2(4000);
colimns VARCHAR2(4000);
TABLE_NAME  VARCHAR2(4000);
ROW_NUMBER NUMBER;
ROW_COUNT NUMBER;
WHERE_SQL  VARCHAR2(4000);
TABLE_NAME_STR VARCHAR2(4000);
begin
   TABLE_NAME:=upper(tablename);
    P_UDP_CREATE_TEMP_TABLE(
     TEMP_TABLE_NAME => TEMP_TABLE_NAME,
     TABLENAME => TABLE_NAME,
     SQL_STR=>WHERE_SQL_STR
    );
    execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd hh24:mi:ss''';
    TABLE_NAME_STR:=''''||TABLE_NAME||''',';
    ROW_NUMBER:=row_index+1;
    sqlstr:='';
    ROW_COUNT:=0;
    if WHERE_SQL_STR is not null
    then 
    WHERE_SQL:=replace(WHERE_SQL_STR,'''','''''');
     execute immediate ' select COUNT(1)  from ('||WHERE_SQL_STR||') t' INTO  ROW_COUNT;
    end if;
    if COMMENT_STR is not null AND ROW_COUNT<>0 
    then 
    --拼接sql注释
    sqlstr:=' select '||ROW_NUMBER||','''','''||COMMENT_STR||''' from dual  UNION ';
    ROW_NUMBER:=ROW_NUMBER+1;
    sqlstr:=sqlstr||' select '||ROW_NUMBER||','||''''||TABLE_NAME||'(DELETE)'''||',''delete '||TABLE_NAME||' where ID in  (select t.ID from ('||WHERE_SQL||') t );'' from dual  UNION ';
    end if;
     --拼接插入数据语句
     sql_str:='select '||ROW_NUMBER||'+ROWNUM, '||TABLE_NAME_STR||'  ''insert into '||upper(tablename);
     SELECT WMSYS.WM_CONCAT(t.column_name) INTO colimns  FROM USER_TAB_COLUMNS t where t.TABLE_NAME=upper(temp_table_name);
     sqlstr2:='('||colimns||') values (';
     SELECT  WMSYS.WM_CONCAT(t.col) into sqlstr1
	 FROM (
    SELECT  CASE a.data_type 
    WHEN 'NUMBER'
    THEN  '''||case when '||a.column_name||' is null then ''0''  else to_char('||a.column_name ||')  end || '''
    WHEN 'DATE'
    THEN    '''''''||case when '||a.column_name||' is  not  null then  ''$("time")$''||replace('||a.column_name||','''''''','''''''''''')||''$("timeend")$''' || 'end || '''''''
    else 
    '''''''||case when '||a.column_name||' is  not  null then replace('||a.column_name||','''''''','''''''''''')' || 'end || '''''''
    END AS COL,a.column_id,a.column_name FROM USER_TAB_COLUMNS a where a.TABLE_NAME=upper(temp_table_name)
     ) t ORDER BY column_id;
     sqlstr1:=replace(sqlstr1,'||,','||'',');
     sqlstr1:=sqlstr1||');''';
     sql_str:=sqlstr||sql_str||sqlstr2||sqlstr1||' from '||upper(temp_table_name);
end P_UDP_EXPORT_SQL_BY_TABLE_NAME;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_PAGE_COMPONENTS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_UDP_PAGE_COMPONENTS" (containerGuid in varchar,pageComponents OUT sys_refcursor,treeSelect OUT sys_refcursor,tabs OUT sys_refcursor,tableColumn OUT sys_refcursor,buttoneEvent OUT sys_refcursor,eventMonitoring OUT sys_refcursor,datePicker OUT sys_refcursor)
AS  
haspage INTEGER;
BEGIN  
select count(1) into haspage  from UDP_PAGE where ID=containerGuid;
if haspage=1
then
open pageComponents for  
select   c.ID componentId,                                 --组件ID
c.COMPONENT_HIGH componentHeight,                          --组件高度
c.COMPONENT_WIDE componentWidth,                            --组件宽度
p.TITLE  pageTitle,                                                                    --页面标题
p.WINDOW_WIDTH  windowWidth,                                      --打开窗口宽度
p.WINDOW_HEIGHT windowHeight,                                     --打开窗口高度
c.COMPONENT_ORDER,                                                           --展示顺序 
c.COMPONENT_NAME componentName,                           --组件名称
c.COMPONENT_LABLE lable,                                                   --组件展示标题
c.COMPONENT_TYPE componentType,                                --组件类型
c.PLACEHOLDER placeholder,                                                 --展示水印文字
p.LAYOUT_TEMPLATE_ID templateName,                              --使用模板名称
l.LAYOUT_AREA_TEMPLATE_ID regionMark,                        --使用区域标识名称
s.IS_CHECK,                                                                                 --是否能够多选
s.IS_CHECKED_LAST_STAGE,                                                    --是否只能选中最末级
'' default_value,                                                                           --默认值
s.DATA_SOURCE_TYPE,                                                             --数据源类型
s.DATA_SOURCE componentSource,                                      --组件数据源
s.PK_FIELD,                                                                                    --主键字段
s.LABLE_FIELD,                                                                              --展示字段
c.DATA_SOURCE                                                                          --展示数据(TemplateHyperText、TemplateContainer)
 from  UDP_LAYOUT l  
 left join UDP_PAGE P on  l.page_id=p.ID
 left join UDP_COMPONENT c on  l.COMPONENT_ID=c.ID 
left join UDP_COMPONENT_DATA_SOURCE s on c.COMPONENT_DATA_SOURCE_ID=s.ID
where l.PAGE_ID=containerGuid and l.page_id=c.page_id order by c.COMPONENT_ORDER asc;
else
open pageComponents for  
select   c.ID componentId,                                                      --组件ID
c.COMPONENT_HIGH componentHeight,                          --组件高度
c.COMPONENT_WIDE componentWidth,                            --组件宽度
''  pageTitle,                                                                              --页面标题
''  windowWidth,                                                                       --打开窗口宽度
'' windowHeight,                                                                       --打开窗口高度
c.COMPONENT_ORDER ,                                                         --展示顺序 
c.COMPONENT_NAME componentName,                           --组件名称
c.COMPONENT_LABLE lable,                                                  --组件展示标题
c.COMPONENT_TYPE componentType,                               --组件类型
c.PLACEHOLDER placeholder,                                                --展示水印文字
'' templateName,                                                                        --模板名称
l.LAYOUT_AREA_TEMPLATE_ID regionMark,                       --使用区域标识名称
s.IS_CHECK,                                                                                --是否能够多选
s.IS_CHECKED_LAST_STAGE,                                                   --是否只能选中最末级
'' default_value,                                                                          --默认值
s.DATA_SOURCE_TYPE,                                                             --数据源类型
s.DATA_SOURCE componentSource,                                      --组件数据源
s.PK_FIELD,                                                                                    --主键字段
s.LABLE_FIELD,                                                                              --展示字段
c.DATA_SOURCE                                                                       --展示数据(TemplateHyperText、TemplateContainer)
from UDP_COMPONENT c
left join UDP_LAYOUT l on  l.COMPONENT_ID=c.ID 
left join UDP_COMPONENT_DATA_SOURCE s on c.COMPONENT_DATA_SOURCE_ID=s.ID
where c.PAGE_ID=containerGuid order by c.COMPONENT_ORDER asc;
end if;

open treeSelect for  
select  
c.id componentId,                                                                     --组件ID
t.default_expanded,                                                                  --默认展开
t.default_checked,                                                                      --默认选中
t.IS_CHECKED_LAST_STAGE                                                      --是否只能选中最末级
from  UDP_COMPONENT c 
left join UDP_COMPONENT_TREE_SELECT t on t.ID=c.id
where c.page_id=containerGuid and (c.component_type='TemplateTreeSelect') ;


open tabs for  
select  
c.id componentId,                                                               --组件ID
t.default_tabsitem,                                                              --默认选中项
t.layout_style,                                                                       --默认样式
i.ITEM_VALUE,                                                                       --tabs组件的项具体值
i.ITEM_LABLE,                                                                        --tabs组件的项展示值
i.ID                                                                                          --tabs组件的项ID
from  UDP_COMPONENT c 
left join UDP_COMPONENT_TABS t on t.ID=c.id
left join UDP_COMPONENT_TABS_ITEM i on t.ID=i.COMPONENT_TABS_ID
where c.page_id=containerGuid and (c.component_type='TemplateTabs') order by i.item_order;

open tableColumn for
select 
n.ID,
c.ID componentId,                                                     --组件ID
n.COLUMN_LABLE,                                                     --列标题
n.COLUMN_FIELD  ,                                                    --列字段名
n.COLUMN_WIDE ,                                                     --列宽度
n.COLUMN_ALIGN ,                                                   --列对齐
n.COLUMN_FIXED ,                                                    --浮动反方向（left,right）
2 COLUMN_NUMBER_FLOAT,                               --小数字段保留几位
n.COLUMN_DATA_TYPE ,                                         --数据类型
n.is_show_total,                                                          --是否显示合计
n.parent_column_id,                                                  --父级列主键
n.is_use_sort,                                                              --是否使用排序
d.IS_CHECK,                                                                 --是否复选
t.detail_url,                                                                   --双击行跳转地址
d.PK_FIELD,                                                                  --主键字段
n.JUMP_URL,                                                               --点击列跳转地址
n.OPEN_MODE,                                                           --点击列打开页面方式
t.OPEN_MODE DETAIL_MODE,                                 --双击行打开页面方式
n.WINDOW_WIDTH,                                                   --单击列打开弹窗的宽度
n.WINDOW_HEIGHT,                                                   --单击列打开弹窗的高度
n.DEAL_WITH_MODE,                                                  --单击列处理的模式
t.WINDOW_WIDTH as "ROW_WINDOW_WIDTH",  --双击行打开弹窗的宽度
t.WINDOW_HEIGHT as "ROW_WINDOW_WIDTH",  --双击行打开弹窗的高度
n.IS_USE_HTML,
'' is_show_stripe from UDP_COMPONENT c 
left join UDP_COMPONENT_TABLE_COLUMN n on c.ID=n.component_table_id
left join UDP_COMPONENT_TABLE  t on c.ID=t.ID
left join UDP_COMPONENT_DATA_SOURCE  d on d.ID=c.COMPONENT_DATA_SOURCE_ID
where c.page_id=containerGuid and (lower(c.component_type)='templatetable' or lower(c.component_type)='templatetreetable' )
and n.STATE=1
order by n.COLUMN_ORDER asc;
open buttoneEvent for
SELECT
    e.COMPONENT_BUTTON_ID,                                 --按钮组件ID
    b.TRADE_ID,                                                               --权限点ID
    b.icon,                                                                         --按钮图标
    e.EVENT_TYPE ,                                                          --按钮事件类型
    e.EXECUTE_TYPE ,                                                      --按钮执行类型
    e.EXECUTE_CONTENT,                                              --按钮执行内容
    e.DIALOG_TITLE,                                                        --点击弹窗标题
    e.DIALOG_CONTEN,                                                   --点击弹窗内容
    e.WINDOW_WIDTH,                                                   --打开弹窗的宽度
    e.WINDOW_HEIGHT                                                   --打开弹窗的高度
FROM
    UDP_COMPONENT c 
    left join UDP_COMPONENT_BUTTON_EVENT e  on c.ID=e.COMPONENT_BUTTON_ID
    left join udp_component_button b  on c.ID=b.ID
    where c.PAGE_ID=containerGuid and  e.COMPONENT_BUTTON_ID  is not null;

open eventMonitoring for
select 
m.ID,                                                                              --事件监听主键
m.COMPONENT_ID ,                                                   --组件ID
m.TARGET_COMPONENT_ID ,                                   --被监听组件ID
c.COMPONENT_TYPE ,                                                --组件类型
m.IS_MUST_MONITORING   from UDP_EVENT_MONITORING m 
left join UDP_COMPONENT c on m.TARGET_COMPONENT_ID=c.ID
where m.component_id in (select  c.ID   from UDP_COMPONENT c where  c.PAGE_ID=containerGuid);

open datePicker for
select 
c.ID componentId,                                                     --组件ID
d.START_TIME,                                                           --开始时间
d.END_TIME,                                                               --结束时间
d.DEFAULT_VALUE,                                                   --默认时间
d.VALUE_FORMAT                                                    --时间格式
from  UDP_COMPONENT c 
left join UDP_COMPONENT_DATE_PICKER d on c.ID=d.ID
where  c.PAGE_ID=containerGuid and (lower(c.component_type)='templatedatepicker' or lower(c.component_type)='templatedatetimepicker' );
END P_UDP_PAGE_COMPONENTS;

/
--------------------------------------------------------
--  DDL for Procedure P_UDP_PROCEDURE_CONFIG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_UDP_PROCEDURE_CONFIG" (procedure_code in varchar,procedureConfigs OUT sys_refcursor)
AS  
BEGIN  
open procedureConfigs for  
SELECT
    r.id,                                                                                 --存储过程配置信息表主键
    r.name,                                                                          --存储过程名
    r.code,                                                                            --配置标识code
    r.state,                                                                            --是否启用
    p.parameter_name,                                                      --存储过程参数名
    p.data_source_keyword,                                              --参数数据来源的关键字标识
    p.parameter_default,                                                    --参数默认值
    case  sys.IN_OUT                                                           --是否为输出参数
    when 'IN' then 1
    else 0 
    end as is_input_parameter,                                          --是否为输入参数
    sys.DATA_TYPE as parameter_type,                           --参数类型
    sys.SEQUENCE as sort                                                  --参数排序
FROM
    udp_procedure_registration r left join UDP_PROCEDURE_PARAMETER p on r.ID=p.PROCEDURE_REGISTRATION_ID
    left join sys.user_arguments sys on upper(r.name)=sys.OBJECT_NAME and upper(p.parameter_name)=sys.ARGUMENT_NAME
    where code=procedure_code;
END p_UDP_Procedure_Config;


/
--------------------------------------------------------
--  DDL for Procedure P_WFI_COPY_TO_INFO
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_WFI_COPY_TO_INFO" (
    noticePersons  IN   CLOB,              --用户code多个
    noticeGroups   IN    CLOB,             --虚拟组
    noticeProjectRoles    IN     CLOB,    --项目级角色
    noticeTitle    IN     varchar2,           -- 发送通知标题
    addressParams in varchar2,           --页面参数
    workItemID  in  varchar2,               --工作项ID
    processInstID  in varchar2,             --流程实例ID
    pchost in varchar2,                         --pc端域名
    mobilehost in varchar2,                   --pc端域名
    messageType out      varchar2,       --0:门户终端消息都推送，1：只推送门户，2：只推送短信或微信
    info     OUT      SYS_REFCURSOR     --消息集合
) IS
toreadpc  varchar2(1000);
toreadmobile  varchar2(1000);
systemId  varchar2(100);
systemappId  varchar2(100);
bizMsgCategory varchar2(100);
creater varchar2(100);
processName varchar2(4000);
portalMsgType number;
formcode  varchar2(1000);
addressParamsStr varchar2(1000);
begin
  execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd hh24:mi:ss''';
  toreadpc:=pchost||'/wfi-sys/process-operation';
  toreadmobile:=mobilehost||'/wfi/process-info';
  messageType:=1;
  portalMsgType:=10;
  bizMsgCategory:='催办消息';
  if addressParams is not null then
  addressParamsStr:=replace(addressParams,'||','&');
  end if;
  select PROCESS_INST_NAME,CREATEBY,FORM_CODE into processName,creater,formcode from WFI_PROCESS_INST where Id=processInstID and rownum=1;
  select f.SYSTEM_ID,s.APP_ID into systemId,systemappId from WFI_BIZ_FORM f left join SYS_APPLICATION s on f.SYSTEM_ID=s.ID  where f.FORM_CODE=formcode;
  p_wfi_person_role_analysis(
    noticePersons => noticePersons,
    noticeGroups => noticeGroups,
    noticeProjectRoles =>noticeProjectRoles
  );
 OPEN info FOR 
    select 
    creater as "senderAccount",                        --发送人
    persons.user_code as  "recipientAccount",    --接收人
    systemId as  "systemId",--系统id
    systemappId as   "appid",--应用id
    workItemID||persons.user_code as "bizKey",--业务id--门户网站的taskId
    bizMsgCategory as "bizMsgCategory",--消息所属类别
-------------------------------------------------------------【短信微信必须】基础信息 ------------------------------------------------------------
    '' as "msgChannel", --使用消息渠道 多个，逗号分隔   tjWeChat：铁建微信,tjSMS：铁建短信
    '' as "smsTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID  --{1}您好，{2}对您负责的任务“{3}”进行了催办，请及时到门户网站查看待办并在《计划管理系统》中反馈任务进度{4}。
    '[]' AS "smsParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
    ''  as "mobile",--短信接收人电话
    '' AS "wechatTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID
    '[]' AS "wechatParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
    '' AS "wechatJumplinkUrl",--微信打开地址，程序调用发消息前需要编码
    '' AS "title",--消息标题
    '' AS "bizSourceCategory",
-------------------------------------------------------------【门户消息必须】基础信息 ------------------------------------------------------------
    portalMsgType as "portalMsgType",
    CASE 
    when addressParamsStr is not null then
    toreadpc||'?'||addressParamsStr
    else 
    toreadpc end as "url",--pc端的url地址
    case when addressParamsStr is not null then
    toreadmobile||'?'||addressParamsStr 
    else toreadmobile  end as "mobileUrl",--移动端的url地址
    case 
    when noticeTitle is not null then
    noticeTitle||'―'||processName
    else 
    processName end as "taskname", --任务名称，等于3、插入待阅/4、插入已阅informationname;等于插入关注的attentionname
    '计划运营' as "typename",--任务类型
    '工作流平台待阅消息推送' as "remark",
     to_char(sysdate,'yyyy-MM-dd HH24:mi:ss')  "expiretime",--expiretime	否	String	过期时间，格式yyyy-MM-dd HH:mm:ss-----过期时间，除关注都有
     1  "priority"--priority	否	Integer	优先级，除关注都有 
    from 
    (select  distinct tab1.USER_ACCOUNT as user_code from (SELECT r.USER_CODE USER_ACCOUNT from (select code from PERSON_ROLE_ANALYSIS_TABLE where  type='person') tab left join SYS_USER r on r.USER_CODE = tab.code
   union select r.USER_ACCOUNT from  (select * from PERSON_ROLE_ANALYSIS_TABLE where  type='group' and detail  is not null) tab left join SYS_ROLE_USER_RELATION_RESULT r on 
   tab.code=r.VIRTUAL_GROUP_NAME where r.role_type=40 and (r.COMPANY_ID=tab.detail or r.DEPT_ID=tab.detail)
   union select r.USER_ACCOUNT from  (select * from PERSON_ROLE_ANALYSIS_TABLE where  type='projectRole'  and detail  is not null) tab left join SYS_ROLE_USER_RELATION_RESULT r on 
   tab.code=r.role_code  where r.role_type=30 and r.PROJECT_ID=tab.detail) tab1) persons where persons.user_code is not null;
END p_wfi_copy_to_info;

/
--------------------------------------------------------
--  DDL for Procedure P_WFI_FORM_DATA_BY_BIZ_ID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_WFI_FORM_DATA_BY_BIZ_ID" (
    biz_id in VARCHAR2,                    --业务主键
    process_inst_id in VARCHAR2,       --流程实例ID
    code OUT VARCHAR2,                  --业务表单code
    formData OUT SYS_REFCURSOR,    -- 输出表单数据结果集游标
    fieldData OUT SYS_REFCURSOR      -- 输出表单字段结果集游标
  )
AS
  v_sql    VARCHAR2(4000);                               
  id_field VARCHAR2(50);
  bizId VARCHAR2(50);
BEGIN
execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd hh24:mi:ss''';
SELECT 
    form_code,biz_id  into code,bizId
FROM
    wfi_process_inst where ID=process_inst_id and ROWNUM=1;
SELECT
    d.field_name INTO id_field
FROM
    wfi_biz_form f,wfi_biz_field d 
where form_code=code and f.id=d.form_id and d.is_pk=1 and ROWNUM=1;
SELECT
    form_sql INTO v_sql
FROM
    wfi_biz_form where form_code=code and ROWNUM=1;
open fieldData for  
SELECT
   d. chinese_name,d.field_name,d.IS_SHOW
FROM
    wfi_biz_form f,wfi_biz_field d 
where form_code=code and f.id=d.form_id and form_code=code order by d.sort;
if  instr(v_sql,'{bizId}',1,1)<>0 then
   v_sql :=replace(v_sql,'{bizId}',bizId);
else 
     v_sql :=replace(v_sql,';','');
    v_sql  :='select * from (' || v_sql || ' ) where  ROWNUM=1 and   '||id_field||' =  '''|| bizId||'''';
end if;
    dbms_output.put_line(v_sql);
OPEN formData FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE formData;
END P_WFI_FORM_DATA_BY_BIZ_ID;

/
--------------------------------------------------------
--  DDL for Procedure P_WFI_PERSON_ROLE_ANALYSIS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_WFI_PERSON_ROLE_ANALYSIS" (
    noticePersons  IN   CLOB,     --用户code多个
    noticeGroups   IN    CLOB,    --虚拟组
    noticeProjectRoles    IN     CLOB --项目级角色
) IS
begin
delete PERSON_ROLE_ANALYSIS_TABLE;

if noticePersons is not null then
insert into PERSON_ROLE_ANALYSIS_TABLE (code , type ) SELECT COLUMN_VALUE ,'person' as type 
FROM table (split (noticePersons,';'));
end if;

if noticeGroups is not null then
insert into PERSON_ROLE_ANALYSIS_TABLE SELECT splitstr(COLUMN_VALUE,1) as code,splitstr(COLUMN_VALUE,2) as detail ,'group' as type 
FROM table (split (noticeGroups,';'));
end if;

if noticeProjectRoles is not null then
insert into PERSON_ROLE_ANALYSIS_TABLE SELECT splitstr(COLUMN_VALUE,1) as code,splitstr(COLUMN_VALUE,2) as detail ,'projectRole' as type 
FROM table (split (noticeProjectRoles,';'));
end if;

end p_wfi_person_role_analysis;

/
--------------------------------------------------------
--  DDL for Procedure P_WFI_SAVE_FORM_CATALOG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."P_WFI_SAVE_FORM_CATALOG" (systemId in VARCHAR2, UUID in VARCHAR2,NEWUUID in VARCHAR2,CATALOGCODE in VARCHAR2,CATALOGNAME in varchar,code OUT NUMBER,msg OUT VARCHAR2)
as
  row_count number;
  appid VARCHAR2(36);
BEGIN
  select count(1) into row_count from SYS_APPLICATION where id=systemId;
  if row_count=1 then
    select APP_ID into appid from SYS_APPLICATION where id=systemId;
    select count(1) into row_count from WFI_BIZ_FORM_CATALOG where ID=UUID;
    if row_count=0 then
        Insert into WFI_BIZ_FORM_CATALOG (ID,APP_ID,CODE,NAME) values (UUID,appid,CATALOGCODE,CATALOGNAME);
        code:=0;
        msg:='保存业务目录信息成功';
    else
        UPDATE WFI_BIZ_FORM_CATALOG SET APP_ID=appid,CODE=CATALOGCODE,NAME=CATALOGNAME,ID=NEWUUID WHERE ID=UUID;
        select count(1) into row_count from WFI_BIZ_FORM where CATALOG_UUID=UUID;
            if  row_count<>0 then
                UPDATE WFI_BIZ_FORM SET BELONG_SYSTEM=CATALOGCODE,SYSTEM_ID=systemId,CATALOG_UUID=NEWUUID WHERE CATALOG_UUID=UUID;
            end if;
           code:=0;
           msg:='保存业务目录信息成功';
    end if;
  ELSE
  code:=1000;
  msg:='保存参数无效';
  end if;
  exception 
        when DUP_VAL_ON_INDEX then 
        code:=100;
        msg:='业务目录ID重复';
        rollback;
END P_WFI_SAVE_FORM_CATALOG;

/
--------------------------------------------------------
--  DDL for Procedure POM_KEY_NODE_MY_REMINDER
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."POM_KEY_NODE_MY_REMINDER" 
(
    REMINDERGUID IN VARCHAR2,
    pageIndex    IN INT,
    pageSize     IN INT,
    total        OUT INT,
    items        OUT SYS_REFCURSOR
)
IS
    v_count clob;
    v_sql clob;
BEGIN
    v_sql := '
    SELECT *
    FROM (SELECT tt.*, ROWNUM AS rowno
          FROM (
            select total.* from  (
                           select
                               node.id AS "id",
                               node.original_node_id  AS "nodeOriginalId",
                               --未到期不亮灯
                               case WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
                                   --到期当天内完成反馈
                                    when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
                                        then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
                                   --到期1-5天内完成反馈
                                   when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
                                         then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                    --到期未反馈黄灯
                                    WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 0 and 5
                                             THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                    --到期超过5天未反馈红灯
                                    WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(NODE.PLAN_END_DATE)) >5)
                                             THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
                                         ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END AS "warnState",
                                    case when node.actual_end_date is not null
                                            then ''已完成''
                                        when to_char(node.plan_end_date,''YYYY-MM-DD'') >to_char(sysdate,''YYYY-MM-DD'') and node.actual_end_date is  null
                                            then ''未到期''
                                        when TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') < TO_CHAR(sysdate, ''YYYY-MM-DD'') and node.actual_end_date is  null
                                            then ''<span style="color:red">已超期</span>'' end as "taskState" ,
                                    TO_CHAR(smrb.created_time, ''YYYY-MM-DD'')  AS "urgeTime",
                                    node.node_name AS "taskName",
                                    node.node_level  AS "taskLevel",
                                    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'')  AS "planTime",
                                    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'')  AS "estimateTime",
                                    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'')  AS "realityTime",
                                    plan.plan_type AS "planType",
                                    plan.id AS "planId",
                                    nvl(sp.project_name, sps.stage_full_name) AS "originProj",
                                    plan.plan_name AS "originPlan",
                                    node.duty_department AS "dutyDept",
                                    unit.org_name AS "secondCompany"
                          from SYS_MSG_RECORD_BIZ smrb
                                   left join SYS_MSG_RECORD_SMS smrs on smrs.MSG_RECORD_BIZ_ID = smrb.ID
                                   left join sys_user sy on smrs.sender_id = sy.user_code
                                   left join pom_proj_plan_node node on smrb.BIZ_KEY = node.id
                                   left join pom_proj_plan plan on node.proj_plan_id = plan.id
                                   left join sys_project sp on plan.proj_id = sp.id
                                   left join sys_project_stage sps on plan.proj_id = sps.id
                                   left join sys_business_unit unit on plan.company_id = unit.id
                          where smrb.biz_msg_category = ''催办消息''
                            and smrb.system_id = ''71313f018a35f3a558166cba7599b5d6''
                            and plan.plan_type = ''关键节点计划''
                            and plan.approval_status = ''已审核''
                            and sy.id = '''||REMINDERGUID||'''
                            and node.is_disable = 0
                          union
                            select
                                node.id AS "id",
                                node.original_node_id  AS "nodeOriginalId",
                                --未到期不亮灯
                                case WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
                                    --到期当天内完成反馈
                                     when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
                                         then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
                                    --到期1-5天内完成反馈
                                    when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
                                         then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                --到期未反馈黄灯
                                WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 0 and 5
                                         THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                --到期超过5天未反馈红灯
                                WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(NODE.PLAN_END_DATE)) >5)
                                         THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
                                     ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END AS "warnState",
                                case when node.actual_end_date is not null
                                        then ''已完成''
                                    when to_char(node.plan_end_date,''YYYY-MM-DD'') >to_char(sysdate,''YYYY-MM-DD'') and node.actual_end_date is  null
                                        then ''未到期''
                                    when TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') < TO_CHAR(sysdate, ''YYYY-MM-DD'') and node.actual_end_date is  null
                                        then ''<span style="color:red">已超期</span>'' end as "taskState" ,
                                TO_CHAR(smrb.created_time, ''YYYY-MM-DD'')  AS "urgeTime",
                                node.node_name AS "taskName",
                                node.node_level  AS "taskLevel",
                                TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'')  AS "planTime",
                                TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'')  AS "estimateTime",
                                TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'')  AS "realityTime",
                                plan.plan_type AS "planType",
                                plan.id AS "planId",
                                nvl(sp.project_name, sps.stage_full_name) AS "originProj",
                                plan.plan_name AS "originPlan",
                                node.duty_department AS "dutyDept",
                                unit.org_name AS "secondCompany"
                          from SYS_MSG_RECORD_BIZ smrb
                              left join SYS_MSG_RECORD_WECHAT smrw on smrw.MSG_RECORD_BIZ_ID = smrb.ID
                              left join sys_user sy on smrw.sender_id = sy.user_code
                              left join pom_proj_plan_node node on smrb.BIZ_KEY = node.id
                              left join pom_proj_plan plan on node.proj_plan_id = plan.id
                              left join sys_project sp on plan.proj_id = sp.id
                              left join sys_project_stage sps on plan.proj_id = sps.id
                              left join sys_business_unit unit on plan.company_id = unit.id
                          where
                              smrb.biz_msg_category = ''催办消息''
                            and smrb.system_id = ''71313f018a35f3a558166cba7599b5d6''
                            and plan.plan_type=''关键节点计划''
                            and plan.approval_status=''已审核''
                            and sy.id='''||REMINDERGUID||'''
                            and node.is_disable = 0
                        union
                            select
                                node.id AS "id",
                                node.original_node_id  AS "nodeOriginalId",
                                --未到期不亮灯
                                case WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
                                    --到期当天内完成反馈
                                     when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
                                         then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
                                    --到期1-5天内完成反馈
                                    when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
                                         then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                --到期未反馈黄灯
                                WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 0 and 5
                                         THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                --到期超过5天未反馈红灯
                                WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(NODE.PLAN_END_DATE)) >5)
                                         THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
                                     ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END AS "warnState",
                                case when node.actual_end_date is not null
                                        then ''已完成''
                                    when to_char(node.plan_end_date,''YYYY-MM-DD'') >to_char(sysdate,''YYYY-MM-DD'') and node.actual_end_date is  null
                                        then ''未到期''
                                    when TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') < TO_CHAR(sysdate, ''YYYY-MM-DD'') and node.actual_end_date is  null
                                        then ''<span style="color:red">已超期</span>'' end as "taskState" ,
                                TO_CHAR(smc.created, ''YYYY-MM-DD'')  AS "urgeTime",
                                node.node_name AS "taskName",
                                node.node_level  AS "taskLevel",
                                TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'')  AS "planTime",
                                TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'')  AS "estimateTime",
                                TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'')  AS "realityTime",
                                plan.plan_type AS "planType",
                                plan.id AS "planId",
                                nvl(sp.project_name, sps.stage_full_name) AS "originProj",
                                plan.plan_name AS "originPlan",
                                node.duty_department AS "dutyDept",
                                unit.org_name AS "secondCompany"
                          from sys_message_center smc
                              left join sys_user sy on smc.creator_name = sy.user_code
                              left join pom_proj_plan_node node on smc.task_id = node.id
                              left join pom_proj_plan plan on node.proj_plan_id = plan.id
                              left join sys_project sp on plan.proj_id = sp.id
                              left join sys_project_stage sps on plan.proj_id = sps.id
                              left join sys_business_unit unit on plan.company_id = unit.id
                          where
                              smc.biz_msg_category = ''催办消息''
                            and plan.plan_type=''关键节点计划''
                            and plan.approval_status=''已审核''
                            and sy.id='''||REMINDERGUID||'''
                            and node.is_disable = 0
        )total order by total."planTime" asc
    ) tt
           WHERE ROWNUM <= '||pageSize||' * '||pageIndex||' )table_alias
           WHERE table_alias.rowno >= '||pageSize||' * ( '||pageIndex||' -1) + 1 ';

    v_count := 'select count(*) from  (
                           select
                               node.id AS "id",
                               node.original_node_id  AS "nodeOriginalId",
                               --未到期不亮灯
                               case WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
                                   --到期当天内完成反馈
                                    when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
                                        then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
                                   --到期1-5天内完成反馈
                                   when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
                                         then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                    --到期未反馈黄灯
                                    WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 0 and 5
                                             THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                    --到期超过5天未反馈红灯
                                    WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(NODE.PLAN_END_DATE)) >5)
                                             THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
                                         ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END AS "warnState",
                                    case when node.actual_end_date is not null
                                            then ''已完成''
                                        when to_char(node.plan_end_date,''YYYY-MM-DD'') >to_char(sysdate,''YYYY-MM-DD'') and node.actual_end_date is  null
                                            then ''未到期''
                                        when TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') < TO_CHAR(sysdate, ''YYYY-MM-DD'') and node.actual_end_date is  null
                                            then ''<span style="color:red">已超期</span>'' end as "taskState" ,
                                    TO_CHAR(smrb.created_time, ''YYYY-MM-DD'')  AS "urgeTime",
                                    node.node_name AS "taskName",
                                    node.node_level  AS "taskLevel",
                                    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'')  AS "planTime",
                                    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'')  AS "estimateTime",
                                    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'')  AS "realityTime",
                                    plan.plan_type AS "planType",
                                    plan.id AS "planId",
                                    nvl(sp.project_name, sps.stage_full_name) AS "originProj",
                                    plan.plan_name AS "originPlan",
                                    node.duty_department AS "dutyDept",
                                    unit.org_name AS "secondCompany"
                          from SYS_MSG_RECORD_BIZ smrb
                                   left join SYS_MSG_RECORD_SMS smrs on smrs.MSG_RECORD_BIZ_ID = smrb.ID
                                   left join sys_user sy on smrs.sender_id = sy.user_code
                                   left join pom_proj_plan_node node on smrb.BIZ_KEY = node.id
                                   left join pom_proj_plan plan on node.proj_plan_id = plan.id
                                   left join sys_project sp on plan.proj_id = sp.id
                                   left join sys_project_stage sps on plan.proj_id = sps.id
                                   left join sys_business_unit unit on plan.company_id = unit.id
                          where smrb.biz_msg_category = ''催办消息''
                            and smrb.system_id = ''71313f018a35f3a558166cba7599b5d6''
                            and plan.plan_type = ''关键节点计划''
                            and plan.approval_status = ''已审核''
                            and sy.id = '''||REMINDERGUID||'''
                            and node.is_disable = 0
                          union
                            select
                                node.id AS "id",
                                node.original_node_id  AS "nodeOriginalId",
                                --未到期不亮灯
                                case WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
                                    --到期当天内完成反馈
                                     when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
                                         then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
                                    --到期1-5天内完成反馈
                                    when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
                                         then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                --到期未反馈黄灯
                                WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 0 and 5
                                         THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                --到期超过5天未反馈红灯
                                WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(NODE.PLAN_END_DATE)) >5)
                                         THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
                                     ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END AS "warnState",
                                case when node.actual_end_date is not null
                                        then ''已完成''
                                    when to_char(node.plan_end_date,''YYYY-MM-DD'') >to_char(sysdate,''YYYY-MM-DD'') and node.actual_end_date is  null
                                        then ''未到期''
                                    when TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') < TO_CHAR(sysdate, ''YYYY-MM-DD'') and node.actual_end_date is  null
                                        then ''<span style="color:red">已超期</span>'' end as "taskState" ,
                                TO_CHAR(smrb.created_time, ''YYYY-MM-DD'')  AS "urgeTime",
                                node.node_name AS "taskName",
                                node.node_level  AS "taskLevel",
                                TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'')  AS "planTime",
                                TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'')  AS "estimateTime",
                                TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'')  AS "realityTime",
                                plan.plan_type AS "planType",
                                plan.id AS "planId",
                                nvl(sp.project_name, sps.stage_full_name) AS "originProj",
                                plan.plan_name AS "originPlan",
                                node.duty_department AS "dutyDept",
                                unit.org_name AS "secondCompany"
                          from SYS_MSG_RECORD_BIZ smrb
                              left join SYS_MSG_RECORD_WECHAT smrw on smrw.MSG_RECORD_BIZ_ID = smrb.ID
                              left join sys_user sy on smrw.sender_id = sy.user_code
                              left join pom_proj_plan_node node on smrb.BIZ_KEY = node.id
                              left join pom_proj_plan plan on node.proj_plan_id = plan.id
                              left join sys_project sp on plan.proj_id = sp.id
                              left join sys_project_stage sps on plan.proj_id = sps.id
                              left join sys_business_unit unit on plan.company_id = unit.id
                          where
                              smrb.biz_msg_category = ''催办消息''
                            and smrb.system_id = ''71313f018a35f3a558166cba7599b5d6''
                            and plan.plan_type=''关键节点计划''
                            and plan.approval_status=''已审核''
                            and sy.id='''||REMINDERGUID||'''
                            and node.is_disable = 0
                        union
                            select
                                node.id AS "id",
                                node.original_node_id  AS "nodeOriginalId",
                                --未到期不亮灯
                                case WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
                                    --到期当天内完成反馈
                                     when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
                                         then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
                                    --到期1-5天内完成反馈
                                    when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
                                         then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                --到期未反馈黄灯
                                WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 0 and 5
                                         THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                --到期超过5天未反馈红灯
                                WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(NODE.PLAN_END_DATE)) >5)
                                         THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
                                     ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END AS "warnState",
                                case when node.actual_end_date is not null
                                        then ''已完成''
                                    when to_char(node.plan_end_date,''YYYY-MM-DD'') >to_char(sysdate,''YYYY-MM-DD'') and node.actual_end_date is  null
                                        then ''未到期''
                                    when TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') < TO_CHAR(sysdate, ''YYYY-MM-DD'') and node.actual_end_date is  null
                                        then ''<span style="color:red">已超期</span>'' end as "taskState" ,
                                TO_CHAR(smc.created, ''YYYY-MM-DD'')  AS "urgeTime",
                                node.node_name AS "taskName",
                                node.node_level  AS "taskLevel",
                                TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'')  AS "planTime",
                                TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'')  AS "estimateTime",
                                TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'')  AS "realityTime",
                                plan.plan_type AS "planType",
                                plan.id AS "planId",
                                nvl(sp.project_name, sps.stage_full_name) AS "originProj",
                                plan.plan_name AS "originPlan",
                                node.duty_department AS "dutyDept",
                                unit.org_name AS "secondCompany"
                          from sys_message_center smc
                              left join sys_user sy on smc.creator_name = sy.user_code
                              left join pom_proj_plan_node node on smc.task_id = node.id
                              left join pom_proj_plan plan on node.proj_plan_id = plan.id
                              left join sys_project sp on plan.proj_id = sp.id
                              left join sys_project_stage sps on plan.proj_id = sps.id
                              left join sys_business_unit unit on plan.company_id = unit.id
                          where
                              smc.biz_msg_category = ''催办消息''
                            and plan.plan_type=''关键节点计划''
                            and plan.approval_status=''已审核''
                            and sy.id=:c
                            and node.is_disable = 0 )total';
     execute immediate v_count into total using REMINDERGUID;
    --dbms_output.put_line(v_sql);

     open items FOR v_sql;

END POM_KEY_NODE_MY_REMINDER;

/
--------------------------------------------------------
--  DDL for Procedure POM_KEY_NODE_MY_WATCH
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."POM_KEY_NODE_MY_WATCH" 
(
    WatcherID    IN VARCHAR2,
    pageIndex    IN INT,
    pageSize     IN INT,
    total        OUT INT,
    items        OUT SYS_REFCURSOR
)
    IS
    v_count clob;
    v_sql clob;
BEGIN
    v_sql := 'SELECT *
    FROM (SELECT tt.*, ROWNUM AS rowno
          FROM (
                   select
                       node.id AS "id",
                       node.node_Name AS "taskName",
                       node.original_node_id  AS "nodeOriginalId",			
                       plan.id AS "planId",
                       case
                           --未到期不亮灯
                           WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
                           --到期当天内完成反馈
                           when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
                               then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
                           --到期1-5天内完成反馈
                           when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
                               then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                           --到期未反馈黄灯
                           WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 0 and 5
                               THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                           --到期超过5天未反馈红灯
                           WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(NODE.PLAN_END_DATE)) >5)
                               THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
                           ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' end as "warnState",
                       case when node.actual_end_date is not null
                                then ''已完成''
                            when to_char(node.plan_end_date,''YYYY-MM-DD'') >to_char(sysdate,''YYYY-MM-DD'') and node.actual_end_date is  null
                                then ''未到期''
                            when TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') < TO_CHAR(sysdate, ''YYYY-MM-DD'') and node.actual_end_date is  null
                                then ''<span style="color:red">已超期</span>'' end as "taskState" ,
                       TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') AS "planTime",
                       case when feed.approval_status = ''已审核''
                            then TO_CHAR(node.ESTIMATE_END_DATE, ''YYYY-MM-DD'')
                       else '''' end AS "estimateTime",
                       TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') AS "realityTime",
                       plan.plan_type AS "planType",
                       nvl(sp.project_name, sps.stage_full_name) AS "originProj",
                       plan.plan_name AS "originPlan",
                       node.node_level AS "taskLevel",
                       node.duty_department AS "dutyDept",
                       unit.org_name AS "secondCompany"
                   from sys_biz_watch sbw
                             left join pom_proj_plan_node node on sbw.biz_id = node.id
                            left join pom_proj_plan plan on node.proj_plan_id = plan.id
                            left join pom_node_feedback feed on node.feedback_id = feed.id
                            left join sys_project sp on plan.proj_id = sp.id
                            left join sys_project_stage sps on plan.proj_id = sps.id
                            left join sys_business_unit unit on plan.company_id = unit.id
                   where is_un_watch = 0 and watcher_id = '''||WatcherID||''' and plan.plan_type=''关键节点计划'' and plan.approval_status=''已审核'' and node.is_disable = 0 order by node.plan_end_date asc
               ) tt
           WHERE ROWNUM <= '||pageSize||' * '||pageIndex||') table_alias
 WHERE table_alias.rowno >= '||pageSize||' * ('||pageIndex||'-1) + 1';
    v_count := 'select count(*) from sys_biz_watch sbw
                             left join pom_proj_plan_node node on sbw.biz_id = node.id
                            left join pom_proj_plan plan on node.proj_plan_id = plan.id
                            left join pom_node_feedback feed on node.feedback_id = feed.id
                            left join sys_project sp on plan.proj_id = sp.id
                            left join sys_project_stage sps on plan.proj_id = sps.id
                            left join sys_business_unit unit on plan.company_id = unit.id
                   where is_un_watch = 0 and watcher_id = :c and plan.plan_type=''关键节点计划'' and plan.approval_status=''已审核'' and node.is_disable = 0 order by node.plan_end_date asc';
     execute immediate v_count into total using WatcherID;
    --dbms_output.put_line(v_sql);
    open items for v_sql;
END POM_KEY_NODE_MY_WATCH;

/
--------------------------------------------------------
--  DDL for Procedure POM_KEY_NODE_SCHEDULE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "POM"."POM_KEY_NODE_SCHEDULE" 
(
    companyGUID IN VARCHAR2,
    items OUT SYS_REFCURSOR
)IS
    v_sql clob;
    v_id clob;
BEGIN
    IF companyGUID IS NULL THEN
        v_id := '0001';
    ELSE
        v_id := companyGUID;
    END IF;
    v_sql :='with temp_origin as (
        select connect_by_isleaf as IS_END ,org.*,project_name,nvl(validtasks,0) AS validTasks,nvl(completenum,0) AS completenum,nvl(completed,0) AS completed,nvl(unfinished,0) AS unfinished,nvl(needResult,0) AS needResult,nvl(realResult,0) AS realResult,nvl(greenLight,0) AS greenLight,
        nvl(yellowLight,0) AS yellowLight,nvl(redlight,0) AS redlight,nvl(micompletenum,0) AS micompletenum,nvl(micompleted,0) AS micompleted,nvl(miunfinished,0) AS miunfinished,
        nvl(olcompletenum,0) AS olcompletenum,nvl(olcompleted,0) AS olcompleted,nvl(olunfinished,0) AS olunfinished,completionrate,dynamicresult
        from (
        select *
        from (select id, org_name as company, org_full_name, parent_id, ''1'' as isCompany,'''' as jumpUrl,order_hierarchy_code as code
        from sys_business_unit
        where is_company = 1)
        union
        select id, project_name as company, '''' as org_full_name, unit_id as parent_id, ''0'' as isCompany,''/pom/plan-assess/node-monitoring/plan-nodes?companyid=''||proj.unit_id||''&ppid=''||proj.id||''&planType=关键节点计划'' as jumpUrl,'''' as code
        from sys_project proj
        union
        select *
        from (select stage.id, stage.stage_full_name as company, stage.stage_full_name as org_full_name, stage.project_id as parent_id, ''0'' as isCompany,''/pom/plan-assess/node-monitoring/plan-nodes?companyid=''||sysP.unit_id||''&ppid=''||stage.id||''&planType=关键节点计划'' as jumpUrl,'''' as code
        from sys_project_stage stage left join sys_project sysP on stage.project_id = sysP.id
        order by stage.sn desc)
        ) org --组织主表
        left join
        (
        select proj.*,
        case when proj.validTasks is null or proj.validTasks = 0 or proj.completed = 0 then
        ''0''
        else to_char((proj.completed / proj.validTasks)*100, ''9999999990.00'') end as completionRate,
        case when proj.needResult is null or proj.needResult = 0 or proj.realResult = 0 then
        ''0''
        else to_char((proj.realResult / proj.needResult)*100, ''9999999990.00'') end as dynamicResult
        FROM (
        select A.*,B.completeNum,C.completed,D.unfinished,N.needResult,O.realResult,E.greenLight,F.yellowLight,G.redLight,H.miCompleteNum,I.miCompleted,J.miUnfinished,
        K.olCompleteNum,L.olCompleted,M.olUnfinished
        from (
        select sp.id, sp.project_name, nvl(count(node.id), 0) as validTasks
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --有效节点
        ) A
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS completeNum
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where to_char(node.plan_end_date, ''YYYY-MM-DD'') <= to_char(sysdate, ''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --应完成
        ) B ON A.ID = B.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS completed
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.actual_end_date is not null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --已完成
        ) C ON A.ID = C.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS unfinished
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.actual_end_date is null
        and node.is_disable = 0
        and to_char(node.plan_end_date,''YYYY-MM-DD'') <= to_char(sysdate,''YYYY-MM-DD'')
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --未完成
        ) D ON A.ID = D.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS greenLight
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where (TRUNC(ACTUAL_END_DATE) - trunc(PLAN_END_DATE)) <= 0
        and actual_end_date is null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --绿灯
        ) E ON A.ID = E.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS yellowLight
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where (((TRUNC(ACTUAL_END_DATE) - trunc(PLAN_END_DATE)) BETWEEN 1 and 5) or
        ((trunc(SYSDATE) - trunc(PLAN_END_DATE)) BETWEEN 0 and 5))
        and actual_end_date is null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --黄灯
        ) F ON A.ID = F.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS redLight
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where ACTUAL_END_DATE IS NULL
        and ((trunc(SYSDATE) - trunc(NODE.PLAN_END_DATE)) > 5)
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --红灯
        ) G ON A.ID = G.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS miCompleteNum
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''里程碑''
        and to_char(node.plan_end_date, ''YYYY-MM-DD'') <= to_char(sysdate, ''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --里程碑应完成
        ) H ON A.ID = H.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS miCompleted
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''里程碑''
        and actual_end_date is not null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --里程碑已完成
        ) I ON A.ID = I.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS miUnfinished
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''里程碑''
        and to_char(node.plan_end_date,''YYYY-MM-DD'') <= to_char(sysdate,''YYYY-MM-DD'')
        and ACTUAL_END_DATE IS NULL
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --里程碑未完成
        ) J ON A.ID = J.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS olCompleteNum
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''一级节点''
        and to_char(node.plan_end_date, ''YYYY-MM-DD'') <= to_char(sysdate, ''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --一级节点应完成
        ) K ON A.ID = K.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS olCompleted
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''一级节点''
        and actual_end_date is not null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --一级节点已完成
        ) L ON A.ID = L.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS olUnfinished
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''一级节点''
        and ACTUAL_END_DATE IS NULL
        and to_char(node.plan_end_date,''YYYY-MM-DD'') <= to_char(sysdate,''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --一级节点未完成
        ) M ON A.ID = M.ID

        left join
        (
        select sp.id, sp.project_name, nvl(sum(node.standard_score), 0) AS needResult
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --应得总分
        ) N ON A.ID = N.ID
        left join
        (
        select sp.id, sp.project_name, nvl(sum(exam.standard_score), 0) AS realResult
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        left join pom_node_examination exam on node.id = exam.original_node_id
        where node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --实际得分
        ) O ON A.ID = O.ID
        )proj
        union
        select projs.*,
        case when projs.validTasks is null or projs.validTasks = 0 or projs.completed = 0 then
        ''0''
        else to_char((projs.completed / projs.validTasks)*100, ''9999999990.00'') end as completionRate,
        case when projs.needResult is null or projs.needResult = 0 or projs.realResult = 0 then
        ''0''
        else to_char((projs.realResult / projs.needResult)*100, ''9999999990.00'') end as dynamicResult
        FROM (
        select A.*,B.completeNum,C.completed,D.unfinished,N.needResult,O.realResult,E.greenLight,F.yellowLight,G.redLight,H.miCompleteNum,I.miCompleted,J.miUnfinished,
        K.olCompleteNum,L.olCompleted,M.olUnfinished
        from (
        select sp.id,sp.stage_full_name as project_name, nvl(count(node.id), 0) as validTasks
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --有效节点
        ) A
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS completeNum
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where to_char(node.plan_end_date, ''YYYY-MM-DD'') <= to_char(sysdate, ''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --应完成
        ) B ON A.ID = B.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS completed
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.actual_end_date is not null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --已完成
        ) C ON A.ID = C.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS unfinished
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.actual_end_date is null
        and node.is_disable = 0
        and to_char(node.plan_end_date,''YYYY-MM-DD'') <= to_char(sysdate,''YYYY-MM-DD'')
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --未完成
        ) D ON A.ID = D.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS greenLight
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where (TRUNC(ACTUAL_END_DATE) - trunc(PLAN_END_DATE)) <= 0
        and actual_end_date is null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --绿灯
        ) E ON A.ID = E.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS yellowLight
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where (((TRUNC(ACTUAL_END_DATE) - trunc(PLAN_END_DATE)) BETWEEN 1 and 5) or
        ((trunc(SYSDATE) - trunc(PLAN_END_DATE)) BETWEEN 0 and 5))
        and actual_end_date is null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --黄灯
        ) F ON A.ID = F.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS redLight
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where ACTUAL_END_DATE IS NULL
        and ((trunc(SYSDATE) - trunc(NODE.PLAN_END_DATE)) > 5)
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --红灯
        ) G ON A.ID = G.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS miCompleteNum
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''里程碑''
        and to_char(node.plan_end_date, ''YYYY-MM-DD'') <= to_char(sysdate, ''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --里程碑应完成
        ) H ON A.ID = H.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS miCompleted
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''里程碑''
        and actual_end_date is not null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --里程碑已完成
        ) I ON A.ID = I.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS miUnfinished
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''里程碑''
        and ACTUAL_END_DATE IS NULL
        and to_char(node.plan_end_date,''YYYY-MM-DD'') <= to_char(sysdate,''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --里程碑未完成
        ) J ON A.ID = J.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS olCompleteNum
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''一级节点''
        and to_char(node.plan_end_date, ''YYYY-MM-DD'') <= to_char(sysdate, ''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --一级节点应完成
        ) K ON A.ID = K.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS olCompleted
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''一级节点''
        and actual_end_date is not null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --一级节点已完成
        ) L ON A.ID = L.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS olUnfinished
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''一级节点''
        and ACTUAL_END_DATE IS NULL
        and to_char(node.plan_end_date,''YYYY-MM-DD'') <= to_char(sysdate,''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --一级节点未完成
        ) M ON A.ID = M.ID

        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(sum(node.standard_score), 0) AS needResult
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --应得总分
        ) N ON A.ID = N.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(sum(exam.standard_score), 0) AS realResult
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        left join pom_node_examination exam on node.id = exam.original_node_id
        where node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --实际得分
        ) O ON A.ID = O.ID
        )projs
        ) statistics on org.id = statistics.id    --节点统计
        start with org.id = '''||v_id||'''
        connect by prior org.id = parent_id
        )
    SELECT fullAll.*,CASE WHEN fullAll.ISEND =''1'' and fullAll.isCompany=''0'' then
                                  ''<span style="color:#409eff">''||company||''</span>''
                          else company end as "company"
    FROM (
             SELECT id as "id",t1.company as company,org_full_name as "fullName",parent_id as "parentId", to_char(IS_END) AS isEnd,t1.isCompany, t1.jumpUrl as "jumpUrl",
                    (select sum(validTasks) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "validTasks",
                    (select sum(completenum) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "completeNum",
                    (select sum(completed) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "completed",
                    (select sum(unfinished) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "unfinished",
                    (select sum(needResult) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "needResult",
                    (select sum(realResult) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "realResult",
                    (select sum(greenLight) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "greenLight",
                    (select sum(yellowLight) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "yellowLight",
                    (select sum(redlight) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "redLight",
                    (select sum(micompletenum) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "miCompleteNum",
                    (select sum(micompleted) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "miCompleted",
                    (select sum(miunfinished) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "miUnfinished",
                    (select sum(olcompletenum) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "olCompleteNum",
                    (select sum(olcompleted) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "olCompleted",
                    (select sum(olunfinished) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "olUnfinished",
                    case when
                                     (select sum(completeNum) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) is null or
                                     (select sum(completeNum) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) = 0 or
                                     (select sum(completed) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) = 0 then
                             ''0%''
                         else to_char(((select sum(completed) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) /
                                       (select sum(completeNum) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id))*100, ''9999999990.00'') ||''%'' end as "completionRate",
                    case when
                                     (select sum(needResult) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) is null or
                                     (select sum(needResult) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) = 0 or
                                     (select sum(realResult) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) = 0 then
                             ''0''
                         else to_char(((select sum(realResult) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) /
                                       (select sum(needResult) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id))*100, ''9999999990.00'') end as "dynamicResult",
                    (select count(validTasks) from temp_origin  where isCompany =''0''  start with t1.id=parent_id connect by prior id=parent_id ) as "childrenLength"
             FROM temp_origin t1 order by t1.code
         ) fullAll where (fullAll."childrenLength">0 and fullAll."childrenLength" is not null and fullAll.isCompany =''1'') or fullAll.isCompany = ''0''';
    open items for v_sql;

END POM_KEY_NODE_SCHEDULE;

/
