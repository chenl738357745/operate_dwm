???prompt PL/SQL Developer Export User Objects for user POM0813@127.0.0.1/ORCL
prompt Created by wang on 2020年8月13日
set define off
spool 0813视图及存储过程脚本导出.log

prompt
prompt Creating view A1_POM_IMPORT_CHECK
prompt =================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.A1_POM_IMPORT_CHECK AS
SELECT (SELECT P.ORG_NAME FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 AND p.LEVEL_RANK=2 START WITH p.ID = b.COMPANY_ID CONNECT BY PRIOR p.PARENT_ID = p.ID) AS 所属二级单位,B.COMPANY_NAME AS 所属公司,B.PLAN_NAME, B.PROJ_NAME AS 所属项目, A.项目ID, A.所属分期, A.分期ID, A.PLAN_ID, A.NODE_ID, A.节点名称, CASE WHEN A.计划类别 = B.PLAN_TYPE THEN	'是' ELSE	'否' END AS 计划类别是否相等, A.计划类别 AS 计划类别_EXCEL, B.PLAN_TYPE AS 计划类别_SYS, CASE WHEN CASE	WHEN A.是否禁用 = '是' THEN	 1	ELSE 0	END = NVL(B.IS_DISABLE, 0) THEN	'是' ELSE	'否' END AS 禁用属性是否正确, A.是否禁用 AS 是否禁用_EXCEL, CASE	 WHEN B.IS_DISABLE = 1 THEN	'是' ELSE	'否' END AS 是否禁用_SYS, CASE WHEN NVL(A.计划开始日期, TO_DATE('1900-01-01', 'YYYY-MM-DD')) = NVL(B.PLAN_START_DATE, TO_DATE('1900-01-01', 'YYYY-MM-DD')) THEN	'是' ELSE	'否' END 计划开始日期是否相等, A.计划开始日期 AS 计划开始日期_EXCEL, B.PLAN_START_DATE AS 计划开始日期_SYS, CASE WHEN NVL(A.计划完成日期, TO_DATE('1900-01-01', 'YYYY-MM-DD')) = NVL(B.PLAN_END_DATE, TO_DATE('1900-01-01', 'YYYY-MM-DD')) THEN	'是' ELSE '否' END AS 计划完成日期是否相等, A.计划完成日期 AS 计划完成日期_EXCEL, B.PLAN_END_DATE AS 计划完成日期_SYS, CASE WHEN NVL(A.实际开始日期, TO_DATE('1900-01-01', 'YYYY-MM-DD')) = NVL(B.ACTUAL_START_DATE, TO_DATE('1900-01-01', 'YYYY-MM-DD')) THEN		'是'	 ELSE	'否' END AS 实际开始日期是否相等, A.实际开始日期 实际开始日期_EXCEL, B.ACTUAL_START_DATE AS 实际开始日期_SYS, CASE WHEN NVL(A.实际完成日期, TO_DATE('1900-1-01', 'YYYY-MM-DD')) = NVL(B.ACTUAL_END_DATE, TO_DATE('1900-1-01', 'YYYY-MM-DD')) THEN '是' ELSE '否' END AS 实际完成日期是否相等, A.实际完成日期 AS 实际完成日期_EXCEL, B.ACTUAL_END_DATE AS 实际完成日期_SYS FROM   A1_PLAN_INFO_E A LEFT   JOIN (SELECT A1.ID AS PLAN_ID, A1.PLAN_NAME, A1.PLAN_TYPE, A1.PROJ_NAME, B1.* FROM POM_PROJ_PLAN A1 INNER JOIN POM_PROJ_PLAN_NODE B1 ON A1.ID = B1.PROJ_PLAN_ID) B ON     A.PLAN_ID = B.PLAN_ID AND A.NODE_ID = B.ID ORDER BY 1,2,3,12;

prompt
prompt Creating view EPC_BUILD_PHASE_INDEX
prompt ===================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.EPC_BUILD_PHASE_INDEX AS
SELECT D1.ID,E1.UNDERGROUND_CAPACITY_AREA, E1.GROUND_TOTAL_BUILD_AREA, E1.GROUND_UNCAPACITY_AREA, E1.GROUND_CAPACITY_AREA, E1.UNDERGROUND_TOTAL_RJ_CARPORT, E1.UNDERGROUND_RFJ_CARPORT,
                E1.UNDERGROUND_RJ_CARPORT, E1.UNDERGROUND_TOTAL_FRJ_CARPORT, E1.UNDERGROUND_FRFJ_CARPORT, E1.UNDERGROUND_FRJ_CARPORT, E1.UNDERGROUND_TOTAL_SALE_CARPORT, E1.UNDERGROUND_R_SALE_CARPORT,
                E1.UNDERGROUND_FRFJ_SALE_CARPORT, E1.UNDERGROUND_FRJ_SALE_CARPORT, E1.TOTAL_SALE_AREA, E1.GROUND_SALE_AREA, E1.UNDERGROUND_SALE_AREA, E1.TOTAL_GIVE_AREA, E1.GROUND_GIVE_AREA,
                E1. UNDERGROUND_GIVE_AREA,e1.TOTAL_RESIDENCE,e1.TOTAL_BUSINESS
         FROM   MDM_PROJECT A1
         INNER  JOIN MDM_BUILD B1
         ON     A1.ID = B1.PROJ_ID
         INNER  JOIN MDM_BUILD_PHASE C1
         ON     B1.ID = C1.BUILD_ID AND
                C1.PHASE_ID = '987b3331-8b68-3c60-e053-0100007fd322'
         INNER  JOIN MDM_OBJ_PHASE_INDEX D1
         ON     C1.ID = D1.OBJ_PHASE_ID
         INNER  JOIN (

                     SELECT B.ID, D.ID AS OBJ_PHASE_ID, SUM(E.UNDERGROUND_CAPACITY_AREA) UNDERGROUND_CAPACITY_AREA, SUM(E.GROUND_TOTAL_BUILD_AREA) GROUND_TOTAL_BUILD_AREA,
                             SUM(E.GROUND_UNCAPACITY_AREA) GROUND_UNCAPACITY_AREA, SUM(E.GROUND_CAPACITY_AREA) GROUND_CAPACITY_AREA, SUM(E.UNDERGROUND_TOTAL_RJ_CARPORT) UNDERGROUND_TOTAL_RJ_CARPORT,
                             SUM(E.UNDERGROUND_RFJ_CARPORT) UNDERGROUND_RFJ_CARPORT, SUM(E.UNDERGROUND_RJ_CARPORT) UNDERGROUND_RJ_CARPORT,
                             SUM(E.UNDERGROUND_TOTAL_FRJ_CARPORT) UNDERGROUND_TOTAL_FRJ_CARPORT, SUM(E.UNDERGROUND_FRFJ_CARPORT) UNDERGROUND_FRFJ_CARPORT,
                             SUM(E.UNDERGROUND_FRJ_CARPORT) UNDERGROUND_FRJ_CARPORT, SUM(E.UNDERGROUND_TOTAL_SALE_CARPORT) UNDERGROUND_TOTAL_SALE_CARPORT,
                             SUM(E.UNDERGROUND_R_SALE_CARPORT) UNDERGROUND_R_SALE_CARPORT, SUM(E.UNDERGROUND_FRFJ_SALE_CARPORT) UNDERGROUND_FRFJ_SALE_CARPORT,
                             SUM(E.UNDERGROUND_FRJ_SALE_CARPORT) UNDERGROUND_FRJ_SALE_CARPORT, SUM(E.TOTAL_SALE_AREA) TOTAL_SALE_AREA, SUM(E.GROUND_SALE_AREA) GROUND_SALE_AREA,
                             SUM(E.UNDERGROUND_SALE_AREA) UNDERGROUND_SALE_AREA, SUM(E.TOTAL_GIVE_AREA) TOTAL_GIVE_AREA, SUM(E.GROUND_GIVE_AREA) GROUND_GIVE_AREA,
                             SUM(E.UNDERGROUND_GIVE_AREA) UNDERGROUND_GIVE_AREA,SUM(e.TOTAL_RESIDENCE) TOTAL_RESIDENCE,SUM(e.TOTAL_BUSINESS)  TOTAL_BUSINESS
                     FROM   MDM_PROJECT A
                     INNER  JOIN MDM_BUILD B
                     ON     A.ID = B.PROJ_ID
                     INNER  JOIN SYS_BUSINESS_UNIT C
                     ON     A.COMPANY_ID = C.ID AND
                            C.ID IN (SELECT ID FROM SYS_BUSINESS_UNIT P1 WHERE P1.IS_COMPANY = 1 START WITH P1.ORG_NAME IN ('西南公司', '华中公司', '华东公司') CONNECT BY PRIOR P1.ID = P1.PARENT_ID)
                     INNER  JOIN MDM_BUILD_PHASE D
                     ON     B.ID = D.BUILD_ID AND
                            D.PHASE_ID = '987b3331-8b68-3c60-e053-0100007fd322'
                     LEFT   JOIN MDM_OBJ_PHASE_PT_INDEX E
                     ON     D.ID = E.OBJ_PHASE_ID
                     /*        WHERE  E.ID IS NULL*/
                     GROUP  BY B.ID, A.PROJECT_NAME, B.BUILD_NAME, D.ID

                     ) E1
         ON     E1.ID = B1.ID;

prompt
prompt Creating view V_AREA_COMPANY_PROJ_TREE
prompt ======================================
prompt
create or replace force view pom0813.v_area_company_proj_tree as
select orgId,orgName,orgType,parentId,isCompany,orderCode from
(
select ID as orgId,STAGE_NAME as orgName,'11' as orgType,PROJECT_ID as parentId,'0' as isCompany,'' as orderCode
from SYS_PROJECT_STAGE
UNION
select ID as orgId,PROJECT_NAME as orgName,'10' as orgType,UNIT_ID as parentId,'0' as isCompany,PROJECT_CODE as orderCode
from SYS_PROJECT
UNION
select ID as orgId,ORG_NAME as orgName,'0' as orgType,PARENT_ID as parentId,'1' as isCompany,ORG_CODE as orderCode
from SYS_BUSINESS_UNIT where ORG_TYPE = 0
) t;

prompt
prompt Creating view V_DWM_TARGET_WORTH_NOW
prompt ====================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_DWM_TARGET_WORTH_NOW AS
SELECT a.order_hierarchy_code,a.project_code,b."ID",b."PROJ_ID",b."PROJ_NAME",b."TARGET_WORTH_PHASE"
,b."TARGET_WORTH",b."REMARK",b."APPROVAL_STATUS",b."APPROVER_ID",b."APPROVAL_TIME"
,b."CREATOR_ID",b."CREATOR",b."CREATED",b."MODIFIED",b."MODIFIER_ID",b."MODIFIER"
,b."WORTH_V",b."PREVIOUS_V_WORTH",b."PREVIOUS_V_INCREMENT",b."FULL_V_WORTH",b."FULL_V_INCREMENT"
,b."FEASIBILITY_STUDY_V_WORTH",b."FEASIBILITY_STUDY_V_INCREMENT",b."IS_DELETE",b."APPROVER"
FROM sys_project A
LEFT JOIN DWM_TARGET_WORTH B ON A.id = B.PROJ_ID AND b.is_delete=0 AND b.approval_status='已审核'
LEFT JOIN (SELECT
        proj_id,MAX(target_worth_phase) AS target_worth_phase,MAX(worth_v) AS worth_v
        FROM DWM_TARGET_WORTH
        WHERE is_delete=0 AND  APPROVAL_STATUS = '已审核'
        GROUP BY  proj_id) c ON B.Proj_Id=C.proj_id AND B.Target_Worth_Phase=C.Target_Worth_Phase AND B.Worth_v=C.Worth_v
WHERE c.proj_id IS NOT NULL
ORDER BY a.order_hierarchy_code;

prompt
prompt Creating view V_DWM_TARGET_WORTH_IDLIST
prompt =======================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_DWM_TARGET_WORTH_IDLIST AS
SELECT a.id AS proj_id,a.order_hierarchy_code,a.project_name
,(CASE WHEN b2.id IS NOT NULL THEN 20  ELSE (CASE WHEN b1.id IS NOT NULL THEN 10 ELSE (CASE WHEN b0.id IS NOT NULL THEN 0  ELSE NULL END ) END ) END) AS A_当前最新版
,(CASE WHEN b2.id IS NOT NULL THEN b2.id  ELSE (CASE WHEN b1.id IS NOT NULL THEN b1.id  ELSE (CASE WHEN b0.id IS NOT NULL THEN b0.id  ELSE '' END ) END ) END) AS A_当前最新版ID
,(CASE WHEN b2.id IS NOT NULL THEN b2.approval_Time  ELSE (CASE WHEN b1.id IS NOT NULL THEN b1.approval_Time  ELSE (CASE WHEN b0.id IS NOT NULL THEN b0.approval_Time  ELSE  NULL END ) END ) END) AS A_最新版审核日期

,b0.id AS A1_可研版目标货值ID
,b1.id AS A2_全盘版目标货值ID
,b2.id AS A3_动态版目标货值ID
FROM mdm_project a
LEFT JOIN DWM_TARGET_WORTH b0 ON a.id=b0.proj_id AND b0.approval_status='已审核' AND b0.target_worth_phase=0 AND b0.is_delete=0
LEFT JOIN DWM_TARGET_WORTH b1 ON a.id=b1.proj_id AND b1.approval_status='已审核' AND b1.target_worth_phase=10 AND b1.is_delete=0
LEFT JOIN ( SELECT t1.*   FROM DWM_TARGET_WORTH t1
          WHERE approval_status='已审核' AND target_worth_phase=20 AND is_delete=0
              AND t1.ID IN (SELECT ID FROM V_DWM_TARGET_WORTH_NOW)
          ) b2 ON a.id=b2.proj_id AND b2.approval_status='已审核' AND b2.target_worth_phase=20 AND b2.is_delete=0

WHERE a.is_delete=0 AND a.approval_status='已审核'
ORDER BY a.order_hierarchy_code;

prompt
prompt Creating view V_DWM_DT_VALUE
prompt ============================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_DWM_DT_VALUE AS
SELECT
          d1.worth AS Target_1
          ,d2.worth AS Target_2
          ,d3.worth AS Target_3
          ,d.worth AS Target_Now
          ,ROUND(a.value_dt_all-d.worth*10000,2) AS Target_Now_Diff
         ,a."ID",a."OBJ_ID",a."OBJ_NAME",a."OBJ_TYPE",a."OBJ_IS_PARKING",a."OBJ_IS_SALE",a."OBJ_IS_HOLD",a."PARENT_ID",a."OBJ_LEVEL",a."ORDER_CODE",a."ORDER_HIERARCHY_CODE",a."VALUE_DT_ALL",a."VALUE_REMAIN",a."VALUE_HAVED_SALE",a."VALUE_RESERVE",a."VALUE_IN_PROCESS",a."VALUE_ALLOW_SALE",a."VALUE_STOCK",a."VALUE_NOT_PLANNING_PERMIT",a."VALUE_NOT_CONSTRUCTION_PERMIT",a."VALUE_NOT_SALE_PERMIT",a."VALUE_NOT_COMPLETION",a."VALUE_YES_COMPLETION",a."VALUE_YES_SETTLEMENT",a."AREA_DT_ALL",a."AREA_REMAIN",a."AREA_HAVED_SALE",a."AREA_RESERVE",a."AREA_IN_PROCESS",a."AREA_ALLOW_SALE",a."AREA_STOCK",a."AREA_NOT_PLANNING_PERMIT",a."AREA_NOT_CONSTRUCTION_PERMIT",a."AREA_NOT_SALE_PERMIT",a."AREA_NOT_COMPLETION",a."AREA_YES_COMPLETION",a."AREA_YES_SETTLEMENT",a."TMP_1KY_VALUE",a."TMP_1KY_AREA",a."TMP_1KY_PRICE",a."TMP_2QP_VALUE",a."TMP_2QP_AREA",a."TMP_2QP_PRICE",a."TMP_3DT_TARGETVALUE",a."TMP_3DT_TARGETAREA",a."TMP_3DT_TARGETPRICE",a."CW_VALUE_DT_ALL",a."CW_VALUE_REMAIN",a."CW_VALUE_HAVED_SALE",a."CW_VALUE_RESERVE",a."CW_VALUE_IN_PROCESS",a."CW_VALUE_ALLOW_SALE",a."CW_VALUE_STOCK",a."CW_VALUE_NOT_PLANNING_PERMIT",a."CW_VALUE_NOT_CONSTRUCTION_PER",a."CW_VALUE_NOT_SALE_PERMIT",a."CW_VALUE_NOT_COMPLETION",a."CW_VALUE_YES_COMPLETION",a."CW_VALUE_YES_SETTLEMENT",a."CW_AREA_DT_ALL",a."CW_AREA_REMAIN",a."CW_AREA_HAVED_SALE",a."CW_AREA_RESERVE",a."CW_AREA_IN_PROCESS",a."CW_AREA_ALLOW_SALE",a."CW_AREA_STOCK",a."CW_AREA_NOT_PLANNING_PERMIT",a."CW_AREA_NOT_CONSTRUCTION_PER",a."CW_AREA_NOT_SALE_PERMIT",a."CW_AREA_NOT_COMPLETION",a."CW_AREA_YES_COMPLETION",a."CW_AREA_YES_SETTLEMENT",a."ZZ_VALUE_DT_ALL",a."ZZ_VALUE_REMAIN",a."ZZ_VALUE_HAVED_SALE",a."ZZ_VALUE_RESERVE",a."ZZ_VALUE_IN_PROCESS",a."ZZ_VALUE_ALLOW_SALE",a."ZZ_VALUE_STOCK",a."ZZ_VALUE_NOT_PLANNING_PERMIT",a."ZZ_VALUE_NOT_CONSTRUCTION_PER",a."ZZ_VALUE_NOT_SALE_PERMIT",a."ZZ_VALUE_NOT_COMPLETION",a."ZZ_VALUE_YES_COMPLETION",a."ZZ_VALUE_YES_SETTLEMENT",a."ZZ_AREA_DT_ALL",a."ZZ_AREA_REMAIN",a."ZZ_AREA_HAVED_SALE",a."ZZ_AREA_RESERVE",a."ZZ_AREA_IN_PROCESS",a."ZZ_AREA_ALLOW_SALE",a."ZZ_AREA_STOCK",a."ZZ_AREA_NOT_PLANNING_PERMIT",a."ZZ_AREA_NOT_CONSTRUCTION_PER",a."ZZ_AREA_NOT_SALE_PERMIT",a."ZZ_AREA_NOT_COMPLETION",a."ZZ_AREA_YES_COMPLETION",a."ZZ_AREA_YES_SETTLEMENT",a."SY_VALUE_DT_ALL",a."SY_VALUE_REMAIN",a."SY_VALUE_HAVED_SALE",a."SY_VALUE_RESERVE",a."SY_VALUE_IN_PROCESS",a."SY_VALUE_ALLOW_SALE",a."SY_VALUE_STOCK",a."SY_VALUE_NOT_PLANNING_PERMIT",a."SY_VALUE_NOT_CONSTRUCTION_PER",a."SY_VALUE_NOT_SALE_PERMIT",a."SY_VALUE_NOT_COMPLETION",a."SY_VALUE_YES_COMPLETION",a."SY_VALUE_YES_SETTLEMENT",a."SY_AREA_DT_ALL",a."SY_AREA_REMAIN",a."SY_AREA_HAVED_SALE",a."SY_AREA_RESERVE",a."SY_AREA_IN_PROCESS",a."SY_AREA_ALLOW_SALE",a."SY_AREA_STOCK",a."SY_AREA_NOT_PLANNING_PERMIT",a."SY_AREA_NOT_CONSTRUCTION_PER",a."SY_AREA_NOT_SALE_PERMIT",a."SY_AREA_NOT_COMPLETION",a."SY_AREA_YES_COMPLETION",a."SY_AREA_YES_SETTLEMENT",a."PROJ_ID"

      FROM dwm_dt_value a
      LEFT JOIN v_dwm_target_worth_idlist b ON a.proj_id=b.proj_id
      LEFT JOIN dwm_target_worth_dtl d1 ON d1.target_worth_id=b.A1_可研版目标货值ID AND d1.obj_id=a.obj_id AND d1.obj_Type<>40 AND a.OBJ_TYPE = '项目'
      LEFT JOIN dwm_target_worth_dtl d2 ON d2.target_worth_id=b.A2_全盘版目标货值ID AND d2.obj_id=a.obj_id AND d2.obj_Type<>40 AND a.OBJ_TYPE = '项目'
      LEFT JOIN dwm_target_worth_dtl d3 ON d3.target_worth_id=b.A3_动态版目标货值ID AND d3.obj_id=a.obj_id AND d3.obj_Type<>40 AND a.OBJ_TYPE = '项目'
      LEFT JOIN dwm_target_worth_dtl d ON d.target_worth_id=b.A_当前最新版ID AND d.obj_id=a.obj_id AND d.obj_Type<>40
       --WHERE a.proj_id='23730850-ea5d-44de-b980-a3bb65ab0098'
     -- ORDER BY a.order_hierarchy_code
;

prompt
prompt Creating view V_DWM_ROOM_BY_BLD
prompt ===============================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_DWM_ROOM_BY_BLD AS
SELECT b.building_id
       ,a.order_hierarchy_code
      ,b.project_name
      ,b.project_id AS Proj_id
      ,SUM(NVL((CASE WHEN b.sale_state<>'签约' THEN ROUND(b.bz_price*NVL(b.new_bld_area,0),2) ELSE 0 END),0)) AS ALL库存货值_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state='签约' THEN NVL(b.trade_total,0) ELSE 0 END),0)) AS ALL已售货值_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state<>'签约' THEN ROUND(b.bz_price*NVL(b.new_bld_area,0),2) ELSE 0 END),0))
      +SUM(NVL((CASE WHEN b.sale_state='签约' THEN NVL(b.trade_total,0) ELSE 0 END),0)) AS ALL库存及已售总货值

      ,SUM(NVL((CASE WHEN b.sale_state<>'签约'THEN NVL(b.new_bld_area,0) ELSE 0 END),0)) AS ALL库存面积_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state='签约' THEN NVL(b.new_bld_area,0) ELSE 0 END),0)) AS ALL已售面积_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state<>'签约'THEN 1 ELSE 0 END),0)) AS ALL库存套数_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state='签约' THEN 1 ELSE 0 END),0)) AS ALL已售套数_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state<>'签约'AND b.product_name IN ('住宅','商办') THEN NVL(b.new_bld_area,0) ELSE 0 END),0)) AS ALL库存货量_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state='签约' AND b.product_name IN ('住宅','商办') THEN NVL(b.new_bld_area,0) ELSE 0 END),0)) AS ALL已售货量_房间合计

      ,SUM(NVL((CASE WHEN b.sale_state<>'签约'AND b.product_name='住宅' THEN ROUND(b.bz_price*NVL(b.new_bld_area,0),2) ELSE 0 END),0)) AS ZZ库存货值_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state='签约' AND b.product_name='住宅' THEN NVL(b.trade_total,0) ELSE 0 END),0)) AS ZZ已售货值_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state<>'签约'AND b.product_name='住宅' THEN NVL(b.new_bld_area,0) ELSE 0 END),0)) AS ZZ库存面积_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state='签约' AND b.product_name='住宅' THEN NVL(b.new_bld_area,0) ELSE 0 END),0)) AS ZZ已售面积_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state<>'签约'AND b.product_name='住宅' THEN 1 ELSE 0 END),0)) AS ZZ库存套数_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state='签约' AND b.product_name='住宅' THEN 1 ELSE 0 END),0)) AS ZZ已售套数_房间合计

      ,SUM(NVL((CASE WHEN b.sale_state<>'签约'AND b.product_name='商办' THEN ROUND(b.bz_price*NVL(b.new_bld_area,0),2) ELSE 0 END),0)) AS SY库存货值_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state='签约' AND b.product_name='商办' THEN NVL(b.trade_total,0) ELSE 0 END),0)) AS SY已售货值_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state<>'签约'AND b.product_name='商办' THEN NVL(b.new_bld_area,0) ELSE 0 END),0)) AS SY库存面积_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state='签约' AND b.product_name='商办' THEN NVL(b.new_bld_area,0) ELSE 0 END),0)) AS SY已售面积_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state<>'签约'AND b.product_name='商办' THEN 1 ELSE 0 END),0)) AS SY库存套数_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state='签约' AND b.product_name='商办' THEN 1 ELSE 0 END),0)) AS SY已售套数_房间合计

      ,SUM(NVL((CASE WHEN b.sale_state<>'签约'AND b.product_name IN ('住宅','商办') THEN ROUND(b.bz_price*NVL(b.new_bld_area,0),2) ELSE 0 END),0)) AS ZS库存货值_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state='签约' AND b.product_name IN ('住宅','商办') THEN NVL(b.trade_total,0) ELSE 0 END),0)) AS ZS已售货值_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state<>'签约'AND b.product_name IN ('住宅','商办') THEN NVL(b.new_bld_area,0) ELSE 0 END),0)) AS ZS库存面积_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state='签约' AND b.product_name IN ('住宅','商办') THEN NVL(b.new_bld_area,0) ELSE 0 END),0)) AS ZS已售面积_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state<>'签约'AND b.product_name IN ('住宅','商办') THEN 1 ELSE 0 END),0)) AS ZS库存套数_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state='签约' AND b.product_name IN ('住宅','商办') THEN 1 ELSE 0 END),0)) AS ZS已售套数_房间合计

      ,SUM(NVL((CASE WHEN b.sale_state<>'签约'AND b.product_name='车位' THEN ROUND(b.bz_price*NVL(b.new_bld_area,0),2) ELSE 0 END),0)) AS CW库存货值_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state='签约' AND b.product_name='车位' THEN NVL(b.trade_total,0) ELSE 0 END),0)) AS CW已售货值_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state<>'签约'AND b.product_name='车位' THEN NVL(b.new_bld_area,0) ELSE 0 END),0)) AS CW库存面积_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state='签约' AND b.product_name='车位' THEN NVL(b.new_bld_area,0) ELSE 0 END),0)) AS CW已售面积_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state<>'签约'AND b.product_name='车位' THEN 1 ELSE 0 END),0)) AS CW库存套数_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state='签约' AND b.product_name='车位' THEN 1 ELSE 0 END),0)) AS CW已售套数_房间合计

FROM Mdm_Room b LEFT JOIN mdm_build a ON a.id=b.building_id
-- WHERE b.project_name='佛山领秀公馆（北区）'
GROUP BY b.project_name,b.project_id,b.building_id ,a.order_hierarchy_code
ORDER BY a.order_hierarchy_code
;

prompt
prompt Creating view V_MDM_BLD_INDEX_SUM
prompt =================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_MDM_BLD_INDEX_SUM AS
SELECT a.id AS Proj_id
,a.project_name
,b.id AS bld_id
,b.build_name
,b.order_hierarchy_code
,C.PHASE_ID AS NOW_Phase_ID
,G.phase_name AS Now_phase_Name
,c.phase_order AS Now_Phase_Order

,SUM(CASE WHEN C1.Id IS NOT NULL THEN 1 ELSE 0 END ) AS B1_是否有
,SUM(CASE WHEN E1.OPERATE_ATTRIBUTE_NAME='可售' THEN 1 ELSE 0 END ) AS B1_经营类别
,SUM(CASE WHEN C2.Id IS NOT NULL THEN 1 ELSE 0 END ) AS B2_是否有
,SUM(CASE WHEN C3.Id IS NOT NULL THEN 1 ELSE 0 END ) AS B3_是否有
,SUM(CASE WHEN C4.Id IS NOT NULL THEN 1 ELSE 0 END ) AS B4_是否有

,SUM(CASE WHEN SUBSTR(F1.Product_Type_Code,1,1)='A' THEN NVL(E1.GROUND_TOTAL_BUILD_AREA,0)+NVL(E1.UNDERGROUND_TOTAL_BUILD_AREA,0) ELSE 0 END ) AS B1ZZ_建筑面积
,SUM(CASE WHEN SUBSTR(F1.Product_Type_Code,1,1)='A' THEN NVL(E1.GROUND_CAPACITY_AREA,0)+NVL(E1.UNDERGROUND_CAPACITY_AREA,0) ELSE 0 END ) AS B1ZZ_计容面积
,SUM(CASE WHEN SUBSTR(F1.Product_Type_Code,1,1)='A' THEN NVL(E1.GROUND_SALE_AREA,0)+NVL(E1.UNDERGROUND_SALE_AREA,0) ELSE 0 END ) AS B1ZZ_可售面积

,SUM(CASE WHEN SUBSTR(F1.Product_Type_Code,1,1)='B' THEN NVL(E1.GROUND_TOTAL_BUILD_AREA,0)+NVL(E1.UNDERGROUND_TOTAL_BUILD_AREA,0) ELSE 0 END ) AS B1SY_建筑面积
,SUM(CASE WHEN SUBSTR(F1.Product_Type_Code,1,1)='B' THEN NVL(E1.GROUND_CAPACITY_AREA,0)+NVL(E1.UNDERGROUND_CAPACITY_AREA,0) ELSE 0 END ) AS B1SY_计容面积
,SUM(CASE WHEN SUBSTR(F1.Product_Type_Code,1,1)='B' THEN NVL(E1.GROUND_SALE_AREA,0)+NVL(E1.UNDERGROUND_SALE_AREA,0) ELSE 0 END ) AS B1SY_可售面积

,SUM(CASE WHEN SUBSTR(F1.Product_Type_Code,1,1)='C' THEN NVL(E1.GROUND_TOTAL_BUILD_AREA,0)+NVL(E1.UNDERGROUND_TOTAL_BUILD_AREA,0) ELSE 0 END ) AS B1CW_建筑面积
,SUM(CASE WHEN SUBSTR(F1.Product_Type_Code,1,1)='C' THEN NVL(E1.GROUND_CAPACITY_AREA,0)+NVL(E1.UNDERGROUND_CAPACITY_AREA,0) ELSE 0 END ) AS B1CW_计容面积
,SUM(CASE WHEN SUBSTR(F1.Product_Type_Code,1,1)='C' THEN NVL(E1.GROUND_SALE_AREA,0)+NVL(E1.UNDERGROUND_SALE_AREA,0) ELSE 0 END ) AS B1CW_可售面积
,SUM(CASE WHEN SUBSTR(F1.Product_Type_Code,1,1)='C' THEN NVL(E1.UNDERGROUND_R_SALE_CARPORT,0)+NVL(E1.UNDERGROUND_FRFJ_SALE_CARPORT,0)+NVL(E1.UNDERGROUND_FRJ_SALE_CARPORT,0) ELSE 0 END ) AS B1CW_可售车位数

,SUM(CASE WHEN SUBSTR(F1.Product_Type_Code,1,1)='D' THEN NVL(E1.GROUND_TOTAL_BUILD_AREA,0)+NVL(E1.UNDERGROUND_TOTAL_BUILD_AREA,0) ELSE 0 END ) AS B1PT_建筑面积
,SUM(CASE WHEN SUBSTR(F1.Product_Type_Code,1,1)='D' THEN NVL(E1.GROUND_CAPACITY_AREA,0)+NVL(E1.UNDERGROUND_CAPACITY_AREA,0) ELSE 0 END ) AS B1PT_计容面积
,SUM(CASE WHEN SUBSTR(F1.Product_Type_Code,1,1)='D' THEN NVL(E1.GROUND_SALE_AREA,0)+NVL(E1.UNDERGROUND_SALE_AREA,0) ELSE 0 END ) AS B1PT_可售面积


,SUM(CASE WHEN SUBSTR(F2.Product_Type_Code,1,1)='A' THEN NVL(E2.GROUND_TOTAL_BUILD_AREA,0)+NVL(E2.UNDERGROUND_TOTAL_BUILD_AREA,0) ELSE 0 END ) AS B2ZZ_建筑面积
,SUM(CASE WHEN SUBSTR(F2.Product_Type_Code,1,1)='A' THEN NVL(E2.GROUND_CAPACITY_AREA,0)+NVL(E2.UNDERGROUND_CAPACITY_AREA,0) ELSE 0 END ) AS B2ZZ_计容面积
,SUM(CASE WHEN SUBSTR(F2.Product_Type_Code,1,1)='A' THEN NVL(E2.GROUND_SALE_AREA,0)+NVL(E2.UNDERGROUND_SALE_AREA,0) ELSE 0 END ) AS B2ZZ_可售面积

,SUM(CASE WHEN SUBSTR(F2.Product_Type_Code,1,1)='B' THEN NVL(E2.GROUND_TOTAL_BUILD_AREA,0)+NVL(E2.UNDERGROUND_TOTAL_BUILD_AREA,0) ELSE 0 END ) AS B2SY_建筑面积
,SUM(CASE WHEN SUBSTR(F2.Product_Type_Code,1,1)='B' THEN NVL(E2.GROUND_CAPACITY_AREA,0)+NVL(E2.UNDERGROUND_CAPACITY_AREA,0) ELSE 0 END ) AS B2SY_计容面积
,SUM(CASE WHEN SUBSTR(F2.Product_Type_Code,1,1)='B' THEN NVL(E2.GROUND_SALE_AREA,0)+NVL(E2.UNDERGROUND_SALE_AREA,0) ELSE 0 END ) AS B2SY_可售面积

,SUM(CASE WHEN SUBSTR(F2.Product_Type_Code,1,1)='C' THEN NVL(E2.GROUND_TOTAL_BUILD_AREA,0)+NVL(E2.UNDERGROUND_TOTAL_BUILD_AREA,0) ELSE 0 END ) AS B2CW_建筑面积
,SUM(CASE WHEN SUBSTR(F2.Product_Type_Code,1,1)='C' THEN NVL(E2.GROUND_CAPACITY_AREA,0)+NVL(E2.UNDERGROUND_CAPACITY_AREA,0) ELSE 0 END ) AS B2CW_计容面积
,SUM(CASE WHEN SUBSTR(F2.Product_Type_Code,1,1)='C' THEN NVL(E2.GROUND_SALE_AREA,0)+NVL(E2.UNDERGROUND_SALE_AREA,0) ELSE 0 END ) AS B2CW_可售面积
,SUM(CASE WHEN SUBSTR(F2.Product_Type_Code,1,1)='C' THEN NVL(E2.UNDERGROUND_R_SALE_CARPORT,0)+NVL(E2.UNDERGROUND_FRFJ_SALE_CARPORT,0)+NVL(E2.UNDERGROUND_FRJ_SALE_CARPORT,0) ELSE 0 END ) AS B2CW_可售车位数

,SUM(CASE WHEN SUBSTR(F2.Product_Type_Code,1,1)='D' THEN NVL(E2.GROUND_TOTAL_BUILD_AREA,0)+NVL(E2.UNDERGROUND_TOTAL_BUILD_AREA,0) ELSE 0 END ) AS B2PT_建筑面积
,SUM(CASE WHEN SUBSTR(F2.Product_Type_Code,1,1)='D' THEN NVL(E2.GROUND_CAPACITY_AREA,0)+NVL(E2.UNDERGROUND_CAPACITY_AREA,0) ELSE 0 END ) AS B2PT_计容面积
,SUM(CASE WHEN SUBSTR(F2.Product_Type_Code,1,1)='D' THEN NVL(E2.GROUND_SALE_AREA,0)+NVL(E2.UNDERGROUND_SALE_AREA,0) ELSE 0 END ) AS B2PT_可售面积


,SUM(CASE WHEN SUBSTR(F3.Product_Type_Code,1,1)='A' THEN NVL(E3.GROUND_TOTAL_BUILD_AREA,0)+NVL(E3.UNDERGROUND_TOTAL_BUILD_AREA,0) ELSE 0 END ) AS B3ZZ_建筑面积
,SUM(CASE WHEN SUBSTR(F3.Product_Type_Code,1,1)='A' THEN NVL(E3.GROUND_CAPACITY_AREA,0)+NVL(E3.UNDERGROUND_CAPACITY_AREA,0) ELSE 0 END ) AS B3ZZ_计容面积
,SUM(CASE WHEN SUBSTR(F3.Product_Type_Code,1,1)='A' THEN NVL(E3.GROUND_SALE_AREA,0)+NVL(E3.UNDERGROUND_SALE_AREA,0) ELSE 0 END ) AS B3ZZ_可售面积

,SUM(CASE WHEN SUBSTR(F3.Product_Type_Code,1,1)='B' THEN NVL(E3.GROUND_TOTAL_BUILD_AREA,0)+NVL(E3.UNDERGROUND_TOTAL_BUILD_AREA,0) ELSE 0 END ) AS B3SY_建筑面积
,SUM(CASE WHEN SUBSTR(F3.Product_Type_Code,1,1)='B' THEN NVL(E3.GROUND_CAPACITY_AREA,0)+NVL(E3.UNDERGROUND_CAPACITY_AREA,0) ELSE 0 END ) AS B3SY_计容面积
,SUM(CASE WHEN SUBSTR(F3.Product_Type_Code,1,1)='B' THEN NVL(E3.GROUND_SALE_AREA,0)+NVL(E3.UNDERGROUND_SALE_AREA,0) ELSE 0 END ) AS B3SY_可售面积

,SUM(CASE WHEN SUBSTR(F3.Product_Type_Code,1,1)='C' THEN NVL(E3.GROUND_TOTAL_BUILD_AREA,0)+NVL(E3.UNDERGROUND_TOTAL_BUILD_AREA,0) ELSE 0 END ) AS B3CW_建筑面积
,SUM(CASE WHEN SUBSTR(F3.Product_Type_Code,1,1)='C' THEN NVL(E3.GROUND_CAPACITY_AREA,0)+NVL(E3.UNDERGROUND_CAPACITY_AREA,0) ELSE 0 END ) AS B3CW_计容面积
,SUM(CASE WHEN SUBSTR(F3.Product_Type_Code,1,1)='C' THEN NVL(E3.GROUND_SALE_AREA,0)+NVL(E3.UNDERGROUND_SALE_AREA,0) ELSE 0 END ) AS B3CW_可售面积
,SUM(CASE WHEN SUBSTR(F3.Product_Type_Code,1,1)='C' THEN NVL(E3.UNDERGROUND_R_SALE_CARPORT,0)+NVL(E3.UNDERGROUND_FRFJ_SALE_CARPORT,0)+NVL(E3.UNDERGROUND_FRJ_SALE_CARPORT,0) ELSE 0 END ) AS B3CW_可售车位数

,SUM(CASE WHEN SUBSTR(F3.Product_Type_Code,1,1)='D' THEN NVL(E3.GROUND_TOTAL_BUILD_AREA,0)+NVL(E3.UNDERGROUND_TOTAL_BUILD_AREA,0) ELSE 0 END ) AS B3PT_建筑面积
,SUM(CASE WHEN SUBSTR(F3.Product_Type_Code,1,1)='D' THEN NVL(E3.GROUND_CAPACITY_AREA,0)+NVL(E3.UNDERGROUND_CAPACITY_AREA,0) ELSE 0 END ) AS B3PT_计容面积
,SUM(CASE WHEN SUBSTR(F3.Product_Type_Code,1,1)='D' THEN NVL(E3.GROUND_SALE_AREA,0)+NVL(E3.UNDERGROUND_SALE_AREA,0) ELSE 0 END ) AS B3PT_可售面积


,SUM(CASE WHEN SUBSTR(F4.Product_Type_Code,1,1)='A' THEN NVL(E4.GROUND_TOTAL_BUILD_AREA,0)+NVL(E4.UNDERGROUND_TOTAL_BUILD_AREA,0) ELSE 0 END ) AS B4ZZ_建筑面积
,SUM(CASE WHEN SUBSTR(F4.Product_Type_Code,1,1)='A' THEN NVL(E4.GROUND_CAPACITY_AREA,0)+NVL(E4.UNDERGROUND_CAPACITY_AREA,0) ELSE 0 END ) AS B4ZZ_计容面积
,SUM(CASE WHEN SUBSTR(F4.Product_Type_Code,1,1)='A' THEN NVL(E4.GROUND_SALE_AREA,0)+NVL(E4.UNDERGROUND_SALE_AREA,0) ELSE 0 END ) AS B4ZZ_可售面积

,SUM(CASE WHEN SUBSTR(F4.Product_Type_Code,1,1)='B' THEN NVL(E4.GROUND_TOTAL_BUILD_AREA,0)+NVL(E4.UNDERGROUND_TOTAL_BUILD_AREA,0) ELSE 0 END ) AS B4SY_建筑面积
,SUM(CASE WHEN SUBSTR(F4.Product_Type_Code,1,1)='B' THEN NVL(E4.GROUND_CAPACITY_AREA,0)+NVL(E4.UNDERGROUND_CAPACITY_AREA,0) ELSE 0 END ) AS B4SY_计容面积
,SUM(CASE WHEN SUBSTR(F4.Product_Type_Code,1,1)='B' THEN NVL(E4.GROUND_SALE_AREA,0)+NVL(E4.UNDERGROUND_SALE_AREA,0) ELSE 0 END ) AS B4SY_可售面积

,SUM(CASE WHEN SUBSTR(F4.Product_Type_Code,1,1)='C' THEN NVL(E4.GROUND_TOTAL_BUILD_AREA,0)+NVL(E4.UNDERGROUND_TOTAL_BUILD_AREA,0) ELSE 0 END ) AS B4CW_建筑面积
,SUM(CASE WHEN SUBSTR(F4.Product_Type_Code,1,1)='C' THEN NVL(E4.GROUND_CAPACITY_AREA,0)+NVL(E4.UNDERGROUND_CAPACITY_AREA,0) ELSE 0 END ) AS B4CW_计容面积
,SUM(CASE WHEN SUBSTR(F4.Product_Type_Code,1,1)='C' THEN NVL(E4.GROUND_SALE_AREA,0)+NVL(E4.UNDERGROUND_SALE_AREA,0) ELSE 0 END ) AS B4CW_可售面积
,SUM(CASE WHEN SUBSTR(F4.Product_Type_Code,1,1)='C' THEN NVL(E4.UNDERGROUND_R_SALE_CARPORT,0)+NVL(E4.UNDERGROUND_FRFJ_SALE_CARPORT,0)+NVL(E4.UNDERGROUND_FRJ_SALE_CARPORT,0) ELSE 0 END ) AS B4CW_可售车位数

,SUM(CASE WHEN SUBSTR(F4.Product_Type_Code,1,1)='D' THEN NVL(E4.GROUND_TOTAL_BUILD_AREA,0)+NVL(E4.UNDERGROUND_TOTAL_BUILD_AREA,0) ELSE 0 END ) AS B4PT_建筑面积
,SUM(CASE WHEN SUBSTR(F4.Product_Type_Code,1,1)='D' THEN NVL(E4.GROUND_CAPACITY_AREA,0)+NVL(E4.UNDERGROUND_CAPACITY_AREA,0) ELSE 0 END ) AS B4PT_计容面积
,SUM(CASE WHEN SUBSTR(F4.Product_Type_Code,1,1)='D' THEN NVL(E4.GROUND_SALE_AREA,0)+NVL(E4.UNDERGROUND_SALE_AREA,0) ELSE 0 END ) AS B4PT_可售面积

FROM  mdm_project a
LEFT JOIN mdm_build b ON a.id=b.proj_id

LEFT JOIN mdm_build_phase C1 ON b.id=C1.BUILD_ID AND C1.PHASE_ORDER=3 -- B1规证阶段
LEFT JOIN mdm_obj_phase_index D1 ON D1.obj_phase_id=c1.id
LEFT JOIN mdm_obj_phase_pt_index E1 ON E1.OBJ_PHASE_ID=c1.id
LEFT JOIN MDM_BUILD_PRODUCT_TYPE F1 ON E1.PRODUCT_TYPE_ID=F1.ID

LEFT JOIN mdm_build_phase C2 ON b.id=C2.BUILD_ID AND C2.PHASE_ORDER=4 -- B2施工证阶段
LEFT JOIN mdm_obj_phase_index D2 ON D2.obj_phase_id=c2.id
LEFT JOIN mdm_obj_phase_pt_index E2 ON E2.OBJ_PHASE_ID=c2.id
LEFT JOIN MDM_BUILD_PRODUCT_TYPE F2 ON E2.PRODUCT_TYPE_ID=F2.ID

LEFT JOIN mdm_build_phase C3 ON b.id=C3.BUILD_ID AND C3.PHASE_ORDER=5 -- B3预售证阶段
LEFT JOIN mdm_obj_phase_index D3 ON D3.obj_phase_id=c3.id
LEFT JOIN mdm_obj_phase_pt_index E3 ON E3.OBJ_PHASE_ID=c3.id
LEFT JOIN MDM_BUILD_PRODUCT_TYPE F3 ON E3.PRODUCT_TYPE_ID=F3.ID


LEFT JOIN mdm_build_phase C4 ON b.id=C4.BUILD_ID AND C4.PHASE_ORDER=6 -- B4竣备阶段
LEFT JOIN mdm_obj_phase_index D4 ON D4.obj_phase_id=c4.id
LEFT JOIN mdm_obj_phase_pt_index E4 ON E4.OBJ_PHASE_ID=c4.id
LEFT JOIN MDM_BUILD_PRODUCT_TYPE F4 ON E4.PRODUCT_TYPE_ID=F4.ID

LEFT JOIN (SELECT BUILD_ID,MAX(PHASE_ORDER) AS NOW_PHASE_ORDER FROM MDM_BUILD_PHASE GROUP BY BUILD_ID)T ON T.BUILD_ID = B.ID -- 当前最新版
LEFT JOIN mdm_build_phase C ON T.BUILD_ID=C.BUILD_ID AND C.PHASE_ORDER=T.NOW_PHASE_ORDER
LEFT JOIN mdm_obj_phase_index D ON D.obj_phase_id=C.Id
LEFT JOIN mdm_obj_phase_pt_index E ON E.OBJ_PHASE_ID=c.id
LEFT JOIN MDM_BUILD_PRODUCT_TYPE F ON E.PRODUCT_TYPE_ID=F.ID
LEFT JOIN mdm_phase G ON C.PHASE_ID=G.id

WHERE a.is_delete=0 AND a.approval_status='已审核'
AND b.is_delete=0
--AND a.project_name='增城国际公馆'
GROUP BY a.id
,a.project_name
,b.id
,b.build_name
,b.order_hierarchy_code
,C.PHASE_ID
,G.phase_name
,c.phase_order

ORDER BY b.order_hierarchy_code
;

prompt
prompt Creating view V_DWM_TARGET_PRICE_BLD_NOW
prompt ========================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_DWM_TARGET_PRICE_BLD_NOW AS
SELECT
a.Project_name AS Proj_name,a.build_name AS Bld_name
,b.A_当前最新版 AS 货值A_最新动态版,b.A_当前最新版ID AS 货值A_最新动态版ID,b.A_最新版审核日期 AS 货值A_最新版审核日期
,(CASE WHEN c.id IS NOT NULL THEN '有' ELSE '无' END ) AS 是否有目标均价记录
,c.operate_attribute_name AS 经营类别
,a.NOW_Phase_ID AS 主数据PT阶段
,a.Now_Phase_Order AS 主数据PT阶段序号
,c.obj_phase_id AS 楼栋阶段
,b.A_当前最新版ID AS 目标货值阶段
,d.is_get_con_plan_permit AS 是否已取规证
,d.is_get_constrcution_permit AS 是否已取施证
,d.is_get_pre_sale_permit AS 是否已取预售证
,d.is_get_completed_permit AS 是否已竣备
,e.Permit_Now_Phase AS 四证当前阶段
,(CASE WHEN c.obj_name LIKE '住宅%' THEN NVL(c.average_price,0) ELSE 0 END) AS ZZ_目标均价
,(CASE WHEN c.obj_name LIKE '商办产业%' THEN NVL(c.average_price,0) ELSE 0 END) AS SY_目标均价
,(CASE WHEN c.obj_name LIKE '车位%' THEN NVL(c.average_price,0) ELSE 0 END) AS CW_目标均价

,a.B1ZZ_可售面积*(CASE WHEN c.obj_name LIKE '住宅%' THEN NVL(c.average_price,0) ELSE 0 END) AS JT_B1ZZ_目标货值 -- B1表示“规证阶段”，ZZ表示住宅，JT表示“静态”
,a.B1SY_可售面积*(CASE WHEN c.obj_name LIKE '商办产业%' THEN NVL(c.average_price,0) ELSE 0 END) AS JT_B1SY_目标货值
,a.B1CW_可售车位数*(CASE WHEN c.obj_name LIKE '车位%' THEN NVL(c.average_price,0) ELSE 0 END) AS JT_B1CW_目标货值

,a.B2ZZ_可售面积*(CASE WHEN c.obj_name LIKE '住宅%' THEN NVL(c.average_price,0) ELSE 0 END) AS JT_B2ZZ_目标货值 -- B2表示“施证阶段”，ZZ表示住宅，JT表示“静态”
,a.B2SY_可售面积*(CASE WHEN c.obj_name LIKE '商办产业%' THEN NVL(c.average_price,0) ELSE 0 END) AS JT_B2SY_目标货值
,a.B2CW_可售车位数*(CASE WHEN c.obj_name LIKE '车位%' THEN NVL(c.average_price,0) ELSE 0 END) AS JT_B2CW_目标货值

,a.B3ZZ_可售面积*(CASE WHEN c.obj_name LIKE '住宅%' THEN NVL(c.average_price,0) ELSE 0 END) AS JT_B3ZZ_目标货值 -- B3表示“预售证阶段”，ZZ表示住宅，JT表示“静态”
,a.B3SY_可售面积*(CASE WHEN c.obj_name LIKE '商办产业%' THEN NVL(c.average_price,0) ELSE 0 END) AS JT_B3SY_目标货值
,a.B3CW_可售车位数*(CASE WHEN c.obj_name LIKE '车位%' THEN NVL(c.average_price,0) ELSE 0 END) AS JT_B3CW_目标货值

--
,(CASE WHEN e.Permit_Now_Phase='B0' THEN a.B1ZZ_可售面积*(CASE WHEN c.obj_name LIKE '住宅%' THEN NVL(c.average_price,0) ELSE 0 END) ELSE 0 END) AS DT_B0ZZ_动态货值 -- B1表示“未取规证阶段”，ZZ表示住宅，DT表示“动态”
,(CASE WHEN e.Permit_Now_Phase='B0' THEN a.B1SY_可售面积*(CASE WHEN c.obj_name LIKE '商办产业%' THEN NVL(c.average_price,0) ELSE 0 END) ELSE 0 END)  AS DT_B0SY_动态货值
,(CASE WHEN e.Permit_Now_Phase='B0' THEN a.B1CW_可售车位数*(CASE WHEN c.obj_name LIKE '车位%' THEN NVL(c.average_price,0) ELSE 0 END) ELSE 0 END)  AS DT_B0CW_动态货值

,(CASE WHEN e.Permit_Now_Phase='B0' THEN a.B1ZZ_可售面积 ELSE 0 END) AS DT_B0ZZ_动态货量 -- B1表示“规证阶段”，ZZ表示住宅，DT表示“动态”
,(CASE WHEN e.Permit_Now_Phase='B0' THEN a.B1SY_可售面积  ELSE 0 END)  AS DT_B0SY_动态货量
,(CASE WHEN e.Permit_Now_Phase='B0' THEN a.B1CW_可售车位数 ELSE 0 END)  AS DT_B0CW_动态货量
--

,(CASE WHEN e.Permit_Now_Phase='B1' THEN a.B1ZZ_可售面积*(CASE WHEN c.obj_name LIKE '住宅%' THEN NVL(c.average_price,0) ELSE 0 END) ELSE 0 END) AS DT_B1ZZ_动态货值 -- B1表示“规证阶段”，ZZ表示住宅，DT表示“动态”
,(CASE WHEN e.Permit_Now_Phase='B1' THEN a.B1SY_可售面积*(CASE WHEN c.obj_name LIKE '商办产业%' THEN NVL(c.average_price,0) ELSE 0 END) ELSE 0 END)  AS DT_B1SY_动态货值
,(CASE WHEN e.Permit_Now_Phase='B1' THEN a.B1CW_可售车位数*(CASE WHEN c.obj_name LIKE '车位%' THEN NVL(c.average_price,0) ELSE 0 END) ELSE 0 END)  AS DT_B1CW_动态货值

,(CASE WHEN e.Permit_Now_Phase='B2' OR (e.Permit_Now_Phase='B3' AND NVL(f.RoomCount,0)=0) THEN a.B2ZZ_可售面积*(CASE WHEN c.obj_name LIKE '住宅%' THEN NVL(c.average_price,0) ELSE 0 END) ELSE 0 END) AS DT_B2ZZ_动态货值 -- B2表示“施证阶段”，ZZ表示住宅，DT表示“动态”
,(CASE WHEN e.Permit_Now_Phase='B2' OR (e.Permit_Now_Phase='B3' AND NVL(f.RoomCount,0)=0)  THEN a.B2SY_可售面积*(CASE WHEN c.obj_name LIKE '商办产业%' THEN NVL(c.average_price,0) ELSE 0 END) ELSE 0 END) AS DT_B2SY_动态货值
,(CASE WHEN e.Permit_Now_Phase='B2' OR (e.Permit_Now_Phase='B3' AND NVL(f.RoomCount,0)=0)  THEN a.B2CW_可售车位数*(CASE WHEN c.obj_name LIKE '车位%' THEN NVL(c.average_price,0) ELSE 0 END)ELSE 0 END)  AS DT_B2CW_动态货值

,(CASE WHEN e.Permit_Now_Phase='B1' THEN a.B1ZZ_可售面积 ELSE 0 END) AS DT_B1ZZ_动态货量 -- B1表示“规证阶段”，ZZ表示住宅，DT表示“动态”
,(CASE WHEN e.Permit_Now_Phase='B1' THEN a.B1SY_可售面积  ELSE 0 END)  AS DT_B1SY_动态货量
,(CASE WHEN e.Permit_Now_Phase='B1' THEN a.B1CW_可售车位数 ELSE 0 END)  AS DT_B1CW_动态货量

,(CASE WHEN e.Permit_Now_Phase='B2' OR (e.Permit_Now_Phase='B3' AND NVL(f.RoomCount,0)=0)  THEN a.B2ZZ_可售面积 ELSE 0 END) AS DT_B2ZZ_动态货量 -- B2表示“施证阶段”，ZZ表示住宅，DT表示“动态”
,(CASE WHEN e.Permit_Now_Phase='B2' OR (e.Permit_Now_Phase='B3' AND NVL(f.RoomCount,0)=0)  THEN a.B2SY_可售面积 ELSE 0 END) AS DT_B2SY_动态货量
,(CASE WHEN e.Permit_Now_Phase='B2' OR (e.Permit_Now_Phase='B3' AND NVL(f.RoomCount,0)=0)  THEN a.B2CW_可售车位数 ELSE 0 END)  AS DT_B2CW_动态货量

,NVL(c.average_price,0) AS 目标均价
,a."PROJ_ID",a."PROJECT_NAME",a."BLD_ID",a."BUILD_NAME",a."ORDER_HIERARCHY_CODE",a."NOW_PHASE_ID",a."NOW_PHASE_NAME",a."NOW_PHASE_ORDER",a."B1_是否有",a."B1_经营类别",a."B2_是否有",a."B3_是否有",a."B4_是否有",a."B1ZZ_建筑面积",a."B1ZZ_计容面积",a."B1ZZ_可售面积",a."B1SY_建筑面积",a."B1SY_计容面积",a."B1SY_可售面积",a."B1CW_建筑面积",a."B1CW_计容面积",a."B1CW_可售面积",a."B1CW_可售车位数",a."B1PT_建筑面积",a."B1PT_计容面积",a."B1PT_可售面积",a."B2ZZ_建筑面积",a."B2ZZ_计容面积",a."B2ZZ_可售面积",a."B2SY_建筑面积",a."B2SY_计容面积",a."B2SY_可售面积",a."B2CW_建筑面积",a."B2CW_计容面积",a."B2CW_可售面积",a."B2CW_可售车位数",a."B2PT_建筑面积",a."B2PT_计容面积",a."B2PT_可售面积",a."B3ZZ_建筑面积",a."B3ZZ_计容面积",a."B3ZZ_可售面积",a."B3SY_建筑面积",a."B3SY_计容面积",a."B3SY_可售面积",a."B3CW_建筑面积",a."B3CW_计容面积",a."B3CW_可售面积",a."B3CW_可售车位数",a."B3PT_建筑面积",a."B3PT_计容面积",a."B3PT_可售面积",a."B4ZZ_建筑面积",a."B4ZZ_计容面积",a."B4ZZ_可售面积",a."B4SY_建筑面积",a."B4SY_计容面积",a."B4SY_可售面积",a."B4CW_建筑面积",a."B4CW_计容面积",a."B4CW_可售面积",a."B4CW_可售车位数",a."B4PT_建筑面积",a."B4PT_计容面积",a."B4PT_可售面积"
FROM V_MDM_bld_Index_SUM a
LEFT JOIN V_DWM_Target_Worth_IdList b ON a.Proj_id=b.proj_id
LEFT JOIN dwm_target_worth_dtl c ON c.target_worth_id=b.A_当前最新版ID AND c.obj_id=a.bld_id AND c.obj_type=40
LEFT JOIN mdm_build d ON a.bld_id=d.id AND d.is_delete=0
LEFT JOIN (SELECT ID,(case when is_get_completed_permit=1 THEN 'B4'
             ELSE (case when is_get_pre_sale_permit=1 THEN 'B3'
               ELSE (case when is_get_constrcution_permit=1 THEN 'B2'
                 ELSE (case when is_get_con_plan_permit=1 THEN 'B1'
                   ELSE 'B0' END )
                    END )  END )
             END ) AS  Permit_Now_Phase
           FROM mdm_build
          ) e ON a.bld_id=e.id
LEFT JOIN (SELECT mdm_room.building_id AS Bld_id,NVL(COUNT(*),0) AS RoomCount FROM mdm_room GROUP BY mdm_room.building_id ) f ON f.bld_id=e.id
WHERE 1=1
-- AND a.project_name='花语岭南苑'
ORDER BY a.order_hierarchy_code
;

prompt
prompt Creating view V_DWM_TARGET_WORTH_DTL_NOW
prompt ========================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_DWM_TARGET_WORTH_DTL_NOW AS
SELECT b."ID",b."OBJ_NAME",b."OBJ_ID",b."OPERATE_ATTRIBUTE_ID",b."OPERATE_ATTRIBUTE_NAME",b."TOTAL_BUILD_AREA",b."TOTAL_VOLUME_AREA",b."TOTAL_SALES_AREA",b."GROUND_CAN_SELL_AREA",b."UNDERGROUND_CAN_SELL_AREA",b."TOTAL_CARPORT",b."GROUND_CARPORT",b."UNDERGROUND_CARPORT",b."AVERAGE_PRICE",b."WORTH",b."TARGET_WORTH_ID",b."OBJ_TYPE",b."CREATOR_ID",b."CREATED",b."CREATOR",b."MODIFIED",b."MODIFIER_ID",b."MODIFIER",b."OBJ_PHASE_ID",b."IS_CARPORT"
FROM v_dwm_target_worth_now a
LEFT   JOIN  dwm_target_worth_dtl b ON a.ID=b.target_worth_id
ORDER BY a.order_hierarchy_code;

prompt
prompt Creating view V_MDM_BLD_TO_NOW_PHASE
prompt ====================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_MDM_BLD_TO_NOW_PHASE AS
SELECT
 E.ID AS Proj_ID
,E.Project_Name AS Project_Name
,B.ID AS BLD_PHASE_ID_NOW
,C.ID AS PHASE_ID_NOW,C.PHASE_ORDER AS PHASE_ORDER_NOW
,C.PHASE_NAME AS PHASE_NAME_NOW,C.PHASE_CODE AS PHASE_CODE_N0W
,B.CREATED AS PHASE_CREATED_DATE
,A.ID AS BLD_ID
,A."ID",A."BUILD_NAME"
,E.Order_Hierarchy_Code||A.BUILD_NAME AS Order_Hierarchy_Code
,SUBSTR(D.PRODUCT_TYPE_NAME, 1,
       INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 1) - 1) AS FIRST_PRODUCT_NAME
,SUBSTR(D.PRODUCT_TYPE_NAME,
       INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 1) + 1,
       INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 2) -
        INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 1) - 1) AS SECOND_PRODUCT_NAME
,SUBSTR(D.PRODUCT_TYPE_NAME,
       DECODE(INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 2), 0, 100,
               INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 2)) + 1) AS THIRD_PRODUCT_NAME
,D.PRODUCT_TYPE_NAME AS PRODUCT_FULL_NAME
,A."PERIOD_ID",A."REMARK",A."PARCEL_ID",A."DELIVERY_TYPE",A."BUILD_STATE"
,A."CREATED",A."CREATOR_ID",A."CREATOR",A."MODIFIED",A."MODIFIER_ID",A."MODIFIER",A."ISSUE_TIME",A."IS_DELETE",A."PERIOD_NAME",A."IS_GET_CON_PLAN_PERMIT"
,A."GET_CON_PLAN_PERMIT_DATE",A."CON_PLAN_PERMIT_NO",A."IS_GET_CONSTRCUTION_PERMIT",A."GET_CONSTRCUTION_PERMIT_DATE",A."CONSTRUCTION_PERMIT_NO"
,A."IS_GET_PRE_SALE_PERMIT",A."GET_PRE_SALE_PERMIT_DATE",A."PRE_SALE_PERMIT_NO",A."IS_GET_COMPLETED_PERMIT",A."GET_COMPLETED_PERMIT_DATE"
,A."GET_COMPLETED_PERMIT_NO",A."NEWEST_BLD_AREA",A."NEWEST_SALE_BLD_AREA",A."NEWEST_SALE_BLD_AREA_ON",A."NEWEST_SALE_BLD_AREA_UBDER"
,A."NEWEST_CARPORT",A."CON_PLAN_PERMIT_ID",A."CONSTRACUTION_PERMIT_ID",A."PRE_SALE_PERMIT_ID",A."COMPLETED_PERMIT_ID",A."NEWEST_VALUE_PHASE"
FROM MDM_BUILD A
LEFT JOIN MDM_BUILD_PHASE B ON A.ID=B.BUILD_ID
LEFT JOIN MDM_PHASE C ON C.PHASE_ORDER=B.PHASE_ORDER
LEFT JOIN (SELECT B1.PRODUCT_TYPE_CODE, A1.*
         FROM   MDM_OBJ_PHASE_PT_INDEX A1
         INNER  JOIN MDM_BUILD_PRODUCT_TYPE B1
         ON     A1.PRODUCT_TYPE_ID = B1.ID) D ON D.OBJ_PHASE_ID = B.ID
LEFT JOIN mdm_project E ON a.proj_id=E.Id AND E.Is_Delete=0 AND E.Approval_Status='已审核'
WHERE
A.IS_DELETE=0 AND
B.PHASE_ORDER=(SELECT MAX(T.PHASE_ORDER) FROM MDM_BUILD_PHASE T WHERE T.BUILD_ID = A.ID GROUP BY  BUILD_ID );

prompt
prompt Creating view V_MDM_BLD_PERMIT_DTL
prompt ==================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_MDM_BLD_PERMIT_DTL AS
SELECT MB.PROJ_ID AS "PROJECT_ID", MP.PROJECT_NAME AS "PROJECT_NAME",
       --MPAR.PARCEL_NAME AS "PARCEL_NAME"
       '' AS "PARCEL_NAME"
       , MB.PARCEL_ID AS "PARCEL_ID",
       MB.PERIOD_ID AS "STAGE_ID", (CASE WHEN NVL(MB.PERIOD_NAME,'')='' OR MB.PERIOD_NAME='无分期' THEN '' ELSE MB.PERIOD_NAME END) AS "STAGE_NAME",
       MB.ID AS "BLD_ID", MB.BUILD_NAME AS "BLD_NAME",MB.BUILD_NAME AS "BLD_CODE",
      c.product_Type_name AS "PRODUCT_FULL_NAME", c.OPERATE_ATTRIBUTE_NAME AS "MANAGEMENT_TYPE",
      to_char(MB.GET_CON_PLAN_PERMIT_DATE,'yyyy-mm-dd') AS PLAN_PERMIT_DATE, -- 规划许可证办理日期
       MB.CON_PLAN_PERMIT_ID AS "PLAN_PERMIT_ID",
       MB.CON_PLAN_PERMIT_NO AS "PLAN_PERMIT_NO",-- 规划许可证编号
       to_char(MB.GET_CONSTRCUTION_PERMIT_DATE,'yyyy-mm-dd') AS "CONSTRUCTION_PERMIT_DATE", -- 施工许可证办理日期
       MB.CONSTRACUTION_PERMIT_ID AS "CONSTRUCTION_PERMIT_ID",
       MB.CONSTRUCTION_PERMIT_NO AS "CONSTRUCTION_PERMIT_NO", -- 施工许可证编号
       to_char(MB.GET_PRE_SALE_PERMIT_DATE,'yyyy-mm-dd') AS "PRE_SALE_PERMIT_DATE", -- 预售许可证办理日期
       MB.PRE_SALE_PERMIT_ID AS "PER_SALE_PERMIT_ID",
       MB.PRE_SALE_PERMIT_NO AS "PRE_SALE_PERMIT_NO", -- 预售许可证编号
       to_char(MB.GET_COMPLETED_PERMIT_DATE,'yyyy-mm-dd') AS "COMPLETED_PERMIT_DATE", -- 竣工备案办理日期
       MB.COMPLETED_PERMIT_ID AS "COMPLATED_PERMIT_ID",
       MB.GET_COMPLETED_PERMIT_NO AS "COMPLETED_PERMIT_NO"-- 竣工备案编号
FROM   V_MDM_BLD_TO_NOW_PHASE  MB
LEFT  JOIN MDM_PROJECT MP
ON     MB.PROJ_ID = MP.PROJECT_ORIGINAL_ID
LEFT  JOIN MDM_PERIOD MPER
ON    MPER.PERIOD_ORIGINAL_ID = MB.PERIOD_ID
LEFT JOIN MDM_PERIOD_VERSION MPerVer
ON     MPER.PERIOD_VERSION_ID = MPerVer.ID
LEFT  JOIN MDM_PARCEL MPAR
ON     MPAR.ID = MB.PARCEL_ID
 LEFT JOIN MDM_OBJ_PHASE_PT_INDEX c on c.obj_Phase_ID=MB.BLD_PHASE_ID_NOW

WHERE 1=1
and MB.IS_DELETE=0
and MP.APPROVAL_STATUS = '已审核' AND
       MP.PROJECT_VERSION IN
       (SELECT MAX(PROJECT_VERSION)
        FROM   MDM_PROJECT
        WHERE  APPROVAL_STATUS = '已审核'
        GROUP  BY PROJECT_ORIGINAL_ID) AND
       MPerVer.APPROVAL_STATUS = '已审核'
--  and MP.PROJECT_NAME='花语岭南苑'
--  and MP.PROJECT_NAME='佛山凤语潮鸣'
--  and MP.PROJECT_NAME='广州荔湾国际城'
ORDER BY MP.PROJECT_CODE,STAGE_NAME,BLD_NAME
;

prompt
prompt Creating view V_MDM_BUILDING
prompt ============================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_MDM_BUILDING AS
SELECT A.ID AS BUILDINGID, A.BUILD_NAME AS BUILDINGNAME,
       B.PROJECT_ORIGINAL_ID AS PROJID, B.PROJECT_NAME AS PROJNAME,
             (case when a.is_get_completed_permit=1 THEN '已竣备'
             ELSE (case when a.is_get_pre_sale_permit=1 THEN '已领预售证'
               ELSE (case when a.is_get_constrcution_permit=1 THEN '已领施工证'
                 ELSE (case when a.is_get_con_plan_permit=1 THEN '已领规证'
                   ELSE '未领规证' END )
                    END )  END ) END ) AS  Permit_Status,
       C.PERIOD_ORIGINAL_ID AS STAGESID, C.PERIOD_NAME AS STAGESNAME,
       D.ID AS COMPANYID, D.ORG_NAME AS COMPANYNAME,
       A.GET_CON_PLAN_PERMIT_DATE, A.CON_PLAN_PERMIT_ID,
       A.CON_PLAN_PERMIT_NO, A.GET_CONSTRCUTION_PERMIT_DATE,
       A.CONSTRACUTION_PERMIT_ID, A.CONSTRUCTION_PERMIT_NO,
       A.GET_PRE_SALE_PERMIT_DATE, A.PRE_SALE_PERMIT_ID,
       A.PRE_SALE_PERMIT_NO, A.GET_COMPLETED_PERMIT_DATE,
       A.COMPLETED_PERMIT_ID, A.GET_COMPLETED_PERMIT_NO

FROM   MDM_BUILD A
LEFT   JOIN MDM_PROJECT B
ON     A.PROJ_ID = B.PROJECT_ORIGINAL_ID
LEFT   JOIN MDM_PERIOD C
ON     A.PERIOD_ID = C.PERIOD_ORIGINAL_ID
LEFT   JOIN MDM_PERIOD_VERSION E
ON     C.PERIOD_VERSION_ID = E.ID
LEFT   JOIN SYS_BUSINESS_UNIT D
ON     B.COMPANY_ID = D.ID
WHERE  B.APPROVAL_STATUS = '已审核' AND
       B.PROJECT_VERSION IN
       (SELECT MAX(PROJECT_VERSION)
        FROM   MDM_PROJECT
        WHERE  APPROVAL_STATUS = '已审核'
        GROUP  BY PROJECT_ORIGINAL_ID) AND
       E.APPROVAL_STATUS = '已审核'
and a.BUILD_STATE='10'
ORDER BY a.ORDER_HIERARCHY_CODE;

prompt
prompt Creating view V_MDM_PROJECTS
prompt ============================
prompt
create or replace force view pom0813.v_mdm_projects as
select orgId,orgName,orgType,parentId,cityName,projCode from
(select a.PERIOD_ORIGINAL_ID as orgId , a.PERIOD_NAME as orgName,'11' as orgType,d.PROJECT_ORIGINAL_ID as parentId,e.CITY_NAME as cityName,'' as projCode
from MDM_PERIOD a left join MDM_PERIOD_VERSION d on a.PERIOD_VERSION_ID = d.ID
left join MDM_PROJECT e on e.PROJECT_ORIGINAL_ID = d.PROJECT_ORIGINAL_ID
where d.APPROVAL_STATUS = '已审核'
UNION
select b.PROJECT_ORIGINAL_ID as orgId, b.PROJECT_NAME as orgName,'10' as orgType,b.COMPANY_ID as parentId,b.CITY_NAME as cityName,b.PROJECT_CODE as projCode
from MDM_PROJECT b  where APPROVAL_STATUS = '已审核' and PROJECT_VERSION in (
select max(PROJECT_VERSION) from MDM_PROJECT  where APPROVAL_STATUS = '已审核' group by PROJECT_ORIGINAL_ID
)
UNION
select c.ID as orgId,c.ORG_NAME as orgName,'0' as orgType,c.PARENT_ID as parentId,'' as cityName,'' as projCode
from SYS_BUSINESS_UNIT c where ORG_TYPE = 0 and (ID != '000100000000000000000000000000' and ID != '000200000000000000000000000000')
) t
where orgTYpe in ('10','11');

prompt
prompt Creating view V_MDM_PROJECT_LIST
prompt ================================
prompt
create or replace force view pom0813.v_mdm_project_list as
select orgId,orgName,orgType,parentId,cityName,projCode,levelRank from
(select a.PERIOD_ORIGINAL_ID as orgId , a.PERIOD_NAME as orgName,'11' as orgType,d.PROJECT_ORIGINAL_ID as parentId,e.CITY_NAME as cityName,'' as projCode,'2' as levelRank
from MDM_PERIOD a left join MDM_PERIOD_VERSION d on a.PERIOD_VERSION_ID = d.ID
left join MDM_PROJECT e on e.PROJECT_ORIGINAL_ID = d.PROJECT_ORIGINAL_ID
where d.APPROVAL_STATUS = '已审核'
UNION
select b.PROJECT_ORIGINAL_ID as orgId, b.PROJECT_NAME as orgName,'10' as orgType,b.COMPANY_ID as parentId,b.CITY_NAME as cityName,b.PROJECT_CODE as projCode,'1' as levelRank
from MDM_PROJECT b  where APPROVAL_STATUS = '已审核' and PROJECT_VERSION in (
select max(PROJECT_VERSION) from MDM_PROJECT  where APPROVAL_STATUS = '已审核' group by PROJECT_ORIGINAL_ID
)
) t;

prompt
prompt Creating view V_MDM_PROJECT_TREE
prompt ================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_MDM_PROJECT_TREE AS
SELECT ORGID, ORGNAME, ORGTYPE, PARENTID, CITYNAME, PROJCODE
/*,order_Code
*/
FROM   (SELECT A.PERIOD_ORIGINAL_ID AS ORGID, A.PERIOD_NAME AS ORGNAME,
								'11' AS ORGTYPE, D.PROJECT_ORIGINAL_ID AS PARENTID,
								E.CITY_NAME AS CITYNAME, '' AS PROJCODE
				 /*,c.Parent_ID||'-'||substr('000'||c.order_code,-3)||'-'||e.project_code||'-'|| a.PERIOD_NAME AS ORDER_CODE --用于树形的排序
         */
				 FROM   MDM_PERIOD A
				 LEFT   JOIN MDM_PERIOD_VERSION D
				 ON     A.PERIOD_VERSION_ID = D.ID
				 LEFT   JOIN MDM_PROJECT E
				 ON     E.PROJECT_ORIGINAL_ID = D.PROJECT_ORIGINAL_ID
				 /*LEFT JOIN SYS_BUSINESS_UNIT c ON e.company_id=c.id
         */
				 WHERE  D.APPROVAL_STATUS = '已审核'

				 UNION
				 SELECT B.PROJECT_ORIGINAL_ID AS ORGID, B.PROJECT_NAME AS ORGNAME,
								'10' AS ORGTYPE, B.COMPANY_ID AS PARENTID,
								B.CITY_NAME AS CITYNAME, B.PROJECT_CODE AS PROJCODE
				 /*,c.Parent_ID||'-'||substr('000'||c.order_code,-3)||'-'||b.project_code AS ORDER_CODE --用于树形的排序
         */
				 FROM   MDM_PROJECT B
				 /*LEFT JOIN SYS_BUSINESS_UNIT c ON b.company_id=c.id
         */
				 WHERE  APPROVAL_STATUS = '已审核' AND
								PROJECT_VERSION IN
								(SELECT MAX(PROJECT_VERSION)
								 FROM   MDM_PROJECT
								 WHERE  APPROVAL_STATUS = '已审核'
								 GROUP  BY PROJECT_ORIGINAL_ID)

				 UNION
				 SELECT C.ID AS ORGID, C.ORG_NAME AS ORGNAME, '0' AS ORGTYPE,
								C.PARENT_ID AS PARENTID, '' AS CITYNAME, '' AS PROJCODE
				 /*,c.Parent_ID||'-'||substr('000'||c.order_code,-3) AS ORDER_CODE --用于树形的排序
         */
				 FROM   SYS_BUSINESS_UNIT C
				 WHERE  ORG_TYPE = 0 AND
								(ID != '000100000000000000000000000000' AND
								ID != '000200000000000000000000000000')) T
/*ORDER BY order_Code
*/
;

prompt
prompt Creating view V_MDM_ROOM
prompt ========================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_MDM_ROOM AS
SELECT b.building_id
       ,a.order_hierarchy_code
      ,b.project_name
      ,SUM(NVL((CASE WHEN b.sale_state<>'签约' THEN ROUND(b.bz_price*b.pre_bld_area,2) ELSE 0 END),0)) AS ALL库存货值_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state='签约' THEN b.trade_total ELSE 0 END),0)) AS ALL已售货值_房间合计

      ,SUM(NVL((CASE WHEN b.sale_state<>'签约'THEN (CASE WHEN b.bz_total_area_type='预售' THEN  b.pre_bld_area ELSE b.actual_bld_area END) ELSE 0 END),0)) AS ALL库存面积_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state='签约' THEN (CASE WHEN b.bz_total_area_type='预售' THEN  b.pre_bld_area ELSE b.actual_bld_area END) ELSE 0 END),0)) AS ALL已售面积_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state<>'签约'THEN (CASE WHEN b.bz_total_area_type='预售' THEN 1 ELSE 0 END) ELSE 0 END),0)) AS ALL库存套数_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state='签约' THEN (CASE WHEN b.bz_total_area_type='预售' THEN 1 ELSE 0 END) ELSE 0 END),0)) AS ALL已售套数_房间合计

      ,SUM(NVL((CASE WHEN b.sale_state<>'签约'AND b.product_name='住宅' THEN ROUND(b.bz_price*b.pre_bld_area,2) ELSE 0 END),0)) AS ZZ库存货值_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state='签约' AND b.product_name='住宅' THEN b.trade_total ELSE 0 END),0)) AS ZZ已售货值_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state<>'签约'AND b.product_name='住宅' THEN (CASE WHEN b.bz_total_area_type='预售' THEN  b.pre_bld_area ELSE b.actual_bld_area END) ELSE 0 END),0)) AS ZZ库存面积_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state='签约' AND b.product_name='住宅' THEN (CASE WHEN b.bz_total_area_type='预售' THEN  b.pre_bld_area ELSE b.actual_bld_area END) ELSE 0 END),0)) AS ZZ已售面积_房间合计

      ,SUM(NVL((CASE WHEN b.sale_state<>'签约'AND b.product_name='商办' THEN ROUND(b.bz_price*b.pre_bld_area,2) ELSE 0 END),0)) AS SY库存货值_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state='签约' AND b.product_name='商办' THEN b.trade_total ELSE 0 END),0)) AS SY已售货值_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state<>'签约'AND b.product_name='商办' THEN (CASE WHEN b.bz_total_area_type='预售' THEN  b.pre_bld_area ELSE b.actual_bld_area END) ELSE 0 END),0)) AS SY库存面积_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state='签约' AND b.product_name='商办' THEN (CASE WHEN b.bz_total_area_type='预售' THEN  b.pre_bld_area ELSE b.actual_bld_area END) ELSE 0 END),0)) AS SY已售面积_房间合计

      ,SUM(NVL((CASE WHEN b.sale_state<>'签约'AND b.product_name='车位' THEN ROUND(b.bz_price*b.pre_bld_area,2) ELSE 0 END),0)) AS CW库存货值_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state='签约' AND b.product_name='车位' THEN b.trade_total ELSE 0 END),0)) AS CW已售货值_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state<>'签约'AND b.product_name='车位' THEN (CASE WHEN b.bz_total_area_type='预售' THEN  b.pre_bld_area ELSE b.actual_bld_area END) ELSE 0 END),0)) AS CW库存面积_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state='签约' AND b.product_name='车位' THEN (CASE WHEN b.bz_total_area_type='预售' THEN  b.pre_bld_area ELSE b.actual_bld_area END) ELSE 0 END),0)) AS CW已售面积_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state<>'签约'AND b.product_name='车位' THEN (CASE WHEN b.bz_total_area_type='预售' THEN  b.pre_bld_area ELSE b.actual_bld_area END) ELSE 0 END),0)) AS CW库存套数_房间合计
      ,SUM(NVL((CASE WHEN b.sale_state='签约' AND b.product_name='车位' THEN (CASE WHEN b.bz_total_area_type='预售' THEN  b.pre_bld_area ELSE b.actual_bld_area END) ELSE 0 END),0)) AS CW已售套数_房间合计

FROM Mdm_Room b LEFT JOIN mdm_build a ON a.id=b.building_id
GROUP BY b.project_name,b.building_id ,a.order_hierarchy_code
ORDER BY a.order_hierarchy_code;

prompt
prompt Creating view V_MDM_STAGE
prompt =========================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_MDM_STAGE AS
SELECT A.PERIOD_ORIGINAL_ID AS STAGESID, A.PERIOD_NAME AS STAGESNAME,
			 B.PROJECT_ORIGINAL_ID AS PROJID, B.PROJECT_NAME AS PROJNAME,
			 B.PROJECT_CODE AS PROJCODE, C.ID AS COMPANYID,
			 C.ORG_NAME AS COMPANYNAME
FROM   MDM_PERIOD A
LEFT   JOIN MDM_PERIOD_VERSION D
ON     A.PERIOD_VERSION_ID = D.ID
LEFT   JOIN MDM_PROJECT B
ON     D.PROJECT_ORIGINAL_ID = B.PROJECT_ORIGINAL_ID
LEFT   JOIN SYS_BUSINESS_UNIT C
ON     B.COMPANY_ID = C.ID
WHERE  D.APPROVAL_STATUS = '已审核';

prompt
prompt Creating view V_NODES_LIST
prompt ==========================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_NODES_LIST AS
SELECT
	b.id as nodeId ,
	b.NODE_NAME as nodeName,
	c.PROJ_NAME as projectName,
    case when  b.NODE_LEVEL='里程碑'or b.NODE_LEVEL='一级节点' or b.NODE_LEVEL='二级节点' or b.NODE_LEVEL='三级节点' then b.NODE_LEVEL else '其他' end  as sqlLevel,
    case when B.ACTUAL_END_DATE is not null then '已完成'
        when B.PLAN_END_DATE < Trunc(sysdate)   then '已超期' else '未完成' end as  status ,
	b.PROJ_PLAN_ID as planId,
	c.plan_type as planType,
	b.PLAN_END_DATE as planEndDate,
	b.ESTIMATE_END_DATE as estimateEndDate,
	b.ACTUAL_END_DATE as actualEndDate,
	a.charge_person_id as chargePersonId,
	b.ORIGINAL_NODE_ID as originalNodeId
FROM
	POM_NODE_CHARGE_PERSON a
	left join POM_PROJ_PLAN_NODE b ON a.node_id = b.id
	left join POM_PROJ_PLAN c ON b.PROJ_PLAN_ID = c.ID
WHERE
	 c.plan_type in ('关键节点计划', '项目主项计划')
	and b.is_delete = 0 and b.is_disable = 0 and c.APPROVAL_STATUS = '已审核'
	UNION ALL
SELECT
	 b.id as nodeId,
	 b.NODE_NAME as nodeName,
	 c.PLAN_NAME as projectName,
	 '其他' as sqlLevel,
        case when B.ACTUAL_END_DATE is not null then '已完成'
        when B.PLAN_END_DATE < Trunc(sysdate)   then '已超期' else '未完成' end as  status ,
	 b.plan_id as planId,
	 '专项计划' as planType,
	 b.PLAN_END_DATE as planEndDate,
	 b.PREDICT_END_DATE as estimateEndDate,
	 b.ACTUAL_END_DATE as actualEndDate,
	 a.charge_person_id as chargePersonId,
	 b.ORIGINAL_NODE_ID as originalNodeId
	 FROM
	 POM_NODE_CHARGE_PERSON a
	 left join POM_SPECIAL_PLAN_NODE b on a.node_id = b.id
	 left join POM_SPECIAL_PLAN c on b.plan_id = c.id
	 WHERE
	  b.is_delete = 0 and c.APPROVAL_STATUS = '已审核'
	 UNION ALL
SELECT
	b.id as nodeId,
	b.NODE_NAME as nodeName,
	c.PLAN_NAME as projectName,
	'其他' as sqlLevel,
        case when B.ACTUAL_END_DATE is not null then '已完成'
        when B.PLAN_END_DATE < Trunc(sysdate)   then '已超期' else '未完成' end as  status ,
	b.DEPT_MONTHLY_PLAN_ID as planId,
	'部门月度计划' as planType,
	b.PLAN_END_DATE as planEndDate,
	b.ESTIMATE_END_DATE as estimateEndDate,
	b.ACTUAL_END_DATE as actualEndDate,
	a.charge_person_id as chargePersonId,
	b.ORIGINAL_NODE_ID as originalNodeId
	FROM
	 POM_NODE_CHARGE_PERSON a
  left join POM_DEPT_MONTHLY_PLAN_NODE b on a.node_id = b.id
  left join POM_DEPT_MONTHLY_PLAN c on c.id = b.DEPT_MONTHLY_PLAN_ID
	where  c.APPROVE_STATUS = '已审核';

prompt
prompt Creating view V_POM_GETEXAMINE_MOTH
prompt ===================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_POM_GETEXAMINE_MOTH AS
SELECT
	TO_CHAR(
	CASE
			WHEN TO_CHAR( SYSDATE, 'DD' ) > 25 
			AND TO_NUMBER( TO_CHAR( SYSDATE, 'MM' ) ) + 1 > 12 THEN
				TO_CHAR( SYSDATE, 'YYYY' ) + 1 ELSE TO_NUMBER( TO_CHAR( SYSDATE, 'YYYY' ) ) 
			END 
			) AS "铁建_本年",
	   TO_CHAR(case when   TO_NUMBER(TO_CHAR(SYSDATE,'mm'))=12 and  TO_NUMBER(TO_CHAR(SYSDATE,'dd')) >25 then 1 else     TO_NUMBER(TO_CHAR(SYSDATE,'Q'))  end) AS "铁建_本季度",
		CASE
			WHEN
			CASE
					WHEN TO_CHAR( SYSDATE, 'DD' ) > 25 THEN
					TO_NUMBER( TO_CHAR( SYSDATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( SYSDATE, 'MM' ) ) 
				END > 12 THEN
	1 ELSE
CASE
		WHEN TO_CHAR( SYSDATE, 'DD' ) > 25 THEN
		TO_NUMBER( TO_CHAR( SYSDATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( SYSDATE, 'MM' ) ) 
	END 
	END AS "铁建_本月" 
,TO_CHAR( SYSDATE, 'DD' ) AS  "铁建_当天"

FROM
	dual;

prompt
prompt Creating view V_POM_GETEXAMINE_QUARTER
prompt ======================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_POM_GETEXAMINE_QUARTER AS
SELECT
CASE
		
	WHEN
		    A.铁建_本季度  = 1  THEN
	  	TO_CHAR(TO_NUMBER(TO_CHAR( SYSDATE, 'YYYY' )-1))

			WHEN A.铁建_本季度 = 2 THEN
			TO_CHAR( SYSDATE, 'YYYY' ) 
			WHEN A.铁建_本季度 = 3 THEN
			TO_CHAR( SYSDATE, 'YYYY' ) 
			WHEN A.铁建_本季度 = 4 THEN
			TO_CHAR( SYSDATE, 'YYYY' ) ELSE NULL 
		END AS 开始年度 
		,TO_CHAR(
CASE
		
	WHEN  TO_NUMBER(TO_CHAR(SYSDATE,'mm'))=12 AND  TO_NUMBER(TO_CHAR(SYSDATE,'DD'))>25 THEN   TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))+1
 ELSE   TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))
		END) AS 结束年度  
		,
	CASE
			
			WHEN A.铁建_本季度 = 4 THEN
			'09' 
			WHEN A.铁建_本季度 = 3 THEN
			'06' 
			WHEN A.铁建_本季度 = 2 THEN
			'03' 
			WHEN A.铁建_本季度 = 1 THEN
			'12' ELSE NULL 
		END AS 开始月份 
		,
	CASE
			
			WHEN A.铁建_本季度 = 4 THEN
			'12' 
			WHEN A.铁建_本季度 = 3 THEN
			'09' 
			WHEN A.铁建_本季度 = 2 THEN
			'06' 
			WHEN A.铁建_本季度 = 1 THEN
			'03' ELSE NULL 
		END AS 结束月份 
FROM
	V_POM_GETEXAMINE_MOTH A;

prompt
prompt Creating view V_POM_KEYNODE_M_STATISTICS
prompt ========================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_POM_KEYNODE_M_STATISTICS AS
SELECT
	row_number() over( PARTITION  BY A.PARENT_ID  order by ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100,2) desc) as rank ,LEVEL_RANK,
	A.ID,A.PARENT_ID,A.ORG_NAME,'' AS "COMPANY_ID"
	,NVL(B.NODESUM,0) AS NODESUM
	,nvl(ISFINISH,0) AS  ISFINISHTOTAL
	,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
	,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
	,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
 ,NVL(ISDELAY,0) AS ISDELAY
	,ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
	,ROUND(CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
	,ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
	,'TYPE_ORG' AS "CTYPE"
    ,'' as "STAGEID"
FROM SYS_BUSINESS_UNIT A LEFT JOIN  (
 SELECT AB.ID,AB.PARENT_ID,SUM(AB.NODESUM) AS NODESUM,SUM(AB.ISFINISH) AS ISFINISH,SUM(AB.ISDELAY) AS ISDELAY,SUM(AB.ONTIMEFINISH) AS ONTIMEFINISH,SUM(AB.DELAYFINISH) AS DELAYFINISH,SUM(AB.ADVANCEFINISH) AS ADVANCEFINISH from  (
--  11

 SELECT    NVL(B.NODESUM,0) AS NODESUM
 ,NVL(B.ISFINISH,0) AS ISFINISH
 ,NVL(B.ONTIMEFINISH,0) AS ONTIMEFINISH
 ,NVL(B.DELAYFINISH,0) AS DELAYFINISH,ORG_NAME
 ,NVL(ADVANCEFINISH,0) AS AdvanceFINISH
  ,NVL(ISDELAY,0) AS ISDELAY
 ,ORG_NAME
 ,CONNECT_BY_ROOT ID AS  ID ,CONNECT_BY_ROOT PARENT_ID  AS  PARENT_ID
 from   SYS_BUSINESS_UNIT A  LEFT JOIN
 (
 SELECT  B1.UNIT_ID ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"


  FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='关键节点计划' AND  A.APPROVAL_STATUS='已审核'
   AND A1. IS_DISABLE=0
 --判断本月
 AND A1.PLAN_END_DATE  BETWEEN
  TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||'-'||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else'12' end ||'-'||'26'  FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')  AND
 TO_DATE ((SELECT    A.铁建_本年||'-'||铁建_本月||'-'||'25' FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID
	)  B ON  A.ID=B.UNIT_ID
	WHERE NVL(B.NODESUM,0)>0
CONNECT  by PRIOR   A.ID= A.PARENT_ID
) AB
GROUP BY AB.ID,AB.PARENT_ID
)B  ON  A.ID=B.ID
WHERE  A.ORG_TYPE=0  AND     NVL(B.NODESUM,0) >0

UNION ALL
--顶级项目汇总//无分期
SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,4 as  lw
,B2.ID,B2.PARENT_ID,B2.PROJECT_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
  ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,/*'TYPE_PROJTOP' AS CTYPE*/CASE WHEN B3.STAGE_NAME LIKE '%无分期%' THEN 'TYPE_PROJLAST' else 'TYPE_PROJTOP' end as CTYPE
,b3."STAGEID" AS "STAGEID"
FROM(
 SELECT  B1.UNIT_ID AS PARENT_ID ,A.COMPANY_ID ,C1.PROJECT_ID AS ID,B1.PROJECT_NAME ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
 --完成规则
 ,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"
,c1.PROJECT_ID
 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
 INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='关键节点计划'AND  A.APPROVAL_STATUS='已审核'
   AND A1. IS_DISABLE=0
   AND A1.PLAN_END_DATE BETWEEN
  TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||'-'||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else'12' end ||'-'||'26'  FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')  AND
 TO_DATE ((SELECT    A.铁建_本年||'-'||铁建_本月||'-'||'25' FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID,A.COMPANY_ID,PROJECT_NAME,c1.PROJECT_ID 	) B2
		LEFT JOIN (SELECT P2.PROJECT_ID,TO_CHAR(wm_concat(P2.STAGE_NAME)) AS STAGE_NAME,p2.id as "STAGEID" FROM SYS_PROJECT P1 LEFT JOIN SYS_PROJECT_STAGE P2 ON P1.ID = P2.PROJECT_ID GROUP BY P2.PROJECT_ID,p2.ID) B3 ON B2.PROJECT_ID = B3.PROJECT_ID
		where        NVL(B2.NODESUM,0)>0 and B3.STAGE_NAME LIKE '%无分期%'


UNION ALL
--顶级项目汇总//有分期
SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,4
,B2.ID,B2.PARENT_ID,B2.PROJECT_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
  ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,/*'TYPE_PROJTOP' AS CTYPE*/CASE WHEN B3.STAGE_NAME LIKE '%无分期%' THEN 'TYPE_PROJLAST' else 'TYPE_PROJTOP' end as CTYPE,
 '' as "STAGEID"
FROM(
 SELECT  B1.UNIT_ID AS PARENT_ID ,A.COMPANY_ID ,B1.ID,B1.PROJECT_NAME ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
 --完成规则
 ,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"
,c1.PROJECT_ID


 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='关键节点计划'
   AND A1. IS_DISABLE=0
 AND  A.APPROVAL_STATUS='已审核'  AND A1.PLAN_END_DATE BETWEEN
  TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||'-'||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else'12' end ||'-'||'26'  FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')  AND
 TO_DATE ((SELECT    A.铁建_本年||'-'||铁建_本月||'-'||'25' FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID,A.COMPANY_ID,B1.ID,PROJECT_NAME,c1.PROJECT_ID 	) B2
		LEFT JOIN (SELECT P2.PROJECT_ID,TO_CHAR(wm_concat(P2.STAGE_NAME)) AS STAGE_NAME FROM SYS_PROJECT P1 LEFT JOIN SYS_PROJECT_STAGE P2 ON P1.ID = P2.PROJECT_ID GROUP BY P2.PROJECT_ID) B3 ON B2.PROJECT_ID = B3.PROJECT_ID
	where        NVL(B2.NODESUM,0)>0 and B3.STAGE_NAME NOT   LIKE '%无分期%'
		----分期汇总

UNION ALL
SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,5
,B2.ID,B2.PARENT_ID,B2.PROJSTAGE_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
  ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,'TYPE_PROJLAST' AS CTYPE
,B2."STAGEID"
FROM(
 SELECT  C1.PROJECT_ID AS PARENT_ID ,A.COMPANY_ID ,C1.ID,B1.PROJECT_NAME||'_'|| C1.STAGE_NAME AS  PROJSTAGE_NAME ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"
,C1.ID as "STAGEID"

 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='关键节点计划' 
   AND A1. IS_DISABLE=0
    AND  A.APPROVAL_STATUS='已审核'
   AND A1.PLAN_END_DATE BETWEEN
  TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||'-'||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else'12' end ||'-'||'26'  FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')  AND
 TO_DATE ((SELECT    A.铁建_本年||'-'||铁建_本月||'-'||'25' FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'--C1.PROJECT_ID
		GROUP BY  C1.PROJECT_ID,A.COMPANY_ID,C1.ID,PROJECT_NAME, STAGE_NAME	) B2		where        NVL(B2.NODESUM,0)>0 AND B2.PROJSTAGE_NAME NOT LIKE '%无分期%'
;

prompt
prompt Creating view V_POM_KEY_NODE_Q_STATISTICS
prompt =========================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_POM_KEY_NODE_Q_STATISTICS AS
SELECT
	row_number() over( PARTITION  BY A.PARENT_ID  order by ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100,2) desc) as rank ,LEVEL_RANK,
	A.ID,A.PARENT_ID,A.ORG_NAME,'' AS COMPANY_ID
	,NVL(B.NODESUM,0) AS NODESUM
	,nvl(ISFINISH,0) AS  ISFINISHTOTAL
	,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
	,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
	,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
		,NVL(ISDELAY,0) AS ISDELAY
	,ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
	,ROUND(CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
	,ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
	,'TYPE_ORG' AS CTYPE
    ,'' as "STAGEID"
FROM SYS_BUSINESS_UNIT A LEFT JOIN  (
 SELECT AB.ID,AB.PARENT_ID,SUM(AB.NODESUM) AS NODESUM,SUM(AB.ISFINISH) AS ISFINISH,SUM(AB.ONTIMEFINISH) AS ONTIMEFINISH,SUM(AB.ISDELAY) AS ISDELAY,SUM(AB.DELAYFINISH) AS DELAYFINISH,SUM(AB.ADVANCEFINISH) AS ADVANCEFINISH from  (
--  11

 SELECT    NVL(B.NODESUM,0) AS NODESUM
 ,NVL(B.ISFINISH,0) AS ISFINISH
 ,NVL(B.ONTIMEFINISH,0) AS ONTIMEFINISH
 ,NVL(B.DELAYFINISH,0) AS DELAYFINISH,ORG_NAME
 ,NVL(ADVANCEFINISH,0) AS AdvanceFINISH
  ,NVL(ISDELAY,0) AS ISDELAY
 ,ORG_NAME
 ,CONNECT_BY_ROOT ID AS  ID ,CONNECT_BY_ROOT PARENT_ID  AS  PARENT_ID
 from   SYS_BUSINESS_UNIT A  LEFT JOIN
 (
 SELECT  B1.UNIT_ID ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"

FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
 INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
WHERE  A.PLAN_TYPE='关键节点计划' 
  AND A1. IS_DISABLE=0
AND  A.APPROVAL_STATUS='已审核'
 --判断季度
 AND TO_CHAR(A1.PLAN_END_DATE,'YYYY-MM-DD') BETWEEN
 (	SELECT A.开始年度||'-'||A.开始月份||'-26'   FROM V_POM_GETEXAMINE_QUARTER A)  AND
 (	SELECT A.结束年度||'-'||A.结束月份||'-25' FROM V_POM_GETEXAMINE_QUARTER A)
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID
	)  B ON  A.ID=B.UNIT_ID
	WHERE NVL(B.NODESUM,0)>0
CONNECT  by PRIOR   A.ID= A.PARENT_ID
) AB
GROUP BY AB.ID,AB.PARENT_ID
)B  ON  A.ID=B.ID
WHERE  A.ORG_TYPE=0  AND     NVL(B.NODESUM,0) >0

UNION ALL
--顶级项目汇总有分期
SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,4
,B2.ID,B2.PARENT_ID,B2.PROJECT_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
  ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,/*'TYPE_PROJTOP' AS CTYPE*/CASE WHEN B3.STAGE_NAME LIKE '%无分期%' THEN 'TYPE_PROJLAST' else 'TYPE_PROJTOP' end as CTYPE
,b3."STAGEID" AS "STAGEID"
FROM(
 SELECT  B1.UNIT_ID AS PARENT_ID ,A.COMPANY_ID ,C1.PROJECT_ID AS ID,B1.PROJECT_NAME ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
,C1.PROJECT_ID
  --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"


 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='关键节点计划'
   AND A1. IS_DISABLE=0
 AND  A.APPROVAL_STATUS='已审核'  AND TO_CHAR(A1.PLAN_END_DATE,'YYYY-MM-DD')
 BETWEEN
(	SELECT A.开始年度||'-'||A.开始月份||'-26'   FROM V_POM_GETEXAMINE_QUARTER A)  AND
 (	SELECT A.结束年度||'-'||A.结束月份||'-25' FROM V_POM_GETEXAMINE_QUARTER A)
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID,A.COMPANY_ID ,PROJECT_NAME ,C1.PROJECT_ID	) B2
		LEFT JOIN (SELECT P2.PROJECT_ID,TO_CHAR(wm_concat(P2.STAGE_NAME)) AS STAGE_NAME,p2.id as "STAGEID" FROM SYS_PROJECT P1 LEFT JOIN SYS_PROJECT_STAGE P2 ON P1.ID = P2.PROJECT_ID GROUP BY P2.PROJECT_ID,p2.ID) B3 ON B2.PROJECT_ID = B3.PROJECT_ID
		where        NVL(B2.NODESUM,0)>0 AND  B3.STAGE_NAME    LIKE '%无分期%'


		UNION ALL
--顶级项目汇总无分期
SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,4
,B2.ID,B2.PARENT_ID,B2.PROJECT_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
  ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,/*'TYPE_PROJTOP' AS CTYPE*/CASE WHEN B3.STAGE_NAME LIKE '%无分期%' THEN 'TYPE_PROJLAST' else 'TYPE_PROJTOP' end as CTYPE
,'' as "STAGEID"
FROM(
 SELECT  B1.UNIT_ID AS PARENT_ID  ,A.COMPANY_ID,B1.ID,B1.PROJECT_NAME ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
,C1.PROJECT_ID
  --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"


 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='关键节点计划'
   AND A1. IS_DISABLE=0
 AND  A.APPROVAL_STATUS='已审核'  AND TO_CHAR(A1.PLAN_END_DATE,'YYYY-MM-DD')
 BETWEEN
(	SELECT A.开始年度||'-'||A.开始月份||'-26'   FROM V_POM_GETEXAMINE_QUARTER A)  AND
 (	SELECT A.结束年度||'-'||A.结束月份||'-25' FROM V_POM_GETEXAMINE_QUARTER A)
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID,A.COMPANY_ID,B1.ID,PROJECT_NAME ,C1.PROJECT_ID	) B2
		LEFT JOIN (SELECT P2.PROJECT_ID,TO_CHAR(wm_concat(P2.STAGE_NAME)) AS STAGE_NAME FROM SYS_PROJECT P1 LEFT JOIN SYS_PROJECT_STAGE P2 ON P1.ID = P2.PROJECT_ID GROUP BY P2.PROJECT_ID) B3 ON B2.PROJECT_ID = B3.PROJECT_ID
		where        NVL(B2.NODESUM,0)>0  AND  B3.STAGE_NAME not  LIKE '%无分期%'


		----分期汇总

UNION ALL
SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,5
,B2.ID,B2.PARENT_ID,B2.PROJSTAGE_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
 ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,'TYPE_PROJLAST' AS CTYPE
,B2."STAGEID"
FROM(
 SELECT  C1.PROJECT_ID AS PARENT_ID,A.COMPANY_ID  ,C1.ID,B1.PROJECT_NAME||'_'|| C1.STAGE_NAME AS  PROJSTAGE_NAME ,COUNT(A1.ID) AS "NODESUM"
  --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"
,C1.ID as "STAGEID"

 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='关键节点计划' 
   AND A1. IS_DISABLE=0
    AND  A.APPROVAL_STATUS='已审核'
   AND TO_CHAR(A1.PLAN_END_DATE,'YYYY-MM-DD') BETWEEN (	SELECT A.开始年度||'-'||A.开始月份||'-26'   FROM V_POM_GETEXAMINE_QUARTER A)  AND
 (	SELECT A.结束年度||'-'||A.结束月份||'-25' FROM V_POM_GETEXAMINE_QUARTER A)
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY C1.PROJECT_ID,C1.ID,A.COMPANY_ID,PROJECT_NAME, STAGE_NAME	) B2		where        NVL(B2.NODESUM,0)>0 AND B2.PROJSTAGE_NAME NOT LIKE '%无分期%'
;

prompt
prompt Creating view V_POM_KEY_NODE_Y_STATISTICS
prompt =========================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_POM_KEY_NODE_Y_STATISTICS AS
SELECT
	row_number() over( PARTITION  BY A.PARENT_ID  order by ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100,2) desc) as rank ,LEVEL_RANK,
	A.ID,A.PARENT_ID,A.ORG_NAME,'' AS COMPANY_ID
	,NVL(B.NODESUM,0) AS NODESUM
	,nvl(ISFINISH,0) AS  ISFINISHTOTAL
	,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
	,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
	,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
		,NVL(ISDELAY,0) AS ISDELAY
	,ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
	,ROUND(CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
	,ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
	,'TYPE_ORG' AS CTYPE
    ,'' as "STAGEID"
FROM SYS_BUSINESS_UNIT A LEFT JOIN  (
 SELECT AB.ID,AB.PARENT_ID,SUM(AB.NODESUM) AS NODESUM,SUM(AB.ISFINISH) AS ISFINISH,SUM(AB.ONTIMEFINISH) AS ONTIMEFINISH,SUM(AB.ISDELAY) AS ISDELAY,SUM(AB.DELAYFINISH) AS DELAYFINISH,SUM(AB.ADVANCEFINISH) AS ADVANCEFINISH from  (
--  11

 SELECT    NVL(B.NODESUM,0) AS NODESUM
 ,NVL(B.ISFINISH,0) AS ISFINISH
 ,NVL(B.ONTIMEFINISH,0) AS ONTIMEFINISH
 ,NVL(B.DELAYFINISH,0) AS DELAYFINISH,ORG_NAME
 ,NVL(ADVANCEFINISH,0) AS AdvanceFINISH
  ,NVL(ISDELAY,0) AS ISDELAY
 ,ORG_NAME
 ,CONNECT_BY_ROOT ID AS  ID ,CONNECT_BY_ROOT PARENT_ID  AS  PARENT_ID
 from   SYS_BUSINESS_UNIT A  LEFT JOIN
 (
 SELECT  B1.UNIT_ID ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"

FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
 INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
WHERE  A.PLAN_TYPE='关键节点计划'
  AND A1. IS_DISABLE=0
 AND  A.APPROVAL_STATUS='已审核'
	 --判断本年
 -- A1.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||'-12'||'-26','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||'-12'||'-25','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH)
 AND  A1.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||'-12'||'-26','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||'-12'||'-25','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH)
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID
	)  B ON  A.ID=B.UNIT_ID
	WHERE NVL(B.NODESUM,0)>0
CONNECT  by PRIOR   A.ID= A.PARENT_ID
) AB
GROUP BY AB.ID,AB.PARENT_ID
)B  ON  A.ID=B.ID
WHERE  A.ORG_TYPE=0  AND     NVL(B.NODESUM,0) >0

UNION ALL
--顶级项目汇总有分期
SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,4
,B2.ID,B2.PARENT_ID,B2.PROJECT_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
  ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,/*'TYPE_PROJTOP' AS CTYPE*/CASE WHEN B3.STAGE_NAME LIKE '%无分期%' THEN 'TYPE_PROJLAST' else 'TYPE_PROJTOP' end as CTYPE
,b3."STAGEID" AS "STAGEID"
FROM(
 SELECT  B1.UNIT_ID AS PARENT_ID ,A.COMPANY_ID ,C1.PROJECT_ID AS ID,B1.PROJECT_NAME ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
,C1.PROJECT_ID
  --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"


 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='关键节点计划'
   AND A1. IS_DISABLE=0
 AND  A.APPROVAL_STATUS='已审核'
 --判断本年

 AND  A1.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||'-12'||'-26','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||'-12'||'-25','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH)
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID,A.COMPANY_ID,PROJECT_NAME ,C1.PROJECT_ID	) B2
		LEFT JOIN (SELECT P2.PROJECT_ID,TO_CHAR(wm_concat(P2.STAGE_NAME)) AS STAGE_NAME,p2.id as "STAGEID" FROM SYS_PROJECT P1 LEFT JOIN SYS_PROJECT_STAGE P2 ON P1.ID = P2.PROJECT_ID GROUP BY P2.PROJECT_ID,p2.ID) B3 ON B2.PROJECT_ID = B3.PROJECT_ID
		where        NVL(B2.NODESUM,0)>0 AND  B3.STAGE_NAME    LIKE '%无分期%'


		UNION ALL
--顶级项目汇总无分期
SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,4
,B2.ID,B2.PARENT_ID,B2.PROJECT_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
  ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,/*'TYPE_PROJTOP' AS CTYPE*/CASE WHEN B3.STAGE_NAME LIKE '%无分期%' THEN 'TYPE_PROJLAST' else 'TYPE_PROJTOP' end as CTYPE
,'' as "STAGEID"
FROM(
 SELECT  B1.UNIT_ID AS PARENT_ID  ,A.COMPANY_ID,B1.ID,B1.PROJECT_NAME ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
,C1.PROJECT_ID
  --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"


 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='关键节点计划'
   AND A1. IS_DISABLE=0
 AND  A.APPROVAL_STATUS='已审核'
	 --判断本年

 AND  A1.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||'-12'||'-26','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||'-12'||'-25','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH)
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID,A.COMPANY_ID,B1.ID,PROJECT_NAME ,C1.PROJECT_ID	) B2
		LEFT JOIN (SELECT P2.PROJECT_ID,TO_CHAR(wm_concat(P2.STAGE_NAME)) AS STAGE_NAME FROM SYS_PROJECT P1 LEFT JOIN SYS_PROJECT_STAGE P2 ON P1.ID = P2.PROJECT_ID GROUP BY P2.PROJECT_ID) B3 ON B2.PROJECT_ID = B3.PROJECT_ID
		where        NVL(B2.NODESUM,0)>0  AND  B3.STAGE_NAME not  LIKE '%无分期%'


		----分期汇总

UNION ALL
SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,5
,B2.ID,B2.PARENT_ID,B2.PROJSTAGE_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
 ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,'TYPE_PROJLAST' AS CTYPE
,B2."STAGEID"
FROM(
 SELECT  C1.PROJECT_ID AS PARENT_ID,A.COMPANY_ID  ,C1.ID,B1.PROJECT_NAME||'_'|| C1.STAGE_NAME AS  PROJSTAGE_NAME ,COUNT(A1.ID) AS "NODESUM"
  --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"
,C1.ID as "STAGEID"

 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='关键节点计划'  
   AND A1. IS_DISABLE=0
   AND  A.APPROVAL_STATUS='已审核'
	 --判断本年

 AND A1.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||'-12'||'-26','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||'-12'||'-25','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH)
		GROUP BY C1.PROJECT_ID,C1.ID,A.COMPANY_ID,PROJECT_NAME, STAGE_NAME	) B2		where        NVL(B2.NODESUM,0)>0 AND B2.PROJSTAGE_NAME NOT LIKE '%无分期%'
;

prompt
prompt Creating view V_POM_MAIN_PLAN_M_STATISTICS
prompt ==========================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_POM_MAIN_PLAN_M_STATISTICS AS
SELECT
	row_number() over( PARTITION  BY A.PARENT_ID  order by ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100,2) desc) as rank ,LEVEL_RANK,
	A.ID,A.PARENT_ID,A.ORG_NAME,'' AS "COMPANY_ID"
	,NVL(B.NODESUM,0) AS NODESUM
	,nvl(ISFINISH,0) AS  ISFINISHTOTAL
	,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
	,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
	,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
 ,NVL(ISDELAY,0) AS ISDELAY
	,ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
	,ROUND(CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
	,ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
	,'TYPE_ORG' AS CTYPE
    ,'' as "STAGEID"
FROM SYS_BUSINESS_UNIT A LEFT JOIN  (
 SELECT AB.ID,AB.PARENT_ID,SUM(AB.NODESUM) AS NODESUM,SUM(AB.ISFINISH) AS ISFINISH,SUM(AB.ISDELAY) AS ISDELAY,SUM(AB.ONTIMEFINISH) AS ONTIMEFINISH,SUM(AB.DELAYFINISH) AS DELAYFINISH,SUM(AB.ADVANCEFINISH) AS ADVANCEFINISH from  (
--  11

 SELECT    NVL(B.NODESUM,0) AS NODESUM
 ,NVL(B.ISFINISH,0) AS ISFINISH
 ,NVL(B.ONTIMEFINISH,0) AS ONTIMEFINISH
 ,NVL(B.DELAYFINISH,0) AS DELAYFINISH,ORG_NAME
 ,NVL(ADVANCEFINISH,0) AS AdvanceFINISH
  ,NVL(ISDELAY,0) AS ISDELAY
 ,ORG_NAME
 ,CONNECT_BY_ROOT ID AS  ID ,CONNECT_BY_ROOT PARENT_ID  AS  PARENT_ID
 from   SYS_BUSINESS_UNIT A  LEFT JOIN
 (
 SELECT  B1.UNIT_ID ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"


  FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='项目主项计划'
   AND A1. IS_DISABLE=0
  AND  A.APPROVAL_STATUS='已审核'
 --判断本月
 AND A1.PLAN_END_DATE  BETWEEN
  TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||'-'||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else'12' end ||'-'||'26'  FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')  AND
 TO_DATE ((SELECT    A.铁建_本年||'-'||铁建_本月||'-'||'25' FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID
	)  B ON  A.ID=B.UNIT_ID
	WHERE NVL(B.NODESUM,0)>0
CONNECT  by PRIOR   A.ID= A.PARENT_ID
) AB
GROUP BY AB.ID,AB.PARENT_ID
)B  ON  A.ID=B.ID
WHERE  A.ORG_TYPE=0  AND     NVL(B.NODESUM,0) >0

UNION ALL
--顶级项目汇总//无分期
SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,4 as  lw
,B2.ID,B2.PARENT_ID,B2.PROJECT_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
  ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,/*'TYPE_PROJTOP' AS CTYPE*/CASE WHEN B3.STAGE_NAME LIKE '%无分期%' THEN 'TYPE_PROJLAST' else 'TYPE_PROJTOP' end as CTYPE
,b3."STAGEID" AS "STAGEID"
FROM(
 SELECT  B1.UNIT_ID AS PARENT_ID ,A.COMPANY_ID ,C1.PROJECT_ID AS ID,B1.PROJECT_NAME ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
 --完成规则
 ,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"
,c1.PROJECT_ID


 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='项目主项计划'
   AND A1. IS_DISABLE=0
 AND  A.APPROVAL_STATUS='已审核'  AND A1.PLAN_END_DATE BETWEEN
  TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||'-'||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else'12' end ||'-'||'26'  FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')  AND
 TO_DATE ((SELECT    A.铁建_本年||'-'||铁建_本月||'-'||'25' FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID,A.COMPANY_ID,PROJECT_NAME,c1.PROJECT_ID 	) B2
		LEFT JOIN (SELECT P2.PROJECT_ID,TO_CHAR(wm_concat(P2.STAGE_NAME)) AS STAGE_NAME,p2.id as "STAGEID" FROM SYS_PROJECT P1 LEFT JOIN SYS_PROJECT_STAGE P2 ON P1.ID = P2.PROJECT_ID GROUP BY P2.PROJECT_ID,p2.id) B3 ON B2.PROJECT_ID = B3.PROJECT_ID
		where        NVL(B2.NODESUM,0)>0 and B3.STAGE_NAME LIKE '%无分期%'
UNION ALL
--顶级项目汇总//有分期
SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,4
,B2.ID,B2.PARENT_ID,B2.PROJECT_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
  ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,/*'TYPE_PROJTOP' AS CTYPE*/CASE WHEN B3.STAGE_NAME LIKE '%无分期%' THEN 'TYPE_PROJLAST' else 'TYPE_PROJTOP' end as CTYPE
,'' as "STAGEID"
FROM(
 SELECT  B1.UNIT_ID AS PARENT_ID ,A.COMPANY_ID ,B1.ID,B1.PROJECT_NAME ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
 --完成规则
 ,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"
,c1.PROJECT_ID


 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='项目主项计划'
   AND A1. IS_DISABLE=0
 AND  A.APPROVAL_STATUS='已审核'  AND A1.PLAN_END_DATE BETWEEN
  TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||'-'||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else'12' end ||'-'||'26'  FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')  AND
 TO_DATE ((SELECT    A.铁建_本年||'-'||铁建_本月||'-'||'25' FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID,A.COMPANY_ID,B1.ID,PROJECT_NAME,c1.PROJECT_ID 	) B2
		LEFT JOIN (SELECT P2.PROJECT_ID,TO_CHAR(wm_concat(P2.STAGE_NAME)) AS STAGE_NAME FROM SYS_PROJECT P1 LEFT JOIN SYS_PROJECT_STAGE P2 ON P1.ID = P2.PROJECT_ID GROUP BY P2.PROJECT_ID) B3 ON B2.PROJECT_ID = B3.PROJECT_ID
	where        NVL(B2.NODESUM,0)>0 and B3.STAGE_NAME NOT   LIKE '%无分期%'
		----分期汇总

UNION ALL

SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,5
,B2.ID,B2.PARENT_ID,B2.PROJSTAGE_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
  ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,'TYPE_PROJLAST' AS CTYPE
,B2."STAGEID"
FROM(
 SELECT  C1.PROJECT_ID AS PARENT_ID ,A.COMPANY_ID ,C1.ID,B1.PROJECT_NAME||'_'|| C1.STAGE_NAME AS  PROJSTAGE_NAME ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"
,C1.ID as "STAGEID"

 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='项目主项计划' 
   AND A1. IS_DISABLE=0
    AND  A.APPROVAL_STATUS='已审核'
   AND A1.PLAN_END_DATE BETWEEN
  TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||'-'||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else'12' end ||'-'||'26'  FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')  AND
 TO_DATE ((SELECT    A.铁建_本年||'-'||铁建_本月||'-'||'25' FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'--C1.PROJECT_ID
		GROUP BY  C1.PROJECT_ID,A.COMPANY_ID,C1.ID,PROJECT_NAME, STAGE_NAME	) B2		where        NVL(B2.NODESUM,0)>0 AND B2.PROJSTAGE_NAME NOT LIKE '%无分期%'
;

prompt
prompt Creating view V_POM_MAIN_PLAN_Q_STATISTICS
prompt ==========================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_POM_MAIN_PLAN_Q_STATISTICS AS
SELECT
	row_number() over( PARTITION  BY A.PARENT_ID  order by ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100,2) desc) as rank ,LEVEL_RANK,
	A.ID,A.PARENT_ID,A.ORG_NAME,'' AS COMPANY_ID
	,NVL(B.NODESUM,0) AS NODESUM
	,nvl(ISFINISH,0) AS  ISFINISHTOTAL
	,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
	,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
	,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
		,NVL(ISDELAY,0) AS ISDELAY
	,ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
	,ROUND(CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
	,ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
	,'TYPE_ORG' AS CTYPE
    ,'' as "STAGEID"
FROM SYS_BUSINESS_UNIT A LEFT JOIN  (
 SELECT AB.ID,AB.PARENT_ID,SUM(AB.NODESUM) AS NODESUM,SUM(AB.ISFINISH) AS ISFINISH,SUM(AB.ONTIMEFINISH) AS ONTIMEFINISH,SUM(AB.ISDELAY) AS ISDELAY,SUM(AB.DELAYFINISH) AS DELAYFINISH,SUM(AB.ADVANCEFINISH) AS ADVANCEFINISH from  (
--  11

 SELECT    NVL(B.NODESUM,0) AS NODESUM
 ,NVL(B.ISFINISH,0) AS ISFINISH
 ,NVL(B.ONTIMEFINISH,0) AS ONTIMEFINISH
 ,NVL(B.DELAYFINISH,0) AS DELAYFINISH,ORG_NAME
 ,NVL(ADVANCEFINISH,0) AS AdvanceFINISH
  ,NVL(ISDELAY,0) AS ISDELAY
 ,ORG_NAME
 ,CONNECT_BY_ROOT ID AS  ID ,CONNECT_BY_ROOT PARENT_ID  AS  PARENT_ID
 from   SYS_BUSINESS_UNIT A  LEFT JOIN
 (
 SELECT  B1.UNIT_ID ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"

FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
 INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
WHERE  A.PLAN_TYPE='项目主项计划' 
  AND A1. IS_DISABLE=0
AND  A.APPROVAL_STATUS='已审核'
 --判断季度
 AND TO_CHAR(A1.PLAN_END_DATE,'YYYY-MM-DD') BETWEEN
 (	SELECT A.开始年度||'-'||A.开始月份||'-26'   FROM V_POM_GETEXAMINE_QUARTER A)  AND
 (	SELECT A.结束年度||'-'||A.结束月份||'-25' FROM V_POM_GETEXAMINE_QUARTER A)
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID
	)  B ON  A.ID=B.UNIT_ID
	WHERE NVL(B.NODESUM,0)>0
CONNECT  by PRIOR   A.ID= A.PARENT_ID
) AB
GROUP BY AB.ID,AB.PARENT_ID
)B  ON  A.ID=B.ID
WHERE  A.ORG_TYPE=0  AND     NVL(B.NODESUM,0) >0

UNION ALL
--顶级项目汇总有分期
SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,4
,B2.ID,B2.PARENT_ID,B2.PROJECT_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
  ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,/*'TYPE_PROJTOP' AS CTYPE*/CASE WHEN B3.STAGE_NAME LIKE '%无分期%' THEN 'TYPE_PROJLAST' else 'TYPE_PROJTOP' end as CTYPE
,b3."STAGEID" AS "STAGEID"
FROM(
 SELECT  B1.UNIT_ID AS PARENT_ID ,A.COMPANY_ID ,C1.PROJECT_ID AS ID,B1.PROJECT_NAME ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
,C1.PROJECT_ID
  --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"


 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='项目主项计划'
   AND A1. IS_DISABLE=0
 AND  A.APPROVAL_STATUS='已审核'  AND TO_CHAR(A1.PLAN_END_DATE,'YYYY-MM-DD')
 BETWEEN
(	SELECT A.开始年度||'-'||A.开始月份||'-26'   FROM V_POM_GETEXAMINE_QUARTER A)  AND
 (	SELECT A.结束年度||'-'||A.结束月份||'-25' FROM V_POM_GETEXAMINE_QUARTER A)
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID,A.COMPANY_ID ,PROJECT_NAME ,C1.PROJECT_ID	) B2
		LEFT JOIN (SELECT P2.PROJECT_ID,TO_CHAR(wm_concat(P2.STAGE_NAME)) AS STAGE_NAME,p2.id as "STAGEID" FROM SYS_PROJECT P1 LEFT JOIN SYS_PROJECT_STAGE P2 ON P1.ID = P2.PROJECT_ID GROUP BY P2.PROJECT_ID,p2.id) B3 ON B2.PROJECT_ID = B3.PROJECT_ID
		where        NVL(B2.NODESUM,0)>0 AND  B3.STAGE_NAME    LIKE '%无分期%'


		UNION ALL
--顶级项目汇总无分期
SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,4
,B2.ID,B2.PARENT_ID,B2.PROJECT_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
  ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,/*'TYPE_PROJTOP' AS CTYPE*/CASE WHEN B3.STAGE_NAME LIKE '%无分期%' THEN 'TYPE_PROJLAST' else 'TYPE_PROJTOP' end as CTYPE
,'' as "STAGEID"
FROM(
 SELECT  B1.UNIT_ID AS PARENT_ID  ,A.COMPANY_ID,B1.ID,B1.PROJECT_NAME ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
,C1.PROJECT_ID
  --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"


 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='项目主项计划'
   AND A1. IS_DISABLE=0
 AND  A.APPROVAL_STATUS='已审核'  AND TO_CHAR(A1.PLAN_END_DATE,'YYYY-MM-DD')
 BETWEEN
(	SELECT A.开始年度||'-'||A.开始月份||'-26'   FROM V_POM_GETEXAMINE_QUARTER A)  AND
 (	SELECT A.结束年度||'-'||A.结束月份||'-25' FROM V_POM_GETEXAMINE_QUARTER A)
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID,A.COMPANY_ID,B1.ID,PROJECT_NAME ,C1.PROJECT_ID	) B2
		LEFT JOIN (SELECT P2.PROJECT_ID,TO_CHAR(wm_concat(P2.STAGE_NAME)) AS STAGE_NAME FROM SYS_PROJECT P1 LEFT JOIN SYS_PROJECT_STAGE P2 ON P1.ID = P2.PROJECT_ID GROUP BY P2.PROJECT_ID) B3 ON B2.PROJECT_ID = B3.PROJECT_ID
		where        NVL(B2.NODESUM,0)>0  AND  B3.STAGE_NAME not  LIKE '%无分期%'


		----分期汇总

UNION ALL
SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,5
,B2.ID,B2.PARENT_ID,B2.PROJSTAGE_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
 ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,'TYPE_PROJLAST' AS CTYPE
,B2."STAGEID"
FROM(
 SELECT  C1.PROJECT_ID AS PARENT_ID,A.COMPANY_ID  ,C1.ID,B1.PROJECT_NAME||'_'|| C1.STAGE_NAME AS  PROJSTAGE_NAME ,COUNT(A1.ID) AS "NODESUM"
  --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"
,C1.ID as "STAGEID"

 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='项目主项计划' 
   AND A1. IS_DISABLE=0
    AND  A.APPROVAL_STATUS='已审核'
   AND TO_CHAR(A1.PLAN_END_DATE,'YYYY-MM-DD') BETWEEN (	SELECT A.开始年度||'-'||A.开始月份||'-26'   FROM V_POM_GETEXAMINE_QUARTER A)  AND
 (	SELECT A.结束年度||'-'||A.结束月份||'-25' FROM V_POM_GETEXAMINE_QUARTER A)
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY C1.PROJECT_ID,C1.ID,A.COMPANY_ID,PROJECT_NAME, STAGE_NAME	) B2		where        NVL(B2.NODESUM,0)>0 AND B2.PROJSTAGE_NAME NOT LIKE '%无分期%'
;

prompt
prompt Creating view V_POM_MAIN_PLAN_Y_STATISTICS
prompt ==========================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_POM_MAIN_PLAN_Y_STATISTICS AS
SELECT
	row_number() over( PARTITION  BY A.PARENT_ID  order by ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100,2) desc) as rank ,LEVEL_RANK,
	A.ID,A.PARENT_ID,A.ORG_NAME,'' AS COMPANY_ID
	,NVL(B.NODESUM,0) AS NODESUM
	,nvl(ISFINISH,0) AS  ISFINISHTOTAL
	,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
	,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
	,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
		,NVL(ISDELAY,0) AS ISDELAY
	,ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
	,ROUND(CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
	,ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
	,'TYPE_ORG' AS CTYPE
    ,'' as "STAGEID"
FROM SYS_BUSINESS_UNIT A LEFT JOIN  (
 SELECT AB.ID,AB.PARENT_ID,SUM(AB.NODESUM) AS NODESUM,SUM(AB.ISFINISH) AS ISFINISH,SUM(AB.ONTIMEFINISH) AS ONTIMEFINISH,SUM(AB.ISDELAY) AS ISDELAY,SUM(AB.DELAYFINISH) AS DELAYFINISH,SUM(AB.ADVANCEFINISH) AS ADVANCEFINISH from  (
--  11

 SELECT    NVL(B.NODESUM,0) AS NODESUM
 ,NVL(B.ISFINISH,0) AS ISFINISH
 ,NVL(B.ONTIMEFINISH,0) AS ONTIMEFINISH
 ,NVL(B.DELAYFINISH,0) AS DELAYFINISH,ORG_NAME
 ,NVL(ADVANCEFINISH,0) AS AdvanceFINISH
  ,NVL(ISDELAY,0) AS ISDELAY
 ,ORG_NAME
 ,CONNECT_BY_ROOT ID AS  ID ,CONNECT_BY_ROOT PARENT_ID  AS  PARENT_ID
 from   SYS_BUSINESS_UNIT A  LEFT JOIN
 (
 SELECT  B1.UNIT_ID ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"

FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
 INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
WHERE  A.PLAN_TYPE='项目主项计划'
  AND A1. IS_DISABLE=0
 AND  A.APPROVAL_STATUS='已审核'
	 --判断本年
 -- A1.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||'-12'||'-26','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||'-12'||'-25','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH)
 AND  A1.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||'-12'||'-26','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||'-12'||'-25','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH)
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID
	)  B ON  A.ID=B.UNIT_ID
	WHERE NVL(B.NODESUM,0)>0
CONNECT  by PRIOR   A.ID= A.PARENT_ID
) AB
GROUP BY AB.ID,AB.PARENT_ID
)B  ON  A.ID=B.ID
WHERE  A.ORG_TYPE=0  AND     NVL(B.NODESUM,0) >0

UNION ALL
--顶级项目汇总有分期
SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,4
,B2.ID,B2.PARENT_ID,B2.PROJECT_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
  ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,/*'TYPE_PROJTOP' AS CTYPE*/CASE WHEN B3.STAGE_NAME LIKE '%无分期%' THEN 'TYPE_PROJLAST' else 'TYPE_PROJTOP' end as CTYPE
,b3."STAGEID" AS "STAGEID"
FROM(
 SELECT  B1.UNIT_ID AS PARENT_ID ,A.COMPANY_ID ,C1.PROJECT_ID AS ID,B1.PROJECT_NAME ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
,C1.PROJECT_ID
  --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"


 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='项目主项计划'
   AND A1. IS_DISABLE=0
 AND  A.APPROVAL_STATUS='已审核'
 --判断本年

 AND  A1.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||'-12'||'-26','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||'-12'||'-25','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH)
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID,A.COMPANY_ID,PROJECT_NAME ,C1.PROJECT_ID	) B2
		LEFT JOIN (SELECT P2.PROJECT_ID,TO_CHAR(wm_concat(P2.STAGE_NAME)) AS STAGE_NAME,p2.id as "STAGEID" FROM SYS_PROJECT P1 LEFT JOIN SYS_PROJECT_STAGE P2 ON P1.ID = P2.PROJECT_ID GROUP BY P2.PROJECT_ID,p2.id) B3 ON B2.PROJECT_ID = B3.PROJECT_ID
		where        NVL(B2.NODESUM,0)>0 AND  B3.STAGE_NAME    LIKE '%无分期%'


		UNION ALL
--顶级项目汇总无分期
SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,4
,B2.ID,B2.PARENT_ID,B2.PROJECT_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
  ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,/*'TYPE_PROJTOP' AS CTYPE*/CASE WHEN B3.STAGE_NAME LIKE '%无分期%' THEN 'TYPE_PROJLAST' else 'TYPE_PROJTOP' end as CTYPE
,'' as "STAGEID"
FROM(
 SELECT  B1.UNIT_ID AS PARENT_ID  ,A.COMPANY_ID,B1.ID,B1.PROJECT_NAME ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
,C1.PROJECT_ID
  --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"


 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='项目主项计划'
   AND A1. IS_DISABLE=0
 AND  A.APPROVAL_STATUS='已审核'
	 --判断本年

 AND  A1.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||'-12'||'-26','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||'-12'||'-25','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH)
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID,A.COMPANY_ID,B1.ID,PROJECT_NAME ,C1.PROJECT_ID	) B2
		LEFT JOIN (SELECT P2.PROJECT_ID,TO_CHAR(wm_concat(P2.STAGE_NAME)) AS STAGE_NAME FROM SYS_PROJECT P1 LEFT JOIN SYS_PROJECT_STAGE P2 ON P1.ID = P2.PROJECT_ID GROUP BY P2.PROJECT_ID) B3 ON B2.PROJECT_ID = B3.PROJECT_ID
		where        NVL(B2.NODESUM,0)>0  AND  B3.STAGE_NAME not  LIKE '%无分期%'


		----分期汇总

UNION ALL
SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,5
,B2.ID,B2.PARENT_ID,B2.PROJSTAGE_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
 ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,'TYPE_PROJLAST' AS CTYPE
,B2."STAGEID"
FROM(
 SELECT  C1.PROJECT_ID AS PARENT_ID,A.COMPANY_ID  ,C1.ID,B1.PROJECT_NAME||'_'|| C1.STAGE_NAME AS  PROJSTAGE_NAME ,COUNT(A1.ID) AS "NODESUM"
  --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"
,C1.ID as "STAGEID"

 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='项目主项计划'  
   AND A1. IS_DISABLE=0
   AND  A.APPROVAL_STATUS='已审核'
	 --判断本年

 AND A1.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||'-12'||'-26','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||'-12'||'-25','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH)
		GROUP BY C1.PROJECT_ID,C1.ID,A.COMPANY_ID,PROJECT_NAME, STAGE_NAME	) B2		where        NVL(B2.NODESUM,0)>0 AND B2.PROJSTAGE_NAME NOT LIKE '%无分期%'
;

prompt
prompt Creating function FN_POM_EXAMINATION_DAY
prompt ========================================
prompt
CREATE OR REPLACE FUNCTION POM0813."FN_POM_EXAMINATION_DAY" RETURN VARCHAR2
AS
BEGIN
	--计划的考核日--
	RETURN 1 ;
END;
/

prompt
prompt Creating view V_POM_MONTH_QUARTER_YEAR
prompt ======================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_POM_MONTH_QUARTER_YEAR AS
with examination_day as (SELECT
         fn_pom_examination_day() - 1 as examination_day    FROM        dual)
 --当前--月考核结束日期
,now_m_end as (SELECT  trunc(SYSDATE, 'month') + examination_day- numtodsinterval(1/1000,'second') as d FROM examination_day) 
 --当前--月考核结束日期
,now_quarter_end as (SELECT  add_months(trunc(SYSDATE, 'Q'), 2) + examination_day- numtodsinterval(1/1000,'second')  as d   FROM  examination_day)       
 --当前--月考核结束日期
,now_year_end as (SELECT add_months(trunc(SYSDATE, 'yyyy'), 11) + examination_day- numtodsinterval(1/1000,'second')  as d   FROM  examination_day)
 --下一个--月考核结束日期
,next_m_end as (select add_months(d,1) as nd from now_m_end )
 --下一个--季考核结束日期
,next_quarter_end as (SELECT add_months(d, 3)  as nd  FROM  now_quarter_end)
 --下一个--年考核结束日期
,next_year_end as (SELECT add_months(d, 12)  as nd  FROM   now_year_end)

---合并将结束时间合并到一起
,o_all_end as (select m.d as md,nm.nd as nmd
,q.d as qd,nq.nd as nqd
,y.d as yd ,ny.nd  as nyd
from 
(select * from now_m_end) m
 cross join
(select * from next_m_end ) nm
 cross join
(select * from now_quarter_end ) q
 cross join
(select * from next_quarter_end ) nq
 cross join
(select * from now_year_end ) y
 cross join
(select * from next_year_end ) ny
)
,计算结束时间 as (select 
case when SYSDATE < md then md else  nmd end as m_end
,case when SYSDATE < qd then qd else  nqd end as quarter_end
,case when SYSDATE < yd then yd else  nyd end as year_end
from o_all_end)
,年季月 as (
select 计算结束时间.*
,add_months(m_end, -1) as m_begin
,add_months(quarter_end, -3) as quarter_begin
,add_months(year_end, -12) as year_begin from 计算结束时间)

select "M_END","QUARTER_END","YEAR_END","M_BEGIN","QUARTER_BEGIN","YEAR_BEGIN" from 年季月
;

prompt
prompt Creating function SPLIT
prompt =======================
prompt
CREATE OR REPLACE FUNCTION POM0813.split (p_list CLOB, p_sep VARCHAR2 := ',')
RETURN tabletype 
PIPELINED 
/************************************** 
* Function: 返回字符串被指定字符分割后的表类型。 
* Parameters: p_list: 待分割的字符串。 
p_sep: 分隔符，默认逗号，也可以指定字符或字符串。 
* Example: SELECT * 
FROM users 
WHERE u_id IN (SELECT COLUMN_VALUE 
FROM table (split ('1,2'))) 
返回u_id为1和2的两行数据。 
**************************************/ 
IS 
l_idx PLS_INTEGER; 
v_list VARCHAR2 (32676) := p_list; 
BEGIN 
LOOP 
l_idx := INSTR (v_list, p_sep); 
IF l_idx > 0 
THEN 
PIPE ROW (SUBSTR (v_list, 1, l_idx - 1)); 
v_list := SUBSTR (v_list, l_idx + LENGTH (p_sep)); 
ELSE 
PIPE ROW (v_list); 
EXIT; 
END IF; 
END LOOP; 
END;
/

prompt
prompt Creating view V_POM_MONTH_QUARTER_YEARS
prompt =======================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_POM_MONTH_QUARTER_YEARS AS
with examination_day as (SELECT
         fn_pom_examination_day()-1 as e_day
         ,TO_DATE(''||to_char(SYSDATE, 'yyyy' )||'-'||to_char(SYSDATE, 'MM' )||'-01','YYYY-MM-DD')  as cmday  
         FROM dual)
 --当前--月考核结束日期
,base as (
SELECT  trunc(cmday, 'month') + e_day as m_end
,add_months(trunc(cmday, 'Q'), 3) + e_day as quarter_end
,add_months(trunc(cmday, 'yyyy'), 12) + e_day as year_end
,cmday
FROM examination_day) 

,年季月 as (
select base.*
,add_months(m_end, -1) as m_begin
,add_months(quarter_end, -3) as quarter_begin
,add_months(year_end, -12) as year_begin
,to_char(add_months(m_end, -1), 'MM' ) as base_mm
,to_char(add_months(m_end, -1), 'yyyy' ) as base_yyyy
from base)

,mms as(SELECT column_value+0 mm   FROM TABLE ( split('1,2,3,4,5,6,7,8,9,10,11,12') ))

,近5年季月 as(
select  年季月.*,mms.*,yyyys.*,e_day
,months_between(TO_DATE(''||yyyy||'-'||mm||'-01','yyyy-mm-dd'),TO_DATE(''||base_yyyy||'-'||base_mm||'-01','yyyy-mm-dd')) as 月份差 
from 年季月
cross join  
(select to_char(SYSDATE, 'yyyy')-1 as yyyy from dual
union all
select to_char(SYSDATE, 'yyyy' )-2 as yyyy from dual
union all
select to_char(SYSDATE, 'yyyy' )-3 as yyyy from dual
union all
select to_char(SYSDATE, 'yyyy' )-4 as yyyy from dual
union all
select to_char(SYSDATE, 'yyyy' )-0 as yyyy from dual) yyyys
cross join  mms
cross join examination_day
)

select 
--近5年季月.cmday,
yyyy,mm,to_char(add_months(add_months(m_end, 月份差), -1), 'Q' ) as Q
,add_months(m_begin, 月份差)-numtodsinterval(1/1000, 'SECOND') as m_begin
,add_months(m_end, 月份差)-numtodsinterval(1/1000, 'SECOND') as m_end
,trunc(add_months(m_begin, 月份差), 'Q')+e_day-numtodsinterval(1/1000, 'SECOND') as quarter_begin
,add_months(trunc(add_months(m_begin, 月份差), 'Q'), 3)+e_day-numtodsinterval(1/1000, 'SECOND') as quarter_end

,trunc(add_months(m_begin, 月份差), 'yyyy')+e_day-numtodsinterval(1/1000, 'SECOND') as year_begin
,add_months(trunc(add_months(m_begin, 月份差), 'yyyy'), 12)+e_day-numtodsinterval(1/1000, 'SECOND') as year_end
 from 近5年季月 order by yyyy,mm
;

prompt
prompt Creating view V_POM_NODE_DT
prompt ===========================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_POM_NODE_DT AS
SELECT
-- 黄伟2020-01-09创建：展示“已审核的计划”的所有未禁用节点的动态情况；涉及到节点的统计、当前状态、预警等都应尽可能从这里取数。
  row_number() OVER(ORDER BY b.Plan_Type,c.order_hierarchy_code,b.proj_name,a.node_code) AS RowCode
  ,b.plan_type AS PlAN_Type -- 计划类别
  ,b.plan_name AS Plan_Name -- 计划名称
  ,b.proj_name AS Proj_Name -- 所属项目
  ,a.node_code AS Node_Code -- 节点编号
  ,a.node_name AS Node_Name -- 节点名称
  ,a.plan_start_date AS plan_start_date -- 计划开始日期
  ,a.plan_end_date AS plan_end_date -- 计划完成日期
  ,(CASE WHEN a.actual_end_date IS NOT NULL THEN '已完成' ELSE '未完成' END) AS Finish_Status -- 节点完成状态
  ,(CASE WHEN a.actual_end_date IS NOT NULL THEN ''
         WHEN a.actual_end_date IS NULL AND TRUNC(SYSDATE)-TRUNC(a.plan_end_date)>0 THEN '超期未完成'
         WHEN a.actual_end_date IS NULL AND TRUNC(SYSDATE)-TRUNC(a.plan_end_date)=0 THEN '今天到期'
         ELSE '未到期' END) AS Finish_NO_Status_Type -- 未完成细分类别
  ,(CASE WHEN a.actual_end_date IS NULL THEN ''
         WHEN a.actual_end_date IS NOT NULL AND TRUNC(actual_end_date)-TRUNC(a.plan_end_date)>0 THEN '超期完成'
         WHEN a.actual_end_date IS NOT NULL AND TRUNC(actual_end_date)-TRUNC(a.plan_end_date)=0 THEN '按时完成'
         WHEN a.actual_end_date IS NOT NULL AND TRUNC(actual_end_date)-TRUNC(a.plan_end_date)<0 THEN '提前完成'
         ELSE '未知' END) AS Finish_YES_Status_Type -- 已完成细分类别
  ,a.actual_start_date -- 实际开始日期
  ,a.actual_end_date -- 实际完成日期
  ,(CASE WHEN a.actual_end_date IS NOT NULL THEN ''
         WHEN a.actual_end_date IS NULL AND TRUNC(a.estimate_end_date)-TRUNC(a.plan_end_date)>0 THEN '预计超期'
         WHEN a.actual_end_date IS NULL AND TRUNC(a.estimate_end_date)-TRUNC(a.plan_end_date)=0 THEN '预计按时'
         WHEN a.actual_end_date IS NULL AND TRUNC(a.estimate_end_date)-TRUNC(a.plan_end_date)=0 THEN '预计提前'
         ELSE '无预测' END) AS Estimate_Status -- 预测状态
  ,a.estimate_start_date, -- 预计开始日期
   a.estimate_end_date, -- 预计完成日期

  a.id,-- 节点ID
   a.proj_plan_id, -- 计划ID
   a.template_node_id, -- 使用模板节点ID
   a.standard_node_id, -- 标准节点ID
   a.node_grade, -- 节点等级(集团级、区域级）
   a.node_level, -- 任务级别（里程碑、一级节点、二级节点、三级节点）
   a.proj_stage, -- 项目阶段
   a.main_responsibility, -- 主责职能
   a.control_type, -- 控制类型
   a.duty_department_id, -- 主责部门ID
   a.duty_department, -- 主责部门
   a.is_disable, -- 是否禁用
   a.disable_time, -- 禁用时间
   a.disable_reason_id, -- 禁用原因ID
   a.standard_score, -- 标准分值
   a.reference_date_node_id, --
   a.reference_day, -- 参考天数
   a.precondition_remark, -- 前置条件说明
   a.is_contains_permit, -- 是否证照节点
   a.permit_type, -- 证照类型
   a.completion_standard, -- 完成标准说明
   a.completion_results_remark, -- 完成成果说明
   a.input_condition, -- 输入条件
   a.other_remark, --  其他备注说明
   a.created, -- 创建时间
   a.creator_id, -- 创建人ID
   a.creator, -- 创建人
   a.modified, -- 修改时间
   a.modifier_id, -- 修改改人ID
   a.modifier, -- 修改人
   a.plan_version, -- 计划版本
   a.is_delete, -- 是否删除
   a.disable_reason, -- 禁用原因
   a.feedback_id, -- 反馈ID
   a.company_name, -- 公司名称
   a.company_id, -- 公司ID
	 a.ORIGINAL_NODE_ID --节点原始ID
FROM pom_proj_plan_node a
LEFT JOIN pom_proj_plan b ON a.proj_plan_id=b.id AND b.approval_status IN ('已审核')
LEFT JOIN Sys_Project c ON b.proj_id=c.id
WHERE b.id IS NOT NULL
--AND b.id='1dccd70b-b294-4424-acca-ca4ea49e1a33'
--AND b.plan_type='关键节点计划'
AND a.is_disable=0
-- ORDER BY b.proj_name,a.node_code
;

prompt
prompt Creating view V_POM_PJMAINPLANRANK
prompt ==================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_POM_PJMAINPLANRANK AS
SELECT ROW_NUMBER() OVER(PARTITION BY A.PARENT_ID ORDER BY ROUND(CASE
					 WHEN NVL(B.本年应完成,
										0) > 0 THEN
						NVL(本年已完成,
								0) /
						NVL(B.本年应完成,
								0)
					 ELSE
						0
			 END * 100, 2) DESC) AS RANK, A.ID, A.PARENT_ID, A.ORG_NAME,
			 NVL(B.本年应完成, 0) AS 本年应完成, NVL(B.本年已完成, 0) AS 本年已完成,
			 NVL(B.本季度应完成, 0) AS 本季度应完成, NVL(B.本季度已完成, 0) AS 本季度已完成,
			 NVL(B.本月应完成, 0) AS 本月应完成, NVL(B.本月已完成, 0) AS 本月已完成
			 /*动态得分情况*/, NVL(B.本月动态得分, 0) AS 本月动态得分, NVL(B.本季度动态得分, 0) AS 本季度动态得分
			 /*里程碑、一级节点完成情况*/, NVL(B.本月里程碑应完成, 0) AS 本月里程碑应完成,
			 NVL(B.本月里程碑已完成, 0) AS 本月里程碑已完成, NVL(B.本月一级节点应完成, 0) AS 本月一级节点应完成,
			 NVL(B.本月一级节点已完成, 0) AS 本月一级节点已完成, NVL(B.本季度里程碑应完成, 0) AS 本季度里程碑应完成,
			 NVL(B.本季度里程碑已完成, 0) AS 本季度里程碑已完成, NVL(B.本季度一级节点应完成, 0) AS 本季度一级节点应完成,
			 NVL(B.本季度一级节点已完成, 0) AS 本季度一级节点已完成
			 /*亮点情况*/, NVL(B.本月里程碑绿灯, 0) AS 本月里程碑绿灯, NVL(B.本月里程碑黄灯, 0) AS 本月里程碑黄灯,
			 NVL(B.本月里程碑红灯, 0) AS 本月里程碑红灯, NVL(B.本月一级节点绿灯, 0) AS 本月一级节点绿灯,
			 NVL(B.本月一级节点黄灯, 0) AS 本月一级节点黄灯, NVL(B.本月一级节点红灯, 0) AS 本月一级节点红灯,
			 NVL(B.本月二三级节点绿灯, 0) AS 本月二三级节点绿灯, NVL(B.本月二三级节点黄灯, 0) AS 本月二三级节点黄灯,
			 NVL(B.本月二三级节点红灯, 0) AS 本月二三级节点红灯, NVL(B.本季度里程碑绿灯, 0) AS 本季度里程碑绿灯,
			 NVL(B.本季度里程碑黄灯, 0) AS 本季度里程碑黄灯, NVL(B.本季度里程碑红灯, 0) AS 本季度里程碑红灯,
			 NVL(B.本季度一级节点绿灯, 0) AS 本季度一级节点绿灯, NVL(B.本季度一级节点黄灯, 0) AS 本季度一级节点黄灯,
			 NVL(B.本季度一级节点红灯, 0) AS 本季度一级节点红灯, NVL(B.本季度二三级节点绿灯, 0) AS 本季度二三级节点绿灯,
			 NVL(B.本季度二三级节点黄灯, 0) AS 本季度二三级节点黄灯,
			 NVL(B.本季度二三级节点红灯, 0) AS 本季度二三级节点红灯

			, 'TYPE_ORG' AS CTYPE
FROM   SYS_BUSINESS_UNIT A
LEFT   JOIN (SELECT AB.ID, AB.PARENT_ID, SUM(AB.本年应完成) AS 本年应完成,
										SUM(AB.本年已完成) AS 本年已完成, SUM(AB.本季度应完成) AS 本季度应完成,
										SUM(AB.本季度已完成) AS 本季度已完成, SUM(AB.本月应完成) AS 本月应完成,
										SUM(AB.本月已完成) AS 本月已完成
										/*动态得分情况*/, SUM(AB.本月动态得分) AS 本月动态得分,
										SUM(AB.本季度动态得分) AS 本季度动态得分
										/*里程碑、一级节点完成情况*/, SUM(AB.本月里程碑应完成) AS 本月里程碑应完成,
										SUM(AB.本月里程碑已完成) AS 本月里程碑已完成,
										SUM(AB.本月一级节点应完成) AS 本月一级节点应完成,
										SUM(AB.本月一级节点已完成) AS 本月一级节点已完成,
										SUM(AB.本季度里程碑应完成) AS 本季度里程碑应完成,
										SUM(AB.本季度里程碑已完成) AS 本季度里程碑已完成,
										SUM(AB.本季度一级节点应完成) AS 本季度一级节点应完成,
										SUM(AB.本季度一级节点已完成) AS 本季度一级节点已完成
										/*亮点情况*/, SUM(AB.本月里程碑绿灯) AS 本月里程碑绿灯,
										SUM(AB.本月里程碑黄灯) AS 本月里程碑黄灯, SUM(AB.本月里程碑红灯) AS 本月里程碑红灯,
										SUM(AB.本月一级节点绿灯) AS 本月一级节点绿灯,
										SUM(AB.本月一级节点黄灯) AS 本月一级节点黄灯,
										SUM(AB.本月一级节点红灯) AS 本月一级节点红灯,
										SUM(AB.本月二三级节点绿灯) AS 本月二三级节点绿灯,
										SUM(AB.本月二三级节点黄灯) AS 本月二三级节点黄灯,
										SUM(AB.本月二三级节点红灯) AS 本月二三级节点红灯,
										SUM(AB.本季度里程碑绿灯) AS 本季度里程碑绿灯,
										SUM(AB.本季度里程碑黄灯) AS 本季度里程碑黄灯,
										SUM(AB.本季度里程碑红灯) AS 本季度里程碑红灯,
										SUM(AB.本季度一级节点绿灯) AS 本季度一级节点绿灯,
										SUM(AB.本季度一级节点黄灯) AS 本季度一级节点黄灯,
										SUM(AB.本季度一级节点红灯) AS 本季度一级节点红灯,
										SUM(AB.本季度二三级节点绿灯) AS 本季度二三级节点绿灯,
										SUM(AB.本季度二三级节点黄灯) AS 本季度二三级节点黄灯,
										SUM(AB.本季度二三级节点红灯) AS 本季度二三级节点红灯
						 FROM   (
											--  11

											SELECT
											/*完成情况*/
											 NVL(B.本年应完成, 0) AS 本年应完成, NVL(B.本年已完成, 0) AS 本年已完成,
												NVL(B.本季度应完成, 0) AS 本季度应完成, NVL(B.本季度已完成, 0) AS 本季度已完成,
												NVL(B.本月应完成, 0) AS 本月应完成, NVL(B.本月已完成, 0) AS 本月已完成
												/*动态得分情况*/, NVL(B.本月动态得分, 0) AS 本月动态得分,
												NVL(B.本季度动态得分, 0) AS 本季度动态得分
												/*里程碑、一级节点完成情况*/, NVL(B.本月里程碑应完成, 0) AS 本月里程碑应完成,
												NVL(B.本月里程碑已完成, 0) AS 本月里程碑已完成,
												NVL(B.本月一级节点应完成, 0) AS 本月一级节点应完成,
												NVL(B.本月一级节点已完成, 0) AS 本月一级节点已完成,
												NVL(B.本季度里程碑应完成, 0) AS 本季度里程碑应完成,
												NVL(B.本季度里程碑已完成, 0) AS 本季度里程碑已完成,
												NVL(B.本季度一级节点应完成, 0) AS 本季度一级节点应完成,
												NVL(B.本季度一级节点已完成, 0) AS 本季度一级节点已完成
												/*亮点情况*/, NVL(B.本月里程碑绿灯, 0) AS 本月里程碑绿灯,
												NVL(B.本月里程碑黄灯, 0) AS 本月里程碑黄灯,
												NVL(B.本月里程碑红灯, 0) AS 本月里程碑红灯,
												NVL(B.本月一级节点绿灯, 0) AS 本月一级节点绿灯,
												NVL(B.本月一级节点黄灯, 0) AS 本月一级节点黄灯,
												NVL(B.本月一级节点红灯, 0) AS 本月一级节点红灯,
												NVL(B.本月二三级节点绿灯, 0) AS 本月二三级节点绿灯,
												NVL(B.本月二三级节点黄灯, 0) AS 本月二三级节点黄灯,
												NVL(B.本月二三级节点红灯, 0) AS 本月二三级节点红灯,
												NVL(B.本季度里程碑绿灯, 0) AS 本季度里程碑绿灯,
												NVL(B.本季度里程碑黄灯, 0) AS 本季度里程碑黄灯,
												NVL(B.本季度里程碑红灯, 0) AS 本季度里程碑红灯,
												NVL(B.本季度一级节点绿灯, 0) AS 本季度一级节点绿灯,
												NVL(B.本季度一级节点黄灯, 0) AS 本季度一级节点黄灯,
												NVL(B.本季度一级节点红灯, 0) AS 本季度一级节点红灯,
												NVL(B.本季度二三级节点绿灯, 0) AS 本季度二三级节点绿灯,
												NVL(B.本季度二三级节点黄灯, 0) AS 本季度二三级节点黄灯,
												NVL(B.本季度二三级节点红灯, 0) AS 本季度二三级节点红灯,
												CONNECT_BY_ROOT ID AS ID,
												CONNECT_BY_ROOT PARENT_ID AS PARENT_ID
											FROM   SYS_BUSINESS_UNIT A
											LEFT   JOIN (

																	 SELECT B1.UNIT_ID, COUNT(A1.ID) AS "NODESUM",
																					 SUM(STANDARD_SCORE) AS "SUMNODESCORE"
																					 --完成规则

																					 ------------------
																					 /*本年任务*/
																					 ------------------
																					 ------
																					 ,
																					 SUM(CASE
																									 WHEN TO_CHAR(A1.PLAN_END_DATE, 'YYYY') =
																												TO_CHAR(SYSDATE, 'YYYY') THEN
																										1
																									 ELSE
																										0
																							 END

																							 ) AS "本年应完成",
																					 SUM((CASE
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本年
																												AND
																												TO_CHAR(A1.PLAN_END_DATE, 'YYYY') =
																												TO_CHAR(SYSDATE, 'YYYY')
																									 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																										THEN
																										1
																									 ELSE
																										0
																							 END)) AS "本年已完成"

																					 ------------------
																					 /*本月任务*/
																					 ------------------
																					 ------
																					 ,
																					 SUM((CASE
																									 WHEN TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A) THEN
																										1
																									 ELSE
																										0
																							 END)) AS "本月应完成",
																					 SUM((CASE
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本月
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A)
																									 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																										THEN
																										1
																									 ELSE
																										0
																							 END)) AS "本月已完成"

																					 ,
																					 SUM((CASE
																							 --按时完成
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本月
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(A1.PLAN_END_DATE, 'DD') -
																												 TRUNC(D.APPROVAL_TIME, 'DD')) BETWEEN 0 AND 29 THEN
																										A1.STANDARD_SCORE * 1
																							 --提前一个月完成
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL --判断本月
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(A1.PLAN_END_DATE, 'DD') -
																												 TRUNC(D.APPROVAL_TIME, 'DD')) >= 30 AND
																												A1.NODE_LEVEL = '里程碑' THEN
																										A1.STANDARD_SCORE * 1.2
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本月
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(A1.PLAN_END_DATE, 'DD') -
																												 TRUNC(D.APPROVAL_TIME, 'DD')) >= 30 AND
																												A1.NODE_LEVEL = '一级节点' THEN
																										A1.STANDARD_SCORE * 1.1
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本月
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'

																												AND
																												(TRUNC(A1.PLAN_END_DATE, 'DD') -
																												 TRUNC(D.APPROVAL_TIME, 'DD')) >= 30 AND
																												A1.NODE_LEVEL IN
																												('二级节点', '三级节点') THEN
																										A1.STANDARD_SCORE * 1.0
																							 --延时完成
																							 --里程碑、一级节点3天
																							 --二三级节点5天
																							 --延时完成
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本月
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'

																												AND
																												(TRUNC(D.APPROVAL_TIME, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																												A1.NODE_LEVEL IN
																												('里程碑', '一级节点') THEN
																										A1.STANDARD_SCORE * 0.6
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本月
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'

																												AND
																												(TRUNC(D.APPROVAL_TIME, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 3 AND
																												A1.NODE_LEVEL IN
																												('二级节点', '三级节点') THEN
																										A1.STANDARD_SCORE * 1.0
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本月
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(D.APPROVAL_TIME, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 4 AND 7 AND
																												A1.NODE_LEVEL IN
																												('二级节点', '三级节点') THEN
																										A1.STANDARD_SCORE * 0.6
																							 --红灯
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本月
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'

																												AND
																												(TRUNC(D.APPROVAL_TIME, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																												A1.NODE_LEVEL IN
																												('里程碑', '一级节点') THEN
																										A1.STANDARD_SCORE * 0
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本月
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'

																												AND
																												(TRUNC(D.APPROVAL_TIME, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) >= 8 AND
																												A1.NODE_LEVEL IN
																												('二级节点', '三级节点') THEN
																										A1.STANDARD_SCORE * 0
																									 ELSE
																										0
																							 END)) AS "本月动态得分"

																					 ------------------
																					 /*-里程碑完成情况*/
																					 ------------------
																					 ,
																					 SUM((CASE
																									 WHEN A1.
																										NODE_LEVEL = '里程碑' AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A) THEN
																										1
																									 ELSE
																										0
																							 END)) AS "本月里程碑应完成",
																					 SUM((CASE
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL AND A1.
																										NODE_LEVEL = '里程碑' AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A) THEN
																										1
																									 ELSE
																										0
																							 END)) AS "本月里程碑已完成"
																					 ------------------
																					 /*-一级节点完成情况*/
																					 ------------------
																					 ,
																					 SUM((CASE
																									 WHEN A1.
																										NODE_LEVEL = '一级节点' AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A) THEN
																										1
																									 ELSE
																										0
																							 END)) AS "本月一级节点应完成",
																					 SUM((CASE
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL AND A1.
																										NODE_LEVEL = '一级节点' AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A) THEN
																										1
																									 ELSE
																										0
																							 END)) AS "本月一级节点已完成"

																					 ------------------
																					 /*-里程碑本月亮灯情况*/
																					 ------------------
																					 ,
																					 SUM(CASE
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本月
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(SYSDATE, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) <= 0 AND
																												A1.NODE_LEVEL IN ('里程碑') THEN
																										1

																									 ELSE
																										0
																							 END) AS "本月里程碑绿灯"

																					 ,
																					 SUM(CASE
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本月
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(SYSDATE, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																												A1.NODE_LEVEL IN ('里程碑') THEN
																										1
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NULL
																											 --判断本月
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(SYSDATE, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																												A1.NODE_LEVEL IN ('里程碑') THEN
																										1

																									 ELSE
																										0
																							 END) AS "本月里程碑黄灯"

																					 ,
																					 SUM(CASE
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本月
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(D.APPROVAL_TIME, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																												A1.NODE_LEVEL IN ('里程碑') THEN
																										1
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NULL
																											 --判断本月
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(SYSDATE, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																												A1.NODE_LEVEL IN ('里程碑') THEN
																										1

																									 ELSE
																										0
																							 END) AS "本月里程碑红灯"

																					 ------------------
																					 /*一级节点本月亮灯情况*/
																					 ------------------
																					 ,
																					 SUM(CASE
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本月
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(SYSDATE, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) <= 0 AND
																												A1.NODE_LEVEL IN ('一级节点') THEN
																										1

																									 ELSE
																										0
																							 END) AS "本月一级节点绿灯"

																					 ,
																					 SUM(CASE
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本月
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(SYSDATE, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																												A1.NODE_LEVEL IN ('一级节点') THEN
																										1
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NULL
																											 --判断本月
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(SYSDATE, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																												A1.NODE_LEVEL IN ('一级节点') THEN
																										1

																									 ELSE
																										0
																							 END) AS "本月一级节点黄灯"

																					 ,
																					 SUM(CASE
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本月
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(D.APPROVAL_TIME, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																												A1.NODE_LEVEL IN ('一级节点') THEN
																										1
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NULL
																											 --判断本月
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(SYSDATE, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																												A1.NODE_LEVEL IN ('一级节点') THEN
																										1

																									 ELSE
																										0
																							 END) AS "本月一级节点红灯"

																					 ------------------
																					 /*二三级节点本月亮灯情况*/
																					 ------------------
																					 ,
																					 SUM(CASE
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本月
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(SYSDATE, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) <= 2 AND
																												A1.NODE_LEVEL IN
																												('二级节点', '三级节点') THEN
																										1

																									 ELSE
																										0
																							 END) AS "本月二三级节点绿灯"

																					 ,
																					 SUM(CASE
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本月
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(SYSDATE, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 3 AND 7 AND
																												A1.NODE_LEVEL IN
																												('二级节点', '三级节点') THEN
																										1
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NULL
																											 --判断本月
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(SYSDATE, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 3 AND 7 AND
																												A1.NODE_LEVEL IN
																												('二级节点', '三级节点') THEN
																										1

																									 ELSE
																										0
																							 END) AS "本月二三级节点黄灯"

																					 ,
																					 SUM(CASE
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本月
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(D.APPROVAL_TIME, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) >= 8 AND
																												A1.NODE_LEVEL IN
																												('二级节点', '三级节点') THEN
																										1
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NULL
																											 --判断本月
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.铁建_本年 || '-' ||
																																 TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																												 FROM   V_POM_GETEXAMINE_MOTH A) AND
																												(SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																												 FROM   V_POM_GETEXAMINE_MOTH A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(SYSDATE, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) >= 8 AND
																												A1.NODE_LEVEL IN
																												('二级节点', '三级节点') THEN
																										1

																									 ELSE
																										0
																							 END) AS "本月二三级节点红灯"

																					 ------------------
																					 /*本季度任务*/
																					 ------------------
																					 ------
																					 ,
																					 SUM((CASE
																									 WHEN
																									 --判断季度
																										TO_CHAR(A1.PLAN_END_DATE,
																														'YYYY-MM-DD') BETWEEN
																										(SELECT A.开始年度 || '-' || A.开始月份 ||
																														 '-26'
																										 FROM   V_POM_GETEXAMINE_QUARTER A) AND
																										(SELECT A.开始年度 || '-' || A.结束月份 ||
																														 '-25'
																										 FROM   V_POM_GETEXAMINE_QUARTER A) THEN
																										1
																									 ELSE
																										0
																							 END)) AS "本季度应完成",
																					 SUM((CASE
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断季度
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												(SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)
																									 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																										THEN
																										1
																									 ELSE
																										0
																							 END)) AS "本季度已完成"

																					 ,
																					 SUM((CASE
																							 --按时完成
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断季度
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(A1.PLAN_END_DATE, 'DD') -
																												 TRUNC(D.APPROVAL_TIME, 'DD')) BETWEEN 0 AND 29 THEN
																										A1.STANDARD_SCORE * 1

																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL --判断本季度
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(A1.PLAN_END_DATE, 'DD') -
																												 TRUNC(D.APPROVAL_TIME, 'DD')) >= 30 AND
																												A1.NODE_LEVEL = '里程碑' THEN
																										A1.STANDARD_SCORE * 1.2
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本季度
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(A1.PLAN_END_DATE, 'DD') -
																												 TRUNC(D.APPROVAL_TIME, 'DD')) >= 30 AND
																												A1.NODE_LEVEL = '一级节点' THEN
																										A1.STANDARD_SCORE * 1.1
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本季度
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'

																												AND
																												(TRUNC(A1.PLAN_END_DATE, 'DD') -
																												 TRUNC(D.APPROVAL_TIME, 'DD')) >= 30 AND
																												A1.NODE_LEVEL IN
																												('二级节点', '三级节点') THEN
																										A1.STANDARD_SCORE * 1.0
																							 --延时完成
																							 --里程碑、一级节点3天
																							 --二三级节点5天
																							 --延时完成
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本季度
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'

																												AND
																												(TRUNC(D.APPROVAL_TIME, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																												A1.NODE_LEVEL IN
																												('里程碑', '一级节点') THEN
																										A1.STANDARD_SCORE * 0.6
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本季度
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'

																												AND
																												(TRUNC(D.APPROVAL_TIME, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 3 AND
																												A1.NODE_LEVEL IN
																												('二级节点', '三级节点') THEN
																										A1.STANDARD_SCORE * 1.0
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本季度
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(D.APPROVAL_TIME, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 4 AND 7 AND
																												A1.NODE_LEVEL IN
																												('二级节点', '三级节点') THEN
																										A1.STANDARD_SCORE * 0.6
																							 --红灯
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本季度
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'

																												AND
																												(TRUNC(D.APPROVAL_TIME, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																												A1.NODE_LEVEL IN
																												('里程碑', '一级节点') THEN
																										A1.STANDARD_SCORE * 0
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本季度
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'

																												AND
																												(TRUNC(D.APPROVAL_TIME, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) >= 8 AND
																												A1.NODE_LEVEL IN
																												('二级节点', '三级节点') THEN
																										A1.STANDARD_SCORE * 0
																									 ELSE
																										0
																							 END)) AS "本季度动态得分"

																					 ------------------
																					 /*-里程碑完成情况*/
																					 ------------------
																					 ,
																					 SUM((CASE
																									 WHEN A1.
																										NODE_LEVEL = '里程碑' AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																	'-26'
																													FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A) THEN
																										1
																									 ELSE
																										0
																							 END)) AS "本季度里程碑应完成",
																					 SUM((CASE
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL AND A1.
																										NODE_LEVEL = '里程碑' AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A) THEN
																										1
																									 ELSE
																										0
																							 END)) AS "本季度里程碑已完成"
																					 ------------------
																					 /*-一级节点完成情况*/
																					 ------------------
																					 ,
																					 SUM((CASE
																									 WHEN A1.
																										NODE_LEVEL = '一级节点' AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																	'-26'
																													FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A) THEN
																										1
																									 ELSE
																										0
																							 END)) AS "本季度一级节点应完成",
																					 SUM((CASE
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL AND A1.
																										NODE_LEVEL = '一级节点' AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A) THEN
																										1
																									 ELSE
																										0
																							 END)) AS "本季度一级节点已完成"

																					 ------------------
																					 /*-里程碑本季度亮灯情况*/
																					 ------------------
																					 ,
																					 SUM(CASE
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本季度
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(SYSDATE, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) <= 0 AND
																												A1.NODE_LEVEL IN ('里程碑') THEN
																										1

																									 ELSE
																										0
																							 END) AS "本季度里程碑绿灯"

																					 ,
																					 SUM(CASE
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本季度
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(SYSDATE, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																												A1.NODE_LEVEL IN ('里程碑') THEN
																										1
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NULL
																											 --判断本季度
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(SYSDATE, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																												A1.NODE_LEVEL IN ('里程碑') THEN
																										1

																									 ELSE
																										0
																							 END) AS "本季度里程碑黄灯"

																					 ,
																					 SUM(CASE
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本季度
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(D.APPROVAL_TIME, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																												A1.NODE_LEVEL IN ('里程碑') THEN
																										1
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NULL
																											 --判断本季度
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(SYSDATE, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																												A1.NODE_LEVEL IN ('里程碑') THEN
																										1

																									 ELSE
																										0
																							 END) AS "本季度里程碑红灯"

																					 ------------------
																					 /*一级节点本季度亮灯情况*/
																					 ------------------
																					 ,
																					 SUM(CASE
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本季度
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(SYSDATE, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) <= 0 AND
																												A1.NODE_LEVEL IN ('一级节点') THEN
																										1

																									 ELSE
																										0
																							 END) AS "本季度一级节点绿灯"

																					 ,
																					 SUM(CASE
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本季度
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(SYSDATE, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																												A1.NODE_LEVEL IN ('一级节点') THEN
																										1
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NULL
																											 --判断本季度
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(SYSDATE, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																												A1.NODE_LEVEL IN ('一级节点') THEN
																										1

																									 ELSE
																										0
																							 END) AS "本季度一级节点黄灯"

																					 ,
																					 SUM(CASE
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本季度
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(D.APPROVAL_TIME, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																												A1.NODE_LEVEL IN ('一级节点') THEN
																										1
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NULL
																											 --判断本季度
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(SYSDATE, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																												A1.NODE_LEVEL IN ('一级节点') THEN
																										1

																									 ELSE
																										0
																							 END) AS "本季度一级节点红灯"

																					 ------------------
																					 /*二三级节点本季度亮灯情况*/
																					 ------------------
																					 ,
																					 SUM(CASE
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本季度
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(SYSDATE, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) <= 2 AND
																												A1.NODE_LEVEL IN
																												('二级节点', '三级节点') THEN
																										1

																									 ELSE
																										0
																							 END) AS "本季度二三级节点绿灯"

																					 ,
																					 SUM(CASE
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本季度
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(SYSDATE, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 3 AND 7 AND
																												A1.NODE_LEVEL IN
																												('二级节点', '三级节点') THEN
																										1
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NULL
																											 --判断本季度
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(SYSDATE, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 3 AND 7 AND
																												A1.NODE_LEVEL IN
																												('二级节点', '三级节点') THEN
																										1

																									 ELSE
																										0
																							 END) AS "本季度二三级节点黄灯"

																					 ,
																					 SUM(CASE
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NOT NULL
																											 --判断本季度
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(D.APPROVAL_TIME, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) >= 8 AND
																												A1.NODE_LEVEL IN
																												('二级节点', '三级节点') THEN
																										1
																									 WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																																'YYYY-MM-DD') IS NULL
																											 --判断本季度
																												AND
																												TO_CHAR(A1.PLAN_END_DATE,
																																'YYYY-MM-DD') BETWEEN
																												((SELECT A.开始年度 || '-' || A.开始月份 ||
																																 '-26'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																												(SELECT A.开始年度 || '-' || A.结束月份 ||
																																 '-25'
																												 FROM   V_POM_GETEXAMINE_QUARTER A)
																											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																												AND
																												(TRUNC(SYSDATE, 'DD') -
																												 TRUNC(A1.PLAN_END_DATE, 'DD')) >= 8 AND
																												A1.NODE_LEVEL IN
																												('二级节点', '三级节点') THEN
																										1

																									 ELSE
																										0
																							 END) AS "本季度二三级节点红灯"

																	 FROM   POM_PROJ_PLAN A
																	 INNER  JOIN POM_PROJ_PLAN_NODE A1
																	 ON     A.ID = A1.PROJ_PLAN_ID
																	 INNER  JOIN SYS_PROJECT_STAGE C1
																	 ON     A.PROJ_ID = C1.ID
																	 INNER  JOIN SYS_PROJECT B1
																	 ON     C1.PROJECT_ID = B1.ID
																	 LEFT   JOIN POM_NODE_FEEDBACK D
																	 ON     D.FEEDBACK_NODE_ID = A1.ID AND
																					FEEDBACK_TYPE = '完成反馈' AND
																					D.APPROVAL_STATUS = '已审核'
																	 WHERE  A.PLAN_TYPE = '项目主项计划' AND
																					A.APPROVAL_STATUS = '已审核'
																	 GROUP  BY B1.UNIT_ID) B
											ON     A.ID = B.UNIT_ID
											WHERE  NVL(B.NODESUM, 0) > 0
											CONNECT BY PRIOR A.ID = A.PARENT_ID) AB
						 GROUP  BY AB.ID, AB.PARENT_ID) B
ON     A.ID = B.ID
WHERE  A.ORG_TYPE = 0 AND
			 A.COMPANY_TYPE = '5' AND
			 A.PARENT_ID = '00320000000000000000000000000S0'
;

prompt
prompt Creating view V_POM_PJMOTHPLAN_STATISTICS
prompt =========================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_POM_PJMOTHPLAN_STATISTICS AS
SELECT
	row_number() over( PARTITION  BY A.PARENT_ID  order by ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100,2) desc) as rank ,LEVEL_RANK,
	A.ID,A.PARENT_ID,A.ORG_NAME,'' AS "COMPANY_ID"
	,NVL(B.NODESUM,0) AS NODESUM
	,nvl(ISFINISH,0) AS  ISFINISHTOTAL
	,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
	,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
	,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
 ,NVL(ISDELAY,0) AS ISDELAY
	,ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
	,ROUND(CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
	,ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
	,'TYPE_ORG' AS "CTYPE"
    ,'' as "STAGEID"
FROM SYS_BUSINESS_UNIT A LEFT JOIN  (
 SELECT AB.ID,AB.PARENT_ID,SUM(AB.NODESUM) AS NODESUM,SUM(AB.ISFINISH) AS ISFINISH,SUM(AB.ISDELAY) AS ISDELAY,SUM(AB.ONTIMEFINISH) AS ONTIMEFINISH,SUM(AB.DELAYFINISH) AS DELAYFINISH,SUM(AB.ADVANCEFINISH) AS ADVANCEFINISH from  (
--  11

 SELECT    NVL(B.NODESUM,0) AS NODESUM
 ,NVL(B.ISFINISH,0) AS ISFINISH
 ,NVL(B.ONTIMEFINISH,0) AS ONTIMEFINISH
 ,NVL(B.DELAYFINISH,0) AS DELAYFINISH,ORG_NAME
 ,NVL(ADVANCEFINISH,0) AS AdvanceFINISH
  ,NVL(ISDELAY,0) AS ISDELAY
 ,ORG_NAME
 ,CONNECT_BY_ROOT ID AS  ID ,CONNECT_BY_ROOT PARENT_ID  AS  PARENT_ID
 from   SYS_BUSINESS_UNIT A  LEFT JOIN
 (
 SELECT  B1.UNIT_ID ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"


  FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='关键节点计划' AND  A.APPROVAL_STATUS='已审核'
 and A1.IS_DISABLE=0
 --判断本月
 AND A1.PLAN_END_DATE  BETWEEN
  TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||'-'||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else'12' end ||'-'||'26'  FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')  AND
 TO_DATE ((SELECT    A.铁建_本年||'-'||铁建_本月||'-'||'25' FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID
	)  B ON  A.ID=B.UNIT_ID
	WHERE NVL(B.NODESUM,0)>0
CONNECT  by PRIOR   A.ID= A.PARENT_ID
) AB
GROUP BY AB.ID,AB.PARENT_ID
)B  ON  A.ID=B.ID
WHERE  A.ORG_TYPE=0  AND     NVL(B.NODESUM,0) >0

UNION ALL
--顶级项目汇总//无分期
SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,4 as  lw
,B2.ID,B2.PARENT_ID,B2.PROJECT_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
  ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,/*'TYPE_PROJTOP' AS CTYPE*/CASE WHEN B3.STAGE_NAME LIKE '%无分期%' THEN 'TYPE_PROJLAST' else 'TYPE_PROJTOP' end as CTYPE
,b3."STAGEID" AS "STAGEID"
FROM(
 SELECT  B1.UNIT_ID AS PARENT_ID ,A.COMPANY_ID ,C1.PROJECT_ID AS ID,B1.PROJECT_NAME ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
 --完成规则
 ,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"
,c1.PROJECT_ID
 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
 INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='关键节点计划'AND  A.APPROVAL_STATUS='已审核'
 and A1.IS_DISABLE=0

 AND A1.PLAN_END_DATE BETWEEN
  TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||'-'||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else'12' end ||'-'||'26'  FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')  AND
 TO_DATE ((SELECT    A.铁建_本年||'-'||铁建_本月||'-'||'25' FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID,A.COMPANY_ID,PROJECT_NAME,c1.PROJECT_ID 	) B2
		LEFT JOIN (SELECT P2.PROJECT_ID,TO_CHAR(wm_concat(P2.STAGE_NAME)) AS STAGE_NAME,p2.id as "STAGEID" FROM SYS_PROJECT P1 LEFT JOIN SYS_PROJECT_STAGE P2 ON P1.ID = P2.PROJECT_ID GROUP BY P2.PROJECT_ID,p2.ID) B3 ON B2.PROJECT_ID = B3.PROJECT_ID
		where        NVL(B2.NODESUM,0)>0 and B3.STAGE_NAME LIKE '%无分期%' 


UNION ALL
--顶级项目汇总//有分期
SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,4
,B2.ID,B2.PARENT_ID,B2.PROJECT_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
  ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,/*'TYPE_PROJTOP' AS CTYPE*/CASE WHEN B3.STAGE_NAME LIKE '%无分期%' THEN 'TYPE_PROJLAST' else 'TYPE_PROJTOP' end as CTYPE,
 '' as "STAGEID"
FROM(
 SELECT  B1.UNIT_ID AS PARENT_ID ,A.COMPANY_ID ,B1.ID,B1.PROJECT_NAME ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
 --完成规则
 ,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"
,c1.PROJECT_ID


 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='关键节点计划'AND  A.APPROVAL_STATUS='已审核' 
 and A1.IS_DISABLE=0

 AND A1.PLAN_END_DATE BETWEEN
  TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||'-'||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else'12' end ||'-'||'26'  FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')  AND
 TO_DATE ((SELECT    A.铁建_本年||'-'||铁建_本月||'-'||'25' FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID,A.COMPANY_ID,B1.ID,PROJECT_NAME,c1.PROJECT_ID 	) B2
		LEFT JOIN (SELECT P2.PROJECT_ID,TO_CHAR(wm_concat(P2.STAGE_NAME)) AS STAGE_NAME FROM SYS_PROJECT P1 LEFT JOIN SYS_PROJECT_STAGE P2 ON P1.ID = P2.PROJECT_ID GROUP BY P2.PROJECT_ID) B3 ON B2.PROJECT_ID = B3.PROJECT_ID
	where        NVL(B2.NODESUM,0)>0 and B3.STAGE_NAME NOT   LIKE '%无分期%'
		----分期汇总

UNION ALL
SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,5
,B2.ID,B2.PARENT_ID,B2.PROJSTAGE_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
  ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,'TYPE_PROJLAST' AS CTYPE
,B2."STAGEID"
FROM(
 SELECT  C1.PROJECT_ID AS PARENT_ID ,A.COMPANY_ID ,C1.ID,B1.PROJECT_NAME||'_'|| C1.STAGE_NAME AS  PROJSTAGE_NAME ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"
,C1.ID as "STAGEID"

 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='关键节点计划'    AND  A.APPROVAL_STATUS='已审核'
  and A1.IS_DISABLE=0
   AND A1.PLAN_END_DATE BETWEEN
  TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||'-'||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else'12' end ||'-'||'26'  FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')  AND
 TO_DATE ((SELECT    A.铁建_本年||'-'||铁建_本月||'-'||'25' FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'--C1.PROJECT_ID
		GROUP BY  C1.PROJECT_ID,A.COMPANY_ID,C1.ID,PROJECT_NAME, STAGE_NAME	) B2		where        NVL(B2.NODESUM,0)>0 AND B2.PROJSTAGE_NAME NOT LIKE '%无分期%'
;

prompt
prompt Creating view V_POM_PJPLANDELAY_STATISTICS
prompt ==========================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_POM_PJPLANDELAY_STATISTICS AS
SELECT ROW_NUMBER() OVER(PARTITION BY A.PARENT_ID ORDER BY ROUND(CASE
					 WHEN NVL(B.NODESUM,
										0) > 0 THEN
						NVL(DELAYFINISH,
								0) /
						NVL(B.NODESUM,
								0)
					 ELSE
						0
			 END * 100, 2) DESC) AS RANK, A.ID, A.PARENT_ID, A.ORG_NAME,
			 NVL(B.NODESUM, 0) AS NODESUM, NVL(DELAYFINISH, 0) AS DELAYFINISHTOTAL,
			 NVL(B."开盘DELAYFINISH", 0) AS "开盘DELAYFINISH",
			 NVL(B."开工DELAYFINISH", 0) AS "开工DELAYFINISH",
			 NVL(B."PROJIDDELAY", 0) AS "PROJDELAY",
			 NVL(B."PROSTAGEID", 0) AS "PROSTAGEDELAY", 'TYPE_ORG' AS CTYPE
FROM   SYS_BUSINESS_UNIT A
LEFT   JOIN (SELECT AB.ID, AB.PARENT_ID, SUM(AB.NODESUM) AS NODESUM,
										SUM(AB.开盘DELAYFINISH) AS 开盘DELAYFINISH,
										SUM(AB.开工DELAYFINISH) AS 开工DELAYFINISH,
										SUM(AB.DELAYFINISH) AS DELAYFINISH,
										SUM(CASE
														WHEN (AB.PROJIDDELAY) IS NOT NULL THEN
														 1
														ELSE
														 0
												END) AS PROJIDDELAY,
										SUM(CASE
														WHEN (AB.PROSTAGEID) IS NOT NULL THEN
														 1
														ELSE
														 0
												END) AS PROSTAGEID -- ,COUNT(AB.PROSTAGEID) AS  PROSTAGEID
						 FROM   (
											--  11

											SELECT NVL(B.NODESUM, 0) AS NODESUM,
															NVL(B.DELAYFINISH, 0) AS DELAYFINISH,
															NVL(B."开盘DELAYFINISH", 0) AS "开盘DELAYFINISH",
															NVL(B."开工DELAYFINISH", 0) AS "开工DELAYFINISH",
															(CASE
																	WHEN NVL(B."DELAYFINISH", 0) > 0 THEN
																	 B.PROSTAGEID
																	ELSE
																	 NULL
															END) AS "PROSTAGEID",
															(CASE
																	WHEN NVL(B."DELAYFINISH", 0) > 0 THEN
																	 B.PROJID
																	ELSE
																	 NULL
															END) AS "PROJIDDELAY", ORG_NAME,
															CONNECT_BY_ROOT ID AS ID,
															CONNECT_BY_ROOT PARENT_ID AS PARENT_ID
											FROM   SYS_BUSINESS_UNIT A
											LEFT   JOIN (SELECT B1.UNIT_ID, C1.ID AS PROSTAGEID,
																					B1.ID AS PROJID,
																					COUNT(A1.ID) AS "NODESUM"
																					--完成规则
																					,
																					SUM((CASE
																									WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																															 'YYYY-MM-DD') IS NOT NULL AND
																											 TO_CHAR(A1.ACTUAL_END_DATE,
																															 'YYYY-MM-DD') >
																											 TO_CHAR(PLAN_END_DATE,
																															 'YYYY-MM-DD') THEN
																									 1
																									ELSE
																									 0
																							END)) AS "DELAYFINISH",
																					SUM((CASE
																									WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																															 'YYYY-MM-DD') IS NOT NULL AND
																											 A1.NODE_NAME LIKE '%开盘%' AND
																											 TO_CHAR(A1.ACTUAL_END_DATE,
																															 'YYYY-MM-DD') >
																											 TO_CHAR(PLAN_END_DATE,
																															 'YYYY-MM-DD') THEN
																									 1
																									ELSE
																									 0
																							END)) AS "开盘DELAYFINISH",
																					SUM((CASE
																									WHEN TO_CHAR(A1.ACTUAL_END_DATE,
																															 'YYYY-MM-DD') IS NOT NULL AND
																											 A1.NODE_NAME LIKE '%建设规划许可证%' AND
																											 TO_CHAR(A1.ACTUAL_END_DATE,
																															 'YYYY-MM-DD') >
																											 TO_CHAR(PLAN_END_DATE,
																															 'YYYY-MM-DD') THEN
																									 1
																									ELSE
																									 0
																							END)) AS "开工DELAYFINISH"

																	 FROM   POM_PROJ_PLAN A
																	 INNER  JOIN POM_PROJ_PLAN_NODE A1
																	 ON     A.ID = A1.PROJ_PLAN_ID
																	 INNER  JOIN SYS_PROJECT_STAGE C1
																	 ON     A.PROJ_ID = C1.ID
																	 INNER  JOIN SYS_PROJECT B1
																	 ON     C1.PROJECT_ID = B1.ID
																	 WHERE  A.PLAN_TYPE = '关键节点计划' AND
																					A.APPROVAL_STATUS = '已审核'
																	 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																	 GROUP  BY B1.UNIT_ID, C1.ID, B1.ID) B
											ON     A.ID = B.UNIT_ID
											WHERE  NVL(B.NODESUM, 0) > 0

											CONNECT BY PRIOR A.ID = A.PARENT_ID) AB
						 GROUP  BY AB.ID, AB.PARENT_ID) B
ON     A.ID = B.ID
WHERE  A.ORG_TYPE = 0 AND
			 NVL(B.NODESUM, 0) > 0

UNION ALL
--顶级项目汇总
SELECT ROW_NUMBER() OVER(PARTITION BY PARENT_ID ORDER BY ROUND(CASE
					 WHEN NVL(NODESUM, 0) > 0 THEN
						NVL(DELAYFINISH, 0) / NVL(NODESUM, 0)
					 ELSE
						0
			 END * 100, 2) DESC) AS RANK, B3."PROJID", B3."PARENT_ID",
			 B3."PROJECT_NAME", B3."NODESUM", B3."DELAYFINISH", B3."开盘DELAYFINISH",
			 B3."开工DELAYFINISH", B3."PROSTAGEID", B3."PROJIDDELAY", B3."CTYPE"
FROM   (SELECT B2.PROJID, B2.PARENT_ID, B2.PROJECT_NAME,
								SUM(NVL(B2.NODESUM, 0)) AS NODESUM,
								SUM(NVL(B2.DELAYFINISH, 0)) AS DELAYFINISH,
								SUM(NVL(B2."开盘DELAYFINISH", 0)) AS "开盘DELAYFINISH",
								SUM(NVL(B2."开工DELAYFINISH", 0)) AS "开工DELAYFINISH",
								COUNT((CASE
													WHEN NVL(B2."DELAYFINISH", 0) > 0 THEN
													 B2.PROSTAGEID
													ELSE
													 NULL
											END)) AS "PROSTAGEID",
								COUNT((CASE
													WHEN NVL(B2."DELAYFINISH", 0) > 0 THEN
													 B2.PROJID
													ELSE
													 NULL
											END)) AS "PROJIDDELAY", 'TYPE_PROJTOP' AS CTYPE
				 FROM   (SELECT B1.UNIT_ID AS PARENT_ID, C1.ID AS PROSTAGEID,
												 B1.ID AS PROJID, B1.PROJECT_NAME,
												 COUNT(A1.ID) AS "NODESUM"
												 --完成规则
												 ,
												 SUM((CASE
																 WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL AND
																			TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') >
																			TO_CHAR(PLAN_END_DATE, 'YYYY-MM-DD') THEN
																	1
																 ELSE
																	0
														 END)) AS "DELAYFINISH",
												 SUM((CASE
																 WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL AND
																			A1.NODE_NAME LIKE '%开盘%' AND
																			TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') >
																			TO_CHAR(PLAN_END_DATE, 'YYYY-MM-DD') THEN
																	1
																 ELSE
																	0
														 END)) AS "开盘DELAYFINISH",
												 SUM((CASE
																 WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL AND
																			A1.NODE_NAME LIKE '%建设规划许可证%' AND
																			TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') >
																			TO_CHAR(PLAN_END_DATE, 'YYYY-MM-DD') THEN
																	1
																 ELSE
																	0
														 END)) AS "开工DELAYFINISH"

									FROM   POM_PROJ_PLAN A
									INNER  JOIN POM_PROJ_PLAN_NODE A1
									ON     A.ID = A1.PROJ_PLAN_ID
									INNER  JOIN SYS_PROJECT_STAGE C1
									ON     A.PROJ_ID = C1.ID
									INNER  JOIN SYS_PROJECT B1
									ON     C1.PROJECT_ID = B1.ID
									WHERE  A.PLAN_TYPE = '关键节点计划' AND
												 A.APPROVAL_STATUS = '已审核'
									--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
									GROUP  BY B1.UNIT_ID, C1.ID, B1.ID, PROJECT_NAME) B2
				 WHERE  NVL(B2.NODESUM, 0) > 0
				 GROUP  BY B2.PROJID, B2.PARENT_ID, B2.PROJECT_NAME) B3
----分期汇总

UNION ALL
SELECT ROW_NUMBER() OVER(PARTITION BY B3.PARENT_ID ORDER BY ROUND(CASE
					 WHEN NVL(B3.NODESUM, 0) > 0 THEN
						NVL(DELAYFINISH, 0) / NVL(B3.NODESUM, 0)
					 ELSE
						0
			 END * 100, 2) DESC) AS RANK, B3."PROSTAGEID", B3."PARENT_ID",
			 B3."PROJSTAGE_NAME", B3."NODESUM", B3."DELAYFINISH",
			 B3."开盘DELAYFINISH", B3."开工DELAYFINISH", B3."PROSTAGEIDDELAY",
			 B3."PROJIDDELAY", B3."CTYPE"
FROM   (SELECT B2.PROSTAGEID, B2.PARENT_ID, B2.PROJSTAGE_NAME,
								SUM(NVL(B2.NODESUM, 0)) AS NODESUM,
								SUM(NVL(B2.DELAYFINISH, 0)) AS DELAYFINISH,
								SUM(NVL(B2."开盘DELAYFINISH", 0)) AS "开盘DELAYFINISH",
								SUM(NVL(B2."开工DELAYFINISH", 0)) AS "开工DELAYFINISH",
								COUNT((CASE
													WHEN NVL(B2."DELAYFINISH", 0) > 0 THEN
													 B2.PROSTAGEID
													ELSE
													 NULL
											END)) AS "PROSTAGEIDDELAY",
								COUNT((CASE
													WHEN NVL(B2."DELAYFINISH", 0) > 0 THEN
													 B2.PROJID
													ELSE
													 NULL
											END)) AS "PROJIDDELAY", 'TYPE_PROJLAST' AS CTYPE
				 FROM   (SELECT C1.PROJECT_ID AS PARENT_ID, C1.ID AS PROSTAGEID,
												 B1.ID AS PROJID,
												 B1.PROJECT_NAME || '_' || C1.STAGE_NAME AS PROJSTAGE_NAME,
												 COUNT(A1.ID) AS "NODESUM"
												 --完成规则
												 ,
												 SUM((CASE
																 WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL AND
																			TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') >
																			TO_CHAR(PLAN_END_DATE, 'YYYY-MM-DD') THEN
																	1
																 ELSE
																	0
														 END)) AS "DELAYFINISH",
												 SUM((CASE
																 WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL AND
																			A1.NODE_NAME LIKE '%开盘%' AND
																			TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') >
																			TO_CHAR(PLAN_END_DATE, 'YYYY-MM-DD') THEN
																	1
																 ELSE
																	0
														 END)) AS "开盘DELAYFINISH",
												 SUM((CASE
																 WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL AND
																			A1.NODE_NAME LIKE '%建设规划许可证%' AND
																			TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') >
																			TO_CHAR(PLAN_END_DATE, 'YYYY-MM-DD') THEN
																	1
																 ELSE
																	0
														 END)) AS "开工DELAYFINISH"

									FROM   POM_PROJ_PLAN A
									INNER  JOIN POM_PROJ_PLAN_NODE A1
									ON     A.ID = A1.PROJ_PLAN_ID
									INNER  JOIN SYS_PROJECT_STAGE C1
									ON     A.PROJ_ID = C1.ID
									INNER  JOIN SYS_PROJECT B1
									ON     C1.PROJECT_ID = B1.ID
									WHERE  A.PLAN_TYPE = '关键节点计划' AND
												 A.APPROVAL_STATUS = '已审核'

									--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
									GROUP  BY C1.PROJECT_ID, C1.ID, B1.ID, PROJECT_NAME,
														STAGE_NAME) B2
				 WHERE  NVL(B2.NODESUM, 0) > 0
				 GROUP  BY B2.PROSTAGEID, B2.PARENT_ID, B2.PROJSTAGE_NAME) B3
;

prompt
prompt Creating view V_POM_PJPLANRANK
prompt ==============================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_POM_PJPLANRANK AS
SELECT  
 row_number() over( PARTITION  BY A4.PARENT_ID  order by ROUND( CASE WHEN NVL(A3.应完成,0)>0 THEN nvl(已完成,0)/NVL(A3.应完成,0) ELSE 0 END *100,2) desc) as rank
 ,PLAN_TYPE AS  PLAN_TYPE

,CONNECT_BY_ROOT A4.ID as ID  ,CONNECT_BY_ROOT A4.PARENT_ID as PARENT_ID  
,CONNECT_BY_ROOT A4."ORG_NAME" as ORG_NAME 
,LPAD(CONNECT_BY_ROOT A4.ORDER_CODE, 4,'0') AS ORGCODE
,A3."PLANYEAR",A3."PLANQUATOR",A3."PLANMOTH",A3."应完成",A3."已完成",A3."SUMNODESCORE",A3."已完成总分",A3."动态得分",A3."里程碑应完成",A3."里程碑已完成",A3."一级节点应完成",A3."一级节点已完成",A3."二级节点应完成",A3."二级节点已完成",A3."三级节点应完成",A3."三级节点已完成",A3."里程碑绿灯",A3."一级节点绿灯",A3."二级节点绿灯",A3."三级节点绿灯",A3."里程碑黄灯",A3."一级节点黄灯",A3."二级节点黄灯",A3."三级节点黄灯",A3."里程碑红灯",A3."一级节点红灯",A3."二级节点红灯",A3."三级节点红灯",A3."CTYPE"
FROM 
SYS_BUSINESS_UNIT A4 LEFT JOIN
(
SELECT 
A2.ORGNAME AS ORG_NAME,A2.PLAN_TYPE ,A2.ORGID,A2.PLANYEAR,A2.PLANQUATOR,A2.PLANMOTH
,COUNT(A2.NODEID) AS 应完成
,SUM(CASE WHEN A2.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0   END ) AS 已完成
,SUM(A2.STANDARD_SCORE) AS SUMNODESCORE
,SUM(NVL(A2.EXAMINATION_SCORE,0)) AS 已完成总分
    /*动态得分情况*/
,SUM(NVL(A2.NEW_EXAMINATION_SCORE,0))   AS 动态得分
,SUM(CASE WHEN A2.NODE_LEVEL='里程碑' THEN 1 ELSE 0 END ) AS 里程碑应完成
,SUM(CASE WHEN A2.NODE_LEVEL='里程碑' AND  A2.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END ) AS 里程碑已完成
 ,SUM(CASE WHEN A2.NODE_LEVEL='一级节点' THEN 1 ELSE 0 END ) AS 一级节点应完成
,SUM(CASE WHEN A2.NODE_LEVEL='一级节点' AND A2.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END ) AS 一级节点已完成
 ,SUM(CASE WHEN A2.NODE_LEVEL='二级节点' THEN 1 ELSE 0 END ) AS 二级节点应完成
,SUM(CASE WHEN A2.NODE_LEVEL='"二级节点'  AND A2.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END ) AS 二级节点已完成
 ,SUM(CASE WHEN A2.NODE_LEVEL='三级节点' THEN 1 ELSE 0 END ) AS 三级节点应完成
,SUM(CASE WHEN A2.NODE_LEVEL='三级节点' AND A2.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END ) AS 三级节点已完成

,SUM(CASE WHEN A2.NODE_LEVEL='里程碑' THEN A2.绿灯  ELSE 0 END ) AS 里程碑绿灯
,SUM(CASE WHEN A2.NODE_LEVEL='一级节点' THEN A2.绿灯  ELSE 0 END ) AS 一级节点绿灯
,SUM(CASE WHEN A2.NODE_LEVEL='二级节点' THEN A2.绿灯  ELSE 0 END ) AS 二级节点绿灯
,SUM(CASE WHEN A2.NODE_LEVEL='三级节点' THEN A2.绿灯  ELSE 0 END ) AS 三级节点绿灯
,SUM(CASE WHEN A2.NODE_LEVEL='里程碑' THEN A2.黄灯  ELSE 0 END ) AS 里程碑黄灯
,SUM(CASE WHEN A2.NODE_LEVEL='一级节点' THEN A2.黄灯  ELSE 0 END ) AS 一级节点黄灯
,SUM(CASE WHEN A2.NODE_LEVEL='二级节点' THEN A2.黄灯  ELSE 0 END ) AS 二级节点黄灯
,SUM(CASE WHEN A2.NODE_LEVEL='三级节点' THEN A2.黄灯  ELSE 0 END ) AS 三级节点黄灯
,SUM(CASE WHEN A2.NODE_LEVEL='里程碑' THEN A2.红灯  ELSE 0 END ) AS 里程碑红灯
,SUM(CASE WHEN A2.NODE_LEVEL='一级节点' THEN A2.红灯  ELSE 0 END ) AS 一级节点红灯
,SUM(CASE WHEN A2.NODE_LEVEL='二级节点' THEN A2.红灯  ELSE 0 END ) AS 二级节点红灯
,SUM(CASE WHEN A2.NODE_LEVEL='三级节点' THEN A2.红灯  ELSE 0 END ) AS 三级节点红灯
   ,'TYPE_ORG' AS CTYPE
		
FROM 

(
SELECT      B1.ID AS PROJECTID,B1.PROJECT_NAME,B1.UNIT_ID AS ORGID,b1.UNIT_NAME AS ORGNAME 
,A.ID AS PLANID ,A.PLAN_NAME,a.PLAN_TYPE
	,A1.ID AS NODEID,A1.NODE_NAME,A1.NODE_LEVEL,A1.PLAN_END_DATE,A1.ACTUAL_END_DATE,A1.ESTIMATE_END_DATE
	,A1.STANDARD_SCORE,PNE.EXAMINATION_SCORE,PNE.NEW_EXAMINATION_SCORE
	,A1.COMPLETION_STANDARD,COMPLETION_RESULTS_REMARK
	, CASE WHEN  	TO_NUMBER( TO_CHAR(A1.PLAN_END_DATE,'MM'))=12 AND 	TO_NUMBER( TO_CHAR(A1.PLAN_END_DATE,'DD'))>25 THEN  TO_CHAR(TO_NUMBER( TO_CHAR(A1.PLAN_END_DATE,'YYYY') +1)) ELSE    TO_CHAR(A1.PLAN_END_DATE,'YYYY')  END AS  "PLANYEAR"
	, CASE WHEN  
	CASE
	WHEN
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END > 12 THEN
	1 ELSE
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END
	END 
	BETWEEN  1  AND 3 THEN 1
	WHEN

	CASE
	WHEN
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END > 12 THEN
	1 ELSE
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END
	END 

	BETWEEN 4  AND 6  THEN 2
	WHEN  
	CASE
	WHEN
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END > 12 THEN
	1 ELSE
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END
	END 


	BETWEEN 7 AND  9  THEN 3
	WHEN   
	CASE
	WHEN
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END > 12 THEN
	1 ELSE
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END
	END 

	BETWEEN 10 AND 12  THEN 4  END
	AS "PLANQUATOR"
	,CASE
	WHEN
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END > 12 THEN
	1 ELSE
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END
	END AS "PLANMOTH"
,CASE 
WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  
<= (CASE WHEN  A1.NODE_LEVEL IN ('里程碑','一级节点')   THEN 0 ELSE 3 END) 

THEN 1   ELSE  0  END AS "绿灯"
,D.APPROVAL_TIME
,CASE 
WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  
BETWEEN (CASE WHEN  A1.NODE_LEVEL IN ('里程碑','一级节点')   THEN 1 ELSE 4 END)   AND  (CASE WHEN  A1.NODE_LEVEL IN ('里程碑','一级节点')   THEN 5 ELSE 7 END)   

THEN 1   ELSE  0  END AS "黄灯"
,CASE 
WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  
>=     (CASE WHEN  A1.NODE_LEVEL IN ('里程碑','一级节点')   THEN 5 ELSE 8 END)   

THEN 1   ELSE  0  END AS "红灯"
 

FROM
POM_PROJ_PLAN A
INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
LEFT JOIN POM_NODE_EXAMINATION PNE ON A1.ID = PNE.NODE_ID
LEFT JOIN POM_NODE_FEEDBACK D ON D.FEEDBACK_NODE_ID=A1.ID AND  FEEDBACK_TYPE='CARRY_OUT' AND  D.APPROVAL_STATUS='已审核'
WHERE     A.APPROVAL_STATUS='已审核' AND  A1.IS_DELETE=0  
AND   A.COMPANY_NAME  NOT  in(  '中南公司','贵州公司')
) A2

GROUP BY A2.ORGID,A2.ORGNAME,PLAN_TYPE,A2.PLANYEAR,A2.PLANQUATOR,A2.PLANMOTH
)A3  ON A3.ORGID=A4.ID
WHERE 1=1
AND A3.应完成>0 
--and  A4.PARENT_ID='003200000000000000000000000000'
-- AND    PLANYEAR=2020
-- AND ORGNAME in ('贵州公司','贵州地产总部')
CONNECT BY PRIOR A4.ID=A4.PARENT_ID


-- AND  B1.PROJECT_NAME='重庆西派城'
--   SELECT * FROM  POM_PROJ_PLAN_NODE  where   ROWNUM<2


UNION ALL 

 ------------------------------------------------------------------------------------
 --查询公司//中南公司项目、贵州公司项目汇总--集团公司
 ------------------------------------------------------------------------------------
 SELECT  
 row_number() over( PARTITION  BY A4.PARENT_ID  order by ROUND( CASE WHEN NVL(A3.应完成,0)>0 THEN nvl(已完成,0)/NVL(A3.应完成,0) ELSE 0 END *100,2) desc) as rank
 ,PLAN_TYPE AS  PLAN_TYPE
,'003200000000000000000000000000' as id ,'0001' as PARENT_ID,'中国铁建地产集团' as ORG_NAME
,'0001' AS ORGCODE

,A3."PLANYEAR",A3."PLANQUATOR",A3."PLANMOTH",A3."应完成",A3."已完成",A3."SUMNODESCORE",A3."已完成总分",A3."动态得分",A3."里程碑应完成",A3."里程碑已完成",A3."一级节点应完成",A3."一级节点已完成",A3."二级节点应完成",A3."二级节点已完成",A3."三级节点应完成",A3."三级节点已完成",A3."里程碑绿灯",A3."一级节点绿灯",A3."二级节点绿灯",A3."三级节点绿灯",A3."里程碑黄灯",A3."一级节点黄灯",A3."二级节点黄灯",A3."三级节点黄灯",A3."里程碑红灯",A3."一级节点红灯",A3."二级节点红灯",A3."三级节点红灯",A3."CTYPE"
FROM 
SYS_BUSINESS_UNIT A4 LEFT JOIN
(
SELECT 
A2.ORGNAME AS ORG_NAME ,PLAN_TYPE,A2.ORGID,A2.PLANYEAR,A2.PLANQUATOR,A2.PLANMOTH
,COUNT(A2.NODEID) AS 应完成
,SUM(CASE WHEN A2.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0   END ) AS 已完成
,SUM(A2.STANDARD_SCORE) AS SUMNODESCORE
,SUM(NVL(A2.EXAMINATION_SCORE,0)) AS 已完成总分
    /*动态得分情况*/
,SUM(NVL(A2.NEW_EXAMINATION_SCORE,0))   AS 动态得分
,SUM(CASE WHEN A2.NODE_LEVEL='里程碑' THEN 1 ELSE 0 END ) AS 里程碑应完成
,SUM(CASE WHEN A2.NODE_LEVEL='里程碑' AND  A2.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END ) AS 里程碑已完成
 ,SUM(CASE WHEN A2.NODE_LEVEL='一级节点' THEN 1 ELSE 0 END ) AS 一级节点应完成
,SUM(CASE WHEN A2.NODE_LEVEL='一级节点' AND A2.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END ) AS 一级节点已完成
 ,SUM(CASE WHEN A2.NODE_LEVEL='二级节点' THEN 1 ELSE 0 END ) AS 二级节点应完成
,SUM(CASE WHEN A2.NODE_LEVEL='"二级节点'  AND A2.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END ) AS 二级节点已完成
 ,SUM(CASE WHEN A2.NODE_LEVEL='三级节点' THEN 1 ELSE 0 END ) AS 三级节点应完成
,SUM(CASE WHEN A2.NODE_LEVEL='三级节点' AND A2.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END ) AS 三级节点已完成

,SUM(CASE WHEN A2.NODE_LEVEL='里程碑' THEN A2.绿灯  ELSE 0 END ) AS 里程碑绿灯
,SUM(CASE WHEN A2.NODE_LEVEL='一级节点' THEN A2.绿灯  ELSE 0 END ) AS 一级节点绿灯
,SUM(CASE WHEN A2.NODE_LEVEL='二级节点' THEN A2.绿灯  ELSE 0 END ) AS 二级节点绿灯
,SUM(CASE WHEN A2.NODE_LEVEL='三级节点' THEN A2.绿灯  ELSE 0 END ) AS 三级节点绿灯
,SUM(CASE WHEN A2.NODE_LEVEL='里程碑' THEN A2.黄灯  ELSE 0 END ) AS 里程碑黄灯
,SUM(CASE WHEN A2.NODE_LEVEL='一级节点' THEN A2.黄灯  ELSE 0 END ) AS 一级节点黄灯
,SUM(CASE WHEN A2.NODE_LEVEL='二级节点' THEN A2.黄灯  ELSE 0 END ) AS 二级节点黄灯
,SUM(CASE WHEN A2.NODE_LEVEL='三级节点' THEN A2.黄灯  ELSE 0 END ) AS 三级节点黄灯
,SUM(CASE WHEN A2.NODE_LEVEL='里程碑' THEN A2.红灯  ELSE 0 END ) AS 里程碑红灯
,SUM(CASE WHEN A2.NODE_LEVEL='一级节点' THEN A2.红灯  ELSE 0 END ) AS 一级节点红灯
,SUM(CASE WHEN A2.NODE_LEVEL='二级节点' THEN A2.红灯  ELSE 0 END ) AS 二级节点红灯
,SUM(CASE WHEN A2.NODE_LEVEL='三级节点' THEN A2.红灯  ELSE 0 END ) AS 三级节点红灯
   ,'TYPE_ORG' AS CTYPE
		
FROM 

(
SELECT      B1.ID AS PROJECTID,B1.PROJECT_NAME,B1.UNIT_ID AS ORGID,b1.UNIT_NAME AS ORGNAME 
,A.ID AS PLANID ,A.PLAN_NAME,A.PLAN_TYPE
	,A1.ID AS NODEID,A1.NODE_NAME,A1.NODE_LEVEL,A1.PLAN_END_DATE,A1.ACTUAL_END_DATE,A1.ESTIMATE_END_DATE
	,A1.STANDARD_SCORE,PNE.EXAMINATION_SCORE,PNE.NEW_EXAMINATION_SCORE
	,A1.COMPLETION_STANDARD,COMPLETION_RESULTS_REMARK
	, CASE WHEN  	TO_NUMBER( TO_CHAR(A1.PLAN_END_DATE,'MM'))=12 AND 	TO_NUMBER( TO_CHAR(A1.PLAN_END_DATE,'DD'))>25 THEN  TO_CHAR(TO_NUMBER( TO_CHAR(A1.PLAN_END_DATE,'YYYY') +1)) ELSE    TO_CHAR(A1.PLAN_END_DATE,'YYYY')  END AS  "PLANYEAR"
	, CASE WHEN  
	CASE
	WHEN
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END > 12 THEN
	1 ELSE
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END
	END 
	BETWEEN  1  AND 3 THEN 1
	WHEN

	CASE
	WHEN
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END > 12 THEN
	1 ELSE
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END
	END 

	BETWEEN 4  AND 6  THEN 2
	WHEN  
	CASE
	WHEN
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END > 12 THEN
	1 ELSE
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END
	END 


	BETWEEN 7 AND  9  THEN 3
	WHEN   
	CASE
	WHEN
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END > 12 THEN
	1 ELSE
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END
	END 

	BETWEEN 10 AND 12  THEN 4  END
	AS "PLANQUATOR"
	,CASE
	WHEN
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END > 12 THEN
	1 ELSE
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END
	END AS "PLANMOTH"
,CASE 
WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  
<= (CASE WHEN  A1.NODE_LEVEL IN ('里程碑','一级节点')   THEN 0 ELSE 3 END) 

THEN 1   ELSE  0  END AS "绿灯"
,D.APPROVAL_TIME
,CASE 
WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  
BETWEEN (CASE WHEN  A1.NODE_LEVEL IN ('里程碑','一级节点')   THEN 1 ELSE 4 END)   AND  (CASE WHEN  A1.NODE_LEVEL IN ('里程碑','一级节点')   THEN 5 ELSE 7 END)   

THEN 1   ELSE  0  END AS "黄灯"
,CASE 
WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  
>=     (CASE WHEN  A1.NODE_LEVEL IN ('里程碑','一级节点')   THEN 5 ELSE 8 END)   

THEN 1   ELSE  0  END AS "红灯"
 

FROM
POM_PROJ_PLAN A
INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
LEFT JOIN POM_NODE_EXAMINATION PNE ON A1.ID = PNE.NODE_ID
LEFT JOIN POM_NODE_FEEDBACK D ON D.FEEDBACK_NODE_ID=A1.ID AND  FEEDBACK_TYPE='CARRY_OUT' AND  D.APPROVAL_STATUS='已审核'
WHERE   A.APPROVAL_STATUS='已审核' AND  A1.IS_DELETE=0  
AND   A.COMPANY_NAME     in (  '中南公司','贵州公司')--集团
) A2


GROUP BY A2.ORGID,A2.ORGNAME,PLAN_TYPE,A2.PLANYEAR,A2.PLANQUATOR,A2.PLANMOTH
)A3  ON A3.ORGID=A4.ID
WHERE 1=1
AND A3.应完成>0 
--and  A4.PARENT_ID='003200000000000000000000000000'
-- AND    PLANYEAR=2020
-- AND ORGNAME in ('贵州公司','贵州地产总部')



-- AND  B1.PROJECT_NAME='重庆西派城'
--   SELECT * FROM  POM_PROJ_PLAN_NODE  where   ROWNUM<2
UNION ALL 

 ------------------------------------------------------------------------------------
 --查询公司//中南公司项目、贵州公司项目
 ------------------------------------------------------------------------------------
 SELECT  
 row_number() over( PARTITION  BY A4.PARENT_ID  order by ROUND( CASE WHEN NVL(A3.应完成,0)>0 THEN nvl(已完成,0)/NVL(A3.应完成,0) ELSE 0 END *100,2) desc) as rank
 ,PLAN_TYPE AS  PLAN_TYPE

, A4.ID as ID  , A4.PARENT_ID as PARENT_ID  
, A4."ORG_NAME" as ORG_NAME 
,LPAD( A4.ORDER_CODE, 4,'0') AS ORGCODE
,A3."PLANYEAR",A3."PLANQUATOR",A3."PLANMOTH",A3."应完成",A3."已完成",A3."SUMNODESCORE",A3."已完成总分",A3."动态得分",A3."里程碑应完成",A3."里程碑已完成",A3."一级节点应完成",A3."一级节点已完成",A3."二级节点应完成",A3."二级节点已完成",A3."三级节点应完成",A3."三级节点已完成",A3."里程碑绿灯",A3."一级节点绿灯",A3."二级节点绿灯",A3."三级节点绿灯",A3."里程碑黄灯",A3."一级节点黄灯",A3."二级节点黄灯",A3."三级节点黄灯",A3."里程碑红灯",A3."一级节点红灯",A3."二级节点红灯",A3."三级节点红灯",A3."CTYPE"
FROM 
SYS_BUSINESS_UNIT A4 LEFT JOIN
(
SELECT 
A2.ORGNAME AS ORG_NAME ,PLAN_TYPE,A2.ORGID,A2.PLANYEAR,A2.PLANQUATOR,A2.PLANMOTH
,COUNT(A2.NODEID) AS 应完成
,SUM(CASE WHEN A2.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0   END ) AS 已完成
,SUM(A2.STANDARD_SCORE) AS SUMNODESCORE
,SUM(NVL(A2.EXAMINATION_SCORE,0)) AS 已完成总分
    /*动态得分情况*/
,SUM(NVL(A2.NEW_EXAMINATION_SCORE,0))   AS 动态得分
,SUM(CASE WHEN A2.NODE_LEVEL='里程碑' THEN 1 ELSE 0 END ) AS 里程碑应完成
,SUM(CASE WHEN A2.NODE_LEVEL='里程碑' AND  A2.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END ) AS 里程碑已完成
 ,SUM(CASE WHEN A2.NODE_LEVEL='一级节点' THEN 1 ELSE 0 END ) AS 一级节点应完成
,SUM(CASE WHEN A2.NODE_LEVEL='一级节点' AND A2.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END ) AS 一级节点已完成
 ,SUM(CASE WHEN A2.NODE_LEVEL='二级节点' THEN 1 ELSE 0 END ) AS 二级节点应完成
,SUM(CASE WHEN A2.NODE_LEVEL='"二级节点'  AND A2.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END ) AS 二级节点已完成
 ,SUM(CASE WHEN A2.NODE_LEVEL='三级节点' THEN 1 ELSE 0 END ) AS 三级节点应完成
,SUM(CASE WHEN A2.NODE_LEVEL='三级节点' AND A2.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END ) AS 三级节点已完成

,SUM(CASE WHEN A2.NODE_LEVEL='里程碑' THEN A2.绿灯  ELSE 0 END ) AS 里程碑绿灯
,SUM(CASE WHEN A2.NODE_LEVEL='一级节点' THEN A2.绿灯  ELSE 0 END ) AS 一级节点绿灯
,SUM(CASE WHEN A2.NODE_LEVEL='二级节点' THEN A2.绿灯  ELSE 0 END ) AS 二级节点绿灯
,SUM(CASE WHEN A2.NODE_LEVEL='三级节点' THEN A2.绿灯  ELSE 0 END ) AS 三级节点绿灯
,SUM(CASE WHEN A2.NODE_LEVEL='里程碑' THEN A2.黄灯  ELSE 0 END ) AS 里程碑黄灯
,SUM(CASE WHEN A2.NODE_LEVEL='一级节点' THEN A2.黄灯  ELSE 0 END ) AS 一级节点黄灯
,SUM(CASE WHEN A2.NODE_LEVEL='二级节点' THEN A2.黄灯  ELSE 0 END ) AS 二级节点黄灯
,SUM(CASE WHEN A2.NODE_LEVEL='三级节点' THEN A2.黄灯  ELSE 0 END ) AS 三级节点黄灯
,SUM(CASE WHEN A2.NODE_LEVEL='里程碑' THEN A2.红灯  ELSE 0 END ) AS 里程碑红灯
,SUM(CASE WHEN A2.NODE_LEVEL='一级节点' THEN A2.红灯  ELSE 0 END ) AS 一级节点红灯
,SUM(CASE WHEN A2.NODE_LEVEL='二级节点' THEN A2.红灯  ELSE 0 END ) AS 二级节点红灯
,SUM(CASE WHEN A2.NODE_LEVEL='三级节点' THEN A2.红灯  ELSE 0 END ) AS 三级节点红灯
   ,'TYPE_ORG' AS CTYPE
		
FROM 

(
SELECT      B1.ID AS PROJECTID,B1.PROJECT_NAME,B1.UNIT_ID AS ORGID,b1.UNIT_NAME AS ORGNAME 
,A.ID AS PLANID ,A.PLAN_NAME,A.PLAN_TYPE
	,A1.ID AS NODEID,A1.NODE_NAME,A1.NODE_LEVEL,A1.PLAN_END_DATE,A1.ACTUAL_END_DATE,A1.ESTIMATE_END_DATE
	,A1.STANDARD_SCORE,PNE.EXAMINATION_SCORE,PNE.NEW_EXAMINATION_SCORE
	,A1.COMPLETION_STANDARD,COMPLETION_RESULTS_REMARK
	, CASE WHEN  	TO_NUMBER( TO_CHAR(A1.PLAN_END_DATE,'MM'))=12 AND 	TO_NUMBER( TO_CHAR(A1.PLAN_END_DATE,'DD'))>25 THEN  TO_CHAR(TO_NUMBER( TO_CHAR(A1.PLAN_END_DATE,'YYYY') +1)) ELSE    TO_CHAR(A1.PLAN_END_DATE,'YYYY')  END AS  "PLANYEAR"
	, CASE WHEN  
	CASE
	WHEN
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END > 12 THEN
	1 ELSE
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END
	END 
	BETWEEN  1  AND 3 THEN 1
	WHEN

	CASE
	WHEN
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END > 12 THEN
	1 ELSE
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END
	END 

	BETWEEN 4  AND 6  THEN 2
	WHEN  
	CASE
	WHEN
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END > 12 THEN
	1 ELSE
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END
	END 


	BETWEEN 7 AND  9  THEN 3
	WHEN   
	CASE
	WHEN
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END > 12 THEN
	1 ELSE
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END
	END 

	BETWEEN 10 AND 12  THEN 4  END
	AS "PLANQUATOR"
	,CASE
	WHEN
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END > 12 THEN
	1 ELSE
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END
	END AS "PLANMOTH"
,CASE 
WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  
<= (CASE WHEN  A1.NODE_LEVEL IN ('里程碑','一级节点')   THEN 0 ELSE 3 END) 

THEN 1   ELSE  0  END AS "绿灯"
,D.APPROVAL_TIME
,CASE 
WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  
BETWEEN (CASE WHEN  A1.NODE_LEVEL IN ('里程碑','一级节点')   THEN 1 ELSE 4 END)   AND  (CASE WHEN  A1.NODE_LEVEL IN ('里程碑','一级节点')   THEN 5 ELSE 7 END)   

THEN 1   ELSE  0  END AS "黄灯"
,CASE 
WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  
>=     (CASE WHEN  A1.NODE_LEVEL IN ('里程碑','一级节点')   THEN 5 ELSE 8 END)   

THEN 1   ELSE  0  END AS "红灯"
 

FROM
POM_PROJ_PLAN A
INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
LEFT JOIN POM_NODE_EXAMINATION PNE ON A1.ID = PNE.NODE_ID
LEFT JOIN POM_NODE_FEEDBACK D ON D.FEEDBACK_NODE_ID=A1.ID AND  FEEDBACK_TYPE='CARRY_OUT' AND  D.APPROVAL_STATUS='已审核'
WHERE    A.APPROVAL_STATUS='已审核' AND  A1.IS_DELETE=0  
AND   A.COMPANY_NAME     in(  '中南公司','贵州公司')--中南公司、贵州公司
) A2

GROUP BY A2.ORGID,PLAN_TYPE,A2.ORGNAME,A2.PLANYEAR,A2.PLANQUATOR,A2.PLANMOTH
)A3  ON A3.ORGID=A4.ID
WHERE 1=1
AND A3.应完成>0 
--and  A4.PARENT_ID='003200000000000000000000000000'
-- AND    PLANYEAR=2020
-- AND ORGNAME in ('贵州公司','贵州地产总部')



-- AND  B1.PROJECT_NAME='重庆西派城'
--   SELECT * FROM  POM_PROJ_PLAN_NODE  where   ROWNUM<2


 ------------------------------------------------------------------------------------
 --查询项目
 ------------------------------------------------------------------------------------
UNION ALL 


 SELECT  
 row_number() over( PARTITION  BY A4.PARENT_ID  order by ROUND( CASE WHEN NVL(A3.应完成,0)>0 THEN nvl(已完成,0)/NVL(A3.应完成,0) ELSE 0 END *100,2) desc) as rank
 ,PLAN_TYPE AS  PLAN_TYPE

, A3.PROJECTID as ID  
,A4.ID AS    PARENT_ID  
,A3.PROJECT_NAME as ORG_NAME 
,LPAD( A3.SN, 4,'0') AS ORGCODE
,A3."PLANYEAR",A3."PLANQUATOR",A3."PLANMOTH",A3."应完成",A3."已完成",A3."SUMNODESCORE",A3."已完成总分",A3."动态得分",A3."里程碑应完成",A3."里程碑已完成",A3."一级节点应完成",A3."一级节点已完成",A3."二级节点应完成",A3."二级节点已完成",A3."三级节点应完成",A3."三级节点已完成",A3."里程碑绿灯",A3."一级节点绿灯",A3."二级节点绿灯",A3."三级节点绿灯",A3."里程碑黄灯",A3."一级节点黄灯",A3."二级节点黄灯",A3."三级节点黄灯",A3."里程碑红灯",A3."一级节点红灯",A3."二级节点红灯",A3."三级节点红灯",A3."CTYPE"
FROM 
SYS_BUSINESS_UNIT A4 LEFT JOIN
(

SELECT 
A2.PROJECT_NAME AS PROJECT_NAME,PLAN_TYPE,A2.SN ,A2.ORGID,  A2.PROJECTID ,A2.PLANYEAR,A2.PLANQUATOR,A2.PLANMOTH
,COUNT(A2.NODEID) AS 应完成
,SUM(CASE WHEN A2.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0   END ) AS 已完成
,SUM(A2.STANDARD_SCORE) AS SUMNODESCORE
,SUM(NVL(A2.EXAMINATION_SCORE,0)) AS 已完成总分
    /*动态得分情况*/
,SUM(NVL(A2.NEW_EXAMINATION_SCORE,0))   AS 动态得分
,SUM(CASE WHEN A2.NODE_LEVEL='里程碑' THEN 1 ELSE 0 END ) AS 里程碑应完成
,SUM(CASE WHEN A2.NODE_LEVEL='里程碑' AND  A2.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END ) AS 里程碑已完成
 ,SUM(CASE WHEN A2.NODE_LEVEL='一级节点' THEN 1 ELSE 0 END ) AS 一级节点应完成
,SUM(CASE WHEN A2.NODE_LEVEL='一级节点' AND A2.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END ) AS 一级节点已完成
 ,SUM(CASE WHEN A2.NODE_LEVEL='二级节点' THEN 1 ELSE 0 END ) AS 二级节点应完成
,SUM(CASE WHEN A2.NODE_LEVEL='"二级节点'  AND A2.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END ) AS 二级节点已完成
 ,SUM(CASE WHEN A2.NODE_LEVEL='三级节点' THEN 1 ELSE 0 END ) AS 三级节点应完成
,SUM(CASE WHEN A2.NODE_LEVEL='三级节点' AND A2.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END ) AS 三级节点已完成

,SUM(CASE WHEN A2.NODE_LEVEL='里程碑' THEN A2.绿灯  ELSE 0 END ) AS 里程碑绿灯
,SUM(CASE WHEN A2.NODE_LEVEL='一级节点' THEN A2.绿灯  ELSE 0 END ) AS 一级节点绿灯
,SUM(CASE WHEN A2.NODE_LEVEL='二级节点' THEN A2.绿灯  ELSE 0 END ) AS 二级节点绿灯
,SUM(CASE WHEN A2.NODE_LEVEL='三级节点' THEN A2.绿灯  ELSE 0 END ) AS 三级节点绿灯
,SUM(CASE WHEN A2.NODE_LEVEL='里程碑' THEN A2.黄灯  ELSE 0 END ) AS 里程碑黄灯
,SUM(CASE WHEN A2.NODE_LEVEL='一级节点' THEN A2.黄灯  ELSE 0 END ) AS 一级节点黄灯
,SUM(CASE WHEN A2.NODE_LEVEL='二级节点' THEN A2.黄灯  ELSE 0 END ) AS 二级节点黄灯
,SUM(CASE WHEN A2.NODE_LEVEL='三级节点' THEN A2.黄灯  ELSE 0 END ) AS 三级节点黄灯
,SUM(CASE WHEN A2.NODE_LEVEL='里程碑' THEN A2.红灯  ELSE 0 END ) AS 里程碑红灯
,SUM(CASE WHEN A2.NODE_LEVEL='一级节点' THEN A2.红灯  ELSE 0 END ) AS 一级节点红灯
,SUM(CASE WHEN A2.NODE_LEVEL='二级节点' THEN A2.红灯  ELSE 0 END ) AS 二级节点红灯
,SUM(CASE WHEN A2.NODE_LEVEL='三级节点' THEN A2.红灯  ELSE 0 END ) AS 三级节点红灯
   ,'TYPE_PROJTOP' AS CTYPE
		
FROM 

(
SELECT      B1.ID AS PROJECTID,B1.SN,B1.PROJECT_NAME,B1.UNIT_ID AS ORGID,b1.UNIT_NAME AS ORGNAME 
,A.ID AS PLANID ,A.PLAN_NAME,A.PLAN_TYPE
	,A1.ID AS NODEID,A1.NODE_NAME,A1.NODE_LEVEL,A1.PLAN_END_DATE,A1.ACTUAL_END_DATE,A1.ESTIMATE_END_DATE
	,A1.STANDARD_SCORE,PNE.EXAMINATION_SCORE,PNE.NEW_EXAMINATION_SCORE
	,A1.COMPLETION_STANDARD,COMPLETION_RESULTS_REMARK
	, CASE WHEN  	TO_NUMBER( TO_CHAR(A1.PLAN_END_DATE,'MM'))=12 AND 	TO_NUMBER( TO_CHAR(A1.PLAN_END_DATE,'DD'))>25 THEN  TO_CHAR(TO_NUMBER( TO_CHAR(A1.PLAN_END_DATE,'YYYY') +1)) ELSE    TO_CHAR(A1.PLAN_END_DATE,'YYYY')  END AS  "PLANYEAR"
	, CASE WHEN  
	CASE
	WHEN
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END > 12 THEN
	1 ELSE
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END
	END 
	BETWEEN  1  AND 3 THEN 1
	WHEN

	CASE
	WHEN
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END > 12 THEN
	1 ELSE
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END
	END 

	BETWEEN 4  AND 6  THEN 2
	WHEN  
	CASE
	WHEN
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END > 12 THEN
	1 ELSE
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END
	END 


	BETWEEN 7 AND  9  THEN 3
	WHEN   
	CASE
	WHEN
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END > 12 THEN
	1 ELSE
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END
	END 

	BETWEEN 10 AND 12  THEN 4  END
	AS "PLANQUATOR"
	,CASE
	WHEN
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END > 12 THEN
	1 ELSE
	CASE
	WHEN TO_CHAR( A1.PLAN_END_DATE, 'DD' ) > 25 THEN
	TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( A1.PLAN_END_DATE, 'MM' ) )
	END
	END AS "PLANMOTH"
,CASE 
WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  
<= (CASE WHEN  A1.NODE_LEVEL IN ('里程碑','一级节点')   THEN 0 ELSE 3 END) 

THEN 1   ELSE  0  END AS "绿灯"
,D.APPROVAL_TIME
,CASE 
WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  
BETWEEN (CASE WHEN  A1.NODE_LEVEL IN ('里程碑','一级节点')   THEN 1 ELSE 4 END)   AND  (CASE WHEN  A1.NODE_LEVEL IN ('里程碑','一级节点')   THEN 5 ELSE 7 END)   

THEN 1   ELSE  0  END AS "黄灯"
,CASE 
WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  
>=     (CASE WHEN  A1.NODE_LEVEL IN ('里程碑','一级节点')   THEN 5 ELSE 8 END)   

THEN 1   ELSE  0  END AS "红灯"
 

FROM
POM_PROJ_PLAN A
INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
LEFT JOIN POM_NODE_EXAMINATION PNE ON A1.ID = PNE.NODE_ID
LEFT JOIN POM_NODE_FEEDBACK D ON D.FEEDBACK_NODE_ID=A1.ID AND  FEEDBACK_TYPE='CARRY_OUT' AND  D.APPROVAL_STATUS='已审核'
WHERE   A.APPROVAL_STATUS='已审核' AND  A1.IS_DELETE=0  
) A2

GROUP BY A2.PROJECT_NAME ,PLAN_TYPE ,A2.SN ,A2.ORGID,  A2.PROJECTID ,A2.PLANYEAR,A2.PLANQUATOR,A2.PLANMOTH
)A3  ON A3.ORGID=A4.ID
WHERE 1=1
AND A3.应完成>0 

--and  A4.PARENT_ID='003200000000000000000000000000'
-- AND    PLANYEAR=2020
-- AND ORGNAME in ('贵州公司','贵州地产总部')
;

prompt
prompt Creating view V_POM_PJPLANRANK0528
prompt ==================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_POM_PJPLANRANK0528 AS
SELECT  
	row_number() over( PARTITION  BY A.PARENT_ID  order by ROUND( CASE WHEN NVL(B.应完成,0)>0 THEN nvl(已完成,0)/NVL(B.应完成,0) ELSE 0 END *100,2) desc) as rank ,
	'项目主项计划'AS  PLAN_TYPE,A.ID,A.PARENT_ID,A.ORG_NAME ,B.PLANYEAR	,B.PLANQUATOR,B.PLANMOTH
-- 		,NVL(B.本季度应完成,0) AS 本季度应完成
-- 		,NVL(B.本季度已完成,0) AS 本季度已完成
		,NVL(B.应完成,0) AS 应完成
		,NVL(B.已完成,0) AS 已完成
		/*动态得分情况*/
		,NVL(B.动态得分,0) AS 动态得分
-- 		,NVL(B.本季度动态得分,0) AS 本季度动态得分
		/*里程碑、一级节点完成情况*/
		,NVL(B.里程碑应完成,0) AS 里程碑应完成
		,NVL(B.里程碑已完成,0) AS 里程碑已完成
		,NVL(B.一级节点应完成,0) AS 一级节点应完成
		,NVL(B.一级节点已完成,0) AS 一级节点已完成
		,NVL(B.二级节点应完成,0) AS 二级节点应完成
		,NVL(B.二级节点已完成,0) AS 二级节点已完成
		,NVL(B.三级节点应完成,0) AS 三级节点应完成
		,NVL(B.三级节点已完成,0) AS 三级节点已完成
-- 		,NVL(B.本季度里程碑应完成,0) AS 本季度里程碑应完成
-- 		,NVL(B.本季度里程碑已完成,0) AS 本季度里程碑已完成
-- 		,NVL(B.本季度一级节点应完成,0) AS 本季度一级节点应完成
-- 		,NVL(B.本季度一级节点已完成,0) AS 本季度一级节点已完成
		/*亮点情况*/
		,NVL(B.里程碑绿灯,0) AS 里程碑绿灯
		,NVL(B.里程碑黄灯,0) AS 里程碑黄灯
		,NVL(B.里程碑红灯,0) AS 里程碑红灯
		,NVL(B.一级节点绿灯,0) AS 一级节点绿灯
		,NVL(B.一级节点黄灯,0) AS 一级节点黄灯
		,NVL(B.一级节点红灯,0) AS 一级节点红灯
		,NVL(B.二级节点绿灯,0) AS 二级节点绿灯
		,NVL(B.二级节点黄灯,0) AS 二级节点黄灯
		,NVL(B.二级节点红灯,0) AS 二级节点红灯
		,NVL(B.三级节点绿灯,0) AS 三级节点绿灯
		,NVL(B.三级节点黄灯,0) AS 三级节点黄灯
		,NVL(B.三级节点红灯,0) AS 三级节点红灯
		
-- 		,NVL(B.本季度里程碑绿灯,0) AS 本季度里程碑绿灯
-- 		,NVL(B.本季度里程碑黄灯,0) AS 本季度里程碑黄灯
-- 		,NVL(B.本季度里程碑红灯,0) AS 本季度里程碑红灯
-- 		,NVL(B.本季度一级节点绿灯,0) AS 本季度一级节点绿灯
-- 		,NVL(B.本季度一级节点黄灯,0) AS 本季度一级节点黄灯
-- 		,NVL(B.本季度一级节点红灯,0) AS 本季度一级节点红灯
-- 		,NVL(B.本季度二三级节点绿灯,0) AS 本季度二三级节点绿灯
-- 		,NVL(B.本季度二三级节点黄灯,0) AS 本季度二三级节点黄灯
-- 		,NVL(B.本季度二三级节点红灯,0) AS 本季度二三级节点红灯
	
	,'TYPE_ORG' AS CTYPE
FROM SYS_BUSINESS_UNIT A LEFT JOIN  (
 SELECT AB.ID,AB.PARENT_ID
 ,AB.PLANYEAR	,AB.PLANQUATOR,AB.PLANMOTH
-- 		,SUM(AB.本季度应完成) AS 本季度应完成
-- 		,SUM(AB.本季度已完成) AS 本季度已完成
		,SUM(AB.应完成) AS 应完成
		,SUM(AB.已完成) AS 已完成
		/*动态得分情况*/
		,SUM(AB.动态得分) AS 动态得分
-- 		,SUM(AB.本季度动态得分) AS 本季度动态得分
		/*里程碑、一级节点完成情况*/
		,SUM(AB.里程碑应完成) AS 里程碑应完成
		 ,SUM(AB.里程碑已完成) AS 里程碑已完成
		 ,SUM(AB.一级节点应完成) AS 一级节点应完成
		 ,SUM(AB.一级节点已完成) AS 一级节点已完成
		 ,SUM(AB.二级节点应完成) AS 二级节点应完成
		 ,SUM(AB.二级节点已完成) AS 二级节点已完成
		 ,SUM(AB.三级节点应完成) AS 三级节点应完成
		 ,SUM(AB.三级节点已完成) AS 三级节点已完成
	-- 									 ,NVL(B.本季度里程碑应完成,0) AS 本季度里程碑应完成
	-- 									 ,NVL(B.本季度里程碑已完成,0) AS 本季度里程碑已完成
	-- 									 ,NVL(B.本季度一级节点应完成,0) AS 本季度一级节点应完成
	-- 									 ,NVL(B.本季度一级节点已完成,0) AS 本季度一级节点已完成
		 /*亮点情况*/
		 ,SUM(AB.里程碑绿灯) AS 里程碑绿灯
		 ,SUM(AB.里程碑黄灯) AS 里程碑黄灯
		 ,SUM(AB.里程碑红灯) AS 里程碑红灯
		 ,SUM(AB.一级节点绿灯) AS 一级节点绿灯
		 ,SUM(AB.一级节点黄灯) AS 一级节点黄灯
		 ,SUM(AB.一级节点红灯) AS 一级节点红灯
		 ,SUM(AB.二级节点绿灯) AS 二级节点绿灯
		 ,SUM(AB.二级节点黄灯) AS 二级节点黄灯
		 ,SUM(AB.二级节点红灯) AS 二级节点红灯
		 ,SUM(AB.三级节点绿灯) AS 三级节点绿灯
		 ,SUM(AB.三级节点黄灯) AS 三级节点黄灯
		 ,SUM(AB.三级节点红灯) AS 三级节点红灯

-- 		,SUM(AB.本季度里程碑绿灯) AS 本季度里程碑绿灯
-- 		,SUM(AB.本季度里程碑黄灯) AS 本季度里程碑黄灯
-- 		,SUM(AB.本季度里程碑红灯) AS 本季度里程碑红灯
-- 		,SUM(AB.本季度一级节点绿灯) AS 本季度一级节点绿灯
-- 		,SUM(AB.本季度一级节点黄灯) AS 本季度一级节点黄灯
-- 		,SUM(AB.本季度一级节点红灯) AS 本季度一级节点红灯
-- 		,SUM(AB.本季度二三级节点绿灯) AS 本季度二三级节点绿灯
-- 		,SUM(AB.本季度二三级节点黄灯) AS 本季度二三级节点黄灯
-- 		,SUM(AB.本季度二三级节点红灯) AS 本季度二三级节点红灯
		 FROM  (
--  11
									 
									 SELECT    
									/*完成情况*/
-- 									 ,NVL(B.本季度应完成,0) AS 本季度应完成
-- 									 ,NVL(B.本季度已完成,0) AS 本季度已完成
										B.PLANYEAR
										,B.PLANQUATOR
										,B.PLANMOTH
									 ,NVL(B.应完成,0) AS 应完成
									 ,NVL(B.已完成,0) AS 已完成
									 /*动态得分情况*/
									 ,NVL(B.动态得分,0) AS 动态得分
-- 									 ,NVL(B.本季度动态得分,0) AS 本季度动态得分
									 /*里程碑、一级节点完成情况*/
									 ,NVL(B.里程碑应完成,0) AS 里程碑应完成
									 ,NVL(B.里程碑已完成,0) AS 里程碑已完成
									 ,NVL(B.一级节点应完成,0) AS 一级节点应完成
									 ,NVL(B.一级节点已完成,0) AS 一级节点已完成
									 ,NVL(B.二级节点应完成,0) AS 二级节点应完成
									 ,NVL(B.二级节点已完成,0) AS 二级节点已完成
									 ,NVL(B.三级节点应完成,0) AS 三级节点应完成
									 ,NVL(B.三级节点已完成,0) AS 三级节点已完成
-- 									 ,NVL(B.本季度里程碑应完成,0) AS 本季度里程碑应完成
-- 									 ,NVL(B.本季度里程碑已完成,0) AS 本季度里程碑已完成
-- 									 ,NVL(B.本季度一级节点应完成,0) AS 本季度一级节点应完成
-- 									 ,NVL(B.本季度一级节点已完成,0) AS 本季度一级节点已完成
									 /*亮点情况*/
									 ,NVL(B.里程碑绿灯,0) AS 里程碑绿灯
									 ,NVL(B.里程碑黄灯,0) AS 里程碑黄灯
									 ,NVL(B.里程碑红灯,0) AS 里程碑红灯
									 ,NVL(B.一级节点绿灯,0) AS 一级节点绿灯
									 ,NVL(B.一级节点黄灯,0) AS 一级节点黄灯
									 ,NVL(B.一级节点红灯,0) AS 一级节点红灯
									 ,NVL(B.二级节点绿灯,0) AS 二级节点绿灯
									 ,NVL(B.二级节点黄灯,0) AS 二级节点黄灯
									 ,NVL(B.二级节点红灯,0) AS 二级节点红灯
									 ,NVL(B.三级节点绿灯,0) AS 三级节点绿灯
									 ,NVL(B.三级节点黄灯,0) AS 三级节点黄灯
									 ,NVL(B.三级节点红灯,0) AS 三级节点红灯

-- 									 ,NVL(B.本季度里程碑绿灯,0) AS 本季度里程碑绿灯
-- 									 ,NVL(B.本季度里程碑黄灯,0) AS 本季度里程碑黄灯
-- 									 ,NVL(B.本季度里程碑红灯,0) AS 本季度里程碑红灯
-- 									 ,NVL(B.本季度一级节点绿灯,0) AS 本季度一级节点绿灯
-- 									 ,NVL(B.本季度一级节点黄灯,0) AS 本季度一级节点黄灯
-- 									 ,NVL(B.本季度一级节点红灯,0) AS 本季度一级节点红灯
-- 									 ,NVL(B.本季度二三级节点绿灯,0) AS 本季度二三级节点绿灯
-- 									 ,NVL(B.本季度二三级节点黄灯,0) AS 本季度二三级节点黄灯
-- 									 ,NVL(B.本季度二三级节点红灯,0) AS 本季度二三级节点红灯
									 ,CONNECT_BY_ROOT ID AS  ID ,CONNECT_BY_ROOT PARENT_ID  AS  PARENT_ID 
									 from   SYS_BUSINESS_UNIT A  LEFT JOIN 
									 ( 	 

									
									 SELECT  B1.UNIT_ID ,COUNT(A1.ID) AS "NODESUM"
									
								, TO_CHAR(A1.PLAN_END_DATE,'YYYY')	 AS  "PLANYEAR"
								, CASE WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '12-26'  AND '03-25'  THEN 1 
											 WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '03-26'  AND '06-25'  THEN 2 
											 WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '06-26'  AND '09-25'  THEN 3 
											 WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '09-26'  AND '12-25'  THEN 4  END
											AS "PLANQUATOR"   
								,CASE
												WHEN
												CASE
														WHEN TO_CHAR( PLAN_END_DATE, 'DD' ) > 25 THEN
														TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) ) 
													END > 12 THEN
										1 ELSE
									CASE
											WHEN TO_CHAR( PLAN_END_DATE, 'DD' ) > 25 THEN
											TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) ) 
										END 
										END AS "PLANMOTH" 
									,SUM(STANDARD_SCORE)   AS "SUMNODESCORE"
									 --完成规则
									 
							
										 

									 ------------------
									 /*任务*/
									 ------------------
									 ------
									, SUM(
										(CASE
											WHEN 
												TO_CHAR( A1.PLAN_END_DATE, 'YYYY-MM-DD' ) IS NOT NULL
									
											THEN		1 
											ELSE 0 
											END 
											) 
										) AS "应完成"
									,SUM( (CASE    	WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL  
							
									 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
										 THEN 		1	ELSE		0 END))   AS "已完成"

									,SUM(
									(CASE    
									--按时完成
											WHEN 
													TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
												
												 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
												AND  (TRUNC( A1.PLAN_END_DATE, 'DD' ) -TRUNC( D.APPROVAL_TIME, 'DD' ) )BETWEEN 0 AND 29 
											THEN 	A1.STANDARD_SCORE*1	
											--提前一个月完成
											WHEN 
													TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL 
													--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
													AND  (TRUNC( A1.PLAN_END_DATE, 'DD' ) -TRUNC( D.APPROVAL_TIME, 'DD' ) )>= 30   AND  A1.NODE_LEVEL='里程碑'      
											THEN 	A1.STANDARD_SCORE*1.2		
											WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
											
												 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
												AND  (TRUNC( A1.PLAN_END_DATE, 'DD' ) -TRUNC( D.APPROVAL_TIME, 'DD' ) )>= 30   AND  A1.NODE_LEVEL='一级节点'     
											THEN 	A1.STANDARD_SCORE*1.1		
											WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL 
										
												 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
												 
													AND  (TRUNC( A1.PLAN_END_DATE, 'DD' ) - TRUNC( D.APPROVAL_TIME, 'DD' ) )>= 30   AND  A1.NODE_LEVEL IN ('二级节点' ,'三级节点')     
											THEN 	A1.STANDARD_SCORE*1.0	
									--延时完成
									--里程碑、一级节点3天
									--二三级节点5天
									--延时完成
										WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
									
												 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
												 
												AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC(A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 1 AND 4 AND   A1.NODE_LEVEL IN ('里程碑' ,'一级节点')     
										THEN 	A1.STANDARD_SCORE*0.6
										WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
								
												 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
												 
												AND  ( TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC(A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 1 AND 3 AND A1.NODE_LEVEL IN ('二级节点' ,'三级节点')     
										THEN 	A1.STANDARD_SCORE*1.0
										WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
								
											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
												AND  ( TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC(A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 4 AND 7 AND A1.NODE_LEVEL IN ('二级节点' ,'三级节点')     
										THEN 	A1.STANDARD_SCORE*0.6
									--红灯
										WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
							
											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
											 
											AND  ( TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC(A1.PLAN_END_DATE, 'DD' )  )  >=5 AND    A1.NODE_LEVEL IN ('里程碑' ,'一级节点')     
										THEN 	A1.STANDARD_SCORE*0
										WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
									
											 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
											 
											AND  ( TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC(A1.PLAN_END_DATE, 'DD' )  )>=8  AND  A1.NODE_LEVEL IN ('二级节点' ,'三级节点')     
										THEN 	A1.STANDARD_SCORE*0
									ELSE	0 END
									)
									)   AS "动态得分"

									 ------------------
									 /*-里程碑完成情况*/
									 ------------------
									,SUM((CASE  WHEN   	 A1. NODE_LEVEL='里程碑'  		 
						
															THEN 	1	ELSE		0 END))   AS "里程碑应完成"
									,SUM((CASE  WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL  
															AND A1. NODE_LEVEL='里程碑' 		 
													    THEN 	1	ELSE		0 END))   AS "里程碑已完成"
									 ------------------
									 /*-一级节点完成情况*/
									 ------------------
									,SUM((CASE   WHEN  	 A1. NODE_LEVEL='一级节点'  				
															  THEN 	1	ELSE		0 END))   AS "一级节点应完成"
									,SUM((CASE   WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL 	
															AND A1. NODE_LEVEL='一级节点'  		
															     THEN 	1	ELSE		0 END))   AS "一级节点已完成"
									 ------------------
									 /*-二级节点完成情况*/
									 ------------------
									,SUM((CASE   WHEN  	 A1. NODE_LEVEL='二级节点'  				
															  THEN 	1	ELSE		0 END))   AS "二级节点应完成"
									,SUM((CASE   WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL 	
															AND A1. NODE_LEVEL='二级节点'  		
															     THEN 	1	ELSE		0 END))   AS "二级节点已完成"	
										 ------------------
									 /*-三级节点完成情况*/
									 ------------------
									,SUM((CASE   WHEN  	 A1. NODE_LEVEL='三级节点'  				
															  THEN 	1	ELSE		0 END))   AS "三级节点应完成"
									,SUM((CASE   WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL 	
															AND A1. NODE_LEVEL='三年级节点'  		
															     THEN 	1	ELSE		0 END))   AS "三级节点已完成"																			 
									 
										------------------
									 /*-里程碑亮灯情况*/
									 ------------------
									 ,SUM(CASE  
												WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
								
														--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
													AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  <= 0 AND    A1.NODE_LEVEL IN ('里程碑')     
												THEN 1

											 ELSE  0  END ) AS  "里程碑绿灯"
												
									 ,SUM(CASE  
												WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
											
														--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
													AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 1 AND 4 AND    A1.NODE_LEVEL IN ('里程碑')     
												THEN 1
											WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL
									
														--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
													AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 1 AND 4  AND    A1.NODE_LEVEL IN ('里程碑')     
												THEN 1		
										

											 ELSE  0  END ) AS  "里程碑黄灯"
												
												
									,SUM(CASE  
												WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
											
														--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
													AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=5 AND    A1.NODE_LEVEL IN ('里程碑')     
												THEN 1
											WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL
										
														--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
													AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=5 AND    A1.NODE_LEVEL IN ('里程碑')     
												THEN 1		
										

											 ELSE  0  END ) AS  "里程碑红灯"
												
												
									 
										------------------
									 /*一级节点亮灯情况*/
									 ------------------
									 ,SUM(CASE  
												WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
									
														--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
													AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  <= 0  AND    A1.NODE_LEVEL IN ('一级节点')     
												THEN 1

											 ELSE  0  END ) AS  "一级节点绿灯"
												
									 ,SUM(CASE  
												WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
								
														--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
													AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 1 AND 4 AND    A1.NODE_LEVEL IN ('一级节点')     
												THEN 1
											WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL
												 
														--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
													AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 1 AND 4  AND    A1.NODE_LEVEL IN ('一级节点')     
												THEN 1		
										

											 ELSE  0  END ) AS  "一级节点黄灯"
												
												
									,SUM(CASE  
												WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
											
														--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
													AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=5 AND    A1.NODE_LEVEL IN ('一级节点')     
												THEN 1
											WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL
												
														--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
													AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=5 AND    A1.NODE_LEVEL IN ('一级节点')     
												THEN 1		
										

											 ELSE  0  END ) AS  "一级节点红灯"
												
												
									 

										------------------
									 /*二级节点亮灯情况*/
									 ------------------
									 ,SUM(CASE  
												WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
							
														--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
													AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  <= 2 AND     A1.NODE_LEVEL IN ('二级节点')     
												THEN 1

											 ELSE  0  END ) AS  "二级节点绿灯"
												
									 ,SUM(CASE  
												WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
											
														--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
													AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 3 AND 7 AND    A1.NODE_LEVEL IN ('二级节点')      
												THEN 1
											WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL
						
														--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
													AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 3 AND 7  AND    A1.NODE_LEVEL IN  ('二级节点')     
												THEN 1		
										

											 ELSE  0  END ) AS  "二级节点黄灯"
												
												
									,SUM(CASE  
												WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
											
														--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
													AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=8 AND    A1.NODE_LEVEL IN  ('二级节点')    
												THEN 1
											WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL
											
														--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
													AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=8 AND    A1.NODE_LEVEL IN  ('二级节点')     
												THEN 1		
										

										ELSE  0  END ) AS  "二级节点红灯"

										------------------
									 /*三级节点亮灯情况*/
									 ------------------
									 ,SUM(CASE  
												WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
							
														--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
													AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  <= 2 AND     A1.NODE_LEVEL IN ('三级节点')     
												THEN 1

											 ELSE  0  END ) AS  "三级节点绿灯"
												
									 ,SUM(CASE  
												WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
											
														--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
													AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 3 AND 7 AND    A1.NODE_LEVEL IN ('三级节点')      
												THEN 1
											WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL
						
														--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
													AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 3 AND 7  AND    A1.NODE_LEVEL IN  ('三级节点')     
												THEN 1		
										

											 ELSE  0  END ) AS  "三级节点黄灯"
												
												
									,SUM(CASE  
												WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
											
														--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
													AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=8 AND    A1.NODE_LEVEL IN  ('三级节点')    
												THEN 1
											WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL
											
														--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
													AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=8 AND    A1.NODE_LEVEL IN  ('三级节点')     
												THEN 1		
										

										ELSE  0  END ) AS  "三级节点红灯"
										
									FROM 	
									POM_PROJ_PLAN A 
									INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
									INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
									INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID 
									LEFT JOIN POM_NODE_FEEDBACK D ON D.FEEDBACK_NODE_ID=A1.ID AND  FEEDBACK_TYPE='完成反馈' AND  D.APPROVAL_STATUS='已审核'
									WHERE  A.PLAN_TYPE='项目主项计划' AND  A.APPROVAL_STATUS='已审核'
									GROUP BY B1.UNIT_ID	, TO_CHAR(A1.PLAN_END_DATE,'YYYY')
									, CASE WHEN CASE 	WHEN TO_CHAR( PLAN_END_DATE, 'DD' ) > 25 THEN	TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) ) 
												END > 12 THEN	1 ELSE  CASE		WHEN TO_CHAR( PLAN_END_DATE, 'DD' ) > 25 THEN		TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) ) 
									END 	END 
									, CASE WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '12-26'  AND '03-25'  THEN 1 	 WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '03-26'  AND '06-25'  THEN 2 
									 WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '06-26'  AND '09-25'  THEN 3 		 WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '09-26'  AND '12-25'  THEN 4  END
	
										)  B ON  A.ID=B.UNIT_ID
										WHERE NVL(B.NODESUM,0)>0
									CONNECT  by PRIOR   A.ID= A.PARENT_ID
) AB
GROUP BY AB.ID,AB.PARENT_ID  ,AB.PLANYEAR	,AB.PLANQUATOR,AB.PLANMOTH
)B  ON  A.ID=B.ID 
WHERE  A.ORG_TYPE=0  --  AND  A.COMPANY_TYPE='5' AND  A.PARENT_ID='003200000000000000000000000000'
--
;

prompt
prompt Creating view V_POM_PJPLAN_EXM_SOCRE
prompt ====================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_POM_PJPLAN_EXM_SOCRE AS
SELECT  
 row_number() over( PARTITION  BY A4.PARENT_ID  order by ROUND( CASE WHEN NVL(A3.应完成,0)>0 THEN nvl(已完成,0)/NVL(A3.应完成,0) ELSE 0 END *100,2) desc) as rank
 ,PLAN_TYPE AS  PLAN_TYPE

, A3.PROJECTID as ID  
,A4.ID AS    PARENT_ID  
,A3.PROJECT_NAME as ORG_NAME 
,PROJECT_NAME as PROJECT_NAME
,LPAD( A3.SN, 4,'0') AS ORGCODE
,A3."PLANYEAR",A3."PLANQUATOR",A3."PLANMOTH",A3."应完成",A3."已完成",A3."SUMNODESCORE",A3."已完成总分",A3."动态得分",A3."里程碑应完成",A3."里程碑已完成",A3."一级节点应完成",A3."一级节点已完成",A3."二级节点应完成",A3."二级节点已完成",A3."三级节点应完成",A3."三级节点已完成",A3."里程碑绿灯",A3."一级节点绿灯",A3."二级节点绿灯",A3."三级节点绿灯",A3."里程碑黄灯",A3."一级节点黄灯",A3."二级节点黄灯",A3."三级节点黄灯",A3."里程碑红灯",A3."一级节点红灯",A3."二级节点红灯",A3."三级节点红灯",A3."CTYPE"
FROM 
SYS_BUSINESS_UNIT A4 LEFT JOIN
(

SELECT 
A2.PROJECT_NAME AS PROJECT_NAME,PLAN_TYPE,A2.SN ,A2.ORGID,  A2.PROJECTID ,A2.PLANYEAR,A2.PLANQUATOR,A2.PLANMOTH
,COUNT(A2.NODEID) AS 应完成
,SUM(CASE WHEN A2.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0   END ) AS 已完成
,SUM(A2.STANDARD_SCORE) AS SUMNODESCORE
,SUM(NVL(A2.EXAMINATION_SCORE,0)) AS 已完成总分
    /*动态得分情况*/
,SUM(NVL(A2.NEW_EXAMINATION_SCORE,0))   AS 动态得分
,SUM(CASE WHEN A2.NODE_LEVEL='里程碑' THEN 1 ELSE 0 END ) AS 里程碑应完成
,SUM(CASE WHEN A2.NODE_LEVEL='里程碑' AND  A2.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END ) AS 里程碑已完成
 ,SUM(CASE WHEN A2.NODE_LEVEL='一级节点' THEN 1 ELSE 0 END ) AS 一级节点应完成
,SUM(CASE WHEN A2.NODE_LEVEL='一级节点' AND A2.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END ) AS 一级节点已完成
 ,SUM(CASE WHEN A2.NODE_LEVEL='二级节点' THEN 1 ELSE 0 END ) AS 二级节点应完成
,SUM(CASE WHEN A2.NODE_LEVEL='"二级节点'  AND A2.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END ) AS 二级节点已完成
 ,SUM(CASE WHEN A2.NODE_LEVEL='三级节点' THEN 1 ELSE 0 END ) AS 三级节点应完成
,SUM(CASE WHEN A2.NODE_LEVEL='三级节点' AND A2.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END ) AS 三级节点已完成

,SUM(CASE WHEN A2.NODE_LEVEL='里程碑' THEN A2.绿灯  ELSE 0 END ) AS 里程碑绿灯
,SUM(CASE WHEN A2.NODE_LEVEL='一级节点' THEN A2.绿灯  ELSE 0 END ) AS 一级节点绿灯
,SUM(CASE WHEN A2.NODE_LEVEL='二级节点' THEN A2.绿灯  ELSE 0 END ) AS 二级节点绿灯
,SUM(CASE WHEN A2.NODE_LEVEL='三级节点' THEN A2.绿灯  ELSE 0 END ) AS 三级节点绿灯
,SUM(CASE WHEN A2.NODE_LEVEL='里程碑' THEN A2.黄灯  ELSE 0 END ) AS 里程碑黄灯
,SUM(CASE WHEN A2.NODE_LEVEL='一级节点' THEN A2.黄灯  ELSE 0 END ) AS 一级节点黄灯
,SUM(CASE WHEN A2.NODE_LEVEL='二级节点' THEN A2.黄灯  ELSE 0 END ) AS 二级节点黄灯
,SUM(CASE WHEN A2.NODE_LEVEL='三级节点' THEN A2.黄灯  ELSE 0 END ) AS 三级节点黄灯
,SUM(CASE WHEN A2.NODE_LEVEL='里程碑' THEN A2.红灯  ELSE 0 END ) AS 里程碑红灯
,SUM(CASE WHEN A2.NODE_LEVEL='一级节点' THEN A2.红灯  ELSE 0 END ) AS 一级节点红灯
,SUM(CASE WHEN A2.NODE_LEVEL='二级节点' THEN A2.红灯  ELSE 0 END ) AS 二级节点红灯
,SUM(CASE WHEN A2.NODE_LEVEL='三级节点' THEN A2.红灯  ELSE 0 END ) AS 三级节点红灯
   ,'TYPE_PROJTOP' AS CTYPE
		
FROM 

(
SELECT      B1.ID AS PROJECTID,B1.SN,B1.PROJECT_NAME,B1.UNIT_ID AS ORGID,b1.UNIT_NAME AS ORGNAME 
,A.ID AS PLANID ,A.PLAN_NAME,A.PLAN_TYPE
	,A1.ID AS NODEID,A1.NODE_NAME,A1.NODE_LEVEL,A1.PLAN_END_DATE,A1.ACTUAL_END_DATE,A1.ESTIMATE_END_DATE
	,A1.STANDARD_SCORE,nvl(PNE.EXAMINATION_SCORE,0) as EXAMINATION_SCORE ,nvl(PNE.NEW_EXAMINATION_SCORE,0) as NEW_EXAMINATION_SCORE
	,A1.COMPLETION_STANDARD,COMPLETION_RESULTS_REMARK
		,TO_CHAR(A1.PLAN_END_DATE,'YYYY')   AS  "PLANYEAR"
	,LPAD( TO_CHAR( A1.PLAN_END_DATE, 'Q' ),2,'0') 	AS "PLANQUATOR"
	,TO_CHAR( A1.PLAN_END_DATE, 'MM' ) AS "PLANMOTH"
,CASE 
WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  
<= (CASE WHEN  A1.NODE_LEVEL IN ('里程碑','一级节点')   THEN 0 ELSE 3 END) 

THEN 1   ELSE  0  END AS "绿灯"
,D.APPROVAL_TIME
,CASE 
WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  
BETWEEN (CASE WHEN  A1.NODE_LEVEL IN ('里程碑','一级节点')   THEN 1 ELSE 4 END)   AND  (CASE WHEN  A1.NODE_LEVEL IN ('里程碑','一级节点')   THEN 5 ELSE 7 END)   

THEN 1   ELSE  0  END AS "黄灯"
,CASE 
WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  
>=     (CASE WHEN  A1.NODE_LEVEL IN ('里程碑','一级节点')   THEN 5 ELSE 8 END)   

THEN 1   ELSE  0  END AS "红灯"
 

FROM
POM_PROJ_PLAN A
INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
LEFT JOIN POM_NODE_EXAMINATION PNE ON A1.ID = PNE.NODE_ID
LEFT JOIN POM_NODE_FEEDBACK D ON D.FEEDBACK_NODE_ID=A1.ID AND  FEEDBACK_TYPE='CARRY_OUT' AND  D.APPROVAL_STATUS='已审核'
WHERE   A.APPROVAL_STATUS='已审核' AND  A1.IS_DELETE=0  and a1.IS_DISABLE=0
--and  a1.FISSION_SOURCE_ORIGINAL_ID is null
) A2

GROUP BY A2.PROJECT_NAME ,PLAN_TYPE ,A2.SN ,A2.ORGID,  A2.PROJECTID ,A2.PLANYEAR,A2.PLANQUATOR,A2.PLANMOTH
)A3  ON A3.ORGID=A4.ID
WHERE 1=1
AND A3.应完成>0 

--and  A4.PARENT_ID='003200000000000000000000000000'
-- AND    PLANYEAR=2020
-- AND ORGNAME in ('贵州公司','贵州地产总部')
;

prompt
prompt Creating view V_POM_PJQUARTERPLAN_STATISTICS
prompt ============================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_POM_PJQUARTERPLAN_STATISTICS AS
SELECT
	row_number() over( PARTITION  BY A.PARENT_ID  order by ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100,2) desc) as rank ,LEVEL_RANK,
	A.ID,A.PARENT_ID,A.ORG_NAME,'' AS COMPANY_ID
	,NVL(B.NODESUM,0) AS NODESUM
	,nvl(ISFINISH,0) AS  ISFINISHTOTAL
	,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
	,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
	,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
		,NVL(ISDELAY,0) AS ISDELAY
	,ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
	,ROUND(CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
	,ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
	,'TYPE_ORG' AS CTYPE
    ,'' as "STAGEID"
FROM SYS_BUSINESS_UNIT A LEFT JOIN  (
 SELECT AB.ID,AB.PARENT_ID,SUM(AB.NODESUM) AS NODESUM,SUM(AB.ISFINISH) AS ISFINISH,SUM(AB.ONTIMEFINISH) AS ONTIMEFINISH,SUM(AB.ISDELAY) AS ISDELAY,SUM(AB.DELAYFINISH) AS DELAYFINISH,SUM(AB.ADVANCEFINISH) AS ADVANCEFINISH from  (
--  11

 SELECT    NVL(B.NODESUM,0) AS NODESUM
 ,NVL(B.ISFINISH,0) AS ISFINISH
 ,NVL(B.ONTIMEFINISH,0) AS ONTIMEFINISH
 ,NVL(B.DELAYFINISH,0) AS DELAYFINISH,ORG_NAME
 ,NVL(ADVANCEFINISH,0) AS AdvanceFINISH
  ,NVL(ISDELAY,0) AS ISDELAY
 ,ORG_NAME
 ,CONNECT_BY_ROOT ID AS  ID ,CONNECT_BY_ROOT PARENT_ID  AS  PARENT_ID
 from   SYS_BUSINESS_UNIT A  LEFT JOIN
 (
 SELECT  B1.UNIT_ID ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"

FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
 INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
WHERE  A.PLAN_TYPE='关键节点计划' AND  A.APPROVAL_STATUS='已审核'
AND A1. IS_DISABLE=0
 --判断季度
 AND A1.PLAN_END_DATE BETWEEN
 (	SELECT   ADD_MONTHS(M_END,-1)+1  FROM v_pom_month_quarter_year )  AND
 (	SELECT M_END  FROM v_pom_month_quarter_year)
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID
	)  B ON  A.ID=B.UNIT_ID
	WHERE NVL(B.NODESUM,0)>0
CONNECT  by PRIOR   A.ID= A.PARENT_ID
) AB
GROUP BY AB.ID,AB.PARENT_ID
)B  ON  A.ID=B.ID
WHERE  A.ORG_TYPE=0  AND     NVL(B.NODESUM,0) >0

UNION ALL
--顶级项目汇总有分期
SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,4
,B2.ID,B2.PARENT_ID,B2.PROJECT_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
  ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,/*'TYPE_PROJTOP' AS CTYPE*/CASE WHEN B3.STAGE_NAME LIKE '%无分期%' THEN 'TYPE_PROJLAST' else 'TYPE_PROJTOP' end as CTYPE
,b3."STAGEID" AS "STAGEID"
FROM(
 SELECT  B1.UNIT_ID AS PARENT_ID ,A.COMPANY_ID ,C1.PROJECT_ID AS ID,B1.PROJECT_NAME ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
,C1.PROJECT_ID
  --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"


 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='关键节点计划'AND  A.APPROVAL_STATUS='已审核' 

 AND A1. IS_DISABLE=0

 --判断季度
 AND A1.PLAN_END_DATE BETWEEN
 (	SELECT   ADD_MONTHS(M_END,-1)+1  FROM v_pom_month_quarter_year )  AND
 (	SELECT M_END  FROM v_pom_month_quarter_year) 
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID,A.COMPANY_ID ,PROJECT_NAME ,C1.PROJECT_ID	) B2
		LEFT JOIN (SELECT P2.PROJECT_ID,TO_CHAR(wm_concat(P2.STAGE_NAME)) AS STAGE_NAME,p2.id as "STAGEID" FROM SYS_PROJECT P1 LEFT JOIN SYS_PROJECT_STAGE P2 ON P1.ID = P2.PROJECT_ID GROUP BY P2.PROJECT_ID,p2.ID) B3 ON B2.PROJECT_ID = B3.PROJECT_ID
		where        NVL(B2.NODESUM,0)>0 AND  B3.STAGE_NAME    LIKE '%无分期%'


		UNION ALL
--顶级项目汇总无分期
SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,4
,B2.ID,B2.PARENT_ID,B2.PROJECT_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
  ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,/*'TYPE_PROJTOP' AS CTYPE*/CASE WHEN B3.STAGE_NAME LIKE '%无分期%' THEN 'TYPE_PROJLAST' else 'TYPE_PROJTOP' end as CTYPE
,'' as "STAGEID"
FROM(
 SELECT  B1.UNIT_ID AS PARENT_ID  ,A.COMPANY_ID,B1.ID,B1.PROJECT_NAME ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
,C1.PROJECT_ID
  --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"


 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='关键节点计划'AND  A.APPROVAL_STATUS='已审核'
  AND A1. IS_DISABLE=0

 --判断季度
 AND A1.PLAN_END_DATE BETWEEN
 (	SELECT   ADD_MONTHS(M_END,-1)+1  FROM v_pom_month_quarter_year )  AND
 (	SELECT M_END  FROM v_pom_month_quarter_year)
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID,A.COMPANY_ID,B1.ID,PROJECT_NAME ,C1.PROJECT_ID	) B2
		LEFT JOIN (SELECT P2.PROJECT_ID,TO_CHAR(wm_concat(P2.STAGE_NAME)) AS STAGE_NAME FROM SYS_PROJECT P1 LEFT JOIN SYS_PROJECT_STAGE P2 ON P1.ID = P2.PROJECT_ID GROUP BY P2.PROJECT_ID) B3 ON B2.PROJECT_ID = B3.PROJECT_ID
		where        NVL(B2.NODESUM,0)>0  AND  B3.STAGE_NAME not  LIKE '%无分期%'


		----分期汇总

UNION ALL
SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,5
,B2.ID,B2.PARENT_ID,B2.PROJSTAGE_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
 ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,'TYPE_PROJLAST' AS CTYPE
,B2."STAGEID"
FROM(
 SELECT  C1.PROJECT_ID AS PARENT_ID,A.COMPANY_ID  ,C1.ID,B1.PROJECT_NAME||'_'|| C1.STAGE_NAME AS  PROJSTAGE_NAME ,COUNT(A1.ID) AS "NODESUM"
  --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"
,C1.ID as "STAGEID"

 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='关键节点计划'    AND  A.APPROVAL_STATUS='已审核'
 AND A1. IS_DISABLE=0
    --判断季度
 AND A1.PLAN_END_DATE BETWEEN
 (	SELECT   ADD_MONTHS(M_END,-1)+1  FROM v_pom_month_quarter_year )  AND
 (	SELECT M_END  FROM v_pom_month_quarter_year)
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY C1.PROJECT_ID,C1.ID,A.COMPANY_ID,PROJECT_NAME, STAGE_NAME	) B2		where        NVL(B2.NODESUM,0)>0 AND B2.PROJSTAGE_NAME NOT LIKE '%无分期%'
;

prompt
prompt Creating view V_POM_PJYEARPLAN_STATISTICS
prompt =========================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_POM_PJYEARPLAN_STATISTICS AS
SELECT
	row_number() over( PARTITION  BY A.PARENT_ID  order by ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100,2) desc) as rank ,LEVEL_RANK,
	A.ID,A.PARENT_ID,A.ORG_NAME,'' AS COMPANY_ID
	,NVL(B.NODESUM,0) AS NODESUM
	,nvl(ISFINISH,0) AS  ISFINISHTOTAL
	,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
	,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
	,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
		,NVL(ISDELAY,0) AS ISDELAY
	,ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
	,ROUND(CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
	,ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
	,'TYPE_ORG' AS CTYPE
    ,'' as "STAGEID"
FROM SYS_BUSINESS_UNIT A LEFT JOIN  (
 SELECT AB.ID,AB.PARENT_ID,SUM(AB.NODESUM) AS NODESUM,SUM(AB.ISFINISH) AS ISFINISH,SUM(AB.ONTIMEFINISH) AS ONTIMEFINISH,SUM(AB.ISDELAY) AS ISDELAY,SUM(AB.DELAYFINISH) AS DELAYFINISH,SUM(AB.ADVANCEFINISH) AS ADVANCEFINISH from  (
--  11

 SELECT    NVL(B.NODESUM,0) AS NODESUM
 ,NVL(B.ISFINISH,0) AS ISFINISH
 ,NVL(B.ONTIMEFINISH,0) AS ONTIMEFINISH
 ,NVL(B.DELAYFINISH,0) AS DELAYFINISH,ORG_NAME
 ,NVL(ADVANCEFINISH,0) AS AdvanceFINISH
  ,NVL(ISDELAY,0) AS ISDELAY
 ,ORG_NAME
 ,CONNECT_BY_ROOT ID AS  ID ,CONNECT_BY_ROOT PARENT_ID  AS  PARENT_ID
 from   SYS_BUSINESS_UNIT A  LEFT JOIN
 (
 SELECT  B1.UNIT_ID ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"

FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
 INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
WHERE  A.PLAN_TYPE='关键节点计划' AND  A.APPROVAL_STATUS='已审核'
 AND A1. IS_DISABLE=0
	 --判断本年
 -- A1.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||'-12'||'-26','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||'-12'||'-25','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH)
 AND  A1.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||'-12'||'-26','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||'-12'||'-25','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH)
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID
	)  B ON  A.ID=B.UNIT_ID
	WHERE NVL(B.NODESUM,0)>0
CONNECT  by PRIOR   A.ID= A.PARENT_ID
) AB
GROUP BY AB.ID,AB.PARENT_ID
)B  ON  A.ID=B.ID
WHERE  A.ORG_TYPE=0  AND     NVL(B.NODESUM,0) >0

UNION ALL
--顶级项目汇总有分期
SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,4
,B2.ID,B2.PARENT_ID,B2.PROJECT_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
  ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,/*'TYPE_PROJTOP' AS CTYPE*/CASE WHEN B3.STAGE_NAME LIKE '%无分期%' THEN 'TYPE_PROJLAST' else 'TYPE_PROJTOP' end as CTYPE
,b3."STAGEID" AS "STAGEID"
FROM(
 SELECT  B1.UNIT_ID AS PARENT_ID ,A.COMPANY_ID ,C1.PROJECT_ID AS ID,B1.PROJECT_NAME ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
,C1.PROJECT_ID
  --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"


 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='关键节点计划'AND  A.APPROVAL_STATUS='已审核'
  AND A1. IS_DISABLE=0
 --判断本年

 AND  A1.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||'-12'||'-26','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||'-12'||'-25','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH)
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID,A.COMPANY_ID,PROJECT_NAME ,C1.PROJECT_ID	) B2
		LEFT JOIN (SELECT P2.PROJECT_ID,TO_CHAR(wm_concat(P2.STAGE_NAME)) AS STAGE_NAME,p2.id as "STAGEID" FROM SYS_PROJECT P1 LEFT JOIN SYS_PROJECT_STAGE P2 ON P1.ID = P2.PROJECT_ID GROUP BY P2.PROJECT_ID,p2.ID) B3 ON B2.PROJECT_ID = B3.PROJECT_ID
		where        NVL(B2.NODESUM,0)>0 AND  B3.STAGE_NAME    LIKE '%无分期%'


		UNION ALL
--顶级项目汇总无分期
SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,4
,B2.ID,B2.PARENT_ID,B2.PROJECT_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
  ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,/*'TYPE_PROJTOP' AS CTYPE*/CASE WHEN B3.STAGE_NAME LIKE '%无分期%' THEN 'TYPE_PROJLAST' else 'TYPE_PROJTOP' end as CTYPE
,'' as "STAGEID"
FROM(
 SELECT  B1.UNIT_ID AS PARENT_ID  ,A.COMPANY_ID,B1.ID,B1.PROJECT_NAME ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
,C1.PROJECT_ID
  --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"


 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='关键节点计划'AND  A.APPROVAL_STATUS='已审核'
  AND A1. IS_DISABLE=0
	 --判断本年

 AND  A1.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||'-12'||'-26','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||'-12'||'-25','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH)
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
		GROUP BY B1.UNIT_ID,A.COMPANY_ID,B1.ID,PROJECT_NAME ,C1.PROJECT_ID	) B2
		LEFT JOIN (SELECT P2.PROJECT_ID,TO_CHAR(wm_concat(P2.STAGE_NAME)) AS STAGE_NAME FROM SYS_PROJECT P1 LEFT JOIN SYS_PROJECT_STAGE P2 ON P1.ID = P2.PROJECT_ID GROUP BY P2.PROJECT_ID) B3 ON B2.PROJECT_ID = B3.PROJECT_ID
		where        NVL(B2.NODESUM,0)>0  AND  B3.STAGE_NAME not  LIKE '%无分期%'


		----分期汇总

UNION ALL
SELECT
 row_number() over( PARTITION  BY B2.PARENT_ID  order by ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) desc) as rank,5
,B2.ID,B2.PARENT_ID,B2.PROJSTAGE_NAME,COMPANY_ID
 ,NVL(B2.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
 ,NVL(ISDELAY,0) AS ISDELAY
, ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B2.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B2.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"
,'TYPE_PROJLAST' AS CTYPE
,B2."STAGEID"
FROM(
 SELECT  C1.PROJECT_ID AS PARENT_ID,A.COMPANY_ID  ,C1.ID,B1.PROJECT_NAME||'_'|| C1.STAGE_NAME AS  PROJSTAGE_NAME ,COUNT(A1.ID) AS "NODESUM"
  --完成规则
,SUM( (CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS   NULL AND  TRUNC(A1.PLAN_END_DATE)< TRUNC(SYSDATE)  THEN 		1	ELSE		0 END))   AS "ISDELAY"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL  THEN 		1	ELSE		0 END))   AS "ISFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <=TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ONTIMEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  <TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "ADVANCEFINISH"
,SUM((CASE    	WHEN TRUNC( A1.ACTUAL_END_DATE) IS NOT NULL AND TRUNC( A1.ACTUAL_END_DATE)  >TRUNC( PLAN_END_DATE)       THEN 		1	ELSE		0 END))   AS "DELAYFINISH"
,C1.ID as "STAGEID"

 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
 INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
 WHERE  A.PLAN_TYPE='关键节点计划'    AND  A.APPROVAL_STATUS='已审核'
  AND A1. IS_DISABLE=0
	 --判断本年

 AND A1.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||'-12'||'-26','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||'-12'||'-25','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH)
		GROUP BY C1.PROJECT_ID,C1.ID,A.COMPANY_ID,PROJECT_NAME, STAGE_NAME	) B2		where        NVL(B2.NODESUM,0)>0 AND B2.PROJSTAGE_NAME NOT LIKE '%无分期%'
;

prompt
prompt Creating view V_POM_PROJ_MONITOR_NODE_LIST
prompt ==========================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_POM_PROJ_MONITOR_NODE_LIST AS
SELECT 

NODEINFO.PROJ_ID
,NODEINFO.PROJ_NAME
,NODEINFO.PROJ_PLAN_ID
,NODEINFO.NODE_ID
,NODEINFO.PLAN_ID
,NODEINFO.PLAN_TYPE
,NODEINFO.ORIGINAL_NODE_ID
,NODEINFO.WARNING_STATUS
,NODEINFO.NODE_CODE
,NODEINFO.NODE_NAME
,NODEINFO.NODE_LEVEL
,NODEINFO.DUTY_DEPARTMENT
,DUTY_MANS 
,NODEINFO.FINISH_STATUS
,NODEINFO.STANDARD_SCORE
,NODEINFO.PLAN_START_DATE
,NODEINFO.PLAN_END_DATE
,NODEINFO.ACTUAL_START_DATE
,NODEINFO.ACTUAL_END_DATE
,NODEINFO.ESTIMATE_END_DATE
,NODEINFO.PROCESS_FEED_BACK_CON
,NODEINFO.FINISH_FEED_BACK_CON
,NODEINFO.OVERDUE_FEED_BACK_CON
,NODEINFO.NODE_FLAG
,NODEINFO.ESTIMATE_BEYOND_NODE_FLAG
,NODEINFO.COMPLETION_STANDARD
,NODEINFO.COMPLETION_RESULTS_REMARK

FROM (
SELECT A.PROJ_ID, A.PROJ_NAME, B.PROJ_PLAN_ID, B.ID AS NODE_ID /*任务ID*/,
			 A.ID AS PLAN_ID /*计划ID */, A.PLAN_TYPE /*计划类别*/, B.ORIGINAL_NODE_ID
			 /*节点原始ID*/, 
			  
				CASE WHEN NODE_LEVEL  in ('里程碑','一级节点') then  
				case 
 --未到期不亮灯
 WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''
 --到期当天内完成反馈
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
 then '绿灯'
  --到期1-5天内完成反馈
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
 then '绿灯'
 --到期未反馈黄灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE)) >0
 THEN  '黄灯'
  --到期超过5天未反馈红灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(PLAN_END_DATE)) >5) THEN  '红灯'
 ELSE '红灯' END
 
 else  
 
 case 
 --未到期不亮灯
 WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''
 --到期3天内完成反馈两天内
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 2
 then '绿灯'
  --到期3-8天内完成反馈
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 3 and 8
 then '黄灯'
 --到期8天内未反馈黄灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(PLAN_END_DATE)) BETWEEN 0 AND 8) 
 THEN   '黄灯'
  --到期超过8天未反馈红灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(PLAN_END_DATE)) > 8) THEN   '红灯'
 ELSE  '红灯' END
 end
 
 
 
			 


			 AS WARNING_STATUS, B.NODE_CODE AS NODE_CODE,
			 B.NODE_NAME AS NODE_NAME, B.NODE_LEVEL, B.DUTY_DEPARTMENT,
 
TO_CHAR(D.CHARGE_PERSON)
   AS DUTY_MANS,
			 CASE
					 WHEN
								B.ACTUAL_END_DATE IS NOT NULL THEN
						'已完成'
					 ELSE
						'未完成'
			 END AS FINISH_STATUS, B.STANDARD_SCORE, B.PLAN_START_DATE,
			 B.PLAN_END_DATE, B.ACTUAL_START_DATE AS ACTUAL_START_DATE,
			 B.ACTUAL_END_DATE, B.ESTIMATE_END_DATE AS ESTIMATE_END_DATE,
			 0 AS PROCESS_FEED_BACK_CON, 0 AS FINISH_FEED_BACK_CON,
			 0 AS OVERDUE_FEED_BACK_CON,
			 CASE
					 WHEN B.ACTUAL_END_DATE IS NOT NULL THEN
						'已完成'
					 WHEN (NVL(B.ACTUAL_END_DATE, SYSDATE) - B.PLAN_END_DATE) > 0 AND
								B.ACTUAL_END_DATE IS NULL THEN
						'超期未完成'
					 ELSE
						'正常'
			 END AS NODE_FLAG,
			 CASE
					 WHEN B.ESTIMATE_END_DATE > B.PLAN_END_DATE AND
								B.ACTUAL_END_DATE IS NULL THEN
						'是'
					 ELSE
						'否'
			 END AS ESTIMATE_BEYOND_NODE_FLAG,
			
			 B.COMPLETION_STANDARD, B.COMPLETION_RESULTS_REMARK
FROM   POM_PROJ_PLAN A
INNER  JOIN POM_PROJ_PLAN_NODE B
ON     A.ID = B.PROJ_PLAN_ID

LEFT   JOIN (SELECT M.NODE_ID,listagg(M.CHARGE_PERSON,',') WITHIN  GROUP (ORDER BY CHARGE_PERSON) 

AS CHARGE_PERSON
						 FROM   POM_NODE_CHARGE_PERSON M
						 GROUP  BY M.NODE_ID) D
ON     D.NODE_ID = B.ID

LEFT   JOIN (SELECT FEEDBACK_NODE_ORIGINAL_ID,
										SUM(CASE
														WHEN FEEDBACK_TYPE = '0' THEN
														 1
														ELSE
														 0
												END) AS PROCESS_FEED_BACK_CON,
										SUM(CASE
														WHEN FEEDBACK_TYPE = '1' THEN
														 1
														ELSE
														 0
												END) AS FINISH_FEED_BACK_CON,
										SUM(CASE
														WHEN FEEDBACK_TYPE = '2' THEN
														 1
														ELSE
														 0
												END) AS OVERDUE_FEED_BACK_CON
						 FROM   POM_NODE_FEEDBACK
						 GROUP  BY FEEDBACK_NODE_ORIGINAL_ID) E
ON     E.FEEDBACK_NODE_ORIGINAL_ID = B.ORIGINAL_NODE_ID
WHERE  A.APPROVAL_STATUS = '已审核' AND
			 A.PLAN_TYPE = '项目主项计划' AND
			 B.IS_DISABLE <> 1
			-- AND  B.id='1e0d1efe-dcc2-4232-9362-5cc4c324c4ab'
	) NODEINFO
-- 	WHERE  TRUNC( PLAN_END_DATE)-TRUNC(SYSDATE)<0 --超期 
-- 	WHERE  TRUNC( ESTIMATE_END_DATE)-TRUNC(SYSDATE)<0 --预计超期
;

prompt
prompt Creating view V_POM_PROJ_MONITOR_SUMMARYLIST
prompt ============================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_POM_PROJ_MONITOR_SUMMARYLIST AS
SELECT 

NODEINFO.PROJ_ID
,NODEINFO.PROJ_NAME
,NODEINFO.PROJ_PLAN_ID
,NODEINFO.NODE_ID
,NODEINFO.PLAN_ID
,NODEINFO.PLAN_TYPE
,NODEINFO.ORIGINAL_NODE_ID
,NODEINFO.WARNING_STATUS
,NODEINFO.NODE_CODE
,NODEINFO.NODE_NAME
,NODEINFO.NODE_LEVEL
,NODEINFO.DUTY_DEPARTMENT
,NODEINFO.DUTY_DEPARTMENT_ID
,DUTY_MANS 
,NODEINFO.FINISH_STATUS
,NODEINFO.STANDARD_SCORE
,NODEINFO.PLAN_START_DATE
,NODEINFO.PLAN_END_DATE
,NODEINFO.ACTUAL_START_DATE
,NODEINFO.ACTUAL_END_DATE
,NODEINFO.ESTIMATE_END_DATE
,NODEINFO.PROCESS_FEED_BACK_CON
,NODEINFO.FINISH_FEED_BACK_CON
,NODEINFO.OVERDUE_FEED_BACK_CON
,NODEINFO.NODE_FLAG
,NODEINFO.ESTIMATE_BEYOND_NODE_FLAG
,NODEINFO.COMPLETION_STANDARD
,NODEINFO.COMPLETION_RESULTS_REMARK

FROM (
SELECT A.PROJ_ID, A.PROJ_NAME, B.PROJ_PLAN_ID, B.ID AS NODE_ID /*任务ID*/,
			 A.ID AS PLAN_ID /*计划ID */, A.PLAN_TYPE /*计划类别*/, B.ORIGINAL_NODE_ID
			 /*节点原始ID*/, 

				CASE WHEN NODE_LEVEL  in ('里程碑','一级节点') then  
				case 
 --未到期不亮灯
 WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''
 --到期当天内完成反馈
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
 then '<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>'
  --到期1-5天内完成反馈
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
 then '<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>'
 --到期未反馈黄灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE)) >0
 THEN  '<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>'
  --到期超过5天未反馈红灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(PLAN_END_DATE)) >5) THEN  '<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'
 ELSE '<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>' END

 else  

 case 
 --未到期不亮灯
 WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''
 --到期3天内完成反馈两天内
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 2
 then '<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>'
  --到期3-8天内完成反馈
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 3 and 8
 then '<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>'
 --到期8天内未反馈黄灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(PLAN_END_DATE)) BETWEEN 0 AND 8) 
 THEN   '<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>'
  --到期超过8天未反馈红灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(PLAN_END_DATE)) > 8) THEN   '<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'
 ELSE '<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>' END
 end






			 AS WARNING_STATUS, B.NODE_CODE AS NODE_CODE,
			 B.NODE_NAME AS NODE_NAME, B.NODE_LEVEL, B.DUTY_DEPARTMENT,B.DUTY_DEPARTMENT_ID,

TO_CHAR(D.CHARGE_PERSON)
   AS DUTY_MANS,
			 CASE
					 WHEN
								B.ACTUAL_END_DATE IS NOT NULL THEN
						'已完成'
					 ELSE
						'未完成'
			 END AS FINISH_STATUS, B.STANDARD_SCORE, B.PLAN_START_DATE,
			 B.PLAN_END_DATE, B.ACTUAL_START_DATE AS ACTUAL_START_DATE,
			 B.ACTUAL_END_DATE, B.ESTIMATE_END_DATE AS ESTIMATE_END_DATE,
			 0 AS PROCESS_FEED_BACK_CON, 0 AS FINISH_FEED_BACK_CON,
			 0 AS OVERDUE_FEED_BACK_CON,
			 CASE
					 WHEN B.ACTUAL_END_DATE IS NOT NULL THEN
						'已完成'
					 WHEN (NVL(B.ACTUAL_END_DATE, SYSDATE) - B.PLAN_END_DATE) > 0 AND
								B.ACTUAL_END_DATE IS NULL THEN
						'超期未完成'
					 ELSE
						'正常'
			 END AS NODE_FLAG,
			 CASE
					 WHEN B.ESTIMATE_END_DATE > B.PLAN_END_DATE AND
								B.ACTUAL_END_DATE IS NULL THEN
						'是'
					 ELSE
						'否'
			 END AS ESTIMATE_BEYOND_NODE_FLAG,

			 B.COMPLETION_STANDARD, B.COMPLETION_RESULTS_REMARK
FROM   POM_PROJ_PLAN A
INNER  JOIN POM_PROJ_PLAN_NODE B
ON     A.ID = B.PROJ_PLAN_ID

LEFT   JOIN (SELECT M.NODE_ID,listagg(M.CHARGE_PERSON,',') WITHIN  GROUP (ORDER BY CHARGE_PERSON) 

AS CHARGE_PERSON
						 FROM   POM_NODE_CHARGE_PERSON M
						 GROUP  BY M.NODE_ID) D
ON     D.NODE_ID = B.ID

LEFT   JOIN (SELECT FEEDBACK_NODE_ORIGINAL_ID,
										SUM(CASE
														WHEN FEEDBACK_TYPE = '0' THEN
														 1
														ELSE
														 0
												END) AS PROCESS_FEED_BACK_CON,
										SUM(CASE
														WHEN FEEDBACK_TYPE = '1' THEN
														 1
														ELSE
														 0
												END) AS FINISH_FEED_BACK_CON,
										SUM(CASE
														WHEN FEEDBACK_TYPE = '2' THEN
														 1
														ELSE
														 0
												END) AS OVERDUE_FEED_BACK_CON
						 FROM   POM_NODE_FEEDBACK
						 GROUP  BY FEEDBACK_NODE_ORIGINAL_ID) E
ON     E.FEEDBACK_NODE_ORIGINAL_ID = B.ORIGINAL_NODE_ID
WHERE  A.APPROVAL_STATUS = '已审核' AND
			 A.PLAN_TYPE = '项目主项计划' AND
			 B.IS_DISABLE <> 1
	) NODEINFO
;

prompt
prompt Creating view V_POM_ROGPROJPLAN_STATISTICS
prompt ==========================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_POM_ROGPROJPLAN_STATISTICS AS
SELECT
  row_number() over( PARTITION  BY A.PARENT_ID  order by ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100,2) desc) as rank ,
 A.ID,A.PARENT_ID,A.ORG_NAME
 ,NVL(B.NODESUM,0) AS NODESUM
 ,nvl(ISFINISH,0) AS  ISFINISHTOTAL
 ,NVL(ONTIMEFINISH,0)AS ONTIMEFINISHTOTAL
 ,NVL(DELAYFINISH,0) AS DELAYFINISHTOTAL
 ,NVL(ADVANCEFINISH,0) AS ADVANCEFINISHTOTAL
, ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ISFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100,2) AS  "FINLISHRATE"
, ROUND(CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(DELAYFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END *100 ,2)AS  "DELAYFINISHRATE"
,ROUND( CASE WHEN NVL(B.NODESUM,0)>0 THEN nvl(ADVANCEFINISH,0)/NVL(B.NODESUM,0) ELSE 0 END*100,2) AS  "ADVANCEFINISHRATE"

FROM SYS_BUSINESS_UNIT A LEFT JOIN  (
 SELECT AB.ID,AB.PARENT_ID,SUM(AB.NODESUM) AS NODESUM,SUM(AB.ISFINISH) AS ISFINISH,SUM(AB.ONTIMEFINISH) AS ONTIMEFINISH,SUM(AB.DELAYFINISH) AS DELAYFINISH,SUM(AB.ADVANCEFINISH) AS ADVANCEFINISH from  (


 SELECT    NVL(B.NODESUM,0) AS NODESUM
 ,NVL(B.ISFINISH,0) AS ISFINISH
 ,NVL(B.ONTIMEFINISH,0) AS ONTIMEFINISH
 ,NVL(B.DELAYFINISH,0) AS DELAYFINISH,ORG_NAME
 ,NVL(ADVANCEFINISH,0) AS AdvanceFINISH
 ,ORG_NAME
 ,CONNECT_BY_ROOT ID AS  ID ,CONNECT_BY_ROOT PARENT_ID  AS  PARENT_ID
 from   SYS_BUSINESS_UNIT A  LEFT JOIN
 (
 SELECT  B1.UNIT_ID ,COUNT(A1.ID) AS "NODESUM"
 --完成规则
,SUM( (CASE      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL  THEN     1  ELSE    0 END))   AS "ISFINISH"
,SUM((CASE      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL AND TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD')  <=TO_CHAR( PLAN_END_DATE,'YYYY-MM-DD')       THEN     1  ELSE    0 END))   AS "ONTIMEFINISH"
,SUM((CASE      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL AND TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD')  <TO_CHAR( PLAN_END_DATE,'YYYY-MM-DD')       THEN     1  ELSE    0 END))   AS "ADVANCEFINISH"
,SUM((CASE      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL AND TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD')  >TO_CHAR( PLAN_END_DATE,'YYYY-MM-DD')       THEN     1  ELSE    0 END))   AS "DELAYFINISH"


 FROM
 POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID

 INNER  JOIN    SYS_PROJECT B1  ON  A.PROJ_ID=B1.ID
 --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
    GROUP BY B1.UNIT_ID
  )  B ON  A.ID=B.UNIT_ID
  WHERE NVL(B.NODESUM,0)>0
CONNECT  by PRIOR   A.ID= A.PARENT_ID
) AB
GROUP BY AB.ID,AB.PARENT_ID
)B  ON  A.ID=B.ID
;

prompt
prompt Creating view V_SYS_AREA_COMPANY_PROJ_TREE
prompt ==========================================
prompt
create or replace force view pom0813.v_sys_area_company_proj_tree as
select orgId,orgName,orgType,parentId,isCompany,orderCode,fullName from
(
select ID as orgId,STAGE_NAME as orgName,'11' as orgType,PROJECT_ID as parentId,'0' as isCompany,'' as orderCode,STAGE_FULL_NAME as fullName
from SYS_PROJECT_STAGE
UNION
select ID as orgId,PROJECT_NAME as orgName,'10' as orgType,UNIT_ID as parentId,'0' as isCompany,'' as orderCode,PROJECT_NAME as fullName
from SYS_PROJECT
UNION
select ID as orgId,ORG_NAME as orgName,'0' as orgType,PARENT_ID as parentId,'1' as isCompany,ORDER_CODE as orderCode,ORG_NAME  as fullName
from SYS_BUSINESS_UNIT where ORG_TYPE = 0 and COMPANY_TYPE = '5'
) t;

prompt
prompt Creating view V_SYS_DEPARTMENT
prompt ==============================
prompt
create or replace force view pom0813.v_sys_department as
select a.ID as departmentId ,a.ORG_NAME as departmentName,a.ORG_TYPE as orgType,a.PARENT_ID as companyId,
b.ORG_NAME as companyName,a.ORDER_CODE as orderCode from SYS_BUSINESS_UNIT  a
left join SYS_BUSINESS_UNIT  b on a.PARENT_ID = b.ID
where a.ORG_TYPE = 1;

prompt
prompt Creating view V_SYS_ORG_TREE
prompt ============================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_SYS_ORG_TREE AS
SELECT orgId,orgName,parentId,orgType,orderCode,isCompany,orderHierarchyCode from (
SELECT id as orgId ,ORG_NAME as orgName,PARENT_ID as parentId,ORG_TYPE as orgType,ORDER_CODE as orderCode,IS_COMPANY as isCompany,ORDER_HIERARCHY_CODE as orderHierarchyCode from SYS_BUSINESS_UNIT
union
SELECT ID as orgId, STATION_NAME  as orgName ,org_id as parentId, '2' as orgType,'1' as orderCode,0 as isCompany,'001' as orderHierarchyCode from SYS_STATION
) t;

prompt
prompt Creating view V_SYS_PROJECT
prompt ===========================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_SYS_PROJECT AS
SELECT
        a.id              AS org_id,
        stage_name        AS org_name,
        c.org_name as company_name,
        '11' AS org_type,
        project_id        AS parent_id,
        b.city_name       AS city_name,
        '' AS proj_code,
        1 AS is_end,
        stage_full_name   AS full_name,
        c.order_hierarchy_code
        || '.'
        || replace(lpad(b.sn, 3), ' ', '0')
        || '.'
        || replace(lpad(a.sn, 3), ' ', '0') AS sn,
        b.unit_id         AS company_id,
        b.id              AS project_id
    FROM
        sys_project_stage   a
        INNER JOIN sys_project         b ON a.project_id = b.id
        INNER JOIN sys_business_unit   c ON b.unit_id = c.id
        where stage_name<>'无分期'
    UNION
    SELECT
        a.id           AS orgid,
        project_name   AS orgname,
        c.org_name as company_name,
        '10' AS orgtype,
        unit_id        AS parentid,
        city_name      AS cityname,
        project_code   AS projcode,
        CASE
            WHEN b.project_id IS NULL THEN
                1
            ELSE
                0
        END AS isend,
        project_name   AS fullname,
        c.order_hierarchy_code
        || '.'
        || replace(lpad(a.sn, 3), ' ', '0'),
        a.unit_id      AS companyid,
        a.id           AS project_id
    FROM
        sys_project a
        LEFT JOIN (
            SELECT DISTINCT
                project_id
            FROM
                sys_project_stage
        ) b ON a.id = b.project_id
        INNER JOIN sys_business_unit c ON a.unit_id = c.id
    UNION
    SELECT
        a.id,
        org_name,
        a.org_name as company_name,
        org_type,
        parent_id,
        '' AS city_name,
        '' AS proj_code,
        CASE
            WHEN b.id IS NULL THEN
                1
            ELSE
                0
        END AS isend,
        org_name               AS full_name,
        order_hierarchy_code   AS sn,
        a.id,
        ''
    FROM
        sys_business_unit a
        LEFT JOIN (
            SELECT DISTINCT
                ( unit_id ) AS id
            FROM
                sys_project
        ) b ON a.id = b.id
    WHERE
        is_company = 1;

prompt
prompt Creating view V_SYS_PROJECTS
prompt ============================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_SYS_PROJECTS AS
SELECT ORGID, ORGNAME, ORGTYPE, PARENTID, CITYNAME, PROJCODE, FULLNAME
FROM   (SELECT ID AS ORGID, STAGE_NAME AS ORGNAME, '11' AS ORGTYPE,
								PROJECT_ID AS PARENTID, '' AS CITYNAME, '' AS PROJCODE,
								STAGE_FULL_NAME AS FULLNAME
				 FROM   SYS_PROJECT_STAGE
				 UNION
				 SELECT ID AS ORGID, PROJECT_NAME AS ORGNAME, '10' AS ORGTYPE,
								UNIT_ID AS PARENTID, CITY_NAME AS CITYNAME,
								PROJECT_CODE AS PROJCODE, PROJECT_NAME AS FULLNAME
				 FROM   SYS_PROJECT) T;

prompt
prompt Creating view V_SYS_PROJECT_STAGE_TREE
prompt ======================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_SYS_PROJECT_STAGE_TREE AS
SELECT a.id                                    AS org_id,
        stage_name                              AS org_name,
        '11'                                    AS org_type,
        project_id                              AS parent_id,
        b.city_name                             AS city_name,
        ''                                      AS proj_code,
        1                                       AS is_end,
        stage_full_name                         AS full_name,
        c.order_hierarchy_code
            || '.'
            || replace(lpad(b.sn, 3), ' ', '0')
            || '.'
            || replace(lpad(a.sn, 3), ' ', '0') AS sn,
        b.unit_id                               AS company_id,
        b.id                                    AS project_id
 FROM sys_project_stage a
          INNER JOIN sys_project b ON a.project_id = b.id
          INNER JOIN sys_business_unit c ON b.unit_id = c.id
 UNION
 SELECT a.id         AS orgid,
        project_name AS orgname,
        '10'         AS orgtype,
        unit_id      AS parentid,
        city_name    AS cityname,
        project_code AS projcode,
        CASE
            WHEN b.project_id IS NULL THEN
                1
            ELSE
                0
            END      AS isend,
        project_name AS fullname,
        c.order_hierarchy_code
            || '.'
            || replace(lpad(a.sn, 3), ' ', '0'),
        a.unit_id    AS companyid,
        a.id         AS project_id
 FROM sys_project a
          LEFT JOIN (
     SELECT DISTINCT project_id
     FROM sys_project_stage
 ) b ON a.id = b.project_id
          INNER JOIN sys_business_unit c ON a.unit_id = c.id
 UNION
 SELECT a.id,
        org_name,
        org_type,
        parent_id,
        ''                   AS city_name,
        ''                   AS proj_code,
        CASE
            WHEN b.id IS NULL THEN
                1
            ELSE
                0
            END              AS isend,
        org_name             AS full_name,
        order_hierarchy_code AS sn,
        a.id,
        ''
 FROM sys_business_unit a
          LEFT JOIN (
     SELECT DISTINCT (unit_id) AS id
     FROM sys_project
 ) b ON a.id = b.id
 WHERE is_company = 1;

prompt
prompt Creating view V_SYS_PROJECT_TREE
prompt ================================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_SYS_PROJECT_TREE AS
SELECT ORGID, ORGNAME, ORGTYPE, PARENTID, CITYNAME, PROJCODE, FULLNAME
FROM   (SELECT ID AS ORGID, STAGE_NAME AS ORGNAME, '11' AS ORGTYPE,
								PROJECT_ID AS PARENTID, '' AS CITYNAME, '' AS PROJCODE,
								STAGE_FULL_NAME AS FULLNAME
				 FROM   SYS_PROJECT_STAGE
				 UNION
				 SELECT ID AS ORGID, PROJECT_NAME AS ORGNAME, '10' AS ORGTYPE,
								UNIT_ID AS PARENTID, CITY_NAME AS CITYNAME,
								PROJECT_CODE AS PROJCODE, PROJECT_NAME AS FULLNAME
				 FROM   SYS_PROJECT
				 UNION
				 SELECT ID AS ORGID, ORG_NAME AS ORGNAME, '0' AS ORGTYPE,
								PARENT_ID AS PARENTID, '' AS CITYNAME, '' AS PROJCODE,
								ORG_NAME AS FULLNAME
				 FROM   SYS_BUSINESS_UNIT
				 WHERE  ORG_TYPE = 0) T
ORDER  BY PROJCODE;

prompt
prompt Creating view V_SYS_STATION
prompt ===========================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_SYS_STATION AS
SELECT A.ID AS STATIONID, A.STATION_NAME AS STATIONNAME, B.ID AS ORGID,
			 B.ORG_NAME AS ORGNAME, C.ID AS COMPANYID, C.ORG_NAME AS COMPANYNAME
FROM   SYS_STATION A
LEFT   JOIN SYS_BUSINESS_UNIT B
ON     B.ID = A.ORG_ID
LEFT   JOIN SYS_BUSINESS_UNIT C
ON     B.PARENT_ID = C.ID;

prompt
prompt Creating view V_SYS_USER
prompt ========================
prompt
create or replace force view pom0813.v_sys_user as
select SYS_USER.ID as USER_ID,SYS_USER.USER_NAME,SYS_USER.USER_CODE,SYS_STATION.ID as STATION_ID,SYS_STATION.STATION_NAME,
deptment.ID as departmentGUID,deptment.ORG_NAME as departmentName,
deptment.PARENT_ID as companyGUID,company.ORG_NAME as companyName
from SYS_USER  left join  SYS_STATION_TO_USER 
on SYS_USER.ID = SYS_STATION_TO_USER.USER_ID
left join SYS_STATION on SYS_STATION_TO_USER.STATION_ID = SYS_STATION.ID
left join SYS_BUSINESS_UNIT deptment on SYS_STATION.ORG_ID = deptment.ID
left join SYS_BUSINESS_UNIT company on deptment.PARENT_ID = company.ID;

prompt
prompt Creating view V_SYS_USER_TREE
prompt =============================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_SYS_USER_TREE AS
SELECT orgId,orgName,parentId,orgType,isCompany,orderCode,orderHierarchyCode
from (
  SELECT id as orgId ,ORG_NAME as orgName,PARENT_ID as parentId,ORG_TYPE as orgType,IS_COMPANY as isCompany,
         ORDER_CODE as orderCode,ORDER_HIERARCHY_CODE as orderHierarchyCode
  from SYS_BUSINESS_UNIT
  where ID != '000100000000000000000000000000' or ID != '000200000000000000000000000000'
  union
  SELECT ID as orgId, STATION_NAME  as orgName ,org_id as parentId, '2' as orgType,0 as isCompany,'88' as orderCode,
         '001' as orderHierarchyCode
  from SYS_STATION
  union
  SELECT a.ID as orgId, a.USER_NAME as orgName, b.STATION_ID as parentId, '4' as orgType,0 as isCompany,
         '99' as orderCode,'001' as orderHierarchyCode
  from SYS_USER a
  left JOIN SYS_STATION_TO_USER b on a.id = b.USER_ID
) t;

prompt
prompt Creating view V_SYS_ZTREES
prompt ==========================
prompt
CREATE OR REPLACE FORCE VIEW POM0813.V_SYS_ZTREES AS
SELECT ID AS ID, PARENT_FUNCTION_ID AS PID, FUNCTION_NAME AS NAME,
			 FUNCTION_URL AS PATH, 'true' AS OPEN, ICON AS ICON, T.IS_DISABLED,
			 CASE
					 WHEN PARENT_FUNCTION_ID IS NULL THEN
						'true'
					 ELSE
						'false'
			 END AS ISPARENT, SYSTEM_ID, ORDE_RHIERARCHY_CODE, 'function' AS TYPE
FROM   "SYS_FUNCTION" T
WHERE  IS_DISABLED = 0
UNION
SELECT ID AS ID, FUNCTION_ID AS PID, ACTION_NAME AS NAME, '' AS PATH,
			 '' AS ICON, 'false' AS OPEN, 0 AS IS_DISABLED, 'false' AS ISPARENT,
			 SYSTEM_ID, '' ORDE_RHIERARCHY_CODE, 'action' AS TYPE
FROM   SYS_ACTION
WHERE  FUNCTION_ID IS NOT NULL;

prompt
prompt Creating type VARCHAR2_LIST
prompt ===========================
prompt
CREATE OR REPLACE TYPE POM0813."VARCHAR2_LIST"                                                                          is varray (100) of VARCHAR2(100)
/

prompt
prompt Creating function FIND_IN_SET
prompt =============================
prompt
CREATE OR REPLACE FUNCTION POM0813."FIND_IN_SET" (piv_str1 varchar2, piv_str2 varchar2, p_sep varchar2 := ',')
RETURN NUMBER IS
  l_idx    number:=0; -- 用于计算piv_str2中分隔符的位置
  str      varchar2(500);  -- 根据分隔符截取的子字符串
  piv_str  varchar2(500) := piv_str2; -- 将piv_str2赋值给piv_str
  res      number:=0; -- 返回结果
  res_place      number:=0;-- 原字符串在目标字符串中的位置
BEGIN
-- 如果字段是null 则返回0
IF piv_str2 IS NULL THEN
  RETURN res;
END IF;
-- 如果piv_str中没有分割符，直接判断piv_str1和piv_str是否相等，相等 res_place=1
IF instr(piv_str, p_sep, 1) = 0 THEN
   IF piv_str = piv_str1 THEN
      res_place:=1;
      res:= res_place;
   END IF;
ELSE
 -- 循环按分隔符截取piv_str
LOOP
    l_idx := instr(piv_str,p_sep);
    --
    res_place := res_place + 1;
    -- 当piv_str中还有分隔符时
      IF l_idx > 0 THEN
      -- 截取第一个分隔符前的字段str
         str:= substr(piv_str,1,l_idx-1);
         -- 判断 str 和piv_str1 是否相等，相等则结束循环判断
         IF str = piv_str1 THEN
           res:= res_place;
           EXIT;
         END IF;
        piv_str := substr(piv_str,l_idx+length(p_sep));
      ELSE
      -- 当截取后的piv_str 中不存在分割符时，判断piv_str和piv_str1是否相等，相等 res=res_path
        IF piv_str = piv_str1 THEN
           res:= res_place;
        END IF;
        -- 无论最后是否相等，都跳出循环
        EXIT;
      END IF;
 END LOOP;
 -- 结束循环
 END IF;
 -- 返回res
 RETURN res;
END FIND_IN_SET;
/

prompt
prompt Creating function FIND_NODE_LEVEL
prompt =================================
prompt
CREATE OR REPLACE FUNCTION POM0813.FIND_NODE_LEVEL (originalplan_id IN VARCHAR2)
    RETURN NUMBER IS 
     LEVEL NUMBER(5);
     nodeL number(5):= 0; 
     msg clob := '1';
     TOTAL NUMBER(5):=0;
    BEGIN
     SELECT COUNT(*) INTO TOTAL FROM POM_PROJ_PLAN WHERE original_plan_id = originalplan_id;
      IF TOTAL>=2 THEN
               SELECT  wm_concat( NL.NODE_LEVEL ) into msg FROM
              (
                -- 最新版本
              SELECT distinct pn.ORIGINAL_plan_ID,pn.ORIGINAL_NODE_ID,pn.NODE_LEVEL,pn.NODE_NAME,pn.PLAN_START_DATE,pn.PLAN_END_DATE 
              FROM POM_PROJ_PLAN_NODE PN WHERE pn.is_disable = 0 AND PN.PROJ_PLAN_ID = 
              (SELECT  p.id from
                      (SELECT row_number() over(partition by original_plan_id order by plan_version desc) rn, PP.* FROM  POM_PROJ_PLAN pp) p 
               where rn = 1 AND p.original_plan_id = originalplan_id) 
               MINUS 
               -- 前一版本
              SELECT distinct pn1.ORIGINAL_plan_ID,pn1.ORIGINAL_NODE_ID,pn1.NODE_LEVEL,pn1.NODE_NAME,pn1.PLAN_START_DATE,pn1.PLAN_END_DATE FROM POM_PROJ_PLAN_NODE PN1 WHERE pn1.is_disable = 0 
              AND PN1.PROJ_PLAN_ID = 
              (select p1.ID from
                      (SELECT row_number() over(partition by original_plan_id order by plan_version desc) rn, PP1.* FROM  POM_PROJ_PLAN pp1) p1 
                where rn = 2 AND p1.original_plan_id = originalplan_id )
             ) NL;
             if msg like '%里程碑%' or msg like '%一级节点%'   then nodeL := 1;
                else nodeL := 2;
            end if;
        ELSE nodeL :=0;
        END IF;
        level := nodeL;
    RETURN (LEVEL);
 END FIND_NODE_LEVEL;
/

prompt
prompt Creating function FN_CN_NUMBER_CHAR_TO_NUMBER
prompt =============================================
prompt
create or replace function pom0813.FN_CN_NUMBER_CHAR_TO_NUMBER(str varchar2)
    return int
-- 中文数字字符转数值 如无(0) 一(1) 二(2)
as
    ret int := 0;
begin
    begin
        ret := TO_NUMBER(str);
    exception when others then
        ret :=
            case str when '一' then 1
                     when '二' then 2
                     when '三' then 3
                     when '四' then 4
                     when '五' then 5
                     when '六' then 6
                     when '七' then 7
                     when '八' then 8
                     when '九' then 9
                     when '十' then 10
                end;
    end;
    return ret;
end;
/

prompt
prompt Creating function FN_CONVERTDECIMALTOPERCENTAGE
prompt ===============================================
prompt
CREATE OR REPLACE FUNCTION POM0813.fn_ConvertDecimalToPercentage (
	DecimalNumber  IN number
)
RETURN varchar2 AUTHID current_user
AS
PercentageNumber varchar2(50);
BEGIN
	IF DecimalNumber IS NULL THEN
		PercentageNumber:='0.00%';
	ELSE
		PercentageNumber:= to_char(floor(DecimalNumber*100),'fm9999999990')||'%';
	END IF;
	RETURN PercentageNumber;
END;
/

prompt
prompt Creating function FN_DWM_DAY_CONVERT_MONTH
prompt ==========================================
prompt
CREATE OR REPLACE FUNCTION POM0813.FN_DWM_DAY_CONVERT_MONTH
(
  day IN NUMBER 
) RETURN VARCHAR2 AUTHID current_user AS 
resultStr varchar2(70);
BEGIN
    if day is null then
        resultStr:='';
    elsif day <= 31 then
        resultStr := day || '天';
    elsif day > 31 then
        resultStr := to_char(trunc(day / 31, 1) ,'fm9999999990.0')|| '月';
    end if;
  RETURN resultStr;
END FN_DWM_DAY_CONVERT_MONTH;
/

prompt
prompt Creating function FN_DWM_DEC_CONVERT_PCT
prompt ========================================
prompt
CREATE OR REPLACE FUNCTION POM0813.FN_DWM_DEC_CONVERT_PCT
(
  PARAM IN NUMBER 
) RETURN VARCHAR2 AUTHID current_user AS
resultStr varchar2(70);
BEGIN
--  resultStr := (PARAM * 100) || '%';
  if PARAM is null then resultStr := '0%';
  elsif PARAM = 0 then resultStr := '0%';
  else resultStr := to_char((PARAM * 100),'9999990') || '%';
  end if;
  resultStr := trim(resultStr);
  RETURN resultStr;
END FN_DWM_DEC_CONVERT_PCT;
/

prompt
prompt Creating function FN_DWM_DURATIONDAYSDEAL
prompt =========================================
prompt
CREATE OR REPLACE FUNCTION POM0813.Fn_DWM_DurationDaysDeal (
	startTime date,
    endTime date,
    param VARCHAR2
)
RETURN varchar2 AUTHID current_user
AS
resultStr varchar2(70);
resultStrHtml varchar2(70);
startDate date;
endDate date;
BEGIN
   if startTime is null or endTime is null then
         resultStrHtml:='';
         resultStr:='';
   else
        startDate:=to_date(to_char(startTime, 'YYYY-MM-DD'),'yyyy-mm-dd');
        endDate:=to_date(to_char(endTime, 'YYYY-MM-DD'),'yyyy-mm-dd');
             if startDate<endDate then
                    if  endDate-startDate>31 then
                        resultStr:='延误'||to_char(trunc(months_between(endDate,startDate),1))||'月首开';
                        resultStrHtml:='<span style="color:#FF0000;">'||resultStr||'</span>';
                    else
                             resultStr:='延误'||to_char(endDate-startDate)||'天首开';
                              if endDate-startDate>=7 then
                                 resultStrHtml:='<span style="color:#FF0000;">'||resultStr||'</span>';
                              else
                                 resultStrHtml:='<span style="color:#FF9900;">'||resultStr||'</span>';
                              end if;
                    end if;
            elsif startDate=endDate then
                resultStr:='按时完成';
                resultStrHtml:='<span style="color:#33CC99;">'||resultStr||'</span>';
            else 
                 if  startDate-endDate >31 then
                 resultStr:='提前'||to_char(trunc(months_between(startDate,endDate),1))||'月首开';
                 resultStrHtml:='<span style="color:#33CC99;">'||resultStr||'</span>';
                 else
                 resultStr:='提前'||to_char(startDate-endDate)||'天首开';
                 resultStrHtml:='<span style="color:#33CC99;">'||resultStr||'</span>';
                 end if;
            end if;
    end if;
    if   param = 'label'  then
    RETURN resultStrHtml;
    else
    RETURN resultStr;
    end if;
END;
/

prompt
prompt Creating function FN_DWM_FONT_COLOR
prompt ===================================
prompt
CREATE OR REPLACE FUNCTION POM0813.FN_DWM_FONT_COLOR
(
  PARAM IN VARCHAR2 
) RETURN VARCHAR2 AUTHID current_user AS
resultStr varchar2(300);
BEGIN
    resultStr := '<span style="color: #169BD5">' || PARAM || '</span>';
  RETURN resultStr;
END FN_DWM_FONT_COLOR;
/

prompt
prompt Creating function FN_DWM_FONT_LAYERED_COLOR
prompt ===========================================
prompt
CREATE OR REPLACE FUNCTION POM0813.FN_DWM_FONT_LAYERED_COLOR
(
  PARAM IN NUMBER 
, criticalPoint IN NUMBER 
) RETURN VARCHAR2 AUTHID current_user AS
resultStr varchar2(200);
BEGIN
  if PARAM = 0 then 
    resultStr := '<span style="color: #169BD5">' || '0%' || '</span>';
  elsif PARAM >= criticalPoint then
    resultStr := '<span style="color: #00CC66">' || trim(to_char((PARAM * 100),'99990')) || '%' || '</span>';
  elsif PARAM < criticalPoint then
    resultStr := '<span style="color: #169BD5">' || trim(to_char((PARAM * 100),'99990')) || '%' || '</span>';   
  end if;  
  RETURN resultStr;
END FN_DWM_FONT_LAYERED_COLOR;
/

prompt
prompt Creating function FN_DWM_MULTIPLE_AND_UNIT
prompt ==========================================
prompt
CREATE OR REPLACE FUNCTION POM0813.FN_DWM_MULTIPLE_AND_UNIT
(
  param IN NUMBER 
, Multiple IN NUMBER 
, unit IN VARCHAR2 
) RETURN VARCHAR2 AUTHID current_user AS 
resultStr varchar2(70);
BEGIN
  if param is null then resultStr := '0.00' || unit;
  elsif param = 0 then resultStr := '0.00' || unit;
  else resultStr := to_char((param / Multiple),'99999990.00') || unit;
  end if;
  resultStr := trim(resultStr);
  RETURN resultStr;
END FN_DWM_MULTIPLE_AND_UNIT;
/

prompt
prompt Creating function FN_DWM_RISKSUMMARYDEAL
prompt ========================================
prompt
CREATE OR REPLACE FUNCTION POM0813.Fn_DWM_RiskSummaryDeal (
	PlanTime date:='2020-3-24',
    NewPlanTime date:='2020-4-10',
    param VARCHAR2
)
RETURN varchar2 AUTHID current_user
AS
resultHtmlStr varchar2(200);
resultStr varchar2(200);
PlanDate date;
NewPlanDate date;
NowDate date;
BEGIN
NowDate:=to_date(to_char(sysdate, 'YYYY-MM-DD'),'yyyy-mm-dd');
if PlanTime is null and NewPlanTime is null then
         resultStr:='';
elsif  NewPlanTime is null then
     PlanDate:=to_date(to_char(PlanTime, 'YYYY-MM-DD'),'yyyy-mm-dd');
     if  NowDate<=PlanDate then 
         resultStr:='按时首开无风险';
         resultHtmlStr:='<span style="color:#33CC99;">'||resultStr||'</span>';
     else
         if  NowDate-PlanDate >31 then 
             resultStr:='已延时'||to_char(trunc(months_between(NowDate,PlanDate),1),'fm9999999990.0')||'月首开';
             resultHtmlStr:='<span style="color:#FF0000;">'||resultStr||'</span>';
        else
                 resultStr:='已延时'||to_char(NowDate-PlanDate)||'天首开';
                     if NowDate-PlanDate>=7 then
                        resultHtmlStr:='<span style="color:#FF0000;">'||resultStr||'</span>';
                    else
                        resultHtmlStr:='<span style="color:#FF9900;">'||resultStr||'</span>';
                    end if;
           end if;
    end if;
else
    PlanDate:=to_date(to_char(PlanTime, 'YYYY-MM-DD'),'yyyy-mm-dd');
    NewPlanDate:=to_date(to_char(NewPlanTime, 'YYYY-MM-DD'),'yyyy-mm-dd');
     if NewPlanDate=PlanDate then
         resultStr:='按时首开无风险';
         resultHtmlStr:='<span style="color:#33CC99;">'||resultStr||'</span>';
         if   param = 'label'  then
             RETURN resultHtmlStr;
        else
             RETURN resultStr;
        end if;
     end if;
   if PlanDate<NewPlanDate then
                    if  NewPlanDate-PlanDate>31 then
                        resultStr:='已延时'||to_char(trunc(months_between(NowDate,PlanDate),1),'fm9999999990.0')||'月首开，预计延时'||to_char(trunc(months_between(NewPlanDate,PlanDate),1),'fm9999999990.0')||'月首开';
                         resultHtmlStr:='<span style="color:#FF0000;">'||resultStr||'</span>';
                    else
                         if NewPlanDate-PlanDate>=7 then
                            resultStr:='已延时'||to_char(NowDate-PlanDate)||'天首开，预计延时'||to_char(NewPlanDate-PlanDate)||'天首开';
                             resultHtmlStr:='<span style="color:#FF0000;">'||resultStr||'</span>';
                          else
                             resultStr:='已延时'||to_char(NowDate-PlanDate)||'天首开，预计延时'||to_char(NewPlanDate-PlanDate)||'天首开';
                             resultHtmlStr:='<span style="color:#FF9900;">'||resultStr||'</span>';
                          end if;
                    end if;
            else 
                     if  PlanDate-NewPlanDate >31 then
                        resultStr:='提前'||to_char(trunc(months_between(PlanDate,NewPlanDate),1),'fm9999999990.0')||'月首开';
                        resultHtmlStr:='<span style="color:#33CC99;">'||resultStr||'</span>';
                     else
                        resultStr:='提前'||to_char(PlanDate-NewPlanDate)||'天首开';
                        resultHtmlStr:='<span style="color:#33CC99;">'||resultStr||'</span>';
                     end if;
            end if;
end if;
     if   param = 'label'  then
             RETURN resultHtmlStr;
        else
             RETURN resultStr;
        end if;
END;
/

prompt
prompt Creating function FN_DWN_AMOUNTTOBILLIONYUAN
prompt ============================================
prompt
CREATE OR REPLACE FUNCTION POM0813.FN_DWN_AmountToBillionYuan (
	money  IN number
)
RETURN varchar2 AUTHID current_user
AS
BillionYuan number;
BEGIN
	IF money IS NULL THEN
		BillionYuan:=0;
	ELSE
		BillionYuan:=trunc(money/100000000,4);
	END IF;
	RETURN to_char(BillionYuan,'fm9999999990.00')||'亿';
END;
/

prompt
prompt Creating function FN_DWN_AREATO1000SQUARE
prompt =========================================
prompt
CREATE OR REPLACE FUNCTION POM0813.FN_DWN_AreaTo1000Square (
	areaSquare  IN number
)
RETURN varchar AUTHID current_user
AS
Square number;
BEGIN
	IF areaSquare IS NULL THEN
		Square:=0;
	ELSE
		Square:=trunc(areaSquare/10000,2);
	END IF;
	RETURN to_char(Square,'fm9999999990.00')||'万方';
END;
/

prompt
prompt Creating function FN_GET_API_IP
prompt ===============================
prompt
CREATE OR REPLACE FUNCTION POM0813."FN_GET_API_IP" RETURN VARCHAR2
AS
BEGIN
	--正式环境id
/*	RETURN '10.22.2.25';*/
	
	
	--测试环境id
	RETURN '10.22.2.142';
END;
/

prompt
prompt Creating function FN_GET_API_KEY
prompt ================================
prompt
CREATE OR REPLACE FUNCTION POM0813."FN_GET_API_KEY" RETURN VARCHAR2
AS
BEGIN
	--计划运营正式api_key--
	/*RETURN '20e2976a-5ac7-4b71-8d8f-0357f49f08f4';*/
	
	--计划运营测试环境API_KEY
	RETURN 'aa916b68-36c3-4745-a897-dd2c5936b478' ;
	
END;
/

prompt
prompt Creating function FN_VARCHAR_TO_DATE
prompt ====================================
prompt
CREATE OR REPLACE FUNCTION POM0813."FN_VARCHAR_TO_DATE" (dateStr VARCHAR2,format VARCHAR2) return date is
BEGIN
	declare num date;
          query_sql varchar2(100);
    begin
      query_sql := 'select TO_DATE('||dateStr||','||format||') from dual';
      execute immediate query_sql into num;
      return num;
    end;
END FN_VARCHAR_TO_DATE;
/

prompt
prompt Creating function FN_VARCHAR_TO_NUMBER
prompt ======================================
prompt
CREATE OR REPLACE FUNCTION POM0813."FN_VARCHAR_TO_NUMBER" (SN VARCHAR2) return number is
begin
    declare num number;
            query_sql varchar2(100);
    begin
      query_sql := 'select to_number('||SN||') from dual';
      execute immediate query_sql into num;
      return num;
    end;
  end FN_VARCHAR_TO_NUMBER;
/

prompt
prompt Creating function GET_JUMP_URL_DOMAIN
prompt =====================================
prompt
CREATE OR REPLACE FUNCTION POM0813.GET_JUMP_URL_DOMAIN(DOMAIN_TYPE VARCHAR2, DOMAIN_ID VARCHAR2)
RETURN VARCHAR2
AS
--获取域名
--修改者：陈丽 20200626 兼容code
--日期：2020-03-31
BACK_ID VARCHAR2(36);
BEGIN
    SELECT APPLICATION_URL INTO BACK_ID FROM SYS_APPLICATION_TERMINAL 
    WHERE (UPPER(APPLICATION_ID) = UPPER(DOMAIN_ID)  or UPPER(APPLICATION_CODE)=UPPER(DOMAIN_ID))
    AND UPPER(APPLICATION_TERMINAL_CODE) = UPPER(DOMAIN_TYPE);
    RETURN BACK_ID;
END;
/

prompt
prompt Creating function GET_PYJM
prompt ==========================
prompt
CREATE OR REPLACE FUNCTION POM0813.GET_PYJM (P_NAME IN VARCHAR2)
    RETURN VARCHAR2
AS
    V_COMPARE   VARCHAR2 (100);
    V_RETURN    VARCHAR2 (4000);
BEGIN
    DECLARE
        FUNCTION F_NLSSORT (P_WORD IN VARCHAR2)
            RETURN VARCHAR2
        AS
        BEGIN
            RETURN NLSSORT (P_WORD, 'NLS_SORT=SCHINESE_PINYIN_M');
        END;
    BEGIN
        FOR I IN 1 .. LENGTH (P_NAME)
        LOOP
            V_COMPARE := F_NLSSORT (SUBSTR (P_NAME, I, 1));

            IF     V_COMPARE >= F_NLSSORT ('吖')
               AND V_COMPARE <= F_NLSSORT ('驁')
            THEN
                V_RETURN := V_RETURN || 'A';
            ELSIF     V_COMPARE >= F_NLSSORT ('八')
                  AND V_COMPARE <= F_NLSSORT ('簿')
            THEN
                V_RETURN := V_RETURN || 'B';
            ELSIF     V_COMPARE >= F_NLSSORT ('嚓')
                  AND V_COMPARE <= F_NLSSORT ('錯')
            THEN
                V_RETURN := V_RETURN || 'C';
            ELSIF     V_COMPARE >= F_NLSSORT ('咑')
                  AND V_COMPARE <= F_NLSSORT ('鵽')
            THEN
                V_RETURN := V_RETURN || 'D';
            ELSIF     V_COMPARE >= F_NLSSORT ('妸')
                  AND V_COMPARE <= F_NLSSORT ('樲')
            THEN
                V_RETURN := V_RETURN || 'E';
            ELSIF     V_COMPARE >= F_NLSSORT ('发')
                  AND V_COMPARE <= F_NLSSORT ('猤')
            THEN
                V_RETURN := V_RETURN || 'F';
            ELSIF     V_COMPARE >= F_NLSSORT ('旮')
                  AND V_COMPARE <= F_NLSSORT ('腂')
            THEN
                V_RETURN := V_RETURN || 'G';
            ELSIF     V_COMPARE >= F_NLSSORT ('妎')
                  AND V_COMPARE <= F_NLSSORT ('夻')
            THEN
                V_RETURN := V_RETURN || 'H';
            ELSIF     V_COMPARE >= F_NLSSORT ('丌')
                  AND V_COMPARE <= F_NLSSORT ('攈')
            THEN
                V_RETURN := V_RETURN || 'J';
            ELSIF     V_COMPARE >= F_NLSSORT ('咔')
                  AND V_COMPARE <= F_NLSSORT ('穒')
            THEN
                V_RETURN := V_RETURN || 'K';
            ELSIF     V_COMPARE >= F_NLSSORT ('垃')
                  AND V_COMPARE <= F_NLSSORT ('擽')
            THEN
                V_RETURN := V_RETURN || 'L';
            ELSIF     V_COMPARE >= F_NLSSORT ('嘸')
                  AND V_COMPARE <= F_NLSSORT ('椧')
            THEN
                V_RETURN := V_RETURN || 'M';
            ELSIF     V_COMPARE >= F_NLSSORT ('拏')
                  AND V_COMPARE <= F_NLSSORT ('瘧')
            THEN
                V_RETURN := V_RETURN || 'N';
            ELSIF     V_COMPARE >= F_NLSSORT ('筽')
                  AND V_COMPARE <= F_NLSSORT ('漚')
            THEN
                V_RETURN := V_RETURN || 'O';
            ELSIF     V_COMPARE >= F_NLSSORT ('妑')
                  AND V_COMPARE <= F_NLSSORT ('曝')
            THEN
                V_RETURN := V_RETURN || 'P';
            ELSIF     V_COMPARE >= F_NLSSORT ('七')
                  AND V_COMPARE <= F_NLSSORT ('裠')
            THEN
                V_RETURN := V_RETURN || 'Q';
            ELSIF     V_COMPARE >= F_NLSSORT ('亽')
                  AND V_COMPARE <= F_NLSSORT ('鶸')
            THEN
                V_RETURN := V_RETURN || 'R';
            ELSIF     V_COMPARE >= F_NLSSORT ('仨')
                  AND V_COMPARE <= F_NLSSORT ('蜶')
            THEN
                V_RETURN := V_RETURN || 'S';
            ELSIF     V_COMPARE >= F_NLSSORT ('侤')
                  AND V_COMPARE <= F_NLSSORT ('籜')
            THEN
                V_RETURN := V_RETURN || 'T';
            ELSIF     V_COMPARE >= F_NLSSORT ('屲')
                  AND V_COMPARE <= F_NLSSORT ('鶩')
            THEN
                V_RETURN := V_RETURN || 'W';
            ELSIF     V_COMPARE >= F_NLSSORT ('夕')
                  AND V_COMPARE <= F_NLSSORT ('鑂')
            THEN
                V_RETURN := V_RETURN || 'X';
            ELSIF     V_COMPARE >= F_NLSSORT ('丫')
                  AND V_COMPARE <= F_NLSSORT ('韻')
            THEN
                V_RETURN := V_RETURN || 'Y';
            ELSIF     V_COMPARE >= F_NLSSORT ('帀')
                  AND V_COMPARE <= F_NLSSORT ('咗')
            THEN
                V_RETURN := V_RETURN || 'Z';
            END IF;
        END LOOP;

        RETURN V_RETURN;
    END;
END;
/

prompt
prompt Creating function GET_UUID
prompt ==========================
prompt
CREATE OR REPLACE FUNCTION POM0813."GET_UUID" return varchar2 is
  v_uuid varchar(36);
begin
  v_uuid := lower(rawtohex(sys_guid()));
  v_uuid := substr(v_uuid, 1, 8) || '-' || substr(v_uuid, 9, 4) || '-' ||
            substr(v_uuid, 13, 4) || '-' || substr(v_uuid, 17, 4) || '-' ||
            substr(v_uuid, 21, 12);
  return v_uuid;
end get_uuid;
/

prompt
prompt Creating function IS_DATE
prompt =========================
prompt
CREATE OR REPLACE FUNCTION POM0813.IS_DATE(mydate   in   varchar2)
    RETURN NUMBER IS
    tmp    DATE;
BEGIN
  tmp := TO_DATE(nvl(mydate,'00'), 'yyyy-MM-dd');
  RETURN 1;
  EXCEPTION
     WHEN OTHERS THEN
         RETURN 0;
END;
/

prompt
prompt Creating function SPLITSTR
prompt ==========================
prompt
CREATE OR REPLACE FUNCTION POM0813.splitstr (str IN CLOB,
i IN NUMBER := 0, 
sep IN VARCHAR2 := ',' 
) 
RETURN VARCHAR2 
/************************************** 
* Function: 返回字符串被指定字符分割后的指定节点字符串。 
* Parameters: str: 待分割的字符串。 
i: 返回第几个节点。当i为0返回str中的所有字符，当i 超过可被分割的个数时返回空。 
sep: 分隔符，默认逗号，也可以指定字符或字符串。当指定的分隔符不存在于str中时返回sep中的字符。 
* Example: select splitstr('abc,def', 1) as str from dual; 得到 abc 
select splitstr('abc,def', 3) as str from dual; 得到 空 
**************************************/ 
IS 
t_i NUMBER; 
t_count NUMBER; 
t_str VARCHAR2 (4000); 
BEGIN 
IF i = 0 
THEN 
t_str := str; 
ELSIF INSTR (str, sep) = 0 
THEN 
t_str := sep; 
ELSE 
SELECT COUNT ( * ) 
INTO t_count 
FROM table (split (str, sep)); 
IF i <= t_count 
THEN 
SELECT str 
INTO t_str 
FROM (SELECT ROWNUM AS item, COLUMN_VALUE AS str 
FROM table (split (str, sep))) 
WHERE item = i; 
END IF; 
END IF; 
RETURN t_str; 
END;
/

prompt
prompt Creating function URL_ENCODE
prompt ============================
prompt
CREATE OR REPLACE FUNCTION POM0813.url_encode(urlEncode IN VARCHAR2)
  RETURN VARCHAR2 AS
BEGIN
  --utl_url.escape()该方法只能在函数中调用
  RETURN utl_url.escape(urlEncode, TRUE, 'utf-8');
END;
/

prompt
prompt Creating procedure CHENL_P_SYS_GET_COMPANY_TREE
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.chenl_p_sys_get_company_tree (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    data_auth_info   OUT              SYS_REFCURSOR
) AS
--获取公司树
--作者：谷国斌
--日期：2019/12/13
    rulevalue   VARCHAR2(50);
    authcount   INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    spid        VARCHAR2(36);--使用临时表的批次号
BEGIN
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;
--插入集团作为根节点

    INSERT INTO tmp_company_tree (
        id,
        org_id,
        org_name,
        org_type,
        parent_id,
        is_company,
        order_code
    )
        SELECT
            spid,
            id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_hierarchy_code
        FROM
            sys_business_unit
        WHERE
            id = '003200000000000000000000000000';

--获取隔离规则：

    SELECT
        isolation_rule_value
    INTO rulevalue
    FROM
        sys_data_auth_biz
    WHERE
        biz_obj_code = bizcode;

    IF rulevalue = '全集团' THEN
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                is_company,
                order_hierarchy_code
            FROM
                sys_business_unit
            WHERE
                is_company = 1;

    ELSE 
--插入本公司及其父级
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                is_company,
                order_hierarchy_code
            FROM
                sys_business_unit
            WHERE
                is_company = 1
            START WITH
                id = companyid
            CONNECT BY
                PRIOR parent_id = id;

--插入数据授权的数据：

        DECLARE
            ownerid     VARCHAR2(36);
            oenertype   NVARCHAR2(50);
            CURSOR cursor_company IS
            SELECT DISTINCT
                auth_owner_id,
                auth_owner_type
            FROM
                sys_data_auth
            WHERE
                auth_biz_code = bizcode
                AND is_disabled = 0;

        BEGIN   

            --打开游标
            OPEN cursor_company;
            LOOP
                FETCH cursor_company INTO
                    ownerid,
                    oenertype;
                EXIT WHEN cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                IF oenertype = '公司' OR oenertype = '集团' THEN
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                        AND id = companyid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF oenertype = '部门' THEN
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 0
                        AND id = deptid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                    INSERT INTO tmp_auth_owner (
                        id,
                        auth_owner_id,
                        auth_owner_type
                    ) VALUES (
                        spid,
                        ownerid,
                        oenertype
                    );

                END IF;

            END LOOP;

            CLOSE cursor_company;
        END;   

          --获取有权限的公司及其父级：            
        DBMS_OUTPUT.PUT_LINE('获取有权限的公司及其父级');
        DECLARE
            ownerid2 VARCHAR2(36);
            CURSOR cursor_auth IS
            SELECT
                auth_owner_id
            FROM
                tmp_auth_owner
            WHERE
                id = spid;

        BEGIN   

                    --打开游标
            OPEN cursor_auth;
            LOOP
                FETCH cursor_auth INTO ownerid2;
                
                EXIT WHEN cursor_auth%notfound;



                            --授权对象为公司：
                            --取授权公司的子级：
                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type IN (
                                    '公司',
                                    '集团'
                                )
                        )
                    CONNECT BY
                        PRIOR id = parent_id;


                            --取授权公司的父级：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type IN (
                                    '公司',
                                    '集团'
                                )
                        )
                    CONNECT BY
                        PRIOR parent_id = id;

                             --授权对应为部门：
                               --取授权部门的父级：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type = '部门'
                        )
                    CONNECT BY
                        PRIOR parent_id = id;
                --授权对应为项目：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT
                                unit_id
                            FROM
                                sys_project
                            WHERE
                                id IN (
                                    SELECT DISTINCT
                                        auth_scope_id
                                    FROM
                                        sys_data_auth
                                    WHERE
                                        auth_biz_code = bizcode
                                        AND is_disabled = 0
                                        AND auth_owner_id = ownerid2
                                        AND auth_scope_type = '项目'
                                        and auth_type='项目'
                                )
                        )
                    CONNECT BY
                        PRIOR parent_id = id;

            END LOOP;

            CLOSE cursor_auth;
        END;

    END IF;

    OPEN data_auth_info FOR SELECT DISTINCT
                               org_id       AS orgid,
                               org_name     AS orgname,
                               org_type     AS orgtype,
                               parent_id    AS parentid,
                               is_company   AS iscompany,
                               order_code   AS ordercode
                           FROM
                               tmp_company_tree
                           WHERE
                               id = spid
                           ORDER BY
                               order_code;

END chenl_p_sys_get_company_tree;
/

prompt
prompt Creating procedure P_DWM_SALE_RATE_PROJ
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_DWM_SALE_RATE_PROJ" (
    is_photograph    IN               NUMBER ,
    proj_base_spid   OUT              VARCHAR2
--    
--        ,proj_base out SYS_REFCURSOR
--         ,proj_plan out SYS_REFCURSOR
) AS
		--去化率项目基础数据刷新;作用=>去化率数据定时更新。
        --调用范围：P_DWM_SALE_RATE_BY_PROJ,P_DWM_SALE_RATE_BY_GRANULARITY,根据proj_base_spid使用tmp_proj_base数据
		--作者：陈丽
		--日期：2020-04-10
    spid VARCHAR2(36); --使用临时表的批次号
plan_stage VARCHAR2(360):= '1期,一期,无分期';
node_exhibit_open_type VARCHAR2(50):='node_exhibit_open';
node_plan_approval_type VARCHAR2(50):='node_plan_approval';
node_get_land_type VARCHAR2(50):='node_get_land';
node_start_work_type VARCHAR2(50):='node_start_work';
node_completed_permit_type VARCHAR2(50):='node_completed_permit';
node_project_open_type VARCHAR2(50):='node_project_open';

node_exhibit_open VARCHAR2(50):='988e38a7-77ef-77eb-e053-0100007f3dda';	--备注--展示区开放（含售楼部、样板间）
node_plan_approval VARCHAR2(50):='988e38a7-77fa-77eb-e053-0100007f3dda';	--备注--规划方案批复
node_get_land VARCHAR2(50):='988e38a7-77c3-77eb-e053-0100007f3dda';	--备注--土地获取
node_start_work VARCHAR2(50):='988e38a7-7813-77eb-e053-0100007f3dda';	--备注--首开楼栋基础开工
node_completed_permit VARCHAR2(50):='988e38a7-7878-77eb-e053-0100007f3dda';	--备注--竣工备案
node_project_open VARCHAR2(50):='988e38a7-7827-77eb-e053-0100007f3dda';	--备注--项目开盘
dwm_REMARK VARCHAR2(200):='测试-chenl';
sys_created date:=sysdate;
BEGIN
delete tmp_proj_related_date;
delete tmp_proj_base;
commit;
--------创建临时表批次号
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;  
--select * from (select obj_phase.*,row_number() over(partition by obj_id order by PHASE_ORDER desc) as order_num from obj_phase )obj_phase_order where order_num = 1
------------------------------------------------备注------------------------------------------------备注--展示区开放（含售楼部、样板间）
  INSERT INTO tmp_proj_related_date (id,project_id,project_date_type,plan_end_date,actual_end_date,estimate_end_date,remark)
    select spid,project_id,nType,plan_end_date,actual_end_date,estimate_end_date,node_name
    from (select obj.*,row_number() over(partition by project_id order by plan_end_date) as order_num 
    from ( 
    ----project_id分组正序取第一条
    SELECT spid,ps.project_id,node_exhibit_open_type as nType,plan_end_date,actual_end_date,estimate_end_date,nodestartsales.node_name
    FROM   pom_proj_plan plan 
    LEFT JOIN pom_proj_plan_node  nodestartsales ON plan.id = nodestartsales.PROJ_PLAN_ID  AND nodestartsales.standard_node_id = node_exhibit_open                           
    left join sys_project_stage  ps ON ps.id = plan.proj_id  and (ps.IS_FIRST_OPEN_PERIOD=1 or  stage_name IN (SELECT column_value FROM TABLE ( split(plan_stage) ))   )                        
        WHERE   plan.approval_status = '已审核'   AND plan.plan_type = '关键节点计划' and IS_DELETE=0 and IS_DISABLE=0 
        GROUP BY ps.project_id,plan_end_date,actual_end_date,estimate_end_date,node_name
    ---project_id分组正序取第一条
        )obj) where order_num = 1;  ------------------------------------------------备注
------------------------------------------------备注------------------------------------------------备注--规划方案批复
  INSERT INTO tmp_proj_related_date (id,project_id,project_date_type,plan_end_date,actual_end_date,estimate_end_date,remark)
    
    select spid,project_id,nType,plan_end_date,actual_end_date,estimate_end_date,node_name
    from (select obj.*,row_number() over(partition by project_id order by plan_end_date) as order_num 
    from ( 
    ----project_id分组正序取第一条
    SELECT spid,ps.project_id,node_plan_approval_type as nType,plan_end_date,actual_end_date,estimate_end_date,nodestartsales.node_name
    FROM   pom_proj_plan plan 
    LEFT JOIN pom_proj_plan_node  nodestartsales ON plan.id = nodestartsales.PROJ_PLAN_ID  AND nodestartsales.standard_node_id = node_plan_approval                           
    left join sys_project_stage  ps ON ps.id = plan.proj_id  and (ps.IS_FIRST_OPEN_PERIOD=1 or  stage_name IN (SELECT column_value FROM TABLE ( split(plan_stage) ))  )                         
        WHERE   plan.approval_status = '已审核'   AND plan.plan_type = '关键节点计划' and IS_DELETE=0 and IS_DISABLE=0 
        GROUP BY ps.project_id,plan_end_date,actual_end_date,estimate_end_date,node_name ------------------------------------------------备注
    ---project_id分组正序取第一条
        )obj) where order_num = 1;  

------------------------------------------------备注------------------------------------------------备注--土地获取
  INSERT INTO tmp_proj_related_date (id,project_id,project_date_type,plan_end_date,actual_end_date,estimate_end_date,remark)
     select spid,project_id,nType,plan_end_date,actual_end_date,estimate_end_date,node_name
    from (select obj.*,row_number() over(partition by project_id order by plan_end_date) as order_num 
    from ( 
    ----project_id分组正序取第一条
    
    SELECT spid,ps.project_id,node_get_land_type as nType,plan_end_date,actual_end_date,estimate_end_date,nodestartsales.node_name
    FROM   pom_proj_plan plan 
    LEFT JOIN pom_proj_plan_node  nodestartsales ON plan.id = nodestartsales.PROJ_PLAN_ID  AND nodestartsales.standard_node_id = node_get_land                           
    left join sys_project_stage  ps ON ps.id = plan.proj_id  and (ps.IS_FIRST_OPEN_PERIOD=1 or  stage_name IN (SELECT column_value FROM TABLE ( split(plan_stage) ))     )                      
        WHERE   plan.approval_status = '已审核'   AND plan.plan_type = '关键节点计划' and IS_DELETE=0 and IS_DISABLE=0 
        GROUP BY ps.project_id,plan_end_date,actual_end_date,estimate_end_date,node_name   ------------------------------------------------备注
    ---project_id分组正序取第一条
        )obj) where order_num = 1;  
------------------------------------------------备注------------------------------------------------备注--首开楼栋基础开工
  INSERT INTO tmp_proj_related_date (id,project_id,project_date_type,plan_end_date,actual_end_date,estimate_end_date,remark)
     select spid,project_id,nType,plan_end_date,actual_end_date,estimate_end_date,node_name
    from (select obj.*,row_number() over(partition by project_id order by plan_end_date) as order_num 
    from ( 
    ----project_id分组正序取第一条
    
    SELECT spid,ps.project_id,node_start_work_type as nType,plan_end_date,actual_end_date,estimate_end_date,nodestartsales.node_name
    FROM   pom_proj_plan plan 
    LEFT JOIN pom_proj_plan_node  nodestartsales ON plan.id = nodestartsales.PROJ_PLAN_ID  AND nodestartsales.standard_node_id = node_start_work                           
    left join sys_project_stage  ps ON ps.id = plan.proj_id  and (ps.IS_FIRST_OPEN_PERIOD=1 or  stage_name IN (SELECT column_value FROM TABLE ( split(plan_stage) ))  )                         
        WHERE   plan.approval_status = '已审核'   AND plan.plan_type = '关键节点计划' and IS_DELETE=0 and IS_DISABLE=0 
        GROUP BY ps.project_id,plan_end_date,actual_end_date,estimate_end_date,node_name   ------------------------------------------------备注
 ---project_id分组正序取第一条
        )obj) where order_num = 1;  
------------------------------------------------备注------------------------------------------------备注--竣工备案
  INSERT INTO tmp_proj_related_date (id,project_id,project_date_type,plan_end_date,actual_end_date,estimate_end_date,remark)
     select spid,project_id,nType,plan_end_date,actual_end_date,estimate_end_date,node_name
    from (select obj.*,row_number() over(partition by project_id order by plan_end_date) as order_num 
    from ( 
    ----project_id分组正序取第一条
    
    SELECT spid,ps.project_id,node_completed_permit_type as nType,plan_end_date,actual_end_date,estimate_end_date,nodestartsales.node_name
    FROM   pom_proj_plan plan 
    LEFT JOIN pom_proj_plan_node  nodestartsales ON plan.id = nodestartsales.PROJ_PLAN_ID  AND nodestartsales.standard_node_id = node_completed_permit                           
    left join sys_project_stage  ps ON ps.id = plan.proj_id  and (ps.IS_FIRST_OPEN_PERIOD=1 or  stage_name IN (SELECT column_value FROM TABLE ( split(plan_stage) ))  )                         
        WHERE   plan.approval_status = '已审核'   AND plan.plan_type = '关键节点计划'
        and fission_source_original_id is null  and IS_DELETE=0 and IS_DISABLE=0 
        GROUP BY ps.project_id,plan_end_date,actual_end_date,estimate_end_date,node_name   ------------------------------------------------备注
 ---project_id分组正序取第一条
        )obj) where order_num = 1;  
------------------------------------------------备注------------------------------------------------备注--项目开盘
  INSERT INTO tmp_proj_related_date (id,project_id,project_date_type,plan_end_date,actual_end_date,estimate_end_date,remark)
       select spid,project_id,nType,plan_end_date,actual_end_date,estimate_end_date,node_name
    from (select obj.*,row_number() over(partition by project_id order by plan_end_date) as order_num 
    from ( 
    ----project_id分组正序取第一条
    
    SELECT spid,ps.project_id,node_project_open_type as nType,plan_end_date,actual_end_date,estimate_end_date,nodestartsales.node_name
    FROM   pom_proj_plan plan 
    LEFT JOIN pom_proj_plan_node  nodestartsales ON plan.id = nodestartsales.PROJ_PLAN_ID  AND nodestartsales.standard_node_id = node_project_open                           
    left join sys_project_stage  ps ON ps.id = plan.proj_id  and (ps.IS_FIRST_OPEN_PERIOD=1 or  stage_name IN (SELECT column_value FROM TABLE ( split(plan_stage) ))  )                         
        WHERE   plan.approval_status = '已审核'   AND plan.plan_type = '关键节点计划'  and IS_DELETE=0 and IS_DISABLE=0 
        GROUP BY ps.project_id,plan_end_date,actual_end_date,estimate_end_date,node_name   ------------------------------------------------备注
 ---project_id分组正序取第一条
        )obj) where order_num = 1;  


    INSERT INTO tmp_proj_base (
        ID,--主键
        PROJECT_ID,--项目ID
        PROJECT_NAME,--项目名称
        ORG_ID,--所属事业部ID
        ORG_NAME,--所属事业部
        FIRST_OPEN_DATE,--首开日期
        OBTAIN_DATE,--项目获得日期
        COMPLETION_RECORD_DATE,--首次竣备日期
        TAKE_LAND_DATE,--拿地日期
        PLAN_FIRST_OPEN_DATE,--计划首开日期
        FIRST_OPEN_DURATION_BY_PLAN,--原计划首开时长(10-9)
        FIRST_OPEN_DURATION_BY_TL,--拿地至首开时长(6-9)
        NEW_PLAN_FIRST_OPEN_DATE,--最新预计首开日期
        EXHIBITION_AREA_OPEN_DATE,--展示区开放日期
        EXHIBITION_AREA_OPEN_BY_PLAN,--展示区开放计划日期
        PLAN_APPROVAL_DATE,--方案批复日期
        PLAN_APPROVAL_DATE_BY_PLAN,--方案批复计划日期
        IS_OPERATE,--是否操盘
        IS_CONSTRUCTION_BEGAN,--是否已开工
        
        CREATED,--创建日期
        REMARK--备注信息
    )
        SELECT
            spid                          AS id,
            project.project_original_id   AS project_id,--项目ID
            project.project_name          AS project_name,--项目名称
            project.company_id            AS org_id,--所属事业部ID
            project.company_name          AS org_name,--所属事业部
            node_project_open1.actual_end_date     AS first_open_date,--实际首开时间----1
            node_get_land1.actual_end_date      AS obtain_date,--项目获取日期
            node_completed_permit1.actual_end_date     AS first_completion_record_date,--首次竣备日期------2
            node_get_land1.actual_end_date     AS take_land_date,--拿地日期----3
            node_project_open1.plan_end_date     AS plan_first_open_date,--计划首开日期-----4
            node_project_open1.plan_end_date - node_get_land1.actual_end_date AS first_open_duration_by_plan,--原计划首开时长
            node_project_open1.actual_end_date - node_get_land1.actual_end_date AS first_open_duration_by_tl,--拿地至首开时间
            node_project_open1.estimate_end_date      AS new_plan_first_open_date,--最新预计首开日期----5
            node_exhibit_open1.actual_end_date     AS exhibition_area_open_date,--实际展示区开放时间---6
            node_exhibit_open1.plan_end_date ,--计划展示区开放时间----7
            node_plan_approval1.actual_end_date     AS plan_approval_date,--方案批复时间----7
            node_plan_approval1.plan_end_date  ,--计划方案批复时间----7 
            CASE
                WHEN project.proj_cooperate = '操盘' THEN
                    1
                ELSE
                    0
            END AS is_operate,--as project.PROJ_COOPERATE 是否操盘
            CASE
                WHEN node_start_work1.actual_end_date is not null THEN
                    1
                ELSE
                    0
            END     AS is_construction_began,--是否开工----7
          
            sys_created,
            '测试' AS remark
        FROM
            mdm_project             project  
--备注--展示区开放（含售楼部、样板间）	
LEFT JOIN tmp_proj_related_date   node_exhibit_open1 ON project.project_original_id = node_exhibit_open1.project_id AND node_exhibit_open1.project_date_type = node_exhibit_open_type
--备注--规划方案批复	
LEFT JOIN tmp_proj_related_date   node_plan_approval1 ON project.project_original_id = node_plan_approval1.project_id AND node_plan_approval1.project_date_type = node_plan_approval_type
--备注--土地获取	
LEFT JOIN tmp_proj_related_date   node_get_land1 ON project.project_original_id = node_get_land1.project_id AND node_get_land1.project_date_type = node_get_land_type
--备注--首开楼栋基础开工	
LEFT JOIN tmp_proj_related_date   node_start_work1 ON project.project_original_id = node_start_work1.project_id AND node_start_work1.project_date_type = node_start_work_type
--备注--竣工备案	
LEFT JOIN tmp_proj_related_date   node_completed_permit1 ON project.project_original_id = node_completed_permit1.project_id AND node_completed_permit1.project_date_type = node_completed_permit_type
--备注--项目开盘	
LEFT JOIN tmp_proj_related_date   node_project_open1 ON project.project_original_id = node_project_open1.project_id AND node_project_open1.project_date_type = node_project_open_type
WHERE project.approval_status = '已审核';

    IF is_photograph <> 0 THEN
--先删除，历史的项目数据，后插入新的数据
        DELETE FROM dwm_sale_rate_project  where CREATED<sys_created;

        INSERT INTO dwm_sale_rate_project (
            ID,--主键
        PROJECT_ID,--项目ID
        PROJECT_NAME,--项目名称
        ORG_ID,--所属事业部ID
        ORG_NAME,--所属事业部
        FIRST_OPEN_DATE,--首开日期
        OBTAIN_DATE,--项目获得日期
        COMPLETION_RECORD_DATE,--首次竣备日期
        TAKE_LAND_DATE,--拿地日期
        PLAN_FIRST_OPEN_DATE,--计划首开日期
        FIRST_OPEN_DURATION_BY_PLAN,--原计划首开时长(10-9)
        FIRST_OPEN_DURATION_BY_TL,--拿地至首开时长(6-9)
        NEW_PLAN_FIRST_OPEN_DATE,--最新预计首开日期
        EXHIBITION_AREA_OPEN_DATE,--展示区开放日期
        EXHIBITION_AREA_OPEN_BY_PLAN,--展示区开放计划日期
        PLAN_APPROVAL_DATE,--方案批复日期
        PLAN_APPROVAL_DATE_BY_PLAN,--方案批复计划日期
        IS_OPERATE,--是否操盘
        IS_CONSTRUCTION_BEGAN,--是否已开工
        HAS_FIRST_PHASE_KEY_PLAN,--是否已上线关键节点计划
        CREATED,--创建日期
        REMARK--备注信息
        )
            SELECT
        get_uuid,
        base.PROJECT_ID,--项目ID
        base.PROJECT_NAME,--项目名称
        base.ORG_ID,--所属事业部ID
        base.ORG_NAME,--所属事业部
        base.FIRST_OPEN_DATE,--首开日期
        base.OBTAIN_DATE,--项目获得日期
        base.COMPLETION_RECORD_DATE,--首次竣备日期
        base.TAKE_LAND_DATE,--拿地日期
        base.PLAN_FIRST_OPEN_DATE,--计划首开日期
        base.FIRST_OPEN_DURATION_BY_PLAN,--原计划首开时长(10-9)
        base.FIRST_OPEN_DURATION_BY_TL,--拿地至首开时长(6-9)
        base.NEW_PLAN_FIRST_OPEN_DATE,--最新预计首开日期
        base.EXHIBITION_AREA_OPEN_DATE,--展示区开放日期
        base.EXHIBITION_AREA_OPEN_BY_PLAN,--展示区开放计划日期
        base.PLAN_APPROVAL_DATE,--方案批复日期
        base.PLAN_APPROVAL_DATE_BY_PLAN,--方案批复计划日期
        base.IS_OPERATE,--是否操盘
        base.IS_CONSTRUCTION_BEGAN,--是否已开工
        CASE
                WHEN FIRST_OPEN.id is not null THEN
                    1
                ELSE
                    0
        END     AS is_FIRST_OPEN,--是否已上关键节点计划 
        base.CREATED,--创建日期
        dwm_REMARK--备注信息
    FROM tmp_proj_base base
    left join (SELECT ps.id,ps.project_id
    FROM  sys_project_stage  ps
    left join   pom_proj_plan plan  ON ps.id = plan.proj_id  where  ps.IS_FIRST_OPEN_PERIOD=1
    and  plan.approval_status = '已审核'   AND plan.plan_type = '关键节点计划')
    FIRST_OPEN on  base.PROJECT_ID= FIRST_OPEN.project_id 
            WHERE
                base.id = spid;
    commit;
    END IF;
--open proj_base for
--select * from tmp_proj_base;
--open proj_plan for
--select a.*,p.project_name from (
--select project_id,project_date_type,count(*) from tmp_proj_related_date group by project_id,project_date_type
--order by count(*)) a left join sys_project p on a.project_id=p.id
--where a.project_id='b425a08a-9b71-4ab3-801c-48746ac2e2dd';

    proj_base_spid := spid;
END P_DWM_SALE_RATE_PROJ;
/

prompt
prompt Creating procedure CL_P_DWM_SALE_RATE_BY_GRA
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."CL_P_DWM_SALE_RATE_BY_GRA" (
    spid_info   OUT  SYS_REFCURSOR,
    t_room_info   OUT  SYS_REFCURSOR ,
    spid_tree_info   OUT  SYS_REFCURSOR,
    info OUT  SYS_REFCURSOR
) AS
		--业态面积段颗粒度去化率；作用=》定时任务拍照
		--作者：陈丽
		--日期：2020-04-10
  PROJ_BASE_SPID VARCHAR2(2000);
  sys_created date:=sysdate;
  spid VARCHAR2(360); --使用临时表的批次号
  spid_tree VARCHAR2(360); --使用临时表的批次号
  dwm_REMARK VARCHAR2(200):='测试-chenl';
  ----------------------
  v_sql clob;
  v_sql_start VARCHAR2(2000):= ' case ';
  v_sql_content clob:= '';
  v_sql_end VARCHAR2(2000):= '  else ''主数据面积段外'' end  ';
BEGIN
delete TMP_ROOM;
delete TMP_SALE_RATE_BY_GRANULARITY;
---------------------------
--------------------------------------------------------创建临时表批次号
    SELECT
        get_uuid(),get_uuid()
    INTO spid,spid_tree
    FROM
        dual;  
---------------------------------------------计算业态面积段1.拼接查询语句
 FOR item IN (
   select 
    ' when '||l.lower_limit_value||l.lower_limit_type||'room.NEW_BLD_AREA and room.NEW_BLD_AREA '||l.upper_limit_type||l.upper_limit_value
    ||' and (case when room.PRODUCT_NAME<>''住宅'' then ''商铺及其他'' else ''住宅'' end)='''||p.attribute_name||''' then ''' ||l.attribute_name||''' ' as aa,
    l.upper_limit_type,
    l.lower_limit_type,
    l.upper_limit_value,
    p.attribute_name as ptype from mdm_attribute_area_level l
    left join mdm_attribute_area_level p on l.parent_id=p.id 
    where p.id is not null
        ) LOOP 
    ---拼接字符串
         v_sql_content := v_sql_content||item.aa;
        END LOOP;
    --规则内容大于0才拼规则语句
        IF length(v_sql_content) > 0 THEN
            v_sql := v_sql_start
                     || v_sql_content
                     || v_sql_end;
        ELSE
            v_sql := '''''';
        END IF;

       v_sql:= 'INSERT INTO TMP_ROOM(id,room_ID,BLD_AREA,ROOM_NAME,PRODUCT_NAME,AREA_LEVEL) select '''||spid||''',id,NEW_BLD_AREA,room_name,case when room.product_name<>''住宅'' then ''商铺及其他'' else ''住宅'' end,'
       ||v_sql|| ' as NODE_WARNING from mdm_room room';
         dbms_output.put_line(v_sql);
       execute immediate v_sql;

        OPEN t_room_info FOR select * from TMP_ROOM;  
-----------------------------------------------项目基本信息
BEGIN
  P_DWM_SALE_RATE_PROJ(0,
    PROJ_BASE_SPID => PROJ_BASE_SPID
  );
    END;
 ------------------------------------------------------------业态面积段树拼接 spid_tree
 INSERT INTO TMP_SALE_RATE_BY_GRANULARITY (ID---【1】主键
,"SORT"
,GRANULARITY_ID--颗粒度id
,PROJECT_ID---【2】项目ID
,PROJECT_NAME--项目名称
,PARENT_ID---父级id
,DATA_GRANULARITY--颗粒度名称
)
-----业态
select spid_tree
,b.order_code
,proj.PROJECT_ID||b."业态" as GRANULARITY_ID
,proj.PROJECT_ID as projectId
,proj.PROJECT_NAME
,null as parentId 
,b."业态" as text   
 from (select * from tmp_proj_base where id = PROJ_BASE_SPID) proj cross join
(select 
   case when l.attribute_name<>'住宅' then '商铺及其他' else '住宅' end  as "业态",order_code  from mdm_attribute_area_level l where parent_id is null) b
   union all
-----面积段
select spid_tree
,a.order_code
,proj.PROJECT_ID||ptype||a.areaStage as GRANULARITY_ID
,proj.PROJECT_ID as projectId
,proj.PROJECT_NAME
,proj.PROJECT_ID||ptype as parentId 
,a.areaStage as text
from  (select * from tmp_proj_base where id = PROJ_BASE_SPID) proj cross join
( select 
    l.attribute_name as areaStage,l.order_code,case when p.attribute_name<>'住宅' then '商铺及其他' else '住宅' end  as ptype from mdm_attribute_area_level l
    left join mdm_attribute_area_level p on l.parent_id=p.id 
    where p.id is not null) a;

OPEN spid_tree_info FOR select * from TMP_SALE_RATE_BY_GRANULARITY where id=spid_tree;  
------------------------------------------------------面积段数据 spid

 INSERT INTO TMP_SALE_RATE_BY_GRANULARITY (ID---【1】主键
,GRANULARITY_ID
,PROJECT_ID---【2】项目ID
,PROJECT_NAME
,FO_SALE_OUT_COUNT---【3】首开去化套数
,FO_SALE_COUNT---【4】首开推售套数
,FO_SALE_RATE_BY_COUNT---【5】首开去化率(按套数)（3/4）
,FO_SALE_OUT_AREA---【6】首开去化面积
,FO_SALE_AREA---【7】首开推售面积
,FO_SALE_RATE_BY_AREA---【8】首开去化率(按面积)（6/7）
,FO_SALE_OUT_MONEY---【9】首开去化货值
,FO_SALE_MONEY---【10】首开推售货值
,FO_SALE_RATE_BY_MONEY---【11】首开去化率(按货值)（9/10）
,FO_SURPLUS_SALE_MONEY---【12】首开剩余货值(10-9)
,FO_SALE_AVERAGE_MONEY---【13】首开标准均价(10/7)
,FO_SALE_OUT_AVERAGE_MONEY---【14】首开签约均价(9/6)
,PO_SALE_OUT_COUNT---【15】全案去化套数
,PO_SALE_COUNT---【16】全案推售套数
,PO_SALE_RATE_BY_COUNT---【17】全案去化率(按套数)(15/16)
,PO_SALE_OUT_AREA---【18】全案去化面积
,PO_SALE_AREA---【19】全案推售面积
,PO_SALE_RATE_BY_AREA---【20】全案去化率(按面积)(18/19)
,PO_SALE_OUT_MONEY---【21】全案去化货值
,PO_SALE_MONEY---【22】全案推售货值
,PO_SALE_RATE_BY_MONEY---【23】全案去化率(按货值)(21/22)
,PO_SURPLUS_SALE_MONEY---【24】全案剩余货值(22-21)
,PO_SALE_AVERAGE_MONEY---【25】全案标准均价(22/19)
,PO_SALE_OUT_AVERAGE_MONEY---【26】全案签约均价(21/18)
,EH_SALE_OUT_COUNT---【27】现房去化套数
,EH_SALE_COUNT---【28】现房推售套数
,EH_SALE_RATE_BY_COUNT---【29】现房去化率(按套数)(27/28)
,EH_SALE_OUT_AREA---【30】现房去化面积
,EH_SALE_AREA---【31】现房推售面积
,EH_SALE_RATE_BY_AREA---【32】现房去化率(按面积)(30/31)
,EH_SALE_OUT_MONEY---【33】现房去化货值
,EH_SALE_MONEY---【34】现房推售货值
,EH_SALE_RATE_BY_MONEY---【35】现房去化率(按货值)(33/34)
,EH_SURPLUS_SALE_MONEY---【36】现房剩余货值(34-33)
,EH_SALE_AVERAGE_MONEY---【37】现房标准均价(34/31)
,EH_SALE_OUT_AVERAGE_MONEY---【38】现房签约均价(33/30)
,SI_SALE_OUT_COUNT---【39】顽固性库存去化套数
,SI_SALE_COUNT---【40】顽固性库存推售套数
,SI_SALE_RATE_BY_COUNT---【41】顽固性库存去化率(按套数)(39/40)
,SI_SALE_OUT_AREA---【42】顽固性库存去化面积
,SI_SALE_AREA---【43】顽固性库存推售面积
,SI_SALE_RATE_BY_AREA---【44】顽固性库存去化率(按面积)(42/43)
,SI_SALE_OUT_MONEY---【45】顽固性库存去化货值
,SI_SALE_MONEY---【46】顽固性库存推售货值
,SI_SALE_RATE_BY_MONEY---【47】顽固性库存去化率(按货值)(45/46)
,SI_SURPLUS_SALE_MONEY---【48】顽固性库存剩余货值(46-45)
,SI_SALE_AVERAGE_MONEY---【49】顽固性库存标准均价(46/43)
,SI_SALE_OUT_AVERAGE_MONEY---【50】顽固性库存签约均价(45/42)
,PARENT_ID  
,DATA_GRANULARITY
,PRODUCT_NAME
,CREATED---【51】创建日期
,REMARK
)select 
spid as ID---【1】主键
,project_id||PRODUCT_NAME||AREA_LEVEL
,project_id as PROJECT_ID---【2】项目ID
,project_name
-----------------------------------K1、首开去化率开始--------------------
,"首开去化套数" as FO_SALE_OUT_COUNT---【3】首开去化套数
,"首开推售套数" as FO_SALE_COUNT---【4】首开推售套数
,case when 首开推售套数=0 then 0 else round("首开去化套数"/"首开推售套数",4)  end as FO_SALE_RATE_BY_COUNT---【5】首开去化率(按套数)（3/4）
,"首开去化面积" as FO_SALE_OUT_AREA---【6】首开去化面积
,"首开推售面积" as FO_SALE_AREA---【7】首开推售面积
,case when 首开推售面积=0 then 0 else round("首开去化面积"/"首开推售面积",4)  end as FO_SALE_RATE_BY_AREA---【8】首开去化率(按面积)（6/7）
,"首开去化货值" as FO_SALE_OUT_MONEY---【9】首开去化货值
,"首开推售货值" as FO_SALE_MONEY---【10】首开推售货值
,case when 首开推售货值=0 then 0 else round("首开去化货值"/"首开推售货值",4)  end as FO_SALE_RATE_BY_MONEY---【11】首开去化率(按货值)（9/10）
,"首开推售货值"-"首开去化货值" as FO_SURPLUS_SALE_MONEY---【12】首开剩余货值(10-9)
,case when 首开推售面积=0 then 0 else round("首开推售货值"/"首开推售面积",4)  end  as FO_SALE_AVERAGE_MONEY---【13】首开标准均价(10/7)
,case when 首开去化面积=0 then 0 else round("首开去化货值"/"首开去化面积",4)  end as FO_SALE_OUT_AVERAGE_MONEY---【14】首开签约均价(9/6)
-----------------------------------K3、全案去化率 （单位：%）--------------------
,"全案已去化套数" as PO_SALE_OUT_COUNT---【15】全案去化套数
,"全案已领证套数" as PO_SALE_COUNT---【16】全案推售套数
,case when 全案已领证套数=0 then 0 else round("全案已去化套数"/"全案已领证套数",4)  end as PO_SALE_RATE_BY_COUNT---【17】全案去化率(按套数)(15/16)
,"全案已去化面积" as PO_SALE_OUT_AREA---【18】全案去化面积
,"全案已领证面积" as PO_SALE_AREA---【19】全案推售面积
,case when 全案已领证面积=0 then 0 else round("全案已去化面积"/"全案已领证面积",4)  end as PO_SALE_RATE_BY_AREA---【20】全案去化率(按面积)(18/19)
,"全案已去化货值" as PO_SALE_OUT_MONEY---【21】全案去化货值
,"全案已领证货值" as PO_SALE_MONEY---【22】全案推售货值
,case when 全案已领证货值=0 then 0 else round("全案已去化货值"/"全案已领证货值",4)  end  as PO_SALE_RATE_BY_MONEY---【23】全案去化率(按货值)(21/22)
,"全案已领证货值"-"全案已去化货值" as PO_SURPLUS_SALE_MONEY---【24】全案剩余货值(22-21)
,case when 全案已领证面积=0 then 0 else round("全案已领证货值"/"全案已领证面积",4)  end  as PO_SALE_AVERAGE_MONEY---【25】全案标准均价(22/19)
,case when 全案已去化面积=0 then 0 else round("全案已去化货值"/"全案已去化面积",4)  end   PO_SALE_OUT_AVERAGE_MONEY---【26】全案签约均价(21/18)
-----------------------------------K4、现房去化率 （单位：%）--------------------
,"现房去化套数" as EH_SALE_OUT_COUNT---【27】现房去化套数
,"现房推售套数" as EH_SALE_COUNT---【28】现房推售套数
,case when 现房推售套数=0 then 0 else  round("现房去化套数"/"现房推售套数",4) end as EH_SALE_RATE_BY_COUNT---【29】现房去化率(按套数)(27/28)
,"现房去化面积" as EH_SALE_OUT_AREA---【30】现房去化面积
,"现房推售面积" as EH_SALE_AREA---【31】现房推售面积
,case when 现房推售面积=0 then 0 else  round("现房去化面积"/"现房推售面积",4) end as EH_SALE_RATE_BY_AREA---【32】现房去化率(按面积)(30/31)
,"现房去化金额" as EH_SALE_OUT_MONEY---【33】现房去化货值
,"现房推售金额" as EH_SALE_MONEY---【34】现房推售货值
,case when 现房推售金额=0 then 0 else  round("现房去化金额"/"现房推售金额",4) end as EH_SALE_RATE_BY_MONEY---【35】现房去化率(按货值)(33/34)
,"现房推售金额"-"现房去化金额" as EH_SURPLUS_SALE_MONEY---【36】现房剩余货值(34-33)
,case when 现房推售面积=0 then 0 else  round("现房推售金额"/"现房推售面积",4) end  as EH_SALE_AVERAGE_MONEY---【37】现房标准均价(34/31)
,case when 现房去化面积=0 then 0 else  round("现房去化金额"/"现房去化面积",4) end  as EH_SALE_OUT_AVERAGE_MONEY---【38】现房签约均价(33/30)
-----------------------------------K5、顽固性库存去化率 （单位：%）--------------------
,"顽固去化套数" as SI_SALE_OUT_COUNT---【39】顽固性库存去化套数
,"顽固推售套数" as SI_SALE_COUNT---【40】顽固性库存推售套数
,case when 顽固推售套数=0 then 0 else  round("顽固去化套数"/"顽固推售套数",4) end as SI_SALE_RATE_BY_COUNT---【41】顽固性库存去化率(按套数)(39/40)
,"顽固去化面积" as SI_SALE_OUT_AREA---【42】顽固性库存去化面积
,"顽固推售面积" as SI_SALE_AREA---【43】顽固性库存推售面积
,case when 顽固推售面积=0 then 0 else  round("顽固去化面积"/"顽固推售面积",4) end  as SI_SALE_RATE_BY_AREA---【44】顽固性库存去化率(按面积)(42/43)
,"顽固去化金额" as SI_SALE_OUT_MONEY---【45】顽固性库存去化货值
,"顽固推售金额" as SI_SALE_MONEY---【46】顽固性库存推售货值
,case when 顽固推售金额=0 then 0 else  round("顽固去化金额"/"顽固推售金额",4) end as SI_SALE_RATE_BY_MONEY---【47】顽固性库存去化率(按货值)(45/46)
,"顽固推售金额"-"顽固去化金额" SI_SURPLUS_SALE_MONEY---【48】顽固性库存剩余货值(46-45)
,case when 顽固推售面积=0 then 0 else  round("顽固推售金额"/"顽固推售面积",4) end as SI_SALE_AVERAGE_MONEY---【49】顽固性库存标准均价(46/43)
,case when 顽固推售面积=0 then 0 else  round("顽固去化金额"/"顽固推售面积",4) end as SI_SALE_OUT_AVERAGE_MONEY---【50】顽固性库存签约均价(45/42)
-------------------- 业态面积段特有 start
,project_id||PRODUCT_NAME  as PARENT_ID  
,AREA_LEVEL as DATA_GRANULARITY
,PRODUCT_NAME    
,sys_created as CREATED---【51】创建日期
,dwm_REMARK
-------------------- 业态面积段特有 end
from 
(select 
------首次开盘30天内的签约金额（首开去化货值）: 
---------->房间“合同成交总价”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约
sum(case when room.SALE_STATE='签约' and proj.first_open_date<build.GET_PRE_SALE_PERMIT_DATE and room.TRADE_CONTRACT_DATE<proj.first_open_date +30 then room.TRADE_TOTAL else 0 end ) as "首开去化货值"
------首次开盘已取证货值（首开推售货值）：
---------->房间“面价标准总价”:在计算“货值去化率”时，对已签约房间（有可能出现优惠打折），分子分母均按“签约金额”计算“货值去化率”。
---------->房间所属“楼栋预售许可证获取日期”<"项目开盘"的实际完成日期 
,sum(case when room.SALE_STATE='签约' and build.GET_PRE_SALE_PERMIT_DATE<proj.first_open_date then room.TRADE_TOTAL 
when build.GET_PRE_SALE_PERMIT_DATE<proj.first_open_date then room.BZ_TOTAL else 0 end )  as "首开推售货值"
------首次开盘30天内的签约面积（首开去化面积）:
---------->房间“最新建筑面积”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' and proj.first_open_date<build.GET_PRE_SALE_PERMIT_DATE and room.TRADE_CONTRACT_DATE<proj.first_open_date +30  then room.NEW_BLD_AREA else 0 end ) as "首开去化面积"
------首次开盘的已取证面积（首开推售面积）:
---------->房间“最新建筑面积”
---------->房间所属“楼栋预售许可证获取日期”<"项目开盘"的实际完成日期 
,sum(case when build.GET_PRE_SALE_PERMIT_DATE<proj.first_open_date then room.NEW_BLD_AREA  else 0 end )  as "首开推售面积"
------首次开盘30天内的签约套数（首开去化套数）:
---------->房间“汇总”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' and proj.first_open_date<build.GET_PRE_SALE_PERMIT_DATE and room.TRADE_CONTRACT_DATE<proj.first_open_date +30 then 1 else 0 end ) as "首开去化套数"
------首次开盘的已取证套数（首开推售套数）:
---------->房间“汇总”
---------->房间所属“楼栋预售许可证获取日期”<"项目开盘"的实际完成日期 
,sum(case when build.GET_PRE_SALE_PERMIT_DATE<proj.first_open_date then 1 else 0 end )  as "首开推售套数"

------全案------全案------全案------全案------全案------全案------全案 
------全案（已去化货值）: 
---------->房间“合同成交总价”
---------->房间“销售状态”=签约
,sum(case when room.SALE_STATE='签约' then room.TRADE_TOTAL else 0 end ) as "全案已去化货值"
------全案（已领证货值）：
---------->房间“面价标准总价”:在计算“货值去化率”时，对已签约房间（有可能出现优惠打折），分子分母均按“签约金额”计算“货值去化率”。
,sum(case when room.SALE_STATE='签约'  then room.TRADE_TOTAL  
when room.SALE_STATE<>'签约' and build.GET_PRE_SALE_PERMIT_DATE is not null then room.BZ_TOTAL else 0 end )  as "全案已领证货值"
------全案（已去化面积）:
---------->房间“最新建筑面积”
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约'  then room.NEW_BLD_AREA else 0 end ) as "全案已去化面积"
------全案（已领证面积）:
---------->房间“最新建筑面积”
,sum(case when room.SALE_STATE='签约' or build.GET_PRE_SALE_PERMIT_DATE is not null then room.NEW_BLD_AREA  else 0 end )  as "全案已领证面积"
------全案（已去化套数):
---------->房间“汇总”
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' then 1 else 0 end ) as "全案已去化套数"
------全案（已领证套数):
---------->房间“汇总”
,sum(case when room.SALE_STATE='签约' or build.GET_PRE_SALE_PERMIT_DATE is not null then 1 else 0 end )  as "全案已领证套数"
------现房------现房------现房------现房------现房------现房------现房------现房------现房
----现房去化面积
,sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE = '签约' and build.GET_PRE_SALE_PERMIT_DATE>proj.COMPLETION_RECORD_DATE then  room.NEW_BLD_AREA else 0 end) as "现房去化面积" ,
----现房推售面积
sum(case when  proj.COMPLETION_RECORD_DATE is not null and  (room.SALE_STATE <> '签约' or (room.SALE_STATE = '签约' and build.GET_PRE_SALE_PERMIT_DATE>proj.COMPLETION_RECORD_DATE) )  then room.NEW_BLD_AREA else 0 end) as 现房推售面积,
----现房去化金额
sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE = '签约' and build.GET_PRE_SALE_PERMIT_DATE>proj.COMPLETION_RECORD_DATE then  room.TRADE_TOTAL else 0 end) as  现房去化金额,
--推售金额需要根据房间是否已经签约来判断取签约金额还是标准金额
----现房推售金额
sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE <> '签约'   then room.BZ_TOTAL  when room.SALE_STATE = '签约' and proj.COMPLETION_RECORD_DATE is not null and  build.GET_PRE_SALE_PERMIT_DATE>proj.COMPLETION_RECORD_DATE then room.TRADE_TOTAL else 0 end) as 现房推售金额,
----现房去化套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE = '签约' and build.GET_PRE_SALE_PERMIT_DATE>proj.COMPLETION_RECORD_DATE then  1 else 0 end) as  现房去化套数,
----现房推售套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null and  (room.SALE_STATE <> '签约' or  (room.SALE_STATE = '签约' and build.GET_PRE_SALE_PERMIT_DATE>proj.COMPLETION_RECORD_DATE) )  then 1 else 0 end) as 现房推售套数
------顽固性库存------顽固性库存------顽固性库存------顽固性库存------顽固性库存------顽固性库存------顽固性库存
----顽固推售面积
,sum(case when  proj.COMPLETION_RECORD_DATE is not null  and room.SALE_STATE = '签约' and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and build.GET_PRE_SALE_PERMIT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  build.GET_PRE_SALE_PERMIT_DATE<sysdate then  room.NEW_BLD_AREA else 0 end) as 顽固去化面积,
----顽固去化面积
sum(case when  proj.COMPLETION_RECORD_DATE is not null  and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and ((TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  build.GET_PRE_SALE_PERMIT_DATE<sysdate  and room.SALE_STATE = '签约') or  room.SALE_STATE <> '签约') then room.NEW_BLD_AREA else 0 end) as 顽固推售面积,
----顽固去化金额
sum(case when  proj.COMPLETION_RECORD_DATE is not null  and room.SALE_STATE = '签约' and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and build.GET_PRE_SALE_PERMIT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  build.GET_PRE_SALE_PERMIT_DATE<sysdate  then  room.TRADE_TOTAL else 0 end) as  顽固去化金额,
--推售金额需要根据房间是否已经签约来判断取签约金额还是标准金额
----顽固推售金额
sum(case  when  proj.COMPLETION_RECORD_DATE is not null  and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and (TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  build.GET_PRE_SALE_PERMIT_DATE<sysdate  and room.SALE_STATE = '签约') then room.TRADE_TOTAL  --已经在今年签约的算签约金额
 when  proj.COMPLETION_RECORD_DATE is not null  and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  room.SALE_STATE <> '签约' then room.BZ_TOTAL  else 0 end) as 顽固推售金额,  --未签约的算校准总价
----顽固去化套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null  and room.SALE_STATE = '签约' and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and build.GET_PRE_SALE_PERMIT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  build.GET_PRE_SALE_PERMIT_DATE<sysdate then  1 else 0 end) as  顽固去化套数,
----顽固推售套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null  and  room.PRODUCT_NAME <> '住宅' and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and ((TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') and  build.GET_PRE_SALE_PERMIT_DATE<sysdate  and room.SALE_STATE = '签约') or  room.SALE_STATE <> '签约') then 1 else 0 end) as 顽固推售套数
,proj.project_id,
proj.project_name,
proj.org_id,
proj.org_name,
proj.first_open_date,
proj.obtain_date,
proj.COMPLETION_RECORD_DATE,
proj.take_land_date,
proj.plan_first_open_date,
proj.first_open_duration_by_tl,
proj.first_open_duration_by_plan,
proj.new_plan_first_open_date,
proj.exhibition_area_open_date,
proj.plan_approval_date,
proj.is_operate,
proj.is_construction_began
,t_room.AREA_LEVEL
,t_room.PRODUCT_NAME 
from tmp_proj_base proj
left join MDM_ROOM room  on proj.project_id=room.project_id  and  proj.id = PROJ_BASE_SPID
left join TMP_ROOM t_room on  room.id=t_room.room_id
left join  mdm_build build on room.BUILDING_ID=build.id 
group by proj.project_id
-------------------- 业态面积段特有 start
    ,t_room.AREA_LEVEL
    ,t_room.PRODUCT_NAME
----------------------业态面积段特有 end
    ,proj.project_name,
    proj.org_id,
    proj.org_name,
    proj.first_open_date,
    proj.obtain_date,
    proj.COMPLETION_RECORD_DATE,
    proj.take_land_date,
    proj.plan_first_open_date,
    proj.first_open_duration_by_tl,
    proj.first_open_duration_by_plan,
    proj.new_plan_first_open_date,
    proj.exhibition_area_open_date,
    proj.plan_approval_date,
    proj.is_operate,
    proj.is_construction_began
    ) result 
-------------------- 业态面积段特有 start
   where  PRODUCT_NAME  is not null
----------------------业态面积段特有 end
;

OPEN spid_info FOR select * from TMP_SALE_RATE_BY_GRANULARITY where id=spid;  
------------------------------------------------------数据移入历史表;
OPEN info FOR
   select  tree.GRANULARITY_ID--颗粒度id---【1】主键
   ,tree.sort
,tree.PROJECT_ID,---【2】项目ID
nvl(apdata.fo_sale_out_count,0),
nvl(apdata.fo_sale_count,0),
nvl(apdata.fo_sale_rate_by_count,0),
nvl(apdata.fo_sale_out_area,0),
nvl(apdata.fo_sale_area,0),
nvl(apdata.fo_sale_rate_by_area,0),
nvl(apdata.fo_sale_out_money,0),
nvl(apdata.fo_sale_money,0),
nvl(apdata.fo_sale_rate_by_money,0),
nvl(apdata.fo_surplus_sale_money,0),
nvl(apdata.fo_sale_average_money,0),
nvl(apdata.fo_sale_out_average_money,0),
nvl(apdata.po_sale_out_count,0),
nvl(apdata.po_sale_count,0),
nvl(apdata.po_sale_rate_by_count,0),
nvl(apdata.po_sale_out_area,0),
nvl(apdata.po_sale_area,0),
nvl(apdata.po_sale_rate_by_area,0),
nvl(apdata.po_sale_out_money,0),
nvl(apdata.po_sale_money,0),
nvl(apdata.po_sale_rate_by_money,0),
nvl(apdata.po_surplus_sale_money,0),
nvl(apdata.po_sale_average_money,0),
nvl(apdata.po_sale_out_average_money,0),
nvl(apdata.eh_sale_out_count,0),
nvl(apdata.eh_sale_count,0),
nvl(apdata.eh_sale_rate_by_count,0),
nvl(apdata.eh_sale_out_area,0),
nvl(apdata.eh_sale_area,0),
nvl(apdata.eh_sale_rate_by_area,0),
nvl(apdata.eh_sale_out_money,0),
nvl(apdata.eh_sale_money,0),
nvl(apdata.eh_sale_rate_by_money,0),
nvl(apdata.eh_surplus_sale_money,0),
nvl(apdata.eh_sale_average_money,0),
nvl(apdata.eh_sale_out_average_money,0),
nvl(apdata.si_sale_out_count,0),
nvl(apdata.si_sale_count,0),
nvl(apdata.si_sale_rate_by_count,0),
nvl(apdata.si_sale_out_area,0),
nvl(apdata.si_sale_area,0),
nvl(apdata.si_sale_rate_by_area,0),
nvl(apdata.si_sale_out_money,0),
nvl(apdata.si_sale_money,0),
nvl(apdata.si_sale_rate_by_money,0),
nvl(apdata.si_surplus_sale_money,0),
nvl(apdata.si_sale_average_money,0),
nvl(apdata.si_sale_out_average_money,0)
,tree.PARENT_ID---父级id
,tree.DATA_GRANULARITY--颗粒度名称
,sys_created
,dwm_REMARK
from 
( select * from TMP_SALE_RATE_BY_GRANULARITY where id=spid_tree) tree
left join 
( 
    select  parent_id||data_granularity as id,
    project_id,
    fo_sale_out_count,
    fo_sale_count,
    fo_sale_rate_by_count,
    fo_sale_out_area,
    fo_sale_area,
    fo_sale_rate_by_area,
    fo_sale_out_money,
    fo_sale_money,
    fo_sale_rate_by_money,
    fo_surplus_sale_money,
    fo_sale_average_money,
    fo_sale_out_average_money,
    po_sale_out_count,
    po_sale_count,
    po_sale_rate_by_count,
    po_sale_out_area,
    po_sale_area,
    po_sale_rate_by_area,
    po_sale_out_money,
    po_sale_money,
    po_sale_rate_by_money,
    po_surplus_sale_money,
    po_sale_average_money,
    po_sale_out_average_money,
    eh_sale_out_count,
    eh_sale_count,
    eh_sale_rate_by_count,
    eh_sale_out_area,
    eh_sale_area,
    eh_sale_rate_by_area,
    eh_sale_out_money,
    eh_sale_money,
    eh_sale_rate_by_money,
    eh_surplus_sale_money,
    eh_sale_average_money,
    eh_sale_out_average_money,
    si_sale_out_count,
    si_sale_count,
    si_sale_rate_by_count,
    si_sale_out_area,
    si_sale_area,
    si_sale_rate_by_area,
    si_sale_out_money,
    si_sale_money,
    si_sale_rate_by_money,
    si_surplus_sale_money,
    si_sale_average_money,
    si_sale_out_average_money
 from  TMP_SALE_RATE_BY_GRANULARITY where id=spid
union all 
select  project_id||PRODUCT_NAME
,project_id,
sum(FO_SALE_OUT_COUNT),--【3】首开去化套数
sum(FO_SALE_COUNT),--【4】首开推售套数 
case when sum(FO_SALE_COUNT)=0 then 0 else  round(sum(FO_SALE_OUT_COUNT)/sum(FO_SALE_COUNT),4) end,--【5】首开去化率(按套数)（3/4）
sum(FO_SALE_OUT_AREA),--【6】首开去化面积
sum(FO_SALE_AREA),--【7】首开推售面积
case when sum(FO_SALE_AREA)=0 then 0 else  round(sum(FO_SALE_OUT_AREA)/sum(FO_SALE_AREA),4) end,--【8】首开去化率(按面积)（6/7）
sum(FO_SALE_OUT_MONEY),--【9】首开去化货值
sum(FO_SALE_MONEY),--【10】首开推售货值
case when sum(FO_SALE_MONEY)=0 then 0 else  round(sum(FO_SALE_OUT_MONEY)/sum(FO_SALE_MONEY),4) end,--【11】首开去化率(按货值)（9/10）
sum(FO_SURPLUS_SALE_MONEY),--【12】首开剩余货值(10-9)
case when sum(FO_SALE_AREA)=0 then 0 else  round(sum(FO_SALE_MONEY)/sum(FO_SALE_AREA),4) end,--【13】首开标准均价(10/7)
case when sum(FO_SALE_OUT_AREA)=0 then 0 else  round(sum(FO_SALE_OUT_MONEY)/sum(FO_SALE_OUT_AREA),4) end,--【14】首开签约均价(9/6)
sum(PO_SALE_OUT_COUNT),--【15】全案去化套数
sum(PO_SALE_COUNT),--【16】全案推售套数
case when sum(PO_SALE_COUNT)=0 then 0 else  round(sum(PO_SALE_OUT_COUNT)/sum(PO_SALE_COUNT),4) end,--【17】全案去化率(按套数)(15/16)
sum(PO_SALE_OUT_AREA),--【18】全案去化面积
sum(PO_SALE_AREA),--【19】全案推售面积
case when sum(PO_SALE_AREA)=0 then 0 else  round(sum(PO_SALE_OUT_AREA)/sum(PO_SALE_AREA),4) end,--【20】全案去化率(按面积)(18/19)
sum(PO_SALE_OUT_MONEY),--【21】全案去化货值
sum(PO_SALE_MONEY),--【22】全案推售货值
case when sum(PO_SALE_MONEY)=0 then 0 else  round(sum(PO_SALE_OUT_MONEY)/sum(PO_SALE_MONEY),4) end,--【23】全案去化率(按货值)(21/22)
sum(PO_SURPLUS_SALE_MONEY),--【24】全案剩余货值(22-21)
case when sum(PO_SALE_AREA)=0 then 0 else  round(sum(PO_SALE_MONEY)/sum(PO_SALE_AREA),4) end,--【25】全案标准均价(22/19)
case when sum(PO_SALE_OUT_AREA)=0 then 0 else  round(sum(PO_SALE_OUT_MONEY)/sum(PO_SALE_OUT_AREA),4) end,--【26】全案签约均价(21/18)
sum(EH_SALE_OUT_COUNT),--【27】现房去化套数
sum(EH_SALE_COUNT),--【28】现房推售套数
case when sum(EH_SALE_COUNT)=0 then 0 else  round(sum(EH_SALE_OUT_COUNT)/sum(EH_SALE_COUNT),4) end,--【29】现房去化率(按套数)(27/28)
sum(EH_SALE_OUT_AREA),--【30】现房去化面积
sum(EH_SALE_AREA),--【31】现房推售面积
case when sum(EH_SALE_AREA)=0 then 0 else  round(sum(EH_SALE_OUT_AREA)/sum(EH_SALE_AREA),4) end,--【32】现房去化率(按面积)(30/31)
sum(EH_SALE_OUT_MONEY),--【33】现房去化货值
sum(EH_SALE_MONEY),--【34】现房推售货值
case when sum(EH_SALE_MONEY)=0 then 0 else  round(sum(EH_SALE_OUT_MONEY)/sum(EH_SALE_MONEY),4) end,--【35】现房去化率(按货值)(33/34)
sum(EH_SURPLUS_SALE_MONEY),--【36】现房剩余货值(34-33)
case when sum(EH_SALE_AREA)=0 then 0 else  round(sum(EH_SALE_MONEY)/sum(EH_SALE_AREA),4) end,--【37】现房标准均价(34/31)
case when sum(EH_SALE_OUT_AREA)=0 then 0 else  round(sum(EH_SALE_OUT_MONEY)/sum(EH_SALE_OUT_AREA),4) end,--【38】现房签约均价(33/30)
sum(SI_SALE_OUT_COUNT),--【39】顽固性库存去化套数
sum(SI_SALE_COUNT),--【40】顽固性库存推售套数
case when sum(SI_SALE_COUNT)=0 then 0 else  round(sum(SI_SALE_OUT_COUNT)/sum(SI_SALE_COUNT),4) end,--【41】顽固性库存去化率(按套数)(39/40)
sum(SI_SALE_OUT_AREA),--【42】顽固性库存去化面积
sum(SI_SALE_AREA),--【43】顽固性库存推售面积
case when sum(SI_SALE_AREA)=0 then 0 else  round(sum(SI_SALE_OUT_AREA)/sum(SI_SALE_AREA),4) end,--【44】顽固性库存去化率(按面积)(42/43)
sum(SI_SALE_OUT_MONEY),--【45】顽固性库存去化货值
sum(SI_SALE_MONEY),--【46】顽固性库存推售货值
case when sum(SI_SALE_MONEY)=0 then 0 else  round(sum(SI_SALE_OUT_MONEY)/sum(SI_SALE_MONEY),4) end,--【47】顽固性库存去化率(按货值)(45/46)
sum(SI_SURPLUS_SALE_MONEY),--【48】顽固性库存剩余货值(46-45)
case when sum(SI_SALE_AREA)=0 then 0 else  round(sum(SI_SALE_MONEY)/sum(SI_SALE_AREA),4) end,--【49】顽固性库存标准均价(46/43)
case when sum(SI_SALE_OUT_AREA)=0 then 0 else  round(sum(SI_SALE_OUT_MONEY)/sum(SI_SALE_OUT_AREA),4) end--【50】顽固性库存签约均价(45/42)
 from  TMP_SALE_RATE_BY_GRANULARITY where id=spid group by project_id,
 parent_id,PRODUCT_NAME) apdata  
on tree.GRANULARITY_ID=apdata.id order by apdata.project_id;


END CL_P_DWM_SALE_RATE_BY_GRA;
/

prompt
prompt Creating procedure COMPILE_INVALID_PROCEDURES
prompt =============================================
prompt
create or replace procedure pom0813.compile_invalid_procedures(
    p_owner varchar2 -- 所有者名称，即 SCHEMA
) as

--编译某个用户下的无效存储过程

    str_sql varchar2(200);

begin
    for invalid_procedures in (select object_name from all_objects
       where status = 'INVALID' and object_type = 'PROCEDURE' and owner=upper(p_owner))
    loop
        str_sql := 'alter procedure '||p_owner||'.'||invalid_procedures.object_name || ' compile';
        begin
            execute immediate str_sql;
        exception
          --When Others Then Null;
            when OTHERS Then
                dbms_output.put_line(sqlerrm);
        end;
    end loop;
end;
/

prompt
prompt Creating procedure POM_KEY_NODE_MY_REMINDER
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.POM_KEY_NODE_MY_REMINDER
(
    REMINDERGUID IN VARCHAR2,
    pageIndex    IN INT,
    pageSize     IN INT,
    total        OUT INT,
    items        OUT SYS_REFCURSOR
)
IS
    v_count clob;
    v_sql clob;
BEGIN
    v_sql := '
    SELECT *
    FROM (SELECT tt.*, ROWNUM AS rowno
          FROM (
            select total.* from  (
                           select
                               node.id AS "id",
                               node.original_node_id  AS "nodeOriginalId",
                               --未到期不亮灯
                               case WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
                                   --到期当天内完成反馈
                                    when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
                                        then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
                                   --到期1-5天内完成反馈
                                   when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
                                         then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                    --到期未反馈黄灯
                                    WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 0 and 5
                                             THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                    --到期超过5天未反馈红灯
                                    WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(NODE.PLAN_END_DATE)) >5)
                                             THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
                                         ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END AS "warnState",
                                    case when node.actual_end_date is not null
                                            then ''已完成''
                                        when to_char(node.plan_end_date,''YYYY-MM-DD'') >to_char(sysdate,''YYYY-MM-DD'') and node.actual_end_date is  null
                                            then ''未到期''
                                        when TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') < TO_CHAR(sysdate, ''YYYY-MM-DD'') and node.actual_end_date is  null
                                            then ''<span style="color:red">已超期</span>'' end as "taskState" ,
                                    TO_CHAR(smrb.created_time, ''YYYY-MM-DD'')  AS "urgeTime",
                                    node.node_name AS "taskName",
                                    node.node_level  AS "taskLevel",
                                    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'')  AS "planTime",
                                    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'')  AS "estimateTime",
                                    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'')  AS "realityTime",
                                    plan.plan_type AS "planType",
                                    plan.id AS "planId",
                                    nvl(sp.project_name, sps.stage_full_name) AS "originProj",
                                    plan.plan_name AS "originPlan",
                                    node.duty_department AS "dutyDept",
                                    unit.org_name AS "secondCompany"
                          from SYS_MSG_RECORD_BIZ smrb
                                   left join SYS_MSG_RECORD_SMS smrs on smrs.MSG_RECORD_BIZ_ID = smrb.ID
                                   left join sys_user sy on smrs.sender_id = sy.user_code
                                   left join pom_proj_plan_node node on smrb.BIZ_KEY = node.id
                                   left join pom_proj_plan plan on node.proj_plan_id = plan.id
                                   left join sys_project sp on plan.proj_id = sp.id
                                   left join sys_project_stage sps on plan.proj_id = sps.id
                                   left join sys_business_unit unit on plan.company_id = unit.id
                          where smrb.biz_msg_category = ''催办消息''
                            and smrb.system_id = ''71313f018a35f3a558166cba7599b5d6''
                            and plan.plan_type = ''关键节点计划''
                            and plan.approval_status = ''已审核''
                            and sy.id = '''||REMINDERGUID||'''
                            and node.is_disable = 0
                          union
                            select
                                node.id AS "id",
                                node.original_node_id  AS "nodeOriginalId",
                                --未到期不亮灯
                                case WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
                                    --到期当天内完成反馈
                                     when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
                                         then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
                                    --到期1-5天内完成反馈
                                    when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
                                         then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                --到期未反馈黄灯
                                WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 0 and 5
                                         THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                --到期超过5天未反馈红灯
                                WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(NODE.PLAN_END_DATE)) >5)
                                         THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
                                     ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END AS "warnState",
                                case when node.actual_end_date is not null
                                        then ''已完成''
                                    when to_char(node.plan_end_date,''YYYY-MM-DD'') >to_char(sysdate,''YYYY-MM-DD'') and node.actual_end_date is  null
                                        then ''未到期''
                                    when TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') < TO_CHAR(sysdate, ''YYYY-MM-DD'') and node.actual_end_date is  null
                                        then ''<span style="color:red">已超期</span>'' end as "taskState" ,
                                TO_CHAR(smrb.created_time, ''YYYY-MM-DD'')  AS "urgeTime",
                                node.node_name AS "taskName",
                                node.node_level  AS "taskLevel",
                                TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'')  AS "planTime",
                                TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'')  AS "estimateTime",
                                TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'')  AS "realityTime",
                                plan.plan_type AS "planType",
                                plan.id AS "planId",
                                nvl(sp.project_name, sps.stage_full_name) AS "originProj",
                                plan.plan_name AS "originPlan",
                                node.duty_department AS "dutyDept",
                                unit.org_name AS "secondCompany"
                          from SYS_MSG_RECORD_BIZ smrb
                              left join SYS_MSG_RECORD_WECHAT smrw on smrw.MSG_RECORD_BIZ_ID = smrb.ID
                              left join sys_user sy on smrw.sender_id = sy.user_code
                              left join pom_proj_plan_node node on smrb.BIZ_KEY = node.id
                              left join pom_proj_plan plan on node.proj_plan_id = plan.id
                              left join sys_project sp on plan.proj_id = sp.id
                              left join sys_project_stage sps on plan.proj_id = sps.id
                              left join sys_business_unit unit on plan.company_id = unit.id
                          where
                              smrb.biz_msg_category = ''催办消息''
                            and smrb.system_id = ''71313f018a35f3a558166cba7599b5d6''
                            and plan.plan_type=''关键节点计划''
                            and plan.approval_status=''已审核''
                            and sy.id='''||REMINDERGUID||'''
                            and node.is_disable = 0
                        union
                            select
                                node.id AS "id",
                                node.original_node_id  AS "nodeOriginalId",
                                --未到期不亮灯
                                case WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
                                    --到期当天内完成反馈
                                     when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
                                         then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
                                    --到期1-5天内完成反馈
                                    when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
                                         then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                --到期未反馈黄灯
                                WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 0 and 5
                                         THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                --到期超过5天未反馈红灯
                                WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(NODE.PLAN_END_DATE)) >5)
                                         THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
                                     ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END AS "warnState",
                                case when node.actual_end_date is not null
                                        then ''已完成''
                                    when to_char(node.plan_end_date,''YYYY-MM-DD'') >to_char(sysdate,''YYYY-MM-DD'') and node.actual_end_date is  null
                                        then ''未到期''
                                    when TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') < TO_CHAR(sysdate, ''YYYY-MM-DD'') and node.actual_end_date is  null
                                        then ''<span style="color:red">已超期</span>'' end as "taskState" ,
                                TO_CHAR(smc.created, ''YYYY-MM-DD'')  AS "urgeTime",
                                node.node_name AS "taskName",
                                node.node_level  AS "taskLevel",
                                TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'')  AS "planTime",
                                TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'')  AS "estimateTime",
                                TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'')  AS "realityTime",
                                plan.plan_type AS "planType",
                                plan.id AS "planId",
                                nvl(sp.project_name, sps.stage_full_name) AS "originProj",
                                plan.plan_name AS "originPlan",
                                node.duty_department AS "dutyDept",
                                unit.org_name AS "secondCompany"
                          from sys_message_center smc
                              left join sys_user sy on smc.creator_name = sy.user_code
                              left join pom_proj_plan_node node on smc.task_id = node.id
                              left join pom_proj_plan plan on node.proj_plan_id = plan.id
                              left join sys_project sp on plan.proj_id = sp.id
                              left join sys_project_stage sps on plan.proj_id = sps.id
                              left join sys_business_unit unit on plan.company_id = unit.id
                          where
                              smc.biz_msg_category = ''催办消息''
                            and plan.plan_type=''关键节点计划''
                            and plan.approval_status=''已审核''
                            and sy.id='''||REMINDERGUID||'''
                            and node.is_disable = 0
        )total order by total."planTime" asc
    ) tt
           WHERE ROWNUM <= '||pageSize||' * '||pageIndex||' )table_alias
           WHERE table_alias.rowno >= '||pageSize||' * ( '||pageIndex||' -1) + 1 ';

    v_count := 'select count(*) from  (
                           select
                               node.id AS "id",
                               node.original_node_id  AS "nodeOriginalId",
                               --未到期不亮灯
                               case WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
                                   --到期当天内完成反馈
                                    when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
                                        then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
                                   --到期1-5天内完成反馈
                                   when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
                                         then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                    --到期未反馈黄灯
                                    WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 0 and 5
                                             THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                    --到期超过5天未反馈红灯
                                    WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(NODE.PLAN_END_DATE)) >5)
                                             THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
                                         ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END AS "warnState",
                                    case when node.actual_end_date is not null
                                            then ''已完成''
                                        when to_char(node.plan_end_date,''YYYY-MM-DD'') >to_char(sysdate,''YYYY-MM-DD'') and node.actual_end_date is  null
                                            then ''未到期''
                                        when TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') < TO_CHAR(sysdate, ''YYYY-MM-DD'') and node.actual_end_date is  null
                                            then ''<span style="color:red">已超期</span>'' end as "taskState" ,
                                    TO_CHAR(smrb.created_time, ''YYYY-MM-DD'')  AS "urgeTime",
                                    node.node_name AS "taskName",
                                    node.node_level  AS "taskLevel",
                                    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'')  AS "planTime",
                                    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'')  AS "estimateTime",
                                    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'')  AS "realityTime",
                                    plan.plan_type AS "planType",
                                    plan.id AS "planId",
                                    nvl(sp.project_name, sps.stage_full_name) AS "originProj",
                                    plan.plan_name AS "originPlan",
                                    node.duty_department AS "dutyDept",
                                    unit.org_name AS "secondCompany"
                          from SYS_MSG_RECORD_BIZ smrb
                                   left join SYS_MSG_RECORD_SMS smrs on smrs.MSG_RECORD_BIZ_ID = smrb.ID
                                   left join sys_user sy on smrs.sender_id = sy.user_code
                                   left join pom_proj_plan_node node on smrb.BIZ_KEY = node.id
                                   left join pom_proj_plan plan on node.proj_plan_id = plan.id
                                   left join sys_project sp on plan.proj_id = sp.id
                                   left join sys_project_stage sps on plan.proj_id = sps.id
                                   left join sys_business_unit unit on plan.company_id = unit.id
                          where smrb.biz_msg_category = ''催办消息''
                            and smrb.system_id = ''71313f018a35f3a558166cba7599b5d6''
                            and plan.plan_type = ''关键节点计划''
                            and plan.approval_status = ''已审核''
                            and sy.id = '''||REMINDERGUID||'''
                            and node.is_disable = 0
                          union
                            select
                                node.id AS "id",
                                node.original_node_id  AS "nodeOriginalId",
                                --未到期不亮灯
                                case WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
                                    --到期当天内完成反馈
                                     when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
                                         then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
                                    --到期1-5天内完成反馈
                                    when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
                                         then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                --到期未反馈黄灯
                                WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 0 and 5
                                         THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                --到期超过5天未反馈红灯
                                WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(NODE.PLAN_END_DATE)) >5)
                                         THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
                                     ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END AS "warnState",
                                case when node.actual_end_date is not null
                                        then ''已完成''
                                    when to_char(node.plan_end_date,''YYYY-MM-DD'') >to_char(sysdate,''YYYY-MM-DD'') and node.actual_end_date is  null
                                        then ''未到期''
                                    when TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') < TO_CHAR(sysdate, ''YYYY-MM-DD'') and node.actual_end_date is  null
                                        then ''<span style="color:red">已超期</span>'' end as "taskState" ,
                                TO_CHAR(smrb.created_time, ''YYYY-MM-DD'')  AS "urgeTime",
                                node.node_name AS "taskName",
                                node.node_level  AS "taskLevel",
                                TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'')  AS "planTime",
                                TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'')  AS "estimateTime",
                                TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'')  AS "realityTime",
                                plan.plan_type AS "planType",
                                plan.id AS "planId",
                                nvl(sp.project_name, sps.stage_full_name) AS "originProj",
                                plan.plan_name AS "originPlan",
                                node.duty_department AS "dutyDept",
                                unit.org_name AS "secondCompany"
                          from SYS_MSG_RECORD_BIZ smrb
                              left join SYS_MSG_RECORD_WECHAT smrw on smrw.MSG_RECORD_BIZ_ID = smrb.ID
                              left join sys_user sy on smrw.sender_id = sy.user_code
                              left join pom_proj_plan_node node on smrb.BIZ_KEY = node.id
                              left join pom_proj_plan plan on node.proj_plan_id = plan.id
                              left join sys_project sp on plan.proj_id = sp.id
                              left join sys_project_stage sps on plan.proj_id = sps.id
                              left join sys_business_unit unit on plan.company_id = unit.id
                          where
                              smrb.biz_msg_category = ''催办消息''
                            and smrb.system_id = ''71313f018a35f3a558166cba7599b5d6''
                            and plan.plan_type=''关键节点计划''
                            and plan.approval_status=''已审核''
                            and sy.id='''||REMINDERGUID||'''
                            and node.is_disable = 0
                        union
                            select
                                node.id AS "id",
                                node.original_node_id  AS "nodeOriginalId",
                                --未到期不亮灯
                                case WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
                                    --到期当天内完成反馈
                                     when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
                                         then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
                                    --到期1-5天内完成反馈
                                    when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
                                         then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                --到期未反馈黄灯
                                WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 0 and 5
                                         THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                                --到期超过5天未反馈红灯
                                WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(NODE.PLAN_END_DATE)) >5)
                                         THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
                                     ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END AS "warnState",
                                case when node.actual_end_date is not null
                                        then ''已完成''
                                    when to_char(node.plan_end_date,''YYYY-MM-DD'') >to_char(sysdate,''YYYY-MM-DD'') and node.actual_end_date is  null
                                        then ''未到期''
                                    when TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') < TO_CHAR(sysdate, ''YYYY-MM-DD'') and node.actual_end_date is  null
                                        then ''<span style="color:red">已超期</span>'' end as "taskState" ,
                                TO_CHAR(smc.created, ''YYYY-MM-DD'')  AS "urgeTime",
                                node.node_name AS "taskName",
                                node.node_level  AS "taskLevel",
                                TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'')  AS "planTime",
                                TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'')  AS "estimateTime",
                                TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'')  AS "realityTime",
                                plan.plan_type AS "planType",
                                plan.id AS "planId",
                                nvl(sp.project_name, sps.stage_full_name) AS "originProj",
                                plan.plan_name AS "originPlan",
                                node.duty_department AS "dutyDept",
                                unit.org_name AS "secondCompany"
                          from sys_message_center smc
                              left join sys_user sy on smc.creator_name = sy.user_code
                              left join pom_proj_plan_node node on smc.task_id = node.id
                              left join pom_proj_plan plan on node.proj_plan_id = plan.id
                              left join sys_project sp on plan.proj_id = sp.id
                              left join sys_project_stage sps on plan.proj_id = sps.id
                              left join sys_business_unit unit on plan.company_id = unit.id
                          where
                              smc.biz_msg_category = ''催办消息''
                            and plan.plan_type=''关键节点计划''
                            and plan.approval_status=''已审核''
                            and sy.id=:c
                            and node.is_disable = 0 )total';
     execute immediate v_count into total using REMINDERGUID;
    --dbms_output.put_line(v_sql);

     open items FOR v_sql;

END POM_KEY_NODE_MY_REMINDER;
/

prompt
prompt Creating procedure POM_KEY_NODE_MY_WATCH
prompt ========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.POM_KEY_NODE_MY_WATCH
(
    WatcherID    IN VARCHAR2,
    pageIndex    IN INT,
    pageSize     IN INT,
    total        OUT INT,
    items        OUT SYS_REFCURSOR
)
    IS
    v_count clob;
    v_sql clob;
BEGIN
    v_sql := 'SELECT *
    FROM (SELECT tt.*, ROWNUM AS rowno
          FROM (
                   select
                       node.id AS "id",
                       node.node_Name AS "taskName",
                       node.original_node_id  AS "nodeOriginalId",			
                       plan.id AS "planId",
                       case
                           --未到期不亮灯
                           WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
                           --到期当天内完成反馈
                           when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
                               then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
                           --到期1-5天内完成反馈
                           when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
                               then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                           --到期未反馈黄灯
                           WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 0 and 5
                               THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                           --到期超过5天未反馈红灯
                           WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(NODE.PLAN_END_DATE)) >5)
                               THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
                           ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' end as "warnState",
                       case when node.actual_end_date is not null
                                then ''已完成''
                            when to_char(node.plan_end_date,''YYYY-MM-DD'') >to_char(sysdate,''YYYY-MM-DD'') and node.actual_end_date is  null
                                then ''未到期''
                            when TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') < TO_CHAR(sysdate, ''YYYY-MM-DD'') and node.actual_end_date is  null
                                then ''<span style="color:red">已超期</span>'' end as "taskState" ,
                       TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') AS "planTime",
                       case when feed.approval_status = ''已审核''
                            then TO_CHAR(node.ESTIMATE_END_DATE, ''YYYY-MM-DD'')
                       else '''' end AS "estimateTime",
                       TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') AS "realityTime",
                       plan.plan_type AS "planType",
                       nvl(sp.project_name, sps.stage_full_name) AS "originProj",
                       plan.plan_name AS "originPlan",
                       node.node_level AS "taskLevel",
                       node.duty_department AS "dutyDept",
                       unit.org_name AS "secondCompany"
                   from sys_biz_watch sbw
                             left join pom_proj_plan_node node on sbw.biz_id = node.id
                            left join pom_proj_plan plan on node.proj_plan_id = plan.id
                            left join pom_node_feedback feed on node.feedback_id = feed.id
                            left join sys_project sp on plan.proj_id = sp.id
                            left join sys_project_stage sps on plan.proj_id = sps.id
                            left join sys_business_unit unit on plan.company_id = unit.id
                   where is_un_watch = 0 and watcher_id = '''||WatcherID||''' and plan.plan_type=''关键节点计划'' and plan.approval_status=''已审核'' and node.is_disable = 0 order by node.plan_end_date asc
               ) tt
           WHERE ROWNUM <= '||pageSize||' * '||pageIndex||') table_alias
 WHERE table_alias.rowno >= '||pageSize||' * ('||pageIndex||'-1) + 1';
    v_count := 'select count(*) from sys_biz_watch sbw
                             left join pom_proj_plan_node node on sbw.biz_id = node.id
                            left join pom_proj_plan plan on node.proj_plan_id = plan.id
                            left join pom_node_feedback feed on node.feedback_id = feed.id
                            left join sys_project sp on plan.proj_id = sp.id
                            left join sys_project_stage sps on plan.proj_id = sps.id
                            left join sys_business_unit unit on plan.company_id = unit.id
                   where is_un_watch = 0 and watcher_id = :c and plan.plan_type=''关键节点计划'' and plan.approval_status=''已审核'' and node.is_disable = 0 order by node.plan_end_date asc';
     execute immediate v_count into total using WatcherID;
    --dbms_output.put_line(v_sql);
    open items for v_sql;
END POM_KEY_NODE_MY_WATCH;
/

prompt
prompt Creating procedure POM_KEY_NODE_SCHEDULE
prompt ========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.POM_KEY_NODE_SCHEDULE
(
    companyGUID IN VARCHAR2,
    items OUT SYS_REFCURSOR
)IS
    v_sql clob;
    v_id clob;
BEGIN
    IF companyGUID IS NULL THEN
        v_id := '0001';
    ELSE
        v_id := companyGUID;
    END IF;
    v_sql :='with temp_origin as (
        select connect_by_isleaf as IS_END ,org.*,project_name,nvl(validtasks,0) AS validTasks,nvl(completenum,0) AS completenum,nvl(completed,0) AS completed,nvl(unfinished,0) AS unfinished,nvl(needResult,0) AS needResult,nvl(realResult,0) AS realResult,nvl(greenLight,0) AS greenLight,
        nvl(yellowLight,0) AS yellowLight,nvl(redlight,0) AS redlight,nvl(micompletenum,0) AS micompletenum,nvl(micompleted,0) AS micompleted,nvl(miunfinished,0) AS miunfinished,
        nvl(olcompletenum,0) AS olcompletenum,nvl(olcompleted,0) AS olcompleted,nvl(olunfinished,0) AS olunfinished,completionrate,dynamicresult
        from (
        select *
        from (select id, org_name as company, org_full_name, parent_id, ''1'' as isCompany,'''' as jumpUrl,order_hierarchy_code as code
        from sys_business_unit
        where is_company = 1)
        union
        select id, project_name as company, '''' as org_full_name, unit_id as parent_id, ''0'' as isCompany,''/pom/plan-assess/node-monitoring/plan-nodes?companyid=''||proj.unit_id||''&ppid=''||proj.id||''&planType=关键节点计划'' as jumpUrl,'''' as code
        from sys_project proj
        union
        select *
        from (select stage.id, stage.stage_full_name as company, stage.stage_full_name as org_full_name, stage.project_id as parent_id, ''0'' as isCompany,''/pom/plan-assess/node-monitoring/plan-nodes?companyid=''||sysP.unit_id||''&ppid=''||stage.id||''&planType=关键节点计划'' as jumpUrl,'''' as code
        from sys_project_stage stage left join sys_project sysP on stage.project_id = sysP.id
        order by stage.sn desc)
        ) org --组织主表
        left join
        (
        select proj.*,
        case when proj.validTasks is null or proj.validTasks = 0 or proj.completed = 0 then
        ''0''
        else to_char((proj.completed / proj.validTasks)*100, ''9999999990.00'') end as completionRate,
        case when proj.needResult is null or proj.needResult = 0 or proj.realResult = 0 then
        ''0''
        else to_char((proj.realResult / proj.needResult)*100, ''9999999990.00'') end as dynamicResult
        FROM (
        select A.*,B.completeNum,C.completed,D.unfinished,N.needResult,O.realResult,E.greenLight,F.yellowLight,G.redLight,H.miCompleteNum,I.miCompleted,J.miUnfinished,
        K.olCompleteNum,L.olCompleted,M.olUnfinished
        from (
        select sp.id, sp.project_name, nvl(count(node.id), 0) as validTasks
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --有效节点
        ) A
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS completeNum
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where to_char(node.plan_end_date, ''YYYY-MM-DD'') <= to_char(sysdate, ''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --应完成
        ) B ON A.ID = B.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS completed
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.actual_end_date is not null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --已完成
        ) C ON A.ID = C.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS unfinished
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.actual_end_date is null
        and node.is_disable = 0
        and to_char(node.plan_end_date,''YYYY-MM-DD'') <= to_char(sysdate,''YYYY-MM-DD'')
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --未完成
        ) D ON A.ID = D.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS greenLight
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where (TRUNC(ACTUAL_END_DATE) - trunc(PLAN_END_DATE)) <= 0
        and actual_end_date is null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --绿灯
        ) E ON A.ID = E.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS yellowLight
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where (((TRUNC(ACTUAL_END_DATE) - trunc(PLAN_END_DATE)) BETWEEN 1 and 5) or
        ((trunc(SYSDATE) - trunc(PLAN_END_DATE)) BETWEEN 0 and 5))
        and actual_end_date is null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --黄灯
        ) F ON A.ID = F.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS redLight
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where ACTUAL_END_DATE IS NULL
        and ((trunc(SYSDATE) - trunc(NODE.PLAN_END_DATE)) > 5)
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --红灯
        ) G ON A.ID = G.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS miCompleteNum
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''里程碑''
        and to_char(node.plan_end_date, ''YYYY-MM-DD'') <= to_char(sysdate, ''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --里程碑应完成
        ) H ON A.ID = H.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS miCompleted
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''里程碑''
        and actual_end_date is not null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --里程碑已完成
        ) I ON A.ID = I.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS miUnfinished
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''里程碑''
        and to_char(node.plan_end_date,''YYYY-MM-DD'') <= to_char(sysdate,''YYYY-MM-DD'')
        and ACTUAL_END_DATE IS NULL
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --里程碑未完成
        ) J ON A.ID = J.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS olCompleteNum
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''一级节点''
        and to_char(node.plan_end_date, ''YYYY-MM-DD'') <= to_char(sysdate, ''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --一级节点应完成
        ) K ON A.ID = K.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS olCompleted
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''一级节点''
        and actual_end_date is not null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --一级节点已完成
        ) L ON A.ID = L.ID
        left join
        (
        select sp.id, sp.project_name, nvl(count(node.id), 0) AS olUnfinished
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''一级节点''
        and ACTUAL_END_DATE IS NULL
        and to_char(node.plan_end_date,''YYYY-MM-DD'') <= to_char(sysdate,''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --一级节点未完成
        ) M ON A.ID = M.ID

        left join
        (
        select sp.id, sp.project_name, nvl(sum(node.standard_score), 0) AS needResult
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --应得总分
        ) N ON A.ID = N.ID
        left join
        (
        select sp.id, sp.project_name, nvl(sum(exam.standard_score), 0) AS realResult
        from sys_project sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        left join pom_node_examination exam on node.id = exam.original_node_id
        where node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.project_name --实际得分
        ) O ON A.ID = O.ID
        )proj
        union
        select projs.*,
        case when projs.validTasks is null or projs.validTasks = 0 or projs.completed = 0 then
        ''0''
        else to_char((projs.completed / projs.validTasks)*100, ''9999999990.00'') end as completionRate,
        case when projs.needResult is null or projs.needResult = 0 or projs.realResult = 0 then
        ''0''
        else to_char((projs.realResult / projs.needResult)*100, ''9999999990.00'') end as dynamicResult
        FROM (
        select A.*,B.completeNum,C.completed,D.unfinished,N.needResult,O.realResult,E.greenLight,F.yellowLight,G.redLight,H.miCompleteNum,I.miCompleted,J.miUnfinished,
        K.olCompleteNum,L.olCompleted,M.olUnfinished
        from (
        select sp.id,sp.stage_full_name as project_name, nvl(count(node.id), 0) as validTasks
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --有效节点
        ) A
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS completeNum
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where to_char(node.plan_end_date, ''YYYY-MM-DD'') <= to_char(sysdate, ''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --应完成
        ) B ON A.ID = B.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS completed
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.actual_end_date is not null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --已完成
        ) C ON A.ID = C.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS unfinished
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.actual_end_date is null
        and node.is_disable = 0
        and to_char(node.plan_end_date,''YYYY-MM-DD'') <= to_char(sysdate,''YYYY-MM-DD'')
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --未完成
        ) D ON A.ID = D.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS greenLight
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where (TRUNC(ACTUAL_END_DATE) - trunc(PLAN_END_DATE)) <= 0
        and actual_end_date is null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --绿灯
        ) E ON A.ID = E.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS yellowLight
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where (((TRUNC(ACTUAL_END_DATE) - trunc(PLAN_END_DATE)) BETWEEN 1 and 5) or
        ((trunc(SYSDATE) - trunc(PLAN_END_DATE)) BETWEEN 0 and 5))
        and actual_end_date is null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --黄灯
        ) F ON A.ID = F.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS redLight
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where ACTUAL_END_DATE IS NULL
        and ((trunc(SYSDATE) - trunc(NODE.PLAN_END_DATE)) > 5)
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --红灯
        ) G ON A.ID = G.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS miCompleteNum
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''里程碑''
        and to_char(node.plan_end_date, ''YYYY-MM-DD'') <= to_char(sysdate, ''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --里程碑应完成
        ) H ON A.ID = H.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS miCompleted
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''里程碑''
        and actual_end_date is not null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --里程碑已完成
        ) I ON A.ID = I.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS miUnfinished
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''里程碑''
        and ACTUAL_END_DATE IS NULL
        and to_char(node.plan_end_date,''YYYY-MM-DD'') <= to_char(sysdate,''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --里程碑未完成
        ) J ON A.ID = J.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS olCompleteNum
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''一级节点''
        and to_char(node.plan_end_date, ''YYYY-MM-DD'') <= to_char(sysdate, ''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --一级节点应完成
        ) K ON A.ID = K.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS olCompleted
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''一级节点''
        and actual_end_date is not null
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --一级节点已完成
        ) L ON A.ID = L.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(count(node.id), 0) AS olUnfinished
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.node_level = ''一级节点''
        and ACTUAL_END_DATE IS NULL
        and to_char(node.plan_end_date,''YYYY-MM-DD'') <= to_char(sysdate,''YYYY-MM-DD'')
        and node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --一级节点未完成
        ) M ON A.ID = M.ID

        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(sum(node.standard_score), 0) AS needResult
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        where node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --应得总分
        ) N ON A.ID = N.ID
        left join
        (
        select sp.id, sp.stage_full_name as project_name, nvl(sum(exam.standard_score), 0) AS realResult
        from sys_project_stage sp
        left join pom_proj_plan plan on sp.id = plan.proj_id
        left join pom_proj_plan_node node on plan.id = node.proj_plan_id
        left join pom_node_examination exam on node.id = exam.original_node_id
        where node.is_disable = 0
        and plan.approval_status = ''已审核''
        and plan.plan_type = ''关键节点计划''
        group by sp.id, sp.stage_full_name --实际得分
        ) O ON A.ID = O.ID
        )projs
        ) statistics on org.id = statistics.id    --节点统计
        start with org.id = '''||v_id||'''
        connect by prior org.id = parent_id
        )
    SELECT fullAll.*,CASE WHEN fullAll.ISEND =''1'' and fullAll.isCompany=''0'' then
                                  ''<span style="color:#409eff">''||company||''</span>''
                          else company end as "company"
    FROM (
             SELECT id as "id",t1.company as company,org_full_name as "fullName",parent_id as "parentId", to_char(IS_END) AS isEnd,t1.isCompany, t1.jumpUrl as "jumpUrl",
                    (select sum(validTasks) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "validTasks",
                    (select sum(completenum) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "completeNum",
                    (select sum(completed) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "completed",
                    (select sum(unfinished) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "unfinished",
                    (select sum(needResult) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "needResult",
                    (select sum(realResult) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "realResult",
                    (select sum(greenLight) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "greenLight",
                    (select sum(yellowLight) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "yellowLight",
                    (select sum(redlight) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "redLight",
                    (select sum(micompletenum) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "miCompleteNum",
                    (select sum(micompleted) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "miCompleted",
                    (select sum(miunfinished) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "miUnfinished",
                    (select sum(olcompletenum) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "olCompleteNum",
                    (select sum(olcompleted) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "olCompleted",
                    (select sum(olunfinished) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) AS "olUnfinished",
                    case when
                                     (select sum(completeNum) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) is null or
                                     (select sum(completeNum) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) = 0 or
                                     (select sum(completed) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) = 0 then
                             ''0%''
                         else to_char(((select sum(completed) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) /
                                       (select sum(completeNum) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id))*100, ''9999999990.00'') ||''%'' end as "completionRate",
                    case when
                                     (select sum(needResult) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) is null or
                                     (select sum(needResult) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) = 0 or
                                     (select sum(realResult) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) = 0 then
                             ''0''
                         else to_char(((select sum(realResult) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id) /
                                       (select sum(needResult) from temp_origin start with id=t1.id connect by prior id=parent_id and id!=parent_id))*100, ''9999999990.00'') end as "dynamicResult",
                    (select count(validTasks) from temp_origin  where isCompany =''0''  start with t1.id=parent_id connect by prior id=parent_id ) as "childrenLength"
             FROM temp_origin t1 order by t1.code
         ) fullAll where (fullAll."childrenLength">0 and fullAll."childrenLength" is not null and fullAll.isCompany =''1'') or fullAll.isCompany = ''0''';
    open items for v_sql;

END POM_KEY_NODE_SCHEDULE;
/

prompt
prompt Creating procedure P_API_ROLE_USER_RELATION
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_API_ROLE_USER_RELATION AS
BEGIN
    delete from SYS_ROLE_USER_RELATION_RESULT where ROLE_TYPE='30';
	--添加数据到目标表  
	insert into SYS_ROLE_USER_RELATION_RESULT(ID,ROLE_TYPE,ROLE_CODE,ROLE_NAME,USER_ACCOUNT,USER_NAME,PROJECT_ID,PROJECT_NAME,CREATED) 
		SELECT get_uuid(),'30',ROLECODE,ROLENAME,USERACCOUNT,USERNAME,PROJECTID,PROJECTNAME,sysdate FROM API_ROLE_USER_RELATION where USERACCOUNT is not null;
END;
/

prompt
prompt Creating procedure P_API_TRANS_STATION_USER
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_API_TRANS_STATION_USER AS
BEGIN
  DELETE FROM sys_role_user_relation_result where role_type='120';
  
  insert into sys_role_user_relation_result(id,role_type,user_account,user_name, station_id, station_name)
  SELECT a.id,'120',c.user_code,c.user_name,b.id,b.station_name  from SYS_STATION_TO_USER a
  left join SYS_STATION b on a.station_id=b.id
  left join SYS_USER c on a.user_id=c.id;
end;
/

prompt
prompt Creating procedure P_API_TRANS_MANAGEMENT_NODE
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_API_TRANS_MANAGEMENT_NODE AS
BEGIN
	--去重，否则有可能违反主键约束。原因是发现从集团抓取的数据有重复id的情况。
	delete from API_MANAGEMENT_NODE a where (a.ID) in (
		select ID from API_MANAGEMENT_NODE group by ID having count(*) > 1) and rowid not in (
			select min(rowid) from API_MANAGEMENT_NODE group by ID having count(*)>1);
	
	--组织表
	delete from SYS_BUSINESS_UNIT;
	--新增公司
	insert into SYS_BUSINESS_UNIT(ID,ORG_NAME,PARENT_ID,ORG_TYPE,ORDER_CODE,IS_COMPANY) 
		SELECT lower(ID),NAME,lower(PID),'0' as NODETYPE,ORDERNUM as ORDER_CODE,1 as IS_COMPANY 
			FROM API_MANAGEMENT_NODE where NODETYPE = 1;
	--新增部门
	insert into SYS_BUSINESS_UNIT(ID,ORG_NAME,PARENT_ID,ORG_TYPE,ORDER_CODE,IS_COMPANY) 
		SELECT lower(ID),NAME,lower(PID),'1' as NODETYPE,ORDERNUM as ORDER_CODE,0 as IS_COMPANY 
			FROM  API_MANAGEMENT_NODE where NODETYPE = 2;
		
	
	--岗位表
	delete from SYS_STATION;
	insert into SYS_STATION(ID,STATION_NAME,ORG_ID) 
		SELECT lower(ID),NAME,lower(PID) 
			FROM API_MANAGEMENT_NODE where NODETYPE = 3;
	 
	--用户表
	delete from SYS_USER;
	--只有alpha测试环境才需要 PASSWORD 数据，默认为 123
	insert into SYS_USER(ID,USER_CODE,USER_NAME,EMAIL,PASSWORD) 
		SELECT DISTINCT lower(USERID),USERACCOUNT，NAME,EMAIL,'$2a$10$ogMzoaGWd4MFaPX6E/z7x.gzZ9CbbiaXWvnujsSVnVm2Okj10U5Gq' 
			FROM API_MANAGEMENT_NODE where NODETYPE = 4;
	
	--只有alpha测试环境才需要 admin 账号
	--insert into SYS_USER(ID,USER_CODE,USER_NAME,PASSWORD) VALUES('9604c692-e3d0-6e95-e053-0100007f8f52','admin','admin','$2a$10$ogMzoaGWd4MFaPX6E/z7x.gzZ9CbbiaXWvnujsSVnVm2Okj10U5Gq');
	 
	 --用户岗位关系表
	delete from SYS_STATION_TO_USER;
	 
	insert into SYS_STATION_TO_USER (ID,STATION_ID,USER_ID) 
		SELECT lower(get_uuid()) as STATION_TO_USER_ID,lower(PID),lower(USERID) 
			FROM API_MANAGEMENT_NODE where NODETYPE = 4;
            
   
    --计算组织层级：
     DECLARE
                    levelcount   int;
                    orgid varchar(36);
                    CURSOR cursor_calc IS
                    SELECT
                        id
                    FROM
                        sys_business_unit;

                BEGIN                                                  
                --打开游标
                    OPEN cursor_calc;
                    loop
                        fetch cursor_calc into orgid;
                        exit when cursor_calc%notfound;
                            begin
                             select count(*) into levelcount FROM  sys_business_unit  
                                 START WITH ID=orgid  CONNECT BY PRIOR  parent_id=ID;
                                exception
                                        when NO_DATA_FOUND then 
                                        levelcount:=0;
                            end;
                            update sys_business_unit set level_rank=levelcount where id=orgid;
                    end loop;

                    close cursor_calc;

                END;   
                
   
     --计算全局编码：
     DECLARE
                    
                    parentcode varchar(500);
                    orgid varchar(36);
                    CURSOR cursor_calc2 IS
                    SELECT
                        id
                    FROM
                        sys_business_unit;

                BEGIN                                                  
                --打开游标
                    OPEN cursor_calc2;
                    loop
                        fetch cursor_calc2 into orgid;
                        exit when cursor_calc2%notfound;
                        
                     
                            begin
                             select replace(wm_concat(order_code),',','.') into parentcode from (
                                    select replace(lpad(order_code,3),' ','0') as order_code FROM      sys_business_unit 
                                        START WITH ID=orgid  CONNECT BY PRIOR  parent_id=ID
                                        order by level_rank) ds;
                                exception
                                        when NO_DATA_FOUND then 
                                        parentcode:='';
                            end;
                     
                                update sys_business_unit set order_hierarchy_code=parentcode where id=orgid;

                            
                    end loop;

                    close cursor_calc2;

                END;      


--计算组织人数：
     DECLARE
                    total int;
                    orgid varchar(36);
                    CURSOR cursor_calc2 IS
                    SELECT
                        id
                    FROM
                        sys_business_unit;

                BEGIN                                                  
                --打开游标
                    OPEN cursor_calc2;
                    loop
                        fetch cursor_calc2 into orgid;
                        exit when cursor_calc2%notfound;
                        
                            begin
                              select count(distinct user_id) into total from (                                      
                                  select id FROM  sys_business_unit  
                                   START WITH ID=orgid  CONNECT BY PRIOR  ID=parent_id) ds inner join 
                                   (select org_id,user_id from sys_station a inner join SYS_STATION_TO_USER b on a.id=b.station_id) b 
                                   on ds.id=b.org_id;
                                exception
                                        when NO_DATA_FOUND then 
                                        total:=0;
                            end;
 
                                update sys_business_unit set staff_total=total where id=orgid;
                            
                    end loop;

                    close cursor_calc2;

                END;  	

UPDATE SYS_BUSINESS_UNIT A
    SET    A.ORG_FULL_NAME =
				(WITH TMP(ORGID, ORGNAME, ORGFULLNAME) AS (SELECT A1.ID, A1.ORG_NAME, A1.ORG_NAME
															FROM   SYS_BUSINESS_UNIT A1
															WHERE  A1.ID = '003200000000000000000000000000'
															UNION ALL
															SELECT B2.ID, B2.ORG_NAME, A2.ORGFULLNAME || '->' || B2.ORG_NAME
															FROM   TMP A2
															INNER  JOIN SYS_BUSINESS_UNIT B2
															ON     A2.ORGID = B2.PARENT_ID)
						SELECT ORGFULLNAME FROM TMP B WHERE A.ID = B.ORGID);
						
--调用存储过程，写入用户与岗位的关系到SYS_ROLE_USER_RELATION_RESULT 目标表
P_API_TRANS_STATION_USER();
	-----更新用户手机 chenl 2020-02-28 定时任务获取手机有问题暂时同步api表手机号码
    update sys_user  set mobile_phone=(select mobile from api_user  where api_user.USERACCOUNT = sys_user.USER_CODE);

    
     commit;                     

END P_API_TRANS_MANAGEMENT_NODE;
/

prompt
prompt Creating procedure P_API_TRANS_PROJECT
prompt ======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_API_TRANS_PROJECT" AS
BEGIN
		--描述：整理API_PROJECT表中从集团抓取过来的数据。
		--作者：雷吉
		--日期：2019/11/22

		DELETE FROM SYS_PROJECT;
		UPDATE API_PROJECT_NEW SET SN = '0' WHERE SN = 'null';
		--插入项目
		INSERT INTO SYS_PROJECT
				(ID, PROJECT_NAME, PROJECT_CODE, ADDRESS, VICE_PM_NAME, UNIT_NAME,
				 CORP_ID, UPDATE_USER_ID, CITY_CODE, COPR_ID, UPDATE_USER, CORP_NAME,
				 COPR_NAME, VICE_PM_ID, CITY_NAME, STRUCT_TYPE, UNIT_ID, SN,
				 PROJECT_STATE)
		
	/*			SELECT PP.ID, PP.PROJECT_NAME, PP.PROJECT_CODE, PP.PROJ_ADDRESS,
							 PP.VICE_PM_NAME, PP.COMPANY_NAME, PP.CORP_ID, PP.CREATOR_ID,
							 PP.CITY_CODE, PP.COPR_ID, PP.CREATOR, PP.CORP_NAME,
							 PP.COPR_NAME, PP.VICE_PM_ID, PP.PROVINCE_NAME, PP.STRUCT_TYPE,
							 PP.COMPANY_ID, PP.SN, PP.PROJECT_STATE
				FROM   (SELECT ROW_NUMBER() OVER(PARTITION BY P.PROJECT_ORIGINAL_ID ORDER BY P.PROJECT_VERSION) AS NUM,
												LOWER(P.PROJECT_ORIGINAL_ID) AS ID, P.PROJECT_NAME,
												P.PROJECT_CODE, P.PROJ_ADDRESS, NULL AS VICE_PM_NAME,
												P.COMPANY_NAME, NULL AS CORP_ID, P.CREATOR_ID,
												NULL AS CITY_CODE, NULL AS COPR_ID, P.CREATOR,
												P.LEGAL_PERSON_COMPANY AS CORP_NAME,
												P.LEGAL_PERSON_COMPANY AS COPR_NAME,
												NULL AS VICE_PM_ID, P.PROVINCE_NAME,
												NULL AS STRUCT_TYPE, P.COMPANY_ID, '0' AS SN,
												NULL AS PROJECT_STATE
								 FROM   MDM_PROJECT P
								 WHERE  P.APPROVAL_STATUS = '已审核') PP
				WHERE  PP.NUM = 1;*/
		        SELECT LOWER(ID), NAME, CODE, ADDRESS, VICEPMNAME, UNITNAME, CORPID,
           UPDATEUSERID, CITYCODE, COPRID, UPDATEUSER, CORPNAME,
           COPRNAME, VICEPMID, CITYNAME, STRUCTTYPE, LOWER(UNITID),
           TO_NUMBER(SN), STATE
    FROM   API_PROJECT_NEW;
		COMMIT;
END;
/

prompt
prompt Creating procedure P_API_TRANS_PROJECT_STAGE
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_API_TRANS_PROJECT_STAGE" AS
BEGIN
		--描述：整理API_PROJECT_STAGE表中从集团抓取过来的数据。
		--作者：雷吉
		--日期：2019/11/22

		DELETE FROM SYS_PROJECT_STAGE;
		UPDATE API_PROJECT_STAGE SET SN = '0' WHERE SN = 'null';
		--插入项目分期
		INSERT INTO SYS_PROJECT_STAGE

				(ID, STAGE, STAGE_NAME, SN, PROJECT_STATE, PROJECT_ID,IS_FIRST_OPEN_PERIOD)
/*				(SELECT DISTINCT LOWER(C.ID), NULL, C.PERIOD_NAME, '0', NULL,
								LOWER(B.PROJECT_ORIGINAL_ID)
				 FROM   MDM_PROJECT A
				 INNER  JOIN MDM_PERIOD_VERSION B
				 ON     A.PROJECT_ORIGINAL_ID = B.PROJECT_ORIGINAL_ID
				 INNER  JOIN MDM_PERIOD C
				 ON     B.ID = C.PERIOD_VERSION_ID
				 INNER  JOIN (SELECT ROW_NUMBER() OVER(PARTITION BY A.PROJECT_ORIGINAL_ID ORDER BY B.PERIOD_VERSION) AS NUM,
														B.PERIOD_VERSION, B.ID
										 FROM   MDM_PROJECT A
										 INNER  JOIN MDM_PERIOD_VERSION B
										 ON     A.PROJECT_ORIGINAL_ID = B.PROJECT_ORIGINAL_ID
										 \*INNER  JOIN MDM_PERIOD C
                     ON     B.ID = C.PERIOD_VERSION_ID*\
										 WHERE  B.APPROVAL_STATUS = '已审核') P
				 ON     P.ID = B.ID AND
								P.NUM = 1
				 WHERE  B.APPROVAL_STATUS = '已审核');*/

		SELECT DISTINCT LOWER(ID), STAGE, NAME, TO_NUMBER(SN), STATE,
                    LOWER(PROJECTID),ISFIRSTOPENPERIOD 
    FROM   API_PROJECT_STAGE;
		--更新分期表fullName
		COMMIT;
		UPDATE SYS_PROJECT_STAGE C
		SET    C.STAGE_FULL_NAME =
						(SELECT (PROJECT_NAME || STAGE_NAME) AS STAGE_FULL_NAME
						 FROM   SYS_PROJECT_STAGE A
						 LEFT   JOIN SYS_PROJECT B
						 ON     A.PROJECT_ID = B.ID
						 WHERE  C.ID = A.ID);
		COMMIT;
		-- SELECT lower(ID),STAGE,NAME,TO_NUMBER(SN),STATE,lower(PROJECTID) from API_PROJECT_STAGE;
END;
/

prompt
prompt Creating procedure P_API_TRANS_VIRTUAL_ORG_USER
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_API_TRANS_VIRTUAL_ORG_USER AS
		STATIONID    VARCHAR2(36);
		ORGID        VARCHAR2(36);
		DEPTID       VARCHAR2(36);
		DEPTNAME     VARCHAR2(200);
		BUSINESSID   VARCHAR2(36);
		BUSINESSNAME VARCHAR2(200);
		CURSOR CURSOR_STATION IS
				SELECT DISTINCT B.ORG_ID, A.PID FROM API_VIRTUAL_ORG_USER_bak A INNER JOIN SYS_STATION B ON A.PID = B.ID;
BEGIN
		OPEN CURSOR_STATION;
		LOOP
				FETCH CURSOR_STATION
						INTO ORGID, STATIONID;
				EXIT WHEN CURSOR_STATION%NOTFOUND;
		
				SELECT ID, ORG_NAME
				INTO   DEPTID, DEPTNAME
				FROM   SYS_BUSINESS_UNIT
				WHERE  ORG_TYPE = 1 AND
							 ROWNUM = 1
				START  WITH ID = ORGID
				CONNECT BY PRIOR PARENT_ID = ID;
				UPDATE API_VIRTUAL_ORG_USER_BAK SET DEPT_ID = DEPTID, DEPT_NAME = DEPTNAME WHERE PID = STATIONID;
		
		
				SELECT ID, ORG_NAME
				INTO   BUSINESSID, BUSINESSNAME
				FROM   SYS_BUSINESS_UNIT
				WHERE  ORG_TYPE = 0 AND
							 ROWNUM = 1
				START  WITH ID = ORGID
				CONNECT BY PRIOR PARENT_ID = ID;
				UPDATE API_VIRTUAL_ORG_USER_BAK SET COMPANY_ID = businessid, COMPANY_NAME = businessname WHERE PID = STATIONID;
		
		END LOOP;
		CLOSE CURSOR_STATION;

		COMMIT;



		DELETE FROM SYS_ROLE_USER_RELATION_RESULT WHERE ROLE_TYPE = '40';
		INSERT INTO SYS_ROLE_USER_RELATION_RESULT
				(ID, ROLE_TYPE, USER_ACCOUNT, USER_NAME, VIRTUAL_GROUP_ID, VIRTUAL_GROUP_NAME, CREATED, DEPT_ID, DEPT_NAME, COMPANY_ID, COMPANY_NAME)
				SELECT GET_UUID(), '40', USERACCOUNT, NAME, VGUID, VNAME, SYSDATE, DEPT_ID, DEPT_NAME, COMPANY_ID, COMPANY_NAME FROM API_VIRTUAL_ORG_USER_BAK;
		COMMIT;

END;
/

prompt
prompt Creating procedure P_SYS_AUTH_DATA_RULE_SPID
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_SYS_AUTH_DATA_RULE_SPID( USERID IN VARCHAR2, STATIONID IN VARCHAR2, DEPTID IN VARCHAR2, COMPANYID IN VARCHAR2, BIZCODE IN VARCHAR2 ,
DATA_AUTH_SPID OUT VARCHAR2) 
AS
--数据鉴权，返回数据权限中有权限的项目或部门（不考虑隔离规则）
--作者：谷国斌
--日期：2019/12/13
AUTHCOUNT INT;--用于判断当前公司、部门是否与数据授权的主体有关系
SPID VARCHAR2(36);--使用临时表的批次号
BEGIN
select get_uuid() into SPID from dual;
------------------------------------------------------开始-----------------------------------------------部门和项目 复制谷哥鉴权存储过程 
--插入数据授权的数据：

        DECLARE
                OWNERID  VARCHAR2(36);
                OENERTYPE NVARCHAR2(50);
                CURSOR cursor_company IS
                select distinct auth_owner_id,auth_owner_type from SYS_DATA_AUTH where auth_biz_code=BIZCODE and is_disabled=0;

            BEGIN   

            --打开游标
                OPEN cursor_company;
                loop
                    fetch cursor_company into OWNERID,OENERTYPE;
                    exit when cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                if OENERTYPE='公司' or OENERTYPE='集团'
                then
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                     SELECT count(*) into AUTHCOUNT FROM sys_business_unit where is_company=1 and id=COMPANYID
                    START WITH ID=OWNERID CONNECT BY PRIOR  ID=parent_id;
                    if AUTHCOUNT<>0
                    then
                        insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
                        values(SPID,OWNERID,OENERTYPE);

                    end if;

                end if;

                 if OENERTYPE='部门'
                then
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                     SELECT count(*) into AUTHCOUNT FROM sys_business_unit where is_company=0 and id=DEPTID
                    START WITH ID=OWNERID CONNECT BY PRIOR  ID=parent_id;
                    if AUTHCOUNT<>0
                    then
                        insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
                        values(SPID,OWNERID,OENERTYPE);

                    end if;

                end if;

                 if (OENERTYPE='岗位' and OWNERID=STATIONID) or (OENERTYPE='人员' and OWNERID=USERID)
                then

                       insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
                        values(SPID,OWNERID,OENERTYPE);    
                end if;

                end loop;

                close cursor_company;

            END;   


          --获取有权限的公司及其部门：            
                DECLARE
                        OWNERID2  VARCHAR2(36);
                        CURSOR cursor_auth IS
                        select distinct auth_owner_id from TMP_AUTH_OWNER where ID=SPID;

                    BEGIN   

                    --打开游标
                        OPEN cursor_auth;
                        loop
                            fetch cursor_auth into OWNERID2;
                            exit when cursor_auth%notfound;


                            --授权对象为公司：
                            --取授权公司的子级：
                            insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,ID FROM
                            sys_business_unit where is_company=0
                                START WITH ID in (
                                select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type in ('公司','集团') and auth_type='部门'
                                )  CONNECT BY PRIOR  ID=parent_id;


                         insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,org_id FROM
                            v_sys_project where org_type<>0
                                START WITH org_id in (
                                select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type in ('公司','集团') and auth_type='项目'
                                )  CONNECT BY PRIOR  org_id=parent_id;

                           --插入可研项目     
                          insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,id FROM
                            CDB_FEASIBLE_PROJECT_CONFIG 
                            where subordinate_company_id in
                                (select id from sys_business_unit where is_company=1 START WITH id in (
                                select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type in ('公司','集团') and auth_type='项目'
                                )  CONNECT BY PRIOR  id=parent_id);       

                             --授权对象为部门：
                               --取授权部门及其子级：

                                 insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,ID FROM
                            sys_business_unit where is_company=0
                                START WITH ID in  (select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type='部门' and auth_type='部门'
                                )  CONNECT BY PRIOR  ID=parent_id;

                               --授权对象为项目： 
                            insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,org_id FROM
                            v_sys_project where org_type<>0 and project_id in 
                                 (select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type='项目' and auth_type='项目'
                                );   

                              end loop;
                           close  cursor_auth;    
                        end;

    --2020/2/20:成本数据库需要，增加
    --插入隔离规则-项目：
    insert into TMP_AUTH_LIST(ID,ORG_ID)
    select SPID,id from sys_project a inner join (
    select ISOLATION_RULE_VALUE from SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE=BIZCODE and ISOLATION_RULE_VALUE='全集团')
    on 1=1;
    --插入隔离规则-可研项目：
    insert into TMP_AUTH_LIST(ID,ORG_ID)
    select SPID,id from CDB_FEASIBLE_PROJECT_CONFIG a inner join (
    select ISOLATION_RULE_VALUE from SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE=BIZCODE and ISOLATION_RULE_VALUE='全集团')
    on 1=1;
    --插入隔离规则-项目：
    insert into TMP_AUTH_LIST(ID,ORG_ID)
    select SPID,id from sys_project a inner join (
    select ISOLATION_RULE_VALUE from SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE=BIZCODE and ISOLATION_RULE_VALUE='本公司')
    on 1=1 where a.unit_id=COMPANYID;
    --插入隔离规则-可研项目：
    insert into TMP_AUTH_LIST(ID,ORG_ID)
    select SPID,id from CDB_FEASIBLE_PROJECT_CONFIG a inner join (
    select ISOLATION_RULE_VALUE from SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE=BIZCODE and ISOLATION_RULE_VALUE='本公司')
    on 1=1 where a.subordinate_company_id=COMPANYID;
------------------------------------------------------结束-----------------------------------------------部门和项目 复制谷哥鉴权存储过程 
-------------------------------------------------------开始----------------------------------------------公司、岗位、人 chenl
    --插入隔离规则-公司、岗位、人
    insert into TMP_AUTH_LIST(ID,ORG_ID)
  	SELECT SPID,
CASE 
	ISOLATION_RULE_VALUE 
	WHEN '本公司' THEN COMPANYID
	WHEN '本部门' THEN DEPTID
	WHEN '本岗位' THEN STATIONID
	WHEN '本人' THEN USERID
	ELSE ''
END AS AUTH_SCOPE_ID
FROM SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE = BIZCODE and ISOLATION_RULE_VALUE in ('本公司','本部门','本岗位','本人');


 DATA_AUTH_SPID:=SPID;
-- open DATA_AUTH_INFO for
--select distinct ORG_ID as orgId
--from TMP_AUTH_LIST WHERE ID=SPID;

END P_SYS_AUTH_DATA_RULE_SPID;
/

prompt
prompt Creating procedure P_CHENL_TEST_DATA
prompt ====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_chenl_test_data (
    USERID IN VARCHAR2,
    STATIONID IN VARCHAR2,
    DEPTID IN VARCHAR2,
    COMPANYID IN VARCHAR2,
    authcode in VARCHAR2,
    userInfo     OUT      SYS_REFCURSOR,--当前用户信息
    data_auth_info OUT SYS_REFCURSOR,--权限数据
    plan_test_info OUT SYS_REFCURSOR,--计划测试数据
    test_out out VARCHAR2
) AS

    bizcode          VARCHAR2(200);
    data_auth_spid   VARCHAR2(200);
    orgid            VARCHAR2(200);
BEGIN
    bizcode :=nvl(authcode,'POM.JHBZYTZ.03');
    p_sys_auth_data_rule_spid(userid => userid, stationid => stationid, deptid => deptid, companyid => companyid, bizcode => bizcode
    , data_auth_spid => data_auth_spid);
---测试多输出
 test_out:='authcode=>'||bizcode;
-- 当前用户数据

    OPEN userInfo FOR SELECT  USERID as "USERID",
    STATIONID as "STATIONID",
    DEPTID as "DEPTID",
    COMPANYID as "COMPANYID",
    bizcode as "bizcode"
                  FROM
                      dual;
----权限数据
open DATA_AUTH_INFO for
select ROWNUM as s,a.orgid,p.ORG_NAME,p.ORG_NAME,p.ORG_TYPE,u.org_name as  UNIT,u.ORDER_HIERARCHY_CODE  from (select distinct ORG_ID as orgId  
from TMP_AUTH_LIST  WHERE ID=DATA_AUTH_SPID ) a 
left join V_SYS_PROJECT  p on a.orgId=p.ORG_id
left join SYS_BUSINESS_UNIT u on a.orgId=u.id;
---计划测试数据
    OPEN plan_test_info FOR select '测试' as from dual;


END p_chenl_test_data;
/

prompt
prompt Creating procedure P_DWM_ALLFILTERCONDITION
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_AllFilterCondition(filter OUT sys_refcursor)
as
begin
open filter for
select * from(
select 'isStart' as id, 'isStart' as "value",'是否已开工' as "lable",null as ParentId,1 as "sort",1 as "isChecked"  from dual
UNION
select 'isStart-01' as id,'1' as "value",'已开工' as "lable",'isStart' as ParentId,1 as "sort",1 as "isChecked"  from dual
UNION
select 'isStart-00' as id,'0' as "value",'未开工' as "lable",'isStart' as ParentId,2 as "sort",1 as "isChecked"  from dual

UNION
select  'opening' as id, 'opening' as "value",'是否已开盘' as "lable",null as ParentId,2 as "sort",0 as "isChecked"  from dual
UNION
select 'opening-01' as id ,'1' as "value",'是' as "lable",'opening' as ParentId,1 as "sort",1 as "isChecked"  from dual
UNION
select  'opening-00' as id,'0' as "value",'否' as "lable",'opening' as ParentId,2 as "sort",0 as "isChecked"  from dual

UNION
select 'openingYear' as id,'openingYear' as "value",'项目首开年份' as "lable",null as ParentId,3 as "sort",0 as "isChecked"  from dual
UNION
select 'openingYear-<2017' as id,'<2017' as "value" ,'2017年之前' as "lable",'openingYear' as ParentId,0 as "sort",0 as "isChecked"   from dual
UNION
select 'openingYear-'||to_char(tab.year) as id,to_char(tab.year) as "value",
to_char(tab.year)||'年' as "lable",
'openingYear' as ParentId,
ROWNUM+1 as "sort",
0 as "isChecked"
from (SELECT to_number(to_char(sysdate,'yyyy'))-ROWNUM+1 year FROM DUAL
CONNECT BY LEVEL<=4 order by year asc) tab

union
select 'isOperate' as id,'isOperate' as "value",'是否操盘' as "lable",null as ParentId,4 as "sort",0 as "isChecked"  from dual
UNION
select 'isOperate-01' as id ,'1' as "value",'是' as "lable",'isOperate' as ParentId,1 as "sort",0 as "isChecked"  from dual
UNION
select  'isOperate-00' as id,'0' as "value",'否' as "lable",'isOperate' as ParentId,2 as "sort",0 as "isChecked"  from dual

union
select 'isHasExistingHouse' as id,'isHasExistingHouse' as "value",'是否有现房存货' as "lable",null as ParentId,5 as "sort",0 as "isChecked"  from dual
UNION
select 'isHasExistingHouse-01' as id ,'1' as "value",'是' as "lable",'isHasExistingHouse' as ParentId,1 as "sort",0 as "isChecked"  from dual
UNION
select  'isHasExistingHouse-00' as id,'0' as "value",'否' as "lable",'isHasExistingHouse' as ParentId,2 as "sort",0 as "isChecked"  from dual


UNION
select 'obtainYear' as id, 'obtainYear' as "value",'项目获得年份' as "lable",null as ParentId,6 as "sort",0 as "isChecked"  from dual
UNION
select
'obtainYear-'||to_char(tab.year) as id,
case when ROWNUM=1 then '<='||to_char(tab.year) else to_char(tab.year) end "value",
case when ROWNUM=1 then to_char(tab.year)||'年之前' else to_char(tab.year)||'年' end "lable",
'obtainYear' as ParentId,
ROWNUM as "sort",
0 as "isChecked"
from (SELECT to_number(to_char(sysdate,'yyyy'))-ROWNUM+1 year FROM DUAL
CONNECT BY LEVEL<=5 order by year asc) tab


UNION
select  'org' as id, 'org' as "value",'二级单位' as "lable",null as ParentId,7 as "sort",0 as "isChecked"  from dual
UNION
select  'org-'||tab."value" as id,tab."value",tab."lable",tab."ParentId",ROWNUM as "sort",tab."isChecked" from (select id "value" ,org_name  "lable",'org' as "ParentId",ORDER_HIERARCHY_CODE as "sort",0 as "isChecked"  from (select ID,org_name,order_hierarchy_code from (select ORG_ID from DWM_SALE_RATE_PROJECT group by ORG_ID) tab left join  SYS_BUSINESS_UNIT on tab.ORG_ID=SYS_BUSINESS_UNIT.ID where SYS_BUSINESS_UNIT.LEVEL_RANK=2
        union 
        select ID,org_name,order_hierarchy_code from  (select parent_id  from (select ORG_ID from DWM_SALE_RATE_PROJECT group by ORG_ID) tab left join  SYS_BUSINESS_UNIT on tab.ORG_ID=SYS_BUSINESS_UNIT.ID where SYS_BUSINESS_UNIT.LEVEL_RANK=3) orgids 
        left join SYS_BUSINESS_UNIT on orgids.parent_id=SYS_BUSINESS_UNIT.id
        union
        select ID,org_name,order_hierarchy_code from(select * from SYS_BUSINESS_UNIT m start with m.id in (
        select sys_business_unit.ID from (select ORG_ID from DWM_SALE_RATE_PROJECT group by ORG_ID) tab left join  SYS_BUSINESS_UNIT on tab.ORG_ID=SYS_BUSINESS_UNIT.ID where SYS_BUSINESS_UNIT.LEVEL_RANK>3
        ) connect by prior m.parent_id=m.id)tab where tab.LEVEL_RANK=2 ) orgs order by orgs.order_hierarchy_code)tab

UNION
select  'hasFirstPhaseKeyPlan' as id, 'hasFirstPhaseKeyPlan' as "value",'已上线首期关键节点计划' as "lable",null as ParentId,8 as "sort",0 as "isChecked"  from dual
UNION
select 'hasFirstPhaseKeyPlan-01' as id ,'1' as "value",'是' as "lable",'hasFirstPhaseKeyPlan' as ParentId,1 as "sort",1 as "isChecked"  from dual
UNION
select  'hasFirstPhaseKeyPlan-00' as id,'0' as "value",'否' as "lable",'hasFirstPhaseKeyPlan' as ParentId,2 as "sort",0 as "isChecked"  from dual

        )filterItems order by filterItems."sort" ;
end P_DWM_AllFilterCondition;
/

prompt
prompt Creating procedure P_DWM_PROJECTSALERATEDATALIST
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_ProjectSaleRateDataList(filter in clob,keyWord in varchar2,rowCnt in number,sortField in varchar,orderby in varchar,items out sys_refcursor,total out number)
as
groupName varchar2(200);
v_sql  clob:='';
v_where clob:='';
v_org_where clob:='';
filterItemStr clob:='';
hasAll number;
ItemStr varchar(1000);
orderbyStr  varchar(1000);
sortFieldStr varchar(1000);
yearStr varchar(1000);
v_count_sql clob:='';
top_str  varchar(100);
RowCount number;
detailstr clob:='';
begin
delete PERSON_ROLE_ANALYSIS_TABLE;
 if filter is not null then
insert into PERSON_ROLE_ANALYSIS_TABLE (code,detail,type )  SELECT  SYS_GUID(),COLUMN_VALUE ,'filter' FROM table (split (filter,';'));
        for item in ( SELECT code,detail FROM  PERSON_ROLE_ANALYSIS_TABLE where type='filter' ) loop
               if INSTR(item.detail,':')<>0 then
                    groupName:= SUBSTR(item.detail,0,INSTR(item.detail,':')-1);
                    detailstr:=REPLACE(item.detail,groupName||':','');
                    if detailstr is not null then
                        update PERSON_ROLE_ANALYSIS_TABLE set detail= REPLACE(item.detail,groupName||':',''),type=groupName  where code=item.code;
                    end if;
                else
                    delete PERSON_ROLE_ANALYSIS_TABLE where code=item.code;
               end if;
      end loop;    
end if;

select count(1) into  RowCount from PERSON_ROLE_ANALYSIS_TABLE where  type='isStart';
if RowCount<>0 then
    select detail into filterItemStr from PERSON_ROLE_ANALYSIS_TABLE where  type='isStart' and rownum=1;
    if filterItemStr is not null then
        SELECT count(1) into hasAll  FROM table (split (filterItemStr,',')) where COLUMN_VALUE='all' ;
        if hasAll=0 then
            v_where:=' and tab."isConstructionBegan" in ('||filterItemStr||')';
        end if;
    end if;
end if;

select count(1) into  RowCount from PERSON_ROLE_ANALYSIS_TABLE where  type='opening';
if RowCount<>0 then
    select detail into filterItemStr from PERSON_ROLE_ANALYSIS_TABLE where  type='opening' and rownum=1;
    if filterItemStr is not null then
        SELECT count(1) into hasAll  FROM table (split (filterItemStr,',')) where COLUMN_VALUE='all' ;
        if hasAll=0 then
            v_where:=v_where||' and tab."hasFirstOpenDate" in ('||filterItemStr||')';
        end if;
    end if;
end if;

select count(1) into  RowCount from PERSON_ROLE_ANALYSIS_TABLE where  type='isOperate';
if RowCount<>0 then
    select detail into filterItemStr from PERSON_ROLE_ANALYSIS_TABLE where  type='isOperate' and rownum=1;
    if filterItemStr is not null then
        SELECT count(1) into hasAll  FROM table (split (filterItemStr,',')) where COLUMN_VALUE='all' ;
        if hasAll=0 then
            v_where:=v_where||' and tab."isOperate" in ('||filterItemStr||')';
        end if;
    end if;
end if;

select count(1) into  RowCount from PERSON_ROLE_ANALYSIS_TABLE where  type='isHasExistingHouse';
if RowCount<>0 then
    select detail into filterItemStr from PERSON_ROLE_ANALYSIS_TABLE where  type='isHasExistingHouse' and rownum=1;
    if filterItemStr is not null then
        SELECT count(1) into hasAll  FROM table (split (filterItemStr,',')) where COLUMN_VALUE='all' ;
        if hasAll=0 then
            v_where:=v_where||' and tab."isHasExistingHouse" in ('||filterItemStr||')';
        end if;
    end if;
end if;

select count(1) into  RowCount from PERSON_ROLE_ANALYSIS_TABLE where  type='hasFirstPhaseKeyPlan';
if RowCount<>0 then
    select detail into filterItemStr from PERSON_ROLE_ANALYSIS_TABLE where  type='hasFirstPhaseKeyPlan' and rownum=1;
    if filterItemStr is not null then
        SELECT count(1) into hasAll  FROM table (split (filterItemStr,',')) where COLUMN_VALUE='all' ;
        if hasAll=0 then
            v_where:=v_where||' and tab."hasFirstPhaseKeyPlan" in ('||filterItemStr||')';
        end if;
    end if;
end if;

select count(1) into  RowCount from PERSON_ROLE_ANALYSIS_TABLE where  type='openingYear';
if RowCount<>0 then
    select detail into filterItemStr from PERSON_ROLE_ANALYSIS_TABLE where  type='openingYear' and rownum=1;
    if filterItemStr is not null then
        SELECT count(1) into hasAll  FROM table (split (filterItemStr,',')) where COLUMN_VALUE='all' ;
        if hasAll=0 then
             v_where:=v_where||' and ( ';
                 for item in (  SELECT COLUMN_VALUE as detail FROM table (split (filterItemStr)) ) loop
                        if INSTR(item.detail,'<')<>0 then
                                if yearStr is null then 
                                    yearStr:=yearStr||' to_number(to_char(tab."firstOpenDateValue",''yyyy''))<'||REPLACE(item.detail,'<','');
                                else
                                    yearStr:=yearStr||' or to_number(to_char(tab."firstOpenDateValue",''yyyy''))<'||REPLACE(item.detail,'<','');
                                end if;
                        else
                                  if yearStr is null then 
                                    yearStr:=yearStr||' to_number(to_char(tab."firstOpenDateValue",''yyyy''))='||item.detail;
                                else
                                    yearStr:=yearStr||' or to_number(to_char(tab."firstOpenDateValue",''yyyy''))='||item.detail;
                                end if;
                        end if;
                  end loop;   
                  if yearStr is null then
                    yearStr:=' 1=1 ';
                  end if;
               v_where:=v_where||yearStr||')';
        end if;
    end if;
end if;

select count(1) into  RowCount from PERSON_ROLE_ANALYSIS_TABLE where  type='obtainYear';
if RowCount<>0 then
    select detail into filterItemStr from PERSON_ROLE_ANALYSIS_TABLE where  type='obtainYear' and rownum=1;
    if filterItemStr is not null then
        SELECT count(1) into hasAll  FROM table (split (filterItemStr,',')) where COLUMN_VALUE='all' ;
        if hasAll=0 then
             v_where:=v_where||' and ( ';
                 for item in (  SELECT COLUMN_VALUE as detail FROM table (split (filterItemStr)) ) loop
                        if INSTR(item.detail,'<')<>0 then
                                if yearStr is null then 
                                    yearStr:=yearStr||' to_number(to_char(tab."obtainDateValue",''yyyy''))<'||REPLACE(item.detail,'<','');
                                else
                                    yearStr:=yearStr||' or to_number(to_char(tab."obtainDateValue",''yyyy''))<'||REPLACE(item.detail,'<','');
                                end if;
                        else
                                  if yearStr is null then 
                                    yearStr:=yearStr||' to_number(to_char(tab."obtainDateValue",''yyyy''))='||item.detail;
                                else
                                    yearStr:=yearStr||' or to_number(to_char(tab."obtainDateValue",''yyyy''))='||item.detail;
                                end if;
                        end if;
                  end loop;   
                  if yearStr is null then
                    yearStr:=' 1=1 ';
                  end if;
              v_where:=v_where||yearStr||')';
        end if;
    end if;
end if;

select count(1) into  RowCount from PERSON_ROLE_ANALYSIS_TABLE where  type='org';
if RowCount<>0 then
    select detail into filterItemStr from PERSON_ROLE_ANALYSIS_TABLE where  type='org' and rownum=1;
    if filterItemStr is not null then
        SELECT count(1) into hasAll  FROM table (split (filterItemStr,',')) where COLUMN_VALUE='all' ;
        if hasAll=0 then
               v_org_where:=' inner join 
               (select id from SYS_BUSINESS_UNIT m start with m.id in (SELECT COLUMN_VALUE FROM table (split ('''||filterItemStr||''','',''))) 
               connect by m.PARENT_ID=prior m.id) unit
               on unit.id=tab.org_id ';
        end if;
    end if;
end if;

if sortField is null then
sortFieldStr:='foSaleRateByCountValue';
else
sortFieldStr:=sortField||'Value';
end if;
if orderby is null then
orderbyStr:='desc';
else
orderbyStr:=orderby;
end if;

if rowcnt=30 or rowcnt is null  then
    top_str:=' rownum<=30 ';
end if;

if keyWord is not null then
    v_where:=v_where||' and tab."projectName"  like  ''%'||keyWord||'%'' ';
end if;

 dbms_output.put_line(v_where);

v_sql:='select * from(SELECT
    proj.project_id as "project_id", 
    proj.project_name as "projectNameValue",
    case when proj.HAS_FIRST_PHASE_KEY_PLAN is null then 0 else proj.HAS_FIRST_PHASE_KEY_PLAN end  as "hasFirstPhaseKeyPlan",
    FN_DWM_FONT_COLOR(proj.project_name) as "projectName",
    proj.org_id,
    proj.IS_OPERATE as "isOperate",
    case when rate.si_surplus_sale_money is not null and rate.si_surplus_sale_money <> 0 then 1 else 0 end as "isHasExistingHouse",
    case when proj.FIRST_OPEN_DATE is not null then 1 else 0 end as "hasFirstOpenDate",
    proj.IS_CONSTRUCTION_BEGAN as "isConstructionBegan",
    proj.FIRST_OPEN_DURATION_BY_TL as "firstOpenDurationByTlValue",
    FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_TL) as "firstOpenDurationByTlText",
    FN_DWM_FONT_COLOR(FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_TL)) as "firstOpenDurationByTl",
    proj.OBTAIN_DATE as "obtainDateValue",
    to_char(proj.OBTAIN_DATE,''yyyy-mm-dd'') as "obtainDate",
    proj.FIRST_OPEN_DATE  as "firstOpenDateValue",
    to_char(proj.FIRST_OPEN_DATE,''yyyy-mm-dd'')  as "firstOpenDate",
    case when rate.fo_sale_rate_by_count is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(rate.fo_sale_rate_by_count)) else 
    FN_DWM_FONT_COLOR(''0%'') end as "foSaleRateByCount",

   case when rate.fo_sale_rate_by_count is not null then
   rate.fo_sale_rate_by_count*100 else 
   0 end as "foSaleRateByCountValue",

   case when rate.fo_sale_rate_by_count is not null then
   fn_ConvertDecimalToPercentage(rate.fo_sale_rate_by_count) else 
   ''0%'' end as "foSaleRateByCountText",

    case when rate.po_sale_rate_by_money is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(rate.po_sale_rate_by_money)) else 
    FN_DWM_FONT_COLOR(''0%'') end as "poSaleRateByMoney",

    case when rate.po_sale_rate_by_money is not null then
   rate.po_sale_rate_by_money*100 else 
    0 end as "poSaleRateByMoneyValue",

     case when rate.po_sale_rate_by_money is not null then
    fn_ConvertDecimalToPercentage(rate.po_sale_rate_by_money) else 
    ''0%'' end as "poSaleRateByMoneyText",

    case when rate.eh_sale_rate_by_money is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(rate.eh_sale_rate_by_money)) else 
    FN_DWM_FONT_COLOR(''0%'') end as "ehSaleRateByMoney",

    case when rate.eh_sale_rate_by_money is not null then
    fn_ConvertDecimalToPercentage(rate.eh_sale_rate_by_money) else 
    ''0%'' end as "ehSaleRateByMoneyText",

    case when rate.eh_sale_rate_by_money is not null then
    rate.eh_sale_rate_by_money*100 else 
    0 end as "ehSaleRateByMoneyValue",


    case when rate.si_sale_rate_by_money is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(rate.si_sale_rate_by_money)) else 
    FN_DWM_FONT_COLOR(''0%'') end as "siSaleRateByMoney",

    case when rate.si_sale_rate_by_money is not null then
    rate.si_sale_rate_by_money*100 else 
    0 end as "siSaleRateByMoneyValue",

    case when rate.si_sale_rate_by_money is not null then
    fn_ConvertDecimalToPercentage(rate.si_sale_rate_by_money) else 
    ''0%'' end as "siSaleRateByMoneyText",

    case when rate.po_surplus_sale_money is not null then
    FN_DWN_AmountToBillionYuan(rate.po_surplus_sale_money) else 
    ''0.00亿'' end as "poSurplusSaleMoney",

    case when rate.eh_surplus_sale_money is not null then
    FN_DWN_AmountToBillionYuan(rate.eh_surplus_sale_money) else 
    ''0.00亿'' end as "ehSurplusSaleMoney",

     case when rate.si_surplus_sale_money is not null then
    FN_DWN_AmountToBillionYuan(rate.si_surplus_sale_money) else 
    ''0.00亿'' end as "siSurplusSaleMoney",

     case when rate.po_surplus_sale_money is not null then
     rate.po_surplus_sale_money   else 
    0 end as "poSurplusSaleMoneyValue",

      case when rate.eh_surplus_sale_money is not null then
     rate.eh_surplus_sale_money   else 
    0 end as "ehSurplusSaleMoneyValue",

      case when rate.si_surplus_sale_money is not null then
     rate.si_surplus_sale_money   else 
    0 end as "siSurplusSaleMoneyValue"

FROM
   DWM_SALE_RATE_PROJECT proj left join dwm_sale_rate_by_project rate on proj.project_id=rate.project_id) tab';
   v_sql:=v_sql||v_org_where||' where 1=1 '|| v_where;
   v_count_sql:='select count(1) FROM ('||v_sql||') tabCount';
   if top_str is not null then
    v_sql:='select * from ('||v_sql||' order by tab."'||sortFieldStr||'" '||orderbyStr||') list where '||top_str ;
   else
    v_sql:=v_sql||' order by tab."'||sortFieldStr||'" '||orderbyStr;
   end if;
 dbms_output.put_line(v_sql);
   execute immediate v_count_sql into total;  
    OPEN items FOR v_sql;
    EXCEPTION
    WHEN OTHERS THEN
      CLOSE items;
 end P_DWM_ProjectSaleRateDataList;
--=================================================================定时任务结束================================================================
/

prompt
prompt Creating procedure P_DWM_ALLPROJECTSALERATE
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_AllProjectSaleRate(filter in clob,keyWord in varchar2,rowCnt in number,sortField in varchar,orderby in varchar,datalist out sys_refcursor,total out number,describe out clob,allSortField out sys_refcursor)
as
begin
delete PERSON_ROLE_ANALYSIS_TABLE;
open allSortField for
SELECT COLUMN_VALUE as "fieldName" FROM table (split ('projectName,obtainDate,firstOpenDate,foSaleRateByCount,firstOpenDurationByTl,poSaleRateByMoney,siSaleRateByMoney,ehSaleRateByMoney,poSurplusSaleMoney,ehSurplusSaleMoney,siSurplusSaleMoney'));
P_DWM_PROJECTSALERATEDATALIST(
    FILTER => filter,
    KEYWORD => keyWord,
    ROWCNT => rowCnt,
    SORTFIELD => sortField,
    ORDERBY => orderby,
    ITEMS => datalist,
    TOTAL => total
  );
   describe:='符合条件的共'||FN_DWM_FONT_COLOR(total||'个项目')||'。点击表头可再次排序；点击项目名称，可穿透查看单项目去化率分析详情。';

 end P_DWM_AllProjectSaleRate;
/

prompt
prompt Creating procedure P_DWM_BRIEFINGANDK1K2
prompt ========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_briefingAndK1K2 (k1DataList OUT sys_refcursor,k2DataList OUT sys_refcursor,bigData  OUT sys_refcursor,k1DataSortField OUT sys_refcursor,k2DataSortField OUT sys_refcursor,k2preparedatasortfield OUT sys_refcursor,tabitems OUT sys_refcursor,k1DataListCount out number,k2DataListCount out number,k2preparedatalistcount out number)
AS  
k1_1abstract varchar2(4000);
k1_2abstract varchar2(4000);
k2_1abstract varchar2(4000);
k2_2abstract varchar2(4000);
k2_3abstract varchar2(4000);
k2_1ListCount number;
k2_3ListCount number;
k2_3_2ListCount number;
begin
SELECT details into k1_1abstract FROM dwm_sale_rate_data_briefing where CODE='k1.1' and rownum=1;
SELECT details into k1_2abstract FROM dwm_sale_rate_data_briefing where CODE='k1.2' and rownum=1;
SELECT details into k2_1abstract FROM dwm_sale_rate_data_briefing where CODE='k2.1' and rownum=1;
SELECT details into k2_2abstract FROM dwm_sale_rate_data_briefing where CODE='k2.2' and rownum=1;
SELECT details into k2_3abstract  FROM dwm_sale_rate_data_briefing where CODE='k2.3' and rownum=1;
select Count(1) into k2_1ListCount from  dwm_sale_rate_project where FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'));
select Count(1) into k2_3ListCount from  dwm_sale_rate_project where FIRST_OPEN_DATE is null and( to_number(to_char(PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) or to_number(to_char(NEW_PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')));
select Count(1) into k2_3_2ListCount from  dwm_sale_rate_project where FIRST_OPEN_DATE is null and (to_number(to_char(PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) or to_number(to_char(NEW_PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'))) and (NEW_PLAN_FIRST_OPEN_DATE< sysdate or PLAN_FIRST_OPEN_DATE< sysdate);

select count(1) into k1DataListCount from DWM_SALE_RATE_PROJECT p left join  dwm_sale_rate_by_project fo on fo.project_id=p.project_id where  p.PROJECT_NAME is not null and to_number(to_char(p.FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'));
select count(1) into k2DataListCount from dwm_sale_rate_project where FIRST_OPEN_DATE is not null and  to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'));

k2preparedatalistcount:=k2_3ListCount;
open k1DataList for  
select * from (SELECT
    fo.project_id as "projectId",
    FN_DWM_FONT_COLOR(p.PROJECT_NAME) as "projectName",
    to_char(p.FIRST_OPEN_DATE,'yyyy-mm-dd') as "firstOpenDate",
    case when fo.fo_sale_out_count is not null then
    to_char(fo.fo_sale_out_count)||'套'else
    '0套' end as "foSaleOutCount",
    case when fo.fo_sale_count is not null then
    to_char(fo.fo_sale_count)||'套'else
    '0套' end as "foSaleCount",
    case when fo.fo_sale_rate_by_count is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo.fo_sale_rate_by_count)) else 
    FN_DWM_FONT_COLOR('0%') end as "foSaleRateByCount",
    FN_DWN_AreaTo1000Square(fo.fo_sale_out_area) as "foSaleOutArea",
    FN_DWN_AreaTo1000Square(fo.fo_sale_area) as "foSaleArea",
    case when fo.fo_sale_rate_by_area is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo.fo_sale_rate_by_area)) else
    FN_DWM_FONT_COLOR('0%') end as "foSaleRateByArea",
    FN_DWN_AmountToBillionYuan(fo.fo_sale_out_money) as "foSaleOutMoney",
    FN_DWN_AmountToBillionYuan(fo.fo_sale_money) as "foSaleMoney",
    case when fo.fo_sale_rate_by_money is not null then
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo.fo_sale_rate_by_money)) else
    FN_DWM_FONT_COLOR('0%') end as "foSaleRateByMoney",
    case when fo.fo_sale_rate_by_money  is  null then
    0 else fo.fo_sale_rate_by_money end as "fo_sale_rate_by_money"
FROM
    DWM_SALE_RATE_PROJECT p left join 
    dwm_sale_rate_by_project fo on fo.project_id=p.project_id where  p.PROJECT_NAME is not null and to_number(to_char(p.FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) ) tab where  rownum<=10  order by tab."fo_sale_rate_by_money"  desc;
open k2DataList for  
select * from (SELECT
    project_id as "projectId",
    FN_DWM_FONT_COLOR(project_name) as "projectName",
    FN_DWM_FONT_COLOR(to_char(FIRST_OPEN_DATE,'yyyy-mm-dd')) as "firstOpenDate",
    to_char(take_land_date,'yyyy-mm-dd') as "takeLandDate",
    FN_DWM_FONT_COLOR(FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_TL)) as "firstOpenDurationByTL",
    to_char(PLAN_FIRST_OPEN_DATE,'yyyy-mm-dd') as "planFirstOpenDate",
    FN_DWM_DAY_CONVERT_MONTH(first_open_duration_by_plan) as "firstOpenDurationByPlan",
   Fn_DWM_DurationDaysDeal(PLAN_FIRST_OPEN_DATE,FIRST_OPEN_DATE,'label')  as "advanceFirstOpenDate",
   FIRST_OPEN_DURATION_BY_TL
FROM
    dwm_sale_rate_project where FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'))  order by FIRST_OPEN_DURATION_BY_TL desc) tab where rownum<=10;
open bigData for SELECT
    details as "describe"
FROM
    dwm_sale_rate_data_briefing where GROUP_NAME='BigDataBriefing' order by SORT;

open k1DataSortField for
SELECT COLUMN_VALUE as "fieldName" FROM table (split ('firstOpenDate,foSaleOutCount,foSaleCount,foSaleRateByCount,foSaleOutArea,foSaleArea,foSaleRateByArea,foSaleOutMoney,foSaleMoney,foSaleRateByMoney'));

open k2DataSortField for
SELECT COLUMN_VALUE as "fieldName" FROM table (split ('firstOpenDate,takeLandDate,firstOpenDurationByTL,planFirstOpenDate,firstOpenDurationByPlan'));

open k2preparedatasortfield for
SELECT COLUMN_VALUE as "fieldName" FROM table (split ('takeLandDate,planFirstOpenDate,firstOpenDurationByPlan,advanceFirstOpenDate,newPlanFirstOpenDate'));

open tabItems for
select * from (SELECT 
'1、本年首开项目去化率排行' as  "title",
k1_1abstract as  "abstract",
'k1' as "code",
1 as "sortNum"
from dual
UNION
select
'2、首开去化率变动趋势图' as  "title",
k1_2abstract as  "abstract",
'k1' as "code",
2 as "sortNum"
from dual
UNION
select
'1、本年已首开项目（'||to_char(k2_1ListCount)||'个）' as  "title",
k2_1abstract as  "abstract",
'k2' as "code",
21 as "sortNum"
from dual
UNION
select
'2、首开时间变动趋势图' as  "title",
k2_2abstract as  "abstract",
'k2' as "code",
22 as "sortNum"
from dual
UNION
select
'<p id="cache20" style=""><span style="color: rgb(64, 64, 64);" id="cache21">3、本年待首开项目（共'||to_char(k2_3ListCount)||'个，</span><span style="color: rgb(255, 0, 0);" id="cache22">其中已延误'||to_char(k2_3_2ListCount)||'个</span><span style="color: rgb(64, 64, 64);" id="cache23">）</span></p>' as  "title",
k2_3abstract as  "abstract",
'k2' as "code",
23 as "sortNum"
from dual) tab order by  tab."sortNum";
END P_DWM_briefingAndK1K2;
/

prompt
prompt Creating procedure P_DWM_BRIEFINGUPDATEBYK1
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_briefingUpdateByK1
AS  
k1 clob;
k1_1 clob;
k1_2 clob;
k1RateByBycount clob;
k1BycountMax clob;
k1BycountMin clob;
k1ProjectCount number;
k1ProjectCountByNearly3Months  number;
k1RateByCountByNearly3Months  clob;
k1ProjectRateByNearly3Months  clob;
rowCount number;
begin
select case when sum(FO_SALE_COUNT) <> 0 then fn_ConvertDecimalToPercentage((sum(FO_SALE_OUT_COUNT))/(sum(FO_SALE_COUNT))) else  fn_ConvertDecimalToPercentage(0.0) end into k1RateByBycount
from  dwm_sale_rate_project  left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id 
where FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')); 

select case when sum(FO_SALE_COUNT) <>0 then fn_ConvertDecimalToPercentage((sum(FO_SALE_OUT_COUNT))/(sum(FO_SALE_COUNT))) else fn_ConvertDecimalToPercentage(0.0) end into k1RateByCountByNearly3Months 
from  dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id 
where FIRST_OPEN_DATE is not null  and FIRST_OPEN_DATE >= ADD_MONTHS(to_date(TO_CHAR(sysdate,'yyyy-mm-dd'),'yyyy-mm-dd'), -2) and FIRST_OPEN_DATE<=sysdate;

select count(1) into k1ProjectCount  from  dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'));
select count(1) into k1ProjectCountByNearly3Months  from   dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where FIRST_OPEN_DATE is not null  and FIRST_OPEN_DATE >= ADD_MONTHS(to_date(TO_CHAR(sysdate,'yyyy-mm-dd'),'yyyy-mm-dd'), -2) and FIRST_OPEN_DATE<=sysdate;

select fn_ConvertDecimalToPercentage(max(FO_SALE_RATE_BY_COUNT)) into k1BycountMax from dwm_sale_rate_project  left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')); 
select fn_ConvertDecimalToPercentage(min(FO_SALE_RATE_BY_COUNT)) into k1BycountMin from dwm_sale_rate_project  left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id
where FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) and FO_SALE_COUNT is not null and FO_SALE_COUNT <> 0; 

select  listagg(project_name||fn_ConvertDecimalToPercentage(FO_SALE_RATE_BY_COUNT),'、') WITHIN GROUP (ORDER BY FO_SALE_RATE_BY_COUNT desc)  into k1ProjectRateByNearly3Months  from (select dwm_sale_rate_project.project_name,case when FO_SALE_RATE_BY_COUNT is null or FO_SALE_RATE_BY_COUNT=0 then 0.0 else FO_SALE_RATE_BY_COUNT end as FO_SALE_RATE_BY_COUNT
from  dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id
where FIRST_OPEN_DATE is not null  and FIRST_OPEN_DATE >= ADD_MONTHS(to_date(TO_CHAR(sysdate,'yyyy-mm-dd'),'yyyy-mm-dd'), -2) and FIRST_OPEN_DATE<=sysdate and FO_SALE_RATE_BY_COUNT <>0 and FO_SALE_RATE_BY_COUNT is not null)tab ;
k1:='<center>
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;font-size: 36px;color: #FF9900;">'||k1RateByBycount||'</span>
        </center>
        <p style="font-size:14px;text-align:center;line-height:18px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">K1首开去化率</span>
        </p>
        <p style="font-size:11px;text-align:left;line-height:20px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >1、本年实际首开项目'||k1ProjectCount|| '个项目，首开去化率均值'||k1RateByBycount||'：</span
          ><span style="font-family:''微软雅黑'';font-weight:400;"></span
          ><span style="font-family:''微软雅黑'';font-weight:400;"></span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#00CC66;">最高值'||k1BycountMax|| '</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">，</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#FF99FF;">最低值'||k1BycountMin||'</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">。</span>
        </p>
        <p style="font-size:11px;text-align:left;line-height:20px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >2、近3个月实际首开项目'||k1ProjectCountByNearly3Months||'个项目，首开去化率均值'||k1RateByCountByNearly3Months||'：</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">'||k1ProjectRateByNearly3Months||'。</span>
        </p>';
    k1_1:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">本年首开共</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k1ProjectCount|| '个项目</span><span style="font-family:''微软雅黑'';font-weight:400;">，首开去化率</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">均值'||k1RateByBycount||'</span><span style="font-family:''微软雅黑'';font-weight:400;">，</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">最高值'||k1BycountMax||'</span><span style="font-family:''微软雅黑'';font-weight:400;">、</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">最低值'||k1BycountMin||'</span><span style="font-family:''微软雅黑'';font-weight:400;">。</span></p>';
    k1_2:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">集团整体首开去化率均值为</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k1RateByBycount||'</span><span style="font-family:''微软雅黑'';font-weight:400;color:#666666;">。</span></p>';

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k1';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k1,MODIFIED=sysdate where code='k1';
    dbms_output.put_line('update--k1----'||k1);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k1',k1,1,'BigDataBriefing',sysdate);
    dbms_output.put_line('insert---k1-----'||k1);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k1.1';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k1_1,MODIFIED=sysdate where code='k1.1';
     dbms_output.put_line('update--k1.1----'||k1_1);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k1.1',k1_1,11,'k1',sysdate);
    dbms_output.put_line('insert---k1.1---'||k1_1);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k1.2';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k1_2,MODIFIED=sysdate where code='k1.2';
      dbms_output.put_line('update---k1.2----'||k1_2);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k1.2',k1_2,12,'k1',sysdate);
     dbms_output.put_line('insert---k1.2----'||k1_2);  
end if;
commit;
end P_DWM_briefingUpdateByK1;
/

prompt
prompt Creating procedure P_DWM_BRIEFINGUPDATEBYK2
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_briefingUpdateByK2
AS  
k2 clob:='';
k2str clob:='';
k2_1 clob:='';
k2_2 clob:='';
k2_3 clob:='';
k2ProjectCount number:=0;
k2MinProjectNames clob:='';
k2MaxProjectNames clob:='';
k2MinFirstOpenDurationByTl number:=0;
k2MaxFirstOpenDurationByTl number:=0;
DelayFirstOpenDurationByTl number:=0;
k2onTimeProjectCount number:=0;
DelayFirstOpen number:=0;
DelayLastFirstOpen number:=0;
rowCount number:=0;
begin
SELECT
   count(1)
   into k2ProjectCount
FROM
    dwm_sale_rate_project where  FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'));
SELECT
   to_char(trunc( (sum(FIRST_OPEN_DURATION_BY_TL)/count(1))/ 31, 1),'fm9999999990.0')
   into k2
FROM
    dwm_sale_rate_project where  FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) and TAKE_LAND_DATE is not null;
SELECT 
  min(FIRST_OPEN_DURATION_BY_TL) into k2MinFirstOpenDurationByTl
FROM
    dwm_sale_rate_project where  FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'));

SELECT 
   replace(WMSYS.WM_CONCAT(project_name),',','、') into k2MinProjectNames
FROM
    dwm_sale_rate_project where  FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'))  and
    FIRST_OPEN_DURATION_BY_TL=k2MinFirstOpenDurationByTl;
k2MinFirstOpenDurationByTl:=trunc(k2MinFirstOpenDurationByTl / 31, 1);

SELECT 
  max(FIRST_OPEN_DURATION_BY_TL) into k2MaxFirstOpenDurationByTl
FROM
    dwm_sale_rate_project where  FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'));

SELECT 
   replace(WMSYS.WM_CONCAT(project_name),',','、') into k2MaxProjectNames
FROM
    dwm_sale_rate_project where  FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'))  and
    FIRST_OPEN_DURATION_BY_TL=k2MaxFirstOpenDurationByTl;

k2MaxFirstOpenDurationByTl:=trunc(k2MaxFirstOpenDurationByTl / 31, 1);

SELECT 
  count(1) into k2onTimeProjectCount
FROM
     dwm_sale_rate_project where  FIRST_OPEN_DATE is not null and to_number(to_char(FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'))  and PLAN_FIRST_OPEN_DATE>=FIRST_OPEN_DATE;

select Count(1) into DelayFirstOpen from  dwm_sale_rate_project where FIRST_OPEN_DATE is null and (to_number(to_char(PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) or to_number(to_char(NEW_PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')));
select Count(1) into DelayLastFirstOpen from  dwm_sale_rate_project where FIRST_OPEN_DATE is null and (to_number(to_char(PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) or to_number(to_char(NEW_PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy'))) and (NEW_PLAN_FIRST_OPEN_DATE< sysdate or PLAN_FIRST_OPEN_DATE< sysdate);

select case when DelayFirstOpen=0 then 0 else trunc(sum(FIRST_OPEN_DURATION_BY_PLAN)/DelayFirstOpen/31,1) end  into DelayFirstOpenDurationByTl from  dwm_sale_rate_project where FIRST_OPEN_DATE is null and (to_number(to_char(PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')) or to_number(to_char(NEW_PLAN_FIRST_OPEN_DATE,'yyyy')) = to_number(to_char(sysdate,'yyyy')));
k2str:=' <center>
          <span
            style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;font-size: 36px;color: #FF9900;"
            >'||k2||'个月</span
          >
        </center>
        <p style="font-size:14px;text-align:center;line-height:18px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >K2 拿地至首开时间</span
          >
        </p>
        <p style="font-size:11px;text-align:left;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >1、本年已首开'||to_char(k2ProjectCount)||'个项目，首开平均时长'||k2||'月：</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">首开最快'||k2MinProjectNames||'，</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#33CC99;">'||to_char(k2minfirstOpenDurationByTl,'fm9999999990.0')||'个月</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">；首开最慢'||k2MaxProjectNames||'，</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#FF6666;">'||to_char(k2MaxFirstOpenDurationByTl,'fm9999999990.0')||'个月</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">。</span>
        </p>
        <p style="font-size:11px;text-align:left;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;color:#000000;"
            >2、本年按时已首开项目</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#33CC99;">'||to_char(k2onTimeProjectCount)||'个</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#000000;">，</span
          ><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;color:#000000;"
            >延迟已首开项目</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#FF6633;">'||to_char(k2ProjectCount-k2onTimeProjectCount)||'个</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#000000;">；</span>
        </p>
        <p style="font-size:11px;text-align:left;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >3、本年剩余首开项目'||to_char(DelayFirstOpen)||'个：</span
          >
        </p>
        <p style="font-size:11px;text-align:left;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑'';font-weight:400;"> </span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#FF99FF;">延迟未首开项目'||to_char(DelayLastFirstOpen)||'个</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">，未到期首开项目'||to_char(DelayFirstOpen-DelayLastFirstOpen)||'个。</span>
        </p>';
    k2_2:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">集团整体首开时长均值为</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k2||'个月</span><span style="font-family:''微软雅黑'';font-weight:400;color:#666666;">。</span></p>';
    k2_3:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">本年待首开项目'||DelayFirstOpen||'个，首开时长目标均值为</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||to_char(DelayFirstOpenDurationByTl,'fm9999999990.0')||'个月；</span><span style="font-family:''微软雅黑'';font-weight:400;">已延误首开的项目</span><span style="font-family:''微软雅黑'';font-weight:400;color:#FF0000;">共'||DelayLastFirstOpen||'个</span><span style="font-family:''微软雅黑'';font-weight:400;color:#666666;">，预计</span><span style="font-family:''微软雅黑'';font-weight:400;">。</span></p>';
    k2_1:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">本年首开项目'||to_char(k2ProjectCount)||'个，“拿地至首开”</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">平均时长'||k2||'个月</span><span style="font-family:''微软雅黑'';font-weight:400;">，首开</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">最快为'||to_char(k2MinFirstOpenDurationByTl,'fm9999999990.0')||'月</span><span style="font-family:''微软雅黑'';font-weight:400;">，首开</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">最慢'||to_char(k2MaxFirstOpenDurationByTl,'fm9999999990.0')||'个月；</span><span style="font-family:''微软雅黑'';font-weight:400;">按时首开项目</span><span style="font-family:''微软雅黑'';font-weight:400;color:#00CC66;">'||to_char(k2onTimeProjectCount)||'个</span><span style="font-family:''微软雅黑'';font-weight:400;">，延迟首开项目</span><span style="font-family:''微软雅黑'';font-weight:400;color:#E68CB2;">'||to_char(k2ProjectCount-k2onTimeProjectCount)||'个</span><span style="font-family:''微软雅黑'';font-weight:400;">。</span></p>';

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k2';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k2str,MODIFIED=sysdate where code='k2';
    dbms_output.put_line('update--k2---'||k2str);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k2',k2str,2,'BigDataBriefing',sysdate);
    dbms_output.put_line('insert---k2-----'||k2str);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k2.1';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k2_1,MODIFIED=sysdate where code='k2.1';
     dbms_output.put_line('update--k2.1----'||k2_1);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k2.1',k2_1,11,'k2',sysdate);
    dbms_output.put_line('insert--k2.1----'||k2_1);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k2.2';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k2_2,MODIFIED=sysdate where code='k2.2';
      dbms_output.put_line('update--k2.2----'||k2_2);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k2.2',k2_2,12,'k2',sysdate);
     dbms_output.put_line('inser--k2.2t----'||k2_2);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k2.3';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k2_3,MODIFIED=sysdate where code='k2.3';
      dbms_output.put_line('update----'||k2_3);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k2.3',k2_3,12,'k2',sysdate);
     dbms_output.put_line('insert----'||k2_3);  
end if;
end P_DWM_briefingUpdateByK2;
/

prompt
prompt Creating procedure P_DWM_BRIEFINGUPDATEBYK3
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_briefingUpdateByK3
AS  
k3 clob:='';
k3_1 clob:='';
k3RateByMoney clob:='';
k3RateByMoneyCout number:=0;
k3RateByMoneyOver90Cout number:=0;
k3RateByMoneyOver90Rate  varchar(50):='0%';
k3RateByMoneyOver99Cout number:=0;
k3RateByMoneyOver99Rate  varchar(50):='0%';
k3RemainingValue varchar(50):='0亿';
k3RemainingValueByParkingSpace varchar(50):='0亿';
k3RemainingValueByParkingBusin varchar(50):='0亿';
k3RemainingValueByParkingHouse varchar(50):='0亿';
ROWCOUNT number;
begin
select case when sum(FO_SALE_COUNT) <> 0 then fn_ConvertDecimalToPercentage(sum(PO_SALE_OUT_MONEY)/sum(PO_SALE_MONEY)) else  fn_ConvertDecimalToPercentage(0.0) end into  k3RateByMoney
from   DWM_SALE_RATE_BY_PROJECT; 

select count(1) into k3RateByMoneyOver90Cout
from DWM_SALE_RATE_BY_PROJECT where DWM_SALE_RATE_BY_PROJECT.PO_SALE_RATE_BY_MONEY>0.9;

select count(1) into k3RateByMoneyCout
from DWM_SALE_RATE_BY_PROJECT where DWM_SALE_RATE_BY_PROJECT.PO_SALE_RATE_BY_MONEY is not null;

select count(1) into k3RateByMoneyOver99Cout
from   DWM_SALE_RATE_BY_PROJECT  where DWM_SALE_RATE_BY_PROJECT.PO_SALE_RATE_BY_MONEY>0.99;

select case when sum(PO_SURPLUS_SALE_MONEY) <> 0 then FN_DWN_AmountToBillionYuan(sum(PO_SURPLUS_SALE_MONEY))  else  '0亿' end into  k3RemainingValue
from   DWM_SALE_RATE_BY_GRANULARITY where DATA_GRANULARITY in ('车位仓储','商办产业','住宅');

select case when sum(PO_SURPLUS_SALE_MONEY) <> 0 then FN_DWN_AmountToBillionYuan(sum(PO_SURPLUS_SALE_MONEY))  else  '0亿' end into  k3RemainingValueByParkingSpace
from   DWM_SALE_RATE_BY_GRANULARITY where DATA_GRANULARITY='车位仓储';

select case when sum(PO_SURPLUS_SALE_MONEY) <> 0 then FN_DWN_AmountToBillionYuan(sum(PO_SURPLUS_SALE_MONEY))  else  '0亿' end into  k3RemainingValueByParkingBusin
from   DWM_SALE_RATE_BY_GRANULARITY  where DATA_GRANULARITY='商办产业';

select case when sum(PO_SURPLUS_SALE_MONEY) <> 0 then FN_DWN_AmountToBillionYuan(sum(PO_SURPLUS_SALE_MONEY))  else  '0亿' end into  k3RemainingValueByParkingHouse

from   DWM_SALE_RATE_BY_GRANULARITY  where DATA_GRANULARITY='住宅';

if k3RateByMoneyCout<>0 then 
k3RateByMoneyOver90Rate:=fn_ConvertDecimalToPercentage(k3RateByMoneyOver90Cout/k3RateByMoneyCout);
end if;

if k3RateByMoneyCout<>0 then 
k3RateByMoneyOver99Rate:=fn_ConvertDecimalToPercentage(k3RateByMoneyOver99Cout/k3RateByMoneyCout);
end if;


k3:='  <center>
          <span
            style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;font-size: 36px;color: #FF9900;"
            >'||k3RateByMoney||'</span
          >
        </center>
        <p style="font-size:14px;text-align:center;line-height:18px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >K3、全案已取证去化率</span
          >
        </p>
        <p style="font-size:11px;text-align:left;line-height:16px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >1、共'||k3RateByMoneyOver90Cout||'个项目全案已取证去化率达90%，占所有项目的'||k3RateByMoneyOver90Rate||' ：</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">本年达到90%去化的'||k3RateByMoneyOver90Cout||'个</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#00CC66;"></span
          ><span style="font-family:''微软雅黑'';font-weight:400;">。</span>
        </p>
        <p style="font-size:11px;text-align:left;line-height:16px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >2、共'||k3RateByMoneyOver99Cout||'个项目全案已取证去化率达99%，占所有项目的'||k3RateByMoneyOver99Rate||'：</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">本年达到99%去化的'||k3RateByMoneyOver99Cout||'个</span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#00CC66;"></span
          ><span style="font-family:''微软雅黑'';font-weight:400;">。</span>
        </p>
        <p style="font-size:11px;text-align:left;line-height:16px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">3</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">、</span
          ><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >库存货值共'||k3RemainingValue||'</span
          ><span style="font-family:''微软雅黑'';font-weight:400;"
            >：住宅'||k3RemainingValueByParkingHouse||'、商业'||k3RemainingValueByParkingBusin||'、车位'||k3RemainingValueByParkingSpace||'。</span
          >
        </p>';
    k3_1:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">全案已取证去化率达到90%的项目，本年新增</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k3RateByMoneyOver90Cout||'个</span><span style="font-family:''微软雅黑'';font-weight:400;">；全案已取证去化率达到99%的项目，本年</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">新增'||k3RateByMoneyOver99Cout||'个</span><span style="font-family:''微软雅黑'';font-weight:400;">。</span></p>';

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k3';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k3,MODIFIED=sysdate where code='k3';
    dbms_output.put_line('update--k3----'||k3);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k3',k3,3,'BigDataBriefing',sysdate);
    dbms_output.put_line('insert--k3-----'||k3);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k3.1';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k3_1,MODIFIED=sysdate where code='k3.1';
     dbms_output.put_line('update--k3.1----'||k3_1);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k3.1',k3_1,11,'k3',sysdate);
    dbms_output.put_line('insert--k3.1----'||k3_1);  
end if;

commit;
end P_DWM_briefingUpdateByK3;
/

prompt
prompt Creating procedure P_DWM_BRIEFINGUPDATEBYK4
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_briefingUpdateByK4
AS  
k4 clob:='';
k4_1 clob:='';
k4RateByMoney clob:='';
AllEhSaleOutMoney number:=0;
AllEhSaleMoney number:=0;
AllEhSurplusSaleMoney number:=0;
ROWCOUNT number;
begin
select case when sum(EH_SALE_MONEY) <> 0 then fn_ConvertDecimalToPercentage(sum(EH_SALE_OUT_MONEY)/sum(EH_SALE_MONEY)) else  fn_ConvertDecimalToPercentage(0.0) end into  k4RateByMoney
from   DWM_SALE_RATE_BY_PROJECT; 

select sum(EH_SALE_OUT_MONEY) into  AllEhSaleOutMoney
from   DWM_SALE_RATE_BY_PROJECT; 

select sum(EH_SALE_MONEY) into  AllEhSaleMoney
from   DWM_SALE_RATE_BY_PROJECT; 

select sum(EH_SURPLUS_SALE_MONEY) into  AllEhSurplusSaleMoney
from   DWM_SALE_RATE_BY_PROJECT; 

k4:='<center>
          <span
            style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;font-size: 36px;color: #FF9900;"
            >'||k4RateByMoney||'</span>
        </center>
        <p style="font-size:14px;text-align:center;line-height:18px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >K4、现房去化率</span>
        </p>
        <p style="font-size:11px;text-align:left;line-height:16px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑'';font-weight:400;">1.竣备时未签约货值</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||FN_DWN_AmountToBillionYuan(AllEhSaleMoney)||'</span><span style="font-family:''微软雅黑'';font-weight:400;">，竣备后签约货值</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||FN_DWN_AmountToBillionYuan(AllEhSaleOutMoney)||'</span><span style="font-family:''微软雅黑'';font-weight:400;">，现房去化率</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k4RateByMoney||'</span><span style="font-family:''微软雅黑'';font-weight:400;">；剩余现房货值</span><span style="font-family:''微软雅黑'';font-weight:400;color:#E68CB2;">'||FN_DWN_AmountToBillionYuan(AllEhSurplusSaleMoney)||'</span><span style="font-family:''微软雅黑'';font-weight:400;">。</span>
        </p>';
    k4_1:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">竣备时未签约货值</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||FN_DWN_AmountToBillionYuan(AllEhSaleMoney)||'</span><span style="font-family:''微软雅黑'';font-weight:400;">，竣备后签约货值</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||FN_DWN_AmountToBillionYuan(AllEhSaleOutMoney)||'</span><span style="font-family:''微软雅黑'';font-weight:400;">，现房去化率</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k4RateByMoney||'</span><span style="font-family:''微软雅黑'';font-weight:400;">；剩余现房货值</span><span style="font-family:''微软雅黑'';font-weight:400;color:#E68CB2;">'||FN_DWN_AmountToBillionYuan(AllEhSurplusSaleMoney)||'</span><span style="font-family:''微软雅黑'';font-weight:400;">。</span></p>';

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k4';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k4,MODIFIED=sysdate where code='k4';
    dbms_output.put_line('update----'||k4);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k4',k4,4,'BigDataBriefing',sysdate);
    dbms_output.put_line('insert------'||k4);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k4.1';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k4_1,MODIFIED=sysdate where code='k4.1';
     dbms_output.put_line('update----'||k4_1);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k4.1',k4_1,11,'k4',sysdate);
    dbms_output.put_line('insert----'||k4_1);  
end if;

commit;
end P_DWM_briefingUpdateByK4;
/

prompt
prompt Creating procedure P_DWM_BRIEFINGUPDATEBYK5
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_briefingUpdateByK5
AS  
k5 clob:='';
k5_1 clob:='';
k5RateByMoney clob:='0%';
k5SaleOutByMoney varchar(50):='0亿';
k5SaleByMoney varchar(50):='0亿';
k5RemainingValue varchar(50):='0亿';
k5RemainingValueByParkingSpace varchar(50):='0亿';
k5RemainingValueByParkingBusin varchar(50):='0亿';
k5RemainingValueByParkingHouse varchar(50):='0亿';
k5ProjectNamesBySaleArea clob:='';
k5ProjectNamesBySaleOutArea clob:='';
k5ProjectNamesByRemainingValue clob:='';
k5tNamesRemainingValueByTop clob:='';
appearindex number;
ROWCOUNT number;
begin
select case when sum(SI_SALE_MONEY) <> 0 then fn_ConvertDecimalToPercentage(sum(SI_SALE_OUT_MONEY)/sum(SI_SALE_MONEY)) else  fn_ConvertDecimalToPercentage(0.0) end into  k5RateByMoney
from    dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id; 

select FN_DWN_AmountToBillionYuan(sum(SI_SALE_MONEY)) into k5SaleByMoney
from    dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id; 

select FN_DWN_AmountToBillionYuan(sum(SI_SALE_OUT_MONEY)) into k5SaleOutByMoney
from    dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id; 

select FN_DWN_AmountToBillionYuan(sum(SI_SALE_MONEY)-sum(SI_SALE_OUT_MONEY)) into k5RemainingValue
from    dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id; 

if k5SaleByMoney <> '0亿' then
select listagg(project_name||FN_DWN_AmountToBillionYuan(SI_SALE_MONEY),'、') WITHIN GROUP (ORDER BY SI_SALE_MONEY desc) into  k5ProjectNamesBySaleArea  from (select dwm_sale_rate_project.project_name,case when SI_SALE_MONEY is null or SI_SALE_MONEY=0 then 0.0 else SI_SALE_MONEY end as SI_SALE_MONEY
from  dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where SI_SALE_MONEY is not null and SI_SALE_MONEY <>0  )tab;
end if;
if k5SaleOutByMoney <> '0亿' then
select listagg(project_name||FN_DWN_AmountToBillionYuan(SI_SALE_OUT_MONEY),'、') WITHIN GROUP (ORDER BY SI_SALE_OUT_MONEY desc) into  k5ProjectNamesBySaleOutArea  from (select dwm_sale_rate_project.project_name,case when SI_SALE_OUT_MONEY is null or SI_SALE_OUT_MONEY=0 then 0.0 else SI_SALE_OUT_MONEY end as SI_SALE_OUT_MONEY
from  dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where SI_SALE_OUT_MONEY is not null and SI_SALE_OUT_MONEY <>0  )tab;
end if;
if k5RemainingValue <> '0亿' then
select listagg(project_name||FN_DWN_AmountToBillionYuan(RemainingValue),'、') WITHIN GROUP (ORDER BY RemainingValue desc)  into  k5ProjectNamesByRemainingValue from (select dwm_sale_rate_project.project_name,SI_SALE_MONEY-SI_SALE_OUT_MONEY as RemainingValue
from  dwm_sale_rate_project left join DWM_SALE_RATE_BY_PROJECT on dwm_sale_rate_project.project_id=DWM_SALE_RATE_BY_PROJECT.project_id where SI_SALE_OUT_MONEY is not null )tab where tab.RemainingValue <> 0;
end if;

if k5ProjectNamesByRemainingValue is not null then
appearindex:=INSTR(k5ProjectNamesByRemainingValue,'、');
k5tNamesRemainingValueByTop:=substr(k5ProjectNamesByRemainingValue,0,appearindex-1);
 dbms_output.put_line('----'||k5tNamesRemainingValueByTop);  
k5ProjectNamesByRemainingValue:=substr(k5ProjectNamesByRemainingValue,appearindex,length(k5ProjectNamesByRemainingValue));
 dbms_output.put_line('----'||k5ProjectNamesByRemainingValue);  
end if;

k5:='  <center>
          <span
            style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;font-size: 36px;color: #FF9900;"
            >'||k5RateByMoney||'</span
          >
        </center>
         <p style="font-size:14px;text-align:center;line-height:18px;margin-bottom: 0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"> K5、顽固性库存去化率</span>
        </p>
        <p style="font-size:11px;line-height:16px;margin-bottom:0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >1、年初顽固性库存为'||k5SaleByMoney||'。</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">'||k5ProjectNamesBySaleArea||'。</span>
        </p>
        <p style="font-size:11px;line-height:16px;margin-bottom:0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >2、今年已去化顽固性库存'||k5SaleOutByMoney||'，去化率'||k5RateByMoney||'：</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">'||k5ProjectNamesBySaleOutArea||'。</span>
        </p>
        <p style="font-size:11px;line-height:16px;margin-bottom:0px;">
          <span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;"
            >3、剩余顽固性库存'||k5RemainingValue||'：</span
          >
        </p>
        <p style="font-size:11px;line-height:16px;margin-bottom:0px;">
          <span style="font-family:''微软雅黑'';font-weight:400;"> </span
          ><span style="font-family:''微软雅黑'';font-weight:400;color:#FF99CC;">'||k5tNamesRemainingValueByTop||'</span
          ><span style="font-family:''微软雅黑'';font-weight:400;">'||k5ProjectNamesByRemainingValue||'。</span>
        </p>';
    k5_1:='<p><span style="font-family:''微软雅黑 Bold'', ''微软雅黑 Regular'', ''微软雅黑'';font-weight:700;">摘要：</span><span style="font-family:''微软雅黑'';font-weight:400;">年初顽固性库存</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k5SaleByMoney||'</span><span style="font-family:''微软雅黑'';font-weight:400;">，本年已去化</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k5SaleOutByMoney||'</span><span style="font-family:''微软雅黑'';font-weight:400;">，去化率</span><span style="font-family:''微软雅黑'';font-weight:400;color:#40A9FF;">'||k5RateByMoney||'</span><span style="font-family:''微软雅黑'';font-weight:400;">；剩余顽固性库存</span><span style="font-family:''微软雅黑'';font-weight:400;color:#E68CB2;">'||k5RemainingValue||'</span><span style="font-family:''微软雅黑'';font-weight:400;">。</span></p>';

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k5';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k5,MODIFIED=sysdate where code='k5';
    dbms_output.put_line('update--k5----'||k5);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k5',k5,5,'BigDataBriefing',sysdate);
    dbms_output.put_line('insert--k5------'||k5);  
end if;

select count(1) into rowCount from DWM_SALE_RATE_DATA_BRIEFING  where  code='k5.1';
if rowCount <> 0 then
    update DWM_SALE_RATE_DATA_BRIEFING set DETAILS=k5_1,MODIFIED=sysdate where code='k5.1';
     dbms_output.put_line('update--k5.1----'||k5_1);  
else
    insert into DWM_SALE_RATE_DATA_BRIEFING(ID,CODE,DETAILS,SORT,GROUP_NAME,MODIFIED) VALUES (GET_UUID(),'k5.1',k5_1,11,'k5',sysdate);
    dbms_output.put_line('insert--k5.1----'||k5_1);  
end if;

commit;
end P_DWM_briefingUpdateByK5;
/

prompt
prompt Creating procedure P_DWM_CHARTFILTER_K1
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_CHARTFILTER_K1
(
  orgFilter OUT sys_refcursor 
, typeFilter OUT sys_refcursor 
, title OUT string 
, abstract OUT string
, typeTitle  OUT string
, orgTitle  OUT string 
) AS 
BEGIN
  open orgFilter for 
        select ID as "orgId", ORG_NAME as "orgName", KEY as "isCheck" from(
        select * from (select ID, ORG_NAME, 1 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        union
        select ID, ORG_NAME, 0 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 and ID not in (
        select ID from (select ID from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        )) order by ORDER_HIERARCHY_CODE asc;
  open typeFilter for 
        select '按面积' as "name", 'area' as "typeName", 0 as "isCheck" from dual
        union
        select '按货值' as "name", 'money' as "typeName", 0 as "isCheck" from dual
        union
        select '按套数' as "name", 'count' as "typeName", 1 as "isCheck" from dual;      
   title := '首开去化率变动趋势';
   abstract := '';
   typeTitle := '去化率类型';
   orgTitle := '二级单位';
END P_DWM_CHARTFILTER_K1;
/

prompt
prompt Creating procedure P_DWM_CHARTFILTER_K1K3
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_CHARTFILTER_K1K3
(
 type_name in varchar2,
  orgFilter OUT sys_refcursor 
, typeFilter OUT sys_refcursor 
, title OUT string 
, typeTitle  OUT string
, orgTitle  OUT string 
) AS 
BEGIN
  open orgFilter for 
       select id "orgId" ,org_name  "orgName",case when rownum=1 then
        1 else 0 end as "isCheck" from (select orgs.*  from (
        select ID,org_name,order_hierarchy_code from SYS_BUSINESS_UNIT  where LEVEL_RANK=1
        union
       select ID,org_name,order_hierarchy_code from (select ORG_ID from DWM_SALE_RATE_PROJECT group by ORG_ID) tab left join  SYS_BUSINESS_UNIT on tab.ORG_ID=SYS_BUSINESS_UNIT.ID where SYS_BUSINESS_UNIT.LEVEL_RANK=2
        union 
        select ID,org_name,order_hierarchy_code from  (select parent_id  from (select ORG_ID from DWM_SALE_RATE_PROJECT group by ORG_ID) tab left join  SYS_BUSINESS_UNIT on tab.ORG_ID=SYS_BUSINESS_UNIT.ID where SYS_BUSINESS_UNIT.LEVEL_RANK=3) orgids 
        left join SYS_BUSINESS_UNIT on orgids.parent_id=SYS_BUSINESS_UNIT.id
        union
        select ID,org_name,order_hierarchy_code from(select * from SYS_BUSINESS_UNIT m start with m.id in (
        select sys_business_unit.ID from (select ORG_ID from DWM_SALE_RATE_PROJECT group by ORG_ID) tab left join  SYS_BUSINESS_UNIT on tab.ORG_ID=SYS_BUSINESS_UNIT.ID where SYS_BUSINESS_UNIT.LEVEL_RANK>3
        ) connect by prior m.parent_id=m.id)tab where tab.LEVEL_RANK=2 ) orgs order by orgs.order_hierarchy_code)tab;
  if  type_name is null or type_name='k1' then
  open typeFilter for 
        select '按面积' as "name", 'area' as "typeName", 0 as "isCheck" from dual
        union
        select '按货值' as "name", 'money' as "typeName", 0 as "isCheck" from dual
        union
        select '按套数' as "name", 'count' as "typeName", 1 as "isCheck" from dual;      
   title := '首开去化率变动趋势';
   typeTitle := '去化率类型';
   orgTitle := '二级单位';
   else
    title := '"全案已取证去化率"变动趋势';
    typeTitle := '去化率类型';
    orgTitle := '二级单位';
     open typeFilter for 
        select '按面积' as "name", 'area' as "typeName", 0 as "isCheck" from dual
        union
        select '按货值' as "name", 'money' as "typeName", 1 as "isCheck" from dual
        union
        select '按套数' as "name", 'count' as "typeName", 0 as "isCheck" from dual;    
   end if;
END P_DWM_CHARTFILTER_K1K3;
/

prompt
prompt Creating procedure P_DWM_CHARTFILTER_K2
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_ChartFilter_K2(orgFilter out sys_refcursor,orgTitle out varchar,title out varchar)
as
begin
orgTitle:='二级单位';
title:='“拿地至首开时间”  变动趋势      (单位：月)';

open orgFilter for 
select id "orgId" ,org_name  "orgName",
case when id='c4571e06-dc50-4780-b663-9d3d358f4888' then
1 else 0 end as "isCheck"
from SYS_BUSINESS_UNIT where LEVEL_RANK=2   order by order_hierarchy_code;

end P_DWM_ChartFilter_K2;
/

prompt
prompt Creating procedure P_DWM_CHARTFILTER_K2K4K5
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_CHARTFILTER_K2K4K5
(
 type_name in varchar2,
  orgFilter OUT sys_refcursor 
, title OUT string 
, orgTitle  OUT string 
) AS 
BEGIN
  open orgFilter for 
       select id "orgId" ,org_name  "orgName",case when rownum=1 then
        1 else 0 end as "isCheck" from (select orgs.*  from (
        select ID,org_name,order_hierarchy_code from SYS_BUSINESS_UNIT  where LEVEL_RANK=1
        union
       select ID,org_name,order_hierarchy_code from (select ORG_ID from DWM_SALE_RATE_PROJECT group by ORG_ID) tab left join  SYS_BUSINESS_UNIT on tab.ORG_ID=SYS_BUSINESS_UNIT.ID where SYS_BUSINESS_UNIT.LEVEL_RANK=2
        union 
        select ID,org_name,order_hierarchy_code from  (select parent_id  from (select ORG_ID from DWM_SALE_RATE_PROJECT group by ORG_ID) tab left join  SYS_BUSINESS_UNIT on tab.ORG_ID=SYS_BUSINESS_UNIT.ID where SYS_BUSINESS_UNIT.LEVEL_RANK=3) orgids 
        left join SYS_BUSINESS_UNIT on orgids.parent_id=SYS_BUSINESS_UNIT.id
        union
        select ID,org_name,order_hierarchy_code from(select * from SYS_BUSINESS_UNIT m start with m.id in (
        select sys_business_unit.ID from (select ORG_ID from DWM_SALE_RATE_PROJECT group by ORG_ID) tab left join  SYS_BUSINESS_UNIT on tab.ORG_ID=SYS_BUSINESS_UNIT.ID where SYS_BUSINESS_UNIT.LEVEL_RANK>3
        ) connect by prior m.parent_id=m.id)tab where tab.LEVEL_RANK=2 ) orgs order by orgs.order_hierarchy_code)tab;
  if  type_name is null or type_name='k2' then 
     orgTitle:='二级单位';
     title:='“拿地至首开时间”  变动趋势      (单位：月)';
   elsif type_name='k4_2' then 
      title := '现房去化率变动趋势';
      orgTitle := '二级单位';
   elsif type_name='k4_3' then 
     title := '剩余现房货值变动趋势 (单位:亿元)';
     orgTitle := '二级单位';
   elsif  type_name='k5_2' then 
     title := '顽固性库存去化率变动趋势图';
     orgTitle := '二级单位';
   elsif  type_name='k5_3' then 
     title := '"剩余顽固性库存"变动趋势 (单位:亿元)';
     orgTitle := '二级单位';
   end if;
END P_DWM_CHARTFILTER_K2k4k5;
/

prompt
prompt Creating procedure P_DWM_CHARTFILTER_K3
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_CHARTFILTER_K3
(
  orgFilter OUT sys_refcursor 
, typeFilter OUT sys_refcursor 
, typeTitle OUT string 
, orgTitle  OUT string
, title  OUT string 
)  AS 
BEGIN
  open orgFilter for 
        select ID as "orgId", ORG_NAME as "orgName", KEY as "isCheck" from(
        select * from (select ID, ORG_NAME, 1 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        union
        select ID, ORG_NAME, 0 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 and ID not in (
        select ID from (select ID from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        )) order by ORDER_HIERARCHY_CODE asc;
  open typeFilter for 
        select '按面积' as "name", 'area' as "typeName", 0 as "isCheck" from dual
        union
        select '按货值' as "name", 'money' as "typeName", 1 as "isCheck" from dual
        union
        select '按套数' as "name", 'count' as "typeName", 0 as "isCheck" from dual;
   title := '"全案已取证去化率"变动趋势';
   typeTitle := '去化率类型';
   orgTitle := '二级单位';
END P_DWM_CHARTFILTER_K3;
/

prompt
prompt Creating procedure P_DWM_CHARTFILTER_K4_2
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_CHARTFILTER_K4_2
(
  orgfilter OUT sys_refcursor 
, title OUT string 
, orgtitle OUT string 
) AS 
BEGIN
  open orgfilter for 
       select ID as "orgId", ORG_NAME as "orgName", KEY as "isCheck" from(
        select * from (select ID, ORG_NAME, 1 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        union
        select ID, ORG_NAME, 0 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 and ID not in (
        select ID from (select ID from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        )) order by ORDER_HIERARCHY_CODE asc;
  title := '现房去化率变动趋势';
  orgTitle := '二级单位';
END P_DWM_CHARTFILTER_K4_2;
/

prompt
prompt Creating procedure P_DWM_CHARTFILTER_K4_3
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_CHARTFILTER_K4_3
(
  orgfilter OUT sys_refcursor 
, title OUT string 
, orgtitle OUT string  
) AS 
BEGIN
  open orgfilter for 
       select ID as "orgId", ORG_NAME as "orgName", KEY as "isCheck" from(
        select * from (select ID, ORG_NAME, 1 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        union
        select ID, ORG_NAME, 0 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 and ID not in (
        select ID from (select ID from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        )) order by ORDER_HIERARCHY_CODE asc;
  title := '剩余现房货值变动趋势 (单位:亿元)';
  orgTitle := '二级单位';
END P_DWM_CHARTFILTER_K4_3;
/

prompt
prompt Creating procedure P_DWM_CHARTFILTER_K5_2
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_CHARTFILTER_K5_2
(
  orgfilter OUT sys_refcursor 
, title OUT string 
, orgtitle OUT string 
) AS 
BEGIN
  open orgfilter for 
        select ID as "orgId", ORG_NAME as "orgName", KEY as "isCheck" from(
        select * from (select ID, ORG_NAME, 1 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        union
        select ID, ORG_NAME, 0 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 and ID not in (
        select ID from (select ID from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        )) order by ORDER_HIERARCHY_CODE asc;
  title := '顽固性库存去化率变动趋势图';
  orgTitle := '二级单位';
END P_DWM_CHARTFILTER_K5_2;
/

prompt
prompt Creating procedure P_DWM_CHARTFILTER_K5_3
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_CHARTFILTER_K5_3
(
  orgfilter OUT sys_refcursor 
, title OUT string 
, orgtitle OUT string 
) AS 
BEGIN
  open orgfilter for 
        select ID as "orgId", ORG_NAME as "orgName", KEY as "isCheck" from(
            select * from (select ID, ORG_NAME, 1 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
            union
            select ID, ORG_NAME, 0 as "KEY", ORDER_HIERARCHY_CODE from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 and ID not in (
        select ID from (select ID from SYS_BUSINESS_UNIT where LEVEL_RANK = 2 order by ORDER_HIERARCHY_CODE asc) where rownum <= 1
        )) order by ORDER_HIERARCHY_CODE asc;
  title := '"剩余顽固性库存"变动趋势 (单位:亿元)';
  orgTitle := '二级单位';
END P_DWM_CHARTFILTER_K5_3;
/

prompt
prompt Creating procedure P_SYS_GET_COMPANY_TREE_SPID
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_SYS_GET_COMPANY_TREE_SPID ( USERID IN VARCHAR2, STATIONID IN VARCHAR2, DEPTID IN VARCHAR2, COMPANYID IN VARCHAR2, BIZCODE IN VARCHAR2 ,
DATA_AUTH_SPID OUT varchar2) 
AS
--获取公司树
--作者：谷国斌
--日期：2019/12/13
RULEVALUE varchar2(50);
AUTHCOUNT INT;--用于判断当前公司、部门是否与数据授权的主体有关系
SPID VARCHAR2(36);--使用临时表的批次号
BEGIN
   SELECT
        get_uuid()
    INTO spid
    FROM
        dual;
--插入集团作为根节点

    INSERT INTO tmp_company_tree (
        id,
        org_id,
        org_name,
        org_type,
        parent_id,
        is_company,
        order_code
    )
        SELECT
            spid,
            id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_hierarchy_code
        FROM
            sys_business_unit
        WHERE
            id = '003200000000000000000000000000';

--获取隔离规则：

    SELECT
        isolation_rule_value
    INTO rulevalue
    FROM
        sys_data_auth_biz
    WHERE
        biz_obj_code = bizcode;

    IF rulevalue = '全集团' THEN
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                is_company,
                order_hierarchy_code
            FROM
                sys_business_unit
            WHERE
                is_company = 1;

    ELSE 
--插入本公司及其父级
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                is_company,
                order_hierarchy_code
            FROM
                sys_business_unit
            WHERE
                is_company = 1
            START WITH
                id = companyid
            CONNECT BY
                PRIOR parent_id = id;

--插入数据授权的数据：

        DECLARE
            ownerid     VARCHAR2(36);
            oenertype   NVARCHAR2(50);
            CURSOR cursor_company IS
            SELECT DISTINCT
                auth_owner_id,
                auth_owner_type
            FROM
                sys_data_auth
            WHERE
                auth_biz_code = bizcode
                AND is_disabled = 0;

        BEGIN   

            --打开游标
            OPEN cursor_company;
            LOOP
                FETCH cursor_company INTO
                    ownerid,
                    oenertype;
                EXIT WHEN cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                IF oenertype = '公司' OR oenertype = '集团' THEN
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                        AND id = companyid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF oenertype = '部门' THEN
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 0
                        AND id = deptid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                    INSERT INTO tmp_auth_owner (
                        id,
                        auth_owner_id,
                        auth_owner_type
                    ) VALUES (
                        spid,
                        ownerid,
                        oenertype
                    );

                END IF;

            END LOOP;

            CLOSE cursor_company;
        END;   

          --获取有权限的公司及其父级：            

        DECLARE
            ownerid2 VARCHAR2(36);
            CURSOR cursor_auth IS
            SELECT
                auth_owner_id
            FROM
                tmp_auth_owner
            WHERE
                id = spid;

        BEGIN   

                    --打开游标
            OPEN cursor_auth;
            LOOP
                FETCH cursor_auth INTO ownerid2;
                EXIT WHEN cursor_auth%notfound;


                            --授权对象为公司：
                            --取授权公司的子级：
                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type IN (
                                    '公司',
                                    '集团'
                                )
                        )
                    CONNECT BY
                        PRIOR id = parent_id;


                            --取授权公司的父级：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type IN (
                                    '公司',
                                    '集团'
                                )
                        )
                    CONNECT BY
                        PRIOR parent_id = id;

                             --授权对应为部门：
                               --取授权部门的父级：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type = '部门'
                        )
                    CONNECT BY
                        PRIOR parent_id = id;
                               --授权对应为项目：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT
                                unit_id
                            FROM
                                sys_project
                            WHERE
                                id IN (
                                    SELECT DISTINCT
                                        auth_scope_id
                                    FROM
                                        sys_data_auth
                                    WHERE
                                        auth_biz_code = bizcode
                                        AND is_disabled = 0
                                        AND auth_owner_id = ownerid2
                                        AND auth_scope_type = '项目'
                                )
                        )
                    CONNECT BY
                        PRIOR parent_id = id;

            END LOOP;

            CLOSE cursor_auth;
        END;

    END IF;
DATA_AUTH_SPID:=spid;
--    OPEN data_auth_info FOR SELECT DISTINCT
--                               org_id       AS orgid,
--                               org_name     AS orgname,
--                               org_type     AS orgtype,
--                               parent_id    AS parentid,
--                               is_company   AS iscompany,
--                               order_code   AS ordercode
--                           FROM
--                               tmp_company_tree
--                           WHERE
--                               id = spid
--                           ORDER BY
--                               order_code;

END P_SYS_GET_COMPANY_TREE_SPID;
/

prompt
prompt Creating procedure P_DWM_COMPANY_PROJ_SITUATION
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_dwm_company_proj_situation (
    USERID IN VARCHAR2,
    STATIONID IN VARCHAR2,
    DEPTID IN VARCHAR2,
    COMPANYID IN VARCHAR2,
    BIZCODE IN VARCHAR2 ,
    wacthinfo OUT SYS_REFCURSOR
) AS
    --动态货值首页-项目货值概况
--作者：陈丽
--日期：2019/11/13
-- 黄伟：2019-12-26修正过本脚本
    RULEVALUE varchar2(50);
    AUTHCOUNT INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    SPID VARCHAR2(36);--使用临时表的批次号
    data_auth_spid   VARCHAR2(200);
    authCode VARCHAR2(50);---- 权限编码
BEGIN
    --权限查询
    authCode := 'DWM.DTHZGL.03';
    p_sys_get_company_tree_spid(userid => USERID, stationid => STATIONID, deptid => DEPTID, companyid => COMPANYID, bizcode
        => authCode, data_auth_spid => data_auth_spid);
    open wacthinfo for
        with tm1 as (
            select * from SYS_BUSINESS_UNIT
            where ID in (select ORG_ID from TMP_COMPANY_TREE where id = data_auth_spid)
        ), tm2 as (
            select distinct t1.*
            from tm1 t1 where not exists(select 1 from tm1 where tm1.PARENT_ID = t1.ID)
        ), tm3 as (
            select * from SYS_BUSINESS_UNIT sbu
            where sbu.IS_COMPANY=1
            start with ID in (select ID from tm2 )
            connect by prior sbu.ID = sbu.PARENT_ID
        ), tm4 as (
            select * from SYS_BUSINESS_UNIT sbu
            where sbu.IS_COMPANY=1
            start with ID in (select ID from tm2 )
            connect by prior sbu.PARENT_ID = sbu.ID
        ), tm5 as (
            SELECT
                A.order_hierarchy_code, -- 对象全路径排序编码
                A.orgId    AS id,--组织id
                A.orgName            AS orgName,--组织名称名称
                lower(A.parentId) AS parentsId,--父级id
                A.Proj_Code,
                (CASE  WHEN A.orgType = 10 THEN 1  ELSE 0  END) AS projTotal,
                round((CASE
                           WHEN X.PROJ_ID IS NOT NULL AND NVL(X.TARGET_WORTH,0)>0 THEN
                               X.TARGET_WORTH
                           WHEN Y.PROJ_ID IS NOT NULL AND NVL(Y.TARGET_WORTH,0)>0 THEN
                               Y.TARGET_WORTH
                           WHEN Z.PROJ_ID IS NOT NULL AND NVL(Z.TARGET_WORTH,0)>0 THEN
                               Z.TARGET_WORTH
                           ELSE   0  END)/10000,2)  AS newestWorth,    -- 最新目标货值
                --E.VALUE_DT_ALL,E.VALUE_IN_PROCESS,E.VALUE_STOCK,E.VALUE_HAVED_SALE
                round(DT.VALUE_DT_ALL_OPT/100000000,2) AS dynamicWorth,  -- 动态总货值
                round(DT.VALUE_RESERVE/100000000,2) AS reserveWorth,      -- 储备货值
--    round(22,2)    as InTransitWorth,  -- 在途货值
                round(nvl(DT.VALUE_IN_PROCESS,0)/100000000,2)    as InTransitWorth,  -- 在途货值
--    round(DT.VALUE_IN_PROCESS/100000000,2) as InTransitWorth,
                round(DT.VALUE_STOCK/100000000,2) AS inventoryWorth,       -- 库存货值
                round(DT.VALUE_HAVED_SALE/100000000,2) AS explaination,  -- 已售货值
                '/dwm/value-manage/dynamic-value/value-monitor' AS jumpUrl
            FROM(
                SELECT
                    t.order_hierarchy_code,-- 对象全路径排序编码
                    t.project_original_id     orgId,--组织id
                    t.project_name            AS orgName,--组织名称名称
                    t.org_type                AS orgType,--组织类型 0公司，1项目
                    t.Proj_Code,
                    lower(t.parent_id) AS parentId--父级id
                FROM(
                    SELECT
                        mdm_project.order_hierarchy_code,-- 对象全路径排序编码
                        mdm_project.project_original_id,
                            project_name||(CASE WHEN proj_cooperate='不操盘' THEN '（非操盘）' ELSE ''END) AS project_Name,
                        mdm_phase.phase_name   AS proj_phase,
                        phase.phase_id,
                        phase.id               AS proj_phase_id,
                        Project_Code AS Proj_Code,
                        10 AS org_type,
                        CASE WHEN phase.phase_id IS NULL THEN 0 ELSE 1 END AS is_exist_proj_phase,
                        company_id             AS parent_id,
                        mdm_obj_phase_index.total_site_area,
                        mdm_obj_phase_index.overall_floorage_area,
                        mdm_obj_phase_index.total_sale_area,
                        mdm_obj_phase_index.total_capacity_area
                    FROM mdm_project left JOIN (
                        SELECT t1.id, t1.phase_id, t1.proj_id, t2.phase_order
                        FROM mdm_project_phase t1 LEFT JOIN (
                            SELECT proj_id, MAX(phase_order) AS phase_order
                            FROM mdm_project_phase
                            GROUP BY proj_id
                        ) t2 ON t1.proj_id = t2.proj_id AND t1.phase_order = t2.phase_order
                        WHERE t2.phase_order IS NOT NULL
                    ) phase ON mdm_project.project_original_id = phase.proj_id
                             LEFT JOIN mdm_phase ON phase.phase_id = mdm_phase.id
                             LEFT JOIN mdm_obj_phase_index ON phase.id = mdm_obj_phase_index.obj_phase_id
                        AND mdm_obj_phase_index.obj_type = 0
                    WHERE approval_status = '已审核'
                    UNION ALL
                    SELECT
                        tm.order_hierarchy_code,-- 对象全路径排序编码
                        id,
                        org_name,
                        '' AS proj_phase,
                        '' AS phase_id,
                        '' AS proj_phase_id,
                        '' AS Proj_Code,
                        0 org_type,
                        NULL is_exist_proj_phase,
                        parent_id,
                        0 AS "totalSiteArea",
                        0 AS "overallFloorageArea",
                        0 AS "totalSalableArea",
                        0 AS "totalCapacityArea"
                    FROM (select * from tm3 union select * from tm4) tm WHERE org_type = 0
                                                                          AND (id != '000100000000000000000000000000' AND id != '000200000000000000000000000000')
                ) t
            )A LEFT JOIN (
                SELECT A.PROJ_ID,A.TARGET_WORTH
                FROM DWM_TARGET_WORTH A RIGHT JOIN (
                    SELECT D.PROJ_ID,D.TARGET_WORTH_PHASE,MAX(WORTH_V) AS WORTH_V
                    FROM DWM_TARGET_WORTH D
                    WHERE D.IS_DELETE = 0 AND D.APPROVAL_STATUS IN ('审核中', '已审核') AND D.TARGET_WORTH_PHASE = 20
                    GROUP BY D.PROJ_ID,D.TARGET_WORTH_PHASE
                )A1 ON A.PROJ_ID = A1.PROJ_ID AND A.WORTH_V = A1.WORTH_V
                    AND A.TARGET_WORTH_PHASE = A1.TARGET_WORTH_PHASE
                where a1.worth_v is not null and a.is_delete = 0
                  AND a.approval_status IN ('审核中','已审核') AND a.target_worth_phase = 20
            )X ON A.orgId = X.PROJ_ID LEFT JOIN (
                SELECT B.PROJ_ID,B.TARGET_WORTH FROM DWM_TARGET_WORTH B RIGHT JOIN (
                    SELECT D.ID,D.PROJ_ID,MAX(APPROVAL_TIME)
                    FROM DWM_TARGET_WORTH D
                    WHERE D.IS_DELETE = 0 AND D.APPROVAL_STATUS IN ('审核中', '已审核') AND D.TARGET_WORTH_PHASE = 10
                    GROUP BY D.ID,D.PROJ_ID) B1 ON B.ID = B1.ID
            )Y ON A.orgId = Y.PROJ_ID LEFT JOIN (
                SELECT C.PROJ_ID,C.TARGET_WORTH
                FROM DWM_TARGET_WORTH C  RIGHT JOIN(
                    SELECT ID,D.PROJ_ID,MAX(APPROVAL_TIME)
                    FROM DWM_TARGET_WORTH D
                    WHERE D.IS_DELETE = 0 AND D.APPROVAL_STATUS IN ('审核中', '已审核') AND D.TARGET_WORTH_PHASE = 0
                    GROUP BY D.ID,D.PROJ_ID
                ) C1 ON C.ID = C1.ID
            )Z ON A.orgId = Z.PROJ_ID LEFT JOIN (
                SELECT E.OBJ_ID,E.VALUE_DT_ALL
                     ,(E.Value_Reserve+E.VALUE_IN_PROCESS+E.VALUE_STOCK+E.VALUE_HAVED_SALE) AS VALUE_DT_ALL_OPT
                     ,E.Value_Reserve,E.VALUE_IN_PROCESS,E.VALUE_STOCK,E.VALUE_HAVED_SALE FROM DWM_DT_VALUE E
                WHERE E.Obj_Type='项目'
            )DT ON A.orgId = DT.OBJ_ID
            ORDER BY A.order_hierarchy_code,A.proj_Code
        )
        select * from tm5
        where tm5.id in (select ID from tm3 union select ID from tm4) or parentsId in (select ID from tm4);
END p_dwm_company_proj_situation;
/

prompt
prompt Creating procedure P_DWM_COMPANY_WORTH_SITUATION
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_DWM_COMPANY_WORTH_SITUATION" (wacthinfo OUT sys_refcursor)
AS  
--首页-公司可售货值情况（树列表）
--作者：陈丽
--日期：2019/11/13
BEGIN  
open wacthinfo for  
select 
'A' as "id",
'' as "parentsId",
'A项目' as "orgName",
'300' as  "projTotal",
'1000' as "dynamicWorth", 
'111' as "reserveWorth", 
'111' as "wayWorth", 
'111' as "inventoryWorth",
'111' as "jumpUrl"
from dual
union all
select
'B' as "id",
'' as "parentsId",
'A项目' as "orgName",
'300' as  "projTotal",
'1000' as "dynamicWorth", 
'111' as "reserveWorth", 
'111' as "wayWorth", 
'111' as "inventoryWorth",
'111' as "jumpUrl"
from dual
union all
select 
'A1' as "id",
'A' as "parentsId",
'A项目' as "orgName",
'300' as  "projTotal",
'1000' as "dynamicWorth", 
'111' as "reserveWorth", 
'111' as "wayWorth", 
'111' as "inventoryWorth",
'111' as "jumpUrl"
from dual
union all
select 
'A2' as "id",
'A' as "parentsId",
'A项目' as "orgName",
'300' as  "projTotal",
'1000' as "dynamicWorth", 
'111' as "reserveWorth", 
'111' as "wayWorth", 
'111' as "inventoryWorth",
'111' as "jumpUrl"
from dual;
END P_DWM_COMPANY_WORTH_SITUATION;
/

prompt
prompt Creating procedure P_DWM_DATALIST_K2
prompt ====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_DATALIST_K2
(
  sortField IN VARCHAR2
, orderBy IN VARCHAR2 
, rowNumber IN number
, k2DataList OUT sys_refcursor 
) AS 
whereStr varchar2(500):='';
v_sql clob :='';
-- 用于返回筛选的列
v_column clob :='';
-- 用于解决排序字段有span标签问题
sortStr varchar2(100):='';
BEGIN
  sortStr := sortField;
  if sortStr = 'firstOpenDurationByPlan' then
    sortStr := 'FIRST_OPEN_DURATION_BY_PLAN';
  elsif sortStr = 'firstOpenDate' then
    sortStr := 'FIRST_OPEN_DATE';
  elsif sortStr = 'takeLandDate' then
    sortStr := 'TAKE_LAND_DATE'; 
  elsif sortStr = 'planFirstOpenDate' then
    sortStr := 'PLAN_FIRST_OPEN_DATE';  
  elsif sortStr = 'firstOpenDurationByTL' then
    sortStr := 'FIRST_OPEN_DURATION_BY_TL';
  elsif sortStr = 'projectName' then
    sortStr := 'projectNameCopy';  
  end if;
  v_sql:='select 
        NVL(FIRST_OPEN_DURATION_BY_PLAN,0) as "FIRST_OPEN_DURATION_BY_PLAN",
        FIRST_OPEN_DATE,
        TAKE_LAND_DATE,
        PLAN_FIRST_OPEN_DATE,
        NVL(FIRST_OPEN_DURATION_BY_TL,0) as "FIRST_OPEN_DURATION_BY_TL",

        PROJECT_NAME as "projectNameCopy",
        FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_PLAN) as "firstOpenDurationByPlanCopy",
        FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_TL) as "firstOpenDurationByTLCopy",
        to_char(FIRST_OPEN_DATE,''yyyy-mm-dd'') as "firstOpenDateCopy",
        Fn_DWM_DurationDaysDeal(PLAN_FIRST_OPEN_DATE, FIRST_OPEN_DATE, ''pure'') as "advanceFirstOpenDateCopy",

        PROJECT_ID as "projectId", 
        FN_DWM_FONT_COLOR(PROJECT_NAME) as "projectName",
        FN_DWM_FONT_COLOR(FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_TL)) as "firstOpenDurationByTL",
        FN_DWM_FONT_COLOR(to_char(FIRST_OPEN_DATE,''yyyy-mm-dd'')) as "firstOpenDate",
        to_char(TAKE_LAND_DATE,''yyyy-mm-dd'') as "takeLandDate",
        to_char(PLAN_FIRST_OPEN_DATE,''yyyy-mm-dd'') as "planFirstOpenDate",
        FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_PLAN) as "firstOpenDurationByPlan",
        Fn_DWM_DurationDaysDeal(PLAN_FIRST_OPEN_DATE, FIRST_OPEN_DATE, ''label'') as "advanceFirstOpenDate"
    from DWM_SALE_RATE_PROJECT 
    where TO_DATE(trunc(sysdate,''yyyy'')) <= FIRST_OPEN_DATE';
  v_column := ' "projectId",
      "projectName",
      "firstOpenDurationByPlan",
      "firstOpenDate",
      "takeLandDate",
      "planFirstOpenDate",
      "firstOpenDurationByTL",
      "advanceFirstOpenDate",
      "projectNameCopy", 
      "firstOpenDurationByPlanCopy",
      "firstOpenDateCopy",
      "advanceFirstOpenDateCopy",
      "firstOpenDurationByTLCopy" ';
--    if rowNumber <> 0 then
--    whereStr:='where rownum<= ' || rowNumber;
--    end if;
    if sortStr is not null and orderBy is not null then
        whereStr:=whereStr||' order by tab."'||sortStr||'"  '||orderBy;
    end if;
    if whereStr is not null then
        v_sql:='select ' || v_column || ' from ('||v_sql||') tab '||whereStr;
    else
        v_sql:='select ' || v_column || ' from (' ||v_sql || ' )';
    end if;
    -- 选择前n条数据，rownum必须拼接在排序后面，不然会先运行rownum再运行排序，会导致筛选数据并不准确
    if rowNumber <> 0 then
        v_sql := 'select ' || v_column || ' from (' ||v_sql || ' )' || ' where rownum <= ' || rowNumber;
    end if;
    dbms_output.put_line(v_sql);
OPEN k2DataList FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE k2DataList;
END P_DWM_DATALIST_K2;
/

prompt
prompt Creating procedure P_DWM_DATALIST_K3
prompt ====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_DATALIST_K3
(
  sortField IN VARCHAR2
, orderBy IN VARCHAR2  
, rowNumber IN NUMBER
, appachAll IN NUMBER
, k3DataList OUT sys_refcursor
) AS
whereStr varchar2(500):='where 1 = 1 ';
v_sql clob :='';
-- 用于返回筛选的列
v_column clob :='';
-- 用于解决排序字段有span标签问题
sortStr varchar2(100):='';
BEGIN
  sortStr := sortField;
  if sortStr = 'firstOpenDate' then
    sortStr := 'FIRST_OPEN_DATE';
  elsif sortStr = 'poSaleRateByMoney' then
    sortStr := 'PO_SALE_RATE_BY_MONEY';
  elsif sortStr = 'poSaleMoney' then
    sortStr := 'PO_SALE_MONEY'; 
  elsif sortStr = 'poSaleOutMoney' then
    sortStr := 'PO_SALE_OUT_MONEY';  
  elsif sortStr = 'poSaleRateByCount' then
    sortStr := 'PO_SALE_RATE_BY_COUNT';
  elsif sortStr = 'poSaleCount' then
    sortStr := 'PO_SALE_COUNT';
  elsif sortStr = 'poSaleOutCount' then
    sortStr := 'PO_SALE_OUT_COUNT';
  elsif sortStr = 'poSaleRateByArea' then
    sortStr := 'PO_SALE_RATE_BY_AREA';
  elsif sortStr = 'poSaleArea' then
    sortStr := 'PO_SALE_AREA';
  elsif sortStr = 'poSaleOutArea' then
    sortStr := 'PO_SALE_OUT_AREA';
  elsif sortStr = 'projectName' then
    sortStr := 'projectNameCopy';  
  end if;
  v_sql:='select
        p.FIRST_OPEN_DATE as "FIRST_OPEN_DATE",
        NVL(sr.PO_SALE_RATE_BY_MONEY,0) as "PO_SALE_RATE_BY_MONEY",
        NVL(sr.PO_SALE_MONEY,0) as "PO_SALE_MONEY",
        NVL(sr.PO_SALE_OUT_MONEY,0) as "PO_SALE_OUT_MONEY",
        NVL(sr.PO_SALE_RATE_BY_COUNT,0) as "PO_SALE_RATE_BY_COUNT",
        NVL(sr.PO_SALE_COUNT,0) as "PO_SALE_COUNT",
        NVL(sr.PO_SALE_OUT_COUNT,0) as "PO_SALE_OUT_COUNT",
        NVL(sr.PO_SALE_RATE_BY_AREA,0) as "PO_SALE_RATE_BY_AREA",
        NVL(sr.PO_SALE_AREA,0) as "PO_SALE_AREA",
        NVL(sr.PO_SALE_OUT_AREA,0) as "PO_SALE_OUT_AREA",

        p.PROJECT_NAME as "projectNameCopy",
        FN_DWM_DEC_CONVERT_PCT(sr.PO_SALE_RATE_BY_MONEY) as "poSaleRateByMoneyCopy",
        FN_DWM_DEC_CONVERT_PCT(sr.PO_SALE_RATE_BY_COUNT) as "poSaleRateByCountCopy",
        FN_DWM_DEC_CONVERT_PCT(sr.PO_SALE_RATE_BY_AREA) as "poSaleRateByAreaCopy",

        p.PROJECT_ID as "projectId",
        FN_DWM_FONT_COLOR(p.PROJECT_NAME) as "projectName",
        to_char(p.FIRST_OPEN_DATE,''yyyy-mm-dd'') as "firstOpenDate",
        FN_DWM_FONT_LAYERED_COLOR(sr.PO_SALE_RATE_BY_MONEY, 0.9) as "poSaleRateByMoney",
        FN_DWM_MULTIPLE_AND_UNIT(sr.PO_SALE_MONEY, 100000000, ''亿'') as "poSaleMoney",
        FN_DWM_MULTIPLE_AND_UNIT(sr.PO_SALE_OUT_MONEY, 100000000, ''亿'') as "poSaleOutMoney",
        FN_DWM_FONT_COLOR(FN_DWM_DEC_CONVERT_PCT(sr.PO_SALE_RATE_BY_COUNT)) as "poSaleRateByCount",
        sr.PO_SALE_COUNT || ''套'' as "poSaleCount",
        sr.PO_SALE_OUT_COUNT || ''套'' as "poSaleOutCount",
        FN_DWM_FONT_COLOR(FN_DWM_DEC_CONVERT_PCT(sr.PO_SALE_RATE_BY_AREA)) as "poSaleRateByArea",
        FN_DWM_MULTIPLE_AND_UNIT(sr.PO_SALE_AREA, 10000, ''万方'') as "poSaleArea",
        FN_DWM_MULTIPLE_AND_UNIT(sr.PO_SALE_OUT_AREA, 10000, ''万方'') as "poSaleOutArea"
    from DWM_SALE_RATE_BY_PROJECT sr
    left join DWM_SALE_RATE_PROJECT p 
    on sr.PROJECT_ID = p.PROJECT_ID
    where p.PROJECT_NAME is not null';
  v_column := ' "projectId",
      "projectName",
      "firstOpenDate",
      "poSaleRateByMoney",
      "poSaleMoney",
      "poSaleOutMoney",
      "poSaleRateByCount",
      "poSaleCount",
      "poSaleOutCount", 
      "poSaleRateByArea",
      "poSaleArea",
      "poSaleOutArea",

      "projectNameCopy",
      "poSaleRateByMoneyCopy",
      "poSaleRateByCountCopy",
      "poSaleRateByAreaCopy"';
  if appachAll = 1 then
    whereStr := whereStr || ' and tab.PO_SALE_RATE_BY_MONEY <= 0.99 ';
  end if;
  if sortStr is not null and orderBy is not null then
    whereStr:=whereStr||' order by tab."'||sortStr||'"  '||orderBy;
  end if;
  if whereStr is not null then
    v_sql:='select ' || v_column || ' from ('||v_sql||') tab '||whereStr;
  else
    v_sql:='select ' || v_column || ' from (' ||v_sql || ' )';
  end if;
-- 选择前n条数据，rownum必须拼接在排序后面，不然会先运行rownum再运行排序，会导致筛选数据并不准确
  if rowNumber <> 0 then
    v_sql := 'select ' || v_column || ' from (' ||v_sql || ' )' || ' where rownum <= ' || rowNumber;
  end if;  
    dbms_output.put_line(v_sql);
OPEN k3DataList FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE k3DataList;   
END P_DWM_DATALIST_K3;
/

prompt
prompt Creating procedure P_DWM_DATALIST_K4
prompt ====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_DATALIST_K4
(
  sortField IN VARCHAR2 
, orderBy IN VARCHAR2 
, rowNumber IN number
, k4DataList OUT sys_refcursor 
) AS
whereStr varchar2(500):='where 1 = 1 ';
v_sql clob :='';
-- 用于返回筛选的列
v_column clob :='';
-- 用于解决排序字段有span标签问题
sortStr varchar2(100):='';
BEGIN
sortStr := sortField;
  if sortStr = 'completionRecordDate' then
    sortStr := 'COMPLETION_RECORD_DATE';
  elsif sortStr = 'ehSaleMoney' then
    sortStr := 'EH_SALE_MONEY';
  elsif sortStr = 'ehSaleOutMoney' then
    sortStr := 'EH_SALE_OUT_MONEY'; 
  elsif sortStr = 'ehSaleRateByMoney' then
    sortStr := 'EH_SALE_RATE_BY_MONEY';
  elsif sortStr = 'ehSurplusSaleMoney' then
    sortStr := 'EH_SURPLUS_MONEY';
  elsif sortStr = 'projectName' then
    sortStr := 'projectNameCopy';  
  end if;

  v_sql:= 'select
        p.COMPLETION_RECORD_DATE as "COMPLETION_RECORD_DATE",
        NVL(sa.EH_SALE_MONEY,0) as "EH_SALE_MONEY",
        NVL(sa.EH_SALE_OUT_MONEY,0) as "EH_SALE_OUT_MONEY",
        NVL(sa.EH_SALE_RATE_BY_MONEY,0) as "EH_SALE_RATE_BY_MONEY",
        NVL(sa.EH_SALE_MONEY - sa.EH_SALE_OUT_MONEY,0) as "EH_SURPLUS_MONEY",

        p.PROJECT_NAME as "projectNameCopy",
        FN_DWM_DEC_CONVERT_PCT(sa.EH_SALE_RATE_BY_MONEY) as "ehSaleRateByMoneyCopy",

        p.PROJECT_ID as "projectId",
        FN_DWM_FONT_COLOR(p.PROJECT_NAME) as "projectName",
        to_char(p.COMPLETION_RECORD_DATE,''yyyy-mm-dd'') as "completionRecordDate",
        FN_DWM_MULTIPLE_AND_UNIT(sa.EH_SALE_MONEY, 100000000, ''亿'') as "ehSaleMoney",
        FN_DWM_MULTIPLE_AND_UNIT(sa.EH_SALE_OUT_MONEY, 100000000, ''亿'') as "ehSaleOutMoney",
        FN_DWM_FONT_COLOR(FN_DWM_DEC_CONVERT_PCT(sa.EH_SALE_RATE_BY_MONEY)) as "ehSaleRateByMoney",
        FN_DWM_MULTIPLE_AND_UNIT((sa.EH_SALE_MONEY - sa.EH_SALE_OUT_MONEY), 100000000, ''亿'') as "ehSurplusSaleMoney"
    from DWM_SALE_RATE_PROJECT p 
    left join DWM_SALE_RATE_BY_PROJECT sa
    on sa.PROJECT_ID = p.PROJECT_ID
    where p.COMPLETION_RECORD_DATE is not null';
  v_column := ' "projectId",
      "projectName",
      "completionRecordDate",
      "ehSaleMoney",
      "ehSaleOutMoney",
      "ehSaleRateByMoney",
      "ehSurplusSaleMoney",

      "projectNameCopy",
      "ehSaleRateByMoneyCopy"';

--  if rowNumber <> 0 then
--    whereStr := whereStr || ' and rownum <= ' || rowNumber;
--  end if;
  if sortStr is not null and orderBy is not null then
    whereStr:= whereStr||' order by tab."'||sortStr||'"  '||orderBy || ' nulls last ';
  end if;
  if whereStr is not null then
    v_sql:='select ' || v_column || ' from ('||v_sql||') tab '||whereStr;
  else
    v_sql:='select ' || v_column || ' from (' ||v_sql || ' )';
  end if;
  -- 选择前n条数据，rownum必须拼接在排序后面，不然会先运行rownum再运行排序，会导致筛选数据并不准确
    if rowNumber <> 0 then
        v_sql := 'select ' || v_column || ' from (' ||v_sql || ' )' || ' where rownum <= ' || rowNumber;
    end if;
    dbms_output.put_line(v_sql);

OPEN k4DataList FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE k4DataList;
END P_DWM_DATALIST_K4;
/

prompt
prompt Creating procedure P_DWM_DATALIST_K5
prompt ====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_DATALIST_K5
(
  sortField IN VARCHAR2 
, orderBy IN VARCHAR2 
, rowNumber IN number 
, k5DataList OUT sys_refcursor 
) AS 
whereStr varchar2(500):='where 1 = 1 ';
v_sql clob :='';
-- 用于返回筛选的列
v_column clob :='';
-- 用于解决排序字段有span标签问题
sortStr varchar2(100):='';
BEGIN
sortStr := sortField;
  if sortStr = 'completionRecordDate' then
    sortStr := 'COMPLETION_RECORD_DATE';
  elsif sortStr = 'siSaleArea' then
    sortStr := 'SI_SALE_AREA';
  elsif sortStr = 'siSaleOutArea' then
    sortStr := 'SI_SALE_OUT_AREA'; 
  elsif sortStr = 'siSaleRateByArea' then
    sortStr := 'SI_SALE_RATE_BY_AREA';
  elsif sortStr = 'siSurplusSaleArea' then
    sortStr := 'SI_SURPLUS_AREA';
  elsif sortStr = 'projectName' then
    sortStr := 'projectNameCopy';
  elsif sortStr = 'siSaleMoney' then
    sortStr := 'SI_SALE_MONEY';
  elsif sortStr = 'siSaleOutMoney' then
    sortStr := 'SI_SALE_OUT_MONEY';
  elsif sortStr = 'siSaleRateByMoney' then
    sortStr := 'SI_SALE_RATE_BY_MONEY';
  elsif sortStr = 'siSurplusSaleMoney' then
    sortStr := 'SI_SURPLUS_SALE_MONEY';  
  end if;

  v_sql:= 'select
        p.COMPLETION_RECORD_DATE as "COMPLETION_RECORD_DATE",
        NVL(sa.SI_SALE_AREA,0) as "SI_SALE_AREA",
        NVL(sa.SI_SALE_OUT_AREA,0) as "SI_SALE_OUT_AREA",
        NVL(sa.SI_SALE_RATE_BY_AREA,0) as "SI_SALE_RATE_BY_AREA",
        NVL(sa.SI_SALE_AREA - sa.SI_SALE_OUT_AREA,0) as "SI_SURPLUS_AREA",
        NVL(sa.SI_SALE_MONEY,0) as "SI_SALE_MONEY",
        NVL(sa.SI_SALE_OUT_MONEY,0) as "SI_SALE_OUT_MONEY",
        NVL(sa.SI_SALE_RATE_BY_MONEY,0) as "SI_SALE_RATE_BY_MONEY",
        NVL(sa.SI_SURPLUS_SALE_MONEY,0) as "SI_SURPLUS_SALE_MONEY",

        p.PROJECT_NAME as "projectNameCopy",
        FN_DWM_DEC_CONVERT_PCT(sa.SI_SALE_RATE_BY_AREA) as "siSaleRateByAreaCopy",
        FN_DWM_DEC_CONVERT_PCT(sa.SI_SALE_RATE_BY_MONEY) as "siSaleRateByMoneyCopy",

        p.PROJECT_ID as "projectId",
        FN_DWM_FONT_COLOR(p.PROJECT_NAME) as "projectName",
        to_char(p.COMPLETION_RECORD_DATE,''yyyy-mm-dd'') as "completionRecordDate",
        FN_DWM_MULTIPLE_AND_UNIT(sa.SI_SALE_AREA, 10000, ''万方'') as "siSaleArea",
        FN_DWM_MULTIPLE_AND_UNIT(sa.SI_SALE_OUT_AREA, 10000, ''万方'') as "siSaleOutArea",
        FN_DWM_FONT_COLOR(FN_DWM_DEC_CONVERT_PCT(sa.SI_SALE_RATE_BY_AREA)) as "siSaleRateByArea",
        FN_DWM_MULTIPLE_AND_UNIT((sa.SI_SALE_AREA - sa.SI_SALE_OUT_AREA), 10000, ''万方'') as "siSurplusSaleArea",
        FN_DWM_MULTIPLE_AND_UNIT(sa.SI_SALE_MONEY, 100000000, ''亿'') as "siSaleMoney",
        FN_DWM_MULTIPLE_AND_UNIT(sa.SI_SALE_OUT_MONEY, 100000000, ''亿'') as "siSaleOutMoney",
        FN_DWM_FONT_COLOR(FN_DWM_DEC_CONVERT_PCT(sa.SI_SALE_RATE_BY_MONEY)) as "siSaleRateByMoney",
        FN_DWM_MULTIPLE_AND_UNIT(sa.SI_SURPLUS_SALE_MONEY, 100000000, ''亿'') as "siSurplusSaleMoney"
    from DWM_SALE_RATE_PROJECT p 
    left join DWM_SALE_RATE_BY_PROJECT sa
    on sa.PROJECT_ID = p.PROJECT_ID
    where p.COMPLETION_RECORD_DATE is not null';

  v_column := '"projectId",
      "projectName",
      "completionRecordDate",
      "siSaleArea",
      "siSaleOutArea",
      "siSaleRateByArea",
      "siSurplusSaleArea",
      "siSaleMoney",
      "siSaleOutMoney",
      "siSaleRateByMoney",
      "siSurplusSaleMoney",

      "projectNameCopy",
      "siSaleRateByAreaCopy",
      "siSaleRateByMoneyCopy"';

--  if rowNumber <> 0 then
--    whereStr := whereStr || ' and rownum <= ' || rowNumber;
--  end if;
  if sortStr is not null and orderBy is not null then
    whereStr:= whereStr||' order by tab."'||sortStr||'"  '||orderBy || ' nulls last ';
  end if;
  if whereStr is not null then
    v_sql:='select ' || v_column || ' from ('||v_sql||') tab '||whereStr;
  else
    v_sql:='select ' || v_column || ' from (' ||v_sql || ' )';
  end if;
  -- 选择前n条数据，rownum必须拼接在排序后面，不然会先运行rownum再运行排序，会导致筛选数据并不准确
    if rowNumber <> 0 then
        v_sql := 'select ' || v_column || ' from (' ||v_sql || ' )' || ' where rownum <= ' || rowNumber;
    end if;
  dbms_output.put_line(v_sql);

OPEN k5DataList FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE k5DataList;
END P_DWM_DATALIST_K5;
/

prompt
prompt Creating procedure P_DWM_DEFAULTDATALIST_K3K4K5
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_DEFAULTDATALIST_K3K4K5
(
  k3DataList OUT sys_refcursor 
, k4DataList OUT sys_refcursor 
, k5DataList OUT sys_refcursor 
, k3DataSortField OUT sys_refcursor
, k4DataSortField OUT sys_refcursor
, k5DataSortField OUT sys_refcursor
, tabItems OUT sys_refcursor
, k3total OUT number
, k4total OUT number
, k5total OUT number
) AS
k3_1abstract varchar2(1000);
--k3_3abstract varchar2(1000);
--k3_4abstract varchar2(1000);
k4_1abstract varchar2(1000);
k5_1abstract varchar2(1000);
BEGIN
  select count(1) into k3total from DWM_SALE_RATE_BY_PROJECT sr
    left join DWM_SALE_RATE_PROJECT p 
    on sr.PROJECT_ID = p.PROJECT_ID
    where p.PROJECT_NAME is not null;
  select count(1) into k4total from DWM_SALE_RATE_PROJECT p 
    left join DWM_SALE_RATE_BY_PROJECT sa
    on sa.PROJECT_ID = p.PROJECT_ID
    where p.COMPLETION_RECORD_DATE is not null;
  select count(1) into k5total from DWM_SALE_RATE_PROJECT p 
    left join DWM_SALE_RATE_BY_PROJECT sa
    on sa.PROJECT_ID = p.PROJECT_ID
    where p.COMPLETION_RECORD_DATE is not null;
  SELECT
    details into k3_1abstract
  FROM
    dwm_sale_rate_data_briefing where CODE='k3.1' and rownum=1;
--  SELECT
--    details into k3_3abstract
--  FROM
--    dwm_sale_rate_data_briefing where CODE='k3.3' and rownum=1;
--  SELECT
--    details into k3_4abstract
--  FROM
--    dwm_sale_rate_data_briefing where CODE='k3.4' and rownum=1;
  SELECT
    details into k4_1abstract
  FROM
    dwm_sale_rate_data_briefing where CODE='k4.1' and rownum=1;  
  SELECT
    details into k5_1abstract
  FROM
    dwm_sale_rate_data_briefing where CODE='k5.1' and rownum=1;  

--  open k3DataList for
--    select 
--        p.PROJECT_ID as "projectId",
--        FN_DWM_FONT_COLOR(p.PROJECT_NAME) as "projectName",
--        to_char(p.FIRST_OPEN_DATE,'yyyy-mm-dd') as "firstOpenDate",
--        FN_DWM_FONT_LAYERED_COLOR(sr.PO_SALE_RATE_BY_MONEY, 0.9) as "poSaleRateByMoney",
--        FN_DWM_MULTIPLE_AND_UNIT(sr.PO_SALE_MONEY, 100000000, '亿') as "poSaleMoney",
--        FN_DWM_MULTIPLE_AND_UNIT(sr.PO_SALE_OUT_MONEY, 100000000, '亿') as "poSaleOutMoney",
--        FN_DWM_FONT_COLOR(FN_DWM_DEC_CONVERT_PCT(sr.PO_SALE_RATE_BY_COUNT)) as "poSaleRateByCount",
--        sr.PO_SALE_COUNT || '套' as "poSaleCount",
--        sr.PO_SALE_OUT_COUNT || '套' as "poSaleOutCount",
--        FN_DWM_FONT_COLOR(FN_DWM_DEC_CONVERT_PCT(sr.PO_SALE_RATE_BY_AREA)) as "poSaleRateByArea",
--        FN_DWM_MULTIPLE_AND_UNIT(sr.PO_SALE_AREA, 10000, '万方') as "poSaleArea",
--        FN_DWM_MULTIPLE_AND_UNIT(sr.PO_SALE_OUT_AREA, 10000, '万方') as "poSaleOutArea"
--    from DWM_SALE_RATE_BY_PROJECT sr
--    left join DWM_SALE_RATE_PROJECT p 
--    on sr.PROJECT_ID = p.PROJECT_ID
----  sr.PO_SALE_RATE_BY_MONEY <= 0.99 and   
--    where rowNum < 11
--    order by sr.PO_SALE_RATE_BY_MONEY desc;
  P_DWM_DATALIST_K3('poSaleRateByMoney', 'desc', 10, 0, k3DataList);
  P_DWM_DATALIST_K4('ehSaleRateByMoney', 'desc', 10, k4DataList);
  P_DWM_DATALIST_K5('siSaleRateByArea', 'desc', 10, k5DataList);


  open k3DataSortField for 
    select 'firstOpenDate' as "fieldName" from dual
    union all select 'poSaleRateByMoney' as "fieldName" from dual
    union all select 'poSaleMoney' as "fieldName" from dual
    union all select 'poSaleOutMoney' as "fieldName" from dual
    union all select 'poSaleRateByCount' as "fieldName" from dual
    union all select 'poSaleCount' as "fieldName" from dual
    union all select 'poSaleOutCount' as "fieldName" from dual
    union all select 'poSaleRateByArea' as "fieldName" from dual
    union all select 'poSaleArea' as "fieldName" from dual
    union all select 'poSaleOutArea' as "fieldName" from dual
    union all select 'projectName' as "fieldName" from dual;
  open k4DataSortField for 
    select 'completionRecordDate' as "fieldName" from dual
    union all select 'ehSaleMoney' as "fieldName" from dual
    union all select 'ehSaleOutMoney' as "fieldName" from dual
    union all select 'ehSaleRateByMoney' as "fieldName" from dual
    union all select 'ehSurplusSaleMoney' as "fieldName" from dual
    union all select 'projectName' as "fieldName" from dual;
  open k5DataSortField for 
    select 'completionRecordDate' as  "fieldName" from dual
    union all select 'siSaleArea' as "fieldName" from dual
    union all select 'siSaleOutArea' as "fieldName" from dual
    union all select 'siSaleRateByArea' as "fieldName" from dual
    union all select 'siSurplusSaleArea' as "fieldName" from dual
    union all select 'projectName' as "fieldName" from dual
    union all select 'siSaleMoney' as "fieldName" from dual
    union all select 'siSaleOutMoney' as "fieldName" from dual
    union all select 'siSaleRateByMoney' as "fieldName" from dual
    union all select 'siSurplusSaleMoney' as "fieldName" from dual;

  open tabItems for
    select '1、全案已取证去化率排行' as "title",k3_1abstract as "abstract",'k3' as "code",1 as "sort" from dual
    union
    select '2、全案已取证去化率变动趋势图' as "title",'' as "abstract",'k3' as "code",2 as "sort" from dual
--    union
--    select '3、本年新取证货值的去化率排行' as "title",k3_3abstract as "abstract",'k3' as "code",3 as "sort" from dual
--    union
--    select '4、本年新取证货值的去化率趋势图' as "title",k3_4abstract as "abstract",'k3' as "code",4 as "sort" from dual

    union
    select '1、现房去化率排行' as "title",k4_1abstract as "abstract",'k4' as "code",1 as "sort" from dual
    union
    select '2、现房去化率变动趋势图' as "title",'' as "abstract",'k4' as "code",2 as "sort" from dual
    union
    select '3、剩余现房货值变动趋势图' as "title",'' as "abstract",'k4' as "code",3 as "sort" from dual

    union
    select '1、顽固性库存去化率排行' as "title",k5_1abstract as "abstract",'k5' as "code",1 as "sort" from dual
    union
    select '2、顽固性库存去化率变动趋势图' as "title",'' as "abstract",'k5' as "code",2 as "sort" from dual
    union
    select '3、剩余顽固性库存变动趋势图' as "title",'' as "abstract",'k5' as "code",3 as "sort" from dual;
END P_DWM_DEFAULTDATALIST_K3K4K5;
/

prompt
prompt Creating procedure P_DWM_DETAILBARCHARTKK3K4K5
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_detailBarChartkK3k4k5(projectId in varchar2,tabName in varchar2,bartitle out varchar2,seriesdataName out  varchar2,saleratebycount out sys_refcursor,saleratebyarea out sys_refcursor,saleratebymoney out sys_refcursor)
AS 
SALE_OUT_COUNT_Business number(16,0):=0;
SALE_COUNT_Business number(16,0):=0;
SALE_RATE_BY_COUNT_Business number(16,4):=0;
SALE_OUT_AREA_Business number(16,2):=0;
SALE_AREA_Business number(16,2):=0;
SALE_RATE_BY_AREA_Business number(16,4):=0;
SALE_OUT_MONEY_Business number(16,2):=0;
SALE_MONEY_Business number(16,2):=0;
SALE_RATE_BY_MONEY_Business number(16,4):=0;

SALE_OUT_COUNT_House number(16,0):=0;
SALE_COUNT_House number(16,0):=0;
SALE_RATE_BY_COUNT_House number(16,4):=0;
SALE_OUT_AREA_House number(16,2):=0;
SALE_AREA_House number(16,2):=0;
SALE_RATE_BY_AREA_House number(16,4):=0;
SALE_OUT_MONEY_House number(16,2):=0;
SALE_MONEY_House number(16,2):=0;
SALE_RATE_BY_MONEY_House number(16,4):=0;

SALE_OUT_COUNT_ParkingSpace number(16,0):=0;
SALE_COUNT_ParkingSpace number(16,0):=0;
SALE_RATE_BY_COUNT_ParkingSpa number(16,4):=0;
SALE_OUT_AREA_ParkingSpace number(16,2):=0;
SALE_AREA_ParkingSpace number(16,2):=0;
SALE_RATE_BY_AREA_ParkingSpace number(16,4):=0;
SALE_OUT_MONEY_ParkingSpace number(16,2):=0;
SALE_MONEY_ParkingSpace number(16,2):=0;
SALE_RATE_BY_MONEY_ParkingSpa number(16,4):=0;

typeName varchar2(500):='';
rowcount number:=0;
series  varchar2(500):='';
begin
if tabName='k3' then
    select count(1) into rowcount  from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='商办产业';
    if rowcount<>0 then
    select PO_SALE_OUT_COUNT,
    PO_SALE_COUNT,
    PO_SALE_RATE_BY_COUNT,
    PO_SALE_OUT_AREA,
    PO_SALE_AREA,
    PO_SALE_RATE_BY_AREA,
    PO_SALE_OUT_MONEY,
    PO_SALE_MONEY,
    PO_SALE_RATE_BY_MONEY into  SALE_OUT_COUNT_Business,SALE_COUNT_Business,SALE_RATE_BY_COUNT_Business,SALE_OUT_AREA_Business,SALE_AREA_Business,SALE_RATE_BY_AREA_Business ,SALE_OUT_MONEY_Business ,SALE_MONEY_Business ,SALE_RATE_BY_MONEY_Business
    from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='商办产业';
    end if;
    select count(1) into rowcount  from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='车位仓储';
    if rowcount<>0 then
    select PO_SALE_OUT_COUNT,
    PO_SALE_COUNT,
    PO_SALE_RATE_BY_COUNT,
    PO_SALE_OUT_AREA,
    PO_SALE_AREA,
    PO_SALE_RATE_BY_AREA,
    PO_SALE_OUT_MONEY,
    PO_SALE_MONEY,
    PO_SALE_RATE_BY_MONEY  into  SALE_OUT_COUNT_ParkingSpace,SALE_COUNT_ParkingSpace,SALE_RATE_BY_COUNT_ParkingSpa ,SALE_OUT_AREA_ParkingSpace,SALE_AREA_ParkingSpace ,SALE_RATE_BY_AREA_ParkingSpace ,SALE_OUT_MONEY_ParkingSpace ,SALE_MONEY_ParkingSpace ,SALE_RATE_BY_MONEY_ParkingSpa 
    from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='车位仓储';
    end if;
    select count(1) into rowcount  from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='住宅';
    if rowcount<>0 then
    select PO_SALE_OUT_COUNT,
    PO_SALE_COUNT,
    PO_SALE_RATE_BY_COUNT,
    PO_SALE_OUT_AREA,
    PO_SALE_AREA,
    PO_SALE_RATE_BY_AREA,
    PO_SALE_OUT_MONEY,
    PO_SALE_MONEY,
    PO_SALE_RATE_BY_MONEY  into  SALE_OUT_COUNT_House,SALE_COUNT_House,SALE_RATE_BY_COUNT_House ,SALE_OUT_AREA_House,SALE_AREA_House ,SALE_RATE_BY_AREA_House ,SALE_OUT_MONEY_House ,SALE_MONEY_House ,SALE_RATE_BY_MONEY_House 
    from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='住宅';
    end if;
    typeName:='全案已取证';
    bartitle:='<span style="font-weight: bold;color: #333;">二、'||typeName||'去化率(%) ——按业态</span>';
    seriesdataName:='住宅,商业,车位';
    series:='已取证';
elsif tabName='k4' then
    select count(1) into rowcount  from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='商办产业';
    if rowcount<>0 then
    select EH_SALE_OUT_COUNT,
    EH_SALE_COUNT,
    EH_SALE_RATE_BY_COUNT,
    EH_SALE_OUT_AREA,
    EH_SALE_AREA,
    EH_SALE_RATE_BY_AREA,
    EH_SALE_OUT_MONEY,
    EH_SALE_MONEY,
    EH_SALE_RATE_BY_MONEY into  SALE_OUT_COUNT_Business,SALE_COUNT_Business,SALE_RATE_BY_COUNT_Business,SALE_OUT_AREA_Business,SALE_AREA_Business,SALE_RATE_BY_AREA_Business ,SALE_OUT_MONEY_Business ,SALE_MONEY_Business ,SALE_RATE_BY_MONEY_Business
    from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='商办产业';
    end if;
    select count(1) into rowcount  from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='车位仓储';
    if rowcount<>0 then
    select EH_SALE_OUT_COUNT,
    EH_SALE_COUNT,
    EH_SALE_RATE_BY_COUNT,
    EH_SALE_OUT_AREA,
    EH_SALE_AREA,
    EH_SALE_RATE_BY_AREA,
    EH_SALE_OUT_MONEY,
    EH_SALE_MONEY,
    EH_SALE_RATE_BY_MONEY  into  SALE_OUT_COUNT_ParkingSpace,SALE_COUNT_ParkingSpace,SALE_RATE_BY_COUNT_ParkingSpa ,SALE_OUT_AREA_ParkingSpace,SALE_AREA_ParkingSpace ,SALE_RATE_BY_AREA_ParkingSpace ,SALE_OUT_MONEY_ParkingSpace ,SALE_MONEY_ParkingSpace ,SALE_RATE_BY_MONEY_ParkingSpa 
    from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='车位仓储';
    end if;
    select count(1) into rowcount  from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='住宅';
    if rowcount<>0 then
    select EH_SALE_OUT_COUNT,
    EH_SALE_COUNT,
    EH_SALE_RATE_BY_COUNT,
    EH_SALE_OUT_AREA,
    EH_SALE_AREA,
    EH_SALE_RATE_BY_AREA,
    EH_SALE_OUT_MONEY,
    EH_SALE_MONEY,
    EH_SALE_RATE_BY_MONEY  into  SALE_OUT_COUNT_House,SALE_COUNT_House,SALE_RATE_BY_COUNT_House ,SALE_OUT_AREA_House,SALE_AREA_House ,SALE_RATE_BY_AREA_House ,SALE_OUT_MONEY_House ,SALE_MONEY_House ,SALE_RATE_BY_MONEY_House 
    from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='住宅';
    end if;
    typeName:='现房';
    bartitle:='<span style="font-weight: bold;color: #333;">二、'||typeName||'去化率(%) ——按业态</span>';
    seriesdataName:='住宅,商业,车位';
    series:='已竣备';
elsif tabName='k5' then
    select count(1) into rowcount  from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='商办产业';
    if rowcount<>0 then
    select SI_SALE_OUT_COUNT,
    SI_SALE_COUNT,
    SI_SALE_RATE_BY_COUNT,
    SI_SALE_OUT_AREA,
    SI_SALE_AREA,
    SI_SALE_RATE_BY_AREA,
    SI_SALE_OUT_MONEY,
    SI_SALE_MONEY,
    SI_SALE_RATE_BY_MONEY into  SALE_OUT_COUNT_Business,SALE_COUNT_Business,SALE_RATE_BY_COUNT_Business,SALE_OUT_AREA_Business,SALE_AREA_Business,SALE_RATE_BY_AREA_Business ,SALE_OUT_MONEY_Business ,SALE_MONEY_Business ,SALE_RATE_BY_MONEY_Business
    from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='商办产业';
    end if;
    select count(1) into rowcount  from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='车位仓储';
    if rowcount<>0 then
    select SI_SALE_OUT_COUNT,
    SI_SALE_COUNT,
    SI_SALE_RATE_BY_COUNT,
    SI_SALE_OUT_AREA,
    SI_SALE_AREA,
    SI_SALE_RATE_BY_AREA,
    SI_SALE_OUT_MONEY,
    SI_SALE_MONEY,
    SI_SALE_RATE_BY_MONEY  into  SALE_OUT_COUNT_ParkingSpace,SALE_COUNT_ParkingSpace,SALE_RATE_BY_COUNT_ParkingSpa ,SALE_OUT_AREA_ParkingSpace,SALE_AREA_ParkingSpace ,SALE_RATE_BY_AREA_ParkingSpace ,SALE_OUT_MONEY_ParkingSpace ,SALE_MONEY_ParkingSpace ,SALE_RATE_BY_MONEY_ParkingSpa 
    from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID=projectId and DATA_GRANULARITY='车位仓储';
    end if;
    typeName:='顽固性库存';
    bartitle:='<span style="font-weight: bold;color: #333;">二、'||typeName||'去化率(%) ——按业态</span>';
    seriesdataName:='商业,车位';
    series:='顽固性库存';
end if;
open saleratebycount for
select 
 series||'套数,签约套数,去化率' as "series", 
 typeName||'去化率（按套数）' as "chartTitle",
 '' as "abstract",
  case  when  tabName<>'k5' then
      to_char(SALE_COUNT_House)||','||to_char(SALE_COUNT_Business)||','||to_char(SALE_COUNT_ParkingSpace) else
      to_char(SALE_COUNT_Business)||','||to_char(SALE_COUNT_ParkingSpace) end as "saleData",
  case  when  tabName<>'k5' then
    to_char(SALE_OUT_COUNT_House)||','||to_char(SALE_OUT_COUNT_Business)||','||to_char(SALE_OUT_COUNT_ParkingSpace) else 
    to_char(SALE_OUT_COUNT_Business)||','||to_char(SALE_OUT_COUNT_ParkingSpace) end as "saleOutData",
  case  when  tabName<>'k5' then
    to_char(trunc(SALE_RATE_BY_COUNT_House*100,2))||','||to_char(trunc(SALE_RATE_BY_COUNT_Business*100,2))||','||to_char(trunc(SALE_RATE_BY_COUNT_ParkingSpa*100,2)) else 
    to_char(trunc(SALE_RATE_BY_COUNT_Business*100,2))||','||to_char(trunc(SALE_RATE_BY_COUNT_ParkingSpa*100,2)) end as "saleRateData",
  1 as sort,
  '套' "unit"
from dual;
open saleratebyarea for
select 
 series||'面积,签约面积,去化率' as "series", 
 typeName||'去化率（按面积）' as "chartTitle",
 '（面积单位：万方）' as "abstract",
  case  when  tabName<>'k5' then
      FN_DWM_MULTIPLE_AND_UNIT(SALE_AREA_House,10000,'')||','|| FN_DWM_MULTIPLE_AND_UNIT(SALE_AREA_Business,10000,'')||','||FN_DWM_MULTIPLE_AND_UNIT(SALE_AREA_ParkingSpace,10000,'') else 
      FN_DWM_MULTIPLE_AND_UNIT(SALE_AREA_Business,10000,'')||','||FN_DWM_MULTIPLE_AND_UNIT(SALE_AREA_ParkingSpace,10000,'') end as "saleData",
 case  when  tabName<>'k5' then
      FN_DWM_MULTIPLE_AND_UNIT(SALE_OUT_AREA_House,10000,'')||','||FN_DWM_MULTIPLE_AND_UNIT(SALE_OUT_AREA_Business,10000,'')||','||FN_DWM_MULTIPLE_AND_UNIT(SALE_OUT_AREA_ParkingSpace,10000,'') else 
      FN_DWM_MULTIPLE_AND_UNIT(SALE_OUT_AREA_Business,10000,'')||','||FN_DWM_MULTIPLE_AND_UNIT(SALE_OUT_AREA_ParkingSpace,10000,'') end as "saleOutData",
  case  when  tabName<>'k5' then
      to_char(trunc(SALE_RATE_BY_AREA_House*100,2))||','||to_char(trunc(SALE_RATE_BY_AREA_Business*100,2))||','||to_char(trunc(SALE_RATE_BY_AREA_ParkingSpace*100,2)) else
      to_char(trunc(SALE_RATE_BY_AREA_Business*100,2))||','||to_char(trunc(SALE_RATE_BY_AREA_ParkingSpace*100,2)) end as "saleRateData",
  3 as sort,
   '万方' "unit"
from dual;
open saleratebymoney for
select 
 series||'货值,签约货值,去化率' as "series", 
 typeName||'去化率（按货值）' as "chartTitle",
 '（货值单位：亿）' as "abstract",
  case  when  tabName<>'k5' then
      FN_DWM_MULTIPLE_AND_UNIT(SALE_MONEY_House,100000000,'')||','||FN_DWM_MULTIPLE_AND_UNIT(SALE_MONEY_Business,100000000,'')||','|| FN_DWM_MULTIPLE_AND_UNIT(SALE_MONEY_ParkingSpace,100000000,'') else 
      FN_DWM_MULTIPLE_AND_UNIT(SALE_MONEY_Business,100000000,'')||','|| FN_DWM_MULTIPLE_AND_UNIT(SALE_MONEY_ParkingSpace,100000000,'') end  as "saleData",
  case  when  tabName<>'k5' then
     FN_DWM_MULTIPLE_AND_UNIT(SALE_OUT_MONEY_House,100000000,'')||','||FN_DWM_MULTIPLE_AND_UNIT(SALE_OUT_MONEY_Business,100000000,'')||','|| FN_DWM_MULTIPLE_AND_UNIT(SALE_OUT_MONEY_ParkingSpace,100000000,'') else 
     FN_DWM_MULTIPLE_AND_UNIT(SALE_OUT_MONEY_Business,100000000,'')||','|| FN_DWM_MULTIPLE_AND_UNIT(SALE_OUT_MONEY_ParkingSpace,100000000,'') end as "saleOutData",
 case  when  tabName<>'k5' then
      to_char(trunc(SALE_RATE_BY_MONEY_House*100,2))||','||to_char(trunc(SALE_RATE_BY_MONEY_Business*100,2))||','||to_char(trunc(SALE_RATE_BY_MONEY_ParkingSpa*100,2))  else
      to_char(trunc(SALE_RATE_BY_MONEY_Business*100,2))||','||to_char(trunc(SALE_RATE_BY_MONEY_ParkingSpa*100,2)) end  as "saleRateData",
 2 as sort,
  '亿' "unit"
from dual;
end P_DWM_detailBarChartkK3k4k5;
/

prompt
prompt Creating procedure P_DWM_DETAILDATAK2
prompt =====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_detailDatak2(projectId in varchar2,bartitle out varchar2,firstopendate out varchar2,planfirstopendate out varchar2,bardata out sys_refcursor,
listdata out sys_refcursor,nodeplantitle out varchar2,nodeplanlist out sys_refcursor,chartTitle out varchar2,chartDescription out varchar2)
AS 
firstopendateValue date;
takeLandDate date;
planfirstopendateValue date;
newPlanFirstOpenDate date;
exhibitionAreaOpenDate date;
exhibitionAreaOpenByPlan date;
planApprovalDate date;
planApprovalDateByPlan date;
rowcount number :=0;
begin
execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd''';
bartitle:='<span style="font-weight: bold;color: #333;">一、拿地至首开时间</span>';
chartTitle:='拿地至首开时间';
nodeplantitle:='<span style="font-weight: bold;color: #333;">二、首开分期“关键节点计划”</span>';
select count(1) into  rowcount  from  DWM_SALE_RATE_PROJECT where PROJECT_ID=projectId;
select FIRST_OPEN_DATE,
TAKE_LAND_DATE,
PLAN_FIRST_OPEN_DATE,
NEW_PLAN_FIRST_OPEN_DATE,
EXHIBITION_AREA_OPEN_DATE,
EXHIBITION_AREA_OPEN_BY_PLAN,
PLAN_APPROVAL_DATE,
PLAN_APPROVAL_DATE_BY_PLAN 
into 
firstopendateValue,
takeLandDate,
planfirstopendateValue,
newPlanFirstOpenDate,
exhibitionAreaOpenDate,
exhibitionAreaOpenByPlan,
planApprovalDate,
planApprovalDateByPlan
from DWM_SALE_RATE_PROJECT where PROJECT_ID=projectId;
firstopendate:='<span style="font-weight: bold;color:#333">实际首开日期：</span>';
planfirstopendate:='<span style="font-weight: bold;color:#333">计划首开日期：</span>';
if firstopendateValue is not null then
    firstopendate:='<span style="font-weight: bold;color:#333">实际首开日期：'||to_char(firstopendateValue,'yyyy-mm-dd')||'</span>';
end if;
if planfirstopendateValue is not null then
    planfirstopendate:='<span style="font-weight: bold;color:#333">计划首开日期：'||to_char(planfirstopendateValue,'yyyy-mm-dd')||'</span>';
end if;
if planfirstopendateValue is not null and firstopendateValue is not null then
    firstopendate:=firstopendate||'<span style="font-weight: bold;">     '||Fn_DWM_DurationDaysDeal(planfirstopendateValue,firstopendateValue,'label')||'';
    open bardata for
    select 
    '实际首开时间' as "seriesName",
    case when planfirstopendateValue is not null then
     trunc(months_between(firstopendateValue,takeLandDate),1)
     else 0 end as "seriesValue"
    from  dual 
    union 
    select 
    '计划首开时间' as "seriesName",
    case when planfirstopendateValue is not null then
    trunc(months_between(planfirstopendateValue,takeLandDate),1) 
    else 0 end as "seriesValue"
    from  dual;
chartDescription:=to_char(trunc(months_between(firstopendateValue,takeLandDate),1))||'月';
end if;

open listdata for
    select * from(select 
    '<span style="font-weight: bold;color:#333">拿地 -->方案批复</ span>' as "description",
    case when takeLandDate is not null and planApprovalDate is not null then trunc(months_between(planApprovalDate,takeLandDate),1) else null end  as "realityDuration",
    case when takeLandDate is not null and planApprovalDateByPlan is not null then trunc(months_between(planApprovalDateByPlan,takeLandDate),1) else null end  as "planDuration",
    replace(Fn_DWM_DurationDaysDeal(planApprovalDateByPlan,planApprovalDate,'label'),'首开','') as "abstract",
    1 as sort
    from  dual  union
    select 
    '<span style="font-weight: bold;color:#333">拿地 -->展示区开放</ span>' as "description",
    case when takeLandDate is not null and exhibitionAreaOpenDate is not null then trunc(months_between(exhibitionAreaOpenDate,takeLandDate),1) else null end  as "realityDuration",
    case when takeLandDate is not null and exhibitionAreaOpenByPlan is not null then trunc(months_between(exhibitionAreaOpenByPlan,takeLandDate),1) else null end  as "planDuration",
    replace(Fn_DWM_DurationDaysDeal(exhibitionAreaOpenByPlan,exhibitionAreaOpenDate,'label'),'首开','') as "abstract",
     2 as sort
    from  dual  union
    select 
    '<span style="color:#FF0000;">*</ span><span style="font-weight: bold;color:#333">拿地 -->首期开盘</ span>' as "description",
    case when takeLandDate is not null and firstopendateValue is not null then trunc(months_between(firstopendateValue,takeLandDate),1) else null end  as "realityDuration",
    case when takeLandDate is not null and planfirstopendateValue is not null then trunc(months_between(planfirstopendateValue,takeLandDate),1) else null end  as "planDuration",
    replace(Fn_DWM_DurationDaysDeal(planfirstopendateValue,firstopendateValue,'label'),'首开','') as "abstract",
     3 as sort
    from  dual) tab order by tab.sort;
open nodeplanlist for    
select 
    nodeStartSales.node_name as "nodeName",
    nodeStartSales.node_level as "nodeType",
    to_char(nodeStartSales.plan_end_Date,'yyyy-mm-dd') as "planCompletionDate",
     to_char(nodeStartSales.actual_end_date,'yyyy-mm-dd') as "actualCompletionDate",
    case when nodeStartSales.actual_end_date is not null then '<div style="display:flex"><span style="display:inline-block;background-color:#33CC99;width:15px;height:15px;border-radius:50%" ></span><span  style="margin-left:2px">已完成</span></div>' else '' end  as "status",
     to_char(nodeStartSales.ESTIMATE_END_DATE,'yyyy-mm-dd') as "expectedCompletionDate"
    from SYS_PROJECT_STAGE ps 
    --join--计划
    left join POM_PROJ_PLAN plan on ps.id=plan.proj_id
    left join POM_PROJ_PLAN_NODE  nodeStartSales on plan.id=nodeStartSales.PROJ_PLAN_ID
    where ps.PROJECT_ID=projectId and ps.IS_FIRST_OPEN_PERIOD =1  and plan.PLAN_TYPE='关键节点计划' and plan.APPROVAL_STATUS='已审核'  and nodeStartSales.IS_DELETE<>1 and nodeStartSales.IS_DISABLE<>1 order by  nodeStartSales.plan_end_Date asc;
end P_DWM_detailDatak2;
/

prompt
prompt Creating procedure P_DWM_DETAILRINGCHART1K3K4K5
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_DetailRingChart1K3k4k5(projectId in varchar2,tabName in varchar2,ringTitle out clob,seriesDataName out varchar2,saleratebycount out sys_refcursor,saleratebyarea out sys_refcursor,saleratebymoney out sys_refcursor)
AS 
SALE_OUT_COUNT number(16,0):=0;
SALE_COUNT number(16,0):=0;
SALE_RATE_BY_COUNT number(16,4):=0;
SALE_OUT_AREA number(16,2):=0;
SALE_AREA number(16,2):=0;
SALE_RATE_BY_AREA number(16,4):=0;
SALE_OUT_MONEY number(16,2):=0;
SALE_MONEY number(16,2):=0;
SALE_RATE_BY_MONEY number(16,4):=0;
SURPLUS_SALE_MONEY number(16,2):=0;
typeName varchar2(500):='';
chartName varchar2(500):='';
rowcount number:=0;
begin
select count(1) into rowcount from DWM_SALE_RATE_BY_PROJECT where PROJECT_ID=projectId ;
if tabName='k1' then
ringTitle:='<span style="font-weight: bold;color: #333;">一、首开去化率</span><span style="color: #333;margin-left:10px;">注：首开的统计时间区间默认为“首次开盘后30天”。</span>';
typeName:='首开';
chartName:=typeName;
elsif  tabName='k3' then
ringTitle:='<span style="font-weight: bold;color: #333;">一、全案已取证去化率</span>';
typeName:='全案已取证';
chartName:='已取证';
elsif  tabName='k4' then
ringTitle:='<span style="font-weight: bold;color: #333;">一、现房去化率(%) </span><span style="color: #333;margin-left:10px;">注：现房指已竣备的可售资源。</span>';
typeName:='现房';
chartName:='现房';
elsif  tabName='k5' then
ringTitle:='<span style="font-weight: bold;color: #333;">一、顽固性库存去化率(%) </span><span style="color: #333;margin-left:10px;">注：顽固性库存指“本年1月1日前已竣备，且未实现签约”的可售资源。</span>';
typeName:='顽固性库存';
chartName:='共';
end if;
if tabName='k1' and rowcount <> 0 then
select FO_SALE_OUT_COUNT,
FO_SALE_COUNT,
FO_SALE_RATE_BY_COUNT,
FO_SALE_OUT_AREA,
FO_SALE_AREA,
FO_SALE_RATE_BY_AREA,
FO_SALE_OUT_MONEY,
FO_SALE_MONEY,
FO_SALE_RATE_BY_MONEY,
FO_SURPLUS_SALE_MONEY into  SALE_OUT_COUNT,SALE_COUNT,SALE_RATE_BY_COUNT ,SALE_OUT_AREA,SALE_AREA ,SALE_RATE_BY_AREA ,SALE_OUT_MONEY ,SALE_MONEY ,SALE_RATE_BY_MONEY ,SURPLUS_SALE_MONEY 
from DWM_SALE_RATE_BY_PROJECT where PROJECT_ID=projectId and rownum=1;
elsif tabName='k3' and rowcount <> 0 then
select PO_SALE_OUT_COUNT,
PO_SALE_COUNT,
PO_SALE_RATE_BY_COUNT,
PO_SALE_OUT_AREA,
PO_SALE_AREA,
PO_SALE_RATE_BY_AREA,
PO_SALE_OUT_MONEY,
PO_SALE_MONEY,
PO_SALE_RATE_BY_MONEY,
PO_SURPLUS_SALE_MONEY into  SALE_OUT_COUNT,SALE_COUNT,SALE_RATE_BY_COUNT ,SALE_OUT_AREA,SALE_AREA ,SALE_RATE_BY_AREA ,SALE_OUT_MONEY ,SALE_MONEY ,SALE_RATE_BY_MONEY ,SURPLUS_SALE_MONEY 
from DWM_SALE_RATE_BY_PROJECT where PROJECT_ID=projectId and rownum=1;
elsif tabName='k4' and rowcount <> 0 then
select EH_SALE_OUT_COUNT,
EH_SALE_COUNT,
EH_SALE_RATE_BY_COUNT,
EH_SALE_OUT_AREA,
EH_SALE_AREA,
EH_SALE_RATE_BY_AREA,
EH_SALE_OUT_MONEY,
EH_SALE_MONEY,
EH_SALE_RATE_BY_MONEY,
EH_SURPLUS_SALE_MONEY into  SALE_OUT_COUNT,SALE_COUNT,SALE_RATE_BY_COUNT ,SALE_OUT_AREA,SALE_AREA ,SALE_RATE_BY_AREA ,SALE_OUT_MONEY ,SALE_MONEY ,SALE_RATE_BY_MONEY ,SURPLUS_SALE_MONEY 
from DWM_SALE_RATE_BY_PROJECT where PROJECT_ID=projectId and rownum=1;
elsif tabName='k5' and rowcount <> 0 then
select SI_SALE_OUT_COUNT,
SI_SALE_COUNT,
SI_SALE_RATE_BY_COUNT,
SI_SALE_OUT_AREA,
SI_SALE_AREA,
SI_SALE_RATE_BY_AREA,
SI_SALE_OUT_MONEY,
SI_SALE_MONEY,
SI_SALE_RATE_BY_MONEY,
SI_SURPLUS_SALE_MONEY into  SALE_OUT_COUNT,SALE_COUNT,SALE_RATE_BY_COUNT ,SALE_OUT_AREA,SALE_AREA ,SALE_RATE_BY_AREA ,SALE_OUT_MONEY ,SALE_MONEY ,SALE_RATE_BY_MONEY ,SURPLUS_SALE_MONEY 
from DWM_SALE_RATE_BY_PROJECT where PROJECT_ID=projectId and rownum=1;
end if;
seriesDataName:='已签约,未签约';
open saleratebycount for
select 
typeName||'去化率（按套数）' as "chartTitle",
'' as "chartDescription",
fn_ConvertDecimalToPercentage(SALE_RATE_BY_COUNT) as "centerTitle",
chartName||to_char(SALE_COUNT)||'套' as "centerDescription",
to_char(SALE_OUT_COUNT)||','||to_char(SALE_COUNT-SALE_OUT_COUNT) as "seriesdata",
'套' "unit",
1 as sort
from  dual;

open saleratebymoney for
select 
typeName||'去化率（按货值）' as "chartTitle",
'（货值单位：亿）' as "chartDescription",
fn_ConvertDecimalToPercentage(SALE_RATE_BY_MONEY) as "centerTitle",
chartName||FN_DWN_AmountToBillionYuan(SALE_MONEY) as "centerDescription",
FN_DWM_MULTIPLE_AND_UNIT(SALE_OUT_MONEY,100000000,'')||','||FN_DWM_MULTIPLE_AND_UNIT(SURPLUS_SALE_MONEY,100000000,'') as "seriesdata",
'亿' "unit",
2  as sort
from  dual;
open saleratebyarea for
select 
typeName||'去化率（按面积）' as "chartTitle",
'（面积单位：万方）' as "chartDescription",
fn_ConvertDecimalToPercentage(SALE_RATE_BY_AREA) as "centerTitle",
chartName||FN_DWN_AreaTo1000Square(SALE_AREA) as "centerDescription",
FN_DWM_MULTIPLE_AND_UNIT(SALE_OUT_AREA,10000,'')||','||FN_DWM_MULTIPLE_AND_UNIT(trunc(SALE_AREA-SALE_OUT_AREA,2),10000,'') as "seriesdata",
 '万方' "unit",
3 as sort
from  dual;
EXCEPTION
WHEN OTHERS THEN
  CLOSE saleratebyarea;
   CLOSE saleratebycount;
    CLOSE saleratebymoney;
END P_DWM_DetailRingChart1K3k4k5;
/

prompt
prompt Creating procedure P_DWM_DETAILSALERATEKLIST
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_DetailSaleRatekList(projectId in varchar2,tabName in varchar2,isShowAreaSection in number,listTitle out varchar2 ,tableData out sys_refcursor)
AS 
v_sql clob:='';
begin
if tabName='k1' then
listTitle:='<span style="font-weight: bold;color: #333;">二、首开去化明细情况（项目-->业态-->面积段）</span>';
v_sql:=
'SELECT
   dwm_sale_rate_by_project.PROJECT_ID as "id",
   FN_DWM_FONT_COLOR(dwm_sale_rate_project.PROJECT_NAME) as "typeName",
    fo_sale_out_count||''套'' as "saleOutCount",
    fo_sale_count||''套'' as "saleCount",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(fo_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(fo_sale_area) as "saleArea",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo_sale_rate_by_area))  as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(fo_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(fo_sale_money) as "saleMoney",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo_sale_rate_by_money))  as "saleRateByMoney",
    fo_sale_average_money as "standardPrice",
    fo_sale_out_average_money as "signPrice",
    '''' as "parentId",
    0 as "isAreaSection",
    0 as Sort
FROM
    dwm_sale_rate_by_project left join dwm_sale_rate_project on dwm_sale_rate_by_project.PROJECT_ID = dwm_sale_rate_project.PROJECT_ID where  rownum=1 and dwm_sale_rate_by_project.PROJECT_ID='''||projectId||'''
    union 
    SELECT
    id as "id",
    FN_DWM_FONT_COLOR(DATA_GRANULARITY) as "typeName",
    fo_sale_out_count||''套'' as "saleOutCount",
    fo_sale_count||''套'' as "saleCount",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(fo_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(fo_sale_area) as "saleArea",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo_sale_rate_by_area))  as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(fo_sale_out_money)  as "saleOutMoney",
   FN_DWN_AmountToBillionYuan( fo_sale_money) as "saleMoney",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(fo_sale_rate_by_money))  as "saleRateByMoney",
    fo_sale_average_money as "standardPrice",
    fo_sale_out_average_money as "signPrice",
    case when PARENT_ID is null then PROJECT_ID  else PARENT_ID end as "parentId",
    case when PARENT_ID is null then 0 else 1 end as "isAreaSection",
    Sort
FROM
    DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID='''||projectId||''' ' ;
    elsif  tabName='k3' then
    listTitle:='<span style="font-weight: bold;color: #333;">三、全案已取证货值去化明细表</span>';
v_sql:=
'SELECT
   dwm_sale_rate_by_project.PROJECT_ID as "id",
   FN_DWM_FONT_COLOR(dwm_sale_rate_project.PROJECT_NAME) as "typeName",
    po_sale_out_count||''套'' as "saleOutCount",
    po_sale_count||''套'' as "saleCount",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(po_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(po_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(po_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(po_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(po_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(po_sale_money) as "saleMoney",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(po_sale_rate_by_money))  as "saleRateByMoney",
    po_sale_average_money as "standardPrice",
    po_sale_out_average_money as "signPrice",
    '''' as "parentId",
    0 as "isAreaSection",
    0 as Sort
FROM
    dwm_sale_rate_by_project left join dwm_sale_rate_project on dwm_sale_rate_by_project.PROJECT_ID = dwm_sale_rate_project.PROJECT_ID where  rownum=1 and  dwm_sale_rate_by_project.PROJECT_ID='''||projectId||'''
    union 
    SELECT
    id as "id",
     FN_DWM_FONT_COLOR(DATA_GRANULARITY) as "typeName",
    po_sale_out_count||''套'' as "saleOutCount",
    po_sale_count||''套'' as "saleCount",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(po_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(po_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(po_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(po_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(po_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(po_sale_money) as "saleMoney",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(po_sale_rate_by_money))  as "saleRateByMoney",
    po_sale_average_money as "standardPrice",
    po_sale_out_average_money as "signPrice",
    case when PARENT_ID is null then PROJECT_ID  else PARENT_ID end as "parentId",
    case when PARENT_ID is null then 0 else 1 end as "isAreaSection",
    sort
FROM
    DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID='''||projectId||''' ' ;
     elsif  tabName='k4' then
    listTitle:='<span style="font-weight: bold;color: #333;">三、现房去化明细表</span>';
v_sql:=
'SELECT
   dwm_sale_rate_by_project.PROJECT_ID as "id",
   FN_DWM_FONT_COLOR(dwm_sale_rate_project.PROJECT_NAME) as "typeName",
    EH_sale_out_count||''套'' as "saleOutCount",
    EH_sale_count||''套'' as "saleCount",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(EH_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(EH_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(EH_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(EH_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(EH_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(EH_sale_money) as "saleMoney",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(EH_sale_rate_by_money))  as "saleRateByMoney",
    EH_sale_average_money as "standardPrice",
    EH_sale_out_average_money as "signPrice",
    '''' as "parentId",
    0 as "isAreaSection",
    0 as sort
FROM
    dwm_sale_rate_by_project left join dwm_sale_rate_project on dwm_sale_rate_by_project.PROJECT_ID = dwm_sale_rate_project.PROJECT_ID where  rownum=1 and  dwm_sale_rate_by_project.PROJECT_ID='''||projectId||'''
    union 
    SELECT
    id as "id",
     FN_DWM_FONT_COLOR(DATA_GRANULARITY) as "typeName",
    EH_sale_out_count||''套'' as "saleOutCount",
    EH_sale_count||''套'' as "saleCount",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(EH_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(EH_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(EH_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(EH_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(EH_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(EH_sale_money) as "saleMoney",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(EH_sale_rate_by_money))  as "saleRateByMoney",
    EH_sale_average_money as "standardPrice",
    EH_sale_out_average_money as "signPrice",
    case when PARENT_ID is null then PROJECT_ID  else PARENT_ID end as "parentId",
    case when PARENT_ID is null then 0 else 1 end as "isAreaSection",
    sort
FROM
    DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID='''||projectId||''' ' ;
elsif  tabName='k5' then
    listTitle:='<span style="font-weight: bold;color: #333;">三、已竣备货值去化明细表</span>';
v_sql:=
'SELECT
   dwm_sale_rate_by_project.PROJECT_ID as "id",
   FN_DWM_FONT_COLOR(dwm_sale_rate_project.PROJECT_NAME) as "typeName",
   SI_sale_out_count||''套'' as "saleOutCount",
   SI_sale_count||''套'' as "saleCount",
   FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(SI_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(SI_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(SI_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(SI_sale_money) as "saleMoney",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_money))  as "saleRateByMoney",
    SI_sale_average_money as "standardPrice",
    SI_sale_out_average_money as "signPrice",
    '''' as "parentId",
    0 as "isAreaSection",
    0 as sort
FROM
    dwm_sale_rate_by_project left join dwm_sale_rate_project on dwm_sale_rate_by_project.PROJECT_ID = dwm_sale_rate_project.PROJECT_ID where  rownum=1 and  dwm_sale_rate_by_project.PROJECT_ID='''||projectId||'''
    union 
    SELECT
    id as "id",
    FN_DWM_FONT_COLOR(DATA_GRANULARITY) as "typeName",
    SI_sale_out_count||''套'' as "saleOutCount",
    SI_sale_count||''套'' as "saleCount",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(SI_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(SI_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(SI_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(SI_sale_money) as "saleMoney",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_money))  as "saleRateByMoney",
    SI_sale_average_money as "standardPrice",
    SI_sale_out_average_money as "signPrice",
    case when PARENT_ID is null then PROJECT_ID  else PARENT_ID end as "parentId",
    case when PARENT_ID is null then 0 else 1 end as "isAreaSection",
    Sort
FROM
    DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID='''||projectId||''' and  DATA_GRANULARITY <> ''住宅''   and PARENT_ID is null
    union 
    SELECT
    id as "id",
    FN_DWM_FONT_COLOR(DATA_GRANULARITY) as "typeName",
    SI_sale_out_count||''套'' as "saleOutCount",
    SI_sale_count||''套'' as "saleCount",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_count)) as "saleRateByCount",
    FN_DWN_AreaTo1000Square(SI_sale_out_area)  as "saleOutArea",
    FN_DWN_AreaTo1000Square(SI_sale_area) as "saleArea",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_area)) as "saleRateByArea",
    FN_DWN_AmountToBillionYuan(SI_sale_out_money)  as "saleOutMoney",
    FN_DWN_AmountToBillionYuan(SI_sale_money) as "saleMoney",
    FN_DWM_FONT_COLOR(fn_ConvertDecimalToPercentage(SI_sale_rate_by_money))  as "saleRateByMoney",
    SI_sale_average_money as "standardPrice",
    SI_sale_out_average_money as "signPrice",
    case when PARENT_ID is null then PROJECT_ID  else PARENT_ID end as "parentId",
    case when PARENT_ID is null then 0 else 1 end as "isAreaSection",
    Sort
FROM
    DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID='''||projectId||''' and  PARENT_ID is not null and
    PARENT_ID not in (select Id from DWM_SALE_RATE_BY_GRANULARITY where PROJECT_ID='''||projectId||''' and DATA_GRANULARITY = ''住宅'' )' ;
end if;
        dbms_output.put_line(v_sql);
    if isShowAreaSection = 0 then
         v_sql:='select * from ('||v_sql||') tab where tab."isAreaSection" = 0 order by sort';
         else
         v_sql:='select * from ('||v_sql||') tab  order by sort';
    end if;
OPEN tableData FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE tableData;
END P_DWM_DetailSaleRatekList;
/

prompt
prompt Creating procedure P_DWM_DT_AREA_DTL
prompt ====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_dwm_dt_area_dtl (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    projectid      IN             VARCHAR2, --选择公司id
    tabsindex      IN             VARCHAR2, --选择选项卡。1开始
    isoperate      IN             VARCHAR2,--是否操盘
    info           OUT            SYS_REFCURSOR
) AS
--动态货量管理-全案动态货量-穿透详情
--作者：陈丽
--日期：2019/12/17
    data_auth_spid   VARCHAR2(200);
    bizcode          VARCHAR2(200);
BEGIN
    IF tabsindex = 1 THEN
        dbms_output.put_line('所有业态!');
    ELSIF tabsindex = 2 THEN
        dbms_output.put_line('住宅及商办!');
    ELSIF tabsindex = 3 THEN
        dbms_output.put_line('住宅!');
    ELSIF tabsindex = 4 THEN
        dbms_output.put_line('商办!');
    ELSIF tabsindex = 5 THEN
        dbms_output.put_line('车位!');
    ELSe--IF tabsindex = 6 THEN
        dbms_output.put_line('剩余货量表!');
        OPEN info FOR SELECT
                          a.id             AS "id",--主键id（生成树的id，唯一可以是业务id）
                          level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '' || project_name
                              WHEN level = 2 THEN
                                  '        ' || project_name
                              WHEN level = 3 THEN
                                  '                ' || project_name
                              WHEN level = 4 THEN
                                  '                        ' || project_name
                              ELSE
                                  '                                ' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          a.parent_id      AS "parentId",--父级id（生成树父级id）
                          a.project_name   AS "orgName",--项目/分期/业态/楼栋
                            NVL(b.ZZ_area_remain,0) AS "projWholeDwellingArea",--项目全案剩余可售货量（S=A+B+C+D）-住宅(m2)
                            NVL( b.SY_area_remain,0) AS "projWholeBusinessArea",--项目全案剩余可售货量（S=A+B+C+D）-商业(m2)
                            NVL( b.CW_area_remain,0) AS "projWholeCarport",--项目全案剩余可售货量（S=A+B+C+D）-车位(个)
                            NVL(b.area_remain,0) AS "projWholeTotalArea",--项目全案剩余可售货量（S=A+B+C+D）-合计(m2)
                            NVL( b.zz_area_not_planning_permit,0) AS "ADwellingArea",--A未取规证的可售货量-住宅(m2)
                            NVL( b.sy_area_not_planning_permit,0) AS "ABusinessArea",--A未取规证的可售货量-商业(m2)
                            NVL( b.CW_Area_not_planning_permit,0) AS "ACarport",--A未取规证的可售货量-车位(个)
                            NVL( b.Area_not_planning_permit,0) AS "ATotalArea",--A未取规证的可售货量-合计(m2)
                            NVL(b.zz_area_not_construction_per,0) AS "BDwellingArea",--B已取规证未取施工证的可售货量-住宅(m2)
                            NVL(b.SY_area_not_construction_per,0) AS "BBusinessArea",--B已取规证未取施工证的可售货量-商业(m2)
                            NVL(b.CW_area_not_construction_per,0) AS "BCarport",--B已取规证未取施工证的可售货量-车位(个)
                            NVL(b.area_not_construction_permit,0) AS "BTotalArea",--B已取规证未取施工证的可售货量-合计(m2)
                            NVL(b.zz_area_not_sale_permit,0) as "CDwellingArea",--C已取规证未取预售证的可售货量-住宅(m2)
                            NVL(b.SY_area_not_sale_permit,0) AS "CBusinessArea",--C已取规证未取预售证的可售货量-商业(m2)
                            NVL(b.CW_area_not_sale_permit,0) AS "CCarport",--C已取规证未取预售证的可售货量-车位(个)
                            NVL(b.area_not_sale_permit,0) AS "CTotalArea",--C已取规证未取预售证的可售货量-合计(m2)
                            NVL(b.zz_area_stock,0) AS "DDwellingArea",--D已取预售证未售的可售货量-住宅(m2)
                            NVL(b.SY_area_stock,0) AS "DBusinessArea",--D已取预售证未售的可售货量-商业(m2)
                            NVL(b.CW_area_stock,0) AS "DCarport",--D已取预售证未售的可售货量-车位(个)
                            NVL(b.area_Stock,0) AS "DTotalArea"--D已取预售证未售的可售货量-合计(m2)
                      FROM
                          (
                              SELECT
                                  id,
                                  project_name,
                                  '' AS parent_id,
                                  sn AS order_code
                              FROM
                                  sys_project
                              WHERE
                                  id = ''
                                       || projectid
                                       || ''
                              UNION ALL
--分期
                              SELECT
                                  id,
                                  stage_name,
                                  project_id AS parent_id,
                                  lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  sys_project_stage
                              WHERE
                                  project_id = ''
                                               || projectid
                                               || ''
                                  AND stage_name <> '无分期'
                              UNION ALL
--楼栋
                              SELECT
                                  mdm_build.id,
                                  build_name,
                                  (
                                      CASE
                                          WHEN mdm_period.period_name <> '无分期' THEN
                                              period_id
                                          ELSE
                                              mdm_build.proj_id
                                      END
                                  ) AS parent_id,
                                  lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  mdm_build left
                                  JOIN mdm_period ON mdm_build.period_id = mdm_period.id
                              WHERE
                                  proj_id = ''
                                            || projectid
                                            || ''
                                  AND build_state = 10--10已发布楼栋
                          ) a LEFT JOIN dwm_dt_value   b ON a.id = b.obj_id
                      START WITH
                          a.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR a.id = a.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(a.order_code, ','), 2);

    END IF;

    IF tabsindex = 1 THEN--OR tabsindex = 2-- OR tabsindex = 3 OR tabsindex = 4 OR tabsindex = 5 THEN
        OPEN info FOR SELECT
                          a.id             AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id      AS "parentId",--父级id（生成树父级id）
                          project_name   AS "orgName",--项目/分期/业态/楼栋
                          level,
                          level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '1' || project_name
                              WHEN level = 2 THEN
                                  '        2' || project_name
                              WHEN level = 3 THEN
                                  '                3' || project_name
                              WHEN level = 4 THEN
                                  '                        4' || project_name
                              ELSE
                                  '                                5' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          TO_CHAR(NVL(b.area_dt_all,0), '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR(NVL(b.area_dt_all,0), '999,999,999,999,990.00') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR(NVL(b.area_dt_all,0), '999,999,999,999,990.00') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR(NVL(b.area_reserve,0), '999,999,999,999,990.00') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR(NVL(b.area_in_process,0), '999,999,999,999,990.00') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR(NVL(b.area_stock,0), '999,999,999,999,990.00') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR(NVL(b.area_haved_sale,0), '999,999,999,999,990.00') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR(NVL(b.area_remain,0), '999,999,999,999,990.00') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR(NVL(b.area_allow_sale,0), '999,999,999,999,990.00') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                            CASE
                                WHEN ( b.Area_stock + b.area_haved_sale ) = 0 THEN
                                    '-'
                                ELSE
                                    TO_CHAR(NVL(b.area_haved_sale /(b.area_stock + b.area_haved_sale) * 100,0), '999,999,999,999,990.00'
                                    )
                                    || '%'
                            END
                        )  AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(NVL(b.area_not_planning_permit,0), '999,999,999,999,990.00') AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(NVL(b.area_not_construction_permit,0), '999,999,999,999,990.00') AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(NVL(b.area_not_sale_permit,0), '999,999,999,999,990.00') AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(NVL(b.area_not_completion,0), '999,999,999,999,990.00') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(NVL(b.area_yes_completion,0), '999,999,999,999,990.00') AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(NVL(b.area_yes_settlement,0), '999,999,999,999,990.00') AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR(NVL(b.area_dt_all,0), '999,999,999,999,990.00') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR(NVL(b.cw_area_reserve,0), '999,999,999,999,990.00') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR(NVL(b.cw_area_in_process,0), '999,999,999,999,990.00') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR(NVL(b.cw_area_stock,0), '999,999,999,999,990.00') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR(NVL(b.cw_area_haved_sale,0), '999,999,999,999,990.00') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR(NVL(b.cw_area_not_planning_permit,0), '999,999,999,999,990.00') AS "carportNoPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(NVL(b.cw_area_not_construction_per,0), '999,999,999,999,990.00') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(NVL(b.cw_area_not_sale_permit,0), '999,999,999,999,990.00') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(NVL(b.cw_area_not_completion,0), '999,999,999,999,990.00') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(NVL(b.cw_value_yes_completion,0), '999,999,999,999,990.00') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(NVL(b.cw_area_yes_settlement,0), '999,999,999,999,990.00') AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM
                          (
                              SELECT
                                  id,
                                  project_name,
                                  '' AS parent_id,
                                  sn AS order_code
                              FROM
                                  sys_project
                              WHERE
                                  id = ''
                                       || projectid
                                       || ''
                              UNION ALL
--分期
                              SELECT
                                  id,
                                  stage_name,
                                  project_id AS parent_id,
                                  lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  sys_project_stage
                              WHERE
                                  project_id = ''
                                               || projectid
                                               || ''
                                  AND stage_name <> '无分期'
                              UNION ALL
--楼栋
                              SELECT
                                  mdm_build.id,
                                  build_name,
                                  (
                                      CASE
                                          WHEN mdm_period.period_name <> '无分期' THEN
                                              period_id
                                          ELSE
                                              mdm_build.proj_id
                                      END
                                  ) AS parent_id,
                                  lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  mdm_build left
                                  JOIN mdm_period ON mdm_build.period_id = mdm_period.id
                              WHERE
                                  proj_id = ''
                                            || projectid
                                            || ''
                                  AND build_state = 10--10已发布楼栋
                          ) a LEFT JOIN dwm_dt_value  b ON a.id= b.obj_id
                      START WITH
                          a.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR a.id = a.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(a.order_code, ','), 2);

    END IF;
    
       IF tabsindex = 2 THEN--OR tabsindex = 4 OR tabsindex = 5 THEN
        OPEN info FOR SELECT
                          a.id             AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id      AS "parentId",--父级id（生成树父级id）
                          project_name   AS "orgName",--项目/分期/业态/楼栋
                          level,
                          level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '1' || project_name
                              WHEN level = 2 THEN
                                  '        2' || project_name
                              WHEN level = 3 THEN
                                  '                3' || project_name
                              WHEN level = 4 THEN
                                  '                        4' || project_name
                              ELSE
                                  '                                5' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          TO_CHAR(NVL(b.ZZ_area_dt_all+b.SY_area_dt_all,0), '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR(NVL(b.ZZ_area_dt_all+b.SY_area_dt_all,0), '999,999,999,999,990.00') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR(NVL(b.ZZ_area_dt_all+b.SY_area_dt_all,0), '999,999,999,999,990.00') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR(NVL(b.zz_area_reserve+b.SY_area_reserve,0), '999,999,999,999,990.00') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR(NVL(b.ZZ_area_in_process+b.SY_area_in_process,0), '999,999,999,999,990.00') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR(NVL(b.ZZ_area_stock+ b.sy_Area_stock,0), '999,999,999,999,990.00') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR(NVL(b.ZZ_area_haved_sale+b.sy_area_haved_sale,0), '999,999,999,999,990.00') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR(NVL(b.ZZ_area_remain+b.sy_area_remain,0), '999,999,999,999,990.00') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR(NVL(b.ZZ_area_allow_sale+b.SY_area_allow_sale,0), '999,999,999,999,990.00') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                            CASE
                                WHEN ( b.ZZ_Area_stock + b.ZZ_area_haved_sale +b.SY_Area_stock + b.SY_area_haved_sale ) = 0 THEN
                                    '-'
                                ELSE
                                    TO_CHAR(NVL((b.ZZ_area_haved_sale +b.SY_area_haved_sale)/( b.ZZ_Area_stock + b.ZZ_area_haved_sale +b.SY_Area_stock + b.SY_area_haved_sale) * 100,0), '999,999,999,999,990.00'
                                    )
                                    || '%'
                            END
                        )  AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(NVL(b.ZZ_area_not_planning_permit+b.SY_area_not_planning_permit,0), '999,999,999,999,990.00') AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(NVL(b.ZZ_area_not_construction_per+b.SY_area_not_construction_per,0), '999,999,999,999,990.00') AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(NVL(b.ZZ_area_not_sale_permit+b.SY_area_not_sale_permit,0), '999,999,999,999,990.00') AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(NVL(b.ZZ_area_not_completion+b.SY_area_not_completion,0), '999,999,999,999,990.00') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(NVL(b.ZZ_area_yes_completion+b.SY_area_yes_completion,0), '999,999,999,999,990.00') AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(NVL(b.ZZ_area_yes_settlement+b.SY_area_yes_settlement,0), '999,999,999,999,990.00') AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR(NVL(b.CW_area_dt_all,0), '999,999,999,999,990.00') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR(NVL(b.cw_area_reserve,0), '999,999,999,999,990.00') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR(NVL(b.cw_area_in_process,0), '999,999,999,999,990.00') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR(NVL(b.cw_area_stock,0), '999,999,999,999,990.00') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR(NVL(b.cw_area_haved_sale,0), '999,999,999,999,990.00') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR(NVL(b.cw_area_not_planning_permit,0), '999,999,999,999,990.00') AS "carportNoPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(NVL(b.cw_area_not_construction_per,0), '999,999,999,999,990.00') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(NVL(b.cw_area_not_sale_permit,0), '999,999,999,999,990.00') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(NVL(b.cw_area_not_completion,0), '999,999,999,999,990.00') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(NVL(b.cw_value_yes_completion,0), '999,999,999,999,990.00') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(NVL(b.cw_area_yes_settlement,0), '999,999,999,999,990.00') AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM
                          (
                              SELECT
                                  id,
                                  project_name,
                                  '' AS parent_id,
                                  sn AS order_code
                              FROM
                                  sys_project
                              WHERE
                                  id = ''
                                       || projectid
                                       || ''
                              UNION ALL
--分期
                              SELECT
                                  id,
                                  stage_name,
                                  project_id AS parent_id,
                                  lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  sys_project_stage
                              WHERE
                                  project_id = ''
                                               || projectid
                                               || ''
                                  AND stage_name <> '无分期'
                              UNION ALL
--楼栋
                              SELECT
                                  mdm_build.id,
                                  build_name,
                                  (
                                      CASE
                                          WHEN mdm_period.period_name <> '无分期' THEN
                                              period_id
                                          ELSE
                                              mdm_build.proj_id
                                      END
                                  ) AS parent_id,
                                  lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  mdm_build left
                                  JOIN mdm_period ON mdm_build.period_id = mdm_period.id
                              WHERE
                                  proj_id = ''
                                            || projectid
                                            || ''
                                  AND build_state = 10--10已发布楼栋
                          ) a LEFT JOIN dwm_dt_value  b ON a.id= b.obj_id
                      START WITH
                          a.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR a.id = a.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(a.order_code, ','), 2);

    END IF;
    
    IF tabsindex = 3 THEN--OR tabsindex = 4 OR tabsindex = 5 THEN
        OPEN info FOR SELECT
                          a.id             AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id      AS "parentId",--父级id（生成树父级id）
                          project_name   AS "orgName",--项目/分期/业态/楼栋
                          level,
                          level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '1' || project_name
                              WHEN level = 2 THEN
                                  '        2' || project_name
                              WHEN level = 3 THEN
                                  '                3' || project_name
                              WHEN level = 4 THEN
                                  '                        4' || project_name
                              ELSE
                                  '                                5' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          TO_CHAR(NVL(b.ZZ_area_dt_all,0), '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR(NVL(b.ZZ_area_dt_all,0), '999,999,999,999,990.00') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR(NVL(b.ZZ_area_dt_all,0), '999,999,999,999,990.00') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR(NVL(b.ZZ_area_reserve,0), '999,999,999,999,990.00') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR(NVL(b.ZZ_area_in_process,0), '999,999,999,999,990.00') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR(NVL(b.ZZ_area_stock,0), '999,999,999,999,990.00') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR(NVL(b.ZZ_area_haved_sale,0), '999,999,999,999,990.00') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR(NVL(b.ZZ_area_remain,0), '999,999,999,999,990.00') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR(NVL(b.ZZ_area_allow_sale,0), '999,999,999,999,990.00') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                            CASE
                                WHEN ( b.ZZ_Area_stock + b.ZZ_area_haved_sale ) = 0 THEN
                                    '-'
                                ELSE
                                    TO_CHAR(NVL(b.ZZ_area_haved_sale /(b.ZZ_area_stock + b.ZZ_area_haved_sale) * 100,0), '999,999,999,999,990.00'
                                    )
                                    || '%'
                            END
                        )  AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(NVL(b.ZZ_area_not_planning_permit,0), '999,999,999,999,990.00') AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(NVL(b.ZZ_area_not_construction_per,0), '999,999,999,999,990.00') AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(NVL(b.ZZ_area_not_sale_permit,0), '999,999,999,999,990.00') AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(NVL(b.ZZ_area_not_completion,0), '999,999,999,999,990.00') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(NVL(b.ZZ_area_yes_completion,0), '999,999,999,999,990.00') AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(NVL(b.ZZ_area_yes_settlement,0), '999,999,999,999,990.00') AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR(NVL(b.ZZ_area_dt_all,0), '999,999,999,999,990.00') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR(NVL(b.cw_area_reserve,0), '999,999,999,999,990.00') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR(NVL(b.cw_area_in_process,0), '999,999,999,999,990.00') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR(NVL(b.cw_area_stock,0), '999,999,999,999,990.00') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR(NVL(b.cw_area_haved_sale,0), '999,999,999,999,990.00') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR(NVL(b.cw_area_not_planning_permit,0), '999,999,999,999,990.00') AS "carportNoPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(NVL(b.cw_area_not_construction_per,0), '999,999,999,999,990.00') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(NVL(b.cw_area_not_sale_permit,0), '999,999,999,999,990.00') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(NVL(b.cw_area_not_completion,0), '999,999,999,999,990.00') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(NVL(b.cw_value_yes_completion,0), '999,999,999,999,990.00') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(NVL(b.cw_area_yes_settlement,0), '999,999,999,999,990.00') AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM
                          (
                              SELECT
                                  id,
                                  project_name,
                                  '' AS parent_id,
                                  sn AS order_code
                              FROM
                                  sys_project
                              WHERE
                                  id = ''
                                       || projectid
                                       || ''
                              UNION ALL
--分期
                              SELECT
                                  id,
                                  stage_name,
                                  project_id AS parent_id,
                                  lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  sys_project_stage
                              WHERE
                                  project_id = ''
                                               || projectid
                                               || ''
                                  AND stage_name <> '无分期'
                              UNION ALL
--楼栋
                              SELECT
                                  mdm_build.id,
                                  build_name,
                                  (
                                      CASE
                                          WHEN mdm_period.period_name <> '无分期' THEN
                                              period_id
                                          ELSE
                                              mdm_build.proj_id
                                      END
                                  ) AS parent_id,
                                  lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  mdm_build left
                                  JOIN mdm_period ON mdm_build.period_id = mdm_period.id
                              WHERE
                                  proj_id = ''
                                            || projectid
                                            || ''
                                  AND build_state = 10--10已发布楼栋
                          ) a LEFT JOIN dwm_dt_value  b ON a.id= b.obj_id
                      START WITH
                          a.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR a.id = a.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(a.order_code, ','), 2);

    END IF;
    
       IF tabsindex = 4 THEN--OR tabsindex = 4 OR tabsindex = 5 THEN
        OPEN info FOR SELECT
                          a.id             AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id      AS "parentId",--父级id（生成树父级id）
                          project_name   AS "orgName",--项目/分期/业态/楼栋
                          level,
                          level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '1' || project_name
                              WHEN level = 2 THEN
                                  '        2' || project_name
                              WHEN level = 3 THEN
                                  '                3' || project_name
                              WHEN level = 4 THEN
                                  '                        4' || project_name
                              ELSE
                                  '                                5' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          TO_CHAR(NVL(b.SY_area_dt_all,0), '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR(NVL(b.SY_area_dt_all,0), '999,999,999,999,990.00') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR(NVL(b.SY_area_dt_all,0), '999,999,999,999,990.00') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR(NVL(b.SY_area_reserve,0), '999,999,999,999,990.00') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR(NVL(b.SY_area_in_process,0), '999,999,999,999,990.00') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR(NVL(b.SY_area_stock,0), '999,999,999,999,990.00') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR(NVL(b.SY_area_haved_sale,0), '999,999,999,999,990.00') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR(NVL(b.SY_area_remain,0), '999,999,999,999,990.00') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR(NVL(b.SY_area_allow_sale,0), '999,999,999,999,990.00') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                            CASE
                                WHEN ( b.SY_Area_stock + b.SY_area_haved_sale ) = 0 THEN
                                    '-'
                                ELSE
                                    TO_CHAR(NVL(b.SY_area_haved_sale /(b.SY_area_stock + b.SY_area_haved_sale) * 100,0), '999,999,999,999,990.00'
                                    )
                                    || '%'
                            END
                        )  AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(NVL(b.SY_area_not_planning_permit,0), '999,999,999,999,990.00') AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(NVL(b.SY_area_not_construction_per,0), '999,999,999,999,990.00') AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(NVL(b.SY_area_not_sale_permit,0), '999,999,999,999,990.00') AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(NVL(b.SY_area_not_completion,0), '999,999,999,999,990.00') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(NVL(b.SY_area_yes_completion,0), '999,999,999,999,990.00') AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(NVL(b.SY_area_yes_settlement,0), '999,999,999,999,990.00') AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR(NVL(b.CW_area_dt_all,0), '999,999,999,999,990.00') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR(NVL(b.cw_area_reserve,0), '999,999,999,999,990.00') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR(NVL(b.cw_area_in_process,0), '999,999,999,999,990.00') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR(NVL(b.cw_area_stock,0), '999,999,999,999,990.00') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR(NVL(b.cw_area_haved_sale,0), '999,999,999,999,990.00') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR(NVL(b.cw_area_not_planning_permit,0), '999,999,999,999,990.00') AS "carportNoPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(NVL(b.cw_area_not_construction_per,0), '999,999,999,999,990.00') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(NVL(b.cw_area_not_sale_permit,0), '999,999,999,999,990.00') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(NVL(b.cw_area_not_completion,0), '999,999,999,999,990.00') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(NVL(b.cw_value_yes_completion,0), '999,999,999,999,990.00') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(NVL(b.cw_area_yes_settlement,0), '999,999,999,999,990.00') AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM
                          (
                              SELECT
                                  id,
                                  project_name,
                                  '' AS parent_id,
                                  sn AS order_code
                              FROM
                                  sys_project
                              WHERE
                                  id = ''
                                       || projectid
                                       || ''
                              UNION ALL
--分期
                              SELECT
                                  id,
                                  stage_name,
                                  project_id AS parent_id,
                                  lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  sys_project_stage
                              WHERE
                                  project_id = ''
                                               || projectid
                                               || ''
                                  AND stage_name <> '无分期'
                              UNION ALL
--楼栋
                              SELECT
                                  mdm_build.id,
                                  build_name,
                                  (
                                      CASE
                                          WHEN mdm_period.period_name <> '无分期' THEN
                                              period_id
                                          ELSE
                                              mdm_build.proj_id
                                      END
                                  ) AS parent_id,
                                  lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  mdm_build left
                                  JOIN mdm_period ON mdm_build.period_id = mdm_period.id
                              WHERE
                                  proj_id = ''
                                            || projectid
                                            || ''
                                  AND build_state = 10--10已发布楼栋
                          ) a LEFT JOIN dwm_dt_value  b ON a.id= b.obj_id
                      START WITH
                          a.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR a.id = a.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(a.order_code, ','), 2);

    END IF;
    
       IF tabsindex = 5 THEN--OR tabsindex = 4 OR tabsindex = 5 THEN
        OPEN info FOR SELECT
                          a.id             AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id      AS "parentId",--父级id（生成树父级id）
                          project_name   AS "orgName",--项目/分期/业态/楼栋
                          level,
                          level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '1' || project_name
                              WHEN level = 2 THEN
                                  '        2' || project_name
                              WHEN level = 3 THEN
                                  '                3' || project_name
                              WHEN level = 4 THEN
                                  '                        4' || project_name
                              ELSE
                                  '                                5' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          TO_CHAR(NVL(b.CW_area_dt_all,0), '999,999,999,999,999') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR(NVL(b.CW_area_dt_all,0), '999,999,999,999,999') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR(NVL(b.CW_area_dt_all,0), '999,999,999,999,999') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR(NVL(b.CW_area_reserve,0), '999,999,999,999,999') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR(NVL(b.CW_area_in_process,0), '999,999,999,999,999') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR(NVL(b.CW_area_stock,0), '999,999,999,999,999') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR(NVL(b.CW_area_haved_sale,0), '999,999,999,999,999') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR(NVL(b.CW_area_remain,0), '999,999,999,999,999') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR(NVL(b.CW_area_allow_sale,0), '999,999,999,999,999') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                            CASE
                                WHEN ( b.CW_Area_stock + b.CW_area_haved_sale ) = 0 THEN
                                    '-'
                                ELSE
                                    TO_CHAR(NVL(b.CW_area_haved_sale /(b.CW_area_stock + b.CW_area_haved_sale) * 100,0), '999,999,999,999,999'
                                    )
                                    || '%'
                            END
                        )  AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(NVL(b.CW_area_not_planning_permit,0), '999,999,999,999,999') AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(NVL(b.CW_area_not_construction_per,0), '999,999,999,999,999') AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(NVL(b.CW_area_not_sale_permit,0), '999,999,999,999,999') AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(NVL(b.CW_area_not_completion,0), '999,999,999,999,999') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(NVL(b.CW_area_yes_completion,0), '999,999,999,999,999') AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(NVL(b.CW_area_yes_settlement,0), '999,999,999,999,999') AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR(NVL(b.CW_area_dt_all,0), '999,999,999,999,999') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR(NVL(b.cw_area_reserve,0), '999,999,999,999,999') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR(NVL(b.cw_area_in_process,0), '999,999,999,999,999') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR(NVL(b.cw_area_stock,0), '999,999,999,999,999') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR(NVL(b.cw_area_haved_sale,0), '999,999,999,999,999') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR(NVL(b.cw_area_not_planning_permit,0), '999,999,999,999,999') AS "carportNoPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(NVL(b.cw_area_not_construction_per,0), '999,999,999,999,999') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(NVL(b.cw_area_not_sale_permit,0), '999,999,999,999,999') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR(NVL(b.cw_area_not_completion,0), '999,999,999,999,999') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(NVL(b.cw_value_yes_completion,0), '999,999,999,999,999') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          TO_CHAR(NVL(b.cw_area_yes_settlement,0), '999,999,999,999,999') AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM
                          (
                              SELECT
                                  id,
                                  project_name,
                                  '' AS parent_id,
                                  sn AS order_code
                              FROM
                                  sys_project
                              WHERE
                                  id = ''
                                       || projectid
                                       || ''
                              UNION ALL
--分期
                              SELECT
                                  id,
                                  stage_name,
                                  project_id AS parent_id,
                                  lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  sys_project_stage
                              WHERE
                                  project_id = ''
                                               || projectid
                                               || ''
                                  AND stage_name <> '无分期'
                              UNION ALL
--楼栋
                              SELECT
                                  mdm_build.id,
                                  build_name,
                                  (
                                      CASE
                                          WHEN mdm_period.period_name <> '无分期' THEN
                                              period_id
                                          ELSE
                                              mdm_build.proj_id
                                      END
                                  ) AS parent_id,
                                  lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  mdm_build left
                                  JOIN mdm_period ON mdm_build.period_id = mdm_period.id
                              WHERE
                                  proj_id = ''
                                            || projectid
                                            || ''
                                  AND build_state = 10--10已发布楼栋
                          ) a LEFT JOIN dwm_dt_value  b ON a.id= b.obj_id
                      START WITH
                          a.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR a.id = a.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(a.order_code, ','), 2);

    END IF;

END p_dwm_dt_area_dtl;
/

prompt
prompt Creating procedure P_SYS_GET_COMPANY_PROJ_SPID
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_SYS_GET_COMPANY_PROJ_SPID
(
		USERID         IN VARCHAR2
	 ,STATIONID      IN VARCHAR2
	 ,DEPTID         IN VARCHAR2
	 ,COMPANYID      IN VARCHAR2
	 ,BIZCODE        IN VARCHAR2
	 ,DATA_AUTH_SPID OUT VARCHAR2
) AS
		--获取有项目的公司树
		--作者：谷国斌
		--日期：2019/12/13
		RULEVALUE VARCHAR2(50);
		AUTHCOUNT INT; --用于判断当前公司、部门是否与数据授权的主体有关系
		SPID      VARCHAR2(36); --使用临时表的批次号
BEGIN

		SELECT GET_UUID() INTO SPID FROM DUAL;
		--插入集团作为根节点
		INSERT INTO TMP_COMPANY_TREE
				(ID, ORG_ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY, ORDER_CODE)
				SELECT SPID, ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
							 ORDER_CODE
				FROM   SYS_BUSINESS_UNIT
				WHERE  ID = '003200000000000000000000000000';

		--获取隔离规则：
		SELECT ISOLATION_RULE_VALUE
		INTO   RULEVALUE
		FROM   SYS_DATA_AUTH_BIZ
		WHERE  BIZ_OBJ_CODE = BIZCODE;
		IF RULEVALUE = '全集团' THEN
				INSERT INTO TMP_COMPANY_TREE
						(ID, ORG_ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
						 ORDER_CODE)
						SELECT SPID, ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
									 ORDER_CODE
						FROM   SYS_BUSINESS_UNIT
						WHERE  IS_COMPANY = 1;
		ELSE
				--插入本公司及其父级
				INSERT INTO TMP_COMPANY_TREE
						(ID, ORG_ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
						 ORDER_CODE)
						SELECT SPID, ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
									 ORDER_CODE
						FROM   SYS_BUSINESS_UNIT
						WHERE  IS_COMPANY = 1
						START  WITH ID = COMPANYID
						CONNECT BY PRIOR PARENT_ID = ID;

				--插入数据授权的数据：

				DECLARE
						OWNERID   VARCHAR2(36);
						OENERTYPE NVARCHAR2(50);
						CURSOR CURSOR_COMPANY IS
								SELECT DISTINCT AUTH_OWNER_ID, AUTH_OWNER_TYPE
								FROM   SYS_DATA_AUTH
								WHERE  AUTH_BIZ_CODE = BIZCODE AND
											 IS_DISABLED = 0;

				BEGIN

						--打开游标
						OPEN CURSOR_COMPANY;
						LOOP
								FETCH CURSOR_COMPANY
										INTO OWNERID, OENERTYPE;
								EXIT WHEN CURSOR_COMPANY%NOTFOUND;

								--过滤当前用户有权限的授权对象：
								IF OENERTYPE = '公司' OR OENERTYPE = '集团' THEN
										--AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
										SELECT COUNT(*)
										INTO   AUTHCOUNT
										FROM   SYS_BUSINESS_UNIT
										WHERE  IS_COMPANY = 1 AND
													 ID = COMPANYID
										START  WITH ID = OWNERID
										CONNECT BY PRIOR ID = PARENT_ID;
										IF AUTHCOUNT <> 0 THEN
												INSERT INTO TMP_AUTH_OWNER
														(ID, AUTH_OWNER_ID, AUTH_OWNER_TYPE)
												VALUES
														(SPID, OWNERID, OENERTYPE);

										END IF;

								END IF;

								IF OENERTYPE = '部门' THEN
										--AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
										SELECT COUNT(*)
										INTO   AUTHCOUNT
										FROM   SYS_BUSINESS_UNIT
										WHERE  IS_COMPANY = 0 AND
													 ID = DEPTID
										START  WITH ID = OWNERID
										CONNECT BY PRIOR ID = PARENT_ID;
										IF AUTHCOUNT <> 0 THEN
												INSERT INTO TMP_AUTH_OWNER
														(ID, AUTH_OWNER_ID, AUTH_OWNER_TYPE)
												VALUES
														(SPID, OWNERID, OENERTYPE);

										END IF;

								END IF;

								IF (OENERTYPE = '岗位' AND OWNERID = STATIONID) OR
									 (OENERTYPE = '人员' AND OWNERID = USERID) THEN

										INSERT INTO TMP_AUTH_OWNER
												(ID, AUTH_OWNER_ID, AUTH_OWNER_TYPE)
										VALUES
												(SPID, OWNERID, OENERTYPE);
								END IF;

						END LOOP;

						CLOSE CURSOR_COMPANY;

				END;

				--获取有权限的公司及其父级：            
				DECLARE
						OWNERID2 VARCHAR2(36);
						CURSOR CURSOR_AUTH IS
								SELECT AUTH_OWNER_ID FROM TMP_AUTH_OWNER WHERE ID = SPID;

				BEGIN

						--打开游标
						OPEN CURSOR_AUTH;
						LOOP
								FETCH CURSOR_AUTH
										INTO OWNERID2;
								EXIT WHEN CURSOR_AUTH%NOTFOUND;

								--授权对象为公司：
								--取授权公司的子级：
								INSERT INTO TMP_COMPANY_TREE
										(ID, ORG_ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
										 ORDER_CODE)
										SELECT SPID, ID, ORG_NAME, ORG_TYPE, PARENT_ID,
													 IS_COMPANY, ORDER_CODE
										FROM   SYS_BUSINESS_UNIT
										WHERE  IS_COMPANY = 1
										START  WITH ID IN
																(SELECT DISTINCT AUTH_SCOPE_ID
																 FROM   SYS_DATA_AUTH
																 WHERE  AUTH_BIZ_CODE = BIZCODE AND
																				IS_DISABLED = 0 AND
																				AUTH_OWNER_ID = OWNERID2 AND
																				AUTH_SCOPE_TYPE IN ('公司', '集团'))
										CONNECT BY PRIOR ID = PARENT_ID;

								--取授权公司的父级：
								INSERT INTO TMP_COMPANY_TREE
										(ID, ORG_ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
										 ORDER_CODE)
										SELECT SPID, ID, ORG_NAME, ORG_TYPE, PARENT_ID,
													 IS_COMPANY, ORDER_CODE
										FROM   SYS_BUSINESS_UNIT
										WHERE  IS_COMPANY = 1
										START  WITH ID IN
																(SELECT DISTINCT AUTH_SCOPE_ID
																 FROM   SYS_DATA_AUTH
																 WHERE  AUTH_BIZ_CODE = BIZCODE AND
																				IS_DISABLED = 0 AND
																				AUTH_OWNER_ID = OWNERID2 AND
																				AUTH_SCOPE_TYPE IN ('公司', '集团'))
										CONNECT BY PRIOR PARENT_ID = ID;

								--授权对应为部门：
								--取授权部门的父级：

								INSERT INTO TMP_COMPANY_TREE
										(ID, ORG_ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
										 ORDER_CODE)
										SELECT SPID, ID, ORG_NAME, ORG_TYPE, PARENT_ID,
													 IS_COMPANY, ORDER_CODE
										FROM   SYS_BUSINESS_UNIT
										WHERE  IS_COMPANY = 1
										START  WITH ID IN (SELECT DISTINCT AUTH_SCOPE_ID
																			 FROM   SYS_DATA_AUTH
																			 WHERE  AUTH_BIZ_CODE = BIZCODE AND
																							IS_DISABLED = 0 AND
																							AUTH_OWNER_ID = OWNERID2 AND
																							AUTH_SCOPE_TYPE = '部门')
										CONNECT BY PRIOR PARENT_ID = ID;
								--授权对应为项目：

								INSERT INTO TMP_COMPANY_TREE
										(ID, ORG_ID, ORG_NAME, ORG_TYPE, PARENT_ID, IS_COMPANY,
										 ORDER_CODE)
										SELECT SPID, ID, ORG_NAME, ORG_TYPE, PARENT_ID,
													 IS_COMPANY, ORDER_CODE
										FROM   SYS_BUSINESS_UNIT
										WHERE  IS_COMPANY = 1
										START  WITH ID IN
																(SELECT UNIT_ID
																 FROM   SYS_PROJECT
																 WHERE  ID IN
																				(SELECT DISTINCT AUTH_SCOPE_ID
																				 FROM   SYS_DATA_AUTH
																				 WHERE  AUTH_BIZ_CODE = BIZCODE AND
																								IS_DISABLED = 0 AND
																								AUTH_OWNER_ID = OWNERID2 AND
																								AUTH_SCOPE_TYPE = '项目'))
										CONNECT BY PRIOR PARENT_ID = ID;

						END LOOP;
						CLOSE CURSOR_AUTH;
				END;

		END IF;
DATA_AUTH_SPID:=SPID;
--		OPEN DATA_AUTH_INFO FOR
--				SELECT DISTINCT ORG_ID AS ORGID, ORG_NAME AS ORGNAME,
--												ORG_TYPE AS ORGTYPE, PARENT_ID AS PARENTID,
--												1 AS ISCOMPANY, ORDER_CODE AS ORDERCODE
--				FROM   TMP_COMPANY_TREE
--				WHERE  ID = SPID AND
--							 ORG_ID IN (SELECT DISTINCT ID
--													FROM   SYS_BUSINESS_UNIT
--													START  WITH ID IN
--																			(SELECT ID
--																			 FROM   (SELECT UNIT_ID AS ID
--																								FROM   SYS_PROJECT
--																								UNION
--																								SELECT SUBORDINATE_COMPANY_ID AS ID
--																								FROM   CDB_FEASIBLE_PROJECT_CONFIG) DS)
--													CONNECT BY PRIOR PARENT_ID = ID)
--				ORDER  BY TO_NUMBER(ORDER_CODE);

END P_SYS_GET_COMPANY_PROJ_SPID;
/

prompt
prompt Creating procedure P_DWM_DT_AREA_LIST
prompt =====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_dwm_dt_area_list (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    unitid         IN             VARCHAR2, --选择公司id
    isoperate      IN             VARCHAR2,--是否操盘
    tabsindex      IN             INT, --选择选项卡。1开始
    info           OUT            SYS_REFCURSOR--返回结果
) AS
--动态货量管理-全案动态货量
--作者：陈丽
--日期：2019/12/17
    data_auth_spid   VARCHAR2(200);
    bizcode          VARCHAR2(200);
    unitid_val       VARCHAR2(200);
BEGIN 
    --权限编码
    unitid_val:=nvl(unitid,'003200000000000000000000000000');
    bizcode := 'DWM.DTHZGL.03';
    p_sys_get_company_proj_spid(userid => userid, stationid => stationid, deptid => departmentid, companyid => companyid, bizcode
    => bizcode, data_auth_spid => data_auth_spid);

    IF tabsindex = 1 THEN
        dbms_output.put_line('所有业态!');
    ELSIF tabsindex = 2 THEN
        dbms_output.put_line('住宅及商办!');
    ELSIF tabsindex = 3 THEN
        dbms_output.put_line('住宅!');
    ELSIF tabsindex = 4 THEN
        dbms_output.put_line('商办!');
    ELSIF tabsindex = 5 THEN
        dbms_output.put_line('车位!');
    ELSIF tabsindex = 6 THEN
        dbms_output.put_line('剩余货量表!');
        OPEN info FOR 
				WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   MDM_PROJECT A1
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
				
				
				SELECT
                          a.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id   AS "parentId",--父级id（生成树父级id）
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/value-project/detail?code=area_dtl&isOperate='
                                  || proj_cooperate
                                  || '&projectId='
                                  || a.id
                                  || '&projectName='
                                  || org_name
                                  || '&projectDate='
                                  || take_date
                                  || '&tabIndex='
                                  || tabsindex
                                  || '&pageTitle='
                                  || org_name--页面标题名称
                              ELSE
                                  ''
                          END AS "openUrl",--详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/dynamic-volume/circular?companyId='
                                  || a.parent_id
                                  || '&projectId='
                                  || a.id
                                  || '&type=2'--companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
                              ELSE
                                  ''
                          END AS "openVisualUrl",--打开可视化地址
                          ORG_LEVEL,
                          CASE
                              WHEN ORG_LEVEL = 1 THEN
                                  '#eaf6ff'
                              WHEN ORG_LEVEL = 2 THEN
                                  '#ecfbee'
                              WHEN ORG_LEVEL = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN ORG_LEVEL = 1 THEN
                                  '' || org_name
                              WHEN ORG_LEVEL = 2 THEN
                                  '        ' || org_name
                              WHEN ORG_LEVEL = 3 THEN
                                  '                ' || org_name
                              WHEN ORG_LEVEL = 4 THEN
                                  '                        ' || org_name
                              ELSE
                                  '                                '|| org_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          org_name      AS "orgName",--公司/项目
                          TO_CHAR( SUM(a.zz_area_remain), '999,999,999,999,990.00') AS "projWholeDwellingArea",--项目全案剩余可售货量（S=A+B+C+D）-住宅(m2)
                          TO_CHAR( SUM(a.sy_area_remain), '999,999,999,999,990.00') AS "projWholeBusinessArea",--项目全案剩余可售货量（S=A+B+C+D）-商业(m2)
                          TO_CHAR( SUM(a.cw_area_remain), '999,999,999,999,990.00') AS "projWholeCarport",--项目全案剩余可售货量（S=A+B+C+D）-车位(个)
                          TO_CHAR(( SUM(a.cw_area_remain)+SUM(a.sy_area_remain)+SUM(a.zz_area_remain)), '999,999,999,999,990.00') AS "projWholeTotalArea",--项目全案剩余可售货量（S=A+B+C+D）-合计(m2)
                          TO_CHAR( SUM(a.zz_area_not_planning_permit), '999,999,999,999,990.00') AS "ADwellingArea",--A未取规证的可售货量-住宅(m2)
                          TO_CHAR( SUM(A.sy_area_not_planning_permit), '999,999,999,999,990.00') AS "ABusinessArea",--A未取规证的可售货量-商业(m2)
                          TO_CHAR( SUM(A.cw_area_not_planning_permit), '999,999,999,999,990.00') AS "ACarport",--A未取规证的可售货量-车位(个)
                          TO_CHAR(( SUM(A.zz_area_not_planning_permit)+SUM(a.sy_area_not_planning_permit)+SUM(a.cw_area_not_planning_permit)), '999,999,999,999,990.00'
                          ) AS "ATotalArea",--A未取规证的可售货量-合计(m2)
                          TO_CHAR( SUM(A.zz_area_not_construction_per), '999,999,999,999,990.00') AS "BDwellingArea",--B已取规证未取施工证的可售货量-住宅(m2)
                          TO_CHAR( SUM(A.sy_area_not_construction_per), '999,999,999,999,990.00') AS "BBusinessArea",--B已取规证未取施工证的可售货量-商业(m2)
                          TO_CHAR( SUM(A.cw_area_not_construction_per), '999,999,999,999,990.00') AS "BCarport",--B已取规证未取施工证的可售货量-车位(个)
                          TO_CHAR(( SUM(A.zz_area_not_construction_per)+SUM(A.sy_area_not_construction_per)+SUM(A.cw_area_not_construction_per)), '999,999,999,999,990.00'
                          ) AS "BTotalArea",--B已取规证未取施工证的可售货量-合计(m2)
                          TO_CHAR( SUM(A.zz_area_not_sale_permit), '999,999,999,999,990.00') AS "CDwellingArea",--C已取规证未取预售证的可售货量-住宅(m2)
                          TO_CHAR( SUM(a.sy_area_not_sale_permit), '999,999,999,999,990.00') AS "CBusinessArea",--C已取规证未取预售证的可售货量-商业(m2)
                          TO_CHAR( SUM(a.cw_area_not_sale_permit), '999,999,999,999,990.00') AS "CCarport",--C已取规证未取预售证的可售货量-车位(个)
                          TO_CHAR(( SUM(a.zz_area_not_sale_permit)+SUM(a.sy_area_not_sale_permit)+SUM(a.cw_area_not_sale_permit)), '999,999,999,999,990.00') AS "CTotalArea"
                          ,--C已取规证未取预售证的可售货量-合计(m2)
                          TO_CHAR( SUM(a.zz_area_stock), '999,999,999,999,990.00') AS "DDwellingArea",--D已取预售证未售的可售货量-住宅(m2)
                          TO_CHAR( SUM(A.sy_area_stock), '999,999,999,999,990.00') AS "DBusinessArea",--D已取预售证未售的可售货量-商业(m2)
                          TO_CHAR( SUM(A.cw_area_stock), '999,999,999,999,990.00') AS "DCarport",--D已取预售证未售的可售货量-车位(个)
                          TO_CHAR((SUM(A.zz_area_stock)+SUM(A.sy_area_stock)+SUM(A.cw_area_stock)), '999,999,999,999,990.00') AS "DTotalArea"--D已取预售证未售的可售货量-合计(m2)
                      FROM
                         TEMP_DT_VALUE A
												 INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
                       --WHERE  a.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END)    
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE order by ORDER_HIERARCHY_CODE;

    END IF;

    IF tabsindex = 1 OR tabsindex = 2  THEN
        OPEN info FOR 
				WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   MDM_PROJECT A1
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
				SELECT
                          a.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id   AS "parentId",--父级id（生成树父级id）
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/area-project/detail?code=area_dtl&isOperate='
                                  || proj_cooperate
                                  || '&projectId='
                                  || a.id--项目id
                                  || '&projectName='
                                  || org_name---项目名称
                                  || '&projectDate='
                                  || take_date--项目获取时间
                                  || '&tabIndex='
                                  || tabsindex--选中的tabindex
                                  || '&pageTitle='
                                  || org_name--页面标题名称
                              ELSE
                                  ''
                          END AS "openUrl",--详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/dynamic-volume/circular?companyId='
                                  || a.parent_id---公司id
                                  || '&projectId='
                                  || a.id---项目id
                                  || '&type=1'--companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
                              ELSE
                                  ''
                          END AS "openVisualUrl",--打开可视化地址
                          ORG_LEVEL,
                          CASE
                              WHEN ORG_LEVEL = 1 THEN
                                  '#eaf6ff'
                              WHEN ORG_LEVEL = 2 THEN
                                  '#ecfbee'
                              WHEN ORG_LEVEL = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN ORG_LEVEL = 1 THEN
                                  '' || org_name
                              WHEN ORG_LEVEL = 2 THEN
                                  '        ' || org_name
                              WHEN ORG_LEVEL = 3 THEN
                                  '                ' || org_name
                              WHEN ORG_LEVEL = 4 THEN
                                  '                        ' || org_name
                              ELSE
                                  '                                '|| org_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          org_name      AS "orgName",--项目/分期/业态/楼栋
                          TO_CHAR( SUM(A.area_dt_all), '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR( SUM(A.area_dt_all), '999,999,999,999,990.00') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR( SUM(A.area_dt_all), '999,999,999,999,990.00') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR( SUM(A.area_reserve), '999,999,999,999,990.00') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR( SUM(A.AREA_IN_PROCESS), '999,999,999,999,990.00') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR( SUM(A.area_stock), '999,999,999,999,990.00') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR(SUM(A.area_haved_sale), '999,999,999,999,990.00') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR( SUM(A.area_remain), '999,999,999,999,990.00') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR( SUM(A.area_allow_sale), '999,999,999,999,990.00') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                              CASE
                                  WHEN ( SUM(A.area_stock)+SUM(A.area_haved_sale)) = 0 THEN
                                      '-'
                                  ELSE
                                      TO_CHAR( SUM(A.area_haved_sale) /( SUM(a.area_stock)+SUM(a.area_haved_sale)) * 100, '999,999,999,999,990.00'
                                      )
                                      || '%'
                              END
                          ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(( SUM(A.zz_area_not_planning_permit)+SUM(A.sy_area_not_planning_permit)), '999,999,999,999,990.00'
                          ) AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR(( SUM(A.zz_area_not_construction_per)+SUM(A.sy_area_not_construction_per)), '999,999,999,999,990.00'
                          ) AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR(( SUM(A.zz_area_not_sale_permit)+SUM(A.sy_area_not_sale_permit)), '999,999,999,999,990.00'
                          ) AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR( SUM(a.area_not_completion), '999,999,999,999,990.00') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR(( SUM(a.zz_area_yes_completion)+SUM(a.sy_area_yes_completion)), '999,999,999,999,990.00'
                          ) AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          '-' AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR( SUM(a.cw_area_dt_all), '999,999,999,999,990.00') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR( SUM(a.cw_value_reserve), '999,999,999,999,990.00') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR( SUM(a.cw_area_in_process), '999,999,999,999,990.00') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR( SUM(a.cw_area_stock), '999,999,999,999,990.00') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR( SUM(a.cw_area_haved_sale), '999,999,999,999,990.00') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR( SUM(a.area_not_planning_permit), '999,999,999,999,990.00') AS "carportNoPermitObtainedPhase"
                          ,--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR( SUM(a.area_not_construction_permit), '999,999,999,999,990.00') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR( SUM(a.area_not_sale_permit), '999,999,999,999,990.00') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR( SUM(A.area_not_completion), '999,999,999,999,990.00') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR( SUM(a.area_yes_completion), '999,999,999,999,990.00') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          '-' AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM
                          TEMP_DT_VALUE A
												 INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
                      -- WHERE  a.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END)    
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE order by ORDER_HIERARCHY_CODE; 


    ELSIF tabsindex = 3  THEN
        OPEN info FOR 
				WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   MDM_PROJECT A1
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
				SELECT
                          a.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id   AS "parentId",--父级id（生成树父级id）
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/area-project/detail?code=area_dtl&isOperate='
                                  || proj_cooperate
                                  || '&projectId='
                                  || a.id--项目id
                                  || '&projectName='
                                  || org_name---项目名称
                                  || '&projectDate='
                                  || take_date--项目获取时间
                                  || '&tabIndex='
                                  || tabsindex--选中的tabindex
                                  || '&pageTitle='
                                  || org_name--页面标题名称
                              ELSE
                                  ''
                          END AS "openUrl",--详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/dynamic-volume/circular?companyId='
                                  || a.parent_id---公司id
                                  || '&projectId='
                                  || a.id---项目id
                                  || '&type=1'--companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
                              ELSE
                                  ''
                          END AS "openVisualUrl",--打开可视化地址
                          ORG_LEVEL,
                          CASE
                              WHEN ORG_LEVEL = 1 THEN
                                  '#eaf6ff'
                              WHEN ORG_LEVEL = 2 THEN
                                  '#ecfbee'
                              WHEN ORG_LEVEL = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN ORG_LEVEL = 1 THEN
                                  '' || org_name
                              WHEN ORG_LEVEL = 2 THEN
                                  '        ' || org_name
                              WHEN ORG_LEVEL = 3 THEN
                                  '                ' || org_name
                              WHEN ORG_LEVEL = 4 THEN
                                  '                        ' || org_name
                              ELSE
                                  '                                '|| org_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          org_name      AS "orgName",--项目/分期/业态/楼栋
                          TO_CHAR( SUM(A.zz_area_dt_all), '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR( SUM(a.zz_area_dt_all), '999,999,999,999,990.00') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR( SUM(A.zz_area_dt_all), '999,999,999,999,990.00') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR( SUM(a.zz_area_reserve), '999,999,999,999,990.00') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR( SUM(A.zz_AREA_IN_PROCESS), '999,999,999,999,990.00') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR( SUM(A.zz_area_stock), '999,999,999,999,990.00') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR( SUM(A.zz_area_haved_sale), '999,999,999,999,990.00') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR( SUM(A.zz_area_remain), '999,999,999,999,990.00') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR( SUM(A.zz_area_allow_sale), '999,999,999,999,990.00') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                              CASE
                                  WHEN ( SUM(a.zz_area_stock)+SUM(a.zz_area_haved_sale)) = 0 THEN
                                      '-'
                                  ELSE
                                      TO_CHAR( SUM(A.zz_area_haved_sale) /( SUM(A.zz_area_stock)+SUM(A.zz_area_haved_sale)) * 100, '999,999,999,999,990.00'
                                      )
                                      || '%'
                              END
                          ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR( SUM(A.zz_area_not_planning_permit), '999,999,999,999,990.00'
                          ) AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR( SUM(A.zz_area_not_construction_per), '999,999,999,999,990.00'
                          ) AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR( SUM(A.zz_area_not_sale_permit), '999,999,999,999,990.00'
                          ) AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR( SUM(A.zz_area_not_completion), '999,999,999,999,990.00') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR( SUM(A.zz_area_yes_completion), '999,999,999,999,990.00'
                          ) AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          '-' AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR( SUM(a.cw_area_dt_all), '999,999,999,999,990.00') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR( SUM(a.cw_value_reserve), '999,999,999,999,990.00') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR( SUM(A.cw_area_in_process), '999,999,999,999,990.00') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR( SUM(A.cw_area_stock), '999,999,999,999,990.00') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR( SUM(A.cw_area_haved_sale), '999,999,999,999,990.00') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR( SUM(A.zz_area_not_planning_permit), '999,999,999,999,990.00') AS "carportNoPermitObtainedPhase"
                          ,--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR( SUM(A.zz_area_not_construction_per), '999,999,999,999,990.00') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR( SUM(A.zz_area_not_sale_permit), '999,999,999,999,990.00') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR( SUM(a.zz_area_not_completion), '999,999,999,999,990.00') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR( SUM(A.zz_area_yes_completion), '999,999,999,999,990.00') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          '-' AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM   TEMP_DT_VALUE A
            INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
                       --WHERE  a.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END)    
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE order by ORDER_HIERARCHY_CODE;
						
ELSIF tabsindex = 4  THEN
        OPEN info FOR 
				WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   MDM_PROJECT A1
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
				SELECT
                          a.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id   AS "parentId",--父级id（生成树父级id）
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/area-project/detail?code=area_dtl&isOperate='
                                  || proj_cooperate
                                  || '&projectId='
                                  || a.id--项目id
                                  || '&projectName='
                                  || org_name---项目名称
                                  || '&projectDate='
                                  || take_date--项目获取时间
                                  || '&tabIndex='
                                  || tabsindex--选中的tabindex
                                  || '&pageTitle='
                                  || org_name--页面标题名称
                              ELSE
                                  ''
                          END AS "openUrl",--详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/dynamic-volume/circular?companyId='
                                  || a.parent_id---公司id
                                  || '&projectId='
                                  || a.id---项目id
                                  || '&type=1'--companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
                              ELSE
                                  ''
                          END AS "openVisualUrl",--打开可视化地址
                          ORG_LEVEL,
                          CASE
                              WHEN ORG_LEVEL = 1 THEN
                                  '#eaf6ff'
                              WHEN ORG_LEVEL = 2 THEN
                                  '#ecfbee'
                              WHEN ORG_LEVEL = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN ORG_LEVEL = 1 THEN
                                  '' || org_name
                              WHEN ORG_LEVEL = 2 THEN
                                  '        ' || org_name
                              WHEN ORG_LEVEL = 3 THEN
                                  '                ' || org_name
                              WHEN ORG_LEVEL = 4 THEN
                                  '                        ' || org_name
                              ELSE
                                  '                                '|| org_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          org_name      AS "orgName",--项目/分期/业态/楼栋
                          TO_CHAR( SUM(A.sy_area_dt_all), '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR( SUM(A.sy_area_dt_all), '999,999,999,999,990.00') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR( SUM(a.sy_area_dt_all), '999,999,999,999,990.00') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR( SUM(a.sy_area_reserve), '999,999,999,999,990.00') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR( SUM(a.sy_AREA_IN_PROCESS), '999,999,999,999,990.00') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR( SUM(a.sy_area_stock), '999,999,999,999,990.00') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR( SUM(a.sy_area_haved_sale), '999,999,999,999,990.00') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR( SUM(a.sy_area_remain), '999,999,999,999,990.00') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR( SUM(a.sy_area_allow_sale), '999,999,999,999,990.00') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                              CASE
                                  WHEN ( SUM(A.sy_area_stock)+SUM(A.sy_area_haved_sale)) = 0 THEN
                                      '-'
                                  ELSE
                                      TO_CHAR( SUM(A.sy_area_haved_sale) /( SUM(A.sy_area_stock)+SUM(A.sy_area_haved_sale)) * 100, '999,999,999,999,990.00'
                                      )
                                      || '%'
                              END
                          ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR( SUM(A.sy_area_not_planning_permit), '999,999,999,999,990.00'
                          ) AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR( SUM(a.sy_area_not_construction_per), '999,999,999,999,990.00'
                          ) AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR( SUM(A.sy_area_not_sale_permit), '999,999,999,999,990.00'
                          ) AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR( SUM(a.sy_area_not_completion), '999,999,999,999,990.00') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR( SUM(A.sy_area_yes_completion), '999,999,999,999,990.00'
                          ) AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          '-' AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR( SUM(A.cw_area_dt_all), '999,999,999,999,990.00') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR( SUM(A.cw_value_reserve), '999,999,999,999,990.00') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR( SUM(a.cw_area_in_process), '999,999,999,999,990.00') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR( SUM(a.cw_area_stock), '999,999,999,999,990.00') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR( SUM(a.cw_area_haved_sale), '999,999,999,999,990.00') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR( SUM(a.sy_area_not_planning_permit), '999,999,999,999,990.00') AS "carportNoPermitObtainedPhase"
                          ,--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR( SUM(a.sy_area_not_construction_per), '999,999,999,999,990.00') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR( SUM(a.sy_area_not_sale_permit), '999,999,999,999,990.00') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR( SUM(a.sy_area_not_completion), '999,999,999,999,990.00') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR( SUM(a.sy_area_yes_completion), '999,999,999,999,990.00') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          '-' AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM   TEMP_DT_VALUE A
            INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
                      -- WHERE  a.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END)    
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE order by ORDER_HIERARCHY_CODE;

ELSIF tabsindex = 5  THEN
        OPEN info FOR 
				WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   MDM_PROJECT A1
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
				SELECT
                          a.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                          a.parent_id   AS "parentId",--父级id（生成树父级id）
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/area-project/detail?code=area_dtl&isOperate='
                                  || proj_cooperate
                                  || '&projectId='
                                  || a.id--项目id
                                  || '&projectName='
                                  || org_name---项目名称
                                  || '&projectDate='
                                  || take_date--项目获取时间
                                  || '&tabIndex='
                                  || tabsindex--选中的tabindex
                                  || '&pageTitle='
                                  || org_name--页面标题名称
                              ELSE
                                  ''
                          END AS "openUrl",--详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
                          CASE
                              WHEN is_company = 0 THEN
                                  '/dwm/value-manage/dynamic-volume/circular?companyId='
                                  || a.parent_id---公司id
                                  || '&projectId='
                                  || a.id---项目id
                                  || '&type=1'--companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
                              ELSE
                                  ''
                          END AS "openVisualUrl",--打开可视化地址
                          ORG_LEVEL,
                          CASE
                              WHEN ORG_LEVEL = 1 THEN
                                  '#eaf6ff'
                              WHEN ORG_LEVEL = 2 THEN
                                  '#ecfbee'
                              WHEN ORG_LEVEL = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN ORG_LEVEL = 1 THEN
                                  '' || org_name
                              WHEN ORG_LEVEL = 2 THEN
                                  '        ' || org_name
                              WHEN ORG_LEVEL = 3 THEN
                                  '                ' || org_name
                              WHEN ORG_LEVEL = 4 THEN
                                  '                        ' || org_name
                              ELSE
                                  '                                '|| org_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          org_name      AS "orgName",--项目/分期/业态/楼栋
                          TO_CHAR( SUM(A.cw_area_dt_all), '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
                          TO_CHAR( SUM(A.cw_area_dt_all), '999,999,999,999,990.00') AS "newestSalesArea",--最新可售面积（不含车位）
                          TO_CHAR( SUM(A.cw_area_dt_all), '999,999,999,999,990.00') AS "dynamicCargo",--动态货量（不含车位）-动态货量(A)
                          TO_CHAR( SUM(A.Cw_Area_Reserve), '999,999,999,999,990.00') AS "reserveCargo",--动态货量（不含车位）-储备货量(A1)
                          TO_CHAR( SUM(A.cw_AREA_IN_PROCESS), '999,999,999,999,990.00') AS "inProcessTotalCargo",--动态货量（不含车位）-在途货量(A2)
                          TO_CHAR( SUM(A.cw_area_stock), '999,999,999,999,990.00') AS "stockCargo",--动态货量（不含车位）-库存货量(A3)
                          TO_CHAR( SUM(a.cw_area_haved_sale), '999,999,999,999,990.00') AS "alreadySalesCargo",--动态货量（不含车位）-已售货量(A4)
                          TO_CHAR( SUM(A.cw_area_remain), '999,999,999,999,990.00') AS "residueCargo",--剩余货量(C=B1+B2+B3)
                          TO_CHAR( SUM(a.cw_area_allow_sale), '999,999,999,999,990.00') AS "getCargo",--已领证货量(D=B3+B4)
                          (
                              CASE
                                  WHEN ( SUM(a.cw_area_stock)+SUM(a.cw_area_haved_sale)) = 0 THEN
                                      '-'
                                  ELSE
                                      TO_CHAR( SUM(a.cw_area_haved_sale) /( SUM(a.cw_area_stock)+SUM(a.cw_area_haved_sale)) * 100, '999,999,999,999,990.00'
                                      )
                                      || '%'
                              END
                          ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR( SUM(a.cw_area_not_planning_permit), '999,999,999,999,990.00'
                          ) AS "noPermitObtainedPhase",--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR( SUM(a.cw_area_not_construction_per), '999,999,999,999,990.00'
                          ) AS "PermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR( SUM(a.cw_area_not_sale_permit), '999,999,999,999,990.00'
                          ) AS "constructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR( SUM(a.cw_area_not_completion), '999,999,999,999,990.00') AS "PreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR( SUM(a.cw_area_yes_completion), '999,999,999,999,990.00'
                          ) AS "completedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          '-' AS "carryDownPhase",--动态货量的各阶段分布（不含车位）-5结转阶段
                          TO_CHAR( SUM(a.cw_area_dt_all), '999,999,999,999,990.00') AS "carportDynamicCargo",--动态货量（车位）-动态货量(A)
                          TO_CHAR( SUM(a.Cw_Area_Reserve), '999,999,999,999,990.00') AS "carportReserveCargo",--动态货量（车位）-储备货量(A1)
                          TO_CHAR( SUM(a.cw_area_in_process), '999,999,999,999,990.00') AS "carportInProcessTotalCargo",--动态货量（车位）-在途货量(A2)
                          TO_CHAR( SUM(a.cw_area_stock), '999,999,999,999,990.00') AS "carportStockCargo",--动态货量（车位）-库存货量(A3)
                          TO_CHAR( SUM(a.cw_area_haved_sale), '999,999,999,999,990.00') AS "carportAlreadySalesCargo",--动态货量（车位）-已售货量(A4)
                          TO_CHAR( SUM(a.cw_area_not_planning_permit), '999,999,999,999,990.00') AS "carportNoPermitObtainedPhase"
                          ,--动态货量的各阶段分布（不含车位）-0未取规证
                          TO_CHAR( SUM(a.cw_area_not_construction_per), '999,999,999,999,990.00') AS "carportPermitObtainedOhase",--动态货量的各阶段分布（不含车位）-1规划许可证阶段
                          TO_CHAR( SUM(a.cw_area_not_sale_permit), '999,999,999,999,990.00') AS "carportConstructionPermitOhase",--动态货量的各阶段分布（不含车位）-2施工许可证阶段
                          TO_CHAR( SUM(a.cw_area_not_completion), '999,999,999,999,990.00') AS "carportPreSalePermitPhase",--动态货量的各阶段分布（不含车位）-3预售许可证阶段
                          TO_CHAR( SUM(a.cw_area_yes_completion), '999,999,999,999,990.00') AS "carportCompletedRecordPhase",--动态货量的各阶段分布（不含车位）-4竣备阶段
                          '-' AS "carportCarryDownPhase"--动态货量的各阶段分布（不含车位）-5结转阶段
                      FROM   TEMP_DT_VALUE A
            INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
                          
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE order by ORDER_HIERARCHY_CODE;
    END IF;
		

END p_dwm_dt_area_list;
/

prompt
prompt Creating procedure P_DWM_DT_VALUE_DTL
prompt =====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_dwm_dt_value_dtl (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    projectid      IN             VARCHAR2, --选择公司id
    tabsindex      IN             VARCHAR2, --选择选项卡。1开始
    isoperate      IN             VARCHAR2,--是否操盘
    info           OUT            SYS_REFCURSOR
) AS
--动态货值管理-全案动态货值-详情
--作者：陈丽
--日期：2019/12/17
BEGIN
 IF tabsindex = 1 THEN
        dbms_output.put_line('所有业态!');
    ELSIF tabsindex = 2 THEN
        dbms_output.put_line('住宅及商办!');
    ELSIF tabsindex = 3 THEN
        dbms_output.put_line('住宅!');
    ELSIF tabsindex = 4 THEN
        dbms_output.put_line('商办!');
    ELSIF tabsindex = 5 THEN
        dbms_output.put_line('车位!');
    ELSIF tabsindex = 6 THEN
        dbms_output.put_line('剩余货量表!');
        OPEN info FOR SELECT
                          t.id             AS "id",--主键id（生成树的id，唯一可以是业务id）
                           level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '' || project_name
                              WHEN level = 2 THEN
                                  '        ' || project_name
                              WHEN level = 3 THEN
                                  '                ' || project_name
                              WHEN level = 4 THEN
                                  '                        ' || project_name
                              ELSE
                                  '                                ' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                          t.parent_id      AS "parentId",--父级id（生成树父级id）
                          project_name   AS "orgName",--项目/分期/业态/楼栋
                          TO_CHAR(nvl(round(b.zz_value_remain/10000,2),0), 'fm999,999,999,990.00') AS "projWholeDwellingValue",--项目全案剩余可售货值（S=A+B+C+D）-住宅(m2)
                          TO_CHAR(nvl(round(b.SY_value_remain/10000,2),0), 'fm999,999,999,990.00') AS "projWholeBusinessValue",--项目全案剩余可售货值（S=A+B+C+D）-商业(m2)
                          TO_CHAR(nvl(round(b.CW_value_remain/10000,2),0), 'fm999,999,999,990.00') AS "projWholeCarportValue",--项目全案剩余可售货值（S=A+B+C+D）-车位(个)
                          TO_CHAR(nvl(round((b.zz_value_remain+b.SY_value_remain+b.CW_value_remain)/10000,2),0), 'fm999,999,999,990.00') AS "projWholeTotalValue",--项目全案剩余可售货值（S=A+B+C+D）-合计(m2)

                          TO_CHAR(nvl(round(b.zz_value_not_planning_permit/10000,2),0), 'fm999,999,999,990.00') AS "ADwellingValue",--A未取规证的可售货值-住宅(m2)
                          TO_CHAR(nvl(round(b.SY_value_not_planning_permit/10000,2),0), 'fm999,999,999,990.00') AS "ABusinessValue",--A未取规证的可售货值-商业(m2)
                          TO_CHAR(nvl(round(b.CW_value_not_planning_permit/10000,2),0), 'fm999,999,999,990.00') AS "ACarportValue",--A未取规证的可售货值-车位(个)
                          TO_CHAR(nvl(round((b.ZZ_value_not_planning_permit+b.SY_value_not_planning_permit+b.CW_value_not_planning_permit)/10000,2),0), 'fm999,999,999,990.00') AS "ATotalValue",--A未取规证的可售货值-合计(m2)

                          TO_CHAR(nvl(round(b.zz_value_not_construction_per/10000,2),0), 'fm999,999,999,990.00') AS "BDwellingValue",--B已取规证未取施工证的可售货值-住宅(m2)
                          TO_CHAR(nvl(round(b.SY_value_not_construction_per/10000,2),0), 'fm999,999,999,990.00') AS "BBusinessValue",--B已取规证未取施工证的可售货值-商业(m2)
                          TO_CHAR(nvl(round(b.CW_value_not_construction_per/10000,2),0), 'fm999,999,999,990.00') AS "BCarportValue",--B已取规证未取施工证的可售货值-车位(个)
                          TO_CHAR(nvl(round((b.zz_value_not_construction_per+b.SY_value_not_construction_per+b.CW_value_not_construction_per)/10000,2),0), 'fm999,999,999,990.00') AS "BTotalValue",--B已取规证未取施工证的可售货值-合计(m2)

                          TO_CHAR(nvl(round(b.zz_value_not_sale_permit/10000,2),0), 'fm999,999,999,990.00') AS "CDwellingValue",--C已取施工证未取预售证的可售货值-住宅(m2)
                          TO_CHAR(nvl(round(b.sy_value_not_sale_permit/10000,2),0), 'fm999,999,999,990.00') AS "CBusinessValue",--C已取施工证未取预售证的可售货值-商业(m2)
                          TO_CHAR(nvl(round(b.cw_value_not_sale_permit/10000,2),0), 'fm999,999,999,990.00') AS "CCarportValue",--C已取施工证未取预售证的可售货值-车位(个)
                         TO_CHAR(nvl( round((b.zz_value_not_sale_permit+b.sy_value_not_sale_permit+b.Cw_value_not_sale_permit)/10000,2),0), 'fm999,999,999,990.00') AS "CTotalValue",--C已取施工证未取预售证的可售货值-合计(m2)

                          TO_CHAR(nvl(round(b.zz_value_stock/10000,2),0), 'fm999,999,999,990.00') AS "DDwellingValue",--D已取预售证未售的可售货值-住宅(m2)
                        TO_CHAR(nvl(round(b.sy_value_stock/10000,2),0), 'fm999,999,999,990.00') AS "DBusinessValue",--D已取预售证未售的可售货值-商业(m2)
                         TO_CHAR(nvl(round(b.cw_value_stock/10000,2),0), 'fm999,999,999,990.00') AS "DCarportValue",--D已取预售证未售的可售货值-车位(个)
                          TO_CHAR(nvl(round((b.zz_value_stock+b.sy_value_stock+b.cw_value_stock)/10000,2),0), 'fm999,999,999,990.00') AS "DTotalValue"--D已取预售证未售的可售货值-合计(m2)
                       FROM
                          (
                              SELECT
                                  id,
                                  project_name,
                                  '' AS parent_id,
                                  sn AS order_code
                              FROM
                                  sys_project
                              WHERE
                                  id = ''
                                       || projectid
                                       || ''
                              UNION ALL
--分期
                              SELECT
                                  id,
                                  stage_name,
                                  project_id AS parent_id,
                                  lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  sys_project_stage
                              WHERE
                                  project_id = ''
                                               || projectid
                                               || ''  AND stage_name<>'无分期'
                              UNION ALL
--楼栋
                              SELECT
                                  mdm_build.id,
                                  mdm_build.build_name||'（'||v_MDM_BUILDING.Permit_Status||'）' AS BuildName,
                              (CASE WHEN mdm_period.period_name<>'无分期' THEN  period_id ELSE mdm_build.proj_id END)  AS parent_id,
                                  lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                              FROM
                                  mdm_build LEFT JOIN mdm_period ON mdm_build.period_id=mdm_period.id
                                  LEFT JOIN v_MDM_BUILDING ON mdm_build.id=v_MDM_BUILDING.BUILDINGID
                              WHERE
                                  mdm_build.proj_id = ''
                                            || projectid
                                            || ''
                                  AND build_state = 10--10已发布楼栋
                          ) t LEFT JOIN dwm_dt_value   b ON t.id = b.obj_id
                       START WITH
                          t.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR t.id = t.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(t.order_code, ','), 2);

    END IF;

    IF tabsindex = 1 THEN
    OPEN info FOR SELECT
                      t.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                       level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '' || project_name
                              WHEN level = 2 THEN
                                  '        ' || project_name
                              WHEN level = 3 THEN
                                  '                ' || project_name
                              WHEN level = 4 THEN
                                  '                        ' || project_name
                              ELSE
                                  '                                ' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                      t.parent_id   AS "parentId",--父级id（生成树父级id）
                      project_name    AS "orgName",--公司/项目
                        TO_CHAR(nvl(b.area_dt_all,0), 'fm999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
                        TO_CHAR(nvl(nvl(b.area_dt_all, 0),0), 'fm999,999,999,999,990.00') AS "targetSalesArea",--最新可售面积（不含车位）
                        TO_CHAR(nvl(b.TARGET_A1_VALUE,0), 'fm999,999,999,999,990.00') AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
                        TO_CHAR(nvl(b.TARGET_A2_VALUE,0), 'fm999,999,999,999,990.00')  AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
                        TO_CHAR( nvl(b.TARGET_A3_VALUE, 0), 'fm999,999,999,999,990.00') AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
                        TO_CHAR( NVL(b.TARGET_A_VALUE,0), 'fm999,999,999,999,990.00') AS "targetNewestWorth",--目标总货值（A）-最新版(A)
                        TO_CHAR(nvl(b.value_dt_all / 10000,0), 'fm999,999,999,999,990.00') AS "dynamicTotalWorth",--动态总货值(B)
                       (CASE WHEN round(nvl(b.value_dt_all,0) / 10000 - nvl(b.TARGET_A_VALUE,0),2)<0 
                         THEN  '<font color=red>'||TO_CHAR(round(b.value_dt_all / 10000 - nvl(b.TARGET_A_VALUE,0),2), 'fm999,999,999,999,990.00')||'</font>'
                         ELSE  '<font color=green>'||TO_CHAR(round(b.value_dt_all / 10000 - nvl(b.TARGET_A_VALUE,0),2), 'fm999,999,999,999,990.00')||'</font>'
                         END  ) AS "dynamicTotalWorthDifference"
                        ,--总货值差额(B-A)
                        TO_CHAR(nvl(b.value_reserve / 10000,0), 'fm999,999,999,999,990.00') AS "reserveTotalWorth",--动态总货值构成（B=B1+B2+B3+B4）---动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1) 
                        TO_CHAR(nvl(b.value_in_process / 10000,0), 'fm999,999,999,999,990.00') AS "inProcessTotalWorth",--动态总货值构成（B=B1+B2+B3+B4）-在途货值(B2)
                        TO_CHAR(nvl(b.value_stock/10000 ,0), 'fm999,999,999,999,990.00') AS "stockWorth",--动态总货值构成（B=B1+B2+B3+B4）-库存货值(B3)
                        TO_CHAR(nvl(b.value_haved_sale / 10000,0), 'fm999,999,999,999,990.00') AS "alreadySalesWorth",--动态总货值构成（B=B1+B2+B3+B4）-已售货值(B4)
                        TO_CHAR(nvl((b.value_remain) / 10000,0), 'fm999,999,999,999,990.00') AS "residueWorth",---剩余货值(C=B1+B2+B3)
                        TO_CHAR(nvl((b.value_stock + b.value_haved_sale) / 10000,0), 'fm999,999,999,999,990.00') AS "getWorth",--已领证货值(D=B3+B4)
                        (
                            CASE
                                WHEN ( b.value_stock + b.value_haved_sale ) = 0 THEN
                                    '-'
                                ELSE
                                    TO_CHAR(nvl(b.value_haved_sale /(b.value_stock + b.value_haved_sale) * 100,0), 'fm999,999,999,999,990.00'
                                    )
                                    || '%'
                            END
                        ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(nvl(b.value_not_planning_permit / 10000,0), 'fm999,999,999,999,990.00') AS "noPlanningPermitObtainedPhase",--F、动态货值的各阶段分布-F0未取规证
                          TO_CHAR(nvl(b.value_not_construction_permit / 10000,0), 'fm999,999,999,999,990.00') AS "planningPermitObtainedOhase",--F、动态货值的各阶段分布-F1规划许可证阶段
                          TO_CHAR(nvl(b.value_not_sale_permit / 10000,0), 'fm999,999,999,999,990.00') AS "constructionPermitOhase",--F、动态货值的各阶段分布-F2施工许可证阶段
                          TO_CHAR(nvl(b.value_not_completion / 10000,0), 'fm999,999,999,999,990.00') AS "PreSalePermitPhase",--F、动态货值的各阶段分布-F3预售许可证阶段
                          --TO_CHAR(nvl(b.value_yes_completion / 10000,0), 'fm999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          TO_CHAR(nvl(b.value_yes_completion / 10000,0), 'fm999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          '-' AS "carryDownPhase",--F、动态货值的各阶段分布-F5结转阶段

                          TO_CHAR(nvl(b.value_reserve / 10000,0), 'fm999,999,999,999,990.00') AS "reserveWorth",--G1、储备货值的量价情况-货值（G1=a1*b1）
                          TO_CHAR(nvl(b.zz_area_reserve+b.SY_area_reserve,0), 'fm999,999,999,999,990.00') AS "reserveCargo",--G1、储备货值的量价情况-货量(a1)
                          '-' AS "reservePrice",--G1、储备货值的量价情况-单价(b1)
                          TO_CHAR(nvl(b.value_in_process / 10000,0), 'fm999,999,999,999,990.00') AS "inTransitWorth",--G2、在途货值的量价情况-货值（G2=a2*b2）
                          TO_CHAR(nvl(b.zz_area_in_process+b.SY_area_in_process,0), 'fm999,999,999,999,990.00') AS "inTransitCargo",--G2、在途货值的量价情况-货量(a2)
                          '-' AS "inTransitPrice",--G2、在途货值的量价情况-单价(b2)
                          TO_CHAR(nvl(b.value_stock / 10000,0), 'fm999,999,999,999,990.00') AS "stockWorth",--G3、库存货值的量价情况-货值（G3=a3*b3）
                          TO_CHAR(nvl(b.zz_area_stock+b.sy_area_stock,0), 'fm999,999,999,999,990.00') AS "stockCargo",--G3、库存货值的量价情况-货量(a3)
                          '-' AS "stockPrice",--G3、库存货值的量价情况-单价(b3)
                          TO_CHAR(nvl(b.value_haved_sale / 10000,0), 'fm999,999,999,999,990.00') AS "soldWorth",--G4、已售货值的量价情况-货值（G4=a4*b4）
                          TO_CHAR(nvl(b.zz_area_haved_sale+b.sy_area_haved_sale,0), 'fm999,999,999,999,990.00') AS "soldCargo",--G4、已售货值的量价情况-货量(a4)
                          '-' AS "soldPrice"--G4、已售货值的量价情况-单价(b4)
                  FROM
                      (
                          SELECT
                              id,
                              project_name,
                              '' AS parent_id,
                              sn AS order_code,
                              '项目' AS Obj_Type
                          FROM
                              sys_project
                          WHERE
                              id = ''
                                   || projectid
                                   || ''
                          UNION ALL
--分期
                          SELECT
                              id,
                              stage_name,
                              project_id AS parent_id,
                              lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code,
                              '分期' AS Obj_Type
                          FROM
                              sys_project_stage
                          WHERE
                              project_id = ''|| projectid|| '' AND stage_name<>'无分期'

                          UNION ALL
--楼栋
                          SELECT
                              mdm_build.id,
                               mdm_build.build_name||'（'||nvl(mdm_build.NEWEST_VALUE_PHASE,'未取证')||'）' AS BuildName,
                              (CASE WHEN mdm_period.period_name<>'无分期' THEN  period_id ELSE mdm_build.proj_id END)  AS parent_id,
                              lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code,
                              '楼栋' AS Obj_Type
                          FROM
                              mdm_build LEFT JOIN mdm_period ON mdm_build.period_id=mdm_period.id
                              LEFT JOIN v_MDM_BUILDING ON mdm_build.id=v_MDM_BUILDING.BUILDINGID
                          WHERE
                              mdm_build.proj_id = ''
                                        || projectid
                                        || ''
                              AND build_state = 10--10已发布楼栋
                      ) t LEFT JOIN dwm_dt_value  b ON t.id= b.obj_id
                          LEFT JOIN dwm_target_worth c1 ON b.obj_id = c1.proj_id  AND c1.target_worth_phase = 0 and c1.IS_DELETE=0 
                               AND c1.approval_status IN ('已审核','审核中')
                          LEFT JOIN dwm_target_worth c2 ON b.obj_id = c2.proj_id AND c2.target_worth_phase = 10 and c2.IS_DELETE=0
                                AND c2.approval_status IN ('已审核','审核中')
                          LEFT JOIN dwm_target_worth c3 ON b.obj_id = c3.proj_id AND c3.target_worth_phase = 20 and c3.IS_DELETE=0
                               AND c3.approval_status IN ('已审核','审核中') AND c3.id IN (SELECT id FROM V_DWM_TARGET_WORTH_NOW)
                          LEFT JOIN v_dwm_target_worth_now c4 ON b.obj_id= c4.proj_id
                               AND c4.approval_status IN ('已审核','审核中')
                          LEFT JOIN v_dwm_target_worth_dtl_now d ON b.obj_id=d.obj_id AND d.obj_type=30
                   START WITH
                          t.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR t.id = t.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(t.order_code, ','), 2);
    END IF;

    IF tabsindex = 2 THEN--OR tabsindex = 3 OR tabsindex = 4 OR tabsindex = 5 
    OPEN info FOR SELECT
                      t.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                       level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '' || project_name
                              WHEN level = 2 THEN
                                  '        ' || project_name
                              WHEN level = 3 THEN
                                  '                ' || project_name
                              WHEN level = 4 THEN
                                  '                        ' || project_name
                              ELSE
                                  '                                ' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                      t.parent_id   AS "parentId",--父级id（生成树父级id）
                      project_name    AS "orgName",--公司/项目
                        TO_CHAR(nvl(b.area_dt_all,0), 'fm999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
                        TO_CHAR(nvl(nvl(b.area_dt_all, 0),0), 'fm999,999,999,999,990.00') AS "targetSalesArea",--最新可售面积（不含车位）
                        (CASE WHEN b.obj_type='楼栋' THEN '-' ELSE TO_CHAR(nvl(nvl(c1.target_worth, 0),0), 'fm999,999,999,999,990.00') END)AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
                        (CASE WHEN b.obj_type='楼栋' THEN '-' ELSE TO_CHAR(nvl(nvl(c2.target_worth, 0),0), 'fm999,999,999,999,990.00') END) AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
                        TO_CHAR(nvl(nvl(c3.target_worth, 0),0), 'fm999,999,999,999,990.00') AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
                        TO_CHAR(nvl(nvl(c4.target_worth, 0),0), 'fm999,999,999,999,990.00') AS "targetNewestWorth",--目标总货值（A）-最新版(A)
                        TO_CHAR(nvl(b.value_dt_all / 10000,0), 'fm999,999,999,999,990.00') AS "dynamicTotalWorth",--动态总货值(B)
                       (CASE WHEN b.value_dt_all / 10000 - nvl(c4.target_worth, 0)<0 
                         THEN  '<font color=red>'||TO_CHAR(nvl(b.value_dt_all / 10000 - nvl(c4.target_worth, 0),0), 'fm999,999,999,999,990.00')||'</font>'
                         ELSE  '<font color=green>'||TO_CHAR(nvl(b.value_dt_all / 10000 - nvl(c4.target_worth, 0),0), 'fm999,999,999,999,990.00')||'</font>'
                         END  ) AS "dynamicTotalWorthDifference"
                        ,--总货值差额(B-A)
                          TO_CHAR(nvl((b.ZZ_value_reserve+b.SY_value_reserve) / 10000,0), 'fm999,999,999,999,990.00') AS "reserveTotalWorth",----动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1) 20200101 修正字段reserveWorth=》reserveTotalWorth
                          TO_CHAR(nvl((b.ZZ_value_in_process+b.SY_value_in_process) / 10000,0), 'fm999,999,999,999,990.00') AS "inProcessTotalWorth",--在途货值(B2)
                          TO_CHAR(nvl((b.ZZ_value_stock+b.SY_value_stock)/10000 ,0), 'fm999,999,999,999,990.00') AS "stockWorth",--库存货值(B3)
                          TO_CHAR(nvl((b.ZZ_value_haved_sale+b.SY_value_haved_sale) / 10000,0), 'fm999,999,999,999,990.00') AS "alreadySalesWorth",--已售货值(B4)
                          TO_CHAR(nvl((b.ZZ_value_remain+b.SY_value_remain) / 10000,0), 'fm999,999,999,999,990.00') AS "residueWorth",--剩余货值(C=B1+B2+B3)
                          TO_CHAR(nvl((b.ZZ_value_stock + b.ZZ_value_haved_sale+b.SY_value_stock + b.SY_value_haved_sale) / 10000,0), 'fm999,999,999,999,990.00') AS "getWorth",--已领证货值(D=B3+B4)
                          (
                              CASE
                                  WHEN (b.ZZ_value_stock + b.ZZ_value_haved_sale+b.SY_value_stock + b.SY_value_haved_sale ) = 0 THEN
                                      '-'
                                  ELSE
                                      TO_CHAR(nvl((b.ZZ_value_haved_sale+b.SY_value_haved_sale) /(b.ZZ_value_stock + b.ZZ_value_haved_sale+b.SY_value_stock + b.SY_value_haved_sale) * 100,0), 'fm999,999,999,999,990.00'
                                      )
                                      || '%'
                              END
                          ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(nvl((b.ZZ_value_not_planning_permit+b.SY_value_not_planning_permit) / 10000,0), 'fm999,999,999,999,990.00') AS "noPlanningPermitObtainedPhase",--F、动态货值的各阶段分布-F0未取规证
                          TO_CHAR(nvl((b.ZZ_value_not_construction_per+b.SY_value_not_construction_per) / 10000,0), 'fm999,999,999,999,990.00') AS "planningPermitObtainedOhase",--F、动态货值的各阶段分布-F1规划许可证阶段
                          TO_CHAR(nvl((b.ZZ_value_not_sale_permit+b.SY_value_not_sale_permit) / 10000,0), 'fm999,999,999,999,990.00') AS "constructionPermitOhase",--F、动态货值的各阶段分布-F2施工许可证阶段
                          TO_CHAR(nvl((b.ZZ_value_not_completion+b.SY_value_not_completion) / 10000,0), 'fm999,999,999,999,990.00') AS "PreSalePermitPhase",--F、动态货值的各阶段分布-F3预售许可证阶段
                          --TO_CHAR(nvl(b.value_yes_completion / 10000,0), 'fm999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          TO_CHAR(nvl((b.ZZ_value_yes_completion+b.SY_value_yes_completion) / 10000,0), 'fm999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          '-' AS "carryDownPhase",--F、动态货值的各阶段分布-F5结转阶段

                          TO_CHAR(nvl((b.ZZ_value_reserve +b.SY_value_reserve )/ 10000,0), 'fm999,999,999,999,990.00') AS "reserveWorth",--G1、储备货值的量价情况-货值（G1=a1*b1）
                          TO_CHAR(nvl((b.zz_area_reserve+b.SY_area_reserve),0), 'fm999,999,999,999,990.00') AS "reserveCargo",--G1、储备货值的量价情况-货量(a1)
                          (CASE WHEN (b.zz_area_reserve+b.SY_area_reserve)=0 THEN '-' ELSE TO_CHAR(nvl((b.ZZ_value_reserve +b.SY_value_reserve )/(b.zz_area_reserve+b.SY_area_reserve),0), 'fm999,,999,990.00') END) AS "reservePrice",--G1、储备货值的量价情况-单价(b1)
                          TO_CHAR(nvl((b.ZZ_value_in_process+b.SY_value_in_process) / 10000,0), 'fm999,999,999,999,990.00') AS "inTransitWorth",--G2、在途货值的量价情况-货值（G2=a2*b2）
                          TO_CHAR(nvl((b.zz_area_in_process+b.SY_area_in_process),0), 'fm999,999,999,999,990.00') AS "inTransitCargo",--G2、在途货值的量价情况-货量(a2)
                          (CASE WHEN (b.zz_area_in_process+b.SY_area_in_process)=0 THEN '-' 
                              ELSE TO_CHAR(nvl((b.ZZ_value_in_process+b.SY_value_in_process)/(b.zz_area_in_process+b.SY_area_in_process),0), 'fm999,,999,990.00') 
                            END) AS "inTransitPrice",--G2、在途货值的量价情况-单价(b2)
                          TO_CHAR(nvl((b.ZZ_value_stock+b.SY_value_stock) / 10000,0), 'fm999,999,999,999,990.00') AS "stockWorth",--G3、库存货值的量价情况-货值（G3=a3*b3）
                          TO_CHAR(nvl(b.ZZ_area_stock+b.SY_area_stock,0), 'fm999,999,999,999,990.00') AS "stockCargo",--G3、库存货值的量价情况-货量(a3)
                          (CASE WHEN (b.ZZ_area_stock+b.SY_area_stock)=0 THEN '-' 
                              ELSE TO_CHAR(nvl((b.ZZ_value_stock+b.SY_value_stock)/(b.ZZ_area_stock+b.SY_area_stock),0), 'fm999,,999,990.00') 
                            END) AS "stockPrice",--G3、库存货值的量价情况-单价(b3)
                          TO_CHAR(nvl((b.ZZ_value_haved_sale+b.SY_value_haved_sale) / 10000,0), 'fm999,999,999,999,990.00') AS "soldWorth",--G4、已售货值的量价情况-货值（G4=a4*b4）
                          TO_CHAR(nvl(b.zz_area_haved_sale+b.sy_area_haved_sale,0), 'fm999,999,999,999,990.00') AS "soldCargo",--G4、已售货值的量价情况-货量(a4)
                          (CASE WHEN (b.zz_area_haved_sale+b.sy_area_haved_sale)=0 THEN '-' 
                              ELSE TO_CHAR(nvl((b.ZZ_value_haved_sale+b.SY_value_haved_sale)/(b.zz_area_haved_sale+b.sy_area_haved_sale),0), 'fm999,,999,990.00') 
                            END) AS "soldPrice"--G4、已售货值的量价情况-单价(b4)
                  FROM
                      (
                          SELECT
                              id,
                              project_name,
                              '' AS parent_id,
                              sn AS order_code
                          FROM
                              sys_project
                          WHERE
                              id = ''
                                   || projectid
                                   || ''
                          UNION ALL
--分期
                          SELECT
                              id,
                              stage_name,
                              project_id AS parent_id,
                              lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                          FROM
                              sys_project_stage
                          WHERE
                              project_id = ''|| projectid|| '' AND stage_name<>'无分期'

                          UNION ALL
--楼栋
                          SELECT
                              mdm_build.id,
                              build_name,
                              (CASE WHEN mdm_period.period_name<>'无分期' THEN  period_id ELSE mdm_build.proj_id END)  AS parent_id,
                              lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                          FROM
                              mdm_build LEFT JOIN mdm_period ON mdm_build.period_id=mdm_period.id
                          WHERE
                              mdm_build.proj_id = ''
                                        || projectid
                                        || ''
                              AND build_state = 10--10已发布楼栋
                      ) t LEFT JOIN dwm_dt_value  b ON t.id= b.obj_id
                          LEFT JOIN dwm_target_worth c1 ON b.obj_id = c1.proj_id  AND c1.target_worth_phase = 0 and c1.IS_DELETE=0 
                               AND c1.approval_status IN ('已审核','审核中')
                          LEFT JOIN dwm_target_worth c2 ON b.obj_id = c2.proj_id AND c2.target_worth_phase = 10 and c2.IS_DELETE=0
                                AND c2.approval_status IN ('已审核','审核中')
                          LEFT JOIN dwm_target_worth c3 ON b.obj_id = c3.proj_id AND c3.target_worth_phase = 20 and c3.IS_DELETE=0
                               AND c3.approval_status IN ('已审核','审核中') AND c3.id IN (SELECT id FROM V_DWM_TARGET_WORTH_NOW)
                          LEFT JOIN v_dwm_target_worth_now c4 ON b.obj_id= c4.proj_id
                               AND c4.approval_status IN ('已审核','审核中')
                    START WITH
                          t.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR t.id = t.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(t.order_code, ','), 2);
    END IF;

    IF tabsindex = 3 THEN  
    OPEN info FOR SELECT
                      t.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                       level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '' || project_name
                              WHEN level = 2 THEN
                                  '        ' || project_name
                              WHEN level = 3 THEN
                                  '                ' || project_name
                              WHEN level = 4 THEN
                                  '                        ' || project_name
                              ELSE
                                  '                                ' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                      t.parent_id   AS "parentId",--父级id（生成树父级id）
                      project_name    AS "orgName",--公司/项目
                        TO_CHAR(nvl(b.area_dt_all,0), 'fm999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
                        TO_CHAR(nvl(nvl(b.area_dt_all, 0),0), 'fm999,999,999,999,990.00') AS "targetSalesArea",--最新可售面积（不含车位）
                        (CASE WHEN b.obj_type='楼栋' THEN '-' ELSE TO_CHAR(nvl(nvl(c1.target_worth, 0),0), 'fm999,999,999,999,990.00') END)AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
                        (CASE WHEN b.obj_type='楼栋' THEN '-' ELSE TO_CHAR(nvl(nvl(c2.target_worth, 0),0), 'fm999,999,999,999,990.00') END) AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
                        TO_CHAR(nvl(nvl(c3.target_worth, 0),0), 'fm999,999,999,999,990.00') AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
                        TO_CHAR(nvl(nvl(c4.target_worth, 0),0), 'fm999,999,999,999,990.00') AS "targetNewestWorth",--目标总货值（A）-最新版(A)
                        TO_CHAR(nvl(b.value_dt_all / 10000,0), 'fm999,999,999,999,990.00') AS "dynamicTotalWorth",--动态总货值(B)
                       (CASE WHEN b.value_dt_all / 10000 - nvl(c4.target_worth, 0)<0 
                         THEN  '<font color=red>'||TO_CHAR(nvl(b.value_dt_all / 10000 - nvl(c4.target_worth, 0),0), 'fm999,999,999,999,990.00')||'</font>'
                         ELSE  '<font color=green>'||TO_CHAR(nvl(b.value_dt_all / 10000 - nvl(c4.target_worth, 0),0), 'fm999,999,999,999,990.00')||'</font>'
                         END  ) AS "dynamicTotalWorthDifference"
                        ,--总货值差额(B-A)
                          TO_CHAR(nvl((b.ZZ_value_reserve) / 10000,0), 'fm999,999,999,999,990.00') AS "reserveTotalWorth",----动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
                          TO_CHAR(nvl((b.ZZ_value_in_process) / 10000,0), 'fm999,999,999,999,990.00') AS "inProcessTotalWorth",--在途货值(B2)
                          TO_CHAR(nvl((b.ZZ_value_stock)/10000 ,0), 'fm999,999,999,999,990.00') AS "stockWorth",--库存货值(B3)
                          TO_CHAR(nvl((b.ZZ_value_haved_sale) / 10000,0), 'fm999,999,999,999,990.00') AS "alreadySalesWorth",--已售货值(B4)
                          TO_CHAR(nvl((b.ZZ_value_remain) / 10000,0), 'fm999,999,999,999,990.00') AS "residueWorth",--剩余货值(C=B1+B2+B3)
                          TO_CHAR(nvl((b.ZZ_value_stock + b.ZZ_value_haved_sale) / 10000,0), 'fm999,999,999,999,990.00') AS "getWorth",--已领证货值(D=B3+B4)
                          (
                              CASE
                                  WHEN (b.ZZ_value_stock + b.ZZ_value_haved_sale) = 0 THEN
                                      '-'
                                  ELSE
                                      TO_CHAR(nvl((b.ZZ_value_haved_sale) /(b.ZZ_value_stock + b.ZZ_value_haved_sale) * 100,0), 'fm999,999,999,999,990.00'
                                      )
                                      || '%'
                              END
                          ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(nvl((b.ZZ_value_not_planning_permit) / 10000,0), 'fm999,999,999,999,990.00') AS "noPlanningPermitObtainedPhase",--F、动态货值的各阶段分布-F0未取规证
                          TO_CHAR(nvl((b.ZZ_value_not_construction_per) / 10000,0), 'fm999,999,999,999,990.00') AS "planningPermitObtainedOhase",--F、动态货值的各阶段分布-F1规划许可证阶段
                          TO_CHAR(nvl((b.ZZ_value_not_sale_permit) / 10000,0), 'fm999,999,999,999,990.00') AS "constructionPermitOhase",--F、动态货值的各阶段分布-F2施工许可证阶段
                          TO_CHAR(nvl((b.ZZ_value_not_completion) / 10000,0), 'fm999,999,999,999,990.00') AS "PreSalePermitPhase",--F、动态货值的各阶段分布-F3预售许可证阶段
                          --TO_CHAR(nvl(b.value_yes_completion / 10000,0), 'fm999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          TO_CHAR(nvl((b.ZZ_value_yes_completion) / 10000,0), 'fm999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          '-' AS "carryDownPhase",--F、动态货值的各阶段分布-F5结转阶段

                          TO_CHAR(nvl((b.ZZ_value_reserve)/ 10000,0), 'fm999,999,999,999,990.00') AS "reserveWorth",--G1、储备货值的量价情况-货值（G1=a1*b1）
                          TO_CHAR(nvl((b.zz_area_reserve),0), 'fm999,999,999,999,990.00') AS "reserveCargo",--G1、储备货值的量价情况-货量(a1)
                          (CASE WHEN (b.zz_area_reserve)=0 THEN '-' ELSE TO_CHAR(nvl((b.ZZ_value_reserve)/(b.zz_area_reserve),0), 'fm999,,999,990.00') END) AS "reservePrice",--G1、储备货值的量价情况-单价(b1)
                          TO_CHAR(nvl((b.ZZ_value_in_process) / 10000,0), 'fm999,999,999,999,990.00') AS "inTransitWorth",--G2、在途货值的量价情况-货值（G2=a2*b2）
                          TO_CHAR(nvl((b.zz_area_in_process),0), 'fm999,999,999,999,990.00') AS "inTransitCargo",--G2、在途货值的量价情况-货量(a2)
                          (CASE WHEN (b.zz_area_in_process)=0 THEN '-' 
                              ELSE TO_CHAR(nvl((b.ZZ_value_in_process)/(b.zz_area_in_process),0), 'fm999,,999,990.00') 
                            END) AS "inTransitPrice",--G2、在途货值的量价情况-单价(b2)
                          TO_CHAR(nvl((b.ZZ_value_stock) / 10000,0), 'fm999,999,999,999,990.00') AS "stockWorth",--G3、库存货值的量价情况-货值（G3=a3*b3）
                          TO_CHAR(nvl(b.ZZ_area_stock,0), 'fm999,999,999,999,990.00') AS "stockCargo",--G3、库存货值的量价情况-货量(a3)
                          (CASE WHEN (b.ZZ_area_stock)=0 THEN '-' 
                              ELSE TO_CHAR(nvl((b.ZZ_value_stock)/(b.ZZ_area_stock),0), 'fm999,,999,990.00') 
                            END) AS "stockPrice",--G3、库存货值的量价情况-单价(b3)
                          TO_CHAR(nvl((b.ZZ_value_haved_sale) / 10000,0), 'fm999,999,999,999,990.00') AS "soldWorth",--G4、已售货值的量价情况-货值（G4=a4*b4）
                          TO_CHAR(nvl(b.zz_area_haved_sale,0), 'fm999,999,999,999,990.00') AS "soldCargo",--G4、已售货值的量价情况-货量(a4)
                          (CASE WHEN (b.zz_area_haved_sale)=0 THEN '-' 
                              ELSE TO_CHAR(nvl((b.ZZ_value_haved_sale)/(b.zz_area_haved_sale),0), 'fm999,,999,990.00') 
                            END) AS "soldPrice"--G4、已售货值的量价情况-单价(b4)
                  FROM
                      (
                          SELECT
                              id,
                              project_name,
                              '' AS parent_id,
                              sn AS order_code
                          FROM
                              sys_project
                          WHERE
                              id = ''
                                   || projectid
                                   || ''
                          UNION ALL
--分期
                          SELECT
                              id,
                              stage_name,
                              project_id AS parent_id,
                              lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                          FROM
                              sys_project_stage
                          WHERE
                              project_id = ''|| projectid|| '' AND stage_name<>'无分期'

                          UNION ALL
--楼栋
                          SELECT
                              mdm_build.id,
                              build_name,
                              (CASE WHEN mdm_period.period_name<>'无分期' THEN  period_id ELSE mdm_build.proj_id END)  AS parent_id,
                              lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                          FROM
                              mdm_build LEFT JOIN mdm_period ON mdm_build.period_id=mdm_period.id
                          WHERE
                              mdm_build.proj_id = ''
                                        || projectid
                                        || ''
                              AND build_state = 10--10已发布楼栋
                      ) t LEFT JOIN dwm_dt_value  b ON t.id= b.obj_id
                          LEFT JOIN dwm_target_worth c1 ON b.obj_id = c1.proj_id  AND c1.target_worth_phase = 0 and c1.IS_DELETE=0 
                               AND c1.approval_status IN ('已审核','审核中')
                          LEFT JOIN dwm_target_worth c2 ON b.obj_id = c2.proj_id AND c2.target_worth_phase = 10 and c2.IS_DELETE=0
                                AND c2.approval_status IN ('已审核','审核中')
                          LEFT JOIN dwm_target_worth c3 ON b.obj_id = c3.proj_id AND c3.target_worth_phase = 20 and c3.IS_DELETE=0
                               AND c3.approval_status IN ('已审核','审核中') AND c3.id IN (SELECT id FROM V_DWM_TARGET_WORTH_NOW)
                          LEFT JOIN v_dwm_target_worth_now c4 ON b.obj_id= c4.proj_id
                               AND c4.approval_status IN ('已审核','审核中')
                    START WITH
                          t.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR t.id = t.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(t.order_code, ','), 2);
    END IF;

    IF tabsindex = 4 THEN  
    OPEN info FOR SELECT
                      t.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                       level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '' || project_name
                              WHEN level = 2 THEN
                                  '        ' || project_name
                              WHEN level = 3 THEN
                                  '                ' || project_name
                              WHEN level = 4 THEN
                                  '                        ' || project_name
                              ELSE
                                  '                                ' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                      t.parent_id   AS "parentId",--父级id（生成树父级id）
                      project_name    AS "orgName",--公司/项目
                        TO_CHAR(nvl(b.area_dt_all,0), 'fm999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
                        TO_CHAR(nvl(nvl(b.area_dt_all, 0),0), 'fm999,999,999,999,990.00') AS "targetSalesArea",--最新可售面积（不含车位）
                        (CASE WHEN b.obj_type='楼栋' THEN '-' ELSE TO_CHAR(nvl(nvl(c1.target_worth, 0),0), 'fm999,999,999,999,990.00') END)AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
                        (CASE WHEN b.obj_type='楼栋' THEN '-' ELSE TO_CHAR(nvl(nvl(c2.target_worth, 0),0), 'fm999,999,999,999,990.00') END) AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
                        TO_CHAR(nvl(nvl(c3.target_worth, 0),0), 'fm999,999,999,999,990.00') AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
                        TO_CHAR(nvl(nvl(c4.target_worth, 0),0), 'fm999,999,999,999,990.00') AS "targetNewestWorth",--目标总货值（A）-最新版(A)
                        TO_CHAR(nvl(b.value_dt_all / 10000,0), 'fm999,999,999,999,990.00') AS "dynamicTotalWorth",--动态总货值(B)
                       (CASE WHEN b.value_dt_all / 10000 - nvl(c4.target_worth, 0)<0 
                         THEN  '<font color=red>'||TO_CHAR(nvl(b.value_dt_all / 10000 - nvl(c4.target_worth, 0),0), 'fm999,999,999,999,990.00')||'</font>'
                         ELSE  '<font color=green>'||TO_CHAR(nvl(b.value_dt_all / 10000 - nvl(c4.target_worth, 0),0), 'fm999,999,999,999,990.00')||'</font>'
                         END  ) AS "dynamicTotalWorthDifference"
                        ,--总货值差额(B-A)
                          TO_CHAR(nvl((b.SY_value_reserve) / 10000,0), 'fm999,999,999,999,990.00') AS "reserveTotalWorth",----动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
                          TO_CHAR(nvl((b.SY_value_in_process) / 10000,0), 'fm999,999,999,999,990.00') AS "inProcessTotalWorth",--在途货值(B2)
                          TO_CHAR(nvl((b.SY_value_stock)/10000 ,0), 'fm999,999,999,999,990.00') AS "stockWorth",--库存货值(B3)
                          TO_CHAR(nvl((b.SY_value_haved_sale) / 10000,0), 'fm999,999,999,999,990.00') AS "alreadySalesWorth",--已售货值(B4)
                          TO_CHAR(nvl((b.SY_value_remain) / 10000,0), 'fm999,999,999,999,990.00') AS "residueWorth",--剩余货值(C=B1+B2+B3)
                          TO_CHAR(nvl((b.SY_value_stock + b.SY_value_haved_sale) / 10000,0), 'fm999,999,999,999,990.00') AS "getWorth",--已领证货值(D=B3+B4)
                          (
                              CASE
                                  WHEN (b.SY_value_stock + b.SY_value_haved_sale ) = 0 THEN
                                      '-'
                                  ELSE
                                      TO_CHAR(nvl((b.SY_value_haved_sale) /(b.SY_value_stock + b.SY_value_haved_sale) * 100,0), 'fm999,999,999,999,990.00'
                                      )
                                      || '%'
                              END
                          ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(nvl((b.SY_value_not_planning_permit) / 10000,0), 'fm999,999,999,999,990.00') AS "noPlanningPermitObtainedPhase",--F、动态货值的各阶段分布-F0未取规证
                          TO_CHAR(nvl((b.SY_value_not_construction_per) / 10000,0), 'fm999,999,999,999,990.00') AS "planningPermitObtainedOhase",--F、动态货值的各阶段分布-F1规划许可证阶段
                          TO_CHAR(nvl((b.SY_value_not_sale_permit) / 10000,0), 'fm999,999,999,999,990.00') AS "constructionPermitOhase",--F、动态货值的各阶段分布-F2施工许可证阶段
                          TO_CHAR(nvl((b.SY_value_not_completion) / 10000,0), 'fm999,999,999,999,990.00') AS "PreSalePermitPhase",--F、动态货值的各阶段分布-F3预售许可证阶段
                          --TO_CHAR(nvl(b.value_yes_completion / 10000,0), 'fm999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          TO_CHAR(nvl((b.SY_value_yes_completion) / 10000,0), 'fm999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          '-' AS "carryDownPhase",--F、动态货值的各阶段分布-F5结转阶段

                          TO_CHAR(nvl((b.SY_value_reserve )/ 10000,0), 'fm999,999,999,999,990.00') AS "reserveWorth",--G1、储备货值的量价情况-货值（G1=a1*b1）
                          TO_CHAR(nvl((b.SY_area_reserve),0), 'fm999,999,999,999,990.00') AS "reserveCargo",--G1、储备货值的量价情况-货量(a1)
                          (CASE WHEN (b.SY_area_reserve)=0 THEN '-' ELSE TO_CHAR(nvl((b.SY_value_reserve )/(b.SY_area_reserve),0), 'fm999,,999,990.00') END) AS "reservePrice",--G1、储备货值的量价情况-单价(b1)
                          TO_CHAR(nvl((b.SY_value_in_process) / 10000,0), 'fm999,999,999,999,990.00') AS "inTransitWorth",--G2、在途货值的量价情况-货值（G2=a2*b2）
                          TO_CHAR(nvl((b.SY_area_in_process),0), 'fm999,999,999,999,990.00') AS "inTransitCargo",--G2、在途货值的量价情况-货量(a2)
                          (CASE WHEN (b.SY_area_in_process)=0 THEN '-' 
                              ELSE TO_CHAR(nvl((b.SY_value_in_process)/(b.SY_area_in_process),0), 'fm999,,999,990.00') 
                            END) AS "inTransitPrice",--G2、在途货值的量价情况-单价(b2)
                          TO_CHAR(nvl((b.SY_value_stock) / 10000,0), 'fm999,999,999,999,990.00') AS "stockWorth",--G3、库存货值的量价情况-货值（G3=a3*b3）
                          TO_CHAR(nvl(b.SY_area_stock,0), 'fm999,999,999,999,990.00') AS "stockCargo",--G3、库存货值的量价情况-货量(a3)
                          (CASE WHEN (b.SY_area_stock)=0 THEN '-' 
                              ELSE TO_CHAR(nvl((b.SY_value_stock)/(b.SY_area_stock),0), 'fm999,,999,990.00') 
                            END) AS "stockPrice",--G3、库存货值的量价情况-单价(b3)
                          TO_CHAR(nvl((b.SY_value_haved_sale) / 10000,0), 'fm999,999,999,999,990.00') AS "soldWorth",--G4、已售货值的量价情况-货值（G4=a4*b4）
                          TO_CHAR(nvl(b.sy_area_haved_sale,0), 'fm999,999,999,999,990.00') AS "soldCargo",--G4、已售货值的量价情况-货量(a4)
                          (CASE WHEN (b.sy_area_haved_sale)=0 THEN '-' 
                              ELSE TO_CHAR(nvl((b.SY_value_haved_sale)/(b.sy_area_haved_sale),0), 'fm999,,999,990.00') 
                            END) AS "soldPrice"--G4、已售货值的量价情况-单价(b4)
                  FROM
                      (
                          SELECT
                              id,
                              project_name,
                              '' AS parent_id,
                              sn AS order_code
                          FROM
                              sys_project
                          WHERE
                              id = ''
                                   || projectid
                                   || ''
                          UNION ALL
--分期
                          SELECT
                              id,
                              stage_name,
                              project_id AS parent_id,
                              lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                          FROM
                              sys_project_stage
                          WHERE
                              project_id = ''|| projectid|| '' AND stage_name<>'无分期'

                          UNION ALL
--楼栋
                          SELECT
                              mdm_build.id,
                              build_name,
                              (CASE WHEN mdm_period.period_name<>'无分期' THEN  period_id ELSE mdm_build.proj_id END)  AS parent_id,
                              lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                          FROM
                              mdm_build LEFT JOIN mdm_period ON mdm_build.period_id=mdm_period.id
                          WHERE
                              mdm_build.proj_id = ''
                                        || projectid
                                        || ''
                              AND build_state = 10--10已发布楼栋
                      ) t LEFT JOIN dwm_dt_value  b ON t.id= b.obj_id
                          LEFT JOIN dwm_target_worth c1 ON b.obj_id = c1.proj_id  AND c1.target_worth_phase = 0 and c1.IS_DELETE=0 
                               AND c1.approval_status IN ('已审核','审核中')
                          LEFT JOIN dwm_target_worth c2 ON b.obj_id = c2.proj_id AND c2.target_worth_phase = 10 and c2.IS_DELETE=0
                                AND c2.approval_status IN ('已审核','审核中')
                          LEFT JOIN dwm_target_worth c3 ON b.obj_id = c3.proj_id AND c3.target_worth_phase = 20 and c3.IS_DELETE=0
                               AND c3.approval_status IN ('已审核','审核中') AND c3.id IN (SELECT id FROM V_DWM_TARGET_WORTH_NOW)
                          LEFT JOIN v_dwm_target_worth_now c4 ON b.obj_id= c4.proj_id
                               AND c4.approval_status IN ('已审核','审核中')
                    START WITH
                          t.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR t.id = t.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(t.order_code, ','), 2);
    END IF;

    IF tabsindex = 5 THEN  
    OPEN info FOR SELECT
                      t.id          AS "id",--主键id（生成树的id，唯一可以是业务id）
                       level,
                          CASE
                              WHEN level = 1 THEN
                                  '#eaf6ff'
                              WHEN level = 2 THEN
                                  '#ecfbee'
                              WHEN level = 3 THEN
                                  '#f2eed4'
                              ELSE
                                  ''
                          END AS "excelRowBgColor",--数据行导出excel背景色
                          CASE
                              WHEN level = 1 THEN
                                  '' || project_name
                              WHEN level = 2 THEN
                                  '        ' || project_name
                              WHEN level = 3 THEN
                                  '                ' || project_name
                              WHEN level = 4 THEN
                                  '                        ' || project_name
                              ELSE
                                  '                                ' || project_name
                          END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                      t.parent_id   AS "parentId",--父级id（生成树父级id）
                      project_name    AS "orgName",--公司/项目
                        TO_CHAR(nvl(b.area_dt_all,0), 'fm999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
                        TO_CHAR(nvl(nvl(b.area_dt_all, 0),0), 'fm999,999,999,999,990.00') AS "targetSalesArea",--最新可售面积（不含车位）
                        (CASE WHEN b.obj_type='楼栋' THEN '-' ELSE TO_CHAR(nvl(nvl(c1.target_worth, 0),0), 'fm999,999,999,999,990.00') END)AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
                        (CASE WHEN b.obj_type='楼栋' THEN '-' ELSE TO_CHAR(nvl(nvl(c2.target_worth, 0),0), 'fm999,999,999,999,990.00') END) AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
                        TO_CHAR(nvl(nvl(c3.target_worth, 0),0), 'fm999,999,999,999,990.00') AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
                        TO_CHAR(nvl(nvl(c4.target_worth, 0),0), 'fm999,999,999,999,990.00') AS "targetNewestWorth",--目标总货值（A）-最新版(A)
                        TO_CHAR(nvl(b.value_dt_all / 10000,0), 'fm999,999,999,999,990.00') AS "dynamicTotalWorth",--动态总货值(B)
                       (CASE WHEN b.value_dt_all / 10000 - nvl(c4.target_worth, 0)<0 
                         THEN  '<font color=red>'||TO_CHAR(nvl(b.value_dt_all / 10000 - nvl(c4.target_worth, 0),0), 'fm999,999,999,999,990.00')||'</font>'
                         ELSE  '<font color=green>'||TO_CHAR(nvl(b.value_dt_all / 10000 - nvl(c4.target_worth, 0),0), 'fm999,999,999,999,990.00')||'</font>'
                         END  ) AS "dynamicTotalWorthDifference"
                        ,--总货值差额(B-A)
                          TO_CHAR(nvl((b.CW_value_reserve) / 10000,0), 'fm999,999,999,999,990.00') AS "reserveTotalWorth",----动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
                          TO_CHAR(nvl((b.CW_value_in_process) / 10000,0), 'fm999,999,999,999,990.00') AS "inProcessTotalWorth",--在途货值(B2)
                          TO_CHAR(nvl((b.CW_value_stock)/10000 ,0), 'fm999,999,999,999,990.00') AS "stockWorth",--库存货值(B3)
                          TO_CHAR(nvl((b.CW_value_haved_sale) / 10000,0), 'fm999,999,999,999,990.00') AS "alreadySalesWorth",--已售货值(B4)
                          TO_CHAR(nvl((b.CW_value_remain) / 10000,0), 'fm999,999,999,999,990.00') AS "residueWorth",--剩余货值(C=B1+B2+B3)
                          TO_CHAR(nvl((b.CW_value_stock + b.CW_value_haved_sale) / 10000,0), 'fm999,999,999,999,990.00') AS "getWorth",--已领证货值(D=B3+B4)
                          (
                              CASE
                                  WHEN (b.CW_value_stock + b.CW_value_haved_sale ) = 0 THEN
                                      '-'
                                  ELSE
                                      TO_CHAR(nvl((b.CW_value_haved_sale) /(b.CW_value_stock + b.CW_value_haved_sale) * 100,0), 'fm999,999,999,999,990.00'
                                      )
                                      || '%'
                              END
                          ) AS "salesRate",--去化率(E=B4/D)
                          TO_CHAR(nvl((b.CW_value_not_planning_permit) / 10000,0), 'fm999,999,999,999,990.00') AS "noPlanningPermitObtainedPhase",--F、动态货值的各阶段分布-F0未取规证
                          TO_CHAR(nvl((b.CW_value_not_construction_per) / 10000,0), 'fm999,999,999,999,990.00') AS "planningPermitObtainedOhase",--F、动态货值的各阶段分布-F1规划许可证阶段
                          TO_CHAR(nvl((b.CW_value_not_sale_permit) / 10000,0), 'fm999,999,999,999,990.00') AS "constructionPermitOhase",--F、动态货值的各阶段分布-F2施工许可证阶段
                          TO_CHAR(nvl((b.CW_value_not_completion) / 10000,0), 'fm999,999,999,999,990.00') AS "PreSalePermitPhase",--F、动态货值的各阶段分布-F3预售许可证阶段
                          --TO_CHAR(nvl(b.value_yes_completion / 10000,0), 'fm999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          TO_CHAR(nvl((b.CW_value_yes_completion) / 10000,0), 'fm999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
                          '-' AS "carryDownPhase",--F、动态货值的各阶段分布-F5结转阶段

                          TO_CHAR(nvl((b.CW_value_reserve )/ 10000,0), 'fm999,999,999,999,990.00') AS "reserveWorth",--G1、储备货值的量价情况-货值（G1=a1*b1）
                          TO_CHAR(nvl((b.CW_area_reserve),0), 'fm999,999,999,999,999') AS "reserveCargo",--G1、储备货值的量价情况-货量(a1)
                          (CASE WHEN (b.CW_area_reserve)=0 THEN '-' ELSE TO_CHAR(nvl((b.CW_value_reserve)/(b.CW_area_reserve),0), 'fm999,,999,990.00') END) AS "reservePrice",--G1、储备货值的量价情况-单价(b1)
                          TO_CHAR(nvl((b.CW_value_in_process) / 10000,0), 'fm999,999,999,999,990.00') AS "inTransitWorth",--G2、在途货值的量价情况-货值（G2=a2*b2）
                          TO_CHAR(nvl((b.CW_area_in_process),0), 'fm999,999,999,999,999') AS "inTransitCargo",--G2、在途货值的量价情况-货量(a2)
                          (CASE WHEN (b.CW_area_in_process)=0 THEN '-' 
                              ELSE TO_CHAR(nvl((b.CW_value_in_process)/(b.CW_area_in_process),0), 'fm999,,999,990.00') 
                            END) AS "inTransitPrice",--G2、在途货值的量价情况-单价(b2)
                          TO_CHAR(nvl((b.CW_value_stock) / 10000,0), 'fm999,999,999,999,990.00') AS "stockWorth",--G3、库存货值的量价情况-货值（G3=a3*b3）
                          TO_CHAR(nvl(b.CW_area_stock,0), 'fm999,999,999,999,999') AS "stockCargo",--G3、库存货值的量价情况-货量(a3)
                          (CASE WHEN (b.CW_area_stock)=0 THEN '-' 
                              ELSE TO_CHAR(nvl((b.CW_value_stock)/(b.CW_area_stock),0), 'fm999,,999,990.00') 
                            END) AS "stockPrice",--G3、库存货值的量价情况-单价(b3)
                          TO_CHAR(nvl((b.CW_value_haved_sale) / 10000,0), 'fm999,999,999,999,990.00') AS "soldWorth",--G4、已售货值的量价情况-货值（G4=a4*b4）
                          TO_CHAR(nvl(b.CW_area_haved_sale,0), 'fm999,999,999,999,999') AS "soldCargo",--G4、已售货值的量价情况-货量(a4)
                          (CASE WHEN (b.CW_area_haved_sale)=0 THEN '-' 
                              ELSE TO_CHAR(nvl((b.CW_value_haved_sale)/(b.CW_area_haved_sale),0), 'fm999,,999,990.00') 
                            END) AS "soldPrice"--G4、已售货值的量价情况-单价(b4)
                  FROM
                      (
                          SELECT
                              id,
                              project_name,
                              '' AS parent_id,
                              sn AS order_code
                          FROM
                              sys_project
                          WHERE
                              id = ''
                                   || projectid
                                   || ''
                          UNION ALL
--分期
                          SELECT
                              id,
                              stage_name,
                              project_id AS parent_id,
                              lpad(regexp_substr(stage_name, '[0-9]+'), 9, '0') AS order_code
                          FROM
                              sys_project_stage
                          WHERE
                              project_id = ''|| projectid|| '' AND stage_name<>'无分期'

                          UNION ALL
--楼栋
                          SELECT
                              mdm_build.id,
                              build_name,
                              (CASE WHEN mdm_period.period_name<>'无分期' THEN  period_id ELSE mdm_build.proj_id END)  AS parent_id,
                              lpad(regexp_substr(build_name, '[0-9]+'), 9, '0') AS order_code
                          FROM
                              mdm_build LEFT JOIN mdm_period ON mdm_build.period_id=mdm_period.id
                          WHERE
                              mdm_build.proj_id = ''
                                        || projectid
                                        || ''
                              AND build_state = 10--10已发布楼栋
                      ) t LEFT JOIN dwm_dt_value  b ON t.id= b.obj_id
                          LEFT JOIN dwm_target_worth c1 ON b.obj_id = c1.proj_id  AND c1.target_worth_phase = 0 and c1.IS_DELETE=0 
                               AND c1.approval_status IN ('已审核','审核中') 
                          LEFT JOIN dwm_target_worth c2 ON b.obj_id = c2.proj_id AND c2.target_worth_phase = 10 and c2.IS_DELETE=0 
                                AND c2.approval_status IN ('已审核','审核中') 
                          LEFT JOIN dwm_target_worth c3 ON b.obj_id = c3.proj_id AND c3.target_worth_phase = 20 and c3.IS_DELETE=0 and c3.IS_DELETE=0
                               AND c3.approval_status IN ('已审核','审核中') AND c3.id IN (SELECT id FROM V_DWM_TARGET_WORTH_NOW)
                          LEFT JOIN v_dwm_target_worth_now c4 ON b.obj_id= c4.proj_id
                               AND c4.approval_status IN ('已审核','审核中')
                  START WITH
                          t.id = ''
                                 || projectid
                                 || ''
                      CONNECT BY
                          PRIOR t.id = t.parent_id
                      ORDER BY
                          substr(sys_connect_by_path(t.order_code, ','), 2);
    END IF;

END p_dwm_dt_value_dtl;
/

prompt
prompt Creating procedure P_DWM_DT_VALUE_LIST
prompt ======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_DT_VALUE_LIST
(
		USERID       IN VARCHAR2 --当前用户id
	 ,STATIONID    IN VARCHAR2 --当前用户岗位id
	 ,DEPARTMENTID IN VARCHAR2 --当前用户部门id
	 ,COMPANYID    IN VARCHAR2 --当前用户公司id
	 ,UNITID       IN VARCHAR2 --选择公司id
	 ,ISOPERATE    IN VARCHAR2 --是否操盘
	 ,TABSINDEX    IN INT --选择选项卡。1开始
	 ,INFO         OUT SYS_REFCURSOR
) AS
		--动态货值管理-全案动态货值-主列表
		--作者：陈丽
		--日期：2019/12/17
		DATA_AUTH_SPID VARCHAR2(200);
		BIZCODE        VARCHAR2(200);
        IS_P_OPERATE VARCHAR2(200);
         unitid_val       VARCHAR2(200);
BEGIN
		unitid_val:=nvl(UNITID,'003200000000000000000000000000');
        --权限编码
		BIZCODE := 'DWM.DTHZGL.03';
		P_SYS_GET_COMPANY_PROJ_SPID(USERID         => USERID,
																STATIONID      => STATIONID,
																DEPTID         => DEPARTMENTID,
																COMPANYID      => COMPANYID,
																BIZCODE        => BIZCODE,
																DATA_AUTH_SPID => DATA_AUTH_SPID);

		IF TABSINDEX = 1 THEN
				DBMS_OUTPUT.PUT_LINE('所有业态!');
		ELSIF TABSINDEX = 2 THEN
				DBMS_OUTPUT.PUT_LINE('住宅及商办!');
		ELSIF TABSINDEX = 3 THEN
				DBMS_OUTPUT.PUT_LINE('住宅!');
		ELSIF TABSINDEX = 4 THEN
				DBMS_OUTPUT.PUT_LINE('商办!');
		ELSIF TABSINDEX = 5 THEN
				DBMS_OUTPUT.PUT_LINE('车位!');
		ELSIF TABSINDEX = 6 THEN
				DBMS_OUTPUT.PUT_LINE('剩余货值表!');
				OPEN INFO FOR
						WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   MDM_PROJECT A1  
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
            SELECT A.ID AS "id",
                   --主键id（生成树的id，唯一可以是业务id）
                   A.PARENT_ID AS "parentId",
                   --父级id（生成树父级id）
                   CASE
                       WHEN A.IS_COMPANY = 0 THEN
                        '/dwm/value-manage/value-project/detail?code=value_dtl'||CHR(38)||'isOperate=' ||
                        A.PROJ_COOPERATE || CHR(38)||'projectId=' || A.ID ||CHR(38)||
                        'projectName=' || A.ORG_NAME || CHR(38)||'projectDate=' ||
                        A.TAKE_DATE ||CHR(38) ||'tabIndex=' || TABSINDEX ||CHR(38)||
                        'pageTitle=' || A.ORG_NAME --页面标题名称
                       ELSE
                        ''
                   END AS "openUrl",
                   --详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
                   CASE
                       WHEN A.IS_COMPANY = 0 THEN
                        '/dwm/value-manage/dynamic-volume/circular?companyId=' ||
                        A.PARENT_ID ||CHR(38) ||'projectId=' || A.ID || CHR(38)||'type=2' --companyId加载项目的公司id，项目id：默认选中的项目id，type：货值是1，货值是2
                       ELSE
                        ''
                   END AS "openVisualUrl",
                   --打开可视化地址
                   ORG_LEVEL,
                   CASE
                       WHEN ORG_LEVEL = 1 THEN
                        '#eaf6ff'
                       WHEN ORG_LEVEL = 2 THEN
                        '#ecfbee'
                       WHEN ORG_LEVEL = 3 THEN
                        '#f2eed4'
                       ELSE
                        ''
                   END AS "excelRowBgColor",
                   --数据行导出excel背景色
                   CASE
                       WHEN ORG_LEVEL = 1 THEN
                        '' || ORG_NAME
                       WHEN ORG_LEVEL = 2 THEN
                        '        ' || ORG_NAME
                       WHEN ORG_LEVEL = 3 THEN
                        '                ' || ORG_NAME
                       WHEN ORG_LEVEL = 4 THEN
                        '                        ' || ORG_NAME
                       ELSE
                        '                                ' || ORG_NAME
                   END AS "excelRowTextTreeOrgName",--文本前面加空格模仿树
                   A.ORG_NAME AS "orgName",--公司/项目
                   TO_CHAR(NVL(ROUND( SUM(A.ZZ_VALUE_REMAIN) / 10000, 2),0),'FM999,999,999,990.00') AS "projWholeDwellingValue",--项目全案剩余可售货值（S=A+B+C+D）-住宅(m2)
                   TO_CHAR(NVL(ROUND( SUM(A.SY_VALUE_REMAIN) / 10000, 2),0),'FM999,999,999,990.00') AS "projWholeBusinessValue",--项目全案剩余可售货值（S=A+B+C+D）-商业(m2)
                   TO_CHAR(NVL(ROUND( SUM(A.CW_VALUE_REMAIN) / 10000, 2),0),'FM999,999,999,990.00') AS "projWholeCarportValue",--项目全案剩余可售货值（S=A+B+C+D）-车位(个)
                   TO_CHAR(NVL(ROUND(( SUM(A.ZZ_VALUE_REMAIN)+SUM(A.CW_VALUE_REMAIN)+SUM(A.SY_VALUE_REMAIN)) / 10000,2),0),'FM999,999,999,990.00') AS "projWholeTotalValue",
                   --项目全案剩余可售货值（S=A+B+C+D）-合计(m2)

                   TO_CHAR(NVL(ROUND( SUM(A.ZZ_VALUE_NOT_PLANNING_PERMIT),0) / 10000, 2),'FM999,999,999,990.00') AS "ADwellingValue",--A未取规证的可售货值-住宅(m2)
                   TO_CHAR(NVL(ROUND( SUM(A.SY_VALUE_NOT_PLANNING_PERMIT),0) / 10000, 2),'FM999,999,999,990.00') AS "ABusinessValue",--A未取规证的可售货值-商业(m2)
                   TO_CHAR(NVL(ROUND( SUM(A.CW_VALUE_NOT_PLANNING_PERMIT),0) / 10000, 2),'FM999,999,999,990.00') AS "ACarportValue",--A未取规证的可售货值-车位(个)
                   TO_CHAR(NVL(ROUND((SUM(A.ZZ_VALUE_NOT_PLANNING_PERMIT)+SUM(A.CW_VALUE_NOT_PLANNING_PERMIT)+SUM(A.SY_VALUE_NOT_PLANNING_PERMIT)),0) / 10000,2),'FM999,999,999,990.00') AS "ATotalValue",--A未取规证的可售货值-合计(m2)
                   TO_CHAR(ROUND( NVL(SUM(A.ZZ_VALUE_NOT_CONSTRUCTION_PER),0) / 10000, 2),'FM999,999,999,990.00') AS "BDwellingValue",--B已取规证未取施工证的可售货值-住宅(m2)
                   TO_CHAR(ROUND(NVL(SUM(A.SY_VALUE_NOT_CONSTRUCTION_PER) / 10000, 2),0),'FM999,999,999,990.00') AS "BBusinessValue",--B已取规证未取施工证的可售货值-商业(m2)
                   TO_CHAR(ROUND(NVL(SUM(A.CW_VALUE_NOT_CONSTRUCTION_PER) / 10000, 2),0),'FM999,999,999,990.00') AS "BCarportValue",--B已取规证未取施工证的可售货值-车位(个)
                   TO_CHAR(NVL(ROUND((SUM(A.ZZ_VALUE_NOT_CONSTRUCTION_PER)+SUM(A.SY_VALUE_NOT_CONSTRUCTION_PER) + SUM(A.CW_VALUE_NOT_CONSTRUCTION_PER))/ 10000,2),0),'FM999,999,999,990.00') AS "BTotalValue",--B已取规证未取施工证的可售货值-合计(m2)

                   TO_CHAR(NVL(ROUND(SUM(A.ZZ_VALUE_NOT_SALE_PERMIT),0) / 10000, 2),'FM999,999,999,990.00') AS "CDwellingValue",--C已取施工证未取预售证的可售货值-住宅(m2)
                   TO_CHAR(NVL(ROUND(SUM(A.SY_VALUE_NOT_SALE_PERMIT),0) / 10000, 2),'FM999,999,999,990.00') AS "CBusinessValue",--C已取施工证未取预售证的可售货值-商业(m2)
                   TO_CHAR(NVL(ROUND(SUM(A.CW_VALUE_NOT_SALE_PERMIT),0) / 10000, 2),'FM999,999,999,990.00') AS "CCarportValue",--C已取施工证未取预售证的可售货值-车位(个)
                   TO_CHAR(NVL(ROUND((SUM(A.ZZ_VALUE_NOT_SALE_PERMIT)+SUM(A.SY_VALUE_NOT_SALE_PERMIT)+SUM(A.CW_VALUE_NOT_SALE_PERMIT)) / 10000,2),0),'FM999,999,999,990.00') AS "CTotalValue",--C已取施工证未取预售证的可售货值-合计(m2)

                   TO_CHAR(NVL(ROUND( SUM(A.ZZ_VALUE_STOCK) / 10000, 2),0),'FM999,999,999,990.00') AS "DDwellingValue",--D已取预售证未售的可售货值-住宅(m2)
                   TO_CHAR(NVL(ROUND(SUM(A.SY_VALUE_STOCK) / 10000, 2),0),'FM999,999,999,990.00') AS "DBusinessValue",--D已取预售证未售的可售货值-商业(m2)
                   TO_CHAR(NVL(ROUND(SUM(A.CW_VALUE_STOCK) / 10000, 2),0),'FM999,999,999,990.00') AS "DCarportValue",--D已取预售证未售的可售货值-车位(个)
                   TO_CHAR(NVL(ROUND((SUM(A.ZZ_VALUE_STOCK)+SUM(A.SY_VALUE_STOCK)+SUM(A.CW_VALUE_STOCK)) / 10000,2),0),'FM999,999,999,990.00') AS "DTotalValue" --D已取预售证未售的可售货值-合计(m2)
            FROM   TEMP_DT_VALUE A
            INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
            --WHERE  a.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END)
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE order by ORDER_HIERARCHY_CODE;

		END IF;

		IF TABSINDEX = 1   THEN
				OPEN INFO FOR
				WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   MDM_PROJECT A1
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
						SELECT A.ID AS "id",
									 --主键id（生成树的id，唯一可以是业务id）
									 A.PARENT_ID AS "parentId",
									 --父级id（生成树父级id）
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/value-project/detail?code=value_dtl&isOperate=' ||
												 A.PROJ_COOPERATE || '&projectId=' || A.ID || '&projectName=' ||
												 A.ORG_NAME || '&projectDate=' || A.TAKE_DATE || '&tabIndex=' ||
												 TABSINDEX || '&pageTitle=' || A.ORG_NAME --页面标题名称
												ELSE
												 ''
										END) AS "openUrl",
									 --详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/dynamic-volume/circular?companyId=' || A.PARENT_ID ||
												 '&projectId=' || A.ID || '&type=2' --companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
												ELSE
												 ''
										END) AS "openVisualUrl",
									 --打开可视化地址
									 ORG_LEVEL,
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '#eaf6ff'
												WHEN ORG_LEVEL = 2 THEN
												 '#ecfbee'
												WHEN ORG_LEVEL = 3 THEN
												 '#f2eed4'
												ELSE
												 ''
										END AS "excelRowBgColor",
									 --数据行导出excel背景色
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '' || ORG_NAME
												WHEN ORG_LEVEL = 2 THEN
												 '        ' || ORG_NAME
												WHEN ORG_LEVEL = 3 THEN
												 '                ' || ORG_NAME
												WHEN ORG_LEVEL = 4 THEN
												 '                        ' || ORG_NAME
												ELSE
												 '                                ' || ORG_NAME
										END AS "excelRowTextTreeOrgName",
									 --文本前面加空格模仿树
									 A.ORG_NAME AS "orgName",--公司/项目
									 --TO_CHAR(b.area_dt_all, '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
									 TO_CHAR( NVL(SUM(A.AREA_DT_ALL),0), '999,999,999,999,990.00') AS "targetSalesArea",--最新可售面积（不含车位）
									 TO_CHAR(NVL(SUM(A.TARGET_A1_VALUE),0),'999,999,999,999,990.00') AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
									 TO_CHAR( NVL(SUM(A.TARGET_A2_VALUE),0),'999,999,999,999,990.00') AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
									 TO_CHAR( NVL(SUM(A.TARGET_A3_VALUE),0),'999,999,999,999,990.00') AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
									  TO_CHAR( NVL(SUM(A.TARGET_A_VALUE),0),'999,999,999,999,990.00') AS "targetNewestWorth",--目标总货值（A）-最新版(A)

/*                   TO_CHAR((SELECT SUM(A.Target_Now)
                            FROM   SYS_BUSINESS_UNIT SBU
                            LEFT   JOIN mdm_PROJECT mp  ON SBU.ID = mp.COMPANY_ID AND mp.APPROVAL_STATUS = '已审核' AND mp.IS_DELETE = 0 
                            LEFT   JOIN v_DWM_DT_VALUE DDV ON A.OBJ_ID = mP.PROJECT_ORIGINAL_ID
                            WHERE mp.PROJ_COOPERATE = (CASE WHEN ISOPERATE = '操盘' THEN '操盘'  WHEN ISOPERATE = '非操盘' THEN '不操盘' ELSE PROJ_COOPERATE END)
                            START  WITH (SBU.ID = a.id OR mp.PROJECT_ORIGINAL_ID = a.id)
                            CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID)
                            ,'999,999,999,999,990.00') AS "targetNewestWorth",--目标总货值（A）-最新版(A)*/

									 TO_CHAR( round(NVL(SUM(A.value_dt_all),0)/10000,2), '999,999,999,999,990.00') AS "dynamicTotalWorth",--动态总货值(B)
									 (CASE
												WHEN round( SUM(A.value_dt_all)/10000-SUM(A.TARGET_A_VALUE),2) < -1 THEN
												 '<font color=red>' ||TO_CHAR( SUM(A.value_dt_all)/10000-SUM(A.TARGET_A_VALUE),'999,999,999,999,990.00') || '</font>'
												ELSE
												 '<font color=green>' ||TO_CHAR( SUM(A.value_dt_all)/10000-SUM(A.TARGET_A_VALUE),'999,999,999,999,990.00') || '</font>'
										END) AS "dynamicTotalWorthDifference",--总货值差额(B-A)
									 TO_CHAR( NVL(SUM(A.VALUE_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "reserveTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
									 TO_CHAR( NVL(SUM(A.VALUE_IN_PROCESS),0) / 10000, '999,999,999,999,990.00') AS "inProcessTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-在途货值(B2)--修改字段holdConstructionPermit=》inTransitWorth
									 TO_CHAR(  SUM(nvl(A.VALUE_STOCK,0))/ 10000 ,'999,999,999,999,990.00') AS "stockWorth",  --动态总货值构成（B=B1+B2+B3+B4）-库存货值(B3)
									 TO_CHAR( NVL(SUM(A.VALUE_HAVED_SALE),0) / 10000, '999,999,999,999,990.00') AS "alreadySalesWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-已售货值(B4)
									 TO_CHAR( NVL(SUM(A.VALUE_REMAIN),0), '999,999,999,999,990.00') AS "residueWorth",
									 --剩余货值(C=B1+B2+B3)
									 TO_CHAR( NVL(( SUM(A.Value_Stock)+SUM(A.VALUE_HAVED_SALE)),0)/10000, '999,999,999,999,990.00') AS "getWorth",
									 --已领证货值(D=B3+B4)
									 (CASE
												WHEN (SUM(A.VALUE_STOCK)+SUM(A.VALUE_HAVED_SALE)) = 0 
                        THEN  '-'
												ELSE
												 TO_CHAR(NVL( SUM(A.VALUE_HAVED_SALE) / ( SUM(A.VALUE_STOCK)+SUM(A.VALUE_HAVED_SALE)),0) * 100, '999,999,999,999,990.00') || '%'
										END) AS "salesRate",
									 --去化率(E=B4/D)
									 TO_CHAR( NVL(SUM(A.VALUE_NOT_PLANNING_PERMIT),0) / 10000, '999,999,999,999,990.00') AS "noPlanningPermitObtainedPhase",
									 --F、动态货值的各阶段分布-F0未取规证
									 TO_CHAR( NVL(SUM(A.VALUE_NOT_CONSTRUCTION_PERMIT),0) / 10000, '999,999,999,999,990.00') AS "planningPermitObtainedOhase",
									 --F、动态货值的各阶段分布-F1规划许可证阶段
									 TO_CHAR( NVL(SUM(A.VALUE_NOT_SALE_PERMIT) ,0)/ 10000, '999,999,999,999,990.00') AS "constructionPermitOhase",
									 --F、动态货值的各阶段分布-F2施工许可证阶段
									 TO_CHAR( NVL(SUM(A.VALUE_NOT_COMPLETION),0) / 10000, '999,999,999,999,990.00') AS "PreSalePermitPhase",
									 --F、动态货值的各阶段分布-F3预售许可证阶段
									 --TO_CHAR(b.value_yes_completion / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
									 TO_CHAR( NVL(SUM(A.VALUE_YES_COMPLETION),0) / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",
									 --F、动态货值的各阶段分布-F4竣备阶段
									 '-' AS "carryDownPhase",
									 --F、动态货值的各阶段分布-F5结转阶段

									 TO_CHAR( NVL(SUM(A.VALUE_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "reserveWorth",
									 --G1、储备货值的量价情况-货值（G1=a1*b1）
									 TO_CHAR(NVL(( SUM(A.ZZ_AREA_RESERVE)+SUM(A.SY_AREA_RESERVE)),0), '999,999,999,999,990.00') AS "reserveCargo",
									 --G1、储备货值的量价情况-货量(a1)
									 '-' AS "reservePrice",
									 --G1、储备货值的量价情况-单价(b1)
									 TO_CHAR( NVL(SUM(A.value_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "inTransitWorth",
									 --G2、在途货值的量价情况-货值（G2=a2*b2）
									 TO_CHAR(NVL(( SUM(A.ZZ_AREA_IN_PROCESS)+SUM(A.SY_AREA_IN_PROCESS)),0), '999,999,999,999,990.00') AS "inTransitCargo",
									 --G2、在途货值的量价情况-货量(a2)
									 '-' AS "inTransitPrice",
									 --G2、在途货值的量价情况-单价(b2)
									 TO_CHAR( NVL(SUM(VALUE_STOCK),0) / 10000, '999,999,999,999,990.00') AS "stockWorth",
									 --G3、库存货值的量价情况-货值（G3=a3*b3）
									 TO_CHAR(NVL(( SUM(A.ZZ_AREA_STOCK) + SUM(A.SY_AREA_STOCK)),0), '999,999,999,999,990.00') AS "stockCargo",
									 --G3、库存货值的量价情况-货量(a3)
									 '-' AS "stockPrice",
									 --G3、库存货值的量价情况-单价(b3)
									 TO_CHAR( NVL(SUM(VALUE_HAVED_SALE),0) / 10000, '999,999,999,999,990.00') AS "soldWorth",
									 --G4、已售货值的量价情况-货值（G4=a4*b4）
									 TO_CHAR(NVL(( SUM(A.ZZ_AREA_HAVED_SALE)+SUM(A.SY_AREA_HAVED_SALE)),0), '999,999,999,999,990.00') AS "soldCargo",
									 --G4、已售货值的量价情况-货量(a4)
									 '-' AS "soldPrice" --G4、已售货值的量价情况-单价(b4)
						FROM   TEMP_DT_VALUE A
            INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
                       --WHERE  a.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END)
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE order by ORDER_HIERARCHY_CODE;
		END IF;

		IF TABSINDEX = 2 THEN
				OPEN INFO FOR
				WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   MDM_PROJECT A1
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
						SELECT A.ID AS "id",
									 --主键id（生成树的id，唯一可以是业务id）
									 A.PARENT_ID AS "parentId",
									 --父级id（生成树父级id）
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/value-project/detail?code=value_dtl&isOperate=' ||
												 A.PROJ_COOPERATE || '&projectId=' || A.ID || '&projectName=' ||
												 A.ORG_NAME || '&projectDate=' || A.TAKE_DATE || '&tabIndex=' ||
												 TABSINDEX || '&pageTitle=' || A.ORG_NAME --页面标题名称
												ELSE
												 ''
										END) AS "openUrl",
									 --详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/dynamic-volume/circular?companyId=' || A.PARENT_ID ||
												 '&projectId=' || A.ID || '&type=2' --companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
												ELSE
												 ''
										END) AS "openVisualUrl",
									 --打开可视化地址
									 ORG_LEVEL,
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '#eaf6ff'
												WHEN ORG_LEVEL = 2 THEN
												 '#ecfbee'
												WHEN ORG_LEVEL = 3 THEN
												 '#f2eed4'
												ELSE
												 ''
										END AS "excelRowBgColor",
									 --数据行导出excel背景色
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '' || ORG_NAME
												WHEN ORG_LEVEL = 2 THEN
												 '        ' || ORG_NAME
												WHEN ORG_LEVEL = 3 THEN
												 '                ' || ORG_NAME
												WHEN ORG_LEVEL = 4 THEN
												 '                        ' || ORG_NAME
												ELSE
												 '                                ' || ORG_NAME
										END AS "excelRowTextTreeOrgName",
									 --文本前面加空格模仿树
									 A.ORG_NAME AS "orgName",--公司/项目
									 --TO_CHAR(b.area_dt_all, '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
									 TO_CHAR(( SUM(A.ZZ_AREA_DT_ALL)+SUM(A.SY_AREA_DT_ALL)), '999,999,999,999,990.00') AS "targetSalesArea",--最新可售面积（不含车位）
									 '-' AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
									 '-' AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
									 '-' AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
									 '-' AS "targetNewestWorth",--目标总货值（A）-最新版(A)


									 '-' AS "dynamicTotalWorth",--动态总货值(B)
									 '-' AS "dynamicTotalWorthDifference",--总货值差额(B-A)
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_RESERVE)+SUM(A.SY_VALUE_RESERVE)),0) / 10000, '999,999,999,999,990.00') AS "reserveTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_IN_PROCESS) +SUM(A.SY_VALUE_IN_PROCESS)),0) / 10000, '999,999,999,999,990.00') AS "inProcessTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-在途货值(B2)--修改字段holdConstructionPermit=》inTransitWorth
									 TO_CHAR( NVL(( SUM(nvl(A.ZZ_VALUE_REMAIN,0))+SUM(nvl(A.SY_VALUE_REMAIN,0))),0) / 10000 ,'999,999,999,999,990.00') AS "stockWorth",  --动态总货值构成（B=B1+B2+B3+B4）-库存货值(B3)
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_HAVED_SALE) + SUM(A.SY_VALUE_HAVED_SALE)),0) / 10000, '999,999,999,999,990.00') AS "alreadySalesWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-已售货值(B4)
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_REMAIN) + SUM(A.SY_VALUE_REMAIN)),0) / 10000, '999,999,999,999,990.00') AS "residueWorth",
									 --剩余货值(C=B1+B2+B3)
									 TO_CHAR( NVL(( SUM(A.ZZ_VALUE_Stock)+SUM(A.ZZ_VALUE_HAVED_SALE) +SUM(A.SY_VALUE_STOCK)+SUM(A.SY_VALUE_HAVED_SALE)),0)/10000, '999,999,999,999,990.00') AS "getWorth",
									 --已领证货值(D=B3+B4)
									 (CASE
												WHEN  SUM(A.ZZ_VALUE_STOCK)+SUM(A.ZZ_VALUE_HAVED_SALE) + SUM(A.SY_VALUE_STOCK)+SUM(A.SY_VALUE_HAVED_SALE) = 0 
                        THEN  '-'
												ELSE
												 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_HAVED_SALE) + SUM(A.SY_VALUE_HAVED_SALE)),0) / ( SUM(A.ZZ_VALUE_STOCK)+SUM(A.ZZ_VALUE_HAVED_SALE) + SUM(A.SY_VALUE_STOCK)+SUM(A.SY_VALUE_HAVED_SALE)) * 100, '999,999,999,999,990.00') || '%'
										END) AS "salesRate",
									 --去化率(E=B4/D)
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_NOT_PLANNING_PERMIT) + SUM(A.SY_VALUE_NOT_PLANNING_PERMIT)),0) / 10000, '999,999,999,999,990.00') AS "noPlanningPermitObtainedPhase",
									 --F、动态货值的各阶段分布-F0未取规证
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_NOT_CONSTRUCTION_PER) + SUM(A.SY_VALUE_NOT_CONSTRUCTION_PER)),0) / 10000, '999,999,999,999,990.00') AS "planningPermitObtainedOhase",
									 --F、动态货值的各阶段分布-F1规划许可证阶段
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_NOT_SALE_PERMIT) + SUM(A.SY_VALUE_NOT_SALE_PERMIT)),0) / 10000, '999,999,999,999,990.00') AS "constructionPermitOhase",
									 --F、动态货值的各阶段分布-F2施工许可证阶段
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_NOT_COMPLETION) + SUM(A.SY_VALUE_NOT_COMPLETION)),0) / 10000, '999,999,999,999,990.00') AS "PreSalePermitPhase",
									 --F、动态货值的各阶段分布-F3预售许可证阶段
									 --TO_CHAR(b.value_yes_completion / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_YES_COMPLETION) + SUM(A.SY_VALUE_YES_COMPLETION)),0) / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",
									 --F、动态货值的各阶段分布-F4竣备阶段
									 '-' AS "carryDownPhase",
									 --F、动态货值的各阶段分布-F5结转阶段

									 TO_CHAR(NVL(( SUM(A.ZZ_VALUE_RESERVE) + SUM(A.SY_VALUE_RESERVE)),0) / 10000, '999,999,999,999,990.00') AS "reserveWorth",
									 --G1、储备货值的量价情况-货值（G1=a1*b1）
									 TO_CHAR(NVL(( SUM(A.ZZ_AREA_RESERVE) + SUM(A.SY_AREA_RESERVE)),0), '999,999,999,999,990.00') AS "reserveCargo",
									 --G1、储备货值的量价情况-货量(a1)
									 '-' AS "reservePrice",
									 --G1、储备货值的量价情况-单价(b1)
									 TO_CHAR(NVL(( SUM(A.ZZ_value_RESERVE) + SUM(A.SY_value_RESERVE)),0) / 10000,
														'999,999,999,999,990.00') AS "inTransitWorth",
									 --G2、在途货值的量价情况-货值（G2=a2*b2）
									 TO_CHAR(NVL(( SUM(A.ZZ_AREA_IN_PROCESS) + SUM(A.SY_AREA_IN_PROCESS)),0), '999,999,999,999,990.00') AS "inTransitCargo",
									 --G2、在途货值的量价情况-货量(a2)
									 '-' AS "inTransitPrice",
									 --G2、在途货值的量价情况-单价(b2)
									 TO_CHAR(NVL(( SUM(ZZ_VALUE_STOCK) + SUM(SY_VALUE_STOCK)),0) / 10000, '999,999,999,999,990.00') AS "stockWorth",
									 --G3、库存货值的量价情况-货值（G3=a3*b3）
									 TO_CHAR(NVl(( SUM(A.ZZ_AREA_STOCK) + SUM(A.SY_AREA_STOCK)),0), '999,999,999,999,990.00') AS "stockCargo",
									 --G3、库存货值的量价情况-货量(a3)
									 '-' AS "stockPrice",
									 --G3、库存货值的量价情况-单价(b3)
									 TO_CHAR(NVL(( SUM(ZZ_VALUE_HAVED_SALE) + SUM(SY_VALUE_HAVED_SALE)),0) / 10000, '999,999,999,999,990.00') AS "soldWorth",
									 --G4、已售货值的量价情况-货值（G4=a4*b4）
									 TO_CHAR(NVL(( SUM(A.ZZ_AREA_HAVED_SALE)+SUM(A.SY_AREA_HAVED_SALE)),0), '999,999,999,999,990.00') AS "soldCargo",
									 --G4、已售货值的量价情况-货量(a4)
									 '-' AS "soldPrice" --G4、已售货值的量价情况-单价(b4)
						FROM   TEMP_DT_VALUE A
            INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
                       --WHERE  a.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END)
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE order by ORDER_HIERARCHY_CODE;
		END IF;

		IF TABSINDEX = 3 --OR tabsindex = 4 OR tabsindex = 5 
		 THEN
				OPEN INFO FOR
				WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   MDM_PROJECT A1
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
						SELECT A.ID AS "id",
									 --主键id（生成树的id，唯一可以是业务id）
									 A.PARENT_ID AS "parentId",
									 --父级id（生成树父级id）
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/value-project/detail?code=value_dtl&isOperate=' ||
												 A.PROJ_COOPERATE || '&projectId=' || A.ID || '&projectName=' ||
												 A.ORG_NAME || '&projectDate=' || A.TAKE_DATE || '&tabIndex=' ||
												 TABSINDEX || '&pageTitle=' || A.ORG_NAME --页面标题名称
												ELSE
												 ''
										END) AS "openUrl",
									 --详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/dynamic-volume/circular?companyId=' || A.PARENT_ID ||
												 '&projectId=' || A.ID || '&type=2' --companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
												ELSE
												 ''
										END) AS "openVisualUrl",
									 --打开可视化地址
									 ORG_LEVEL,
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '#eaf6ff'
												WHEN ORG_LEVEL = 2 THEN
												 '#ecfbee'
												WHEN ORG_LEVEL = 3 THEN
												 '#f2eed4'
												ELSE
												 ''
										END AS "excelRowBgColor",
									 --数据行导出excel背景色
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '' || ORG_NAME
												WHEN ORG_LEVEL = 2 THEN
												 '        ' || ORG_NAME
												WHEN ORG_LEVEL = 3 THEN
												 '                ' || ORG_NAME
												WHEN ORG_LEVEL = 4 THEN
												 '                        ' || ORG_NAME
												ELSE
												 '                                ' || ORG_NAME
										END AS "excelRowTextTreeOrgName",
									 --文本前面加空格模仿树
									 A.ORG_NAME AS "orgName",--公司/项目
									 --TO_CHAR(b.area_dt_all, '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
									 TO_CHAR( SUM(A.ZZ_AREA_DT_ALL), '999,999,999,999,990.00') AS "targetSalesArea",--最新可售面积（不含车位）
									 '-' AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
									 '-' AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
									 '-' AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
									 '-' AS "targetNewestWorth",--目标总货值（A）-最新版(A)


									 '-' AS "dynamicTotalWorth",--动态总货值(B)
									 '-' AS "dynamicTotalWorthDifference",--总货值差额(B-A)
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "reserveTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_IN_PROCESS),0) / 10000, '999,999,999,999,990.00') AS "inProcessTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-在途货值(B2)--修改字段holdConstructionPermit=》inTransitWorth
									 TO_CHAR(  NVL(SUM(nvl(A.ZZ_VALUE_REMAIN,0)),0) / 10000 ,'999,999,999,999,990.00') AS "stockWorth",  --动态总货值构成（B=B1+B2+B3+B4）-库存货值(B3)
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_HAVED_SALE),0) / 10000, '999,999,999,999,990.00') AS "alreadySalesWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-已售货值(B4)
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_REMAIN),0)/ 10000, '999,999,999,999,990.00') AS "residueWorth",
									 --剩余货值(C=B1+B2+B3)
									 TO_CHAR( NVL(( SUM(A.ZZ_VALUE_Stock)+SUM(A.ZZ_VALUE_HAVED_SALE)),0)/10000, '999,999,999,999,990.00') AS "getWorth",
									 --已领证货值(D=B3+B4)
									 (CASE
												WHEN  SUM(A.ZZ_VALUE_STOCK)+SUM(A.ZZ_VALUE_HAVED_SALE) = 0 
                        THEN  '-'
												ELSE
												 TO_CHAR( NVL(SUM(A.ZZ_VALUE_HAVED_SALE),0) / ( SUM(A.ZZ_VALUE_STOCK)+SUM(A.ZZ_VALUE_HAVED_SALE)) * 100,
																 '999,999,999,999,990.00') || '%'
										END) AS "salesRate",
									 --去化率(E=B4/D)
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_NOT_PLANNING_PERMIT),0) / 10000, '999,999,999,999,990.00') AS "noPlanningPermitObtainedPhase",
									 --F、动态货值的各阶段分布-F0未取规证
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_NOT_CONSTRUCTION_PER),0) / 10000, '999,999,999,999,990.00') AS "planningPermitObtainedOhase",
									 --F、动态货值的各阶段分布-F1规划许可证阶段
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_NOT_SALE_PERMIT),0) / 10000, '999,999,999,999,990.00') AS "constructionPermitOhase",
									 --F、动态货值的各阶段分布-F2施工许可证阶段
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_NOT_COMPLETION),0) / 10000, '999,999,999,999,990.00') AS "PreSalePermitPhase",
									 --F、动态货值的各阶段分布-F3预售许可证阶段
									 --TO_CHAR(b.value_yes_completion / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_YES_COMPLETION),0) / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",
									 --F、动态货值的各阶段分布-F4竣备阶段
									 '-' AS "carryDownPhase",
									 --F、动态货值的各阶段分布-F5结转阶段

									 TO_CHAR( NVL(SUM(A.ZZ_VALUE_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "reserveWorth",
									 --G1、储备货值的量价情况-货值（G1=a1*b1）
									 TO_CHAR( NVL(SUM(A.ZZ_AREA_RESERVE),0), '999,999,999,999,990.00') AS "reserveCargo",
									 --G1、储备货值的量价情况-货量(a1)
									 '-' AS "reservePrice",
									 --G1、储备货值的量价情况-单价(b1)
									 TO_CHAR( NVL(SUM(A.ZZ_value_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "inTransitWorth",
									 --G2、在途货值的量价情况-货值（G2=a2*b2）
									 TO_CHAR( NVL(SUM(A.ZZ_AREA_IN_PROCESS),0), '999,999,999,999,990.00') AS "inTransitCargo",
									 --G2、在途货值的量价情况-货量(a2)
									 '-' AS "inTransitPrice",
									 --G2、在途货值的量价情况-单价(b2)
									 TO_CHAR( NVL(SUM(ZZ_VALUE_STOCK),0) / 10000, '999,999,999,999,990.00') AS "stockWorth",
									 --G3、库存货值的量价情况-货值（G3=a3*b3）
									 TO_CHAR( NVL(SUM(A.ZZ_AREA_STOCK),0) , '999,999,999,999,990.00') AS "stockCargo",
									 --G3、库存货值的量价情况-货量(a3)
									 '-' AS "stockPrice",
									 --G3、库存货值的量价情况-单价(b3)
									 TO_CHAR( NVL(SUM(ZZ_VALUE_HAVED_SALE),0) / 10000, '999,999,999,999,990.00') AS "soldWorth",
									 --G4、已售货值的量价情况-货值（G4=a4*b4）
									 TO_CHAR( NVL(SUM(A.ZZ_AREA_HAVED_SALE),0), '999,999,999,999,990.00') AS "soldCargo",
									 --G4、已售货值的量价情况-货量(a4)
									 '-' AS "soldPrice" --G4、已售货值的量价情况-单价(b4)
												FROM   TEMP_DT_VALUE A
            INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
                       --WHERE  a.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END)
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE order by ORDER_HIERARCHY_CODE;
		END IF;

		IF TABSINDEX = 4 THEN
				OPEN INFO FOR
				WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   MDM_PROJECT A1
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
						SELECT A.ID AS "id",
									 --主键id（生成树的id，唯一可以是业务id）
									 A.PARENT_ID AS "parentId",
									 --父级id（生成树父级id）
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/value-project/detail?code=value_dtl&isOperate=' ||
												 A.PROJ_COOPERATE || '&projectId=' || A.ID || '&projectName=' ||
												 A.ORG_NAME || '&projectDate=' || A.TAKE_DATE || '&tabIndex=' ||
												 TABSINDEX || '&pageTitle=' || A.ORG_NAME --页面标题名称
												ELSE
												 ''
										END) AS "openUrl",
									 --详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/dynamic-volume/circular?companyId=' || A.PARENT_ID ||
												 '&projectId=' || A.ID || '&type=2' --companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
												ELSE
												 ''
										END) AS "openVisualUrl",
									 --打开可视化地址
									 ORG_LEVEL,
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '#eaf6ff'
												WHEN ORG_LEVEL = 2 THEN
												 '#ecfbee'
												WHEN ORG_LEVEL = 3 THEN
												 '#f2eed4'
												ELSE
												 ''
										END AS "excelRowBgColor",
									 --数据行导出excel背景色
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '' || ORG_NAME
												WHEN ORG_LEVEL = 2 THEN
												 '        ' || ORG_NAME
												WHEN ORG_LEVEL = 3 THEN
												 '                ' || ORG_NAME
												WHEN ORG_LEVEL = 4 THEN
												 '                        ' || ORG_NAME
												ELSE
												 '                                ' || ORG_NAME
										END AS "excelRowTextTreeOrgName",
									 --文本前面加空格模仿树
									 A.ORG_NAME AS "orgName",--公司/项目
									 --TO_CHAR(b.area_dt_all, '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
									 TO_CHAR( SUM(A.SY_AREA_DT_ALL), '999,999,999,999,990.00') AS "targetSalesArea",--最新可售面积（不含车位）
									 '-' AS "targetFeasibleWorth",--目标总货值（A）-可研版(A1)
									 '-' AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
									 '-' AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
									 '-' AS "targetNewestWorth",--目标总货值（A）-最新版(A)
                   '-' AS "dynamicTotalWorth",--动态总货值(B)
									 '-' AS "dynamicTotalWorthDifference",--总货值差额(B-A)
									 TO_CHAR( NVL(SUM(A.SY_VALUE_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "reserveTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
									 TO_CHAR(NVL(SUM(A.SY_VALUE_IN_PROCESS),0) / 10000, '999,999,999,999,990.00') AS "inProcessTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-在途货值(B2)--修改字段holdConstructionPermit=》inTransitWorth
									 TO_CHAR(SUM(nvl(A.SY_VALUE_REMAIN,0)) / 10000 ,'999,999,999,999,990.00') AS "stockWorth",  --动态总货值构成（B=B1+B2+B3+B4）-库存货值(B3)
									 TO_CHAR( NVL(SUM(A.SY_VALUE_HAVED_SALE),0) / 10000, '999,999,999,999,990.00') AS "alreadySalesWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-已售货值(B4)
									 TO_CHAR( NVL(SUM(A.SY_VALUE_REMAIN),0) / 10000, '999,999,999,999,990.00') AS "residueWorth",
									 --剩余货值(C=B1+B2+B3)
									 TO_CHAR(  NVL((SUM(A.SY_VALUE_Stock)+SUM(A.SY_VALUE_HAVED_SALE)),0)/10000, '999,999,999,999,990.00') AS "getWorth",
									 --已领证货值(D=B3+B4)
									 (CASE
												WHEN  SUM(A.SY_VALUE_STOCK)+SUM(A.SY_VALUE_HAVED_SALE) = 0 
                        THEN  '-'
												ELSE
												 TO_CHAR( NVL(SUM(A.SY_VALUE_HAVED_SALE),0) / ( SUM(A.SY_VALUE_STOCK)+SUM(A.SY_VALUE_HAVED_SALE)) * 100, '999,999,999,999,990.00') || '%'
										END) AS "salesRate",
									 --去化率(E=B4/D)
									 TO_CHAR( NVL(SUM(A.SY_VALUE_NOT_PLANNING_PERMIT),0) / 10000, '999,999,999,999,990.00') AS "noPlanningPermitObtainedPhase",
									 --F、动态货值的各阶段分布-F0未取规证
									 TO_CHAR( NVL(SUM(A.SY_VALUE_NOT_CONSTRUCTION_PER),0) / 10000, '999,999,999,999,990.00') AS "planningPermitObtainedOhase",
									 --F、动态货值的各阶段分布-F1规划许可证阶段
									 TO_CHAR( NVL(SUM(A.SY_VALUE_NOT_SALE_PERMIT),0) / 10000, '999,999,999,999,990.00') AS "constructionPermitOhase",
									 --F、动态货值的各阶段分布-F2施工许可证阶段
									 TO_CHAR( NVL(SUM(A.SY_VALUE_NOT_COMPLETION),0) / 10000, '999,999,999,999,990.00') AS "PreSalePermitPhase",
									 --F、动态货值的各阶段分布-F3预售许可证阶段
									 --TO_CHAR(b.value_yes_completion / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
									 TO_CHAR( NVL(SUM(A.SY_VALUE_YES_COMPLETION),0) / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",
									 --F、动态货值的各阶段分布-F4竣备阶段
									 '-' AS "carryDownPhase",
									 --F、动态货值的各阶段分布-F5结转阶段

									 TO_CHAR( NVL(SUM(A.SY_VALUE_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "reserveWorth",
									 --G1、储备货值的量价情况-货值（G1=a1*b1）
									 TO_CHAR( NVL(SUM(A.SY_AREA_RESERVE),0), '999,999,999,999,990.00') AS "reserveCargo",
									 --G1、储备货值的量价情况-货量(a1)
									 '-' AS "reservePrice",
									 --G1、储备货值的量价情况-单价(b1)
									 TO_CHAR( NVL(SUM(A.SY_value_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "inTransitWorth",
									 --G2、在途货值的量价情况-货值（G2=a2*b2）
									 TO_CHAR( NVL(SUM(A.SY_AREA_IN_PROCESS),0), '999,999,999,999,990.00') AS "inTransitCargo",
									 --G2、在途货值的量价情况-货量(a2)
									 '-' AS "inTransitPrice",
									 --G2、在途货值的量价情况-单价(b2)
									 TO_CHAR( NVL(SUM(SY_VALUE_STOCK),0) / 10000, '999,999,999,999,990.00') AS "stockWorth",
									 --G3、库存货值的量价情况-货值（G3=a3*b3）
									 TO_CHAR( NVL(SUM(A.SY_AREA_STOCK),0) , '999,999,999,999,990.00') AS "stockCargo",
									 --G3、库存货值的量价情况-货量(a3)
									 '-' AS "stockPrice",
									 --G3、库存货值的量价情况-单价(b3)
									 TO_CHAR( NVL(SUM(SY_VALUE_HAVED_SALE),0) / 10000, '999,999,999,999,990.00') AS "soldWorth",
									 --G4、已售货值的量价情况-货值（G4=a4*b4）
									 TO_CHAR( NVL(SUM(A.SY_AREA_HAVED_SALE),0), '999,999,999,999,990.00') AS "soldCargo",
									 --G4、已售货值的量价情况-货量(a4)
									 '-' AS "soldPrice" --G4、已售货值的量价情况-单价(b4)
						FROM   TEMP_DT_VALUE A
            INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
                       --WHERE  a.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END)
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE order by ORDER_HIERARCHY_CODE;
		END IF;

		IF TABSINDEX = 5 THEN
				OPEN INFO FOR
				WITH TEMP_DT_VALUE (ID,COMPANY_ID, ORG_NAME, OBJ_TYPE, VALUE_DT_ALL, VALUE_REMAIN, VALUE_HAVED_SALE, VALUE_RESERVE, VALUE_IN_PROCESS, VALUE_ALLOW_SALE, VALUE_STOCK,
       VALUE_NOT_PLANNING_PERMIT, VALUE_NOT_CONSTRUCTION_PERMIT, VALUE_NOT_SALE_PERMIT, VALUE_NOT_COMPLETION, VALUE_YES_COMPLETION, VALUE_YES_SETTLEMENT, AREA_DT_ALL, AREA_REMAIN,
       AREA_HAVED_SALE, AREA_RESERVE, AREA_IN_PROCESS, AREA_ALLOW_SALE, AREA_STOCK, AREA_NOT_PLANNING_PERMIT, AREA_NOT_CONSTRUCTION_PERMIT, AREA_NOT_SALE_PERMIT, AREA_NOT_COMPLETION,
       AREA_YES_COMPLETION, AREA_YES_SETTLEMENT, TMP_1KY_VALUE, TMP_1KY_AREA, TMP_1KY_PRICE, TMP_2QP_VALUE, TMP_2QP_AREA, TMP_2QP_PRICE, TMP_3DT_TARGETVALUE, TMP_3DT_TARGETAREA,
       TMP_3DT_TARGETPRICE, CW_VALUE_DT_ALL, CW_VALUE_REMAIN, CW_VALUE_HAVED_SALE, CW_VALUE_RESERVE, CW_VALUE_IN_PROCESS, CW_VALUE_ALLOW_SALE, CW_VALUE_STOCK,
       CW_VALUE_NOT_PLANNING_PERMIT, CW_VALUE_NOT_CONSTRUCTION_PER, CW_VALUE_NOT_SALE_PERMIT, CW_VALUE_NOT_COMPLETION, CW_VALUE_YES_COMPLETION, CW_VALUE_YES_SETTLEMENT, CW_AREA_DT_ALL,
       CW_AREA_REMAIN, CW_AREA_HAVED_SALE, CW_AREA_RESERVE, CW_AREA_IN_PROCESS, CW_AREA_ALLOW_SALE, CW_AREA_STOCK, CW_AREA_NOT_PLANNING_PERMIT, CW_AREA_NOT_CONSTRUCTION_PER,
       CW_AREA_NOT_SALE_PERMIT, CW_AREA_NOT_COMPLETION, CW_AREA_YES_COMPLETION, CW_AREA_YES_SETTLEMENT, ZZ_VALUE_DT_ALL, ZZ_VALUE_REMAIN, ZZ_VALUE_HAVED_SALE, ZZ_VALUE_RESERVE,
       ZZ_VALUE_IN_PROCESS, ZZ_VALUE_ALLOW_SALE, ZZ_VALUE_STOCK, ZZ_VALUE_NOT_PLANNING_PERMIT, ZZ_VALUE_NOT_CONSTRUCTION_PER, ZZ_VALUE_NOT_SALE_PERMIT, ZZ_VALUE_NOT_COMPLETION,
       ZZ_VALUE_YES_COMPLETION, ZZ_VALUE_YES_SETTLEMENT, ZZ_AREA_DT_ALL, ZZ_AREA_REMAIN, ZZ_AREA_HAVED_SALE, ZZ_AREA_RESERVE, ZZ_AREA_IN_PROCESS, ZZ_AREA_ALLOW_SALE, ZZ_AREA_STOCK,
       ZZ_AREA_NOT_PLANNING_PERMIT, ZZ_AREA_NOT_CONSTRUCTION_PER, ZZ_AREA_NOT_SALE_PERMIT, ZZ_AREA_NOT_COMPLETION, ZZ_AREA_YES_COMPLETION, ZZ_AREA_YES_SETTLEMENT, SY_VALUE_DT_ALL,
       SY_VALUE_REMAIN, SY_VALUE_HAVED_SALE, SY_VALUE_RESERVE, SY_VALUE_IN_PROCESS, SY_VALUE_ALLOW_SALE, SY_VALUE_STOCK, SY_VALUE_NOT_PLANNING_PERMIT, SY_VALUE_NOT_CONSTRUCTION_PER,
       SY_VALUE_NOT_SALE_PERMIT, SY_VALUE_NOT_COMPLETION, SY_VALUE_YES_COMPLETION, SY_VALUE_YES_SETTLEMENT, SY_AREA_DT_ALL, SY_AREA_REMAIN, SY_AREA_HAVED_SALE, SY_AREA_RESERVE,
       SY_AREA_IN_PROCESS, SY_AREA_ALLOW_SALE, SY_AREA_STOCK, SY_AREA_NOT_PLANNING_PERMIT, SY_AREA_NOT_CONSTRUCTION_PER, SY_AREA_NOT_SALE_PERMIT, SY_AREA_NOT_COMPLETION,
       SY_AREA_YES_COMPLETION, SY_AREA_YES_SETTLEMENT, PROJ_ID, TARGET_NOW_NAME, TARGET_A_ID, TARGET_A1_ID, TARGET_A2_ID, TARGET_A3_ID, TARGET_A_VALUE, TARGET_A1_VALUE,
       TARGET_A2_VALUE, TARGET_A3_VALUE, TARGET_A_VALUE_DIFF,PARENT_ID,PROJ_COOPERATE,TAKE_DATE,IS_COMPANY,ORG_LEVEL,ORDER_HIERARCHY_CODE) AS 
       (     
SELECT A1.ID,A1.COMPANY_ID, B1.OBJ_NAME, B1.OBJ_TYPE, B1.VALUE_DT_ALL, B1.VALUE_REMAIN, B1.VALUE_HAVED_SALE, B1.VALUE_RESERVE, B1.VALUE_IN_PROCESS, B1.VALUE_ALLOW_SALE, B1.VALUE_STOCK,
       B1.VALUE_NOT_PLANNING_PERMIT, B1.VALUE_NOT_CONSTRUCTION_PERMIT, B1.VALUE_NOT_SALE_PERMIT, B1.VALUE_NOT_COMPLETION, B1.VALUE_YES_COMPLETION, B1.VALUE_YES_SETTLEMENT, B1.AREA_DT_ALL, B1.AREA_REMAIN,
       B1.AREA_HAVED_SALE, B1.AREA_RESERVE, B1.AREA_IN_PROCESS, B1.AREA_ALLOW_SALE, B1.AREA_STOCK, B1.AREA_NOT_PLANNING_PERMIT, B1.AREA_NOT_CONSTRUCTION_PERMIT, B1.AREA_NOT_SALE_PERMIT, B1.AREA_NOT_COMPLETION,
       B1.AREA_YES_COMPLETION, B1.AREA_YES_SETTLEMENT, B1.TMP_1KY_VALUE, B1.TMP_1KY_AREA, B1.TMP_1KY_PRICE, B1.TMP_2QP_VALUE, B1.TMP_2QP_AREA, B1.TMP_2QP_PRICE, B1.TMP_3DT_TARGETVALUE, B1.TMP_3DT_TARGETAREA,
       B1.TMP_3DT_TARGETPRICE, B1.CW_VALUE_DT_ALL, B1.CW_VALUE_REMAIN, B1.CW_VALUE_HAVED_SALE, B1.CW_VALUE_RESERVE, B1.CW_VALUE_IN_PROCESS, B1.CW_VALUE_ALLOW_SALE, B1.CW_VALUE_STOCK,
       B1.CW_VALUE_NOT_PLANNING_PERMIT, B1.CW_VALUE_NOT_CONSTRUCTION_PER, B1.CW_VALUE_NOT_SALE_PERMIT, B1.CW_VALUE_NOT_COMPLETION, B1.CW_VALUE_YES_COMPLETION, B1.CW_VALUE_YES_SETTLEMENT, B1.CW_AREA_DT_ALL,
       B1.CW_AREA_REMAIN, B1.CW_AREA_HAVED_SALE, B1.CW_AREA_RESERVE, B1.CW_AREA_IN_PROCESS, B1.CW_AREA_ALLOW_SALE, B1.CW_AREA_STOCK, B1.CW_AREA_NOT_PLANNING_PERMIT, B1.CW_AREA_NOT_CONSTRUCTION_PER,
       B1.CW_AREA_NOT_SALE_PERMIT, B1.CW_AREA_NOT_COMPLETION, B1.CW_AREA_YES_COMPLETION, B1.CW_AREA_YES_SETTLEMENT, B1.ZZ_VALUE_DT_ALL, B1.ZZ_VALUE_REMAIN, B1.ZZ_VALUE_HAVED_SALE, B1.ZZ_VALUE_RESERVE,
       B1.ZZ_VALUE_IN_PROCESS, B1.ZZ_VALUE_ALLOW_SALE, B1.ZZ_VALUE_STOCK, B1.ZZ_VALUE_NOT_PLANNING_PERMIT, B1.ZZ_VALUE_NOT_CONSTRUCTION_PER, B1.ZZ_VALUE_NOT_SALE_PERMIT, B1.ZZ_VALUE_NOT_COMPLETION,
       B1.ZZ_VALUE_YES_COMPLETION, B1.ZZ_VALUE_YES_SETTLEMENT, B1.ZZ_AREA_DT_ALL, B1.ZZ_AREA_REMAIN, B1.ZZ_AREA_HAVED_SALE, B1.ZZ_AREA_RESERVE, B1.ZZ_AREA_IN_PROCESS, B1.ZZ_AREA_ALLOW_SALE, B1.ZZ_AREA_STOCK,
       B1.ZZ_AREA_NOT_PLANNING_PERMIT, B1.ZZ_AREA_NOT_CONSTRUCTION_PER, B1.ZZ_AREA_NOT_SALE_PERMIT, B1.ZZ_AREA_NOT_COMPLETION, B1.ZZ_AREA_YES_COMPLETION, B1.ZZ_AREA_YES_SETTLEMENT, B1.SY_VALUE_DT_ALL,
       B1.SY_VALUE_REMAIN, B1.SY_VALUE_HAVED_SALE, B1.SY_VALUE_RESERVE, B1.SY_VALUE_IN_PROCESS, B1.SY_VALUE_ALLOW_SALE, B1.SY_VALUE_STOCK, B1.SY_VALUE_NOT_PLANNING_PERMIT, B1.SY_VALUE_NOT_CONSTRUCTION_PER,
       B1.SY_VALUE_NOT_SALE_PERMIT, B1.SY_VALUE_NOT_COMPLETION, B1.SY_VALUE_YES_COMPLETION, B1.SY_VALUE_YES_SETTLEMENT, B1.SY_AREA_DT_ALL, B1.SY_AREA_REMAIN, B1.SY_AREA_HAVED_SALE, B1.SY_AREA_RESERVE,
       B1.SY_AREA_IN_PROCESS, B1.SY_AREA_ALLOW_SALE, B1.SY_AREA_STOCK, B1.SY_AREA_NOT_PLANNING_PERMIT, B1.SY_AREA_NOT_CONSTRUCTION_PER, B1.SY_AREA_NOT_SALE_PERMIT, B1.SY_AREA_NOT_COMPLETION,
       B1.SY_AREA_YES_COMPLETION, B1.SY_AREA_YES_SETTLEMENT, B1.PROJ_ID, B1.TARGET_NOW_NAME, B1.TARGET_A_ID, B1.TARGET_A1_ID, B1.TARGET_A2_ID, B1.TARGET_A3_ID, B1.TARGET_A_VALUE, B1.TARGET_A1_VALUE,
       B1.TARGET_A2_VALUE, B1.TARGET_A3_VALUE, B1.TARGET_A_VALUE_DIFF,A1.COMPANY_ID AS PARENT_ID,NVL(A1.PROJ_COOPERATE,'操盘'),TO_CHAR(A1.PROJECT_GET_TIME,'YYYY-MM-DD') AS TAKE_DATE,0,4,a1.ORDER_HIERARCHY_CODE
FROM   MDM_PROJECT A1
INNER  JOIN DWM_DT_VALUE B1
ON     A1.ID = B1.OBJ_ID AND B1.OBJ_TYPE = '项目'
WHERE  a1.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a1.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END) 
UNION ALL
SELECT B2.ID,A2.PARENT_ID, B2.ORG_NAME, '公司', A2.VALUE_DT_ALL, A2.VALUE_REMAIN, A2.VALUE_HAVED_SALE, A2.VALUE_RESERVE, A2.VALUE_IN_PROCESS, A2.VALUE_ALLOW_SALE, A2.VALUE_STOCK,
       A2.VALUE_NOT_PLANNING_PERMIT, A2.VALUE_NOT_CONSTRUCTION_PERMIT, A2.VALUE_NOT_SALE_PERMIT, A2.VALUE_NOT_COMPLETION, A2.VALUE_YES_COMPLETION, A2.VALUE_YES_SETTLEMENT, A2.AREA_DT_ALL, A2.AREA_REMAIN,
       A2.AREA_HAVED_SALE, A2.AREA_RESERVE, A2.AREA_IN_PROCESS, A2.AREA_ALLOW_SALE, A2.AREA_STOCK, A2.AREA_NOT_PLANNING_PERMIT, A2.AREA_NOT_CONSTRUCTION_PERMIT, A2.AREA_NOT_SALE_PERMIT, A2.AREA_NOT_COMPLETION,
       A2.AREA_YES_COMPLETION, A2.AREA_YES_SETTLEMENT, A2.TMP_1KY_VALUE, A2.TMP_1KY_AREA, A2.TMP_1KY_PRICE, A2.TMP_2QP_VALUE, A2.TMP_2QP_AREA, A2.TMP_2QP_PRICE, A2.TMP_3DT_TARGETVALUE, A2.TMP_3DT_TARGETAREA,
       A2.TMP_3DT_TARGETPRICE, A2.CW_VALUE_DT_ALL, A2.CW_VALUE_REMAIN, A2.CW_VALUE_HAVED_SALE, A2.CW_VALUE_RESERVE, A2.CW_VALUE_IN_PROCESS, A2.CW_VALUE_ALLOW_SALE, A2.CW_VALUE_STOCK,
       A2.CW_VALUE_NOT_PLANNING_PERMIT, A2.CW_VALUE_NOT_CONSTRUCTION_PER, A2.CW_VALUE_NOT_SALE_PERMIT, A2.CW_VALUE_NOT_COMPLETION, A2.CW_VALUE_YES_COMPLETION, A2.CW_VALUE_YES_SETTLEMENT, A2.CW_AREA_DT_ALL,
       A2.CW_AREA_REMAIN, A2.CW_AREA_HAVED_SALE, A2.CW_AREA_RESERVE, A2.CW_AREA_IN_PROCESS, A2.CW_AREA_ALLOW_SALE, A2.CW_AREA_STOCK, A2.CW_AREA_NOT_PLANNING_PERMIT, A2.CW_AREA_NOT_CONSTRUCTION_PER,
       A2.CW_AREA_NOT_SALE_PERMIT, A2.CW_AREA_NOT_COMPLETION, A2.CW_AREA_YES_COMPLETION, A2.CW_AREA_YES_SETTLEMENT, A2.ZZ_VALUE_DT_ALL, A2.ZZ_VALUE_REMAIN, A2.ZZ_VALUE_HAVED_SALE, A2.ZZ_VALUE_RESERVE,
       A2.ZZ_VALUE_IN_PROCESS, A2.ZZ_VALUE_ALLOW_SALE, A2.ZZ_VALUE_STOCK, A2.ZZ_VALUE_NOT_PLANNING_PERMIT, A2.ZZ_VALUE_NOT_CONSTRUCTION_PER, A2.ZZ_VALUE_NOT_SALE_PERMIT, A2.ZZ_VALUE_NOT_COMPLETION,
       A2.ZZ_VALUE_YES_COMPLETION, A2.ZZ_VALUE_YES_SETTLEMENT, A2.ZZ_AREA_DT_ALL, A2.ZZ_AREA_REMAIN, A2.ZZ_AREA_HAVED_SALE, A2.ZZ_AREA_RESERVE, A2.ZZ_AREA_IN_PROCESS, A2.ZZ_AREA_ALLOW_SALE, A2.ZZ_AREA_STOCK,
       A2.ZZ_AREA_NOT_PLANNING_PERMIT, A2.ZZ_AREA_NOT_CONSTRUCTION_PER, A2.ZZ_AREA_NOT_SALE_PERMIT, A2.ZZ_AREA_NOT_COMPLETION, A2.ZZ_AREA_YES_COMPLETION, A2.ZZ_AREA_YES_SETTLEMENT, A2.SY_VALUE_DT_ALL,
       A2.SY_VALUE_REMAIN, A2.SY_VALUE_HAVED_SALE, A2.SY_VALUE_RESERVE, A2.SY_VALUE_IN_PROCESS, A2.SY_VALUE_ALLOW_SALE, A2.SY_VALUE_STOCK, A2.SY_VALUE_NOT_PLANNING_PERMIT, A2.SY_VALUE_NOT_CONSTRUCTION_PER,
       A2.SY_VALUE_NOT_SALE_PERMIT, A2.SY_VALUE_NOT_COMPLETION, A2.SY_VALUE_YES_COMPLETION, A2.SY_VALUE_YES_SETTLEMENT, A2.SY_AREA_DT_ALL, A2.SY_AREA_REMAIN, A2.SY_AREA_HAVED_SALE, A2.SY_AREA_RESERVE,
       A2.SY_AREA_IN_PROCESS, A2.SY_AREA_ALLOW_SALE, A2.SY_AREA_STOCK, A2.SY_AREA_NOT_PLANNING_PERMIT, A2.SY_AREA_NOT_CONSTRUCTION_PER, A2.SY_AREA_NOT_SALE_PERMIT, A2.SY_AREA_NOT_COMPLETION,
       A2.SY_AREA_YES_COMPLETION, A2.SY_AREA_YES_SETTLEMENT, A2.PROJ_ID, A2.TARGET_NOW_NAME, A2.TARGET_A_ID, A2.TARGET_A1_ID, A2.TARGET_A2_ID, A2.TARGET_A3_ID, A2.TARGET_A_VALUE, A2.TARGET_A1_VALUE,
       A2.TARGET_A2_VALUE, A2.TARGET_A3_VALUE, A2.TARGET_A_VALUE_DIFF,B2.PARENT_ID,'','',1,B2.LEVEL_RANK,b2.ORDER_HIERARCHY_CODE
FROM TEMP_DT_VALUE A2
INNER JOIN SYS_BUSINESS_UNIT B2 ON A2.PARENT_ID = B2.ID AND B2.IS_COMPANY = 1
)
						SELECT A.ID AS "id",
									 --主键id（生成树的id，唯一可以是业务id）
									 A.PARENT_ID AS "parentId",
									 --父级id（生成树父级id）
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/value-project/detail?code=value_dtl&isOperate=' ||
												 A.PROJ_COOPERATE || '&projectId=' || A.ID || '&projectName=' ||
												 A.ORG_NAME || '&projectDate=' || A.TAKE_DATE || '&tabIndex=' ||
												 TABSINDEX || '&pageTitle=' || A.ORG_NAME --页面标题名称
												ELSE
												 ''
										END) AS "openUrl",
									 --详情穿透打开地址code：穿透后的列表获取数据源存储过程注册编码
									 (CASE
												WHEN A.IS_COMPANY = 0 THEN
												 '/dwm/value-manage/dynamic-volume/circular?companyId=' || A.PARENT_ID ||
												 '&projectId=' || A.ID || '&type=2' --companyId加载项目的公司id，项目id：默认选中的项目id，type：货量是1，货值是2
												ELSE
												 ''
										END) AS "openVisualUrl",
									 --打开可视化地址
									 ORG_LEVEL,
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '#eaf6ff'
												WHEN ORG_LEVEL = 2 THEN
												 '#ecfbee'
												WHEN ORG_LEVEL = 3 THEN
												 '#f2eed4'
												ELSE
												 ''
										END AS "excelRowBgColor",
									 --数据行导出excel背景色
									 CASE
												WHEN ORG_LEVEL = 1 THEN
												 '' || ORG_NAME
												WHEN ORG_LEVEL = 2 THEN
												 '        ' || ORG_NAME
												WHEN ORG_LEVEL = 3 THEN
												 '                ' || ORG_NAME
												WHEN ORG_LEVEL = 4 THEN
												 '                        ' || ORG_NAME
												ELSE
												 '                                ' || ORG_NAME
										END AS "excelRowTextTreeOrgName",
									 --文本前面加空格模仿树
									 A.ORG_NAME AS "orgName",--公司/项目
									 --TO_CHAR(b.area_dt_all, '999,999,999,999,990.00') AS "newestBuildArea",--最新建筑面积
									 TO_CHAR( NVL(SUM(A.CW_AREA_DT_ALL),0), '999,999,999,999,990.00') AS "targetSalesArea",--最新可售面积（不含车位）
									 '-' AS "targetFeasibleWorth",--目标总货值（A）-可研版(A2)
									 '-' AS "targetWholeWorth",--目标总货值（A）-全盘版(A2)
									 '-' AS "targetDynamicWorth",--目标总货值（A）-动态版(A3)
									  '-' AS "targetNewestWorth",--目标总货值（A）-最新版(A)

                   '-' AS "dynamicTotalWorth",--动态总货值(B)
									 '-' AS "dynamicTotalWorthDifference",--总货值差额(B-A)
									 TO_CHAR( NVL(SUM(A.CW_VALUE_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "reserveTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-储备货值(B1)
									 TO_CHAR( NVL(SUM(A.CW_VALUE_IN_PROCESS),0) / 10000, '999,999,999,999,990.00') AS "inProcessTotalWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-在途货值(B2)--修改字段holdConstructionPermit=》inTransitWorth
									 TO_CHAR(  NVL(SUM(nvl(A.CW_VALUE_REMAIN,0)),0) / 10000 ,'999,999,999,999,990.00') AS "stockWorth",  --动态总货值构成（B=B1+B2+B3+B4）-库存货值(B3)
									 TO_CHAR( NVL(SUM(A.CW_VALUE_HAVED_SALE),0) / 10000, '999,999,999,999,990.00') AS "alreadySalesWorth",
									 --动态总货值构成（B=B1+B2+B3+B4）-已售货值(B4)
									 TO_CHAR( NVL(SUM(A.CW_VALUE_REMAIN),0) / 10000, '999,999,999,999,990.00') AS "residueWorth",
									 --剩余货值(C=B1+B2+B3)
									 TO_CHAR( NVL(( SUM(A.CW_VALUE_Stock)+SUM(A.CW_VALUE_HAVED_SALE)),0)/10000, '999,999,999,999,990.00') AS "getWorth",
									 --已领证货值(D=B3+B4)
									 CASE
												WHEN  SUM(A.CW_VALUE_STOCK)+SUM(A.CW_VALUE_HAVED_SALE) = 0 
                        THEN  '-'
												ELSE
												 TO_CHAR( NVL(SUM(A.CW_VALUE_HAVED_SALE),0) / ( SUM(A.CW_VALUE_STOCK)+SUM(A.CW_VALUE_HAVED_SALE)) * 100, '999,999,999,999,990.00') || '%'
										END AS "salesRate",
									 --去化率(E=B4/D)
									 TO_CHAR(NVL( SUM(A.CW_VALUE_NOT_PLANNING_PERMIT),0) / 10000, '999,999,999,999,990.00') AS "noPlanningPermitObtainedPhase",
									 --F、动态货值的各阶段分布-F0未取规证
									 TO_CHAR( NVL(SUM(A.CW_VALUE_NOT_CONSTRUCTION_PER),0) / 10000, '999,999,999,999,990.00') AS "planningPermitObtainedOhase",
									 --F、动态货值的各阶段分布-F1规划许可证阶段
									 TO_CHAR( NVL(SUM(A.CW_VALUE_NOT_SALE_PERMIT),0) / 10000, '999,999,999,999,990.00') AS "constructionPermitOhase",
									 --F、动态货值的各阶段分布-F2施工许可证阶段
									 TO_CHAR( NVL(SUM(A.CW_VALUE_NOT_COMPLETION),0) / 10000, '999,999,999,999,990.00') AS "PreSalePermitPhase",
									 --F、动态货值的各阶段分布-F3预售许可证阶段
									 --TO_CHAR(b.value_yes_completion / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",--F、动态货值的各阶段分布-F4竣备阶段
									 TO_CHAR( NVL(SUM(A.CW_VALUE_YES_COMPLETION),0) / 10000, '999,999,999,999,990.00') AS "completedRecordPhase",
									 --F、动态货值的各阶段分布-F4竣备阶段
									 '-' AS "carryDownPhase",
									 --F、动态货值的各阶段分布-F5结转阶段

									 TO_CHAR( NVL(SUM(A.CW_VALUE_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "reserveWorth",
									 --G1、储备货值的量价情况-货值（G1=a1*b1）
									 TO_CHAR( NVL(SUM(A.CW_AREA_RESERVE),0), '999,999,999,999,990.00') AS "reserveCargo",
									 --G1、储备货值的量价情况-货量(a1)
									 '-' AS "reservePrice",
									 --G1、储备货值的量价情况-单价(b1)
									 TO_CHAR( NVL(SUM(A.CW_value_RESERVE),0) / 10000, '999,999,999,999,990.00') AS "inTransitWorth",
									 --G2、在途货值的量价情况-货值（G2=a2*b2）
									 TO_CHAR( NVL(SUM(A.CW_AREA_IN_PROCESS),0), '999,999,999,999,990.00') AS "inTransitCargo",
									 --G2、在途货值的量价情况-货量(a2)
									 '-' AS "inTransitPrice",
									 --G2、在途货值的量价情况-单价(b2)
									 TO_CHAR( NVL(SUM(CW_VALUE_STOCK),0) / 10000, '999,999,999,999,990.00') AS "stockWorth",
									 --G3、库存货值的量价情况-货值（G3=a3*b3）
									 TO_CHAR( NVL(SUM(A.CW_AREA_STOCK),0) , '999,999,999,999,990.00') AS "stockCargo",
									 --G3、库存货值的量价情况-货量(a3)
									 '-' AS "stockPrice",
									 --G3、库存货值的量价情况-单价(b3)
									 TO_CHAR( NVL(SUM(CW_VALUE_HAVED_SALE),0) / 10000, '999,999,999,999,990.00') AS "soldWorth",
									 --G4、已售货值的量价情况-货值（G4=a4*b4）
									 TO_CHAR( NVL(SUM(A.CW_AREA_HAVED_SALE),0), '999,999,999,999,990.00') AS "soldCargo",
									 --G4、已售货值的量价情况-货量(a4)
									 '-' AS "soldPrice" --G4、已售货值的量价情况-单价(b4)
						FROM   TEMP_DT_VALUE A
            INNER JOIN (SELECT p.ID FROM SYS_BUSINESS_UNIT p WHERE p.IS_COMPANY = 1 START WITH p.id = '' || unitid_val || '' CONNECT BY PRIOR p.ID = p.PARENT_ID
						           UNION ALL
											 SELECT M.ID FROM SYS_PROJECT M WHERE EXISTS (SELECT 1 FROM SYS_BUSINESS_UNIT N WHERE N.IS_COMPANY = 1 AND N.ID = M.UNIT_ID START WITH N.id = '' || unitid_val || '' CONNECT BY PRIOR N.ID = N.PARENT_ID)) b ON a.id = b.id
                       --WHERE  a.PROJ_COOPERATE =  (CASE WHEN ISOPERATE = '所有' THEN a.PROJ_COOPERATE WHEN ISOPERATE = '操盘' THEN  '操盘' ELSE '不操盘' END)    
						GROUP BY A.ID,A.ORG_NAME,A.PARENT_ID,A.IS_COMPANY,A.PROJ_COOPERATE，A.TAKE_DATE,ORG_LEVEL,A.ORDER_HIERARCHY_CODE
                    
                        order by ORDER_HIERARCHY_CODE;
		END IF;

END P_DWM_DT_VALUE_LIST;
/

prompt
prompt Creating procedure P_DWM_DT_EXCEL
prompt =================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_dwm_dt_excel (
    userid          IN              VARCHAR2, --当前用户id
    stationid       IN              VARCHAR2, --当前用户岗位id
    departmentid    IN              VARCHAR2, --当前用户部门id
    companyid       IN              VARCHAR2, --当前用户公司id
    unitid          IN              VARCHAR2, --选择公司id
    isoperate       IN              VARCHAR2,--是否操盘
    dttype          IN              VARCHAR2,--类型： dt_value:货值，dt_area:货量，value_dtl:货值，area_dtl:货量
    tabsindex       IN              INT, --选择选项卡。1开始
    colorfiled      OUT             VARCHAR2,--excel 指定颜色字段名称
    exceldescribe   OUT             VARCHAR2,--excel 顶部描述，空不显示对应区域
    excelname       OUT             VARCHAR2,--excel导出文件名，已弃用
    excelfileds     OUT             SYS_REFCURSOR,--excel需要导出的列及中文列名，及表头颜色
    info            OUT             SYS_REFCURSOR--返回结果
) AS
--动态货量管理-全案动态货量
--作者：陈丽
--日期：2019/12/17

    data_auth_spid   VARCHAR2(200);
    bizcode          VARCHAR2(200);
    v_sql            CLOB;
    v_tab1_sql       CLOB;
    v_build_sql      CLOB;
    v_tab2_sql       CLOB;
    v_tab3_sql       CLOB;
    v_pub_sql        CLOB;
    v_sql_exec       CLOB;
BEGIN
    exceldescribe := '全案动态表';--excel 顶部描述，空不显示对应区域
    excelname := '';--excel导出文件名，已弃用
    colorfiled := 'excelRowBgColor';
    v_build_sql := 'SELECT
                           2  as "order",
                           get_uuid() AS "id",
                             '''' AS "parentId",
                            ''newestBuildArea'' AS "filed",
                            ''最新建筑面积'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION '
    ;
    v_pub_sql := 'SELECT
                           1 as "order",
                             get_uuid() AS "id",
                             '''' AS "parentId",
                            ''excelRowTextTreeOrgName'' AS "filed",
                          case when '''
                 || dttype
                 || ''' = ''dt_value'' or '''
                 || dttype
                 || ''' = ''dt_area'' then ''公司/项目'' else ''项目/分期/业态/楼栋'' end AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                            UNION 
                        '
                 ;
    IF ( dttype = 'dt_area' OR dttype = 'area_dtl' ) THEN
        IF ( dttype = 'dt_area' ) THEN
            p_dwm_dt_area_list(userid => userid, stationid => stationid, departmentid => departmentid, companyid => companyid, unitid
            => unitid, isoperate => isoperate, tabsindex => tabsindex, info => info);
        ELSE
            p_dwm_dt_area_dtl(userid => userid, stationid => stationid, departmentid => departmentid, companyid => companyid, projectid
            => unitid, isoperate => isoperate, tabsindex => tabsindex, info => info);
        END IF;

        v_tab1_sql := '  
                        SELECT
                             3  as "order",
                             get_uuid() AS "id",
                             '''' AS "parentId",
                            ''newestSalesArea'' AS "filed",
                            ''最新可售面积（不含车位）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                            UNION
                            SELECT
                            4  as "order",
                            ''1'' AS "id",
                            '''' AS "parentId",
                            ''noCarportDynamicCargo'' AS "filed",
                            ''动态货量（不含车位）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                            4.1  as "order",
                            get_uuid() AS "id",
                             ''1'' AS "parentId",
                            ''dynamicCargo'' AS "filed",
                            ''动态货量'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor" --表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                         4.2  as "order",
                         get_uuid() AS "id",
                             ''1'' AS "parentId",
                            ''reserveCargo'' AS "filed",
                            ''储备货量(A1)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        4.3  as "order",
                         get_uuid() AS "id",
                             ''1'' AS "parentId",
                            ''inProcessTotalCargo'' AS "filed",
                            ''在途货量(A2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        4.4 as "order",
                         get_uuid() AS "id",
                             ''1'' AS "parentId",
                            ''stockCargo'' AS "filed",
                            ''库存货量(A3)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        4.5  as "order",
                         get_uuid() AS "id",
                             ''1'' AS "parentId",
                            ''alreadySalesCargo'' AS "filed",
                            ''已售货量(A4)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        5  as "order",
                              ''2'' AS "id",
                            '''' AS "parentId",
                            ''noPermitObtainedPhase'' AS "filed",
                            ''动态货量的各阶段分布（不含车位）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                          SELECT
                          5.1 as "order",
                            get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''noPermitObtainedPhase'' AS "filed",
                            ''0未取规证'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                          5.2  as "order",
                        get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''PermitObtainedOhase'' AS "filed",
                            ''1规划许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                          SELECT
                          5.3  as "order",
                          get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''constructionPermitOhase'' AS "filed",
                            ''2施工许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                         5.4  as "order",
                         get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''PreSalePermitPhase'' AS "filed",
                            ''3预售许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                          5.5 as "order",
                         get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''completedRecordPhase'' AS "filed",
                            ''4竣备阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                          5.6  as "order",
                         get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''carryDownPhase'' AS "filed",
                            ''5结转阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual'

        ;
        v_tab2_sql := ' 
                        SELECT
                           6  as "order",
                            ''3'' AS "id",
                            '''' AS "parentId",
                            ''dynamicCargo'' AS "filed",
                            ''动态货量（车位按“个”）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        6.1 as "order",
                            get_uuid() AS "id",
                             ''3'' AS "parentId",
                            ''carportDynamicCargo'' AS "filed",
                            ''动态货量'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor" --表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        6.2 as "order",
                         get_uuid() AS "id",
                             ''3'' AS "parentId",
                            ''carportReserveCargo'' AS "filed",
                            ''储备货量(A1)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        6.3  as "order",
                         get_uuid() AS "id",
                             ''3'' AS "parentId",
                            ''carportInProcessTotalCargo'' AS "filed",
                            ''在途货量(A2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        6.4  as "order",
                         get_uuid() AS "id",
                             ''3'' AS "parentId",
                            ''carportStockCargo'' AS "filed",
                            ''库存货量(A3)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        6.5  as "order",
                         get_uuid() AS "id",
                             ''3'' AS "parentId",
                            ''carportAlreadySalesCargo'' AS "filed",
                            ''已售货量(A4)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        7  as "order",
                              ''4'' AS "id",
                            '''' AS "parentId",
                            ''permitObtainedPhase'' AS "filed",
                            ''动态货量的各阶段分布（车位按“个”）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                          SELECT
                          7.1  as "order",
                            get_uuid() AS "id",
                             ''4'' AS "parentId",
                            ''carportNoPermitObtainedPhase'' AS "filed",
                            ''0未取规证'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        7.2  as "order",
                        get_uuid() AS "id",
                             ''4'' AS "parentId",
                            ''carportPermitObtainedOhase'' AS "filed",
                            ''1规划许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                          SELECT
                         7.3  as "order",
                          get_uuid() AS "id",
                             ''4'' AS "parentId",
                            ''carportConstructionPermitOhase'' AS "filed",
                            ''2施工许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                         7.4  as "order",
                         get_uuid() AS "id",
                             ''4'' AS "parentId",
                            ''carportPreSalePermitPhase'' AS "filed",
                            ''3预售许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                         7.5 as "order",
                         get_uuid() AS "id",
                             ''4'' AS "parentId",
                            ''carportCompletedRecordPhase'' AS "filed",
                            ''4竣备阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor" --表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                        7.6 as "order",
                         get_uuid() AS "id",
                             ''4'' AS "parentId",
                            ''carportCarryDownPhase'' AS "filed",
                            ''5结转阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual'
        ;
        v_tab3_sql := ' 
                        SELECT
                       8  as "order",
                            ''5'' AS "id",
                             '''' AS "parentId",
                            ''projSurplusArea'' AS "filed",
                            ''项目全案剩余可售货量（S=A+B+C+D）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                         8.1  as "order",
                             get_uuid() AS "id",
                             ''5'' AS "parentId",
                            ''projWholeDwellingArea'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                            UNION
                            SELECT
                            8.2 as "order",
                             get_uuid() AS "id",
                            ''5'' AS "parentId",
                            ''projWholeBusinessArea'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                         8.3 as "order",
                            get_uuid() AS "id",
                             ''5'' AS "parentId",
                            ''projWholeCarport'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor" --表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                         8.4  as "order",
                         get_uuid() AS "id",
                             ''5'' AS "parentId",
                            ''projWholeTotalArea'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                         9  as "order",
                         ''6'' AS "id",
                             '''' AS "parentId",
                            ''noA'' AS "filed",
                            ''A未取规证的可售货量'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        9.1  as "order",
                         get_uuid() AS "id",
                             ''6'' AS "parentId",
                            ''ADwellingArea'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                         9.2  as "order",
                         get_uuid() AS "id",
                             ''6'' AS "parentId",
                            ''ABusinessArea'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        9.3  as "order",
                             get_uuid() AS "id",
                            ''6'' AS "parentId",
                            ''ACarport'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                          SELECT
                           9.4 as "order",
                            get_uuid() AS "id",
                             ''6'' AS "parentId",
                            ''ATotalArea'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual

                            UNION
                        SELECT
                         10  as "order",
                         ''7'' AS "id",
                             '''' AS "parentId",
                            ''noB1'' AS "filed",
                            ''B已取规证未取施工证的可售货量'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                        10.1  as "order",
                         get_uuid() AS "id",
                             ''7'' AS "parentId",
                            ''BDwellingArea'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                         10.2 as "order",
                         get_uuid() AS "id",
                             ''7'' AS "parentId",
                            ''BBusinessArea'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                        SELECT
                         10.3  as "order",
                             get_uuid() AS "id",
                            ''7'' AS "parentId",
                            ''BCarport'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                          SELECT
                           10.4  as "order",
                            get_uuid() AS "id",
                             ''7'' AS "parentId",
                            ''BTotalArea'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual   
                        UNION
                        SELECT
                         11 as "order",
                        ''8'' AS "id",
                             '''' AS "parentId",
                            ''CA'' AS "filed",
                            ''C已取施工证未取预售证的可售货量'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                          SELECT
                            11.1 as "order",
                          get_uuid() AS "id",
                             ''8'' AS "parentId",
                            ''CDwellingArea'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                           11.2 as "order",
                         get_uuid() AS "id",
                             ''8'' AS "parentId",
                            ''CBusinessArea'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                           11.3 as "order",
                         get_uuid() AS "id",
                             ''8'' AS "parentId",
                            ''CCarport'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                        UNION
                         SELECT
                          11.4 as "order",
                         get_uuid() AS "id",
                             ''8'' AS "parentId",
                            ''CTotalArea'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                             UNION
                         SELECT
                          12 as "order",
                         ''9'' AS "id",
                             '''' AS "parentId",
                            ''DA'' AS "filed",
                            ''D已取预售证未售的可售货量'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                            UNION
                         SELECT
                           12.1 as "order",
                         get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''DDwellingArea'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                             UNION
                         SELECT
                           12.2 as "order",
                         get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''DBusinessArea'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                             UNION
                         SELECT
                           12.3 as "order",
                         get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''DCarport'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                              UNION
                         SELECT
                          12.4 as "order",
                         get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''DTotalArea'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual
                            '
        ;
        IF ( tabsindex = 1 ) THEN
            v_sql := v_pub_sql
                     || v_build_sql
                     || v_tab1_sql
                     || ' UNION '
                     || v_tab2_sql;
        ELSIF ( tabsindex = 2 OR tabsindex = 3 OR tabsindex = 4 ) THEN
            v_sql := v_pub_sql
                     || v_build_sql
                     || v_tab1_sql;
        ELSIF ( tabsindex = 5 ) THEN
            v_sql := v_pub_sql
                     || v_build_sql
                     || v_tab2_sql;
        ELSIF ( tabsindex = 6 ) THEN
            v_sql := v_pub_sql || v_tab3_sql;
        ELSE
            v_sql := v_pub_sql
                     || v_build_sql
                     || v_tab2_sql;
        END IF;

        v_sql_exec := 'select  level,
                             a."id",
                            a."parentId",
                            a."filed",
                            a."filedName",
                            a."filedTitleBgColor",
                            a."filedTitleColor"  from ('
                      || v_sql
                      || ') a   START WITH
                            "parentId" IS NULL
                        CONNECT BY
                            PRIOR "id" = "parentId"  order by a."order"'
                      ;
        dbms_output.put_line(v_sql_exec);
        OPEN excelfileds FOR v_sql_exec;

    ELSE
        IF ( dttype = 'dt_value' ) THEN
            p_dwm_dt_value_list(userid => userid, stationid => stationid, departmentid => departmentid, companyid => companyid, unitid
            => unitid, isoperate => isoperate, tabsindex => tabsindex, info => info);
        ELSE
            p_dwm_dt_value_dtl(userid => userid, stationid => stationid, departmentid => departmentid, companyid => companyid, projectid
            => unitid, isoperate => isoperate, tabsindex => tabsindex, info => info);
        END IF;

        v_tab1_sql := ' SELECT
                          3 as "order",
                          ''2'' AS "id",
                             '''' AS "parentId",
                            ''A1'' AS "filed",
                            ''目标总货值（A）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                            SELECT
                              3.1 as "order",
                         get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''targetFeasibleWorth'' AS "filed",
                            ''可研版(A1)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                              SELECT
                                3.2 as "order",
                         get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''targetWholeWorth'' AS "filed",
                            ''全盘版(A2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               3.3 as "order",
                         get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''targetDynamicWorth'' AS "filed",
                            ''动态版(A3)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               3.4 as "order",
                         get_uuid() AS "id",
                             ''2'' AS "parentId",
                            ''targetNewestWorth'' AS "filed",
                            ''最新版(A4)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               4 as "order",
                         ''3'' AS "id",
                             '''' AS "parentId",
                            ''dynamicTotalWorth'' AS "filed",
                            ''动态总货值(B)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                              5 as "order",
                         ''4'' AS "id",
                             '''' AS "parentId",
                            ''dynamicTotalWorthDifference'' AS "filed",
                            ''总货值差额(B-A)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                               6 as "order",
                           ''5'' AS "id",
                             '''' AS "parentId",
                            ''dt'' AS "filed",
                            ''动态总货值构成（B=B1+B2+B3+B4）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               6.1 as "order",
                           get_uuid() AS "id",
                             ''5'' AS "parentId",
                            ''reserveTotalWorth'' AS "filed",
                            ''储备货值(B1)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                              6.2 as "order",
                           get_uuid() AS "id",
                             ''5'' AS "parentId",
                            ''inProcessTotalWorth'' AS "filed",
                            ''在途货值(B2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                               UNION
                             SELECT
                              6.3 as "order",
                           get_uuid() AS "id",
                             ''5'' AS "parentId",
                            ''stockWorth'' AS "filed",
                            ''库存货值(B3)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                             SELECT
                              6.4 as "order",
                           get_uuid() AS "id",
                             ''5'' AS "parentId",
                            ''alreadySalesWorth'' AS "filed",
                            ''已售货值(B4)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                              7 as "order",
                           ''6'' AS "id",
                             '''' AS "parentId",
                            ''residueWorth'' AS "filed",
                            ''剩余货值(C=B1+B2+B3)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                               8 as "order",
                           ''7'' AS "id",
                             '''' AS "parentId",
                            ''getWorth'' AS "filed",
                            ''已领证货值(D=B3+B4)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               9 as "order",
                           ''8'' AS "id",
                             '''' AS "parentId",
                            ''salesRate'' AS "filed",
                            ''去化率(E=B4/D)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                               10 as "order",
                           ''9'' AS "id",
                             '''' AS "parentId",
                            ''noPlanningPermitObtainedPhase'' AS "filed",
                            ''F、动态货值的各阶段分布'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               10.1 as "order",
                              get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''noPlanningPermitObtainedPhase'' AS "filed",
                            ''F0未取规证'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                               UNION
                             SELECT
                               10.2 as "order",
                              get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''planningPermitObtainedOhase'' AS "filed",
                            ''F1规划许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                               10.3 as "order",
                              get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''constructionPermitOhase'' AS "filed",
                            ''F2施工许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                              10.4 as "order",
                              get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''PreSalePermitPhase'' AS "filed",
                            ''F3预售许可证阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                                10.5 as "order",
                              get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''completedRecordPhase'' AS "filed",
                            ''F4竣备阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                               UNION
                             SELECT
                                10.6 as "order",
                              get_uuid() AS "id",
                             ''9'' AS "parentId",
                            ''carryDownPhase'' AS "filed",
                            ''F5结转阶段'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                               UNION
                             SELECT
                                11 as "order",
                             ''10'' AS "id",
                             '''' AS "parentId",
                            ''G1'' AS "filed",
                            ''G1、储备货值的量价情况'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               11.1 as "order",
                             get_uuid() AS "id",
                             ''10'' AS "parentId",
                            ''reserveWorth'' AS "filed",
                            ''货值（G1=a1*b1）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                               11.2 as "order",
                             get_uuid() AS "id",
                             ''10'' AS "parentId",
                            ''reserveCargo'' AS "filed",
                            ''货值(a1)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                               11.3 as "order",
                             get_uuid() AS "id",
                             ''10'' AS "parentId",
                            ''reservePrice'' AS "filed",
                            ''单价(b1)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               12 as "order",
                             ''11'' AS "id",
                             '''' AS "parentId",
                            ''reservePrice'' AS "filed",
                            ''G2、在途货值的量价情况'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               12.1 as "order",
                             get_uuid() AS "id",
                             ''11'' AS "parentId",
                            ''inTransitWorth'' AS "filed",
                            ''货值（G2=a2*b2）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                               12.2 as "order",
                             get_uuid() AS "id",
                             ''11'' AS "parentId",
                            ''inTransitCargo'' AS "filed",
                            ''货值(a2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                               12.3 as "order",
                             get_uuid() AS "id",
                             ''11'' AS "parentId",
                            ''inTransitPrice'' AS "filed",
                            ''单价(b2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                               13 as "order",
                             ''12'' AS "id",
                             '''' AS "parentId",
                            ''G3'' AS "filed",
                            ''G3、库存货值的量价情况'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                                  13.1 as "order",
                             get_uuid() AS "id",
                             ''12'' AS "parentId",
                            ''stockWorth'' AS "filed",
                            ''货值（G3=a3*b3）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                               UNION
                             SELECT
                                  13.2 as "order",
                             get_uuid() AS "id",
                             ''12'' AS "parentId",
                            ''stockCargo'' AS "filed",
                            ''货值(a3)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                                  13.3 as "order",
                             get_uuid() AS "id",
                             ''12'' AS "parentId",
                            ''stockPrice'' AS "filed",
                            ''单价(b3)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                                  14 as "order",
                             ''13'' AS "id",
                             '''' AS "parentId",
                            ''G4'' AS "filed",
                            ''G4、已售货值的量价情况'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                              UNION
                             SELECT
                                14.1 as "order",
                            get_uuid() AS "id",
                             ''13'' AS "parentId",
                            ''soldWorth'' AS "filed",
                            ''货值（G4=a4*b4）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                             UNION
                             SELECT
                                14.2 as "order",
                            get_uuid() AS "id",
                             ''13'' AS "parentId",
                            ''soldCargo'' AS "filed",
                            ''货值(a4)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                             SELECT
                                14.3 as "order",
                            get_uuid() AS "id",
                             ''13'' AS "parentId",
                            ''soldPrice'' AS "filed",
                            ''单价(b4)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual '

        ;
        v_tab2_sql := ' SELECT
                              15 as "order",
                            ''14'' AS "id",
                             '''' AS "parentId",
                            ''S1'' AS "filed",
                            ''项目全案剩余可售货值（万元）（S=A+B+C+D）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                            SELECT
                            15.1 as "order",
                          get_uuid() AS "id",
                             ''14'' AS "parentId",
                            ''projWholeDwellingValue'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                               SELECT
                                   15.2 as "order",
                          get_uuid() AS "id",
                             ''14'' AS "parentId",
                            ''projWholeBusinessValue'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                 SELECT
                                   15.3 as "order",
                          get_uuid() AS "id",
                             ''14'' AS "parentId",
                            ''projWholeCarportValue'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                  SELECT
                                    15.4 as "order",
                          get_uuid() AS "id",
                             ''14'' AS "parentId",
                            ''projWholeTotalValue'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                            SELECT
                              16 as "order",
                            ''15'' AS "id",
                             '''' AS "parentId",
                            ''S2'' AS "filed",
                            ''A未取规证的可售货值（万元）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                            SELECT
                              16.1 as "order",
                          get_uuid() AS "id",
                             ''15'' AS "parentId",
                            ''ADwellingValue'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                               SELECT
                               16.2 as "order",
                          get_uuid() AS "id",
                             ''15'' AS "parentId",
                            ''ABusinessValue'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                 SELECT
                                 16.3 as "order",
                          get_uuid() AS "id",
                             ''15'' AS "parentId",
                            ''ACarportValue'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                  SELECT
                                  16.4 as "order",
                          get_uuid() AS "id",
                             ''15'' AS "parentId",
                            ''ATotalValue'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                             SELECT
                             17 as "order",
                            ''16'' AS "id",
                             '''' AS "parentId",
                            ''S3'' AS "filed",
                            ''B已取规证未取施工证的可售货值（万元）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                            SELECT
                              17.1 as "order",
                          get_uuid() AS "id",
                             ''16'' AS "parentId",
                            ''BDwellingValue'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                               SELECT
                                  17.2 as "order",
                          get_uuid() AS "id",
                             ''16'' AS "parentId",
                            ''BBusinessValue'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                 SELECT
                                   17.3 as "order",
                          get_uuid() AS "id",
                             ''16'' AS "parentId",
                            ''BCarportValue'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                  SELECT
                                    17.4 as "order",
                          get_uuid() AS "id",
                             ''16'' AS "parentId",
                            ''BTotalValue'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                SELECT
                                  18 as "order",
                            ''17'' AS "id",
                             '''' AS "parentId",
                            ''S4'' AS "filed",
                            ''C已取施工证未取预售证的可售货值（万元）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                            SELECT
                            18.1 as "order",
                          get_uuid() AS "id",
                             ''17'' AS "parentId",
                            ''CDwellingValue'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                               SELECT
                               18.2 as "order",
                          get_uuid() AS "id",
                             ''17'' AS "parentId",
                            ''CBusinessValue'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                 SELECT
                                 18.3 as "order",
                          get_uuid() AS "id",
                             ''17'' AS "parentId",
                            ''CCarportValue'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                  SELECT
                                  18.4 as "order",
                          get_uuid() AS "id",
                             ''17'' AS "parentId",
                            ''CTotalValue'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                               SELECT
                               19 as "order",
                            ''18'' AS "id",
                             '''' AS "parentId",
                            ''S5'' AS "filed",
                            ''D已取预售证未售的可售货值（万元）'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                            SELECT
                                19.1 as "order",
                          get_uuid() AS "id",
                             ''18'' AS "parentId",
                            ''DDwellingValue'' AS "filed",
                            ''住宅(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                               SELECT
                                  19.2 as "order",
                          get_uuid() AS "id",
                             ''18'' AS "parentId",
                            ''DBusinessValue'' AS "filed",
                            ''商业(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                 SELECT
                                          19.3 as "order",
                          get_uuid() AS "id",
                             ''18'' AS "parentId",
                            ''DCarportValue'' AS "filed",
                            ''车位(个)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual 
                            UNION
                                  SELECT
                                           19.4 as "order",
                          get_uuid() AS "id",
                             ''18'' AS "parentId",
                            ''DTotalValue'' AS "filed",
                            ''合计(m2)'' AS "filedName",--
                            ''#c0aaae'' "filedTitleBgColor",--表头背景颜色,无颜色不设置
                            ''#f9f4f5'' "filedTitleColor"--表头文字颜色,无颜色不设置
                        FROM
                            dual '
        ;
        IF ( tabsindex = 1 OR tabsindex = 2 OR tabsindex = 3 OR tabsindex = 4 OR tabsindex = 5 ) THEN
            v_sql := v_pub_sql || v_tab1_sql;
        ELSIF ( tabsindex = 6 ) THEN
            v_sql := v_pub_sql || v_tab2_sql;
        END IF;

        v_sql_exec := 'select  level,
                              a."id",
                            a."parentId",
                            a."filed",
                            a."filedName",
                            a."filedTitleBgColor",
                            a."filedTitleColor"  from ('
                      || v_sql
                      || ') a   START WITH
                            "parentId" IS NULL
                        CONNECT BY
                            PRIOR "id" = "parentId" order by a."order" '
                      ;
        OPEN excelfileds FOR v_sql_exec;

    END IF;

END p_dwm_dt_excel;
/

prompt
prompt Creating procedure P_DWM_EXPLANATIONBYCODE
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_ExplanationByCode(keycode in varchar2,Explanation out clob)
as
keycodeStr varchar2(100):='';
begin
Explanation:='';
    if keycode is not null then
     keycodeStr:=keycode||'.explanation';
     end if;
    select DETAILS into Explanation from DWM_SALE_RATE_DATA_BRIEFING where code=keycodeStr and rownum=1;
end P_DWM_ExplanationByCode;
/

prompt
prompt Creating procedure P_DWM_GET_DT_VALUE
prompt =====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_GET_DT_VALUE
IS
/*
CREATE BY:WANGCK
CREATE DATE:20200601
后续需优化事项：取可研阶段数据时，要按照地块下的业态去取。
*/


    CURSOR CUR_BLD_LIST IS --取楼栋基础信息。
        SELECT A.ID, A.PROJ_ID, A.PERIOD_ID, A.BUILD_NAME, A.IS_GET_CON_PLAN_PERMIT, A.GET_CON_PLAN_PERMIT_DATE, A.IS_GET_CONSTRCUTION_PERMIT, A.GET_CONSTRCUTION_PERMIT_DATE, A.IS_GET_PRE_SALE_PERMIT,
               A.GET_PRE_SALE_PERMIT_DATE, A.IS_GET_COMPLETED_PERMIT, A.GET_COMPLETED_PERMIT_DATE
        FROM   MDM_BUILD A
        WHERE  NVL(A.IS_DELETE, 0) = 0
        ;

    ITEM_BLD_LIST CUR_BLD_LIST%ROWTYPE;

    V_NEWEST_PHASE VARCHAR2(100); --存储楼栋当前对应阶段，跟据此值更新对应动态货值。

    CURSOR CUR_ROOM_ACCOUNT_LIST(V_BLD_ID VARCHAR2) IS --计算“已推货值”使用，取从《销售系统》同步房源数据。
    SELECT B.BUILDING_ID, B.PROJECT_NAME, B.PROJECT_ID AS PROJ_ID,
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' THEN ROUND(B.BZ_PRICE * NVL(B.NEW_BLD_AREA, 0), 2) ELSE 0 END), 0)) AS ALL库存货值_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' THEN NVL(B.TRADE_TOTAL, 0) ELSE 0 END), 0)) AS ALL已售货值_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' THEN ROUND(B.BZ_PRICE * NVL(B.NEW_BLD_AREA, 0), 2) ELSE 0 END), 0)) + SUM(NVL((CASE WHEN B.SALE_STATE = '签约' THEN NVL(B.TRADE_TOTAL, 0) ELSE 0 END), 0)) AS ALL库存及已售总货值 ,
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' THEN NVL(B.NEW_BLD_AREA, 0) ELSE 0 END), 0)) AS ALL库存面积_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' THEN NVL(B.NEW_BLD_AREA, 0) ELSE 0 END), 0)) AS ALL已售面积_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' THEN 1 ELSE 0 END), 0)) AS ALL库存套数_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' THEN 1 ELSE 0 END), 0)) AS ALL已售套数_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' AND B.PRODUCT_NAME IN ('住宅', '商办') THEN NVL(B.NEW_BLD_AREA, 0) ELSE 0 END), 0)) AS ALL库存货量_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' AND B.PRODUCT_NAME IN ('住宅', '商办') THEN NVL(B.NEW_BLD_AREA, 0) ELSE 0 END), 0)) AS ALL已售货量_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME IN ('住宅', '商办') THEN B.ACTUAL_BLD_AREA ELSE 0 END), 0)) AS ALL竣备面积_房间合计,
         SUM(NVL((CASE WHEN NVL(B.ACTUAL_BLD_AREA, 0) <> 0 AND B.SALE_STATE = '签约' THEN B.TRADE_TOTAL WHEN NVL(B.ACTUAL_BLD_AREA, 0) <> 0 AND B.SALE_STATE <> '签约' THEN B.BZ_TOTAL ELSE 0 END), 0)) AS ALL竣备货值_房间合计,
         SUM(NVL((CASE WHEN B.IS_INDIRECT = 1 THEN B.TRADE_TOTAL ELSE 0 END), 0)) AS ALL结转货值_房间合计,
         SUM(NVL((CASE WHEN B.IS_INDIRECT = 1 THEN B.ACTUAL_BLD_AREA ELSE 0 END), 0)) AS ALL结转货量_房间合计 ,
         --住宅
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' AND B.PRODUCT_NAME = '住宅' THEN ROUND(B.BZ_PRICE * NVL(B.NEW_BLD_AREA, 0), 2) ELSE 0 END), 0)) AS ZZ库存货值_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' AND B.PRODUCT_NAME = '住宅' THEN NVL(B.TRADE_TOTAL, 0) ELSE 0 END), 0)) AS ZZ已售货值_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' AND B.PRODUCT_NAME = '住宅' THEN NVL(B.NEW_BLD_AREA, 0) ELSE 0 END), 0)) AS ZZ库存面积_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' AND B.PRODUCT_NAME = '住宅' THEN NVL(B.NEW_BLD_AREA, 0) ELSE 0 END), 0)) AS ZZ已售面积_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' AND B.PRODUCT_NAME = '住宅' THEN 1 ELSE 0 END), 0)) AS ZZ库存套数_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' AND B.PRODUCT_NAME = '住宅' THEN 1 ELSE 0 END), 0)) AS ZZ已售套数_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME = '住宅' THEN B.ACTUAL_BLD_AREA ELSE 0 END), 0)) AS ZZ竣备面积_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME = '住宅' AND B.SALE_STATE = '签约' AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0 THEN B.TRADE_TOTAL WHEN B.PRODUCT_NAME = '住宅' AND B.SALE_STATE <> '签约' AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0 THEN B.BZ_TOTAL ELSE 0 END), 0)) AS ZZ竣备货值_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME = '住宅' AND B.IS_INDIRECT = 1 THEN B.TRADE_TOTAL ELSE 0 END), 0)) AS ZZ结转货值_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME = '住宅' AND B.IS_INDIRECT = 1 THEN B.ACTUAL_BLD_AREA ELSE 0 END), 0)) AS ZZ结转货量_房间合计 ,
         --商业
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' AND B.PRODUCT_NAME = '商办' THEN ROUND(B.BZ_PRICE * NVL(B.NEW_BLD_AREA, 0), 2) ELSE 0 END), 0)) AS SY库存货值_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' AND B.PRODUCT_NAME = '商办' THEN NVL(B.TRADE_TOTAL, 0) ELSE 0 END), 0)) AS SY已售货值_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' AND B.PRODUCT_NAME = '商办' THEN NVL(B.NEW_BLD_AREA, 0) ELSE 0 END), 0)) AS SY库存面积_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' AND B.PRODUCT_NAME = '商办' THEN NVL(B.NEW_BLD_AREA, 0) ELSE 0 END), 0)) AS SY已售面积_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' AND B.PRODUCT_NAME = '商办' THEN 1 ELSE 0 END), 0)) AS SY库存套数_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' AND B.PRODUCT_NAME = '商办' THEN 1 ELSE 0 END), 0)) AS SY已售套数_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME = '商办' THEN B.ACTUAL_BLD_AREA ELSE 0 END), 0)) AS SY竣备面积_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME = '商办' AND B.SALE_STATE = '签约' AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0 THEN B.TRADE_TOTAL WHEN B.PRODUCT_NAME = '商办' AND B.SALE_STATE <> '签约' AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0 THEN B.BZ_TOTAL ELSE 0 END), 0)) AS SY竣备货值_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME = '商办' AND B.IS_INDIRECT = 1 THEN B.TRADE_TOTAL ELSE 0 END), 0)) AS SY结转货值_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME = '商办' AND B.IS_INDIRECT = 1 THEN B.ACTUAL_BLD_AREA ELSE 0 END), 0)) AS SY结转货量_房间合计 ,
         --住宅、商业
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' AND B.PRODUCT_NAME IN ('住宅', '商办') THEN ROUND(B.BZ_PRICE * NVL(B.NEW_BLD_AREA, 0), 2) ELSE 0 END), 0)) AS ZS库存货值_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' AND B.PRODUCT_NAME IN ('住宅', '商办') THEN NVL(B.TRADE_TOTAL, 0) ELSE 0 END), 0)) AS ZS已售货值_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' AND B.PRODUCT_NAME IN ('住宅', '商办') THEN NVL(B.NEW_BLD_AREA, 0) ELSE 0 END), 0)) AS ZS库存面积_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' AND B.PRODUCT_NAME IN ('住宅', '商办') THEN NVL(B.NEW_BLD_AREA, 0) ELSE 0 END), 0)) AS ZS已售面积_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' AND B.PRODUCT_NAME IN ('住宅', '商办') THEN 1 ELSE 0 END), 0)) AS ZS库存套数_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' AND B.PRODUCT_NAME IN ('住宅', '商办') THEN 1 ELSE 0 END), 0)) AS ZS已售套数_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME IN ('住宅', '商办') THEN B.ACTUAL_BLD_AREA ELSE 0 END), 0)) AS ZS竣备面积_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME IN ('住宅', '商办') AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0 AND B.SALE_STATE = '签约' THEN B.TRADE_TOTAL WHEN B.PRODUCT_NAME IN ('住宅', '商办') AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0 AND B.SALE_STATE <> '签约' THEN B.BZ_TOTAL ELSE 0 END), 0)) AS ZS竣备货值_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME IN ('住宅', '商办') AND B.IS_INDIRECT = 1 THEN B.TRADE_TOTAL ELSE 0 END), 0)) AS ZS结转货值_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME IN ('住宅', '商办') AND B.IS_INDIRECT = 1 THEN B.ACTUAL_BLD_AREA ELSE 0 END), 0)) AS ZS结转货量_房间合计 ,
         --车位
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' AND B.PRODUCT_NAME = '车位' THEN ROUND(B.BZ_PRICE * NVL(B.NEW_BLD_AREA, 0), 2) ELSE 0 END), 0)) AS CW库存货值_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' AND B.PRODUCT_NAME = '车位' THEN NVL(B.TRADE_TOTAL, 0) ELSE 0 END), 0)) AS CW已售货值_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' AND B.PRODUCT_NAME = '车位' THEN NVL(B.NEW_BLD_AREA, 0) ELSE 0 END), 0)) AS CW库存面积_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' AND B.PRODUCT_NAME = '车位' THEN NVL(B.NEW_BLD_AREA, 0) ELSE 0 END), 0)) AS CW已售面积_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE <> '签约' AND B.PRODUCT_NAME = '车位' THEN 1 ELSE 0 END), 0)) AS CW库存套数_房间合计,
         SUM(NVL((CASE WHEN B.SALE_STATE = '签约' AND B.PRODUCT_NAME = '车位' THEN 1 ELSE 0 END), 0)) AS CW已售套数_房间合计,
         SUM(CASE WHEN B.PRODUCT_NAME = '车位' AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0 THEN 1 ELSE 0 END) AS CW已竣备套数_房间合计,
         SUM(CASE WHEN B.PRODUCT_NAME = '车位' AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0 AND B.SALE_STATE = '签约' THEN B.TRADE_TOTAL WHEN B.PRODUCT_NAME = '车位' AND NVL(B.ACTUAL_BLD_AREA, 0) <> 0 AND B.SALE_STATE <> '签约' THEN B.BZ_TOTAL ELSE 0 END) AS CW已竣备货值_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME = '车位' AND B.IS_INDIRECT = 1 THEN B.TRADE_TOTAL ELSE 0 END), 0)) AS CW结转货值_房间合计,
         SUM(NVL((CASE WHEN B.PRODUCT_NAME = '车位' AND B.IS_INDIRECT = 1 THEN B.ACTUAL_BLD_AREA ELSE 0 END), 0)) AS CW结转货量_房间合计
  FROM   MDM_ROOM B
  WHERE B.BUILDING_ID = V_BLD_ID
  GROUP  BY B.PROJECT_NAME, B.PROJECT_ID, B.BUILDING_ID;
    ITEM_ROOM_ACCOUNT_LIST CUR_ROOM_ACCOUNT_LIST%ROWTYPE;

    CURSOR CUR_OBJ_INDEX_LIST(V_OBJ_ID VARCHAR2) IS --取楼栋“最新阶段”主数据下业态数据
        SELECT C.*
        FROM   MDM_BUILD A
        INNER  JOIN MDM_BUILD_PHASE B
        ON     A.ID = B.BUILD_ID AND B.PHASE_ORDER = (SELECT MAX(P.PHASE_ORDER) FROM MDM_BUILD_PHASE P WHERE P.BUILD_ID = B.BUILD_ID AND P.PHASE_STATE >= 19)
        INNER  JOIN MDM_OBJ_PHASE_PT_INDEX C
        ON     B.ID = C.OBJ_PHASE_ID
        WHERE  A.ID = V_OBJ_ID;
    ITEM_OBJ_INDEX_LIST CUR_OBJ_INDEX_LIST%ROWTYPE;

    CURSOR CUR_PERIOD_LIST IS --取当前主数据在“全盘阶段”的分期
        SELECT B.PROJECT_ID, A.ID AS PERIOD_ID, A.PERIOD_NAME, D.*
        FROM   MDM_PERIOD A
        INNER  JOIN MDM_PERIOD_VERSION B
        ON     A.PERIOD_VERSION_ID = B.ID
        INNER  JOIN MDM_PERIOD_PHASE C
        ON     A.ID = C.PERIOD_ID AND c.PHASE_ORDER = (SELECT MAX(p.PHASE_ORDER) FROM MDM_PERIOD_PHASE p WHERE p.PERIOD_ID = c.PERIOD_ID AND p.PHASE_STATE >= 19 GROUP BY p.PERIOD_ID HAVING MAX(p.PHASE_ORDER) = 2)
        INNER  JOIN MDM_OBJ_PHASE_PT_INDEX D
        ON     C.ID = D.OBJ_PHASE_ID
        ;
    ITEM_PERIOD_LIST CUR_PERIOD_LIST%ROWTYPE;

    CURSOR CUR_PROJECT_LIST IS --取当前主数据阶段在可研的项目
        SELECT A.ID AS PROJECT_ID, A.PROJECT_NAME, B.PHASE_ID, C.*
        FROM   MDM_PROJECT A
        INNER  JOIN MDM_PROJECT_PHASE B
        ON     A.ID = B.PROJ_ID AND B.PHASE_ORDER = (SELECT MAX(O.PHASE_ORDER) FROM MDM_PROJECT_PHASE O WHERE O.PROJ_ID = B.PROJ_ID AND O.PHASE_STATE >=19 GROUP BY O.PROJ_ID HAVING MAX(O.PHASE_ORDER) = 1)
        INNER  JOIN MDM_OBJ_PHASE_PT_INDEX C
        ON     B.ID = C.OBJ_PHASE_ID
        --WHERE a.ID = '50af8807-b767-4fc8-b7a1-d7fc1bce9384'
        ;
    ITEM_PROJECT_LIST CUR_PROJECT_LIST%ROWTYPE;


    V_PRODUCT_TYPE VARCHAR2(100); --计算“规证阶段、施工证阶段”动态货值时，存储一级业态

    V_COUNT              NUMBER(10, 2); --计数器
    V_TARGET_WORTH_PHASE NUMBER(10, 0); --最新目标货值版本
    V_WORTH_VERSION      NUMBER(10, 0); --目标货值VERSION
    V_TARGET_WORTH_ID    VARCHAR2(100); --最新目标货值ID
    V_IS_CARPORT         NUMBER(5, 0); --标记业态是否为车位，1：车位；0：非车位
    V_PRICE              NUMBER(20, 2); --业态均价

BEGIN
    /*楼栋级数据初始化为0*/
    UPDATE DWM_DT_VALUE A
    SET    VALUE_DT_ALL = 0, VALUE_REMAIN = 0, VALUE_HAVED_SALE = 0, VALUE_RESERVE = 0, VALUE_IN_PROCESS = 0, VALUE_ALLOW_SALE = 0, VALUE_STOCK = 0, VALUE_NOT_PLANNING_PERMIT = 0,
           VALUE_NOT_CONSTRUCTION_PERMIT = 0, VALUE_NOT_SALE_PERMIT = 0, VALUE_NOT_COMPLETION = 0, VALUE_YES_COMPLETION = 0, VALUE_YES_SETTLEMENT = 0, AREA_DT_ALL = 0, AREA_REMAIN = 0,
           AREA_HAVED_SALE = 0, AREA_RESERVE = 0, AREA_IN_PROCESS = 0, AREA_ALLOW_SALE = 0, AREA_STOCK = 0, AREA_NOT_PLANNING_PERMIT = 0, AREA_NOT_CONSTRUCTION_PERMIT = 0, AREA_NOT_SALE_PERMIT = 0,
           AREA_NOT_COMPLETION = 0, AREA_YES_COMPLETION = 0, AREA_YES_SETTLEMENT = 0, TMP_1KY_VALUE = 0, TMP_1KY_AREA = 0, TMP_1KY_PRICE = 0, TMP_2QP_VALUE = 0, TMP_2QP_AREA = 0, TMP_2QP_PRICE = 0,
           CW_VALUE_DT_ALL = 0, CW_VALUE_REMAIN = 0, CW_VALUE_HAVED_SALE = 0, CW_VALUE_RESERVE = 0, CW_VALUE_IN_PROCESS = 0, CW_VALUE_ALLOW_SALE = 0, CW_VALUE_STOCK = 0,
           CW_VALUE_NOT_PLANNING_PERMIT = 0, CW_VALUE_NOT_CONSTRUCTION_PER = 0, CW_VALUE_NOT_SALE_PERMIT = 0, CW_VALUE_NOT_COMPLETION = 0, CW_VALUE_YES_COMPLETION = 0, CW_VALUE_YES_SETTLEMENT = 0,
           CW_AREA_DT_ALL = 0, CW_AREA_REMAIN = 0, CW_AREA_HAVED_SALE = 0, CW_AREA_RESERVE = 0, CW_AREA_IN_PROCESS = 0, CW_AREA_ALLOW_SALE = 0, CW_AREA_STOCK = 0, CW_AREA_NOT_PLANNING_PERMIT = 0,
           CW_AREA_NOT_CONSTRUCTION_PER = 0, CW_AREA_NOT_SALE_PERMIT = 0, CW_AREA_NOT_COMPLETION = 0, CW_AREA_YES_COMPLETION = 0, CW_AREA_YES_SETTLEMENT = 0, ZZ_VALUE_DT_ALL = 0, ZZ_VALUE_REMAIN = 0,
           ZZ_VALUE_HAVED_SALE = 0, ZZ_VALUE_RESERVE = 0, ZZ_VALUE_IN_PROCESS = 0, ZZ_VALUE_ALLOW_SALE = 0, ZZ_VALUE_STOCK = 0, ZZ_VALUE_NOT_PLANNING_PERMIT = 0, ZZ_VALUE_NOT_CONSTRUCTION_PER = 0,
           ZZ_VALUE_NOT_SALE_PERMIT = 0, ZZ_VALUE_NOT_COMPLETION = 0, ZZ_VALUE_YES_COMPLETION = 0, ZZ_VALUE_YES_SETTLEMENT = 0, ZZ_AREA_DT_ALL = 0, ZZ_AREA_REMAIN = 0, ZZ_AREA_HAVED_SALE = 0,
           ZZ_AREA_RESERVE = 0, ZZ_AREA_IN_PROCESS = 0, ZZ_AREA_ALLOW_SALE = 0, ZZ_AREA_STOCK = 0, ZZ_AREA_NOT_PLANNING_PERMIT = 0, ZZ_AREA_NOT_CONSTRUCTION_PER = 0, ZZ_AREA_NOT_SALE_PERMIT = 0,
           ZZ_AREA_NOT_COMPLETION = 0, ZZ_AREA_YES_COMPLETION = 0, ZZ_AREA_YES_SETTLEMENT = 0, SY_VALUE_DT_ALL = 0, SY_VALUE_REMAIN = 0, SY_VALUE_HAVED_SALE = 0, SY_VALUE_RESERVE = 0,
           SY_VALUE_IN_PROCESS = 0, SY_VALUE_ALLOW_SALE = 0, SY_VALUE_STOCK = 0, SY_VALUE_NOT_PLANNING_PERMIT = 0, SY_VALUE_NOT_CONSTRUCTION_PER = 0, SY_VALUE_NOT_SALE_PERMIT = 0,
           SY_VALUE_NOT_COMPLETION = 0, SY_VALUE_YES_COMPLETION = 0, SY_VALUE_YES_SETTLEMENT = 0, SY_AREA_DT_ALL = 0, SY_AREA_REMAIN = 0, SY_AREA_HAVED_SALE = 0, SY_AREA_RESERVE = 0,
           SY_AREA_IN_PROCESS = 0, SY_AREA_ALLOW_SALE = 0, SY_AREA_STOCK = 0, SY_AREA_NOT_PLANNING_PERMIT = 0, SY_AREA_NOT_CONSTRUCTION_PER = 0, SY_AREA_NOT_SALE_PERMIT = 0, SY_AREA_NOT_COMPLETION = 0,
           SY_AREA_YES_COMPLETION = 0, SY_AREA_YES_SETTLEMENT = 0

 /*   WHERE  A.OBJ_TYPE = '楼栋'*/;

    OPEN CUR_BLD_LIST;
    LOOP
        FETCH CUR_BLD_LIST
            INTO ITEM_BLD_LIST;
        EXIT WHEN CUR_BLD_LIST%NOTFOUND;
        BEGIN
            --判断楼栋当前所处阶段,需考虑现售的情况
            IF ITEM_BLD_LIST.GET_COMPLETED_PERMIT_DATE IS NOT NULL THEN
                V_NEWEST_PHASE := '竣工备案证';
            ELSIF ITEM_BLD_LIST.GET_PRE_SALE_PERMIT_DATE IS NOT NULL THEN
                V_NEWEST_PHASE := '预售许可证';
            ELSIF ITEM_BLD_LIST.GET_CONSTRCUTION_PERMIT_DATE IS NOT NULL THEN
                V_NEWEST_PHASE := '施工许可证';
            ELSIF ITEM_BLD_LIST.GET_CON_PLAN_PERMIT_DATE IS NOT NULL THEN
                V_NEWEST_PHASE := '规划许可证';
            ELSE
                V_NEWEST_PHASE := '未取证';
            END IF;

            UPDATE MDM_BUILD A SET A.NEWEST_VALUE_PHASE = V_NEWEST_PHASE WHERE A.ID = ITEM_BLD_LIST.ID;
            --销售系统已有楼栋，但当前阶段未到“预售许可证”楼栋更新

            SELECT COUNT(1) INTO V_COUNT FROM MDM_BUILD A WHERE NVL(A.NEWEST_VALUE_PHASE,'未取证') IN ('未取证','规划许可证','施工许可证') AND EXISTS (SELECT 1 FROM MDM_ROOM P WHERE P.BUILDING_ID = A.ID) AND A.ID = ITEM_BLD_LIST.ID AND A.IS_EXISTING_HOME = 1 AND A.IS_PUSH_OUT = 1;
            IF V_COUNT <> 0 THEN
            UPDATE MDM_BUILD A SET A.NEWEST_VALUE_PHASE='预售许可证' WHERE NVL(A.NEWEST_VALUE_PHASE,'未取证') IN ('未取证','规划许可证','施工许可证') AND EXISTS (SELECT 1 FROM MDM_ROOM P WHERE P.BUILDING_ID = A.ID) AND A.ID = ITEM_BLD_LIST.ID;
            V_NEWEST_PHASE := '预售许可证';
            END IF;


            SELECT COUNT(1) INTO V_COUNT FROM MDM_BUILD A WHERE NVL(A.NEWEST_VALUE_PHASE,'未取证') IN ('未取证','规划许可证','施工许可证') AND EXISTS (SELECT 1 FROM MDM_ROOM P WHERE P.BUILDING_ID = A.ID) AND A.ID = ITEM_BLD_LIST.ID AND A.IS_PUSH_OUT = 0;
            IF V_COUNT <> 0 THEN
            UPDATE MDM_BUILD A SET A.NEWEST_VALUE_PHASE='预售许可证' WHERE NVL(A.NEWEST_VALUE_PHASE,'未取证') IN ('未取证','规划许可证','施工许可证') AND EXISTS (SELECT 1 FROM MDM_ROOM P WHERE P.BUILDING_ID = A.ID) AND A.ID = ITEM_BLD_LIST.ID;
            V_NEWEST_PHASE := '预售许可证';
            END IF;

            --DWM_DT_VALUE表楼栋数据处理

            /*
            ===========处理楼栋为竣工备案证阶段数据
            */
            IF V_NEWEST_PHASE = '竣工备案证' THEN

                --更新所有货值
                BEGIN
                    OPEN CUR_ROOM_ACCOUNT_LIST(ITEM_BLD_LIST.ID);
                    LOOP
                        FETCH CUR_ROOM_ACCOUNT_LIST
                            INTO ITEM_ROOM_ACCOUNT_LIST;
                        EXIT WHEN CUR_ROOM_ACCOUNT_LIST%NOTFOUND;
                        UPDATE DWM_DT_VALUE A
                        SET    (A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                                (SELECT ITEM_ROOM_ACCOUNT_LIST.ALL库存及已售总货值, ITEM_ROOM_ACCOUNT_LIST.ALL库存货值_房间合计, ITEM_ROOM_ACCOUNT_LIST.ALL已售货值_房间合计, 0, 0, ITEM_ROOM_ACCOUNT_LIST.ALL库存及已售总货值,
                                        ITEM_ROOM_ACCOUNT_LIST.ALL库存货值_房间合计, 0, 0, 0, 0, ITEM_ROOM_ACCOUNT_LIST.ALL库存及已售总货值, 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                        --更新车位货值
                        UPDATE DWM_DT_VALUE A
                        SET    (A.CW_VALUE_DT_ALL, A.CW_VALUE_REMAIN, A.CW_VALUE_HAVED_SALE, A.CW_VALUE_RESERVE, A.CW_VALUE_IN_PROCESS, A.CW_VALUE_ALLOW_SALE, A.CW_VALUE_STOCK, A.CW_VALUE_NOT_PLANNING_PERMIT, A.CW_VALUE_NOT_CONSTRUCTION_PER, A.CW_VALUE_NOT_SALE_PERMIT, A.CW_VALUE_NOT_COMPLETION, A.CW_VALUE_YES_COMPLETION, A.CW_VALUE_YES_SETTLEMENT) =
                                (SELECT NVL(ITEM_ROOM_ACCOUNT_LIST.CW库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.CW已售货值_房间合计, 0), ITEM_ROOM_ACCOUNT_LIST.CW库存货值_房间合计, ITEM_ROOM_ACCOUNT_LIST.CW已售货值_房间合计, 0,
                                        0, NVL(ITEM_ROOM_ACCOUNT_LIST.CW库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.CW已售货值_房间合计, 0), ITEM_ROOM_ACCOUNT_LIST.CW库存货值_房间合计, 0, 0, 0, 0,
                                        NVL(ITEM_ROOM_ACCOUNT_LIST.CW库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.CW已售货值_房间合计, 0), 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        --更新商业货值
                        UPDATE DWM_DT_VALUE A
                        SET    (A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT) =
                                (SELECT NVL(ITEM_ROOM_ACCOUNT_LIST.SY库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.SY已售货值_房间合计, 0), ITEM_ROOM_ACCOUNT_LIST.SY库存货值_房间合计, ITEM_ROOM_ACCOUNT_LIST.SY已售货值_房间合计, 0,
                                        0, NVL(ITEM_ROOM_ACCOUNT_LIST.SY库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.SY已售货值_房间合计, 0), ITEM_ROOM_ACCOUNT_LIST.SY库存货值_房间合计, 0, 0, 0, 0,
                                        NVL(ITEM_ROOM_ACCOUNT_LIST.SY库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.SY已售货值_房间合计, 0), 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        --更新住宅货值
                        UPDATE DWM_DT_VALUE A
                        SET    (A.ZZ_VALUE_DT_ALL, A.ZZ_VALUE_REMAIN, A.ZZ_VALUE_HAVED_SALE, A.ZZ_VALUE_RESERVE, A.ZZ_VALUE_IN_PROCESS, A.ZZ_VALUE_ALLOW_SALE, A.ZZ_VALUE_STOCK, A.ZZ_VALUE_NOT_PLANNING_PERMIT, A.ZZ_VALUE_NOT_CONSTRUCTION_PER, A.ZZ_VALUE_NOT_SALE_PERMIT, A.ZZ_VALUE_NOT_COMPLETION, A.ZZ_VALUE_YES_COMPLETION, A.ZZ_VALUE_YES_SETTLEMENT) =
                                (SELECT NVL(ITEM_ROOM_ACCOUNT_LIST.ZZ库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.ZZ已售货值_房间合计, 0), ITEM_ROOM_ACCOUNT_LIST.ZZ库存货值_房间合计, ITEM_ROOM_ACCOUNT_LIST.ZZ已售货值_房间合计, 0,
                                        0, NVL(ITEM_ROOM_ACCOUNT_LIST.ZZ库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.ZZ已售货值_房间合计, 0), ITEM_ROOM_ACCOUNT_LIST.ZZ库存货值_房间合计, 0, 0, 0, 0,
                                        NVL(ITEM_ROOM_ACCOUNT_LIST.ZZ库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.ZZ已售货值_房间合计, 0), 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        --更新所有货量
                        UPDATE DWM_DT_VALUE A
                        SET    (A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                                (SELECT ITEM_ROOM_ACCOUNT_LIST.ZS库存面积_房间合计 + ITEM_ROOM_ACCOUNT_LIST.ZS已售面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.ZS库存面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.ZS已售面积_房间合计, 0, 0,
                                        ITEM_ROOM_ACCOUNT_LIST.ZS库存面积_房间合计 + ITEM_ROOM_ACCOUNT_LIST.ZS已售面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.ZS库存面积_房间合计, 0, 0, 0, 0, ITEM_ROOM_ACCOUNT_LIST.ZS竣备面积_房间合计, 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        --更新车位货量
                        UPDATE DWM_DT_VALUE A
                        SET    (A.CW_AREA_DT_ALL, A.CW_AREA_REMAIN, A.CW_AREA_HAVED_SALE, A.CW_AREA_RESERVE, A.CW_AREA_IN_PROCESS, A.CW_AREA_ALLOW_SALE, A.CW_AREA_STOCK, A.CW_AREA_NOT_PLANNING_PERMIT, A.CW_AREA_NOT_CONSTRUCTION_PER, A.CW_AREA_NOT_SALE_PERMIT, A.CW_AREA_NOT_COMPLETION, A.CW_AREA_YES_COMPLETION, A.CW_AREA_YES_SETTLEMENT) =
                                (SELECT ITEM_ROOM_ACCOUNT_LIST.CW已竣备套数_房间合计, ITEM_ROOM_ACCOUNT_LIST.CW库存套数_房间合计, ITEM_ROOM_ACCOUNT_LIST.CW已售套数_房间合计, 0, 0, ITEM_ROOM_ACCOUNT_LIST.CW已竣备套数_房间合计,
                                        ITEM_ROOM_ACCOUNT_LIST.CW库存套数_房间合计, 0, 0, 0, 0, ITEM_ROOM_ACCOUNT_LIST.CW已竣备套数_房间合计, 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        --更新商业货量
                        UPDATE DWM_DT_VALUE A
                        SET    (A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT) =
                                (SELECT ITEM_ROOM_ACCOUNT_LIST.SY竣备面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.SY库存面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.SY已售面积_房间合计, 0, 0, ITEM_ROOM_ACCOUNT_LIST.SY竣备面积_房间合计,
                                        ITEM_ROOM_ACCOUNT_LIST.SY库存面积_房间合计, 0, 0, 0, 0, ITEM_ROOM_ACCOUNT_LIST.SY竣备面积_房间合计, 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        --更新住宅货量
                        UPDATE DWM_DT_VALUE A
                        SET    (A.ZZ_AREA_DT_ALL, A.ZZ_AREA_REMAIN, A.ZZ_AREA_HAVED_SALE, A.ZZ_AREA_RESERVE, A.ZZ_AREA_IN_PROCESS, A.ZZ_AREA_ALLOW_SALE, A.ZZ_AREA_STOCK, A.ZZ_AREA_NOT_PLANNING_PERMIT, A.ZZ_AREA_NOT_CONSTRUCTION_PER, A.ZZ_AREA_NOT_SALE_PERMIT, A.ZZ_AREA_NOT_COMPLETION, A.ZZ_AREA_YES_COMPLETION, A.ZZ_AREA_YES_SETTLEMENT) =
                                (SELECT ITEM_ROOM_ACCOUNT_LIST.ZZ竣备面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.ZZ库存面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.ZZ已售面积_房间合计, 0, 0, ITEM_ROOM_ACCOUNT_LIST.ZZ竣备面积_房间合计,
                                        ITEM_ROOM_ACCOUNT_LIST.ZZ库存面积_房间合计, 0, 0, 0, 0, ITEM_ROOM_ACCOUNT_LIST.ZZ竣备面积_房间合计, 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        /*
                        ==========更新楼栋为预售许可证阶段动态货值数据
                        */
                    END LOOP;
                    CLOSE CUR_ROOM_ACCOUNT_LIST;
                END;
            ELSIF V_NEWEST_PHASE = '预售许可证' THEN
                --更新所有货值
                BEGIN

                    OPEN CUR_ROOM_ACCOUNT_LIST(ITEM_BLD_LIST.ID);
                    LOOP
                        FETCH CUR_ROOM_ACCOUNT_LIST
                            INTO ITEM_ROOM_ACCOUNT_LIST;
                        EXIT WHEN CUR_ROOM_ACCOUNT_LIST%NOTFOUND;
                        UPDATE DWM_DT_VALUE A
                        SET    (A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                                (SELECT ITEM_ROOM_ACCOUNT_LIST.ALL库存及已售总货值, ITEM_ROOM_ACCOUNT_LIST.ALL库存货值_房间合计, ITEM_ROOM_ACCOUNT_LIST.ALL已售货值_房间合计, 0, 0, ITEM_ROOM_ACCOUNT_LIST.ALL库存及已售总货值,
                                        ITEM_ROOM_ACCOUNT_LIST.ALL库存货值_房间合计, 0, 0, 0, ITEM_ROOM_ACCOUNT_LIST.ALL库存及已售总货值, 0, 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        --更新车位货值
                        UPDATE DWM_DT_VALUE A
                        SET    (A.CW_VALUE_DT_ALL, A.CW_VALUE_REMAIN, A.CW_VALUE_HAVED_SALE, A.CW_VALUE_RESERVE, A.CW_VALUE_IN_PROCESS, A.CW_VALUE_ALLOW_SALE, A.CW_VALUE_STOCK, A.CW_VALUE_NOT_PLANNING_PERMIT, A.CW_VALUE_NOT_CONSTRUCTION_PER, A.CW_VALUE_NOT_SALE_PERMIT, A.CW_VALUE_NOT_COMPLETION, A.CW_VALUE_YES_COMPLETION, A.CW_VALUE_YES_SETTLEMENT) =
                                (SELECT NVL(ITEM_ROOM_ACCOUNT_LIST.CW库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.CW已售货值_房间合计, 0), ITEM_ROOM_ACCOUNT_LIST.CW库存货值_房间合计, ITEM_ROOM_ACCOUNT_LIST.CW已售货值_房间合计, 0,
                                        0, NVL(ITEM_ROOM_ACCOUNT_LIST.CW库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.CW已售货值_房间合计, 0), ITEM_ROOM_ACCOUNT_LIST.CW库存货值_房间合计, 0, 0, 0,
                                        NVL(ITEM_ROOM_ACCOUNT_LIST.CW库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.CW已售货值_房间合计, 0), 0, 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        --更新商业货值
                        UPDATE DWM_DT_VALUE A
                        SET    (A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT) =
                                (SELECT NVL(ITEM_ROOM_ACCOUNT_LIST.SY库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.SY已售货值_房间合计, 0), ITEM_ROOM_ACCOUNT_LIST.SY库存货值_房间合计, ITEM_ROOM_ACCOUNT_LIST.SY已售货值_房间合计, 0,
                                        0, NVL(ITEM_ROOM_ACCOUNT_LIST.SY库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.SY已售货值_房间合计, 0), ITEM_ROOM_ACCOUNT_LIST.SY库存货值_房间合计, 0, 0, 0,
                                        NVL(ITEM_ROOM_ACCOUNT_LIST.SY库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.SY已售货值_房间合计, 0), 0, 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        --更新住宅货值
                        UPDATE DWM_DT_VALUE A
                        SET    (A.ZZ_VALUE_DT_ALL, A.ZZ_VALUE_REMAIN, A.ZZ_VALUE_HAVED_SALE, A.ZZ_VALUE_RESERVE, A.ZZ_VALUE_IN_PROCESS, A.ZZ_VALUE_ALLOW_SALE, A.ZZ_VALUE_STOCK, A.ZZ_VALUE_NOT_PLANNING_PERMIT, A.ZZ_VALUE_NOT_CONSTRUCTION_PER, A.ZZ_VALUE_NOT_SALE_PERMIT, A.ZZ_VALUE_NOT_COMPLETION, A.ZZ_VALUE_YES_COMPLETION, A.ZZ_VALUE_YES_SETTLEMENT) =
                                (SELECT NVL(ITEM_ROOM_ACCOUNT_LIST.ZZ库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.ZZ已售货值_房间合计, 0), ITEM_ROOM_ACCOUNT_LIST.ZZ库存货值_房间合计, ITEM_ROOM_ACCOUNT_LIST.ZZ已售货值_房间合计, 0,
                                        0, NVL(ITEM_ROOM_ACCOUNT_LIST.ZZ库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.ZZ已售货值_房间合计, 0), ITEM_ROOM_ACCOUNT_LIST.ZZ库存货值_房间合计, 0, 0, 0,
                                        NVL(ITEM_ROOM_ACCOUNT_LIST.ZZ库存货值_房间合计, 0) + NVL(ITEM_ROOM_ACCOUNT_LIST.ZZ已售货值_房间合计, 0), 0, 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        --更新所有货量
                        UPDATE DWM_DT_VALUE A
                        SET    (A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                                (SELECT ITEM_ROOM_ACCOUNT_LIST.ZS库存面积_房间合计 + ITEM_ROOM_ACCOUNT_LIST.ZS已售面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.ZS库存面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.ZS已售面积_房间合计, 0, 0,
                                        ITEM_ROOM_ACCOUNT_LIST.ZS库存面积_房间合计 + ITEM_ROOM_ACCOUNT_LIST.ZS已售面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.ZS库存面积_房间合计, 0, 0, 0,
                                        ITEM_ROOM_ACCOUNT_LIST.ZS库存面积_房间合计 + ITEM_ROOM_ACCOUNT_LIST.ZS已售面积_房间合计, 0, 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        --更新车位货量
                        UPDATE DWM_DT_VALUE A
                        SET    (A.CW_AREA_DT_ALL, A.CW_AREA_REMAIN, A.CW_AREA_HAVED_SALE, A.CW_AREA_RESERVE, A.CW_AREA_IN_PROCESS, A.CW_AREA_ALLOW_SALE, A.CW_AREA_STOCK, A.CW_AREA_NOT_PLANNING_PERMIT, A.CW_AREA_NOT_CONSTRUCTION_PER, A.CW_AREA_NOT_SALE_PERMIT, A.CW_AREA_NOT_COMPLETION, A.CW_AREA_YES_COMPLETION, A.CW_AREA_YES_SETTLEMENT) =
                                (SELECT ITEM_ROOM_ACCOUNT_LIST.CW库存套数_房间合计 + ITEM_ROOM_ACCOUNT_LIST.CW已售套数_房间合计, ITEM_ROOM_ACCOUNT_LIST.CW库存套数_房间合计, ITEM_ROOM_ACCOUNT_LIST.CW已售套数_房间合计, 0, 0,
                                        ITEM_ROOM_ACCOUNT_LIST.CW库存套数_房间合计 + ITEM_ROOM_ACCOUNT_LIST.CW已售套数_房间合计, ITEM_ROOM_ACCOUNT_LIST.CW库存套数_房间合计, 0, 0, 0,
                                        ITEM_ROOM_ACCOUNT_LIST.CW库存套数_房间合计 + ITEM_ROOM_ACCOUNT_LIST.CW已售套数_房间合计, 0, 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        --更新商业货量
                        UPDATE DWM_DT_VALUE A
                        SET    (A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT) =
                                (SELECT ITEM_ROOM_ACCOUNT_LIST.SY库存面积_房间合计 + ITEM_ROOM_ACCOUNT_LIST.SY已售面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.SY库存面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.SY已售面积_房间合计, 0, 0,
                                        ITEM_ROOM_ACCOUNT_LIST.SY库存面积_房间合计 + ITEM_ROOM_ACCOUNT_LIST.SY已售面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.SY库存面积_房间合计, 0, 0, 0,
                                        ITEM_ROOM_ACCOUNT_LIST.SY库存面积_房间合计 + ITEM_ROOM_ACCOUNT_LIST.SY已售面积_房间合计, 0, 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                        --更新住宅货量
                        UPDATE DWM_DT_VALUE A
                        SET    (A.ZZ_AREA_DT_ALL, A.ZZ_AREA_REMAIN, A.ZZ_AREA_HAVED_SALE, A.ZZ_AREA_RESERVE, A.ZZ_AREA_IN_PROCESS, A.ZZ_AREA_ALLOW_SALE, A.ZZ_AREA_STOCK, A.ZZ_AREA_NOT_PLANNING_PERMIT, A.ZZ_AREA_NOT_CONSTRUCTION_PER, A.ZZ_AREA_NOT_SALE_PERMIT, A.ZZ_AREA_NOT_COMPLETION, A.ZZ_AREA_YES_COMPLETION, A.ZZ_AREA_YES_SETTLEMENT) =
                                (SELECT ITEM_ROOM_ACCOUNT_LIST.ZZ库存面积_房间合计 + ITEM_ROOM_ACCOUNT_LIST.ZZ已售面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.ZZ库存面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.ZZ已售面积_房间合计, 0, 0,
                                        ITEM_ROOM_ACCOUNT_LIST.ZZ库存面积_房间合计 + ITEM_ROOM_ACCOUNT_LIST.ZZ已售面积_房间合计, ITEM_ROOM_ACCOUNT_LIST.ZZ库存面积_房间合计, 0, 0, 0,
                                        ITEM_ROOM_ACCOUNT_LIST.ZZ库存面积_房间合计 + ITEM_ROOM_ACCOUNT_LIST.ZZ已售面积_房间合计, 0, 0
                                 FROM   DUAL)
                        WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                    END LOOP;
                    CLOSE CUR_ROOM_ACCOUNT_LIST;
                END;
                /*
                ===========更新楼栋在施工证阶段货值数据
                */
            ELSIF V_NEWEST_PHASE = '施工许可证' THEN
                BEGIN

                    OPEN CUR_OBJ_INDEX_LIST(ITEM_BLD_LIST.ID);
                    LOOP
                        --开始循环，取楼栋下业态数据
                        FETCH CUR_OBJ_INDEX_LIST
                            INTO ITEM_OBJ_INDEX_LIST;
                        EXIT WHEN CUR_OBJ_INDEX_LIST%NOTFOUND;

                        V_PRODUCT_TYPE := SUBSTR(ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_NAME, 0, INSTR(ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_NAME, '/', 1) - 1); --取一级业态
                        V_IS_CARPORT := CASE
                                            WHEN ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_JSON = '{"isCarport":1}' THEN
                                             1
                                            ELSE
                                             0
                                        END; -- 取当前业态是否为车位，1：车位；0：非车位

                        --取最新的业态均价，取值原则：动态版→全盘版→可研版


                        SELECT COUNT(1) INTO V_COUNT FROM DWM_DT_VALUE A WHERE A.TARGET_A_ID IS NOT NULL AND A.OBJ_ID = ITEM_BLD_LIST.ID;

                        IF V_COUNT = 0 THEN
                            --无目标货值
                            V_PRICE := 0;
                        ELSE
                            SELECT COUNT(1) INTO V_COUNT FROM DWM_DT_VALUE A WHERE A.OBJ_ID = ITEM_BLD_LIST.ID AND A.OBJ_TYPE = '楼栋';
                            SELECT A.TARGET_A_ID INTO V_TARGET_WORTH_ID FROM DWM_DT_VALUE A WHERE A.OBJ_ID = ITEM_BLD_LIST.ID AND A.OBJ_TYPE = '楼栋';


                            SELECT A.TARGET_WORTH_PHASE INTO V_TARGET_WORTH_PHASE FROM DWM_TARGET_WORTH A WHERE A.ID = V_TARGET_WORTH_ID;

                            IF V_TARGET_WORTH_PHASE = 0 THEN

                                SELECT COUNT(1) INTO V_COUNT FROM DWM_TARGET_WORTH_DTL A WHERE A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;

                                IF V_COUNT = 1 THEN
                                    SELECT NVL(A.AVERAGE_PRICE, 0)
                                    INTO   V_PRICE
                                    FROM   DWM_TARGET_WORTH_DTL A
                                    WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;
                                ELSE
                                    V_PRICE := 0;
                                END IF;

                            ELSIF V_TARGET_WORTH_PHASE = 10 THEN
                                SELECT COUNT(1)
                                INTO   V_COUNT
                                FROM   DWM_TARGET_WORTH_DTL A
                                WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_PARENT_ID = ITEM_BLD_LIST.PERIOD_ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;

                                IF V_COUNT = 1 THEN
                                    SELECT NVL(A.AVERAGE_PRICE, 0)
                                    INTO   V_PRICE
                                    FROM   DWM_TARGET_WORTH_DTL A
                                    WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_PARENT_ID = ITEM_BLD_LIST.PERIOD_ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;
                                ELSE
                                    V_PRICE := 0;
                                END IF;

                            ELSE
                                SELECT COUNT(1)
                                INTO   V_COUNT
                                FROM   DWM_TARGET_WORTH_DTL A
                                WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_PARENT_ID = ITEM_BLD_LIST.ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;

                                IF V_COUNT = 1 THEN
                                    SELECT NVL(A.AVERAGE_PRICE, 0)
                                    INTO   V_PRICE
                                    FROM   DWM_TARGET_WORTH_DTL A
                                    WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_PARENT_ID = ITEM_BLD_LIST.ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;
                                ELSE
                                    V_PRICE := 0;

                                END IF;
                            END IF;

                        END IF;

                        --更新车位动态货值、货量
                        IF V_PRODUCT_TYPE = '车位仓储' AND V_IS_CARPORT = 1 THEN
                            --车位动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.CW_VALUE_DT_ALL, A.CW_VALUE_REMAIN, A.CW_VALUE_HAVED_SALE, A.CW_VALUE_RESERVE, A.CW_VALUE_IN_PROCESS, A.CW_VALUE_ALLOW_SALE, A.CW_VALUE_STOCK, A.CW_VALUE_NOT_PLANNING_PERMIT, A.CW_VALUE_NOT_CONSTRUCTION_PER, A.CW_VALUE_NOT_SALE_PERMIT, A.CW_VALUE_NOT_COMPLETION, A.CW_VALUE_YES_COMPLETION, A.CW_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.CW_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT * V_PRICE, 0),
                                            NVL(A.CW_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT * V_PRICE, 0), NVL(A.CW_VALUE_HAVED_SALE, 0) + 0,
                                            NVL(A.CW_VALUE_RESERVE, 0) + 0, NVL(A.CW_VALUE_IN_PROCESS, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT * V_PRICE, 0),
                                            NVL(A.CW_VALUE_ALLOW_SALE, 0) + 0, NVL(A.CW_VALUE_STOCK, 0) + 0, NVL(A.CW_VALUE_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.CW_VALUE_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.CW_VALUE_NOT_SALE_PERMIT, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT * V_PRICE, 0), NVL(A.CW_VALUE_NOT_COMPLETION, 0) + 0,
                                            NVL(A.CW_VALUE_YES_COMPLETION, 0) + 0, NVL(A.CW_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --车位动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.CW_AREA_DT_ALL, A.CW_AREA_REMAIN, A.CW_AREA_HAVED_SALE, A.CW_AREA_RESERVE, A.CW_AREA_IN_PROCESS, A.CW_AREA_ALLOW_SALE, A.CW_AREA_STOCK, A.CW_AREA_NOT_PLANNING_PERMIT, A.CW_AREA_NOT_CONSTRUCTION_PER, A.CW_AREA_NOT_SALE_PERMIT, A.CW_AREA_NOT_COMPLETION, A.CW_AREA_YES_COMPLETION, A.CW_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.CW_AREA_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                                            NVL(A.CW_AREA_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_HAVED_SALE, 0) + 0, NVL(A.CW_AREA_RESERVE, 0) + 0,
                                            NVL(A.CW_AREA_IN_PROCESS, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_ALLOW_SALE, 0) + 0, NVL(A.CW_AREA_STOCK, 0) + 0,
                                            NVL(A.CW_AREA_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.CW_AREA_NOT_CONSTRUCTION_PER, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                                            NVL(A.CW_AREA_NOT_SALE_PERMIT, 0) + 0, NVL(A.CW_AREA_NOT_COMPLETION, 0) + 0, NVL(A.CW_AREA_YES_COMPLETION, 0) + 0, NVL(A.CW_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --更新仓储部分动态货量、动态货值
                        ELSIF V_PRODUCT_TYPE = '车位仓储' AND V_IS_CARPORT = 0 THEN
                            --商业动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_HAVED_SALE, 0) + 0, NVL(A.SY_VALUE_RESERVE, 0) + 0,
                                            NVL(A.SY_VALUE_IN_PROCESS, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0) + 0, NVL(A.SY_VALUE_STOCK, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_NOT_COMPLETION, 0) + 0,
                                            NVL(A.SY_VALUE_YES_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --商业动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.ZZ_AREA_DT_ALL, A.ZZ_AREA_REMAIN, A.ZZ_AREA_HAVED_SALE, A.ZZ_AREA_RESERVE, A.ZZ_AREA_IN_PROCESS, A.ZZ_AREA_ALLOW_SALE, A.ZZ_AREA_STOCK, A.ZZ_AREA_NOT_PLANNING_PERMIT, A.ZZ_AREA_NOT_CONSTRUCTION_PER, A.ZZ_AREA_NOT_SALE_PERMIT, A.ZZ_AREA_NOT_COMPLETION, A.ZZ_AREA_YES_COMPLETION, A.ZZ_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.ZZ_AREA_DT_ALL, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.ZZ_AREA_REMAIN, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.ZZ_AREA_HAVED_SALE, 0) + 0, NVL(A.ZZ_AREA_RESERVE, 0) + 0, NVL(A.ZZ_AREA_IN_PROCESS, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.ZZ_AREA_ALLOW_SALE, 0) + 0, NVL(A.ZZ_AREA_STOCK, 0) + 0, NVL(A.ZZ_AREA_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.ZZ_AREA_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.ZZ_AREA_NOT_SALE_PERMIT, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.ZZ_AREA_NOT_COMPLETION, 0) + 0, NVL(A.ZZ_AREA_YES_COMPLETION, 0) + 0,
                                            NVL(A.ZZ_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                        ELSIF V_PRODUCT_TYPE = '住宅' THEN
                            --住宅动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.ZZ_VALUE_DT_ALL, A.ZZ_VALUE_REMAIN, A.ZZ_VALUE_HAVED_SALE, A.ZZ_VALUE_RESERVE, A.ZZ_VALUE_IN_PROCESS, A.ZZ_VALUE_ALLOW_SALE, A.ZZ_VALUE_STOCK, A.ZZ_VALUE_NOT_PLANNING_PERMIT, A.ZZ_VALUE_NOT_CONSTRUCTION_PER, A.ZZ_VALUE_NOT_SALE_PERMIT, A.ZZ_VALUE_NOT_COMPLETION, A.ZZ_VALUE_YES_COMPLETION, A.ZZ_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.ZZ_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.ZZ_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.ZZ_VALUE_HAVED_SALE, 0) + 0, NVL(A.ZZ_VALUE_RESERVE, 0) + 0,
                                            NVL(A.ZZ_VALUE_IN_PROCESS, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.ZZ_VALUE_ALLOW_SALE, 0) + 0, NVL(A.ZZ_VALUE_STOCK, 0) + 0,
                                            NVL(A.ZZ_VALUE_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.ZZ_VALUE_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.ZZ_VALUE_NOT_SALE_PERMIT, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.ZZ_VALUE_NOT_COMPLETION, 0) + 0,
                                            NVL(A.ZZ_VALUE_YES_COMPLETION, 0) + 0, NVL(A.ZZ_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --住宅动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.ZZ_AREA_DT_ALL, A.ZZ_AREA_REMAIN, A.ZZ_AREA_HAVED_SALE, A.ZZ_AREA_RESERVE, A.ZZ_AREA_IN_PROCESS, A.ZZ_AREA_ALLOW_SALE, A.ZZ_AREA_STOCK, A.ZZ_AREA_NOT_PLANNING_PERMIT, A.ZZ_AREA_NOT_CONSTRUCTION_PER, A.ZZ_AREA_NOT_SALE_PERMIT, A.ZZ_AREA_NOT_COMPLETION, A.ZZ_AREA_YES_COMPLETION, A.ZZ_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.ZZ_AREA_DT_ALL, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.ZZ_AREA_REMAIN, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.ZZ_AREA_HAVED_SALE, 0) + 0, NVL(A.ZZ_AREA_RESERVE, 0) + 0, NVL(A.ZZ_AREA_IN_PROCESS, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.ZZ_AREA_ALLOW_SALE, 0) + 0, NVL(A.ZZ_AREA_STOCK, 0) + 0, NVL(A.ZZ_AREA_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.ZZ_AREA_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.ZZ_AREA_NOT_SALE_PERMIT, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.ZZ_AREA_NOT_COMPLETION, 0) + 0, NVL(A.ZZ_AREA_YES_COMPLETION, 0) + 0,
                                            NVL(A.ZZ_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                        ELSIF V_PRODUCT_TYPE = '商办产业' THEN
                            --商业动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_HAVED_SALE, 0) + 0, NVL(A.SY_VALUE_RESERVE, 0) + 0,
                                            NVL(A.SY_VALUE_IN_PROCESS, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0) + 0, NVL(A.SY_VALUE_STOCK, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_NOT_COMPLETION, 0) + 0,
                                            NVL(A.SY_VALUE_YES_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --商业动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.ZZ_AREA_DT_ALL, A.ZZ_AREA_REMAIN, A.ZZ_AREA_HAVED_SALE, A.ZZ_AREA_RESERVE, A.ZZ_AREA_IN_PROCESS, A.ZZ_AREA_ALLOW_SALE, A.ZZ_AREA_STOCK, A.ZZ_AREA_NOT_PLANNING_PERMIT, A.ZZ_AREA_NOT_CONSTRUCTION_PER, A.ZZ_AREA_NOT_SALE_PERMIT, A.ZZ_AREA_NOT_COMPLETION, A.ZZ_AREA_YES_COMPLETION, A.ZZ_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.ZZ_AREA_DT_ALL, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.ZZ_AREA_REMAIN, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.ZZ_AREA_HAVED_SALE, 0) + 0, NVL(A.ZZ_AREA_RESERVE, 0) + 0, NVL(A.ZZ_AREA_IN_PROCESS, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.ZZ_AREA_ALLOW_SALE, 0) + 0, NVL(A.ZZ_AREA_STOCK, 0) + 0, NVL(A.ZZ_AREA_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.ZZ_AREA_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.ZZ_AREA_NOT_SALE_PERMIT, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.ZZ_AREA_NOT_COMPLETION, 0) + 0, NVL(A.ZZ_AREA_YES_COMPLETION, 0) + 0,
                                            NVL(A.ZZ_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                        ELSIF V_PRODUCT_TYPE = '配套设施' THEN
                            --商业动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_HAVED_SALE, 0) + 0, NVL(A.SY_VALUE_RESERVE, 0) + 0,
                                            NVL(A.SY_VALUE_IN_PROCESS, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0) + 0, NVL(A.SY_VALUE_STOCK, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_NOT_COMPLETION, 0) + 0,
                                            NVL(A.SY_VALUE_YES_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --商业动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.ZZ_AREA_DT_ALL, A.ZZ_AREA_REMAIN, A.ZZ_AREA_HAVED_SALE, A.ZZ_AREA_RESERVE, A.ZZ_AREA_IN_PROCESS, A.ZZ_AREA_ALLOW_SALE, A.ZZ_AREA_STOCK, A.ZZ_AREA_NOT_PLANNING_PERMIT, A.ZZ_AREA_NOT_CONSTRUCTION_PER, A.ZZ_AREA_NOT_SALE_PERMIT, A.ZZ_AREA_NOT_COMPLETION, A.ZZ_AREA_YES_COMPLETION, A.ZZ_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.ZZ_AREA_DT_ALL, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.ZZ_AREA_REMAIN, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.ZZ_AREA_HAVED_SALE, 0) + 0, NVL(A.ZZ_AREA_RESERVE, 0) + 0, NVL(A.ZZ_AREA_IN_PROCESS, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.ZZ_AREA_ALLOW_SALE, 0) + 0, NVL(A.ZZ_AREA_STOCK, 0) + 0, NVL(A.ZZ_AREA_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.ZZ_AREA_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.ZZ_AREA_NOT_SALE_PERMIT, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.ZZ_AREA_NOT_COMPLETION, 0) + 0, NVL(A.ZZ_AREA_YES_COMPLETION, 0) + 0,
                                            NVL(A.ZZ_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                        ELSE
                            DBMS_OUTPUT.PUT_LINE('1');

                        END IF;
                    END LOOP;
                    CLOSE CUR_OBJ_INDEX_LIST;

                    UPDATE DWM_DT_VALUE A
                    SET    (A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                            (SELECT NVL(A.CW_VALUE_DT_ALL, 0) + NVL(A.SY_VALUE_DT_ALL, 0) + NVL(A.ZZ_VALUE_DT_ALL, 0), NVL(A.CW_VALUE_REMAIN, 0) + NVL(A.SY_VALUE_REMAIN, 0) + NVL(A.ZZ_VALUE_REMAIN, 0),
                                    NVL(A.CW_VALUE_HAVED_SALE, 0) + NVL(A.SY_VALUE_HAVED_SALE, 0) + NVL(A.ZZ_VALUE_HAVED_SALE, 0),
                                    NVL(A.CW_VALUE_RESERVE, 0) + NVL(A.SY_VALUE_RESERVE, 0) + NVL(A.ZZ_VALUE_RESERVE, 0),
                                    NVL(A.CW_VALUE_IN_PROCESS, 0) + NVL(A.SY_VALUE_IN_PROCESS, 0) + NVL(A.ZZ_VALUE_IN_PROCESS, 0),
                                    NVL(A.CW_VALUE_ALLOW_SALE, 0) + NVL(A.SY_VALUE_ALLOW_SALE, 0) + NVL(A.ZZ_VALUE_ALLOW_SALE, 0),
                                    NVL(A.CW_VALUE_STOCK, 0) + NVL(A.SY_VALUE_STOCK, 0) + NVL(A.ZZ_VALUE_STOCK, 0),
                                    NVL(A.CW_VALUE_NOT_PLANNING_PERMIT, 0) + NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + NVL(A.ZZ_VALUE_NOT_PLANNING_PERMIT, 0),
                                    NVL(A.CW_VALUE_NOT_CONSTRUCTION_PER, 0) + NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0) + NVL(A.ZZ_VALUE_NOT_CONSTRUCTION_PER, 0),
                                    NVL(A.CW_VALUE_NOT_SALE_PERMIT, 0) + NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0) + NVL(A.ZZ_VALUE_NOT_SALE_PERMIT, 0),
                                    NVL(A.CW_VALUE_NOT_COMPLETION, 0) + NVL(A.SY_VALUE_NOT_COMPLETION, 0) + NVL(A.ZZ_VALUE_NOT_COMPLETION, 0),
                                    NVL(A.CW_VALUE_YES_COMPLETION, 0) + NVL(A.SY_VALUE_YES_COMPLETION, 0) + NVL(A.ZZ_VALUE_YES_COMPLETION, 0),
                                    NVL(A.CW_VALUE_YES_SETTLEMENT, 0) + NVL(A.SY_VALUE_YES_SETTLEMENT, 0) + NVL(A.ZZ_VALUE_YES_SETTLEMENT, 0)
                             FROM   DUAL)
                    WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                    UPDATE DWM_DT_VALUE A
                    SET    (A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                            (SELECT NVL(A.CW_AREA_DT_ALL, 0) + NVL(A.SY_AREA_DT_ALL, 0) + NVL(A.ZZ_AREA_DT_ALL, 0), NVL(A.CW_AREA_REMAIN, 0) + NVL(A.SY_AREA_REMAIN, 0) + NVL(A.ZZ_AREA_REMAIN, 0),
                                    NVL(A.CW_AREA_HAVED_SALE, 0) + NVL(A.SY_AREA_HAVED_SALE, 0) + NVL(A.ZZ_AREA_HAVED_SALE, 0),
                                    NVL(A.CW_AREA_RESERVE, 0) + NVL(A.SY_AREA_RESERVE, 0) + NVL(A.ZZ_AREA_RESERVE, 0),
                                    NVL(A.CW_AREA_IN_PROCESS, 0) + NVL(A.SY_AREA_IN_PROCESS, 0) + NVL(A.ZZ_AREA_IN_PROCESS, 0),
                                    NVL(A.CW_AREA_ALLOW_SALE, 0) + NVL(A.SY_AREA_ALLOW_SALE, 0) + NVL(A.ZZ_AREA_ALLOW_SALE, 0),
                                    NVL(A.CW_AREA_STOCK, 0) + NVL(A.SY_AREA_STOCK, 0) + NVL(A.ZZ_AREA_STOCK, 0),
                                    NVL(A.CW_AREA_NOT_PLANNING_PERMIT, 0) + NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + NVL(A.ZZ_AREA_NOT_PLANNING_PERMIT, 0),
                                    NVL(A.CW_AREA_NOT_CONSTRUCTION_PER, 0) + NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0) + NVL(A.ZZ_AREA_NOT_CONSTRUCTION_PER, 0),
                                    NVL(A.CW_AREA_NOT_SALE_PERMIT, 0) + NVL(A.SY_AREA_NOT_SALE_PERMIT, 0) + NVL(A.ZZ_AREA_NOT_SALE_PERMIT, 0),
                                    NVL(A.CW_AREA_NOT_COMPLETION, 0) + NVL(A.SY_AREA_NOT_COMPLETION, 0) + NVL(A.ZZ_AREA_NOT_COMPLETION, 0),
                                    NVL(A.CW_AREA_YES_COMPLETION, 0) + NVL(A.SY_AREA_YES_COMPLETION, 0) + NVL(A.ZZ_AREA_YES_COMPLETION, 0),
                                    NVL(A.CW_AREA_YES_SETTLEMENT, 0) + NVL(A.SY_AREA_YES_SETTLEMENT, 0) + NVL(A.ZZ_AREA_YES_SETTLEMENT, 0)
                             FROM   DUAL)
                    WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                END;
                /*
                ===========更新楼栋在规证阶段货值数据
                */
            ELSIF V_NEWEST_PHASE = '规划许可证' THEN
                BEGIN

                    OPEN CUR_OBJ_INDEX_LIST(ITEM_BLD_LIST.ID);
                    LOOP
                        --开始循环，取楼栋下业态数据
                        FETCH CUR_OBJ_INDEX_LIST
                            INTO ITEM_OBJ_INDEX_LIST;
                        EXIT WHEN CUR_OBJ_INDEX_LIST%NOTFOUND;

                        V_PRODUCT_TYPE := SUBSTR(ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_NAME, 0, INSTR(ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_NAME, '/', 1) - 1); --取一级业态
                        V_IS_CARPORT := CASE
                                            WHEN ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_JSON = '{"isCarport":1}' THEN
                                             1
                                            ELSE
                                             0
                                        END; -- 取当前业态是否为车位，1：车位；0：非车位

                        --取最新的业态均价，取值原则：动态版→全盘版→可研版

                        SELECT COUNT(1) INTO V_COUNT FROM DWM_DT_VALUE A WHERE A.TARGET_A_ID IS NOT NULL AND A.OBJ_ID = ITEM_BLD_LIST.ID;

                        IF V_COUNT = 0 THEN
                            --无目标货值
                            V_PRICE := 0;
                        ELSE
                            SELECT A.TARGET_A_ID INTO V_TARGET_WORTH_ID FROM DWM_DT_VALUE A WHERE A.OBJ_ID = ITEM_BLD_LIST.ID AND A.OBJ_TYPE = '楼栋';


                            SELECT A.TARGET_WORTH_PHASE INTO V_TARGET_WORTH_PHASE FROM DWM_TARGET_WORTH A WHERE A.ID = V_TARGET_WORTH_ID;

                            IF V_TARGET_WORTH_PHASE = 0 THEN

                                SELECT COUNT(1) INTO V_COUNT FROM DWM_TARGET_WORTH_DTL A WHERE A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;

                                IF V_COUNT = 1 THEN
                                    SELECT NVL(A.AVERAGE_PRICE, 0)
                                    INTO   V_PRICE
                                    FROM   DWM_TARGET_WORTH_DTL A
                                    WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;
                                ELSE
                                    V_PRICE := 0;
                                END IF;

                            ELSIF V_TARGET_WORTH_PHASE = 10 THEN
                                SELECT COUNT(1)
                                INTO   V_COUNT
                                FROM   DWM_TARGET_WORTH_DTL A
                                WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_PARENT_ID = ITEM_BLD_LIST.PERIOD_ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;

                                IF V_COUNT = 1 THEN
                                    SELECT NVL(A.AVERAGE_PRICE, 0)
                                    INTO   V_PRICE
                                    FROM   DWM_TARGET_WORTH_DTL A
                                    WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_PARENT_ID = ITEM_BLD_LIST.PERIOD_ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;
                                ELSE
                                    V_PRICE := 0;
                                END IF;

                            ELSE
                                SELECT COUNT(1)
                                INTO   V_COUNT
                                FROM   DWM_TARGET_WORTH_DTL A
                                WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_PARENT_ID = ITEM_BLD_LIST.ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;

                                IF V_COUNT = 1 THEN
                                    SELECT NVL(A.AVERAGE_PRICE, 0)
                                    INTO   V_PRICE
                                    FROM   DWM_TARGET_WORTH_DTL A
                                    WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_PARENT_ID = ITEM_BLD_LIST.ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;
                                ELSE
                                    V_PRICE := 0;
                                END IF;
                            END IF;

                        END IF;


                        --更新车位动态货值、货量
                        IF V_PRODUCT_TYPE = '车位仓储' AND V_IS_CARPORT = 1 THEN
                            --车位动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.CW_VALUE_DT_ALL, A.CW_VALUE_REMAIN, A.CW_VALUE_HAVED_SALE, A.CW_VALUE_RESERVE, A.CW_VALUE_IN_PROCESS, A.CW_VALUE_ALLOW_SALE, A.CW_VALUE_STOCK, A.CW_VALUE_NOT_PLANNING_PERMIT, A.CW_VALUE_NOT_CONSTRUCTION_PER, A.CW_VALUE_NOT_SALE_PERMIT, A.CW_VALUE_NOT_COMPLETION, A.CW_VALUE_YES_COMPLETION, A.CW_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.CW_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT * V_PRICE, 0),
                                            NVL(A.CW_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT * V_PRICE, 0), NVL(A.CW_VALUE_HAVED_SALE, 0) + 0,
                                            NVL(A.CW_VALUE_RESERVE, 0) + 0, NVL(A.CW_VALUE_IN_PROCESS, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT * V_PRICE, 0),
                                            NVL(A.CW_VALUE_ALLOW_SALE, 0) + 0, NVL(A.CW_VALUE_STOCK, 0) + 0, NVL(A.CW_VALUE_NOT_PLANNING_PERMIT, 0) + 0,
                                            NVL(A.CW_VALUE_NOT_CONSTRUCTION_PER, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT * V_PRICE, 0), NVL(A.CW_VALUE_NOT_SALE_PERMIT, 0) + 0,
                                            NVL(A.CW_VALUE_NOT_COMPLETION, 0) + 0, NVL(A.CW_VALUE_YES_COMPLETION, 0) + 0, NVL(A.CW_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --车位动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.CW_AREA_DT_ALL, A.CW_AREA_REMAIN, A.CW_AREA_HAVED_SALE, A.CW_AREA_RESERVE, A.CW_AREA_IN_PROCESS, A.CW_AREA_ALLOW_SALE, A.CW_AREA_STOCK, A.CW_AREA_NOT_PLANNING_PERMIT, A.CW_AREA_NOT_CONSTRUCTION_PER, A.CW_AREA_NOT_SALE_PERMIT, A.CW_AREA_NOT_COMPLETION, A.CW_AREA_YES_COMPLETION, A.CW_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.CW_AREA_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                                            NVL(A.CW_AREA_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_HAVED_SALE, 0) + 0, NVL(A.CW_AREA_RESERVE, 0) + 0,
                                            NVL(A.CW_AREA_IN_PROCESS, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_ALLOW_SALE, 0) + 0, NVL(A.CW_AREA_STOCK, 0) + 0,
                                            NVL(A.CW_AREA_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.CW_AREA_NOT_CONSTRUCTION_PER, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                                            NVL(A.CW_AREA_NOT_SALE_PERMIT, 0) + 0, NVL(A.CW_AREA_NOT_COMPLETION, 0) + 0, NVL(A.CW_AREA_YES_COMPLETION, 0) + 0, NVL(A.CW_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --更新仓储部分动态货量、动态货值
                        ELSIF V_PRODUCT_TYPE = '车位仓储' AND V_IS_CARPORT = 0 THEN
                            --商业动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_HAVED_SALE, 0) + 0, NVL(A.SY_VALUE_RESERVE, 0) + 0,
                                            NVL(A.SY_VALUE_IN_PROCESS, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0) + 0, NVL(A.SY_VALUE_STOCK, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0) + 0, NVL(A.SY_VALUE_NOT_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --商业动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_AREA_DT_ALL, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.SY_AREA_REMAIN, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.SY_AREA_HAVED_SALE, 0) + 0, NVL(A.SY_AREA_RESERVE, 0) + 0, NVL(A.SY_AREA_IN_PROCESS, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.SY_AREA_ALLOW_SALE, 0) + 0, NVL(A.SY_AREA_STOCK, 0) + 0, NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + 0,
                                            NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.SY_AREA_NOT_SALE_PERMIT, 0) + 0, NVL(A.SY_AREA_NOT_COMPLETION, 0) + 0,
                                            NVL(A.SY_AREA_YES_COMPLETION, 0) + 0, NVL(A.SY_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                        ELSIF V_PRODUCT_TYPE = '住宅' THEN
                            --住宅动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.ZZ_VALUE_DT_ALL, A.ZZ_VALUE_REMAIN, A.ZZ_VALUE_HAVED_SALE, A.ZZ_VALUE_RESERVE, A.ZZ_VALUE_IN_PROCESS, A.ZZ_VALUE_ALLOW_SALE, A.ZZ_VALUE_STOCK, A.ZZ_VALUE_NOT_PLANNING_PERMIT, A.ZZ_VALUE_NOT_CONSTRUCTION_PER, A.ZZ_VALUE_NOT_SALE_PERMIT, A.ZZ_VALUE_NOT_COMPLETION, A.ZZ_VALUE_YES_COMPLETION, A.ZZ_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.ZZ_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.ZZ_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.ZZ_VALUE_HAVED_SALE, 0) + 0, NVL(A.ZZ_VALUE_RESERVE, 0) + 0,
                                            NVL(A.ZZ_VALUE_IN_PROCESS, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.ZZ_VALUE_ALLOW_SALE, 0) + 0, NVL(A.ZZ_VALUE_STOCK, 0) + 0,
                                            NVL(A.ZZ_VALUE_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.ZZ_VALUE_NOT_CONSTRUCTION_PER, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.ZZ_VALUE_NOT_SALE_PERMIT, 0) + 0, NVL(A.ZZ_VALUE_NOT_COMPLETION, 0) + 0, NVL(A.ZZ_VALUE_YES_COMPLETION, 0) + 0, NVL(A.ZZ_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --住宅动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.ZZ_AREA_DT_ALL, A.ZZ_AREA_REMAIN, A.ZZ_AREA_HAVED_SALE, A.ZZ_AREA_RESERVE, A.ZZ_AREA_IN_PROCESS, A.ZZ_AREA_ALLOW_SALE, A.ZZ_AREA_STOCK, A.ZZ_AREA_NOT_PLANNING_PERMIT, A.ZZ_AREA_NOT_CONSTRUCTION_PER, A.ZZ_AREA_NOT_SALE_PERMIT, A.ZZ_AREA_NOT_COMPLETION, A.ZZ_AREA_YES_COMPLETION, A.ZZ_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.ZZ_AREA_DT_ALL, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.ZZ_AREA_REMAIN, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.ZZ_AREA_HAVED_SALE, 0) + 0, NVL(A.ZZ_AREA_RESERVE, 0) + 0, NVL(A.ZZ_AREA_IN_PROCESS, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.ZZ_AREA_ALLOW_SALE, 0) + 0, NVL(A.ZZ_AREA_STOCK, 0) + 0, NVL(A.ZZ_AREA_NOT_PLANNING_PERMIT, 0) + 0,
                                            NVL(A.ZZ_AREA_NOT_CONSTRUCTION_PER, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.ZZ_AREA_NOT_SALE_PERMIT, 0) + 0, NVL(A.ZZ_AREA_NOT_COMPLETION, 0) + 0,
                                            NVL(A.ZZ_AREA_YES_COMPLETION, 0) + 0, NVL(A.ZZ_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                        ELSIF V_PRODUCT_TYPE = '商办产业' THEN
                            --商业动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_HAVED_SALE, 0) + 0, NVL(A.SY_VALUE_RESERVE, 0) + 0,
                                            NVL(A.SY_VALUE_IN_PROCESS, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0) + 0, NVL(A.SY_VALUE_STOCK, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0) + 0, NVL(A.SY_VALUE_NOT_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --商业动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_AREA_DT_ALL, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.SY_AREA_REMAIN, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.SY_AREA_HAVED_SALE, 0) + 0, NVL(A.SY_AREA_RESERVE, 0) + 0, NVL(A.SY_AREA_IN_PROCESS, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.SY_AREA_ALLOW_SALE, 0) + 0, NVL(A.SY_AREA_STOCK, 0) + 0, NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + 0,
                                            NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.SY_AREA_NOT_SALE_PERMIT, 0) + 0, NVL(A.SY_AREA_NOT_COMPLETION, 0) + 0,
                                            NVL(A.SY_AREA_YES_COMPLETION, 0) + 0, NVL(A.SY_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                        ELSIF V_PRODUCT_TYPE = '配套设施' THEN
                            --商业动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_HAVED_SALE, 0) + 0, NVL(A.SY_VALUE_RESERVE, 0) + 0,
                                            NVL(A.SY_VALUE_IN_PROCESS, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0) + 0, NVL(A.SY_VALUE_STOCK, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + 0, NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0) + 0, NVL(A.SY_VALUE_NOT_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --商业动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_AREA_DT_ALL, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.SY_AREA_REMAIN, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.SY_AREA_HAVED_SALE, 0) + 0, NVL(A.SY_AREA_RESERVE, 0) + 0, NVL(A.SY_AREA_IN_PROCESS, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.SY_AREA_ALLOW_SALE, 0) + 0, NVL(A.SY_AREA_STOCK, 0) + 0, NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + 0,
                                            NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.SY_AREA_NOT_SALE_PERMIT, 0) + 0, NVL(A.SY_AREA_NOT_COMPLETION, 0) + 0,
                                            NVL(A.SY_AREA_YES_COMPLETION, 0) + 0, NVL(A.SY_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                        ELSE
                            DBMS_OUTPUT.PUT_LINE('1');
                        END IF;
                    END LOOP;
                    CLOSE CUR_OBJ_INDEX_LIST;


                UPDATE DWM_DT_VALUE A
                SET    (A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                        (SELECT NVL(A.CW_VALUE_DT_ALL, 0) + NVL(A.SY_VALUE_DT_ALL, 0) + NVL(A.ZZ_VALUE_DT_ALL, 0), NVL(A.CW_VALUE_REMAIN, 0) + NVL(A.SY_VALUE_REMAIN, 0) + NVL(A.ZZ_VALUE_REMAIN, 0),
                                NVL(A.CW_VALUE_HAVED_SALE, 0) + NVL(A.SY_VALUE_HAVED_SALE, 0) + NVL(A.ZZ_VALUE_HAVED_SALE, 0),
                                NVL(A.CW_VALUE_RESERVE, 0) + NVL(A.SY_VALUE_RESERVE, 0) + NVL(A.ZZ_VALUE_RESERVE, 0),
                                NVL(A.CW_VALUE_IN_PROCESS, 0) + NVL(A.SY_VALUE_IN_PROCESS, 0) + NVL(A.ZZ_VALUE_IN_PROCESS, 0),
                                NVL(A.CW_VALUE_ALLOW_SALE, 0) + NVL(A.SY_VALUE_ALLOW_SALE, 0) + NVL(A.ZZ_VALUE_ALLOW_SALE, 0),
                                NVL(A.CW_VALUE_STOCK, 0) + NVL(A.SY_VALUE_STOCK, 0) + NVL(A.ZZ_VALUE_STOCK, 0),
                                NVL(A.CW_VALUE_NOT_PLANNING_PERMIT, 0) + NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + NVL(A.ZZ_VALUE_NOT_PLANNING_PERMIT, 0),
                                NVL(A.CW_VALUE_NOT_CONSTRUCTION_PER, 0) + NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0) + NVL(A.ZZ_VALUE_NOT_CONSTRUCTION_PER, 0),
                                NVL(A.CW_VALUE_NOT_SALE_PERMIT, 0) + NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0) + NVL(A.ZZ_VALUE_NOT_SALE_PERMIT, 0),
                                NVL(A.CW_VALUE_NOT_COMPLETION, 0) + NVL(A.SY_VALUE_NOT_COMPLETION, 0) + NVL(A.ZZ_VALUE_NOT_COMPLETION, 0),
                                NVL(A.CW_VALUE_YES_COMPLETION, 0) + NVL(A.SY_VALUE_YES_COMPLETION, 0) + NVL(A.ZZ_VALUE_YES_COMPLETION, 0),
                                NVL(A.CW_VALUE_YES_SETTLEMENT, 0) + NVL(A.SY_VALUE_YES_SETTLEMENT, 0) + NVL(A.ZZ_VALUE_YES_SETTLEMENT, 0)
                         FROM   DUAL)
                WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                UPDATE DWM_DT_VALUE A
                SET    (A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                        (SELECT NVL(A.CW_AREA_DT_ALL, 0) + NVL(A.SY_AREA_DT_ALL, 0) + NVL(A.ZZ_AREA_DT_ALL, 0), NVL(A.CW_AREA_REMAIN, 0) + NVL(A.SY_AREA_REMAIN, 0) + NVL(A.ZZ_AREA_REMAIN, 0),
                                NVL(A.CW_AREA_HAVED_SALE, 0) + NVL(A.SY_AREA_HAVED_SALE, 0) + NVL(A.ZZ_AREA_HAVED_SALE, 0),
                                NVL(A.CW_AREA_RESERVE, 0) + NVL(A.SY_AREA_RESERVE, 0) + NVL(A.ZZ_AREA_RESERVE, 0),
                                NVL(A.CW_AREA_IN_PROCESS, 0) + NVL(A.SY_AREA_IN_PROCESS, 0) + NVL(A.ZZ_AREA_IN_PROCESS, 0),
                                NVL(A.CW_AREA_ALLOW_SALE, 0) + NVL(A.SY_AREA_ALLOW_SALE, 0) + NVL(A.ZZ_AREA_ALLOW_SALE, 0), NVL(A.CW_AREA_STOCK, 0) + NVL(A.SY_AREA_STOCK, 0) + NVL(A.ZZ_AREA_STOCK, 0),
                                NVL(A.CW_AREA_NOT_PLANNING_PERMIT, 0) + NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + NVL(A.ZZ_AREA_NOT_PLANNING_PERMIT, 0),
                                NVL(A.CW_AREA_NOT_CONSTRUCTION_PER, 0) + NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0) + NVL(A.ZZ_AREA_NOT_CONSTRUCTION_PER, 0),
                                NVL(A.CW_AREA_NOT_SALE_PERMIT, 0) + NVL(A.SY_AREA_NOT_SALE_PERMIT, 0) + NVL(A.ZZ_AREA_NOT_SALE_PERMIT, 0),
                                NVL(A.CW_AREA_NOT_COMPLETION, 0) + NVL(A.SY_AREA_NOT_COMPLETION, 0) + NVL(A.ZZ_AREA_NOT_COMPLETION, 0),
                                NVL(A.CW_AREA_YES_COMPLETION, 0) + NVL(A.SY_AREA_YES_COMPLETION, 0) + NVL(A.ZZ_AREA_YES_COMPLETION, 0),
                                NVL(A.CW_AREA_YES_SETTLEMENT, 0) + NVL(A.SY_AREA_YES_SETTLEMENT, 0) + NVL(A.ZZ_AREA_YES_SETTLEMENT, 0)
                         FROM   DUAL)
                WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                END;


           ELSIF V_NEWEST_PHASE = '未取证' THEN
               BEGIN

                    OPEN CUR_OBJ_INDEX_LIST(ITEM_BLD_LIST.ID);
                    LOOP
                        --开始循环，取楼栋下业态数据
                        FETCH CUR_OBJ_INDEX_LIST
                            INTO ITEM_OBJ_INDEX_LIST;
                        EXIT WHEN CUR_OBJ_INDEX_LIST%NOTFOUND;

                        V_PRODUCT_TYPE := SUBSTR(ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_NAME, 0, INSTR(ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_NAME, '/', 1) - 1); --取一级业态
                        V_IS_CARPORT := CASE
                                            WHEN ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_JSON = '{"isCarport":1}' THEN
                                             1
                                            ELSE
                                             0
                                        END; -- 取当前业态是否为车位，1：车位；0：非车位

                        --取最新的业态均价，取值原则：动态版→全盘版→可研版

                        SELECT COUNT(1) INTO V_COUNT FROM DWM_DT_VALUE A WHERE A.TARGET_A_ID IS NOT NULL AND A.OBJ_ID = ITEM_BLD_LIST.ID;

                        IF V_COUNT = 0 THEN
                            --无目标货值
                            V_PRICE := 0;
                        ELSE
                            SELECT A.TARGET_A_ID INTO V_TARGET_WORTH_ID FROM DWM_DT_VALUE A WHERE A.OBJ_ID = ITEM_BLD_LIST.ID AND A.OBJ_TYPE = '楼栋';


                            SELECT A.TARGET_WORTH_PHASE INTO V_TARGET_WORTH_PHASE FROM DWM_TARGET_WORTH A WHERE A.ID = V_TARGET_WORTH_ID;

                            IF V_TARGET_WORTH_PHASE = 0 THEN

                                SELECT COUNT(1) INTO V_COUNT FROM DWM_TARGET_WORTH_DTL A WHERE A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;

                                IF V_COUNT = 1 THEN
                                    SELECT NVL(A.AVERAGE_PRICE, 0)
                                    INTO   V_PRICE
                                    FROM   DWM_TARGET_WORTH_DTL A
                                    WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;
                                ELSE
                                    V_PRICE := 0;
                                END IF;

                            ELSIF V_TARGET_WORTH_PHASE = 10 THEN
                                SELECT COUNT(1)
                                INTO   V_COUNT
                                FROM   DWM_TARGET_WORTH_DTL A
                                WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_PARENT_ID = ITEM_BLD_LIST.PERIOD_ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;

                                IF V_COUNT = 1 THEN
                                    SELECT NVL(A.AVERAGE_PRICE, 0)
                                    INTO   V_PRICE
                                    FROM   DWM_TARGET_WORTH_DTL A
                                    WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_PARENT_ID = ITEM_BLD_LIST.PERIOD_ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;
                                ELSE
                                    V_PRICE := 0;
                                END IF;

                            ELSE
                                SELECT COUNT(1)
                                INTO   V_COUNT
                                FROM   DWM_TARGET_WORTH_DTL A
                                WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_PARENT_ID = ITEM_BLD_LIST.ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;

                                IF V_COUNT = 1 THEN
                                    SELECT NVL(A.AVERAGE_PRICE, 0)
                                    INTO   V_PRICE
                                    FROM   DWM_TARGET_WORTH_DTL A
                                    WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_PARENT_ID = ITEM_BLD_LIST.ID AND A.OBJ_ID = ITEM_OBJ_INDEX_LIST.PRODUCT_TYPE_ID;
                                ELSE
                                    V_PRICE := 0;
                                END IF;
                            END IF;

                        END IF;


                        --更新车位动态货值、货量
                        IF V_PRODUCT_TYPE = '车位仓储' AND V_IS_CARPORT = 1 THEN
                            --车位动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.CW_VALUE_DT_ALL, A.CW_VALUE_REMAIN, A.CW_VALUE_HAVED_SALE, A.CW_VALUE_RESERVE, A.CW_VALUE_IN_PROCESS, A.CW_VALUE_ALLOW_SALE, A.CW_VALUE_STOCK, A.CW_VALUE_NOT_PLANNING_PERMIT, A.CW_VALUE_NOT_CONSTRUCTION_PER, A.CW_VALUE_NOT_SALE_PERMIT, A.CW_VALUE_NOT_COMPLETION, A.CW_VALUE_YES_COMPLETION, A.CW_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.CW_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT * V_PRICE, 0),
                                            NVL(A.CW_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT * V_PRICE, 0), NVL(A.CW_VALUE_HAVED_SALE, 0) + 0,
                                            NVL(A.CW_VALUE_RESERVE, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT * V_PRICE, 0), NVL(A.CW_VALUE_IN_PROCESS, 0) + 0,
                                            NVL(A.CW_VALUE_ALLOW_SALE, 0) + 0, NVL(A.CW_VALUE_STOCK, 0) + 0, NVL(A.CW_VALUE_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT * V_PRICE, 0),
                                            NVL(A.CW_VALUE_NOT_CONSTRUCTION_PER, 0) + 0, NVL(A.CW_VALUE_NOT_SALE_PERMIT, 0) + 0,
                                            NVL(A.CW_VALUE_NOT_COMPLETION, 0) + 0, NVL(A.CW_VALUE_YES_COMPLETION, 0) + 0, NVL(A.CW_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --车位动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.CW_AREA_DT_ALL, A.CW_AREA_REMAIN, A.CW_AREA_HAVED_SALE, A.CW_AREA_RESERVE, A.CW_AREA_IN_PROCESS, A.CW_AREA_ALLOW_SALE, A.CW_AREA_STOCK, A.CW_AREA_NOT_PLANNING_PERMIT, A.CW_AREA_NOT_CONSTRUCTION_PER, A.CW_AREA_NOT_SALE_PERMIT, A.CW_AREA_NOT_COMPLETION, A.CW_AREA_YES_COMPLETION, A.CW_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.CW_AREA_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                                            NVL(A.CW_AREA_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_HAVED_SALE, 0) + 0, NVL(A.CW_AREA_RESERVE, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                                            NVL(A.CW_AREA_IN_PROCESS, 0) + 0, NVL(A.CW_AREA_ALLOW_SALE, 0) + 0, NVL(A.CW_AREA_STOCK, 0) + 0,
                                            NVL(A.CW_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_OBJ_INDEX_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.CW_AREA_NOT_SALE_PERMIT, 0) + 0, NVL(A.CW_AREA_NOT_COMPLETION, 0) + 0, NVL(A.CW_AREA_YES_COMPLETION, 0) + 0, NVL(A.CW_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --更新仓储部分动态货量、动态货值
                        ELSIF V_PRODUCT_TYPE = '车位仓储' AND V_IS_CARPORT = 0 THEN
                            --商业动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_HAVED_SALE, 0) + 0, NVL(A.SY_VALUE_RESERVE, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_IN_PROCESS, 0) + 0, NVL(A.SY_VALUE_ALLOW_SALE, 0) + 0, NVL(A.SY_VALUE_STOCK, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0) + 0, NVL(A.SY_VALUE_NOT_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --商业动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_AREA_DT_ALL, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.SY_AREA_REMAIN, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.SY_AREA_HAVED_SALE, 0) + 0, NVL(A.SY_AREA_RESERVE, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.SY_AREA_IN_PROCESS, 0) + 0,
                                            NVL(A.SY_AREA_ALLOW_SALE, 0) + 0, NVL(A.SY_AREA_STOCK, 0) + 0, NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0) + 0, NVL(A.SY_AREA_NOT_SALE_PERMIT, 0) + 0, NVL(A.SY_AREA_NOT_COMPLETION, 0) + 0,
                                            NVL(A.SY_AREA_YES_COMPLETION, 0) + 0, NVL(A.SY_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                        ELSIF V_PRODUCT_TYPE = '住宅' THEN
                            --住宅动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.ZZ_VALUE_DT_ALL, A.ZZ_VALUE_REMAIN, A.ZZ_VALUE_HAVED_SALE, A.ZZ_VALUE_RESERVE, A.ZZ_VALUE_IN_PROCESS, A.ZZ_VALUE_ALLOW_SALE, A.ZZ_VALUE_STOCK, A.ZZ_VALUE_NOT_PLANNING_PERMIT, A.ZZ_VALUE_NOT_CONSTRUCTION_PER, A.ZZ_VALUE_NOT_SALE_PERMIT, A.ZZ_VALUE_NOT_COMPLETION, A.ZZ_VALUE_YES_COMPLETION, A.ZZ_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.ZZ_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.ZZ_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.ZZ_VALUE_HAVED_SALE, 0) + 0, NVL(A.ZZ_VALUE_RESERVE, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.ZZ_VALUE_IN_PROCESS, 0) + 0, NVL(A.ZZ_VALUE_ALLOW_SALE, 0) + 0, NVL(A.ZZ_VALUE_STOCK, 0) + 0,
                                            NVL(A.ZZ_VALUE_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.ZZ_VALUE_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.ZZ_VALUE_NOT_SALE_PERMIT, 0) + 0, NVL(A.ZZ_VALUE_NOT_COMPLETION, 0) + 0, NVL(A.ZZ_VALUE_YES_COMPLETION, 0) + 0, NVL(A.ZZ_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --住宅动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.ZZ_AREA_DT_ALL, A.ZZ_AREA_REMAIN, A.ZZ_AREA_HAVED_SALE, A.ZZ_AREA_RESERVE, A.ZZ_AREA_IN_PROCESS, A.ZZ_AREA_ALLOW_SALE, A.ZZ_AREA_STOCK, A.ZZ_AREA_NOT_PLANNING_PERMIT, A.ZZ_AREA_NOT_CONSTRUCTION_PER, A.ZZ_AREA_NOT_SALE_PERMIT, A.ZZ_AREA_NOT_COMPLETION, A.ZZ_AREA_YES_COMPLETION, A.ZZ_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.ZZ_AREA_DT_ALL, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.ZZ_AREA_REMAIN, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.ZZ_AREA_HAVED_SALE, 0) + 0, NVL(A.ZZ_AREA_RESERVE, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.ZZ_AREA_IN_PROCESS, 0) + 0,
                                            NVL(A.ZZ_AREA_ALLOW_SALE, 0) + 0, NVL(A.ZZ_AREA_STOCK, 0) + 0, NVL(A.ZZ_AREA_NOT_PLANNING_PERMIT, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.ZZ_AREA_NOT_CONSTRUCTION_PER, 0) + 0, NVL(A.ZZ_AREA_NOT_SALE_PERMIT, 0) + 0, NVL(A.ZZ_AREA_NOT_COMPLETION, 0) + 0,
                                            NVL(A.ZZ_AREA_YES_COMPLETION, 0) + 0, NVL(A.ZZ_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                        ELSIF V_PRODUCT_TYPE = '商办产业' THEN
                            --商业动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_HAVED_SALE, 0) + 0, NVL(A.SY_VALUE_RESERVE, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_IN_PROCESS, 0) + 0, NVL(A.SY_VALUE_ALLOW_SALE, 0) + 0, NVL(A.SY_VALUE_STOCK, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0) + 0, NVL(A.SY_VALUE_NOT_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --商业动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_AREA_DT_ALL, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.SY_AREA_REMAIN, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.SY_AREA_HAVED_SALE, 0) + 0, NVL(A.SY_AREA_RESERVE, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.SY_AREA_IN_PROCESS, 0) + 0,
                                            NVL(A.SY_AREA_ALLOW_SALE, 0) + 0, NVL(A.SY_AREA_STOCK, 0) + 0, NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0) + 0, NVL(A.SY_AREA_NOT_SALE_PERMIT, 0) + 0, NVL(A.SY_AREA_NOT_COMPLETION, 0) + 0,
                                            NVL(A.SY_AREA_YES_COMPLETION, 0) + 0, NVL(A.SY_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                        ELSIF V_PRODUCT_TYPE = '配套设施' THEN
                            --商业动态货值更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_VALUE_DT_ALL, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_REMAIN, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_HAVED_SALE, 0) + 0, NVL(A.SY_VALUE_RESERVE, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0),
                                            NVL(A.SY_VALUE_IN_PROCESS, 0) + 0, NVL(A.SY_VALUE_ALLOW_SALE, 0) + 0, NVL(A.SY_VALUE_STOCK, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA * V_PRICE, 0), NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0) + 0,
                                            NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0) + 0, NVL(A.SY_VALUE_NOT_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_COMPLETION, 0) + 0, NVL(A.SY_VALUE_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;
                            --商业动态货量更新
                            UPDATE DWM_DT_VALUE A
                            SET    (A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT) =
                                    (SELECT NVL(A.SY_AREA_DT_ALL, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.SY_AREA_REMAIN, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.SY_AREA_HAVED_SALE, 0) + 0, NVL(A.SY_AREA_RESERVE, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA, NVL(A.SY_AREA_IN_PROCESS, 0) + 0,
                                            NVL(A.SY_AREA_ALLOW_SALE, 0) + 0, NVL(A.SY_AREA_STOCK, 0) + 0, NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + ITEM_OBJ_INDEX_LIST.TOTAL_SALE_AREA,
                                            NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0) + 0, NVL(A.SY_AREA_NOT_SALE_PERMIT, 0) + 0, NVL(A.SY_AREA_NOT_COMPLETION, 0) + 0,
                                            NVL(A.SY_AREA_YES_COMPLETION, 0) + 0, NVL(A.SY_AREA_YES_SETTLEMENT, 0) + 0
                                     FROM   DUAL)
                            WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                        ELSE
                            DBMS_OUTPUT.PUT_LINE('1');
                        END IF;
                    END LOOP;
                CLOSE CUR_OBJ_INDEX_LIST;


                UPDATE DWM_DT_VALUE A
                SET    (A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                        (SELECT NVL(A.CW_VALUE_DT_ALL, 0) + NVL(A.SY_VALUE_DT_ALL, 0) + NVL(A.ZZ_VALUE_DT_ALL, 0), NVL(A.CW_VALUE_REMAIN, 0) + NVL(A.SY_VALUE_REMAIN, 0) + NVL(A.ZZ_VALUE_REMAIN, 0),
                                NVL(A.CW_VALUE_HAVED_SALE, 0) + NVL(A.SY_VALUE_HAVED_SALE, 0) + NVL(A.ZZ_VALUE_HAVED_SALE, 0),
                                NVL(A.CW_VALUE_RESERVE, 0) + NVL(A.SY_VALUE_RESERVE, 0) + NVL(A.ZZ_VALUE_RESERVE, 0),
                                NVL(A.CW_VALUE_IN_PROCESS, 0) + NVL(A.SY_VALUE_IN_PROCESS, 0) + NVL(A.ZZ_VALUE_IN_PROCESS, 0),
                                NVL(A.CW_VALUE_ALLOW_SALE, 0) + NVL(A.SY_VALUE_ALLOW_SALE, 0) + NVL(A.ZZ_VALUE_ALLOW_SALE, 0),
                                NVL(A.CW_VALUE_STOCK, 0) + NVL(A.SY_VALUE_STOCK, 0) + NVL(A.ZZ_VALUE_STOCK, 0),
                                NVL(A.CW_VALUE_NOT_PLANNING_PERMIT, 0) + NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + NVL(A.ZZ_VALUE_NOT_PLANNING_PERMIT, 0),
                                NVL(A.CW_VALUE_NOT_CONSTRUCTION_PER, 0) + NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0) + NVL(A.ZZ_VALUE_NOT_CONSTRUCTION_PER, 0),
                                NVL(A.CW_VALUE_NOT_SALE_PERMIT, 0) + NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0) + NVL(A.ZZ_VALUE_NOT_SALE_PERMIT, 0),
                                NVL(A.CW_VALUE_NOT_COMPLETION, 0) + NVL(A.SY_VALUE_NOT_COMPLETION, 0) + NVL(A.ZZ_VALUE_NOT_COMPLETION, 0),
                                NVL(A.CW_VALUE_YES_COMPLETION, 0) + NVL(A.SY_VALUE_YES_COMPLETION, 0) + NVL(A.ZZ_VALUE_YES_COMPLETION, 0),
                                NVL(A.CW_VALUE_YES_SETTLEMENT, 0) + NVL(A.SY_VALUE_YES_SETTLEMENT, 0) + NVL(A.ZZ_VALUE_YES_SETTLEMENT, 0)
                         FROM   DUAL)
                WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                UPDATE DWM_DT_VALUE A
                SET    (A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                        (SELECT NVL(A.CW_AREA_DT_ALL, 0) + NVL(A.SY_AREA_DT_ALL, 0) + NVL(A.ZZ_AREA_DT_ALL, 0), NVL(A.CW_AREA_REMAIN, 0) + NVL(A.SY_AREA_REMAIN, 0) + NVL(A.ZZ_AREA_REMAIN, 0),
                                NVL(A.CW_AREA_HAVED_SALE, 0) + NVL(A.SY_AREA_HAVED_SALE, 0) + NVL(A.ZZ_AREA_HAVED_SALE, 0),
                                NVL(A.CW_AREA_RESERVE, 0) + NVL(A.SY_AREA_RESERVE, 0) + NVL(A.ZZ_AREA_RESERVE, 0),
                                NVL(A.CW_AREA_IN_PROCESS, 0) + NVL(A.SY_AREA_IN_PROCESS, 0) + NVL(A.ZZ_AREA_IN_PROCESS, 0),
                                NVL(A.CW_AREA_ALLOW_SALE, 0) + NVL(A.SY_AREA_ALLOW_SALE, 0) + NVL(A.ZZ_AREA_ALLOW_SALE, 0), NVL(A.CW_AREA_STOCK, 0) + NVL(A.SY_AREA_STOCK, 0) + NVL(A.ZZ_AREA_STOCK, 0),
                                NVL(A.CW_AREA_NOT_PLANNING_PERMIT, 0) + NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + NVL(A.ZZ_AREA_NOT_PLANNING_PERMIT, 0),
                                NVL(A.CW_AREA_NOT_CONSTRUCTION_PER, 0) + NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0) + NVL(A.ZZ_AREA_NOT_CONSTRUCTION_PER, 0),
                                NVL(A.CW_AREA_NOT_SALE_PERMIT, 0) + NVL(A.SY_AREA_NOT_SALE_PERMIT, 0) + NVL(A.ZZ_AREA_NOT_SALE_PERMIT, 0),
                                NVL(A.CW_AREA_NOT_COMPLETION, 0) + NVL(A.SY_AREA_NOT_COMPLETION, 0) + NVL(A.ZZ_AREA_NOT_COMPLETION, 0),
                                NVL(A.CW_AREA_YES_COMPLETION, 0) + NVL(A.SY_AREA_YES_COMPLETION, 0) + NVL(A.ZZ_AREA_YES_COMPLETION, 0),
                                NVL(A.CW_AREA_YES_SETTLEMENT, 0) + NVL(A.SY_AREA_YES_SETTLEMENT, 0) + NVL(A.ZZ_AREA_YES_SETTLEMENT, 0)
                         FROM   DUAL)
                WHERE  A.OBJ_ID = ITEM_BLD_LIST.ID;

                END;

            ELSE
                NULL;
            END IF;
        END;
    END LOOP;
    CLOSE CUR_BLD_LIST;

    /*
    --项目级动态货值、货量更新
    */
    --项目级动态货值更新
    UPDATE DWM_DT_VALUE B
    SET    (B.VALUE_DT_ALL, B.VALUE_REMAIN, B.VALUE_HAVED_SALE, B.VALUE_RESERVE, B.VALUE_IN_PROCESS, B.VALUE_ALLOW_SALE, B.VALUE_STOCK, B.VALUE_NOT_PLANNING_PERMIT, B.VALUE_NOT_CONSTRUCTION_PERMIT, B.VALUE_NOT_SALE_PERMIT, B.VALUE_NOT_COMPLETION, B.VALUE_YES_COMPLETION, B.VALUE_YES_SETTLEMENT) =
            (SELECT SUM(A.VALUE_DT_ALL), SUM(A.VALUE_REMAIN), SUM(A.VALUE_HAVED_SALE), SUM(A.VALUE_RESERVE), SUM(A.VALUE_IN_PROCESS), SUM(A.VALUE_ALLOW_SALE), SUM(A.VALUE_STOCK),
                    SUM(A.VALUE_NOT_PLANNING_PERMIT), SUM(A.VALUE_NOT_CONSTRUCTION_PERMIT), SUM(A.VALUE_NOT_SALE_PERMIT), SUM(A.VALUE_NOT_COMPLETION), SUM(A.VALUE_YES_COMPLETION),
                    SUM(A.VALUE_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PROJ_ID = B.PROJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  B.OBJ_TYPE = '项目';

    UPDATE DWM_DT_VALUE P
    SET    (P.CW_VALUE_DT_ALL, P.CW_VALUE_REMAIN, P.CW_VALUE_HAVED_SALE, P.CW_VALUE_RESERVE, P.CW_VALUE_IN_PROCESS, P.CW_VALUE_ALLOW_SALE, P.CW_VALUE_STOCK, P.CW_VALUE_NOT_PLANNING_PERMIT, P.CW_VALUE_NOT_CONSTRUCTION_PER, P.CW_VALUE_NOT_SALE_PERMIT, P.CW_VALUE_NOT_COMPLETION, P.CW_VALUE_YES_COMPLETION, P.CW_VALUE_YES_SETTLEMENT) =
            (SELECT SUM(A.CW_VALUE_DT_ALL), SUM(A.CW_VALUE_REMAIN), SUM(A.CW_VALUE_HAVED_SALE), SUM(A.CW_VALUE_RESERVE), SUM(A.CW_VALUE_IN_PROCESS), SUM(A.CW_VALUE_ALLOW_SALE), SUM(A.CW_VALUE_STOCK),
                    SUM(A.CW_VALUE_NOT_PLANNING_PERMIT), SUM(A.CW_VALUE_NOT_CONSTRUCTION_PER), SUM(A.CW_VALUE_NOT_SALE_PERMIT), SUM(A.CW_VALUE_NOT_COMPLETION), SUM(A.CW_VALUE_YES_COMPLETION),
                    SUM(A.CW_VALUE_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PROJ_ID = P.PROJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  P.OBJ_TYPE = '项目';

    UPDATE DWM_DT_VALUE P
    SET    (P.ZZ_VALUE_DT_ALL, P.ZZ_VALUE_REMAIN, P.ZZ_VALUE_HAVED_SALE, P.ZZ_VALUE_RESERVE, P.ZZ_VALUE_IN_PROCESS, P.ZZ_VALUE_ALLOW_SALE, P.ZZ_VALUE_STOCK, P.ZZ_VALUE_NOT_PLANNING_PERMIT, P.ZZ_VALUE_NOT_CONSTRUCTION_PER, P.ZZ_VALUE_NOT_SALE_PERMIT, P.ZZ_VALUE_NOT_COMPLETION, P.ZZ_VALUE_YES_COMPLETION, P.ZZ_VALUE_YES_SETTLEMENT) =
            (SELECT SUM(A.ZZ_VALUE_DT_ALL), SUM(A.ZZ_VALUE_REMAIN), SUM(A.ZZ_VALUE_HAVED_SALE), SUM(A.ZZ_VALUE_RESERVE), SUM(A.ZZ_VALUE_IN_PROCESS), SUM(A.ZZ_VALUE_ALLOW_SALE), SUM(A.ZZ_VALUE_STOCK),
                    SUM(A.ZZ_VALUE_NOT_PLANNING_PERMIT), SUM(A.ZZ_VALUE_NOT_CONSTRUCTION_PER), SUM(A.ZZ_VALUE_NOT_SALE_PERMIT), SUM(A.ZZ_VALUE_NOT_COMPLETION), SUM(A.ZZ_VALUE_YES_COMPLETION),
                    SUM(A.ZZ_VALUE_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PROJ_ID = P.PROJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  P.OBJ_TYPE = '项目';

    UPDATE DWM_DT_VALUE P
    SET    (P.SY_VALUE_DT_ALL, P.SY_VALUE_REMAIN, P.SY_VALUE_HAVED_SALE, P.SY_VALUE_RESERVE, P.SY_VALUE_IN_PROCESS, P.SY_VALUE_ALLOW_SALE, P.SY_VALUE_STOCK, P.SY_VALUE_NOT_PLANNING_PERMIT, P.SY_VALUE_NOT_CONSTRUCTION_PER, P.SY_VALUE_NOT_SALE_PERMIT, P.SY_VALUE_NOT_COMPLETION, P.SY_VALUE_YES_COMPLETION, P.SY_VALUE_YES_SETTLEMENT) =
            (SELECT SUM(A.SY_VALUE_DT_ALL), SUM(A.SY_VALUE_REMAIN), SUM(A.SY_VALUE_HAVED_SALE), SUM(A.SY_VALUE_RESERVE), SUM(A.SY_VALUE_IN_PROCESS), SUM(A.SY_VALUE_ALLOW_SALE), SUM(A.SY_VALUE_STOCK),
                    SUM(A.SY_VALUE_NOT_PLANNING_PERMIT), SUM(A.SY_VALUE_NOT_CONSTRUCTION_PER), SUM(A.SY_VALUE_NOT_SALE_PERMIT), SUM(A.SY_VALUE_NOT_COMPLETION), SUM(A.SY_VALUE_YES_COMPLETION),
                    SUM(A.SY_VALUE_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PROJ_ID = P.PROJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  P.OBJ_TYPE = '项目';

    --项目级动态货量更新
    UPDATE DWM_DT_VALUE B
    SET    (B.AREA_DT_ALL, B.AREA_REMAIN, B.AREA_HAVED_SALE, B.AREA_RESERVE, B.AREA_IN_PROCESS, B.AREA_ALLOW_SALE, B.AREA_STOCK, B.AREA_NOT_PLANNING_PERMIT, B.AREA_NOT_CONSTRUCTION_PERMIT, B.AREA_NOT_SALE_PERMIT, B.AREA_NOT_COMPLETION, B.AREA_YES_COMPLETION, B.AREA_YES_SETTLEMENT) =
            (SELECT SUM(A.AREA_DT_ALL), SUM(A.AREA_REMAIN), SUM(A.AREA_HAVED_SALE), SUM(A.AREA_RESERVE), SUM(A.AREA_IN_PROCESS), SUM(A.AREA_ALLOW_SALE), SUM(A.AREA_STOCK),
                    SUM(A.AREA_NOT_PLANNING_PERMIT), SUM(A.AREA_NOT_CONSTRUCTION_PERMIT), SUM(A.AREA_NOT_SALE_PERMIT), SUM(A.AREA_NOT_COMPLETION), SUM(A.AREA_YES_COMPLETION), SUM(A.AREA_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PROJ_ID = B.PROJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  B.OBJ_TYPE = '项目';

    UPDATE DWM_DT_VALUE P
    SET    (P.CW_AREA_DT_ALL, P.CW_AREA_REMAIN, P.CW_AREA_HAVED_SALE, P.CW_AREA_RESERVE, P.CW_AREA_IN_PROCESS, P.CW_AREA_ALLOW_SALE, P.CW_AREA_STOCK, P.CW_AREA_NOT_PLANNING_PERMIT, P.CW_AREA_NOT_CONSTRUCTION_PER, P.CW_AREA_NOT_SALE_PERMIT, P.CW_AREA_NOT_COMPLETION, P.CW_AREA_YES_COMPLETION, P.CW_AREA_YES_SETTLEMENT) =
            (SELECT SUM(A.CW_AREA_DT_ALL), SUM(A.CW_AREA_REMAIN), SUM(A.CW_AREA_HAVED_SALE), SUM(A.CW_AREA_RESERVE), SUM(A.CW_AREA_IN_PROCESS), SUM(A.CW_AREA_ALLOW_SALE), SUM(A.CW_AREA_STOCK),
                    SUM(A.CW_AREA_NOT_PLANNING_PERMIT), SUM(A.CW_AREA_NOT_CONSTRUCTION_PER), SUM(A.CW_AREA_NOT_SALE_PERMIT), SUM(A.CW_AREA_NOT_COMPLETION), SUM(A.CW_AREA_YES_COMPLETION),
                    SUM(A.CW_AREA_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PROJ_ID = P.PROJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  P.OBJ_TYPE = '项目';

    UPDATE DWM_DT_VALUE P
    SET    (P.ZZ_AREA_DT_ALL, P.ZZ_AREA_REMAIN, P.ZZ_AREA_HAVED_SALE, P.ZZ_AREA_RESERVE, P.ZZ_AREA_IN_PROCESS, P.ZZ_AREA_ALLOW_SALE, P.ZZ_AREA_STOCK, P.ZZ_AREA_NOT_PLANNING_PERMIT, P.ZZ_AREA_NOT_CONSTRUCTION_PER, P.ZZ_AREA_NOT_SALE_PERMIT, P.ZZ_AREA_NOT_COMPLETION, P.ZZ_AREA_YES_COMPLETION, P.ZZ_AREA_YES_SETTLEMENT) =
            (SELECT SUM(A.ZZ_AREA_DT_ALL), SUM(A.ZZ_AREA_REMAIN), SUM(A.ZZ_AREA_HAVED_SALE), SUM(A.ZZ_AREA_RESERVE), SUM(A.ZZ_AREA_IN_PROCESS), SUM(A.ZZ_AREA_ALLOW_SALE), SUM(A.ZZ_AREA_STOCK),
                    SUM(A.ZZ_AREA_NOT_PLANNING_PERMIT), SUM(A.ZZ_AREA_NOT_CONSTRUCTION_PER), SUM(A.ZZ_AREA_NOT_SALE_PERMIT), SUM(A.ZZ_AREA_NOT_COMPLETION), SUM(A.ZZ_AREA_YES_COMPLETION),
                    SUM(A.ZZ_AREA_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PROJ_ID = P.PROJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  P.OBJ_TYPE = '项目';

    UPDATE DWM_DT_VALUE P
    SET    (P.SY_AREA_DT_ALL, P.SY_AREA_REMAIN, P.SY_AREA_HAVED_SALE, P.SY_AREA_RESERVE, P.SY_AREA_IN_PROCESS, P.SY_AREA_ALLOW_SALE, P.SY_AREA_STOCK, P.SY_AREA_NOT_PLANNING_PERMIT, P.SY_AREA_NOT_CONSTRUCTION_PER, P.SY_AREA_NOT_SALE_PERMIT, P.SY_AREA_NOT_COMPLETION, P.SY_AREA_YES_COMPLETION, P.SY_AREA_YES_SETTLEMENT) =
            (SELECT SUM(A.SY_AREA_DT_ALL), SUM(A.SY_AREA_REMAIN), SUM(A.SY_AREA_HAVED_SALE), SUM(A.SY_AREA_RESERVE), SUM(A.SY_AREA_IN_PROCESS), SUM(A.SY_AREA_ALLOW_SALE), SUM(A.SY_AREA_STOCK),
                    SUM(A.SY_AREA_NOT_PLANNING_PERMIT), SUM(A.SY_AREA_NOT_CONSTRUCTION_PER), SUM(A.SY_AREA_NOT_SALE_PERMIT), SUM(A.SY_AREA_NOT_COMPLETION), SUM(A.SY_AREA_YES_COMPLETION),
                    SUM(A.SY_AREA_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PROJ_ID = P.PROJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  P.OBJ_TYPE = '项目';

    /*
    --分期级动态货值、货量更新
    */

    --动态货值更新
    UPDATE DWM_DT_VALUE B
    SET    (B.VALUE_DT_ALL, B.VALUE_REMAIN, B.VALUE_HAVED_SALE, B.VALUE_RESERVE, B.VALUE_IN_PROCESS, B.VALUE_ALLOW_SALE, B.VALUE_STOCK, B.VALUE_NOT_PLANNING_PERMIT, B.VALUE_NOT_CONSTRUCTION_PERMIT, B.VALUE_NOT_SALE_PERMIT, B.VALUE_NOT_COMPLETION, B.VALUE_YES_COMPLETION, B.VALUE_YES_SETTLEMENT) =
            (SELECT SUM(A.VALUE_DT_ALL), SUM(A.VALUE_REMAIN), SUM(A.VALUE_HAVED_SALE), SUM(A.VALUE_RESERVE), SUM(A.VALUE_IN_PROCESS), SUM(A.VALUE_ALLOW_SALE), SUM(A.VALUE_STOCK),
                    SUM(A.VALUE_NOT_PLANNING_PERMIT), SUM(A.VALUE_NOT_CONSTRUCTION_PERMIT), SUM(A.VALUE_NOT_SALE_PERMIT), SUM(A.VALUE_NOT_COMPLETION), SUM(A.VALUE_YES_COMPLETION),
                    SUM(A.VALUE_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PARENT_ID = B.OBJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  B.OBJ_TYPE = '分期';

    UPDATE DWM_DT_VALUE P
    SET    (P.CW_VALUE_DT_ALL, P.CW_VALUE_REMAIN, P.CW_VALUE_HAVED_SALE, P.CW_VALUE_RESERVE, P.CW_VALUE_IN_PROCESS, P.CW_VALUE_ALLOW_SALE, P.CW_VALUE_STOCK, P.CW_VALUE_NOT_PLANNING_PERMIT, P.CW_VALUE_NOT_CONSTRUCTION_PER, P.CW_VALUE_NOT_SALE_PERMIT, P.CW_VALUE_NOT_COMPLETION, P.CW_VALUE_YES_COMPLETION, P.CW_VALUE_YES_SETTLEMENT) =
            (SELECT SUM(A.CW_VALUE_DT_ALL), SUM(A.CW_VALUE_REMAIN), SUM(A.CW_VALUE_HAVED_SALE), SUM(A.CW_VALUE_RESERVE), SUM(A.CW_VALUE_IN_PROCESS), SUM(A.CW_VALUE_ALLOW_SALE), SUM(A.CW_VALUE_STOCK),
                    SUM(A.CW_VALUE_NOT_PLANNING_PERMIT), SUM(A.CW_VALUE_NOT_CONSTRUCTION_PER), SUM(A.CW_VALUE_NOT_SALE_PERMIT), SUM(A.CW_VALUE_NOT_COMPLETION), SUM(A.CW_VALUE_YES_COMPLETION),
                    SUM(A.CW_VALUE_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PARENT_ID = P.OBJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  P.OBJ_TYPE = '分期';

    UPDATE DWM_DT_VALUE P
    SET    (P.ZZ_VALUE_DT_ALL, P.ZZ_VALUE_REMAIN, P.ZZ_VALUE_HAVED_SALE, P.ZZ_VALUE_RESERVE, P.ZZ_VALUE_IN_PROCESS, P.ZZ_VALUE_ALLOW_SALE, P.ZZ_VALUE_STOCK, P.ZZ_VALUE_NOT_PLANNING_PERMIT, P.ZZ_VALUE_NOT_CONSTRUCTION_PER, P.ZZ_VALUE_NOT_SALE_PERMIT, P.ZZ_VALUE_NOT_COMPLETION, P.ZZ_VALUE_YES_COMPLETION, P.ZZ_VALUE_YES_SETTLEMENT) =
            (SELECT SUM(A.ZZ_VALUE_DT_ALL), SUM(A.ZZ_VALUE_REMAIN), SUM(A.ZZ_VALUE_HAVED_SALE), SUM(A.ZZ_VALUE_RESERVE), SUM(A.ZZ_VALUE_IN_PROCESS), SUM(A.ZZ_VALUE_ALLOW_SALE), SUM(A.ZZ_VALUE_STOCK),
                    SUM(A.ZZ_VALUE_NOT_PLANNING_PERMIT), SUM(A.ZZ_VALUE_NOT_CONSTRUCTION_PER), SUM(A.ZZ_VALUE_NOT_SALE_PERMIT), SUM(A.ZZ_VALUE_NOT_COMPLETION), SUM(A.ZZ_VALUE_YES_COMPLETION),
                    SUM(A.ZZ_VALUE_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PARENT_ID = P.OBJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  P.OBJ_TYPE = '分期';

    UPDATE DWM_DT_VALUE P
    SET    (P.SY_VALUE_DT_ALL, P.SY_VALUE_REMAIN, P.SY_VALUE_HAVED_SALE, P.SY_VALUE_RESERVE, P.SY_VALUE_IN_PROCESS, P.SY_VALUE_ALLOW_SALE, P.SY_VALUE_STOCK, P.SY_VALUE_NOT_PLANNING_PERMIT, P.SY_VALUE_NOT_CONSTRUCTION_PER, P.SY_VALUE_NOT_SALE_PERMIT, P.SY_VALUE_NOT_COMPLETION, P.SY_VALUE_YES_COMPLETION, P.SY_VALUE_YES_SETTLEMENT) =
            (SELECT SUM(A.SY_VALUE_DT_ALL), SUM(A.SY_VALUE_REMAIN), SUM(A.SY_VALUE_HAVED_SALE), SUM(A.SY_VALUE_RESERVE), SUM(A.SY_VALUE_IN_PROCESS), SUM(A.SY_VALUE_ALLOW_SALE), SUM(A.SY_VALUE_STOCK),
                    SUM(A.SY_VALUE_NOT_PLANNING_PERMIT), SUM(A.SY_VALUE_NOT_CONSTRUCTION_PER), SUM(A.SY_VALUE_NOT_SALE_PERMIT), SUM(A.SY_VALUE_NOT_COMPLETION), SUM(A.SY_VALUE_YES_COMPLETION),
                    SUM(A.SY_VALUE_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PARENT_ID = P.OBJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  P.OBJ_TYPE = '分期';

    --动态货量更新
    UPDATE DWM_DT_VALUE B
    SET    (B.AREA_DT_ALL, B.AREA_REMAIN, B.AREA_HAVED_SALE, B.AREA_RESERVE, B.AREA_IN_PROCESS, B.AREA_ALLOW_SALE, B.AREA_STOCK, B.AREA_NOT_PLANNING_PERMIT, B.AREA_NOT_CONSTRUCTION_PERMIT, B.AREA_NOT_SALE_PERMIT, B.AREA_NOT_COMPLETION, B.AREA_YES_COMPLETION, B.AREA_YES_SETTLEMENT) =
            (SELECT SUM(A.AREA_DT_ALL), SUM(A.AREA_REMAIN), SUM(A.AREA_HAVED_SALE), SUM(A.AREA_RESERVE), SUM(A.AREA_IN_PROCESS), SUM(A.AREA_ALLOW_SALE), SUM(A.AREA_STOCK),
                    SUM(A.AREA_NOT_PLANNING_PERMIT), SUM(A.AREA_NOT_CONSTRUCTION_PERMIT), SUM(A.AREA_NOT_SALE_PERMIT), SUM(A.AREA_NOT_COMPLETION), SUM(A.AREA_YES_COMPLETION), SUM(A.AREA_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PARENT_ID = B.OBJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  B.OBJ_TYPE = '分期';

    UPDATE DWM_DT_VALUE P
    SET    (P.CW_AREA_DT_ALL, P.CW_AREA_REMAIN, P.CW_AREA_HAVED_SALE, P.CW_AREA_RESERVE, P.CW_AREA_IN_PROCESS, P.CW_AREA_ALLOW_SALE, P.CW_AREA_STOCK, P.CW_AREA_NOT_PLANNING_PERMIT, P.CW_AREA_NOT_CONSTRUCTION_PER, P.CW_AREA_NOT_SALE_PERMIT, P.CW_AREA_NOT_COMPLETION, P.CW_AREA_YES_COMPLETION, P.CW_AREA_YES_SETTLEMENT) =
            (SELECT SUM(A.CW_AREA_DT_ALL), SUM(A.CW_AREA_REMAIN), SUM(A.CW_AREA_HAVED_SALE), SUM(A.CW_AREA_RESERVE), SUM(A.CW_AREA_IN_PROCESS), SUM(A.CW_AREA_ALLOW_SALE), SUM(A.CW_AREA_STOCK),
                    SUM(A.CW_AREA_NOT_PLANNING_PERMIT), SUM(A.CW_AREA_NOT_CONSTRUCTION_PER), SUM(A.CW_AREA_NOT_SALE_PERMIT), SUM(A.CW_AREA_NOT_COMPLETION), SUM(A.CW_AREA_YES_COMPLETION),
                    SUM(A.CW_AREA_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PARENT_ID = P.OBJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  P.OBJ_TYPE = '分期';

    UPDATE DWM_DT_VALUE P
    SET    (P.ZZ_AREA_DT_ALL, P.ZZ_AREA_REMAIN, P.ZZ_AREA_HAVED_SALE, P.ZZ_AREA_RESERVE, P.ZZ_AREA_IN_PROCESS, P.ZZ_AREA_ALLOW_SALE, P.ZZ_AREA_STOCK, P.ZZ_AREA_NOT_PLANNING_PERMIT, P.ZZ_AREA_NOT_CONSTRUCTION_PER, P.ZZ_AREA_NOT_SALE_PERMIT, P.ZZ_AREA_NOT_COMPLETION, P.ZZ_AREA_YES_COMPLETION, P.ZZ_AREA_YES_SETTLEMENT) =
            (SELECT SUM(A.ZZ_AREA_DT_ALL), SUM(A.ZZ_AREA_REMAIN), SUM(A.ZZ_AREA_HAVED_SALE), SUM(A.ZZ_AREA_RESERVE), SUM(A.ZZ_AREA_IN_PROCESS), SUM(A.ZZ_AREA_ALLOW_SALE), SUM(A.ZZ_AREA_STOCK),
                    SUM(A.ZZ_AREA_NOT_PLANNING_PERMIT), SUM(A.ZZ_AREA_NOT_CONSTRUCTION_PER), SUM(A.ZZ_AREA_NOT_SALE_PERMIT), SUM(A.ZZ_AREA_NOT_COMPLETION), SUM(A.ZZ_AREA_YES_COMPLETION),
                    SUM(A.ZZ_AREA_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PARENT_ID = P.OBJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  P.OBJ_TYPE = '分期';

    UPDATE DWM_DT_VALUE P
    SET    (P.SY_AREA_DT_ALL, P.SY_AREA_REMAIN, P.SY_AREA_HAVED_SALE, P.SY_AREA_RESERVE, P.SY_AREA_IN_PROCESS, P.SY_AREA_ALLOW_SALE, P.SY_AREA_STOCK, P.SY_AREA_NOT_PLANNING_PERMIT, P.SY_AREA_NOT_CONSTRUCTION_PER, P.SY_AREA_NOT_SALE_PERMIT, P.SY_AREA_NOT_COMPLETION, P.SY_AREA_YES_COMPLETION, P.SY_AREA_YES_SETTLEMENT) =
            (SELECT SUM(A.SY_AREA_DT_ALL), SUM(A.SY_AREA_REMAIN), SUM(A.SY_AREA_HAVED_SALE), SUM(A.SY_AREA_RESERVE), SUM(A.SY_AREA_IN_PROCESS), SUM(A.SY_AREA_ALLOW_SALE), SUM(A.SY_AREA_STOCK),
                    SUM(A.SY_AREA_NOT_PLANNING_PERMIT), SUM(A.SY_AREA_NOT_CONSTRUCTION_PER), SUM(A.SY_AREA_NOT_SALE_PERMIT), SUM(A.SY_AREA_NOT_COMPLETION), SUM(A.SY_AREA_YES_COMPLETION),
                    SUM(A.SY_AREA_YES_SETTLEMENT)
             FROM   DWM_DT_VALUE A
             WHERE  A.OBJ_TYPE = '楼栋' AND A.PARENT_ID = P.OBJ_ID
             GROUP  BY A.PROJ_ID)
    WHERE  P.OBJ_TYPE = '分期';

    /*
    ----------------------------------------------------------------
        更新当前在全盘阶段分期的动态货值、动态货量,动态货值计算公式：当前阶段业态的面积*业态最新均价
    ----------------------------------------------------------------
    */

    OPEN CUR_PERIOD_LIST;
    LOOP

        FETCH CUR_PERIOD_LIST
            INTO ITEM_PERIOD_LIST;
        EXIT WHEN CUR_PERIOD_LIST%NOTFOUND;
        --获取当前业态最新均价
        SELECT A.TARGET_A_ID INTO V_TARGET_WORTH_ID FROM DWM_DT_VALUE A WHERE A.OBJ_ID = ITEM_PERIOD_LIST.PERIOD_ID;

        SELECT COUNT(1)
        INTO   V_COUNT
        FROM   DWM_TARGET_WORTH_DTL A
        WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_ID = ITEM_PERIOD_LIST.PRODUCT_TYPE_ID AND A.OBJ_PARENT_ID = ITEM_PERIOD_LIST.PERIOD_ID;

        IF V_COUNT = 1 THEN
            SELECT NVL(A.AVERAGE_PRICE, 0)
            INTO   V_PRICE
            FROM   DWM_TARGET_WORTH_DTL A
            WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_ID = ITEM_PERIOD_LIST.PRODUCT_TYPE_ID AND A.OBJ_PARENT_ID = ITEM_PERIOD_LIST.PERIOD_ID;
        ELSE
            V_PRICE := 0;
        END IF;

        --获取当前业态所属一级业态

        V_PRODUCT_TYPE := SUBSTR(ITEM_PERIOD_LIST.PRODUCT_TYPE_NAME, 0, INSTR(ITEM_PERIOD_LIST.PRODUCT_TYPE_NAME, '/', 1) - 1);
        V_IS_CARPORT := CASE
                            WHEN ITEM_PERIOD_LIST.PRODUCT_TYPE_JSON = '{"isCarport":1}' THEN
                             1
                            ELSE
                             0
                        END;

        IF V_PRODUCT_TYPE = '住宅' THEN
            /*
            ------------------------------------------
            更新分期ZZ动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --ZZ动态货值
                     A.ZZ_VALUE_DT_ALL, A.ZZ_VALUE_REMAIN, A.ZZ_VALUE_HAVED_SALE, A.ZZ_VALUE_RESERVE, A.ZZ_VALUE_IN_PROCESS, A.ZZ_VALUE_ALLOW_SALE, A.ZZ_VALUE_STOCK, A.ZZ_VALUE_NOT_PLANNING_PERMIT, A.ZZ_VALUE_NOT_CONSTRUCTION_PER, A.ZZ_VALUE_NOT_SALE_PERMIT, A.ZZ_VALUE_NOT_COMPLETION, A.ZZ_VALUE_YES_COMPLETION, A.ZZ_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --ZZ动态货值
                      NVL(A.ZZ_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.ZZ_VALUE_HAVED_SALE, 0), NVL(A.ZZ_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_VALUE_IN_PROCESS, 0), NVL(A.ZZ_VALUE_ALLOW_SALE, 0),
                      NVL(A.ZZ_VALUE_STOCK, 0), NVL(A.ZZ_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.ZZ_VALUE_NOT_SALE_PERMIT, 0), NVL(A.ZZ_VALUE_NOT_COMPLETION, 0), NVL(A.ZZ_VALUE_YES_COMPLETION, 0), NVL(A.ZZ_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.VALUE_HAVED_SALE, 0), NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0),
                      NVL(A.VALUE_STOCK, 0), NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.VALUE_NOT_SALE_PERMIT, 0), NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PERIOD_ID;
            /*
            ------------------------------------------
            更新分期ZZ动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --ZZ动态货量
                     A.ZZ_AREA_DT_ALL, A.ZZ_AREA_REMAIN, A.ZZ_AREA_HAVED_SALE, A.ZZ_AREA_RESERVE, A.ZZ_AREA_IN_PROCESS, A.ZZ_AREA_ALLOW_SALE, A.ZZ_AREA_STOCK, A.ZZ_AREA_NOT_PLANNING_PERMIT, A.ZZ_AREA_NOT_CONSTRUCTION_PER, A.ZZ_AREA_NOT_SALE_PERMIT, A.ZZ_AREA_NOT_COMPLETION, A.ZZ_AREA_YES_COMPLETION, A.ZZ_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --ZZ动态货量
                      NVL(A.ZZ_AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_AREA_HAVED_SALE, 0),
                      NVL(A.ZZ_AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_AREA_IN_PROCESS, 0), NVL(A.ZZ_AREA_ALLOW_SALE, 0), NVL(A.ZZ_AREA_STOCK, 0),
                      NVL(A.ZZ_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_AREA_NOT_CONSTRUCTION_PER, 0), NVL(A.ZZ_AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.ZZ_AREA_NOT_COMPLETION, 0), NVL(A.ZZ_AREA_YES_COMPLETION, 0), NVL(A.ZZ_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_HAVED_SALE, 0),
                      NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0), NVL(A.AREA_STOCK, 0),
                      NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.AREA_NOT_SALE_PERMIT, 0), NVL(A.AREA_NOT_COMPLETION, 0),
                      NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PERIOD_ID;
            /*
            ------------------------------------------
            更新项目ZZ动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --ZZ动态货值
                     A.ZZ_VALUE_DT_ALL, A.ZZ_VALUE_REMAIN, A.ZZ_VALUE_HAVED_SALE, A.ZZ_VALUE_RESERVE, A.ZZ_VALUE_IN_PROCESS, A.ZZ_VALUE_ALLOW_SALE, A.ZZ_VALUE_STOCK, A.ZZ_VALUE_NOT_PLANNING_PERMIT, A.ZZ_VALUE_NOT_CONSTRUCTION_PER, A.ZZ_VALUE_NOT_SALE_PERMIT, A.ZZ_VALUE_NOT_COMPLETION, A.ZZ_VALUE_YES_COMPLETION, A.ZZ_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --ZZ动态货值
                      NVL(A.ZZ_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.ZZ_VALUE_HAVED_SALE, 0), NVL(A.ZZ_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_VALUE_IN_PROCESS, 0), NVL(A.ZZ_VALUE_ALLOW_SALE, 0),
                      NVL(A.ZZ_VALUE_STOCK, 0), NVL(A.ZZ_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.ZZ_VALUE_NOT_SALE_PERMIT, 0), NVL(A.ZZ_VALUE_NOT_COMPLETION, 0), NVL(A.ZZ_VALUE_YES_COMPLETION, 0), NVL(A.ZZ_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.VALUE_HAVED_SALE, 0), NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0),
                      NVL(A.VALUE_STOCK, 0), NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.VALUE_NOT_SALE_PERMIT, 0), NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PROJECT_ID;
            /*
            ------------------------------------------
            更新项目ZZ动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --ZZ动态货量
                     A.ZZ_AREA_DT_ALL, A.ZZ_AREA_REMAIN, A.ZZ_AREA_HAVED_SALE, A.ZZ_AREA_RESERVE, A.ZZ_AREA_IN_PROCESS, A.ZZ_AREA_ALLOW_SALE, A.ZZ_AREA_STOCK, A.ZZ_AREA_NOT_PLANNING_PERMIT, A.ZZ_AREA_NOT_CONSTRUCTION_PER, A.ZZ_AREA_NOT_SALE_PERMIT, A.ZZ_AREA_NOT_COMPLETION, A.ZZ_AREA_YES_COMPLETION, A.ZZ_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --ZZ动态货量
                      NVL(A.ZZ_AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_AREA_HAVED_SALE, 0),
                      NVL(A.ZZ_AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_AREA_IN_PROCESS, 0), NVL(A.ZZ_AREA_ALLOW_SALE, 0), NVL(A.ZZ_AREA_STOCK, 0),
                      NVL(A.ZZ_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_AREA_NOT_CONSTRUCTION_PER, 0), NVL(A.ZZ_AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.ZZ_AREA_NOT_COMPLETION, 0), NVL(A.ZZ_AREA_YES_COMPLETION, 0), NVL(A.ZZ_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_HAVED_SALE, 0),
                      NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0), NVL(A.AREA_STOCK, 0),
                      NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.AREA_NOT_SALE_PERMIT, 0), NVL(A.AREA_NOT_COMPLETION, 0),
                      NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PROJECT_ID;

        ELSIF V_PRODUCT_TYPE = '商办产业' THEN

            /*
            ------------------------------------------
            更新分期ZZ动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --ZZ动态货值
                     A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --ZZ动态货值
                      NVL(A.SY_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.SY_VALUE_HAVED_SALE, 0), NVL(A.SY_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_IN_PROCESS, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0),
                      NVL(A.SY_VALUE_STOCK, 0), NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0), NVL(A.SY_VALUE_NOT_COMPLETION, 0), NVL(A.SY_VALUE_YES_COMPLETION, 0), NVL(A.SY_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.VALUE_HAVED_SALE, 0), NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0),
                      NVL(A.VALUE_STOCK, 0), NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.VALUE_NOT_SALE_PERMIT, 0), NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PERIOD_ID;
            /*
            ------------------------------------------
            更新分期SY动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --ZZ动态货量
                     A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --ZZ动态货量
                      NVL(A.SY_AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_HAVED_SALE, 0),
                      NVL(A.SY_AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_IN_PROCESS, 0), NVL(A.SY_AREA_ALLOW_SALE, 0), NVL(A.SY_AREA_STOCK, 0),
                      NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0), NVL(A.SY_AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.SY_AREA_NOT_COMPLETION, 0), NVL(A.SY_AREA_YES_COMPLETION, 0), NVL(A.SY_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_HAVED_SALE, 0),
                      NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0), NVL(A.AREA_STOCK, 0),
                      NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.AREA_NOT_SALE_PERMIT, 0), NVL(A.AREA_NOT_COMPLETION, 0),
                      NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PERIOD_ID;
            /*
            ------------------------------------------
            更新项目SY动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --ZZ动态货值
                     A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --ZZ动态货值
                      NVL(A.SY_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.SY_VALUE_HAVED_SALE, 0), NVL(A.SY_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_IN_PROCESS, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0),
                      NVL(A.SY_VALUE_STOCK, 0), NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0), NVL(A.SY_VALUE_NOT_COMPLETION, 0), NVL(A.SY_VALUE_YES_COMPLETION, 0), NVL(A.SY_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.VALUE_HAVED_SALE, 0), NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0),
                      NVL(A.VALUE_STOCK, 0), NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.VALUE_NOT_SALE_PERMIT, 0), NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PROJECT_ID;
            /*
            ------------------------------------------
            更新项目ZZ动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --ZZ动态货量
                     A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --ZZ动态货量
                      NVL(A.SY_AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_HAVED_SALE, 0),
                      NVL(A.SY_AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_IN_PROCESS, 0), NVL(A.SY_AREA_ALLOW_SALE, 0), NVL(A.SY_AREA_STOCK, 0),
                      NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0), NVL(A.SY_AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.SY_AREA_NOT_COMPLETION, 0), NVL(A.SY_AREA_YES_COMPLETION, 0), NVL(A.SY_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_HAVED_SALE, 0),
                      NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0), NVL(A.AREA_STOCK, 0),
                      NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.AREA_NOT_SALE_PERMIT, 0), NVL(A.AREA_NOT_COMPLETION, 0),
                      NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PROJECT_ID;

        ELSIF V_PRODUCT_TYPE = '车位仓储' AND V_IS_CARPORT = 1 THEN

            /*
            ------------------------------------------
            更新分期CW动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --CW动态货值
                     A.CW_VALUE_DT_ALL, A.CW_VALUE_REMAIN, A.CW_VALUE_HAVED_SALE, A.CW_VALUE_RESERVE, A.CW_VALUE_IN_PROCESS, A.CW_VALUE_ALLOW_SALE, A.CW_VALUE_STOCK, A.CW_VALUE_NOT_PLANNING_PERMIT, A.CW_VALUE_NOT_CONSTRUCTION_PER, A.CW_VALUE_NOT_SALE_PERMIT, A.CW_VALUE_NOT_COMPLETION, A.CW_VALUE_YES_COMPLETION, A.CW_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --CW动态货值
                      NVL(A.CW_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                      NVL(A.CW_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_VALUE_HAVED_SALE, 0),
                      NVL(A.CW_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_VALUE_IN_PROCESS, 0), NVL(A.CW_VALUE_ALLOW_SALE, 0),
                      NVL(A.CW_VALUE_STOCK, 0), NVL(A.CW_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.CW_VALUE_NOT_SALE_PERMIT, 0), NVL(A.CW_VALUE_NOT_COMPLETION, 0), NVL(A.CW_VALUE_YES_COMPLETION, 0), NVL(A.CW_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                      NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.VALUE_HAVED_SALE, 0),
                      NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0), NVL(A.VALUE_STOCK, 0),
                      NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.VALUE_NOT_SALE_PERMIT, 0),
                      NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PERIOD_ID;
            /*
            ------------------------------------------
            更新分期CW动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --CW动态货量
                     A.CW_AREA_DT_ALL, A.CW_AREA_REMAIN, A.CW_AREA_HAVED_SALE, A.CW_AREA_RESERVE, A.CW_AREA_IN_PROCESS, A.CW_AREA_ALLOW_SALE, A.CW_AREA_STOCK, A.CW_AREA_NOT_PLANNING_PERMIT, A.CW_AREA_NOT_CONSTRUCTION_PER, A.CW_AREA_NOT_SALE_PERMIT, A.CW_AREA_NOT_COMPLETION, A.CW_AREA_YES_COMPLETION, A.CW_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --CW动态货量
                      NVL(A.CW_AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                      NVL(A.CW_AREA_HAVED_SALE, 0), NVL(A.CW_AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_IN_PROCESS, 0), NVL(A.CW_AREA_ALLOW_SALE, 0),
                      NVL(A.CW_AREA_STOCK, 0), NVL(A.CW_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.CW_AREA_NOT_SALE_PERMIT, 0), NVL(A.CW_AREA_NOT_COMPLETION, 0), NVL(A.CW_AREA_YES_COMPLETION, 0), NVL(A.CW_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                      NVL(A.AREA_HAVED_SALE, 0), NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0),
                      NVL(A.AREA_STOCK, 0), NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.AREA_NOT_SALE_PERMIT, 0), NVL(A.AREA_NOT_COMPLETION, 0), NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PERIOD_ID;
            /*
            ------------------------------------------
            更新项目CW动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --CW动态货值
                     A.CW_VALUE_DT_ALL, A.CW_VALUE_REMAIN, A.CW_VALUE_HAVED_SALE, A.CW_VALUE_RESERVE, A.CW_VALUE_IN_PROCESS, A.CW_VALUE_ALLOW_SALE, A.CW_VALUE_STOCK, A.CW_VALUE_NOT_PLANNING_PERMIT, A.CW_VALUE_NOT_CONSTRUCTION_PER, A.CW_VALUE_NOT_SALE_PERMIT, A.CW_VALUE_NOT_COMPLETION, A.CW_VALUE_YES_COMPLETION, A.CW_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --CW动态货值
                      NVL(A.CW_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                      NVL(A.CW_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_VALUE_HAVED_SALE, 0),
                      NVL(A.CW_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_VALUE_IN_PROCESS, 0), NVL(A.CW_VALUE_ALLOW_SALE, 0),
                      NVL(A.CW_VALUE_STOCK, 0), NVL(A.CW_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.CW_VALUE_NOT_SALE_PERMIT, 0), NVL(A.CW_VALUE_NOT_COMPLETION, 0), NVL(A.CW_VALUE_YES_COMPLETION, 0), NVL(A.CW_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                      NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.VALUE_HAVED_SALE, 0),
                      NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0), NVL(A.VALUE_STOCK, 0),
                      NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.VALUE_NOT_SALE_PERMIT, 0),
                      NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PROJECT_ID;
            /*
            ------------------------------------------
            更新项目CW动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --CW动态货量
                     A.CW_AREA_DT_ALL, A.CW_AREA_REMAIN, A.CW_AREA_HAVED_SALE, A.CW_AREA_RESERVE, A.CW_AREA_IN_PROCESS, A.CW_AREA_ALLOW_SALE, A.CW_AREA_STOCK, A.CW_AREA_NOT_PLANNING_PERMIT, A.CW_AREA_NOT_CONSTRUCTION_PER, A.CW_AREA_NOT_SALE_PERMIT, A.CW_AREA_NOT_COMPLETION, A.CW_AREA_YES_COMPLETION, A.CW_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --CW动态货量
                      NVL(A.CW_AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                      NVL(A.CW_AREA_HAVED_SALE, 0), NVL(A.CW_AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_IN_PROCESS, 0), NVL(A.CW_AREA_ALLOW_SALE, 0),
                      NVL(A.CW_AREA_STOCK, 0), NVL(A.CW_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.CW_AREA_NOT_SALE_PERMIT, 0), NVL(A.CW_AREA_NOT_COMPLETION, 0), NVL(A.CW_AREA_YES_COMPLETION, 0), NVL(A.CW_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                      NVL(A.AREA_HAVED_SALE, 0), NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0),
                      NVL(A.AREA_STOCK, 0), NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.AREA_NOT_SALE_PERMIT, 0), NVL(A.AREA_NOT_COMPLETION, 0), NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PROJECT_ID;

        ELSIF V_PRODUCT_TYPE = '车位仓储' AND V_IS_CARPORT = 0 THEN

            /*
            ------------------------------------------
            更新分期SY动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货值
                     A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货值
                      NVL(A.SY_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.SY_VALUE_HAVED_SALE, 0), NVL(A.SY_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_IN_PROCESS, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0),
                      NVL(A.SY_VALUE_STOCK, 0), NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0), NVL(A.SY_VALUE_NOT_COMPLETION, 0), NVL(A.SY_VALUE_YES_COMPLETION, 0), NVL(A.SY_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.VALUE_HAVED_SALE, 0), NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0),
                      NVL(A.VALUE_STOCK, 0), NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.VALUE_NOT_SALE_PERMIT, 0), NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PERIOD_ID;
            /*
            ------------------------------------------
            更新分期SY动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货量
                     A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货量
                      NVL(A.SY_AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_HAVED_SALE, 0),
                      NVL(A.SY_AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_IN_PROCESS, 0), NVL(A.SY_AREA_ALLOW_SALE, 0), NVL(A.SY_AREA_STOCK, 0),
                      NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0), NVL(A.SY_AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.SY_AREA_NOT_COMPLETION, 0), NVL(A.SY_AREA_YES_COMPLETION, 0), NVL(A.SY_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_HAVED_SALE, 0),
                      NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0), NVL(A.AREA_STOCK, 0),
                      NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.AREA_NOT_SALE_PERMIT, 0), NVL(A.AREA_NOT_COMPLETION, 0),
                      NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PERIOD_ID;
            /*
            ------------------------------------------
            更新项目SY动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货值
                     A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货值
                      NVL(A.SY_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.SY_VALUE_HAVED_SALE, 0), NVL(A.SY_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_IN_PROCESS, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0),
                      NVL(A.SY_VALUE_STOCK, 0), NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0), NVL(A.SY_VALUE_NOT_COMPLETION, 0), NVL(A.SY_VALUE_YES_COMPLETION, 0), NVL(A.SY_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.VALUE_HAVED_SALE, 0), NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0),
                      NVL(A.VALUE_STOCK, 0), NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.VALUE_NOT_SALE_PERMIT, 0), NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PROJECT_ID;
            /*
            ------------------------------------------
            更新项目SY动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货量
                     A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货量
                      NVL(A.SY_AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_HAVED_SALE, 0),
                      NVL(A.SY_AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_IN_PROCESS, 0), NVL(A.SY_AREA_ALLOW_SALE, 0), NVL(A.SY_AREA_STOCK, 0),
                      NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0), NVL(A.SY_AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.SY_AREA_NOT_COMPLETION, 0), NVL(A.SY_AREA_YES_COMPLETION, 0), NVL(A.SY_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_HAVED_SALE, 0),
                      NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0), NVL(A.AREA_STOCK, 0),
                      NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.AREA_NOT_SALE_PERMIT, 0), NVL(A.AREA_NOT_COMPLETION, 0),
                      NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PROJECT_ID;
        ELSIF V_PRODUCT_TYPE = '配套设施' THEN

            /*
            ------------------------------------------
            更新分期SY动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货值
                     A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货值
                      NVL(A.SY_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.SY_VALUE_HAVED_SALE, 0), NVL(A.SY_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_IN_PROCESS, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0),
                      NVL(A.SY_VALUE_STOCK, 0), NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0), NVL(A.SY_VALUE_NOT_COMPLETION, 0), NVL(A.SY_VALUE_YES_COMPLETION, 0), NVL(A.SY_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.VALUE_HAVED_SALE, 0), NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0),
                      NVL(A.VALUE_STOCK, 0), NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.VALUE_NOT_SALE_PERMIT, 0), NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PERIOD_ID;
            /*
            ------------------------------------------
            更新分期SY动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货量
                     A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货量
                      NVL(A.SY_AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_HAVED_SALE, 0),
                      NVL(A.SY_AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_IN_PROCESS, 0), NVL(A.SY_AREA_ALLOW_SALE, 0), NVL(A.SY_AREA_STOCK, 0),
                      NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0), NVL(A.SY_AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.SY_AREA_NOT_COMPLETION, 0), NVL(A.SY_AREA_YES_COMPLETION, 0), NVL(A.SY_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_HAVED_SALE, 0),
                      NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0), NVL(A.AREA_STOCK, 0),
                      NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.AREA_NOT_SALE_PERMIT, 0), NVL(A.AREA_NOT_COMPLETION, 0),
                      NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PERIOD_ID;
            /*
            ------------------------------------------
            更新项目SY动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货值
                     A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货值
                      NVL(A.SY_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.SY_VALUE_HAVED_SALE, 0), NVL(A.SY_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_IN_PROCESS, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0),
                      NVL(A.SY_VALUE_STOCK, 0), NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0), NVL(A.SY_VALUE_NOT_COMPLETION, 0), NVL(A.SY_VALUE_YES_COMPLETION, 0), NVL(A.SY_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.VALUE_HAVED_SALE, 0), NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0),
                      NVL(A.VALUE_STOCK, 0), NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.VALUE_NOT_SALE_PERMIT, 0), NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PROJECT_ID;
            /*
            ------------------------------------------
            更新项目SY动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货量
                     A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货量
                      NVL(A.SY_AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_HAVED_SALE, 0),
                      NVL(A.SY_AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_IN_PROCESS, 0), NVL(A.SY_AREA_ALLOW_SALE, 0), NVL(A.SY_AREA_STOCK, 0),
                      NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0), NVL(A.SY_AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.SY_AREA_NOT_COMPLETION, 0), NVL(A.SY_AREA_YES_COMPLETION, 0), NVL(A.SY_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_HAVED_SALE, 0),
                      NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0), NVL(A.AREA_STOCK, 0),
                      NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PERIOD_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.AREA_NOT_SALE_PERMIT, 0), NVL(A.AREA_NOT_COMPLETION, 0),
                      NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PERIOD_LIST.PROJECT_ID;
        ELSE
            NULL;
        END IF;

    END LOOP;
    CLOSE CUR_PERIOD_LIST;

    /*
    ----------------------------------------------------------------
        更新当前在可研阶段项目的动态货值、动态货量,动态货值计算公式：当前阶段业态的面积*业态最新均价
    ----------------------------------------------------------------
    */

    OPEN CUR_PROJECT_LIST;

    LOOP
      FETCH CUR_PROJECT_LIST
            INTO ITEM_PROJECT_LIST;
        EXIT WHEN CUR_PROJECT_LIST%NOTFOUND;
        --获取一级业态
        V_PRODUCT_TYPE := SUBSTR(ITEM_PROJECT_LIST.PRODUCT_TYPE_NAME, 0, INSTR(ITEM_PROJECT_LIST.PRODUCT_TYPE_NAME, '/', 1) - 1);
        V_IS_CARPORT := CASE
                            WHEN ITEM_PROJECT_LIST.PRODUCT_TYPE_JSON = '{"isCarport":1}' THEN
                             1
                            ELSE
                             0
                        END;
        --获取当前业态均价
        SELECT A.TARGET_A_ID INTO V_TARGET_WORTH_ID FROM DWM_DT_VALUE A WHERE A.OBJ_ID = ITEM_PROJECT_LIST.PROJECT_ID AND A.OBJ_TYPE = '项目';

        SELECT COUNT(1)
        INTO   V_COUNT
        FROM   DWM_TARGET_WORTH_DTL A
        WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_ID = ITEM_PROJECT_LIST.PRODUCT_TYPE_ID AND A.OBJ_PARENT_ID = ITEM_PROJECT_LIST.PROJECT_ID;

        IF V_COUNT = 1 THEN
            SELECT A.AVERAGE_PRICE
            INTO   V_PRICE
            FROM   DWM_TARGET_WORTH_DTL A
            WHERE  A.TARGET_WORTH_ID = V_TARGET_WORTH_ID AND A.OBJ_ID = ITEM_PROJECT_LIST.PRODUCT_TYPE_ID AND A.OBJ_PARENT_ID = ITEM_PROJECT_LIST.PROJECT_ID;
        ELSE
            V_PRICE := 0;
        END IF;

        IF V_PRODUCT_TYPE = '住宅' THEN

            /*
            ------------------------------------------
            更新项目ZZ动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --ZZ动态货值
                     A.ZZ_VALUE_DT_ALL, A.ZZ_VALUE_REMAIN, A.ZZ_VALUE_HAVED_SALE, A.ZZ_VALUE_RESERVE, A.ZZ_VALUE_IN_PROCESS, A.ZZ_VALUE_ALLOW_SALE, A.ZZ_VALUE_STOCK, A.ZZ_VALUE_NOT_PLANNING_PERMIT, A.ZZ_VALUE_NOT_CONSTRUCTION_PER, A.ZZ_VALUE_NOT_SALE_PERMIT, A.ZZ_VALUE_NOT_COMPLETION, A.ZZ_VALUE_YES_COMPLETION, A.ZZ_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --ZZ动态货值
                      NVL(A.ZZ_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.ZZ_VALUE_HAVED_SALE, 0), NVL(A.ZZ_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_VALUE_IN_PROCESS, 0), NVL(A.ZZ_VALUE_ALLOW_SALE, 0),
                      NVL(A.ZZ_VALUE_STOCK, 0), NVL(A.ZZ_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.ZZ_VALUE_NOT_SALE_PERMIT, 0), NVL(A.ZZ_VALUE_NOT_COMPLETION, 0), NVL(A.ZZ_VALUE_YES_SETTLEMENT, 0), NVL(A.ZZ_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.VALUE_HAVED_SALE, 0), NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0),
                      NVL(A.VALUE_STOCK, 0), NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.VALUE_NOT_SALE_PERMIT, 0), NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PROJECT_LIST.PROJECT_ID;
            /*
            ------------------------------------------
            更新项目ZZ动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --ZZ动态货量
                     A.ZZ_AREA_DT_ALL, A.ZZ_AREA_REMAIN, A.ZZ_AREA_HAVED_SALE, A.ZZ_AREA_RESERVE, A.ZZ_AREA_IN_PROCESS, A.ZZ_AREA_ALLOW_SALE, A.ZZ_AREA_STOCK, A.ZZ_AREA_NOT_PLANNING_PERMIT, A.ZZ_AREA_NOT_CONSTRUCTION_PER, A.ZZ_AREA_NOT_SALE_PERMIT, A.ZZ_AREA_NOT_COMPLETION, A.ZZ_AREA_YES_COMPLETION, A.ZZ_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --ZZ动态货量
                      NVL(A.ZZ_AREA_DT_ALL, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_AREA_REMAIN, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_AREA_HAVED_SALE, 0),
                      NVL(A.ZZ_AREA_RESERVE, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_AREA_IN_PROCESS, 0), NVL(A.ZZ_AREA_ALLOW_SALE, 0), NVL(A.ZZ_AREA_STOCK, 0),
                      NVL(A.ZZ_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.ZZ_AREA_NOT_CONSTRUCTION_PER, 0), NVL(A.ZZ_AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.ZZ_AREA_NOT_COMPLETION, 0), NVL(A.ZZ_AREA_YES_COMPLETION, 0), NVL(A.ZZ_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_HAVED_SALE, 0),
                      NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0), NVL(A.AREA_STOCK, 0),
                      NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.AREA_NOT_COMPLETION, 0), NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PROJECT_LIST.PROJECT_ID;
        ELSIF V_PRODUCT_TYPE = '商办产业' THEN
            /*
            ------------------------------------------
            更新项目SY动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货值
                     A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货值
                      NVL(A.SY_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.SY_VALUE_HAVED_SALE, 0), NVL(A.SY_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_IN_PROCESS, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0),
                      NVL(A.SY_VALUE_STOCK, 0), NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0), NVL(A.SY_VALUE_NOT_COMPLETION, 0), NVL(A.SY_VALUE_YES_COMPLETION, 0), NVL(A.SY_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.VALUE_HAVED_SALE, 0), NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0),
                      NVL(A.VALUE_STOCK, 0), NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.VALUE_NOT_SALE_PERMIT, 0), NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PROJECT_LIST.PROJECT_ID;
            /*
            ------------------------------------------
            更新项目SY动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货量
                     A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货量
                      NVL(A.SY_AREA_DT_ALL, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_REMAIN, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_HAVED_SALE, 0),
                      NVL(A.SY_AREA_RESERVE, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_IN_PROCESS, 0), NVL(A.SY_AREA_ALLOW_SALE, 0), NVL(A.SY_AREA_STOCK, 0),
                      NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0), NVL(A.SY_AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.SY_AREA_NOT_COMPLETION, 0), NVL(A.SY_AREA_YES_COMPLETION, 0), NVL(A.SY_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_HAVED_SALE, 0),
                      NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0), NVL(A.AREA_STOCK, 0),
                      NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.AREA_NOT_COMPLETION, 0), NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PROJECT_LIST.PROJECT_ID;
        ELSIF V_PRODUCT_TYPE = '车位仓储' AND V_IS_CARPORT = 1 THEN
            /*
            ------------------------------------------
            更新项目CW动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --CW动态货值
                     A.CW_VALUE_DT_ALL, A.CW_VALUE_REMAIN, A.CW_VALUE_HAVED_SALE, A.CW_VALUE_RESERVE, A.CW_VALUE_IN_PROCESS, A.CW_VALUE_ALLOW_SALE, A.CW_VALUE_STOCK, A.CW_VALUE_NOT_PLANNING_PERMIT, A.CW_VALUE_NOT_CONSTRUCTION_PER, A.CW_VALUE_NOT_SALE_PERMIT, A.CW_VALUE_NOT_COMPLETION, A.CW_VALUE_YES_COMPLETION, A.CW_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --CW动态货值
                      NVL(A.CW_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                      NVL(A.CW_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_VALUE_HAVED_SALE, 0),
                      NVL(A.CW_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_VALUE_IN_PROCESS, 0), NVL(A.CW_VALUE_ALLOW_SALE, 0),
                      NVL(A.CW_VALUE_STOCK, 0), NVL(A.CW_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.CW_VALUE_NOT_SALE_PERMIT, 0), NVL(A.CW_VALUE_NOT_COMPLETION, 0), NVL(A.CW_VALUE_YES_COMPLETION, 0), NVL(A.CW_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                      NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.VALUE_HAVED_SALE, 0),
                      NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0), NVL(A.VALUE_STOCK, 0),
                      NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.VALUE_NOT_SALE_PERMIT, 0),
                      NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PROJECT_LIST.PROJECT_ID;
            /*
            ------------------------------------------
            更新项目CW动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --CW动态货量
                     A.CW_AREA_DT_ALL, A.CW_AREA_REMAIN, A.CW_AREA_HAVED_SALE, A.CW_AREA_RESERVE, A.CW_AREA_IN_PROCESS, A.CW_AREA_ALLOW_SALE, A.CW_AREA_STOCK, A.CW_AREA_NOT_PLANNING_PERMIT, A.CW_AREA_NOT_CONSTRUCTION_PER, A.CW_AREA_NOT_SALE_PERMIT, A.CW_AREA_NOT_COMPLETION, A.CW_AREA_YES_COMPLETION, A.CW_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --CW动态货量
                      NVL(A.CW_AREA_DT_ALL, 0) + NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_REMAIN, 0) + NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                      NVL(A.CW_AREA_HAVED_SALE, 0), NVL(A.CW_AREA_RESERVE, 0) + NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_IN_PROCESS, 0), NVL(A.CW_AREA_ALLOW_SALE, 0),
                      NVL(A.CW_AREA_STOCK, 0), NVL(A.CW_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.CW_AREA_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.CW_AREA_NOT_SALE_PERMIT, 0), NVL(A.CW_AREA_NOT_COMPLETION, 0), NVL(A.CW_AREA_YES_COMPLETION, 0), NVL(A.CW_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0),
                      NVL(A.AREA_HAVED_SALE, 0), NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0),
                      NVL(A.AREA_STOCK, 0), NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PROJECT_LIST.UNDERGROUND_TOTAL_SALE_CARPORT, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.AREA_NOT_SALE_PERMIT, 0), NVL(A.AREA_NOT_COMPLETION, 0), NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PROJECT_LIST.PROJECT_ID;
        ELSIF V_PRODUCT_TYPE = '车位仓储' AND V_IS_CARPORT = 0 THEN
            /*
            ------------------------------------------
            更新项目SY动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货值
                     A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货值
                      NVL(A.SY_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.SY_VALUE_HAVED_SALE, 0), NVL(A.SY_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_IN_PROCESS, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0),
                      NVL(A.SY_VALUE_STOCK, 0), NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0), NVL(A.SY_VALUE_NOT_COMPLETION, 0), NVL(A.SY_VALUE_YES_COMPLETION, 0), NVL(A.SY_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.VALUE_HAVED_SALE, 0), NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0),
                      NVL(A.VALUE_STOCK, 0), NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.VALUE_NOT_SALE_PERMIT, 0), NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PROJECT_LIST.PROJECT_ID;
            /*
            ------------------------------------------
            更新项目SY动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货量
                     A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货量
                      NVL(A.SY_AREA_DT_ALL, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_REMAIN, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_HAVED_SALE, 0),
                      NVL(A.SY_AREA_RESERVE, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_IN_PROCESS, 0), NVL(A.SY_AREA_ALLOW_SALE, 0), NVL(A.SY_AREA_STOCK, 0),
                      NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0), NVL(A.SY_AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.SY_AREA_NOT_COMPLETION, 0), NVL(A.SY_AREA_YES_COMPLETION, 0), NVL(A.SY_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_HAVED_SALE, 0),
                      NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0), NVL(A.AREA_STOCK, 0),
                      NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.AREA_NOT_COMPLETION, 0), NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PROJECT_LIST.PROJECT_ID;
        ELSIF V_PRODUCT_TYPE = '配套设施' THEN
            /*
            ------------------------------------------
            更新项目SY动态货值
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货值
                     A.SY_VALUE_DT_ALL, A.SY_VALUE_REMAIN, A.SY_VALUE_HAVED_SALE, A.SY_VALUE_RESERVE, A.SY_VALUE_IN_PROCESS, A.SY_VALUE_ALLOW_SALE, A.SY_VALUE_STOCK, A.SY_VALUE_NOT_PLANNING_PERMIT, A.SY_VALUE_NOT_CONSTRUCTION_PER, A.SY_VALUE_NOT_SALE_PERMIT, A.SY_VALUE_NOT_COMPLETION, A.SY_VALUE_YES_COMPLETION, A.SY_VALUE_YES_SETTLEMENT
                     --ALL动态货值
                    , A.VALUE_DT_ALL, A.VALUE_REMAIN, A.VALUE_HAVED_SALE, A.VALUE_RESERVE, A.VALUE_IN_PROCESS, A.VALUE_ALLOW_SALE, A.VALUE_STOCK, A.VALUE_NOT_PLANNING_PERMIT, A.VALUE_NOT_CONSTRUCTION_PERMIT, A.VALUE_NOT_SALE_PERMIT, A.VALUE_NOT_COMPLETION, A.VALUE_YES_COMPLETION, A.VALUE_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货值
                      NVL(A.SY_VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.SY_VALUE_HAVED_SALE, 0), NVL(A.SY_VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_IN_PROCESS, 0), NVL(A.SY_VALUE_ALLOW_SALE, 0),
                      NVL(A.SY_VALUE_STOCK, 0), NVL(A.SY_VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_VALUE_NOT_CONSTRUCTION_PER, 0),
                      NVL(A.SY_VALUE_NOT_SALE_PERMIT, 0), NVL(A.SY_VALUE_NOT_COMPLETION, 0), NVL(A.SY_VALUE_YES_COMPLETION, 0), NVL(A.SY_VALUE_YES_SETTLEMENT, 0)
                      --ALL动态货值
                     , NVL(A.VALUE_DT_ALL, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_REMAIN, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0),
                      NVL(A.VALUE_HAVED_SALE, 0), NVL(A.VALUE_RESERVE, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_IN_PROCESS, 0), NVL(A.VALUE_ALLOW_SALE, 0),
                      NVL(A.VALUE_STOCK, 0), NVL(A.VALUE_NOT_PLANNING_PERMIT, 0) + V_PRICE * NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT, 0),
                      NVL(A.VALUE_NOT_SALE_PERMIT, 0), NVL(A.VALUE_NOT_COMPLETION, 0), NVL(A.VALUE_YES_COMPLETION, 0), NVL(A.VALUE_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PROJECT_LIST.PROJECT_ID;
            /*
            ------------------------------------------
            更新项目SY动态货量
            ------------------------------------------
            */
            UPDATE DWM_DT_VALUE A
            SET    (
                     --SY动态货量
                     A.SY_AREA_DT_ALL, A.SY_AREA_REMAIN, A.SY_AREA_HAVED_SALE, A.SY_AREA_RESERVE, A.SY_AREA_IN_PROCESS, A.SY_AREA_ALLOW_SALE, A.SY_AREA_STOCK, A.SY_AREA_NOT_PLANNING_PERMIT, A.SY_AREA_NOT_CONSTRUCTION_PER, A.SY_AREA_NOT_SALE_PERMIT, A.SY_AREA_NOT_COMPLETION, A.SY_AREA_YES_COMPLETION, A.SY_AREA_YES_SETTLEMENT
                     --ALL动态货量
                    , A.AREA_DT_ALL, A.AREA_REMAIN, A.AREA_HAVED_SALE, A.AREA_RESERVE, A.AREA_IN_PROCESS, A.AREA_ALLOW_SALE, A.AREA_STOCK, A.AREA_NOT_PLANNING_PERMIT, A.AREA_NOT_CONSTRUCTION_PERMIT, A.AREA_NOT_SALE_PERMIT, A.AREA_NOT_COMPLETION, A.AREA_YES_COMPLETION, A.AREA_YES_SETTLEMENT) =
                    (SELECT
                     --SY动态货量
                      NVL(A.SY_AREA_DT_ALL, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_REMAIN, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_HAVED_SALE, 0),
                      NVL(A.SY_AREA_RESERVE, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_IN_PROCESS, 0), NVL(A.SY_AREA_ALLOW_SALE, 0), NVL(A.SY_AREA_STOCK, 0),
                      NVL(A.SY_AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.SY_AREA_NOT_CONSTRUCTION_PER, 0), NVL(A.SY_AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.SY_AREA_NOT_COMPLETION, 0), NVL(A.SY_AREA_YES_COMPLETION, 0), NVL(A.SY_AREA_YES_SETTLEMENT, 0)
                      --ALL动态货量
                     , NVL(A.AREA_DT_ALL, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_REMAIN, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_HAVED_SALE, 0),
                      NVL(A.AREA_RESERVE, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_IN_PROCESS, 0), NVL(A.AREA_ALLOW_SALE, 0), NVL(A.AREA_STOCK, 0),
                      NVL(A.AREA_NOT_PLANNING_PERMIT, 0) + NVL(ITEM_PROJECT_LIST.TOTAL_SALE_AREA, 0), NVL(A.AREA_NOT_CONSTRUCTION_PERMIT, 0), NVL(A.AREA_NOT_SALE_PERMIT, 0),
                      NVL(A.AREA_NOT_COMPLETION, 0), NVL(A.AREA_YES_COMPLETION, 0), NVL(A.AREA_YES_SETTLEMENT, 0)
                     FROM   DUAL)
            WHERE  A.OBJ_ID = ITEM_PROJECT_LIST.PROJECT_ID;
        ELSE
            NULL;
        END IF;

    END LOOP;
    CLOSE CUR_PROJECT_LIST;

    COMMIT;


/*
异常处理部分
*/
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        DBMS_OUTPUT.PUT_LINE('【目标货值取数异常】' || ITEM_BLD_LIST.ID || '事务已回退');
        ROLLBACK;
    WHEN TOO_MANY_ROWS THEN
        DBMS_OUTPUT.PUT_LINE('【返回多行数据】' || ITEM_BLD_LIST.ID || '事务已回退');
        ROLLBACK;
END;
/

prompt
prompt Creating procedure P_DWM_GET_OBJ_INFO
prompt =====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_GET_OBJ_INFO AS
/*  CURSOR CUR_BLD_LIST IS
    SELECT B.*
    FROM MDM_PROJECT A
    INNER JOIN MDM_BUILD B
    ON A.ID = B.PROJ_ID
    WHERE A.CITY_NAME IN ('天津市', '长春市', '杭州市', '贵阳市');
  ITEM_BLD_LIST CUR_BLD_LIST%ROWTYPE;*/
BEGIN
  /*
  ------------------------------------------------------------
  DWM_DT_VALUE数据生成
  */

  INSERT INTO DWM_DT_VALUE
    (ID, OBJ_ID, OBJ_NAME, OBJ_TYPE, OBJ_IS_PARKING, OBJ_IS_SALE,
     OBJ_IS_HOLD, OBJ_LEVEL, PARENT_ID, PROJ_ID)
    SELECT GET_UUID, A.ID, A.BUILD_NAME, '楼栋', NULL, NULL, NULL, 3,
           A.PERIOD_ID, A.PROJ_ID
    FROM MDM_BUILD A
    WHERE NOT EXISTS (SELECT 1
           FROM DWM_DT_VALUE P
           WHERE A.ID = P.OBJ_ID AND P.OBJ_TYPE = '楼栋') AND
          A.BUILD_STATE = 10;
  COMMIT;

  INSERT INTO DWM_DT_VALUE
    (ID, OBJ_ID, OBJ_NAME, OBJ_TYPE, OBJ_LEVEL, PARENT_ID, PROJ_ID)
    SELECT GET_UUID, A.ID, A.PROJECT_NAME, '项目', 1, NULL, A.ID
    FROM MDM_PROJECT A
    WHERE NOT EXISTS (SELECT 1
           FROM DWM_DT_VALUE P
           WHERE A.ID = P.OBJ_ID AND P.OBJ_TYPE = '项目') AND
          A.APPROVAL_STATUS = '已审核' AND
          A.PROJECT_VERSION =
          (SELECT MAX(PROJECT_VERSION)
           FROM MDM_PROJECT O
           WHERE O.PROJECT_ORIGINAL_ID = A.PROJECT_ORIGINAL_ID AND
                 O.APPROVAL_STATUS = '已审核');
  COMMIT;

  INSERT INTO DWM_DT_VALUE
    (ID, OBJ_ID, OBJ_NAME, OBJ_TYPE, OBJ_LEVEL, PARENT_ID, PROJ_ID)
    SELECT GET_UUID, C.ID, C.PERIOD_NAME, '分期', 2, A.ID, A.ID
    FROM MDM_PROJECT A
    INNER JOIN MDM_PERIOD_VERSION B
    ON A.ID = B.PROJECT_ID AND
       B.PERIOD_VERSION =
       (SELECT MAX(P.PERIOD_VERSION)
        FROM MDM_PERIOD_VERSION P
        WHERE B.PROJECT_ID = P.PROJECT_ID AND P.APPROVAL_STATUS = '已审核')
    INNER JOIN MDM_PERIOD C
    ON B.ID = C.PERIOD_VERSION_ID
    WHERE NOT EXISTS (SELECT 1 FROM DWM_DT_VALUE O WHERE O.OBJ_ID = C.ID);

  /*
  ------------------------------------------------------------
  MDM_ROOM表数据生成
  */

  UPDATE MDM_ROOM_BAK A
  SET A.BUILDING_ID = REPLACE(A.BUILDING_ID, ' ', '');
  COMMIT;

  --删除本次需要更新的房源
  DELETE FROM MDM_ROOM A
  WHERE EXISTS (SELECT 1 FROM MDM_ROOM_BAK P WHERE P.ID = A.ID);
  --插入本次新同步的房源数据
  INSERT INTO MDM_ROOM
    (ID, ROOM_NAME, ROOM_CODE, PRODUCT_CODE, PRODUCT_NAME, PRODUCT_IS_CW,
     PROJECT_ID, PROJECT_CODE, PROJECT_NAME, BUILDING_ID, BUILDING_NAME,
     UNIT_ID, UNIT_NAME, FLOOR_ID, FLOOR_NAME, SALE_STATE, PRE_BLD_AREA,
     PRE_IN_AREA, ACTUAL_BLD_AREA, ACTUAL_IN_AREA, NEW_BLD_AREA, NEW_IN_AREA,
     PRE_SELL_PERMIT_ID, PRE_SELL_PERMIT_NO, PRE_SELL_PERMIT_DATE,
     BASE_PRICE, BASE_TOTAL, BASE_TOTAL_AREA_TYPE, BZ_PRICE, BZ_TOTAL,
     BZ_TOTAL_AREA_TYPE, TRADE_PRICE, TRADE_TOTAL, TRADE_TOTAL_AREA_TYPE,
     TRADE_CONTRACT_DATE, IS_AREA_BC, PRE_AFTER_BC_TOTAL,
     ACTUAL_AFTER_BC_TOTAL, IS_TRANSFER, PRE_TRANSFER_DATE,
     ACTUAL_TRANSFER_DATE, IS_INDIRECT, ACTUAL_INDIRECT_DATE,
     ACTUAL_INDIRECT_TOTAL, ACTUAL_INDIRECT_AREA)
    SELECT A.ID, A.ROOM_NAME, A.ROOM_CODE, A.PRODUCT_CODE, A.PRODUCT_NAME,
           A.PRODUCT_IS_CW, A.PROJECT_ID, A.PROJECT_CODE, A.PROJECT_NAME,
           B.ID, A.BUILDING_NAME, A.UNIT_ID, A.UNIT_NAME, A.FLOOR_ID,
           A.FLOOR_NAME, A.SALE_STATE, A.PRE_BLD_AREA, A.PRE_IN_AREA,
           A.ACTUAL_BLD_AREA, A.ACTUAL_IN_AREA, A.NEW_BLD_AREA,
           A.NEW_IN_AREA, A.PRE_SELL_PERMIT_ID, A.PRE_SELL_PERMIT_NO,
           A.PRE_SELL_PERMIT_DATE, A.BASE_PRICE, A.BASE_TOTAL,
           A.BASE_TOTAL_AREA_TYPE, A.BZ_PRICE, A.BZ_TOTAL,
           A.BZ_TOTAL_AREA_TYPE, A.TRADE_PRICE, A.TRADE_TOTAL,
           A.TRADE_TOTAL_AREA_TYPE, A.TRADE_CONTRACT_DATE, A.IS_AREA_BC,
           A.PRE_AFTER_BC_TOTAL, A.ACTUAL_AFTER_BC_TOTAL, A.IS_TRANSFER,
           A.PRE_TRANSFER_DATE, A.ACTUAL_TRANSFER_DATE, A.IS_INDIRECT,
           A.ACTUAL_INDIRECT_DATE, A.ACTUAL_INDIRECT_TOTAL,
           A.ACTUAL_INDIRECT_AREA
    /*    SELECT COUNT(1)*/
    FROM MDM_ROOM_BAK A
    INNER JOIN (SELECT ROW_NUMBER() OVER(PARTITION BY LOWER(M.R_BUILD_ID) ORDER BY M.ID) AS NUM,
                       M.ID, M.R_BUILD_ID
                FROM MDM_BUILD M) B
    ON LOWER(A.BUILDING_ID) = LOWER(B.R_BUILD_ID) AND B.NUM = 1
    WHERE NOT EXISTS (SELECT 1 FROM MDM_ROOM P WHERE P.ID = A.ID);

  --更新MDM_ROOM表中业态异常数据

  UPDATE MDM_ROOM A
  SET A.PRODUCT_NAME = '商办'
  WHERE A.PRODUCT_NAME IN ('社区底商', '住宅配套', '仓储.', '公建配套');

  COMMIT;

  --更新现房销售的楼栋
 /* OPEN CUR_BLD_LIST;
  FETCH CUR_BLD_LIST
    INTO ITEM_BLD_LIST;
  LOOP
    EXIT WHEN CUR_BLD_LIST%NOTFOUND;
    UPDATE MDM_BUILD A
    SET A.IS_EXISTING_HOME = 1
    WHERE A.ID = ITEM_BLD_LIST.ID;
  END LOOP;
  COMMIT;*/
END;
/

prompt
prompt Creating procedure P_DWM_GET_OBJ_TARGET_VALUE
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_GET_OBJ_TARGET_VALUE AS
		/*
      CreateBy:Wangck
      CreateDate:20200406
      Note:更新DWM_DT_VALUE表中“项目、分期、楼栋”的目标货值
    */
		CURSOR CUR_OBJ_LIST IS
				SELECT A.* FROM DWM_DT_VALUE A ;

		ITEM_OBJ_LIST CUR_OBJ_LIST%ROWTYPE;

		V_TARGET_ID VARCHAR(50);
		V_OBJ_TYPE  VARCHAR(100);
		V_TARGET_VALUE NUMBER(20,4);
		V_COUNT     NUMBER(10, 0); -- 记数器

BEGIN

		--更新可研版目标货值

		OPEN CUR_OBJ_LIST;
		LOOP
				FETCH CUR_OBJ_LIST
						INTO ITEM_OBJ_LIST;
				EXIT WHEN CUR_OBJ_LIST%NOTFOUND;
		    --DBMS_OUTPUT.PUT_LINE(ITEM_OBJ_LIST.ID);
				IF ITEM_OBJ_LIST.OBJ_TYPE = '项目' THEN
						--处理项目的动态货值相关数据
				
						--可研目标货值ID更新
						UPDATE DWM_DT_VALUE A
						SET    (A.TARGET_A1_ID, A.TARGET_A1_VALUE) =
										(SELECT P.ID, P.TARGET_WORTH FROM DWM_TARGET_WORTH P WHERE P.PROJ_ID = A.OBJ_ID AND P.TARGET_WORTH_PHASE = 0 AND P.IS_DELETE = 0 AND P.APPROVAL_STATUS = '已审核')
						WHERE  A.ID = ITEM_OBJ_LIST.ID;
				
						--全盘目标货值ID更新
						UPDATE DWM_DT_VALUE A
						SET    (A.TARGET_A2_ID, A.TARGET_A2_VALUE) =
										(SELECT P.ID, P.TARGET_WORTH FROM DWM_TARGET_WORTH P WHERE P.PROJ_ID = A.OBJ_ID AND P.TARGET_WORTH_PHASE = 10 AND P.IS_DELETE = 0 AND P.APPROVAL_STATUS = '已审核')
						WHERE  A.ID = ITEM_OBJ_LIST.ID;
				
						--动态版目标货值数据更新
						UPDATE DWM_DT_VALUE A
						SET    (A.TARGET_A3_ID, A.TARGET_A3_VALUE) =
										(SELECT P.ID, P.TARGET_WORTH
										 FROM   DWM_TARGET_WORTH P
										 WHERE  P.PROJ_ID = A.OBJ_ID AND P.TARGET_WORTH_PHASE = 20 AND
														P.WORTH_V = (SELECT MAX(O.WORTH_V) FROM DWM_TARGET_WORTH O WHERE O.PROJ_ID = P.PROJ_ID AND O.TARGET_WORTH_PHASE = 20 AND O.APPROVAL_STATUS = '已审核' AND O.IS_DELETE = 0) AND P.IS_DELETE = 0)
						WHERE  A.ID = ITEM_OBJ_LIST.ID;
				
						
				
						--最新版目标货值更新
						SELECT NVL(A.TARGET_A3_ID, ''),NVL(A.TARGET_A3_VALUE,0) INTO V_TARGET_ID,V_TARGET_VALUE FROM DWM_DT_VALUE A WHERE A.ID = ITEM_OBJ_LIST.ID;
						IF LENGTH(V_TARGET_ID) <> 0 THEN
								UPDATE DWM_DT_VALUE A SET A.TARGET_NOW_NAME = 20, A.TARGET_A_ID = V_TARGET_ID,A.TARGET_A_VALUE =V_TARGET_VALUE  WHERE A.ID = ITEM_OBJ_LIST.ID;
						ELSE
								SELECT NVL(A.TARGET_A2_ID, ''),NVL(A.TARGET_A2_VALUE,0) INTO V_TARGET_ID,V_TARGET_VALUE FROM DWM_DT_VALUE A WHERE A.ID = ITEM_OBJ_LIST.ID;
								IF LENGTH(V_TARGET_ID) <> 0 THEN
										UPDATE DWM_DT_VALUE A SET A.TARGET_NOW_NAME = 10, A.TARGET_A_ID = V_TARGET_ID,A.TARGET_A_VALUE = V_TARGET_VALUE WHERE A.ID = ITEM_OBJ_LIST.ID;
								ELSE
										SELECT NVL(A.TARGET_A1_ID, ''),NVL(A.TARGET_A1_VALUE,0) INTO V_TARGET_ID,V_TARGET_VALUE FROM DWM_DT_VALUE A WHERE A.ID = ITEM_OBJ_LIST.ID;
										IF LENGTH(V_TARGET_ID) <> 0 THEN
												UPDATE DWM_DT_VALUE A SET A.TARGET_NOW_NAME = 0, A.TARGET_A_ID = V_TARGET_ID,A.TARGET_A_VALUE=V_TARGET_VALUE WHERE A.ID = ITEM_OBJ_LIST.ID;
										ELSE
												UPDATE DWM_DT_VALUE A SET A.TARGET_NOW_NAME = NULL, A.TARGET_A_ID = NULL,A.TARGET_A_VALUE = NULL WHERE A.ID = ITEM_OBJ_LIST.ID;
										END IF;
								END IF;
						END IF;
				
				ELSIF ITEM_OBJ_LIST.OBJ_TYPE = '楼栋' THEN
						--处理楼栋的数据
						UPDATE DWM_DT_VALUE A
						SET    (A.TARGET_A_ID, A.TARGET_A1_ID, A.TARGET_A2_ID, TARGET_A3_ID) =
										(SELECT P.TARGET_A_ID, P.TARGET_A1_ID, P.TARGET_A2_ID, P.TARGET_A3_ID FROM DWM_DT_VALUE P WHERE P.OBJ_ID = A.PROJ_ID AND P.OBJ_TYPE = '项目')
						WHERE  A.ID = ITEM_OBJ_LIST.ID;
            
            UPDATE DWM_DT_VALUE A
            SET (A.TARGET_A_VALUE) = 
            (SELECT P.WORTH
            FROM DWM_TARGET_WORTH_DTL P  WHERE P.TARGET_WORTH_ID = A.TARGET_A_ID AND P.OBJ_ID = A.OBJ_ID AND P.OBJ_TYPE = 30)
            WHERE A.ID = ITEM_OBJ_LIST.ID;
            
            UPDATE DWM_DT_VALUE A
            SET (A.TARGET_A1_VALUE) = 
            (SELECT P.WORTH
            FROM DWM_TARGET_WORTH_DTL P  WHERE P.TARGET_WORTH_ID = A.TARGET_A1_ID AND P.OBJ_ID = A.OBJ_ID AND P.OBJ_TYPE = 30)
            WHERE A.ID = ITEM_OBJ_LIST.ID;
            
            UPDATE DWM_DT_VALUE A
            SET (A.TARGET_A2_VALUE) = 
            (SELECT P.WORTH
            FROM DWM_TARGET_WORTH_DTL P  WHERE P.TARGET_WORTH_ID = A.TARGET_A2_ID AND P.OBJ_ID = A.OBJ_ID AND P.OBJ_TYPE = 30)
            WHERE A.ID = ITEM_OBJ_LIST.ID;
            
             UPDATE DWM_DT_VALUE A
            SET (A.TARGET_A3_VALUE) = 
            (SELECT P.WORTH
            FROM DWM_TARGET_WORTH_DTL P  WHERE P.TARGET_WORTH_ID = A.TARGET_A3_ID AND P.OBJ_ID = A.OBJ_ID AND P.OBJ_TYPE = 30)
            WHERE A.ID = ITEM_OBJ_LIST.ID;
            
				
				ELSIF ITEM_OBJ_LIST.OBJ_TYPE = '分期' THEN
						--处理分期的数据
						UPDATE DWM_DT_VALUE A
						SET    (A.TARGET_A_ID, A.TARGET_A1_ID, A.TARGET_A2_ID, TARGET_A3_ID) =
										(SELECT P.TARGET_A_ID, P.TARGET_A1_ID, P.TARGET_A2_ID, P.TARGET_A3_ID FROM DWM_DT_VALUE P WHERE P.OBJ_ID = A.PROJ_ID AND P.OBJ_TYPE = '项目')
						WHERE  A.ID = ITEM_OBJ_LIST.ID;
            
            UPDATE DWM_DT_VALUE A
            SET (A.TARGET_A_VALUE) = 
            (SELECT P.WORTH
            FROM DWM_TARGET_WORTH_DTL P  WHERE P.TARGET_WORTH_ID = A.TARGET_A_ID AND P.OBJ_ID = A.OBJ_ID AND P.OBJ_TYPE = 20)
            WHERE A.ID = ITEM_OBJ_LIST.ID;
            
            UPDATE DWM_DT_VALUE A
            SET (A.TARGET_A1_VALUE) = 
            (SELECT P.WORTH
            FROM DWM_TARGET_WORTH_DTL P  WHERE P.TARGET_WORTH_ID = A.TARGET_A1_ID AND P.OBJ_ID = A.OBJ_ID AND P.OBJ_TYPE = 20)
            WHERE A.ID = ITEM_OBJ_LIST.ID;
            
            UPDATE DWM_DT_VALUE A
            SET (A.TARGET_A2_VALUE) = 
            (SELECT P.WORTH
            FROM DWM_TARGET_WORTH_DTL P  WHERE P.TARGET_WORTH_ID = A.TARGET_A2_ID AND P.OBJ_ID = A.OBJ_ID AND P.OBJ_TYPE = 20)
            WHERE A.ID = ITEM_OBJ_LIST.ID;
            
             UPDATE DWM_DT_VALUE A
            SET (A.TARGET_A3_VALUE) = 
            (SELECT P.WORTH
            FROM DWM_TARGET_WORTH_DTL P  WHERE P.TARGET_WORTH_ID = A.TARGET_A3_ID AND P.OBJ_ID = A.OBJ_ID AND P.OBJ_TYPE = 20)
            WHERE A.ID = ITEM_OBJ_LIST.ID;
            
				END IF;
		
		END LOOP;

		COMMIT;
		CLOSE CUR_OBJ_LIST;
END;
/

prompt
prompt Creating procedure P_DWM_GLOBAL_WORK_AMOUNT
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_dwm_global_work_amount (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
     unitid         IN             VARCHAR2, --选择公司id
    projectid      IN             VARCHAR2,--项目id()
    info           OUT            SYS_REFCURSOR
) AS
--动态货值管理-全案动态货值
--作者：陈丽
--日期：2019/12/17
 P_ID VARCHAR2(36) :='3e7507a3-b76a-48c5-bd81-2820958ed919';
BEGIN
--  P_ID :=projectid;
   SELECT t.ID INTO P_ID  FROM  Mdm_Project t WHERE t.project_Name='佛山领秀公馆（南区）' AND t.is_delete=0;
    OPEN info FOR

SELECT
  b.OBJ_ID AS ID,
  null AS PARENT_ID,
  ''  AS WORK_CODE,
  NVL(b.obj_name,'XX项目') AS WORK_NAME,      -- 项目/分期/业态/楼栋
  to_char(b.AREA_DT_ALL,'999,999,999,999,999.99') AS RECENT_FLOORAGE_AREA,              -- 最新建筑面积
  to_char(b.AREA_DT_ALL,'999,999,999,999,999.99') AS RECENT_SALE_AREA,                  -- 最新可售面积
  to_char(c1.target_worth,'999,999,999,999,999.99') AS FIRST_PHASE,                       -- 可研版(A1)
  to_char(c2.target_worth,'999,999,999,999,999.99')  AS NEXT_PHASE,                        -- 全盘版(A2)
  to_char(c3.target_worth,'999,999,999,999,999.99')  AS ACT_PHASE,                         -- 动态版(A3)
  to_char(c9.target_worth,'999,999,999,999,999.99')  AS RECENT_AREA,                       -- 最新版(A)


  to_char(b.VALUE_DT_ALL/10000,'999,999,999,999,999.99') AS TOTAL_GLOBAL_WORK_VALUE,           -- 动态总货值(B)
  to_char((c9.target_worth-b.VALUE_DT_ALL)/10000,'999,999,999,999,999.99') AS TOTAL_WORK_VALUE_MINUS,            -- 总货值差额(B-A)
  to_char(b.VALUE_RESERVE/10000,'999,999,999,999,999.99') AS STORE_VALUE,                       -- 储备货值(B1)
  to_char(b.VALUE_IN_PROCESS/10000,'999,999,999,999,999.99') AS TRANSIT_VALUE,                     -- 在途货值(B2)
  to_char(b.VALUE_STOCK/10000,'999,999,999,999,999.99') AS REPERTORY_VALUE,                   -- 库存货值(B3)
  to_char(b.VALUE_HAVED_SALE/10000,'999,999,999,999,999.99') AS SALE_VALUE,                        -- 已售货值(B4)
  to_char(b.VALUE_REMAIN/10000,'999,999,999,999,999.99') AS REMAIN_VALUE,                      -- 剩余货值(C=B1+B2+B3)
  to_char(b.VALUE_ALLOW_SALE/10000,'999,999,999,999,999.99') AS HOLD_VALUE,                        -- 已领证货值(D=B3+B4)
  to_char((CASE WHEN b.VALUE_ALLOW_SALE=0 THEN 0 ELSE b.VALUE_HAVED_SALE/b.VALUE_ALLOW_SALE*100 END)
                ,'999,999,999,999,999.99') AS RID_RATE,                          -- 去化率(E=B4/D)

  to_char(b.AREA_DT_ALL/10000,'999,999,999,999,999.99') AS NO_PLAN_PERMIT,                    -- F0未取规证
  to_char(b.AREA_DT_ALL/10000,'999,999,999,999,999.99') AS PLAN_PERMIT_PHASE,                 -- F1规划许可证阶段
  to_char(b.AREA_DT_ALL/10000,'999,999,999,999,999.99') AS CONSTRUCTION_PERMIT_PHASE,         -- F2施工许可证阶段
  to_char(b.AREA_DT_ALL/10000,'999,999,999,999,999.99') AS PRE_SALE_PERMIT_PHASE,             -- F3预售许可证阶段
  to_char(b.AREA_DT_ALL/10000,'999,999,999,999,999.99') AS COMPLETED_PERMIT_PHASE,            -- F4竣工备案阶段
  to_char(b.AREA_DT_ALL/10000,'999,999,999,999,999.99') AS CARRY_FORWARD_PHASE                -- F5结转阶段

FROM   dual a
LEFT JOIN dwm_dt_value b ON 1=1 AND b.obj_type='项目' --AND b.obj_id=P_ID --AND b.is_delete=0
LEFT JOIN dwm_target_worth c1 ON b.obj_id=c1.proj_id AND c1.target_worth_phase=0 AND c1.APPROVAL_STATUS = '已审核'
LEFT JOIN dwm_target_worth c2 ON b.obj_id=c2.proj_id AND c2.target_worth_phase=10 AND c2.APPROVAL_STATUS = '已审核'
LEFT JOIN dwm_target_worth c3 ON b.obj_id=c3.proj_id AND c3.target_worth_phase=20 AND c3.APPROVAL_STATUS = '已审核'
LEFT JOIN dwm_target_worth c9 ON b.obj_id=c9.proj_id AND c9.target_worth_phase=20 AND c9.APPROVAL_STATUS = '已审核'
LEFT JOIN MDM_PROJECT d on b.obj_id=d.id and d.is_delete=0

ORDER BY d.PROJECT_CODE
;

END p_dwm_global_work_amount;
/

prompt
prompt Creating procedure P_DWM_GLOBAL_WORK_VALUE
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_dwm_global_work_value (
  userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    unitid         IN             VARCHAR2, --选择公司id
    projectid      IN             VARCHAR2,--项目id()
    info           OUT            SYS_REFCURSOR) AS
--动态货值管理-全案动态货量
--作者：陈丽
--日期：2019/12/17

/*
SELECT
  '1' AS "编码",
  '1' AS  "分期/业态/楼栋" ,
  '1' AS "最新建筑面积" ,
  '1' AS "最新可售面积" ,
  '1' AS "动态货量" ,
  '1' AS "A1" ,
  '1' AS "A2" ,
  '1' AS "A3" ,
  '1' AS "1_" ,
  '1' AS "2_" ,
  '1' AS "3_" ,
  '1' AS "货量(a)" , A2
  '1' AS "均价(b)" , A2
  '1' AS "货值(c)" , A2
  '1' AS 货量(a) , A3
  '1' AS 均价(b) , A3
  '1' AS 货值(c) , A3
  '1' AS 0未取规证 ,
  '1' AS 1规划许可证阶段 ,
  '1'AS 2施工许可证阶段 ,
  '1' AS 3预售许可证阶段 ,
  '1' AS 4竣工备案阶段 ,
  '1' AS 5结转阶段 ,

FROM
  dual  ;
*/
/*
id  主键
parentId  父
workCode  编码
workName  期/业态/楼栋
recentFloorageArea  最新建筑面积
recentSaleArea  最新可售面积
globalWorkValue 动态货量
noPushValue A1未推货量
noSaleValue A2已推未售货量
saleValue A3已批准已售货量
noPlanPermit  1_未拿规证
holdPlanPermit  2_已拿规证
holdConstructionPermit  3_已经施证
workValueOne  货量(a)
averageValueOne 均价(b)
workAmountOne 货值(c)
workValueTwo  货量(a)
averageValueTwo 均价(b)
workAmountTwo 货值(c)
noSavePlanPermit  0未取规证
planPermitPhase 1规划许可证阶段
constructionPermitPhase 2施工许可证阶段
preSalePermitPhase  3预售许可证阶段
completedPermitPhase  4竣工备案阶段
carryForwardPhase 5结转阶段

*/
 P_ID VARCHAR2(36) :='3e7507a3-b76a-48c5-bd81-2820958ed919';


BEGIN
--  P_ID :=projectid;
SELECT T.ID
INTO   P_ID
FROM   MDM_PROJECT T
WHERE  T.PROJECT_NAME = '佛山领秀公馆（南区）' AND
			 T.IS_DELETE = 0;
OPEN INFO FOR
--  P_ID   :='3e7507a3-b76a-48c5-bd81-2820958ed919';
		SELECT C.PROJECT_CODE AS ID, '' AS PARENT_ID,
					 C.PROJECT_CODE AS WORK_CODE,
            NVL(B.OBJ_NAME, 'XX项目') AS WORK_NAME,

					 TO_CHAR(B.AREA_DT_ALL, '999,999,999,999,999.99') AS RECENT_FLOORAGE_AREA,
						--  最新建筑面积
					 TO_CHAR(B.AREA_DT_ALL, '999,999,999,999,999.99') AS RECENT_SALE_AREA,
						-- 最新可售面积
					 TO_CHAR(B.AREA_REMAIN + B.AREA_HAVED_SALE + B.AREA_STOCK,
										'999,999,999,999,999.99') AS GLOBAL_WORK_VALUE,
						--      动态货量
					 -- to_char(b.AREA_DT_ALL,'999,999,999,999,999.99') AS GLOBAL_WORK_VALUE, --      动态货量
					 TO_CHAR(B.AREA_REMAIN, '999,999,999,999,999.99') AS NO_PUSH_VALUE,
						-- A1未推货量
					 TO_CHAR(B.AREA_HAVED_SALE, '999,999,999,999,999.99') AS NO_SALE_VALUE,
						-- A2已推未售货量
					 TO_CHAR(B.AREA_STOCK, '999,999,999,999,999.99') AS SALE_VALUE,
						-- A3已推已售货量

					 TO_CHAR(B.AREA_NOT_PLANNING_PERMIT, '999,999,999,999,999.99') AS NO_PLAN_PERMIT,
						-- 未推货量分布1_未拿规证
					 TO_CHAR(B.AREA_NOT_CONSTRUCTION_PERMIT, '999,999,999,999,999.99') AS HOLD_PLAN_PERMIT,
						-- 未推货量分布2_已拿规证
					 TO_CHAR(B.AREA_NOT_SALE_PERMIT, '999,999,999,999,999.99') AS HOLD_CONSTRUCTION_PERMIT,
						-- 未推货量分布3_已取施证

					 TO_CHAR(B.AREA_HAVED_SALE, '999,999,999,999,999.99') AS WORK_VALUE_ONE,
						-- 已推已售情况_货量(a)
					 TO_CHAR((CASE
											 WHEN AREA_HAVED_SALE = 0 THEN
												0
											 ELSE
												B.VALUE_HAVED_SALE / B.AREA_HAVED_SALE
									 END), '999,999,999,999,999.99') AS AVERAGE_VALUE_ONE,
						-- 已推已售情况_均价(b)
					 TO_CHAR(B.VALUE_HAVED_SALE / 10000, '999,999,999,999,999.99') AS WORK_AMOUNT_ONE,
						-- 已推已售情况_货值(c)

					 TO_CHAR(B.AREA_STOCK, '999,999,999,999,999.99') AS WORK_VALUE_TWO,
						-- 已推未售情况_货量(a)
					 TO_CHAR((CASE
											 WHEN AREA_STOCK = 0 THEN
												0
											 ELSE
												B.VALUE_STOCK / B.AREA_STOCK
									 END), '999,999,999,999,999.99') AS AVERAGE_VALUE_TWO,
						-- 已推未售情况_均价(b)
					 TO_CHAR(B.VALUE_STOCK / 10000, '999,999,999,999,999.99') AS WORK_AMOUNT_TWO,
						-- 已推未售情况_货值(c)

					 TO_CHAR(B.AREA_NOT_PLANNING_PERMIT, '999,999,999,999,999.99') AS NO_SAVE_PLAN_PERMIT,
						--0未取规证
					 TO_CHAR(B.AREA_NOT_CONSTRUCTION_PERMIT, '999,999,999,999,999.99') AS PLAN_PERMIT_PHASE,
						-- 1规划许可证阶段
					 TO_CHAR(B.AREA_NOT_SALE_PERMIT, '999,999,999,999,999.99') AS CONSTRUCTION_PERMIT_PHASE,
						-- 2施工许可证阶段
					 TO_CHAR(B.AREA_NOT_COMPLETION, '999,999,999,999,999.99') AS PRE_SALE_PERMIT_PHASE,
						-- 3预售许可证阶段
					 TO_CHAR(B.AREA_YES_COMPLETION, '999,999,999,999,999.99') AS COMPLETED_PERMIT_PHASE,
						-- 4竣工备案阶段
					 TO_CHAR(B.AREA_YES_SETTLEMENT, '999,999,999,999,999.99') AS CARRY_FORWARD_PHASE -- 5结转阶段
		FROM   DUAL A
		LEFT   JOIN DWM_DT_VALUE B
		ON     1 = 1 AND
					 B.OBJ_TYPE = '项目' -- AND b.obj_id=P_ID --AND b.is_delete=0
		LEFT   JOIN MDM_PROJECT C
		ON     B.OBJ_ID = C.ID AND
					 C.IS_DELETE = 0
		ORDER  BY C.PROJECT_CODE

		/*

      -- 楼栋
    UNION ALL
    SELECT
      to_char(ROWNUM+1) AS ID,
      '1' AS PARENT_ID,
      to_char(ROWNUM)AS WORK_CODE,
      b.obj_name AS WORK_NAME,

           to_char(b.AREA_DT_ALL,'999,999,999,999,999.99')  AS RECENT_FLOORAGE_AREA,      --  最新建筑面积
           to_char(b.AREA_DT_ALL,'999,999,999,999,999.99') AS RECENT_SALE_AREA, -- 最新可售面积
            to_char(b.AREA_DT_ALL,'999,999,999,999,999.99') AS GLOBAL_WORK_VALUE, --      动态货量
            to_char(b.AREA_RESERVE+b.area_in_process,'999,999,999,999,999.99') AS NO_PUSH_VALUE,  -- A1未推货量
            to_char(b.AREA_STOCK,'999,999,999,999,999.99') AS NO_SALE_VALUE,            -- A2已推未售货量
            to_char(b.AREA_HAVED_SALE,'999,999,999,999,999.99') AS SALE_VALUE,               -- A3已推已售货量

            to_char(b.AREA_NOT_PLANNING_PERMIT,'999,999,999,999,999.99') AS NO_PLAN_PERMIT,           -- 未推货量分布1_未拿规证
            to_char(b.AREA_NOT_CONSTRUCTION_PERMIT,'999,999,999,999,999.99') AS HOLD_PLAN_PERMIT,         -- 未推货量分布2_已拿规证
            to_char(b.AREA_NOT_SALE_PERMIT,'999,999,999,999,999.99') AS HOLD_CONSTRUCTION_PERMIT, -- 未推货量分布3_已取施证

            to_char(b.AREA_HAVED_SALE,'999,999,999,999,999.99') AS WORK_VALUE_ONE,           -- 已推已售情况_货量(a)
            to_char((CASE WHEN AREA_HAVED_SALE=0 THEN 0 ELSE b.VALUE_HAVED_SALE/b.AREA_HAVED_SALE END ),'999,999,999,999,999.99') AS AVERAGE_VALUE_ONE,        -- 已推已售情况_均价(b)
            to_char(b.VALUE_HAVED_SALE/10000,'999,999,999,999,999.99') AS WORK_AMOUNT_ONE,          -- 已推已售情况_货值(c)

            to_char(b.AREA_STOCK,'999,999,999,999,999.99') AS WORK_VALUE_TWO,           -- 已推未售情况_货量(a)
            to_char((CASE WHEN AREA_STOCK=0 THEN 0 ELSE b.VALUE_STOCK/b.AREA_STOCK END ),'999,999,999,999,999.99') AS AVERAGE_VALUE_TWO,        -- 已推未售情况_均价(b)
            to_char(b.VALUE_STOCK/10000,'999,999,999,999,999.99') AS WORK_AMOUNT_TWO,          -- 已推未售情况_货值(c)

            to_char(b.AREA_NOT_PLANNING_PERMIT,'999,999,999,999,999.99') AS NO_SAVE_PLAN_PERMIT,      --0未取规证
            to_char(b.AREA_NOT_CONSTRUCTION_PERMIT,'999,999,999,999,999.99') AS PLAN_PERMIT_PHASE,        -- 1规划许可证阶段
            to_char(b.AREA_NOT_SALE_PERMIT,'999,999,999,999,999.99') AS CONSTRUCTION_PERMIT_PHASE,   -- 2施工许可证阶段
            to_char(b.AREA_NOT_COMPLETION,'999,999,999,999,999.99') AS PRE_SALE_PERMIT_PHASE,       -- 3预售许可证阶段
            to_char(b.AREA_YES_COMPLETION,'999,999,999,999,999.99') AS COMPLETED_PERMIT_PHASE,      -- 4竣工备案阶段
            to_char(b.AREA_YES_SETTLEMENT,'999,999,999,999,999.99') AS CARRY_FORWARD_PHASE          -- 5结转阶段
    FROM   dual a
    LEFT JOIN dwm_dt_value b ON 1=1 AND b.obj_id IN (SELECT t.id FROM mdm_build t WHERE t.proj_id=P_ID) --AND b.is_delete=0
    AND ROWNUM=1
    --ORDER BY b.obj_name
    */

		/*
      UNION ALL
    SELECT
      '3' AS ID,
      '2' AS PARENT_ID,
      '1' AS WORK_CODE,
      '1#' AS WORK_NAME,
      '1' AS RECENT_FLOORAGE_AREA,
      '1' AS RECENT_SALE_AREA,
      '1' AS GLOBAL_WORK_VALUE,
      '1' AS NO_PUSH_VALUE,
      '1' AS NO_SALE_VALUE,
      '1' AS SALE_VALUE,
      '1' AS NO_PLAN_PERMIT,
      '1' AS HOLD_PLAN_PERMIT,
      '1' AS HOLD_CONSTRUCTION_PERMIT,
      '1' AS WORK_VALUE_ONE,
      '1' AS AVERAGE_VALUE_ONE,
      '1' AS WORK_AMOUNT_ONE,
      '1' AS WORK_VALUE_TWO,
      '1' AS AVERAGE_VALUE_TWO,
      '1' AS WORK_AMOUNT_TWO,
      '1' AS NO_SAVE_PLAN_PERMIT,
      '1' AS PLAN_PERMIT_PHASE,
      '1' AS CONSTRUCTION_PERMIT_PHASE,
      '1' AS PRE_SALE_PERMIT_PHASE,
      '1' AS COMPLETED_PERMIT_PHASE,
      '1' AS CARRY_FORWARD_PHASE
      ,'' AS Obj_ID
    FROM
      dual a
    WHERE rownum=1

      UNION ALL
    SELECT
      '4' AS ID,
      '2' AS PARENT_ID,
      '2' AS WORK_CODE,
      '黄伟的楼栋' AS WORK_NAME,
      '1' AS RECENT_FLOORAGE_AREA,
      '1' AS RECENT_SALE_AREA,
      '1' AS GLOBAL_WORK_VALUE,
      '1' AS NO_PUSH_VALUE,
      '1' AS NO_SALE_VALUE,
      '1' AS SALE_VALUE,
      '1' AS NO_PLAN_PERMIT,
      '1' AS HOLD_PLAN_PERMIT,
      '1' AS HOLD_CONSTRUCTION_PERMIT,
      '1' AS WORK_VALUE_ONE,
      '1' AS AVERAGE_VALUE_ONE,
      '1' AS WORK_AMOUNT_ONE,
      '1' AS WORK_VALUE_TWO,
      '1' AS AVERAGE_VALUE_TWO,
      '1' AS WORK_AMOUNT_TWO,
      '1' AS NO_SAVE_PLAN_PERMIT,
      '1' AS PLAN_PERMIT_PHASE,
      '1' AS CONSTRUCTION_PERMIT_PHASE,
      '1' AS PRE_SALE_PERMIT_PHASE,
      '1' AS COMPLETED_PERMIT_PHASE,
      '1' AS CARRY_FORWARD_PHASE
      ,'' AS Obj_ID
    FROM
      dual
       */
		;

END P_DWM_GLOBAL_WORK_VALUE;
/

prompt
prompt Creating procedure P_DWM_K1DATALIST
prompt ===================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_K1DataList
(
rowNum number
,sortField varchar2 default 'foSaleRateByMoney'
,orderBy varchar2 default 'desc'
,k1DataList OUT sys_refcursor
)
AS  
v_sql clob :='';
whereStr varchar2(500):='';
-- 用于返回筛选的列
v_column clob :='';
-- 用于解决排序字段有span标签问题
sortStr varchar2(100):='';
begin
sortStr := sortField;
  if sortStr = 'firstOpenDate' then
    sortStr := 'FIRST_OPEN_DATE';
  elsif sortStr = 'foSaleRateByMoney' then
    sortStr := 'fo_sale_rate_by_money';
  elsif sortStr = 'foSaleMoney' then
    sortStr := 'fo_sale_money'; 
  elsif sortStr = 'foSaleOutMoney' then
    sortStr := 'fo_sale_out_money';
  elsif sortStr = 'foSaleRateByCount' then
    sortStr := 'fo_sale_rate_by_count';
  elsif sortStr = 'foSaleCount' then
    sortStr := 'fo_sale_count';
  elsif sortStr = 'foSaleOutCount' then
    sortStr := 'fo_sale_out_count';
  elsif sortStr = 'foSaleRateByArea' then
    sortStr := 'fo_sale_rate_by_area';
  elsif sortStr = 'foSaleArea' then
    sortStr := 'fo_sale_area';
  elsif sortStr = 'foSaleOutArea' then
    sortStr := 'fo_sale_out_area';
  elsif sortStr = 'projectName' then
    sortStr := 'projectNameCopy';  
  end if;
--execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd''';
v_sql:='
SELECT
    p.FIRST_OPEN_DATE as "FIRST_OPEN_DATE",
    NVL(fo.fo_sale_rate_by_money,0) as "fo_sale_rate_by_money",
    NVL(fo.fo_sale_money,0) as "fo_sale_money",
    NVL(fo.fo_sale_out_money,0) as "fo_sale_out_money",
    NVL(fo.fo_sale_rate_by_count,0) as "fo_sale_rate_by_count",
    NVL(fo.fo_sale_count,0) as "fo_sale_count",
    NVL(fo.fo_sale_out_count,0) as "fo_sale_out_count",
    NVL(fo.fo_sale_rate_by_area,0) as "fo_sale_rate_by_area",
    NVL(fo.fo_sale_area,0) as "fo_sale_area",
    NVL(fo.fo_sale_out_area,0) as "fo_sale_out_area",

    p.PROJECT_NAME as "projectNameCopy",
    case when fo.fo_sale_rate_by_money is not null then
    FN_DWM_DEC_CONVERT_PCT(fo.fo_sale_rate_by_money) else ''0%'' end as "foSaleRateByMoneyCopy",
    case when fo.fo_sale_rate_by_count is not null then
    FN_DWM_DEC_CONVERT_PCT(fo.fo_sale_rate_by_count) else ''0%'' end as "foSaleRateByCountCopy",
    case when fo.fo_sale_rate_by_area is not null then
    FN_DWM_DEC_CONVERT_PCT(fo.fo_sale_rate_by_area) else ''0%'' end as "foSaleRateByAreaCopy",

    p.project_id as "projectId",
    FN_DWM_FONT_COLOR(p.PROJECT_NAME) as "projectName",
    to_char(p.FIRST_OPEN_DATE,''yyyy-mm-dd'')  as "firstOpenDate",
    case when fo.fo_sale_rate_by_money is not null then
    FN_DWM_FONT_COLOR(FN_DWM_DEC_CONVERT_PCT(fo.fo_sale_rate_by_money)) else FN_DWM_FONT_COLOR(''0%'') end as "foSaleRateByMoney",
    FN_DWM_MULTIPLE_AND_UNIT(fo.fo_sale_money, 100000000, ''亿'') as "foSaleMoney",
    FN_DWM_MULTIPLE_AND_UNIT(fo.fo_sale_out_money, 100000000, ''亿'') as "foSaleOutMoney",
    case when fo.fo_sale_rate_by_count is not null then
    FN_DWM_FONT_COLOR(FN_DWM_DEC_CONVERT_PCT(fo.fo_sale_rate_by_count)) else FN_DWM_FONT_COLOR(''0%'') end as "foSaleRateByCount",
    case when fo.fo_sale_count is not null then
    fo.fo_sale_count || ''套'' else ''0套'' end as "foSaleCount",
    case when fo.fo_sale_out_count is not null then
    fo.fo_sale_out_count || ''套'' else ''0套'' end  as "foSaleOutCount",
    case when fo.fo_sale_rate_by_area is not null then
    FN_DWM_FONT_COLOR(FN_DWM_DEC_CONVERT_PCT(fo.fo_sale_rate_by_area)) else FN_DWM_FONT_COLOR(''0%'') end as "foSaleRateByArea",
    FN_DWM_MULTIPLE_AND_UNIT(fo.fo_sale_area, 10000, ''万方'') as "foSaleArea",
    FN_DWM_MULTIPLE_AND_UNIT(fo.fo_sale_out_area, 10000, ''万方'') as "foSaleOutArea"
FROM
    dwm_sale_rate_by_project fo right join 
    DWM_SALE_RATE_PROJECT p on fo.project_id=p.project_id  
    where p.PROJECT_NAME is not null and TO_DATE(trunc(sysdate,''yyyy'')) <= p.FIRST_OPEN_DATE';
v_column := ' "projectId",
      "projectName",
      "firstOpenDate",
      "foSaleRateByMoney",
      "foSaleMoney",
      "foSaleOutMoney",
      "foSaleRateByCount",
      "foSaleCount",
      "foSaleOutCount",
      "foSaleRateByArea",
      "foSaleArea",
      "foSaleOutArea",

      "projectNameCopy",
      "foSaleRateByMoneyCopy",
      "foSaleRateByCountCopy",
      "foSaleRateByAreaCopy"';    
--    if rowNum <> 0 then
--    whereStr:='where rownum<= ' || rowNum;
--    end if;
    if sortStr is not null and orderBy is not null then
        whereStr:=whereStr||' order by tab."'||sortStr|| '"  '||orderBy || ' nulls last ';
    end if;
    if whereStr is not null then
        v_sql:='select ' || v_column || ' from ('||v_sql||') tab '||whereStr;
    else
        v_sql:='select ' || v_column || ' from (' ||v_sql || ' )';
    end if;
    -- 选择前n条数据，rownum必须拼接在排序后面，不然会先运行rownum再运行排序，会导致筛选数据并不准确
    if rowNum <> 0 then
        v_sql := 'select ' || v_column || ' from (' ||v_sql || ' )' || ' where rownum <= ' || rowNum;
    end if; 
    dbms_output.put_line(v_sql);
OPEN k1DataList FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE k1DataList;
END P_DWM_K1DataList;
/

prompt
prompt Creating procedure P_DWM_PREPARE_DATALIST_K2
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_PREPARE_DATALIST_K2
(
  sortField IN VARCHAR2
, orderBy IN VARCHAR2 
, rowNumber IN number
, k2PrepareDataList OUT sys_refcursor 
) AS
whereStr varchar2(500):='';
v_sql clob :='';
-- 用于返回筛选的列
v_column clob :='';
-- 用于解决排序字段有span标签问题
sortStr varchar2(100):='';
BEGIN
  sortStr := sortField;
  if sortStr = 'takeLandDate' then
    sortStr := 'TAKE_LAND_DATE';
  elsif sortStr = 'planFirstOpenDate' then
    sortStr := 'PLAN_FIRST_OPEN_DATE';
  elsif sortStr = 'firstOpenDurationByPlan' then
    sortStr := 'FIRST_OPEN_DURATION_BY_PLAN'; 
  elsif sortStr = 'newPlanFirstOpenDate' then
    sortStr := 'NEW_PLAN_FIRST_OPEN_DATE';   
  end if;
  v_sql:='select
        TAKE_LAND_DATE,
        PLAN_FIRST_OPEN_DATE,
        NVL(FIRST_OPEN_DURATION_BY_PLAN,0) as "FIRST_OPEN_DURATION_BY_PLAN",
        NEW_PLAN_FIRST_OPEN_DATE,

        PROJECT_NAME as "projectNameCopy",
        FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_PLAN) as "firstOpenDurationByPlanCopy",
        Fn_DWM_RiskSummaryDeal(PLAN_FIRST_OPEN_DATE,NEW_PLAN_FIRST_OPEN_DATE,''pure'') as "risKAbstractCopy",

        PROJECT_ID as "projectId", 
        FN_DWM_FONT_COLOR(PROJECT_NAME) as "projectName",
        to_char(TAKE_LAND_DATE,''yyyy-mm-dd'') as "takeLandDate",
        to_char(PLAN_FIRST_OPEN_DATE,''yyyy-mm-dd'') as "planFirstOpenDate",  
        FN_DWM_FONT_COLOR(FN_DWM_DAY_CONVERT_MONTH(FIRST_OPEN_DURATION_BY_PLAN)) as "firstOpenDurationByPlan",
        to_char(NEW_PLAN_FIRST_OPEN_DATE,''yyyy-mm-dd'') as "newPlanFirstOpenDate",
        Fn_DWM_RiskSummaryDeal(PLAN_FIRST_OPEN_DATE,NEW_PLAN_FIRST_OPEN_DATE,''label'') as "risKAbstract"
    from DWM_SALE_RATE_PROJECT
    where (to_number(to_char(PLAN_FIRST_OPEN_DATE,''yyyy'')) = to_number(to_char(sysdate,''yyyy'')) or to_number(to_char(NEW_PLAN_FIRST_OPEN_DATE,''yyyy'')) = to_number(to_char(sysdate,''yyyy'')))  and FIRST_OPEN_DATE is null';
  v_column := ' "projectId",
      "projectName",
      "projectNameCopy",
      "takeLandDate",
      "planFirstOpenDate",
      "firstOpenDurationByPlan",
      "firstOpenDurationByPlanCopy",
      "newPlanFirstOpenDate",
      "risKAbstract",
      "risKAbstractCopy" ';
--    if rowNumber <> 0 then
--    whereStr:='where rownum<= ' || rowNumber;
--    end if;
    if sortStr is not null and orderBy is not null then
    whereStr:=whereStr||' order by tab."'||sortStr||'"  '||orderBy;
    end if;
    if whereStr is not null then
    v_sql:='select ' || v_column || ' from ('||v_sql||') tab '||whereStr;
    else
    v_sql:='select ' || v_column || ' from (' ||v_sql || ' )';
    end if;
    -- 选择前n条数据，rownum必须拼接在排序后面，不然会先运行rownum再运行排序，会导致筛选数据并不准确
    if rowNumber <> 0 then
        v_sql := 'select ' || v_column || ' from (' ||v_sql || ' )' || ' where rownum <= ' || rowNumber;
    end if;
  dbms_output.put_line(v_sql);  
  OPEN k2PrepareDataList FOR v_sql;
  EXCEPTION
    WHEN OTHERS THEN
  CLOSE k2PrepareDataList;
END P_DWM_PREPARE_DATALIST_K2;
/

prompt
prompt Creating procedure P_DWM_SALERATEDETAILPROJECT
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_SaleRateDetailProject(projectId in varchar2,projectName out varchar2,obtainDate out varchar2,firstOpenDate out varchar2,orgName out varchar2)
AS 
begin
execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd''';
select PROJECT_NAME,to_char(OBTAIN_DATE,'yyyy-mm-dd'),to_char(FIRST_OPEN_DATE,'yyyy-mm-dd'),ORG_NAME into projectName,obtainDate,firstOpenDate,orgName  from DWM_SALE_RATE_PROJECT where PROJECT_ID=projectId;
END P_DWM_SaleRateDetailProject;
/

prompt
prompt Creating procedure P_DWM_SALE_RATE_BY_GRANULARITY
prompt =================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_DWM_SALE_RATE_BY_GRANULARITY" (
    spid_info   OUT  SYS_REFCURSOR,
    t_room_info   OUT  SYS_REFCURSOR ,
    spid_tree_info   OUT  SYS_REFCURSOR
) AS
		--业态面积段颗粒度去化率；作用=》定时任务拍照
		--作者：陈丽
		--日期：2020-04-10
  PROJ_BASE_SPID VARCHAR2(2000);
  sys_created date:=sysdate;
  spid VARCHAR2(360); --使用临时表的批次号
  spid_tree VARCHAR2(360); --使用临时表的批次号
  dwm_REMARK VARCHAR2(200):='测试-chenl';
  ----------------------
  v_sql clob;
  v_sql_start VARCHAR2(2000):= ' case ';
  v_sql_content clob:= '';
  v_sql_end VARCHAR2(2000):= '  else ''主数据面积段外'' end  ';
BEGIN
delete TMP_ROOM;
delete TMP_SALE_RATE_BY_GRANULARITY;
---------------------------
--------------------------------------------------------创建临时表批次号
    SELECT
        get_uuid(),get_uuid()
    INTO spid,spid_tree
    FROM
        dual;  
---------------------------------------------计算业态面积段1.拼接查询语句
 FOR item IN (select 
    ' when room.NEW_BLD_AREA'||l.lower_limit_type||l.lower_limit_value||' and room.NEW_BLD_AREA '||l.upper_limit_type||l.upper_limit_value
    ||' and (case when room.PRODUCT_NAME=''车位'' then ''车位仓储'' when room.PRODUCT_NAME=''商办'' then ''商办产业'' else ''住宅'' end)='''||l.顶级业态||''' then ''' ||l.areaStage||''' ' as aa,
    l.upper_limit_type,
    l.lower_limit_type,
    l.upper_limit_value,
    l.areaStage,
    l.顶级业态 as ptype from (select 
    lev.attribute_name as areaStage
    ,lev.order_code
    ,lev.upper_limit_type
    ,lev.LOWER_LIMIT_VALUE
    ,lev.lower_limit_type
    ,lev.upper_limit_value
    ,product_type.id as 顶级业态id
    ,product_type.product_type_short_name as 顶级业态
    from mdm_attribute_area_level lev
    left join mdm_attribute_area_level p on lev.parent_id=p.id 
    ---关联面积段对应业态
    left join MDM_AREA_LEVEL_APPLY_PRODUCT ap on p.id=ap.AREA_LEVEL_ID 
     --关联业态 找到业态顶级
    left join MDM_BUILD_PRODUCT_TYPE PRODUCT_TYPE 
    on substr(ap.product_type_name,1,instr(ap.product_type_name,'/',1,1)-1)=PRODUCT_TYPE.product_type_name
    where product_type.product_type_short_name is not null
    group by product_type.id
    ,product_type.product_type_short_name,lev.attribute_name,lev.order_code ,lev.upper_limit_type
    ,lev.lower_limit_type
    ,lev.upper_limit_value,lev.lower_limit_value
    order by product_type.product_type_short_name,lev.order_code)l
        ) LOOP 
    ---拼接字符串
         v_sql_content := v_sql_content||item.aa;
        END LOOP;
    --规则内容大于0才拼规则语句
        IF length(v_sql_content) > 0 THEN
            v_sql := v_sql_start
                     || v_sql_content
                     || v_sql_end;
        ELSE
            v_sql := '''''';
        END IF;

       v_sql:= 'INSERT INTO TMP_ROOM(id,room_ID,BLD_AREA,ROOM_NAME,PRODUCT_NAME,AREA_LEVEL)
       select '''||spid||''',id,NEW_BLD_AREA,room_name
       ,case when room.PRODUCT_NAME=''车位'' then ''车位仓储'' when room.PRODUCT_NAME=''商办'' then ''商办产业'' else ''住宅'' end,'
       ||v_sql|| ' as NODE_WARNING from mdm_room room';
         dbms_output.put_line(v_sql);
       execute immediate v_sql;

        OPEN t_room_info FOR select * from TMP_ROOM;  
-----------------------------------------------项目基本信息
BEGIN
  P_DWM_SALE_RATE_PROJ(0,
    PROJ_BASE_SPID => PROJ_BASE_SPID
  );
    END;
 ------------------------------------------------------------业态面积段树拼接 spid_tree
 INSERT INTO TMP_SALE_RATE_BY_GRANULARITY (ID---【1】主键
,"SORT"
,GRANULARITY_ID--颗粒度id
,PROJECT_ID---【2】项目ID
,PROJECT_NAME--项目名称
,PARENT_ID---父级id
,DATA_GRANULARITY--颗粒度名称
)
-----业态
select spid_tree
,b.order_code
,proj.PROJECT_ID||b.product_type_short_name as GRANULARITY_ID
,proj.PROJECT_ID as projectId
,proj.PROJECT_NAME
,null as parentId 
,b.product_type_short_name as text   
 from (select * from tmp_proj_base where id = PROJ_BASE_SPID) proj cross join
(
select ptype.*,rownum as order_code FROM(select * from  MDM_BUILD_PRODUCT_TYPE ptype
where parent_code is null order by PRODUCT_TYPE_CODE) ptype ) b
   union all
-----面积段
select spid_tree
,a.order_code
,proj.PROJECT_ID||顶级业态||a.areaStage as GRANULARITY_ID
,proj.PROJECT_ID as projectId
,proj.PROJECT_NAME
,proj.PROJECT_ID||顶级业态 as parentId 
,a.areaStage as text
from  (select * from tmp_proj_base where id = PROJ_BASE_SPID) proj cross join
( select 
    lev.attribute_name as areaStage
    ,lev.order_code
    ,lev.upper_limit_type
    ,lev.LOWER_LIMIT_VALUE
    ,lev.lower_limit_type
    ,lev.upper_limit_value
    ,product_type.id as 顶级业态id
    ,product_type.product_type_short_name as 顶级业态
    from mdm_attribute_area_level lev
    left join mdm_attribute_area_level p on lev.parent_id=p.id 
    ---关联面积段对应业态
    left join MDM_AREA_LEVEL_APPLY_PRODUCT ap on p.id=ap.AREA_LEVEL_ID 
     --关联业态 找到业态顶级
    left join MDM_BUILD_PRODUCT_TYPE PRODUCT_TYPE 
    on substr(ap.product_type_name,1,instr(ap.product_type_name,'/',1,1)-1)=PRODUCT_TYPE.product_type_name
    where product_type.product_type_short_name is not null
    group by product_type.id
    ,product_type.product_type_short_name,lev.attribute_name,lev.order_code ,lev.upper_limit_type
    ,lev.lower_limit_type
    ,lev.upper_limit_value,lev.lower_limit_value
    order by product_type.product_type_short_name,lev.order_code) a;

OPEN spid_tree_info FOR select * from TMP_SALE_RATE_BY_GRANULARITY where id=spid_tree;  
------------------------------------------------------面积段数据 spid

 INSERT INTO TMP_SALE_RATE_BY_GRANULARITY (ID---【1】主键
,GRANULARITY_ID
,PROJECT_ID---【2】项目ID
,PROJECT_NAME
,FO_SALE_OUT_COUNT---【3】首开去化套数
,FO_SALE_COUNT---【4】首开推售套数
,FO_SALE_RATE_BY_COUNT---【5】首开去化率(按套数)（3/4）
,FO_SALE_OUT_AREA---【6】首开去化面积
,FO_SALE_AREA---【7】首开推售面积
,FO_SALE_RATE_BY_AREA---【8】首开去化率(按面积)（6/7）
,FO_SALE_OUT_MONEY---【9】首开去化货值
,FO_SALE_MONEY---【10】首开推售货值
,FO_SALE_RATE_BY_MONEY---【11】首开去化率(按货值)（9/10）
,FO_SURPLUS_SALE_MONEY---【12】首开剩余货值(10-9)
,FO_SALE_AVERAGE_MONEY---【13】首开标准均价(10/7)
,FO_SALE_OUT_AVERAGE_MONEY---【14】首开签约均价(9/6)
,PO_SALE_OUT_COUNT---【15】全案去化套数
,PO_SALE_COUNT---【16】全案推售套数
,PO_SALE_RATE_BY_COUNT---【17】全案去化率(按套数)(15/16)
,PO_SALE_OUT_AREA---【18】全案去化面积
,PO_SALE_AREA---【19】全案推售面积
,PO_SALE_RATE_BY_AREA---【20】全案去化率(按面积)(18/19)
,PO_SALE_OUT_MONEY---【21】全案去化货值
,PO_SALE_MONEY---【22】全案推售货值
,PO_SALE_RATE_BY_MONEY---【23】全案去化率(按货值)(21/22)
,PO_SURPLUS_SALE_MONEY---【24】全案剩余货值(22-21)
,PO_SALE_AVERAGE_MONEY---【25】全案标准均价(22/19)
,PO_SALE_OUT_AVERAGE_MONEY---【26】全案签约均价(21/18)
,EH_SALE_OUT_COUNT---【27】现房去化套数
,EH_SALE_COUNT---【28】现房推售套数
,EH_SALE_RATE_BY_COUNT---【29】现房去化率(按套数)(27/28)
,EH_SALE_OUT_AREA---【30】现房去化面积
,EH_SALE_AREA---【31】现房推售面积
,EH_SALE_RATE_BY_AREA---【32】现房去化率(按面积)(30/31)
,EH_SALE_OUT_MONEY---【33】现房去化货值
,EH_SALE_MONEY---【34】现房推售货值
,EH_SALE_RATE_BY_MONEY---【35】现房去化率(按货值)(33/34)
,EH_SURPLUS_SALE_MONEY---【36】现房剩余货值(34-33)
,EH_SALE_AVERAGE_MONEY---【37】现房标准均价(34/31)
,EH_SALE_OUT_AVERAGE_MONEY---【38】现房签约均价(33/30)
,SI_SALE_OUT_COUNT---【39】顽固性库存去化套数
,SI_SALE_COUNT---【40】顽固性库存推售套数
,SI_SALE_RATE_BY_COUNT---【41】顽固性库存去化率(按套数)(39/40)
,SI_SALE_OUT_AREA---【42】顽固性库存去化面积
,SI_SALE_AREA---【43】顽固性库存推售面积
,SI_SALE_RATE_BY_AREA---【44】顽固性库存去化率(按面积)(42/43)
,SI_SALE_OUT_MONEY---【45】顽固性库存去化货值
,SI_SALE_MONEY---【46】顽固性库存推售货值
,SI_SALE_RATE_BY_MONEY---【47】顽固性库存去化率(按货值)(45/46)
,SI_SURPLUS_SALE_MONEY---【48】顽固性库存剩余货值(46-45)
,SI_SALE_AVERAGE_MONEY---【49】顽固性库存标准均价(46/43)
,SI_SALE_OUT_AVERAGE_MONEY---【50】顽固性库存签约均价(45/42)
,PARENT_ID  
,DATA_GRANULARITY
,PRODUCT_NAME
,CREATED---【51】创建日期
,REMARK
)select 
spid as ID---【1】主键
,project_id||PRODUCT_NAME||AREA_LEVEL
,project_id as PROJECT_ID---【2】项目ID
,project_name
-----------------------------------K1、首开去化率开始--------------------
,"首开去化套数" as FO_SALE_OUT_COUNT---【3】首开去化套数
,"首开推售套数" as FO_SALE_COUNT---【4】首开推售套数
,case when 首开推售套数=0 then 0 else round("首开去化套数"/"首开推售套数",4)  end as FO_SALE_RATE_BY_COUNT---【5】首开去化率(按套数)（3/4）
,"首开去化面积" as FO_SALE_OUT_AREA---【6】首开去化面积
,"首开推售面积" as FO_SALE_AREA---【7】首开推售面积
,case when 首开推售面积=0 then 0 else round("首开去化面积"/"首开推售面积",4)  end as FO_SALE_RATE_BY_AREA---【8】首开去化率(按面积)（6/7）
,"首开去化货值" as FO_SALE_OUT_MONEY---【9】首开去化货值
,"首开推售货值" as FO_SALE_MONEY---【10】首开推售货值
,case when 首开推售货值=0 then 0 else round("首开去化货值"/"首开推售货值",4)  end as FO_SALE_RATE_BY_MONEY---【11】首开去化率(按货值)（9/10）
,"首开推售货值"-"首开去化货值" as FO_SURPLUS_SALE_MONEY---【12】首开剩余货值(10-9)
,case when 首开推售面积=0 then 0 else round("首开推售货值"/"首开推售面积",4)  end  as FO_SALE_AVERAGE_MONEY---【13】首开标准均价(10/7)
,case when 首开去化面积=0 then 0 else round("首开去化货值"/"首开去化面积",4)  end as FO_SALE_OUT_AVERAGE_MONEY---【14】首开签约均价(9/6)
-----------------------------------K3、全案去化率 （单位：%）--------------------
,"全案已去化套数" as PO_SALE_OUT_COUNT---【15】全案去化套数
,"全案已领证套数" as PO_SALE_COUNT---【16】全案推售套数
,case when 全案已领证套数=0 then 0 else round("全案已去化套数"/"全案已领证套数",4)  end as PO_SALE_RATE_BY_COUNT---【17】全案去化率(按套数)(15/16)
,"全案已去化面积" as PO_SALE_OUT_AREA---【18】全案去化面积
,"全案已领证面积" as PO_SALE_AREA---【19】全案推售面积
,case when 全案已领证面积=0 then 0 else round("全案已去化面积"/"全案已领证面积",4)  end as PO_SALE_RATE_BY_AREA---【20】全案去化率(按面积)(18/19)
,"全案已去化货值" as PO_SALE_OUT_MONEY---【21】全案去化货值
,"全案已领证货值" as PO_SALE_MONEY---【22】全案推售货值
,case when 全案已领证货值=0 then 0 else round("全案已去化货值"/"全案已领证货值",4)  end  as PO_SALE_RATE_BY_MONEY---【23】全案去化率(按货值)(21/22)
,"全案已领证货值"-"全案已去化货值" as PO_SURPLUS_SALE_MONEY---【24】全案剩余货值(22-21)
,case when 全案已领证面积=0 then 0 else round("全案已领证货值"/"全案已领证面积",4)  end  as PO_SALE_AVERAGE_MONEY---【25】全案标准均价(22/19)
,case when 全案已去化面积=0 then 0 else round("全案已去化货值"/"全案已去化面积",4)  end   PO_SALE_OUT_AVERAGE_MONEY---【26】全案签约均价(21/18)
-----------------------------------K4、现房去化率 （单位：%）--------------------
,"现房去化套数" as EH_SALE_OUT_COUNT---【27】现房去化套数
,"现房推售套数" as EH_SALE_COUNT---【28】现房推售套数
,case when 现房推售套数=0 then 0 else  round("现房去化套数"/"现房推售套数",4) end as EH_SALE_RATE_BY_COUNT---【29】现房去化率(按套数)(27/28)
,"现房去化面积" as EH_SALE_OUT_AREA---【30】现房去化面积
,"现房推售面积" as EH_SALE_AREA---【31】现房推售面积
,case when 现房推售面积=0 then 0 else  round("现房去化面积"/"现房推售面积",4) end as EH_SALE_RATE_BY_AREA---【32】现房去化率(按面积)(30/31)
,"现房去化金额" as EH_SALE_OUT_MONEY---【33】现房去化货值
,"现房推售金额" as EH_SALE_MONEY---【34】现房推售货值
,case when 现房推售金额=0 then 0 else  round("现房去化金额"/"现房推售金额",4) end as EH_SALE_RATE_BY_MONEY---【35】现房去化率(按货值)(33/34)
,"现房推售金额"-"现房去化金额" as EH_SURPLUS_SALE_MONEY---【36】现房剩余货值(34-33)
,case when 现房推售面积=0 then 0 else  round("现房推售金额"/"现房推售面积",4) end  as EH_SALE_AVERAGE_MONEY---【37】现房标准均价(34/31)
,case when 现房去化面积=0 then 0 else  round("现房去化金额"/"现房去化面积",4) end  as EH_SALE_OUT_AVERAGE_MONEY---【38】现房签约均价(33/30)
-----------------------------------K5、顽固性库存去化率 （单位：%）--------------------
,"顽固去化套数" as SI_SALE_OUT_COUNT---【39】顽固性库存去化套数
,"顽固推售套数" as SI_SALE_COUNT---【40】顽固性库存推售套数
,case when 顽固推售套数=0 then 0 else  round("顽固去化套数"/"顽固推售套数",4) end as SI_SALE_RATE_BY_COUNT---【41】顽固性库存去化率(按套数)(39/40)
,"顽固去化面积" as SI_SALE_OUT_AREA---【42】顽固性库存去化面积
,"顽固推售面积" as SI_SALE_AREA---【43】顽固性库存推售面积
,case when 顽固推售面积=0 then 0 else  round("顽固去化面积"/"顽固推售面积",4) end  as SI_SALE_RATE_BY_AREA---【44】顽固性库存去化率(按面积)(42/43)
,"顽固去化金额" as SI_SALE_OUT_MONEY---【45】顽固性库存去化货值
,"顽固推售金额" as SI_SALE_MONEY---【46】顽固性库存推售货值
,case when 顽固推售金额=0 then 0 else  round("顽固去化金额"/"顽固推售金额",4) end as SI_SALE_RATE_BY_MONEY---【47】顽固性库存去化率(按货值)(45/46)
,"顽固推售金额"-"顽固去化金额" SI_SURPLUS_SALE_MONEY---【48】顽固性库存剩余货值(46-45)
,case when 顽固推售面积=0 then 0 else  round("顽固推售金额"/"顽固推售面积",4) end as SI_SALE_AVERAGE_MONEY---【49】顽固性库存标准均价(46/43)
,case when 顽固推售面积=0 then 0 else  round("顽固去化金额"/"顽固推售面积",4) end as SI_SALE_OUT_AVERAGE_MONEY---【50】顽固性库存签约均价(45/42)
-------------------- 业态面积段特有 start
,project_id||PRODUCT_NAME  as PARENT_ID  
,AREA_LEVEL as DATA_GRANULARITY
,PRODUCT_NAME    
,sys_created as CREATED---【51】创建日期
,dwm_REMARK
-------------------- 业态面积段特有 end
from 
(select 
--------------------------------------------------基础计算字段开始
------首次开盘30天内的签约金额（首开去化货值）: 
---------->房间“合同成交总价”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约
sum(case when room.SALE_STATE='签约' 
-- 首开分期房间
and FIRST_OPEN_PERIOD.id is not null
--and proj.first_open_date<=build.GET_PRE_SALE_PERMIT_DATE
and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30 then room.TRADE_TOTAL else 0 end ) as "首开去化货值"
------首次开盘已取证货值（首开推售货值）：
---------->房间“面价标准总价”:在计算“货值去化率”时，对已签约房间（有可能出现优惠打折），分子分母均按“签约金额”计算“货值去化率”。
---------->房间所属“楼栋预售许可证获取日期”<"项目开盘"的实际完成日期 
,sum(case when room.SALE_STATE='签约'
-- 首开分期房间
and FIRST_OPEN_PERIOD.id is not null
--and build.GET_PRE_SALE_PERMIT_DATE<=proj.first_open_date 
and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30
then room.TRADE_TOTAL 
when build.GET_PRE_SALE_PERMIT_DATE<=proj.first_open_date
-- 首开分期房间
and FIRST_OPEN_PERIOD.id is not null
then room.BZ_TOTAL else 0 end )  as "首开推售货值"
------首次开盘30天内的签约面积（首开去化面积）:
---------->房间“最新建筑面积”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' 
-- 首开分期房间
and FIRST_OPEN_PERIOD.id is not null
--and proj.first_open_date<=build.GET_PRE_SALE_PERMIT_DATE 
and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30  then room.NEW_BLD_AREA else 0 end ) as "首开去化面积"
------首次开盘的已取证面积（首开推售面积）:
---------->房间“最新建筑面积”
---------->房间所属“楼栋预售许可证获取日期”<"项目开盘"的实际完成日期 
,sum(case when build.GET_PRE_SALE_PERMIT_DATE<=proj.first_open_date 
-- 首开分期房间
and FIRST_OPEN_PERIOD.id is not null then room.NEW_BLD_AREA 
when room.SALE_STATE='签约' 
-- 首开分期房间
and FIRST_OPEN_PERIOD.id is not null
--and proj.first_open_date<=build.GET_PRE_SALE_PERMIT_DATE 
and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30  then room.NEW_BLD_AREA 
else 0 end )  as "首开推售面积"
------首次开盘30天内的签约套数（首开去化套数）:
---------->房间“汇总”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约  
--,sum(case when room.SALE_STATE='签约' and proj.first_open_date<=build.GET_PRE_SALE_PERMIT_DATE           and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30 then 1 else 0 end ) as "首开去化套数"
,sum(case when room.SALE_STATE='签约' 
-- 首开分期房间
and FIRST_OPEN_PERIOD.id is not null
          --and proj.first_open_date<=build.GET_PRE_SALE_PERMIT_DATE 
and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30 then 1 else 0 end ) as "首开去化套数"
------首次开盘的已取证套数（首开推售套数）:
---------->房间“汇总”
---------->房间所属“楼栋预售许可证获取日期”<"项目开盘"的实际完成日期 
--原来统计逻辑
--,sum(case when build.GET_PRE_SALE_PERMIT_DATE<proj.first_open_date then 1 else 0 end )  as "首开推售套数"
,sum(case when build.GET_PRE_SALE_PERMIT_DATE<=proj.first_open_date
-- 首开分期房间
and FIRST_OPEN_PERIOD.id is not null
then 1 
when room.SALE_STATE='签约'
-- 首开分期房间
and FIRST_OPEN_PERIOD.id is not null
--and proj.first_open_date<=build.GET_PRE_SALE_PERMIT_DATE 
and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30 then 1
else 0 end )  as "首开推售套数"




------全案------全案------全案------全案------全案------全案------全案 
------全案（已去化货值）: 
---------->房间“合同成交总价”
---------->房间“销售状态”=签约
,sum(case when room.SALE_STATE='签约' then room.TRADE_TOTAL else 0 end ) as "全案已去化货值"
------全案（已领证货值）：
---------->房间“面价标准总价”:在计算“货值去化率”时，对已签约房间（有可能出现优惠打折），分子分母均按“签约金额”计算“货值去化率”。
,sum(case when room.SALE_STATE='签约'  then room.TRADE_TOTAL  
when room.SALE_STATE<>'签约' and build.GET_PRE_SALE_PERMIT_DATE is not null then room.BZ_TOTAL else 0 end )  as "全案已领证货值"
------全案（已去化面积）:
---------->房间“最新建筑面积”
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约'  then room.NEW_BLD_AREA else 0 end ) as "全案已去化面积"
------全案（已领证面积）:
---------->房间“最新建筑面积”
,sum(case when room.SALE_STATE='签约' or build.GET_PRE_SALE_PERMIT_DATE is not null then room.NEW_BLD_AREA  else 0 end )  as "全案已领证面积"
------全案（已去化套数):
---------->房间“汇总”
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' then 1 else 0 end ) as "全案已去化套数"
------全案（已领证套数):
---------->房间“汇总”
,sum(case when room.SALE_STATE='签约' or build.GET_PRE_SALE_PERMIT_DATE is not null then 1 else 0 end )  as "全案已领证套数"
------现房------现房------现房------现房------现房------现房------现房------现房------现房
----现房去化面积
,sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE = '签约' and room.TRADE_CONTRACT_DATE>proj.COMPLETION_RECORD_DATE then  room.NEW_BLD_AREA else 0 end) as "现房去化面积" ,
----现房推售面积
sum(case when  proj.COMPLETION_RECORD_DATE is not null and   (room.SALE_STATE <> '签约'
or  (room.SALE_STATE = '签约' and room.TRADE_CONTRACT_DATE>proj.COMPLETION_RECORD_DATE) )   then room.NEW_BLD_AREA else 0 end) as 现房推售面积,
----现房去化金额
sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE = '签约' and room.TRADE_CONTRACT_DATE>proj.COMPLETION_RECORD_DATE then  room.TRADE_TOTAL else 0 end) as  现房去化金额,
--推售金额需要根据房间是否已经签约来判断取签约金额还是标准金额
----现房推售金额
sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE <> '签约'   then room.BZ_TOTAL  
when room.SALE_STATE = '签约' and proj.COMPLETION_RECORD_DATE is not null and  room.TRADE_CONTRACT_DATE>proj.COMPLETION_RECORD_DATE then room.TRADE_TOTAL else 0 end) as 现房推售金额,
----现房去化套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE = '签约' and room.TRADE_CONTRACT_DATE>proj.COMPLETION_RECORD_DATE then  1 else 0 end) as  现房去化套数,
----现房推售套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null and  (room.SALE_STATE <> '签约'
or  (room.SALE_STATE = '签约' and room.TRADE_CONTRACT_DATE>proj.COMPLETION_RECORD_DATE) )  then 1 else 0 end) as 现房推售套数
------顽固性库存------顽固性库存------顽固性库存------顽固性库存------顽固性库存------顽固性库存------顽固性库存
----顽固推售面积
,sum(case when  proj.COMPLETION_RECORD_DATE is not null  and room.SALE_STATE = '签约' and  room.PRODUCT_NAME <> '住宅' 
and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and room.TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd')
and room.TRADE_CONTRACT_DATE<sysdate then  room.NEW_BLD_AREA else 0 end) as 顽固去化面积,
----顽固去化面积
sum(case when  proj.COMPLETION_RECORD_DATE is not null  
and  room.PRODUCT_NAME <> '住宅' 
and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and ((TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and  room.TRADE_CONTRACT_DATE<sysdate  and room.SALE_STATE = '签约') or  room.SALE_STATE <> '签约') then room.NEW_BLD_AREA else 0 end) as 顽固推售面积,
----顽固去化金额
sum(case when  proj.COMPLETION_RECORD_DATE is not null  and room.SALE_STATE = '签约' 
and  room.PRODUCT_NAME <> '住宅' 
and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and room.TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd')
and  room.TRADE_CONTRACT_DATE<sysdate  then  room.TRADE_TOTAL else 0 end) as  顽固去化金额,
--推售金额需要根据房间是否已经签约来判断取签约金额还是标准金额
----顽固推售金额
sum(case  when  proj.COMPLETION_RECORD_DATE is not null  
and  room.PRODUCT_NAME <> '住宅'
and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and (TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and  room.TRADE_CONTRACT_DATE<sysdate  and room.SALE_STATE = '签约') then room.TRADE_TOTAL  --已经在今年签约的算签约金额
 when  proj.COMPLETION_RECORD_DATE is not null  and  room.PRODUCT_NAME <> '住宅' 
 and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
 and  room.SALE_STATE <> '签约' then room.BZ_TOTAL  else 0 end) as 顽固推售金额,  --未签约的算校准总价
----顽固去化套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null 
and room.SALE_STATE = '签约' 
and  room.PRODUCT_NAME <> '住宅' 
and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and room.TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and  room.TRADE_CONTRACT_DATE<sysdate then  1 else 0 end) as  顽固去化套数,
----顽固推售套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null  
and  room.PRODUCT_NAME <> '住宅' 
and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and ((TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and  room.TRADE_CONTRACT_DATE<sysdate  and room.SALE_STATE = '签约') or  room.SALE_STATE <> '签约') then 1 else 0 end) as 顽固推售套数
--------------------------------------------------基础计算字段结束

,proj.project_id,
proj.project_name,
proj.org_id,
proj.org_name,
proj.first_open_date,
proj.obtain_date,
proj.COMPLETION_RECORD_DATE,
proj.take_land_date,
proj.plan_first_open_date,
proj.first_open_duration_by_tl,
proj.first_open_duration_by_plan,
proj.new_plan_first_open_date,
proj.exhibition_area_open_date,
proj.plan_approval_date,
proj.is_operate,
proj.is_construction_began
,t_room.AREA_LEVEL
,t_room.PRODUCT_NAME 
from tmp_proj_base proj
left join MDM_ROOM room  on proj.project_id=room.project_id  and  proj.id = PROJ_BASE_SPID
left join TMP_ROOM t_room on  room.id=t_room.room_id
left join  mdm_build build on room.BUILDING_ID=build.id 
-- chenl 20200613 只取首开楼栋
left join  SYS_PROJECT_STAGE FIRST_OPEN_PERIOD on build.PERIOD_ID=FIRST_OPEN_PERIOD.id  
AND FIRST_OPEN_PERIOD.IS_FIRST_OPEN_PERIOD=1
group by proj.project_id
-------------------- 业态面积段特有 start
    ,t_room.AREA_LEVEL
    ,t_room.PRODUCT_NAME
----------------------业态面积段特有 end
    ,proj.project_name,
    proj.org_id,
    proj.org_name,
    proj.first_open_date,
    proj.obtain_date,
    proj.COMPLETION_RECORD_DATE,
    proj.take_land_date,
    proj.plan_first_open_date,
    proj.first_open_duration_by_tl,
    proj.first_open_duration_by_plan,
    proj.new_plan_first_open_date,
    proj.exhibition_area_open_date,
    proj.plan_approval_date,
    proj.is_operate,
    proj.is_construction_began
    ) result 
-------------------- 业态面积段特有 start
   where  PRODUCT_NAME  is not null
----------------------业态面积段特有 end
;

OPEN spid_info FOR select * from TMP_SALE_RATE_BY_GRANULARITY where id=spid;  
------------------------------------------------------数据移入历史表;
INSERT INTO  dwm_sale_rate_gran_history (
    id,
    project_id,
    fo_sale_out_count,
    fo_sale_count,
    fo_sale_rate_by_count,
    fo_sale_out_area,
    fo_sale_area,
    fo_sale_rate_by_area,
    fo_sale_out_money,
    fo_sale_money,
    fo_sale_rate_by_money,
    fo_surplus_sale_money,
    fo_sale_average_money,
    fo_sale_out_average_money,
    po_sale_out_count,
    po_sale_count,
    po_sale_rate_by_count,
    po_sale_out_area,
    po_sale_area,
    po_sale_rate_by_area,
    po_sale_out_money,
    po_sale_money,
    po_sale_rate_by_money,
    po_surplus_sale_money,
    po_sale_average_money,
    po_sale_out_average_money,
    eh_sale_out_count,
    eh_sale_count,
    eh_sale_rate_by_count,
    eh_sale_out_area,
    eh_sale_area,
    eh_sale_rate_by_area,
    eh_sale_out_money,
    eh_sale_money,
    eh_sale_rate_by_money,
    eh_surplus_sale_money,
    eh_sale_average_money,
    eh_sale_out_average_money,
    si_sale_out_count,
    si_sale_count,
    si_sale_rate_by_count,
    si_sale_out_area,
    si_sale_area,
    si_sale_rate_by_area,
    si_sale_out_money,
    si_sale_money,
    si_sale_rate_by_money,
    si_surplus_sale_money,
    si_sale_average_money,
    si_sale_out_average_money,
    parent_id,
    data_granularity,
    created,
    remark,
    sort
)
SELECT
    id,
    project_id,
    fo_sale_out_count,
    fo_sale_count,
    fo_sale_rate_by_count,
    fo_sale_out_area,
    fo_sale_area,
    fo_sale_rate_by_area,
    fo_sale_out_money,
    fo_sale_money,
    fo_sale_rate_by_money,
    fo_surplus_sale_money,
    fo_sale_average_money,
    fo_sale_out_average_money,
    po_sale_out_count,
    po_sale_count,
    po_sale_rate_by_count,
    po_sale_out_area,
    po_sale_area,
    po_sale_rate_by_area,
    po_sale_out_money,
    po_sale_money,
    po_sale_rate_by_money,
    po_surplus_sale_money,
    po_sale_average_money,
    po_sale_out_average_money,
    eh_sale_out_count,
    eh_sale_count,
    eh_sale_rate_by_count,
    eh_sale_out_area,
    eh_sale_area,
    eh_sale_rate_by_area,
    eh_sale_out_money,
    eh_sale_money,
    eh_sale_rate_by_money,
    eh_surplus_sale_money,
    eh_sale_average_money,
    eh_sale_out_average_money,
    si_sale_out_count,
    si_sale_count,
    si_sale_rate_by_count,
    si_sale_out_area,
    si_sale_area,
    si_sale_rate_by_area,
    si_sale_out_money,
    si_sale_money,
    si_sale_rate_by_money,
    si_surplus_sale_money,
    si_sale_average_money,
    si_sale_out_average_money,
    parent_id,
    data_granularity,
    created,
    remark,
    sort
FROM
    dwm_sale_rate_by_granularity;
commit;
------------------------------------------------------删除已移入历史表树；
DELETE FROM DWM_SALE_RATE_BY_GRANULARITY ;--where REMARK=dwm_REMARK;
commit;
--------------------------------------------------------新增拍照数据;
INSERT INTO DWM_SALE_RATE_BY_GRANULARITY (
ID---【1】主键
,sort
,PROJECT_ID---【2】项目ID
,FO_SALE_OUT_COUNT---【3】首开去化套数
,FO_SALE_COUNT---【4】首开推售套数
,FO_SALE_RATE_BY_COUNT---【5】首开去化率(按套数)（3/4）
,FO_SALE_OUT_AREA---【6】首开去化面积
,FO_SALE_AREA---【7】首开推售面积
,FO_SALE_RATE_BY_AREA---【8】首开去化率(按面积)（6/7）
,FO_SALE_OUT_MONEY---【9】首开去化货值
,FO_SALE_MONEY---【10】首开推售货值
,FO_SALE_RATE_BY_MONEY---【11】首开去化率(按货值)（9/10）
,FO_SURPLUS_SALE_MONEY---【12】首开剩余货值(10-9)
,FO_SALE_AVERAGE_MONEY---【13】首开标准均价(10/7)
,FO_SALE_OUT_AVERAGE_MONEY---【14】首开签约均价(9/6)
,PO_SALE_OUT_COUNT---【15】全案去化套数
,PO_SALE_COUNT---【16】全案推售套数
,PO_SALE_RATE_BY_COUNT---【17】全案去化率(按套数)(15/16)
,PO_SALE_OUT_AREA---【18】全案去化面积
,PO_SALE_AREA---【19】全案推售面积
,PO_SALE_RATE_BY_AREA---【20】全案去化率(按面积)(18/19)
,PO_SALE_OUT_MONEY---【21】全案去化货值
,PO_SALE_MONEY---【22】全案推售货值
,PO_SALE_RATE_BY_MONEY---【23】全案去化率(按货值)(21/22)
,PO_SURPLUS_SALE_MONEY---【24】全案剩余货值(22-21)
,PO_SALE_AVERAGE_MONEY---【25】全案标准均价(22/19)
,PO_SALE_OUT_AVERAGE_MONEY---【26】全案签约均价(21/18)
,EH_SALE_OUT_COUNT---【27】现房去化套数
,EH_SALE_COUNT---【28】现房推售套数
,EH_SALE_RATE_BY_COUNT---【29】现房去化率(按套数)(27/28)
,EH_SALE_OUT_AREA---【30】现房去化面积
,EH_SALE_AREA---【31】现房推售面积
,EH_SALE_RATE_BY_AREA---【32】现房去化率(按面积)(30/31)
,EH_SALE_OUT_MONEY---【33】现房去化货值
,EH_SALE_MONEY---【34】现房推售货值
,EH_SALE_RATE_BY_MONEY---【35】现房去化率(按货值)(33/34)
,EH_SURPLUS_SALE_MONEY---【36】现房剩余货值(34-33)
,EH_SALE_AVERAGE_MONEY---【37】现房标准均价(34/31)
,EH_SALE_OUT_AVERAGE_MONEY---【38】现房签约均价(33/30)
,SI_SALE_OUT_COUNT---【39】顽固性库存去化套数
,SI_SALE_COUNT---【40】顽固性库存推售套数
,SI_SALE_RATE_BY_COUNT---【41】顽固性库存去化率(按套数)(39/40)
,SI_SALE_OUT_AREA---【42】顽固性库存去化面积
,SI_SALE_AREA---【43】顽固性库存推售面积
,SI_SALE_RATE_BY_AREA---【44】顽固性库存去化率(按面积)(42/43)
,SI_SALE_OUT_MONEY---【45】顽固性库存去化货值
,SI_SALE_MONEY---【46】顽固性库存推售货值
,SI_SALE_RATE_BY_MONEY---【47】顽固性库存去化率(按货值)(45/46)
,SI_SURPLUS_SALE_MONEY---【48】顽固性库存剩余货值(46-45)
,SI_SALE_AVERAGE_MONEY---【49】顽固性库存标准均价(46/43)
,SI_SALE_OUT_AVERAGE_MONEY---【50】顽固性库存签约均价(45/42)
,PARENT_ID  
,DATA_GRANULARITY 
,CREATED---【51】创建日期
,REMARK---【52】备注信息
        )
   select  tree.GRANULARITY_ID--颗粒度id---【1】主键
   ,tree.sort
,tree.PROJECT_ID,---【2】项目ID
nvl(apdata.fo_sale_out_count,0),
nvl(apdata.fo_sale_count,0),
nvl(apdata.fo_sale_rate_by_count,0),
nvl(apdata.fo_sale_out_area,0),
nvl(apdata.fo_sale_area,0),
nvl(apdata.fo_sale_rate_by_area,0),
nvl(apdata.fo_sale_out_money,0),
nvl(apdata.fo_sale_money,0),
nvl(apdata.fo_sale_rate_by_money,0),
nvl(apdata.fo_surplus_sale_money,0),
nvl(apdata.fo_sale_average_money,0),
nvl(apdata.fo_sale_out_average_money,0),
nvl(apdata.po_sale_out_count,0),
nvl(apdata.po_sale_count,0),
nvl(apdata.po_sale_rate_by_count,0),
nvl(apdata.po_sale_out_area,0),
nvl(apdata.po_sale_area,0),
nvl(apdata.po_sale_rate_by_area,0),
nvl(apdata.po_sale_out_money,0),
nvl(apdata.po_sale_money,0),
nvl(apdata.po_sale_rate_by_money,0),
nvl(apdata.po_surplus_sale_money,0),
nvl(apdata.po_sale_average_money,0),
nvl(apdata.po_sale_out_average_money,0),
nvl(apdata.eh_sale_out_count,0),
nvl(apdata.eh_sale_count,0),
nvl(apdata.eh_sale_rate_by_count,0),
nvl(apdata.eh_sale_out_area,0),
nvl(apdata.eh_sale_area,0),
nvl(apdata.eh_sale_rate_by_area,0),
nvl(apdata.eh_sale_out_money,0),
nvl(apdata.eh_sale_money,0),
nvl(apdata.eh_sale_rate_by_money,0),
nvl(apdata.eh_surplus_sale_money,0),
nvl(apdata.eh_sale_average_money,0),
nvl(apdata.eh_sale_out_average_money,0),
nvl(apdata.si_sale_out_count,0),
nvl(apdata.si_sale_count,0),
nvl(apdata.si_sale_rate_by_count,0),
nvl(apdata.si_sale_out_area,0),
nvl(apdata.si_sale_area,0),
nvl(apdata.si_sale_rate_by_area,0),
nvl(apdata.si_sale_out_money,0),
nvl(apdata.si_sale_money,0),
nvl(apdata.si_sale_rate_by_money,0),
nvl(apdata.si_surplus_sale_money,0),
nvl(apdata.si_sale_average_money,0),
nvl(apdata.si_sale_out_average_money,0)
,tree.PARENT_ID---父级id
,tree.DATA_GRANULARITY--颗粒度名称
,sys_created
,dwm_REMARK
from 
( select * from TMP_SALE_RATE_BY_GRANULARITY where id=spid_tree) tree
left join 
( 
    select  parent_id||data_granularity as id,
    project_id,
    fo_sale_out_count,
    fo_sale_count,
    fo_sale_rate_by_count,
    fo_sale_out_area,
    fo_sale_area,
    fo_sale_rate_by_area,
    fo_sale_out_money,
    fo_sale_money,
    fo_sale_rate_by_money,
    fo_surplus_sale_money,
    fo_sale_average_money,
    fo_sale_out_average_money,
    po_sale_out_count,
    po_sale_count,
    po_sale_rate_by_count,
    po_sale_out_area,
    po_sale_area,
    po_sale_rate_by_area,
    po_sale_out_money,
    po_sale_money,
    po_sale_rate_by_money,
    po_surplus_sale_money,
    po_sale_average_money,
    po_sale_out_average_money,
    eh_sale_out_count,
    eh_sale_count,
    eh_sale_rate_by_count,
    eh_sale_out_area,
    eh_sale_area,
    eh_sale_rate_by_area,
    eh_sale_out_money,
    eh_sale_money,
    eh_sale_rate_by_money,
    eh_surplus_sale_money,
    eh_sale_average_money,
    eh_sale_out_average_money,
    si_sale_out_count,
    si_sale_count,
    si_sale_rate_by_count,
    si_sale_out_area,
    si_sale_area,
    si_sale_rate_by_area,
    si_sale_out_money,
    si_sale_money,
    si_sale_rate_by_money,
    si_surplus_sale_money,
    si_sale_average_money,
    si_sale_out_average_money
 from  TMP_SALE_RATE_BY_GRANULARITY where id=spid
union all 
select  project_id||PRODUCT_NAME
,project_id,
sum(FO_SALE_OUT_COUNT),--【3】首开去化套数
sum(FO_SALE_COUNT),--【4】首开推售套数 
case when sum(FO_SALE_COUNT)=0 then 0 else  round(sum(FO_SALE_OUT_COUNT)/sum(FO_SALE_COUNT),4) end,--【5】首开去化率(按套数)（3/4）
sum(FO_SALE_OUT_AREA),--【6】首开去化面积
sum(FO_SALE_AREA),--【7】首开推售面积
case when sum(FO_SALE_AREA)=0 then 0 else  round(sum(FO_SALE_OUT_AREA)/sum(FO_SALE_AREA),4) end,--【8】首开去化率(按面积)（6/7）
sum(FO_SALE_OUT_MONEY),--【9】首开去化货值
sum(FO_SALE_MONEY),--【10】首开推售货值
case when sum(FO_SALE_MONEY)=0 then 0 else  round(sum(FO_SALE_OUT_MONEY)/sum(FO_SALE_MONEY),4) end,--【11】首开去化率(按货值)（9/10）
sum(FO_SURPLUS_SALE_MONEY),--【12】首开剩余货值(10-9)
case when sum(FO_SALE_AREA)=0 then 0 else  round(sum(FO_SALE_MONEY)/sum(FO_SALE_AREA),4) end,--【13】首开标准均价(10/7)
case when sum(FO_SALE_OUT_AREA)=0 then 0 else  round(sum(FO_SALE_OUT_MONEY)/sum(FO_SALE_OUT_AREA),4) end,--【14】首开签约均价(9/6)
sum(PO_SALE_OUT_COUNT),--【15】全案去化套数
sum(PO_SALE_COUNT),--【16】全案推售套数
case when sum(PO_SALE_COUNT)=0 then 0 else  round(sum(PO_SALE_OUT_COUNT)/sum(PO_SALE_COUNT),4) end,--【17】全案去化率(按套数)(15/16)
sum(PO_SALE_OUT_AREA),--【18】全案去化面积
sum(PO_SALE_AREA),--【19】全案推售面积
case when sum(PO_SALE_AREA)=0 then 0 else  round(sum(PO_SALE_OUT_AREA)/sum(PO_SALE_AREA),4) end,--【20】全案去化率(按面积)(18/19)
sum(PO_SALE_OUT_MONEY),--【21】全案去化货值
sum(PO_SALE_MONEY),--【22】全案推售货值
case when sum(PO_SALE_MONEY)=0 then 0 else  round(sum(PO_SALE_OUT_MONEY)/sum(PO_SALE_MONEY),4) end,--【23】全案去化率(按货值)(21/22)
sum(PO_SURPLUS_SALE_MONEY),--【24】全案剩余货值(22-21)
case when sum(PO_SALE_AREA)=0 then 0 else  round(sum(PO_SALE_MONEY)/sum(PO_SALE_AREA),4) end,--【25】全案标准均价(22/19)
case when sum(PO_SALE_OUT_AREA)=0 then 0 else  round(sum(PO_SALE_OUT_MONEY)/sum(PO_SALE_OUT_AREA),4) end,--【26】全案签约均价(21/18)
sum(EH_SALE_OUT_COUNT),--【27】现房去化套数
sum(EH_SALE_COUNT),--【28】现房推售套数
case when sum(EH_SALE_COUNT)=0 then 0 else  round(sum(EH_SALE_OUT_COUNT)/sum(EH_SALE_COUNT),4) end,--【29】现房去化率(按套数)(27/28)
sum(EH_SALE_OUT_AREA),--【30】现房去化面积
sum(EH_SALE_AREA),--【31】现房推售面积
case when sum(EH_SALE_AREA)=0 then 0 else  round(sum(EH_SALE_OUT_AREA)/sum(EH_SALE_AREA),4) end,--【32】现房去化率(按面积)(30/31)
sum(EH_SALE_OUT_MONEY),--【33】现房去化货值
sum(EH_SALE_MONEY),--【34】现房推售货值
case when sum(EH_SALE_MONEY)=0 then 0 else  round(sum(EH_SALE_OUT_MONEY)/sum(EH_SALE_MONEY),4) end,--【35】现房去化率(按货值)(33/34)
sum(EH_SURPLUS_SALE_MONEY),--【36】现房剩余货值(34-33)
case when sum(EH_SALE_AREA)=0 then 0 else  round(sum(EH_SALE_MONEY)/sum(EH_SALE_AREA),4) end,--【37】现房标准均价(34/31)
case when sum(EH_SALE_OUT_AREA)=0 then 0 else  round(sum(EH_SALE_OUT_MONEY)/sum(EH_SALE_OUT_AREA),4) end,--【38】现房签约均价(33/30)
sum(SI_SALE_OUT_COUNT),--【39】顽固性库存去化套数
sum(SI_SALE_COUNT),--【40】顽固性库存推售套数
case when sum(SI_SALE_COUNT)=0 then 0 else  round(sum(SI_SALE_OUT_COUNT)/sum(SI_SALE_COUNT),4) end,--【41】顽固性库存去化率(按套数)(39/40)
sum(SI_SALE_OUT_AREA),--【42】顽固性库存去化面积
sum(SI_SALE_AREA),--【43】顽固性库存推售面积
case when sum(SI_SALE_AREA)=0 then 0 else  round(sum(SI_SALE_OUT_AREA)/sum(SI_SALE_AREA),4) end,--【44】顽固性库存去化率(按面积)(42/43)
sum(SI_SALE_OUT_MONEY),--【45】顽固性库存去化货值
sum(SI_SALE_MONEY),--【46】顽固性库存推售货值
case when sum(SI_SALE_MONEY)=0 then 0 else  round(sum(SI_SALE_OUT_MONEY)/sum(SI_SALE_MONEY),4) end,--【47】顽固性库存去化率(按货值)(45/46)
sum(SI_SURPLUS_SALE_MONEY),--【48】顽固性库存剩余货值(46-45)
case when sum(SI_SALE_AREA)=0 then 0 else  round(sum(SI_SALE_MONEY)/sum(SI_SALE_AREA),4) end,--【49】顽固性库存标准均价(46/43)
case when sum(SI_SALE_OUT_AREA)=0 then 0 else  round(sum(SI_SALE_OUT_MONEY)/sum(SI_SALE_OUT_AREA),4) end--【50】顽固性库存签约均价(45/42)
 from  TMP_SALE_RATE_BY_GRANULARITY where id=spid group by project_id,
 parent_id,PRODUCT_NAME) apdata  
on tree.GRANULARITY_ID=apdata.id order by apdata.project_id;
commit;

END P_DWM_SALE_RATE_BY_GRANULARITY;
--=================================================================定时任务结束================================================================
/

prompt
prompt Creating procedure P_DWM_SALE_RATE_BY_PROJ
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_DWM_SALE_RATE_BY_PROJ" (
    IS_PHOTOGRAPH in number:=0,
    proj_SPID  out NVARCHAR2
--    ,SALE_RATE_BY_PROJECT out SYS_REFCURSOR
    
) AS
		--项目颗粒度去化率拍照；作用=》定时拍照
        --调用范围=》P_DWM_SALE_RATE_BY_ORG
		--作者：陈丽
		--日期：2020-04-10
  PROJ_BASE_INFO SYS_REFCURSOR;
  PROJ_DATE_INFO SYS_REFCURSOR;
  PROJ_BASE_SPID VARCHAR2(2000);
  sys_created date:=sysdate;
  spid VARCHAR2(360); --使用临时表的批次号
  dwm_REMARK VARCHAR2(200):='测试-chenl';
BEGIN
delete TMP_SALE_RATE_BY_PROJECT;
commit;
--------创建临时表批次号
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;  
proj_SPID:=spid;
------项目基本信息
BEGIN

  P_DWM_SALE_RATE_PROJ(0,
    PROJ_BASE_SPID => PROJ_BASE_SPID
  );
    END;
 ----- 
 INSERT INTO TMP_SALE_RATE_BY_PROJECT (ID---【1】主键
,PROJECT_ID---【2】项目ID
,PROJECT_NAME
,ORG_ID
,ORG_NAME
,FO_SALE_OUT_COUNT---【3】首开去化套数
,FO_SALE_COUNT---【4】首开推售套数
,FO_SALE_RATE_BY_COUNT---【5】首开去化率(按套数)（3/4）
,FO_SALE_OUT_AREA---【6】首开去化面积
,FO_SALE_AREA---【7】首开推售面积
,FO_SALE_RATE_BY_AREA---【8】首开去化率(按面积)（6/7）
,FO_SALE_OUT_MONEY---【9】首开去化货值
,FO_SALE_MONEY---【10】首开推售货值
,FO_SALE_RATE_BY_MONEY---【11】首开去化率(按货值)（9/10）
,FO_SURPLUS_SALE_MONEY---【12】首开剩余货值(10-9)
,FO_SALE_AVERAGE_MONEY---【13】首开标准均价(10/7)
,FO_SALE_OUT_AVERAGE_MONEY---【14】首开签约均价(9/6)
,PO_SALE_OUT_COUNT---【15】全案去化套数
,PO_SALE_COUNT---【16】全案推售套数
,PO_SALE_RATE_BY_COUNT---【17】全案去化率(按套数)(15/16)
,PO_SALE_OUT_AREA---【18】全案去化面积
,PO_SALE_AREA---【19】全案推售面积
,PO_SALE_RATE_BY_AREA---【20】全案去化率(按面积)(18/19)
,PO_SALE_OUT_MONEY---【21】全案去化货值
,PO_SALE_MONEY---【22】全案推售货值
,PO_SALE_RATE_BY_MONEY---【23】全案去化率(按货值)(21/22)
,PO_SURPLUS_SALE_MONEY---【24】全案剩余货值(22-21)
,PO_SALE_AVERAGE_MONEY---【25】全案标准均价(22/19)
,PO_SALE_OUT_AVERAGE_MONEY---【26】全案签约均价(21/18)
,EH_SALE_OUT_COUNT---【27】现房去化套数
,EH_SALE_COUNT---【28】现房推售套数
,EH_SALE_RATE_BY_COUNT---【29】现房去化率(按套数)(27/28)
,EH_SALE_OUT_AREA---【30】现房去化面积
,EH_SALE_AREA---【31】现房推售面积
,EH_SALE_RATE_BY_AREA---【32】现房去化率(按面积)(30/31)
,EH_SALE_OUT_MONEY---【33】现房去化货值
,EH_SALE_MONEY---【34】现房推售货值
,EH_SALE_RATE_BY_MONEY---【35】现房去化率(按货值)(33/34)
,EH_SURPLUS_SALE_MONEY---【36】现房剩余货值(34-33)
,EH_SALE_AVERAGE_MONEY---【37】现房标准均价(34/31)
,EH_SALE_OUT_AVERAGE_MONEY---【38】现房签约均价(33/30)
,SI_SALE_OUT_COUNT---【39】顽固性库存去化套数
,SI_SALE_COUNT---【40】顽固性库存推售套数
,SI_SALE_RATE_BY_COUNT---【41】顽固性库存去化率(按套数)(39/40)
,SI_SALE_OUT_AREA---【42】顽固性库存去化面积
,SI_SALE_AREA---【43】顽固性库存推售面积
,SI_SALE_RATE_BY_AREA---【44】顽固性库存去化率(按面积)(42/43)
,SI_SALE_OUT_MONEY---【45】顽固性库存去化货值
,SI_SALE_MONEY---【46】顽固性库存推售货值
,SI_SALE_RATE_BY_MONEY---【47】顽固性库存去化率(按货值)(45/46)
,SI_SURPLUS_SALE_MONEY---【48】顽固性库存剩余货值(46-45)
,SI_SALE_AVERAGE_MONEY---【49】顽固性库存标准均价(46/43)
,SI_SALE_OUT_AVERAGE_MONEY---【50】顽固性库存签约均价(45/42)
,CREATED---【51】创建日期
)select 
spid as ID---【1】主键
,project_id as PROJECT_ID---【2】项目ID
,project_name
,ORG_ID
,ORG_NAME
-----------------------------------K1、首开去化率开始--------------------
,"首开去化套数" as FO_SALE_OUT_COUNT---【3】首开去化套数
,"首开推售套数" as FO_SALE_COUNT---【4】首开推售套数
,case when 首开推售套数=0 then 0 else round("首开去化套数"/"首开推售套数",4)  end as FO_SALE_RATE_BY_COUNT---【5】首开去化率(按套数)（3/4）
,"首开去化面积" as FO_SALE_OUT_AREA---【6】首开去化面积
,"首开推售面积" as FO_SALE_AREA---【7】首开推售面积
,case when 首开推售面积=0 then 0 else round("首开去化面积"/"首开推售面积",4)  end as FO_SALE_RATE_BY_AREA---【8】首开去化率(按面积)（6/7）
,"首开去化货值" as FO_SALE_OUT_MONEY---【9】首开去化货值
,"首开推售货值" as FO_SALE_MONEY---【10】首开推售货值
,case when 首开推售货值=0 then 0 else round("首开去化货值"/"首开推售货值",4)  end as FO_SALE_RATE_BY_MONEY---【11】首开去化率(按货值)（9/10）
,"首开推售货值"-"首开去化货值" as FO_SURPLUS_SALE_MONEY---【12】首开剩余货值(10-9)
,case when 首开推售面积=0 then 0 else round("首开推售货值"/"首开推售面积",4)  end  as FO_SALE_AVERAGE_MONEY---【13】首开标准均价(10/7)
,case when 首开去化面积=0 then 0 else round("首开去化货值"/"首开去化面积",4)  end as FO_SALE_OUT_AVERAGE_MONEY---【14】首开签约均价(9/6)
-----------------------------------K3、全案去化率 （单位：%）--------------------
,"全案已去化套数" as PO_SALE_OUT_COUNT---【15】全案去化套数
,"全案已领证套数" as PO_SALE_COUNT---【16】全案推售套数
,case when 全案已领证套数=0 then 0 else round("全案已去化套数"/"全案已领证套数",4)  end as PO_SALE_RATE_BY_COUNT---【17】全案去化率(按套数)(15/16)
,"全案已去化面积" as PO_SALE_OUT_AREA---【18】全案去化面积
,"全案已领证面积" as PO_SALE_AREA---【19】全案推售面积
,case when 全案已领证面积=0 then 0 else round("全案已去化面积"/"全案已领证面积",4)  end as PO_SALE_RATE_BY_AREA---【20】全案去化率(按面积)(18/19)
,"全案已去化货值" as PO_SALE_OUT_MONEY---【21】全案去化货值
,"全案已领证货值" as PO_SALE_MONEY---【22】全案推售货值
,case when 全案已领证货值=0 then 0 else round("全案已去化货值"/"全案已领证货值",4)  end  as PO_SALE_RATE_BY_MONEY---【23】全案去化率(按货值)(21/22)
,"全案已领证货值"-"全案已去化货值" as PO_SURPLUS_SALE_MONEY---【24】全案剩余货值(22-21)
,case when 全案已领证面积=0 then 0 else round("全案已领证货值"/"全案已领证面积",4)  end  as PO_SALE_AVERAGE_MONEY---【25】全案标准均价(22/19)
,case when 全案已去化面积=0 then 0 else round("全案已去化货值"/"全案已去化面积",4)  end   PO_SALE_OUT_AVERAGE_MONEY---【26】全案签约均价(21/18)
-----------------------------------K4、现房去化率 （单位：%）--------------------
,"现房去化套数" as EH_SALE_OUT_COUNT---【27】现房去化套数
,"现房推售套数" as EH_SALE_COUNT---【28】现房推售套数
,case when 现房推售套数=0 then 0 else  round("现房去化套数"/"现房推售套数",4) end as EH_SALE_RATE_BY_COUNT---【29】现房去化率(按套数)(27/28)
,"现房去化面积" as EH_SALE_OUT_AREA---【30】现房去化面积
,"现房推售面积" as EH_SALE_AREA---【31】现房推售面积
,case when 现房推售面积=0 then 0 else  round("现房去化面积"/"现房推售面积",4) end as EH_SALE_RATE_BY_AREA---【32】现房去化率(按面积)(30/31)
,"现房去化金额" as EH_SALE_OUT_MONEY---【33】现房去化货值
,"现房推售金额" as EH_SALE_MONEY---【34】现房推售货值
,case when 现房推售金额=0 then 0 else  round("现房去化金额"/"现房推售金额",4) end as EH_SALE_RATE_BY_MONEY---【35】现房去化率(按货值)(33/34)
,"现房推售金额"-"现房去化金额" as EH_SURPLUS_SALE_MONEY---【36】现房剩余货值(34-33)
,case when 现房推售面积=0 then 0 else  round("现房推售金额"/"现房推售面积",4) end  as EH_SALE_AVERAGE_MONEY---【37】现房标准均价(34/31)
,case when 现房去化面积=0 then 0 else  round("现房去化金额"/"现房去化面积",4) end  as EH_SALE_OUT_AVERAGE_MONEY---【38】现房签约均价(33/30)
-----------------------------------K5、顽固性库存去化率 （单位：%）--------------------
,"顽固去化套数" as SI_SALE_OUT_COUNT---【39】顽固性库存去化套数
,"顽固推售套数" as SI_SALE_COUNT---【40】顽固性库存推售套数
,case when 顽固推售套数=0 then 0 else  round("顽固去化套数"/"顽固推售套数",4) end as SI_SALE_RATE_BY_COUNT---【41】顽固性库存去化率(按套数)(39/40)
,"顽固去化面积" as SI_SALE_OUT_AREA---【42】顽固性库存去化面积
,"顽固推售面积" as SI_SALE_AREA---【43】顽固性库存推售面积
,case when 顽固推售面积=0 then 0 else  round("顽固去化面积"/"顽固推售面积",4) end  as SI_SALE_RATE_BY_AREA---【44】顽固性库存去化率(按面积)(42/43)
,"顽固去化金额" as SI_SALE_OUT_MONEY---【45】顽固性库存去化货值
,"顽固推售金额" as SI_SALE_MONEY---【46】顽固性库存推售货值
,case when 顽固推售金额=0 then 0 else  round("顽固去化金额"/"顽固推售金额",4) end as SI_SALE_RATE_BY_MONEY---【47】顽固性库存去化率(按货值)(45/46)
,"顽固推售金额"-"顽固去化金额" SI_SURPLUS_SALE_MONEY---【48】顽固性库存剩余货值(46-45)
,case when 顽固推售面积=0 then 0 else  round("顽固推售金额"/"顽固推售面积",4) end as SI_SALE_AVERAGE_MONEY---【49】顽固性库存标准均价(46/43)
,case when 顽固推售面积=0 then 0 else  round("顽固去化金额"/"顽固推售面积",4) end as SI_SALE_OUT_AVERAGE_MONEY---【50】顽固性库存签约均价(45/42)
,sys_created as CREATED---【51】创建日期
from 
(select 
--------------------------------------------------基础计算字段开始
------首次开盘30天内的签约金额（首开去化货值）: 
---------->房间“合同成交总价”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约
sum(case when room.SALE_STATE='签约' 
-- 首开分期房间
and FIRST_OPEN_PERIOD.id is not null
--and proj.first_open_date<=build.GET_PRE_SALE_PERMIT_DATE
and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30 then room.TRADE_TOTAL else 0 end ) as "首开去化货值"
------首次开盘已取证货值（首开推售货值）：
---------->房间“面价标准总价”:在计算“货值去化率”时，对已签约房间（有可能出现优惠打折），分子分母均按“签约金额”计算“货值去化率”。
---------->房间所属“楼栋预售许可证获取日期”<"项目开盘"的实际完成日期 
,sum(case when room.SALE_STATE='签约'
-- 首开分期房间
and FIRST_OPEN_PERIOD.id is not null
--and build.GET_PRE_SALE_PERMIT_DATE<=proj.first_open_date 
and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30
then room.TRADE_TOTAL 
when build.GET_PRE_SALE_PERMIT_DATE<=proj.first_open_date
-- 首开分期房间
and FIRST_OPEN_PERIOD.id is not null
then room.BZ_TOTAL else 0 end )  as "首开推售货值"
------首次开盘30天内的签约面积（首开去化面积）:
---------->房间“最新建筑面积”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' 
-- 首开分期房间
and FIRST_OPEN_PERIOD.id is not null
--and proj.first_open_date<=build.GET_PRE_SALE_PERMIT_DATE 
and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30  then room.NEW_BLD_AREA else 0 end ) as "首开去化面积"
------首次开盘的已取证面积（首开推售面积）:
---------->房间“最新建筑面积”
---------->房间所属“楼栋预售许可证获取日期”<"项目开盘"的实际完成日期 
,sum(case when build.GET_PRE_SALE_PERMIT_DATE<=proj.first_open_date 
-- 首开分期房间
and FIRST_OPEN_PERIOD.id is not null then room.NEW_BLD_AREA 
when room.SALE_STATE='签约' 
-- 首开分期房间
and FIRST_OPEN_PERIOD.id is not null
--and proj.first_open_date<=build.GET_PRE_SALE_PERMIT_DATE 
and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30  then room.NEW_BLD_AREA 
else 0 end )  as "首开推售面积"
------首次开盘30天内的签约套数（首开去化套数）:
---------->房间“汇总”
---------->"项目开盘"的实际完成日期 <合同签约日期<"项目开盘"的实际完成日期 +30天
---------->房间“销售状态”=签约  
--,sum(case when room.SALE_STATE='签约' and proj.first_open_date<=build.GET_PRE_SALE_PERMIT_DATE           and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30 then 1 else 0 end ) as "首开去化套数"
,sum(case when room.SALE_STATE='签约' 
-- 首开分期房间
and FIRST_OPEN_PERIOD.id is not null
          --and proj.first_open_date<=build.GET_PRE_SALE_PERMIT_DATE 
and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30 then 1 else 0 end ) as "首开去化套数"
------首次开盘的已取证套数（首开推售套数）:
---------->房间“汇总”
---------->房间所属“楼栋预售许可证获取日期”<"项目开盘"的实际完成日期 
--原来统计逻辑
--,sum(case when build.GET_PRE_SALE_PERMIT_DATE<proj.first_open_date then 1 else 0 end )  as "首开推售套数"
,sum(case when build.GET_PRE_SALE_PERMIT_DATE<=proj.first_open_date
-- 首开分期房间
and FIRST_OPEN_PERIOD.id is not null
then 1 
when room.SALE_STATE='签约'
-- 首开分期房间
and FIRST_OPEN_PERIOD.id is not null
--and proj.first_open_date<=build.GET_PRE_SALE_PERMIT_DATE 
and room.TRADE_CONTRACT_DATE<=proj.first_open_date +30 then 1
else 0 end )  as "首开推售套数"




------全案------全案------全案------全案------全案------全案------全案 
------全案（已去化货值）: 
---------->房间“合同成交总价”
---------->房间“销售状态”=签约
,sum(case when room.SALE_STATE='签约' then room.TRADE_TOTAL else 0 end ) as "全案已去化货值"
------全案（已领证货值）：
---------->房间“面价标准总价”:在计算“货值去化率”时，对已签约房间（有可能出现优惠打折），分子分母均按“签约金额”计算“货值去化率”。
,sum(case when room.SALE_STATE='签约'  then room.TRADE_TOTAL  
when room.SALE_STATE<>'签约' and build.GET_PRE_SALE_PERMIT_DATE is not null then room.BZ_TOTAL else 0 end )  as "全案已领证货值"
------全案（已去化面积）:
---------->房间“最新建筑面积”
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约'  then room.NEW_BLD_AREA else 0 end ) as "全案已去化面积"
------全案（已领证面积）:
---------->房间“最新建筑面积”
,sum(case when room.SALE_STATE='签约' or build.GET_PRE_SALE_PERMIT_DATE is not null then room.NEW_BLD_AREA  else 0 end )  as "全案已领证面积"
------全案（已去化套数):
---------->房间“汇总”
---------->房间“销售状态”=签约  
,sum(case when room.SALE_STATE='签约' then 1 else 0 end ) as "全案已去化套数"
------全案（已领证套数):
---------->房间“汇总”
,sum(case when room.SALE_STATE='签约' or build.GET_PRE_SALE_PERMIT_DATE is not null then 1 else 0 end )  as "全案已领证套数"
------现房------现房------现房------现房------现房------现房------现房------现房------现房
----现房去化面积
,sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE = '签约' and room.TRADE_CONTRACT_DATE>proj.COMPLETION_RECORD_DATE then  room.NEW_BLD_AREA else 0 end) as "现房去化面积" ,
----现房推售面积
sum(case when  proj.COMPLETION_RECORD_DATE is not null and   (room.SALE_STATE <> '签约'
or  (room.SALE_STATE = '签约' and room.TRADE_CONTRACT_DATE>proj.COMPLETION_RECORD_DATE) )   then room.NEW_BLD_AREA else 0 end) as 现房推售面积,
----现房去化金额
sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE = '签约' and room.TRADE_CONTRACT_DATE>proj.COMPLETION_RECORD_DATE then  room.TRADE_TOTAL else 0 end) as  现房去化金额,
--推售金额需要根据房间是否已经签约来判断取签约金额还是标准金额
----现房推售金额
sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE <> '签约'   then room.BZ_TOTAL  
when room.SALE_STATE = '签约' and proj.COMPLETION_RECORD_DATE is not null and  room.TRADE_CONTRACT_DATE>proj.COMPLETION_RECORD_DATE then room.TRADE_TOTAL else 0 end) as 现房推售金额,
----现房去化套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null and room.SALE_STATE = '签约' and room.TRADE_CONTRACT_DATE>proj.COMPLETION_RECORD_DATE then  1 else 0 end) as  现房去化套数,
----现房推售套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null and  (room.SALE_STATE <> '签约'
or  (room.SALE_STATE = '签约' and room.TRADE_CONTRACT_DATE>proj.COMPLETION_RECORD_DATE) )  then 1 else 0 end) as 现房推售套数
------顽固性库存------顽固性库存------顽固性库存------顽固性库存------顽固性库存------顽固性库存------顽固性库存
----顽固推售面积
,sum(case when  proj.COMPLETION_RECORD_DATE is not null  and room.SALE_STATE = '签约' and  room.PRODUCT_NAME <> '住宅' 
and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and room.TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd')
and room.TRADE_CONTRACT_DATE<sysdate then  room.NEW_BLD_AREA else 0 end) as 顽固去化面积,
----顽固去化面积
sum(case when  proj.COMPLETION_RECORD_DATE is not null  
and  room.PRODUCT_NAME <> '住宅' 
and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and ((TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and  room.TRADE_CONTRACT_DATE<sysdate  and room.SALE_STATE = '签约') or  room.SALE_STATE <> '签约') then room.NEW_BLD_AREA else 0 end) as 顽固推售面积,
----顽固去化金额
sum(case when  proj.COMPLETION_RECORD_DATE is not null  and room.SALE_STATE = '签约' 
and  room.PRODUCT_NAME <> '住宅' 
and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and room.TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd')
and  room.TRADE_CONTRACT_DATE<sysdate  then  room.TRADE_TOTAL else 0 end) as  顽固去化金额,
--推售金额需要根据房间是否已经签约来判断取签约金额还是标准金额
----顽固推售金额
sum(case  when  proj.COMPLETION_RECORD_DATE is not null  
and  room.PRODUCT_NAME <> '住宅'
and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and (TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and  room.TRADE_CONTRACT_DATE<sysdate  and room.SALE_STATE = '签约') then room.TRADE_TOTAL  --已经在今年签约的算签约金额
 when  proj.COMPLETION_RECORD_DATE is not null  and  room.PRODUCT_NAME <> '住宅' 
 and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
 and  room.SALE_STATE <> '签约' then room.BZ_TOTAL  else 0 end) as 顽固推售金额,  --未签约的算校准总价
----顽固去化套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null 
and room.SALE_STATE = '签约' 
and  room.PRODUCT_NAME <> '住宅' 
and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and room.TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and  room.TRADE_CONTRACT_DATE<sysdate then  1 else 0 end) as  顽固去化套数,
----顽固推售套数
sum(case when  proj.COMPLETION_RECORD_DATE is not null  
and  room.PRODUCT_NAME <> '住宅' 
and proj.COMPLETION_RECORD_DATE<to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and ((TRADE_CONTRACT_DATE>to_date(extract(year from sysdate)||'-01-01','yy-mm-dd') 
and  room.TRADE_CONTRACT_DATE<sysdate  and room.SALE_STATE = '签约') or  room.SALE_STATE <> '签约') then 1 else 0 end) as 顽固推售套数
--------------------------------------------------基础计算字段结束
,proj.project_id,
proj.project_name,
proj.org_id,
proj.org_name,
proj.first_open_date,
proj.obtain_date,
proj.COMPLETION_RECORD_DATE,
proj.take_land_date,
proj.plan_first_open_date,
proj.first_open_duration_by_tl,
proj.first_open_duration_by_plan,
proj.new_plan_first_open_date,
proj.exhibition_area_open_date,
proj.plan_approval_date,
proj.is_operate,
proj.is_construction_began
from tmp_proj_base proj left join  MDM_ROOM room  
on proj.project_id=room.project_id  and  proj.id = PROJ_BASE_SPID
left join  mdm_build build on room.BUILDING_ID=build.id 
-- chenl 20200613 只取首开楼栋
left join  SYS_PROJECT_STAGE FIRST_OPEN_PERIOD on build.PERIOD_ID=FIRST_OPEN_PERIOD.id  
AND FIRST_OPEN_PERIOD.IS_FIRST_OPEN_PERIOD=1
group by proj.project_id
    ,proj.project_name,
    proj.org_id,
    proj.org_name,
    proj.first_open_date,
    proj.obtain_date,
    proj.COMPLETION_RECORD_DATE,
    proj.take_land_date,
    proj.plan_first_open_date,
    proj.first_open_duration_by_tl,
    proj.first_open_duration_by_plan,
    proj.new_plan_first_open_date,
    proj.exhibition_area_open_date,
    proj.plan_approval_date,
    proj.is_operate,
    proj.is_construction_began) result  order by "全案已去化货值" asc
;

-- 
IF is_photograph <> 0 THEN
----先将表数据移入，历史的项目数据，后插入新的数据
------------------------------------------------------数据移入历史表;
INSERT INTO dwm_sale_rate_by_proj_history (
    id,
    project_id,
    fo_sale_out_count,
    fo_sale_count,
    fo_sale_rate_by_count,
    fo_sale_out_area,
    fo_sale_area,
    fo_sale_rate_by_area,
    fo_sale_out_money,
    fo_sale_money,
    fo_sale_rate_by_money,
    fo_surplus_sale_money,
    fo_sale_average_money,
    fo_sale_out_average_money,
    po_sale_out_count,
    po_sale_count,
    po_sale_rate_by_count,
    po_sale_out_area,
    po_sale_area,
    po_sale_rate_by_area,
    po_sale_out_money,
    po_sale_money,
    po_sale_rate_by_money,
    po_surplus_sale_money,
    po_sale_average_money,
    po_sale_out_average_money,
    eh_sale_out_count,
    eh_sale_count,
    eh_sale_rate_by_count,
    eh_sale_out_area,
    eh_sale_area,
    eh_sale_rate_by_area,
    eh_sale_out_money,
    eh_sale_money,
    eh_sale_rate_by_money,
    eh_surplus_sale_money,
    eh_sale_average_money,
    eh_sale_out_average_money,
    si_sale_out_count,
    si_sale_count,
    si_sale_rate_by_count,
    si_sale_out_area,
    si_sale_area,
    si_sale_rate_by_area,
    si_sale_out_money,
    si_sale_money,
    si_sale_rate_by_money,
    si_surplus_sale_money,
    si_sale_average_money,
    si_sale_out_average_money,
    created,
    remark
)
SELECT
    id,
    project_id,
    fo_sale_out_count,
    fo_sale_count,
    fo_sale_rate_by_count,
    fo_sale_out_area,
    fo_sale_area,
    fo_sale_rate_by_area,
    fo_sale_out_money,
    fo_sale_money,
    fo_sale_rate_by_money,
    fo_surplus_sale_money,
    fo_sale_average_money,
    fo_sale_out_average_money,
    po_sale_out_count,
    po_sale_count,
    po_sale_rate_by_count,
    po_sale_out_area,
    po_sale_area,
    po_sale_rate_by_area,
    po_sale_out_money,
    po_sale_money,
    po_sale_rate_by_money,
    po_surplus_sale_money,
    po_sale_average_money,
    po_sale_out_average_money,
    eh_sale_out_count,
    eh_sale_count,
    eh_sale_rate_by_count,
    eh_sale_out_area,
    eh_sale_area,
    eh_sale_rate_by_area,
    eh_sale_out_money,
    eh_sale_money,
    eh_sale_rate_by_money,
    eh_surplus_sale_money,
    eh_sale_average_money,
    eh_sale_out_average_money,
    si_sale_out_count,
    si_sale_count,
    si_sale_rate_by_count,
    si_sale_out_area,
    si_sale_area,
    si_sale_rate_by_area,
    si_sale_out_money,
    si_sale_money,
    si_sale_rate_by_money,
    si_surplus_sale_money,
    si_sale_average_money,
    si_sale_out_average_money,
    created,
    remark
FROM
    dwm_sale_rate_by_proj_history;
commit;
------------------------------------------------------删除已移入历史表树；
DELETE FROM DWM_SALE_RATE_BY_PROJECT ;
    --where REMARK=dwm_REMARK;
commit;
--------------------------------------------------------新增拍照数据;
INSERT INTO DWM_SALE_RATE_BY_PROJECT (
ID---【1】主键
,PROJECT_ID---【2】项目ID
,FO_SALE_OUT_COUNT---【3】首开去化套数
,FO_SALE_COUNT---【4】首开推售套数
,FO_SALE_RATE_BY_COUNT---【5】首开去化率(按套数)（3/4）
,FO_SALE_OUT_AREA---【6】首开去化面积
,FO_SALE_AREA---【7】首开推售面积
,FO_SALE_RATE_BY_AREA---【8】首开去化率(按面积)（6/7）
,FO_SALE_OUT_MONEY---【9】首开去化货值
,FO_SALE_MONEY---【10】首开推售货值
,FO_SALE_RATE_BY_MONEY---【11】首开去化率(按货值)（9/10）
,FO_SURPLUS_SALE_MONEY---【12】首开剩余货值(10-9)
,FO_SALE_AVERAGE_MONEY---【13】首开标准均价(10/7)
,FO_SALE_OUT_AVERAGE_MONEY---【14】首开签约均价(9/6)
,PO_SALE_OUT_COUNT---【15】全案去化套数
,PO_SALE_COUNT---【16】全案推售套数
,PO_SALE_RATE_BY_COUNT---【17】全案去化率(按套数)(15/16)
,PO_SALE_OUT_AREA---【18】全案去化面积
,PO_SALE_AREA---【19】全案推售面积
,PO_SALE_RATE_BY_AREA---【20】全案去化率(按面积)(18/19)
,PO_SALE_OUT_MONEY---【21】全案去化货值
,PO_SALE_MONEY---【22】全案推售货值
,PO_SALE_RATE_BY_MONEY---【23】全案去化率(按货值)(21/22)
,PO_SURPLUS_SALE_MONEY---【24】全案剩余货值(22-21)
,PO_SALE_AVERAGE_MONEY---【25】全案标准均价(22/19)
,PO_SALE_OUT_AVERAGE_MONEY---【26】全案签约均价(21/18)
,EH_SALE_OUT_COUNT---【27】现房去化套数
,EH_SALE_COUNT---【28】现房推售套数
,EH_SALE_RATE_BY_COUNT---【29】现房去化率(按套数)(27/28)
,EH_SALE_OUT_AREA---【30】现房去化面积
,EH_SALE_AREA---【31】现房推售面积
,EH_SALE_RATE_BY_AREA---【32】现房去化率(按面积)(30/31)
,EH_SALE_OUT_MONEY---【33】现房去化货值
,EH_SALE_MONEY---【34】现房推售货值
,EH_SALE_RATE_BY_MONEY---【35】现房去化率(按货值)(33/34)
,EH_SURPLUS_SALE_MONEY---【36】现房剩余货值(34-33)
,EH_SALE_AVERAGE_MONEY---【37】现房标准均价(34/31)
,EH_SALE_OUT_AVERAGE_MONEY---【38】现房签约均价(33/30)
,SI_SALE_OUT_COUNT---【39】顽固性库存去化套数
,SI_SALE_COUNT---【40】顽固性库存推售套数
,SI_SALE_RATE_BY_COUNT---【41】顽固性库存去化率(按套数)(39/40)
,SI_SALE_OUT_AREA---【42】顽固性库存去化面积
,SI_SALE_AREA---【43】顽固性库存推售面积
,SI_SALE_RATE_BY_AREA---【44】顽固性库存去化率(按面积)(42/43)
,SI_SALE_OUT_MONEY---【45】顽固性库存去化货值
,SI_SALE_MONEY---【46】顽固性库存推售货值
,SI_SALE_RATE_BY_MONEY---【47】顽固性库存去化率(按货值)(45/46)
,SI_SURPLUS_SALE_MONEY---【48】顽固性库存剩余货值(46-45)
,SI_SALE_AVERAGE_MONEY---【49】顽固性库存标准均价(46/43)
,SI_SALE_OUT_AVERAGE_MONEY---【50】顽固性库存签约均价(45/42)
,CREATED---【51】创建日期
,REMARK---【52】备注信息
        )
            SELECT
PROJECT_ID      ID---【1】主键
,PROJECT_ID---【2】项目ID
,FO_SALE_OUT_COUNT---【3】首开去化套数
,FO_SALE_COUNT---【4】首开推售套数
,FO_SALE_RATE_BY_COUNT---【5】首开去化率(按套数)（3/4）
,FO_SALE_OUT_AREA---【6】首开去化面积
,FO_SALE_AREA---【7】首开推售面积
,FO_SALE_RATE_BY_AREA---【8】首开去化率(按面积)（6/7）
,FO_SALE_OUT_MONEY---【9】首开去化货值
,FO_SALE_MONEY---【10】首开推售货值
,FO_SALE_RATE_BY_MONEY---【11】首开去化率(按货值)（9/10）
,FO_SURPLUS_SALE_MONEY---【12】首开剩余货值(10-9)
,FO_SALE_AVERAGE_MONEY---【13】首开标准均价(10/7)
,FO_SALE_OUT_AVERAGE_MONEY---【14】首开签约均价(9/6)
,PO_SALE_OUT_COUNT---【15】全案去化套数
,PO_SALE_COUNT---【16】全案推售套数
,PO_SALE_RATE_BY_COUNT---【17】全案去化率(按套数)(15/16)
,PO_SALE_OUT_AREA---【18】全案去化面积
,PO_SALE_AREA---【19】全案推售面积
,PO_SALE_RATE_BY_AREA---【20】全案去化率(按面积)(18/19)
,PO_SALE_OUT_MONEY---【21】全案去化货值
,PO_SALE_MONEY---【22】全案推售货值
,PO_SALE_RATE_BY_MONEY---【23】全案去化率(按货值)(21/22)
,PO_SURPLUS_SALE_MONEY---【24】全案剩余货值(22-21)
,PO_SALE_AVERAGE_MONEY---【25】全案标准均价(22/19)
,PO_SALE_OUT_AVERAGE_MONEY---【26】全案签约均价(21/18)
,EH_SALE_OUT_COUNT---【27】现房去化套数
,EH_SALE_COUNT---【28】现房推售套数
,EH_SALE_RATE_BY_COUNT---【29】现房去化率(按套数)(27/28)
,EH_SALE_OUT_AREA---【30】现房去化面积
,EH_SALE_AREA---【31】现房推售面积
,EH_SALE_RATE_BY_AREA---【32】现房去化率(按面积)(30/31)
,EH_SALE_OUT_MONEY---【33】现房去化货值
,EH_SALE_MONEY---【34】现房推售货值
,EH_SALE_RATE_BY_MONEY---【35】现房去化率(按货值)(33/34)
,EH_SURPLUS_SALE_MONEY---【36】现房剩余货值(34-33)
,EH_SALE_AVERAGE_MONEY---【37】现房标准均价(34/31)
,EH_SALE_OUT_AVERAGE_MONEY---【38】现房签约均价(33/30)
,SI_SALE_OUT_COUNT---【39】顽固性库存去化套数
,SI_SALE_COUNT---【40】顽固性库存推售套数
,SI_SALE_RATE_BY_COUNT---【41】顽固性库存去化率(按套数)(39/40)
,SI_SALE_OUT_AREA---【42】顽固性库存去化面积
,SI_SALE_AREA---【43】顽固性库存推售面积
,SI_SALE_RATE_BY_AREA---【44】顽固性库存去化率(按面积)(42/43)
,SI_SALE_OUT_MONEY---【45】顽固性库存去化货值
,SI_SALE_MONEY---【46】顽固性库存推售货值
,SI_SALE_RATE_BY_MONEY---【47】顽固性库存去化率(按货值)(45/46)
,SI_SURPLUS_SALE_MONEY---【48】顽固性库存剩余货值(46-45)
,SI_SALE_AVERAGE_MONEY---【49】顽固性库存标准均价(46/43)
,SI_SALE_OUT_AVERAGE_MONEY---【50】顽固性库存签约均价(45/42)
,CREATED---【51】创建日期
,dwm_REMARK---【52】备注信息
            FROM
                TMP_SALE_RATE_BY_PROJECT where id=spid;


commit;
    END IF;

--    open SALE_RATE_BY_PROJECT for
--select * FROM
--                TMP_SALE_RATE_BY_PROJECT where id=spid;
END P_DWM_SALE_RATE_BY_PROJ;
/

prompt
prompt Creating procedure P_DWM_SALE_RATE_BY_ORG
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_DWM_SALE_RATE_BY_ORG"  AS
		--公司颗粒度去化率；作用=》定时任务拍照
		--作者：陈丽
		--日期：2020-04-10

    PROJ_SPID NVARCHAR2(200);
    sys_created       DATE := SYSDATE;
    spid_tree              VARCHAR2(360); --使用临时表的批次号
    spid_sum              VARCHAR2(360); --使用临时表的批次号
    spid_result              VARCHAR2(360); --使用临时表的批次号
    dwm_remark        VARCHAR2(200) := '测试-chenl';
    p_X_AXIS_PERIOD  VARCHAR2(200):=to_char(sysdate, 'yyyy') ||'-'||to_char(sysdate, 'MM' );
BEGIN
delete tmp_sale_rate_by_org;
--------创建临时表批次号
    SELECT
        get_uuid(),get_uuid(),get_uuid()
    INTO spid_tree,spid_sum,spid_result
    FROM
        dual;  

------项目基本信息
BEGIN
  P_DWM_SALE_RATE_BY_PROJ(0,
    PROJ_SPID => PROJ_SPID
  );
END;

----组装树
INSERT INTO tmp_sale_rate_by_org (
        id,
        org_id,--【  2】项目ID
        org_name,--【  3】项目名称
        parent_id,
        IS_COMPANY,
        LEVEL_RANK,
        fo_sale_out_count,--【  4】首开去化套数
        fo_sale_count,--【  5】首开推售套数
        fo_sale_out_area,--【  7】首开去化面积
        fo_sale_area,--【  8】首开推售面积
        fo_sale_out_money,--【 10】首开去化货值
        fo_sale_money,--【 11】首开推售货值
        fo_surplus_sale_money,--【 13】首开剩余货值
        po_sale_out_count,--【 14】全案去化套数
        po_sale_count,--【 15】全案推售套数
        po_sale_out_area,--【 17】全案去化面积
        po_sale_area,--【 18】全案推售面积
        po_sale_out_money,--【 20】全案去化货值
        po_sale_money,--【 21】全案推售货值
        po_surplus_sale_money,--【 23】全案剩余货值
        eh_sale_out_count,--【 24】现房去化套数
        eh_sale_count,--【 25】现房推售套数
        eh_sale_out_area,--【 27】现房去化面积
        eh_sale_area,--【 28】现房推售面积
        eh_sale_out_money,--【 30】现房去化货值
        eh_sale_money,--【 31】现房推售货值
        eh_surplus_sale_money,--【 33】现房剩余货值
        si_sale_out_count,--【 34】顽固性库存去化套数
        si_sale_count,--【 35】顽固性库存推售套数
        si_sale_out_area,--【 37】顽固性库存去化面积
        si_sale_area,--【 38】顽固性库存推售面积
        si_sale_out_money,--【 40】顽固性库存去化货值
        si_sale_money,--【 41】顽固性库存推售货值
        si_surplus_sale_money--【 43】顽固性库存剩余货值
    )
        SELECT
            spid_tree,
            id AS org_id,
            org_name,
            parent_id,
            IS_COMPANY,
            LEVEL_RANK,
            0 AS fo_sale_out_count,--【  4】首开去化套数
            0 AS fo_sale_count,--【  5】首开推售套数
            0 AS fo_sale_out_area,--【  7】首开去化面积
            0 AS fo_sale_area,--【  8】首开推售面积
            0 AS fo_sale_out_money,--【 10】首开去化货值
            0 AS fo_sale_money,--【 11】首开推售货值
            0 AS fo_surplus_sale_money,--【 13】首开剩余货值
            0 AS po_sale_out_count,--【 14】全案去化套数
            0 AS po_sale_count,--【 15】全案推售套数
            0 AS po_sale_out_area,--【 17】全案去化面积
            0 AS po_sale_area,--【 18】全案推售面积
            0 AS po_sale_out_money,--【 20】全案去化货值
            0 AS po_sale_money,--【 21】全案推售货值
            0 AS po_surplus_sale_money,--【 23】全案剩余货值
            0 AS eh_sale_out_count,--【 24】现房去化套数
            0 AS eh_sale_count,--【 25】现房推售套数
            0 AS eh_sale_out_area,--【 27】现房去化面积
            0 AS eh_sale_area,--【 28】现房推售面积
            0 AS eh_sale_out_money,--【 30】现房去化货值
            0 AS eh_sale_money,--【 31】现房推售货值
            0 AS eh_surplus_sale_money,--【 33】现房剩余货值
            0 AS si_sale_out_count,--【 34】顽固性库存去化套数
            0 AS si_sale_count,--【 35】顽固性库存推售套数
            0 AS si_sale_out_area,--【 37】顽固性库存去化面积
            0 AS si_sale_area,--【 38】顽固性库存推售面积
            0 AS si_sale_out_money,--【 40】顽固性库存去化货值
            0 AS si_sale_money,--【 41】顽固性库存推售货值
            0 AS si_surplus_sale_money--【 43】顽固性库存剩余货值
        FROM
            sys_business_unit where IS_COMPANY=1
        UNION ALL
        SELECT
            spid_tree,
            project_id,
            org_name,
            org_id AS parent_id,
            0,
            null,
            fo_sale_out_count,--【  4】首开去化套数
            fo_sale_count,--【  5】首开推售套数
            fo_sale_out_area,--【  7】首开去化面积
            fo_sale_area,--【  8】首开推售面积
            fo_sale_out_money,--【 10】首开去化货值
            fo_sale_money,--【 11】首开推售货值
            fo_surplus_sale_money,--【 13】首开剩余货值
            po_sale_out_count,--【 14】全案去化套数
            po_sale_count,--【 15】全案推售套数
            po_sale_out_area,--【 17】全案去化面积
            po_sale_area,--【 18】全案推售面积
            po_sale_out_money,--【 20】全案去化货值
            po_sale_money,--【 21】全案推售货值
            po_surplus_sale_money,--【 23】全案剩余货值
            eh_sale_out_count,--【 24】现房去化套数
            eh_sale_count,--【 25】现房推售套数
            eh_sale_out_area,--【 27】现房去化面积
            eh_sale_area,--【 28】现房推售面积
            eh_sale_out_money,--【 30】现房去化货值
            eh_sale_money,--【 31】现房推售货值
            eh_surplus_sale_money,--【 33】现房剩余货值
            si_sale_out_count,--【 34】顽固性库存去化套数
            si_sale_count,--【 35】顽固性库存推售套数
            si_sale_out_area,--【 37】顽固性库存去化面积
            si_sale_area,--【 38】顽固性库存推售面积
            si_sale_out_money,--【 40】顽固性库存去化货值
            si_sale_money,--【 41】顽固性库存推售货值
            si_surplus_sale_money--【 43】顽固性库存剩余货值
        FROM
            tmp_sale_rate_by_project where id=proj_spid;           
----汇总          
INSERT INTO tmp_sale_rate_by_org (
        id,
        org_id,--【  2】项目ID
        org_name,--【  3】项目名称
        parent_id,
        IS_COMPANY,
        LEVEL_RANK,
        fo_sale_out_count,--【  4】首开去化套数
        fo_sale_count,--【  5】首开推售套数
        fo_sale_out_area,--【  7】首开去化面积
        fo_sale_area,--【  8】首开推售面积
        fo_sale_out_money,--【 10】首开去化货值
        fo_sale_money,--【 11】首开推售货值
        fo_surplus_sale_money,--【 13】首开剩余货值
        po_sale_out_count,--【 14】全案去化套数
        po_sale_count,--【 15】全案推售套数
        po_sale_out_area,--【 17】全案去化面积
        po_sale_area,--【 18】全案推售面积
        po_sale_out_money,--【 20】全案去化货值
        po_sale_money,--【 21】全案推售货值
        po_surplus_sale_money,--【 23】全案剩余货值
        eh_sale_out_count,--【 24】现房去化套数
        eh_sale_count,--【 25】现房推售套数
        eh_sale_out_area,--【 27】现房去化面积
        eh_sale_area,--【 28】现房推售面积
        eh_sale_out_money,--【 30】现房去化货值
        eh_sale_money,--【 31】现房推售货值
        eh_surplus_sale_money,--【 33】现房剩余货值
        si_sale_out_count,--【 34】顽固性库存去化套数
        si_sale_count,--【 35】顽固性库存推售套数
        si_sale_out_area,--【 37】顽固性库存去化面积
        si_sale_area,--【 38】顽固性库存推售面积
        si_sale_out_money,--【 40】顽固性库存去化货值
        si_sale_money,--【 41】顽固性库存推售货值
        si_surplus_sale_money--【 43】顽固性库存剩余货值
    )
 select spid_sum,org_id,org_name,parent_id,IS_COMPANY,LEVEL_RANK
,(select sum(FO_SALE_OUT_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FO_SALE_OUT_COUNT
,(select sum(FO_SALE_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FO_SALE_COUNT
,(select sum(FO_SALE_OUT_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FO_SALE_OUT_AREA
,(select sum(FO_SALE_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FO_SALE_AREA
,(select sum(FO_SALE_OUT_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FO_SALE_OUT_MONEY
,(select sum(FO_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FO_SALE_MONEY
,(select sum(FO_SURPLUS_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) FO_SURPLUS_SALE_MONEY
,(select sum(PO_SALE_OUT_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) PO_SALE_OUT_COUNT
,(select sum(PO_SALE_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) PO_SALE_COUNT
,(select sum(PO_SALE_OUT_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) PO_SALE_OUT_AREA
,(select sum(PO_SALE_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) PO_SALE_AREA
,(select sum(PO_SALE_OUT_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) PO_SALE_OUT_MONEY
,(select sum(PO_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) PO_SALE_MONEY
,(select sum(PO_SURPLUS_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) PO_SURPLUS_SALE_MONEY
,(select sum(EH_SALE_OUT_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) EH_SALE_OUT_COUNT
,(select sum(EH_SALE_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) EH_SALE_COUNT
,(select sum(EH_SALE_OUT_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) EH_SALE_OUT_AREA
,(select sum(EH_SALE_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) EH_SALE_AREA
,(select sum(EH_SALE_OUT_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) EH_SALE_OUT_MONEY
,(select sum(EH_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) EH_SALE_MONEY
,(select sum(EH_SURPLUS_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) EH_SURPLUS_SALE_MONEY
,(select sum(SI_SALE_OUT_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) SI_SALE_OUT_COUNT
,(select sum(SI_SALE_COUNT) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) SI_SALE_COUNT
,(select sum(SI_SALE_OUT_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) SI_SALE_OUT_AREA
,(select sum(SI_SALE_AREA) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) SI_SALE_AREA
,(select sum(SI_SALE_OUT_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) SI_SALE_OUT_MONEY
,(select sum(SI_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) SI_SALE_MONEY
,(select sum(SI_SURPLUS_SALE_MONEY) from tmp_sale_rate_by_org start with org_id=s.org_id connect by prior org_id=parent_id and org_id!=parent_id) SI_SURPLUS_SALE_MONEY
from tmp_sale_rate_by_org s where id=spid_tree
order by org_id  ; 
----计算率
INSERT INTO tmp_sale_rate_by_org (
ID,--【1】主键
ORG_ID,--【2】项目ID
ORG_NAME,--【3】项目名称
LEVEL_RANK,
FO_SALE_OUT_COUNT,--【4】首开去化套数
FO_SALE_COUNT,--【5】首开推售套数
FO_SALE_RATE_BY_COUNT,--【6】首开去化率(按套数)
FO_SALE_OUT_AREA,--【7】首开去化面积
FO_SALE_AREA,--【8】首开推售面积
FO_SALE_RATE_BY_AREA,--【9】首开去化率(按面积)
FO_SALE_OUT_MONEY,--【10】首开去化货值
FO_SALE_MONEY,--【11】首开推售货值
FO_SALE_RATE_BY_MONEY,--【12】首开去化率(按货值)
FO_SURPLUS_SALE_MONEY,--【13】首开剩余货值
PO_SALE_OUT_COUNT,--【14】全案去化套数
PO_SALE_COUNT,--【15】全案推售套数
PO_SALE_RATE_BY_COUNT,--【16】全案去化率(按套数)
PO_SALE_OUT_AREA,--【17】全案去化面积
PO_SALE_AREA,--【18】全案推售面积
PO_SALE_RATE_BY_AREA,--【19】全案去化率(按面积)
PO_SALE_OUT_MONEY,--【20】全案去化货值
PO_SALE_MONEY,--【21】全案推售货值
PO_SALE_RATE_BY_MONEY,--【22】全案去化率(按货值)
PO_SURPLUS_SALE_MONEY,--【23】全案剩余货值
EH_SALE_OUT_COUNT,--【24】现房去化套数
EH_SALE_COUNT,--【25】现房推售套数
EH_SALE_RATE_BY_COUNT,--【26】现房去化率(按套数)
EH_SALE_OUT_AREA,--【27】现房去化面积
EH_SALE_AREA,--【28】现房推售面积
EH_SALE_RATE_BY_AREA,--【29】现房去化率(按面积)
EH_SALE_OUT_MONEY,--【30】现房去化货值
EH_SALE_MONEY,--【31】现房推售货值
EH_SALE_RATE_BY_MONEY,--【32】现房去化率(按货值)
EH_SURPLUS_SALE_MONEY,--【33】现房剩余货值
SI_SALE_OUT_COUNT,--【34】顽固性库存去化套数
SI_SALE_COUNT,--【35】顽固性库存推售套数
SI_SALE_RATE_BY_COUNT,--【36】顽固性库存去化率(按套数)
SI_SALE_OUT_AREA,--【37】顽固性库存去化面积
SI_SALE_AREA,--【38】顽固性库存推售面积
SI_SALE_RATE_BY_AREA,--【39】顽固性库存去化率(按面积)
SI_SALE_OUT_MONEY,--【40】顽固性库存去化货值
SI_SALE_MONEY,--【41】顽固性库存推售货值
SI_SALE_RATE_BY_MONEY,--【42】顽固性库存去化率(按货值)
SI_SURPLUS_SALE_MONEY,--【43】顽固性库存剩余货值
X_AXIS_PERIOD,--【44】时间（横坐标）
CREATED,--【45】创建时间
"REMARK" )
select spid_result,ORG_ID,--【2】项目ID
ORG_NAME,--【3】项目名称
LEVEL_RANK,
FO_SALE_OUT_COUNT,--【4】首开去化套数
FO_SALE_COUNT,--【5】首开推售套数
case when FO_SALE_COUNT=0 then 0 else  round(FO_SALE_OUT_COUNT/FO_SALE_COUNT,4) end as  FO_SALE_RATE_BY_COUNT,--【6】首开去化率(按套数)
FO_SALE_OUT_AREA,--【7】首开去化面积
FO_SALE_AREA,--【8】首开推售面积
case when FO_SALE_AREA=0 then 0 else  round(FO_SALE_OUT_AREA/FO_SALE_AREA,4) end as  FO_SALE_RATE_BY_AREA,--【9】首开去化率(按面积)
FO_SALE_OUT_MONEY,--【10】首开去化货值
FO_SALE_MONEY,--【11】首开推售货值
case when FO_SALE_MONEY=0 then 0 else  round(FO_SALE_OUT_MONEY/FO_SALE_MONEY,4) end as FO_SALE_RATE_BY_MONEY,--【12】首开去化率(按货值)
FO_SALE_MONEY-FO_SALE_OUT_MONEY as FO_SURPLUS_SALE_MONEY,--【13】首开剩余货值
PO_SALE_OUT_COUNT,--【14】全案去化套数
PO_SALE_COUNT,--【15】全案推售套数
case when FO_SALE_MONEY=0 then 0 else  round(PO_SALE_OUT_COUNT/PO_SALE_COUNT,4) end as PO_SALE_RATE_BY_COUNT,--【16】全案去化率(按套数)
PO_SALE_OUT_AREA,--【17】全案去化面积
PO_SALE_AREA,--【18】全案推售面积
case when PO_SALE_AREA=0 then 0 else  round(PO_SALE_OUT_AREA/PO_SALE_AREA,4) end as PO_SALE_RATE_BY_AREA,--【19】全案去化率(按面积)
PO_SALE_OUT_MONEY,--【20】全案去化货值
PO_SALE_MONEY,--【21】全案推售货值
case when PO_SALE_AREA=0 then 0 else  round(PO_SALE_OUT_MONEY/PO_SALE_MONEY,4) end as PO_SALE_RATE_BY_MONEY,--【22】全案去化率(按货值)
PO_SALE_MONEY-PO_SALE_OUT_MONEY as PO_SURPLUS_SALE_MONEY,--【23】全案剩余货值
EH_SALE_OUT_COUNT,--【24】现房去化套数
EH_SALE_COUNT,--【25】现房推售套数
case when EH_SALE_COUNT=0 then 0 else  round(EH_SALE_OUT_COUNT/EH_SALE_COUNT,4) end as EH_SALE_RATE_BY_COUNT,--【26】现房去化率(按套数)
EH_SALE_OUT_AREA,--【27】现房去化面积
EH_SALE_AREA,--【28】现房推售面积
case when EH_SALE_AREA=0 then 0 else  round(EH_SALE_OUT_AREA/EH_SALE_AREA,4) end  as EH_SALE_RATE_BY_AREA,--【29】现房去化率(按面积)
EH_SALE_OUT_MONEY,--【30】现房去化货值
EH_SALE_MONEY,--【31】现房推售货值
case when EH_SALE_MONEY=0 then 0 else  round(EH_SALE_OUT_MONEY/EH_SALE_MONEY,4) end  as EH_SALE_RATE_BY_MONEY,--【32】现房去化率(按货值)
EH_SALE_MONEY-EH_SALE_OUT_MONEY as EH_SURPLUS_SALE_MONEY,--【33】现房剩余货值
SI_SALE_OUT_COUNT,--【34】顽固性库存去化套数
SI_SALE_COUNT,--【35】顽固性库存推售套数
case when SI_SALE_COUNT=0 then 0 else  round(SI_SALE_OUT_COUNT/SI_SALE_COUNT,4) end  as SI_SALE_RATE_BY_COUNT,--【36】顽固性库存去化率(按套数)
SI_SALE_OUT_AREA,--【37】顽固性库存去化面积
SI_SALE_AREA,--【38】顽固性库存推售面积
case when SI_SALE_AREA=0 then 0 else  round(SI_SALE_OUT_AREA/SI_SALE_AREA,4) end  as SI_SALE_RATE_BY_AREA,--【39】顽固性库存去化率(按面积)
SI_SALE_OUT_MONEY,--【40】顽固性库存去化货值
SI_SALE_MONEY,--【41】顽固性库存推售货值
case when SI_SALE_MONEY=0 then 0 else  round(SI_SALE_OUT_MONEY/SI_SALE_MONEY,4) end  as SI_SALE_RATE_BY_MONEY,--【42】顽固性库存去化率(按货值)
SI_SALE_MONEY-SI_SALE_OUT_MONEY as SI_SURPLUS_SALE_MONEY,--【43】顽固性库存剩余货值
p_X_AXIS_PERIOD,--【44】时间（横坐标）
sys_created,--【45】创建时间
dwm_remark--【46】备注信息
from tmp_sale_rate_by_org where IS_COMPANY=1 and id=spid_sum and LEVEL_RANK<=2
;
----插入到目标表

   DELETE FROM dwm_sale_rate_by_org where  X_AXIS_PERIOD=p_X_AXIS_PERIOD;
   --and REMARK=dwm_REMARK;

   INSERT INTO dwm_sale_rate_by_org (
ID,--【1】主键
ORG_ID,--【2】项目ID
ORG_NAME,--【3】项目名称
FO_SALE_OUT_COUNT,--【4】首开去化套数
FO_SALE_COUNT,--【5】首开推售套数
FO_SALE_RATE_BY_COUNT,--【6】首开去化率(按套数)
FO_SALE_OUT_AREA,--【7】首开去化面积
FO_SALE_AREA,--【8】首开推售面积
FO_SALE_RATE_BY_AREA,--【9】首开去化率(按面积)
FO_SALE_OUT_MONEY,--【10】首开去化货值
FO_SALE_MONEY,--【11】首开推售货值
FO_SALE_RATE_BY_MONEY,--【12】首开去化率(按货值)
FO_SURPLUS_SALE_MONEY,--【13】首开剩余货值
PO_SALE_OUT_COUNT,--【14】全案去化套数
PO_SALE_COUNT,--【15】全案推售套数
PO_SALE_RATE_BY_COUNT,--【16】全案去化率(按套数)
PO_SALE_OUT_AREA,--【17】全案去化面积
PO_SALE_AREA,--【18】全案推售面积
PO_SALE_RATE_BY_AREA,--【19】全案去化率(按面积)
PO_SALE_OUT_MONEY,--【20】全案去化货值
PO_SALE_MONEY,--【21】全案推售货值
PO_SALE_RATE_BY_MONEY,--【22】全案去化率(按货值)
PO_SURPLUS_SALE_MONEY,--【23】全案剩余货值
EH_SALE_OUT_COUNT,--【24】现房去化套数
EH_SALE_COUNT,--【25】现房推售套数
EH_SALE_RATE_BY_COUNT,--【26】现房去化率(按套数)
EH_SALE_OUT_AREA,--【27】现房去化面积
EH_SALE_AREA,--【28】现房推售面积
EH_SALE_RATE_BY_AREA,--【29】现房去化率(按面积)
EH_SALE_OUT_MONEY,--【30】现房去化货值
EH_SALE_MONEY,--【31】现房推售货值
EH_SALE_RATE_BY_MONEY,--【32】现房去化率(按货值)
EH_SURPLUS_SALE_MONEY,--【33】现房剩余货值
SI_SALE_OUT_COUNT,--【34】顽固性库存去化套数
SI_SALE_COUNT,--【35】顽固性库存推售套数
SI_SALE_RATE_BY_COUNT,--【36】顽固性库存去化率(按套数)
SI_SALE_OUT_AREA,--【37】顽固性库存去化面积
SI_SALE_AREA,--【38】顽固性库存推售面积
SI_SALE_RATE_BY_AREA,--【39】顽固性库存去化率(按面积)
SI_SALE_OUT_MONEY,--【40】顽固性库存去化货值
SI_SALE_MONEY,--【41】顽固性库存推售货值
SI_SALE_RATE_BY_MONEY,--【42】顽固性库存去化率(按货值)
SI_SURPLUS_SALE_MONEY,--【43】顽固性库存剩余货值
X_AXIS_PERIOD,--【44】时间（横坐标）
CREATED,--【45】创建时间
"REMARK" )
select get_uuid,--【1】主键
ORG_ID,--【2】项目ID
ORG_NAME,--【3】项目名称
FO_SALE_OUT_COUNT,--【4】首开去化套数
FO_SALE_COUNT,--【5】首开推售套数
FO_SALE_RATE_BY_COUNT,--【6】首开去化率(按套数)
FO_SALE_OUT_AREA,--【7】首开去化面积
FO_SALE_AREA,--【8】首开推售面积
FO_SALE_RATE_BY_AREA,--【9】首开去化率(按面积)
FO_SALE_OUT_MONEY,--【10】首开去化货值
FO_SALE_MONEY,--【11】首开推售货值
FO_SALE_RATE_BY_MONEY,--【12】首开去化率(按货值)
FO_SURPLUS_SALE_MONEY,--【13】首开剩余货值
PO_SALE_OUT_COUNT,--【14】全案去化套数
PO_SALE_COUNT,--【15】全案推售套数
PO_SALE_RATE_BY_COUNT,--【16】全案去化率(按套数)
PO_SALE_OUT_AREA,--【17】全案去化面积
PO_SALE_AREA,--【18】全案推售面积
PO_SALE_RATE_BY_AREA,--【19】全案去化率(按面积)
PO_SALE_OUT_MONEY,--【20】全案去化货值
PO_SALE_MONEY,--【21】全案推售货值
PO_SALE_RATE_BY_MONEY,--【22】全案去化率(按货值)
PO_SURPLUS_SALE_MONEY,--【23】全案剩余货值
EH_SALE_OUT_COUNT,--【24】现房去化套数
EH_SALE_COUNT,--【25】现房推售套数
EH_SALE_RATE_BY_COUNT,--【26】现房去化率(按套数)
EH_SALE_OUT_AREA,--【27】现房去化面积
EH_SALE_AREA,--【28】现房推售面积
EH_SALE_RATE_BY_AREA,--【29】现房去化率(按面积)
EH_SALE_OUT_MONEY,--【30】现房去化货值
EH_SALE_MONEY,--【31】现房推售货值
EH_SALE_RATE_BY_MONEY,--【32】现房去化率(按货值)
EH_SURPLUS_SALE_MONEY,--【33】现房剩余货值
SI_SALE_OUT_COUNT,--【34】顽固性库存去化套数
SI_SALE_COUNT,--【35】顽固性库存推售套数
SI_SALE_RATE_BY_COUNT,--【36】顽固性库存去化率(按套数)
SI_SALE_OUT_AREA,--【37】顽固性库存去化面积
SI_SALE_AREA,--【38】顽固性库存推售面积
SI_SALE_RATE_BY_AREA,--【39】顽固性库存去化率(按面积)
SI_SALE_OUT_MONEY,--【40】顽固性库存去化货值
SI_SALE_MONEY,--【41】顽固性库存推售货值
SI_SALE_RATE_BY_MONEY,--【42】顽固性库存去化率(按货值)
SI_SURPLUS_SALE_MONEY,--【43】顽固性库存剩余货值
X_AXIS_PERIOD,--【44】时间（横坐标）
CREATED,--【45】创建时间
"REMARK"
from tmp_sale_rate_by_org where id=spid_result;
commit;  
END p_dwm_sale_rate_by_org;
/

prompt
prompt Creating procedure P_DWM_TARGET_VALUE_LIST
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_DWM_TARGET_VALUE_LIST" (
    companyid     IN            VARCHAR2,--当前用户公司
    stationid     IN            VARCHAR2,---当前用户的岗位
    deptid        IN            VARCHAR2,---当前用户的部门
    bizcode       IN            VARCHAR2,---权限code
    userid        IN            VARCHAR2,---当前用户id
    projectid   IN              VARCHAR2,---、所选项目
    searchparam   IN            VARCHAR2,--筛选条件
    selectCompanyId IN          VARCHAR2,--当前选中的公司
    info         OUT            SYS_REFCURSOR
) IS
--目标货值管理
--作者：鲜晓勇
--日期：2020/2/09

    v_sql_exec         CLOB;
    v_sql         CLOB;
    v_spid             VARCHAR2(200);---数据验证spid
    v_where            VARCHAR2(4000):=' and 1=1 ';
    v_projWhere        VARCHAR2(4000):=' where 1=1';
    v_search           VARCHAR2(4000):=' and 1=1 ';  ---搜素sql
    v_license          VARCHAR2(4000):=' AND 1=1';
    v_project          VARCHAR2(4000);
    v_type             VARCHAR2(4000);
    v_auth_sql         VARCHAR2(4000) :=' where 1=1';
BEGIN
    BEGIN
    --执行数据权限存储过程。拿到零时表id 用户连临时表鉴权
 --调用查询数据权限的存储过程,返回spid 
       P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
           STATIONID => stationid,
          DEPTID => deptid,
           COMPANYID => companyid,
          BIZCODE => bizcode,
          DATA_AUTH_SPID => v_spid
      );
	v_auth_sql:='left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') ta on ta.orgid=dtw.PROJ_ID  where ta.orgid is not null ';
    --v_auth_sql:='';
    if(selectCompanyId is not null )THEN
     v_where:='  AND mp.UNIT_ID in(  select ID from SYS_BUSINESS_UNIT
   start with id= '''||selectCompanyId||''' connect by prior id=parent_id)';
    end if;
    if(projectid is not null)THEN 
     v_projWhere:=' WHERE s."projId"='''||projectid||'''';
    END if;
    if(searchParam is not null)THEN
        v_search:=' AND (t."version" like ''%'
                       || searchparam
                       || '%'' or t."projName" like ''%'
                       || searchparam
                       || '%'')';
    END IF;
    v_sql := '
     SELECT t.* FROM (
            select s.* from (
                SELECT
        dtw.ID as "id",
        dtw.PROJ_ID as "projId",
        dtw.PROJ_NAME as "projName",
        dtw.TARGET_WORTH_PHASE as "targetWorthPhase",
        dtw.TARGET_WORTH as "targetWorth",
        dtw.REMARK as "remark",
        dtw.APPROVAL_STATUS as "approvalStatus",
        dtw.APPROVER_ID as "approverId",
        dtw.APPROVAL_TIME as "approvalTime",
        mp.ORDER_HIERARCHY_CODE as "projectCode",
        dtw.WORTH_V as "worthV",
        dtw.CREATED as "created",
        dtw.PREVIOUS_V_WORTH as "previousVWorth",
        dtw.PREVIOUS_V_INCREMENT "previousVIncrement",
        dtw.FULL_V_WORTH as "fullVWorth",
        dtw.FULL_V_INCREMENT as "fullVIncrement",
        dtw.FEASIBILITY_STUDY_V_WORTH as "feasibilityStudyVWorth",
        dtw.FEASIBILITY_STUDY_V_INCREMENT as "feasibilityStudyVIncrement",
        dtw.IS_DELETE as "isDelete",
        dtw.APPROVER as "approver",
        dtwd.TOTAL_SALES_AREA AS "totalSalesArea",
        dtwd.TOTAL_CARPORT AS "totalCarport",
        CASE WHEN dtw.TARGET_WORTH_PHASE = 0 THEN
        ''可研版目标货值''
        WHEN dtw.TARGET_WORTH_PHASE = 10 THEN
        ''全盘开发计划版目标货值''
        WHEN dtw.TARGET_WORTH_PHASE = 20 THEN
        ''动态版目标货值(V''|| dtw.WORTH_V ||''.0)''
        END "version"
        FROM DWM_TARGET_WORTH dtw
        LEFT JOIN DWM_TARGET_WORTH_DTL dtwd ON dtw.ID = dtwd.TARGET_WORTH_ID AND dtwd.OBJ_TYPE = 0
        ---chenl 20200728调整，非项目维护本身模块，使用项目数据查询SYS_PROJECT表
        LEFT JOIN SYS_PROJECT mp ON dtw.PROJ_ID = mp.ID
        '||v_auth_sql||'
         AND dtw.IS_DELETE = 0
        '||v_where||'
            ) s '||v_projWhere||'
        )t
        WHERE 1= 1 AND t."isDelete" = 0
        '||v_search||'
         ORDER BY t."projectCode" ASC,t."targetWorthPhase",t."worthV"';
--        v_sql_exec := '
--                select a.* from ( '
--                  || v_sql
--                  || ' AND rownum <= '
--                  || pageindex * pagesizes
--                  || ' ) a where a.rowno >= '
--                  || pagesizes * ( pageindex - 1 )
--                  || '';

    dbms_output.put_line(v_sql);
   OPEN info FOR v_sql;
END;
END P_DWM_TARGET_VALUE_LIST;
/

prompt
prompt Creating procedure P_DWM_TARGET_WORTH_DTL_M
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_TARGET_WORTH_DTL_M (
    targetWorthId         IN             VARCHAR2 --目标货值id
) AS
--修正目标货值错误数据存储修正。之前数据逻辑存储错误，保存时修改正。临时处理。
--作者：陈丽
--日期：2020/05/09
BEGIN
---复制OBJ_ID  
  update DWM_TARGET_WORTH_DTL a set a.OLD_OBJ_ID=(select OBJ_ID from DWM_TARGET_WORTH_DTL b where a.id=b.id) where target_Worth_Id=targetWorthId;
  commit;
---修正OBJ_PARENT_ID
   update DWM_TARGET_WORTH_DTL a set a.OBJ_PARENT_ID=(select OBJ_PARENT_ID from (SELECT
        d.ID,
        d.OBJ_NAME,
        d.OBJ_ID,
        d.OPERATE_ATTRIBUTE_ID,
        d.OPERATE_ATTRIBUTE_NAME,
        d.TOTAL_BUILD_AREA,
        d.TOTAL_VOLUME_AREA,
        d.TOTAL_SALES_AREA,
        d.GROUND_CAN_SELL_AREA,
        d.UNDERGROUND_CAN_SELL_AREA,
        d.TOTAL_CARPORT,
        d.GROUND_CARPORT,
        d.UNDERGROUND_CARPORT,
        d.AVERAGE_PRICE,
        d.WORTH,
        d.TARGET_WORTH_ID,
        d.OBJ_TYPE,
        d.CREATOR_ID,
        d.CREATED,
        d.CREATOR,
        d.MODIFIED,
        d.MODIFIER_ID,
        d.MODIFIER,
        d.OBJ_PHASE_ID,
        CASE WHEN d.OBJ_TYPE = 0 THEN
        NULL
        WHEN d.OBJ_TYPE = 10 THEN
        mp2.PROJECT_ID
        WHEN d.OBJ_TYPE = 20 THEN
        mpv.PROJECT_ID
        WHEN d.OBJ_TYPE = 30 THEN
        mb.PERIOD_ID
        ELSE d.OBJ_ID
        END  OBJ_PARENT_ID
        FROM DWM_TARGET_WORTH_DTL d
        LEFT JOIN MDM_PROJECT mp1 ON d.OBJ_ID = mp1.ID
        LEFT JOIN MDM_PARCEL mp2 ON d.OBJ_ID = mp2.ID
        LEFT JOIN MDM_PERIOD mp3 ON d.OBJ_ID = mp3.ID
        LEFT JOIN MDM_PERIOD_VERSION mpv ON mpv.ID = mp3.PERIOD_VERSION_ID
        AND mpv.APPROVAL_STATUS = '已审核'
        LEFT JOIN MDM_BUILD mb ON d.OBJ_ID = mb.ID) b where a.id=b.id) where target_Worth_Id=targetWorthId;
   commit;

---修正OBJ_ID  
  update DWM_TARGET_WORTH_DTL a set a.OBJ_ID=(select id from MDM_BUILD_PRODUCT_TYPE b where a.OBJ_NAME=b.PRODUCT_TYPE_NAME) 
  where target_Worth_Id=targetWorthId and a.OBJ_TYPE=40;
  commit;
END P_DWM_TARGET_WORTH_DTL_M;
/

prompt
prompt Creating procedure P_DWM_TARGET_WORTH_RECOUNT
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_TARGET_WORTH_RECOUNT (
    targetWorthId         IN             VARCHAR2 --目标货值id
) AS
--目标货值重新计算
--作者：陈丽
--日期：2020/05/09
BEGIN
RETURN;
--with 计算 as(select (case when obj_type=40 then average_price else 0 end) as average_price_temp,
--    (case when obj_type=40 then nvl(average_price*(TOTAL_CARPORT+GROUND_CAN_SELL_AREA),0) else 0 end) as worth_temp,
--    id,target_worth_id,
--    worth_dtl_id,
--    worth_dtl_parent_id from DWM_TARGET_WORTH_DTL)
--
-- , 汇总 as( select s.*
-- ,(SELECT SUM(worth_temp) FROM 计算 START WITH ID=S.ID CONNECT BY PRIOR ID=obj_parent_id ) AS  worth_yuan
-- from 计算 s)
--
--SELECT 汇总.*
--,CASE WHEN (TOTAL_CARPORT+GROUND_CAN_SELL_AREA)=0 THEN 0 ELSE worth_yuan/(TOTAL_CARPORT+GROUND_CAN_SELL_AREA) END AS average_price
--,WORTH_yuan/10000 AS "worth"
--FROM 汇总;

END P_DWM_TARGET_WORTH_RECOUNT;
/

prompt
prompt Creating procedure P_DWM_TARGET_WORTH_REF
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_TARGET_WORTH_REF (
    USERID   IN   VARCHAR2,
    STATIONID    IN  VARCHAR2,
    DEPTID   IN   VARCHAR2,
    COMPANYID IN VARCHAR2,
    i_projectId    IN               VARCHAR2,---项目id
    i_target_worth_phase    IN               VARCHAR2:=0 ---货值阶段（0：可研版目标货值，10：全盘开发计划版目标货值，20：动态版目标货值）
    ,o_target_worth out  SYS_REFCURSOR
) AS
		--获取目标货值。可研版本货值,全盘版本目标货值，动态版本目标货值（只是获取，未到数据库）
        --调用范围：货值管理系统目标货值刷新
		--作者：陈丽
		--日期：2020-06-14
l_created date:=sysdate;
l_UUID varchar2(36):=GET_UUID();
BEGIN
open o_TARGET_WORTH for

with 
-------------------------------------------=======对象基本信息，项目，分期，楼栋
obj_base as(
select id as obj_id,PROJECT_NAME as obj_name,UNIT_ID as parent_id,'项目' as objtype from sys_project obj_base where id=i_projectId
union all
select id as obj_id,STAGE_NAME as obj_name,project_id  as parent_id,'分期' as objtype from sys_project_stage where project_id=i_projectId
union all
select id as obj_id,BUILD_NAME as obj_name,period_id  as parent_id,'楼栋' as objtype from sys_build where PROJ_ID=i_projectId
),
-------------------------------------------=======已审核的对象阶段实例 状态（10：激活（未审核）；15：审核中，19：已审核；20：已成完成（即创建了下一个版本）
obj_phase as(
select pp.ID as instance_id,pp.PROJ_ID as obj_id,proj.PROJECT_NAME as obj_name,mp.PHASE_NAME,mp.PHASE_ORDER,'项目' as objtype from MDM_PROJECT_PHASE  pp
left join mdm_phase mp on pp.PHASE_ID=mp.id
left join sys_project proj on pp.PROJ_ID=proj.id
--审核或者已创建下一阶段
where pp.PROJ_ID=i_projectId and (PHASE_STATE=19 or PHASE_STATE=20)
union all
select p.ID as  instance_id,p.PERIOD_ID as obj_id,stage.STAGE_NAME as obj_name,mp.PHASE_NAME,mp.PHASE_ORDER ,'分期' as objtype from MDM_PERIOD_PHASE p
left join sys_project_stage stage on p.PERIOD_ID=stage.id
left join mdm_phase mp on p.PHASE_ID=mp.id
--审核或者已创建下一阶段
where stage.project_id=i_projectId and (PHASE_STATE=19 or PHASE_STATE=20)
union all
select b.ID as instance_id,b.BUILD_ID as obj_id,build.BUILD_NAME as obj_name,mp.PHASE_NAME,mp.PHASE_ORDER ,'楼栋' as objtype from MDM_BUILD_PHASE b
left join sys_build build on b.BUILD_ID=build.id
left join sys_project proj on build.PROJ_ID=proj.id
left join mdm_phase mp on b.PHASE_ID=mp.id
--审核或者已创建下一阶段
where proj.id=i_projectId and (PHASE_STATE=19 or PHASE_STATE=20) 
),
-------------------------------------------=======最新已审核阶段实例
obj_new_phase as
(
select * from (select obj_phase.*,row_number() over(partition by obj_id order by PHASE_ORDER desc) as order_num from obj_phase )obj_phase_order where order_num = 1
),
-------------------------------------------=======最新已审核目标货值--用于新增引入上一个已审核单价
latest_target_worth as
(select * from (select latest_tw.*,row_number() over(partition by OBJ_ID,obj_parent_id order by target_worth_phase,worth_v desc) as order_num from 
(select dtl.OBJ_ID,dtl.AVERAGE_PRICE,dtl.obj_parent_id,worth_v,target_worth_phase,dtl.obj_name 
,dtl.WORTH_DTL_PARENT_ID,dtl.WORTH_DTL_ID
from DWM_TARGET_WORTH_DTL dtl
left join DWM_TARGET_WORTH  w on dtl.TARGET_WORTH_ID=w.id
left join DWM_TARGET_WORTH_DTL parentdtl on dtl.obj_parent_id=parentdtl.obj_id
--已审核并且等于业态的
where  approval_status='已审核' and dtl.OBJ_TYPE=40  and w.proj_id =i_projectId) latest_tw
)obj_phase_order where order_num = 1
),
-------------------------------------------=======查询可研版本---查询可研版本---查询可研版本---查询可研版本---查询可研版本---查询可研版本
可研版本对象 as (
select  obj_base.obj_id||l_UUID as id,
        '可研版本' 类型,
        PHASE_NAME,
        obj_base.obj_name as OBJ_NAME,
        ph.obj_id as OBJ_ID,
        '' as OPERATE_ATTRIBUTE_ID,
        '' as OPERATE_ATTRIBUTE_NAME,
        pIndex.OVERALL_FLOORAGE_AREA as TOTAL_BUILD_AREA,
        pIndex.TOTAL_CAPACITY_AREA as TOTAL_VOLUME_AREA,--'总计容面积'
        pIndex.TOTAL_SALE_AREA as TOTAL_SALES_AREA,---'总可售面积';
        pIndex.GROUND_SALE_AREA as GROUND_CAN_SELL_AREA,--GROUND_CAN_SELL_AREA" IS '地上可售面积';
        pIndex.UNDERGROUND_SALE_AREA as UNDERGROUND_CAN_SELL_AREA,-- IS '地下可售面积';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT  as TOTAL_CARPORT,--'总车位数';
        0 as GROUND_CARPORT,-- '地上车位数';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT as UNDERGROUND_CARPORT,-- '地下车位数';
        ------0 AVERAGE_PRICE,-- '均价（手动录入）'
         ------0 WORTH,-- '均价（手动录入）'
        l_UUID as TARGET_WORTH_ID,--'货值主键';
       case when ph.objtype='项目' then 0 
        when  ph.objtype='分期' then 20 
        when ph.objtype='楼栋' then 30 end as
        OBJ_TYPE,-- '对象类型（0：项目；20：分期；30：楼栋;40业态）';
        pIndex.OBJ_PHASE_ID as OBJ_PHASE_ID,
        obj_base.parent_id||l_UUID as WORTH_DTL_PARENT_ID,obj_base.obj_id  as OBJ_PARENT_ID,
        '' as PRODUCT_TYPE_ID
from obj_base obj_base
--所有阶段
left join obj_phase ph on obj_base.obj_id=ph.obj_id
--阶段指标
left join MDM_OBJ_PHASE_INDEX pIndex on ph.instance_id =pIndex.OBJ_PHASE_ID
--只查询可研版本计划
where  ph.phase_name='可研版' and obj_base.objtype='项目' 
)

,可研版本业态 as (
---查询项目业态指标
 select 
        pIndex.id id,
         '可研版本' 类型,
         PHASE_NAME,
        pIndex.product_type_name as OBJ_NAME,
        pIndex.product_type_id as OBJ_ID,
        pIndex.OPERATE_ATTRIBUTE_ID as OPERATE_ATTRIBUTE_ID,
        pIndex.OPERATE_ATTRIBUTE_NAME as OPERATE_ATTRIBUTE_NAME,
        pIndex.GROUND_TOTAL_BUILD_AREA+pIndex.UNDERGROUND_TOTAL_BUILD_AREA as TOTAL_BUILD_AREA,
        pIndex.GROUND_CAPACITY_AREA+pIndex.UNDERGROUND_CAPACITY_AREA as TOTAL_VOLUME_AREA,--'总计容面积'
        pIndex.TOTAL_SALE_AREA as TOTAL_SALES_AREA,---'总可售面积';
        pIndex.GROUND_SALE_AREA as GROUND_CAN_SELL_AREA,--GROUND_CAN_SELL_AREA" IS '地上可售面积';
        pIndex.UNDERGROUND_SALE_AREA as UNDERGROUND_CAN_SELL_AREA,-- IS '地下可售面积';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT  as TOTAL_CARPORT,--'总车位数';
        0 as GROUND_CARPORT,-- '地上车位数';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT as UNDERGROUND_CARPORT,-- '地下车位数';
        ------0 AVERAGE_PRICE,-- '均价（手动录入）'
         ------0 WORTH,-- '均价（手动录入）'
        l_UUID as TARGET_WORTH_ID,--'货值主键';
        40 OBJ_TYPE,-- '对象类型（0：项目；20：分期；30：楼栋40业态）';
        可研版本对象.OBJ_PHASE_ID as OBJ_PHASE_ID,
        可研版本对象.id as WORTH_DTL_PARENT_ID,
        可研版本对象.OBJ_ID as OBJ_PARENT_ID,
        pIndex.PRODUCT_TYPE_ID
--业态指标
from MDM_OBJ_PHASE_PT_INDEX pIndex 
left join 可研版本对象 可研版本对象 on pIndex.OBJ_PHASE_ID=可研版本对象.OBJ_PHASE_ID
--只查询可研 分期业态指标。
where (可研版本对象.OBJ_TYPE=0 ) 
--and 可研版本对象.id is not null
--只查询可研阶段 项目的业态指标。
--where  ph.phase_name='可研版' and ph.objtype='项目' 
),


-------------------------------------------=======全盘版本---全盘版本---全盘版本---全盘版本---全盘版本---全盘版本---全盘版本
---项目和分期
全盘版本对象 as (
select  obj_base.obj_id||l_UUID as id,
        '全盘版本' 类型,
        PHASE_NAME,
        obj_base.obj_name as OBJ_NAME,
        obj_base.obj_id as OBJ_ID,
        '' as OPERATE_ATTRIBUTE_ID,
        '' as OPERATE_ATTRIBUTE_NAME,
        pIndex.OVERALL_FLOORAGE_AREA as TOTAL_BUILD_AREA,
        pIndex.TOTAL_CAPACITY_AREA as TOTAL_VOLUME_AREA,--'总计容面积'
        pIndex.TOTAL_SALE_AREA as TOTAL_SALES_AREA,---'总可售面积';
        pIndex.GROUND_SALE_AREA as GROUND_CAN_SELL_AREA,--GROUND_CAN_SELL_AREA" IS '地上可售面积';
        pIndex.UNDERGROUND_SALE_AREA as UNDERGROUND_CAN_SELL_AREA,-- IS '地下可售面积';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT  as TOTAL_CARPORT,--'总车位数';
        0 as GROUND_CARPORT,-- '地上车位数';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT as UNDERGROUND_CARPORT,-- '地下车位数';
        ------0 AVERAGE_PRICE,-- '均价（手动录入）'
         ------0 WORTH,-- '均价（手动录入）'
        l_UUID as TARGET_WORTH_ID,--'货值主键';
         case when ph.objtype='项目' then 0 
        when  ph.objtype='分期' then 20 
        when  ph.objtype='楼栋' then 30 end as
        OBJ_TYPE,-- '对象类型（0：项目；20：分期；30：楼栋;40业态）';
        pIndex.OBJ_PHASE_ID as OBJ_PHASE_ID,
        obj_base.parent_id||l_UUID as WORTH_DTL_PARENT_ID ,obj_base.obj_id as OBJ_PARENT_ID,
       '' as PRODUCT_TYPE_ID
from obj_base obj_base
--所有阶段
left join obj_phase ph on obj_base.obj_id=ph.obj_id
--阶段指标
left join MDM_OBJ_PHASE_INDEX pIndex on ph.instance_id =pIndex.OBJ_PHASE_ID
--只查询全盘计划版 项目和分期指标。
where  ph.phase_name='全盘计划版' and (ph.objtype='项目' or ph.objtype='分期' ) and obj_base.objtype<>'楼栋' ) 

,全盘版本业态 as (
---查询项目业态指标
 select 
        pIndex.id,
         '全盘版本' 类型,
         PHASE_NAME,
        pIndex.product_type_name as OBJ_NAME,
        pIndex.product_type_id as OBJ_ID,
        pIndex.OPERATE_ATTRIBUTE_ID as OPERATE_ATTRIBUTE_ID,
        pIndex.OPERATE_ATTRIBUTE_NAME as OPERATE_ATTRIBUTE_NAME,
        pIndex.GROUND_TOTAL_BUILD_AREA+pIndex.UNDERGROUND_TOTAL_BUILD_AREA as TOTAL_BUILD_AREA,
        pIndex.GROUND_CAPACITY_AREA+pIndex.UNDERGROUND_CAPACITY_AREA as TOTAL_VOLUME_AREA,--'总计容面积'
        pIndex.TOTAL_SALE_AREA as TOTAL_SALES_AREA,---'总可售面积';
        pIndex.GROUND_SALE_AREA as GROUND_CAN_SELL_AREA,--GROUND_CAN_SELL_AREA" IS '地上可售面积';
        pIndex.UNDERGROUND_SALE_AREA as UNDERGROUND_CAN_SELL_AREA,-- IS '地下可售面积';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT  as TOTAL_CARPORT,--'总车位数';
        0 as GROUND_CARPORT,-- '地上车位数';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT as UNDERGROUND_CARPORT,-- '地下车位数';
        ------0 AVERAGE_PRICE,-- '均价（手动录入）'
         ------0 WORTH,-- '均价（手动录入）'
        l_UUID as TARGET_WORTH_ID,--'货值主键';
        40 OBJ_TYPE,-- '对象类型（0：项目；20：分期；30：楼栋40业态）';
        全盘版本对象.OBJ_PHASE_ID as OBJ_PHASE_ID,
        全盘版本对象.id as WORTH_DTL_PARENT_ID ,
        全盘版本对象.OBJ_ID as OBJ_PARENT_ID,
        pIndex.PRODUCT_TYPE_ID

from  MDM_OBJ_PHASE_PT_INDEX pIndex 
left join 全盘版本对象 全盘版本对象 on pIndex.OBJ_PHASE_ID=全盘版本对象.OBJ_PHASE_ID
--只查询全盘计划版 分期业态指标。
where (全盘版本对象.OBJ_TYPE=20 )
)
,
-------------------------------------------=======动态版本---动态版本---动态版本---动态版本---动态版本---动态版本---动态版本
---项目和分期和楼栋,获取最新已审核阶段的数据
动态版本对象base as (
---查询主数据项目，分期，楼栋最新阶段的指标
select  obj_base.obj_id||l_UUID as id,
        '动态版本' 类型,
        newph.PHASE_NAME,
        obj_base.obj_name as OBJ_NAME,
        obj_base.obj_id as OBJ_ID,
        '' as OPERATE_ATTRIBUTE_ID,
        '' as OPERATE_ATTRIBUTE_NAME,
        pIndex.OVERALL_FLOORAGE_AREA as TOTAL_BUILD_AREA,
        pIndex.TOTAL_CAPACITY_AREA as TOTAL_VOLUME_AREA,--'总计容面积'
        pIndex.TOTAL_SALE_AREA as TOTAL_SALES_AREA,---'总可售面积';
        pIndex.GROUND_SALE_AREA as GROUND_CAN_SELL_AREA,--GROUND_CAN_SELL_AREA" IS '地上可售面积';
        pIndex.UNDERGROUND_SALE_AREA as UNDERGROUND_CAN_SELL_AREA,-- IS '地下可售面积';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT  as TOTAL_CARPORT,--'总车位数';
        0 as GROUND_CARPORT,-- '地上车位数';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT as UNDERGROUND_CARPORT,-- '地下车位数';
        ------0 AVERAGE_PRICE,-- '均价（手动录入）'
         ------0 WORTH,-- '均价（手动录入）'
        l_UUID as TARGET_WORTH_ID,--'货值主键';
        case when newph.objtype='项目' then 0 
        when  newph.objtype='分期' then 20 
        when  newph.objtype='楼栋' then 30 end as
        OBJ_TYPE,-- '对象类型（0：项目；20：分期；30：楼栋;40业态）';
        pIndex.OBJ_PHASE_ID as OBJ_PHASE_ID,
        obj_base.parent_id||l_UUID as WORTH_DTL_PARENT_ID ,
        obj_base.obj_id as OBJ_PARENT_ID,
       '' as PRODUCT_TYPE_ID
from obj_base obj_base
--最新阶段
left join obj_new_phase newph on obj_base.obj_id=newph.obj_id
--最新阶段指标
left join MDM_OBJ_PHASE_INDEX pIndex on newph.instance_id =pIndex.OBJ_PHASE_ID)
--动态可研或全盘阶段 项目和分期
,动态可研或全盘阶段 as (select * from 动态版本对象base where (obj_type=20 and PHASE_NAME='全盘计划版') 
or (obj_type=0 and PHASE_NAME='可研版') )
--去掉可研全盘版基础对象的子级（分期或楼栋）
,动态版本对象 as (select base.* from 动态版本对象base base
left join 动态可研或全盘阶段 d on base.WORTH_DTL_PARENT_ID=d.id
where d.id is null
)

,动态版本业态 as (
---查询项目业态指标
 select 
        pIndex.id,
        '动态版本' 类型,
        动态版本对象.PHASE_NAME,
        pIndex.product_type_name as OBJ_NAME,
        pIndex.product_type_id as OBJ_ID,
        pIndex.OPERATE_ATTRIBUTE_ID as OPERATE_ATTRIBUTE_ID,
        pIndex.OPERATE_ATTRIBUTE_NAME as OPERATE_ATTRIBUTE_NAME,
        pIndex.GROUND_TOTAL_BUILD_AREA+pIndex.UNDERGROUND_TOTAL_BUILD_AREA as TOTAL_BUILD_AREA,--总建筑面积
        pIndex.GROUND_CAPACITY_AREA+pIndex.UNDERGROUND_CAPACITY_AREA as TOTAL_VOLUME_AREA,--'总计容面积'
        pIndex.TOTAL_SALE_AREA as TOTAL_SALES_AREA,---'总可售面积';
        pIndex.GROUND_SALE_AREA as GROUND_CAN_SELL_AREA,--GROUND_CAN_SELL_AREA" IS '地上可售面积';
        pIndex.UNDERGROUND_SALE_AREA as UNDERGROUND_CAN_SELL_AREA,-- IS '地下可售面积';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT  as TOTAL_CARPORT,--'总车位数';
        0 as GROUND_CARPORT,-- '地上车位数';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT as UNDERGROUND_CARPORT,-- '地下车位数';
        ------0 AVERAGE_PRICE,-- '均价（手动录入）'
         ------0 WORTH,-- '均价（手动录入）'
        l_UUID as TARGET_WORTH_ID,--'货值主键';
        40 OBJ_TYPE,-- '对象类型（0：项目；20：分期；30：楼栋40业态）';
        动态版本对象.OBJ_PHASE_ID as OBJ_PHASE_ID,
        动态版本对象.id as WORTH_DTL_PARENT_ID, 
        动态版本对象.OBJ_ID as OBJ_PARENT_ID,
        pIndex.PRODUCT_TYPE_ID
        from MDM_OBJ_PHASE_PT_INDEX pIndex
        left join 动态版本对象 动态版本对象  on pIndex.OBJ_PHASE_ID=动态版本对象.OBJ_PHASE_ID
        where (动态版本对象.OBJ_TYPE=30 or
        pindex.OBJ_PHASE_ID in (select OBJ_PHASE_ID from 动态可研或全盘阶段) )
)

,计算 as(select pv.*,nvl(lw.AVERAGE_PRICE,0) as AVERAGE_PRICE_temp
,nvl(lw.AVERAGE_PRICE*(pv.TOTAL_CARPORT+pv.GROUND_CAN_SELL_AREA),0) as WORTH_temp
from (
        -----可研
        select * from 可研版本对象 where 1=case when i_target_worth_phase=0 then 1 else 0 end
        union all
        select * from 可研版本业态 where 1=case when i_target_worth_phase=0 then 1 else 0 end
        -----全盘
        union all
        select * from 全盘版本对象 where 1=case when i_target_worth_phase=10 then 1 else 0 end
        union all
        select * from 全盘版本业态 where 1=case when i_target_worth_phase=10 then 1 else 0 end
        ---动态
        union all
        select * from 动态版本对象 where 1=case when i_target_worth_phase=20 then 1 else 0 end
        union all
        select * from 动态版本业态 where 1=case when i_target_worth_phase=20 then 1 else 0 end
        ) pv left join latest_target_worth lw 
        on pv.OBJ_ID=lw.OBJ_ID and pv.obj_parent_id=lw.obj_parent_id)
--------------汇总货值
 , 汇总 as( select s.*,(select sum(WORTH_temp) from 计算 start with id=s.id connect by prior id=WORTH_DTL_PARENT_ID) as  WORTH_yuan
 from 计算 s)

,结果 as ( SELECT  GET_UUID() AS "id"
,汇总.TARGET_WORTH_ID AS "targetWorthId"
,汇总.PHASE_NAME AS "phaseName"
,汇总.类型 AS "类型"
,汇总.id as "worthDtlId"---【WORTH_DTL_ID】树id
,汇总.WORTH_DTL_PARENT_ID AS "worthDtlParentId"----【WORTH_DTL_PARENT_ID】 树父级id
,汇总.OBJ_PHASE_ID AS "objPhaseId"----"DWM_TARGET_WORTH_DTL"."OBJ_PHASE_ID" IS '对象阶段id';
,汇总.TOTAL_BUILD_AREA AS "totalBuildArea"----"DWM_TARGET_WORTH_DTL"."TOTAL_BUILD_AREA" IS '总建筑面积';
,汇总.TOTAL_VOLUME_AREA AS "totalVolumeArea"----"DWM_TARGET_WORTH_DTL"."TOTAL_VOLUME_AREA" IS '总计容面积';
,汇总.OBJ_PARENT_ID AS "objParentId"--"DWM_TARGET_WORTH_DTL"."OBJ_PARENT_ID" IS '对象父级id';
,汇总.OPERATE_ATTRIBUTE_NAME AS "operateAttributeName"---"DWM_TARGET_WORTH_DTL"."OPERATE_ATTRIBUTE_NAME" IS '经营属性名称';
,汇总.OBJ_NAME AS "objName"----"DWM_TARGET_WORTH_DTL"."OBJ_NAME" IS '对象名称（项目名称、分期名称、业态名称）';
,汇总.OBJ_ID AS "objId"----"DWM_TARGET_WORTH_DTL"."OBJ_ID" IS '对象id';
,汇总.GROUND_CAN_SELL_AREA AS "groundCanSellArea"--"DWM_TARGET_WORTH_DTL"."GROUND_CAN_SELL_AREA" IS '地上可售面积';
,汇总.GROUND_CARPORT AS "groundCarport"---"DWM_TARGET_WORTH_DTL"."GROUND_CARPORT" IS '地上车位数';
,汇总.OPERATE_ATTRIBUTE_ID AS "operateAttributeId"---."DWM_TARGET_WORTH_DTL"."OPERATE_ATTRIBUTE_ID" IS '经营属性Id';
,汇总.UNDERGROUND_CARPORT AS "undergroundCarport"---"DWM_TARGET_WORTH_DTL"."UNDERGROUND_CARPORT" IS '地下车位数';
,汇总.OBJ_TYPE AS "objType"---."DWM_TARGET_WORTH_DTL"."OBJ_TYPE" IS '对象类型（0：项目；20：分期；30：楼栋40业态）';
,汇总.TOTAL_CARPORT AS "totalCarport"---"DWM_TARGET_WORTH_DTL"."TOTAL_CARPORT" IS '总车位数';
,汇总.TOTAL_SALES_AREA AS "totalSalesArea"----."DWM_TARGET_WORTH_DTL"."TOTAL_SALES_AREA" IS '总可售面积';
,汇总.UNDERGROUND_CAN_SELL_AREA AS "undergroundCanSellArea"--"DWM_TARGET_WORTH_DTL"."UNDERGROUND_CAN_SELL_AREA" IS '地下可售面积';
,CASE WHEN (TOTAL_CARPORT+GROUND_CAN_SELL_AREA)=0 THEN 0 ELSE WORTH_yuan/(TOTAL_CARPORT+GROUND_CAN_SELL_AREA) END
AS "averagePrice"---"DWM_TARGET_WORTH_DTL"."AVERAGE_PRICE" IS '均价（手动录入）';
,WORTH_yuan/10000 AS "worth"----"DWM_TARGET_WORTH_DTL"."WORTH" IS '货值';
,pt.is_carport as "isCarport"---"DWM_TARGET_WORTH_DTL"."IS_CARPORT" IS '是否车位,1:是,0:否';
,WORTH_yuan
FROM 汇总
left join MDM_BUILD_PRODUCT_TYPE pt on 汇总.PRODUCT_TYPE_ID=pt.id)

select * from 结果
;

END P_DWM_TARGET_WORTH_REF;
----------------------------------------------chenl20200621结束------从主数据刷新目标货值存储过程


----------------------------------------------chenl20200621开始------从主数据刷新目标货值存储过程注册
/

prompt
prompt Creating procedure P_DWM_TARGET_WORTH_REF1
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_TARGET_WORTH_REF1 (
    USERID   IN   VARCHAR2,
    STATIONID    IN  VARCHAR2,
    DEPTID   IN   VARCHAR2,
    COMPANYID IN VARCHAR2,
    i_projectId    IN               VARCHAR2,---项目id
    i_target_worth_phase    IN               VARCHAR2:=0 ---货值阶段（0：可研版目标货值，10：全盘开发计划版目标货值，20：动态版目标货值）
    ,o_target_worth out  SYS_REFCURSOR
) AS
		--获取目标货值。可研版本货值,全盘版本目标货值，动态版本目标货值（只是获取，未到数据库）
        --调用范围：货值管理系统目标货值刷新
		--作者：陈丽
		--日期：2020-06-14
l_created date:=sysdate;
l_UUID varchar2(36):=GET_UUID();
BEGIN
open o_TARGET_WORTH for
with 
-------------------------------------------=======对象基本信息，项目，分期，楼栋
obj_base as(
select id as obj_id,PROJECT_NAME as obj_name,UNIT_ID as parent_id,'项目' as objtype from sys_project obj_base where id=i_projectId
union all
select id as obj_id,STAGE_NAME as obj_name,project_id  as parent_id,'分期' as objtype from sys_project_stage where project_id=i_projectId
union all
select id as obj_id,BUILD_NAME as obj_name,period_id  as parent_id,'楼栋' as objtype from sys_build where PROJ_ID=i_projectId
),
-------------------------------------------=======已审核的对象阶段实例 状态（10：激活（未审核）；15：审核中，19：已审核；20：已成完成（即创建了下一个版本）
obj_phase as(
select pp.ID as instance_id,pp.PROJ_ID as obj_id,proj.PROJECT_NAME as obj_name,mp.PHASE_NAME,mp.PHASE_ORDER,'项目' as objtype from MDM_PROJECT_PHASE  pp
left join mdm_phase mp on pp.PHASE_ID=mp.id
left join sys_project proj on pp.PROJ_ID=proj.id
--审核或者已创建下一阶段
where pp.PROJ_ID=i_projectId and (PHASE_STATE=19 or PHASE_STATE=20)
union all
select p.ID as  instance_id,p.PERIOD_ID as obj_id,stage.STAGE_NAME as obj_name,mp.PHASE_NAME,mp.PHASE_ORDER ,'分期' as objtype from MDM_PERIOD_PHASE p
left join sys_project_stage stage on p.PERIOD_ID=stage.id
left join mdm_phase mp on p.PHASE_ID=mp.id
--审核或者已创建下一阶段
where stage.project_id=i_projectId and (PHASE_STATE=19 or PHASE_STATE=20)
union all
select b.ID as instance_id,b.BUILD_ID as obj_id,build.BUILD_NAME as obj_name,mp.PHASE_NAME,mp.PHASE_ORDER ,'楼栋' as objtype from MDM_BUILD_PHASE b
left join sys_build build on b.BUILD_ID=build.id
left join sys_project proj on build.PROJ_ID=proj.id
left join mdm_phase mp on b.PHASE_ID=mp.id
--审核或者已创建下一阶段
where proj.id=i_projectId and (PHASE_STATE=19 or PHASE_STATE=20) 
),
-------------------------------------------=======最新已审核阶段实例
obj_new_phase as
(
select * from (select obj_phase.*,row_number() over(partition by obj_id order by PHASE_ORDER desc) as order_num from obj_phase )obj_phase_order where order_num = 1
),
-------------------------------------------=======最新已审核目标货值--用于新增引入上一个已审核单价
latest_target_worth as
(select * from (select latest_tw.*,row_number() over(partition by OBJ_ID,obj_parent_id order by target_worth_phase,worth_v desc) as order_num from 
(select dtl.OBJ_ID,dtl.AVERAGE_PRICE,dtl.obj_parent_id,worth_v,target_worth_phase,dtl.obj_name 
,dtl.WORTH_DTL_PARENT_ID,dtl.WORTH_DTL_ID
from DWM_TARGET_WORTH_DTL dtl
left join DWM_TARGET_WORTH  w on dtl.TARGET_WORTH_ID=w.id
left join DWM_TARGET_WORTH_DTL parentdtl on dtl.obj_parent_id=parentdtl.obj_id
--已审核并且等于业态的
where  approval_status='已审核' and dtl.OBJ_TYPE=40  and w.proj_id =i_projectId) latest_tw
)obj_phase_order where order_num = 1
),
-------------------------------------------=======查询可研版本---查询可研版本---查询可研版本---查询可研版本---查询可研版本---查询可研版本
可研版本对象 as (
select  obj_base.obj_id||l_UUID as id,
        '可研版本' 类型,
        PHASE_NAME,
        obj_base.obj_name as OBJ_NAME,
        ph.obj_id as OBJ_ID,
        '' as OPERATE_ATTRIBUTE_ID,
        '' as OPERATE_ATTRIBUTE_NAME,
        0 as TOTAL_BUILD_AREA,
        0 as TOTAL_VOLUME_AREA,--'总计容面积'
        0 as TOTAL_SALES_AREA,---'总可售面积';
        0 as GROUND_CAN_SELL_AREA,--GROUND_CAN_SELL_AREA" IS '地上可售面积';
        0 as UNDERGROUND_CAN_SELL_AREA,-- IS '地下可售面积';
        0  as TOTAL_CARPORT,--'总车位数';
        0 as GROUND_CARPORT,-- '地上车位数';
        0 as UNDERGROUND_CARPORT,-- '地下车位数';
        ------0 AVERAGE_PRICE,-- '均价（手动录入）'
        ------0 WORTH,-- '均价（手动录入）'
        l_UUID as TARGET_WORTH_ID,--'货值主键';
       case when ph.objtype='项目' then 0 
        when  ph.objtype='分期' then 20 
        when ph.objtype='楼栋' then 30 end as
        OBJ_TYPE,-- '对象类型（0：项目；20：分期；30：楼栋;40业态）';
        ph.instance_id as OBJ_PHASE_ID,
        obj_base.parent_id||l_UUID as WORTH_DTL_PARENT_ID,obj_base.obj_id  as OBJ_PARENT_ID,
        '' as PRODUCT_TYPE_ID
from obj_base obj_base
--所有阶段
left join obj_phase ph on obj_base.obj_id=ph.obj_id
--阶段指标
--left join MDM_OBJ_PHASE_INDEX pIndex on ph.instance_id =pIndex.OBJ_PHASE_ID
--只查询可研版本计划
where  ph.phase_name='可研版' and obj_base.objtype='项目' 
)

,可研版本业态 as (
---查询项目业态指标
 select 
        pIndex.id id,
         '可研版本' 类型,
         PHASE_NAME,
        pIndex.product_type_name as OBJ_NAME,
        pIndex.product_type_id as OBJ_ID,
        pIndex.OPERATE_ATTRIBUTE_ID as OPERATE_ATTRIBUTE_ID,
        pIndex.OPERATE_ATTRIBUTE_NAME as OPERATE_ATTRIBUTE_NAME,
        pIndex.GROUND_TOTAL_BUILD_AREA+pIndex.UNDERGROUND_TOTAL_BUILD_AREA as TOTAL_BUILD_AREA,
        pIndex.GROUND_CAPACITY_AREA+pIndex.UNDERGROUND_CAPACITY_AREA as TOTAL_VOLUME_AREA,--'总计容面积'
        pIndex.TOTAL_SALE_AREA as TOTAL_SALES_AREA,---'总可售面积';
        pIndex.GROUND_SALE_AREA as GROUND_CAN_SELL_AREA,--GROUND_CAN_SELL_AREA" IS '地上可售面积';
        pIndex.UNDERGROUND_SALE_AREA as UNDERGROUND_CAN_SELL_AREA,-- IS '地下可售面积';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT  as TOTAL_CARPORT,--'总车位数';
        0 as GROUND_CARPORT,-- '地上车位数';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT as UNDERGROUND_CARPORT,-- '地下车位数';
        ------0 AVERAGE_PRICE,-- '均价（手动录入）'
         ------0 WORTH,-- '均价（手动录入）'
        l_UUID as TARGET_WORTH_ID,--'货值主键';
        40 OBJ_TYPE,-- '对象类型（0：项目；20：分期；30：楼栋40业态）';
        可研版本对象.OBJ_PHASE_ID as OBJ_PHASE_ID,
        可研版本对象.id as WORTH_DTL_PARENT_ID,
        可研版本对象.OBJ_ID as OBJ_PARENT_ID,
        pIndex.PRODUCT_TYPE_ID
--业态指标
from MDM_OBJ_PHASE_PT_INDEX pIndex 
left join 可研版本对象 可研版本对象 on pIndex.OBJ_PHASE_ID=可研版本对象.OBJ_PHASE_ID
--只查询可研 分期业态指标。
where (可研版本对象.OBJ_TYPE=0 ) 
--and 可研版本对象.id is not null
--只查询可研阶段 项目的业态指标。
--where  ph.phase_name='可研版' and ph.objtype='项目' 
),


-------------------------------------------=======全盘版本---全盘版本---全盘版本---全盘版本---全盘版本---全盘版本---全盘版本
---项目和分期
全盘版本对象 as (
select  obj_base.obj_id||l_UUID as id,
        '全盘版本' 类型,
        PHASE_NAME,
        obj_base.obj_name as OBJ_NAME,
        obj_base.obj_id as OBJ_ID,
        '' as OPERATE_ATTRIBUTE_ID,
        '' as OPERATE_ATTRIBUTE_NAME,
        0 as TOTAL_BUILD_AREA,
        0 as TOTAL_VOLUME_AREA,--'总计容面积'
        0 as TOTAL_SALES_AREA,---'总可售面积';
        0 as GROUND_CAN_SELL_AREA,--GROUND_CAN_SELL_AREA" IS '地上可售面积';
        0 as UNDERGROUND_CAN_SELL_AREA,-- IS '地下可售面积';
        0  as TOTAL_CARPORT,--'总车位数';
        0 as GROUND_CARPORT,-- '地上车位数';
        0 as UNDERGROUND_CARPORT,-- '地下车位数';
        ------0 AVERAGE_PRICE,-- '均价（手动录入）'
         ------0 WORTH,-- '均价（手动录入）'
        l_UUID as TARGET_WORTH_ID,--'货值主键';
         case when ph.objtype='项目' then 0 
        when  ph.objtype='分期' then 20 
        when  ph.objtype='楼栋' then 30 end as
        OBJ_TYPE,-- '对象类型（0：项目；20：分期；30：楼栋;40业态）';
        ph.instance_id as OBJ_PHASE_ID,
        obj_base.parent_id||l_UUID as WORTH_DTL_PARENT_ID ,obj_base.obj_id as OBJ_PARENT_ID,
       '' as PRODUCT_TYPE_ID
from obj_base obj_base
--所有阶段
left join obj_phase ph on obj_base.obj_id=ph.obj_id
--阶段指标
--left join MDM_OBJ_PHASE_INDEX pIndex on ph.instance_id =pIndex.OBJ_PHASE_ID
--只查询全盘计划版 项目和分期指标。
where  ph.phase_name='全盘计划版' and (ph.objtype='项目' or ph.objtype='分期' ) and obj_base.objtype<>'楼栋' ) 

,全盘版本业态 as (
---查询项目业态指标
 select 
        pIndex.id,
         '全盘版本' 类型,
         PHASE_NAME,
        pIndex.product_type_name as OBJ_NAME,
        pIndex.product_type_id as OBJ_ID,
        pIndex.OPERATE_ATTRIBUTE_ID as OPERATE_ATTRIBUTE_ID,
        pIndex.OPERATE_ATTRIBUTE_NAME as OPERATE_ATTRIBUTE_NAME,
        pIndex.GROUND_TOTAL_BUILD_AREA+pIndex.UNDERGROUND_TOTAL_BUILD_AREA as TOTAL_BUILD_AREA,
        pIndex.GROUND_CAPACITY_AREA+pIndex.UNDERGROUND_CAPACITY_AREA as TOTAL_VOLUME_AREA,--'总计容面积'
        pIndex.TOTAL_SALE_AREA as TOTAL_SALES_AREA,---'总可售面积';
        pIndex.GROUND_SALE_AREA as GROUND_CAN_SELL_AREA,--GROUND_CAN_SELL_AREA" IS '地上可售面积';
        pIndex.UNDERGROUND_SALE_AREA as UNDERGROUND_CAN_SELL_AREA,-- IS '地下可售面积';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT  as TOTAL_CARPORT,--'总车位数';
        0 as GROUND_CARPORT,-- '地上车位数';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT as UNDERGROUND_CARPORT,-- '地下车位数';
        ------0 AVERAGE_PRICE,-- '均价（手动录入）'
         ------0 WORTH,-- '均价（手动录入）'
        l_UUID as TARGET_WORTH_ID,--'货值主键';
        40 OBJ_TYPE,-- '对象类型（0：项目；20：分期；30：楼栋40业态）';
        全盘版本对象.OBJ_PHASE_ID as OBJ_PHASE_ID,
        全盘版本对象.id as WORTH_DTL_PARENT_ID ,
        全盘版本对象.OBJ_ID as OBJ_PARENT_ID,
        pIndex.PRODUCT_TYPE_ID

from  MDM_OBJ_PHASE_PT_INDEX pIndex 
left join 全盘版本对象 全盘版本对象 on pIndex.OBJ_PHASE_ID=全盘版本对象.OBJ_PHASE_ID
--只查询全盘计划版 分期业态指标。
where (全盘版本对象.OBJ_TYPE=20 )
)
,
-------------------------------------------=======动态版本---动态版本---动态版本---动态版本---动态版本---动态版本---动态版本
---项目和分期和楼栋,获取最新已审核阶段的数据
动态版本对象base as (
---查询主数据项目，分期，楼栋最新阶段的指标
select  obj_base.obj_id||l_UUID as id,
        '动态版本' 类型,
        newph.PHASE_NAME,
        obj_base.obj_name as OBJ_NAME,
        obj_base.obj_id as OBJ_ID,
        '' as OPERATE_ATTRIBUTE_ID,
        '' as OPERATE_ATTRIBUTE_NAME,
        0 as TOTAL_BUILD_AREA,
        0 as TOTAL_VOLUME_AREA,--'总计容面积'
        0 as TOTAL_SALES_AREA,---'总可售面积';
        0 as GROUND_CAN_SELL_AREA,--GROUND_CAN_SELL_AREA" IS '地上可售面积';
        0 as UNDERGROUND_CAN_SELL_AREA,-- IS '地下可售面积';
        0  as TOTAL_CARPORT,--'总车位数';
        0 as GROUND_CARPORT,-- '地上车位数';
        0 as UNDERGROUND_CARPORT,-- '地下车位数';
        ------0 AVERAGE_PRICE,-- '均价（手动录入）'
         ------0 WORTH,-- '均价（手动录入）'
        l_UUID as TARGET_WORTH_ID,--'货值主键';
        case when newph.objtype='项目' then 0 
        when  newph.objtype='分期' then 20 
        when  newph.objtype='楼栋' then 30 end as
        OBJ_TYPE,-- '对象类型（0：项目；20：分期；30：楼栋;40业态）';
        newph.instance_id as OBJ_PHASE_ID,
        obj_base.parent_id||l_UUID as WORTH_DTL_PARENT_ID ,
        obj_base.obj_id as OBJ_PARENT_ID,
       '' as PRODUCT_TYPE_ID
from obj_base obj_base
--最新阶段
left join obj_new_phase newph on obj_base.obj_id=newph.obj_id
--最新阶段指标
--left join MDM_OBJ_PHASE_INDEX pIndex on newph.instance_id =pIndex.OBJ_PHASE_ID
)
--动态可研或全盘阶段 项目和分期
,动态可研或全盘阶段 as (select * from 动态版本对象base where (obj_type=20 and PHASE_NAME='全盘计划版') 
or (obj_type=0 and PHASE_NAME='可研版') )
--去掉可研全盘版基础对象的子级（分期或楼栋）
,动态版本对象 as (select base.* from 动态版本对象base base
left join 动态可研或全盘阶段 d on base.WORTH_DTL_PARENT_ID=d.id
where d.id is null
)

,动态版本业态 as (
---查询项目业态指标
 select 
        pIndex.id,
        '动态版本' 类型,
        动态版本对象.PHASE_NAME,
        pIndex.product_type_name as OBJ_NAME,
        pIndex.product_type_id as OBJ_ID,
        pIndex.OPERATE_ATTRIBUTE_ID as OPERATE_ATTRIBUTE_ID,
        pIndex.OPERATE_ATTRIBUTE_NAME as OPERATE_ATTRIBUTE_NAME,
        pIndex.GROUND_TOTAL_BUILD_AREA+pIndex.UNDERGROUND_TOTAL_BUILD_AREA as TOTAL_BUILD_AREA,--总建筑面积
        pIndex.GROUND_CAPACITY_AREA+pIndex.UNDERGROUND_CAPACITY_AREA as TOTAL_VOLUME_AREA,--'总计容面积'
        pIndex.TOTAL_SALE_AREA as TOTAL_SALES_AREA,---'总可售面积';
        pIndex.GROUND_SALE_AREA as GROUND_CAN_SELL_AREA,--GROUND_CAN_SELL_AREA" IS '地上可售面积';
        pIndex.UNDERGROUND_SALE_AREA as UNDERGROUND_CAN_SELL_AREA,-- IS '地下可售面积';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT  as TOTAL_CARPORT,--'总车位数';
        0 as GROUND_CARPORT,-- '地上车位数';
        pIndex.UNDERGROUND_TOTAL_SALE_CARPORT as UNDERGROUND_CARPORT,-- '地下车位数';
        ------0 AVERAGE_PRICE,-- '均价（手动录入）'
         ------0 WORTH,-- '均价（手动录入）'
        l_UUID as TARGET_WORTH_ID,--'货值主键';
        40 OBJ_TYPE,-- '对象类型（0：项目；20：分期；30：楼栋40业态）';
        动态版本对象.OBJ_PHASE_ID as OBJ_PHASE_ID,
        动态版本对象.id as WORTH_DTL_PARENT_ID, 
        动态版本对象.OBJ_ID as OBJ_PARENT_ID,
        pIndex.PRODUCT_TYPE_ID
        from MDM_OBJ_PHASE_PT_INDEX pIndex
        left join 动态版本对象 动态版本对象  on pIndex.OBJ_PHASE_ID=动态版本对象.OBJ_PHASE_ID
        where (动态版本对象.OBJ_TYPE=30 or
        pindex.OBJ_PHASE_ID in (select OBJ_PHASE_ID from 动态可研或全盘阶段) )
)


,基础对象 as ( -----可研
        -----可研
        select * from 可研版本对象 where 1=case when i_target_worth_phase=0 then 1 else 0 end
        -----全盘
        union all
        select * from 全盘版本对象 where 1=case when i_target_worth_phase=10 then 1 else 0 end
        ---动态
        union all
        select * from 动态版本对象 where 1=case when i_target_worth_phase=20 then 1 else 0 end
       )

,基础业态 as ( select pv.*,nvl(lw.AVERAGE_PRICE,0) as AVERAGE_PRICE_temp
,nvl(lw.AVERAGE_PRICE*(pv.TOTAL_CARPORT+pv.GROUND_CAN_SELL_AREA),0) as WORTH_temp
from (     
        -----可研
        select * from 可研版本业态 where 1=case when i_target_worth_phase=0 then 1 else 0 end
        -----全盘
        union all
        select * from 全盘版本业态 where 1=case when i_target_worth_phase=10 then 1 else 0 end
        ---动态
        union all
        select * from 动态版本业态 where 1=case when i_target_worth_phase=20 then 1 else 0 end

        ) pv left join latest_target_worth lw 
        on pv.OBJ_ID=lw.OBJ_ID and pv.obj_parent_id=lw.obj_parent_id)

, 汇总 (
PHASE_NAME  
,类型
,id 
,WORTH_DTL_PARENT_ID 

)as( 
    select PHASE_NAME  
,类型
,id 
,WORTH_DTL_PARENT_ID 
from 基础业态 a1
UNION all select 
a1.PHASE_NAME  
,a1.类型
,a1.id 
,a1.WORTH_DTL_PARENT_ID 
 from  汇总 a1 INNER join 基础对象 a2 on a1.WORTH_DTL_PARENT_ID=a2.id 
)



select * from 汇总;
END P_DWM_TARGET_WORTH_REF1;
----------------------------------------------chenl20200621结束------从主数据刷新目标货值存储过程


----------------------------------------------chenl20200621开始------从主数据刷新目标货值存储过程注册
/

prompt
prompt Creating procedure P_DWM_TRENDMAP_K1
prompt ====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_TRENDMAP_K1
(
  orgIds IN clob 
, rateTye IN VARCHAR2 default 'count'
, pointsData  OUT sys_refcursor
, numerator  OUT sys_refcursor
, denominator  OUT sys_refcursor
, sellRate  OUT sys_refcursor
) AS 
BEGIN
   if rateTye IS NOT NULL AND rateTye = 'count' then
     open pointsData for 
--     SELECT 
--        ORG_NAME as "orgName",
--        FO_SALE_OUT_COUNT as "numerator",
--        FO_SALE_COUNT as "denominator",
--        FN_DWM_MULTIPLE_AND_UNIT(FO_SALE_RATE_BY_COUNT, 0.01, '') as "sellRate",
--        to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--        ORG_ID as "orgId",
--        RN as "rn"
--        FROM(
--            SELECT ORG_NAME, FO_SALE_OUT_COUNT, FO_SALE_COUNT, FO_SALE_RATE_BY_COUNT, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--            ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, FO_SALE_OUT_COUNT, FO_SALE_COUNT, FO_SALE_RATE_BY_COUNT, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--            ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--            (SELECT COLUMN_VALUE FROM table (split (orgIds))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--   WHERE RN <= 12);
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.FO_SALE_COUNT is null then 0 else  tab.FO_SALE_COUNT end  as "denominator",
             case when tab.FO_SALE_OUT_COUNT is null then 0 else  tab.FO_SALE_OUT_COUNT end  as "numerator",
             case when tab.FO_SALE_RATE_BY_COUNT is null then 0 else  trunc(tab.FO_SALE_RATE_BY_COUNT*100 ,2)end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, FO_SALE_OUT_COUNT, FO_SALE_COUNT, FO_SALE_RATE_BY_COUNT, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.FO_SALE_COUNT,rateTable.FO_SALE_RATE_BY_COUNT,rateTable.FO_SALE_OUT_COUNT
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '首开去化套数' as "prefix", '套' as "suffix" from dual;
        open denominator for select '首开推售套数' as "prefix", '套' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
        ELSIF rateTye IS NOT NULL AND rateTye = 'area' THEN
        open pointsData for 
--        SELECT 
--            ORG_NAME as "orgName",
--            FN_DWM_MULTIPLE_AND_UNIT(FO_SALE_OUT_AREA, 10000, '') as "numerator",
--            FN_DWM_MULTIPLE_AND_UNIT(FO_SALE_AREA, 10000, '') as "denominator",
--            FN_DWM_MULTIPLE_AND_UNIT(FO_SALE_RATE_BY_AREA, 0.01, '') as "sellRate",
--            to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--            ORG_ID as "orgId",
--            RN as "rn"
--        FROM(
--            SELECT ORG_NAME, FO_SALE_OUT_AREA, FO_SALE_AREA, FO_SALE_RATE_BY_AREA, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--            ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, FO_SALE_OUT_AREA, FO_SALE_AREA, FO_SALE_RATE_BY_AREA, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--            ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--            (SELECT COLUMN_VALUE FROM table (split (orgIds))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--   WHERE RN <= 12);
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.FO_SALE_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FO_SALE_AREA, 10000, '') end  as "denominator",
             case when tab.FO_SALE_OUT_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FO_SALE_OUT_AREA, 10000, '') end  as "numerator",
             case when tab.FO_SALE_RATE_BY_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FO_SALE_RATE_BY_AREA, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, FO_SALE_OUT_AREA, FO_SALE_AREA, FO_SALE_RATE_BY_AREA, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.FO_SALE_AREA,rateTable.FO_SALE_RATE_BY_AREA,rateTable.FO_SALE_OUT_AREA
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '首开去化面积' as "prefix", '万方' as "suffix" from dual;
        open denominator for select '首开推售面积' as "prefix", '万方' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
    ELSIF rateTye IS NOT NULL AND rateTye = 'money' THEN
        open pointsData for 
--        SELECT 
--            ORG_NAME as "orgName",
--            FN_DWM_MULTIPLE_AND_UNIT(FO_SALE_OUT_MONEY, 100000000, '') as "numerator",
--            FN_DWM_MULTIPLE_AND_UNIT(FO_SALE_MONEY, 100000000, '') as "denominator",
--            FN_DWM_MULTIPLE_AND_UNIT(FO_SALE_RATE_BY_MONEY, 0.01, '') as "sellRate",
--            to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--            ORG_ID as "orgId",
--            RN as "rn"
--        FROM(
--            SELECT ORG_NAME, FO_SALE_OUT_MONEY, FO_SALE_MONEY, FO_SALE_RATE_BY_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--            ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, FO_SALE_OUT_MONEY, FO_SALE_MONEY, FO_SALE_RATE_BY_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--            ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--            (SELECT COLUMN_VALUE FROM table (split (orgIds))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--   WHERE RN <= 12);
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.FO_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FO_SALE_MONEY, 100000000, '') end  as "denominator",
             case when tab.FO_SALE_OUT_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FO_SALE_OUT_MONEY, 100000000, '') end  as "numerator",
             case when tab.FO_SALE_RATE_BY_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.FO_SALE_RATE_BY_MONEY, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, FO_SALE_OUT_MONEY, FO_SALE_MONEY, FO_SALE_RATE_BY_MONEY, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.FO_SALE_MONEY,rateTable.FO_SALE_RATE_BY_MONEY,rateTable.FO_SALE_OUT_MONEY
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '首开去化货值' as "prefix", '亿元' as "suffix" from dual;
        open denominator for select '首开推售货值' as "prefix", '亿元' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
   end if;

EXCEPTION
WHEN OTHERS THEN
  CLOSE pointsData;
  CLOSE numerator;
  CLOSE denominator;
  CLOSE sellRate;   
END P_DWM_TRENDMAP_K1;
/

prompt
prompt Creating procedure P_DWM_TRENDMAP_K2
prompt ====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_TRENDMAP_K2(orgIds in clob,pointsData out sys_refcursor,numerator out sys_refcursor,denominator out sys_refcursor,sellRate out sys_refcursor)
as
numeratorVlue number :=200;
sellRateValue number :=10;
orgIdsStr clob :='';
indexNum number:=0;
begin
delete DWM_RATE_TRENDMAP;
if orgIds is not null then 
orgIdsStr:=orgIds;
    for item in ( SELECT id,org_name FROM
    sys_business_unit where id in (SELECT COLUMN_VALUE FROM table (split (orgIdsStr)))) loop
            insert into DWM_RATE_TRENDMAP(x_xAxisPeriod,denominator,numerator,sellRate,orgId,orgName,sort)
            select 
            mm as "x_xAxisPeriod", 
            case when "denominator" is null then 0 else "denominator" end as "denominator" ,
            case when "numerator" is null then 0 else "numerator" end as "numerator",
            case when "sellRate" is null then 0 else "sellRate" end as "sellRate",
            item.id,
            item.org_name,
            months."index"
           from (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab) months
            left join (
            select tab1."denominator",trunc(tab1."numerator"/31,1) as "numerator",tab1."month", trunc(tab1."numerator"/tab1."denominator"/31,1) as "sellRate"
            from (
            select count(1) as "denominator",sum(FIRST_OPEN_DURATION_BY_TL) as "numerator","month" from
            (select proj.*,to_char(proj.first_open_date,'yyyy-mm') as "month" from DWM_SALE_RATE_PROJECT proj inner join
            (select * from SYS_BUSINESS_UNIT m start with m.id =item.id connect by m.parent_id=prior m.id) orgs
            on proj.org_id=orgs.id where proj.first_open_date is not null ) tab 
            group by tab."month") tab1 ) tab2
            on months.mm=tab2."month";
      end loop;    
      OPEN pointsData FOR select  to_char(to_date(x_xAxisPeriod||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"')  as "xAxisPeriod",denominator as "denominator",numerator as "numerator",sellRate as "sellRate",
      orgId as "orgId",orgName as "orgName",sort as "rn"
      from DWM_RATE_TRENDMAP order by sort;
end if;
  open numerator for select 
  '总计拿地至首开时长' as "prefix",
  '月' as "suffix"
  from  dual;
   open denominator for select 
  '首开项目数量' as "prefix",
  '个' as "suffix"
  from  dual;
   open sellRate for select 
  '平均拿地至首开时长' as "prefix",
  '月' as "suffix"
  from  dual;

EXCEPTION
WHEN OTHERS THEN
  CLOSE pointsData;
  CLOSE numerator;
  CLOSE denominator;
  CLOSE sellRate;
end P_DWM_TRENDMAP_K2;
/

prompt
prompt Creating procedure P_DWM_TRENDMAP_K3
prompt ====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_TRENDMAP_K3
(
  rateTye IN VARCHAR2 default 'count'
, orgIds IN clob 
, pointsData OUT sys_refcursor
, numerator OUT sys_refcursor 
, denominator OUT sys_refcursor
, sellRate OUT sys_refcursor 
) AS 
BEGIN
  if rateTye IS NOT NULL AND rateTye = 'count' then
     open pointsData for 
--     SELECT 
--        ORG_NAME as "orgName",
--        PO_SALE_OUT_COUNT as "numerator",
--        PO_SALE_COUNT as "denominator",
--        FN_DWM_MULTIPLE_AND_UNIT(PO_SALE_RATE_BY_COUNT, 0.01, '') as "sellRate",
--        to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--        ORG_ID as "orgId",
--        RN as "rn"
--        FROM(
--            SELECT ORG_NAME, PO_SALE_OUT_COUNT, PO_SALE_COUNT, PO_SALE_RATE_BY_COUNT, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, PO_SALE_OUT_COUNT, PO_SALE_COUNT, PO_SALE_RATE_BY_COUNT, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--                (SELECT COLUMN_VALUE FROM table (split (orgIds))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--       WHERE RN <= 12
--        );
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.PO_SALE_COUNT is null then 0 else  tab.PO_SALE_COUNT end  as "denominator",
             case when tab.PO_SALE_OUT_COUNT is null then 0 else  tab.PO_SALE_OUT_COUNT end  as "numerator",
             case when tab.PO_SALE_RATE_BY_COUNT is null then '0' else  FN_DWM_MULTIPLE_AND_UNIT(tab.PO_SALE_RATE_BY_COUNT, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, PO_SALE_OUT_COUNT, PO_SALE_COUNT, PO_SALE_RATE_BY_COUNT, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.PO_SALE_COUNT,rateTable.PO_SALE_RATE_BY_COUNT,rateTable.PO_SALE_OUT_COUNT
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '全案去化套数' as "prefix", '套' as "suffix" from dual;
        open denominator for select '全案推售套数' as "prefix", '套' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
   ELSIF rateTye IS NOT NULL AND rateTye = 'area' THEN
        open pointsData for 
--        SELECT 
--            ORG_NAME as "orgName",
--            FN_DWM_MULTIPLE_AND_UNIT(PO_SALE_OUT_AREA, 10000, '') as "numerator",
--            FN_DWM_MULTIPLE_AND_UNIT(PO_SALE_AREA, 10000, '') as "denominator",
--            FN_DWM_MULTIPLE_AND_UNIT(PO_SALE_RATE_BY_AREA, 0.01, '') as "sellRate",
--            to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--            ORG_ID as "orgId",
--            RN as "rn"
--        FROM(
--            SELECT ORG_NAME, PO_SALE_OUT_AREA, PO_SALE_AREA, PO_SALE_RATE_BY_AREA, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, PO_SALE_OUT_AREA, PO_SALE_AREA, PO_SALE_RATE_BY_AREA, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--                (SELECT COLUMN_VALUE FROM table (split (orgIds))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--       WHERE RN <= 12
--        );
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.PO_SALE_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.PO_SALE_AREA, 10000, '') end  as "denominator",
             case when tab.PO_SALE_OUT_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.PO_SALE_OUT_AREA, 10000, '') end  as "numerator",
             case when tab.PO_SALE_RATE_BY_AREA is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.PO_SALE_RATE_BY_AREA, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, PO_SALE_OUT_AREA, PO_SALE_AREA, PO_SALE_RATE_BY_AREA, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.PO_SALE_AREA,rateTable.PO_SALE_RATE_BY_AREA,rateTable.PO_SALE_OUT_AREA
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '全案去化面积' as "prefix", '万方' as "suffix" from dual;
        open denominator for select '全案推售面积' as "prefix", '万方' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
    ELSIF rateTye IS NOT NULL AND rateTye = 'money' THEN
        open pointsData for 
--        SELECT 
--            ORG_NAME as "orgName",
--            FN_DWM_MULTIPLE_AND_UNIT(PO_SALE_OUT_MONEY, 100000000, '') as "numerator",
--            FN_DWM_MULTIPLE_AND_UNIT(PO_SALE_MONEY, 100000000, '') as "denominator",
--            FN_DWM_MULTIPLE_AND_UNIT(PO_SALE_RATE_BY_MONEY, 0.01, '') as "sellRate",
--            to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--            ORG_ID as "orgId",
--            RN as "rn"
--        FROM(
--            SELECT ORG_NAME, PO_SALE_OUT_MONEY, PO_SALE_MONEY, PO_SALE_RATE_BY_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, PO_SALE_OUT_MONEY, PO_SALE_MONEY, PO_SALE_RATE_BY_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--                (SELECT COLUMN_VALUE FROM table (split (orgIds))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--       WHERE RN <= 12
--        );
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.PO_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.PO_SALE_MONEY, 100000000, '') end  as "denominator",
             case when tab.PO_SALE_OUT_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.PO_SALE_OUT_MONEY, 100000000, '') end  as "numerator",
             case when tab.PO_SALE_RATE_BY_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.PO_SALE_RATE_BY_MONEY, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, PO_SALE_OUT_MONEY, PO_SALE_MONEY, PO_SALE_RATE_BY_MONEY, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.PO_SALE_MONEY,rateTable.PO_SALE_RATE_BY_MONEY,rateTable.PO_SALE_OUT_MONEY
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgIds)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= 12) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= 12) tab;
        open numerator for select '全案去化货值' as "prefix", '亿元' as "suffix" from dual;
        open denominator for select '全案推售货值' as "prefix", '亿元' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;     
   end if;
   EXCEPTION
WHEN OTHERS THEN
  CLOSE pointsData;
  CLOSE numerator;
  CLOSE denominator;
 CLOSE sellRate;
END P_DWM_TRENDMAP_K3;
/

prompt
prompt Creating procedure P_DWM_TRENDMAP_K4_2
prompt ======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_TRENDMAP_K4_2
(
  orgId IN clob 
, pointsData OUT sys_refcursor
, numerator OUT sys_refcursor 
, denominator OUT sys_refcursor
, sellRate OUT sys_refcursor
, abscissa OUT sys_refcursor
) AS 
BEGIN
open pointsData for 
--SELECT 
--        ORG_NAME as "orgName",
--        FN_DWM_MULTIPLE_AND_UNIT(EH_SALE_OUT_MONEY, 100000000, '') as "numerator",
--        FN_DWM_MULTIPLE_AND_UNIT(EH_SALE_MONEY, 100000000, '') as "denominator",
--        FN_DWM_MULTIPLE_AND_UNIT(EH_SALE_RATE_BY_MONEY, 0.01, '') as "sellRate",
--        to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--        ORG_ID as "orgId",
--        RN as "rn"
--        FROM(
--            SELECT ORG_NAME, EH_SALE_OUT_MONEY, EH_SALE_MONEY, EH_SALE_RATE_BY_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, EH_SALE_OUT_MONEY, EH_SALE_MONEY, EH_SALE_RATE_BY_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--                (SELECT COLUMN_VALUE FROM table (split (orgId))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--       WHERE RN <= 12
--        );
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.EH_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.EH_SALE_MONEY, 100000000, '') end  as "denominator",
             case when tab.EH_SALE_OUT_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.EH_SALE_OUT_MONEY, 100000000, '') end  as "numerator",
             case when tab.EH_SALE_RATE_BY_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.EH_SALE_RATE_BY_MONEY, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, EH_SALE_OUT_MONEY, EH_SALE_MONEY, EH_SALE_RATE_BY_MONEY, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.EH_SALE_MONEY,rateTable.EH_SALE_RATE_BY_MONEY,rateTable.EH_SALE_OUT_MONEY
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgId)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= TO_NUMBER(TO_CHAR(sysdate,'mm'))) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= TO_NUMBER(TO_CHAR(sysdate,'mm'))) tab;  
        open abscissa for select to_char(TO_DATE(TO_CHAR(ADD_MONTHS(trunc(sysdate,'yyyy'), (ROWNUM-1)), 'yyyy-mm'),'yyyy-mm'),'yyyy"年"mm"月"') as "date" from DUAL connect by ROWNUM <= 12;    
        open numerator for select '竣备后签约货值' as "prefix", '亿元' as "suffix" from dual;
        open denominator for select '竣备时未签约货值' as "prefix", '亿元' as "suffix" from dual;
        open sellRate for select '现房去化率' as "prefix", '%' as "suffix" from dual;
EXCEPTION
WHEN OTHERS THEN
  CLOSE pointsData;
  CLOSE numerator;
  CLOSE denominator;
 CLOSE sellRate;
 CLOSE abscissa;
END P_DWM_TRENDMAP_K4_2;
/

prompt
prompt Creating procedure P_DWM_TRENDMAP_K4_3
prompt ======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_TRENDMAP_K4_3
(
  orgId IN clob 
, pointsData OUT sys_refcursor
, numerator OUT sys_refcursor 
, denominator OUT sys_refcursor
, sellRate OUT sys_refcursor
, abscissa OUT sys_refcursor
) AS 
BEGIN
 open pointsData for 
-- SELECT 
--        ORG_NAME as "orgName",
--        FN_DWM_MULTIPLE_AND_UNIT(EH_SALE_OUT_MONEY, 100000000, '') as "numerator",
--        FN_DWM_MULTIPLE_AND_UNIT(EH_SALE_MONEY, 100000000, '') as "denominator",
--        FN_DWM_MULTIPLE_AND_UNIT(EH_SURPLUS_SALE_MONEY, 100000000, '') as "sellRate",
--        to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--        ORG_ID as "orgId",
--        RN as "rn"
--        FROM(
--            SELECT ORG_NAME, EH_SALE_OUT_MONEY, EH_SALE_MONEY, EH_SURPLUS_SALE_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, EH_SALE_OUT_MONEY, EH_SALE_MONEY, EH_SURPLUS_SALE_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--                (SELECT COLUMN_VALUE FROM table (split (orgId))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--       WHERE RN <= 12
--        );
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.EH_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.EH_SALE_MONEY, 100000000, '') end  as "denominator",
             case when tab.EH_SALE_OUT_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.EH_SALE_OUT_MONEY, 100000000, '') end  as "numerator",
             case when tab.EH_SURPLUS_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.EH_SURPLUS_SALE_MONEY, 100000000, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, EH_SALE_OUT_MONEY, EH_SALE_MONEY, EH_SURPLUS_SALE_MONEY, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.EH_SALE_MONEY,rateTable.EH_SURPLUS_SALE_MONEY,rateTable.EH_SALE_OUT_MONEY
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgId)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= TO_NUMBER(TO_CHAR(sysdate,'mm'))) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= TO_NUMBER(TO_CHAR(sysdate,'mm'))) tab;
        open abscissa for select to_char(TO_DATE(TO_CHAR(ADD_MONTHS(trunc(sysdate,'yyyy'), (ROWNUM-1)), 'yyyy-mm'),'yyyy-mm'),'yyyy"年"mm"月"') as "date" from DUAL connect by ROWNUM <= 12;
        open numerator for select '竣备后签约货值' as "prefix", '亿元' as "suffix" from dual;
        open denominator for select '竣备时未签约货值' as "prefix", '亿元' as "suffix" from dual;
        open sellRate for select '剩余现房货值' as "prefix", '亿元' as "suffix" from dual;
EXCEPTION
WHEN OTHERS THEN
  CLOSE pointsData;
  CLOSE numerator;
  CLOSE denominator;
 CLOSE sellRate;
 CLOSE abscissa;        
END P_DWM_TRENDMAP_K4_3;
/

prompt
prompt Creating procedure P_DWM_TRENDMAP_K5_2
prompt ======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_TRENDMAP_K5_2
(
  orgId IN clob 
, pointsData OUT sys_refcursor
, numerator OUT sys_refcursor 
, denominator OUT sys_refcursor
, sellRate OUT sys_refcursor
, abscissa OUT sys_refcursor
) AS 
BEGIN
open pointsData for 
--SELECT 
--        ORG_NAME as "orgName",
--        FN_DWM_MULTIPLE_AND_UNIT(SI_SALE_OUT_MONEY, 100000000, '') as "numerator",
--        FN_DWM_MULTIPLE_AND_UNIT(SI_SALE_MONEY, 100000000, '') as "denominator",
--        FN_DWM_MULTIPLE_AND_UNIT(SI_SALE_RATE_BY_MONEY, 0.01, '') as "sellRate",
--        to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--        ORG_ID as "orgId",
--        RN as "rn"
--        FROM(
--             SELECT ORG_NAME, SI_SALE_OUT_MONEY, SI_SALE_MONEY, SI_SALE_RATE_BY_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, SI_SALE_OUT_MONEY, SI_SALE_MONEY, SI_SALE_RATE_BY_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--                (SELECT COLUMN_VALUE FROM table (split (orgId))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--       WHERE RN <= 12
--        );
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.SI_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.SI_SALE_MONEY, 100000000, '') end  as "denominator",
             case when tab.SI_SALE_OUT_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.SI_SALE_OUT_MONEY, 100000000, '')  end  as "numerator",
             case when tab.SI_SALE_RATE_BY_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.SI_SALE_RATE_BY_MONEY, 0.01, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, SI_SALE_OUT_MONEY, SI_SALE_MONEY, SI_SALE_RATE_BY_MONEY, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.SI_SALE_MONEY,rateTable.SI_SALE_RATE_BY_MONEY,rateTable.SI_SALE_OUT_MONEY
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgId)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= TO_NUMBER(TO_CHAR(sysdate,'mm'))) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= TO_NUMBER(TO_CHAR(sysdate,'mm'))) tab;
        open abscissa for select to_char(TO_DATE(TO_CHAR(ADD_MONTHS(trunc(sysdate,'yyyy'), (ROWNUM-1)), 'yyyy-mm'),'yyyy-mm'),'yyyy"年"mm"月"') as "date" from DUAL connect by ROWNUM <= 12;
        open numerator for select '本年已去化货值' as "prefix", '亿元' as "suffix" from dual;
        open denominator for select '年初顽固性库存货值' as "prefix", '亿元' as "suffix" from dual;
        open sellRate for select '去化率' as "prefix", '%' as "suffix" from dual;
EXCEPTION
WHEN OTHERS THEN
  CLOSE pointsData;
  CLOSE numerator;
  CLOSE denominator;
 CLOSE sellRate;
 CLOSE abscissa;
END P_DWM_TRENDMAP_K5_2;
/

prompt
prompt Creating procedure P_DWM_TRENDMAP_K5_3
prompt ======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_TRENDMAP_K5_3
(
  orgId IN clob 
, pointsData OUT sys_refcursor
, numerator OUT sys_refcursor 
, denominator OUT sys_refcursor
, sellRate OUT sys_refcursor 
, abscissa OUT sys_refcursor
) AS 
BEGIN
open pointsData for 
--SELECT 
--        ORG_NAME as "orgName",
--        FN_DWM_MULTIPLE_AND_UNIT(SI_SALE_OUT_MONEY, 100000000, '') as "numerator",
--        FN_DWM_MULTIPLE_AND_UNIT(SI_SALE_MONEY, 100000000, '') as "denominator",
--        FN_DWM_MULTIPLE_AND_UNIT(SI_SURPLUS_SALE_MONEY, 100000000, '') as "sellRate",
--        to_char(TO_DATE(X_AXIS_PERIOD,'yyyy-fmmm'),'yyyy"年"fmmm"月"') as "xAxisPeriod",
--        ORG_ID as "orgId",
--        RN as "rn"
--        FROM(
--            SELECT ORG_NAME, SI_SALE_OUT_MONEY, SI_SALE_MONEY, SI_SURPLUS_SALE_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') asc) AS RN FROM ( SELECT ORG_NAME, SI_SALE_OUT_MONEY, SI_SALE_MONEY, SI_SURPLUS_SALE_MONEY, X_AXIS_PERIOD, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID 
--                ORDER BY TO_DATE(X_AXIS_PERIOD,'yyyy-mm') desc) AS RN FROM (SELECT * FROM DWM_SALE_RATE_BY_ORG WHERE ORG_ID IN 
--                (SELECT COLUMN_VALUE FROM table (split (orgId))) and TO_DATE(X_AXIS_PERIOD,'yyyy-mm') < sysdate))
--       WHERE RN <= 12
--        );
        select 
             to_char(to_date(tab.mm||'-1','yyyy-mm-dd'),'yyyy"年"mm"月"') as "xAxisPeriod", 
             case when tab.SI_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.SI_SALE_MONEY, 100000000, '')  end  as "denominator",
             case when tab.SI_SALE_OUT_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.SI_SALE_OUT_MONEY, 100000000, '')  end  as "numerator",
             case when tab.SI_SURPLUS_SALE_MONEY is null then '0' else FN_DWM_MULTIPLE_AND_UNIT(tab.SI_SURPLUS_SALE_MONEY, 100000000, '') end  as "sellRate",
             tab.org_id as "orgId",
             tab.org_name as "orgName",
            tab."RN" as "rn"
            from (SELECT * FROM  (
        SELECT ORG_NAME, SI_SALE_OUT_MONEY, SI_SALE_MONEY, SI_SURPLUS_SALE_MONEY, mm, ORG_ID, ROW_NUMBER() OVER(PARTITION BY ORG_ID  
        ORDER BY TO_DATE(mm,'yyyy-mm') asc) AS RN FROM (
            select monthTable.*,rateTable.SI_SALE_MONEY,rateTable.SI_SURPLUS_SALE_MONEY,rateTable.SI_SALE_OUT_MONEY
            from (
            select org_id,"index",MM,org_name from (select * from (select org_id from DWM_SALE_RATE_BY_ORG where org_id in (SELECT COLUMN_VALUE FROM table (split (orgId)))  group by org_id) orgs,
            (select rownum as "index",mm from (select mm from (select TO_CHAR(ADD_MONTHS(sysdate, -(ROWNUM-1)), 'yyyy-mm') mm from DUAL connect by ROWNUM <= TO_NUMBER(TO_CHAR(sysdate,'mm'))) allMonths order by  to_date(allMonths.mm||'-1','yyyy-mm-dd'))tab)months) orgMonths
            ,SYS_BUSINESS_UNIT where SYS_BUSINESS_UNIT.id=orgMonths.org_id
            )monthTable 
            left join (select * from DWM_SALE_RATE_BY_ORG )  rateTable on
            monthTable.mm=rateTable.X_AXIS_PERIOD and  monthTable.org_id=rateTable.org_id
            )
) 
WHERE RN <= TO_NUMBER(TO_CHAR(sysdate,'mm'))) tab;
        open abscissa for select to_char(TO_DATE(TO_CHAR(ADD_MONTHS(trunc(sysdate,'yyyy'), (ROWNUM-1)), 'yyyy-mm'),'yyyy-mm'),'yyyy"年"mm"月"') as "date" from DUAL connect by ROWNUM <= 12;
        open numerator for select '本年已去化货值' as "prefix", '亿元' as "suffix" from dual;
        open denominator for select '年初顽固性库存货值' as "prefix", '亿元' as "suffix" from dual;
        open sellRate for select '剩余顽固性库存货值' as "prefix", '亿元' as "suffix" from dual;
EXCEPTION
WHEN OTHERS THEN
  CLOSE pointsData;
  CLOSE numerator;
  CLOSE denominator;
 CLOSE sellRate;
 CLOSE abscissa;
END P_DWM_TRENDMAP_K5_3;
/

prompt
prompt Creating procedure P_DWM_VALUE_PROJECT_SCOPE
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_dwm_value_project_scope (
    userid         IN             VARCHAR2 --当前用户id
    ,
    stationid      IN             VARCHAR2 --当前用户岗位id
    ,
    departmentid   IN             VARCHAR2 --当前用户部门id
    ,
    companyid      IN             VARCHAR2 --当前用户公司id
    ,
    projtreeinfo   OUT            SYS_REFCURSOR--项目树
) AS 
--货值数据项目树
--作者：鲜晓勇
--日期：2020/01/13
--输入变量：用户ID
    data_auth_spid   VARCHAR2(200);
    bizcode          VARCHAR2(200);
BEGIN
    bizcode := 'DWM.DTHZGL.01';
    p_sys_get_company_tree_spid(userid => userid, stationid => stationid, deptid => departmentid, companyid => companyid, bizcode
    => bizcode, data_auth_spid => data_auth_spid);

    OPEN projtreeinfo FOR SELECT
                             orgid      "orgId",
                             orgname    AS "orgName",
                             parentid   AS "parentId",
                             userid  as userid,
                             stationid as stationid,
                             departmentid as departmentid,
                             companyid as companyid,
                             orgtype    AS "orgType"
                         FROM
                             (
                                 SELECT DISTINCT
                                     org_id       AS orgid,
                                     org_name     AS orgname,
                                     order_code   AS ordercode,
                                     parent_id    AS parentid,
                                     org_type     AS orgtype
                                     
                                 FROM
                                     tmp_company_tree
                                 WHERE
                                     id = data_auth_spid
                                     AND org_id IN (
                                         SELECT DISTINCT
                                             id
                                         FROM
                                             sys_business_unit
                                         START WITH
                                             id IN (
                                                 SELECT
                                                     id
                                                 FROM
                                                     (
                                                         SELECT
                                                             unit_id AS id
                                                         FROM
                                                             sys_project
                                                         UNION
                                                         SELECT
                                                             subordinate_company_id AS id
                                                         FROM
                                                             cdb_feasible_project_config
                                                     ) ds
                                             )
                                         CONNECT BY
                                             PRIOR parent_id = id
                                     )
                                 UNION ALL
                                 SELECT
                                     id             AS projid,
                                     project_name   AS projname,
                                     project_code   AS ordercode,
                                     unit_id        AS parentid,
                                     '10' AS orgtype
                                 FROM
                                     sys_project
                             ) t
                         ORDER BY
                             ordercode;

END p_dwm_value_project_scope;
/

prompt
prompt Creating procedure P_DWM_W_COMPANY_WORTH
prompt ========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_DWM_W_COMPANY_WORTH" (title out VARCHAR2, wacthinfo OUT sys_refcursor)
AS
 --动态货值监控-7公司可售货值货量监控（树列表）
--作者：陈丽
--日期：2019/11/13
-- 黄伟20191222：【动态货值监控】第1个Tab页的右下方树列表。问题：展示不出多个区域公司。
-- 韩金明20200507: 更改查询逻辑 支持查询带项目的所有公司
BEGIN
    open wacthinfo FOR
        with t1 as(
            select sbu.ID, sbu.ORG_NAME, sum(ddv.area_dt_all) salesArea,
                    SUM(NVL(ddv.ZZ_Value_Dt_All,0)) + SUM(NVL(ddv.SY_Value_Dt_All,0)) +
                    SUM(NVL(ddv.CW_Value_Dt_All,0)) as salesWorth, nvl(count(*), 0) cnt
            from SYS_BUSINESS_UNIT sbu
                     left join  MDM_PROJECT mp on sbu.ID = mp.COMPANY_ID
                     left join (select * from DWM_DT_VALUE where OBJ_TYPE = '项目') ddv on ddv.OBJ_ID = mp.ID
            where mp.IS_DELETE = 0 and APPROVAL_STATUS='已审核'
            group by sbu.ID, sbu.ORG_NAME
        ), t2 as (
            select tt.ID, tt.PARENT_ID, rootId, tt.ORG_NAME, salesArea, salesWorth,
                   ORDER_HIERARCHY_CODE, cnt
            from (
                select sbu.ID, sbu.PARENT_ID, sbu.ORG_NAME, connect_by_root(sbu.ID) rootId,
                       ORDER_HIERARCHY_CODE
                from SYS_BUSINESS_UNIT sbu
                start with id in (select id from t1 where id = sbu.id)
                connect by prior sbu.PARENT_ID = sbu.ID
            ) tt left join t1 on tt.rootId = t1.ID
        )select
             id,
             PARENT_ID "parentsId",
             ORG_NAME "companyName",
                 sum(cnt)||'' "projTotal",
             round(sum(nvl(salesArea, 0))/10000,2) "salesArea",
             round(sum(nvl(salesWorth,0))/100000000,2) "salesWorth",
             ORDER_HIERARCHY_CODE||'' "orderCode"
        from t2 group by id, PARENT_ID, ORG_NAME, ORDER_HIERARCHY_CODE
        order by ORDER_HIERARCHY_CODE;
    title:='货值排行榜（面积单位：万平方   货值单位：亿元）';
END p_dwm_w_company_worth;
/

prompt
prompt Creating procedure P_DWM_W_PHASE_LAYOUT
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_dwm_w_phase_layout (
    orgid          IN             VARCHAR2 --组织id 公司id，项目id
    ,
    orgtype        IN             VARCHAR2 ---组织类型 公司，项目
    ,
    wdescription   OUT            VARCHAR2 -------描述
    ,
    title          OUT            VARCHAR2 --显示标题
    ,
    unit           OUT            VARCHAR2---单位
    ,
    unitcolor      OUT            VARCHAR2   ---单位颜色
    ,
    wacthinfo      OUT            SYS_REFCURSOR --监控信息（根据页面图
) AS
		--动态货值监控-货值阶段分布tab
		--作者：陈丽
		--日期：2019/12/07

    color_wqz    VARCHAR2(100); -- 未取证
    color_gz     VARCHAR2(100); --规证阶段
    color_sgz    VARCHAR2(100); --施工证阶段
    color_ysz    VARCHAR2(100); --预售许可证
    color_jgba   VARCHAR2(100); --竣工备案证
    color_jz     VARCHAR2(100); --结转阶段
BEGIN
    unit := '亿元';
    unitcolor := '#333333';
    title := '可售货值阶段分布';
		/*WDESCRIPTION := '说明：可再穿透至项目';*/
		/*
    SELECT COLOR_FIRST, COLOR_SECOND, COLOR_THIRD
    INTO   COLOR_ZZ, COLOR_CW, COLOR_SY
    FROM   SYS_COLOR_SET SAMPLE(80)
    WHERE  GROUP_NAME IN ('轻快、华丽、动感', '回味、女性化、优雅', '运动型、轻快') AND
           COLOR_FIRST NOT LIKE '#FFFF%' AND
           COLOR_SECOND NOT LIKE '#FFFF%' AND
           COLOR_THIRD NOT LIKE '#FFFF%' AND
           ROWNUM = 1;*/
    OPEN wacthinfo FOR WITH tmp_proj_value (
                           org_id,
                           orgname,
                           parent_id,
                           order_hierarchy_code,
                           zz_value_allow_sale,
                           cw_value_allow_sale,
                           sy_value_allow_sale,
                           value_not_planning_permit,
                           value_not_construction_permit,
                           value_not_sale_permit,
                           value_not_completion,
                           value_yes_completion,
                           value_yes_settlement,
                           proj_con,
                           orgtype
                       ) AS (
					--子集
                           SELECT
                               a1.id             AS org_id,
                               a1.project_name   AS orgname,
                               a1.unit_id        AS parent_id,
                               a1.order_hierarchy_code,
                               nvl(b1.zz_value_allow_sale, 0) zz_value_allow_sale,
                               nvl(b1.cw_value_allow_sale, 0) cw_value_allow_sale,
                               nvl(b1.sy_value_allow_sale, 0) sy_value_allow_sale,
                               nvl(b1.value_not_planning_permit, 0) AS value_not_planning_permit,
                               nvl(b1.value_not_construction_permit, 0) AS value_not_construction_permit,
                               nvl(b1.value_not_sale_permit, 0) value_not_sale_permit,
                               nvl(b1.value_not_completion, 0) AS value_not_completion,
                               nvl(b1.value_yes_completion, 0) AS value_yes_completion,
                               nvl(b1.value_yes_settlement, 0) AS value_yes_settlement,
                               1 AS proj_con,
                               '1' AS orgtype
                           FROM
                               sys_project    a1
                               INNER JOIN dwm_dt_value   b1 ON a1.id = b1.obj_id
                                                             AND b1.obj_type = '项目'
					--父级
                           UNION ALL
                           SELECT
                               b2.id,
                               b2.org_name,
                               b2.parent_id,
                               b2.order_hierarchy_code,
                               nvl(a2.zz_value_allow_sale, 0),
                               nvl(a2.cw_value_allow_sale, 0),
                               nvl(a2.sy_value_allow_sale, 0),
                               nvl(a2.value_not_planning_permit, 0) AS value_not_planning_permit,
                               nvl(a2.value_not_construction_permit, 0) AS value_not_construction_permit,
                               nvl(a2.value_not_sale_permit, 0) value_not_sale_permit,
                               nvl(a2.value_not_completion, 0) AS value_not_completion,
                               nvl(a2.value_yes_completion, 0) AS value_yes_completion,
                               nvl(a2.value_yes_settlement, 0) AS value_yes_settlement,
                               a2.proj_con,
                               '0' AS orgtype
                           FROM
                               tmp_proj_value      a2
                               INNER JOIN sys_business_unit   b2 ON a2.parent_id = b2.id
                       )
				--/dwm/value-manage/dynamic-value/value-phase?orgid={组织id}&orgtype=0 
                       SELECT
                           1 AS "groupId",
                           '未取证 单位（亿元）' AS "groupName",
                           '#83b5ea' AS "groupColor",
                           300 AS "groupHigh",
                           p.orgname AS "itemName",
                           CASE
                               WHEN p.orgtype = 1 THEN
                                   ''
                               ELSE
                                   '/dwm/value-manage/dynamic-value/value-phase?orgid='
                                   || TO_CHAR(nvl(p.org_id, ''))
                                   || CHR(38)
                                   || 'orgtype=0'
                           END AS "itemOpenUrl",
                           round(SUM(p.value_not_planning_permit) / 100000000, 2) AS "statistics",
                           p.order_hierarchy_code
                       FROM
                           tmp_proj_value p
                       WHERE
                           p.parent_id = orgid
                       GROUP BY
                           p.orgname,
                           p.orgtype,
                           p.org_id,
                           p.order_hierarchy_code
                       UNION ALL
                       SELECT
                           2 AS "groupId",
                           '已取规划许可证 单位（亿元）' AS "groupName",
                           '#666699' AS "groupColor",
                           300 AS "groupHigh",
                           p.orgname AS "itemName",
                           CASE
                               WHEN p.orgtype = 1 THEN
                                   ''
                               ELSE
                                   '/dwm/value-manage/dynamic-value/value-phase?orgid='
                                   || TO_CHAR(nvl(p.org_id, ''))
                                   || CHR(38)
                                   || 'orgtype=0'
                           END AS "itemOpenUrl",
                           round(SUM(p.value_not_construction_permit) / 100000000, 2) AS "statistics",
                           p.order_hierarchy_code
                       FROM
                           tmp_proj_value p
                       WHERE
                           p.parent_id = orgid
                       GROUP BY
                           p.orgname,
                           p.orgtype,
                           p.org_id,
                           p.order_hierarchy_code
                       UNION ALL
                       SELECT
                           3 AS "groupId",
                           '已取施工许可证 单位（亿元）' AS "groupName",
                           '#663300' AS "groupColor",
                           300 AS "groupHigh",
                           p.orgname AS "itemName",
                           CASE
                               WHEN p.orgtype = 1 THEN
                                   ''
                               ELSE
                                   '/dwm/value-manage/dynamic-value/value-phase?orgid='
                                   || TO_CHAR(nvl(p.org_id, ''))
                                   || CHR(38)
                                   || 'orgtype=0'
                           END AS "itemOpenUrl",
                           round(SUM(p.value_not_sale_permit) / 100000000, 2) AS "statistics",
                           p.order_hierarchy_code
                       FROM
                           tmp_proj_value p
                       WHERE
                           p.parent_id = orgid
                       GROUP BY
                           p.orgname,
                           p.orgtype,
                           p.org_id,
                           p.order_hierarchy_code
                       UNION ALL
                       SELECT
                           4 AS "groupId",
                           '已取预售许可证 单位（亿元）' AS "groupName",
                           '#006633' AS "groupColor",
                           300 AS "groupHigh",
                           p.orgname AS "itemName",
                           CASE
                               WHEN p.orgtype = 1 THEN
                                   ''
                               ELSE
                                   '/dwm/value-manage/dynamic-value/value-phase?orgid='
                                   || TO_CHAR(nvl(p.org_id, ''))
                                   || CHR(38)
                                   || 'orgtype=0'
                           END AS "itemOpenUrl",
                           round(SUM(p.value_not_completion) / 100000000, 2) AS "statistics",
                           p.order_hierarchy_code
                       FROM
                           tmp_proj_value p
                       WHERE
                           p.parent_id = orgid
                       GROUP BY
                           p.orgname,
                           p.orgtype,
                           p.org_id,
                           p.order_hierarchy_code
                       UNION ALL
                       SELECT
                           5 AS "groupId",
                           '已取竣工备案证 单位（亿元）' AS "groupName",
                           '#CC9900' AS "groupColor",
                           300 AS "groupHigh",
                           p.orgname AS "itemName",
                           CASE
                               WHEN p.orgtype = 1 THEN
                                   ''
                               ELSE
                                   '/dwm/value-manage/dynamic-value/value-phase?orgid='
                                   || TO_CHAR(nvl(p.org_id, ''))
                                   || CHR(38)
                                   || 'orgtype=0'
                           END AS "itemOpenUrl",
                           round(SUM(p.value_yes_completion) / 100000000, 2) AS "statistics",
                           p.order_hierarchy_code
                       FROM
                           tmp_proj_value p
                       WHERE
                           p.parent_id = orgid
                       GROUP BY
                           p.orgname,
                           p.orgtype,
                           p.org_id,
                           p.order_hierarchy_code
                       UNION ALL
                       SELECT
                           6 AS "groupId",
                           '已结转 单位（亿元）' AS "groupName",
                           '#CC3366' AS "groupColor",
                           300 AS "groupHigh",
                           p.orgname AS "itemName",
                           CASE
                               WHEN p.orgtype = 1 THEN
                                   ''
                               ELSE
                                   '/dwm/value-manage/dynamic-value/value-phase?orgid='
                                   || TO_CHAR(nvl(p.org_id, ''))
                                   || CHR(38)
                                   || 'orgtype=0'
                           END AS "itemOpenUrl",
                           round(SUM(p.value_yes_settlement) / 100000000, 2) AS "statistics",
                           p.order_hierarchy_code
                       FROM
                           tmp_proj_value p
                       WHERE
                           p.parent_id = orgid
                       GROUP BY
                           p.orgname,
                           p.orgtype,
                           p.org_id,
                           p.order_hierarchy_code
                       ORDER BY
                           1,
                           8;

END p_dwm_w_phase_layout;
/

prompt
prompt Creating procedure P_DWM_W_PRESALE_PERMIT_WORTH
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_DWM_W_PRESALE_PERMIT_WORTH"
(
		TITLE     OUT VARCHAR2
	 ,BARTYPE   OUT VARCHAR2
	 ,UNIT      OUT VARCHAR2
	 ,WACTHINFO OUT SYS_REFCURSOR
) AS
		--动态货值监控-4已取预售证的货值情况
		--作者：陈丽
		--日期：2019/11/13
BEGIN
		OPEN WACTHINFO FOR
				SELECT '已售货值' AS NAME, round(SUM(A.VALUE_HAVED_SALE)/100000000,2) AS TOTAL,
							 '#37cd69' AS "color"
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '未售货值' AS NAME, round(SUM(A.VALUE_STOCK)/100000000,2) AS TOTAL,
							 '#E68CB2' AS "color"
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目';
		TITLE   := '已领预售证的货值情况';
		UNIT    := '亿元';
		BARTYPE := 'column';
END P_DWM_W_PRESALE_PERMIT_WORTH;
/

prompt
prompt Creating procedure P_DWM_W_PRODUCT_TYPE_LAYOUT
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_W_PRODUCT_TYPE_LAYOUT
(
		ORGID        IN VARCHAR2 --组织id 公司id，项目id
	 ,ORGTYPE      IN VARCHAR2 ---组织类型 公司，项目
	 ,WDESCRIPTION OUT VARCHAR2 -------描述
	 ,TITLE        OUT VARCHAR2 --显示标题
      ,unit          OUT VARCHAR2 ---单位
    ,unitcolor    OUT VARCHAR2   ---单位颜色
	 ,WACTHINFO    OUT SYS_REFCURSOR --监控信息（根据页面图
) AS
		--动态货值监控-货值业态分布tab
		--作者：陈丽
		--日期：2019/12/07

		COLOR_ZZ VARCHAR2(100);
		COLOR_CW VARCHAR2(100);
		COLOR_SY VARCHAR2(100);

BEGIN
		TITLE := '各项目可售货值业态分布';
		/*WDESCRIPTION := '说明：可再穿透至项目';*/
  unit := '亿元';
    unitcolor := '#333333';
		SELECT COLOR_FIRST, COLOR_SECOND, COLOR_THIRD
		INTO   COLOR_ZZ, COLOR_CW, COLOR_SY
		FROM   SYS_COLOR_SET SAMPLE(80)
		WHERE  GROUP_NAME IN ('轻快、华丽、动感','回味、女性化、优雅','运动型、轻快') AND
					 COLOR_FIRST NOT LIKE '#FFFF%' AND
					 COLOR_SECOND NOT LIKE '#FFFF%' AND
					 COLOR_THIRD NOT LIKE '#FFFF%' AND
					 ROWNUM = 1;

		OPEN WACTHINFO FOR
		
				WITH TMP_PROJ_VALUE(ORG_ID,
				ORGNAME,
				PARENT_ID,
				ORDER_HIERARCHY_CODE,
				ZZ_VALUE_ALLOW_SALE,
				CW_VALUE_ALLOW_SALE,
				SY_VALUE_ALLOW_SALE,
				PROJ_CON,
				ORGTYPE) AS
				 (
					--子集
					SELECT A1.ID AS ORG_ID, A1.PROJECT_NAME AS ORGNAME,
									A1.UNIT_ID AS PARENT_ID, A1.ORDER_HIERARCHY_CODE,
									NVL(B1.ZZ_VALUE_ALLOW_SALE, 0) ZZ_VALUE_ALLOW_SALE,
									NVL(B1.CW_VALUE_ALLOW_SALE, 0) CW_VALUE_ALLOW_SALE,
									NVL(B1.SY_VALUE_ALLOW_SALE, 0) SY_VALUE_ALLOW_SALE,
									1 AS PROJ_CON, '1' AS ORGTYPE
					FROM   SYS_PROJECT A1
					INNER  JOIN DWM_DT_VALUE B1
					ON     A1.ID = B1.OBJ_ID AND
								 B1.OBJ_TYPE = '项目'
					--父级
					UNION ALL
					SELECT B2.ID, B2.ORG_NAME, B2.PARENT_ID, B2.ORDER_HIERARCHY_CODE,
									NVL(A2.ZZ_VALUE_ALLOW_SALE, 0),
									NVL(A2.CW_VALUE_ALLOW_SALE, 0),
									NVL(A2.SY_VALUE_ALLOW_SALE, 0), A2.PROJ_CON, '0' AS ORGTYPE
					FROM   TMP_PROJ_VALUE A2
					INNER  JOIN SYS_BUSINESS_UNIT B2
					ON     A2.PARENT_ID = B2.ID)
				--/dwm/plan-worth/distribution-format?orgid=003200000000000000000000000000&orgtype=0
				SELECT 1 AS "groupId", '住宅 单位（亿元）' AS "groupName",
							 COLOR_ZZ AS "groupColor", 300 AS "groupHigh",
							 P.ORGNAME AS "itemName",
							 CASE
									 WHEN P.ORGTYPE = 1 THEN
										''
									 ELSE
										'/dwm/value-manage/dynamic-value/distributed?orgid=' ||
										TO_CHAR(NVL(P.ORG_ID, '')) || CHR(38) || 'orgtype=0'
							 END AS "itemOpenUrl",
							 ROUND(SUM(P.ZZ_VALUE_ALLOW_SALE) / 100000000, 2) AS "statistics",
							 P.ORDER_HIERARCHY_CODE
				FROM   TMP_PROJ_VALUE P
				WHERE  P.PARENT_ID = ORGID
				GROUP  BY P.ORGNAME, P.ORG_ID, P.ORGTYPE, P.ORDER_HIERARCHY_CODE
				UNION ALL
				SELECT 2 AS "groupId", '车位 单位（亿元）' AS "groupName",
								COLOR_CW AS "groupColor", 300 AS "groupHigh",
								P.ORGNAME AS "itemName",
								CASE
										 WHEN P.ORGTYPE = 1 THEN
											''
										 ELSE
											'/dwm/value-manage/dynamic-value/distributed?orgid=' ||
											TO_CHAR(NVL(P.ORG_ID, '')) || CHR(38) || 'orgtype=0'
								 END AS "itemOpenUrl",
								ROUND(SUM(P.CW_VALUE_ALLOW_SALE) / 100000000, 2) AS "statistics",
								P.ORDER_HIERARCHY_CODE
				FROM   TMP_PROJ_VALUE P
				WHERE  P.PARENT_ID = ORGID
				GROUP  BY P.ORGNAME, P.ORG_ID, P.ORGTYPE, P.ORDER_HIERARCHY_CODE
				UNION ALL
				SELECT 3 AS "groupId", '商业 单位（亿元）' AS "groupName",
								 COLOR_SY AS "groupColor", 300 AS "groupHigh",
								 P.ORGNAME AS "itemName",
								 CASE
											WHEN P.ORGTYPE = 1 THEN
											 ''
											ELSE
											 '/dwm/value-manage/dynamic-value/distributed?orgid=' ||
											 TO_CHAR(NVL(P.ORG_ID, '')) || CHR(38) || 'orgtype=0'
									END AS "itemOpenUrl",
								 ROUND(SUM(P.SY_VALUE_ALLOW_SALE) / 100000000, 2) AS "statistics",
								 P.ORDER_HIERARCHY_CODE
				FROM   TMP_PROJ_VALUE P
				WHERE  P.PARENT_ID = ORGID
				GROUP  BY P.ORGNAME, P.ORG_ID, P.ORGTYPE, P.ORDER_HIERARCHY_CODE
				ORDER  BY 8;

END P_DWM_W_PRODUCT_TYPE_LAYOUT;
/

prompt
prompt Creating procedure P_DWM_W_PRODUCT_TYPE_WORTH
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_DWM_W_PRODUCT_TYPE_WORTH" (title out VARCHAR2,bartype out VARCHAR2,unit out VARCHAR2,carport out INT,wacthinfo OUT sys_refcursor,classificationRatio out sys_refcursor)
AS  
--动态货值监控-6各产品类型可售货值的业态分布图
--作者：陈丽
--日期：2019/11/13
-- 黄伟2020-01-02修改过
BEGIN
open wacthinfo for
select
'住宅' as  "name",
round(SUM(NVL(a.Zz_Value_Dt_All,0))/100000000,2) as "total" ,
'#37cd69' as "color"
from Dwm_Dt_Value a
WHERE a.obj_type='项目'
UNION

/*select
'住宅(库存)' as  "name",
round(SUM(NVL(a.zz_value_stock,0))/100000000,2) as "total" ,
'#37cd69' as "color"
from Dwm_Dt_Value a
WHERE a.obj_type='项目'
UNION*/

select
'商业' as  "name",
round(SUM(NVL(a.SY_Value_Dt_All,0))/100000000,2) as "total" ,
'#37cd69' as "color"
from Dwm_Dt_Value a
WHERE a.obj_type='项目'

/*UNION
select
'商业(库存)' as  "name",
round(SUM(NVL(a.SY_Value_STOCK,0))/100000000,2) as "total" ,
'#37cd69' as "color"
from Dwm_Dt_Value a
WHERE a.obj_type='项目'*/

union
select
'车位' as  "name",
round(SUM(NVL(a.CW_Value_Dt_All,0))/100000000,2) as "total" ,
'#37cd69' as "color"
from Dwm_Dt_Value a
WHERE a.obj_type='项目'

/*union
select
'车位(库存)' as  "name",
round(SUM(NVL(a.CW_Value_STOCK,0))/100000000,2) as "total" ,
'#37cd69' as "color"
from Dwm_Dt_Value a
WHERE a.obj_type='项目'*/
;
title:='各产品类型总可售货值的业态分布图';
unit:='亿元';
bartype:='column';
carport:=10000;
SELECT SUM(NVL(a.CW_AREA_Dt_All,0)) INTO carport from Dwm_Dt_Value a
WHERE a.obj_type='项目'
;


open classificationRatio for
select
'住宅' as  "name",
to_Char(round(SUM(NVL(a.ZZ_Value_Dt_All,0))/(SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))*100,2),'99.99')||'%' as "total" 
from Dwm_Dt_Value a
WHERE a.obj_type='项目'
union
select
'商业' as  "name",
to_Char(round(SUM(NVL(a.SY_Value_Dt_All,0))/(SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))*100,2),'99.99')||'%' as "total" 
from Dwm_Dt_Value a
WHERE a.obj_type='项目'
union
select
'车位' as  "name",
to_Char(round(SUM(NVL(a.CW_Value_Dt_All,0))/(SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))*100,2),'99.99')||'%' as "total" 
from Dwm_Dt_Value a
WHERE a.obj_type='项目'

;

END p_dwm_w_product_type_worth;
/

prompt
prompt Creating procedure P_DWM_W_REPERTORY
prompt ====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_W_REPERTORY
(
		USERID        IN VARCHAR2 --当前用户id
	 ,STATIONID     IN VARCHAR2 --当前用户岗位id
	 ,DEPARTMENTID  IN VARCHAR2 --当前用户部门id
	 ,COMPANYID     IN VARCHAR2 --当前用户公司id
	 ,ORGID         IN VARCHAR2 --组织id 公司id，项目id
	 ,ORGTYPE       IN VARCHAR2 ---组织类型 0:公司，1:项目
	 ,SCOPEYEAR     IN VARCHAR2 --监控范围段 年
	 ,SCOPEMONTH    IN VARCHAR2 --监控范围 月
	 ,REPERTORYTYPE IN VARCHAR2 --库存类型 各区域库存业态分析图：productType ，各区域库存货龄分析图：age
      ,UNIT          OUT VARCHAR2 ---- 单位
     ,UNITCOLOR     OUT VARCHAR2 --单位颜色
	 ,TITLE         OUT VARCHAR2 --显示标题
	 ,ISSHOWVALUE   OUT INT --是否显示数字 1显示，0不显示
	 ,WACTHINFO     OUT SYS_REFCURSOR --监控信息（根据页面图）
) AS
		--动态货值监控-库存监控tab
		--作者：陈丽
		--日期：2019/12/07
BEGIN
  unit := '亿元';
    unitcolor := '#333333';
		IF REPERTORYTYPE = 'productType' THEN
				TITLE := '区域库存业态分析图';
		ELSE
				TITLE := '区域库存货龄分析图';
		END IF;
		ISSHOWVALUE := 1;
		IF REPERTORYTYPE = 'productType' THEN
				OPEN WACTHINFO FOR
						WITH TMP_PROJ_VALUE(ORG_ID,
						ORGNAME,
						PARENT_ID,
						ORDER_HIERARCHY_CODE,
						ZZ_VALUE_ALLOW_SALE,
						CW_VALUE_ALLOW_SALE,
						SY_VALUE_ALLOW_SALE,
						VALUE_NOT_PLANNING_PERMIT,
						VALUE_NOT_CONSTRUCTION_PERMIT,
						VALUE_NOT_SALE_PERMIT,
						VALUE_NOT_COMPLETION,
						VALUE_YES_COMPLETION,
						VALUE_YES_SETTLEMENT,
						ZZ_VALUE_STOCK,
						CW_VALUE_STOCK,
						SY_VALUE_STOCK,
						PROJ_CON,
						ORGTYPE) AS
						 (
							--子集
							SELECT A1.ID AS ORG_ID, A1.PROJECT_NAME AS ORGNAME, A1.UNIT_ID AS PARENT_ID, A1.ORDER_HIERARCHY_CODE, NVL(B1.ZZ_VALUE_ALLOW_SALE, 0) ZZ_VALUE_ALLOW_SALE,
											NVL(B1.CW_VALUE_ALLOW_SALE, 0) CW_VALUE_ALLOW_SALE, NVL(B1.SY_VALUE_ALLOW_SALE, 0) SY_VALUE_ALLOW_SALE, NVL(B1.VALUE_NOT_PLANNING_PERMIT, 0) AS VALUE_NOT_PLANNING_PERMIT,
											NVL(B1.VALUE_NOT_CONSTRUCTION_PERMIT, 0) AS VALUE_NOT_CONSTRUCTION_PERMIT, NVL(B1.VALUE_NOT_SALE_PERMIT, 0) VALUE_NOT_SALE_PERMIT,
											NVL(B1.VALUE_NOT_COMPLETION, 0) AS VALUE_NOT_COMPLETION, NVL(B1.VALUE_YES_COMPLETION, 0) AS VALUE_YES_COMPLETION, NVL(B1.VALUE_YES_SETTLEMENT, 0) AS VALUE_YES_SETTLEMENT,
											NVL(B1.ZZ_VALUE_STOCK, 0) ZZ_VALUE_STOCK, NVL(B1.CW_VALUE_STOCK, 0) CW_VALUE_STOCK, NVL(B1.SY_VALUE_STOCK, 0) AS SY_VALUE_STOCK, 1 AS PROJ_CON, '1' AS ORGTYPE
							FROM   SYS_PROJECT A1
							INNER  JOIN DWM_DT_VALUE B1
							ON     A1.ID = B1.OBJ_ID AND
										 B1.OBJ_TYPE = '项目'
							--父级
							UNION ALL
							SELECT B2.ID, B2.ORG_NAME, B2.PARENT_ID, B2.ORDER_HIERARCHY_CODE, NVL(A2.ZZ_VALUE_ALLOW_SALE, 0), NVL(A2.CW_VALUE_ALLOW_SALE, 0), NVL(A2.SY_VALUE_ALLOW_SALE, 0),
											NVL(A2.VALUE_NOT_PLANNING_PERMIT, 0) AS VALUE_NOT_PLANNING_PERMIT, NVL(A2.VALUE_NOT_CONSTRUCTION_PERMIT, 0) AS VALUE_NOT_CONSTRUCTION_PERMIT,
											NVL(A2.VALUE_NOT_SALE_PERMIT, 0) VALUE_NOT_SALE_PERMIT, NVL(A2.VALUE_NOT_COMPLETION, 0) AS VALUE_NOT_COMPLETION, NVL(A2.VALUE_YES_COMPLETION, 0) AS VALUE_YES_COMPLETION,
											NVL(A2.VALUE_YES_SETTLEMENT, 0) AS VALUE_YES_SETTLEMENT, NVL(A2.ZZ_VALUE_STOCK, 0) ZZ_VALUE_STOCK, NVL(A2.CW_VALUE_STOCK, 0) CW_VALUE_STOCK,
											NVL(A2.SY_VALUE_STOCK, 0) AS SY_VALUE_STOCK, A2.PROJ_CON, '0' AS ORGTYPE
							FROM   TMP_PROJ_VALUE A2
							INNER  JOIN SYS_BUSINESS_UNIT B2
							ON     A2.PARENT_ID = B2.ID)
						
						SELECT '1' AS "repertoryTypeId", '住宅' AS "repertoryTypeName", A.ORGNAME AS "orgName", ROUND(SUM(A.ZZ_VALUE_STOCK) / 100000000, 2) AS "statistics", 1 AS "orderId",
									 CASE
												WHEN A.ORGTYPE = 1 THEN
												 ''
												ELSE
												 '/dwm/value-manage/dynamic-value/monitorStock?orgid=' || TO_CHAR(NVL(A.ORG_ID, '')) || CHR(38) || 'orgtype=0'
										END AS "openUrl", A.ORDER_HIERARCHY_CODE
						FROM   TMP_PROJ_VALUE A
						WHERE  A.PARENT_ID = ORGID
						GROUP  BY A.ORGNAME, A.ORG_ID, A.ORGTYPE, A.ORDER_HIERARCHY_CODE
						UNION ALL
						SELECT '2' AS "repertoryTypeId", '车位' AS "repertoryTypeName", A.ORGNAME AS "orgName", ROUND(SUM(A.CW_VALUE_STOCK) / 100000000, 2) AS "statistics", 1 AS "orderId",
										CASE
												 WHEN A.ORGTYPE = 1 THEN
													''
												 ELSE
													'/dwm/value-manage/dynamic-value/monitorStock?orgid=' || TO_CHAR(NVL(A.ORG_ID, '')) || CHR(38) || 'orgtype=0'
										 END AS "openUrl", A.ORDER_HIERARCHY_CODE
						FROM   TMP_PROJ_VALUE A
						WHERE  A.PARENT_ID = ORGID
						GROUP  BY A.ORGNAME, A.ORG_ID, A.ORGTYPE, A.ORDER_HIERARCHY_CODE
						UNION ALL
						SELECT '3' AS "repertoryTypeId", '商业' AS "repertoryTypeName", A.ORGNAME AS "orgName", ROUND(SUM(A.SY_VALUE_STOCK) / 100000000, 2) AS "statistics", 1 AS "orderId",
										 CASE
													WHEN A.ORGTYPE = 1 THEN
													 ''
													ELSE
													 '/dwm/value-manage/dynamic-value/monitorStock?orgid=' || TO_CHAR(NVL(A.ORG_ID, '')) || CHR(38) || 'orgtype=0'
											END AS "openUrl", A.ORDER_HIERARCHY_CODE
						FROM   TMP_PROJ_VALUE A
						WHERE  A.PARENT_ID = ORGID
						GROUP  BY A.ORGNAME, A.ORG_ID, A.ORGTYPE, A.ORDER_HIERARCHY_CODE
						ORDER  BY 7;
		
		ELSIF REPERTORYTYPE = 'age' THEN
				OPEN WACTHINFO FOR
						WITH TMP_STOCK_VALUE(ORG_ID,
						ORGNAME,
						PARENTID,
						ORDER_HIERARCHY_CODE,
						ORGTYPE,
						SIX_MONTH_IN,
						SIX_TO_TWELVE_MONTH,
						TWELVE_TO_EIGHTEEN_MONTH,
						EIGHTEEN_MONTH_ABOVE,
						TOTAL) AS
						 (
							--子集
							SELECT A1.ID AS ORG_ID, A1.PROJECT_NAME AS ORGNAME, A1.UNIT_ID AS PARENT_ID, A1.ORDER_HIERARCHY_CODE, '1' AS ORGTYPE,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) <= 5 THEN
																B1.BZ_PRICE * B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS SIX_MONTH_IN,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) BETWEEN 6 AND 12 THEN
																B1.BZ_PRICE * B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS SIX_TO_TWELVE_MONTH,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) BETWEEN 12 AND 18 THEN
																B1.BZ_PRICE * B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS TWELVE_TO_EIGHTEEN_MONTH,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) > 18 OR C1.GET_PRE_SALE_PERMIT_DATE IS NULL THEN
																B1.BZ_PRICE * B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS EIGHTEEN_MONTH_ABOVE, SUM(B1.BZ_PRICE * B1.PRE_BLD_AREA) AS TOTAL
							FROM   SYS_PROJECT A1
							LEFT   JOIN MDM_ROOM B1
							ON     A1.ID = B1.PROJECT_ID AND
										 B1.SALE_STATE <> '签约'
							LEFT   JOIN MDM_BUILD C1
							ON     B1.BUILDING_ID = C1.ID
							GROUP  BY A1.ID, A1.PROJECT_NAME, A1.UNIT_ID, A1.ORDER_HIERARCHY_CODE
							--父级
							UNION ALL
							SELECT B2.ID, B2.ORG_NAME, B2.PARENT_ID, B2.ORDER_HIERARCHY_CODE, '0' AS ORGTYPE, SIX_MONTH_IN, SIX_TO_TWELVE_MONTH, TWELVE_TO_EIGHTEEN_MONTH, EIGHTEEN_MONTH_ABOVE, TOTAL
							FROM   TMP_STOCK_VALUE A2
							INNER  JOIN SYS_BUSINESS_UNIT B2
							ON     A2.PARENTID = B2.ID)
						
						SELECT 1 AS "repertoryTypeId", '6个月以内' AS "repertoryTypeName", P.ORGNAME AS "orgName", ROUND(SUM(P.SIX_MONTH_IN) / 100000000, 2) AS "statistics", 1 AS ORDERID,
									 CASE
												WHEN P.ORGTYPE = 1 THEN
												 ''
												ELSE
												 '/dwm/value-manage/dynamic-value/monitorStock?orgid=' || TO_CHAR(NVL(P.ORG_ID, '')) || CHR(38) || 'orgtype=0'
										END AS "openUrl", P.ORDER_HIERARCHY_CODE
						FROM   TMP_STOCK_VALUE P
						WHERE  P.PARENTID = ORGID
						GROUP  BY P.ORGNAME, P.ORGTYPE, P.ORG_ID, P.ORDER_HIERARCHY_CODE
						UNION ALL
						SELECT 2 AS "repertoryTypeId", '6-12个月' AS "repertoryTypeName", P.ORGNAME AS "orgName", ROUND(SUM(P.SIX_TO_TWELVE_MONTH) / 100000000, 2) AS "statistics", 2 AS ORDERID,
										CASE
												 WHEN P.ORGTYPE = 1 THEN
													''
												 ELSE
													'/dwm/value-manage/dynamic-value/monitorStock?orgid=' || TO_CHAR(NVL(P.ORG_ID, '')) || CHR(38) || 'orgtype=0'
										 END AS "openUrl", P.ORDER_HIERARCHY_CODE
						FROM   TMP_STOCK_VALUE P
						WHERE  P.PARENTID = ORGID
						GROUP  BY P.ORGNAME, P.ORGTYPE, P.ORG_ID, P.ORDER_HIERARCHY_CODE
						UNION ALL
						SELECT 3 AS "repertoryTypeId", '12-18个月' AS "repertoryTypeName", P.ORGNAME AS "orgName", ROUND(SUM(P.TWELVE_TO_EIGHTEEN_MONTH) / 100000000, 2) AS "statistics", 3 AS ORDERID,
										 CASE
													WHEN P.ORGTYPE = 1 THEN
													 ''
													ELSE
													 '/dwm/value-manage/dynamic-value/monitorStock?orgid=' || TO_CHAR(NVL(P.ORG_ID, '')) || CHR(38) || 'orgtype=0'
											END AS "openUrl", P.ORDER_HIERARCHY_CODE
						FROM   TMP_STOCK_VALUE P
						WHERE  P.PARENTID = ORGID
						GROUP  BY P.ORGNAME, P.ORGTYPE, P.ORG_ID, P.ORDER_HIERARCHY_CODE
						UNION ALL
						SELECT 4 AS "repertoryTypeId", '18个月以上' AS "repertoryTypeName", P.ORGNAME AS "orgName", ROUND(SUM(P.EIGHTEEN_MONTH_ABOVE) / 100000000, 2) AS "statistics", 4 AS ORDERID,
											CASE
													 WHEN P.ORGTYPE = 1 THEN
														''
													 ELSE
														'/dwm/value-manage/dynamic-value/monitorStock?orgid=' || TO_CHAR(NVL(P.ORG_ID, '')) || CHR(38) || 'orgtype=0'
											 END AS "openUrl", P.ORDER_HIERARCHY_CODE
						FROM   TMP_STOCK_VALUE P
						WHERE  P.PARENTID = ORGID
						GROUP  BY P.ORGNAME, P.ORGTYPE, P.ORG_ID, P.ORDER_HIERARCHY_CODE
						ORDER  BY 7;
		END IF;

END P_DWM_W_REPERTORY;
/

prompt
prompt Creating procedure P_DWM_W_SALES_RATE
prompt =====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_W_SALES_RATE
(
		SCOPEYEAR  IN VARCHAR2 --监控时间段 年
	 ,SCOPEMONTH IN VARCHAR2 --监控时间段 月
	 ,ORGID      IN VARCHAR2 --组织id 公司id，项目id
	 ,ORGTYPE    IN VARCHAR2 ---组织类型 0:公司，1:项目
      ,unit          OUT VARCHAR2 ---- 单位
     ,unitcolor     OUT VARCHAR2 --单位颜色
	 ,TITLE      OUT VARCHAR2 --显示标题
	 ,WACTHINFO  OUT SYS_REFCURSOR --监控信息（根据页面图
) AS
		--动态货值监控-货值去化率监控tab
		--作者：陈丽
		--日期：2019/12/07
BEGIN
		TITLE := '可售货值去化率';
         unit := '亿元';
    unitcolor := '#333333';
		OPEN WACTHINFO FOR
				WITH TMP_SALERATE(ORG_ID,
				ORGNAME,
				PARENTID,
				ORDER_HIERARCHY_CODE,
				CONTRACTAMOUNT,
				SALEWORTH,
				ORGTYPE) AS
				 (SELECT A1.ID AS ORG_ID, A1.PROJECT_NAME AS ORGNAME, A1.UNIT_ID AS PARENTID, A1.ORDER_HIERARCHY_CODE, NVL(B1.VALUE_HAVED_SALE, 0) AS CONTRACTAMOUNT,
								 NVL(B1.VALUE_STOCK, 0) + NVL(B1.VALUE_HAVED_SALE, 0) AS SALEWORTH, 1 AS ORGTYPE
					FROM   SYS_PROJECT A1
					INNER  JOIN DWM_DT_VALUE B1
					ON     A1.ID = B1.OBJ_ID AND
								 B1.OBJ_TYPE = '项目'
					UNION ALL
					
					SELECT B2.ID, B2.ORG_NAME, B2.PARENT_ID, B2.ORDER_HIERARCHY_CODE, A2.CONTRACTAMOUNT, A2.SALEWORTH, 0
					FROM   TMP_SALERATE A2
					INNER  JOIN SYS_BUSINESS_UNIT B2
					ON     A2.PARENTID = B2.ID
					
					)
				
				SELECT P.ORGNAME AS "orgName", ROUND(SUM(P.SALEWORTH) / 100000000, 2) AS "salesWorth", ROUND(SUM(P.CONTRACTAMOUNT) / 100000000, 2) AS "contractAmount",
							 CASE
									 WHEN P.ORGTYPE = 1 THEN
										''
									 ELSE
										'/dwm/value-manage/dynamic-value/sales-value?orgid=' || P.ORG_ID || CHR(38) || 'orgtype=0'
							 END AS "openUrl",
							 CASE
									 WHEN SUM(P.SALEWORTH) = 0 THEN
										0
									 ELSE
										ROUND(SUM(P.CONTRACTAMOUNT) / SUM(P.SALEWORTH) * 100, 2)
							 END AS "salesRate"
				FROM   TMP_SALERATE P
				WHERE  P.PARENTID = ORGID
				GROUP  BY P.ORGNAME, P.ORGTYPE, P.ORG_ID, P.ORDER_HIERARCHY_CODE
				ORDER  BY P.ORDER_HIERARCHY_CODE
				
				;

END P_DWM_W_SALES_RATE;
/

prompt
prompt Creating procedure P_DWM_W_SALES_WORTH_AREA
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_DWM_W_SALES_WORTH_AREA" (title out VARCHAR2,wacthinfo OUT sys_refcursor)
IS
--动态货值监控-5可售货值区域分布(中国地图）
--作者：陈丽
--日期：2019/11/13
--黄伟20191222：【动态货值监控】第1个Tab页的底部。
--2020/07/06KangWJ修改
v_total number(20,2);

begin 

   select round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2) into v_total from dwm_dt_value a where a.obj_type='项目';
   
open wacthinfo FOR

-- 1 华南区域:广州市
-- 2 北方区域：北京
-- 3 华东区域：上海市
-- 4 西南区域：成都市
-- 5 华中公司：西安市
-- 6 中南区域：武汉市
-- 7 东北区域：沈阳市

select a."place",a."totalworth",a."proportion",b."salesArea",b."projName",b."salesWorth" from (
-- 1 华南区域:广州市
select
    '1' as "indexid",
    '广州市' as "place",
    to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2))  as  "totalworth",
    to_char(
    round( ((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000)/v_total,4)*100
    )||'%' as "proportion"
    from dwm_dt_value a
    inner JOIN mdm_project b ON a.obj_id=b.id
    INNER JOIN SYS_BUSINESS_UNIT c
        ON b.COMPANY_ID = c.ID 
        and c.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('华南公司','南沙公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
    WHERE a.obj_type='项目' 

-- 2 北方区域：北京
union all
select
'2' as "indexid",
'北京' as "place",
to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2))  as  "totalworth",
    to_char(
    round( ((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000)/v_total,4)*100
    )||'%' as "proportion"
    from dwm_dt_value a
    inner JOIN mdm_project b ON a.obj_id=b.id
    INNER JOIN SYS_BUSINESS_UNIT c
        ON b.COMPANY_ID = c.ID 
        and c.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('北方公司','集团总部','公寓管理公司','创新公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
    WHERE a.obj_type='项目' 

-- 3 华东区域：上海市
union all
select
'3' as "indexid",
'上海' as "place",
to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2))  as  "totalworth",
    to_char(
    round( ((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000)/v_total,4)*100
    )||'%' as "proportion"
    from dwm_dt_value a
    inner JOIN mdm_project b ON a.obj_id=b.id
    INNER JOIN SYS_BUSINESS_UNIT c
        ON b.COMPANY_ID = c.ID 
        and c.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('华东公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
    WHERE a.obj_type='项目' 

-- 4 西南区域：成都市
union all
select
'4' as "indexid",
'成都市' as "place",
to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2))  as  "totalworth",
    to_char(
    round( ((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000)/v_total,4)*100
    )||'%' as "proportion"
    from dwm_dt_value a
    inner JOIN mdm_project b ON a.obj_id=b.id
    INNER JOIN SYS_BUSINESS_UNIT c
        ON b.COMPANY_ID = c.ID 
        and c.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('西南公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
    WHERE a.obj_type='项目' 

-- 5 华中公司：西安市
union all
select
'5' as "indexid",
'西安市' as "place",
to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2))  as  "totalworth",
    to_char(
    round( ((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000)/v_total,4)*100
    )||'%' as "proportion"
    from dwm_dt_value a
    inner JOIN mdm_project b ON a.obj_id=b.id
    INNER JOIN SYS_BUSINESS_UNIT c
        ON b.COMPANY_ID = c.ID 
        and c.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('华中公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
    WHERE a.obj_type='项目' 

-- 6 中南区域：武汉市
union all
select
'6' as "indexid",
'武汉市' as "place",
to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2))  as  "totalworth",
    to_char(
    round( ((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000)/v_total,4)*100
    )||'%' as "proportion"
    from dwm_dt_value a
    inner JOIN mdm_project b ON a.obj_id=b.id
    INNER JOIN SYS_BUSINESS_UNIT c
        ON b.COMPANY_ID = c.ID 
        and c.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('中南公司','商业公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
    WHERE a.obj_type='项目' 

-- 7 东北区域：沈阳市
union all
select
'7' as "indexid",
'沈阳市' as "place",
to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2))  as  "totalworth",
    to_char(
    round( ((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000)/v_total,4)*100
    )||'%' as "proportion"
    from dwm_dt_value a
    inner JOIN mdm_project b ON a.obj_id=b.id
    INNER JOIN SYS_BUSINESS_UNIT c
        ON b.COMPANY_ID = c.ID 
        and c.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('东北公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
    WHERE a.obj_type='项目' 

--  8 贵州公司、文旅公司：贵阳市
union all
select
'8' as "indexid",
'贵阳市' as "place",
to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2))  as  "totalworth",
    to_char(
    round( ((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000)/v_total,4)*100
    )||'%' as "proportion"
    from dwm_dt_value a
    inner JOIN mdm_project b ON a.obj_id=b.id
    INNER JOIN SYS_BUSINESS_UNIT c
        ON b.COMPANY_ID = c.ID 
        and c.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('文旅公司','贵州公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
    WHERE a.obj_type='项目' 


) a

left join
(
-- 1 华南区域:广州市
      SELECT 
        '1' as "indexid",
        c.org_name as  "projName",
        to_char(round(SUM(nvl(a.area_dt_all,0))/10000,2)) as "salesArea",
        to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2)) as "salesWorth"
        from dwm_dt_value a
        inner JOIN mdm_project b ON a.obj_id=b.id
        inner JOIN sys_business_unit c ON b.company_id=c.id
         INNER JOIN SYS_BUSINESS_UNIT d
        ON b.COMPANY_ID = d.ID 
        and d.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('华南公司','南沙公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
        WHERE a.obj_type='项目'
        GROUP BY C.ORDER_HIERARCHY_CODE,c.org_name

-- 2 北方区域：北京
union all
select
'2' as "indexid",
 c.org_name as  "projName",
        to_char(round(SUM(nvl(a.area_dt_all,0))/10000,2)) as "salesArea",
        to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2)) as "salesWorth"
        from dwm_dt_value a
        inner JOIN mdm_project b ON a.obj_id=b.id
        inner JOIN sys_business_unit c ON b.company_id=c.id
         INNER JOIN SYS_BUSINESS_UNIT d
        ON b.COMPANY_ID = d.ID 
        and d.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('北方公司','集团总部','公寓管理公司','创新公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
        WHERE a.obj_type='项目'
        GROUP BY C.ORDER_HIERARCHY_CODE,c.org_name


-- 3 华东区域：上海
union all
select
'3' as "indexid",
 c.org_name as  "projName",
        to_char(round(SUM(nvl(a.area_dt_all,0))/10000,2)) as "salesArea",
        to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2)) as "salesWorth"
        from dwm_dt_value a
        inner JOIN mdm_project b ON a.obj_id=b.id
        inner JOIN sys_business_unit c ON b.company_id=c.id
         INNER JOIN SYS_BUSINESS_UNIT d
        ON b.COMPANY_ID = d.ID 
        and d.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('华东公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
        WHERE a.obj_type='项目'
        GROUP BY C.ORDER_HIERARCHY_CODE,c.org_name



-- 4 西南区域：成都市
union all
select
'4' as "indexid",
 c.org_name as  "projName",
        to_char(round(SUM(nvl(a.area_dt_all,0))/10000,2)) as "salesArea",
        to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2)) as "salesWorth"
        from dwm_dt_value a
        inner JOIN mdm_project b ON a.obj_id=b.id
        inner JOIN sys_business_unit c ON b.company_id=c.id
         INNER JOIN SYS_BUSINESS_UNIT d
        ON b.COMPANY_ID = d.ID 
        and d.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('西南公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
        WHERE a.obj_type='项目'
        GROUP BY C.ORDER_HIERARCHY_CODE,c.org_name

-- 5 华中公司：西安市
union all
select
'5' as "indexid",
 c.org_name as  "projName",
        to_char(round(SUM(nvl(a.area_dt_all,0))/10000,2)) as "salesArea",
        to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2)) as "salesWorth"
        from dwm_dt_value a
        inner JOIN mdm_project b ON a.obj_id=b.id
        inner JOIN sys_business_unit c ON b.company_id=c.id
         INNER JOIN SYS_BUSINESS_UNIT d
        ON b.COMPANY_ID = d.ID 
        and d.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('华中公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
        WHERE a.obj_type='项目'
        GROUP BY C.ORDER_HIERARCHY_CODE,c.org_name


-- 6 中南区域：武汉市
union all
select
'6' as "indexid",
 c.org_name as  "projName",
        to_char(round(SUM(nvl(a.area_dt_all,0))/10000,2)) as "salesArea",
        to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2)) as "salesWorth"
        from dwm_dt_value a
        inner JOIN mdm_project b ON a.obj_id=b.id
        inner JOIN sys_business_unit c ON b.company_id=c.id
         INNER JOIN SYS_BUSINESS_UNIT d
        ON b.COMPANY_ID = d.ID 
        and d.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('中南公司','商业公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
        WHERE a.obj_type='项目'
        GROUP BY C.ORDER_HIERARCHY_CODE,c.org_name


-- 7 东北区域：沈阳市
union all
SELECT
'7' as "indexid",
 c.org_name as  "projName",
        to_char(round(SUM(nvl(a.area_dt_all,0))/10000,2)) as "salesArea",
        to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2)) as "salesWorth"
        from dwm_dt_value a
        inner JOIN mdm_project b ON a.obj_id=b.id
        inner JOIN sys_business_unit c ON b.company_id=c.id
         INNER JOIN SYS_BUSINESS_UNIT d
        ON b.COMPANY_ID = d.ID 
        and d.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('东北公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
        WHERE a.obj_type='项目'
        GROUP BY C.ORDER_HIERARCHY_CODE,c.org_name
--  8 贵州公司、文旅公司：贵阳
    union all
SELECT
'8' as "indexid",
 c.org_name as  "projName",
        to_char(round(SUM(nvl(a.area_dt_all,0))/10000,2)) as "salesArea",
        to_char(round((SUM(NVL(a.ZZ_Value_Dt_All,0))+SUM(NVL(a.SY_Value_Dt_All,0))+SUM(NVL(a.CW_Value_Dt_All,0)))/100000000,2)) as "salesWorth"
        from dwm_dt_value a
        inner JOIN mdm_project b ON a.obj_id=b.id
        inner JOIN sys_business_unit c ON b.company_id=c.id
         INNER JOIN SYS_BUSINESS_UNIT d
        ON b.COMPANY_ID = d.ID 
        and d.ID in (SELECT E.ID FROM SYS_BUSINESS_UNIT E WHERE E.IS_COMPANY = 1 
        START WITH ORG_NAME IN ('文旅公司','贵州公司')
        CONNECT BY PRIOR E.ID=E.PARENT_ID 
        )
        WHERE a.obj_type='项目'
        GROUP BY C.ORDER_HIERARCHY_CODE,c.org_name

)b on a."indexid"=b."indexid";


title:='可售货值区域分布';
END p_dwm_w_sales_worth_area;
/

prompt
prompt Creating procedure P_DWM_W_TOTAL_WORTH
prompt ======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_DWM_W_TOTAL_WORTH"
(
		TITLE     OUT VARCHAR2
	 ,BARTYPE   OUT VARCHAR2
	 ,UNIT      OUT VARCHAR2
	 ,WACTHINFO OUT SYS_REFCURSOR
) AS
		--动态货值监控-2总货值情况：目标货值 vs 动态货值
		--作者：陈丽
		--日期：2019/11/13

		V_KY_TARGET_VALUE  NUMBER(18, 2); --可研版
		V_QP_TARGET_VALUE  NUMBER(18, 2);
		V_DT_TARGET_VALUE  NUMBER(18, 2);
		V_NOW_TARGET_VALUE NUMBER(18, 2);
		V_DT_VALUE         NUMBER(18, 2);

BEGIN
		/*
    SELECT ROUND(SUM(B.TMP_1KY_VALUE) / 10000, 2)
    INTO   V_KY_TARGET_VALUE
    FROM   SYS_PROJECT A
    INNER  JOIN DWM_DT_VALUE B
    ON     A.ID = B.PROJ_ID AND b.OBJ_TYPE = '项目'
    \*WHERE  B.APPROVAL_STATUS = '已审核' AND
           B.TARGET_WORTH_PHASE = 0*\;
    
    SELECT ROUND(SUM(B.TMP_2QP_VALUE) / 10000, 2)
    INTO   V_QP_TARGET_VALUE
    FROM   SYS_PROJECT A
    INNER  JOIN DWM_DT_VALUE B
    ON     A.ID = B.PROJ_ID AND b.OBJ_TYPE = '项目'
    \*WHERE  B.APPROVAL_STATUS = '已审核' AND
           B.TARGET_WORTH_PHASE = 10*\;
    
    SELECT ROUND(SUM(B.TMP_3DT_TARGETVALUE) / 10000, 2)
    INTO   V_DT_TARGET_VALUE
    FROM   SYS_PROJECT A
    INNER  JOIN DWM_DT_VALUE B
    ON     A.ID = B.PROJ_ID  AND b.OBJ_TYPE = '项目';
    
    
    SELECT ROUND((SUM(NVL(B.VALUE_RESERVE,0))+SUM(NVL(B.VALUE_IN_PROCESS,0))+SUM(NVL(B.VALUE_STOCK,0))+SUM(NVL(B.VALUE_HAVED_SALE,0)))  / 100000000, 2)
    INTO   V_DT_VALUE
    FROM   SYS_PROJECT A
    INNER  JOIN DWM_DT_VALUE B
    ON     A.ID = B.OBJ_ID AND
           B.OBJ_TYPE = '项目';*/
		SELECT ROUND(SUM(DDV.TARGET_A1_VALUE) / 10000, 2)
    INTO   V_KY_TARGET_VALUE
    FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = '003200000000000000000000000000' CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
    LEFT   JOIN SYS_PROJECT SP
    ON     PP.ID = SP.UNIT_ID
    LEFT   JOIN DWM_DT_VALUE DDV
    ON     DDV.OBJ_ID = SP.ID;
    
    
    SELECT ROUND(SUM(A.VALUE_DT_ALL) / 100000000, 2) INTO V_DT_VALUE FROM DWM_DT_VALUE A WHERE A.OBJ_TYPE = '项目';
    
    
		SELECT ROUND(SUM(DDV.TARGET_A2_VALUE) / 10000, 2)
    INTO   V_QP_TARGET_VALUE
    FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = '003200000000000000000000000000' CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
    LEFT   JOIN SYS_PROJECT SP
    ON     PP.ID = SP.UNIT_ID
    LEFT   JOIN DWM_DT_VALUE DDV
    ON     DDV.OBJ_ID = SP.ID;
    SELECT ROUND(SUM(A.VALUE_DT_ALL) / 100000000, 2) INTO V_DT_VALUE FROM DWM_DT_VALUE A WHERE A.OBJ_TYPE = '项目';

		SELECT ROUND(SUM(DDV.TARGET_A3_VALUE) / 10000, 2)
    INTO   V_DT_TARGET_VALUE
    FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = '003200000000000000000000000000' CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
    LEFT   JOIN SYS_PROJECT SP
    ON     PP.ID = SP.UNIT_ID
    LEFT   JOIN DWM_DT_VALUE DDV
    ON     DDV.OBJ_ID = SP.ID;
    SELECT ROUND(SUM(A.VALUE_DT_ALL) / 100000000, 2) INTO V_DT_VALUE FROM DWM_DT_VALUE A WHERE A.OBJ_TYPE = '项目';
    
    
    
		SELECT ROUND(SUM(DDV.TARGET_A_VALUE) / 10000, 2)
		INTO   V_NOW_TARGET_VALUE
		FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = '003200000000000000000000000000' CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
		LEFT   JOIN SYS_PROJECT SP
		ON     PP.ID = SP.UNIT_ID
		LEFT   JOIN DWM_DT_VALUE DDV
		ON     DDV.OBJ_ID = SP.ID;
		SELECT ROUND(SUM(A.VALUE_DT_ALL) / 100000000, 2) INTO V_DT_VALUE FROM DWM_DT_VALUE A WHERE A.OBJ_TYPE = '项目';

		OPEN WACTHINFO FOR
				SELECT '可研版目标货值' AS "name", V_KY_TARGET_VALUE AS "total", '#33CCCC' AS "color", '1'
				FROM   DUAL
				UNION
				SELECT '全盘版目标货值' AS "name", V_QP_TARGET_VALUE AS "total", '#33CCCC' AS "color", '2'
				FROM   DUAL
				UNION
				SELECT '动态版目标货值' AS "name", V_DT_TARGET_VALUE AS "total", '#33CCCC' AS "color", '3'
				FROM   DUAL
				UNION
				SELECT '最新版目标货值' AS "name", V_NOW_TARGET_VALUE AS "total", '#00b2df' AS "color", '4'
				FROM   DUAL
				UNION
				SELECT '动态货值' AS "name", V_DT_VALUE AS "total", '#37cd71' AS "color", '4'
				FROM   DUAL
				ORDER  BY 4 DESC;
		TITLE   := '总货值情况：目标货值 vs 动态货值';
		UNIT    := '亿元';
		BARTYPE := 'column';
END P_DWM_W_TOTAL_WORTH;
/

prompt
prompt Creating procedure P_DWM_W_VISUAL_LAYOUT
prompt ========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_W_VISUAL_LAYOUT
(
		PROJID     IN VARCHAR2
	 , --项目分期id
		VISUALTYPE IN VARCHAR2
	 , --类别，1：动态货量，2：动态货值
		DATEPOINT  IN DATE
	 , ---数据点,选中时间
		WACTHINFO  OUT SYS_REFCURSOR --监控信息（根据页面图
) AS
		--动态货值-可视化分析
		--作者：陈丽
		--日期：2019/12/07
BEGIN
		IF VISUALTYPE = 2 THEN
		
				OPEN WACTHINFO FOR
						WITH TMP_PROJ_VALUE(ORG_ID,
						ORGNAME,
						PARENT_ID,
						ORDER_HIERARCHY_CODE,
						ZZ_VALUE_ALLOW_SALE,
						CW_VALUE_ALLOW_SALE,
						SY_VALUE_ALLOW_SALE,
						VALUE_NOT_PLANNING_PERMIT,
						VALUE_NOT_CONSTRUCTION_PERMIT,
						VALUE_NOT_SALE_PERMIT,
						VALUE_NOT_COMPLETION,
						VALUE_YES_COMPLETION,
						VALUE_YES_SETTLEMENT,
						ZZ_VALUE_STOCK,
						SY_VALUE_STOCK,
						CW_VALUE_STOCK,
						PROJ_CON,
						ORGTYPE) AS
						 (
							--子集
							SELECT A1.ID AS ORG_ID, A1.PROJECT_NAME AS ORGNAME, A1.UNIT_ID AS PARENT_ID, A1.ORDER_HIERARCHY_CODE, NVL(B1.ZZ_VALUE_ALLOW_SALE, 0) ZZ_VALUE_ALLOW_SALE,
											NVL(B1.CW_VALUE_ALLOW_SALE, 0) CW_VALUE_ALLOW_SALE, NVL(B1.SY_VALUE_ALLOW_SALE, 0) SY_VALUE_ALLOW_SALE, NVL(B1.VALUE_NOT_PLANNING_PERMIT, 0) AS VALUE_NOT_PLANNING_PERMIT,
											NVL(B1.VALUE_NOT_CONSTRUCTION_PERMIT, 0) AS VALUE_NOT_CONSTRUCTION_PERMIT, NVL(B1.VALUE_NOT_SALE_PERMIT, 0) VALUE_NOT_SALE_PERMIT,
											NVL(B1.VALUE_NOT_COMPLETION, 0) AS VALUE_NOT_COMPLETION, NVL(B1.VALUE_YES_COMPLETION, 0) AS VALUE_YES_COMPLETION, NVL(B1.VALUE_YES_SETTLEMENT, 0) AS VALUE_YES_SETTLEMENT,
											NVL(B1.ZZ_VALUE_STOCK, 0) ZZ_VALUE_STOCK, NVL(B1.SY_VALUE_STOCK, 0) SY_VALUE_STOCK, NVL(B1.CW_VALUE_STOCK, 0) CW_VALUE_STOCK, 1 AS PROJ_CON, '1' AS ORGTYPE
							FROM   SYS_PROJECT A1
							INNER  JOIN DWM_DT_VALUE B1
							ON     A1.ID = B1.OBJ_ID AND
										 B1.OBJ_TYPE = '项目'
							--父级
							UNION ALL
							SELECT B2.ID, B2.ORG_NAME, B2.PARENT_ID, B2.ORDER_HIERARCHY_CODE, NVL(A2.ZZ_VALUE_ALLOW_SALE, 0), NVL(A2.CW_VALUE_ALLOW_SALE, 0), NVL(A2.SY_VALUE_ALLOW_SALE, 0),
											NVL(A2.VALUE_NOT_PLANNING_PERMIT, 0) AS VALUE_NOT_PLANNING_PERMIT, NVL(A2.VALUE_NOT_CONSTRUCTION_PERMIT, 0) AS VALUE_NOT_CONSTRUCTION_PERMIT,
											NVL(A2.VALUE_NOT_SALE_PERMIT, 0) VALUE_NOT_SALE_PERMIT, NVL(A2.VALUE_NOT_COMPLETION, 0) AS VALUE_NOT_COMPLETION, NVL(A2.VALUE_YES_COMPLETION, 0) AS VALUE_YES_COMPLETION,
											NVL(A2.VALUE_YES_SETTLEMENT, 0) AS VALUE_YES_SETTLEMENT, NVL(A2.ZZ_VALUE_STOCK, 0), NVL(A2.SY_VALUE_STOCK, 0), NVL(A2.CW_VALUE_STOCK, 0), A2.PROJ_CON, '0' AS ORGTYPE
							FROM   TMP_PROJ_VALUE A2
							INNER  JOIN SYS_BUSINESS_UNIT B2
							ON     A2.PARENT_ID = B2.ID),
						TMP_STOCK_VALUE(ORG_ID,
						ORGNAME,
						PARENTID,
						ORDER_HIERARCHY_CODE,
						ORGTYPE,
						SIX_MONTH_IN,
						SIX_TO_TWELVE_MONTH,
						TWELVE_TO_EIGHTEEN_MONTH,
						EIGHTEEN_MONTH_ABOVE,
						TOTAL) AS
						 (
							--子集
							SELECT A1.ID AS ORG_ID, A1.PROJECT_NAME AS ORGNAME, A1.UNIT_ID AS PARENT_ID, A1.ORDER_HIERARCHY_CODE, '1' AS ORGTYPE,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) <= 5 THEN
																B1.BZ_PRICE * B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS SIX_MONTH_IN,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) BETWEEN 6 AND 12 THEN
																B1.BZ_PRICE * B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS SIX_TO_TWELVE_MONTH,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) BETWEEN 12 AND 18 THEN
																B1.BZ_PRICE * B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS TWELVE_TO_EIGHTEEN_MONTH,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) > 18 OR C1.GET_PRE_SALE_PERMIT_DATE IS NULL THEN
																B1.BZ_PRICE * B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS EIGHTEEN_MONTH_ABOVE, SUM(B1.BZ_PRICE * B1.PRE_BLD_AREA) AS TOTAL
							FROM   SYS_PROJECT A1
							LEFT   JOIN MDM_ROOM B1
							ON     A1.ID = B1.PROJECT_ID AND
										 B1.SALE_STATE <> '签约'
							LEFT   JOIN MDM_BUILD C1
							ON     B1.BUILDING_ID = C1.ID
							GROUP  BY A1.ID, A1.PROJECT_NAME, A1.UNIT_ID, A1.ORDER_HIERARCHY_CODE
							--父级
							UNION ALL
							SELECT B2.ID, B2.ORG_NAME, B2.PARENT_ID, B2.ORDER_HIERARCHY_CODE, '0' AS ORGTYPE, SIX_MONTH_IN, SIX_TO_TWELVE_MONTH, TWELVE_TO_EIGHTEEN_MONTH, EIGHTEEN_MONTH_ABOVE, TOTAL
							FROM   TMP_STOCK_VALUE A2
							INNER  JOIN SYS_BUSINESS_UNIT B2
							ON     A2.PARENTID = B2.ID)
						
						SELECT *
						FROM   (SELECT 1 AS "groupId", '1:各阶段货值分布' AS "groupName", '#4472C4' AS "itemColor", '未取证' AS "itemName", ROUND(P.VALUE_NOT_PLANNING_PERMIT / 100000000, 2) AS "statistics"
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 1 AS "groupId", '1:各阶段货值分布', '#ED7D31' AS "itemColor", '已取规划许可证' AS "itemName", ROUND(P.VALUE_NOT_CONSTRUCTION_PERMIT / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 1 AS "groupId", '1:各阶段货值分布', '#A5A5A5' AS "itemColor", '已取施工许可证' AS "itemName", ROUND(P.VALUE_NOT_SALE_PERMIT / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 1 AS "groupId", '1:各阶段货值分布', '#FFC000' AS "itemColor", '已取预售许可证' AS "itemName", ROUND(P.VALUE_NOT_COMPLETION / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 1 AS "groupId", '1:各阶段货值分布', '#5B9BD5' AS "itemColor", '已取竣工备案证' AS "itemName", ROUND(P.VALUE_YES_COMPLETION / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 1 AS "groupId", '1:各阶段货值分布', '#00CED1' AS "itemColor", '已结转' AS "itemName", ROUND(P.VALUE_YES_SETTLEMENT / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 2, '2:各业态货值分布', '#5B9BD5', '住宅', ROUND(P.ZZ_VALUE_ALLOW_SALE / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 2, '2:各业态货值分布', '#4472C4', '车位', ROUND(P.CW_VALUE_ALLOW_SALE / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 2, '2:各业态货值分布', '#FFC000', '商业', ROUND(P.SY_VALUE_ALLOW_SALE / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 3, '3:已推未售货值分布', '#5B9BD5', '住宅', ROUND(P.ZZ_VALUE_STOCK / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 3, '3:已推未售货值分布', '#FFC000', '商业', ROUND(P.SY_VALUE_STOCK / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 3, '3:已推未售货值分布', '#4472C4', '车位', ROUND(P.CW_VALUE_STOCK / 100000000, 2)
										 FROM   TMP_PROJ_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 4, '4:库存货龄分布', '#4472C4', '6个月以内', ROUND(SUM(P.SIX_MONTH_IN) / 100000000, 2)
										 FROM   TMP_STOCK_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 4, '4:库存货龄分布', '#FFC000', '6-12个月', ROUND(SUM(P.SIX_TO_TWELVE_MONTH) / 100000000, 2)
										 FROM   TMP_STOCK_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 4, '4:库存货龄分布', '#5B9BD5', '12-18个月', ROUND(SUM(P.TWELVE_TO_EIGHTEEN_MONTH) / 100000000, 2)
										 FROM   TMP_STOCK_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 4, '4:库存货龄分布', '#A5A5A5', '18个月以上', ROUND(SUM(P.EIGHTEEN_MONTH_ABOVE) / 100000000, 2)
										 FROM   TMP_STOCK_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 
										 ) M
						WHERE  m."statistics" <> 0;
		
		END IF;

		IF VISUALTYPE = 1 THEN
				--- 货量
				OPEN WACTHINFO FOR
						WITH TMP_PROJ_AREA(ORG_ID,
						ORGNAME,
						PARENT_ID,
						ORDER_HIERARCHY_CODE,
						ZZ_AREA_ALLOW_SALE,
						CW_AREA_ALLOW_SALE,
						SY_AREA_ALLOW_SALE,
						AREA_NOT_PLANNING_PERMIT,
						AREA_NOT_CONSTRUCTION_PERMIT,
						AREA_NOT_SALE_PERMIT,
						AREA_NOT_COMPLETION,
						AREA_YES_COMPLETION,
						AREA_YES_SETTLEMENT,
						ZZ_AREA_STOCK,
						SY_AREA_STOCK,
						CW_AREA_STOCK,
						PROJ_CON,
						ORGTYPE) AS
						 (
							--子集
							SELECT A1.ID AS ORG_ID, A1.PROJECT_NAME AS ORGNAME, A1.UNIT_ID AS PARENT_ID, A1.ORDER_HIERARCHY_CODE, NVL(B1.ZZ_AREA_ALLOW_SALE, 0) ZZ_AREA_ALLOW_SALE,
											NVL(B1.CW_AREA_ALLOW_SALE, 0) CW_AREA_ALLOW_SALE, NVL(B1.SY_AREA_ALLOW_SALE, 0) SY_AREA_ALLOW_SALE,
											NVL(B1.ZZ_AREA_NOT_PLANNING_PERMIT, 0) + NVL(B1.SY_AREA_NOT_PLANNING_PERMIT, 0) AS AREA_NOT_PLANNING_PERMIT,
											NVL(B1.ZZ_AREA_NOT_CONSTRUCTION_PER, 0) + NVL(B1.SY_AREA_NOT_CONSTRUCTION_PER, 0) AS AREA_NOT_CONSTRUCTION_PERMIT,
											NVL(B1.ZZ_AREA_NOT_SALE_PERMIT, 0) + NVL(B1.SY_AREA_NOT_SALE_PERMIT, 0) AREA_NOT_SALE_PERMIT,
											NVL(B1.ZZ_AREA_NOT_COMPLETION, 0) + NVL(B1.SY_AREA_NOT_COMPLETION, 0) AS AREA_NOT_COMPLETION,
											NVL(B1.ZZ_AREA_YES_COMPLETION, 0) + NVL(B1.SY_AREA_YES_COMPLETION, 0) AS AREA_YES_COMPLETION,
											NVL(B1.ZZ_AREA_YES_SETTLEMENT, 0) + NVL(B1.SY_AREA_YES_SETTLEMENT, 0) AS AREA_YES_SETTLEMENT, NVL(B1.ZZ_AREA_STOCK, 0) ZZ_AREA_STOCK, NVL(B1.SY_AREA_STOCK, 0) SY_AREA_STOCK,
											NVL(B1.CW_AREA_STOCK, 0) CW_AREA_STOCK, 1 AS PROJ_CON, '1' AS ORGTYPE
							FROM   SYS_PROJECT A1
							INNER  JOIN DWM_DT_VALUE B1
							ON     A1.ID = B1.OBJ_ID AND
										 B1.OBJ_TYPE = '项目'
							--父级
							UNION ALL
							SELECT B2.ID, B2.ORG_NAME, B2.PARENT_ID, B2.ORDER_HIERARCHY_CODE, NVL(A2.ZZ_AREA_ALLOW_SALE, 0), NVL(A2.CW_AREA_ALLOW_SALE, 0), NVL(A2.SY_AREA_ALLOW_SALE, 0),
											NVL(A2.AREA_NOT_PLANNING_PERMIT, 0) AS AREA_NOT_PLANNING_PERMIT, NVL(A2.AREA_NOT_CONSTRUCTION_PERMIT, 0) AS AREA_NOT_CONSTRUCTION_PERMIT,
											NVL(A2.AREA_NOT_SALE_PERMIT, 0) AREA_NOT_SALE_PERMIT, NVL(A2.AREA_NOT_COMPLETION, 0) AS AREA_NOT_COMPLETION, NVL(A2.AREA_YES_COMPLETION, 0) AS AREA_YES_COMPLETION,
											NVL(A2.AREA_YES_SETTLEMENT, 0) AS AREA_YES_SETTLEMENT, NVL(A2.ZZ_AREA_STOCK, 0), NVL(A2.SY_AREA_STOCK, 0), NVL(A2.CW_AREA_STOCK, 0), A2.PROJ_CON, '0' AS ORGTYPE
							FROM   TMP_PROJ_AREA A2
							INNER  JOIN SYS_BUSINESS_UNIT B2
							ON     A2.PARENT_ID = B2.ID),
						
						--库存
						TMP_STOCK_VALUE(ORG_ID,
						ORGNAME,
						PARENTID,
						ORDER_HIERARCHY_CODE,
						ORGTYPE,
						SIX_MONTH_IN,
						SIX_TO_TWELVE_MONTH,
						TWELVE_TO_EIGHTEEN_MONTH,
						EIGHTEEN_MONTH_ABOVE,
						TOTAL) AS
						 (
							--子集
							SELECT A1.ID AS ORG_ID, A1.PROJECT_NAME AS ORGNAME, A1.UNIT_ID AS PARENT_ID, A1.ORDER_HIERARCHY_CODE, '1' AS ORGTYPE,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) <= 5 THEN
																B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS SIX_MONTH_IN,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) BETWEEN 6 AND 12 THEN
																B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS SIX_TO_TWELVE_MONTH,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) BETWEEN 12 AND 18 THEN
																B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS TWELVE_TO_EIGHTEEN_MONTH,
											SUM(CASE
															 WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, C1.GET_PRE_SALE_PERMIT_DATE)) > 18 OR C1.GET_PRE_SALE_PERMIT_DATE IS NULL THEN
																B1.PRE_BLD_AREA
															 ELSE
																0
													 END) AS EIGHTEEN_MONTH_ABOVE, SUM( B1.PRE_BLD_AREA) AS TOTAL
							FROM   SYS_PROJECT A1
							LEFT   JOIN MDM_ROOM B1
							ON     A1.ID = B1.PROJECT_ID AND
										 B1.SALE_STATE <> '签约'
							LEFT   JOIN MDM_BUILD C1
							ON     B1.BUILDING_ID = C1.ID
							GROUP  BY A1.ID, A1.PROJECT_NAME, A1.UNIT_ID, A1.ORDER_HIERARCHY_CODE
							--父级
							UNION ALL
							SELECT B2.ID, B2.ORG_NAME, B2.PARENT_ID, B2.ORDER_HIERARCHY_CODE, '0' AS ORGTYPE, SIX_MONTH_IN, SIX_TO_TWELVE_MONTH, TWELVE_TO_EIGHTEEN_MONTH, EIGHTEEN_MONTH_ABOVE, TOTAL
							FROM   TMP_STOCK_VALUE A2
							INNER  JOIN SYS_BUSINESS_UNIT B2
							ON     A2.PARENTID = B2.ID)
						
						SELECT *
						FROM   (SELECT 11 AS "groupId", '1:各阶段货量分布' AS "groupName", '#4472C4' AS "itemColor", '未取证' AS "itemName", P.AREA_NOT_PLANNING_PERMIT AS "statistics"
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 11 AS "groupId", '1:各阶段货量分布', '#ED7D31' AS "itemColor", '已取规划许可证' AS "itemName", P.AREA_NOT_CONSTRUCTION_PERMIT
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 11 AS "groupId", '1:各阶段货量分布', '#A5A5A5' AS "itemColor", '已取施工许可证' AS "itemName", P.AREA_NOT_SALE_PERMIT
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 11 AS "groupId", '1:各阶段货量分布', '#FFC000' AS "itemColor", '已取预售许可证' AS "itemName", P.AREA_NOT_COMPLETION
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 11 AS "groupId", '1:各阶段货量分布', '#5B9BD5' AS "itemColor", '已取竣工备案证' AS "itemName", P.AREA_YES_COMPLETION
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 11 AS "groupId", '1:各阶段货量分布', '#00CED1' AS "itemColor", '已结转' AS "itemName", P.AREA_YES_SETTLEMENT
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 12, '2:各业态货量分布', '#5B9BD5', '住宅', P.ZZ_AREA_ALLOW_SALE
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										  UNION ALL
                     SELECT 12, '2:各业态货量分布', '#4472C4', '车位', P.CW_AREA_ALLOW_SALE
                     FROM   TMP_PROJ_AREA P
                     WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 12, '2:各业态货量分布', '#FFC000', '商业', P.SY_AREA_ALLOW_SALE
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 13, '3:已推未售货量分布', '#5B9BD5', '住宅', P.ZZ_AREA_STOCK
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 13, '3:已推未售货量分布', '#FFC000', '商业', P.SY_AREA_STOCK
										 FROM   TMP_PROJ_AREA P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
                     SELECT 13, '3:已推未售货量分布', '#4472C4', '车位', p.CW_AREA_STOCK
                     FROM   TMP_PROJ_AREA P
                     WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 14, '4:库存货龄分布', '#4472C4', '6个月以内', SUM(P.SIX_MONTH_IN)
										 FROM   TMP_STOCK_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 14, '4:库存货龄分布', '#FFC000', '6-12个月', SUM(P.SIX_TO_TWELVE_MONTH)
										 FROM   TMP_STOCK_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 14, '4:库存货龄分布', '#5B9BD5', '12-18个月', SUM(P.TWELVE_TO_EIGHTEEN_MONTH) 
										 FROM   TMP_STOCK_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 UNION ALL
										 SELECT 14, '4:库存货龄分布', '#FA8072', '18个月以上', SUM(P.EIGHTEEN_MONTH_ABOVE) 
										 FROM   TMP_STOCK_VALUE P
										 WHERE  P.ORG_ID = PROJID
										 
										 ) M
						WHERE  m."statistics" <> 0;
				
		
		END IF;

END P_DWM_W_VISUAL_LAYOUT;
/

prompt
prompt Creating procedure P_DWM_W_WORTH_BIG_DATA
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_W_WORTH_BIG_DATA
(
	  ORGID         IN VARCHAR2---查询货值的组织
	 ,ORGTYPE       IN VARCHAR2---查询货值的类型 
     ,i_source      IN VARCHAR2---请求数据源 OA、DWM
     ,userid           IN               VARCHAR2---当前登录人
     ,stationid        IN               VARCHAR2---当前登录人岗位
     ,deptid           IN               VARCHAR2---当前登录人部门
     ,companyid        IN               VARCHAR2---当前登录人公司
	 ,TARGETWORTH  OUT SYS_REFCURSOR---目标货值
	 ,DYNAMICWORTH OUT SYS_REFCURSOR---动态货值
     ,O_SOURCECONFIG OUT SYS_REFCURSOR---配置
	 ,DESCRIPTION  OUT CLOB--货值下方描述
) AS
		--动态货值监控-tab货值大数据
		--作者：陈丽
		--修改者：谢松宏
        --修改者：陈丽 20200626 于政要求，动态货值监控-货值数据，库存货值和剩余货值需要对齐。调整后按固定宽度计算。要求 '目标总货值'和'动态总货值' id 不能改变。
		--修改者：陈丽 20200809 chenl 动态货值监控中货值数据tab页，货值阶段图中结转阶段删除。 
        --日期：2020-03-31
		V_DT_VALUE_ALL      NUMBER(18, 2); --动态总货值
		V_DT_SYHZ_VALUE_ALL NUMBER(18, 2); --剩余货值
		V_DT_YSHZ_VALUE     NUMBER(18, 2); --已售货值
		V_DT_CBHZ_VALUE     NUMBER(18, 2); --储备货值
		V_DT_ZTHZ_VALUE     NUMBER(18, 2); --在途货值
		V_DT_YQZHZ_VALUE    NUMBER(18, 2); --已取证货值
		V_DT_KCHZ_VALUE     NUMBER(18, 2); --库存货值
		V_DT_WQGZHZ_VALUE   NUMBER(18, 2); --未取规证货值
		V_DT_GHXKZHZ_VALUE  NUMBER(18, 2); --规划许可证货值
		V_DT_SGXKZHZ_VALUE  NUMBER(18, 2); --施工许可证货值
		V_DT_YSXKZHZ_VALUE  NUMBER(18, 2); --预售许可证货值
		V_DT_JGBAHZ_VALUE   NUMBER(18, 2); --竣工备案货值
		V_DT_JZHZ_VALUE     NUMBER(18, 2); --结转货值
        page_source VARCHAR2(10):=UPPER(nvl(i_source,'dwm'));
        oa_page_source_val VARCHAR2(10):=UPPER('OA');
        min_base_width VARCHAR2(10):=(case when page_source=oa_page_source_val then '75' else '85' end);
        base_width NUMBER(18, 2):=(case when page_source=oa_page_source_val then 170 else 430 end);
        未取规证	 VARCHAR2(10):=min_base_width;
        规划许可证阶段 VARCHAR2(10):=	min_base_width;
        施工许可证阶段 VARCHAR2(10):=	min_base_width;
        预售许可证阶段	 VARCHAR2(10):=min_base_width;
        竣工备案阶段	 VARCHAR2(10):=min_base_width;
        结转阶段	 VARCHAR2(10):=min_base_width;

        储备货值	 VARCHAR2(10):=min_base_width;
        在途货值 VARCHAR2(10):=to_char(2*min_base_width,'99,990.0');
        已取证货值 VARCHAR2(10):=to_char(2*min_base_width,'99,990.0');
        库存货值	 VARCHAR2(10):=min_base_width;
        已售货值1	 VARCHAR2(10):=to_char(1*min_base_width,'99,990.0');

        剩余货值	 VARCHAR2(10):=to_char(储备货值+在途货值+库存货值,'99,990.0');
        已售货值	 VARCHAR2(10):=已售货值1;

        base_row_width  NUMBER(18, 2):=base_width+剩余货值+已售货值; --总宽度
        jumpurl VARCHAR2(500);
        domain VARCHAR2(500):=GET_JUMP_URL_DOMAIN('pc','dwm');
        oaj   VARCHAR2(500):=domain||'/dwm/value-manage/dynamic-value/value-monitor?companyId=003200000000000000000000000000&orgtype=0&projectId=003200000000000000000000000000&tabType=5';

        mj   VARCHAR2(500):=domain||'/dwm/value-manage/value-project/list?code=value_list&companyId=003200000000000000000000000000&projectId=003200000000000000000000000000';

BEGIN
-------------------------20200701 集团栗亚鹏和于政提出  门户网站货值数据页面,区域较小 所以根据源设置高度和字体


   BEGIN   
    OPEN o_sourceConfig FOR select (case when page_source=oa_page_source_val then 42 else 60 end) as rowHeight
         ,(case when page_source=oa_page_source_val then 12 else 18 end) as valueFontSize
         ,(case when page_source=oa_page_source_val then 42 else 60 end) as  leftWidth
         ,(case when page_source=oa_page_source_val then 2 else 10 end) as  spacing
         ,(case when page_source=oa_page_source_val then 8 else 12 end) as descriptionFontSize
           from dual;
         jumpurl:=(case when page_source=oa_page_source_val then oaj else mj end);
           EXCEPTION
        WHEN OTHERS THEN 
           jumpurl:=mj;
        OPEN o_sourceConfig FOR select 60 as rowHeight
         ,18 as valueFontSize
         ,60 as  leftWidth
         ,10 as  spacing
         ,12 as descriptionFontSize
          from dual;
    END; 
		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_DT_ALL) / 100000000, 2)
						FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
						LEFT   JOIN SYS_PROJECT SP
						ON     PP.ID = SP.UNIT_ID
						LEFT   JOIN DWM_DT_VALUE DDV
						ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_DT_ALL / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_VALUE_ALL
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;



		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_REMAIN) / 100000000, 2)
						FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
						LEFT   JOIN SYS_PROJECT SP
						ON     PP.ID = SP.UNIT_ID
						LEFT   JOIN DWM_DT_VALUE DDV
						ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_REMAIN / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_SYHZ_VALUE_ALL
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_HAVED_SALE) / 100000000, 2)
						FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
						LEFT   JOIN SYS_PROJECT SP
						ON     PP.ID = SP.UNIT_ID
						LEFT   JOIN DWM_DT_VALUE DDV
						ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_HAVED_SALE / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_YSHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_RESERVE) / 100000000, 2)
						FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
						LEFT   JOIN SYS_PROJECT SP
						ON     PP.ID = SP.UNIT_ID
						LEFT   JOIN DWM_DT_VALUE DDV
						ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_RESERVE / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_CBHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_IN_PROCESS) / 100000000, 2)
						FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
						LEFT   JOIN SYS_PROJECT SP
						ON     PP.ID = SP.UNIT_ID
						LEFT   JOIN DWM_DT_VALUE DDV
						ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_IN_PROCESS / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_ZTHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;


		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_NOT_CONSTRUCTION_PERMIT) / 100000000, 2)
						FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
						LEFT   JOIN SYS_PROJECT SP
						ON     PP.ID = SP.UNIT_ID
						LEFT   JOIN DWM_DT_VALUE DDV
						ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_NOT_CONSTRUCTION_PERMIT / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_GHXKZHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_STOCK) / 100000000, 2)
						FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
						LEFT   JOIN SYS_PROJECT SP
						ON     PP.ID = SP.UNIT_ID
						LEFT   JOIN DWM_DT_VALUE DDV
						ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_STOCK / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_KCHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		V_DT_YQZHZ_VALUE := V_DT_YSHZ_VALUE + V_DT_KCHZ_VALUE;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_NOT_PLANNING_PERMIT) / 100000000, 2)
						FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
						LEFT   JOIN SYS_PROJECT SP
						ON     PP.ID = SP.UNIT_ID
						LEFT   JOIN DWM_DT_VALUE DDV
						ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_NOT_PLANNING_PERMIT / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_WQGZHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_NOT_SALE_PERMIT) / 100000000, 2)
						FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
						LEFT   JOIN SYS_PROJECT SP
						ON     PP.ID = SP.UNIT_ID
						LEFT   JOIN DWM_DT_VALUE DDV
						ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_NOT_SALE_PERMIT / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_SGXKZHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_NOT_COMPLETION) / 100000000, 2)
						FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
						LEFT   JOIN SYS_PROJECT SP
						ON     PP.ID = SP.UNIT_ID
						LEFT   JOIN DWM_DT_VALUE DDV
						ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_NOT_COMPLETION / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_YSXKZHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_YES_COMPLETION) / 100000000, 2)
						FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
						LEFT   JOIN SYS_PROJECT SP
						ON     PP.ID = SP.UNIT_ID
						LEFT   JOIN DWM_DT_VALUE DDV
						ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_YES_COMPLETION / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_JGBAHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_YES_SETTLEMENT) / 100000000, 2)
						FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
						LEFT   JOIN SYS_PROJECT SP
						ON     PP.ID = SP.UNIT_ID
						LEFT   JOIN DWM_DT_VALUE DDV
						ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.VALUE_YES_SETTLEMENT / 100000000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0)
		INTO   V_DT_JZHZ_VALUE
		FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
		WHERE  AA.ID = ORGID;
----20200809 chenl 动态货值监控中货值数据tab页，货值阶段图中结转阶段删除。 
        V_DT_JZHZ_VALUE:=0;
		OPEN TARGETWORTH FOR 
				SELECT (case 
 when "id"='未取规证' then 未取规证 
 when "id"='规划许可证阶段' then 规划许可证阶段 
 when "id"='施工许可证阶段' then 施工许可证阶段 
 when "id"='预售许可证阶段' then 预售许可证阶段 
 when "id"='竣工备案阶段' then 竣工备案阶段 
 --when "id"='结转阶段' then 结转阶段 
 when "id"='储备货值（c=b0）' then 储备货值 
 when "id"='在途货值（d）' then 在途货值 
 when "id"='已取证货值' then 已取证货值 
 when "id"='库存货值' then 库存货值 
 when "id"='已售货值1' then 已售货值1 
 when "id"='剩余货值' then 剩余货值 
 when "id"='已售货值（E2）' then 已售货值
 else '6' end  ) AS "minPercentage"
 ,base_row_width as "baseRowWidth"
 ,to_char(base_width/(case when V_DT_VALUE_ALL=0 then 1 else V_DT_VALUE_ALL end),'fm990.000000000000000000000000000') as "singleWidth"
 ,jumpurl as "jumpUrl"
 , RESULT.*
				FROM   (SELECT '目标总货值' AS "id", NULL AS "parentsId", ' 目标 总货值' AS "name", NULL AS "value", '#009900' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
								 FROM   SYS_BUSINESS_UNIT AA
								 WHERE  AA.IS_COMPANY = 1 AND AA.ID = '003200000000000000000000000000'
--								 UNION ALL
--								 SELECT AA.ID AS "id", '目标总货值' AS "parentsId", 'A1可研版目标货值' AS "name",
--												NVL((SELECT ROUND(SUM(DDV.TARGET_A1_VALUE) / 10000, 2)
--														 FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
--														 LEFT   JOIN SYS_PROJECT SP
--														 ON     PP.ID = SP.UNIT_ID
--														 LEFT   JOIN DWM_DT_VALUE DDV
--														 ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.TARGET_A1_VALUE / 10000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0) AS "value",
--												'#009900' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
--								 FROM   (SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP) AA
--								 WHERE  AA.ID = ORGID
--								 UNION ALL
--								 SELECT AA.ID, '目标总货值', 'A2全盘版目标货值',
--												NVL((SELECT ROUND(SUM(DDV.TARGET_A2_VALUE) / 10000, 2)
--														 FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
--														 LEFT   JOIN SYS_PROJECT SP
--														 ON     PP.ID = SP.UNIT_ID
--														 LEFT   JOIN DWM_DT_VALUE DDV
--														 ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.TARGET_A2_VALUE / 10000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0),
--												'#009900' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
--								 FROM   ((SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP)) AA
--								 WHERE  AA.ID = ORGID
--								 UNION ALL
--								 SELECT AA.ID, '目标总货值', 'A3动态版目标货值',
--												NVL((SELECT ROUND(SUM(DDV.TARGET_A3_VALUE) / 10000, 2)
--														 FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
--														 LEFT   JOIN SYS_PROJECT SP
--														 ON     PP.ID = SP.UNIT_ID
--														 LEFT   JOIN DWM_DT_VALUE DDV
--														 ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.TARGET_A3_VALUE / 10000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0),
--												'#009900' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
--								 FROM   ((SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP)) AA
--								 WHERE  AA.ID = ORGID
								 UNION ALL
								 SELECT AA.ID, '目标总货值', '最新版目标货值',
												NVL((SELECT ROUND(SUM(DDV.TARGET_A_VALUE) / 10000, 2)
														 FROM   (SELECT SBU.ORG_NAME, SBU.ID FROM SYS_BUSINESS_UNIT SBU WHERE SBU.IS_COMPANY = 1 START WITH SBU.ID = ORGID CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID) PP
														 LEFT   JOIN SYS_PROJECT SP
														 ON     PP.ID = SP.UNIT_ID
														 LEFT   JOIN DWM_DT_VALUE DDV
														 ON     DDV.OBJ_ID = SP.ID), 0) + NVL((SELECT ROUND(P.TARGET_A_VALUE / 10000, 2) FROM DWM_DT_VALUE P WHERE P.OBJ_ID = AA.ID AND P.OBJ_TYPE = '项目'), 0),
												'#FFA500' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
								 FROM   ((SELECT SBU.ID, SBU.IS_COMPANY FROM SYS_BUSINESS_UNIT SBU UNION ALL SELECT SP.ID, 0 FROM SYS_PROJECT SP)) AA
								 WHERE  AA.ID = ORGID) RESULT;

		OPEN DYNAMICWORTH FOR
				SELECT (case 
 when "id"='未取规证' then 未取规证 
 when "id"='规划许可证阶段' then 规划许可证阶段 
 when "id"='施工许可证阶段' then 施工许可证阶段 
 when "id"='预售许可证阶段' then 预售许可证阶段 
 when "id"='竣工备案阶段' then 竣工备案阶段 
 --when "id"='结转阶段' then 结转阶段 
 when "id"='储备货值（c=b0）' then 储备货值 
 when "id"='在途货值（d）' then 在途货值 
 when "id"='已取证货值' then 已取证货值 
 when "id"='库存货值' then 库存货值 
 when "id"='已售货值1' then 已售货值1 
 when "id"='剩余货值' then 剩余货值 
 when "id"='已售货值（E2）' then 已售货值
 else '6' end  ) AS "minPercentage"
 ,base_row_width as "baseRowWidth"
 ,to_char(base_width/(case when V_DT_VALUE_ALL=0 then 1 else V_DT_VALUE_ALL end),'fm990.000000000000000000000000000') as "singleWidth"
 ,jumpurl as "jumpUrl"
 ,"id", "parentsId", "name", "value", "color" AS "color", "bgColor" AS "bgColor", "nameColor" AS "nameColor",
							 CASE WHEN "name"=
										'已取证货值' THEN
										 1
										ELSE
										 0
								END AS "isNesting", 0 "layout"
				FROM   (SELECT '动态总货值' AS "id", '' AS "parentsId", ' 动态 总货值' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_VALUE_ALL, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 --- 动态总货值
								 UNION ALL
								 SELECT '0' AS "id", '动态总货值' AS "parentsId", '动态总货值' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_VALUE_ALL, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '1' AS "id", '动态总货值' AS "parentsId", '' AS "name", '#ffffff' AS "color", '#00BFFF' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_VALUE_ALL, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '剩余货值' AS "id", '1' AS "parentsId", '剩余货值' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_SYHZ_VALUE_ALL, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
--                                 --------------------chenl
--                                  UNION ALL
--								 SELECT '储备货值（c=b0）old' AS "id", '剩余货值' AS "parentsId", '储备货值（c=b0）' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
--												RTRIM(TO_CHAR(V_DT_CBHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
--								 FROM   DUAL
--								 UNION ALL
--								 SELECT '在途货值（d）old' AS "id", '剩余货值' AS "parentsId", '在途货值（d）' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
--												RTRIM(TO_CHAR(V_DT_ZTHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
--								 FROM   DUAL
--                                  UNION ALL
--								 SELECT '库存货值old' AS "id", '剩余货值' AS "parentsId", '库存货值' AS "name", '#ffffff' AS "color", '#e46c0a' AS "bgColor", '#666666' AS "nameColor",
--												RTRIM(TO_CHAR(V_DT_KCHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
--								 FROM   DUAL
--                                 ---------------------chenl
								 UNION ALL
								 SELECT '已售货值（E2）' AS "id", '1' AS "parentsId", '已售货值（E2）' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_YSHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 ------2
								 UNION ALL
								 SELECT '2' AS "id", '动态总货值' AS "parentsId", '' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_VALUE_ALL, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '储备货值（c=b0）' AS "id", '2' AS "parentsId", '储备货值（c=b0）' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_CBHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '在途货值（d）' AS "id", '2' AS "parentsId", '在途货值（d）' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_ZTHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '已取证货值' AS "id", '2' AS "parentsId", '已取证货值' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_YQZHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '库存货值' AS "id", '已取证货值' AS "parentsId", '库存货值' AS "name", '#ffffff' AS "color", '#e46c0a' AS "bgColor", '#666666' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_KCHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '已售货值1' AS "id", '已取证货值' AS "parentsId", '已售货值' AS "name", '#ffffff' AS "color", '#00b050' AS "bgColor", '#d7d7d7' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_YSHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 --------------------3
								 UNION ALL
								 SELECT '3' AS "id", '动态总货值' AS "parentsId", '' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#666666' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_VALUE_ALL, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '未取规证' AS "id", '3' AS "parentsId", '未取规证' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_WQGZHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '规划许可证阶段' AS "id", '3' AS "parentsId", '规划许可证阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor",
												RTRIM(TO_CHAR(NVL(V_DT_GHXKZHZ_VALUE, 0), 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '施工许可证阶段' AS "id", '3' AS "parentsId", '施工许可证阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_SGXKZHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '预售许可证阶段' AS "id", '3' AS "parentsId", '预售许可证阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_YSXKZHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '竣工备案阶段' AS "id", '3' AS "parentsId", '竣工备案阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor",
												RTRIM(TO_CHAR(V_DT_JGBAHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
								 FROM   DUAL
--								 UNION ALL
--								 SELECT '结转阶段' AS "id", '3' AS "parentsId", '结转阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor",
--												RTRIM(TO_CHAR(V_DT_JZHZ_VALUE, 'FM999990D99'), TO_CHAR(0, 'D')) AS "value"
--								 FROM   DUAL
                                 ) A;

		DESCRIPTION := '<span style="font-size:14px;color:#333333"><span style="font-weight:bold">最新版目标总货值： </span>若有"动态版目标货值"，则取"动态版目标货值"；若无"动态版目标货值"，则取"全盘版目标货值"；若无"全盘版目标货值"，则取"可研版目标货值。</span></br>
<span style="font-size:14px;color:#333333"><span style="font-weight:bold">动态总货值</span> =剩余货值+已售货值=储备货值+在途货值+库存货值+已售货值。</span></br>
<span style="font-size:14px;color:#333333"><span style="font-weight:bold">剩余货值</span> =储备货值+在途货值+库存货值。</span></br>
<span style="font-size:14px;color:#333333"><span style="font-weight:bold">已售货值：</span> 已拿预售许可证且已签约的货值，取《销售系统》中的签约金额。</span></br>
<span style="font-size:14px;color:#333333"><span style="font-weight:bold">储备货值(即未取规证货值)： </span>面积取主数据中“未取规证的面积”，价格按业态取最新的目标均价。</span></br>
<span style="font-size:14px;color:#333333"><span style="font-weight:bold">在途货值： </span>面积取主数据中“已取规证未取预售许可证的面积”，价格按业态取最新的目标均价。</span></br>
<span style="font-size:14px;color:#333333"><span style="font-weight:bold">已取证货值： </span>已拿预售许可证货值，包括“未签约、已签约”。</span></br>
<span style="font-size:14px;color:#333333"><span style="font-weight:bold">库存货值： </span>已拿预售许可证但未签约的货值，取《销售系统》中的底价。</span>';
END P_DWM_W_WORTH_BIG_DATA;
/

prompt
prompt Creating procedure P_DWM_W_WORTH_DATA
prompt =====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_W_WORTH_DATA
(
		ORGID        IN VARCHAR2
	 ,ORGTYPE      IN VARCHAR2
	 ,TARGETWORTH  OUT SYS_REFCURSOR
	 ,DYNAMICWORTH OUT SYS_REFCURSOR
) AS
		--动态货值监控-tab货值大数据
		--作者：陈丽
		--日期：2019/11/13
		V_DT_VALUE_ALL      NUMBER(18, 2); --动态总货值
		V_DT_SYHZ_VALUE_ALL NUMBER(18, 2); --剩余货值
		V_DT_YSHZ_VALUE     NUMBER(18, 2); --已售货值
		V_DT_CBHZ_VALUE     NUMBER(18, 2); --储备货值
		V_DT_ZTHZ_VALUE     NUMBER(18, 2); --在途货值
		V_DT_YQZHZ_VALUE    NUMBER(18, 2); --已取证货值
		V_DT_KCHZ_VALUE     NUMBER(18, 2); --库存货值
		V_DT_WQGZHZ_VALUE   NUMBER(18, 2); --未取规证货值
		V_DT_GHXKZHZ_VALUE  NUMBER(18, 2); --规划许可证货值
		V_DT_SGXKZHZ_VALUE  NUMBER(18, 2); --施工许可证货值
		V_DT_YSXKZHZ_VALUE  NUMBER(18, 2); --预售许可证货值
		V_DT_JGBAHZ_VALUE   NUMBER(18, 2); --竣工备案货值
		V_DT_JZHZ_VALUE     NUMBER(18, 2); --结转货值
BEGIN
		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_DT_ALL) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_DT_ALL/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_VALUE_ALL
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_REMAIN) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_REMAIN/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_SYHZ_VALUE_ALL
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_REMAIN) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_REMAIN/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_SYHZ_VALUE_ALL
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_HAVED_SALE) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_HAVED_SALE/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_YSHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_RESERVE) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_RESERVE/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_CBHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_IN_PROCESS) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_IN_PROCESS/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_ZTHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_STOCK) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_STOCK/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_YQZHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_STOCK) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_STOCK/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_KCHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE 
					 AA.ID = ORGID;

		V_DT_YQZHZ_VALUE := V_DT_YSHZ_VALUE + V_DT_KCHZ_VALUE;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_NOT_PLANNING_PERMIT) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_NOT_PLANNING_PERMIT/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_WQGZHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_NOT_SALE_PERMIT) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_NOT_SALE_PERMIT/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_SGXKZHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_NOT_COMPLETION) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_NOT_COMPLETION/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_YSXKZHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_YES_COMPLETION) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_YES_COMPLETION/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_JGBAHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		SELECT NVL((SELECT ROUND(SUM(DDV.VALUE_YES_SETTLEMENT) / 100000000, 2)
								FROM   SYS_BUSINESS_UNIT SBU
								LEFT   JOIN SYS_PROJECT SP
								ON     SBU.ID = SP.UNIT_ID
								LEFT   JOIN DWM_DT_VALUE DDV
								ON     DDV.OBJ_ID = SP.ID AND
											 DDV.OBJ_TYPE = '项目'
								WHERE  SBU.IS_COMPANY = 1
								START  WITH SBU.ID = AA.ID
								CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),
								0) + NVL((SELECT round(P.VALUE_YES_SETTLEMENT/100000000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0)
		INTO   V_DT_JZHZ_VALUE
		FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
WHERE sbu.IS_COMPANY = 1
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
		WHERE  
					 AA.ID = ORGID;

		OPEN TARGETWORTH FOR
				SELECT '目标总货值' AS "id", NULL AS "parentsId", '目标总货值' AS "name", NULL AS "value", '#009900' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
				FROM   SYS_BUSINESS_UNIT AA
				WHERE  AA.IS_COMPANY = 1 AND
							 AA.ID = '003200000000000000000000000000'
				UNION ALL
				SELECT AA.ID AS "id", '目标总货值' AS "parentsId", 'A1可研版目标货值' AS "name",
							 NVL((SELECT ROUND(SUM(DDV.TARGET_A1_VALUE) / 10000, 2)
								 FROM   SYS_BUSINESS_UNIT SBU
								 LEFT   JOIN SYS_PROJECT SP
								 ON     SBU.ID = SP.UNIT_ID
								 LEFT   JOIN DWM_DT_VALUE DDV
								 ON     DDV.OBJ_ID = SP.ID
								 WHERE  SBU.IS_COMPANY = 1
								 START  WITH SBU.ID = AA.ID
								 CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),0)+NVL((SELECT round(P.TARGET_A1_VALUE/10000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0) AS "value", '#009900' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
				FROM   (SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP) AA
				WHERE  
							 AA.ID = ORGID
				UNION ALL
				SELECT AA.ID, '目标总货值', 'A2全盘版目标货值',
							 NVL((SELECT ROUND(SUM(DDV.TARGET_A2_VALUE) / 10000, 2)
								 FROM   SYS_BUSINESS_UNIT SBU
								 LEFT   JOIN SYS_PROJECT SP
								 ON     SBU.ID = SP.UNIT_ID
								 LEFT   JOIN DWM_DT_VALUE DDV
								 ON     DDV.OBJ_ID = SP.ID
								 WHERE  SBU.IS_COMPANY = 1
								 START  WITH SBU.ID = AA.ID
								 CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),0)+NVL((SELECT round(P.TARGET_A2_VALUE/10000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0), '#009900' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
				FROM   ((SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP)) AA
				WHERE  
							 AA.ID = ORGID
				UNION ALL
				SELECT AA.ID, '目标总货值', 'A3动态版目标货值',
							 NVL((SELECT ROUND(SUM(DDV.TARGET_A3_VALUE) / 10000, 2)
								 FROM   SYS_BUSINESS_UNIT SBU
								 LEFT   JOIN SYS_PROJECT SP
								 ON     SBU.ID = SP.UNIT_ID
								 LEFT   JOIN DWM_DT_VALUE DDV
								 ON     DDV.OBJ_ID = SP.ID
								 WHERE  SBU.IS_COMPANY = 1
								 START  WITH SBU.ID = AA.ID
								 CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),0)+NVL((SELECT round(P.TARGET_A3_VALUE/10000,2)
												 FROM   DWM_DT_VALUE P
												 WHERE  P.OBJ_ID = AA.ID AND
																P.OBJ_TYPE = '项目'),
												 0), '#009900' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
				FROM   ((SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP)) AA
				WHERE  
							 AA.ID = ORGID
				UNION ALL
				SELECT AA.ID, '目标总货值', '最新版目标货值' AS FLAG,
							 NVL((SELECT ROUND(SUM(DDV.TARGET_WORTH) / 10000, 2)
								 FROM   SYS_BUSINESS_UNIT SBU
								 LEFT   JOIN SYS_PROJECT SP
								 ON     SBU.ID = SP.UNIT_ID
								 LEFT   JOIN V_DWM_TARGET_WORTH_NOW DDV
								 ON     DDV.PROJ_ID = SP.ID
								 WHERE  SBU.IS_COMPANY = 1
								 START  WITH SBU.ID = AA.ID
								 CONNECT BY PRIOR SBU.ID = SBU.PARENT_ID),0)+NVL((SELECT round(P.TARGET_WORTH/10000,2)
												 FROM   V_DWM_TARGET_WORTH_NOW P
												 WHERE  P.proj_id = AA.ID ),
												 0), '#FFA500' AS "color", '#f2f2f2' AS "bgColor", '#666666' AS "nameColor", 0 "isNesting", 0 "layout"
				FROM   ((SELECT SBU.ID,SBU.IS_COMPANY
FROM SYS_BUSINESS_UNIT SBU
UNION ALL
SELECT SP.ID,0
FROM SYS_PROJECT SP)) AA
				WHERE 
							 AA.ID = ORGID;

		OPEN DYNAMICWORTH FOR
				SELECT "id", "parentsId", "name", "value", "color" AS "color", "bgColor" AS "bgColor", "nameColor" AS "nameColor",
							 CASE "name"
										WHEN '已取证货值' THEN
										 1
										ELSE
										 0
								END AS "isNesting", 1 "layout"
				FROM   (SELECT '动态总货值' AS "id", '' AS "parentsId", '动态总货值' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_VALUE_ALL AS "value"
								 FROM   DUAL
								 --- 动态总货值
								 UNION ALL
								 SELECT '0' AS "id", '动态总货值' AS "parentsId", '动态总货值' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_VALUE_ALL AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '1' AS "id", '动态总货值' AS "parentsId", '' AS "name", '#ffffff' AS "color", '#00BFFF' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_VALUE_ALL AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '剩余货值' AS "id", '1' AS "parentsId", '剩余货值' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_SYHZ_VALUE_ALL AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '已售货值（E2）' AS "id", '1' AS "parentsId", '已售货值（E2）' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_YSHZ_VALUE AS "value"
								 FROM   DUAL
								 ------2
								 UNION ALL
								 SELECT '2' AS "id", '动态总货值' AS "parentsId", '' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_VALUE_ALL AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '储备货值（c=b0）' AS "id", '2' AS "parentsId", '储备货值（c=b0）' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_CBHZ_VALUE AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '在途货值（d）' AS "id", '2' AS "parentsId", '在途货值（d）' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_ZTHZ_VALUE AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '已取证货值' AS "id", '2' AS "parentsId", '已取证货值' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#bcbcbc' AS "nameColor", V_DT_YQZHZ_VALUE AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '库存货值' AS "id", '已取证货值' AS "parentsId", '库存货值' AS "name", '#ffffff' AS "color", '#e46c0a' AS "bgColor", '#666666' AS "nameColor", V_DT_KCHZ_VALUE AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '已售货值1' AS "id", '已取证货值' AS "parentsId", '已售货值' AS "name", '#ffffff' AS "color", '#00b050' AS "bgColor", '#d7d7d7' AS "nameColor", V_DT_YSHZ_VALUE AS "value"
								 FROM   DUAL
								 --------------------3
								 UNION ALL
								 SELECT '3' AS "id", '动态总货值' AS "parentsId", '' AS "name", '#ffffff' AS "color", '#0070C0' AS "bgColor", '#666666' AS "nameColor", V_DT_VALUE_ALL AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '未取规证' AS "id", '3' AS "parentsId", '未取规证' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor", V_DT_WQGZHZ_VALUE AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '规划许可证阶段' AS "id", '3' AS "parentsId", '规划许可证阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor", NVL(V_DT_GHXKZHZ_VALUE, 0) AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '施工许可证阶段' AS "id", '3' AS "parentsId", '施工许可证阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor", V_DT_SGXKZHZ_VALUE AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '预售许可证阶段' AS "id", '3' AS "parentsId", '预售许可证阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor", V_DT_YSXKZHZ_VALUE AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '竣工备案阶段' AS "id", '3' AS "parentsId", '竣工备案阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor", V_DT_JGBAHZ_VALUE AS "value"
								 FROM   DUAL
								 UNION ALL
								 SELECT '结转阶段' AS "id", '3' AS "parentsId", '结转阶段' AS "name", '#ffffff' AS "color", '#ffc000' AS "bgColor", '#666666' AS "nameColor", V_DT_JZHZ_VALUE AS "value"
								 FROM   DUAL) A;

END P_DWM_W_WORTH_DATA;
/

prompt
prompt Creating procedure P_DWM_W_WORTH_LAYOUT
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_W_WORTH_LAYOUT
(
    TITLE     OUT VARCHAR2
   ,WACTHINFO OUT SYS_REFCURSOR
) AS
    --动态货值监控-1布局动态
    --作者：陈丽
    --日期：2019/11/13
    V_PROJECT_TOTAL  NUMBER(5, 0) := 20;
    V_CITY_TOTAL     NUMBER(5, 0) := 4;
    V_BUSINESS_TOTAL NUMBER(5, 0) := 3;
    V_REGION_TOTAL   NUMBER(5, 0) := 1;
BEGIN
SELECT COUNT(1) INTO V_PROJECT_TOTAL FROM SYS_PROJECT;

SELECT COUNT(1) INTO V_BUSINESS_TOTAL FROM (SELECT COUNT(*) FROM SYS_PROJECT GROUP BY UNIT_ID);

SELECT COUNT(1)
INTO   V_REGION_TOTAL
FROM   (SELECT DISTINCT (SELECT O.ORG_NAME FROM SYS_BUSINESS_UNIT O WHERE O.LEVEL_RANK = 2 START WITH A.UNIT_ID = O.ID CONNECT BY PRIOR O.PARENT_ID = O.ID) ORG_NAME --,A.ID,A.PROJECT_NAME
         FROM   SYS_PROJECT A);

SELECT COUNT(1) INTO V_CITY_TOTAL FROM (SELECT COUNT(1) FROM SYS_PROJECT GROUP BY CITY_NAME);

OPEN WACTHINFO FOR
    SELECT '区域总数' AS "name", V_REGION_TOTAL AS "value", '/dwm/icon/区域总数@1x.png' AS "icon"
    FROM   DUAL
    UNION
    SELECT '事业部总数' AS "name", V_BUSINESS_TOTAL AS "value", '/dwm/icon/事业部总数@1x.png' AS "icon"
    FROM   DUAL
    UNION
    SELECT '城市总数' AS "name", V_CITY_TOTAL AS "value", '/dwm/icon/城市总数@1x.png' AS "icon"
    FROM   DUAL
    UNION
    SELECT '项目总数' AS "name", V_PROJECT_TOTAL AS "value", '/dwm/icon/项目总数@1x.png' AS "icon"
    FROM   DUAL;
TITLE := '布局动态';
END P_DWM_W_WORTH_LAYOUT;
/

prompt
prompt Creating procedure P_DWM_W_WORTH_PHASE
prompt ======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_DWM_W_WORTH_PHASE"
(
		TITLE     OUT VARCHAR2
	 ,MOREURL   OUT VARCHAR2
	 ,WACTHINFO OUT SYS_REFCURSOR
) AS
		--动态货值监控-3动态货值所处阶段
		--作者：陈丽
		--日期：2019/11/13
BEGIN
		OPEN WACTHINFO FOR
    SELECT * FROM (
				SELECT ' 未取规证' AS "NAME", 'B0' AS TOPLEFTCORNER,
							 '#C8CFD8' AS "color", '可售面积' AS TOTALNAME,
							 ROUND(SUM(NVL(A.AREA_NOT_PLANNING_PERMIT,0)) / 10000, 2) AS TOTALVALUE,
							 '万方' AS UNIT, 1 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT ' 未取规证' AS "NAME", 'B0' AS TOPLEFTCORNER,
							 '#C8CFD8' AS "color", '可售车位' AS TOTALNAME,
							 ROUND(CEIL(SUM(NVL(A.Cw_Area_Not_Planning_Permit,0))),0) AS TOTALVALUE,
                '个' AS UNIT,
							 2 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
        SELECT ' 未取规证' AS "NAME", 'B0' AS TOPLEFTCORNER,
               '#C8CFD8' AS "color", '可售货值' AS TOTALNAME,
               ROUND(SUM(NVL(A.VALUE_NOT_PLANNING_PERMIT,0)) / 100000000, 2) AS TOTALVALUE,
               '亿元' AS UNIT, 3 AS ORDER_CODE
        FROM   DWM_DT_VALUE A
        WHERE  A.OBJ_TYPE = '项目'
        UNION ALL

				SELECT '已取规证未取施证' AS "NAME", 'B1' AS TOPLEFTCORNER,
							 '#1D88C0' AS "color", '可售面积' AS TOTALNAME,
							 ROUND(SUM(NVL(A.AREA_NOT_CONSTRUCTION_PERMIT,0)) / 10000, 2) AS TOTALVALUE,
							 '万方' AS UNIT, 1 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已取规证未取施证' AS "NAME", 'B1' AS TOPLEFTCORNER,
							 '#1D88C0' AS "color", '可售车位' AS TOTALNAME,
							 ROUND(CEIL(SUM(NVL(A.CW_AREA_NOT_CONSTRUCTION_PER,0))),0) AS TOTALVALUE,
							 '个' AS UNIT, 2 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
        SELECT '已取规证未取施证' AS "NAME", 'B1' AS TOPLEFTCORNER,
               '#1D88C0' AS "color", '可售货值' AS TOTALNAME,
               ROUND(SUM(NVL(A.VALUE_NOT_CONSTRUCTION_PERMIT,0)) / 100000000, 2) AS TOTALVALUE,
               '亿元' AS UNIT, 3 AS ORDER_CODE
        FROM   DWM_DT_VALUE A
        WHERE  A.OBJ_TYPE = '项目'
        UNION ALL
				SELECT '已取施证未取预售证' AS "NAME", 'B2' AS TOPLEFTCORNER,
							 '#1D88C0' AS "color", '可售货值' AS TOTALNAME,
							 ROUND(SUM(NVL(A.VALUE_NOT_SALE_PERMIT,0)) / 100000000, 2) AS TOTALVALUE,
							 '亿元' AS UNIT, 3 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已取施证未取预售证' AS "NAME", 'B2' AS TOPLEFTCORNER,
							 '#1D88C0' AS "color", '可售面积' AS TOTALNAME,
							 ROUND(SUM(NVL(A.AREA_NOT_SALE_PERMIT,0)) / 10000, 2) AS TOTALVALUE,
							 '万方' AS UNIT, 1 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已取施证未取预售证' AS "NAME", 'B2' AS TOPLEFTCORNER,
							 '#1D88C0' AS "color", '可售车位' AS TOTALNAME,
							 ROUND(CEIL(SUM(NVL(A.CW_AREA_NOT_SALE_PERMIT,0))),0) AS TOTALVALUE,
                '个' AS UNIT,
							 2 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已取预售证未售' AS "NAME", 'B3' AS TOPLEFTCORNER,
							 '#E68CB2' AS "color", '可售货值' AS TOTALNAME,
							 ROUND(SUM(NVL(A.VALUE_STOCK,0)) / 100000000, 2) AS TOTALVALUE,
							 '亿元' AS UNIT, 3 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已取预售证未售' AS "NAME", 'B3' AS TOPLEFTCORNER,
							 '#E68CB2' AS "color", '可售面积' AS TOTALNAME,
							 ROUND(SUM(NVL(A.AREA_STOCK,0)) / 10000, 2) AS TOTALVALUE,
							 '万方' AS UNIT, 1 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已取预售证未售' AS "NAME", 'B3' AS TOPLEFTCORNER,
							 '#E68CB2' AS "color", '可售车位' AS TOTALNAME,
							 ROUND(CEIL(SUM(NVL(A.CW_AREA_STOCK,0))),0) AS TOTALVALUE,
                '个' AS UNIT,
							 2 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
        UNION ALL
        SELECT ' 已售未竣备' AS "NAME", 'B4' AS TOPLEFTCORNER,
               '#00CC66' AS "color", '可售货值' AS TOTALNAME,
               ROUND((SUM(NVL(A.VALUE_NOT_COMPLETION,0))) / 100000000, 2) AS TOTALVALUE,
               '亿元' AS UNIT, 3 AS ORDER_CODE
        FROM   DWM_DT_VALUE A
        WHERE  A.OBJ_TYPE = '项目'
        UNION ALL
        SELECT ' 已售未竣备' AS "NAME", 'B4' AS TOPLEFTCORNER,
               '#00CC66' AS "color", '可售面积' AS TOTALNAME,
               ROUND((SUM(NVL(A.AREA_NOT_COMPLETION,0))) / 10000, 2) AS TOTALVALUE,
               '万方' AS UNIT, 1 AS ORDER_CODE
        FROM   DWM_DT_VALUE A
        WHERE  A.OBJ_TYPE = '项目'
        UNION ALL
        SELECT ' 已售未竣备' AS "NAME", 'B4' AS TOPLEFTCORNER,
               '#00CC66' AS "color", '可售车位' AS TOTALNAME,
               ROUND(CEIL(SUM(NVL(A.CW_AREA_NOT_COMPLETION,0))),0) AS TOTALVALUE,
                '个' AS UNIT,
               2 AS ORDER_CODE
        FROM   DWM_DT_VALUE A
        WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已售已竣备' AS "NAME", 'B5' AS TOPLEFTCORNER,
							 '#00CC66' AS "color", '可售货值' AS TOTALNAME,
							 ROUND(SUM(NVL(A.VALUE_YES_COMPLETION,0)) / 100000000, 2) AS TOTALVALUE,
							 '亿元' AS UNIT, 3 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已售已竣备' AS "NAME", 'B5' AS TOPLEFTCORNER,
							 '#00CC66' AS "color", '可售面积' AS TOTALNAME,
							 ROUND(SUM(NVL(A.AREA_YES_COMPLETION,0)) / 10000, 2) AS TOTALVALUE,
							 '万方' AS UNIT, 1 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '已售已竣备' AS "NAME", 'B5' AS TOPLEFTCORNER,
							 '#00CC66' AS "color", '可售车位' AS TOTALNAME,
							 ROUND(CEIL(SUM(NVL(A.CW_AREA_YES_COMPLETION,0))),0) AS TOTALVALUE,
                '个' AS UNIT,
							 2 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
/*				UNION ALL
				SELECT '结转阶段' AS "NAME", '05' AS TOPLEFTCORNER, '#37cd69' AS "color",
							 '可售货值' AS TOTALNAME,
							 ROUND(SUM(A.VALUE_YES_SETTLEMENT) / 100000000, 2) AS TOTALVALUE,
							 '亿元' AS UNIT, 3 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '结转阶段' AS "NAME", '05' AS TOPLEFTCORNER, '#37cd69' AS "color",
							 '可售面积' AS TOTALNAME,
							 ROUND(SUM(A.AREA_YES_SETTLEMENT) / 100000000, 2) AS TOTALVALUE,
							 '万方' AS UNIT, 1 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'
				UNION ALL
				SELECT '结转阶段' AS "NAME", '05' AS TOPLEFTCORNER, '#37cd69' AS "color",
							 '可售车位' AS TOTALNAME,
							 SUM(A.CW_AREA_YES_SETTLEMENT) AS TOTALVALUE, '个' AS UNIT,
							 2 AS ORDER_CODE
				FROM   DWM_DT_VALUE A
				WHERE  A.OBJ_TYPE = '项目'*/
        ) t
        ORDER  BY TOPLEFTCORNER,ORDER_CODE
        ;

		MOREURL := '';

		TITLE := '动态货值阶段分布';
END P_DWM_W_WORTH_PHASE;
/

prompt
prompt Creating procedure P_DWM_云徙联合项目组
prompt ================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_DWM_云徙联合项目组
(
INFO OUT SYS_REFCURSOR
) AS
BEGIN

   OPEN INFO FOR 
      WITH basedata AS(
    ---末级业态，关联得到顶级业态。及末级业态所属对象关联(楼栋/项目/分期)
    select 
    proj.id  as 项目id
    ,proj.PROJECT_NAME as 项目名称
    ,w.TARGET_WORTH_PHASE as 阶段类型
    ,case when proj_stage.id is null then build_proj_stage.id else proj_stage.id end as 分期id
    ,case when proj_stage.id is null then build_proj_stage.STAGE_NAME else proj_stage.STAGE_NAME end as 分期名称
    ,build.id as 楼栋id
    ,build.BUILD_NAME as 楼栋名称
    ,objtype.OBJ_TYPE as 业态对象父级类型
    ,dtl.obj_id||GET_UUID() as 末级业态id
    ,dtl.obj_name as 末级业态全路径
    ,dtl.TOTAL_SALES_AREA as 总可售面积
    ,dtl.WORTH as 总货值
    ,product_type.id as 顶级业态id
    ,product_type.product_type_short_name as 顶级业态
    ,dtl.obj_parent_id as 业态对象父级id
    from (select * from DWM_TARGET_WORTH_DTL where OBJ_TYPE=40) dtl
    --关联业态 找到业态顶级
    left join MDM_BUILD_PRODUCT_TYPE PRODUCT_TYPE 
    on substr(dtl.obj_name,1,instr(dtl.obj_name,'/',1,1)-1)=PRODUCT_TYPE.product_type_name
    --关联自身找到业态的父级对象 类型
    left join DWM_TARGET_WORTH_DTL objtype on dtl.obj_parent_id=objtype.obj_id
    --关联主表建立用于与项目建立关联
    left join DWM_TARGET_WORTH w on dtl.TARGET_WORTH_ID=w.id
    --关联项目获得项目id
    left join sys_project proj on w.PROJ_ID=proj.id
    --关联楼栋获取业态的父级对象为楼栋的楼栋数据
    left join mdm_build build on dtl.obj_parent_id=build.id
    left join SYS_PROJECT_STAGE build_proj_stage on build.PERIOD_ID=build_proj_stage.id
    --关联分期获取业态的父级对象为分期的分期数据
    left join SYS_PROJECT_STAGE proj_stage on dtl.obj_parent_id=proj_stage.id
    --只获取已审核的目标货值
    where w.APPROVAL_STATUS='已审核' and w.is_delete=0
    order by objtype.OBJ_TYPE )

   ,可研 as(
    --可研:项目-业态顶级-末级业态 
    select ID,NAME,PARENT_ID,0 as 套,0 as 面积,0 as 金额,0 as 均价  from (
    select id||'|可研' id,project_name name,'可研' PARENT_ID  from SYS_PROJECT
    union all
    --业态顶级id：项目id|分期id|业态顶级id
    select proj.id||'|'||PRODUCT_TYPE.id as  id
    ,proj.project_NAME||'-'||PRODUCT_TYPE.PRODUCT_TYPE_NAME as name
    ,proj.ID||'|可研' as parent_id 
    from  SYS_PROJECT proj cross join (select * from
    MDM_BUILD_PRODUCT_TYPE where product_type_level=1) PRODUCT_TYPE)  
    union all 
    select 项目id||'|'||顶级业态id||'|'||末级业态id as id
    ,末级业态全路径
    ,项目id||'|'||顶级业态id as parent_id
    ,0 as 套
    ,总可售面积 as 面积
    ,总货值 as 金额
    ,0 as 均价 from basedata 
    where 阶段类型=0)

    ,全盘 as(
    --全盘:项目-分期-业态顶级-末级业态 
    select ID,NAME,PARENT_ID,0 as 套,10 as 面积,0 as 金额,0 as 均价  from (
    select id||'|全盘' as id,project_name name,'全盘' PARENT_ID  from SYS_PROJECT
    union all
    select proj_stage.PROJECT_ID||'|'||proj_stage.id  as Id
    ,proj_stage.STAGE_FULL_NAME as NAME
    ,proj_stage.PROJECT_ID||'|全盘' as PARENT_ID
    from SYS_PROJECT_STAGE PROJ_STAGE
    union all
    --业态顶级id：项目id|分期id|业态顶级id
    select proj_stage.PROJECT_ID||'|'||proj_stage.id||'|'||PRODUCT_TYPE.id as  id
    ,proj_stage.STAGE_FULL_NAME||'-'||PRODUCT_TYPE.PRODUCT_TYPE_NAME as name
    ,proj_stage.PROJECT_ID||'|'||proj_stage.id as parent_id 
    from  SYS_PROJECT_STAGE proj_stage cross join (select * from
    MDM_BUILD_PRODUCT_TYPE where product_type_level=1) PRODUCT_TYPE)  
    union all 
    select 项目id||'|'||分期id||'|'||顶级业态id||'|'||末级业态id as id
    ,末级业态全路径
    ,项目id||'|'||分期id||'|'||顶级业态id as parent_id
    ,0 as 套
    ,总可售面积 as 面积
    ,总货值 as 金额
    ,0 as 均价 from basedata 
    where 阶段类型=10)

     ,动态 as(
    --全盘:项目-分期-业态顶级-楼栋-末级业态
    select ID,NAME,PARENT_ID,20 as 套,0 as 面积,0 as 金额,0 as 均价  from (
    select id||'|动态' as id,project_name name,'动态' PARENT_ID  from SYS_PROJECT
    union all
    select proj_stage.PROJECT_ID||'|'||proj_stage.id||'|动态'  as Id
    ,proj_stage.STAGE_FULL_NAME as NAME
    ,proj_stage.PROJECT_ID||'|动态' as PARENT_ID
    from SYS_PROJECT_STAGE PROJ_STAGE
    union all
    --业态顶级id：项目id|分期id|业态顶级id
    select proj_stage.PROJECT_ID||'|'||proj_stage.id||'|'||PRODUCT_TYPE.id||'|动态' as  id
    ,proj_stage.STAGE_FULL_NAME||'-'||PRODUCT_TYPE.PRODUCT_TYPE_NAME as name
    ,proj_stage.PROJECT_ID||'|'||proj_stage.id||'|动态' as parent_id 
    from  SYS_PROJECT_STAGE proj_stage cross join (select * from
    MDM_BUILD_PRODUCT_TYPE where product_type_level=1) PRODUCT_TYPE)  
    --楼栋级：
    union all
    select 项目id||'|'||分期id||'|'||顶级业态id||'|'||楼栋id as id
    ,楼栋名称
    ,项目id||'|'||分期id||'|'||顶级业态id||'|动态' as parent_id
    ,0 as 套
    ,0 as 面积
    ,0 as 金额
    ,0 as 均价 from basedata 
    where 阶段类型=20 group by 楼栋id,项目id,分期id,顶级业态id,楼栋名称
    union all 
    select 项目id||'|'||分期id||'|'||顶级业态id||'|'||楼栋id||'|'||末级业态id as id
    ,末级业态全路径
    ,项目id||'|'||分期id||'|'||顶级业态id||'|'||楼栋id as parent_id
    ,0 as 套
    ,总可售面积 as 面积
    ,总货值 as 金额
    ,0 as 均价 from basedata 
    where 阶段类型=20)

   ,结果 as ( 
   select '可研' as id, '可研' as NAME,null PARENT_ID
    ,0 as 套,0 as 面积,0 as 金额,0 as 均价 from dual
    union all
   select '全盘' as id,'全盘' as NAME,null PARENT_ID
    ,0 as 套,0 as 面积,0 as 金额,0 as 均价 from dual
   union all
   select '动态' as id,'动态' as NAME,null PARENT_ID
    ,0 as 套,0 as 面积,0 as 金额,0 as 均价 from dual
   union all
   select ID,NAME,PARENT_ID,套,面积,金额,均价 from 可研
   union all
   select ID,NAME,PARENT_ID,套,面积,金额,均价 from 全盘
   union all 
   select  ID,NAME,PARENT_ID,套,面积,金额,均价 from 动态
   )

select ID,NAME,PARENT_ID,套,面积,金额
--,(select sum(面积) from 结果 m start with m.id=s.id connect by prior m.id=m.parent_id ) 面积
--,(select sum(金额) from 结果 start with id=s.id connect by prior id=parent_id  ) 金额
 from 结果 s ;

END P_DWM_云徙联合项目组;
/

prompt
prompt Creating procedure P_GET_COMPANY_TREE_PROJ_SPID
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_GET_COMPANY_TREE_PROJ_SPID" (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    data_auth_spid  OUT                VARCHAR2         
) AS
--获取有项目的公司树
--作者：谷国斌
--日期：2019/12/13
    rulevalue   VARCHAR2(50);
    authcount   INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    spid        VARCHAR2(36);--使用临时表的批次号
BEGIN
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;
--插入集团作为根节点
    INSERT INTO tmp_company_tree (id, org_id, org_name, org_type, parent_id, is_company, order_code)
        SELECT spid, id, org_name, org_type, parent_id, is_company, order_hierarchy_code
        FROM sys_business_unit
        WHERE id = '003200000000000000000000000000';
--获取隔离规则：

    SELECT isolation_rule_value INTO rulevalue
    FROM sys_data_auth_biz
    WHERE biz_obj_code = bizcode;

    IF rulevalue = '全集团' THEN
        INSERT INTO tmp_company_tree (id, org_id, org_name, org_type, parent_id, is_company, order_code)
            SELECT spid, id, org_name, org_type, parent_id, is_company, order_hierarchy_code
            FROM sys_business_unit
            WHERE is_company = 1;
    ELSE
--插入本公司及其父级
        INSERT INTO tmp_company_tree (id, org_id, org_name, org_type, parent_id, is_company, order_code)
            SELECT spid, id, org_name, org_type, parent_id, is_company, order_hierarchy_code
            FROM sys_business_unit
            WHERE is_company = 1
            START WITH id = companyid
            CONNECT BY PRIOR parent_id = id;

--插入数据授权的数据：
        DECLARE
            ownerid     VARCHAR2(36);
            oenertype   NVARCHAR2(50);
            CURSOR cursor_company IS
                SELECT DISTINCT auth_owner_id, auth_owner_type
                FROM sys_data_auth
                WHERE auth_biz_code = bizcode AND is_disabled = 0;
        BEGIN
            --打开游标
            OPEN cursor_company;
            LOOP
                FETCH cursor_company INTO ownerid, oenertype;
                EXIT WHEN cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                IF oenertype = '公司' OR oenertype = '集团' THEN
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司
                    SELECT COUNT(*) INTO authcount
                    FROM sys_business_unit
                    WHERE is_company = 1 AND id = companyid
                    START WITH id = ownerid
                    CONNECT BY PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (id, auth_owner_id, auth_owner_type)
                        VALUES (spid, ownerid, oenertype);
                    END IF;
                END IF;

                IF oenertype = '部门' THEN
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门
                    SELECT COUNT(*) INTO authcount
                    FROM sys_business_unit
                    WHERE is_company = 0 AND id = deptid
                    START WITH id = ownerid
                    CONNECT BY PRIOR id = parent_id;
                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (id, auth_owner_id, auth_owner_type)
                        VALUES (spid, ownerid, oenertype);
                    END IF;
                END IF;

                IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                    INSERT INTO tmp_auth_owner (id, auth_owner_id, auth_owner_type)
                        VALUES (spid,ownerid,oenertype);
                END IF;
            END LOOP;
            CLOSE cursor_company;
        END;
        --获取有权限的公司及其父级：
        DECLARE
            ownerid2 VARCHAR2(36);
            CURSOR cursor_auth IS SELECT auth_owner_id FROM tmp_auth_owner WHERE id = spid;
        BEGIN
        --打开游标
        OPEN cursor_auth;
        LOOP
        FETCH cursor_auth INTO ownerid2;
        EXIT WHEN cursor_auth%notfound;
        --授权对象为公司：
        --取授权公司的子级：
        INSERT INTO tmp_company_tree (id, org_id, org_name, org_type, parent_id, is_company, order_code )
            SELECT spid, id, org_name, org_type, parent_id, is_company, order_hierarchy_code
            FROM sys_business_unit
            WHERE is_company = 1
            START WITH id IN (
                SELECT DISTINCT auth_scope_id
                FROM sys_data_auth
                WHERE auth_biz_code = bizcode
                    AND is_disabled = 0
                    AND auth_owner_id = ownerid2
                    AND auth_scope_type IN ('公司',  '集团')
            ) CONNECT BY PRIOR id = parent_id;
        INSERT INTO tmp_company_tree ( id, org_id, org_name, org_type, parent_id, is_company, order_code)
            SELECT spid, id, org_name, org_type, parent_id, is_company, order_hierarchy_code
                FROM sys_business_unit
                WHERE is_company = 1
                START WITH id IN (
                    SELECT DISTINCT auth_scope_id
                    FROM sys_data_auth
                    WHERE auth_biz_code = bizcode
                        AND is_disabled = 0
                        AND auth_owner_id = ownerid2
                        AND auth_scope_type IN ( '公司', '集团')
                ) CONNECT BY PRIOR parent_id = id;

                   --授权对应为部门：
                   --取授权部门的父级：


            INSERT INTO tmp_company_tree ( id, org_id, org_name, org_type, parent_id, is_company, order_code)
                    SELECT spid, id, org_name, org_type, parent_id, is_company, order_hierarchy_code
                    FROM sys_business_unit
                    WHERE is_company = 1
                    START WITH id IN (
                        SELECT DISTINCT auth_scope_id
                        FROM sys_data_auth
                        WHERE auth_biz_code = bizcode
                            AND is_disabled = 0
                            AND auth_owner_id = ownerid2
                            AND auth_scope_type = '部门'
                    ) CONNECT BY PRIOR parent_id = id;
                   --授权对应为项目：

            INSERT INTO tmp_company_tree ( id, org_id, org_name, org_type, parent_id, is_company, order_code)
                SELECT spid, id, org_name,  org_type, parent_id, is_company, order_hierarchy_code
                FROM sys_business_unit
                WHERE is_company = 1
                START WITH id IN (
                    SELECT unit_id
                    FROM sys_project
                    WHERE id IN (
                        SELECT DISTINCT auth_scope_id
                        FROM sys_data_auth
                        WHERE auth_biz_code = bizcode
                            AND is_disabled = 0
                            AND auth_owner_id = ownerid2
                            AND auth_scope_type = '项目'
                    )
                ) CONNECT BY PRIOR parent_id = id;
            END LOOP;
            CLOSE cursor_auth;
        END;
    END IF;
--    OPEN data_auth_info FOR
--        SELECT DISTINCT
--            org_id       AS orgid,
--            org_name     AS orgname,
--            org_type     AS orgtype,
--            parent_id    AS parentid,
--            1 AS iscompany,
--            order_code   AS ordercode
--        FROM tmp_company_tree
--        WHERE id = spid
--            AND org_id IN (
--               SELECT DISTINCT id
--               FROM sys_business_unit
--               START WITH id IN (
--                   SELECT id
--                   FROM (
--                       SELECT unit_id AS id
--                       FROM sys_project
--                       UNION
--                       SELECT subordinate_company_id AS id
--                       FROM cdb_feasible_project_config
--                   ) ds
--               ) CONNECT BY PRIOR parent_id = id
--            ) ORDER BY order_code;

             data_auth_spid:=SPID;
END P_GET_COMPANY_TREE_PROJ_SPID;
/

prompt
prompt Creating procedure P_JUDGE_OBJ_MAINTAIN_CONDT
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_JUDGE_OBJ_MAINTAIN_Condt(
    phaseId   IN VARCHAR2,--阶段ID
    projectID IN VARCHAR2,--项目原始ID
    isSatisfied OUT INT --是否满足
)
as
BEGIN
    select COUNT(id) INTO isSatisfied FROM MDM_OBJ_PHASE_VERSION WHERE obj_id=''||projectID||''
                                                                   AND PHASE_STATE='10';
END P_JUDGE_OBJ_MAINTAIN_Condt;
/

prompt
prompt Creating procedure P_MDM_BLD_PERMIT
prompt ===================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_MDM_BLD_PERMIT(
    companyid     IN            VARCHAR2,--当前用户公司
    stationid     IN            VARCHAR2,---当前用户的岗位
    deptid        IN            VARCHAR2,---当前用户的部门
    bizcode       IN            VARCHAR2,---权限code
    userid        IN            VARCHAR2,---当前用户id
    projectids   IN            VARCHAR2,---项目名称
    searchparam   IN            VARCHAR2,--筛选条件
    selectCompanyId  IN           VARCHAR2,---当前选中的公司
    licenseType   IN            VARCHAR2, --证照类型
    info         OUT           SYS_REFCURSOR,
    pageindex     IN            INT,
    pagesizes     IN            INT,
    total         OUT           INT

) IS
    --证照办理一栏
--作者：鲜晓勇
--日期：2020/2/09
    v_sql_exec         CLOB;
    v_sql        CLOB;
    v_spid             VARCHAR2(200);---数据验证spid
    v_where            VARCHAR2(4000):=' and 1=1 ';
    v_search           VARCHAR2(4000):=' and 1=1 ';  ---搜素sql
    v_project          VARCHAR2(4000);
    v_auth_sql         VARCHAR2(4000) :=' where 1=1';
BEGIN
    BEGIN
        --执行数据权限存储过程。拿到零时表id 用户连临时表鉴权
        --调用查询数据权限的存储过程,返回spid
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => stationid,
            DEPTID => deptid,
            COMPANYID => companyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
            );
        if(selectCompanyId is not null and projectids is null)
        THEN
            v_where:=' AND MB.PROJ_ID IN(' ||
                     'select ID from sys_project WHERE UNIT_ID IN (' ||
                     'select ID from SYS_BUSINESS_UNIT sbu where IS_COMPANY = 1 ' ||
                     'start with sbu.id='''||selectCompanyId||'''' ||
                     'connect by prior sbu.ID = sbu.PARENT_ID)' ||
                     ')';
        END IF;
        if (projectids is not null) THEN
            FOR item IN (
                SELECT
                    regexp_substr('' || projectids || '', '[^,]+', 1, ROWNUM) AS id
                FROM dual
                CONNECT BY ROWNUM <= length('' || projectids || '')
                                         - length(regexp_replace('' || projectids || '', ',', '')) + 1
                ) LOOP v_project:=v_project||''''||item.id||''',';
                END LOOP;
            v_project:=substr(v_project,1,length(v_project) -1 );
            v_where:=' AND MB.PROJ_ID IN('||v_project||')';
        END if;

        if(searchParam is not null)THEN
            v_search:=' AND (MPAR.PARCEL_NAME like ''%'
                || searchparam
                || '%'' or MB.CON_PLAN_PERMIT_NO like ''%'
                || searchparam
                || '%'' or MB.CONSTRUCTION_PERMIT_NO like ''%'
                || searchparam
                || '%'' or MB.PRE_SALE_PERMIT_NO like ''%'
                || searchparam
                || '%'' or MB.GET_COMPLETED_PERMIT_NO like ''%'
                || searchparam
                || '%'')';
        END IF;
        v_sql := 'SELECT
            rownum as rowno,
            MB.ORDER_HIERARCHY_CODE AS "orderCode",
             MB.PROJ_ID AS "projectId", MP.PROJECT_NAME AS "projectName",
			 MPAR.PARCEL_NAME AS "parcelName", MB.PARCEL_ID AS "parcelId",
			 MB.PERIOD_ID AS "stageId", MB.PERIOD_NAME AS "stageName",
			 MB.ID AS "bldId", MB.BUILD_NAME AS "bldName",MB.BUILD_NAME AS "bldCode",
			 NULL AS "productFullName", NULL AS "managementType",
              to_char(MB.GET_CON_PLAN_PERMIT_DATE,''yyyy-MM-dd'') as "planPermitDate",
			 MB.CON_PLAN_PERMIT_ID AS "planPermitId",
			 MB.CON_PLAN_PERMIT_NO AS "planPermitNo",
              to_char(MB.GET_CONSTRCUTION_PERMIT_DATE,''yyyy-MM-dd'') as "constructionPermitDate",
			 MB.CONSTRACUTION_PERMIT_ID AS "constructionPermitId",
			 MB.CONSTRUCTION_PERMIT_NO AS "constructionPermitNo",
                 to_char(MB.GET_PRE_SALE_PERMIT_DATE,''yyyy-MM-dd'') as "preSalePermitDate",
			 MB.PRE_SALE_PERMIT_ID AS "perSalePermitId",
			 MB.PRE_SALE_PERMIT_NO AS "preSalePermitNo",
                 to_char(MB.GET_COMPLETED_PERMIT_DATE,''yyyy-MM-dd'') as "completedPermitDate",
			 MB.COMPLETED_PERMIT_ID AS "complatedPerimtId",
			 MB.GET_COMPLETED_PERMIT_NO AS "completedPermitNo"
            FROM   MDM_BUILD MB
            INNER  JOIN SYS_PROJECT MP
            ON     MB.PROJ_ID = MP.id
            INNER  JOIN SYS_PROJECT_STAGE MPER
            ON     MPER.ID = MB.PERIOD_ID
            INNER  JOIN (select distinct p.parcel_name,p.PARCEL_ORIGINAL_ID from mdm_project m1 inner join MDM_PARCEL  p on m1.id=p.project_id and m1.approval_status=''已审核'' )MPAR
            on mb.Parcel_id=MPAR.PARCEL_ORIGINAL_ID
            '||v_auth_sql||' and 1=1
             '||v_where||' '||v_search||'';

        if pagesizes != 0 and pageindex != 0 then
            v_sql_exec := 'select a.* from ( '
                || v_sql || ' AND rownum <= ' || pageindex * pagesizes
                || ' ) a where a.rowno > ' || pagesizes * ( pageindex - 1 )
                || ' order by a."projectName", a."orderCode" asc';
        else
            v_sql_exec := v_sql;
        end if;
        dbms_output.put_line(v_sql_exec);
        ----获取总条数
        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
            || v_sql
            || ') a '
            INTO total;
        OPEN info FOR v_sql_exec;
    END;
END P_MDM_BLD_PERMIT;
/

prompt
prompt Creating procedure P_SYS_BUILD_SYNCHRONIZATION
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_SYS_BUILD_SYNCHRONIZATION AS
--同步主数据数据--楼同步
--处理原因：除主数据维护外，其他地方使用项目表混乱。主数据维护外使用项目按设计，应计划统一调整使用 分期、楼栋sys_project,sys_project_stage,sys_build,sys_PARCEL
--作者：陈丽
--日期：2020-06-19
BEGIN------同步主数据项目
----删除楼栋;
DELETE sys_build;
INSERT INTO sys_build (id,build_name,period_id,parcel_id,proj_id,delivery_type,issue_time,is_get_con_plan_permit,con_plan_permit_date,con_plan_permit_no,is_get_constrcution_permit,constrcution_permit_date,construction_permit_no,is_get_pre_sale_permit,pre_sale_permit_date,pre_sale_permit_no,is_get_completed_permit,completed_permit_date,completed_permit_no) 
WITH build AS (
   SELECT id,build_name,period_id,parcel_id,proj_id,delivery_type,issue_time,is_get_con_plan_permit,get_con_plan_permit_date,con_plan_permit_no,is_get_constrcution_permit,get_constrcution_permit_date,construction_permit_no,is_get_pre_sale_permit,get_pre_sale_permit_date,pre_sale_permit_no,is_get_completed_permit,get_completed_permit_date,get_completed_permit_no FROM mdm_build WHERE BUILD_STATE=10
) 
SELECT*FROM build;
COMMIT;
END P_SYS_BUILD_SYNCHRONIZATION;
/

prompt
prompt Creating procedure P_MDM_BUILDING_RELEASE_CB
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_mdm_building_release_cb (
    id IN VARCHAR--楼栋表MDM_BUILD 主键id
) 
	--分期楼栋发布回调，1、创建动态货值相关版本数据//王传科实现 20191208
	--作者：陈丽
	--日期：2019/12/08	
 AS
  b_status   VARCHAR2(50);
  i_id varchar2(50):=id;
BEGIN
   BEGIN
    -- 查询是否是审批通过
        SELECT
            build_state 
            into b_status
        FROM
            mdm_build
        WHERE
            id = i_id;

        IF b_status = 10 THEN
            BEGIN
                P_SYS_BUILD_SYNCHRONIZATION();
                dbms_output.put_line('执行了同步');
            END;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            dbms_output.put_line('失败咯!'||sqlcode || sqlerrm);
    END;
END p_mdm_building_release_cb;
/

prompt
prompt Creating procedure P_MDM_BUILDLIST_TO_ROOM
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_mdm_buildlist_to_room (
    items OUT SYS_REFCURSOR
) IS
BEGIN
    ----因为当前数据库中的楼栋 在集团提供的查询房间的接口中无法查出房间,所以就使用了接口文档中提供的示例楼栋id用来测试
    OPEN items FOR SELECT
                       ID
                   FROM
                       mdm_build union select 'e7836cbbe38245cd9ebd0c2e91d4ff75' from dual;

END p_mdm_buildlist_to_room;
/

prompt
prompt Creating procedure P_MDM_COMPANY_PROJ_SITUATION
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_MDM_COMPANY_PROJ_SITUATION
(
    USERID    IN VARCHAR2
   ,STATIONID IN VARCHAR2
   ,DEPTID    IN VARCHAR2
   ,COMPANYID IN VARCHAR2
   ,BIZCODE   IN VARCHAR2
   ,WACTHINFO OUT SYS_REFCURSOR
) AS
    --公司主数据项目情况-主数据首页
    --作者：陈丽
    --日期：2019/11/13
    RULEVALUE VARCHAR2(50);
    AUTHCOUNT INT; --用于判断当前公司、部门是否与数据授权的主体有关系
    SPID      VARCHAR2(36); --使用临时表的批次号
BEGIN
    -- select get_uuid() into SPID from dual;
    -- --插入集团作为根节点
    -- insert into TMP_COMPANY_TREE(ID,ORG_ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE)
    -- select SPID,ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE FROM sys_business_unit where id='003200000000000000000000000000';
    --
    -- --获取隔离规则：
    -- select isolation_rule_value into RULEVALUE from SYS_DATA_AUTH_BIZ where biz_obj_code=BIZCODE;
    -- if RULEVALUE='全集团' then
    -- insert into TMP_COMPANY_TREE(ID,ORG_ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE)
    -- select SPID,ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE FROM sys_business_unit where is_company=1;
    --
    -- insert into TMP_COMPANY_TREE(ID,ORG_ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE)
    --                             select SPID,ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE FROM
    --                             sys_business_unit where is_company=1
    --                                 START WITH ID in (
    --                                 select unit_id from sys_project where id in (select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code='CDB002'
    --                                  and is_disabled=0  and auth_scope_type='项目')
    --                                 )  CONNECT BY PRIOR  parent_id=ID;
    -- else
    -- --插入本公司及其父级
    -- insert into TMP_COMPANY_TREE(ID,ORG_ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE)
    -- select SPID,ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE FROM
    --     sys_business_unit where is_company=1 START WITH ID=COMPANYID  CONNECT BY PRIOR  parent_id=ID;
    --
    -- --插入数据授权的数据：
    --
    --         DECLARE
    --                 OWNERID  VARCHAR2(36);
    --                 OENERTYPE NVARCHAR2(50);
    --                 CURSOR cursor_company IS
    --                 select distinct auth_owner_id,auth_owner_type from SYS_DATA_AUTH where auth_biz_code=BIZCODE and is_disabled=0;
    --
    --             BEGIN
    --
    --             --打开游标
    --                 OPEN cursor_company;
    --                 loop
    --                     fetch cursor_company into OWNERID,OENERTYPE;
    --                     exit when cursor_company%notfound;
    --
    --                 --过滤当前用户有权限的授权对象：
    --                 if OENERTYPE='公司' or OENERTYPE='集团'
    --                 then
    --                    --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司
    --                      SELECT count(*) into AUTHCOUNT FROM sys_business_unit where is_company=1 and id=COMPANYID
    --                     START WITH ID=OWNERID CONNECT BY PRIOR  ID=parent_id;
    --                     if AUTHCOUNT<>0
    --                     then
    --                         insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
    --                         values(SPID,OWNERID,OENERTYPE);
    --
    --                     end if;
    --
    --                 end if;
    --
    --                  if OENERTYPE='部门'
    --                 then
    --                    --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门
    --                      SELECT count(*) into AUTHCOUNT FROM sys_business_unit where is_company=0 and id=DEPTID
    --                     START WITH ID=OWNERID CONNECT BY PRIOR  ID=parent_id;
    --                     if AUTHCOUNT<>0
    --                     then
    --                         insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
    --                         values(SPID,OWNERID,OENERTYPE);
    --
    --                     end if;
    --
    --                 end if;
    --
    --                  if (OENERTYPE='岗位' and OWNERID=STATIONID) or (OENERTYPE='人员' and OWNERID=USERID)
    --                 then
    --
    --                        insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
    --                         values(SPID,OWNERID,OENERTYPE);
    --                 end if;
    --
    --                 end loop;
    --
    --                 close cursor_company;
    --
    --             END;
    --
    --           --获取有权限的公司及其父级：
    --                 DECLARE
    --                         OWNERID2  VARCHAR2(36);
    --                         CURSOR cursor_auth IS
    --                         select auth_owner_id from TMP_AUTH_OWNER where ID=SPID;
    --
    --                     BEGIN
    --
    --                     --打开游标
    --                         OPEN cursor_auth;
    --                         loop
    --                             fetch cursor_auth into OWNERID2;
    --                             exit when cursor_auth%notfound;
    --
    --
    --                             --授权对象为公司：
    --                             --取授权公司的子级：
    --                             insert into TMP_COMPANY_TREE(ID,ORG_ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE)
    --                             select SPID,ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE FROM
    --                             sys_business_unit where is_company=1
    --                                 START WITH ID in (
    --                                 select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE
    --                                  and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type in ('公司','集团')
    --                                 )  CONNECT BY PRIOR  ID=parent_id;
    --
    --
    --                             --取授权公司的父级：
    --                             insert into TMP_COMPANY_TREE(ID,ORG_ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE)
    --                             select SPID,ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE FROM
    --                             sys_business_unit where is_company=1
    --                                 START WITH ID in (
    --                                 select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE
    --                                  and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type in ('公司','集团')
    --                                 )  CONNECT BY PRIOR  parent_id=ID;
    --
    --                              --授权对应为部门：
    --                                --取授权部门的父级：
    --
    --                                  insert into TMP_COMPANY_TREE(ID,ORG_ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE)
    --                             select SPID,ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE FROM
    --                             sys_business_unit where is_company=1
    --                                 START WITH ID in  (select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE
    --                                  and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type='部门'
    --                                 )  CONNECT BY PRIOR  parent_id=ID;
    --                                --授权对应为项目：
    --
    --                             insert into TMP_COMPANY_TREE(ID,ORG_ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE)
    --                             select SPID,ID,ORG_NAME,ORG_TYPE,PARENT_ID,IS_COMPANY,ORDER_CODE FROM
    --                             sys_business_unit where is_company=1
    --                                 START WITH ID in (
    --                                 select unit_id from sys_project where id in (select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE
    --                                  and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type='项目')
    --                                 )  CONNECT BY PRIOR  parent_id=ID;
    --
    --                               end loop;
    --                            close  cursor_auth;
    --                         end;
    --
    --
    --     end if;

    --  SELECT
    --  A.orgId AS id,
    --  A.parentId AS parentsId,
    --  A.orgName AS orgName,
    --  CASE
    --  WHEN A.orgType = 10 THEN
    --    1
    --  ELSE
    --    0
    -- END projTotal,
    --  CASE
    --  WHEN B.PROJ_ID IS NOT NULL THEN
    --    B.TARGET_WORTH
    --  ELSE
    --    0
    -- END dynamicWorth,
    -- '0' AS reserveWorth,
    -- '0' AS wayWorth,
    -- '0' AS inventoryWorth,
    -- '/dwm/value-manage/dynamic-value/value-monitor' AS jumpUrl FROM
    -- (select distinct ORG_ID as orgId,org_name as orgName,org_type as orgType,parent_id as parentId,1 as isCompany,order_code as orderCode
    -- from TMP_COMPANY_TREE WHERE ID=SPID AND
    -- ORG_ID in(
    --                     SELECT distinct id FROM sys_business_unit START WITH ID in (select id from (
    --                     select unit_id as id from sys_project
    --                     union
    --                     SELECT SUBORDINATE_COMPANY_ID as id FROM CDB_FEASIBLE_PROJECT_CONFIG
    --                     ) ds) CONNECT BY PRIOR parent_id = ID))A
    --  LEFT JOIN (
    -- SELECT T1.PROJ_ID,T1.PROJ_NAME,
    -- CASE WHEN T2.PROJ_ID IS NOT NULL
    -- THEN T2.TARGET_WORTH
    --  ELSE
    --    T1.TARGET_WORTH
    -- END TARGET_WORTH FROM
    -- (SELECT D.PROJ_ID,D.PROJ_NAME,D.TARGET_WORTH,MAX(D.APPROVAL_TIME)
    -- FROM DWM_TARGET_WORTH D
    --  WHERE D.IS_DELETE = 0 AND D.APPROVAL_STATUS = '已审核'
    --  GROUP BY D.PROJ_ID,D.PROJ_NAME,D.TARGET_WORTH) T1
    --  LEFT JOIN
    --  (
    --  SELECT D.PROJ_ID,D.PROJ_NAME,D.TARGET_WORTH,MAX(D.APPROVAL_TIME)
    -- FROM DWM_TARGET_WORTH D
    --  WHERE D.IS_DELETE = 0 AND D.APPROVAL_STATUS = '已审核' AND D.TARGET_WORTH_PHASE = 20
    --  GROUP BY D.PROJ_ID,D.PROJ_NAME,D.TARGET_WORTH
    --  )T2 ON T1.PROJ_ID = T2.PROJ_ID)B ON A.orgId = B.PROJ_ID;
    --
    --
    OPEN WACTHINFO FOR
        SELECT A.ORGID AS ID,
                --组织id
               A.ORGNAME || 'tt' AS ORGNAME,
                --组织名称名称
               LOWER(A.PARENTID) AS PARENTSID,
                --父级id

               CASE
                   WHEN A.ORGTYPE = 1 THEN
                    1
                   ELSE
                    0
               END PROJTOTAL,
               CASE
                   WHEN X.PROJ_ID IS NOT NULL AND NVL(X.TARGET_WORTH, 0) > 0 THEN
                    X.TARGET_WORTH
                   WHEN Y.PROJ_ID IS NOT NULL AND NVL(Y.TARGET_WORTH, 0) > 0 THEN
                    Y.TARGET_WORTH
                   WHEN Z.PROJ_ID IS NOT NULL AND NVL(Z.TARGET_WORTH, 0) > 0 THEN
                    Z.TARGET_WORTH
                   ELSE
                    0
               END NEWESTWORTH, '0' AS DYNAMICWORTH, '0' AS RESERVEWORTH,
               '0' AS INTRANSITWORTH, '0' AS INVENTORYWORTH,
               '0' AS EXPLAINATION,
               '/dwm/value-manage/dynamic-value/value-monitor' AS JUMPURL

        FROM   (SELECT ORDER_CODE,
                         --用于树形的排序
                        T.PROJECT_ORIGINAL_ID ORGID,
                         --组织id
                        T.PROJECT_NAME AS ORGNAME,
                         --组织名称名称

                        T.ORG_TYPE AS ORGTYPE,
                         --组织类型 0公司，1项目
                        LOWER(T.PARENT_ID) AS PARENTID --父级id

                 FROM   (SELECT MDM_PROJECT.PROJECT_ORIGINAL_ID,
                                 ORG.PARENT_ID || '-' ||
                                  SUBSTR('000' || ORG.ORDER_CODE, -3) ||
                                  ORG.ORDER_CODE AS ORDER_CODE,
                                  --用于树形的排序
                                 PROJECT_NAME,
                                 MDM_PHASE.PHASE_NAME AS PROJ_PHASE,
                                 PHASE.PHASE_ID, PHASE.ID AS PROJ_PHASE_ID,
                                 10 AS ORG_TYPE,
                                 CASE
                                     WHEN PHASE.PHASE_ID IS NULL THEN
                                      0
                                     ELSE
                                      1
                                 END AS IS_EXIST_PROJ_PHASE,
                                 MDM_PROJECT.COMPANY_ID AS PARENT_ID,
                                 MDM_OBJ_PHASE_INDEX.TOTAL_SITE_AREA,
                                 MDM_OBJ_PHASE_INDEX.OVERALL_FLOORAGE_AREA,
                                 MDM_OBJ_PHASE_INDEX.TOTAL_SALE_AREA,
                                 MDM_OBJ_PHASE_INDEX.TOTAL_CAPACITY_AREA
                          FROM   MDM_PROJECT
                          LEFT   JOIN (SELECT T1.ID, T1.PHASE_ID, T1.PROJ_ID,
                                             T2.PHASE_ORDER
                                      FROM   MDM_PROJECT_PHASE T1
                                      LEFT   JOIN (SELECT PROJ_ID,
                                                         MAX(PHASE_ORDER) AS PHASE_ORDER
                                                  FROM   MDM_PROJECT_PHASE
                                                  GROUP  BY PROJ_ID) T2
                                      ON     T1.PROJ_ID = T2.PROJ_ID AND
                                             T1.PHASE_ORDER = T2.PHASE_ORDER
                                      WHERE  T2.PHASE_ORDER IS NOT NULL) PHASE
                          ON     MDM_PROJECT.PROJECT_ORIGINAL_ID =
                                 PHASE.PROJ_ID
                          LEFT   JOIN MDM_PHASE
                          ON     PHASE.PHASE_ID = MDM_PHASE.ID
                          LEFT   JOIN MDM_OBJ_PHASE_INDEX
                          ON     PHASE.ID = MDM_OBJ_PHASE_INDEX.OBJ_PHASE_ID AND
                                 MDM_OBJ_PHASE_INDEX.OBJ_TYPE = 0
                          LEFT   JOIN SYS_BUSINESS_UNIT ORG
                          ON     MDM_PROJECT.COMPANY_ID = ORG.ID
                          WHERE  APPROVAL_STATUS = '已审核'
                          UNION ALL
                          SELECT ID,
                                 PARENT_ID || '-' ||
                                  SUBSTR('000' || ORDER_CODE, -3) AS ORDER_CODE,
                                  --用于树形的排序
                                 ORG_NAME, '' AS PROJ_PHASE, '' AS PHASE_ID,
                                 '' AS PROJ_PHASE_ID, 0 ORG_TYPE,
                                 NULL IS_EXIST_PROJ_PHASE, PARENT_ID,
                                 0 AS "totalSiteArea",
                                 0 AS "overallFloorageArea",
                                 0 AS "totalSalableArea",
                                 0 AS "totalCapacityArea"
                          FROM   SYS_BUSINESS_UNIT
                          WHERE  ORG_TYPE = 0 AND
                                 (ID != '000100000000000000000000000000' AND
                                 ID != '000200000000000000000000000000')) T) A
        LEFT   JOIN (SELECT A.PROJ_ID, A.TARGET_WORTH
                     FROM   DWM_TARGET_WORTH A
                     RIGHT  JOIN (SELECT D.PROJ_ID, D.TARGET_WORTH_PHASE,
                                        MAX(WORTH_V) AS WORTH_V
                                 FROM   DWM_TARGET_WORTH D
                                 WHERE  D.IS_DELETE = 0 AND
                                        D.APPROVAL_STATUS IN ('已审核', '审核中') AND
                                        D.TARGET_WORTH_PHASE = 20
                                 GROUP  BY D.PROJ_ID, D.TARGET_WORTH_PHASE) A1
                     ON     A.PROJ_ID = A1.PROJ_ID AND
                            A.WORTH_V = A1.WORTH_V AND
                            A.TARGET_WORTH_PHASE = A1.TARGET_WORTH_PHASE) X
        ON     A.ORGID = X.PROJ_ID
        LEFT   JOIN (SELECT B.PROJ_ID, B.TARGET_WORTH
                     FROM   DWM_TARGET_WORTH B
                     RIGHT  JOIN (SELECT D.ID, D.PROJ_ID, MAX(APPROVAL_TIME)
                                 FROM   DWM_TARGET_WORTH D
                                 WHERE  D.IS_DELETE = 0 AND
                                        D.APPROVAL_STATUS IN ('已审核', '审核中') AND
                                        D.TARGET_WORTH_PHASE = 10
                                 GROUP  BY D.ID, D.PROJ_ID) B1
                     ON     B.ID = B1.ID) Y
        ON     A.ORGID = Y.PROJ_ID
        LEFT   JOIN (SELECT C.PROJ_ID, C.TARGET_WORTH
                     FROM   DWM_TARGET_WORTH C
                     RIGHT  JOIN (SELECT ID, D.PROJ_ID, MAX(APPROVAL_TIME)
                                 FROM   DWM_TARGET_WORTH D
                                 WHERE  D.IS_DELETE = 0 AND
                                        D.APPROVAL_STATUS IN ('已审核', '审核中') AND
                                        D.TARGET_WORTH_PHASE = 0
                                 GROUP  BY D.ID, D.PROJ_ID) C1
                     ON     C.ID = C1.ID) Z
        ON     A.ORGID = Z.PROJ_ID
        WHERE  ROWNUM = 1
        ORDER  BY ORDER_CODE;

END P_MDM_COMPANY_PROJ_SITUATION;
/

prompt
prompt Creating procedure P_MDM_DELETE_DATA_MAINTAIN
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_MDM_DELETE_DATA_MAINTAIN (
    objPhaseVersionId  IN VARCHAR2, --项目id
    msg     OUT  VARCHAR2--消息
)
as
    v_obj_version  varchar2(50):='';
    v_projectId   varchar2(50):='';
    v_phaseId     varchar2(50):='';
    v_error_count  INT :=0;
BEGIN
    -- 查询项目id
    select COUNT(id) INTO v_error_count FROM MDM_OBJ_PHASE_VERSION WHERE
            id = objPhaseVersionId and (PHASE_STATE=19 or PHASE_STATE=20);
    IF v_error_count > 0 THEN
        msg:='审核中或已审核的数据不允许删除，若需要删除请先作废流程';
        return;
    END IF;

    --查询版本
    select OBJ_PHASE_VERSION,obj_id,phase_id into v_obj_version,v_projectId,v_phaseId
    from MDM_OBJ_PHASE_VERSION where id=objPhaseVersionId;

    --删除面积指标表
    delete from MDM_OBJ_PHASE_AL_V where OBJ_PHASE_PT_INDEX_ID in (
        with t1 as (
            SELECT ID from MDM_PROJECT_PHASE
            where PROJ_ID = v_projectId
              and PHASE_ID = v_phaseId
            union
            select mpp1.ID
            from MDM_PERIOD_PHASE mpp1
                     left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                     left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
            where mpv.PROJECT_ID = v_projectId
              and PHASE_ID = v_phaseId
              and APPROVAL_STATUS='已审核'
            union
            select mpp1.ID
            from MDM_PARCEL_PHASE mpp1
                     left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
            where mp1.PROJECT_ORIGINAL_ID = v_projectId
              and PHASE_ID = v_phaseId
            union
            select mbp1.ID
            from MDM_BUILD_PHASE mbp1
                     left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
            where mb1.PROJ_ID = v_projectId
              and PHASE_ID = v_phaseId
        ) select mopvpi.ID
        from t1
                 left join MDM_OBJ_PHASE_VERSION mopv on OBJ_PHASE_ID = t1.ID
                 left join MDM_OBJ_PHASE_VERSION_PT_INDEX mopvpi on mopvpi.OBJ_PHASE_ID = mopv.ID
        where mopv.PHASE_ID = v_phaseId and mopv.OBJ_PHASE_VERSION=v_obj_version
    );


    --删除业态信息表
    delete from MDM_OBJ_PHASE_VERSION_PT_INDEX where OBJ_PHASE_VERSION_ID in (
        with t1 as (
            SELECT ID from MDM_PROJECT_PHASE
            where PROJ_ID = v_projectId
              and PHASE_ID = v_phaseId
            union
            select mpp1.ID
            from MDM_PERIOD_PHASE mpp1
                     left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                     left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
            where mpv.PROJECT_ID = v_projectId
              and PHASE_ID = v_phaseId
              and APPROVAL_STATUS='已审核'
            union
            select mpp1.ID
            from MDM_PARCEL_PHASE mpp1
                     left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
            where mp1.PROJECT_ORIGINAL_ID = v_projectId
              and PHASE_ID = v_phaseId
            union
            select mbp1.ID
            from MDM_BUILD_PHASE mbp1
                     left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
            where mb1.PROJ_ID = v_projectId
              and PHASE_ID = v_phaseId
        ) select mopv.ID from t1
                                  left join MDM_OBJ_PHASE_VERSION mopv on OBJ_PHASE_ID = t1.ID
        where mopv.PHASE_ID = v_phaseId and mopv.OBJ_PHASE_VERSION=v_obj_version
    );

    --删除指标表
    delete from MDM_OBJ_PHASE_VERSION_INDEX where OBJ_PHASE_VERSION_ID in (
        with t1 as (
            SELECT ID from MDM_PROJECT_PHASE
            where PROJ_ID = v_projectId
              and PHASE_ID = v_phaseId
            union
            select mpp1.ID
            from MDM_PERIOD_PHASE mpp1
                     left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                     left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
            where mpv.PROJECT_ID = v_projectId
              and PHASE_ID = v_phaseId
              and APPROVAL_STATUS='已审核'
            union
            select mpp1.ID
            from MDM_PARCEL_PHASE mpp1
                     left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
            where mp1.PROJECT_ORIGINAL_ID = v_projectId
              and PHASE_ID = v_phaseId
            union
            select mbp1.ID
            from MDM_BUILD_PHASE mbp1
                     left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
            where mb1.PROJ_ID = v_projectId
              and PHASE_ID = v_phaseId
        ) select mopv.ID from t1
                                  left join MDM_OBJ_PHASE_VERSION mopv on OBJ_PHASE_ID = t1.ID
        where mopv.PHASE_ID = v_phaseId and mopv.OBJ_PHASE_VERSION=v_obj_version
    );

    --删除阶段版本表
    delete from MDM_OBJ_PHASE_VERSION mopv where mopv.OBJ_PHASE_VERSION=v_obj_version and OBJ_PHASE_ID in (
        SELECT ID from MDM_PROJECT_PHASE
        where PROJ_ID = v_projectId
          and PHASE_ID = v_phaseId
        union
        select mpp1.ID
        from MDM_PERIOD_PHASE mpp1
                 left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                 left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
        where mpv.PROJECT_ID = v_projectId
          and PHASE_ID = v_phaseId
          and APPROVAL_STATUS='已审核'
        union
        select mpp1.ID
        from MDM_PARCEL_PHASE mpp1
                 left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
        where mp1.PROJECT_ORIGINAL_ID = v_projectId
          and PHASE_ID = v_phaseId
        union
        select mbp1.ID
        from MDM_BUILD_PHASE mbp1
                 left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
        where mb1.PROJ_ID = v_projectId
          and PHASE_ID = v_phaseId
    );

    msg:='删除成功';
END P_MDM_DELETE_DATA_MAINTAIN;
/

prompt
prompt Creating procedure P_MDM_GET_BLD_DATA_BY_PLATFORM
prompt =================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_MDM_GET_BLD_DATA_BY_PLATFORM(
    PROJ_PERIOD_ID IN NVARCHAR2 --分期ID
                                                          ,PERMIT_TYPE    IN NVARCHAR2 --证照类型
                                                          ,BLD_ID_TABLE   OUT SYS_REFCURSOR --返回值
) AS
BEGIN
    OPEN BLD_ID_TABLE FOR
        SELECT A.ID AS "bldId", A.BUILD_NAME AS "bldName", NULL AS "bldCode", A.PERIOD_NAME AS "projectName",
            SUBSTR(D.PRODUCT_TYPE_NAME, 1, INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 1) - 1) AS "firstProductName",
            SUBSTR(D.PRODUCT_TYPE_NAME, INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 1) + 1,
                   INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 2) - INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 1) - 1) AS "secondProductName",
            SUBSTR(D.PRODUCT_TYPE_NAME, DECODE(INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 2), 0, 100,
                                               INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 2)) + 1) AS "thirdProductName",
            D.PRODUCT_TYPE_NAME AS "productFullName", D.PRODUCT_TYPE_ID AS "productId",
            case when(
                         case when PERMIT_TYPE='规划许可证'
                                  then a.IS_GET_CON_PLAN_PERMIT
                              when PERMIT_TYPE='施工许可证'
                                  then a.IS_GET_CONSTRCUTION_PERMIT
                              when PERMIT_TYPE='竣工备案证'
                                  then a.IS_GET_COMPLETED_PERMIT
                              when PERMIT_TYPE='预售许可证'
                                  then a.IS_GET_PRE_SALE_PERMIT
                              else
                                  '' end
                         )='1' then '是' else '否' end  AS "isGetSalePermit", D.BUILD_AREA AS "bldArea",
            D.GROUND_TOTAL_BUILD_AREA AS "bldAreaOn", D.UNDERGROUND_TOTAL_BUILD_AREA AS "bldAreaUnder",
            D.TOTAL_SALE_AREA AS "saleArea", D.GROUND_SALE_AREA AS "saleAreaOn",
            D.UNDERGROUND_SALE_AREA AS "saleAreaUnder", E.PRE_SALE_BLD_AREA AS "preSaleBldArea",
            E.PRE_SALE_BLD_AREA_ON AS "preSaleBldAreaOn", E.PRE_SALE_BLD_AREA_UNDER AS "preSaleBldAreaUbder",
            E.PRE_SALE_IN_AREA AS "preSaleInArea", E.PRE_SALE_IN_AREA_ON AS "preSaleInAreaOn",
            E.PRE_SALE_IN_AREA_UNDER AS "preSaleInAreaUnder", E.ACTUAL_SALE_BLD_AREA AS "actualSaleBldArea",
            E.ACTUAL_SALE_BLD_AREA_ON AS "actualSaleBldAreaOn",
            E.ACTUAL_SALE_BLD_AREA_UNDER AS "actualSaleBldAreaUnber", a.IS_GET_CON_PLAN_PERMIT,
            a.IS_GET_CONSTRCUTION_PERMIT,a.IS_GET_PRE_SALE_PERMIT,a.IS_GET_COMPLETED_PERMIT
        FROM MDM_BUILD A
             left join (
            select * from (
                select mb.*, MAX(phase_order) over (partition by mb.BUILD_ID) max from MDM_BUILD_PHASE mb
            ) where PHASE_ORDER = max
        ) B on B.BUILD_ID = A.ID
             left join MDM_OBJ_PHASE_INDEX C ON C.OBJ_PHASE_ID = B.ID
             LEFT JOIN (
            SELECT B1.PRODUCT_TYPE_CODE, A1.*
            FROM MDM_OBJ_PHASE_PT_INDEX A1
                 INNER JOIN MDM_BUILD_PRODUCT_TYPE B1 ON A1.PRODUCT_TYPE_ID = B1.ID
        ) D ON D.OBJ_PHASE_ID = B.ID
             LEFT JOIN(
            SELECT A2.BUILDING_ID, A2.BUILDING_NAME, A2.PRODUCT_CODE, SUM(A2.PRE_BLD_AREA) AS PRE_SALE_BLD_AREA,
                SUM(CASE WHEN PRODUCT_IS_CW = 0 THEN A2.PRE_BLD_AREA ELSE 0 END) AS PRE_SALE_BLD_AREA_ON,
                SUM(CASE WHEN PRODUCT_IS_CW = 1 THEN A2.PRE_BLD_AREA ELSE 0 END) AS PRE_SALE_BLD_AREA_UNDER,
                SUM(A2.PRE_IN_AREA) AS PRE_SALE_IN_AREA,  SUM(A2.ACTUAL_BLD_AREA) AS ACTUAL_SALE_BLD_AREA,
                SUM(CASE WHEN PRODUCT_IS_CW = 0 THEN A2.PRE_IN_AREA ELSE 0 END) AS PRE_SALE_IN_AREA_ON,
                SUM(CASE WHEN A2.PRODUCT_IS_CW = 1 THEN A2.PRE_IN_AREA ELSE 0 END) AS PRE_SALE_IN_AREA_UNDER,
                SUM(CASE WHEN A2.PRODUCT_IS_CW = 0 THEN A2.ACTUAL_BLD_AREA ELSE 0 END) AS ACTUAL_SALE_BLD_AREA_ON,
                SUM(CASE WHEN A2.PRODUCT_IS_CW = 1 THEN A2.ACTUAL_BLD_AREA ELSE 0 END) AS ACTUAL_SALE_BLD_AREA_UNDER
            FROM MDM_ROOM A2
            GROUP BY A2.BUILDING_ID, A2.BUILDING_NAME, A2.PRODUCT_CODE
        ) E ON E.BUILDING_ID = A.ID AND E.PRODUCT_CODE = D.PRODUCT_TYPE_CODE
             LEFT JOIN (
            SELECT B3.BUILD_ID, B3.ID AS OBJ_PHASE_ID, A3.BUILD_AREA, A3.GROUND_TOTAL_BUILD_AREA, A3.UNDERGROUND_TOTAL_BUILD_AREA
            FROM MDM_OBJ_PHASE_PT_INDEX A3
                 INNER JOIN MDM_BUILD_PHASE B3 ON A3.OBJ_PHASE_ID = B3.ID AND B3.PHASE_NAME = '竣工备案证阶段'
        ) F ON F.BUILD_ID = A.ID AND F.OBJ_PHASE_ID = B.ID
        WHERE EXISTS (
                  SELECT 1 FROM (
                      SELECT ROW_NUMBER() OVER(PARTITION BY A.ID ORDER BY C.PHASE_ORDER DESC) AS PRANK,
                          A.ID BUILDID, C.PHASE_ORDER PHASEORDER, C.PHASE_NAME PHASENAME, C.ID PHASEID
                      FROM MDM_BUILD A
                           INNER JOIN MDM_BUILD_PHASE B ON A.ID = B.BUILD_ID
                           INNER JOIN MDM_PHASE C ON B.PHASE_ID = C.ID
                  ) P WHERE P.PRANK = 1 AND P.PHASEID = B.PHASE_ID AND P.BUILDID = A.ID
                  ) AND A.BUILD_STATE = 10 AND A.PERIOD_ID = '' || PROJ_PERIOD_ID || '' OR A.PROJ_ID = '' || PROJ_PERIOD_ID || ''
        ORDER  BY BUILD_NAME;
END;
/

prompt
prompt Creating procedure P_MDM_GET_BUILDS_BY_PROJECT
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_MDM_GET_BUILDS_BY_PROJECT
(
    PROJECTID IN VARCHAR2
   ,ITEMS     OUT SYS_REFCURSOR
) IS
    --从销售系统抓取房间数据 创建根据项目ID获取楼栋数据存储过程
    --作者：鲜晓勇
    --日期：2020/01/13
BEGIN
OPEN ITEMS FOR
WITH  builds as(select id from(
                                --------------------小写
                             SELECT nvl(lower(Translate(r_build_id USING CHAR_CS)),'kong') as id FROM MDM_BUILD where r_build_id is not null 
                                /*union all
                                SELECT lower(Translate(id USING CHAR_CS)) as id FROM MDM_BUILD
                                union all
                                ----------------------大写
                                SELECT Translate(r_build_id USING CHAR_CS) as id FROM MDM_BUILD
                                union all
                                SELECT Translate(id USING CHAR_CS) as id FROM MDM_BUILD*/
                                
             
                                )group by id order by id)
,base as (select* from (select id,rownum rowsn  from builds)),

第一批次 AS (
select id from base where rowsn<=1000

    )
,第二批次 as (
select id from base  where rowsn>1000 and rowsn<=2000
    )
,第三批次 as (
select id from base where rowsn>2000 and rowsn<=3000
     )
,第四批次 as (
select id from base where rowsn>3000 and rowsn<=4000
    )
,第五批次 as (
select id from base  where rowsn>4000 and rowsn<=5000
    )

select id as id from (
select * from 第一批次 where 1=1
union all
select * from 第二批次 where 1=1
union all
select * from 第三批次 where 1=1
union all
select * from 第四批次 where 1=1
union all
select * from 第五批次 where 1=1
)
;

    --select '3c9f8ee72ab84ba9be19b7ea92e49e8f' as "id" from dual;
END P_MDM_GET_BUILDS_BY_PROJECT;
/

prompt
prompt Creating procedure P_MDM_GET_INVOLVE_PERMIT
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_MDM_GET_INVOLVE_PERMIT" (
   permitType  IN NVARCHAR2 --证照类型
   ,planNodeId  IN NVARCHAR2 ---节点id
   ,items        OUT          SYS_REFCURSOR --返回值
) AS
BEGIN
    OPEN items FOR  select mp.id as "id" 
           from mdm_permit mp
           inner join(select ci.* from (select nf.*,n.id as nodeId,n.fission_source_original_id
               from POM_NODE_FEEDBACK nf
               inner join (select id, fission_source_original_id
                   from pom_proj_plan_node a
                   start with a.id = ''||planNodeId||''
                   CONNECT BY PRIOR a.fission_source_original_id = a.id
               ) n on nf.FEEDBACK_NODE_ID = n.id and n.id is not null and nf.APPROVAL_STATUS='已审核')s left join POM_CURRENT_EVIDENCE_INFO ci on ci.feedback_id=s.id
           ) f on mp.id = f.PERMIT_ID where mp.PERMIT_TYPE=''||permitType||'';
END;
/

prompt
prompt Creating procedure P_MDM_GET_PEMIT_BY_PROJECT
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_mdm_get_pemit_by_project (
    PROJECT_ID    IN           NVARCHAR2 , --项目or 分期id
    PERMIT_TYPE  IN NVARCHAR2 ,--证照类型
    items        OUT          SYS_REFCURSOR --返回值
) AS
    v_sql_exec         CLOB;
BEGIN
    v_sql_exec:='SELECT
                           id                AS "id",
                           permit_no         AS "permitNo",
                          to_char(permit_get_date,''yyyy-MM-dd'') as "permitGetDate",
                          to_char(created,''yyyy-MM-dd'') as "created",
                           creator           AS "creator",
                           bld_scope         AS "bldScope",
                           project_id        AS "projectId",
                           SALE_AREA         as "saleArea",
                           BLD_AREA          as   "bldArea",
                          APPROVAL_STATUS    as "approvalStatus"
                       FROM
                           mdm_permit
                       WHERE
                           1=1 AND permit_type='''||PERMIT_TYPE||'''';
	 IF ( PROJECT_ID IS NOT NULL ) THEN
    v_sql_exec:=v_sql_exec||'AND ( project_id = '''|| PROJECT_ID||'''
                                 OR stage_id = '''
                                               || PROJECT_ID
                                               || ''' ) ORDER BY created DESC';

    ELSE
        v_sql_exec:=v_sql_exec||'AND project_id = ''11111111111111111111''';
    END IF;
     dbms_output.put_line(v_sql_exec);
    OPEN items FOR v_sql_exec;
END;
/

prompt
prompt Creating procedure P_MDM_GET_PERMIT_BLD_REF_DATA
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_MDM_GET_PERMIT_BLD_REF_DATA
(
    PROJ_PERIOD_ID      IN NVARCHAR2  --分期ID
   ,PERMIT_TYPE  IN NVARCHAR2 --证照类型
   ,BLD_ID_TABLE OUT SYS_REFCURSOR --返回值
) AS

BEGIN
    /*    OPEN BLD_ID_TABLE FOR
    SELECT '75948F49-61C3-E711-AC26-000C293C2531' AS BLD_ID
         , '一号楼' AS BLD_NAME, 'Q1.001' AS BLD_CODE, '一期' AS PROJECT_NAME
         , '住宅' AS FIRST_PRODUCT_NAME, '商品住宅' AS SECOND_PRODUCT_NAME
         , '高层I' AS THIRD_PRODUCT_NAME
         , '住宅-商品住宅-高层I' AS PRODUCT_FULL_NAME
         , GET_UUID( ) AS PRODUCT_ID, '否' AS IS_GET_SALE_PERMIT
         , 100.00 AS BLD_AREA, 90.00 AS BLD_AREA_ON, 10.00 AS BLD_AREA_UNDER
         , 90.00 AS SALE_AREA, 90.00 AS SALE_AREA_ON, 0.00 AS SALE_AREA_UNDER
         , 90.00 AS PRE_SALE_BLD_AREA, 90.00 AS PRE_SALE_BLD_AREA_ON
         , 0.00 AS PRE_SALE_BLD_AREA_UBDER, 79.00 AS PRE_SALE_IN_AREA
         , 79.00 AS PRE_SALE_IN_AREA_ON, 0.00 AS PRE_SALE_IN_AREA_UNDER
         , NULL AS ACTUAL_SALE_BLD_AREA, NULL AS ACTUAL_SALE_BLD_AREA_ON
         , NULL AS ACTUAL_SALE_BLD_AREA_UNBER, NULL AS ACTUAL_BLD_AREA
         , NULL AS ACTUAL_BLD_AREA_ON, NULL AS ACTUAL_BLD_AREA_UNDER
         , 10 AS BLD_ROOM_TOTAL, 10 AS CHOOSED_ROOM_TOTAL
      FROM DUAL;*/
    OPEN BLD_ID_TABLE FOR
        SELECT A.ID AS BLD_ID, A.BUILD_NAME AS BLD_NAME, NULL AS BLD_CODE,
               A.PERIOD_NAME AS PROJECT_NAME,
               SUBSTR(D.PRODUCT_TYPE_NAME, 1,
                       INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 1) - 1) AS FIRST_PRODUCT_NAME,
               SUBSTR(D.PRODUCT_TYPE_NAME,
                       INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 1) + 1,
                       INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 2) -
                        INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 1) - 1) AS SECOND_PRODUCT_NAME,
               SUBSTR(D.PRODUCT_TYPE_NAME,
                       DECODE(INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 2), 0, 100,
                               INSTR(D.PRODUCT_TYPE_NAME, '/', 1, 2)) + 1) AS THIRD_PRODUCT_NAME,
               D.PRODUCT_TYPE_NAME AS PRODUCT_FULL_NAME,
               D.PRODUCT_TYPE_ID AS PRODUCT_ID, '否' AS IS_GET_SALE_NAME,
               D.BUILD_AREA AS BLD_AREA,
               D.GROUND_TOTAL_BUILD_AREA AS BLD_AREA_ON,
               D.UNDERGROUND_TOTAL_BUILD_AREA AS BLD_AREA_UNDER,
               D.TOTAL_SALE_AREA AS SALE_AREA,
               D.GROUND_SALE_AREA AS SALE_AREA_ON,
               D.UNDERGROUND_SALE_AREA AS SALE_AREA_UNDER,
               E.PRE_SALE_BLD_AREA, E.PRE_SALE_BLD_AREA_ON,
               E.PRE_SALE_BLD_AREA_UNDER, E.PRE_SALE_IN_AREA,
               E.PRE_SALE_IN_AREA_ON, E.PRE_SALE_IN_AREA_UNDER,
               E.ACTUAL_SALE_BLD_AREA, E.ACTUAL_SALE_BLD_AREA_ON,
               E.ACTUAL_SALE_BLD_AREA_UNDER

        FROM   MDM_BUILD A
        INNER  JOIN MDM_BUILD_PHASE B
        ON     A.ID = B.BUILD_ID
        INNER  JOIN MDM_OBJ_PHASE_INDEX C
        ON     C.OBJ_PHASE_ID = B.ID
        INNER  JOIN (SELECT B1.PRODUCT_TYPE_CODE, A1.*
                     FROM   MDM_OBJ_PHASE_PT_INDEX A1
                     INNER  JOIN MDM_BUILD_PRODUCT_TYPE B1
                     ON     A1.PRODUCT_TYPE_ID = B1.ID) D
        ON     D.OBJ_PHASE_ID = B.ID
        LEFT   JOIN (SELECT A2.BUILDING_ID, A2.BUILDING_NAME, A2.PRODUCT_CODE, SUM(A2.PRE_BLD_AREA) AS PRE_SALE_BLD_AREA,
										SUM(CASE
														WHEN PRODUCT_IS_CW = 0 THEN
														 A2.PRE_BLD_AREA
														ELSE
														 0
												END) AS PRE_SALE_BLD_AREA_ON,
										SUM(CASE
														WHEN PRODUCT_IS_CW = 1 THEN
														 A2.PRE_BLD_AREA
														ELSE
														 0
												END) AS PRE_SALE_BLD_AREA_UNDER, SUM(A2.PRE_IN_AREA) AS PRE_SALE_IN_AREA,
										SUM(CASE
														WHEN PRODUCT_IS_CW = 0 THEN
														 A2.PRE_IN_AREA
														ELSE
														 0
												END) AS PRE_SALE_IN_AREA_ON,
										SUM(CASE
														WHEN A2.PRODUCT_IS_CW = 1 THEN
														 A2.PRE_IN_AREA
														ELSE
														 0
												END) AS PRE_SALE_IN_AREA_UNDER, SUM(A2.ACTUAL_BLD_AREA) AS ACTUAL_SALE_BLD_AREA,
										SUM(CASE
														WHEN A2.PRODUCT_IS_CW = 0 THEN
														 A2.ACTUAL_BLD_AREA
														ELSE
														 0
												END) AS ACTUAL_SALE_BLD_AREA_ON,
										SUM(CASE
														WHEN A2.PRODUCT_IS_CW = 1 THEN
														 A2.ACTUAL_BLD_AREA
														ELSE
														 0
												END) AS ACTUAL_SALE_BLD_AREA_UNDER

                     FROM   MDM_ROOM A2
                     GROUP  BY A2.BUILDING_ID, A2.BUILDING_NAME,
                               A2.PRODUCT_CODE) E
        ON     E.BUILDING_ID = A.ID AND
               E.PRODUCT_CODE = D.PRODUCT_TYPE_CODE
        LEFT   JOIN (SELECT B3.BUILD_ID, B3.ID AS OBJ_PHASE_ID, A3.BUILD_AREA,
                            A3.GROUND_TOTAL_BUILD_AREA,
                            A3.UNDERGROUND_TOTAL_BUILD_AREA
                     FROM   MDM_OBJ_PHASE_PT_INDEX A3
                     INNER  JOIN MDM_BUILD_PHASE B3
                     ON     A3.OBJ_PHASE_ID = B3.ID AND
                            B3.PHASE_NAME = '竣工备案证阶段') F
        ON     F.BUILD_ID = A.ID AND
               F.OBJ_PHASE_ID = B.ID
        WHERE  EXISTS (SELECT 1
                FROM   (SELECT ROW_NUMBER() OVER(PARTITION BY A.ID ORDER BY C.PHASE_ORDER DESC) AS PRANK,
                                A.ID BUILDID, C.PHASE_ORDER PHASEORDER,
                                C.PHASE_NAME PHASENAME, C.ID PHASEID
                         FROM   MDM_BUILD A
                         INNER  JOIN MDM_BUILD_PHASE B
                         ON     A.ID = B.BUILD_ID
                         INNER  JOIN MDM_PHASE C
                         ON     B.PHASE_ID = C.ID) P
                WHERE  P.PRANK = 1 AND
                       P.PHASEID = B.PHASE_ID AND
                       P.BUILDID = A.ID) AND A.BUILD_STATE = 10
                       AND
               (A.PERIOD_ID =''||PROJ_PERIOD_ID||''  OR A.PROJ_ID=''||PROJ_PERIOD_ID||'')
        ORDER  BY BUILD_NAME;


END;
/

prompt
prompt Creating procedure P_MDM_GET_PERMIT_BUILD
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_MDM_GET_PERMIT_BUILD"(PROJ_PERIOD_ID IN NVARCHAR2 --分期ID
                                         , PERMIT_TYPE IN NVARCHAR2 --证照类型
                                         , FEEDBACK_NODE_ID IN NVARCHAR2-- 反馈ID
                                         , BLD_ID_TABLE OUT SYS_REFCURSOR --返回值
) AS
    permitType varchar(36) := PERMIT_TYPE;
    projPeriodId varchar(100):=PROJ_PERIOD_ID;
    feedbackNodeId varchar(100):=FEEDBACK_NODE_ID;
BEGIN
    OPEN BLD_ID_TABLE FOR
      SELECT DISTINCT a.id AS "bldId",BUILD_NAME AS "bldName",a.period_name AS "projectName"
,''AS "firstProductName"

,'' AS "secondProductName"
,''AS "thirdProductName"
,'' AS "productFullName",'' AS "productId",CASE WHEN case when a2.id is null then 0 else 1 end =1 THEN '是'  else  '否' end as "isGetSalePermit"
,0 AS "bldArea"
,0 AS "bldAreaOn"
,0 AS "bldAreaUnder"
,
                0 AS "saleArea",
                0 AS "saleAreaOn",
                0 AS "saleAreaUnder",
                0 AS "preSaleBldArea",
                0 AS "preSaleBldAreaOn",
                0 AS "preSaleBldAreaUbder",
                0 AS "preSaleInArea",
                0 AS "preSaleInAreaOn",
                0 AS "preSaleInAreaUnder",
                0 AS "actualSaleBldArea",
                0 AS "actualSaleBldAreaOn",
                0 AS "actualSaleBldAreaUnber",
                case when a2.id is null then 0 else 1 end  as is_get_con_plan_permit,
                case when a2.id is null then 0 else 1 end  as is_get_constrcution_permit,
                case when a2.id is null then 0 else 1 end  as is_get_pre_sale_permit,
                case when a2.id is null then 0 else 1 end   as is_get_completed_permit
								,  case when a2.id is null then 0 else 1 end "isDisabled"
								
										,   permit_id AS "permitId"
								, permit_no AS "permitNO"
								, permit_type
FROM MDM_BUILD a 
LEFT JOIN SYS_PROJECT b on a.PROJ_ID=  b.id
LEFT JOIN

(
 
SELECT  *  FROM (
SELECT a.id
--,BUILD_NAME,IS_GET_CON_PLAN_PERMIT ,GET_CON_PLAN_PERMIT_DATE
,'规划许可证'  as "PERMIT_TYPE" ,C.id as permit_id,permit_no as permit_no FROM MDM_BUILD  a  LEFT  JOIN MDM_PERMIT_BLD b on a.id=bld_id 
LEFT JOIN  MDM_PERMIT c on c.id=PERMIT_ID  AND C.APPROVAL_STATUS<>'未审核'   AND  PERMIT_TYPE=''||permitType||''
where (PROJ_ID=''||projPeriodId||'' or PERIOD_ID= ''||projPeriodId||'') and nvl(IS_GET_CON_PLAN_PERMIT,0)=1

UNION ALL 
--是否取施工许可证
SELECT a.id
--,BUILD_NAME,IS_GET_CONSTRCUTION_PERMIT,GET_CONSTRCUTION_PERMIT_DATE
,'施工许可证',C.id as permit_id,permit_no as permit_no FROM MDM_BUILD  a  LEFT  JOIN MDM_PERMIT_BLD b on a.id=bld_id 
LEFT JOIN  MDM_PERMIT c on c.id=PERMIT_ID  AND C.APPROVAL_STATUS<>'未审核'    
AND  PERMIT_TYPE=''||permitType||''
where (PROJ_ID=''||projPeriodId||'' or PERIOD_ID= ''||projPeriodId||'')
and nvl(IS_GET_CONSTRCUTION_PERMIT,0)=1 

 UNION ALL 
--是否取预售许可证
SELECT a.id
--,BUILD_NAME,IS_GET_PRE_SALE_PERMIT,GET_PRE_SALE_PERMIT_DATE
,'预售许可证',C.id as permit_id,permit_no as permit_no FROM MDM_BUILD  a  LEFT  JOIN MDM_PERMIT_BLD b on a.id=bld_id 
LEFT  JOIN  MDM_PERMIT c on c.id=PERMIT_ID AND C.APPROVAL_STATUS<>'未审核'    AND  PERMIT_TYPE=''||permitType||''
where (PROJ_ID=''||projPeriodId||'' or PERIOD_ID= ''||projPeriodId||'')
AND C.APPROVAL_STATUS<>'未审核' 
and nvl(IS_GET_PRE_SALE_PERMIT,0)=1 
AND  PERMIT_TYPE=(
 SELECT PERMIT_TYPE  FROM POM_PROJ_PLAN_NODE  a   where a.id =''||FEEDBACK_NODE_ID||'' )
UNION ALL 
--是否竣工备案证
SELECT a.id
--,BUILD_NAME,IS_GET_COMPLETED_PERMIT,GET_COMPLETED_PERMIT_DATE
,'竣工备案证',C.id as permit_id,permit_no as permit_no FROM MDM_BUILD  a  LEFT  JOIN MDM_PERMIT_BLD b on a.id=bld_id 
LEFT  JOIN  MDM_PERMIT c on c.id=PERMIT_ID  
 AND C.APPROVAL_STATUS<>'未审核'   AND  PERMIT_TYPE=''||permitType||''
where (PROJ_ID=''||projPeriodId||'' or PERIOD_ID= ''||projPeriodId||'')
and nvl(IS_GET_COMPLETED_PERMIT,0)=1 


) a1  where    PERMIT_TYPE=(
 SELECT PERMIT_TYPE  FROM POM_PROJ_PLAN_NODE  a   where a.id =''||FEEDBACK_NODE_ID||'' )
 
 
UNION ALL 
 /*本次取证楼栋*/
SELECT c.BLD_ID,PERMIT_TYPE, b.id as permit_id,permit_no as permit_no  FROM POM_CURRENT_EVIDENCE_INFO a INNER JOIN  MDM_PERMIT b  on a.PERMIT_ID=b.id and PERMIT_TYPE=''||permitType||''
INNER JOIN MDM_PERMIT_BLD c on c.PERMIT_ID=b.id
INNER JOIN MDM_BUILD d on d.id=bld_id
WHERE b.APPROVAL_STATUS<>'未审核'
and (PROJ_ID=''||projPeriodId||'' or PERIOD_ID= ''||projPeriodId||'')
 
AND PERMIT_TYPE=(
 SELECT PERMIT_TYPE  FROM POM_PROJ_PLAN_NODE  a   where a.id =''||FEEDBACK_NODE_ID||'' )
 
 
 ) a2   on  a2.id=a.id

where (PROJ_ID=''||projPeriodId||''  or PERIOD_ID= ''||projPeriodId||'' )   
ORDER BY 2
;
END;
/

prompt
prompt Creating procedure P_MDM_GET_PROJ_TJ
prompt ====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_MDM_GET_PROJ_tj(
info   OUT         SYS_REFCURSOR
) AS
BEGIN
  OPEN info FOR 
  SELECT 
A.ID,
A.COMPANY_NAME AS COMPANY_NAME,--公司名
A.PROJECT_NAME AS PROJECT_NAME,--项目名
CASE 
  WHEN BUI.BUI_NUM IS NOT NULL AND BUI67.BUI67_NUM IS NOT NULL AND BUI.BUI_NUM = BUI67.BUI67_NUM THEN
    '竣工'
  WHEN PROJ.PROJ_NUM IS NULL THEN 
    '待建'
  WHEN BUI5.BUI5_NUM IS NOT NULL THEN 
    '在售'
  WHEN BUI5.BUI5_NUM IS NULL AND BUI34.BUI34_NUM IS NOT NULL THEN 
    '在建'
  ELSE
    '待建'
END STATUS,--项目状态
A.PROJ_COOPERATE AS PROJ_COOPERATE,--是否操盘
to_char(nvl(PAL.LAND_GET_DATE,A.PROJECT_GET_TIME),'YYYY-MM-DD') AS LAND_GET_DATE --拿地时间
FROM MDM_PROJECT A
LEFT JOIN (
SELECT B.PROJ_ID,COUNT(1) AS PROJ_NUM FROM MDM_PROJECT_PHASE B
WHERE B.PHASE_ORDER > 2
GROUP BY B.PROJ_ID
)PROJ ON A.PROJECT_ORIGINAL_ID = PROJ.PROJ_ID

LEFT JOIN (
SELECT D.PROJ_ID,COUNT(1) AS BUI5_NUM FROM MDM_BUILD_PHASE C
LEFT JOIN MDM_BUILD D ON C.BUILD_ID = D.ID AND D.BUILD_STATE = 10
WHERE C.PHASE_ORDER = 5
GROUP BY D.PROJ_ID)BUI5 ON A.PROJECT_ORIGINAL_ID = BUI5.PROJ_ID

LEFT JOIN (
SELECT D.PROJ_ID,COUNT(1) AS BUI34_NUM FROM MDM_BUILD_PHASE C
LEFT JOIN MDM_BUILD D ON C.BUILD_ID = D.ID AND D.BUILD_STATE = 10
WHERE C.PHASE_ORDER IN (3,4)
GROUP BY D.PROJ_ID)BUI34 ON A.PROJECT_ORIGINAL_ID = BUI34.PROJ_ID

LEFT JOIN (
SELECT E.PROJ_ID,COUNT(1) AS BUI67_NUM FROM （
SELECT D.PROJ_ID,C.BUILD_ID,COUNT(1) AS BUI67_NUM FROM MDM_BUILD_PHASE C
LEFT JOIN MDM_BUILD D ON C.BUILD_ID = D.ID AND D.BUILD_STATE = 10
WHERE C.PHASE_ORDER IN (6,7)
GROUP BY D.PROJ_ID,C.BUILD_ID
)E GROUP BY E.PROJ_ID)BUI67 ON A.PROJECT_ORIGINAL_ID = BUI67.PROJ_ID

LEFT JOIN (
SELECT M.PROJ_ID,COUNT(1) AS BUI_NUM  FROM MDM_BUILD M
GROUP BY M.PROJ_ID
)BUI ON A.PROJECT_ORIGINAL_ID = BUI.PROJ_ID

LEFT JOIN (
SELECT B.PROJECT_ID,B.PROJECT_ORIGINAL_ID,MIN(LAND_GET_DATE) AS LAND_GET_DATE FROM (
SELECT A.ID,A.PROJECT_ID,A.PROJECT_ORIGINAL_ID,MIN(LAND_GET_DATE) AS LAND_GET_DATE FROM MDM_PARCEL A
WHERE A.IS_DELETE = 0 
GROUP BY A.ID,A.PROJECT_ID,A.PROJECT_ORIGINAL_ID
)B GROUP BY B.PROJECT_ID,B.PROJECT_ORIGINAL_ID)PAL ON A.PROJECT_ORIGINAL_ID = PAL.PROJECT_ORIGINAL_ID AND A.ID = PAL.PROJECT_ID
WHERE A.APPROVAL_STATUS = '已审核' order by COMPANY_NAME,PROJECT_CODE;

END P_MDM_GET_PROJ_tj;
/

prompt
prompt Creating procedure P_MDM_HIT_DATA_MAINTAIN
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_MDM_HIT_DATA_MAINTAIN (
    objId  IN VARCHAR2, --项目id
    phaseId IN VARCHAR2,--阶段ID
    items  OUT SYS_REFCURSOR --解析后阶段
)
--获取项目主数据维护历史版本列表
--作者：鲜晓勇
--日期：2020/6/23
AS
BEGIN
    open items FOR
            select 
            pv.id as "id",
            pv.obj_phase_version        AS "objPhaseVersion",
            pv.phase_name               AS "phaseName",
            pv.phase_id                 AS "phaseId",
            pv.version as "version",
            to_char(pvi.overall_floorage_area,'99999999999990.99')   AS "overallFloorageAreaAfter",
            to_char(pvi.TOTAL_SALE_AREA,'999999999999990.99') as "totalSaleAreaAfter",
            pvi.UNDERGROUND_TOTAL_SALE_CARPORT as "ungroundTotalSaleCarportAfter",
            to_char(lag(pvi.overall_floorage_area,1,null) over(order by pv.version asc),'99999999999990.99') as "overallFloorageAreaBefore",
            to_char(lag(pvi.TOTAL_SALE_AREA,1,null) over(order by pv.version asc),'99999999999990.99') as "totalSaleAreaBefore",
            lag(pvi.UNDERGROUND_TOTAL_SALE_CARPORT,1,null) over(order by pv.version asc) as "ungroundTotalSaleCarportBefore",
            to_char(pv.created,'yyyy-MM-dd') as "created",
            pv.creator as "creator",
            pv.phase_state as "phaseState"
                from (
                                 SELECT
                                        id ,
                                        obj_phase_version,     
                                        phase_name,       
                                        phase_id,        
                                        case when to_number(replace(obj_phase_version,'V',''))>0
                                            then to_number(replace(obj_phase_version,'V',''))
                                            else to_number(obj_phase_version) end as version,
                                        created,
                                        creator,
                                        OBJ_ID,
                                        obj_type,
                                        phase_state 
                                    FROM
                                        mdm_obj_phase_version 
                            ) pv
                                LEFT JOIN mdm_obj_phase_version_index   pvi ON pv.id = pvi.obj_phase_version_id
                                     WHERE
                                        pv.obj_type = 0 and PV.OBJ_ID=objId
                                    and  pv.phase_id=phaseId
                                    order BY pv.obj_phase_version  asc;
        END P_MDM_HIT_DATA_MAINTAIN;
/

prompt
prompt Creating procedure P_MDM_LICENSE_REGISTRATION
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_MDM_LICENSE_REGISTRATION (
    companyid     IN            VARCHAR2,--当前用户公司
    stationid     IN            VARCHAR2,---当前用户的岗位
    deptid        IN            VARCHAR2,---当前用户的部门
    bizcode       IN            VARCHAR2,---权限code
    userid        IN            VARCHAR2,---当前用户id
    projectids   IN            VARCHAR2,---项目名称
    searchparam   IN            VARCHAR2,--筛选条件
    licenseType   IN            VARCHAR2, --证照类型
    selectCompanyId IN          VARCHAR2,--当前选中的公司
    info         OUT           SYS_REFCURSOR,
    pageindex     IN            INT,
    pagesizes     IN            INT,
    total         OUT           INT
) IS
    --证照办理登记
--作者：鲜晓勇
--日期：2020/2/09
    v_sql_exec         CLOB;
    v_sql         CLOB;
    v_spid             VARCHAR2(200);---数据验证spid
    v_where            VARCHAR2(4000):=' and 1=1 ';
    v_search           VARCHAR2(4000):=' and 1=1 ';  ---搜素sql
    v_license          VARCHAR2(4000):=' AND 1=1';
    v_project          VARCHAR2(4000);
    v_type             VARCHAR2(4000);
    v_auth_sql         VARCHAR2(4000) :=' where 1=1';
BEGIN
    BEGIN
        --执行数据权限存储过程。拿到零时表id 用户连临时表鉴权
        --调用查询数据权限的存储过程,返回spid
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => stationid,
            DEPTID => deptid,
            COMPANYID => companyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
            );
        v_auth_sql:=' left join SYS_PROJECT_STAGE projs on mp.PROJECT_ID=projs.id
                            --关联权限表结果
                            left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') org
                            on (case when projs.id is not null then projs.PROJECT_ID else mp.PROJECT_ID end)=org.orgId
                            --左连接权限字段为空表示没有权限
                            where org.orgId is not null ';
        if(selectCompanyId is not null and projectids is null)THEN
            v_where:= 'AND (case when ps.id  is null then mp.project_id else ps.project_id end) IN (' ||
                'select id from  sys_project where UNIT_ID IN (' ||
                'select ID from SYS_BUSINESS_UNIT sbu where IS_COMPANY = 1 ' ||
                'start with sbu.id='''||selectCompanyId||'''' ||
                'connect by prior sbu.ID = sbu.PARENT_ID)' ||
                ')';
        elsif(projectids is not null)THEN
            FOR item IN (
                SELECT
                    regexp_substr('' || projectids || '', '[^,]+', 1, ROWNUM) AS id
                FROM
                    dual
                CONNECT BY
                    ROWNUM <= length(''
                        || projectids
                        || '') - length(regexp_replace(''
                                                           || projectids
                                                           || '', ',', '')) + 1
                ) LOOP
                    v_project:=v_project||''''||item.id||''',';
                END LOOP;
            v_project:=substr(v_project,1,length(v_project) -1 );
            v_where:='AND (case when ps.id  is null then mp.project_id else ps.project_id end) IN('||v_project||')';
        elsif(projectids is null and selectCompanyId is null) THEN
--           v_where:=' IN (''aaaaaaa'')';
            v_where:=' AND 1=1 ';
        END if;
        if(licenseType <>'默认')
        THEN
            FOR item IN (
                SELECT
                    regexp_substr(''
                                      || licenseType
                                      || '', '[^,]+', 1, ROWNUM) AS type
                FROM
                    dual
                CONNECT BY
                    ROWNUM <= length(''
                        || licenseType
                        || '') - length(regexp_replace(''
                                                           || licenseType
                                                           || '', ',', '')) + 1
                ) LOOP
                    v_type:=v_type||''''||item.type||''',';
                END LOOP;
            v_type:=substr(v_type,1,length(v_type) -1 );
            v_license:=' AND PERMIT_TYPE IN('||v_type||')';
--       v_license:=' AND PERMIT_TYPE IN ('||licenseType||')';
        elsif licenseType='默认' THEN
            v_license:=' AND 1=1 ';
        END IF;
        if(searchParam is not null)THEN
            v_search:=' AND (mp.PROJECT_NAME like ''%'
                || searchparam
                || '%'' or mp.PERMIT_TYPE like ''%'
                || searchparam
                || '%'' or mp.PERMIT_NO like ''%'
                || searchparam
                || '%'')';
        END IF;
        v_sql := '
    SELECT mp.ID as "id",
        rownum as rowno,
    mp.PROJECT_ID as "projectId",
    mp.PROJECT_NAME  as "projectName",
    mp.PERMIT_TYPE as "permitType",
    mp.PERMIT_NO as "permitNo",
    mp.PERMIT_GET_DATE as "permitGetDate",
    mp.CREATOR_ID as "creatorId",
    mp.CREATOR as "creator",
    mp.CREATED as "created",
    mp.APPROVAL_STATUS as "approvalStatus",
    mp.APPROVER_ID as "approverId",
    mp.APPROVER as "approver",
    mp.APPROVAL_TIME as "approvalTime",
    mp.REMARK as "remark",
    mp.BID_SECTIONG as "bidSectiong",
    mp.CONSTRUCTION_UNTI as "constructionUnti",
    mp.CON_PLAN_PERMIT_NO as "conPlanPermitNo",
    mp.CONSTRUCTION_PERMIT_NO as "constructionPermitNo",
    mp.MODIFIER_ID as "modifierId",
    mp.MODIFIER as "modifier",
    mp.MODIFIED as "modified",
    mp.STAGE_NAME as "stageName",
    mp.BLD_SCOPE as "bldScope",
    mp.BLD_AREA as "bldArea",
    mp.SALE_AREA as "saleArea",
    mp.STAGE_ID as "stageId",
    case  when feedback.id is null
    then ''http://pmd.crccre.cn/mdm/mdm/license-handle/license-handle/registration-detil?permitType=''||mp.permit_type||''&id=''||mp.id||''&cancelType=0&action=mdm_licensehandle_insert&companyId=''||sp.unit_id||''''
    else ''http://pom.crccre.cn/pom/pom/licence-feedback/licence-detail?cancelType=0&permitType=''||mp.permit_type||''&product=''||mp.project_name||''&permitNumber=''||mp.permit_no||''&id=''||mp.id||''''
    end as "openUrl",
    nvl(sa.cnt, 0) as "annex"
    FROM MDM_PERMIT mp
    left join POM_NODE_FEEDBACK feedback on mp.id=feedback.PERMIT_ID
    left join (
        select BIZ_ID, count(*) as cnt
            from SYS_ATTACHMENT sa1 inner join SYS_ATTACHMENT_GROUP sag1 on sa1.ATTACHMENT_GROUP_ID = sag1.ID
        group by BIZ_ID) sa on sa.BIZ_ID = mp.id
    left join sys_project_stage ps on mp.project_id=ps.id
    left join SYS_PROJECT sp on (case when ps.id is null then mp.project_id else ps.project_id end)=sp.id
    where 1=1'||v_where||'
    and 1=1
 '||v_license||'
 '||v_search||'';
        if pageindex != 0 and pagesizes != 0 then
            v_sql_exec := 'select a.* from ( ' || v_sql
                || ' AND rownum <= ' || pageindex * pagesizes || ' ) a ' ||
                'where a.rowno >= ' || pagesizes * ( pageindex - 1 ) || '';
        else
            v_sql_exec := v_sql;
        end if;
        dbms_output.put_line(pageindex || ':' || pagesizes);
        dbms_output.put_line(v_sql_exec);
        ----获取总条数
        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
            || v_sql
            || ') a '
            INTO total;
        OPEN info FOR v_sql_exec;
    END;
END P_MDM_LICENSE_REGISTRATION;
/

prompt
prompt Creating procedure P_MDM_MAINTAIN_TO_VERSION
prompt ============================================
prompt
create or replace procedure pom0813.P_MDM_MAINTAIN_TO_VERSION(
    objPhaseId in varchar2, -- 对象id
    objPhaseType in varchar2, -- 对象类型
    version in varchar2, -- 版本
    userId in varchar2, -- 用户id
    username in varchar2, -- 用户名
    info out varchar2, -- 执行结果
    code out number
)
    -- 生成新的主数据版本数据
-- @note 脚本初始化
-- @date 2020-06-30 17:39:18
-- @author 韩金明
as
    tmpObjType varchar(36) := objPhaseType;
    projectId varchar2(36); --项目id
    phaseId varchar2(36); -- 项目阶段id
    isLatestVersion number(1); -- 是否为最新版本
    latestVersion varchar2(36); -- 对象最新版本
    existsRow number(8); -- 验证数据是否已添加
begin
    code := 200;
    info := '执行成功';
    -- 获取项目id
    begin
        begin
            if tmpObjType = '0' then
                select mpp.PROJ_ID, mpp.PHASE_ID into projectId, phaseId from MDM_PROJECT_PHASE mpp
                where id = objPhaseId;
            end if;
        exception when others then
            tmpObjType := '20';
        end;
        if tmpObjType = '20' then
            select mpv.PROJECT_ORIGINAL_ID, mpp.PHASE_ID into projectId, phaseId
            from MDM_PERIOD_VERSION mpv
                     left join MDM_PERIOD mp on mp.PERIOD_VERSION_ID = mpv.ID
                     left join MDM_PERIOD_PHASE mpp on mpp.PERIOD_ID = mp.PERIOD_ORIGINAL_ID
            where mpp.ID = objPhaseId;
        end if;
    exception when others then
        info := '未获取到项目信息';
        code := 501;
        return;
    end;
    -- 获取是否是最新版本
    begin
        select max(OBJ_PHASE_VERSION) into latestVersion  from MDM_OBJ_PHASE_VERSION where OBJ_ID = projectId;
        isLatestVersion := case when latestVersion = version then 1 else 0 end;
    exception when others then
        isLatestVersion := 1;
    end;
    -- 判断数据是否已添加
    select count(1) into existsRow from MDM_OBJ_PHASE_VERSION
    where OBJ_ID = projectId and PHASE_ID = phaseId and OBJ_PHASE_VERSION = version;
    if existsRow != 0 then
        code := 502;
        info := '数据已存在';
        return;
    end if;
    ------------------------------------------MDM_OBJ_PHASE_VERSION----------------------------------------------------
    -- 项目阶段向MDM_OBJ_PHASE_VERSION添加数据
    insert into MDM_OBJ_PHASE_VERSION(
        ID, OBJ_PHASE_ID, OBJ_ID, OBJ_TYPE, PHASE_ID, PHASE_NAME, PHASE_ORDER, CREATED, CREATOR_ID, CREATOR, PHASE_STATE,
        OBJ_PHASE_VERSION, IS_NEWEST, PLANE_FIGURE)
    select GET_UUID(), mpp1.ID, mpp1.PROJ_ID, '0', mpp1.PHASE_ID, mp1.PHASE_NAME, mpp1.PHASE_ORDER,
           SYSDATE, userId, username,
           (case when mpp1.PHASE_STATE=20 then 19 else mpp1.PHASE_STATE end) PHASE_STATE, version,
           isLatestVersion, PLANE_FIGURE from MDM_PROJECT_PHASE mpp1
                                                  left join MDM_PHASE mp1 on mp1.ID = mpp1.PHASE_ID
    where PROJ_ID = projectId and PHASE_ID = phaseId;

    -- 分期阶段向MDM_OBJ_PHASE_VERSION添加数据
    insert into MDM_OBJ_PHASE_VERSION(
        ID, OBJ_PHASE_ID, OBJ_ID, OBJ_TYPE, PHASE_ID, PHASE_NAME, PHASE_ORDER, CREATED, CREATOR_ID, CREATOR, PHASE_STATE,
        OBJ_PHASE_VERSION, IS_NEWEST, PLANE_FIGURE)
    select GET_UUID(), mpp.ID,  PERIOD_ID, '20', PHASE_ID, mp2.PHASE_NAME, mpp.PHASE_ORDER, SYSDATE,
           userId, username, (case when mpp.PHASE_STATE=20 then 19 else mpp.PHASE_STATE end) PHASE_STATE,
           version, isLatestVersion, null
    from MDM_PERIOD_PHASE mpp
             inner join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp.PERIOD_ID
             inner join MDM_PERIOD_VERSION mpv on mpv.ID = mp1.PERIOD_VERSION_ID
             left join MDM_PHASE mp2 on mp2.ID = mpp.PHASE_ID
    where mpv.PROJECT_ID = projectId and mpp.PHASE_ID = phaseId and mpv.APPROVAL_STATUS='已审核';

    -- 楼栋阶段向MDM_OBJ_PHASE_VERSION添加数据
    insert into MDM_OBJ_PHASE_VERSION(
        ID, OBJ_PHASE_ID, OBJ_ID, OBJ_TYPE, PHASE_ID, PHASE_NAME, PHASE_ORDER, CREATED, CREATOR_ID,
        CREATOR, PHASE_STATE,OBJ_PHASE_VERSION, IS_NEWEST, PLANE_FIGURE)
    select GET_UUID(), mbp.ID,  BUILD_ID, '30', PHASE_ID, mp2.PHASE_NAME, mbp.PHASE_ORDER, SYSDATE,
           userId, username, (case when mbp.PHASE_STATE=20 then 19 else mbp.PHASE_STATE end) PHASE_STATE,
           version, isLatestVersion, null
    from MDM_BUILD_PHASE mbp
             inner join MDM_BUILD mb on mbp.BUILD_ID = mb.ID
             left join MDM_PHASE mp2 on mp2.ID = mbp.PHASE_ID
    where mb.PROJ_ID = projectId and mbp.PHASE_ID = phaseId;

    -- 宗地阶段向MDM_OBJ_PHASE_VERSION添加数据
    insert into MDM_OBJ_PHASE_VERSION(
        ID, OBJ_PHASE_ID, OBJ_ID, OBJ_TYPE, PHASE_ID, PHASE_NAME, PHASE_ORDER, CREATED, CREATOR_ID, CREATOR, PHASE_STATE,
        OBJ_PHASE_VERSION, IS_NEWEST, PLANE_FIGURE)
    select distinct GET_UUID(), mpp.ID, PAECEL_ID, '10', PHASE_ID, mp2.PHASE_NAME, mpp.PHASE_ORDER,
                    sysdate, userId, username,
                    (case when mpp.PHASE_STATE=20 then 19 else mpp.PHASE_STATE end) PHASE_STATE, version,
                    isLatestVersion, null
    from MDM_PARCEL_PHASE mpp
             inner join MDM_PARCEL mp on mpp.PAECEL_ID = mp.PARCEL_ORIGINAL_ID
             left join MDM_PROJECT mp2 on mp2.ID = mp.PROJECT_ID
             left join MDM_PHASE mp2 on mp2.ID = mpp.PHASE_ID
    where mp.PROJECT_ORIGINAL_ID = projectId
      and mpp.PHASE_ID = phaseId and APPROVAL_STATUS='已审核';
    ------------------------------------------业态数据复制----------------------------------------------------
    -- 项目阶段向MDM_OBJ_PHASE_VERSION_PT_INDEX添加数据
    insert into MDM_OBJ_PHASE_VERSION_PT_INDEX(
        ID, OBJ_PHASE_VERSION_ID, PRODUCT_TYPE_ID, OPERATE_ATTRIBUTE_ID, OPERATE_ATTRIBUTE_NAME, BUILD_AREA,
        GROUND_CAPACITY_AREA, UNDERGROUND_CAPACITY_AREA, GROUND_UNCAPACITY_AREA, UNDERGROUND_UNCAPACITY_AREA,
        GROUND_TOTAL_BUILD_AREA, UNDERGROUND_TOTAL_BUILD_AREA, REFUGE_STOREY_AREA, MECHANICAL_FLOOR_AREA,
        EMPTY_SPACE_AREA, TOWER_BASEMENT_AREA, UNDERGROUND_GARAGE_AREA, STORAGE_AREA, STORAGE_TOTAL, TOTAL_SALE_AREA,
        GROUND_SALE_AREA, UNDERGROUND_SALE_AREA, TOTAL_GIVE_AREA, GROUND_GIVE_AREA, UNDERGROUND_GIVE_AREA,
        TOTAL_RESIDENCE, TOTAL_BUSINESS, GROUND_CARPORT, RESIDENCE_BOTTOM_CARPORT, PARKING_GARAGE_CARPORT,
        UNDERGROUND_RFJ_CARPORT, UNDERGROUND_RJ_CARPORT, UNDERGROUND_FRFJ_CARPORT, UNDERGROUND_FRJ_CARPORT,
        UNDERGROUND_R_SALE_CARPORT, UNDERGROUND_FRFJ_SALE_CARPORT, UNDERGROUND_FRJ_SALE_CARPORT, CARPORT_TOTAL,
        GROUND_TOTAL_CARPORT, UNDERGROUND_TOTAL_CARPORT, UNDERGROUND_TOTAL_RJ_CARPORT, UNDERGROUND_TOTAL_FRJ_CARPORT,
        UNDERGROUND_TOTAL_SALE_CARPORT, OBJ_PHASE_ID, OBJ_TYPE, PRODUCT_TYPE_NAME, PRODUCT_TYPE_JSON
    )with t1 as (
        SELECT ID, '0' pType from MDM_PROJECT_PHASE
        where PROJ_ID = projectId and PHASE_ID = phaseId
        union
        select mpp1.ID, '20' pType  from MDM_PERIOD_PHASE mpp1
                                             left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                                             left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
        where mpv.PROJECT_ID = projectId and mpp1.PHASE_ID = phaseId and APPROVAL_STATUS='已审核'
        union
        select mpp1.ID, '10' pType from MDM_PARCEL_PHASE mpp1
                                            left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
        where mp1.PROJECT_ORIGINAL_ID = projectId and mpp1.PHASE_ID = phaseId
        union
        select mbp1.ID, '30' pType  from MDM_BUILD_PHASE mbp1
                                             left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
        where mb1.PROJ_ID = projectId and mbp1.PHASE_ID = phaseId
    )SELECT
         GET_UUID(), mopv.ID, PRODUCT_TYPE_ID, OPERATE_ATTRIBUTE_ID, OPERATE_ATTRIBUTE_NAME, BUILD_AREA,
         GROUND_CAPACITY_AREA, UNDERGROUND_CAPACITY_AREA, GROUND_UNCAPACITY_AREA, UNDERGROUND_UNCAPACITY_AREA,
         GROUND_TOTAL_BUILD_AREA, UNDERGROUND_TOTAL_BUILD_AREA, REFUGE_STOREY_AREA, MECHANICAL_FLOOR_AREA,
         EMPTY_SPACE_AREA, TOWER_BASEMENT_AREA, UNDERGROUND_GARAGE_AREA, STORAGE_AREA, STORAGE_TOTAL, TOTAL_SALE_AREA,
         GROUND_SALE_AREA, UNDERGROUND_SALE_AREA, TOTAL_GIVE_AREA, GROUND_GIVE_AREA, UNDERGROUND_GIVE_AREA,
         TOTAL_RESIDENCE, TOTAL_BUSINESS, GROUND_CARPORT, RESIDENCE_BOTTOM_CARPORT, PARKING_GARAGE_CARPORT,
         UNDERGROUND_RFJ_CARPORT, UNDERGROUND_RJ_CARPORT, UNDERGROUND_FRFJ_CARPORT, UNDERGROUND_FRJ_CARPORT,
         UNDERGROUND_R_SALE_CARPORT, UNDERGROUND_FRFJ_SALE_CARPORT, UNDERGROUND_FRJ_SALE_CARPORT, CARPORT_TOTAL,
         GROUND_TOTAL_CARPORT, UNDERGROUND_TOTAL_CARPORT, UNDERGROUND_TOTAL_RJ_CARPORT, UNDERGROUND_TOTAL_FRJ_CARPORT,
         UNDERGROUND_TOTAL_SALE_CARPORT, moppi.OBJ_PHASE_ID, t1.pType, PRODUCT_TYPE_NAME, PRODUCT_TYPE_JSON
    from MDM_OBJ_PHASE_VERSION mopv
             inner join t1 on t1.ID = mopv.OBJ_PHASE_ID
             inner join MDM_OBJ_PHASE_PT_INDEX moppi on moppi.OBJ_PHASE_ID = mopv.OBJ_PHASE_ID
    where mopv.OBJ_PHASE_VERSION = version;

    -- 复制阶段数据
    insert into MDM_OBJ_PHASE_VERSION_INDEX(
        ID, BUILD_AREA, GROUND_CAPACITY_AREA, UNDERGROUND_CAPACITY_AREA, GROUND_UNCAPACITY_AREA,
        UNDERGROUND_UNCAPACITY_AREA, GROUND_TOTAL_BUILD_AREA, UNDERGROUND_TOTAL_BUILD_AREA, REFUGE_STOREY_AREA,
        MECHANICAL_FLOOR_AREA, EMPTY_SPACE_AREA, TOWER_BASEMENT_AREA, UNDERGROUND_GARAGE_AREA, STORAGE_AREA, STORAGE_TOTAL,
        TOTAL_SALE_AREA, GROUND_SALE_AREA, UNDERGROUND_SALE_AREA, TOTAL_GIVE_AREA, GROUND_GIVE_AREA, UNDERGROUND_GIVE_AREA,
        TOTAL_RESIDENCE, TOTAL_BUSINESS, GROUND_CARPORT, RESIDENCE_BOTTOM_CARPORT, PARKING_GARAGE_CARPORT,
        UNDERGROUND_RFJ_CARPORT, UNDERGROUND_RJ_CARPORT, UNDERGROUND_FRFJ_CARPORT, UNDERGROUND_FRJ_CARPORT,
        UNDERGROUND_R_SALE_CARPORT, UNDERGROUND_FRFJ_SALE_CARPORT, UNDERGROUND_FRJ_SALE_CARPORT, CARPORT_TOTAL,
        GROUND_TOTAL_CARPORT, UNDERGROUND_TOTAL_CARPORT, UNDERGROUND_TOTAL_RJ_CARPORT, UNDERGROUND_TOTAL_FRJ_CARPORT,
        UNDERGROUND_TOTAL_SALE_CARPORT, CONSTRUCTION_LAND_AREA, EXPROPRIATION_GREEN_SPACE_AREA, EXPROPRIATION_ROAD_AREA,
        OTHER_EXPROPRIATION_AREA, TOTAL_ROAD_AREA, TOTAL_GREEN_LAND_AREA, DEMONSTRATION_AREA, PLOT_RATIO, BUILD_DENSITY,
        GREENING_RATE, SALE_RATIO, GROUND_ENGINE_CARPORT, TOTAL_SITE_AREA, CONFISCATED_AREA, OVERALL_FLOORAGE_AREA,
        TOTAL_CAPACITY_AREA, CONSTRUCTION_PLOT_RATIO, TOTAL_SITE_AREA_PLOT_RATIO, CONSTRUCTION_BUILD_DENSITY,
        TOTAL_SITE_AREA_BUILD_DENSITY, CONSTRUCTION_GREENING_RATE, TOTAL_SITE_AREA_GREENING_RATE, CARPORT_RATIO,
        TOTAL_HOUSEHOLDS, OBJ_PHASE_ID, OBJ_TYPE, JBS_AREA, OBJ_PHASE_VERSION_ID
    ) with t1 as (
        SELECT ID, '0' pType from MDM_PROJECT_PHASE
        where PROJ_ID = projectId and PHASE_ID = phaseId
        union
        select mpp1.ID, '20' pType  from MDM_PERIOD_PHASE mpp1
                                             left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                                             left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
        where mpv.PROJECT_ID = projectId and mpp1.PHASE_ID = phaseId and APPROVAL_STATUS='已审核'
        union
        select mpp1.ID, '10' pType from MDM_PARCEL_PHASE mpp1
                                            left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
        where mp1.PROJECT_ORIGINAL_ID = projectId and mpp1.PHASE_ID = phaseId
        union
        select mbp1.ID, '30' pType  from MDM_BUILD_PHASE mbp1
                                             left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
        where mb1.PROJ_ID = projectId and mbp1.PHASE_ID = phaseId
    )SELECT
         GET_UUID(), BUILD_AREA, GROUND_CAPACITY_AREA, UNDERGROUND_CAPACITY_AREA, GROUND_UNCAPACITY_AREA,
         UNDERGROUND_UNCAPACITY_AREA, GROUND_TOTAL_BUILD_AREA, UNDERGROUND_TOTAL_BUILD_AREA, REFUGE_STOREY_AREA,
         MECHANICAL_FLOOR_AREA, EMPTY_SPACE_AREA, TOWER_BASEMENT_AREA, UNDERGROUND_GARAGE_AREA, STORAGE_AREA, STORAGE_TOTAL,
         TOTAL_SALE_AREA, GROUND_SALE_AREA, UNDERGROUND_SALE_AREA, TOTAL_GIVE_AREA, GROUND_GIVE_AREA, UNDERGROUND_GIVE_AREA,
         TOTAL_RESIDENCE, TOTAL_BUSINESS, GROUND_CARPORT, RESIDENCE_BOTTOM_CARPORT, PARKING_GARAGE_CARPORT,
         UNDERGROUND_RFJ_CARPORT, UNDERGROUND_RJ_CARPORT, UNDERGROUND_FRFJ_CARPORT, UNDERGROUND_FRJ_CARPORT,
         UNDERGROUND_R_SALE_CARPORT, UNDERGROUND_FRFJ_SALE_CARPORT, UNDERGROUND_FRJ_SALE_CARPORT, CARPORT_TOTAL,
         GROUND_TOTAL_CARPORT, UNDERGROUND_TOTAL_CARPORT, UNDERGROUND_TOTAL_RJ_CARPORT, UNDERGROUND_TOTAL_FRJ_CARPORT,
         UNDERGROUND_TOTAL_SALE_CARPORT, CONSTRUCTION_LAND_AREA, EXPROPRIATION_GREEN_SPACE_AREA, EXPROPRIATION_ROAD_AREA,
         OTHER_EXPROPRIATION_AREA, TOTAL_ROAD_AREA, TOTAL_GREEN_LAND_AREA, DEMONSTRATION_AREA, PLOT_RATIO, BUILD_DENSITY,
         GREENING_RATE, SALE_RATIO, GROUND_ENGINE_CARPORT, TOTAL_SITE_AREA, CONFISCATED_AREA, OVERALL_FLOORAGE_AREA,
         TOTAL_CAPACITY_AREA, CONSTRUCTION_PLOT_RATIO, TOTAL_SITE_AREA_PLOT_RATIO, CONSTRUCTION_BUILD_DENSITY,
         TOTAL_SITE_AREA_BUILD_DENSITY, CONSTRUCTION_GREENING_RATE, TOTAL_SITE_AREA_GREENING_RATE, CARPORT_RATIO,
         TOTAL_HOUSEHOLDS, moppi.OBJ_PHASE_ID, t1.pType OBJ_TYPE, JBS_AREA, mopv.ID
    from MDM_OBJ_PHASE_VERSION mopv
             inner join t1 on t1.ID = mopv.OBJ_PHASE_ID
             inner join MDM_OBJ_PHASE_INDEX moppi on moppi.OBJ_PHASE_ID = mopv.OBJ_PHASE_ID
    where mopv.OBJ_PHASE_VERSION = version;
    ------------------------------------------业态面积复制----------------------------------------------------
    -- 复制业态对象面积分布表MDM_OBJ_PHASE_AL_V
    insert into MDM_OBJ_PHASE_AL_V(
        ID, ATTRIBUTE_AREA_LEVEL_ID, ATTRIBUTE_AREA_LEVEL_NAME, ROOM_NUMBER, OBJ_PHASE_PT_INDEX_ID, OBJ_PHASE_VERSION_ID
    )with t1 as (
        SELECT ID, '0' pType from MDM_PROJECT_PHASE
        where PROJ_ID = projectId and PHASE_ID = phaseId
        union
        select mpp1.ID, '20' pType from MDM_PERIOD_PHASE mpp1
                                            left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                                            left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
        where mpv.PROJECT_ID = projectId and mpp1.PHASE_ID = phaseId and APPROVAL_STATUS='已审核'
        union
        select mpp1.ID, '10' pType from MDM_PARCEL_PHASE mpp1
                                            left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
        where mpp1.PHASE_ID = phaseId and mp1.PROJECT_ORIGINAL_ID = projectId
        union
        select mbp1.ID, '30' pType from MDM_BUILD_PHASE mbp1
                                            left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
        where mb1.PROJ_ID = projectId and mbp1.PHASE_ID = phaseId
    )select
         GET_UUID(), ATTRIBUTE_AREA_LEVEL_ID, ATTRIBUTE_AREA_LEVEL_NAME, ROOM_NUMBER, movpi.ID, mopv.ID
    from t1
             left join MDM_OBJ_PHASE_VERSION mopv on t1.ID = mopv.OBJ_PHASE_ID
             left join MDM_OBJ_PHASE_PT_INDEX mopi on mopi.OBJ_PHASE_ID = t1.ID
             inner join MDM_OBJ_PHASE_AREA_LEVEL mopav on mopav.OBJ_PHASE_PT_INDEX_ID = mopi.ID
             left join MDM_OBJ_PHASE_VERSION_PT_INDEX movpi on mopv.ID = movpi.OBJ_PHASE_VERSION_ID
        and mopi.PRODUCT_TYPE_ID = movpi.PRODUCT_TYPE_ID
    where mopv.OBJ_PHASE_VERSION = version;
end;
/

prompt
prompt Creating procedure P_MDM_MASTER_DATA_SUM
prompt ========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_MDM_MASTER_DATA_SUM"
(
    PHASEID           IN VARCHAR2 , --阶段id
    OBJTPYE           IN VARCHAR2 , --对象类型（项目、宗地、分期、楼栋）
    OBJID             IN OUT VARCHAR2 , --对象id
    PROJCOLLECTSOURCE IN VARCHAR2 --项目数据汇总来源
) AS
    -- 项目主数据汇总-- 作者：杨明-- 日期:2019/11/20
    -- change @author 韩金明 @date 2020-3-30
    periodPhaseId varchar2(36);
    phaseOrder number;
    projectPhaseId varchar(36);
BEGIN
    IF PROJCOLLECTSOURCE = '10' THEN
        --项目汇总数据来源为宗地
        IF OBJTPYE = '10' THEN
            -- 对象为宗地 需要汇总项目数据--汇总对象阶段业态指标表
            begin
                SELECT mpp.ID into projectPhaseId
                FROM MDM_PARCEL mp1
                    LEFT JOIN MDM_PROJECT mp2 ON mp2.PROJECT_ORIGINAL_ID = mp1.PROJECT_ORIGINAL_ID
                    LEFT JOIN MDM_PROJECT_PHASE mpp ON mpp.PROJ_ID = mp2.PROJECT_ORIGINAL_ID AND mp2.APPROVAL_STATUS = '已审核'
                WHERE mp1.PARCEL_ORIGINAL_ID = OBJID AND mpp.PHASE_ID = PHASEID and ROWNUM < 2;
            exception when others then
                projectPhaseId := GET_UUID();
                DBMS_OUTPUT.PUT_LINE('未获取到项目阶段id: [10:10],[' || OBJID || ',' || PHASEID || ']');
            end;
            -- 删除需要修改的业态指标数据
            DELETE FROM MDM_OBJ_PHASE_PT_INDEX B WHERE B.OBJ_PHASE_ID = projectPhaseId AND B.OBJ_TYPE = 0;
            -- 添加新的业态指标数据(全部宗地的)
            insert into MDM_OBJ_PHASE_PT_INDEX
            select
                GET_UUID() AS ID,
                M1.PRODUCT_TYPE_ID AS PRODUCT_TYPE_ID,
                M1.OPERATE_ATTRIBUTE_ID AS OPERATE_ATTRIBUTE_ID,
                M1.OPERATE_ATTRIBUTE_NAME AS OPERATE_ATTRIBUTE_NAME,
                SUM(M1.BUILD_AREA) AS BUILD_AREA,
                SUM(M1.GROUND_CAPACITY_AREA) AS GROUND_CAPACITY_AREA,
                SUM(M1.UNDERGROUND_CAPACITY_AREA) AS UNDERGROUND_CAPACITY_AREA,
                SUM(M1.GROUND_UNCAPACITY_AREA) AS GROUND_UNCAPACITY_AREA,
                SUM(M1.UNDERGROUND_UNCAPACITY_AREA) AS UNDERGROUND_UNCAPACITY_AREA,
                SUM(M1.GROUND_TOTAL_BUILD_AREA) AS GROUND_TOTAL_BUILD_AREA,
                SUM(M1.UNDERGROUND_TOTAL_BUILD_AREA) AS UNDERGROUND_TOTAL_BUILD_AREA,
                SUM(M1.REFUGE_STOREY_AREA) AS REFUGE_STOREY_AREA,
                SUM(M1.MECHANICAL_FLOOR_AREA) AS MECHANICAL_FLOOR_AREA,
                SUM(M1.EMPTY_SPACE_AREA) AS EMPTY_SPACE_AREA,
                SUM(M1.TOWER_BASEMENT_AREA) AS TOWER_BASEMENT_AREA,
                SUM(M1.UNDERGROUND_GARAGE_AREA) AS UNDERGROUND_GARAGE_AREA,
                SUM(M1.STORAGE_AREA) AS STORAGE_AREA,
                SUM(M1.STORAGE_TOTAL) AS STORAGE_TOTAL,
                SUM(M1.TOTAL_SALE_AREA) AS TOTAL_SALE_AREA,
                SUM(M1.GROUND_SALE_AREA) AS GROUND_SALE_AREA,
                SUM(M1.UNDERGROUND_SALE_AREA) AS UNDERGROUND_SALE_AREA,
                SUM(M1.TOTAL_GIVE_AREA) AS TOTAL_GIVE_AREA,
                SUM(M1.GROUND_GIVE_AREA) AS GROUND_GIVE_AREA,
                SUM(M1.UNDERGROUND_GIVE_AREA) AS UNDERGROUND_GIVE_AREA,
                SUM(M1.TOTAL_RESIDENCE) AS TOTAL_RESIDENCE,
                SUM(M1.TOTAL_BUSINESS) AS TOTAL_BUSINESS,
                SUM(M1.GROUND_CARPORT) AS GROUND_CARPORT,
                SUM(M1.RESIDENCE_BOTTOM_CARPORT) AS RESIDENCE_BOTTOM_CARPORT,
                SUM(M1.PARKING_GARAGE_CARPORT) AS PARKING_GARAGE_CARPORT,
                SUM(M1.UNDERGROUND_RFJ_CARPORT) AS UNDERGROUND_RFJ_CARPORT,
                SUM(M1.UNDERGROUND_RJ_CARPORT) AS UNDERGROUND_RJ_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_CARPORT) AS UNDERGROUND_FRFJ_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_CARPORT) AS UNDERGROUND_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_R_SALE_CARPORT) AS UNDERGROUND_R_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_SALE_CARPORT) AS UNDERGROUND_FRFJ_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_SALE_CARPORT) AS UNDERGROUND_FRJ_SALE_CARPORT,
                SUM(M1.CARPORT_TOTAL) AS CARPORT_TOTAL,
                SUM(M1.GROUND_TOTAL_CARPORT) AS GROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_CARPORT) AS UNDERGROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_RJ_CARPORT) AS UNDERGROUND_TOTAL_RJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_FRJ_CARPORT) AS UNDERGROUND_TOTAL_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_SALE_CARPORT) AS UNDERGROUND_TOTAL_SALE_CARPORT,
                aId AS OBJ_PHASE_ID, 0 AS OBJ_TYPE,
                M1.PRODUCT_TYPE_NAME AS PRODUCT_TYPE_NAME,
                M1.PRODUCT_TYPE_JSON AS PRODUCT_TYPE_JSON
            from (
                select
                    distinct moppi.id,
                    moppi.product_type_id,
                    moppi.operate_attribute_id,
                    moppi.operate_attribute_name,
                    moppi.build_area,
                    moppi.ground_capacity_area,
                    moppi.underground_capacity_area,
                    moppi.ground_uncapacity_area,
                    moppi.underground_uncapacity_area,
                    moppi.ground_total_build_area,
                    moppi.underground_total_build_area,
                    moppi.refuge_storey_area,
                    moppi.mechanical_floor_area,
                    moppi.empty_space_area,
                    moppi.tower_basement_area,
                    moppi.underground_garage_area,
                    moppi.storage_area,
                    moppi.storage_total,
                    moppi.total_sale_area,
                    moppi.ground_sale_area,
                    moppi.underground_sale_area,
                    moppi.total_give_area,
                    moppi.ground_give_area,
                    moppi.underground_give_area,
                    moppi.total_residence,
                    moppi.total_business,
                    moppi.ground_carport,
                    moppi.residence_bottom_carport,
                    moppi.parking_garage_carport,
                    moppi.underground_rfj_carport,
                    moppi.underground_rj_carport,
                    moppi.underground_frfj_carport,
                    moppi.underground_frj_carport,
                    moppi.underground_r_sale_carport,
                    moppi.underground_frfj_sale_carport,
                    moppi.underground_frj_sale_carport,
                    moppi.carport_total,
                    moppi.ground_total_carport,
                    moppi.underground_total_carport,
                    moppi.underground_total_rj_carport,
                    moppi.underground_total_frj_carport,
                    moppi.underground_total_sale_carport,
                    moppi.product_type_name,
                    moppi.product_type_json,
                    projectPhaseId as aId
                from MDM_PROJECT_PHASE mpp1
                    left join MDM_PARCEL mp1 on mp1.PROJECT_ORIGINAL_ID = mpp1.PROJ_ID
                    left join MDM_PARCEL_PHASE mpp2 on mpp2.PHASE_ID = mpp1.PHASE_ID
                    and mpp2.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
                    left join MDM_OBJ_PHASE_PT_INDEX moppi on moppi.OBJ_PHASE_ID = mpp2.ID
                where mpp1.ID=projectPhaseId and OBJ_PHASE_ID is not null
            ) M1 GROUP BY PRODUCT_TYPE_ID, OPERATE_ATTRIBUTE_ID,
                     OPERATE_ATTRIBUTE_NAME,PRODUCT_TYPE_NAME,
                     PRODUCT_TYPE_JSON, aId;
            -- 删除需要修改的业态指标数据
            DELETE FROM MDM_OBJ_PHASE_INDEX B WHERE B.OBJ_PHASE_ID = projectPhaseId AND B.OBJ_TYPE = 0;
            -- 插入汇总后的对象阶段指标表数据
            insert into MDM_OBJ_PHASE_INDEX
            select
                GET_UUID()       AS ID,
                SUM(M1.BUILD_AREA)                     AS BUILD_AREA,
                SUM(M1.GROUND_CAPACITY_AREA)           AS GROUND_CAPACITY_AREA,
                SUM(M1.UNDERGROUND_CAPACITY_AREA)      AS UNDERGROUND_CAPACITY_AREA,
                SUM(M1.GROUND_UNCAPACITY_AREA)         AS GROUND_UNCAPACITY_AREA,
                SUM(M1.UNDERGROUND_UNCAPACITY_AREA)    AS UNDERGROUND_UNCAPACITY_AREA,
                SUM(M1.GROUND_TOTAL_BUILD_AREA)        AS GROUND_TOTAL_BUILD_AREA,
                SUM(M1.UNDERGROUND_TOTAL_BUILD_AREA)   AS UNDERGROUND_TOTAL_BUILD_AREA,
                SUM(M1.REFUGE_STOREY_AREA)             AS REFUGE_STOREY_AREA,
                SUM(M1.MECHANICAL_FLOOR_AREA)          AS MECHANICAL_FLOOR_AREA,
                SUM(M1.EMPTY_SPACE_AREA)               AS EMPTY_SPACE_AREA,
                SUM(M1.TOWER_BASEMENT_AREA)            AS TOWER_BASEMENT_AREA,
                SUM(M1.UNDERGROUND_GARAGE_AREA)        AS UNDERGROUND_GARAGE_AREA,
                SUM(M1.STORAGE_AREA)                   AS STORAGE_AREA,
                SUM(M1.STORAGE_TOTAL)                  AS STORAGE_TOTAL,
                SUM(M1.TOTAL_SALE_AREA)                AS TOTAL_SALE_AREA,
                SUM(M1.GROUND_SALE_AREA)               AS GROUND_SALE_AREA,
                SUM(M1.UNDERGROUND_SALE_AREA)          AS UNDERGROUND_SALE_AREA,
                SUM(M1.TOTAL_GIVE_AREA)                AS TOTAL_GIVE_AREA,
                SUM(M1.GROUND_GIVE_AREA)               AS GROUND_GIVE_AREA,
                SUM(M1.UNDERGROUND_GIVE_AREA)          AS UNDERGROUND_GIVE_AREA,
                SUM(M1.TOTAL_RESIDENCE)                AS TOTAL_RESIDENCE,
                SUM(M1.TOTAL_BUSINESS)                 AS TOTAL_BUSINESS,
                SUM(M1.GROUND_CARPORT)                 AS GROUND_CARPORT,
                SUM(M1.RESIDENCE_BOTTOM_CARPORT)       AS RESIDENCE_BOTTOM_CARPORT,
                SUM(M1.PARKING_GARAGE_CARPORT)         AS PARKING_GARAGE_CARPORT,
                SUM(M1.UNDERGROUND_RFJ_CARPORT)        AS UNDERGROUND_RFJ_CARPORT,
                SUM(M1.UNDERGROUND_RJ_CARPORT)         AS UNDERGROUND_RJ_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_CARPORT)       AS UNDERGROUND_FRFJ_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_CARPORT)        AS UNDERGROUND_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_R_SALE_CARPORT)     AS UNDERGROUND_R_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_SALE_CARPORT)  AS UNDERGROUND_FRFJ_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_SALE_CARPORT)   AS UNDERGROUND_FRJ_SALE_CARPORT,
                SUM(M1.CARPORT_TOTAL)                  AS CARPORT_TOTAL,
                SUM(M1.GROUND_TOTAL_CARPORT)           AS GROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_CARPORT)      AS UNDERGROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_RJ_CARPORT)   AS UNDERGROUND_TOTAL_RJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_FRJ_CARPORT)  AS UNDERGROUND_TOTAL_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_SALE_CARPORT) AS UNDERGROUND_TOTAL_SALE_CARPORT,
                SUM(M1.CONSTRUCTION_LAND_AREA)         AS CONSTRUCTION_LAND_AREA,
                SUM(M1.EXPROPRIATION_GREEN_SPACE_AREA) AS EXPROPRIATION_GREEN_SPACE_AREA,
                SUM(M1.EXPROPRIATION_ROAD_AREA)        AS EXPROPRIATION_ROAD_AREA,
                SUM(M1.OTHER_EXPROPRIATION_AREA)       AS OTHER_EXPROPRIATION_AREA,
                SUM(M1.TOTAL_ROAD_AREA)                AS TOTAL_ROAD_AREA,
                SUM(M1.TOTAL_GREEN_LAND_AREA)          AS TOTAL_GREEN_LAND_AREA,
                SUM(M1.DEMONSTRATION_AREA)             AS DEMONSTRATION_AREA,
                SUM(M1.PLOT_RATIO)                     AS PLOT_RATIO,
                SUM(M1.BUILD_DENSITY)                  AS BUILD_DENSITY,
                SUM(M1.GREENING_RATE)                  AS GREENING_RATE,
                SUM(M1.SALE_RATIO)                     AS SALE_RATIO,
                SUM(M1.GROUND_ENGINE_CARPORT)          AS GROUND_ENGINE_CARPORT,
                SUM(M1.TOTAL_SITE_AREA)                AS TOTAL_SITE_AREA,
                SUM(M1.CONFISCATED_AREA)               AS CONFISCATED_AREA,
                SUM(M1.OVERALL_FLOORAGE_AREA)          AS OVERALL_FLOORAGE_AREA,
                SUM(M1.TOTAL_CAPACITY_AREA)            AS TOTAL_CAPACITY_AREA,
                SUM(M1.CONSTRUCTION_PLOT_RATIO)        AS CONSTRUCTION_PLOT_RATIO,
                SUM(M1.TOTAL_SITE_AREA_PLOT_RATIO)     AS TOTAL_SITE_AREA_PLOT_RATIO,
                SUM(M1.CONSTRUCTION_BUILD_DENSITY)     AS CONSTRUCTION_BUILD_DENSITY,
                SUM(M1.TOTAL_SITE_AREA_BUILD_DENSITY)  AS TOTAL_SITE_AREA_BUILD_DENSITY,
                SUM(M1.CONSTRUCTION_GREENING_RATE)     AS CONSTRUCTION_GREENING_RATE,
                SUM(M1.TOTAL_SITE_AREA_GREENING_RATE)  AS TOTAL_SITE_AREA_GREENING_RATE,
                SUM(M1.CARPORT_RATIO)                  AS CARPORT_RATIO,
                SUM(M1.TOTAL_HOUSEHOLDS)               AS TOTAL_HOUSEHOLDS,
                objPhaseId                             AS OBJ_PHASE_ID,
                '0'                                    AS OBJ_TYPE,
                SUM(M1.JBS_AREA)                       AS JBS_AREA
            from (
                select distinct mopi.*, mpp1.ID objPhaseId
                from MDM_PROJECT_PHASE mpp1
                    left join MDM_PARCEL mp1 on mp1.PROJECT_ORIGINAL_ID = mpp1.PROJ_ID
                    left join MDM_PARCEL_PHASE mpp2 on mpp2.PHASE_ID = mpp1.PHASE_ID
                    and mpp2.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
                    left join MDM_OBJ_PHASE_INDEX mopi on mopi.OBJ_PHASE_ID = mpp2.ID
                where mpp1.ID = projectPhaseId and OBJ_PHASE_ID is not null
            ) M1
            GROUP BY objPhaseId;
        END IF;
    END IF;
    IF PROJCOLLECTSOURCE = '20' THEN
        --项目汇总数据来源为分期
        IF OBJTPYE = '20' THEN
            begin
                select mpp.ID into projectPhaseId
                from MDM_PERIOD mp
                    left join MDM_PERIOD_VERSION mpv on mp.PERIOD_VERSION_ID = mpv.id
                    left join MDM_PROJECT_PHASE mpp on mpp.PROJ_ID = mpv.PROJECT_ORIGINAL_ID
                where mp.period_original_id=OBJID and mpp.phase_id=PHASEID and ROWNUM < 2;
            exception when others then
                projectPhaseId := GET_UUID();
                DBMS_OUTPUT.PUT_LINE('未获取到项目阶段id: [20:20],[' || OBJID || ',' || PHASEID || ']');
            end;
            -- 分期 需要汇总项目数据--需要删除项目户数表 项目业态表
            -- 删除业态数据表
            DELETE FROM MDM_OBJ_PHASE_PT_INDEX B  WHERE B.OBJ_PHASE_ID = projectPhaseId;
            -- 汇总业态数据
            insert into MDM_OBJ_PHASE_PT_INDEX
            select
                GET_UUID() AS ID,
                M1.PRODUCT_TYPE_ID AS PRODUCT_TYPE_ID,
                M1.OPERATE_ATTRIBUTE_ID AS OPERATE_ATTRIBUTE_ID,
                M1.OPERATE_ATTRIBUTE_NAME  AS OPERATE_ATTRIBUTE_NAME,
                SUM(M1.BUILD_AREA) AS BUILD_AREA,
                SUM(M1.GROUND_CAPACITY_AREA) AS GROUND_CAPACITY_AREA,
                SUM(M1.UNDERGROUND_CAPACITY_AREA) AS UNDERGROUND_CAPACITY_AREA,
                SUM(M1.GROUND_UNCAPACITY_AREA) AS GROUND_UNCAPACITY_AREA,
                SUM(M1.UNDERGROUND_UNCAPACITY_AREA) AS UNDERGROUND_UNCAPACITY_AREA,
                SUM(M1.GROUND_TOTAL_BUILD_AREA) AS GROUND_TOTAL_BUILD_AREA,
                SUM(M1.UNDERGROUND_TOTAL_BUILD_AREA) AS UNDERGROUND_TOTAL_BUILD_AREA,
                SUM(M1.REFUGE_STOREY_AREA) AS REFUGE_STOREY_AREA,
                SUM(M1.MECHANICAL_FLOOR_AREA) AS MECHANICAL_FLOOR_AREA,
                SUM(M1.EMPTY_SPACE_AREA) AS EMPTY_SPACE_AREA,
                SUM(M1.TOWER_BASEMENT_AREA) AS TOWER_BASEMENT_AREA,
                SUM(M1.UNDERGROUND_GARAGE_AREA) AS UNDERGROUND_GARAGE_AREA,
                SUM(M1.STORAGE_AREA) AS STORAGE_AREA,
                SUM(M1.STORAGE_TOTAL) AS STORAGE_TOTAL,
                SUM(M1.TOTAL_SALE_AREA) AS TOTAL_SALE_AREA,
                SUM(M1.GROUND_SALE_AREA) AS GROUND_SALE_AREA,
                SUM(M1.UNDERGROUND_SALE_AREA) AS UNDERGROUND_SALE_AREA,
                SUM(M1.TOTAL_GIVE_AREA) AS TOTAL_GIVE_AREA,
                SUM(M1.GROUND_GIVE_AREA) AS GROUND_GIVE_AREA,
                SUM(M1.UNDERGROUND_GIVE_AREA) AS UNDERGROUND_GIVE_AREA,
                SUM(M1.TOTAL_RESIDENCE) AS TOTAL_RESIDENCE,
                SUM(M1.TOTAL_BUSINESS) AS TOTAL_BUSINESS,
                SUM(M1.GROUND_CARPORT) AS GROUND_CARPORT,
                SUM(M1.RESIDENCE_BOTTOM_CARPORT) AS RESIDENCE_BOTTOM_CARPORT,
                SUM(M1.PARKING_GARAGE_CARPORT) AS PARKING_GARAGE_CARPORT,
                SUM(M1.UNDERGROUND_RFJ_CARPORT) AS UNDERGROUND_RFJ_CARPORT,
                SUM(M1.UNDERGROUND_RJ_CARPORT) AS UNDERGROUND_RJ_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_CARPORT) AS UNDERGROUND_FRFJ_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_CARPORT) AS UNDERGROUND_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_R_SALE_CARPORT) AS UNDERGROUND_R_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_SALE_CARPORT) AS UNDERGROUND_FRFJ_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_SALE_CARPORT) AS UNDERGROUND_FRJ_SALE_CARPORT,
                SUM(M1.CARPORT_TOTAL) AS CARPORT_TOTAL,
                SUM(M1.GROUND_TOTAL_CARPORT) AS GROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_CARPORT) AS UNDERGROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_RJ_CARPORT) AS UNDERGROUND_TOTAL_RJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_FRJ_CARPORT) AS UNDERGROUND_TOTAL_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_SALE_CARPORT) AS UNDERGROUND_TOTAL_SALE_CARPORT,
                hid AS OBJ_PHASE_ID,
                0 AS OBJ_TYPE,
                M1.PRODUCT_TYPE_NAME AS PRODUCT_TYPE_NAME,
                M1.PRODUCT_TYPE_JSON AS PRODUCT_TYPE_JSON
            from (
                select
                    distinct moppi.ID,
                    mpp.id as hid,
                    PRODUCT_TYPE_ID,
                    OPERATE_ATTRIBUTE_ID,
                    OPERATE_ATTRIBUTE_NAME,
                    BUILD_AREA,
                    GROUND_CAPACITY_AREA,
                    UNDERGROUND_CAPACITY_AREA,
                    GROUND_UNCAPACITY_AREA,
                    UNDERGROUND_UNCAPACITY_AREA,
                    GROUND_TOTAL_BUILD_AREA,
                    UNDERGROUND_TOTAL_BUILD_AREA,
                    REFUGE_STOREY_AREA,
                    MECHANICAL_FLOOR_AREA,
                    EMPTY_SPACE_AREA,
                    TOWER_BASEMENT_AREA,
                    UNDERGROUND_GARAGE_AREA,
                    STORAGE_AREA,
                    STORAGE_TOTAL,
                    TOTAL_SALE_AREA,
                    GROUND_SALE_AREA,
                    UNDERGROUND_SALE_AREA,
                    TOTAL_GIVE_AREA,
                    GROUND_GIVE_AREA,
                    UNDERGROUND_GIVE_AREA,
                    TOTAL_RESIDENCE,
                    TOTAL_BUSINESS,
                    GROUND_CARPORT,
                    RESIDENCE_BOTTOM_CARPORT,
                    PARKING_GARAGE_CARPORT,
                    UNDERGROUND_RFJ_CARPORT,
                    UNDERGROUND_RJ_CARPORT,
                    UNDERGROUND_FRFJ_CARPORT,
                    UNDERGROUND_FRJ_CARPORT,
                    UNDERGROUND_R_SALE_CARPORT,
                    UNDERGROUND_FRFJ_SALE_CARPORT,
                    UNDERGROUND_FRJ_SALE_CARPORT,
                    CARPORT_TOTAL,
                    GROUND_TOTAL_CARPORT,
                    UNDERGROUND_TOTAL_CARPORT,
                    UNDERGROUND_TOTAL_RJ_CARPORT,
                    UNDERGROUND_TOTAL_FRJ_CARPORT,
                    UNDERGROUND_TOTAL_SALE_CARPORT,
                    PRODUCT_TYPE_NAME, PRODUCT_TYPE_JSON
                from MDM_PROJECT_PHASE mpp
                    left join MDM_PERIOD_VERSION mpv on mpp.PROJ_ID = mpv.PROJECT_ORIGINAL_ID
                    left join MDM_PERIOD mp on mp.PERIOD_VERSION_ID = mpv.ID
                    left join MDM_PERIOD_PHASE mpp2 on mpp2.PERIOD_ID = mp.PERIOD_ORIGINAL_ID
                    and mpp.PHASE_ID = mpp2.PHASE_ID
                    left join MDM_OBJ_PHASE_PT_INDEX moppi on moppi.OBJ_PHASE_ID = mpp2.id
                where mpp.id = projectPhaseId and mpp.PHASE_ID = PHASEID and OBJ_PHASE_ID is not null
            ) M1 group by M1.PRODUCT_TYPE_ID, M1.OPERATE_ATTRIBUTE_ID, M1.OPERATE_ATTRIBUTE_NAME,
                     M1.PRODUCT_TYPE_NAME, M1.PRODUCT_TYPE_JSON, hid;
            -- 删除指标数据
            delete from MDM_OBJ_PHASE_INDEX where OBJ_PHASE_ID = projectPhaseId;
            --汇总指标数据
            insert into MDM_OBJ_PHASE_INDEX(
                ID,
                BUILD_AREA,
                GROUND_CAPACITY_AREA,
                UNDERGROUND_CAPACITY_AREA,
                GROUND_UNCAPACITY_AREA,
                UNDERGROUND_UNCAPACITY_AREA,
                GROUND_TOTAL_BUILD_AREA,
                UNDERGROUND_TOTAL_BUILD_AREA,
                REFUGE_STOREY_AREA,
                MECHANICAL_FLOOR_AREA,
                EMPTY_SPACE_AREA,
                TOWER_BASEMENT_AREA,
                UNDERGROUND_GARAGE_AREA,
                STORAGE_AREA,
                STORAGE_TOTAL,
                TOTAL_SALE_AREA,
                GROUND_SALE_AREA,
                UNDERGROUND_SALE_AREA,
                TOTAL_GIVE_AREA,
                GROUND_GIVE_AREA,
                UNDERGROUND_GIVE_AREA,
                TOTAL_RESIDENCE,
                TOTAL_BUSINESS,
                GROUND_CARPORT,
                RESIDENCE_BOTTOM_CARPORT,
                PARKING_GARAGE_CARPORT,
                UNDERGROUND_RFJ_CARPORT,
                UNDERGROUND_RJ_CARPORT,
                UNDERGROUND_FRFJ_CARPORT,
                UNDERGROUND_FRJ_CARPORT,
                UNDERGROUND_R_SALE_CARPORT,
                UNDERGROUND_FRFJ_SALE_CARPORT,
                UNDERGROUND_FRJ_SALE_CARPORT,
                CARPORT_TOTAL,
                GROUND_TOTAL_CARPORT,
                UNDERGROUND_TOTAL_CARPORT,
                UNDERGROUND_TOTAL_RJ_CARPORT,
                UNDERGROUND_TOTAL_FRJ_CARPORT,
                UNDERGROUND_TOTAL_SALE_CARPORT,
                CONSTRUCTION_LAND_AREA,
                EXPROPRIATION_GREEN_SPACE_AREA,
                EXPROPRIATION_ROAD_AREA,
                OTHER_EXPROPRIATION_AREA,
                TOTAL_ROAD_AREA,
                TOTAL_GREEN_LAND_AREA,
                DEMONSTRATION_AREA,
                PLOT_RATIO,
                BUILD_DENSITY,
                GREENING_RATE,
                SALE_RATIO,
                GROUND_ENGINE_CARPORT,
                TOTAL_SITE_AREA,
                CONFISCATED_AREA,
                OVERALL_FLOORAGE_AREA,
                TOTAL_CAPACITY_AREA,
                CONSTRUCTION_PLOT_RATIO,
                TOTAL_SITE_AREA_PLOT_RATIO,
                CONSTRUCTION_BUILD_DENSITY,
                TOTAL_SITE_AREA_BUILD_DENSITY,
                CONSTRUCTION_GREENING_RATE,
                TOTAL_SITE_AREA_GREENING_RATE,
                CARPORT_RATIO,
                TOTAL_HOUSEHOLDS,
                JBS_AREA,
                OBJ_TYPE,
                OBJ_PHASE_ID
            )
            select
                GET_UUID() AS ID,
                SUM(M1.BUILD_AREA) AS BUILD_AREA,
                SUM(M1.GROUND_CAPACITY_AREA) AS GROUND_CAPACITY_AREA,
                SUM(M1.UNDERGROUND_CAPACITY_AREA) AS UNDERGROUND_CAPACITY_AREA,
                SUM(M1.GROUND_UNCAPACITY_AREA) AS GROUND_UNCAPACITY_AREA,
                SUM(M1.UNDERGROUND_UNCAPACITY_AREA) AS UNDERGROUND_UNCAPACITY_AREA,
                SUM(M1.GROUND_TOTAL_BUILD_AREA) AS GROUND_TOTAL_BUILD_AREA,
                SUM(M1.UNDERGROUND_TOTAL_BUILD_AREA) AS UNDERGROUND_TOTAL_BUILD_AREA,
                SUM(M1.REFUGE_STOREY_AREA) AS REFUGE_STOREY_AREA,
                SUM(M1.MECHANICAL_FLOOR_AREA) AS MECHANICAL_FLOOR_AREA,
                SUM(M1.EMPTY_SPACE_AREA) AS EMPTY_SPACE_AREA,
                SUM(M1.TOWER_BASEMENT_AREA) AS TOWER_BASEMENT_AREA,
                SUM(M1.UNDERGROUND_GARAGE_AREA) AS UNDERGROUND_GARAGE_AREA,
                SUM(M1.STORAGE_AREA) AS STORAGE_AREA,
                SUM(M1.STORAGE_TOTAL) AS STORAGE_TOTAL,
                SUM(M1.TOTAL_SALE_AREA) AS TOTAL_SALE_AREA,
                SUM(M1.GROUND_SALE_AREA) AS GROUND_SALE_AREA,
                SUM(M1.UNDERGROUND_SALE_AREA) AS UNDERGROUND_SALE_AREA,
                SUM(M1.TOTAL_GIVE_AREA) AS TOTAL_GIVE_AREA,
                SUM(M1.GROUND_GIVE_AREA) AS GROUND_GIVE_AREA,
                SUM(M1.UNDERGROUND_GIVE_AREA) AS UNDERGROUND_GIVE_AREA,
                SUM(M1.TOTAL_RESIDENCE) AS TOTAL_RESIDENCE,
                SUM(M1.TOTAL_BUSINESS) AS TOTAL_BUSINESS,
                SUM(M1.GROUND_CARPORT) AS GROUND_CARPORT,
                SUM(M1.RESIDENCE_BOTTOM_CARPORT) AS RESIDENCE_BOTTOM_CARPORT,
                SUM(M1.PARKING_GARAGE_CARPORT) AS PARKING_GARAGE_CARPORT,
                SUM(M1.UNDERGROUND_RFJ_CARPORT) AS UNDERGROUND_RFJ_CARPORT,
                SUM(M1.UNDERGROUND_RJ_CARPORT) AS UNDERGROUND_RJ_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_CARPORT) AS UNDERGROUND_FRFJ_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_CARPORT) AS UNDERGROUND_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_R_SALE_CARPORT) AS UNDERGROUND_R_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_SALE_CARPORT) AS UNDERGROUND_FRFJ_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_SALE_CARPORT) AS UNDERGROUND_FRJ_SALE_CARPORT,
                SUM(M1.CARPORT_TOTAL) AS CARPORT_TOTAL,
                SUM(M1.GROUND_TOTAL_CARPORT) AS GROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_CARPORT) AS UNDERGROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_RJ_CARPORT) AS UNDERGROUND_TOTAL_RJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_FRJ_CARPORT) AS UNDERGROUND_TOTAL_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_SALE_CARPORT) AS UNDERGROUND_TOTAL_SALE_CARPORT,
                SUM(M1.CONSTRUCTION_LAND_AREA) AS CONSTRUCTION_LAND_AREA,
                SUM(M1.EXPROPRIATION_GREEN_SPACE_AREA) AS EXPROPRIATION_GREEN_SPACE_AREA,
                SUM(M1.EXPROPRIATION_ROAD_AREA) AS EXPROPRIATION_ROAD_AREA,
                SUM(M1.OTHER_EXPROPRIATION_AREA) AS OTHER_EXPROPRIATION_AREA,
                SUM(M1.TOTAL_ROAD_AREA) AS TOTAL_ROAD_AREA,
                SUM(M1.TOTAL_GREEN_LAND_AREA) AS TOTAL_GREEN_LAND_AREA,
                SUM(M1.DEMONSTRATION_AREA) AS DEMONSTRATION_AREA,
                SUM(M1.PLOT_RATIO) AS PLOT_RATIO,
                SUM(M1.BUILD_DENSITY) AS BUILD_DENSITY,
                SUM(M1.GREENING_RATE) AS GREENING_RATE,
                SUM(M1.SALE_RATIO) AS SALE_RATIO,
                SUM(M1.GROUND_ENGINE_CARPORT) AS GROUND_ENGINE_CARPORT,
                SUM(M1.TOTAL_SITE_AREA) AS TOTAL_SITE_AREA,
                SUM(M1.CONFISCATED_AREA) AS CONFISCATED_AREA,
                SUM(M1.OVERALL_FLOORAGE_AREA) AS OVERALL_FLOORAGE_AREA,
                SUM(M1.TOTAL_CAPACITY_AREA) AS TOTAL_CAPACITY_AREA,
                SUM(M1.CONSTRUCTION_PLOT_RATIO) AS CONSTRUCTION_PLOT_RATIO,
                SUM(M1.TOTAL_SITE_AREA_PLOT_RATIO) AS TOTAL_SITE_AREA_PLOT_RATIO,
                SUM(M1.CONSTRUCTION_BUILD_DENSITY) AS CONSTRUCTION_BUILD_DENSITY,
                SUM(M1.TOTAL_SITE_AREA_BUILD_DENSITY) AS TOTAL_SITE_AREA_BUILD_DENSITY,
                SUM(M1.CONSTRUCTION_GREENING_RATE) AS CONSTRUCTION_GREENING_RATE,
                SUM(M1.TOTAL_SITE_AREA_GREENING_RATE) AS TOTAL_SITE_AREA_GREENING_RATE,
                SUM(M1.CARPORT_RATIO) AS CARPORT_RATIO,
                SUM(M1.TOTAL_HOUSEHOLDS) AS TOTAL_HOUSEHOLDS,
                SUM(M1.JBS_AREA) AS JBS_AREA,
                0 AS OBJ_TYPE,
                hid AS OBJ_PHASE_ID
            from (
                select
                    distinct mopi.*,
                    mpp.id as hid
                from MDM_PROJECT_PHASE mpp
                    left join MDM_PERIOD_VERSION mpv on mpp.PROJ_ID = mpv.PROJECT_ORIGINAL_ID
                    left join MDM_PERIOD mp on mp.PERIOD_VERSION_ID = mpv.ID
                    left join MDM_PERIOD_PHASE mpp2 on mpp2.PERIOD_ID = mp.PERIOD_ORIGINAL_ID
                    and mpp.PHASE_ID = mpp2.PHASE_ID
                    left join MDM_OBJ_PHASE_INDEX mopi on mopi.OBJ_PHASE_ID = mpp2.id
                where mpp.id = projectPhaseId and mpp.PHASE_ID = PHASEID and OBJ_PHASE_ID is not null
            ) M1 group by hid;
        END IF;
        --项目汇总数据来源为宗地
        IF OBJTPYE = '30' THEN
            -- 获取分期阶段ID, 阶段号
            begin
                select mpp2.ID, mpp2.PHASE_ORDER into periodPhaseId, phaseOrder
                from MDM_BUILD_PHASE mbp
                    left join MDM_BUILD mb on mb.ID = mbp.BUILD_ID
                    left join MDM_PERIOD mp on mp.PERIOD_ORIGINAL_ID = mb.PERIOD_ID
                    left join MDM_PERIOD_PHASE mpp2 on mpp2.PERIOD_ID = mp.PERIOD_ORIGINAL_ID
                    and mpp2.PHASE_ORDER = mbp.PHASE_ORDER
                where mb.PERIOD_ID = (
                    select  PERIOD_ID from MDM_BUILD where ID =  OBJID
                ) and mbp.PHASE_ID = PHASEID and ROWNUM < 2;
            exception when others then
                DBMS_OUTPUT.PUT_LINE('未获取到分期阶段信息, [20:30], ['||OBJID || ',' || PHASEID || ']');
                periodPhaseId := GET_UUID();
                phaseOrder := -1;
            end;
            -- 删除当前分期业态数据
            DELETE FROM MDM_OBJ_PHASE_PT_INDEX B WHERE B.OBJ_PHASE_ID = periodPhaseId;
            -- 汇总数据到分期
            insert into MDM_OBJ_PHASE_PT_INDEX
            select
                GET_UUID() AS ID,
                M1.PRODUCT_TYPE_ID AS PRODUCT_TYPE_ID,
                M1.OPERATE_ATTRIBUTE_ID AS OPERATE_ATTRIBUTE_ID,
                M1.OPERATE_ATTRIBUTE_NAME AS OPERATE_ATTRIBUTE_NAME,
                SUM(M1.BUILD_AREA) AS BUILD_AREA,
                SUM(M1.GROUND_CAPACITY_AREA) AS GROUND_CAPACITY_AREA,
                SUM(M1.UNDERGROUND_CAPACITY_AREA) AS UNDERGROUND_CAPACITY_AREA,
                SUM(M1.GROUND_UNCAPACITY_AREA) AS GROUND_UNCAPACITY_AREA,
                SUM(M1.UNDERGROUND_UNCAPACITY_AREA) AS UNDERGROUND_UNCAPACITY_AREA,
                SUM(M1.GROUND_TOTAL_BUILD_AREA) AS GROUND_TOTAL_BUILD_AREA,
                SUM(M1.UNDERGROUND_TOTAL_BUILD_AREA) AS UNDERGROUND_TOTAL_BUILD_AREA,
                SUM(M1.REFUGE_STOREY_AREA) AS REFUGE_STOREY_AREA,
                SUM(M1.MECHANICAL_FLOOR_AREA) AS MECHANICAL_FLOOR_AREA,
                SUM(M1.EMPTY_SPACE_AREA) AS EMPTY_SPACE_AREA,
                SUM(M1.TOWER_BASEMENT_AREA) AS TOWER_BASEMENT_AREA,
                SUM(M1.UNDERGROUND_GARAGE_AREA) AS UNDERGROUND_GARAGE_AREA,
                SUM(M1.STORAGE_AREA) AS STORAGE_AREA,
                SUM(M1.STORAGE_TOTAL) AS STORAGE_TOTAL,
                SUM(M1.TOTAL_SALE_AREA) AS TOTAL_SALE_AREA,
                SUM(M1.GROUND_SALE_AREA) AS GROUND_SALE_AREA,
                SUM(M1.UNDERGROUND_SALE_AREA) AS UNDERGROUND_SALE_AREA,
                SUM(M1.TOTAL_GIVE_AREA) AS TOTAL_GIVE_AREA,
                SUM(M1.GROUND_GIVE_AREA) AS GROUND_GIVE_AREA,
                SUM(M1.UNDERGROUND_GIVE_AREA) AS UNDERGROUND_GIVE_AREA,
                SUM(M1.TOTAL_RESIDENCE) AS TOTAL_RESIDENCE,
                SUM(M1.TOTAL_BUSINESS) AS TOTAL_BUSINESS,
                SUM(M1.GROUND_CARPORT) AS GROUND_CARPORT,
                SUM(M1.RESIDENCE_BOTTOM_CARPORT) AS RESIDENCE_BOTTOM_CARPORT,
                SUM(M1.PARKING_GARAGE_CARPORT) AS PARKING_GARAGE_CARPORT,
                SUM(M1.UNDERGROUND_RFJ_CARPORT) AS UNDERGROUND_RFJ_CARPORT,
                SUM(M1.UNDERGROUND_RJ_CARPORT) AS UNDERGROUND_RJ_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_CARPORT) AS UNDERGROUND_FRFJ_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_CARPORT) AS UNDERGROUND_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_R_SALE_CARPORT) AS UNDERGROUND_R_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_SALE_CARPORT) AS UNDERGROUND_FRFJ_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_SALE_CARPORT) AS UNDERGROUND_FRJ_SALE_CARPORT,
                SUM(M1.CARPORT_TOTAL) AS CARPORT_TOTAL,
                SUM(M1.GROUND_TOTAL_CARPORT) AS GROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_CARPORT) AS UNDERGROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_RJ_CARPORT) AS UNDERGROUND_TOTAL_RJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_FRJ_CARPORT) AS UNDERGROUND_TOTAL_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_SALE_CARPORT) AS UNDERGROUND_TOTAL_SALE_CARPORT,
                periodPhaseId AS OBJ_PHASE_ID, 20 AS OBJ_TYPE,
                M1.PRODUCT_TYPE_NAME AS PRODUCT_TYPE_NAME,
                M1.PRODUCT_TYPE_JSON AS PRODUCT_TYPE_JSON
            from (
                select  moppi.*
                from MDM_OBJ_PHASE_PT_INDEX moppi
                    left join MDM_BUILD_PHASE mbp on moppi.OBJ_PHASE_ID = mbp.ID
                    left join MDM_BUILD mb on mb.ID = mbp.BUILD_ID
                where mb.PERIOD_ID = (
                    select distinct PERIOD_ID from MDM_BUILD where ID = OBJID
                ) and mbp.PHASE_ID = PHASEID and OBJ_PHASE_ID is not null
            ) M1 GROUP  BY M1.PRODUCT_TYPE_ID, M1.OPERATE_ATTRIBUTE_ID,
                     M1.OPERATE_ATTRIBUTE_NAME, M1.PRODUCT_TYPE_NAME,
                     M1.PRODUCT_TYPE_JSON, periodPhaseId;
            -- 删除当前(分期)阶段指标数据
            DELETE FROM MDM_OBJ_PHASE_INDEX B WHERE B.OBJ_PHASE_ID = periodPhaseId;
            --汇总对象(到当前分期)阶段指标表
            insert into MDM_OBJ_PHASE_INDEX(
                ID, BUILD_AREA,GROUND_CAPACITY_AREA,UNDERGROUND_CAPACITY_AREA,GROUND_UNCAPACITY_AREA,
                UNDERGROUND_UNCAPACITY_AREA,GROUND_TOTAL_BUILD_AREA,UNDERGROUND_TOTAL_BUILD_AREA, REFUGE_STOREY_AREA,
                MECHANICAL_FLOOR_AREA,EMPTY_SPACE_AREA,TOWER_BASEMENT_AREA,UNDERGROUND_GARAGE_AREA,STORAGE_AREA,
                STORAGE_TOTAL,TOTAL_SALE_AREA,GROUND_SALE_AREA,UNDERGROUND_SALE_AREA,TOTAL_GIVE_AREA,GROUND_GIVE_AREA,
                UNDERGROUND_GIVE_AREA,TOTAL_RESIDENCE,TOTAL_BUSINESS,GROUND_CARPORT,RESIDENCE_BOTTOM_CARPORT,
                PARKING_GARAGE_CARPORT,UNDERGROUND_RFJ_CARPORT,UNDERGROUND_RJ_CARPORT,UNDERGROUND_FRFJ_CARPORT,
                UNDERGROUND_FRJ_CARPORT,UNDERGROUND_R_SALE_CARPORT,UNDERGROUND_FRFJ_SALE_CARPORT,
                UNDERGROUND_FRJ_SALE_CARPORT,CARPORT_TOTAL,GROUND_TOTAL_CARPORT,UNDERGROUND_TOTAL_CARPORT,
                UNDERGROUND_TOTAL_RJ_CARPORT,UNDERGROUND_TOTAL_FRJ_CARPORT,UNDERGROUND_TOTAL_SALE_CARPORT,SALE_RATIO,
                GROUND_ENGINE_CARPORT,OVERALL_FLOORAGE_AREA,TOTAL_CAPACITY_AREA,CARPORT_RATIO,TOTAL_HOUSEHOLDS,
                OBJ_PHASE_ID,OBJ_TYPE,JBS_AREA
            )
            SELECT
                GET_UUID() AS ID,
                SUM(M1.BUILD_AREA) AS BUILD_AREA,
                SUM(M1.GROUND_CAPACITY_AREA) AS GROUND_CAPACITY_AREA,
                SUM(M1.UNDERGROUND_CAPACITY_AREA) AS UNDERGROUND_CAPACITY_AREA,
                SUM(M1.GROUND_UNCAPACITY_AREA) AS GROUND_UNCAPACITY_AREA,
                SUM(M1.UNDERGROUND_UNCAPACITY_AREA) AS UNDERGROUND_UNCAPACITY_AREA,
                SUM(M1.GROUND_TOTAL_BUILD_AREA) AS GROUND_TOTAL_BUILD_AREA,
                SUM(M1.UNDERGROUND_TOTAL_BUILD_AREA) AS UNDERGROUND_TOTAL_BUILD_AREA,
                SUM(M1.REFUGE_STOREY_AREA) AS REFUGE_STOREY_AREA,
                SUM(M1.MECHANICAL_FLOOR_AREA) AS MECHANICAL_FLOOR_AREA,
                SUM(M1.EMPTY_SPACE_AREA) AS EMPTY_SPACE_AREA,
                SUM(M1.TOWER_BASEMENT_AREA) AS TOWER_BASEMENT_AREA,
                SUM(M1.UNDERGROUND_GARAGE_AREA) AS UNDERGROUND_GARAGE_AREA,
                SUM(M1.STORAGE_AREA) AS STORAGE_AREA,
                SUM(M1.STORAGE_TOTAL) AS STORAGE_TOTAL,
                SUM(M1.TOTAL_SALE_AREA) AS TOTAL_SALE_AREA,
                SUM(M1.GROUND_SALE_AREA) AS GROUND_SALE_AREA,
                SUM(M1.UNDERGROUND_SALE_AREA) AS UNDERGROUND_SALE_AREA,
                SUM(M1.TOTAL_GIVE_AREA) AS TOTAL_GIVE_AREA,
                SUM(M1.GROUND_GIVE_AREA) AS GROUND_GIVE_AREA,
                SUM(M1.UNDERGROUND_GIVE_AREA) AS UNDERGROUND_GIVE_AREA,
                SUM(M1.TOTAL_RESIDENCE) AS TOTAL_RESIDENCE,
                SUM(M1.TOTAL_BUSINESS) AS TOTAL_BUSINESS,
                SUM(M1.GROUND_CARPORT) AS GROUND_CARPORT,
                SUM(M1.RESIDENCE_BOTTOM_CARPORT) AS RESIDENCE_BOTTOM_CARPORT,
                SUM(M1.PARKING_GARAGE_CARPORT) AS PARKING_GARAGE_CARPORT,
                SUM(M1.UNDERGROUND_RFJ_CARPORT) AS UNDERGROUND_RFJ_CARPORT,
                SUM(M1.UNDERGROUND_RJ_CARPORT) AS UNDERGROUND_RJ_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_CARPORT) AS UNDERGROUND_FRFJ_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_CARPORT) AS UNDERGROUND_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_R_SALE_CARPORT) AS UNDERGROUND_R_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_SALE_CARPORT) AS UNDERGROUND_FRFJ_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_SALE_CARPORT) AS UNDERGROUND_FRJ_SALE_CARPORT,
                SUM(M1.CARPORT_TOTAL) AS CARPORT_TOTAL,
                SUM(M1.GROUND_TOTAL_CARPORT) AS GROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_CARPORT) AS UNDERGROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_RJ_CARPORT) AS UNDERGROUND_TOTAL_RJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_FRJ_CARPORT) AS UNDERGROUND_TOTAL_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_SALE_CARPORT) AS UNDERGROUND_TOTAL_SALE_CARPORT,
                SUM(M1.SALE_RATIO) AS SALE_RATIO,
                SUM(M1.GROUND_ENGINE_CARPORT) AS GROUND_ENGINE_CARPORT,
                SUM(M1.OVERALL_FLOORAGE_AREA) AS OVERALL_FLOORAGE_AREA,
                SUM(M1.TOTAL_CAPACITY_AREA) AS TOTAL_CAPACITY_AREA,
                SUM(M1.CARPORT_RATIO) AS CARPORT_RATIO,
                SUM(M1.TOTAL_HOUSEHOLDS) AS TOTAL_HOUSEHOLDS,
                objPhaseId AS OBJ_PHASE_ID,
                20 AS OBJ_TYPE,
                SUM(M1.JBS_AREA) AS JBS_AREA
            from (
                select  mopi.*, periodPhaseId objPhaseId
                from MDM_OBJ_PHASE_INDEX mopi
                    left join MDM_BUILD_PHASE mbp on mopi.OBJ_PHASE_ID = mbp.ID
                    left join MDM_BUILD mb on mb.ID = mbp.BUILD_ID
                where mb.PERIOD_ID = (
                    select distinct PERIOD_ID from MDM_BUILD where ID = OBJID
                ) and mbp.PHASE_ID = PHASEID and OBJ_PHASE_ID is not null
            ) M1 GROUP BY objPhaseId;
            -- 获取项目ID;
            begin
                select mpp3.ID into projectPhaseId
                from MDM_PERIOD_PHASE mpp1
                    left join MDM_PERIOD mp1 on mp1.ID = mpp1.PERIOD_ID
                    left join MDM_PERIOD mp2 on mp2.PERIOD_VERSION_ID = mp1.PERIOD_VERSION_ID
                    left join MDM_PERIOD_PHASE mpp2 on mpp2.PERIOD_ID = mp2.ID
                    and mpp1.PHASE_ORDER = mpp2.PHASE_ORDER
                    left join MDM_PERIOD_VERSION mpv on mpv.ID = mp2.PERIOD_VERSION_ID
                    left join MDM_PROJECT_PHASE mpp3 on mpp3.PROJ_ID = mpv.PROJECT_ORIGINAL_ID
                where mpp1.ID = periodPhaseId and mpp3.PHASE_ORDER = phaseOrder and ROWNUM < 2;
            exception when others then
                DBMS_OUTPUT.PUT_LINE('未获取到项目阶段信息, [20:30], [' || OBJID || ',' || PHASEID || ']');
                projectPhaseId := GET_UUID();
            end;
            -- 删除项目业态指标数据
            DELETE FROM MDM_OBJ_PHASE_PT_INDEX where OBJ_PHASE_ID = projectPhaseId;
            -- 添加业态指标数据(从分期合并到项目)
            insert into MDM_OBJ_PHASE_PT_INDEX
            select
                GET_UUID() AS ID,
                M1.PRODUCT_TYPE_ID AS PRODUCT_TYPE_ID,
                M1.OPERATE_ATTRIBUTE_ID AS OPERATE_ATTRIBUTE_ID,
                M1.OPERATE_ATTRIBUTE_NAME AS OPERATE_ATTRIBUTE_NAME,
                SUM(M1.BUILD_AREA) AS BUILD_AREA,
                SUM(M1.GROUND_CAPACITY_AREA) AS GROUND_CAPACITY_AREA,
                SUM(M1.UNDERGROUND_CAPACITY_AREA) AS UNDERGROUND_CAPACITY_AREA,
                SUM(M1.GROUND_UNCAPACITY_AREA) AS GROUND_UNCAPACITY_AREA,
                SUM(M1.UNDERGROUND_UNCAPACITY_AREA) AS UNDERGROUND_UNCAPACITY_AREA,
                SUM(M1.GROUND_TOTAL_BUILD_AREA) AS GROUND_TOTAL_BUILD_AREA,
                SUM(M1.UNDERGROUND_TOTAL_BUILD_AREA) AS UNDERGROUND_TOTAL_BUILD_AREA,
                SUM(M1.REFUGE_STOREY_AREA) AS REFUGE_STOREY_AREA,
                SUM(M1.MECHANICAL_FLOOR_AREA) AS MECHANICAL_FLOOR_AREA,
                SUM(M1.EMPTY_SPACE_AREA) AS EMPTY_SPACE_AREA,
                SUM(M1.TOWER_BASEMENT_AREA) AS TOWER_BASEMENT_AREA,
                SUM(M1.UNDERGROUND_GARAGE_AREA) AS UNDERGROUND_GARAGE_AREA,
                SUM(M1.STORAGE_AREA) AS STORAGE_AREA,
                SUM(M1.STORAGE_TOTAL) AS STORAGE_TOTAL,
                SUM(M1.TOTAL_SALE_AREA) AS TOTAL_SALE_AREA,
                SUM(M1.GROUND_SALE_AREA) AS GROUND_SALE_AREA,
                SUM(M1.UNDERGROUND_SALE_AREA) AS UNDERGROUND_SALE_AREA,
                SUM(M1.TOTAL_GIVE_AREA) AS TOTAL_GIVE_AREA,
                SUM(M1.GROUND_GIVE_AREA) AS GROUND_GIVE_AREA,
                SUM(M1.UNDERGROUND_GIVE_AREA) AS UNDERGROUND_GIVE_AREA,
                SUM(M1.TOTAL_RESIDENCE) AS TOTAL_RESIDENCE,
                SUM(M1.TOTAL_BUSINESS) AS TOTAL_BUSINESS,
                SUM(M1.GROUND_CARPORT) AS GROUND_CARPORT,
                SUM(M1.RESIDENCE_BOTTOM_CARPORT) AS RESIDENCE_BOTTOM_CARPORT,
                SUM(M1.PARKING_GARAGE_CARPORT) AS PARKING_GARAGE_CARPORT,
                SUM(M1.UNDERGROUND_RFJ_CARPORT) AS UNDERGROUND_RFJ_CARPORT,
                SUM(M1.UNDERGROUND_RJ_CARPORT) AS UNDERGROUND_RJ_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_CARPORT) AS UNDERGROUND_FRFJ_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_CARPORT) AS UNDERGROUND_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_R_SALE_CARPORT) AS UNDERGROUND_R_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_SALE_CARPORT) AS UNDERGROUND_FRFJ_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_SALE_CARPORT) AS UNDERGROUND_FRJ_SALE_CARPORT,
                SUM(M1.CARPORT_TOTAL) AS CARPORT_TOTAL,
                SUM(M1.GROUND_TOTAL_CARPORT) AS GROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_CARPORT) AS UNDERGROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_RJ_CARPORT) AS UNDERGROUND_TOTAL_RJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_FRJ_CARPORT) AS UNDERGROUND_TOTAL_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_SALE_CARPORT) AS UNDERGROUND_TOTAL_SALE_CARPORT,
                objPhaseId AS OBJ_PHASE_ID, 0 AS OBJ_TYPE,
                M1.PRODUCT_TYPE_NAME AS PRODUCT_TYPE_NAME,
                M1.PRODUCT_TYPE_JSON AS PRODUCT_TYPE_JSON
            from (
                select moppi.*, projectPhaseId objPhaseId
                from MDM_PERIOD_PHASE mpp1
                    left join MDM_PERIOD mp1 on mp1.ID = mpp1.PERIOD_ID
                    left join MDM_PERIOD mp2 on mp2.PERIOD_VERSION_ID = mp1.PERIOD_VERSION_ID
                    left join MDM_PERIOD_PHASE mpp2 on mpp2.PERIOD_ID = mp2.ID
                    and mpp1.PHASE_ORDER = mpp2.PHASE_ORDER
                    left join MDM_OBJ_PHASE_PT_INDEX moppi on moppi.OBJ_PHASE_ID = mpp2.ID
                where mpp1.ID = periodPhaseId and OBJ_PHASE_ID is not null
            )M1 group by M1.PRODUCT_TYPE_ID, M1.OPERATE_ATTRIBUTE_ID,
                    M1.OPERATE_ATTRIBUTE_NAME, M1.PRODUCT_TYPE_NAME,
                    M1.PRODUCT_TYPE_JSON, objPhaseId;
            -- 删除项目阶段指标表
            DELETE FROM MDM_OBJ_PHASE_INDEX where OBJ_PHASE_ID = projectPhaseId;
            -- 添加阶段指标表(从分期到项目)
            insert into MDM_OBJ_PHASE_INDEX(
                ID, BUILD_AREA,GROUND_CAPACITY_AREA,UNDERGROUND_CAPACITY_AREA,GROUND_UNCAPACITY_AREA,
                UNDERGROUND_UNCAPACITY_AREA,GROUND_TOTAL_BUILD_AREA,UNDERGROUND_TOTAL_BUILD_AREA, REFUGE_STOREY_AREA,
                MECHANICAL_FLOOR_AREA,EMPTY_SPACE_AREA,TOWER_BASEMENT_AREA,UNDERGROUND_GARAGE_AREA,STORAGE_AREA,
                STORAGE_TOTAL,TOTAL_SALE_AREA,GROUND_SALE_AREA,UNDERGROUND_SALE_AREA,TOTAL_GIVE_AREA,GROUND_GIVE_AREA,
                UNDERGROUND_GIVE_AREA,TOTAL_RESIDENCE,TOTAL_BUSINESS,GROUND_CARPORT,RESIDENCE_BOTTOM_CARPORT,
                PARKING_GARAGE_CARPORT,UNDERGROUND_RFJ_CARPORT,UNDERGROUND_RJ_CARPORT,UNDERGROUND_FRFJ_CARPORT,
                UNDERGROUND_FRJ_CARPORT,UNDERGROUND_R_SALE_CARPORT,UNDERGROUND_FRFJ_SALE_CARPORT,
                UNDERGROUND_FRJ_SALE_CARPORT,CARPORT_TOTAL,GROUND_TOTAL_CARPORT,UNDERGROUND_TOTAL_CARPORT,
                UNDERGROUND_TOTAL_RJ_CARPORT,UNDERGROUND_TOTAL_FRJ_CARPORT,UNDERGROUND_TOTAL_SALE_CARPORT,SALE_RATIO,
                GROUND_ENGINE_CARPORT,OVERALL_FLOORAGE_AREA,TOTAL_CAPACITY_AREA,CARPORT_RATIO,TOTAL_HOUSEHOLDS,
                OBJ_PHASE_ID,OBJ_TYPE,JBS_AREA
            )
            SELECT
                GET_UUID() AS ID,
                SUM(M1.BUILD_AREA) AS BUILD_AREA,
                SUM(M1.GROUND_CAPACITY_AREA) AS GROUND_CAPACITY_AREA,
                SUM(M1.UNDERGROUND_CAPACITY_AREA) AS UNDERGROUND_CAPACITY_AREA,
                SUM(M1.GROUND_UNCAPACITY_AREA) AS GROUND_UNCAPACITY_AREA,
                SUM(M1.UNDERGROUND_UNCAPACITY_AREA) AS UNDERGROUND_UNCAPACITY_AREA,
                SUM(M1.GROUND_TOTAL_BUILD_AREA) AS GROUND_TOTAL_BUILD_AREA,
                SUM(M1.UNDERGROUND_TOTAL_BUILD_AREA) AS UNDERGROUND_TOTAL_BUILD_AREA,
                SUM(M1.REFUGE_STOREY_AREA) AS REFUGE_STOREY_AREA,
                SUM(M1.MECHANICAL_FLOOR_AREA) AS MECHANICAL_FLOOR_AREA,
                SUM(M1.EMPTY_SPACE_AREA) AS EMPTY_SPACE_AREA,
                SUM(M1.TOWER_BASEMENT_AREA) AS TOWER_BASEMENT_AREA,
                SUM(M1.UNDERGROUND_GARAGE_AREA) AS UNDERGROUND_GARAGE_AREA,
                SUM(M1.STORAGE_AREA) AS STORAGE_AREA,
                SUM(M1.STORAGE_TOTAL) AS STORAGE_TOTAL,
                SUM(M1.TOTAL_SALE_AREA) AS TOTAL_SALE_AREA,
                SUM(M1.GROUND_SALE_AREA) AS GROUND_SALE_AREA,
                SUM(M1.UNDERGROUND_SALE_AREA) AS UNDERGROUND_SALE_AREA,
                SUM(M1.TOTAL_GIVE_AREA) AS TOTAL_GIVE_AREA,
                SUM(M1.GROUND_GIVE_AREA) AS GROUND_GIVE_AREA,
                SUM(M1.UNDERGROUND_GIVE_AREA) AS UNDERGROUND_GIVE_AREA,
                SUM(M1.TOTAL_RESIDENCE) AS TOTAL_RESIDENCE,
                SUM(M1.TOTAL_BUSINESS) AS TOTAL_BUSINESS,
                SUM(M1.GROUND_CARPORT) AS GROUND_CARPORT,
                SUM(M1.RESIDENCE_BOTTOM_CARPORT) AS RESIDENCE_BOTTOM_CARPORT,
                SUM(M1.PARKING_GARAGE_CARPORT) AS PARKING_GARAGE_CARPORT,
                SUM(M1.UNDERGROUND_RFJ_CARPORT) AS UNDERGROUND_RFJ_CARPORT,
                SUM(M1.UNDERGROUND_RJ_CARPORT) AS UNDERGROUND_RJ_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_CARPORT) AS UNDERGROUND_FRFJ_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_CARPORT) AS UNDERGROUND_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_R_SALE_CARPORT) AS UNDERGROUND_R_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRFJ_SALE_CARPORT) AS UNDERGROUND_FRFJ_SALE_CARPORT,
                SUM(M1.UNDERGROUND_FRJ_SALE_CARPORT) AS UNDERGROUND_FRJ_SALE_CARPORT,
                SUM(M1.CARPORT_TOTAL) AS CARPORT_TOTAL,
                SUM(M1.GROUND_TOTAL_CARPORT) AS GROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_CARPORT) AS UNDERGROUND_TOTAL_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_RJ_CARPORT) AS UNDERGROUND_TOTAL_RJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_FRJ_CARPORT) AS UNDERGROUND_TOTAL_FRJ_CARPORT,
                SUM(M1.UNDERGROUND_TOTAL_SALE_CARPORT) AS UNDERGROUND_TOTAL_SALE_CARPORT,
                SUM(M1.SALE_RATIO) AS SALE_RATIO,
                SUM(M1.GROUND_ENGINE_CARPORT) AS GROUND_ENGINE_CARPORT,
                SUM(M1.OVERALL_FLOORAGE_AREA) AS OVERALL_FLOORAGE_AREA,
                SUM(M1.TOTAL_CAPACITY_AREA) AS TOTAL_CAPACITY_AREA,
                SUM(M1.CARPORT_RATIO) AS CARPORT_RATIO,
                SUM(M1.TOTAL_HOUSEHOLDS) AS TOTAL_HOUSEHOLDS,
                objPhaseId AS OBJ_PHASE_ID,
                0 AS OBJ_TYPE,
                SUM(M1.JBS_AREA) AS JBS_AREA
            from (
                select moppi.*, projectPhaseId objPhaseId
                from MDM_PERIOD_PHASE mpp1
                    left join MDM_PERIOD mp1 on mp1.ID = mpp1.PERIOD_ID
                    left join MDM_PERIOD mp2 on mp2.PERIOD_VERSION_ID = mp1.PERIOD_VERSION_ID
                    left join MDM_PERIOD_PHASE mpp2 on mpp2.PERIOD_ID = mp2.ID
                    and mpp1.PHASE_ORDER = mpp2.PHASE_ORDER
                    left join MDM_OBJ_PHASE_INDEX moppi on moppi.OBJ_PHASE_ID = mpp2.ID
                where mpp1.ID = periodPhaseId and OBJ_PHASE_ID is not null
            ) M1 GROUP BY objPhaseId;
        END IF;
    END IF;
END;
/

prompt
prompt Creating procedure P_MDM_MASTER_DATA_SUM_V2
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_MDM_MASTER_DATA_SUM_V2
(
    phaseId           IN VARCHAR2 , --阶段id
    objType           IN VARCHAR2 , --对象类型（项目、宗地、分期、楼栋）
    objId             IN VARCHAR2 , --对象id
    code              OUT INTEGER, -- 状态码
    errMsg            OUT VARCHAR2 -- 错误信息
) AS
    -- 项目主数据汇总-- 作者：杨明-- 日期:2019/11/20
    -- change @author 韩金明 @date 2020-3-30
    periodPhaseId varchar(36) := '';
    tempObjId varchar(36) := objId;
    tempObjPhaseId varchar(36);
    tempObjType varchar(36) := objType;
BEGIN
    code := 0;
    errMsg := '执行成功';
    -- 从宗地汇总到项目
    if tempObjType = 10 then
        -- 获取项目id和项目阶段id
        begin
            SELECT mpp.ID, mpp.PROJ_ID into tempObjPhaseId, tempObjId
            FROM MDM_PARCEL mp1
                     LEFT JOIN MDM_PROJECT mp2 ON mp2.ID = mp1.PROJECT_ID
                     LEFT JOIN MDM_PROJECT_PHASE mpp ON mpp.PROJ_ID = mp2.PROJECT_ORIGINAL_ID
                AND mp2.APPROVAL_STATUS = '已审核'
            WHERE mp1.PARCEL_ORIGINAL_ID = OBJID AND mpp.PHASE_ID = PHASEID;
        exception when others then
            code := 10400;
            errMsg := '未找到对应项目信息';
            return;
        end;
        -- 删除项目业态信息
        DELETE FROM MDM_OBJ_PHASE_PT_INDEX moppi WHERE moppi.OBJ_PHASE_ID = tempObjPhaseId AND moppi.OBJ_TYPE = 0;
        -- 添加项目业态信息
        insert into MDM_OBJ_PHASE_PT_INDEX(
            id,  product_type_id, operate_attribute_id,
            operate_attribute_name, build_area, ground_capacity_area, underground_capacity_area,
            ground_uncapacity_area, underground_uncapacity_area, ground_total_build_area,
            underground_total_build_area, refuge_storey_area, mechanical_floor_area, empty_space_area,
            tower_basement_area, underground_garage_area, storage_area, storage_total, total_sale_area,
            ground_sale_area, underground_sale_area, total_give_area, ground_give_area, underground_give_area,
            total_residence, total_business, ground_carport, residence_bottom_carport, parking_garage_carport,
            underground_rfj_carport, underground_rj_carport, underground_frfj_carport, underground_frj_carport,
            underground_r_sale_carport, underground_frfj_sale_carport, underground_frj_sale_carport, carport_total,
            ground_total_carport, underground_total_carport, underground_total_rj_carport,
            underground_total_frj_carport, underground_total_sale_carport, obj_phase_id, obj_type,
            product_type_name, product_type_json)
        select GET_UUID(), product_type_id, operate_attribute_id,
               operate_attribute_name, sum(build_area) build_area, sum(ground_capacity_area) ground_capacity_area,
               sum(underground_capacity_area) underground_capacity_area,
               sum(ground_uncapacity_area) ground_uncapacity_area,
               sum(underground_uncapacity_area) underground_uncapacity_area,
               sum(ground_total_build_area) ground_total_build_area,
               sum(underground_total_build_area) underground_total_build_area, sum(refuge_storey_area) refuge_storey_area,
               sum(mechanical_floor_area) mechanical_floor_area, sum(empty_space_area) empty_space_area,
               sum(tower_basement_area) tower_basement_area, sum(underground_garage_area) underground_garage_area,
               sum(storage_area) storage_area, sum(storage_total) storage_total, sum(total_sale_area) total_sale_area,
               sum(ground_sale_area) ground_sale_area, sum(underground_sale_area) underground_sale_area,
               sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
               sum(underground_give_area) underground_give_area, sum(total_residence) total_residence,
               sum(total_business) total_business,sum(ground_carport) ground_carport,
               sum(residence_bottom_carport) residence_bottom_carport, sum(parking_garage_carport) parking_garage_carport,
               sum(underground_rfj_carport) underground_rfj_carport, sum(underground_rj_carport) underground_rj_carport,
               sum(underground_frfj_carport) underground_frfj_carport, sum(underground_frj_carport) underground_frj_carport,
               sum(underground_r_sale_carport) underground_r_sale_carport,
               sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
               sum(underground_frj_sale_carport) underground_frj_sale_carport, sum(carport_total) carport_total,
               sum(ground_total_carport) ground_total_carport, sum(underground_total_carport) underground_total_carport,
               sum(underground_total_rj_carport) underground_total_rj_carport,
               sum(underground_total_frj_carport) underground_total_frj_carport,
               sum(underground_total_sale_carport) underground_total_sale_carport, tempObjPhaseId obj_phase_id,
               '0' objType, product_type_name, product_type_json
        from MDM_PARCEL mp1
                 left join MDM_PARCEL_PHASE mpp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
                 left join MDM_PROJECT mp2 on mp1.PROJECT_ID = mp2.ID
                 left join MDM_OBJ_PHASE_PT_INDEX moppi on moppi.OBJ_PHASE_ID = mpp1.ID
        where mp1.PROJECT_ORIGINAL_ID = tempObjId AND mpp1.PHASE_ID = phaseId and mp2.APPROVAL_STATUS='已审核'
        group by tempObjPhaseId, product_type_id, product_type_name, operate_attribute_id,
                 product_type_json, operate_attribute_name;
        -- 删除项目阶段信息
        DELETE FROM MDM_OBJ_PHASE_INDEX moppi WHERE moppi.OBJ_PHASE_ID = tempObjPhaseId AND moppi.OBJ_TYPE = 0;
        -- 添加项目阶段信息
        insert into MDM_OBJ_PHASE_INDEX(
            id, build_area, ground_capacity_area, underground_capacity_area, ground_uncapacity_area,
            underground_uncapacity_area, ground_total_build_area, underground_total_build_area, refuge_storey_area,
            mechanical_floor_area, empty_space_area, tower_basement_area, underground_garage_area, storage_area,
            storage_total, total_sale_area, ground_sale_area, underground_sale_area, total_give_area, ground_give_area,
            underground_give_area, total_residence, total_business, ground_carport, residence_bottom_carport,
            parking_garage_carport, underground_rfj_carport, underground_rj_carport, underground_frfj_carport,
            underground_frj_carport, underground_r_sale_carport, underground_frfj_sale_carport, underground_frj_sale_carport,
            carport_total, ground_total_carport, underground_total_carport, underground_total_rj_carport,
            underground_total_frj_carport, underground_total_sale_carport, construction_land_area,
            expropriation_green_space_area, expropriation_road_area, other_expropriation_area, total_road_area,
            total_green_land_area, demonstration_area, plot_ratio, build_density, greening_rate, sale_ratio,
            ground_engine_carport, total_site_area, confiscated_area, overall_floorage_area, total_capacity_area,
            construction_plot_ratio, total_site_area_plot_ratio, construction_build_density, total_site_area_build_density,
            construction_greening_rate, total_site_area_greening_rate, carport_ratio, total_households, obj_phase_id,
            obj_type, jbs_area
        )
        select
            GET_UUID(), sum(build_area) build_area, sum(ground_capacity_area) ground_capacity_area,
            sum(underground_capacity_area) underground_capacity_area,sum(ground_uncapacity_area) ground_uncapacity_area,
            sum(underground_uncapacity_area) underground_uncapacity_area, sum(ground_total_build_area) ground_total_build_area,
            sum(underground_total_build_area) underground_total_build_area, sum(refuge_storey_area) refuge_storey_area,
            sum(mechanical_floor_area) mechanical_floor_area, sum(empty_space_area) empty_space_area,
            sum(tower_basement_area) tower_basement_area,sum(underground_garage_area) underground_garage_area,
            sum(storage_area) storage_area, sum(storage_total) storage_total,sum(total_sale_area) total_sale_area,
            sum(ground_sale_area) ground_sale_area,sum(underground_sale_area) underground_sale_area,
            sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
            sum(underground_give_area) underground_give_area, sum(total_residence) total_residence,
            sum(total_business) total_business, sum(ground_carport) ground_carport,
            sum(residence_bottom_carport) residence_bottom_carport, sum(parking_garage_carport) parking_garage_carport,
            sum(underground_rfj_carport) underground_rfj_carport, sum(underground_rj_carport) underground_rj_carport,
            sum(underground_frfj_carport) underground_frfj_carport,
            sum(underground_frj_carport) underground_frj_carport,
            sum(underground_r_sale_carport) underground_r_sale_carport,
            sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
            sum(underground_frj_sale_carport) underground_frj_sale_carport, sum(carport_total) carport_total,
            sum(ground_total_carport) ground_total_carport, sum(underground_total_carport) underground_total_carport,
            sum(underground_total_rj_carport) underground_total_rj_carport,
            sum(underground_total_frj_carport) underground_total_frj_carport,
            sum(underground_total_sale_carport) underground_total_sale_carport,
            sum(construction_land_area) construction_land_area,
            sum(expropriation_green_space_area) expropriation_green_space_area,
            sum(expropriation_road_area) expropriation_road_area, sum(other_expropriation_area) other_expropriation_area,
            sum(total_road_area) total_road_area, sum(total_green_land_area) total_green_land_area,
            sum(demonstration_area) demonstration_area, sum(plot_ratio) plot_ratio, sum(build_density) build_density,
            sum(greening_rate) greening_rate, sum(sale_ratio) sale_ratio, sum(ground_engine_carport) ground_engine_carport,
            sum(total_site_area) total_site_area, sum(confiscated_area) confiscated_area,
            sum(overall_floorage_area) overall_floorage_area, sum(total_capacity_area) total_capacity_area,
            sum(construction_plot_ratio) construction_plot_ratio, sum(total_site_area_plot_ratio) total_site_area_plot_ratio,
            sum(construction_build_density) construction_build_density,
            sum(total_site_area_build_density) total_site_area_build_density,
            sum(construction_greening_rate) construction_greening_rate,
            sum(total_site_area_greening_rate) total_site_area_greening_rate, sum(carport_ratio) carport_ratio,
            sum(total_households) total_households, tempObjPhaseId objPhaseId,
            '0' obj_type, sum(jbs_area) jbs_area
        from MDM_PARCEL mp1
                 left join MDM_PARCEL_PHASE mpp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
                 left join MDM_PROJECT mp2 on mp1.PROJECT_ID = mp2.ID
                 left join MDM_OBJ_PHASE_INDEX moppi on moppi.OBJ_PHASE_ID = mpp1.ID
        where mp1.PROJECT_ORIGINAL_ID = tempObjId AND mpp1.PHASE_ID = phaseId and mp2.APPROVAL_STATUS='已审核'
        group by tempObjPhaseId;
    end if;
    -- 从楼栋上汇总到分期，最后会修改tempObjType和tempObjId的值 触发从分期汇总到项目
    if tempObjType = 30 then
        -- 获取分期原始ID和分期阶段ID
        begin
            select mpp.ID, mp.PERIOD_ORIGINAL_ID into tempObjPhaseId, tempObjId
            from MDM_BUILD mb
                     left join MDM_PERIOD mp on mb.PERIOD_ID = mp.PERIOD_ORIGINAL_ID
                     inner join MDM_PERIOD_VERSION mpv on mpv.ID = mp.PERIOD_VERSION_ID
                     left join MDM_PERIOD_PHASE mpp on mpp.PERIOD_ID = mp.PERIOD_ORIGINAL_ID
            where mb.id = tempObjId and mpp.PHASE_ID=phaseId and mpv.APPROVAL_STATUS='已审核';
        exception when others then
            code := 10400;
            errMsg := '未找到对应项目信息';
            return;
        end;
        -- 删除分期业态信息
        DELETE FROM MDM_OBJ_PHASE_PT_INDEX moppi WHERE moppi.OBJ_PHASE_ID = tempObjPhaseId AND moppi.OBJ_TYPE = 20;
        -- 添加分期业态信息
        insert into MDM_OBJ_PHASE_PT_INDEX(
            id,  product_type_id, operate_attribute_id,
            operate_attribute_name, build_area, ground_capacity_area, underground_capacity_area,
            ground_uncapacity_area, underground_uncapacity_area, ground_total_build_area,
            underground_total_build_area, refuge_storey_area, mechanical_floor_area, empty_space_area,
            tower_basement_area, underground_garage_area, storage_area, storage_total, total_sale_area,
            ground_sale_area, underground_sale_area, total_give_area, ground_give_area, underground_give_area,
            total_residence, total_business, ground_carport, residence_bottom_carport, parking_garage_carport,
            underground_rfj_carport, underground_rj_carport, underground_frfj_carport, underground_frj_carport,
            underground_r_sale_carport, underground_frfj_sale_carport, underground_frj_sale_carport, carport_total,
            ground_total_carport, underground_total_carport, underground_total_rj_carport,
            underground_total_frj_carport, underground_total_sale_carport, obj_phase_id, obj_type,
            product_type_name, product_type_json)
        select GET_UUID(), product_type_id, operate_attribute_id,
               operate_attribute_name, sum(build_area) build_area, sum(ground_capacity_area) ground_capacity_area,
               sum(underground_capacity_area) underground_capacity_area,
               sum(ground_uncapacity_area) ground_uncapacity_area,
               sum(underground_uncapacity_area) underground_uncapacity_area,
               sum(ground_total_build_area) ground_total_build_area,
               sum(underground_total_build_area) underground_total_build_area, sum(refuge_storey_area) refuge_storey_area,
               sum(mechanical_floor_area) mechanical_floor_area, sum(empty_space_area) empty_space_area,
               sum(tower_basement_area) tower_basement_area, sum(underground_garage_area) underground_garage_area,
               sum(storage_area) storage_area, sum(storage_total) storage_total, sum(total_sale_area) total_sale_area,
               sum(ground_sale_area) ground_sale_area, sum(underground_sale_area) underground_sale_area,
               sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
               sum(underground_give_area) underground_give_area, sum(total_residence) total_residence,
               sum(total_business) total_business,sum(ground_carport) ground_carport,
               sum(residence_bottom_carport) residence_bottom_carport, sum(parking_garage_carport) parking_garage_carport,
               sum(underground_rfj_carport) underground_rfj_carport, sum(underground_rj_carport) underground_rj_carport,
               sum(underground_frfj_carport) underground_frfj_carport, sum(underground_frj_carport) underground_frj_carport,
               sum(underground_r_sale_carport) underground_r_sale_carport,
               sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
               sum(underground_frj_sale_carport) underground_frj_sale_carport, sum(carport_total) carport_total,
               sum(ground_total_carport) ground_total_carport, sum(underground_total_carport) underground_total_carport,
               sum(underground_total_rj_carport) underground_total_rj_carport,
               sum(underground_total_frj_carport) underground_total_frj_carport,
               sum(underground_total_sale_carport) underground_total_sale_carport, tempObjPhaseId obj_phase_id,
               '20' objType, product_type_name, product_type_json
        from MDM_BUILD mb
                 left join MDM_BUILD_PHASE mbp on mbp.BUILD_ID = mb.ID
                 left join MDM_OBJ_PHASE_PT_INDEX moppi on moppi.OBJ_PHASE_ID = mbp.ID
        where mb.PERIOD_ID = tempObjId and mbp.PHASE_ID= phaseId
        group by tempObjPhaseId, product_type_id, product_type_name, operate_attribute_id,
                 product_type_json, operate_attribute_name;
        -- 删除分期阶段信息
        DELETE FROM MDM_OBJ_PHASE_INDEX moppi WHERE moppi.OBJ_PHASE_ID = tempObjPhaseId AND moppi.OBJ_TYPE = 20;
        -- 添加分期阶段信息
        insert into MDM_OBJ_PHASE_INDEX(
            id, build_area, ground_capacity_area, underground_capacity_area, ground_uncapacity_area,
            underground_uncapacity_area, ground_total_build_area, underground_total_build_area, refuge_storey_area,
            mechanical_floor_area, empty_space_area, tower_basement_area, underground_garage_area, storage_area,
            storage_total, total_sale_area, ground_sale_area, underground_sale_area, total_give_area, ground_give_area,
            underground_give_area, total_residence, total_business, ground_carport, residence_bottom_carport,
            parking_garage_carport, underground_rfj_carport, underground_rj_carport, underground_frfj_carport,
            underground_frj_carport, underground_r_sale_carport, underground_frfj_sale_carport, underground_frj_sale_carport,
            carport_total, ground_total_carport, underground_total_carport, underground_total_rj_carport,
            underground_total_frj_carport, underground_total_sale_carport, construction_land_area,
            expropriation_green_space_area, expropriation_road_area, other_expropriation_area, total_road_area,
            total_green_land_area, demonstration_area, plot_ratio, build_density, greening_rate, sale_ratio,
            ground_engine_carport, total_site_area, confiscated_area, overall_floorage_area, total_capacity_area,
            construction_plot_ratio, total_site_area_plot_ratio, construction_build_density, total_site_area_build_density,
            construction_greening_rate, total_site_area_greening_rate, carport_ratio, total_households, obj_phase_id,
            obj_type, jbs_area
        )
        select
            GET_UUID(), sum(build_area) build_area, sum(ground_capacity_area) ground_capacity_area,
            sum(underground_capacity_area) underground_capacity_area,sum(ground_uncapacity_area) ground_uncapacity_area,
            sum(underground_uncapacity_area) underground_uncapacity_area, sum(ground_total_build_area) ground_total_build_area,
            sum(underground_total_build_area) underground_total_build_area, sum(refuge_storey_area) refuge_storey_area,
            sum(mechanical_floor_area) mechanical_floor_area, sum(empty_space_area) empty_space_area,
            sum(tower_basement_area) tower_basement_area,sum(underground_garage_area) underground_garage_area,
            sum(storage_area) storage_area, sum(storage_total) storage_total,sum(total_sale_area) total_sale_area,
            sum(ground_sale_area) ground_sale_area,sum(underground_sale_area) underground_sale_area,
            sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
            sum(underground_give_area) underground_give_area, sum(total_residence) total_residence,
            sum(total_business) total_business, sum(ground_carport) ground_carport,
            sum(residence_bottom_carport) residence_bottom_carport, sum(parking_garage_carport) parking_garage_carport,
            sum(underground_rfj_carport) underground_rfj_carport, sum(underground_rj_carport) underground_rj_carport,
            sum(underground_frfj_carport) underground_frfj_carport,
            sum(underground_frj_carport) underground_frj_carport,
            sum(underground_r_sale_carport) underground_r_sale_carport,
            sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
            sum(underground_frj_sale_carport) underground_frj_sale_carport, sum(carport_total) carport_total,
            sum(ground_total_carport) ground_total_carport, sum(underground_total_carport) underground_total_carport,
            sum(underground_total_rj_carport) underground_total_rj_carport,
            sum(underground_total_frj_carport) underground_total_frj_carport,
            sum(underground_total_sale_carport) underground_total_sale_carport,
            sum(construction_land_area) construction_land_area,
            sum(expropriation_green_space_area) expropriation_green_space_area,
            sum(expropriation_road_area) expropriation_road_area, sum(other_expropriation_area) other_expropriation_area,
            sum(total_road_area) total_road_area, sum(total_green_land_area) total_green_land_area,
            sum(demonstration_area) demonstration_area, sum(plot_ratio) plot_ratio, sum(build_density) build_density,
            sum(greening_rate) greening_rate, sum(sale_ratio) sale_ratio, sum(ground_engine_carport) ground_engine_carport,
            sum(total_site_area) total_site_area, sum(confiscated_area) confiscated_area,
            sum(overall_floorage_area) overall_floorage_area, sum(total_capacity_area) total_capacity_area,
            sum(construction_plot_ratio) construction_plot_ratio, sum(total_site_area_plot_ratio) total_site_area_plot_ratio,
            sum(construction_build_density) construction_build_density,
            sum(total_site_area_build_density) total_site_area_build_density,
            sum(construction_greening_rate) construction_greening_rate,
            sum(total_site_area_greening_rate) total_site_area_greening_rate, sum(carport_ratio) carport_ratio,
            sum(total_households) total_households, tempObjPhaseId objPhaseId,
            '20' obj_type, sum(jbs_area) jbs_area
        from MDM_BUILD mb
                 left join MDM_BUILD_PHASE mbp on mbp.BUILD_ID = mb.ID
                 left join MDM_OBJ_PHASE_INDEX moppi on moppi.OBJ_PHASE_ID = mbp.ID
        where mb.PERIOD_ID = tempObjId and mbp.PHASE_ID= phaseId
        group by tempObjPhaseId;
        -- 更新tempObjType 触发汇总到项目
        tempObjType := 20;
        periodPhaseId := tempObjPhaseId;
    end if;
    -- 从分期上汇总到项目
    if tempObjType = 20 then
        -- 获取项目阶段id和项目原始id
        begin
            select mpp.ID, mpp.PROJ_ID into tempObjPhaseId, tempObjId
            from MDM_PERIOD mp1
                     inner join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
                     left join MDM_PROJECT_PHASE mpp on mpp.PROJ_ID = mpv.PROJECT_ORIGINAL_ID
            where mp1.PERIOD_ORIGINAL_ID=tempObjId
              and mpp.PHASE_ID=phaseId
              and mpv.APPROVAL_STATUS='已审核';
        exception when others then
            code := 0;
            errMsg := '获取分期信息失败';
            return;
        end;
        -- 添加项目业态信息
        DELETE FROM MDM_OBJ_PHASE_PT_INDEX moppi WHERE moppi.OBJ_PHASE_ID = tempObjPhaseId AND moppi.OBJ_TYPE = 0;
        -- 添加分期业态信息
        insert into MDM_OBJ_PHASE_PT_INDEX(
            id,  product_type_id, operate_attribute_id,
            operate_attribute_name, build_area, ground_capacity_area, underground_capacity_area,
            ground_uncapacity_area, underground_uncapacity_area, ground_total_build_area,
            underground_total_build_area, refuge_storey_area, mechanical_floor_area, empty_space_area,
            tower_basement_area, underground_garage_area, storage_area, storage_total, total_sale_area,
            ground_sale_area, underground_sale_area, total_give_area, ground_give_area, underground_give_area,
            total_residence, total_business, ground_carport, residence_bottom_carport, parking_garage_carport,
            underground_rfj_carport, underground_rj_carport, underground_frfj_carport, underground_frj_carport,
            underground_r_sale_carport, underground_frfj_sale_carport, underground_frj_sale_carport, carport_total,
            ground_total_carport, underground_total_carport, underground_total_rj_carport,
            underground_total_frj_carport, underground_total_sale_carport, obj_phase_id, obj_type,
            product_type_name, product_type_json)
        select GET_UUID(), product_type_id, operate_attribute_id,
               operate_attribute_name, sum(build_area) build_area, sum(ground_capacity_area) ground_capacity_area,
               sum(underground_capacity_area) underground_capacity_area,
               sum(ground_uncapacity_area) ground_uncapacity_area,
               sum(underground_uncapacity_area) underground_uncapacity_area,
               sum(ground_total_build_area) ground_total_build_area,
               sum(underground_total_build_area) underground_total_build_area, sum(refuge_storey_area) refuge_storey_area,
               sum(mechanical_floor_area) mechanical_floor_area, sum(empty_space_area) empty_space_area,
               sum(tower_basement_area) tower_basement_area, sum(underground_garage_area) underground_garage_area,
               sum(storage_area) storage_area, sum(storage_total) storage_total, sum(total_sale_area) total_sale_area,
               sum(ground_sale_area) ground_sale_area, sum(underground_sale_area) underground_sale_area,
               sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
               sum(underground_give_area) underground_give_area, sum(total_residence) total_residence,
               sum(total_business) total_business,sum(ground_carport) ground_carport,
               sum(residence_bottom_carport) residence_bottom_carport, sum(parking_garage_carport) parking_garage_carport,
               sum(underground_rfj_carport) underground_rfj_carport, sum(underground_rj_carport) underground_rj_carport,
               sum(underground_frfj_carport) underground_frfj_carport, sum(underground_frj_carport) underground_frj_carport,
               sum(underground_r_sale_carport) underground_r_sale_carport,
               sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
               sum(underground_frj_sale_carport) underground_frj_sale_carport, sum(carport_total) carport_total,
               sum(ground_total_carport) ground_total_carport, sum(underground_total_carport) underground_total_carport,
               sum(underground_total_rj_carport) underground_total_rj_carport,
               sum(underground_total_frj_carport) underground_total_frj_carport,
               sum(underground_total_sale_carport) underground_total_sale_carport, tempObjPhaseId obj_phase_id,
               '0' objType, product_type_name, product_type_json
        from MDM_PERIOD_VERSION mpv
                 left join MDM_PERIOD mp on mp.PERIOD_VERSION_ID = mpv.ID
                 left join MDM_PERIOD_PHASE mpp on mpp.PERIOD_ID = mp.PERIOD_ORIGINAL_ID
                 left join MDM_OBJ_PHASE_PT_INDEX moppi on moppi.OBJ_PHASE_ID = mpp.ID
        where mpv.PROJECT_ORIGINAL_ID=tempObjId and mpp.PHASE_ID=phaseId and mpv.APPROVAL_STATUS='已审核'
        group by product_type_id, operate_attribute_id, operate_attribute_name, tempObjPhaseId,
                 product_type_name, product_type_json;
        -- 删除分期阶段信息
        DELETE FROM MDM_OBJ_PHASE_INDEX moppi WHERE moppi.OBJ_PHASE_ID = tempObjPhaseId AND moppi.OBJ_TYPE = 0;
        -- 添加分期阶段信息
        insert into MDM_OBJ_PHASE_INDEX(
            id, build_area, ground_capacity_area, underground_capacity_area, ground_uncapacity_area,
            underground_uncapacity_area, ground_total_build_area, underground_total_build_area, refuge_storey_area,
            mechanical_floor_area, empty_space_area, tower_basement_area, underground_garage_area, storage_area,
            storage_total, total_sale_area, ground_sale_area, underground_sale_area, total_give_area, ground_give_area,
            underground_give_area, total_residence, total_business, ground_carport, residence_bottom_carport,
            parking_garage_carport, underground_rfj_carport, underground_rj_carport, underground_frfj_carport,
            underground_frj_carport, underground_r_sale_carport, underground_frfj_sale_carport, underground_frj_sale_carport,
            carport_total, ground_total_carport, underground_total_carport, underground_total_rj_carport,
            underground_total_frj_carport, underground_total_sale_carport, construction_land_area,
            expropriation_green_space_area, expropriation_road_area, other_expropriation_area, total_road_area,
            total_green_land_area, demonstration_area, plot_ratio, build_density, greening_rate, sale_ratio,
            ground_engine_carport, total_site_area, confiscated_area, overall_floorage_area, total_capacity_area,
            construction_plot_ratio, total_site_area_plot_ratio, construction_build_density, total_site_area_build_density,
            construction_greening_rate, total_site_area_greening_rate, carport_ratio, total_households, obj_phase_id,
            obj_type, jbs_area
        )
        select
            GET_UUID(), sum(build_area) build_area, sum(ground_capacity_area) ground_capacity_area,
            sum(underground_capacity_area) underground_capacity_area,sum(ground_uncapacity_area) ground_uncapacity_area,
            sum(underground_uncapacity_area) underground_uncapacity_area, sum(ground_total_build_area) ground_total_build_area,
            sum(underground_total_build_area) underground_total_build_area, sum(refuge_storey_area) refuge_storey_area,
            sum(mechanical_floor_area) mechanical_floor_area, sum(empty_space_area) empty_space_area,
            sum(tower_basement_area) tower_basement_area,sum(underground_garage_area) underground_garage_area,
            sum(storage_area) storage_area, sum(storage_total) storage_total,sum(total_sale_area) total_sale_area,
            sum(ground_sale_area) ground_sale_area,sum(underground_sale_area) underground_sale_area,
            sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
            sum(underground_give_area) underground_give_area, sum(total_residence) total_residence,
            sum(total_business) total_business, sum(ground_carport) ground_carport,
            sum(residence_bottom_carport) residence_bottom_carport, sum(parking_garage_carport) parking_garage_carport,
            sum(underground_rfj_carport) underground_rfj_carport, sum(underground_rj_carport) underground_rj_carport,
            sum(underground_frfj_carport) underground_frfj_carport,
            sum(underground_frj_carport) underground_frj_carport,
            sum(underground_r_sale_carport) underground_r_sale_carport,
            sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
            sum(underground_frj_sale_carport) underground_frj_sale_carport, sum(carport_total) carport_total,
            sum(ground_total_carport) ground_total_carport, sum(underground_total_carport) underground_total_carport,
            sum(underground_total_rj_carport) underground_total_rj_carport,
            sum(underground_total_frj_carport) underground_total_frj_carport,
            sum(underground_total_sale_carport) underground_total_sale_carport,
            sum(construction_land_area) construction_land_area,
            sum(expropriation_green_space_area) expropriation_green_space_area,
            sum(expropriation_road_area) expropriation_road_area, sum(other_expropriation_area) other_expropriation_area,
            sum(total_road_area) total_road_area, sum(total_green_land_area) total_green_land_area,
            sum(demonstration_area) demonstration_area, sum(plot_ratio) plot_ratio, sum(build_density) build_density,
            sum(greening_rate) greening_rate, sum(sale_ratio) sale_ratio, sum(ground_engine_carport) ground_engine_carport,
            sum(total_site_area) total_site_area, sum(confiscated_area) confiscated_area,
            sum(overall_floorage_area) overall_floorage_area, sum(total_capacity_area) total_capacity_area,
            sum(construction_plot_ratio) construction_plot_ratio, sum(total_site_area_plot_ratio) total_site_area_plot_ratio,
            sum(construction_build_density) construction_build_density,
            sum(total_site_area_build_density) total_site_area_build_density,
            sum(construction_greening_rate) construction_greening_rate,
            sum(total_site_area_greening_rate) total_site_area_greening_rate, sum(carport_ratio) carport_ratio,
            sum(total_households) total_households, tempObjPhaseId objPhaseId,
            '0' obj_type, sum(jbs_area) jbs_area
        from MDM_PERIOD_VERSION mpv
                 left join MDM_PERIOD mp on mp.PERIOD_VERSION_ID = mpv.ID
                 left join MDM_PERIOD_PHASE mpp on mpp.PERIOD_ID = mp.PERIOD_ORIGINAL_ID
                 left join MDM_OBJ_PHASE_INDEX moppi on moppi.OBJ_PHASE_ID = mpp.ID
        where mpv.PROJECT_ORIGINAL_ID=tempObjId and mpp.PHASE_ID=phaseId and mpv.APPROVAL_STATUS='已审核'
        group by tempObjPhaseId;
    end if;
    -- 指标重新计算
    begin
        update MDM_OBJ_PHASE_INDEX
            -- 车位配比=总车位数/总户数)
        set CARPORT_RATIO = decode(TOTAL_HOUSEHOLDS, 0, 0, TO_CHAR(CARPORT_TOTAL/TOTAL_HOUSEHOLDS, 'FM9990.99')),
            -- 可售比=总可售面积/总建筑面积
            SALE_RATIO = decode(OVERALL_FLOORAGE_AREA, 0, 0, TO_CHAR(TOTAL_SALE_AREA/OVERALL_FLOORAGE_AREA*100,
                                                                     'FM9990.99')),
            --实际容积率(按建设用地面积)=总建筑面积(G)/建设用地面积(B)
            CONSTRUCTION_PLOT_RATIO=decode(CONSTRUCTION_LAND_AREA, 0, 0, OVERALL_FLOORAGE_AREA/CONSTRUCTION_LAND_AREA),
            -- 实际容积率(按总用地面积)=总建筑面积(G)/总用地面积(A)
            TOTAL_SITE_AREA_PLOT_RATIO=decode(TOTAL_SITE_AREA, 0, 0, OVERALL_FLOORAGE_AREA/TOTAL_SITE_AREA),
            -- 实际建筑密度(按建设用地面积）= 建筑占地面积(ZD)/建设用地面积(B)
            CONSTRUCTION_BUILD_DENSITY=decode(CONSTRUCTION_LAND_AREA, 0, 0,TO_CHAR(BUILD_AREA/CONSTRUCTION_LAND_AREA,
                                                                                   'FM9990.99')),
            -- 实际建筑密度（按总用地面积=建筑占地面积(ZD)/总用地面积(A)
            TOTAL_SITE_AREA_BUILD_DENSITY=decode(TOTAL_SITE_AREA, 0, 0, TO_CHAR(BUILD_AREA/TOTAL_SITE_AREA,
                                                                                'FM9990.99')),
            -- 实际绿地率(按建设用地面积）= 代征绿地面积(DL)/建设用地面积(B)
            CONSTRUCTION_GREENING_RATE = decode(CONSTRUCTION_LAND_AREA, 0, 0,
                                                TO_CHAR(EXPROPRIATION_GREEN_SPACE_AREA/CONSTRUCTION_LAND_AREA, 'FM9990.99')),
            -- 检查实际绿地率（按总用地面积）= 代征绿地面积(DL)/总用地面积(A)
            TOTAL_SITE_AREA_GREENING_RATE = decode(TOTAL_SITE_AREA, 0, 0,
                                                   TO_CHAR(EXPROPRIATION_GREEN_SPACE_AREA/TOTAL_SITE_AREA, 'FM9990.99'))
        where OBJ_PHASE_ID = tempObjPhaseId or OBJ_PHASE_ID=periodPhaseId;
    exception when others then
        code := 1;
        errMsg := '更新指标数据失败';
    end;
END;
/

prompt
prompt Creating procedure P_MDM_OBJ_MAINTAIN_BUILD_TOTAL
prompt =================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_MDM_Obj_Maintain_Build_Total (
    phaseId  IN VARCHAR2, --阶段ID
    objId    IN VARCHAR2,--项目原始ID
    items     OUT  SYS_REFCURSOR--消息
)
as
BEGIN
    open items FOR
        select C.ID as "buildId" ,X.PRODUCT_TYPE_NAME AS "productTypeName" ,a.sale_ratio AS "saleRatio",A.total_Sale_Area as "totalSaleArea",
               A.total_Sale_Area AS "totalSaleArea",a.overall_floorage_area AS "overallFloorageArea",C.PERIOD_NAME as "periodName",C.BUILD_NAME as "buildName"
        FROM (select listagg(PRODUCT_TYPE_NAME,',')within group(order by(PRODUCT_TYPE_NAME)) PRODUCT_TYPE_NAME ,OBJ_PHASE_VERSION_ID ,OBJ_TYPE
              FROM MDM_OBJ_PHASE_VERSION_PT_INDEX
              WHERE OBJ_TYPE=30 GROUP BY OBJ_PHASE_VERSION_ID ,OBJ_TYPE) X  RIGHT JOIN MDM_OBJ_PHASE_VERSION_INDEX A

                                                                                       ON A.OBJ_PHASE_VERSION_ID=X.OBJ_PHASE_VERSION_ID and A.OBJ_TYPE=X.OBJ_TYPE
                                                                            LEFT JOIN MDM_OBJ_PHASE_VERSION B
                                                                                      ON A.OBJ_PHASE_VERSION_ID=B.ID AND a.obj_type=30
                                                                                          and B.PHASE_ID=''||phaseId||''
                                                                            RIGHT JOIN (select TO_NUMBER(REGEXP_SUBSTR(CC.BUILD_NAME,'[0-9]+')) as ODID, CC.* from MDM_BUILD CC) C
                                                                                       ON b.obj_id=C.ID
        WHERE C.ID in (select ID
                       FROM MDM_BUILD
                       WHERE PROJ_ID=''||objId||'' and BUILD_STATE=10)
        order by C.ODID;
END P_MDM_Obj_Maintain_Build_Total;
/

prompt
prompt Creating procedure P_SYS_PERIOD_SYNCHRONIZATION
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_SYS_PERIOD_SYNCHRONIZATION AS
--同步主数据数据--分期/分期宗地关系表 强关联所以一起同步
--处理原因：除主数据维护外，其他地方使用项目表混乱。主数据维护外使用项目按设计，应计划统一调整使用 分期、楼栋sys_project,sys_project_stage,sys_build,sys_PARCEL
--作者：陈丽
--日期：2020-06-19
BEGIN------同步主数据项目
----删除项目;
DELETE sys_project_stage;
COMMIT;----新增项目;
INSERT INTO sys_project_stage (id,stage,stage_name,project_state,project_id,is_first_open_period,stage_full_name,ORDER_CODE)
WITH period AS (
    SELECT DISTINCT d.id,d.period_original_id,d.period_name,e.phase_name,f.project_original_id,d.is_first_open_period,d.PERIOD_CODE FROM mdm_period d 
    LEFT JOIN mdm_period_version f ON d.period_version_id=f.id LEFT JOIN (
    SELECT v.period_id,v.phase_name FROM (
    SELECT a.period_id,a.phase_order,b.phase_name FROM mdm_period_phase a LEFT JOIN (
    SELECT id,phase_name FROM mdm_phase) b ON a.phase_id=b.id) v INNER JOIN (
    SELECT period_id,MAX(phase_order) max FROM mdm_period_phase GROUP BY period_id) vv
    ON v.period_id=vv.period_id AND v.phase_order=vv.max) e 
    ON d.period_original_id=e.period_id WHERE f.approval_status='已审核' and d.IS_DELETE=0 ORDER BY f.project_original_id)
SELECT period.period_original_id,period.period_name,period.period_name,period.phase_name,period.project_original_id,period.is_first_open_period,case when period.period_name='无分期' then proj.PROJECT_NAME else proj.PROJECT_NAME||period.period_name end,PERIOD_CODE  FROM period
left join sys_project  proj on period.project_original_id=proj.id;
COMMIT;
--删除分期和宗地的关系
DELETE sys_parcel_obj_r WHERE obj_type='分期';
COMMIT;----新增分期和宗地的关系;
INSERT INTO sys_parcel_obj_r (id,obj_id,obj_type,parcel_id) 
WITH period AS (
    SELECT DISTINCT d.id,d.period_original_id,d.period_name,e.phase_name,f.project_original_id,d.is_first_open_period FROM mdm_period d LEFT JOIN mdm_period_version f ON d.period_version_id=f.id LEFT JOIN (
    SELECT v.period_id,v.phase_name FROM (
    SELECT a.period_id,a.phase_order,b.phase_name FROM mdm_period_phase a LEFT JOIN (
    SELECT id,phase_name FROM mdm_phase) b ON a.phase_id=b.id) v INNER JOIN (
    SELECT period_id,MAX(phase_order) max FROM mdm_period_phase GROUP BY period_id) vv ON v.period_id=vv.period_id AND v.phase_order=vv.max) e ON d.period_original_id=e.period_id WHERE f.approval_status='已审核' ORDER BY f.project_original_id)
SELECT get_uuid () id,period.period_original_id AS obj_id,obj_type,parcel_original_id AS PARCEL_ID FROM mdm_obj_parcel_r r LEFT JOIN period ON r.obj_id=period.id WHERE obj_type='分期' AND period.id IS NOT NULL;
COMMIT;
END P_SYS_PERIOD_SYNCHRONIZATION;
/

prompt
prompt Creating procedure P_MDM_PERIOD_APPROVAL_CB
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_mdm_period_approval_cb (
    id IN VARCHAR2--分期版本表MDM_PERIOD_VERSION 主键id
) 
	--分期审批回调，1、创建动态货值相关版本数据//王传科实现 20191208
	--作者：陈丽
	--日期：2019/12/08	
    --日期：2020/06/22 chenl 更新，审批通过后同步项目到sys_project_stage
 AS
     approvalstatus   VARCHAR2(50);
    i_v_id        VARCHAR2(200) := id;
BEGIN
     BEGIN
    -- 查询是否是审批通过
        SELECT
            APPROVAL_STATUS 
            into approvalstatus
        FROM
              mdm_period_version 
        WHERE
            id = i_v_id;

        IF approvalstatus = '已审核' THEN
            BEGIN
                P_SYS_PERIOD_SYNCHRONIZATION();
            END;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            dbms_output.put_line('失败咯!');
    END;
END p_mdm_period_approval_cb;
/

prompt
prompt Creating procedure P_MDM_PERMIT_APPROVAL_CB
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_MDM_PERMIT_APPROVAL_CB(
    permitId IN VARCHAR2
) AS
    --证照审批回调，1、更新证照涉及楼栋数据到楼栋表
--作者：鲜晓勇
--日期：2020/04/13
    permitType VARCHAR2(200);--证照类型
    permitNo   VARCHAR(200);--证照编号
BEGIN
    --查询证照类型和证照编号
    select permit_type,permit_no into permitType,permitNo from mdm_permit where id=''||permitId||'';
    update mdm_build
    set
        IS_GET_CON_PLAN_PERMIT = case when ''||permitType||''='规划许可证' then '1' else IS_GET_CON_PLAN_PERMIT end,
        GET_CON_PLAN_PERMIT_DATE = case when ''||permitType||''='规划许可证' then SYSDATE else GET_CON_PLAN_PERMIT_DATE end,
        CON_PLAN_PERMIT_NO = case when ''||permitType||''='规划许可证' then ''||permitNo||'' else CON_PLAN_PERMIT_NO end,
        CON_PLAN_PERMIT_ID = case when ''||permitType||''='规划许可证' then ''||permitId||'' else CON_PLAN_PERMIT_ID end,

        IS_GET_CONSTRCUTION_PERMIT = case when ''||permitType||''='施工许可证' then '1' else IS_GET_CONSTRCUTION_PERMIT end,
        GET_CONSTRCUTION_PERMIT_DATE = case when ''||permitType||''='施工许可证' then SYSDATE else GET_CONSTRCUTION_PERMIT_DATE end,
        CONSTRUCTION_PERMIT_NO = case when ''||permitType||''='施工许可证' then ''||permitNo||'' else CONSTRUCTION_PERMIT_NO end,
        CONSTRACUTION_PERMIT_ID = case when ''||permitType||''='施工许可证' then ''||permitId||'' else CONSTRACUTION_PERMIT_ID end,

        IS_GET_PRE_SALE_PERMIT = case when ''||permitType||''='预售许可证' then '1' else IS_GET_PRE_SALE_PERMIT end,
        GET_PRE_SALE_PERMIT_DATE = case when ''||permitType||''='预售许可证' then SYSDATE else GET_PRE_SALE_PERMIT_DATE end,
        PRE_SALE_PERMIT_NO = case when ''||permitType||''='预售许可证' then ''||permitNo||'' else PRE_SALE_PERMIT_NO end,
        PRE_SALE_PERMIT_ID = case when ''||permitType||''='预售许可证' then ''||permitId||'' else PRE_SALE_PERMIT_ID end,

        IS_GET_COMPLETED_PERMIT = case when ''||permitType||''='竣工备案证' then '1' else IS_GET_COMPLETED_PERMIT end,
        GET_COMPLETED_PERMIT_DATE = case when ''||permitType||''='竣工备案证' then SYSDATE else GET_COMPLETED_PERMIT_DATE end,
        GET_COMPLETED_PERMIT_NO = case when ''||permitType||''='竣工备案证' then ''||permitNo||'' else GET_COMPLETED_PERMIT_NO end,
        COMPLETED_PERMIT_ID = case when ''||permitType||''='竣工备案证' then ''||permitId||'' else COMPLETED_PERMIT_ID end
    where id in(
        select pb.bld_id from mdm_permit_bld pb
            inner join mdm_permit pt on pb.permit_id=pt.id
        where pt.id=''||permitid||'' and pt.APPROVAL_STATUS='已审核'
    );
    commit;
END p_mdm_permit_approval_cb;
/

prompt
prompt Creating procedure P_MDM_PHASE
prompt ==============================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_MDM_PHASE (
    projId  IN VARCHAR2, --项目id
    phaseinfo  OUT SYS_REFCURSOR --解析后阶段
)
--阶段解析
--作者：陈丽
--日期：2019/12/07
AS
    CREATE_PHASE_APPROVAL_OBJ_sql          clob;
    CREATE_PHASE_OBJ_sql          clob;
    FORM_TYPE_NAME_sql            clob;
    FORM_GROUP_CODE_sql           clob;
    MAINTAIN_BUILDING_OBJ_sql       clob;  ---楼栋维护 sql
    exec_sql          clob;
BEGIN
    --1.拼接查询语句
    FOR item IN (
        select id,CREATE_PHASE_OBJ,CREATE_PHASE_APPROVAL_OBJ,FORM_TYPE_NAME,FORM_GROUP_CODE,MAINTAIN_BUILDING_OBJ
        from MDM_PHASE)
        LOOP
            CREATE_PHASE_OBJ_sql:=CREATE_PHASE_OBJ_sql||'select a.*,'''||item.id||''' as id from ('||item.CREATE_PHASE_OBJ||') a   union all ';
            CREATE_PHASE_APPROVAL_OBJ_sql:=CREATE_PHASE_APPROVAL_OBJ_sql||'select a.*,'''||item.id||''' as id from ('||item.CREATE_PHASE_APPROVAL_OBJ||') a   union all ';
            FORM_TYPE_NAME_sql:=FORM_TYPE_NAME_sql||'select a.*,'''||item.id||''' as id from ('||item.FORM_TYPE_NAME||') a   union all ';
            FORM_GROUP_CODE_sql:=FORM_GROUP_CODE_sql||'select a.*,'''||item.id||''' as id from ('||item.FORM_GROUP_CODE||') a   union all ';
            MAINTAIN_BUILDING_OBJ_sql:=MAINTAIN_BUILDING_OBJ_sql||'select a.*,'''||item.id||''' as id from ('||item.MAINTAIN_BUILDING_OBJ||') a   union all ';
        END LOOP;
    --2.解析 替换关键字
    CREATE_PHASE_OBJ_sql:= rtrim(replace(CREATE_PHASE_OBJ_sql, '{项目ID}', ''||projId||''),'union all ');
    CREATE_PHASE_APPROVAL_OBJ_sql:= rtrim(replace(CREATE_PHASE_APPROVAL_OBJ_sql, '{项目ID}', ''||projId||''),'union all ');
    FORM_TYPE_NAME_sql:= rtrim(replace(FORM_TYPE_NAME_sql, '{项目ID}', ''||projId||''),'union all ');
    FORM_GROUP_CODE_sql:= rtrim(replace(FORM_GROUP_CODE_sql, '{项目ID}', ''||projId||''),'union all ');
    MAINTAIN_BUILDING_OBJ_sql:= rtrim(replace(MAINTAIN_BUILDING_OBJ_sql, '{项目ID}', ''||projId||''),'union all ');
    exec_sql:='
select MDM_PHASE.id as "id",
    phase_name as "phaseName",
    phase_code as "phaseCode",
    phase_order as "phaseOrder",
    phase_end_obj as "phaseEndObj",
    proj_collect_source as "projCollectSource",
    is_maintain_building as "isMaintainBuilding",
    CREATE_PHASE."objType" as "createPhaseObj",
    CREATE_PHASE_APPROVAL."objType" as "createPhaseApprovalObj",
    FORM_TYPE_NAME."objType" as "formTypeName",
    FORM_GROUP_CODE."objType" as "formGroupCode",
    MAINTAIN_BUILDING."objType" as "maintainBuildingObj"
    from MDM_PHASE
    left join('||CREATE_PHASE_OBJ_sql||' a) CREATE_PHASE
    on MDM_PHASE.id=CREATE_PHASE.id
    left join ('||CREATE_PHASE_APPROVAL_OBJ_sql||' a)CREATE_PHASE_APPROVAL
    on MDM_PHASE.id=CREATE_PHASE_APPROVAL.id
    left join('||FORM_TYPE_NAME_sql||' a) FORM_TYPE_NAME
    on MDM_PHASE.id=FORM_TYPE_NAME.id
    left join('||FORM_GROUP_CODE_sql||' a) FORM_GROUP_CODE
    on MDM_PHASE.id=FORM_GROUP_CODE.id
     left join('||MAINTAIN_BUILDING_OBJ_sql||' a) MAINTAIN_BUILDING
    on MDM_PHASE.id=MAINTAIN_BUILDING.id
    order by phase_code'
    ;
    DBMS_OUTPUT.PUT_LINE('INFO = ' || exec_sql);
    open phaseinfo FOR exec_sql;
END P_MDM_PHASE;
/

prompt
prompt Creating procedure P_MDM_PHASE_APPROVAL_CB
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_mdm_phase_approval_cb (
    id IN VARCHAR2--主数据各阶段对象实例表 MDM_PROJECT_PHASE，MDM_PARCEL_PHASE，MDM_PERIOD_PHASE，MDM_BUILD_PHASE 表 主键id
) 
	--阶段审批接口回调，1、创建动态货值相关版本数据//王传科实现 20191208
	--作者：陈丽
	--日期：2019/12/08	
 AS
BEGIN
    NULL;
END p_mdm_phase_approval_cb;
/

prompt
prompt Creating procedure P_MDM_PHASE_ORDER_CHECK
prompt ==========================================
prompt
create or replace procedure pom0813.P_MDM_PHASE_ORDER_CHECK(
    projectPhaseId in varchar2, --项目阶段id
    info out sys_refcursor --是否全部到达
)
-- 根据项目阶段id判断其下分期是否都到达该阶段 1是 0否
as
    ret integer := 0;
begin
    select
        (case when sum(
                           case when periodPhaseOrder >= projectPhaseOrder then 1 else 0 end
                       ) = count(1) then 1 else 0 end) into ret
    from (
             select mp1.PERIOD_NAME, max(mpp2.PHASE_ORDER) periodPhaseOrder, mpp1.PHASE_ORDER projectPhaseOrder
             from MDM_PROJECT_PHASE mpp1
                      left join MDM_PERIOD mp1 on mp1.PROJECT_ORIGINAL_ID = mpp1.PROJ_ID
                      left join MDM_PERIOD_PHASE mpp2 on mpp2.PERIOD_ID = mp1.PERIOD_ORIGINAL_ID
             where mpp1.ID = ''||projectPhaseId||''
             group by PERIOD_NAME, mpp1.PHASE_ORDER
         );
    open info for select ret as "isAllArrive" from dual;
end;
/

prompt
prompt Creating procedure P_MDM_PHASE_VERSION_DATA_SUM
prompt ===============================================
prompt
create or replace procedure pom0813.P_MDM_PHASE_VERSION_DATA_SUM(
    objId in VARCHAR2, -- 阶段对象id
    objType in INTEGER, -- 阶段类型（项目0、宗地10、分期20、楼栋30）
    phaseId in VARCHAR2, -- 阶段id
    version in varchar2, -- 版本
    errCode out INTEGER,  --错误码
    errMsg out VARCHAR2 -- 错误信息
)
    -- 主数据版本数据汇总
-- @note 脚本初始化
-- @date 2020-06-30 17:39:18
-- @author 韩金明
    is
    objectPhaseId varchar2(36); --项目阶段id
    objectVersionId varchar2(36); --项目版本id
    objectId varchar2(36); -- 项目id
    periodVersionId varchar2(36); -- 分期阶段id
    tempOrgType varchar2(36) := objType;
    tempObjId varchar2(36) := objId;
begin
    insert into TEST(ID,REMARK) values (GET_UUID(), objId);
    insert into TEST(ID,REMARK) values (GET_UUID(), objType);
    insert into TEST(ID,REMARK) values (GET_UUID(), phaseId);
    errCode := 0;
    if objType = 0 then
        errMsg := '汇总来源为项目，跳过';
    end if;
    -- 从宗地汇总
    if objType = 10 then
        -- 查询项目id和阶段id
        select distinct mpp.OBJ_ID, mpp.ID, mpp2.ID into objectId, objectVersionId, objectPhaseId
        from MDM_PARCEL mp1
                 LEFT JOIN MDM_PROJECT mp2 ON mp2.PROJECT_ORIGINAL_ID = mp1.PROJECT_ORIGINAL_ID
                 LEFT JOIN MDM_OBJ_PHASE_VERSION mpp ON mpp.OBJ_ID = mp2.PROJECT_ORIGINAL_ID
            AND mp2.APPROVAL_STATUS = '已审核'
                 LEFT JOIN MDM_PROJECT_PHASE mpp2 ON mpp2.PROJ_ID = mp2.PROJECT_ORIGINAL_ID and mpp2.PHASE_ID = mpp.PHASE_ID
        where mp1.PARCEL_ORIGINAL_ID = objId and mpp.OBJ_PHASE_VERSION = version and mpp.PHASE_ID = phaseId;

        --删除项目业态数据
        delete from MDM_OBJ_PHASE_VERSION_PT_INDEX
        where OBJ_PHASE_ID = objectPhaseId and OBJ_PHASE_VERSION_ID = objectVersionId;
        -- 插入项目业态数据
        insert into MDM_OBJ_PHASE_VERSION_PT_INDEX(
            id, obj_phase_version_id, product_type_id, operate_attribute_id,
            operate_attribute_name, build_area, ground_capacity_area, underground_capacity_area,
            ground_uncapacity_area, underground_uncapacity_area, ground_total_build_area,
            underground_total_build_area, refuge_storey_area, mechanical_floor_area, empty_space_area,
            tower_basement_area, underground_garage_area, storage_area, storage_total, total_sale_area,
            ground_sale_area, underground_sale_area, total_give_area, ground_give_area, underground_give_area,
            total_residence, total_business, ground_carport, residence_bottom_carport, parking_garage_carport,
            underground_rfj_carport, underground_rj_carport, underground_frfj_carport, underground_frj_carport,
            underground_r_sale_carport, underground_frfj_sale_carport, underground_frj_sale_carport, carport_total,
            ground_total_carport, underground_total_carport, underground_total_rj_carport,
            underground_total_frj_carport, underground_total_sale_carport, obj_phase_id, obj_type,
            product_type_name, product_type_json)
        select GET_UUID(), objectVersionId obj_phase_version_id, product_type_id, operate_attribute_id,
               operate_attribute_name, sum(build_area) build_area, sum(ground_capacity_area) ground_capacity_area,
               sum(underground_capacity_area) underground_capacity_area, sum(ground_uncapacity_area) ground_uncapacity_area,
               sum(underground_uncapacity_area) underground_uncapacity_area,
               sum(ground_total_build_area) ground_total_build_area,
               sum(underground_total_build_area) underground_total_build_area, sum(refuge_storey_area) refuge_storey_area,
               sum(mechanical_floor_area) mechanical_floor_area, sum(empty_space_area) empty_space_area,
               sum(tower_basement_area) tower_basement_area, sum(underground_garage_area) underground_garage_area,
               sum(storage_area) storage_area, sum(storage_total) storage_total, sum(total_sale_area) total_sale_area,
               sum(ground_sale_area) ground_sale_area, sum(underground_sale_area) underground_sale_area,
               sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
               sum(underground_give_area) underground_give_area, sum(total_residence) total_residence,
               sum(total_business) total_business,sum(ground_carport) ground_carport,
               sum(residence_bottom_carport) residence_bottom_carport, sum(parking_garage_carport) parking_garage_carport,
               sum(underground_rfj_carport) underground_rfj_carport, sum(underground_rj_carport) underground_rj_carport,
               sum(underground_frfj_carport) underground_frfj_carport, sum(underground_frj_carport) underground_frj_carport,
               sum(underground_r_sale_carport) underground_r_sale_carport,
               sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
               sum(underground_frj_sale_carport) underground_frj_sale_carport, sum(carport_total) carport_total,
               sum(ground_total_carport) ground_total_carport, sum(underground_total_carport) underground_total_carport,
               sum(underground_total_rj_carport) underground_total_rj_carport,
               sum(underground_total_frj_carport) underground_total_frj_carport,
               sum(underground_total_sale_carport) underground_total_sale_carport, objectPhaseId obj_phase_id,
               '0' objType, product_type_name, product_type_json
        from MDM_PARCEL mp1
                 left join MDM_PARCEL_PHASE mpp on mpp.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
                 left join MDM_OBJ_PHASE_VERSION_PT_INDEX mopvpi on mopvpi.OBJ_PHASE_ID = mpp.ID
                 left join MDM_OBJ_PHASE_VERSION mopv on mopv.ID = mopvpi.OBJ_PHASE_VERSION_ID
        where mp1.PROJECT_ORIGINAL_ID = objectId and mpp.PHASE_ID=phaseId
          and mopv.OBJ_PHASE_VERSION = version
        group by PRODUCT_TYPE_ID, OPERATE_ATTRIBUTE_ID,
                 OPERATE_ATTRIBUTE_NAME,PRODUCT_TYPE_NAME,
                 PRODUCT_TYPE_JSON, objectPhaseId, objectVersionId;

        --删除项目阶段数据
        delete from MDM_OBJ_PHASE_VERSION_INDEX
        where OBJ_PHASE_ID = objectPhaseId and OBJ_PHASE_VERSION_ID = objectVersionId;
        --添加项目业态阶段数据
        insert into MDM_OBJ_PHASE_VERSION_INDEX(
            id, build_area, ground_capacity_area, underground_capacity_area, ground_uncapacity_area,
            underground_uncapacity_area, ground_total_build_area, underground_total_build_area, refuge_storey_area,
            mechanical_floor_area, empty_space_area, tower_basement_area, underground_garage_area, storage_area,
            storage_total, total_sale_area, ground_sale_area, underground_sale_area, total_give_area, ground_give_area,
            underground_give_area, total_residence, total_business, ground_carport, residence_bottom_carport,
            parking_garage_carport, underground_rfj_carport, underground_rj_carport, underground_frfj_carport,
            underground_frj_carport, underground_r_sale_carport, underground_frfj_sale_carport, underground_frj_sale_carport,
            carport_total, ground_total_carport, underground_total_carport, underground_total_rj_carport,
            underground_total_frj_carport, underground_total_sale_carport, construction_land_area,
            expropriation_green_space_area, expropriation_road_area, other_expropriation_area, total_road_area,
            total_green_land_area, demonstration_area, plot_ratio, build_density, greening_rate, sale_ratio,
            ground_engine_carport, total_site_area, confiscated_area, overall_floorage_area, total_capacity_area,
            construction_plot_ratio, total_site_area_plot_ratio, construction_build_density, total_site_area_build_density,
            construction_greening_rate, total_site_area_greening_rate, carport_ratio, total_households, obj_phase_id,
            obj_type, jbs_area, OBJ_PHASE_VERSION_ID
        )
        select
            GET_UUID(), sum(build_area) build_area, sum(ground_capacity_area) ground_capacity_area,
            sum(underground_capacity_area) underground_capacity_area,sum(ground_uncapacity_area) ground_uncapacity_area,
            sum(underground_uncapacity_area) underground_uncapacity_area, sum(ground_total_build_area) ground_total_build_area,
            sum(underground_total_build_area) underground_total_build_area, sum(refuge_storey_area) refuge_storey_area,
            sum(mechanical_floor_area) mechanical_floor_area, sum(empty_space_area) empty_space_area,
            sum(tower_basement_area) tower_basement_area,sum(underground_garage_area) underground_garage_area,
            sum(storage_area) storage_area, sum(storage_total) storage_total,sum(total_sale_area) total_sale_area,
            sum(ground_sale_area) ground_sale_area,sum(underground_sale_area) underground_sale_area,
            sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
            sum(underground_give_area) underground_give_area, sum(total_residence) total_residence,
            sum(total_business) total_business, sum(ground_carport) ground_carport,
            sum(residence_bottom_carport) residence_bottom_carport, sum(parking_garage_carport) parking_garage_carport,
            sum(underground_rfj_carport) underground_rfj_carport, sum(underground_rj_carport) underground_rj_carport,
            sum(underground_frfj_carport) underground_frfj_carport,
            sum(underground_frj_carport) underground_frj_carport,
            sum(underground_r_sale_carport) underground_r_sale_carport,
            sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
            sum(underground_frj_sale_carport) underground_frj_sale_carport, sum(carport_total) carport_total,
            sum(ground_total_carport) ground_total_carport, sum(underground_total_carport) underground_total_carport,
            sum(underground_total_rj_carport) underground_total_rj_carport,
            sum(underground_total_frj_carport) underground_total_frj_carport,
            sum(underground_total_sale_carport) underground_total_sale_carport,
            sum(construction_land_area) construction_land_area,
            sum(expropriation_green_space_area) expropriation_green_space_area,
            sum(expropriation_road_area) expropriation_road_area, sum(other_expropriation_area) other_expropriation_area,
            sum(total_road_area) total_road_area, sum(total_green_land_area) total_green_land_area,
            sum(demonstration_area) demonstration_area, sum(plot_ratio) plot_ratio, sum(build_density) build_density,
            sum(greening_rate) greening_rate, sum(sale_ratio) sale_ratio, sum(ground_engine_carport) ground_engine_carport,
            sum(total_site_area) total_site_area, sum(confiscated_area) confiscated_area,
            sum(overall_floorage_area) overall_floorage_area, sum(total_capacity_area) total_capacity_area,
            sum(construction_plot_ratio) construction_plot_ratio, sum(total_site_area_plot_ratio) total_site_area_plot_ratio,
            sum(construction_build_density) construction_build_density,
            sum(total_site_area_build_density) total_site_area_build_density,
            sum(construction_greening_rate) construction_greening_rate,
            sum(total_site_area_greening_rate) total_site_area_greening_rate, sum(carport_ratio) carport_ratio,
            sum(total_households) total_households, objectPhaseId objPhaseId,
            '0' obj_type, sum(jbs_area) jbs_area, objectVersionId OBJ_PHASE_VERSION_ID
        from MDM_PARCEL mp1
                 left join MDM_PARCEL_PHASE mpp on mpp.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
                 left join MDM_OBJ_PHASE_VERSION_INDEX mopvpi on mopvpi.OBJ_PHASE_ID = mpp.ID
                 left join MDM_OBJ_PHASE_VERSION mopv on mopv.ID = mopvpi.OBJ_PHASE_VERSION_ID
        where mp1.PROJECT_ORIGINAL_ID = objectId
          and mpp.PHASE_ID = phaseId
          and mopv.OBJ_PHASE_VERSION = version
        group by objectPhaseId, objectVersionId;
    end if;

    -- 从楼栋汇总
    if objType = 30 then
        -- 获取分期id和分期阶段id
        begin
            select mopv.ID, mp1.PERIOD_ORIGINAL_ID, mpp.ID into objectVersionId, objectId, objectPhaseId
            from MDM_BUILD mb
                     inner join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mb.PERIOD_ID
                     inner join MDM_PERIOD_PHASE mpp on mpp.PERIOD_ID = mp1.PERIOD_ORIGINAL_ID
                     inner join MDM_PERIOD_VERSION mpv on mpv.ID = mp1.PERIOD_VERSION_ID
                     inner join MDM_OBJ_PHASE_VERSION mopv on mopv.OBJ_ID = mb.PERIOD_ID
                and mpp.PHASE_ID = mopv.PHASE_ID
            where mb.id = objId and mpp.PHASE_ID = phaseId and mpv.APPROVAL_STATUS='已审核'
              and mopv.OBJ_PHASE_VERSION = version;
        exception when others then
            errMsg := '楼栋版本阶段存在多条数据';
            errCode := 501;
            return;
        end;


        -- 删除分期业态数据
        delete from MDM_OBJ_PHASE_VERSION_PT_INDEX
        where OBJ_PHASE_ID = objectPhaseId and OBJ_PHASE_VERSION_ID = objectVersionId;
        -- 添加分期业态数据
        insert into MDM_OBJ_PHASE_VERSION_PT_INDEX(
            id, obj_phase_version_id, product_type_id, operate_attribute_id,
            operate_attribute_name, build_area, ground_capacity_area, underground_capacity_area,
            ground_uncapacity_area, underground_uncapacity_area, ground_total_build_area,
            underground_total_build_area, refuge_storey_area, mechanical_floor_area, empty_space_area,
            tower_basement_area, underground_garage_area, storage_area, storage_total, total_sale_area,
            ground_sale_area, underground_sale_area, total_give_area, ground_give_area, underground_give_area,
            total_residence, total_business, ground_carport, residence_bottom_carport, parking_garage_carport,
            underground_rfj_carport, underground_rj_carport, underground_frfj_carport, underground_frj_carport,
            underground_r_sale_carport, underground_frfj_sale_carport, underground_frj_sale_carport, carport_total,
            ground_total_carport, underground_total_carport, underground_total_rj_carport,
            underground_total_frj_carport, underground_total_sale_carport, obj_phase_id, obj_type,
            product_type_name, product_type_json)
        select GET_UUID(), objectVersionId obj_phase_version_id, product_type_id, operate_attribute_id,
               operate_attribute_name, sum(build_area) build_area, sum(ground_capacity_area) ground_capacity_area,
               sum(underground_capacity_area) underground_capacity_area, sum(ground_uncapacity_area) ground_uncapacity_area,
               sum(underground_uncapacity_area) underground_uncapacity_area,
               sum(ground_total_build_area) ground_total_build_area,
               sum(underground_total_build_area) underground_total_build_area, sum(refuge_storey_area) refuge_storey_area,
               sum(mechanical_floor_area) mechanical_floor_area, sum(empty_space_area) empty_space_area,
               sum(tower_basement_area) tower_basement_area, sum(underground_garage_area) underground_garage_area,
               sum(storage_area) storage_area, sum(storage_total) storage_total, sum(total_sale_area) total_sale_area,
               sum(ground_sale_area) ground_sale_area, sum(underground_sale_area) underground_sale_area,
               sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
               sum(underground_give_area) underground_give_area, sum(total_residence) total_residence,
               sum(total_business) total_business,sum(ground_carport) ground_carport,
               sum(residence_bottom_carport) residence_bottom_carport, sum(parking_garage_carport) parking_garage_carport,
               sum(underground_rfj_carport) underground_rfj_carport, sum(underground_rj_carport) underground_rj_carport,
               sum(underground_frfj_carport) underground_frfj_carport, sum(underground_frj_carport) underground_frj_carport,
               sum(underground_r_sale_carport) underground_r_sale_carport,
               sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
               sum(underground_frj_sale_carport) underground_frj_sale_carport, sum(carport_total) carport_total,
               sum(ground_total_carport) ground_total_carport, sum(underground_total_carport) underground_total_carport,
               sum(underground_total_rj_carport) underground_total_rj_carport,
               sum(underground_total_frj_carport) underground_total_frj_carport,
               sum(underground_total_sale_carport) underground_total_sale_carport, objectPhaseId obj_phase_id,
               '20' objType, product_type_name, product_type_json
        from MDM_BUILD mb1
                 left join MDM_BUILD_PHASE mbp on mbp.BUILD_ID = mb1.ID
                 left join MDM_OBJ_PHASE_VERSION_PT_INDEX mopvpi on mopvpi.OBJ_PHASE_ID = mbp.ID
                 left join MDM_OBJ_PHASE_VERSION mopv on mopv.ID = mopvpi.OBJ_PHASE_VERSION_ID
        where mb1.PERIOD_ID = objectId and mbp.PHASE_ID=phaseId
          and mopv.OBJ_PHASE_VERSION = version
        group by PRODUCT_TYPE_ID, OPERATE_ATTRIBUTE_ID,
                 OPERATE_ATTRIBUTE_NAME,PRODUCT_TYPE_NAME,
                 PRODUCT_TYPE_JSON, objectPhaseId, objectVersionId;


        -- 删除分期阶段数据
        delete from MDM_OBJ_PHASE_VERSION_INDEX
        where OBJ_PHASE_ID = objectPhaseId and OBJ_PHASE_VERSION_ID = objectVersionId;
        -- 添加分期阶段数据
        insert into MDM_OBJ_PHASE_VERSION_INDEX(
            id, build_area, ground_capacity_area, underground_capacity_area, ground_uncapacity_area,
            underground_uncapacity_area, ground_total_build_area, underground_total_build_area, refuge_storey_area,
            mechanical_floor_area, empty_space_area, tower_basement_area, underground_garage_area, storage_area,
            storage_total, total_sale_area, ground_sale_area, underground_sale_area, total_give_area, ground_give_area,
            underground_give_area, total_residence, total_business, ground_carport, residence_bottom_carport,
            parking_garage_carport, underground_rfj_carport, underground_rj_carport, underground_frfj_carport,
            underground_frj_carport, underground_r_sale_carport, underground_frfj_sale_carport, underground_frj_sale_carport,
            carport_total, ground_total_carport, underground_total_carport, underground_total_rj_carport,
            underground_total_frj_carport, underground_total_sale_carport, construction_land_area,
            expropriation_green_space_area, expropriation_road_area, other_expropriation_area, total_road_area,
            total_green_land_area, demonstration_area, plot_ratio, build_density, greening_rate, sale_ratio,
            ground_engine_carport, total_site_area, confiscated_area, overall_floorage_area, total_capacity_area,
            construction_plot_ratio, total_site_area_plot_ratio, construction_build_density, total_site_area_build_density,
            construction_greening_rate, total_site_area_greening_rate, carport_ratio, total_households, obj_phase_id,
            obj_type, jbs_area, OBJ_PHASE_VERSION_ID
        )
        select
            GET_UUID(), sum(build_area) build_area, sum(ground_capacity_area) ground_capacity_area,
            sum(underground_capacity_area) underground_capacity_area,sum(ground_uncapacity_area) ground_uncapacity_area,
            sum(underground_uncapacity_area) underground_uncapacity_area, sum(ground_total_build_area) ground_total_build_area,
            sum(underground_total_build_area) underground_total_build_area, sum(refuge_storey_area) refuge_storey_area,
            sum(mechanical_floor_area) mechanical_floor_area, sum(empty_space_area) empty_space_area,
            sum(tower_basement_area) tower_basement_area,sum(underground_garage_area) underground_garage_area,
            sum(storage_area) storage_area, sum(storage_total) storage_total,sum(total_sale_area) total_sale_area,
            sum(ground_sale_area) ground_sale_area,sum(underground_sale_area) underground_sale_area,
            sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
            sum(underground_give_area) underground_give_area, sum(total_residence) total_residence,
            sum(total_business) total_business, sum(ground_carport) ground_carport,
            sum(residence_bottom_carport) residence_bottom_carport, sum(parking_garage_carport) parking_garage_carport,
            sum(underground_rfj_carport) underground_rfj_carport, sum(underground_rj_carport) underground_rj_carport,
            sum(underground_frfj_carport) underground_frfj_carport,
            sum(underground_frj_carport) underground_frj_carport,
            sum(underground_r_sale_carport) underground_r_sale_carport,
            sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
            sum(underground_frj_sale_carport) underground_frj_sale_carport, sum(carport_total) carport_total,
            sum(ground_total_carport) ground_total_carport, sum(underground_total_carport) underground_total_carport,
            sum(underground_total_rj_carport) underground_total_rj_carport,
            sum(underground_total_frj_carport) underground_total_frj_carport,
            sum(underground_total_sale_carport) underground_total_sale_carport,
            sum(construction_land_area) construction_land_area,
            sum(expropriation_green_space_area) expropriation_green_space_area,
            sum(expropriation_road_area) expropriation_road_area, sum(other_expropriation_area) other_expropriation_area,
            sum(total_road_area) total_road_area, sum(total_green_land_area) total_green_land_area,
            sum(demonstration_area) demonstration_area, sum(plot_ratio) plot_ratio, sum(build_density) build_density,
            sum(greening_rate) greening_rate, sum(sale_ratio) sale_ratio, sum(ground_engine_carport) ground_engine_carport,
            sum(total_site_area) total_site_area, sum(confiscated_area) confiscated_area,
            sum(overall_floorage_area) overall_floorage_area, sum(total_capacity_area) total_capacity_area,
            sum(construction_plot_ratio) construction_plot_ratio, sum(total_site_area_plot_ratio) total_site_area_plot_ratio,
            sum(construction_build_density) construction_build_density,
            sum(total_site_area_build_density) total_site_area_build_density,
            sum(construction_greening_rate) construction_greening_rate,
            sum(total_site_area_greening_rate) total_site_area_greening_rate, sum(carport_ratio) carport_ratio,
            sum(total_households) total_households, objectPhaseId objPhaseId,
            '20' obj_type, sum(jbs_area) jbs_area, objectVersionId OBJ_PHASE_VERSION_ID
        from MDM_BUILD mb1
                 left join MDM_BUILD_PHASE mbp on mbp.BUILD_ID = mb1.ID
                 left join MDM_OBJ_PHASE_VERSION_INDEX mopvpi on mopvpi.OBJ_PHASE_ID = mbp.ID
                 left join MDM_OBJ_PHASE_VERSION mopv on mopv.ID = mopvpi.OBJ_PHASE_VERSION_ID
        where mb1.PERIOD_ID = objectId
          and mbp.PHASE_ID=phaseId
          and mopv.OBJ_PHASE_VERSION = version
        group by objectVersionId, objectPhaseId;

        --更新tempOrgType和tempOrgId 进行分期向项目汇总
        tempOrgType := 20;
        tempObjId := objectId;
    end if;

    -- 从分期汇总
    if tempOrgType = 20 then
        -- 获取项目id,项目版本id和项目阶段id
        begin
            select mpp2.ID, mpv.PROJECT_ORIGINAL_ID, mpp1.ID, mpv.ID
            into objectVersionId, objectId, objectPhaseId, periodVersionId
            from MDM_PERIOD mp1
                     left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
                     left join MDM_PROJECT_PHASE mpp1 on mpp1.PROJ_ID = mpv.PROJECT_ORIGINAL_ID
                     left join MDM_OBJ_PHASE_VERSION mpp2 on mpp2.OBJ_ID = mpp1.PROJ_ID and mpp1.PHASE_ID = mpp2.PHASE_ID
            where mp1.PERIOD_ORIGINAL_ID = tempObjId
              and mpp1.PHASE_ID=phaseId
              and mpv.APPROVAL_STATUS='已审核' and OBJ_PHASE_VERSION=version;
        exception when others then
            errMsg := '分期阶段版本存在多条数据';
            errCode := 0;
            return;
        end;

        -- 删除项目业态数据
        delete from MDM_OBJ_PHASE_VERSION_PT_INDEX
        where OBJ_PHASE_ID = objectPhaseId and OBJ_PHASE_VERSION_ID = objectVersionId;
        -- 添加项目业态数据
        insert into MDM_OBJ_PHASE_VERSION_PT_INDEX(
            id, obj_phase_version_id, product_type_id, operate_attribute_id,
            operate_attribute_name, build_area, ground_capacity_area, underground_capacity_area,
            ground_uncapacity_area, underground_uncapacity_area, ground_total_build_area,
            underground_total_build_area, refuge_storey_area, mechanical_floor_area, empty_space_area,
            tower_basement_area, underground_garage_area, storage_area, storage_total, total_sale_area,
            ground_sale_area, underground_sale_area, total_give_area, ground_give_area, underground_give_area,
            total_residence, total_business, ground_carport, residence_bottom_carport, parking_garage_carport,
            underground_rfj_carport, underground_rj_carport, underground_frfj_carport, underground_frj_carport,
            underground_r_sale_carport, underground_frfj_sale_carport, underground_frj_sale_carport, carport_total,
            ground_total_carport, underground_total_carport, underground_total_rj_carport,
            underground_total_frj_carport, underground_total_sale_carport, obj_phase_id, obj_type,
            product_type_name, product_type_json)
        select GET_UUID(), objectVersionId obj_phase_version_id, product_type_id, operate_attribute_id,
               operate_attribute_name, sum(build_area) build_area, sum(ground_capacity_area) ground_capacity_area,
               sum(underground_capacity_area) underground_capacity_area, sum(ground_uncapacity_area) ground_uncapacity_area,
               sum(underground_uncapacity_area) underground_uncapacity_area,
               sum(ground_total_build_area) ground_total_build_area,
               sum(underground_total_build_area) underground_total_build_area, sum(refuge_storey_area) refuge_storey_area,
               sum(mechanical_floor_area) mechanical_floor_area, sum(empty_space_area) empty_space_area,
               sum(tower_basement_area) tower_basement_area, sum(underground_garage_area) underground_garage_area,
               sum(storage_area) storage_area, sum(storage_total) storage_total, sum(total_sale_area) total_sale_area,
               sum(ground_sale_area) ground_sale_area, sum(underground_sale_area) underground_sale_area,
               sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
               sum(underground_give_area) underground_give_area, sum(total_residence) total_residence,
               sum(total_business) total_business,sum(ground_carport) ground_carport,
               sum(residence_bottom_carport) residence_bottom_carport, sum(parking_garage_carport) parking_garage_carport,
               sum(underground_rfj_carport) underground_rfj_carport, sum(underground_rj_carport) underground_rj_carport,
               sum(underground_frfj_carport) underground_frfj_carport, sum(underground_frj_carport) underground_frj_carport,
               sum(underground_r_sale_carport) underground_r_sale_carport,
               sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
               sum(underground_frj_sale_carport) underground_frj_sale_carport, sum(carport_total) carport_total,
               sum(ground_total_carport) ground_total_carport, sum(underground_total_carport) underground_total_carport,
               sum(underground_total_rj_carport) underground_total_rj_carport,
               sum(underground_total_frj_carport) underground_total_frj_carport,
               sum(underground_total_sale_carport) underground_total_sale_carport, objectPhaseId obj_phase_id,
               '0' objType, product_type_name, product_type_json
        from MDM_OBJ_PHASE_VERSION_PT_INDEX mopvpi
                 inner join MDM_OBJ_PHASE_VERSION mopv on mopv.ID = OBJ_PHASE_VERSION_ID
                 left join MDM_PERIOD mp on mp.PERIOD_ORIGINAL_ID = mopv.OBJ_ID
                 left join MDM_PERIOD_PHASE mpp1 on mpp1.ID = mopv.OBJ_PHASE_ID
        where mopv.OBJ_PHASE_VERSION=version
          and mp.PERIOD_VERSION_ID = periodVersionId
          and mopv.PHASE_ID = phaseId
        group by PRODUCT_TYPE_ID, OPERATE_ATTRIBUTE_ID,
                 OPERATE_ATTRIBUTE_NAME,PRODUCT_TYPE_NAME,
                 PRODUCT_TYPE_JSON, objectPhaseId, objectVersionId;

        -- 删除项目阶段数据
        delete from MDM_OBJ_PHASE_VERSION_INDEX
        where OBJ_PHASE_ID = objectPhaseId and OBJ_PHASE_VERSION_ID = objectVersionId;
        -- 添加项目业态数据
        insert into MDM_OBJ_PHASE_VERSION_INDEX(
            id, build_area, ground_capacity_area, underground_capacity_area, ground_uncapacity_area,
            underground_uncapacity_area, ground_total_build_area, underground_total_build_area, refuge_storey_area,
            mechanical_floor_area, empty_space_area, tower_basement_area, underground_garage_area, storage_area,
            storage_total, total_sale_area, ground_sale_area, underground_sale_area, total_give_area, ground_give_area,
            underground_give_area, total_residence, total_business, ground_carport, residence_bottom_carport,
            parking_garage_carport, underground_rfj_carport, underground_rj_carport, underground_frfj_carport,
            underground_frj_carport, underground_r_sale_carport, underground_frfj_sale_carport, underground_frj_sale_carport,
            carport_total, ground_total_carport, underground_total_carport, underground_total_rj_carport,
            underground_total_frj_carport, underground_total_sale_carport, construction_land_area,
            expropriation_green_space_area, expropriation_road_area, other_expropriation_area, total_road_area,
            total_green_land_area, demonstration_area, plot_ratio, build_density, greening_rate, sale_ratio,
            ground_engine_carport, total_site_area, confiscated_area, overall_floorage_area, total_capacity_area,
            construction_plot_ratio, total_site_area_plot_ratio, construction_build_density, total_site_area_build_density,
            construction_greening_rate, total_site_area_greening_rate, carport_ratio, total_households, obj_phase_id,
            obj_type, jbs_area, OBJ_PHASE_VERSION_ID
        )
        select
            GET_UUID(), sum(build_area) build_area, sum(ground_capacity_area) ground_capacity_area,
            sum(underground_capacity_area) underground_capacity_area,sum(ground_uncapacity_area) ground_uncapacity_area,
            sum(underground_uncapacity_area) underground_uncapacity_area, sum(ground_total_build_area) ground_total_build_area,
            sum(underground_total_build_area) underground_total_build_area, sum(refuge_storey_area) refuge_storey_area,
            sum(mechanical_floor_area) mechanical_floor_area, sum(empty_space_area) empty_space_area,
            sum(tower_basement_area) tower_basement_area,sum(underground_garage_area) underground_garage_area,
            sum(storage_area) storage_area, sum(storage_total) storage_total,sum(total_sale_area) total_sale_area,
            sum(ground_sale_area) ground_sale_area,sum(underground_sale_area) underground_sale_area,
            sum(total_give_area) total_give_area, sum(ground_give_area) ground_give_area,
            sum(underground_give_area) underground_give_area, sum(total_residence) total_residence,
            sum(total_business) total_business, sum(ground_carport) ground_carport,
            sum(residence_bottom_carport) residence_bottom_carport, sum(parking_garage_carport) parking_garage_carport,
            sum(underground_rfj_carport) underground_rfj_carport, sum(underground_rj_carport) underground_rj_carport,
            sum(underground_frfj_carport) underground_frfj_carport,
            sum(underground_frj_carport) underground_frj_carport,
            sum(underground_r_sale_carport) underground_r_sale_carport,
            sum(underground_frfj_sale_carport) underground_frfj_sale_carport,
            sum(underground_frj_sale_carport) underground_frj_sale_carport, sum(carport_total) carport_total,
            sum(ground_total_carport) ground_total_carport, sum(underground_total_carport) underground_total_carport,
            sum(underground_total_rj_carport) underground_total_rj_carport,
            sum(underground_total_frj_carport) underground_total_frj_carport,
            sum(underground_total_sale_carport) underground_total_sale_carport,
            sum(construction_land_area) construction_land_area,
            sum(expropriation_green_space_area) expropriation_green_space_area,
            sum(expropriation_road_area) expropriation_road_area, sum(other_expropriation_area) other_expropriation_area,
            sum(total_road_area) total_road_area, sum(total_green_land_area) total_green_land_area,
            sum(demonstration_area) demonstration_area, sum(plot_ratio) plot_ratio, sum(build_density) build_density,
            sum(greening_rate) greening_rate, sum(sale_ratio) sale_ratio, sum(ground_engine_carport) ground_engine_carport,
            sum(total_site_area) total_site_area, sum(confiscated_area) confiscated_area,
            sum(overall_floorage_area) overall_floorage_area, sum(total_capacity_area) total_capacity_area,
            sum(construction_plot_ratio) construction_plot_ratio, sum(total_site_area_plot_ratio) total_site_area_plot_ratio,
            sum(construction_build_density) construction_build_density,
            sum(total_site_area_build_density) total_site_area_build_density,
            sum(construction_greening_rate) construction_greening_rate,
            sum(total_site_area_greening_rate) total_site_area_greening_rate, sum(carport_ratio) carport_ratio,
            sum(total_households) total_households, objectPhaseId objPhaseId,
            '0' obj_type, sum(jbs_area) jbs_area, objectVersionId OBJ_PHASE_VERSION_ID
        from MDM_OBJ_PHASE_VERSION_INDEX mopvpi
                 inner join MDM_OBJ_PHASE_VERSION mopv on mopv.ID = OBJ_PHASE_VERSION_ID
                 left join MDM_PERIOD mp on mp.PERIOD_ORIGINAL_ID = mopv.OBJ_ID
                 left join MDM_PERIOD_PHASE mpp1 on mpp1.ID = mopv.OBJ_PHASE_ID
        where mopv.OBJ_PHASE_VERSION=version
          and mp.PERIOD_VERSION_ID = periodVersionId
          and mopv.PHASE_ID = phaseId
        group by objectPhaseId, objectVersionId;
    end if;
end;
/

prompt
prompt Creating procedure P_SYS_PROJ_SYNCHRONIZATION
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_SYS_PROJ_SYNCHRONIZATION AS
--同步主数据数据---项目、宗地 强关联所以一起同步
--处理原因：除主数据维护外，其他地方使用项目表混乱。主数据维护外使用项目按设计，应计划统一调整使用 分期、楼栋sys_project,sys_project_stage,sys_build,sys_PARCEL
--作者：陈丽
--日期：2020-06-19
BEGIN------同步主数据项目

------更新项目全路径
update mdm_project set ORDER_HIERARCHY_CODE=(
select code from (
select p.id,u.ORDER_HIERARCHY_CODE||'.'||PROJECT_CODE as code from  mdm_project p
left join SYS_BUSINESS_UNIT u on  p.COMPANY_ID=u.id) s where mdm_project.id=s.id );
commit;
----删除项目;
DELETE sys_project;
COMMIT;----新增项目;
INSERT INTO sys_project (sn,---排序
id,---主键
project_name,---项目名称
update_date,---更新时间
project_code,---项目编号
----------------
unit_id,---公司id
unit_name,---公司名称
project_state,---项目状态
address,---地址
city_code,---城市编号
----------------
city_name,---城市名称
update_user_id,---更新人id
update_user,---更新人
take_date,---获得日期
order_hierarchy_code,---全路径排序编码//黄伟1227增加
----------------
project_reply_name,---项目批复名称///陈丽20200619新增
project_popularize_name,---项目推广名称///陈丽20200619新增
is_cooperate,---是否合作项目///陈丽20200619新增

PROJ_COOPERATE,
PROJ_COOPERATE_ID,
---------------------- 主数据无
    project_get_time,
    company_id,
    company_name,
    legal_person_company_id,
    legal_person_company,
    legal_person_company_code,
    real_estate_share_ratio,
    series_ratio,
    person_liable,
    partners1,
    partners2,
    partners3,
    place_id,
    province_name,
    place_name,
    plane_figure,
    proj_address,
    approval_status,
    approval_time,
    approver_id,
    approver,
    remark,
    created,
    creator,
    creator_id,
    first_proj_approval_time,
    first_period_approval_time,
    project_original_id,
    project_version,
    province_id,
    city_id,
    create_station_id,
    create_station,
    modified,
    modifier_id,
    modifier
) WITH proj AS (
    SELECT d.id,d.project_name,d.project_code,---------------------
    e.phase_name,d.city_name,d.order_hierarchy_code,---------------------
    d.project_reply_name,d.project_popularize_name,d.is_cooperate,d.PROJ_COOPERATE,
    d.PROJ_COOPERATE_ID,
d.Project_Get_Time,
d.Company_Id,
d.Company_Name,
d.Legal_Person_Company_Id,
d.Legal_Person_Company,
d.Legal_Person_Company_Code,
d.Real_Estate_Share_Ratio,
d.Series_Ratio,
d.Person_Liable,
d.Partners1,
d.Partners2,
d.Partners3,
d.Place_Id,
d.Province_Name,
d.Place_Name,
d.Plane_Figure,
d.Proj_Address,
d.Approval_Status,
d.Approval_Time,
d.Approver_Id,
d.Approver,
d.Remark,
d.Created,
d.Creator,
d.Creator_Id,
d.First_Proj_Approval_Time,
d.First_Period_Approval_Time,
d.Project_Original_Id,
d.Project_Version,
d.Province_Id,
d.City_Id,
d.Create_Station_Id,
d.Create_Station,
d.Modified,
d.Modifier_Id,
d.Modifier
    
    FROM mdm_project d LEFT JOIN (
    SELECT v.proj_id,v.phase_name FROM (
    SELECT a.proj_id,a.phase_order,b.phase_name FROM mdm_project_phase a LEFT JOIN (
    SELECT id,phase_name FROM mdm_phase) b ON a.phase_id=b.id) v INNER JOIN (
    SELECT proj_id,MAX(phase_order) max FROM mdm_project_phase GROUP BY proj_id) vv ON v.proj_id=vv.proj_id AND v.phase_order=vv.max) e ON d.project_original_id=e.proj_id WHERE d.approval_status='已审核' ORDER BY d.project_code)
SELECT ROWNUM sn,project_original_id AS id,project_name AS name,modified AS updatedate,project_code AS code,company_id AS unitid,company_name AS unitname,phase_name AS state,proj_address AS address,city_id AS citycode,city_name AS cityname,modifier_id AS updateuserid,modifier AS updateuser,project_get_time AS takedate,order_hierarchy_code,project_reply_name,project_popularize_name,is_cooperate,PROJ_COOPERATE,
PROJ_COOPERATE_ID,
proj.project_get_time,
proj.company_id,
proj.company_name,
proj.legal_person_company_id,
proj.legal_person_company,
proj.legal_person_company_code,
proj.real_estate_share_ratio,
proj.series_ratio,
proj.person_liable,
proj.partners1,
proj.partners2,
proj.partners3,
proj.place_id,
proj.province_name,
proj.place_name,
proj.plane_figure,
proj.proj_address,
proj.approval_status,
proj.approval_time,
proj.approver_id,
proj.approver,
proj.remark,
proj.created,
proj.creator,
proj.creator_id,
proj.first_proj_approval_time,
proj.first_period_approval_time,
proj.project_original_id,
proj.project_version,
proj.province_id,
proj.city_id,
proj.create_station_id,
proj.create_station,
proj.modified,
proj.modifier_id,
proj.modifier
FROM proj ORDER BY ROWNUM;
COMMIT;--删除宗地
DELETE SYS_PARCEL;---同步宗地
INSERT INTO sys_parcel (id,parcel_name,project_id,land_transfer_contract_code,contract_total_price,land_transfer_method,land_transferer,land_get_date,hand_over_date,land_state,land_address,land_useage,province_name,city_name,district_name,remarks,province_id,city_id,district_id)
WITH proj AS (
    SELECT d.id FROM mdm_project d LEFT JOIN (
    SELECT v.proj_id,v.phase_name FROM (
    SELECT a.proj_id,a.phase_order,b.phase_name FROM mdm_project_phase a LEFT JOIN (
    SELECT id,phase_name FROM mdm_phase) b ON a.phase_id=b.id) v INNER JOIN (
    SELECT proj_id,MAX(phase_order) max FROM mdm_project_phase GROUP BY proj_id) vv ON v.proj_id=vv.proj_id AND v.phase_order=vv.max) e ON d.project_original_id=e.proj_id WHERE d.approval_status='已审核' ORDER BY d.project_code)
SELECT PARCEL_ORIGINAL_ID,parcel_name,PROJECT_ORIGINAL_ID,land_transfer_contract_code,contract_total_price,land_transfer_method,land_transferer,land_get_date,hand_over_date,land_state,land_address,land_useage,province_name,city_name,district_name,remarks,province_id,city_id,district_id

FROM MDM_PARCEL pa LEFT JOIN proj p ON pa.PROJECT_ID=p.id where  p.id is not null and PARCEL_ORIGINAL_ID  is not null;
commit;
END P_SYS_PROJ_SYNCHRONIZATION;
/

prompt
prompt Creating procedure P_MDM_PROJECT_APPROVAL_CB
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_mdm_project_approval_cb (
    id IN VARCHAR2--项目表MDM_PROJECT 主键id
)
    --项目审批回调，1、创建动态货值相关版本数据//王传科实现 20191208
    --作者：陈丽
    --日期：2019/12/08
    --日期：2020/06/22 chenl 更新，审批通过后同步项目到sys_project
 AS
    approvalstatus   VARCHAR2(50);
    i_proj_id        VARCHAR2(200) := id;
BEGIN
    BEGIN
    -- 查询是否是审批通过
        SELECT
            approval_status 
            into approvalstatus
        FROM
            mdm_project
        WHERE
            id = i_proj_id;

        IF approvalstatus = '已审核' THEN
            BEGIN
                p_sys_proj_synchronization();
            END;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            dbms_output.put_line('失败咯!');
    END;
END p_mdm_project_approval_cb;
/

prompt
prompt Creating procedure P_MDM_PROJECT_FROM_SERIES
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_MDM_PROJECT_FROM_SERIES is
begin
    update MDM_PROJECT mp
    set mp.SERIES_RATIO=(
        select t.seriesRatio from T_MDM_PROJECT_SERIES_RATIO t
        where t.projectId = mp.ID
    ) where EXISTS(select 1 from T_MDM_PROJECT_SERIES_RATIO t where t.projectId = mp.ID);
end;
/

prompt
prompt Creating procedure P_SYS_GET_PROJ_TREE_SPID
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_sys_get_proj_tree_spid (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    auth_spid           OUT           VARCHAR2
) AS
--获取有权限的项目树
--作者：谷国斌
--日期：2019/12/14
    rulevalue   VARCHAR2(50);
    authcount   INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    spid        VARCHAR2(36);--使用临时表的批次号
BEGIN
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;

--获取隔离规则：

    SELECT
        isolation_rule_value
    INTO rulevalue
    FROM
        sys_data_auth_biz
    WHERE
        biz_obj_code = bizcode;

    IF rulevalue = '全集团' THEN
        INSERT INTO tmp_proj_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            full_name,
            is_end,
            city_name,
            company_id,
            order_code
        )
            SELECT
                spid,
                org_id,
                org_name,
                org_type,
                parent_id,
                full_name,
                is_end,
                city_name,
                company_id,
                sn
            FROM
                v_sys_project;

    ELSE 
--插入本公司的项目
        INSERT INTO tmp_proj_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            full_name,
            is_end,
            city_name,
            company_id,
            order_code
        )
            SELECT
                spid,
                org_id,
                org_name,
                org_type,
                parent_id,
                full_name,
                is_end,
                city_name,
                company_id,
                sn
            FROM
                v_sys_project
            WHERE
                company_id = companyid;

--插入数据授权的数据：

        DECLARE
            ownerid     VARCHAR2(36);
            oenertype   NVARCHAR2(50);
            CURSOR cursor_company IS
            SELECT DISTINCT
                auth_owner_id,
                auth_owner_type
            FROM
                sys_data_auth
            WHERE
                auth_biz_code = bizcode
                AND is_disabled = 0
                AND nvl(auth_type, '项目') = '项目';

        BEGIN   

            --打开游标
            OPEN cursor_company;
            LOOP
                FETCH cursor_company INTO
                    ownerid,
                    oenertype;
                EXIT WHEN cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                IF oenertype = '公司' OR oenertype = '集团' THEN
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                        AND id = companyid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF oenertype = '部门' THEN
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 0
                        AND id = deptid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                    INSERT INTO tmp_auth_owner (
                        id,
                        auth_owner_id,
                        auth_owner_type
                    ) VALUES (
                        spid,
                        ownerid,
                        oenertype
                    );

                END IF;

            END LOOP;

            CLOSE cursor_company;
        END;   

          --获取有权限的公司及其父级：            

        DECLARE
            ownerid2 VARCHAR2(36);
            CURSOR cursor_auth IS
            SELECT
                auth_owner_id
            FROM
                tmp_auth_owner
            WHERE
                id = spid;

        BEGIN   

                    --打开游标
            OPEN cursor_auth;
            LOOP
                FETCH cursor_auth INTO ownerid2;
                EXIT WHEN cursor_auth%notfound;


                            --授权对象为公司：
                            --取授权公司的子级：
                INSERT INTO tmp_proj_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    full_name,
                    is_end,
                    city_name,
                    company_id,
                    order_code
                )
                    SELECT
                        spid,
                        org_id,
                        org_name,
                        org_type,
                        parent_id,
                        full_name,
                        is_end,
                        city_name,
                        company_id,
                        sn
                    FROM
                        v_sys_project
                    WHERE
                        company_id IN (
                            SELECT
                                id
                            FROM
                                sys_business_unit
                            WHERE
                                is_company = 1
                            START WITH
                                id IN (
                                    SELECT DISTINCT
                                        auth_scope_id
                                    FROM
                                        sys_data_auth
                                    WHERE
                                        auth_biz_code = bizcode
                                        AND is_disabled = 0
                                        AND auth_owner_id = ownerid2
                                        AND auth_scope_type IN (
                                            '公司',
                                            '集团'
                                        )
                                        AND nvl(auth_type, '项目') = '项目'
                                )
                            CONNECT BY
                                PRIOR id = parent_id
                        );



                               --授权对应为项目：

                INSERT INTO tmp_proj_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    full_name,
                    is_end,
                    city_name,
                    company_id,
                    order_code
                )
                    SELECT
                        spid,
                        org_id,
                        org_name,
                        org_type,
                        parent_id,
                        full_name,
                        is_end,
                        city_name,
                        company_id,
                        sn
                    FROM
                        v_sys_project
                    WHERE
                        project_id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type = '项目'
                                AND nvl(auth_type, '项目') = '项目'
                        );

            END LOOP;
            CLOSE cursor_auth;
        END;
    END IF;
--    OPEN data_auth_info FOR SELECT DISTINCT
--                               a.org_id         AS orgid,
--                               a.org_name       AS orgname,
--                               a.org_type       AS orgtype,
--                               a.parent_id      AS parentid,
--                               a.full_name      AS fullname,
--                               a.is_end         AS isend,
--                               a.city_name      AS cityname,
--                               a.company_id     AS companyid,
--                               b.company_type   AS companytype,
--                               a.order_code     AS ordercode
--                           FROM
--                               tmp_proj_tree       a
--                               LEFT JOIN sys_business_unit   b ON a.org_id = b.id
--                           ORDER BY
--                               a.order_code;
        auth_spid:=spid;
END p_sys_get_proj_tree_spid;
/

prompt
prompt Creating procedure P_MDM_PROJECT_STAGE_BY_BIZID
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_mdm_project_stage_by_bizId(
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    bizId   IN     VARCHAR2,
    orgType  IN   VARCHAR2,
    dataList  out SYS_REFCURSOR
) AS
auth_spid varchar2(50);
rowcount number;
projectNmae varchar(100);
begin
if orgType ='10' then
select PROJECT_NAME into projectNmae from sys_project where id=bizId;
open dataList for
select * from (select  id as "id",projectNmae||'_'||STAGE_NAME "text",'' as "parentId",to_char(SN) as sort from sys_project_stage where PROJECT_ID=bizId
union 
select  mdm_build.id as "id",mdm_build.BUILD_NAME "text",mdm_build.PERIOD_ID as "parentId",replace(lpad(mdm_build.BUILD_NAME,5),' ','0')  as sort from sys_project_stage left join mdm_build on sys_project_stage.id=mdm_build.PERIOD_ID  
where PROJECT_ID=bizId ) tab where tab."id" is not null order by tab.sort;
else
P_SYS_GET_PROJ_TREE_SPID(
    USERID => USERID,
    STATIONID => STATIONID,
    DEPTID => DEPTID,
    COMPANYID => COMPANYID,
    BIZCODE => BIZCODE,
    AUTH_SPID => AUTH_SPID
  );
  select count(1) into rowcount from tmp_company_tree;
  if bizId ='003200000000000000000000000000' then
            open dataList for
            select * from
           (SELECT 
                 tmp_proj_tree.org_id       AS "id",
                 sys_project.PROJECT_NAME||'_'||tmp_proj_tree.org_name     AS "text",
                 ''   AS "parentId",
                 tmp_proj_tree.order_code as sort
             FROM
                  tmp_proj_tree
                  left join 
                  sys_project on
                  tmp_proj_tree.parent_id=sys_project.id
             WHERE
                 tmp_proj_tree.id = auth_spid and tmp_proj_tree.org_type='11'
                 union
                 select 
                mdm_build.id as "id",
                mdm_build.BUILD_NAME "text",
                mdm_build.PERIOD_ID as "parentId",
                replace(lpad(mdm_build.BUILD_NAME,5),' ','0') as sort 
                 from
                 mdm_build 
                inner join  (select tmp_proj_tree.ORG_ID from tmp_proj_tree inner join
                (select tmp_proj_tree.ORG_ID,tmp_proj_tree.org_name as PROJECT_NAME from tmp_proj_tree inner join (select ID  from(select * from SYS_BUSINESS_UNIT m start with m.id=bizId connect by m.parent_id=prior m.id) tab where tab.level_rank<=4) orgs
                on tmp_proj_tree.parent_id=orgs.id where tmp_proj_tree.org_type='10' and  tmp_proj_tree.id = auth_spid ) projects
                on  projects.ORG_ID=tmp_proj_tree.parent_id) stage

                on stage.ORG_ID=mdm_build.PERIOD_ID
                 )tab 
                 order by tab.sort;
else
            open dataList for
             select * from 
             (SELECT 
                 tmp_proj_tree.org_id       AS "id",
                 projects.PROJECT_NAME||'_'||tmp_proj_tree.org_name     AS "text",
                 ''   AS "parentId",
                  tmp_proj_tree.order_code as sort
             FROM
              tmp_proj_tree 
               inner join 
            (select tmp_proj_tree.ORG_ID,tmp_proj_tree.org_name as PROJECT_NAME from tmp_proj_tree inner join (select ID  from(select * from SYS_BUSINESS_UNIT m start with m.id=bizId connect by m.PARENT_ID=prior m.id) tab where tab.level_rank<=4) orgs
            on tmp_proj_tree.parent_id=orgs.id where tmp_proj_tree.org_type='10' and  tmp_proj_tree.id = auth_spid ) projects
            on projects.ORG_ID=tmp_proj_tree.parent_id where  tmp_proj_tree.id = auth_spid and tmp_proj_tree.org_type='11' 
            union
            select  mdm_build.id as "id",
            mdm_build.BUILD_NAME "text",
            mdm_build.PERIOD_ID as "parentId",
            replace(lpad(mdm_build.BUILD_NAME,5),' ','0') as sort 
            from mdm_build    inner join  

            (select tmp_proj_tree.ORG_ID from tmp_proj_tree inner join
            (select tmp_proj_tree.ORG_ID,tmp_proj_tree.org_name as PROJECT_NAME from tmp_proj_tree inner join (select ID  from(select * from SYS_BUSINESS_UNIT m start with m.id=bizId connect by m.parent_id=prior m.id) tab where tab.level_rank<=4) orgs
            on tmp_proj_tree.parent_id=orgs.id where tmp_proj_tree.org_type='10' and  tmp_proj_tree.id = auth_spid ) projects
            on  projects.ORG_ID=tmp_proj_tree.parent_id) stage

             on stage.ORG_ID=mdm_build.PERIOD_ID) tab 
             order by tab.sort
            ;
  end if;
end if;
end p_mdm_project_stage_by_bizId;
/

prompt
prompt Creating procedure P_MDM_PROJ_MAINTENANCE
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_mdm_proj_maintenance (
    userid         IN             VARCHAR2 --当前用户id
    ,
    stationid      IN             VARCHAR2 --当前用户岗位id
    ,
    departmentid   IN             VARCHAR2 --当前用户部门id
    ,
    companyid      IN             VARCHAR2 --当前用户公司id
    ,
    projtreeinfo   OUT            SYS_REFCURSOR--项目树
) AS
--项目维护与分期维护数据源
--作者：陈丽
--日期：2019/11/13
--输入变量：用户ID
    data_auth_spid   VARCHAR2(200);
    bizcode          VARCHAR2(200);
BEGIN
    bizcode := 'MDM.XMZSJ.01';
    p_sys_get_company_tree_spid(userid => userid, stationid => stationid, deptid => departmentid, companyid => companyid, bizcode
    => bizcode, data_auth_spid => data_auth_spid);

    OPEN projtreeinfo FOR SELECT
                             orgid      "orgId",
                             orgname    AS "orgName",
                             projcode   AS "projCodeas",
                             orgtype    AS "orgType",
                             parentid   AS "parentId",
                             1 AS "levelRank",
                             cityname   AS "cityName"
                         FROM
                             (
                                 SELECT DISTINCT
                                     org_id       AS orgid,
                                     org_name     AS orgname,
                                     REPLACE(order_code, '.' ,'') AS projcode,
                                     org_type     AS orgtype,
                                     parent_id    AS parentid,
                                     is_company   AS iscompany,
                                     '' AS cityname,
                                     order_code   AS ordercode
                                 FROM
                                                tmp_company_tree
                                 WHERE
                                     id = data_auth_spid
                                 UNION ALL
                                 SELECT
                                     project_original_id   AS projid,
                                     project_name          AS projname,
                                     project_code          AS projcode,
                                     '10' AS datatype,
                                     company_id            AS parentid,
                                     1 AS levelrank,
                                     city_name             AS cityname,
                                     project_code          AS ordercode
                                 FROM
                                     mdm_project  left
                                     JOIN (
                                         SELECT
                                             MIN(project_version) AS v,
                                             project_original_id AS o
                                         FROM
                                             mdm_project
                                         GROUP BY
                                             project_original_id 
                                     ) vv ON mdm_project.project_version = vv.v
                                             AND mdm_project.project_original_id = vv.o AND mdm_project.company_id IN(
                                              SELECT DISTINCT
                                     org_id       AS orgid
                                 FROM
                                                tmp_company_tree
                                 WHERE
                                     id = data_auth_spid
                                             )
                                 WHERE
                                     vv.v IS NOT NULL 
                             ) t 
                         ORDER BY
                             projcode;

END p_mdm_proj_maintenance;
/

prompt
prompt Creating procedure P_MDM_PROJ_MAINTENANCE_PHASE
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_mdm_proj_maintenance_phase (
    userid         IN             VARCHAR2 --当前用户id
    ,
    stationid      IN             VARCHAR2 --当前用户岗位id
    ,
    departmentid   IN             VARCHAR2 --当前用户部门id
    ,
    companyid      IN             VARCHAR2 --当前用户公司id
    ,
    projtreeinfo   OUT            SYS_REFCURSOR--项目树
) AS
--项目维护阶段维护数据源。
--作者：陈丽
--日期：2019/11/13
    data_auth_spid   VARCHAR2(200);
    bizcode          VARCHAR2(200);
BEGIN
    bizcode := 'MDM.XMZSJ.01';
    p_sys_get_company_tree_spid(userid => userid, stationid => stationid, deptid => departmentid, companyid => companyid, bizcode
    => bizcode, data_auth_spid => data_auth_spid);

    OPEN projtreeinfo FOR SELECT
                             project_original_id   "orgId",--组织id
                             project_name          AS "orgName",--组织名称名称
                             proj_phase            AS "projPhase",--项目阶段
                             phase_id              AS "phaseId",--阶段id
                             proj_phase_id         AS "projPhaseId",--项目阶段id
                             org_type              AS "orgType",--组织类型 0公司，1项目
                             lower(parent_id) AS "parentId",--父级id
                             nvl(total_site_area, 0) AS "totalSiteArea",--总用地面积
                             nvl(overall_floorage_area, 0) AS "overallFloorageArea",--总建组面积
                             nvl(total_sale_area, 0) AS "totalSalableArea",--总可售面积
                             nvl(total_capacity_area, 0) AS "totalCapacityArea",--计容面积
                             is_exist_proj_phase   AS "isExistProjPhase",--存在项目阶段
                             "ordercode"
                         FROM
                             (
                                 SELECT
                                     sys_project.project_original_id,
                                     project_name,
                                     mdm_phase.phase_name   AS proj_phase,
                                     phase.phase_id,
                                     phase.id               AS proj_phase_id,
                                     10 AS org_type,
                                     CASE
                                         WHEN phase.phase_id IS NULL THEN
                                             0
                                         ELSE
                                             1
                                     END AS is_exist_proj_phase,
                                     company_id             AS parent_id,
                                     mdm_obj_phase_index.total_site_area,
                                     mdm_obj_phase_index.overall_floorage_area,
                                     mdm_obj_phase_index.total_sale_area,
                                     mdm_obj_phase_index.total_capacity_area,
                                    project_code as "ordercode"
                                 FROM
                                     sys_project left
                                     JOIN (
                                         SELECT
                                             t1.id,
                                             t1.phase_id,
                                             t1.proj_id,
                                             t2.phase_order
                                         FROM
                                             mdm_project_phase t1
                                             LEFT JOIN (
                                                 SELECT
                                                     proj_id,
                                                     MAX(phase_order) AS phase_order
                                                 FROM
                                                     mdm_project_phase
                                                 GROUP BY
                                                     proj_id
                                             ) t2 ON t1.proj_id = t2.proj_id
                                                     AND t1.phase_order = t2.phase_order
                                         WHERE
                                             t2.phase_order IS NOT NULL
                                     ) phase ON sys_project.project_original_id = phase.proj_id
                                     LEFT JOIN mdm_phase ON phase.phase_id = mdm_phase.id
                                     LEFT JOIN mdm_obj_phase_index ON phase.id = mdm_obj_phase_index.obj_phase_id
                                                                      AND mdm_obj_phase_index.obj_type = 0
                                 WHERE
                                       sys_project.company_id in
                                     (
                                     SELECT DISTINCT
                                    org_id   
                                FROM

                                              tmp_company_tree
                                 WHERE
                                     id = data_auth_spid
--                                     SELECT DISTINCT
--                                     org_id   
--                                 FROM
--                                              tmp_company_tree
--                                 WHERE
--                                     id = data_auth_spid
--                                     AND org_id IN (
--                                         SELECT DISTINCT
--                                             id
--                                         FROM
--                                             sys_business_unit
--                                         START WITH
--                                             id IN (
--                                                 SELECT
--                                                     id
--                                                 FROM
--                                                     (
--                                                         SELECT
--                                                             unit_id AS id
--                                                         FROM
--                                                             sys_project
--                                                         UNION
--                                                         SELECT
--                                                             subordinate_company_id AS id
--                                                         FROM
--                                                             cdb_feasible_project_config
--                                                     ) ds
--                                             )
--                                         CONNECT BY
--                                             PRIOR parent_id = id
--                                     )
                                     )
                                 UNION ALL

                                  SELECT DISTINCT
                                     org_id       AS orgid,
                                     org_name     AS orgname,
                                    -- order_code AS projcode,
                                      '' AS proj_phase,
                                     '' AS phase_id,
                                     '' AS proj_phase_id,
                                     0     AS orgtype,
                                     NULL is_exist_proj_phase,
                                     parent_id,
                                     0 AS "totalSiteArea",
                                     0 AS "overallFloorageArea",
                                     0 AS "totalSalableArea",
                                     0 AS "totalCapacityArea",
                                   order_code as "ordercode"
                                 FROM
                                              tmp_company_tree
                                 WHERE
                                     id = data_auth_spid
--                                     AND org_id IN (
--                                         SELECT DISTINCT
--                                             id
--                                         FROM
--                                             sys_business_unit
--                                         START WITH
--                                             id IN (
--                                                 SELECT
--                                                     id
--                                                 FROM
--                                                     (
--                                                         SELECT
--                                                             unit_id AS id
--                                                         FROM
--                                                             sys_project
--                                                         UNION
--                                                         SELECT
--                                                             subordinate_company_id AS id
--                                                         FROM
--                                                             cdb_feasible_project_config
--                                                     ) ds
--                                             )
--                                         CONNECT BY
--                                             PRIOR parent_id = id
--                                     )
                             ) t order by "ordercode";

END p_mdm_proj_maintenance_phase;
/

prompt
prompt Creating procedure P_MDM_PROJ_SITUATION
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_mdm_proj_situation(
   userid         IN             VARCHAR2 --当前用户id
    ,
    stationid      IN             VARCHAR2 --当前用户岗位id
    ,
    departmentid   IN             VARCHAR2 --当前用户部门id
    ,
    companyid      IN             VARCHAR2 --当前用户公司id
    ,
projtreeinfo   OUT            SYS_REFCURSOR)
AS
--主数据首页，主数据概况。
--作者：陈丽
--日期：2019/11/13
    data_auth_spid   VARCHAR2(200);
    bizcode          VARCHAR2(200);
BEGIN
    --权限查询
    bizcode := 'MDM.XMZSJ.01';
    p_sys_get_company_tree_spid(userid => userid, stationid => stationid, deptid => departmentid, companyid => companyid, bizcode
    => bizcode, data_auth_spid => data_auth_spid);
OPEN projtreeinfo FOR
SELECT DISTINCT
                                     org_id       AS id,
                                     org_name     AS orgName,
                                     tt.parent_id as parentsId,
                                      b.nums       as projTotal,
                                      nvl(c.salesArea,0) salesArea,
                                      nvl(c.salesCarport,0) salesCarport
                                 FROM
                                              tmp_company_tree tt left join(
                                              SELECT
                                                      count( b.company_id ) nums,
                                                      b.company_id
                                                    FROM
                                                      mdm_project b
                                                    WHERE
                                                      b.APPROVAL_STATUS = '已审核'
                                                    GROUP BY
                                                      b.company_id
                                                      ) b ON tt.org_id = b.company_id
                                                    left join (SELECT
                                                      company_id,
                                                      sum(mdm_obj_phase_index.total_sale_area) salesArea,
                                                      sum(mdm_obj_phase_index.underground_total_sale_carport) salesCarport
                                                    FROM
                                                      mdm_project
                                                        LEFT JOIN (
                                                    SELECT
                                                      t1.id,
                                                      t1.phase_id,
                                                      t1.proj_id,
                                                      t2.phase_order
                                                    FROM
                                                      mdm_project_phase t1
                                                      LEFT JOIN ( SELECT proj_id, MAX( phase_order ) AS phase_order FROM mdm_project_phase GROUP BY proj_id ) t2 ON t1.proj_id = t2.proj_id
                                                      AND t1.phase_order = t2.phase_order
                                                    WHERE
                                                      t2.phase_order IS NOT NULL
                                                      ) phase ON mdm_project.project_original_id = phase.proj_id
                                                        LEFT JOIN mdm_phase ON phase.phase_id = mdm_phase.id
                                                        LEFT JOIN mdm_obj_phase_index ON phase.id = mdm_obj_phase_index.obj_phase_id
                                                          AND mdm_obj_phase_index.obj_type = 0
                                                        WHERE
                                                          approval_status = '已审核'
                                                          GROUP BY company_id) c on c.company_id = tt.org_id
                                                        WHERE
                                                          tt.org_type = 0
                                                          AND ( tt.org_id != '000100000000000000000000000000' AND tt.org_id != '000200000000000000000000000000' ) 
                                     AND
                                     tt.id = data_auth_spid
                                     AND tt.org_id IN (
                                         SELECT DISTINCT
                                             id
                                         FROM
                                             sys_business_unit
                                         START WITH
                                             id IN (
                                                 SELECT
                                                     id
                                                 FROM
                                                     (
                                                         SELECT
                                                             unit_id AS id
                                                         FROM
                                                             sys_project
                                                         UNION
                                                         SELECT
                                                             subordinate_company_id AS id
                                                         FROM
                                                             cdb_feasible_project_config
                                                     ) ds
                                             )
                                         CONNECT BY
                                             PRIOR parent_id = id
                                     );
       --                                                   ORDER BY CAST(tt.order_code AS int);
END p_mdm_proj_situation;
/

prompt
prompt Creating procedure P_MDM_PUBLISH_VERSION_DATA
prompt =============================================
prompt
create or replace procedure pom0813.P_MDM_PUBLISH_VERSION_DATA(
    phaseVersionId in varchar2, --阶段版本id
    code out INTEGER,
    info out varchar2
)
    -- 发布版本数据
-- @note 脚本初始化
-- @date 2020-06-30 17:39:18
-- @author 韩金明
    is
    projectId varchar2(36);
    phaseId varchar2(36);
    phaseVersion varchar2(36);
begin
    -- 获取项目id
    begin
        select OBJ_ID, PHASE_ID, OBJ_PHASE_VERSION into projectId, phaseId, phaseVersion
        from MDM_OBJ_PHASE_VERSION mopv
        where id = phaseVersionId and OBJ_TYPE = 0;
    exception when others then
        info := '未获取到项目信息';
        code := 501;
        return;
    end;
    -- 更新所有阶段的审核状态为已审核
    merge into MDM_OBJ_PHASE_VERSION mopv using (
        SELECT ID, '0' pType
        from MDM_PROJECT_PHASE
        where PROJ_ID = projectId
          and PHASE_ID = phaseId
        union
        select mpp1.ID, '20' pType
        from MDM_PERIOD_PHASE mpp1
                 left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                 left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
        where mpv.PROJECT_ID = projectId
          and mpp1.PHASE_ID = phaseId
          and APPROVAL_STATUS = '已审核'
        union
        select mpp1.ID, '10' pType
        from MDM_PARCEL_PHASE mpp1
                 left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
        where mp1.PROJECT_ORIGINAL_ID = projectId
          and mpp1.PHASE_ID = phaseId
        union
        select mbp1.ID, '30' pType
        from MDM_BUILD_PHASE mbp1
                 left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
        where mb1.PROJ_ID = projectId
          and mbp1.PHASE_ID = phaseId
    ) t1 on (t1.ID = mopv.OBJ_PHASE_ID)
    when matched then update
                      set mopv.PHASE_STATE = (case when mopv.OBJ_PHASE_VERSION=phaseVersion then '20' else mopv.PHASE_STATE end),
                          mopv.IS_NEWEST = (case when mopv.OBJ_PHASE_VERSION = phaseVersion then 1 else 0 end)
                      where mopv.OBJ_PHASE_VERSION = phaseVersion and mopv.PHASE_ID = phaseId;

    -- 还原项目阶段数据
    merge into MDM_PROJECT_PHASE mpp
    using (
        select * from MDM_OBJ_PHASE_VERSION
        where OBJ_ID = projectId and OBJ_TYPE = 0 and OBJ_PHASE_VERSION = phaseVersion
    ) mopv
    on (mpp.ID = mopv.OBJ_PHASE_ID and  mpp.PROJ_ID = mopv.OBJ_ID and mpp.PHASE_ID = mpp.PHASE_ID)
    when matched then
        update set mpp.PLANE_FIGURE = mopv.PLANE_FIGURE;
    -- 暂时只需要更新项目阶段 其他暂时无更新字段
--     -- 还原分期阶段数据
--     merge into MDM_PERIOD_PHASE mpp
--     using (
--         select * from MDM_OBJ_PHASE_VERSION
--         where OBJ_ID = projectId and OBJ_TYPE = 20 and OBJ_PHASE_VERSION = phaseVersion
--     ) mopv
--     on (mpp.ID = mopv.OBJ_PHASE_ID and  mpp.PERIOD_ID = mopv.OBJ_ID and mpp.PHASE_ID = mpp.PHASE_ID)
--     when matched then
--         update
--         set mpp.PHASE_STATE = mopv.PHASE_STATE;
--     -- 还原宗地阶段数据
--     merge into MDM_PARCEL_PHASE mpp
--     using (
--         select * from MDM_OBJ_PHASE_VERSION
--         where OBJ_ID = projectId and OBJ_TYPE = 20 and OBJ_PHASE_VERSION = phaseVersion
--     ) mopv
--     on (mpp.ID = mopv.OBJ_PHASE_ID and  mpp.PAECEL_ID = mopv.OBJ_ID and mpp.PHASE_ID = mpp.PHASE_ID)
--     when matched then
--         update
--         set mpp.PHASE_STATE = mopv.PHASE_STATE;
--     -- 还原楼栋阶段数据
--     merge into MDM_BUILD_PHASE mpp
--     using (
--         select * from MDM_OBJ_PHASE_VERSION
--         where OBJ_ID = projectId and OBJ_TYPE = 20 and OBJ_PHASE_VERSION = phaseVersion
--     ) mopv
--     on (mpp.ID = mopv.OBJ_PHASE_ID and  mpp.BUILD_ID = mopv.OBJ_ID and mpp.PHASE_ID = mpp.PHASE_ID)
--     when matched then
--         update
--         set mpp.PHASE_STATE = mopv.PHASE_STATE;

    -- 删除业态数据
    delete from MDM_OBJ_PHASE_PT_INDEX moppi
    where OBJ_PHASE_ID in (
        with t1 as (
            SELECT ID, '0' pType from MDM_PROJECT_PHASE
            where PROJ_ID = projectId and PHASE_ID = phaseId
            union
            select mpp1.ID, '20' pType  from MDM_PERIOD_PHASE mpp1
                                                 left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                                                 left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
            where mpv.PROJECT_ID = projectId and mpp1.PHASE_ID = phaseId and APPROVAL_STATUS='已审核'
            union
            select mpp1.ID, '10' pType from MDM_PARCEL_PHASE mpp1
                                                left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
            where mp1.PROJECT_ORIGINAL_ID = projectId and mpp1.PHASE_ID = phaseId
            union
            select mbp1.ID, '30' pType  from MDM_BUILD_PHASE mbp1
                                                 left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
            where mb1.PROJ_ID = projectId and mbp1.PHASE_ID = phaseId
        ) select t1.ID from t1
    );
    -- 添加业态数据
    insert into MDM_OBJ_PHASE_PT_INDEX(
        ID, PRODUCT_TYPE_ID, OPERATE_ATTRIBUTE_ID, OPERATE_ATTRIBUTE_NAME, BUILD_AREA, GROUND_CAPACITY_AREA,
        UNDERGROUND_CAPACITY_AREA, GROUND_UNCAPACITY_AREA, UNDERGROUND_UNCAPACITY_AREA, GROUND_TOTAL_BUILD_AREA,
        UNDERGROUND_TOTAL_BUILD_AREA, REFUGE_STOREY_AREA, MECHANICAL_FLOOR_AREA, EMPTY_SPACE_AREA, TOWER_BASEMENT_AREA,
        UNDERGROUND_GARAGE_AREA, STORAGE_AREA, STORAGE_TOTAL, TOTAL_SALE_AREA, GROUND_SALE_AREA, UNDERGROUND_SALE_AREA,
        TOTAL_GIVE_AREA, GROUND_GIVE_AREA, UNDERGROUND_GIVE_AREA, TOTAL_RESIDENCE, TOTAL_BUSINESS, GROUND_CARPORT,
        RESIDENCE_BOTTOM_CARPORT, PARKING_GARAGE_CARPORT, UNDERGROUND_RFJ_CARPORT, UNDERGROUND_RJ_CARPORT,
        UNDERGROUND_FRFJ_CARPORT, UNDERGROUND_FRJ_CARPORT, UNDERGROUND_R_SALE_CARPORT, UNDERGROUND_FRFJ_SALE_CARPORT,
        UNDERGROUND_FRJ_SALE_CARPORT, CARPORT_TOTAL, GROUND_TOTAL_CARPORT, UNDERGROUND_TOTAL_CARPORT,
        UNDERGROUND_TOTAL_RJ_CARPORT, UNDERGROUND_TOTAL_FRJ_CARPORT, UNDERGROUND_TOTAL_SALE_CARPORT, OBJ_PHASE_ID,
        OBJ_TYPE, PRODUCT_TYPE_NAME, PRODUCT_TYPE_JSON)
    with t1 as (
        SELECT ID, '0' pType from MDM_PROJECT_PHASE
        where PROJ_ID = projectId and PHASE_ID = phaseId
        union
        select mpp1.ID, '20' pType  from MDM_PERIOD_PHASE mpp1
                                             left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                                             left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
        where mpv.PROJECT_ID = projectId and mpp1.PHASE_ID = phaseId and APPROVAL_STATUS='已审核'
        union
        select mpp1.ID, '10' pType from MDM_PARCEL_PHASE mpp1
                                            left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
        where mp1.PROJECT_ORIGINAL_ID = projectId and mpp1.PHASE_ID = phaseId
        union
        select mbp1.ID, '30' pType  from MDM_BUILD_PHASE mbp1
                                             left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
        where mb1.PROJ_ID = projectId and mbp1.PHASE_ID = phaseId
    ) select
          GET_UUID(), PRODUCT_TYPE_ID, OPERATE_ATTRIBUTE_ID, OPERATE_ATTRIBUTE_NAME, BUILD_AREA, GROUND_CAPACITY_AREA,
          UNDERGROUND_CAPACITY_AREA, GROUND_UNCAPACITY_AREA, UNDERGROUND_UNCAPACITY_AREA, GROUND_TOTAL_BUILD_AREA,
          UNDERGROUND_TOTAL_BUILD_AREA, REFUGE_STOREY_AREA, MECHANICAL_FLOOR_AREA, EMPTY_SPACE_AREA, TOWER_BASEMENT_AREA,
          UNDERGROUND_GARAGE_AREA, STORAGE_AREA, STORAGE_TOTAL, TOTAL_SALE_AREA, GROUND_SALE_AREA, UNDERGROUND_SALE_AREA,
          TOTAL_GIVE_AREA, GROUND_GIVE_AREA, UNDERGROUND_GIVE_AREA, TOTAL_RESIDENCE, TOTAL_BUSINESS, GROUND_CARPORT,
          RESIDENCE_BOTTOM_CARPORT, PARKING_GARAGE_CARPORT, UNDERGROUND_RFJ_CARPORT, UNDERGROUND_RJ_CARPORT,
          UNDERGROUND_FRFJ_CARPORT, UNDERGROUND_FRJ_CARPORT, UNDERGROUND_R_SALE_CARPORT, UNDERGROUND_FRFJ_SALE_CARPORT,
          UNDERGROUND_FRJ_SALE_CARPORT, CARPORT_TOTAL, GROUND_TOTAL_CARPORT, UNDERGROUND_TOTAL_CARPORT,
          UNDERGROUND_TOTAL_RJ_CARPORT, UNDERGROUND_TOTAL_FRJ_CARPORT, UNDERGROUND_TOTAL_SALE_CARPORT,
          mopvpi.OBJ_PHASE_ID,mopvpi.OBJ_TYPE, PRODUCT_TYPE_NAME, PRODUCT_TYPE_JSON
    from  MDM_OBJ_PHASE_VERSION mopv
              inner join t1 on t1.ID = mopv.OBJ_PHASE_ID
              inner join MDM_OBJ_PHASE_VERSION_PT_INDEX mopvpi on mopv.ID = mopvpi.OBJ_PHASE_VERSION_ID
    where OBJ_PHASE_VERSION = phaseVersion and (mopv.PHASE_STATE = '20' or mopv.PHASE_STATE='19')
      and mopv.PHASE_ID=phaseId;

    -- 删除业态阶段数据
    delete from MDM_OBJ_PHASE_INDEX moppi
    where OBJ_PHASE_ID in (
        with t1 as (
            SELECT ID, '0' pType from MDM_PROJECT_PHASE
            where PROJ_ID = projectId and PHASE_ID = phaseId
            union
            select mpp1.ID, '20' pType  from MDM_PERIOD_PHASE mpp1
                                                 left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                                                 left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
            where mpv.PROJECT_ID = projectId and mpp1.PHASE_ID = phaseId and APPROVAL_STATUS='已审核'
              and mp1.IS_DELETE = 0
            union
            select mpp1.ID, '10' pType from MDM_PARCEL_PHASE mpp1
                                                left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
            where mpp1.PHASE_ID = phaseId and mp1.PROJECT_ORIGINAL_ID = projectId
              and mp1.IS_DELETE = 0
            union
            select mbp1.ID, '30' pType  from MDM_BUILD_PHASE mbp1
                                                 left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
            where mb1.PROJ_ID = projectId and mbp1.PHASE_ID = phaseId
              and mb1.IS_DELETE = 0
        ) select t1.ID from t1
    );
    -- 添加业态阶段数据
    insert into MDM_OBJ_PHASE_INDEX(
        ID, BUILD_AREA, GROUND_CAPACITY_AREA, UNDERGROUND_CAPACITY_AREA, GROUND_UNCAPACITY_AREA,
        UNDERGROUND_UNCAPACITY_AREA, GROUND_TOTAL_BUILD_AREA, UNDERGROUND_TOTAL_BUILD_AREA, REFUGE_STOREY_AREA,
        MECHANICAL_FLOOR_AREA, EMPTY_SPACE_AREA, TOWER_BASEMENT_AREA, UNDERGROUND_GARAGE_AREA, STORAGE_AREA,
        STORAGE_TOTAL, TOTAL_SALE_AREA, GROUND_SALE_AREA, UNDERGROUND_SALE_AREA, TOTAL_GIVE_AREA, GROUND_GIVE_AREA,
        UNDERGROUND_GIVE_AREA, TOTAL_RESIDENCE, TOTAL_BUSINESS, GROUND_CARPORT, RESIDENCE_BOTTOM_CARPORT,
        PARKING_GARAGE_CARPORT, UNDERGROUND_RFJ_CARPORT, UNDERGROUND_RJ_CARPORT, UNDERGROUND_FRFJ_CARPORT,
        UNDERGROUND_FRJ_CARPORT, UNDERGROUND_R_SALE_CARPORT, UNDERGROUND_FRFJ_SALE_CARPORT,
        UNDERGROUND_FRJ_SALE_CARPORT, CARPORT_TOTAL, GROUND_TOTAL_CARPORT, UNDERGROUND_TOTAL_CARPORT,
        UNDERGROUND_TOTAL_RJ_CARPORT, UNDERGROUND_TOTAL_FRJ_CARPORT, UNDERGROUND_TOTAL_SALE_CARPORT,
        CONSTRUCTION_LAND_AREA, EXPROPRIATION_GREEN_SPACE_AREA, EXPROPRIATION_ROAD_AREA, OTHER_EXPROPRIATION_AREA,
        TOTAL_ROAD_AREA, TOTAL_GREEN_LAND_AREA, DEMONSTRATION_AREA, PLOT_RATIO, BUILD_DENSITY, GREENING_RATE,
        SALE_RATIO, GROUND_ENGINE_CARPORT, TOTAL_SITE_AREA, CONFISCATED_AREA, OVERALL_FLOORAGE_AREA,
        TOTAL_CAPACITY_AREA, CONSTRUCTION_PLOT_RATIO, TOTAL_SITE_AREA_PLOT_RATIO, CONSTRUCTION_BUILD_DENSITY,
        TOTAL_SITE_AREA_BUILD_DENSITY, CONSTRUCTION_GREENING_RATE, TOTAL_SITE_AREA_GREENING_RATE, CARPORT_RATIO,
        TOTAL_HOUSEHOLDS, OBJ_PHASE_ID, OBJ_TYPE, JBS_AREA
    )
    with t1 as (
        SELECT ID, '0' pType from MDM_PROJECT_PHASE
        where PROJ_ID = projectId and PHASE_ID = phaseId
        union
        select mpp1.ID, '20' pType  from MDM_PERIOD_PHASE mpp1
                                             left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                                             left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
        where mpv.PROJECT_ID = projectId and mpp1.PHASE_ID = phaseId and APPROVAL_STATUS='已审核'
        union
        select mpp1.ID, '10' pType from MDM_PARCEL_PHASE mpp1
                                            left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
        where mpp1.PHASE_ID = phaseId and mp1.PROJECT_ORIGINAL_ID = projectId
        union
        select mbp1.ID, '30' pType  from MDM_BUILD_PHASE mbp1
                                             left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
        where mb1.PROJ_ID = projectId and mbp1.PHASE_ID = phaseId
    ) select
          GET_UUID(), BUILD_AREA, GROUND_CAPACITY_AREA, UNDERGROUND_CAPACITY_AREA, GROUND_UNCAPACITY_AREA,
          UNDERGROUND_UNCAPACITY_AREA, GROUND_TOTAL_BUILD_AREA, UNDERGROUND_TOTAL_BUILD_AREA, REFUGE_STOREY_AREA,
          MECHANICAL_FLOOR_AREA, EMPTY_SPACE_AREA, TOWER_BASEMENT_AREA, UNDERGROUND_GARAGE_AREA, STORAGE_AREA,
          STORAGE_TOTAL, TOTAL_SALE_AREA, GROUND_SALE_AREA, UNDERGROUND_SALE_AREA, TOTAL_GIVE_AREA, GROUND_GIVE_AREA,
          UNDERGROUND_GIVE_AREA, TOTAL_RESIDENCE, TOTAL_BUSINESS, GROUND_CARPORT, RESIDENCE_BOTTOM_CARPORT,
          PARKING_GARAGE_CARPORT, UNDERGROUND_RFJ_CARPORT, UNDERGROUND_RJ_CARPORT, UNDERGROUND_FRFJ_CARPORT,
          UNDERGROUND_FRJ_CARPORT, UNDERGROUND_R_SALE_CARPORT, UNDERGROUND_FRFJ_SALE_CARPORT,
          UNDERGROUND_FRJ_SALE_CARPORT, CARPORT_TOTAL, GROUND_TOTAL_CARPORT, UNDERGROUND_TOTAL_CARPORT,
          UNDERGROUND_TOTAL_RJ_CARPORT, UNDERGROUND_TOTAL_FRJ_CARPORT, UNDERGROUND_TOTAL_SALE_CARPORT,
          CONSTRUCTION_LAND_AREA, EXPROPRIATION_GREEN_SPACE_AREA, EXPROPRIATION_ROAD_AREA, OTHER_EXPROPRIATION_AREA,
          TOTAL_ROAD_AREA, TOTAL_GREEN_LAND_AREA, DEMONSTRATION_AREA, PLOT_RATIO, BUILD_DENSITY, GREENING_RATE,
          SALE_RATIO, GROUND_ENGINE_CARPORT, TOTAL_SITE_AREA, CONFISCATED_AREA, OVERALL_FLOORAGE_AREA,
          TOTAL_CAPACITY_AREA, CONSTRUCTION_PLOT_RATIO, TOTAL_SITE_AREA_PLOT_RATIO, CONSTRUCTION_BUILD_DENSITY,
          TOTAL_SITE_AREA_BUILD_DENSITY, CONSTRUCTION_GREENING_RATE, TOTAL_SITE_AREA_GREENING_RATE, CARPORT_RATIO,
          TOTAL_HOUSEHOLDS, mopvpi.OBJ_PHASE_ID, mopvpi.OBJ_TYPE, JBS_AREA
    from MDM_OBJ_PHASE_VERSION mopv
             inner join t1 on t1.ID = mopv.OBJ_PHASE_ID
             inner join MDM_OBJ_PHASE_VERSION_INDEX mopvpi on mopv.ID = mopvpi.OBJ_PHASE_VERSION_ID
    where OBJ_PHASE_VERSION = phaseVersion and (mopv.PHASE_STATE = '20' or mopv.PHASE_STATE='19')
      and mopv.PHASE_ID=phaseId;

    delete from MDM_OBJ_PHASE_AREA_LEVEL
    where OBJ_PHASE_PT_INDEX_ID in (
        with t1 as (
            SELECT ID, '0' pType
            from MDM_PROJECT_PHASE
            where PROJ_ID = projectId and PHASE_ID = phaseId
            union
            select mpp1.ID, '20' pType
            from MDM_PERIOD_PHASE mpp1
                     left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                     left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
            where mpv.PROJECT_ID = projectId and mpp1.PHASE_ID = phaseId and APPROVAL_STATUS='已审核'
            union
            select mpp1.ID, '10' pType
            from MDM_PARCEL_PHASE mpp1
                     left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
            where mpp1.PHASE_ID = phaseId and mp1.PROJECT_ORIGINAL_ID = projectId
            union
            select mbp1.ID, '30' pType
            from MDM_BUILD_PHASE mbp1
                     left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
            where mb1.PROJ_ID = projectId and mbp1.PHASE_ID = phaseId
        )select
            mopi.ID
        from MDM_OBJ_PHASE_VERSION mopv
                 -- inner join 排出到未到达阶段的数据
                 inner join t1 on t1.ID = mopv.OBJ_PHASE_ID
                 inner join MDM_OBJ_PHASE_PT_INDEX mopi on mopi.OBJ_PHASE_ID = mopv.OBJ_PHASE_ID
        where OBJ_PHASE_VERSION = phaseVersion
    );
    --发布住户类型信息
    insert into MDM_OBJ_PHASE_AREA_LEVEL(
        ID, ATTRIBUTE_AREA_LEVEL_ID, ATTRIBUTE_AREA_LEVEL_NAME, ROOM_NUMBER, OBJ_PHASE_PT_INDEX_ID
    ) with t1 as (
        SELECT ID, '0' pType from MDM_PROJECT_PHASE
        where PROJ_ID = projectId and PHASE_ID = phaseId
        union
        select mpp1.ID, '20' pType  from MDM_PERIOD_PHASE mpp1
                                             left join MDM_PERIOD mp1 on mp1.PERIOD_ORIGINAL_ID = mpp1.PERIOD_ID
                                             left join MDM_PERIOD_VERSION mpv on mp1.PERIOD_VERSION_ID = mpv.ID
        where mpv.PROJECT_ID = projectId and mpp1.PHASE_ID = phaseId and APPROVAL_STATUS='已审核'
        union
        select mpp1.ID, '10' pType from MDM_PARCEL_PHASE mpp1
                                            left join MDM_PARCEL mp1 on mpp1.PAECEL_ID = mp1.PARCEL_ORIGINAL_ID
        where mpp1.PHASE_ID = phaseId and mp1.PROJECT_ORIGINAL_ID = projectId
        union
        select mbp1.ID, '30' pType  from MDM_BUILD_PHASE mbp1
                                             left join MDM_BUILD mb1 on mb1.ID = mbp1.BUILD_ID
        where mb1.PROJ_ID = projectId and mbp1.PHASE_ID = phaseId
    )select
         GET_UUID(), ATTRIBUTE_AREA_LEVEL_ID, ATTRIBUTE_AREA_LEVEL_NAME, ROOM_NUMBER, ppi.ID
    from t1
             left join MDM_OBJ_PHASE_VERSION_PT_INDEX pi on t1.ID = pi.OBJ_PHASE_ID
             left join MDM_OBJ_PHASE_PT_INDEX ppi on ppi.OBJ_PHASE_ID = t1.ID
        and ppi.PRODUCT_TYPE_ID = pi.PRODUCT_TYPE_ID
             inner join MDM_OBJ_PHASE_AL_V mopav on mopav.OBJ_PHASE_PT_INDEX_ID = pi.ID
             left join MDM_OBJ_PHASE_VERSION mopv on mopv.ID = mopav.OBJ_PHASE_VERSION_ID
    where mopv.OBJ_PHASE_VERSION = phaseVersion and (mopv.PHASE_STATE = '20' or mopv.PHASE_STATE='19')
      and mopv.PHASE_ID=phaseId;
    info := '成功';
    code := 0;
end;
/

prompt
prompt Creating procedure P_MDM_ROOM_BY_BUILDID
prompt ========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_mdm_room_by_buildId(
    buildId in varchar2,
    roomNums out SYS_REFCURSOR,
    unintNums out SYS_REFCURSOR,
    floorNum out SYS_REFCURSOR,
    rooms out SYS_REFCURSOR,
    categoryRateData out SYS_REFCURSOR
) AS
total number;
ds_total number;
qy_total number;
rg_total number;
xd_total number;
xk_total number;

yl_total number;
yy_total number;

--chenl 20200701 调整验收，根据集团于政要求，销控图颜色按照销售系统来
--预留 #FDFF00
yl_color varchar2(50):='#FDFF00';
--预约 #00FF00 
yy_color varchar2(50):='#00FF00';

--待售 #FCFCFC 
---待售
ds_color varchar2(50):='#FCFCFC';
--签约 #CD00FE  
--签约
qy_color varchar2(50):='#CD00FE';
--认购  #FD0200 
--认购
rg_color varchar2(50):='#FD0200';
--小订 #FFA303
--小订
xd_color varchar2(50):='#FFA303';
--销控
--销控 #BBCFE4
xk_color varchar2(50):='#BBCFE4';
begin
select count(1) into total from MDM_ROOM where BUILDING_ID=buildId;
--select count(1) into ds_total from MDM_ROOM where BUILDING_ID=buildId and SALE_STATE='待售'  ;
--select count(1) into qy_total from MDM_ROOM where BUILDING_ID=buildId and SALE_STATE='签约'  ;
--select count(1) into rg_total from MDM_ROOM where BUILDING_ID=buildId and SALE_STATE='认购'  ;
--select count(1) into xd_total from MDM_ROOM where BUILDING_ID=buildId and SALE_STATE='小订'  ;
--select count(1) into xk_total from MDM_ROOM where BUILDING_ID=buildId and SALE_STATE='销控'  ;
---chenl 20200701 优化
select sum(case when SALE_STATE='待售' then 1 else 0 end) ds,
sum(case when SALE_STATE='签约' then 1 else 0 end) yy,
sum(case when SALE_STATE='认购' then 1 else 0 end) rg,
sum(case when SALE_STATE='小订' then 1 else 0 end) xd,
sum(case when SALE_STATE='销控' then 1 else 0 end) xk,
sum(case when SALE_STATE='预留' then 1 else 0 end) yl,
sum(case when SALE_STATE='预约' then 1 else 0 end) yy
into ds_total,qy_total,rg_total,xd_total,xk_total,yl_total,yy_total
from MDM_ROOM where BUILDING_ID=buildId;

if total <> 0 then 
open floorNum for
select FLOOR_NAME as "name",replace(lpad(tab.FLOOR_NAME,5),' ','0')  as sort from (select FLOOR_NAME from MDM_ROOM where BUILDING_ID=buildId group by  FLOOR_NAME)tab
order by sort desc;

open unintNums for
select UNIT_ID as "name",replace(lpad(tab.UNIT_ID,5),' ','0')  as sort from (select UNIT_ID from MDM_ROOM where BUILDING_ID=buildId group by  UNIT_ID)tab
order by sort;

open roomNums for
select 号码 as "room_num",UNIT_ID "unitId" from (
select UNIT_ID,substr(room_code,length(floor_name)+1) as 号码 from mdm_room where building_id=buildId )tab  group by 号码,UNIT_ID order by UNIT_ID,号码;

open categoryRateData for
select * from
(select xk_total as "categoryCount",
xk_color as "categoryColor",
'销控' as "categoryName",
fn_ConvertDecimalToPercentage(xk_total/total) as "categoryRate",
1 as sort
from dual
union
select ds_total as "categoryCount",
ds_color as "categoryColor",
'待售' as "categoryName",
fn_ConvertDecimalToPercentage(ds_total/total) as "categoryRate",
2 as sort
from dual
union
select xd_total as "categoryCount",
yy_color as "categoryColor",
'预约' as "categoryName",
fn_ConvertDecimalToPercentage(yy_total/total) as "categoryRate",
3 as sort
from dual
union
select xd_total as "categoryCount",
yl_color as "categoryColor",
'预留' as "categoryName",
fn_ConvertDecimalToPercentage(yl_total/total) as "categoryRate",
4 as sort
from dual
union
select xd_total as "categoryCount",
xd_color as "categoryColor",
'小订' as "categoryName",
fn_ConvertDecimalToPercentage(xd_total/total) as "categoryRate",
5 as sort
from dual
union
select rg_total as "categoryCount",
rg_color as "categoryColor",
'认购' as "categoryName",
fn_ConvertDecimalToPercentage(rg_total/total) as "categoryRate",
6 as sort
from dual
union
select qy_total as "categoryCount",
qy_color as "categoryColor",
'签约' as "categoryName",
fn_ConvertDecimalToPercentage(qy_total/total) as "categoryRate",
7 as sort
from dual) tab order by tab.sort;

open rooms for
select 
substr(room_code,length(floor_name)+1) as "room_num",
ROOM_NAME,ROOM_CODE,BUILDING_ID,BUILDING_NAME,UNIT_ID "unitId",UNIT_NAME,FLOOR_ID,FLOOR_NAME,SALE_STATE,PRE_BLD_AREA,
PRE_IN_AREA,ACTUAL_BLD_AREA,ACTUAL_IN_AREA,NEW_BLD_AREA,NEW_IN_AREA,PRODUCT_NAME,BASE_PRICE,BASE_TOTAL,BZ_PRICE,BZ_TOTAL,BZ_TOTAL_AREA_TYPE,
TRADE_PRICE,
TRADE_TOTAL,
TRADE_TOTAL_AREA_TYPE,
case when TRADE_CONTRACT_DATE is not null then to_char( TRADE_CONTRACT_DATE,'yyyy-mm-dd' ) else '' end TRADE_CONTRACT_DATE,
case when IS_AREA_BC =1 then '是' else '否' end IS_AREA_BC,
PRE_AFTER_BC_TOTAL,
ACTUAL_AFTER_BC_TOTAL,
IS_TRANSFER,
PRE_TRANSFER_DATE,
ACTUAL_TRANSFER_DATE,
IS_INDIRECT,
ACTUAL_INDIRECT_DATE,
ACTUAL_INDIRECT_TOTAL,
case when SALE_STATE='待售' then ds_color
when SALE_STATE='签约' then qy_color
when SALE_STATE='认购' then rg_color
when SALE_STATE='小订' then xd_color
when SALE_STATE='销控' then xk_color
when SALE_STATE='预约' then yy_color
when SALE_STATE='预留' then yl_color end color,
ACTUAL_INDIRECT_AREA from MDM_ROOM where BUILDING_ID=buildId order by LPAD(unit_id,10,'0'),LPAD(floor_name,10,'0'),LPAD(room_code,10,'0') ;
end if;
end p_mdm_room_by_buildId;
/

prompt
prompt Creating procedure P_MDM_ROOM_FROM_SMS
prompt ======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_mdm_room_from_sms IS
   synchDate Date ;
BEGIN
--从销售系统抓取房间数据 mdm_room_from_sms 中间表数据转换到mdm_room_bak 目标表的存储过程
--作者：鲜晓勇
--日期：2020/01/13
	---初始化同步时间 
    synchDate:=sysdate();
    INSERT INTO mdm_room_from_sms 
    select * from api_room_from_sms;
    
    MERGE INTO mdm_room_bak USING (
       --数据处理  中间表中出现 多条相同数据时，去重，默认去id最大的哪条，可修改
	     -- mdm_room_from_sms 从销售系统接口抓取房间数据中间表中，存在字段 返回“无”的情况，和mdm_room_bak 目标表的数据类型无法对应。先将处理为将“无”的数据转换为 null 可修改
--                                    SELECT
--                                        *
--                                    FROM
--                                        mdm_room_from_sms x
--                                    WHERE
--                                        x.rowId = (
--                                            SELECT
--                                                MAX(y.rowId)
--                                            FROM
--                                                mdm_room_from_sms y
--                                            WHERE  
--                                                x.room_id = y.room_id
--                                        )
                  select * from 
                 (select mdm_room_from_sms.*,row_number() over(partition by room_id order by TRADE_CONTRACT_DATE desc) as order_num 
                 from mdm_room_from_sms )rfs where order_num = 1
                                )
        mdm_room_from_sms ON ( mdm_room_bak.id = mdm_room_from_sms.room_id )
        WHEN MATCHED THEN
        --修改 将中间表数据update 到 room_bak 表
        UPDATE SET
            mdm_room_bak.room_name = mdm_room_from_sms.room_name,  mdm_room_bak.room_code = CASE mdm_room_from_sms.room_code  WHEN '无' THEN  NULL  ELSE  mdm_room_from_sms.room_code END,
            mdm_room_bak.product_code=case mdm_room_from_sms.pt_code when '无' THEN  NULL ELSE mdm_room_from_sms.pt_code END,
            mdm_room_bak.product_name=case mdm_room_from_sms.pt_name when '无' THEN  NULL ELSE mdm_room_from_sms.pt_name END,
            mdm_room_bak.product_is_cw= CASE WHEN mdm_room_from_sms.pt_is_cw = '无' OR mdm_room_from_sms.pt_is_cw = '否' THEN 0 ELSE 1 END,
            mdm_room_bak.project_id=case mdm_room_from_sms.project_id when '无' THEN  NULL ELSE mdm_room_from_sms.project_id END,
            mdm_room_bak.project_code=case mdm_room_from_sms.project_code when '无' THEN  NULL ELSE mdm_room_from_sms.project_code END,
            mdm_room_bak.project_name=case mdm_room_from_sms.project_name when '无' THEN  NULL ELSE mdm_room_from_sms.project_name END,
            mdm_room_bak.building_id=case mdm_room_from_sms.building_id when '无' THEN  NULL ELSE mdm_room_from_sms.building_id END,
            mdm_room_bak.building_name=case mdm_room_from_sms.building_name when '无' THEN  NULL ELSE mdm_room_from_sms.building_name END,
            mdm_room_bak.unit_id=case mdm_room_from_sms.unit_id when '无' THEN  NULL ELSE mdm_room_from_sms.unit_id END,
            mdm_room_bak.unit_name=case mdm_room_from_sms.unit_name when '无' THEN  NULL ELSE mdm_room_from_sms.unit_name END,
            mdm_room_bak.floor_id=case mdm_room_from_sms.floor_id when '无' THEN  NULL ELSE mdm_room_from_sms.floor_id END,
            mdm_room_bak.floor_name=case mdm_room_from_sms.floor_name when '无' THEN  NULL ELSE mdm_room_from_sms.floor_name END,
            mdm_room_bak.sale_state=case mdm_room_from_sms.sale_state when '无' THEN  NULL ELSE mdm_room_from_sms.sale_state END,
            mdm_room_bak.pre_bld_area=case mdm_room_from_sms.build_area_yc when '无' THEN  NULL ELSE mdm_room_from_sms.build_area_yc END,
            mdm_room_bak.pre_in_area=case mdm_room_from_sms.inside_area_yc when '无' THEN  NULL ELSE mdm_room_from_sms.inside_area_yc END,
            mdm_room_bak.actual_bld_area=case mdm_room_from_sms.build_area_sc when '无' THEN  NULL ELSE mdm_room_from_sms.build_area_sc END,
            mdm_room_bak.actual_in_area=case mdm_room_from_sms.inside_area_sc when '无' THEN  NULL ELSE mdm_room_from_sms.inside_area_sc END,
            mdm_room_bak.new_bld_area=case mdm_room_from_sms.build_area_new when '无' THEN  NULL ELSE mdm_room_from_sms.build_area_new END,
            mdm_room_bak.new_in_area=case mdm_room_from_sms.inside_area_new when '无' THEN  NULL ELSE mdm_room_from_sms.inside_area_new END,
            mdm_room_bak.pre_sell_permit_id=case mdm_room_from_sms.preselling_card_id when '无' THEN  NULL ELSE mdm_room_from_sms.preselling_card_id END,
            mdm_room_bak.pre_sell_permit_no=case mdm_room_from_sms.preselling_card_code when '无' THEN  NULL ELSE mdm_room_from_sms.preselling_card_code END,
            mdm_room_bak.pre_sell_permit_date=case when (select is_date(''||mdm_room_from_sms.preselling_card_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.preselling_card_date, 'yyyy-MM-dd')END,
            mdm_room_bak.base_price=case mdm_room_from_sms.base_price when '无' THEN  NULL ELSE mdm_room_from_sms.base_price END,
            mdm_room_bak.base_total=case mdm_room_from_sms.base_total when '无' THEN  NULL ELSE mdm_room_from_sms.base_total END,
            mdm_room_bak.base_total_area_type=case mdm_room_from_sms.base_total_area_type when '无' THEN  NULL ELSE mdm_room_from_sms.base_total_area_type END,
            mdm_room_bak.bz_price=case mdm_room_from_sms.bz_price when '无' THEN  NULL ELSE mdm_room_from_sms.bz_price END,
            mdm_room_bak.bz_total=case mdm_room_from_sms.bz_total when '无' THEN  NULL ELSE mdm_room_from_sms.bz_total END,
            mdm_room_bak.bz_total_area_type=case mdm_room_from_sms.bz_total_area_type when '无' THEN  NULL ELSE mdm_room_from_sms.bz_total_area_type END,
            mdm_room_bak.trade_price=case mdm_room_from_sms.trade_price when '无' THEN  NULL ELSE mdm_room_from_sms.trade_price END,
            mdm_room_bak.trade_total=case mdm_room_from_sms.trade_total when '无' THEN  NULL ELSE mdm_room_from_sms.trade_total END,
            mdm_room_bak.trade_total_area_type=case mdm_room_from_sms.trade_total_area_type when '无' THEN  NULL ELSE mdm_room_from_sms.trade_total_area_type END,
            mdm_room_bak.trade_contract_date=case when (select is_date(''||mdm_room_from_sms.trade_contract_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.trade_contract_date, 'yyyy-MM-dd')END,
            mdm_room_bak.is_area_bc= CASE WHEN mdm_room_from_sms.is_area_bc = '无' OR mdm_room_from_sms.is_area_bc = '否' THEN 0 ELSE 1 END,
            mdm_room_bak.pre_after_bc_total=case mdm_room_from_sms.pre_after_bc_total when '无' THEN  NULL ELSE mdm_room_from_sms.pre_after_bc_total END,
            mdm_room_bak.actual_after_bc_total=case mdm_room_from_sms.fact_after_bc_total when '无' THEN  NULL ELSE mdm_room_from_sms.fact_after_bc_total END,
            mdm_room_bak.is_transfer= CASE WHEN mdm_room_from_sms.is_transfer = '无' OR mdm_room_from_sms.is_transfer = '否' THEN 0 ELSE 1 END,
            mdm_room_bak.pre_transfer_date=case when (select is_date(''||mdm_room_from_sms.pre_transfer_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.pre_transfer_date, 'yyyy-MM-dd')END,
            mdm_room_bak.actual_transfer_date=case when (select is_date(''||mdm_room_from_sms.fact_transfer_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.fact_transfer_date, 'yyyy-MM-dd')END,
            mdm_room_bak.is_indirect=CASE WHEN mdm_room_from_sms.is_indirect = '无' OR mdm_room_from_sms.is_indirect = '否' THEN 0 ELSE 1 END,
            mdm_room_bak.actual_indirect_date=case when (select is_date(''||mdm_room_from_sms.fact_indirect_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.fact_indirect_date, 'yyyy-MM-dd')END,
            mdm_room_bak.actual_indirect_total=case mdm_room_from_sms.fact_indirect_area when '无' THEN  NULL ELSE mdm_room_from_sms.fact_indirect_area END,
            mdm_room_bak.actual_indirect_area=case mdm_room_from_sms.fact_indirect_area when '无' THEN  NULL ELSE mdm_room_from_sms.fact_indirect_area END,
            mdm_room_bak.SYNCH_DATE=''||synchDate||''            
            WHEN NOT MATCHED THEN 
            --新增 将中间表数据 insert 到room_bak 表
       INSERT ( mdm_room_bak.id, mdm_room_bak.room_name, mdm_room_bak.room_code, mdm_room_bak.product_code,
        mdm_room_bak.product_name,
        mdm_room_bak.product_is_cw,
        mdm_room_bak.project_id,
        mdm_room_bak.project_code,
        mdm_room_bak.project_name,
        mdm_room_bak.building_id,
        mdm_room_bak.building_name,
        mdm_room_bak.unit_id,
        mdm_room_bak.unit_name,
        mdm_room_bak.floor_id,
        mdm_room_bak.floor_name,
        mdm_room_bak.sale_state,
        mdm_room_bak.pre_bld_area,
        mdm_room_bak.pre_in_area,
        mdm_room_bak.actual_bld_area,
        mdm_room_bak.actual_in_area,
        mdm_room_bak.new_bld_area,
        mdm_room_bak.new_in_area,
        mdm_room_bak.pre_sell_permit_id,
        mdm_room_bak.pre_sell_permit_no,
        mdm_room_bak.pre_sell_permit_date,
        mdm_room_bak.base_price,
        mdm_room_bak.base_total,
        mdm_room_bak.base_total_area_type,
        mdm_room_bak.bz_price,
        mdm_room_bak.bz_total,
        mdm_room_bak.bz_total_area_type,
        mdm_room_bak.trade_price,
        mdm_room_bak.trade_total,
        mdm_room_bak.trade_total_area_type,
        mdm_room_bak.trade_contract_date,
        mdm_room_bak.is_area_bc,
        mdm_room_bak.pre_after_bc_total,
        mdm_room_bak.actual_after_bc_total,
        mdm_room_bak.is_transfer,
        mdm_room_bak.pre_transfer_date,
        mdm_room_bak.actual_transfer_date,
        mdm_room_bak.is_indirect,
        mdm_room_bak.actual_indirect_date,
        mdm_room_bak.actual_indirect_total,
        mdm_room_bak.actual_indirect_area,
        mdm_room_bak.SYNCH_DATE
    ) values (mdm_room_from_sms.room_id,
       case mdm_room_from_sms.room_name when '无' THEN NULL ELSE mdm_room_from_sms.room_name END,
       case mdm_room_from_sms.room_code when '无' THEN NULL ELSE mdm_room_from_sms.room_code END,
       case mdm_room_from_sms.pt_code when '无' THEN NULL ELSE mdm_room_from_sms.pt_code END,
       case mdm_room_from_sms.pt_name when '无' THEN NULL ELSE mdm_room_from_sms.pt_name END,
       case WHEN mdm_room_from_sms.pt_is_cw='无' OR mdm_room_from_sms.pt_is_cw = '否' THEN 0 ELSE 1 END,
       case mdm_room_from_sms.project_id when '无' THEN NULL ELSE mdm_room_from_sms.project_id END,
       case mdm_room_from_sms.project_code when '无' THEN NULL ELSE mdm_room_from_sms.project_code END,
       case mdm_room_from_sms.project_name when '无' THEN NULL ELSE mdm_room_from_sms.project_name END,
       case mdm_room_from_sms.building_id when '无' THEN NULL ELSE mdm_room_from_sms.building_id END,
       case mdm_room_from_sms.building_name when '无' THEN NULL ELSE mdm_room_from_sms.building_name END,
       case mdm_room_from_sms.unit_id when '无' THEN NULL ELSE mdm_room_from_sms.unit_id END,
       case mdm_room_from_sms.unit_name when '无' THEN NULL ELSE mdm_room_from_sms.unit_name END,
       case mdm_room_from_sms.floor_id when '无' THEN NULL ELSE mdm_room_from_sms.floor_id END,
       case mdm_room_from_sms.floor_name when '无' THEN NULL ELSE mdm_room_from_sms.floor_name END,
       case mdm_room_from_sms.sale_state when '无' THEN NULL ELSE mdm_room_from_sms.sale_state END,
       case mdm_room_from_sms.build_area_yc when '无' THEN NULL ELSE mdm_room_from_sms.build_area_yc END,
       case mdm_room_from_sms.inside_area_yc when '无' THEN NULL ELSE mdm_room_from_sms.inside_area_yc END,
       case mdm_room_from_sms.build_area_sc when '无' THEN NULL ELSE mdm_room_from_sms.build_area_sc END,
       case mdm_room_from_sms.inside_area_sc when '无' THEN NULL ELSE mdm_room_from_sms.inside_area_sc END,
       case mdm_room_from_sms.build_area_new when '无' THEN NULL ELSE mdm_room_from_sms.build_area_new END,
       case mdm_room_from_sms.inside_area_new when '无' THEN NULL ELSE mdm_room_from_sms.inside_area_new END,
       case mdm_room_from_sms.preselling_card_id when '无' THEN NULL ELSE mdm_room_from_sms.preselling_card_id END,
       case mdm_room_from_sms.preselling_card_code when '无' THEN NULL ELSE mdm_room_from_sms.preselling_card_code END,
       case when (select is_date(''||mdm_room_from_sms.preselling_card_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.preselling_card_date, 'yyyy-MM-dd')END,  
       case mdm_room_from_sms.base_price when '无' THEN NULL ELSE mdm_room_from_sms.base_price END,
       case mdm_room_from_sms.base_total when '无' THEN NULL ELSE mdm_room_from_sms.base_total END,
       case mdm_room_from_sms.base_total_area_type when '无' THEN NULL ELSE mdm_room_from_sms.base_total_area_type END,
       case mdm_room_from_sms.bz_price when '无' THEN NULL ELSE mdm_room_from_sms.bz_price END,
       case mdm_room_from_sms.bz_total when '无' THEN NULL ELSE mdm_room_from_sms.bz_total END,
       case mdm_room_from_sms.bz_total_area_type when '无' THEN NULL ELSE mdm_room_from_sms.bz_total_area_type END,
       case mdm_room_from_sms.trade_price when '无' THEN NULL ELSE mdm_room_from_sms.trade_price END,
       case mdm_room_from_sms.trade_total when '无' THEN NULL ELSE mdm_room_from_sms.trade_total END,
       case mdm_room_from_sms.trade_total_area_type when '无' THEN NULL ELSE mdm_room_from_sms.trade_total_area_type END,
        case when (select is_date(''||mdm_room_from_sms.trade_contract_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.trade_contract_date, 'yyyy-MM-dd')END,  
       case WHEN mdm_room_from_sms.is_area_bc='无' OR mdm_room_from_sms.is_area_bc = '否' THEN 0 ELSE 1 END,
       case mdm_room_from_sms.pre_after_bc_total when '无' THEN NULL ELSE mdm_room_from_sms.pre_after_bc_total END,
       case mdm_room_from_sms.fact_after_bc_total when '无' THEN NULL ELSE mdm_room_from_sms.fact_after_bc_total END,
       case WHEN mdm_room_from_sms.is_transfer='无' OR mdm_room_from_sms.is_transfer = '否' THEN 0 ELSE 1 END,    
       case when (select is_date(''||mdm_room_from_sms.pre_transfer_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.pre_transfer_date, 'yyyy-MM-dd')END,  
       case when (select is_date(''||mdm_room_from_sms.fact_transfer_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.fact_transfer_date, 'yyyy-MM-dd')END,
       case WHEN mdm_room_from_sms.is_indirect='无' OR mdm_room_from_sms.is_indirect = '否' THEN 0 ELSE 1 END,
       case when (select is_date(''||mdm_room_from_sms.fact_indirect_date||'') from dual)=0 THEN NULL  ELSE TO_DATE(mdm_room_from_sms.fact_indirect_date, 'yyyy-MM-dd')END,
       case mdm_room_from_sms.fact_indirect_total when '无' THEN NULL ELSE mdm_room_from_sms.fact_indirect_total END,
       case mdm_room_from_sms.fact_indirect_area when '无' THEN NULL ELSE mdm_room_from_sms.fact_indirect_area END,
       synchDate
    );
    COMMIT;
end;
/

prompt
prompt Creating procedure P_MDM_VERIFY_ATTR_AREA_USE
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_MDM_VERIFY_ATTR_AREA_USE(
    attrid     IN         VARCHAR2_LIST,--输入变量：单位面积等级id集合
    attrtype   IN         INT,--0单位面积等级,10项目合作属性,20经营属性
    message    OUT        VARCHAR2,--提示消息
    isuse      OUT        INT--0未使用，1已使用
) IS
    --验证业态是否被使用
--作者：陈丽
--日期：2019/11/17
    idStr varchar2(300);
    typeName varchar(50);
BEGIN
    BEGIN
        for i in 1..attrid.count loop
                idStr:= idStr || ',$' || attrid(i) || '#';
        end loop;
        isuse := -1;
        message := '验证通过';
        --查看是否在指标表使用---先单个后期调整
        if attrtype = 0 then
            SELECT COUNT(1) INTO isuse
            FROM mdm_obj_phase_area_level
            WHERE instr(idStr, '$'||id||'#') > 0;
            typeName := '单位面积等级';
        end if;
        if attrtype = 10 then
            SELECT COUNT(1) INTO isuse
            FROM MDM_PROJECT where instr(idStr, '$'||PROJ_COOPERATE_ID||'#') > 0;
            typeName := '项目合作属性';
        end if;
        if attrtype = 20 then
            select COUNT(1) into isuse
            from MDM_OBJ_PHASE_PT_INDEX
            where instr(idStr, '$'||OPERATE_ATTRIBUTE_ID||'#') > 0;
            typeName := '经营属性类别';
        end if;
        if isuse = -1 then
            message := '属性类别未找到';
        end if;
        IF isuse > 0 THEN
            isuse := 1;
            message := typeName || '已被使用不允许删除';
        end if;
    END;
END P_MDM_VERIFY_ATTR_AREA_USE;
/

prompt
prompt Creating procedure P_MDM_VERIFY_PERIOD_USE
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_mdm_verify_period_use (
    periodoriginalid   IN                 VARCHAR2_LIST,--输入变量：分期原始id,多个逗号分隔
message OUT VARCHAR2,--提示消息
isuse OUT INT--0未使用，1已使用
) IS--验证分期是否被使用
--作者：陈丽
--日期：2019/11/17
--分期删除验证计划（全盘、关键节点、项目主项计划）是否使用，目标货值是否使用，证照是否使用，主数据维护是否使用）
BEGIN
    BEGIN
        isuse := 0;
        FOR I IN 1 .. periodoriginalid.COUNT
            LOOP
                SELECT
                        COUNT(period_id)+isuse
                INTO isuse
                FROM
                    mdm_period_phase
                WHERE period_id = periodoriginalid(I);
            END LOOP;
        IF isuse > 0 THEN
            isuse := 1;
            message := '分期已存在指标数据不允许删除';
        END IF;
    END;
    
--分期删除验证计划（关键节点、项目主项计划）是否使用
--SELECT COUNT(id) INTO PLAN_USE FROM POM_PROJ_PLAN WHERE PROJ_ID IN (SELECT column_value FROM TABLE ( split(periodoriginalid) ))   ; 
----分期删除验证,目标货值是否使用
--SELECT COUNT(id) INTO TARGET_WORTH_Use FROM DWM_TARGET_WORTH_DTL WHERE OBJ_ID IN (SELECT column_value FROM TABLE ( split(periodoriginalid) ))   ; 
----证照是否使用
--SELECT COUNT(id) INTO PERMIT_USE FROM MDM_PERMIT WHERE PROJECT_ID IN (SELECT column_value FROM TABLE ( split(periodoriginalid) ))   ;  
----主数据维护是否使用
--SELECT COUNT(period_id) INTO PHASE_USE FROM mdm_period_phase WHERE period_id IN (SELECT column_value FROM TABLE ( split(periodoriginalid) ))   ;  

    
END p_mdm_verify_period_use;
/

prompt
prompt Creating procedure P_MDM_VERIFY_PRODUCT_TYPE_USE
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_MDM_VERIFY_PRODUCT_TYPE_USE" (
    ptid   IN           VARCHAR2,--输入变量：业态id。多个逗号分隔，
    message      OUT          VARCHAR2,--提示消息
    isuse        OUT          INT--0未使用，1已使用
) IS
    -- 复制于P_MDM_VERIFY_PRODUCT_TYPE_USE
--验证业态是否被使用
--作者：韩金明
--日期：2020/03/23
    nodeName varchar(50);
    projectName varchar(50);
BEGIN
    isuse := 0;
    --查看分期是否在指标表使用
    select count(*) into isuse from MDM_OBJ_PHASE_PT_INDEX
    where PRODUCT_TYPE_ID = ptid;
    IF isuse > 0 THEN
        declare
            -- 定义游标
            cursor list is
                select OBJ_PHASE_ID, OBJ_TYPE from MDM_OBJ_PHASE_PT_INDEX
                where PRODUCT_TYPE_ID = ptid;
        begin
            -- 打开游标循环遍历数据
            for item in list loop
                begin
                    -- 为项目关联业态
                    if item.OBJ_TYPE = 0 then
                        select PROJECT_NAME into projectName from MDM_PROJECT a
                        where a.id = item.OBJ_PHASE_ID and ROWNUM < 2;
                    end if;
                    -- 为宗地关联业态
                    if item.OBJ_TYPE = 10 then
                        select a.PROJECT_NAME into projectName  from MDM_PARCEL a
                        where a.id = item.OBJ_PHASE_ID and ROWNUM < 2;
                    end if;
                    -- 为分期关联业态
                    if item.OBJ_TYPE = 20 then
                        select a.PROJECT_NAME into projectName
                        from MDM_PROJECT a
                             left join MDM_PERIOD_VERSION b on a.id = b.PROJECT_ID
                             left join MDM_PERIOD c on b.id = c.PERIOD_VERSION_ID
                        where c.id = item.OBJ_PHASE_ID and ROWNUM < 2;
                    end if;
                    -- 为楼栋关联业态
                    if item.OBJ_TYPE = 30 then
                        select a.PROJECT_NAME into projectName
                        from MDM_PROJECT a
                             left join MDM_PERIOD_VERSION b on a.id = b.PROJECT_ID
                             left join MDM_PERIOD c on b.id = c.PERIOD_VERSION_ID
                             left join MDM_BUILD d on c.id = d.PERIOD_ID
                             left join MDM_BUILD_PHASE e on d.id = e.BUILD_ID
                        where e.id = item.OBJ_PHASE_ID and ROWNUM < 2;
                    end if;
                EXCEPTION
                    -- 未找到数据 置为空
                    when OTHERS then
                        projectName := null;
                end;
                -- 找到关联项目, 退出循环
                if projectName is not null then
                    -- 获取节点名称
                    select PRODUCT_TYPE_SHORT_NAME into nodeName from MDM_BUILD_PRODUCT_TYPE
                    where id = ptid;
                    isuse := 1;
                    DBMS_OUTPUT.PUT_LINE('isuse:' || isuse);
                    message := '验证失败提示：节点' || nodeName ||'已被项目' || projectName || '使用, 不允许删除。';
                    exit;
                end if;
            end loop;
        end;
    END IF;
    if message is null then
        isuse := 0;
        message := '验证通过';
        DBMS_OUTPUT.PUT_LINE('isuse2:' || isuse);
    end if;
END P_MDM_VERIFY_PRODUCT_TYPE_USE;
/

prompt
prompt Creating procedure P_POM_CURRENT_DELAY
prompt ======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_CURRENT_DELAY" (planType in VARCHAR2
,dataScope in VARCHAR2
,searchKey in VARCHAR2
,orgId  in VARCHAR2
,currentDelay OUT sys_refcursor)
AS
BEGIN
open currentDelay for
SELECT
    p.company_name as  "orgName",
    proj_name as "projName",
    node_name as "nodeName",
    '' as "projOpenUrl",
    '' as "nodeOpenUrl",
    ROUND(TO_NUMBER(plan_end_date-sysdate)) as "delayDays"
FROM
    pom_proj_plan_node n
    left join
    pom_proj_plan p on  n.proj_plan_id=p.id where proj_name is not null;

END p_pom_current_delay;
/

prompt
prompt Creating procedure P_POM_DELAY_NODE_CURRENT
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_DELAY_NODE_CURRENT
(
		PLANTYPE     IN VARCHAR2
	 ,DATASCOPE    IN VARCHAR2
	 ,SEARCHKEY    IN VARCHAR2
	 ,ORGID        IN VARCHAR2
	 ,CURRENTDELAY OUT SYS_REFCURSOR
) AS --关键节点计划监控-当前延误节点
		--作者：陈丽
		--日期：2019/11/13
BEGIN

		IF DATASCOPE = 'thisMonth' THEN
				OPEN CURRENTDELAY FOR
						SELECT DISTINCT A.ORG_NAME AS "orgName",
														B2.PROJECTSTAGE_NAME AS "projName",
														B2.NODE_NAME AS "nodeName",
														'/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||
														 NVL(B2.COMPANY_ID, '003200000000000000000000000000') ||
														 '&ppid=' || B2.PPID || '&planType=关键节点计划' AS "projOpenUrl",
														'/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' ||
														 B2.PLANID || '&feedbackNodeId=' || NODE_ID ||
														 '&feedbackNodeOriginalId=' || ORIGINAL_NODE_ID ||
														 '&nodeSourcePlanType=0' AS "nodeOpenUrl",
														TRUNC(SYSDATE, 'dd') -
														 TRUNC(PLAN_END_DATE, 'dd') AS "delayDays"
						FROM   SYS_BUSINESS_UNIT A
						LEFT   JOIN (SELECT LEVEL, ORG_NAME, CONNECT_BY_ROOT ID AS ID,
																CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
																B.UNIT_ID, B.NODE_NAME, B.NODE_ID,
																B.ACTUAL_END_DATE, B.PLAN_END_DATE,
																B.PROJECTSTAGE_NAME, B.PPID, B.PID,
																'TYPE_ORG' AS CTYPE, B.ESTIMATE_END_DATE,
																B.PLANID, ORIGINAL_NODE_ID,B.COMPANY_ID
												 FROM   SYS_BUSINESS_UNIT A
												 LEFT   JOIN (SELECT B1.UNIT_ID, A.ID AS PLANID,A.COMPANY_ID,
																						A.PROJ_ID AS PPID, B1.ID AS PID,
																						A1.ORIGINAL_NODE_ID,
																				
																						 A.PROJ_NAME AS PROJECTSTAGE_NAME,
																						A1.NODE_NAME, A1.ID AS NODE_ID,
																						A1.ACTUAL_END_DATE,
																						A1.PLAN_END_DATE,
																						A1.ESTIMATE_END_DATE
																		 FROM   POM_PROJ_PLAN A
																		 INNER  JOIN POM_PROJ_PLAN_NODE A1
																		 ON     A.ID = A1.PROJ_PLAN_ID
																		 INNER  JOIN SYS_PROJECT_STAGE C1
																		 ON     A.PROJ_ID = C1.ID
																		 INNER  JOIN SYS_PROJECT B1
																		 ON     C1.PROJECT_ID = B1.ID
																		 WHERE  A.PLAN_TYPE = '关键节点计划' AND
																						A.APPROVAL_STATUS = '已审核' 	AND
																						A1.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||'-'||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else'12' end ||'-'||'26'  FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')  AND
 TO_DATE ((SELECT    A.铁建_本年||'-'||铁建_本月||'-'||'25' FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')  AND   
																						TRUNC(SYSDATE, 'dd') -TRUNC(PLAN_END_DATE, 'dd') > 0 AND
																						ACTUAL_END_DATE IS NULL) B
												 ON     A.ID = B.UNIT_ID
												 WHERE  ORG_TYPE = 0
												 START  WITH ID = '' || ORGID || ''
												 CONNECT BY PRIOR A.ID = A.PARENT_ID) B2
						ON     A.ID = B2.ID
						WHERE  NODE_NAME IS NOT NULL AND
									 ACTUAL_END_DATE IS NULL AND
									 TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 --分期
						UNION ALL
						SELECT DISTINCT '' AS "orgName",
													 A.PROJ_NAME AS "projName",
														A1.NODE_NAME AS "nodeName",
														'/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||
														 NVL(A.COMPANY_ID,
																 '003200000000000000000000000001') ||
														 '&ppid=' || a.PROJ_ID || '&planType=关键节点计划' AS "projOpenUrl",
														'/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || A.ID ||
														 '&feedbackNodeId=' || A1.ID ||
														 '&feedbackNodeOriginalId=' ||
														 A1.ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
														TRUNC(SYSDATE, 'dd') -
														 TRUNC(PLAN_END_DATE, 'dd') AS "delayDays"
						FROM   POM_PROJ_PLAN A
						INNER  JOIN POM_PROJ_PLAN_NODE A1
						ON     A.ID = A1.PROJ_PLAN_ID
						INNER  JOIN SYS_PROJECT_STAGE C1
						ON     A.PROJ_ID = C1.ID
						INNER  JOIN SYS_PROJECT B1
						ON     C1.PROJECT_ID = B1.ID
						WHERE  A.PLAN_TYPE = '关键节点计划' AND
									 A.APPROVAL_STATUS = '已审核'   AND
							A1.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||'-'||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else'12' end ||'-'||'26'  FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')  AND
 TO_DATE ((SELECT    A.铁建_本年||'-'||铁建_本月||'-'||'25' FROM V_POM_GETEXAMINE_MOTH A),'yyyy-mm-dd')   AND
									 TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 AND
									 ACTUAL_END_DATE IS NULL AND
									 C1.PROJECT_ID = '' || ORGID || ''
						ORDER  BY 6 DESC;
		
		ELSIF DATASCOPE = 'thisQuarter' THEN
				OPEN CURRENTDELAY FOR
						SELECT DISTINCT A.ORG_NAME AS "orgName",
														B2.PROJECTSTAGE_NAME AS "projName",
														B2.NODE_NAME AS "nodeName",
														'/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||
														 NVL(B2.COMPANY_ID,
																 '003200000000000000000000000002') ||
														 '&ppid=' || B2.PPID || '&planType=关键节点计划' AS "projOpenUrl",
														'/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' ||
														 B2.PLANID || '&feedbackNodeId=' || NODE_ID ||
														 '&feedbackNodeOriginalId=' || ORIGINAL_NODE_ID ||
														 '&nodeSourcePlanType=0' AS "nodeOpenUrl",
														TRUNC(SYSDATE, 'dd') -
														 TRUNC(PLAN_END_DATE, 'dd') AS "delayDays"
						FROM   SYS_BUSINESS_UNIT A
						LEFT   JOIN (SELECT LEVEL, ORG_NAME, CONNECT_BY_ROOT ID AS ID,
																CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
																B.UNIT_ID, B.NODE_NAME, B.NODE_ID,
																B.ACTUAL_END_DATE, B.PLAN_END_DATE,
																B.PROJECTSTAGE_NAME, B.PPID, B.PID,
																'TYPE_ORG' AS CTYPE, B.ESTIMATE_END_DATE,
																B.PLANID, ORIGINAL_NODE_ID,B.COMPANY_ID
												 FROM   SYS_BUSINESS_UNIT A
												 LEFT   JOIN (SELECT B1.UNIT_ID, A.ID AS PLANID,A.COMPANY_ID,
																						A.PROJ_ID AS PPID, B1.ID AS PID,
																						A1.ORIGINAL_NODE_ID,
																						
																						 A.PROJ_NAME AS PROJECTSTAGE_NAME,
																						A1.NODE_NAME, A1.ID AS NODE_ID,
																						A1.ACTUAL_END_DATE,
																						A1.PLAN_END_DATE,
																						A1.ESTIMATE_END_DATE
																		 FROM   POM_PROJ_PLAN A
																		 INNER  JOIN POM_PROJ_PLAN_NODE A1
																		 ON     A.ID = A1.PROJ_PLAN_ID
																		 INNER  JOIN SYS_PROJECT_STAGE C1
																		 ON     A.PROJ_ID = C1.ID
																		 INNER  JOIN SYS_PROJECT B1
																		 ON     C1.PROJECT_ID = B1.ID
																		 WHERE  A.PLAN_TYPE = '关键节点计划' AND
																						A.APPROVAL_STATUS = '已审核' --判断季度
																					 --判断季度
																					 
																						AND
																					A1.PLAN_END_DATE BETWEEN
																		 TO_DATE( 			(	SELECT A.开始年度||'-'||A.开始月份||'-26'   FROM V_POM_GETEXAMINE_QUARTER A),'YYYY-MM-DD')  AND
 TO_DATE((	SELECT A.结束年度||'-'||A.结束月份||'-25' FROM V_POM_GETEXAMINE_QUARTER A),'YYYY-MM-DD')
							AND
																						TRUNC(SYSDATE, 'dd') -
																						TRUNC(PLAN_END_DATE, 'dd') > 0 AND
																						ACTUAL_END_DATE IS NULL) B
												 ON     A.ID = B.UNIT_ID
												 WHERE  ORG_TYPE = 0
												 START  WITH ID = '' || ORGID || ''
												 CONNECT BY PRIOR A.ID = A.PARENT_ID) B2
						ON     A.ID = B2.ID
						WHERE  NODE_NAME IS NOT NULL AND
									 ACTUAL_END_DATE IS NULL AND
									 TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 --分期
						UNION ALL
						SELECT DISTINCT '' AS "orgName",
														 A.PROJ_NAME AS "projName",
														A1.NODE_NAME AS "nodeName",
														'/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||
														 NVL(A.COMPANY_ID,
																 '003200000000000000000000000000') ||
														 '&ppid=' || C1.ID || '&planType=关键节点计划' AS "projOpenUrl",
														'/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || A.ID ||
														 '&feedbackNodeId=' || A1.ID ||
														 '&feedbackNodeOriginalId=' ||
														 A1.ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
														TRUNC(SYSDATE, 'dd') -
														 TRUNC(PLAN_END_DATE, 'dd') AS "delayDays"
						FROM   POM_PROJ_PLAN A
						INNER  JOIN POM_PROJ_PLAN_NODE A1
						ON     A.ID = A1.PROJ_PLAN_ID
						INNER  JOIN SYS_PROJECT_STAGE C1
						ON     A.PROJ_ID = C1.ID
						INNER  JOIN SYS_PROJECT B1
						ON     C1.PROJECT_ID = B1.ID
						WHERE  A.PLAN_TYPE = '关键节点计划' AND
									 A.APPROVAL_STATUS = '已审核' --判断季度
									
									 AND
									 A1.PLAN_END_DATE  BETWEEN
																										 TO_DATE( 			(	SELECT A.开始年度||'-'||A.开始月份||'-26'   FROM V_POM_GETEXAMINE_QUARTER A),'YYYY-MM-DD')  AND
 TO_DATE((	SELECT A.结束年度||'-'||A.结束月份||'-25' FROM V_POM_GETEXAMINE_QUARTER A),'YYYY-MM-DD') AND
									 TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 AND
									 ACTUAL_END_DATE IS NULL AND
									 C1.PROJECT_ID = '' || ORGID || ''
						ORDER  BY 6 DESC;
		ELSIF DATASCOPE = 'thisYear' THEN
				OPEN CURRENTDELAY FOR
						SELECT DISTINCT A.ORG_NAME AS "orgName",
														B2.PROJECTSTAGE_NAME AS "projName",
														B2.NODE_NAME AS "nodeName",
														'/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||
														 NVL(B2.COMPANY_ID,
																 '003200000000000000000000000000') ||
														 '&ppid=' || B2.PPID || '&planType=关键节点计划' AS "projOpenUrl",
														'/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' ||
														 B2.PLANID || '&feedbackNodeId=' || NODE_ID ||
														 '&feedbackNodeOriginalId=' || ORIGINAL_NODE_ID ||
														 '&nodeSourcePlanType=0' AS "nodeOpenUrl",
														TRUNC(SYSDATE, 'dd') -
														 TRUNC(PLAN_END_DATE, 'dd') AS "delayDays"
						FROM   SYS_BUSINESS_UNIT A
						LEFT   JOIN (SELECT LEVEL, ORG_NAME, CONNECT_BY_ROOT ID AS ID,
																CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
																B.UNIT_ID, B.NODE_NAME, B.NODE_ID,
																B.ACTUAL_END_DATE, B.PLAN_END_DATE,
																B.PROJECTSTAGE_NAME, B.PPID, B.PID,
																'TYPE_ORG' AS CTYPE, B.ESTIMATE_END_DATE,
																B.PLANID, ORIGINAL_NODE_ID,B.COMPANY_ID
												 FROM   SYS_BUSINESS_UNIT A
												 LEFT   JOIN (SELECT B1.UNIT_ID, A.ID AS PLANID,A.COMPANY_ID,
																						A.PROJ_ID AS PPID, B1.ID AS PID,
																						A1.ORIGINAL_NODE_ID,
																						
																						 A.PROJ_NAME AS PROJECTSTAGE_NAME,
																						A1.NODE_NAME, A1.ID AS NODE_ID,
																						A1.ACTUAL_END_DATE,
																						A1.PLAN_END_DATE,
																						A1.ESTIMATE_END_DATE
																		 FROM   POM_PROJ_PLAN A
																		 INNER  JOIN POM_PROJ_PLAN_NODE A1
																		 ON     A.ID = A1.PROJ_PLAN_ID
																		 INNER  JOIN SYS_PROJECT_STAGE C1
																		 ON     A.PROJ_ID = C1.ID
																		 INNER  JOIN SYS_PROJECT B1
																		 ON     C1.PROJECT_ID = B1.ID
																		 WHERE  A.PLAN_TYPE = '关键节点计划' AND
																						A.APPROVAL_STATUS = '已审核' AND
																						PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||'-12'||'-26','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||'-12'||'-25','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH)  AND
																						TRUNC(SYSDATE, 'dd') -
																						TRUNC(PLAN_END_DATE, 'dd') > 0 AND
																						ACTUAL_END_DATE IS NULL) B
												 ON     A.ID = B.UNIT_ID
												 WHERE  ORG_TYPE = 0
												 START  WITH ID = '' || ORGID || ''
												 CONNECT BY PRIOR A.ID = A.PARENT_ID) B2
						ON     A.ID = B2.ID
						WHERE  NODE_NAME IS NOT NULL AND
									 ACTUAL_END_DATE IS NULL AND
									 TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 --分期
						UNION ALL
						SELECT DISTINCT '' AS "orgName",
														A.PROJ_NAME AS "projName",
														A1.NODE_NAME AS "nodeName",
														'/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||
														 NVL(A.COMPANY_ID,
																 '003200000000000000000000000000') ||
														 '&ppid=' || C1.ID || '&planType=关键节点计划' AS "projOpenUrl",
														'/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || A.ID ||
														 '&feedbackNodeId=' || A1.ID ||
														 '&feedbackNodeOriginalId=' ||
														 A1.ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
														TRUNC(SYSDATE, 'dd') -
														 TRUNC(PLAN_END_DATE, 'dd') AS "delayDays"
						FROM   POM_PROJ_PLAN A
						INNER  JOIN POM_PROJ_PLAN_NODE A1
						ON     A.ID = A1.PROJ_PLAN_ID
						INNER  JOIN SYS_PROJECT_STAGE C1
						ON     A.PROJ_ID = C1.ID
						INNER  JOIN SYS_PROJECT B1
						ON     C1.PROJECT_ID = B1.ID
						WHERE  A.PLAN_TYPE = '关键节点计划' AND
									 A.APPROVAL_STATUS = '已审核' AND
									PLAN_END_DATE  BETWEEN (SELECT TO_DATE( "铁建_本年"-1||'-12'||'-26','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||'-12'||'-25','YYYY-MM-DD') FROM V_POM_GETEXAMINE_MOTH)
										AND
									 TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 AND
									 ACTUAL_END_DATE IS NULL AND
									 C1.PROJECT_ID = '' || ORGID || ''
						ORDER  BY 6 DESC;
		END IF;

END P_POM_DELAY_NODE_CURRENT;
/

prompt
prompt Creating procedure P_POM_DELAY_NODE_PREDICT
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_delay_node_predict (
    planType IN VARCHAR2,
    dataScope IN VARCHAR2,
    searchKey IN VARCHAR2,
    orgId IN VARCHAR2,
    currentDelay OUT sys_refcursor 
  ) AS --关键节点计划监控-预计延误节点
--作者：陈丽
--日期：2019/11/13
BEGIN
  IF
    DATASCOPE = 'thisMonth' THEN
      open currentDelay FOR
      SELECT DISTINCT
      A.ORG_NAME AS "orgName",
      B2.PROJECTSTAGE_NAME AS "projName",
      B2.NODE_NAME AS "nodeName",
      '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' || A.id || '&ppid=' || B2.PPID || '&planType=关键节点计划' AS "projOpenUrl",
      '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || B2.PLANID || '&feedbackNodeId=' || NODE_ID || '&feedbackNodeOriginalId=' || ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
      TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) AS "delayDays" 
    FROM
      SYS_BUSINESS_UNIT a
      LEFT JOIN (
      SELECT LEVEL
        ,
        ORG_NAME,
        CONNECT_BY_ROOT ID AS ID,
        CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
        B.UNIT_ID,
        B.NODE_NAME,
        B.NODE_ID,
        B.ACTUAL_END_DATE,
        B.PLAN_END_DATE,
        B.PROJECTSTAGE_NAME,
        B.PPID,
        B.PID,
        'TYPE_ORG' AS CTYPE,
        B.ESTIMATE_END_DATE,
        PLANID,
        ORIGINAL_NODE_ID 
      FROM
        SYS_BUSINESS_UNIT A
        LEFT JOIN (
        SELECT
          B1.UNIT_ID,
          A.ID AS PLANID,
          A1.ORIGINAL_NODE_ID,
          A.PROJ_ID AS PPID,
          B1.ID AS PID,
           A.PROJ_NAME AS PROJECTSTAGE_NAME,
          A1.NODE_NAME,
          A1.ID AS NODE_ID,
          A1.ACTUAL_END_DATE,
          A1.PLAN_END_DATE,
          A1.ESTIMATE_END_DATE 
        FROM
          POM_PROJ_PLAN A
          INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
          INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
          INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
        WHERE
          A.PLAN_TYPE = '关键节点计划' 
          AND A.APPROVAL_STATUS = '已审核' 
          AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5)
          AND ACTUAL_END_DATE IS NULL 
          AND TO_CHAR( A1.PLAN_END_DATE, 'YYYY-MM-DD' ) BETWEEN (
          SELECT
            A.铁建_本年 || '-' || TO_CHAR( TO_NUMBER( 铁建_本月 ) - 1 ) || '-' || '26' 
          FROM
            V_POM_GETEXAMINE_MOTH A 
          ) 
          AND (
          SELECT
            A.铁建_本年 || '-' ||铁建_本月 || '-' || '25' 
          FROM
            V_POM_GETEXAMINE_MOTH A 
          ) 
        ) B ON A.ID = B.UNIT_ID 
      WHERE
        ORG_TYPE = 0 START WITH ID = '' || orgId || '' CONNECT BY PRIOR A.ID = A.PARENT_ID 
      ) B2 ON A.ID = B2.ID 
    WHERE
      NODE_NAME IS NOT NULL 
      AND ACTUAL_END_DATE IS NULL 
			--判断条件
    AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5 --5天内到期
				)
				
			--分期
    UNION ALL
    SELECT DISTINCT
      '' AS "orgName",
       A.PROJ_NAME AS "projName",
      A1.NODE_NAME AS "nodeName",
      '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||A.COMPANY_ID || '&ppid=' || A.PROJ_ID || '&planType=关键节点计划' AS "projOpenUrl",
      '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || A.ID || '&feedbackNodeId=' || A1.ID || '&feedbackNodeOriginalId=' || A1.ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
      TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) AS "delayDays" 
    FROM
      POM_PROJ_PLAN A
      INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
      INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
      INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
    WHERE
      A.PLAN_TYPE = '关键节点计划' 
      AND A.APPROVAL_STATUS = '已审核' 
      AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5)
      AND ACTUAL_END_DATE IS NULL 
      AND TO_CHAR( A1.PLAN_END_DATE, 'YYYY-MM-DD' ) BETWEEN (
      SELECT
        A.铁建_本年 || '-' || TO_CHAR( TO_NUMBER( 铁建_本月 ) - 1 ) || '-' || '26' 
      FROM
        V_POM_GETEXAMINE_MOTH A 
      ) 
      AND (
      SELECT
        A.铁建_本年 || '-' ||铁建_本月 || '-' || '25' 
      FROM
        V_POM_GETEXAMINE_MOTH A 
      ) 
      AND C1.PROJECT_ID = '' || orgId || '' 
    ORDER BY
      6 DESC;
    ELSIF
      DATASCOPE = 'thisQuarter' THEN
        open currentDelay FOR 
				SELECT DISTINCT
        A.ORG_NAME AS "orgName",
        B2.PROJECTSTAGE_NAME AS "projName",
        B2.NODE_NAME AS "nodeName",
        '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' || A.COMPANY_ID ||  '&ppid=' || B2.PPID || '&planType=关键节点计划' AS "projOpenUrl",
        '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || B2.PLANID || '&feedbackNodeId=' || NODE_ID || '&feedbackNodeOriginalId=' || ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
        TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) AS "delayDays" 
      FROM
        SYS_BUSINESS_UNIT a
        LEFT JOIN (
        SELECT LEVEL
          ,
          ORG_NAME,
          CONNECT_BY_ROOT ID AS ID,
          CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
          B.UNIT_ID,
          B.NODE_NAME,
          B.NODE_ID,
          B.ACTUAL_END_DATE,
          B.PLAN_END_DATE,
          B.PROJECTSTAGE_NAME,
          B.PPID,
          B.PID,
          'TYPE_ORG' AS CTYPE,
          B.ESTIMATE_END_DATE,
          PLANID,
          ORIGINAL_NODE_ID 
        FROM
          SYS_BUSINESS_UNIT A
          LEFT JOIN (
          SELECT
            B1.UNIT_ID,
            A.ID AS PLANID,
            A1.ORIGINAL_NODE_ID,
            A.PROJ_ID AS PPID,
            B1.ID AS PID,
            A.PROJ_NAME AS PROJECTSTAGE_NAME,
            A1.NODE_NAME,
            A1.ID AS NODE_ID,
            A1.ACTUAL_END_DATE,
            A1.PLAN_END_DATE,
            A1.ESTIMATE_END_DATE 
          FROM
            POM_PROJ_PLAN A
            INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
            INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
            INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
          WHERE
            A.PLAN_TYPE = '关键节点计划' 
            AND A.APPROVAL_STATUS = '已审核' 
           AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5)
            AND ACTUAL_END_DATE IS NULL 
            AND TO_CHAR( A1.PLAN_END_DATE, 'YYYY-MM-DD' ) BETWEEN (
            SELECT
              A.开始年度 || '-' || A.开始月份 || '-26' 
            FROM
              V_POM_GETEXAMINE_QUARTER A 
            ) 
            AND (
            SELECT
              A.结束年度 || '-' || A.结束月份 || '-25' 
            FROM
              V_POM_GETEXAMINE_QUARTER A 
            ) 
          ) B ON A.ID = B.UNIT_ID 
        WHERE
          ORG_TYPE = 0 START WITH ID = '' || orgId || '' CONNECT BY PRIOR A.ID = A.PARENT_ID 
        ) B2 ON A.ID = B2.ID 
      WHERE
        NODE_NAME IS NOT NULL 
        AND ACTUAL_END_DATE IS NULL 
        AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5)
      UNION ALL
      SELECT DISTINCT
        '' AS "orgName",
         A.PROJ_NAME AS "projName",
        A1.NODE_NAME AS "nodeName",
        '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' || A.COMPANY_ID|| '&ppid=' || C1.ID || '&planType=关键节点计划' AS "projOpenUrl",
        '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || A.ID || '&feedbackNodeId=' || A1.ID || '&feedbackNodeOriginalId=' || A1.ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
        TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) AS "delayDays" 
      FROM
        POM_PROJ_PLAN A
        INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
        INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
        INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
      WHERE
        A.PLAN_TYPE = '关键节点计划' 
        AND A.APPROVAL_STATUS = '已审核' 
        AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5)
        AND ACTUAL_END_DATE IS NULL 
        AND TO_CHAR( A1.PLAN_END_DATE, 'YYYY-MM-DD' ) BETWEEN (
        SELECT
          A.开始年度 || '-' || A.开始月份 || '-26' 
        FROM
          V_POM_GETEXAMINE_QUARTER A 
        ) 
        AND (
        SELECT
          A.结束年度 || '-' || A.结束月份 || '-25' 
        FROM
          V_POM_GETEXAMINE_QUARTER A 
        ) 
        AND C1.PROJECT_ID = '' || orgId || '' 
      ORDER BY
        6 DESC;
      ELSIF
        DATASCOPE = 'thisYear' THEN
          open currentDelay FOR SELECT DISTINCT
          A.ORG_NAME AS "orgName",
          B2.PROJECTSTAGE_NAME AS "projName",
          B2.NODE_NAME AS "nodeName",
          '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' || A.COMPANY_ID || '&ppid=' || B2.PPID || '&planType=关键节点计划' AS "projOpenUrl",
          '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || B2.PLANID || '&feedbackNodeId=' || NODE_ID || '&feedbackNodeOriginalId=' || ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
          TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) AS "delayDays" 
        FROM
          SYS_BUSINESS_UNIT a
          LEFT JOIN (
          SELECT LEVEL
            ,
            ORG_NAME,
            CONNECT_BY_ROOT ID AS ID,
            CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
            B.UNIT_ID,
            B.NODE_NAME,
            B.NODE_ID,
            B.ACTUAL_END_DATE,
            B.PLAN_END_DATE,
            B.PROJECTSTAGE_NAME,
            B.PPID,
            B.PID,
            'TYPE_ORG' AS CTYPE,
            B.ESTIMATE_END_DATE,
            PLANID,
            ORIGINAL_NODE_ID 
          FROM
            SYS_BUSINESS_UNIT A
            LEFT JOIN (
            SELECT
              B1.UNIT_ID,
              A.ID AS PLANID,
              A1.ORIGINAL_NODE_ID,
              A.PROJ_ID AS PPID,
              B1.ID AS PID,
              A.PROJ_NAME AS PROJECTSTAGE_NAME,
              A1.NODE_NAME,
              A1.ID AS NODE_ID,
              A1.ACTUAL_END_DATE,
              A1.PLAN_END_DATE,
              A1.ESTIMATE_END_DATE 
            FROM
              POM_PROJ_PLAN A
              INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
              INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
              INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
            WHERE
              A.PLAN_TYPE = '关键节点计划' 
              AND A.APPROVAL_STATUS = '已审核' 
              AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5) 
              AND ACTUAL_END_DATE IS NULL 
              AND TO_CHAR( A1.PLAN_END_DATE, 'YYYY' ) = TO_CHAR( SYSDATE, 'YYYY' ) 
            ) B ON A.ID = B.UNIT_ID 
          WHERE
            ORG_TYPE = 0 START WITH ID = '' || orgId || '' CONNECT BY PRIOR A.ID = A.PARENT_ID 
          ) B2 ON A.ID = B2.ID 
        WHERE
          NODE_NAME IS NOT NULL 
          AND ACTUAL_END_DATE IS NULL 
          AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5) --分期
        UNION ALL
        SELECT DISTINCT
          '' AS "orgName",
          A.PROJ_NAME AS "projName",
          A1.NODE_NAME AS "nodeName",
          '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' || A.COMPANY_ID || '&ppid=' || C1.ID || '&planType=关键节点计划' AS "projOpenUrl",
          '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || A.ID || '&feedbackNodeId=' || A1.ID || '&feedbackNodeOriginalId=' || A1.ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
          TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) AS "delayDays" 
        FROM
          POM_PROJ_PLAN A
          INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
          INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
          INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
        WHERE
          A.PLAN_TYPE = '关键节点计划' 
          AND A.APPROVAL_STATUS = '已审核' 
          AND (TRUNC( ESTIMATE_END_DATE, 'dd' ) - TRUNC( PLAN_END_DATE, 'dd' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5)
          AND ACTUAL_END_DATE IS NULL 
          AND TO_CHAR( A1.PLAN_END_DATE, 'YYYY' ) = TO_CHAR( SYSDATE, 'YYYY' ) 
          AND C1.PROJECT_ID = '' || orgId || '' 
        ORDER BY
          6 DESC;
      END IF;
END p_pom_delay_node_predict;
/

prompt
prompt Creating procedure P_POM_DEPT_MONTHLY_PLAN
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_dept_monthly_plan (
    currentcompanyid     IN            VARCHAR2,--当前用户公司
    currentstationid     IN            VARCHAR2,---当前用户的岗位
    currentdeptid        IN            VARCHAR2,---当前用户的部门
    currentuserid        IN            VARCHAR2,---当前用户id 
    companyid     IN            VARCHAR2,---当前选择的公司
    deptid     IN            VARCHAR2,---当前选择的部门
    bizcode       IN            VARCHAR2,---权限code
    listtype      IN            int,---类型
    planname      IN            VARCHAR2,
    items          OUT           SYS_REFCURSOR
) IS
    v_sql_exec         CLOB;            --sql
    v_spid             VARCHAR2(200);--数据权限验证spid
    v_sheet            VARCHAR2(200);--是否查询历史数据表
    v_where            VARCHAR2(4000):=' 1=1 ';
    v_search           VARCHAR2(4000):=' 1=1 ';  ---搜素sql
BEGIN
    --调用数据权限验证存储过程
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => currentuserid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
     --根据type来确定联查哪张表
    IF listtype =0
        then v_sheet:='POM_DEPT_MONTHLY_PLAN A LEFT JOIN POM_DEPT_MONTHLY_PLAN_NODE B ON A.ID = B.DEPT_MONTHLY_PLAN_ID ';
    elsif listtype =1
        then v_sheet:='POM_DEPT_MONTHLY_PLAN_HISTORY A LEFT JOIN POM_DEPT_MONTHLY_NODE_HISTORY B ON A.ID = B.DEPT_MONTHLY_PLAN_HISTORY_ID';
    END IF;

    --添加搜索条件
    v_search:=' 1=1 ';
    IF (companyid is not null) then
            v_search:= v_search ||' And TOTAL."companyId" = '''||companyid||'''';
    end if;
    IF (deptid is not null) then
            v_search:= v_search ||' And TOTAL."deptId" = '''||deptid||'''';
    end if;
    IF (planname is not null) then
            v_search:= v_search ||' And TOTAL."planName" LIKE ''%'||planname||'%''';
    end if;

    IF listtype = 0 THEN
        v_sql_exec:= 'SELECT * FROM
        (
          SELECT PLAN.ID               AS "id"
               , PLAN.PLAN_NAME        as "planName"
               , PLAN.ORIGINAL_PLAN_ID as "originalPlanId"
               , PLAN.DEPT_ID          as "deptId"
               , PLAN.DEPT_NAME        as "deptName"
               , PLAN.COMPANY_ID       as "companyId"
               , PLAN.COMPANY_NAME     as "companyName"
               , PLAN.PLAN_VERSION     as "planVersion"
               , PLAN.BIZ_YEAR         as "bizYear"
               , PLAN.BIZ_MONTH        as "bizMonth"
               , PLAN.PLAN_TYPE        as "planType"
               , PLAN.CREATOR          as "creator"
               , PLAN.CREATOR_ID       as "creatorId"
               , PLAN.CREATED          as "createTime"
               , PLAN.APPROVE_STATUS   as "approveStatus"
               , PLAN.APPROVE_TIME     as "approveTime"
               , PLAN.APPROVER_ID      as "approverId"
               , PLAN.APPROVER         as "approver"
               , PLAN.REMARKS          as "remarks"
               , PLAN.MODIFIER         as "modifier"
               , PLAN.MODIFIER_ID      as "modifierId"
               , PLAN.MODIFIED         as "modifiedTime"
               , PLAN.ALTER_SUBJECT    as "alterSubject"
               , PLAN.ALTER_REASON     as "alterReason"
               , PLAN.ADJUST_SOURCE_ID as "adjustSourceId"
               , COUNT(NODE.ID)        AS "totalNode"
               , (
              SELECT COUNT(INDEX_NODE.ACTUAL_END_DATE)
              FROM POM_DEPT_MONTHLY_PLAN_NODE INDEX_NODE
                       LEFT JOIN POM_DEPT_MONTHLY_PLAN INDEX_PLAN
                                 ON INDEX_NODE.DEPT_MONTHLY_PLAN_ID = INDEX_PLAN.ID
              WHERE INDEX_PLAN.ID = PLAN.ID
                AND INDEX_NODE.ACTUAL_END_DATE IS NOT NULL
          )                            AS "finishedNode"
               , (
              SELECT COUNT(*)
              FROM POM_DEPT_MONTHLY_PLAN_NODE INDEX_NODE
                       LEFT JOIN POM_DEPT_MONTHLY_PLAN INDEX_PLAN
                                 ON INDEX_NODE.DEPT_MONTHLY_PLAN_ID = INDEX_PLAN.ID
              WHERE INDEX_PLAN.ID = PLAN.ID
                AND INDEX_NODE.ACTUAL_END_DATE IS NULL
          )                            AS "notFinishedNode"
          FROM POM_DEPT_MONTHLY_PLAN PLAN
                   LEFT JOIN POM_DEPT_MONTHLY_PLAN_NODE NODE
                             ON PLAN.ID = NODE.DEPT_MONTHLY_PLAN_ID
                                 AND PLAN.PLAN_VERSION = NODE.PLAN_VERSION
          GROUP BY PLAN.ID,
                   PLAN.PLAN_NAME,
                   PLAN.ORIGINAL_PLAN_ID,
                   PLAN.DEPT_ID,
                   PLAN.DEPT_NAME,
                   PLAN.COMPANY_ID,
                   PLAN.COMPANY_NAME,
                   PLAN.PLAN_VERSION,
                   PLAN.BIZ_YEAR,
                   PLAN.BIZ_MONTH,
                   PLAN.PLAN_TYPE,
                   PLAN.CREATOR,
                   PLAN.CREATOR_ID,
                   PLAN.CREATED,
                   PLAN.APPROVE_STATUS,
                   PLAN.APPROVE_TIME,
                   PLAN.APPROVER_ID,
                   PLAN.APPROVER,
                   PLAN.REMARKS,
                   PLAN.MODIFIER,
                   PLAN.MODIFIER_ID,
                   PLAN.MODIFIED,
                   PLAN.ALTER_SUBJECT,
                   PLAN.ALTER_REASON,
                   PLAN.ADJUST_SOURCE_ID
        )TOTAL
            LEFT JOIN (SELECT DISTINCT ORG_ID AS "orgid" FROM TMP_AUTH_LIST WHERE ID = '''||v_spid||''')  TAL on  TAL."orgid"=TOTAL."companyId" or TAL."orgid"=TOTAL."deptId"
        WHERE '||v_search||' AND (
            (TOTAL."approveStatus" =''已审核'' AND TOTAL."planVersion" > 1) OR (TOTAL."planVersion" =1)
        )';
    ELSIF listtype = 1 THEN
    --查询历史版本的部门月度计划表
    v_sql_exec:='SELECT * FROM
    (
        SELECT PLAN.ID               AS "id"
             , PLAN.PLAN_NAME        as "planName"
             , PLAN.ORIGINAL_PLAN_ID as "originalPlanId"
             , PLAN.DEPT_ID          as "deptId"
             , PLAN.DEPT_NAME        as "deptName"
             , PLAN.COMPANY_ID       as "companyId"
             , PLAN.COMPANY_NAME     as "companyName"
             , PLAN.PLAN_VERSION     as "planVersion"
             , PLAN.BIZ_YEAR         as "bizYear"
             , PLAN.BIZ_MONTH        as "bizMonth"
             , PLAN.PLAN_TYPE        as "planType"
             , PLAN.CREATOR          as "creator"
             , PLAN.CREATOR_ID       as "creatorId"
             , PLAN.CREATED          as "createTime"
             , PLAN.APPROVE_STATUS   as "approveStatus"
             , PLAN.APPROVE_TIME     as "approveTime"
             , PLAN.APPROVER_ID      as "approverId"
             , PLAN.APPROVER         as "approver"
             , PLAN.REMARKS          as "remarks"
             , PLAN.MODIFIER         as "modifier"
             , PLAN.MODIFIER_ID      as "modifierId"
             , PLAN.MODIFIED         as "modifiedTime"
             , PLAN.ALTER_SUBJECT    as "alterSubject"
             , PLAN.ALTER_REASON     as "alterReason"
             , PLAN.ADJUST_SOURCE_ID as "adjustSourceId"
             , COUNT(NODE.ID)        AS "totalNode"
             , (
                    SELECT
                        COUNT( INDEX_NODE.id )
                    FROM
                        POM_DEPT_MONTHLY_NODE_HISTORY INDEX_NODE
                            LEFT JOIN POM_DEPT_MONTHLY_PLAN_HISTORY INDEX_PLAN ON INDEX_PLAN.ID = INDEX_NODE.DEPT_MONTHLY_PLAN_HISTORY_ID
                    WHERE
                            INDEX_PLAN.PLAN_VERSION = (
                            SELECT
                                    PLAN_VERSION - 1
                            FROM
                                POM_DEPT_MONTHLY_PLAN_HISTORY
                            WHERE
                                    ORIGINAL_PLAN_ID = INDEX_PLAN.ORIGINAL_PLAN_ID
                        )
              ) AS "previousNode"
        FROM POM_DEPT_MONTHLY_PLAN_HISTORY PLAN
                 LEFT JOIN POM_DEPT_MONTHLY_NODE_HISTORY NODE
                           ON PLAN.ID = NODE.DEPT_MONTHLY_PLAN_HISTORY_ID
                               AND PLAN.PLAN_VERSION = NODE.PLAN_VERSION
        GROUP BY PLAN.ID,
                 PLAN.PLAN_NAME,
                 PLAN.ORIGINAL_PLAN_ID,
                 PLAN.DEPT_ID,
                 PLAN.DEPT_NAME,
                 PLAN.COMPANY_ID,
                 PLAN.COMPANY_NAME,
                 PLAN.PLAN_VERSION,
                 PLAN.BIZ_YEAR,
                 PLAN.BIZ_MONTH,
                 PLAN.PLAN_TYPE,
                 PLAN.CREATOR,
                 PLAN.CREATOR_ID,
                 PLAN.CREATED,
                 PLAN.APPROVE_STATUS,
                 PLAN.APPROVE_TIME,
                 PLAN.APPROVER_ID,
                 PLAN.APPROVER,
                 PLAN.REMARKS,
                 PLAN.MODIFIER,
                 PLAN.MODIFIER_ID,
                 PLAN.MODIFIED,
                 PLAN.ALTER_SUBJECT,
                 PLAN.ALTER_REASON,
                 PLAN.ADJUST_SOURCE_ID
    )TOTAL
        LEFT JOIN (SELECT DISTINCT ORG_ID AS "orgid" FROM TMP_AUTH_LIST WHERE ID = '''||v_spid||''')  TAL on  TAL."orgid"=TOTAL."companyId" or TAL."orgid"=TOTAL."deptId"';    
    END IF;


    dbms_output.put_line(v_sql_exec);
    OPEN items FOR v_sql_exec;


END p_pom_dept_monthly_plan;
/

prompt
prompt Creating procedure P_POM_DEPT_PLAN_GET_PROJ_NODE
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_DEPT_PLAN_GET_PROJ_NODE"
 (
     I_DEPT_ID              IN VARCHAR2 := NULL
 ,I_DEPT_MONTHLY_PLAN_ID IN VARCHAR2 := NULL --传入参数_部门月度计划ID
 ,I_BIZ_YEAR             IN NUMBER := NULL --传入参数 _年份
 ,I_BIZ_MONTH            IN NUMBER := NULL --传入参数_月份
 ,O_FLAG                 OUT NUMBER --更新成功的条数
 ) AS
     V_CON          NUMBER(8, 0) := 0;
     V_PLAN_VERSION NUMBER(8, 0);
     V_BIZ_MONTH    NVARCHAR2(2);
     V_DEPT_NAME    NVARCHAR2(100);
     MAX_CODE       NUMBER(8, 0) :=0;
 BEGIN
     IF I_BIZ_MONTH < 10 THEN
         V_BIZ_MONTH := '0'||I_BIZ_MONTH;
     elsif I_BIZ_MONTH >= 10 THEN
         V_BIZ_MONTH := ''||I_BIZ_MONTH;
     end if;
     BEGIN
         SELECT COUNT(1), NVL(A.PLAN_VERSION,''),  NVL(A.DEPT_NAME,'')
         INTO   V_CON, V_PLAN_VERSION, V_DEPT_NAME
         FROM   POM_DEPT_MONTHLY_PLAN A, POM_DEPT_MONTHLY_PLAN_NODE B
         WHERE  A.ID = B.DEPT_MONTHLY_PLAN_ID AND
                 B.NODE_SOURCE = '项目主项计划' AND
                 --A.APPROVE_STATUS = '已审核' AND
                 B.DUTY_DEPT_ID = I_DEPT_ID AND
                 A.BIZ_YEAR = TO_CHAR(I_BIZ_YEAR) AND
                 A.BIZ_MONTH = TO_CHAR(I_BIZ_MONTH)
         GROUP  BY A.PLAN_VERSION, A.DEPT_NAME;
         EXCEPTION
         WHEN NO_DATA_FOUND THEN
         O_FLAG := 0;
         --RETURN;
    END;

    --获取该计划内最大的nodecode
    SELECT 
        MAX(NODE_CODE)
    INTO MAX_CODE
    FROM POM_DEPT_MONTHLY_PLAN A 
        LEFT JOIN POM_DEPT_MONTHLY_PLAN_NODE B 
        ON A.ID = B.DEPT_MONTHLY_PLAN_ID
    WHERE A.ID = I_DEPT_MONTHLY_PLAN_ID 
    ORDER BY NODE_CODE DESC;

     IF V_CON <> 0 THEN
         DELETE FROM POM_DEPT_MONTHLY_PLAN_NODE A
         WHERE  EXISTS (SELECT 1
                        FROM   POM_DEPT_MONTHLY_PLAN B
                        LEFT JOIN POM_DEPT_MONTHLY_PLAN_NODE C
                        ON B.ID=C.DEPT_MONTHLY_PLAN_ID
                        WHERE  A.DEPT_MONTHLY_PLAN_ID = B.ID AND
                                C.DUTY_DEPT_ID = I_DEPT_ID AND
                                B.BIZ_MONTH = V_BIZ_MONTH AND
                                B.BIZ_YEAR = I_BIZ_YEAR AND
                                B.ID = I_DEPT_MONTHLY_PLAN_ID)
         /* AND
 A.NODE_SOURCE = '项目主项计划' AND
 A.ACTUAL_END_DATE IS NULL AND
 A.ACTUAL_START_DATE IS NULL AND
 A.ESTIMATE_END_DATE IS NULL AND
 A.ESTIMATE_START_DATE IS NULL;*/
         ;
     END IF;

 INSERT INTO POM_DEPT_MONTHLY_PLAN_NODE
     (ID, ORIGINAL_NODE_ID, DEPT_MONTHLY_PLAN_ID, PLAN_VERSION,
      NODE_NAME, NODE_CODE, NODE_SOURCE, NODE_TYPE, STAND_SCORE,
      PLAN_START_DATE, PLAN_END_DATE, ACTUAL_START_DATE, ACTUAL_END_DATE,
      ESTIMATE_START_DATE, ESTIMATE_END_DATE, RELATED_DEPT_ID,
      RELATED_DEPT, DUTY_DEPT_ID, DUTY_DEPT_NAME, SOURCE_PLAN_ID,
      SOUCE_NODE_ID, SOUCE_NODE_LEVEL, SOUCE_NODE_SCORE,
      COMPLETION_RESULTS_REMARK, COMPLETION_STANDARD, REMARKS)
SELECT
     NODE_ID
    ,NODE_ID
    ,DEPT_MONTHLY_PLAN_ID
    ,PLAN_VERSION
    ,NODE_NAME
    ,CASE WHEN ROWNUM < 10 AND ROWNUM > 0 THEN
        '0'||TO_CHAR(ROWNUM + MAX_CODE)
     WHEN ROWNUM >= 10 THEN
        TO_CHAR(ROWNUM + MAX_CODE)  END
    ,NODE_SOURCE
    ,'项目主项计划'
    ,STANDARD_SCORE
    ,PLAN_START_DATE
    ,PLAN_END_DATE
    ,ACTUAL_START_DATE
    ,ACTUAL_END_DATE
    ,NULL
    ,NULL
    ,NULL
    ,NULL
    ,DUTY_DEPT_ID
    ,DUTY_DEPARTMENT
    ,SOURCE_PLAN_ID
    ,SOURCE_NODE_ID
    ,NODE_LEVEL
    ,STANDARD_SCORE
    ,COMPLETION_RESULTS_REMARK
    ,COMPLETION_STANDARD
    ,NULL
FROM (
    SELECT
        GET_UUID AS NODE_ID
        ,I_DEPT_MONTHLY_PLAN_ID AS DEPT_MONTHLY_PLAN_ID
        ,A.plan_version
        ,B.NODE_NAME
        ,'项目主项计划' AS NODE_SOURCE
        ,B.PLAN_START_DATE
        ,B.PLAN_END_DATE
        ,B.ACTUAL_START_DATE
        ,B.ACTUAL_END_DATE
        ,B.STANDARD_SCORE
        ,I_DEPT_ID AS DUTY_DEPT_ID
        ,b.duty_department
        ,A.ID AS SOURCE_PLAN_ID
        ,B.ID AS SOURCE_NODE_ID
        ,B.NODE_LEVEL
        ,B.COMPLETION_RESULTS_REMARK
        ,B.COMPLETION_STANDARD
    FROM POM_PROJ_PLAN A
        LEFT JOIN POM_PROJ_PLAN_NODE B ON A.ID = B.PROJ_PLAN_ID
    WHERE  A.APPROVAL_STATUS = '已审核'
        AND B.DUTY_DEPARTMENT_ID = I_DEPT_ID
        AND TO_CHAR(B.PLAN_END_DATE, 'MM') = V_BIZ_MONTH
        AND TO_CHAR(B.PLAN_END_DATE, 'YYYY') = I_BIZ_YEAR
        AND B.IS_DISABLE = 0
        AND B.IS_DELETE = 0
    ORDER BY B.NODE_CODE ASC
);

     O_FLAG := SQL%ROWCOUNT;
     COMMIT;

 END P_POM_DEPT_PLAN_GET_PROJ_NODE;
/

prompt
prompt Creating procedure P_POM_DM_PERFORM_DYNAMIC
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_DM_PERFORM_DYNAMIC
(
		IN_ORG_ID    IN VARCHAR2
	 ,DATASCOPE    IN VARCHAR2
	 ,IN_PLAN_TYPE IN VARCHAR2
	 ,IN_PROJID  IN VARCHAR2 
	 ,PAGEINDEX    IN INT
	 ,PAGESIZES    IN INT
	 ,P_PAGETYPE  IN INT
	 ,ITEMS        OUT SYS_REFCURSOR
	 ,TOTAL        OUT INT
) AS
		--传入的参数有三个，1：IN_ORG_ID（公司ID）
		--，2：DATASCOPE（统计期间，3个值“THIS_MONTH、THIS_QUARTER、THIS_YEAR"）
		--，3：PLAN_TYPE（计划类型，预留，估计后面会用的到）
		--，4：P_PAGETYPE（页面类型：1：已延误 2：已完成 3：应完成）//alterby 李小聪
		--关键节点计划-执行动态查询（wangck需要）
		--作者：陈丽
		--日期：2019/12/07

		CURSOR CUR_COMPANY_LIST(V_ORG_ID SYS_BUSINESS_UNIT.ID%TYPE) IS
				SELECT P.ID, P.PARENT_ID, P.ORG_NAME FROM SYS_BUSINESS_UNIT P WHERE P.IS_COMPANY = 1 START WITH P.ID = V_ORG_ID CONNECT BY PRIOR P.ID = P.PARENT_ID;
		V_SQL_TOTAL     CLOB := ' ';
		V_SQL           CLOB := ' ';
		V_SQL_DATASCOPE CLOB := ' ';
		V_COMPANY_LIST  CLOB := ' ';

BEGIN

  dbms_output.put_line('开始');
--月度
--已延误
		IF DATASCOPE = 'thisMonth' AND P_PAGETYPE=1  THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL   AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';
--月度
--已完成
		ELSIF DATASCOPE = 'thisMonth' AND P_PAGETYPE=2  THEN
				V_SQL_DATASCOPE := ' AND  PN.ACTUAL_END_DATE IS  NOT NULL  AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';

--月度
--应完成

		ELSIF DATASCOPE = 'thisMonth' AND P_PAGETYPE=3  THEN
				V_SQL_DATASCOPE := 'AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';

--季度
--已延误
	ELSIF DATASCOPE = 'thisQuarter' AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := ' AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL    AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((	SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((	SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
--季度
--已完成
	ELSIF DATASCOPE = 'thisQuarter' AND P_PAGETYPE=2 THEN
				V_SQL_DATASCOPE := 'AND  PN.ACTUAL_END_DATE IS  NOT NULL AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((	SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((	SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
--季度
--季度应完成
	ELSIF DATASCOPE = 'thisQuarter' AND P_PAGETYPE=3 THEN
				V_SQL_DATASCOPE := '  AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((	SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((	SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
--年度
--已延误
		ELSIF DATASCOPE = 'thisYear'AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL  
			 AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) ';
--年度
--已完成
		ELSIF DATASCOPE = 'thisYear'AND P_PAGETYPE=2 THEN
				V_SQL_DATASCOPE := 'AND  PN.ACTUAL_END_DATE IS  NOT NULL  
				 AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH)  ';
--年度
--应完成
		ELSIF DATASCOPE = 'thisYear' AND P_PAGETYPE=3 THEN
				V_SQL_DATASCOPE := ' AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) ';
--全部，没有时间限
--已延误
	ELSIF DATASCOPE = 'thisAll' AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL ';
--计划所有节点
	ELSIF DATASCOPE = 'thisAll' AND P_PAGETYPE=2 THEN
				V_SQL_DATASCOPE := ' AND   1=1 ';



		END IF;

		FOR ITEM_COMPANY_LIST IN CUR_COMPANY_LIST(IN_ORG_ID)
		LOOP
				/*DBMS_OUTPUT.PUT_LINE(ITEM_COMPANY_LIST.ORG_NAME || ',PARENT_ID' ||
        ITEM_COMPANY_LIST.PARENT_ID || ',ID:' ||
        ITEM_COMPANY_LIST.ID);*/
				V_COMPANY_LIST := V_COMPANY_LIST || '''' || ITEM_COMPANY_LIST.ID || '''' || ',';
		END LOOP;
-- 	dbms_output.put_line(V_COMPANY_LIST);
		V_COMPANY_LIST := '('  || SUBSTR(V_COMPANY_LIST, 1, LENGTH(V_COMPANY_LIST) - 1) || ')';
-- 		dbms_output.put_line(V_COMPANY_LIST);
IF  V_COMPANY_LIST='()'
	 THEN  V_COMPANY_LIST := '('''||IN_ORG_ID||''')';
END  IF;
-- 	dbms_output.put_line(V_COMPANY_LIST);
		V_SQL := V_SQL ||
						 'SELECT PP.COMPANY_ID, PP.COMPANY_NAME AS COMPANY_NAME,PP.PROJ_name AS PROJ_NAME,PP.PLAN_NAME AS PLAN_NAME, PN.ID,PN.PROJ_PLAN_ID,PN.ORIGINAL_NODE_ID,CASE WHEN PN.IS_DISABLE = 0 THEN	PN.NODE_NAME ELSE	''【禁用】'' || PN.NODE_NAME END AS NODE_NAME, PN.NODE_CODE, PN.NODE_LEVEL, PN.PROJ_STAGE, PN.MAIN_RESPONSIBILITY, PN.DUTY_DEPARTMENT, TO_CHAR(PN.PLAN_START_DATE, ''yyyy-MM-dd'') AS PLAN_START_DATE, TO_CHAR(PN.PLAN_END_DATE, ''yyyy-MM-dd'') AS PLAN_END_DATE, PN.IS_DISABLE, PN.COMPLETION_STANDARD, PN.COMPLETION_RESULTS_REMARK, TO_CHAR(PN.ACTUAL_END_DATE, ''yyyy-MM-dd'') AS ACTUAL_END_DATE
	, case 
 --未到期不亮灯
 WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
 --到期当天内完成反馈
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
 then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
  --到期1-5天内完成反馈
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
 then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
 --到期未反馈黄灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE)) >0
 THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>'' 
  --到期超过5天未反馈红灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(PLAN_END_DATE)) >5) THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' 
 ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END
  AS PLAN_STATUS,PN.ESTIMATE_END_DATE,	nps.CHARGE_PERSON
	FROM  pom_proj_plan_node pn 
LEFT JOIN pom_proj_plan pp ON pn.proj_plan_id = pp.id 
LEFT JOIN  SYS_PROJECT_STAGE ps on  ps.id=pp.proj_id
LEFT JOIN SYS_PROJECT pj on  ps.PROJECT_ID =pj.id
LEFT JOIN(	SELECT  NODE_ID, listagg(CHARGE_PERSON,'','') WITHIN GROUP (ORDER BY CHARGE_PERSON )  as CHARGE_PERSON
	FROM POM_NODE_CHARGE_PERSON 
	GROUP BY NODE_ID) nps on  nps.NODE_ID=pn.id
	WHERE  PP.PLAN_TYPE = ''部门月度计划''  AND APPROVAL_STATUS = ''已审核'' AND 1=1 
	and  ((pp.proj_id ='''||IN_PROJID||''' or pn.proj_plan_id='''||IN_PROJID||'''  OR  pj.id='''||IN_PROJID||''' )
	OR PP.COMPANY_ID IN ' || V_COMPANY_LIST ||' ) '|| V_SQL_DATASCOPE || '  ORDER BY PN.PROJ_PLAN_ID,  PN.NODE_CODE';

		DBMS_OUTPUT.PUT_LINE(V_SQL);
			V_SQL_TOTAL := V_SQL_TOTAL|| 				 'SELECT  TO_CHAR(COUNT(pn.ID))
	FROM  pom_proj_plan_node pn 
LEFT JOIN pom_proj_plan pp ON pn.proj_plan_id = pp.id 
LEFT JOIN  SYS_PROJECT_STAGE ps on  ps.id=pp.proj_id
LEFT JOIN SYS_PROJECT pj on  ps.PROJECT_ID =pj.id
LEFT JOIN(	SELECT  NODE_ID, listagg(CHARGE_PERSON,'','') WITHIN GROUP (ORDER BY CHARGE_PERSON )  as CHARGE_PERSON
	FROM POM_NODE_CHARGE_PERSON 
	GROUP BY NODE_ID) nps on  nps.NODE_ID=pn.id
	WHERE  PP.PLAN_TYPE = ''部门月度计划''  AND APPROVAL_STATUS = ''已审核'' AND 1=1 
	and  ((pp.proj_id ='''||IN_PROJID||''' or pn.proj_plan_id='''||IN_PROJID||'''  OR  pj.id='''||IN_PROJID||''' )
	OR PP.COMPANY_ID IN ' || V_COMPANY_LIST ||' ) '|| V_SQL_DATASCOPE || '  ORDER BY PN.PROJ_PLAN_ID,  PN.NODE_CODE';

		--DBMS_OUTPUT.PUT_LINE(V_SQL_TOTAL);
		 execute immediate V_SQL_TOTAL into TOTAL; 
	--	 DBMS_OUTPUT.PUT_LINE(TOTAL);

		OPEN ITEMS FOR V_SQL;

END P_POM_DM_PERFORM_DYNAMIC;
/

prompt
prompt Creating procedure P_POM_EXAMELATE_NODE
prompt =======================================
prompt
create or replace procedure pom0813.P_POM_EXAMELATE_NODE
(
    examelateNodeId in varchar2,
    bizId in varchar2
)
IS
    v_node_sql clob;
    v_node_exist clob;
    isProjectOpenNode INT;
    isOnTime number;
    node_self_id varchar2(36);
    node_plan_id varchar2(36);
    node_plan_type varchar2(20);
    node_self_type varchar2(20);
    node_self_plan_end_date varchar2(50);
    node_expression_exist number;
    node_expression varchar2(2000);
    user_expression varchar2(2000);
    node_is_exist number;
    expression_is_default number;
BEGIN
    node_expression := NULL;
    --查询节点是否为项目开盘节点
    select
    case when standard_node_id = bizId then
        1
    else 0 end,
    plan.id,
    plan.plan_type,
    node.node_level,
    to_char(node.plan_end_date, 'YYYY-MM-DD'),
    node.id
    INTO isProjectOpenNode, node_plan_id, node_plan_type, node_self_type, node_self_plan_end_date, node_self_id
    from pom_proj_plan_node node
    left join pom_proj_plan plan on node.proj_plan_id = plan.id
    left join pom_node_feedback fb on node.id = fb.feedback_node_id
    where fb.id = examelateNodeId;

    --判断是否为项目开盘节点
    IF isProjectOpenNode = 1 THEN
        --是项目开盘节点，则判断是否按时完成
         EXECUTE IMMEDIATE 'select
            case when to_char(plan_end_date, ''YYYY-MM-DD'') <= to_char((sysdate, ''YYYY-MM-DD'') then
                1
            else 0 end
            from pom_proj_plan_node where id = '''||node_self_id||'''' INTO isOnTime;
    ELSE
        --不是项目开盘计划
        isOnTime := 0;
    END IF;

    --项目开盘节点计划且按时完成
    IF isProjectOpenNode = 1 AND isOnTime = 1 THEN
        --找出所有计划完成时间在项目开盘节点之前的节点ID
       EXECUTE IMMEDIATE 'SELECT WM_CONCAT(ID) FROM POM_PROJ_PLAN_NODE  WHERE PROJ_PLAN_ID = (
                            SELECT PLAN.ID FROM POM_PROJ_PLAN_NODE NODE LEFT JOIN POM_PROJ_PLAN PLAN ON NODE.PROJ_PLAN_ID = PLAN.ID
                            WHERE PLAN.APPROVAL_STATUS = ''已审核'' AND
                            NODE.STANDARD_NODE_ID = '''||bizId||''' AND
                            PLAN.ID = '''||node_plan_id||''' AND
                            PLAN_END_DATE IS NOT NULL AND
                            TO_CHAR(PLAN_END_DATE ,''YYYY-MM-DD'') <= '''||node_self_plan_end_date||''')'
       INTO v_node_exist;
       --修改所有在计划考核表中已经存在的节点的最新考核分数
       EXECUTE IMMEDIATE 'UPDATE POM_NODE_EXAMINATION SET NEW_EXAMINATION_SCORE = STANDARD_SCORE WHERE NODE_ID IN (
            SELECT REGEXP_SUBSTR ('''||v_node_exist||''', ''[^,]+'', 1,rownum) from dual connect by rownum<=LENGTH ('''||v_node_exist||''') - LENGTH (regexp_replace('''||v_node_exist||''', '','', ''''))+1
       )';

       --插入计划考核表原本不存在的项目开盘节点数据
       EXECUTE IMMEDIATE 'INSERT INTO POM_NODE_EXAMINATION(
                            ID,
                            NODE_ID,
                            ORIGINAL_NODE_ID,
                            NODE_LEVEL,
                            STANDARD_SCORE,
                            DUTY_DEPT_ID,
                            DUTY_DEPT,
                            COMPLETE_FEEDBACK_ID,
                            ORIGINAL_PLAN_ID,
                            PLAN_ID,
                            PLAN_TYPE,
                            EXAMINATION_SCORE,
                            NEW_EXAMINATION_SCORE,
                            PLAN_START_DATE,
                            ACTUAL_START_DATE,
                            ACTUAL_END_DATE,
                            EXAMINATION_DATE,
                            COMPLETE_FEEDBACK_APPROVE_TIME,
                            CHARGE_PERSON_ID,
                            CHARGE_PERSON,
                            NODE_NAME
                        )
                        SELECT
                            GET_UUID(),
                            NODE.ID,
                            NODE.ORIGINAL_NODE_ID,
                            NODE.NODE_LEVEL,
                            NODE.STANDARD_SCORE,
                            NODE.DUTY_DEPARTMENT_ID,
                            NODE.DUTY_DEPARTMENT,
                            FB.ID,
                            NODE.ORIGINAL_PLAN_ID,
                            PLAN.ID,
                            PLAN.PLAN_TYPE,
                            NODE.STANDARD_SCORE,
                            NODE.STANDARD_SCORE,
                            NODE.PLAN_START_DATE,
                            NODE.ACTUAL_START_DATE,
                            NODE.ACTUAL_END_DATE,
                            SYSDATE,
                            FB.APPROVAL_TIME,
                            (SELECT WM_CONCAT(CHARGE_PERSON_ID) FROM POM_NODE_CHARGE_PERSON WHERE NODE_ID = '''||node_self_id||'''),
                            (SELECT WM_CONCAT(CHARGE_PERSON) FROM POM_NODE_CHARGE_PERSON WHERE NODE_ID = '''||node_self_id||'''),
                            NODE.NODE_NAME
                        FROM POM_PROJ_PLAN_NODE NODE
                                 LEFT JOIN POM_PROJ_PLAN PLAN ON NODE.PROJ_PLAN_ID = PLAN.ID
                                 LEFT JOIN POM_NODE_FEEDBACK FB ON NODE.ID = FB.FEEDBACK_NODE_ID
                        WHERE NODE.ID  = '''||node_self_id||''' 
                          AND FB.FEEDBACK_TYPE = ''CARRY_OUT'' 
                          AND IS_DISABLED = 0
                          AND IS_DELETE = 0';
    ELSIF isProjectOpenNode = 0 OR (isProjectOpenNode = 1 AND isOnTime = 0) THEN
        --非项目开盘节点 / 未按时完成的项目开盘节点，则向上查询对应计划所对应公司的计划的节点的考核规则(非未启用、默认)
        EXECUTE IMMEDIATE 'SELECT COUNT(*) FROM POM_RULE_EXAMINATION WHERE APPLY_COMPANY_ID = (
                                SELECT PLAN.COMPANY_ID FROM POM_PROJ_PLAN_NODE NODE LEFT JOIN
                                    POM_PROJ_PLAN PLAN ON NODE.PROJ_PLAN_ID = PLAN.ID
                                    WHERE NODE.ID = '''||node_self_id||'''
                            )  AND IS_ACTIVE = 1' INTO node_expression_exist;
        IF node_expression_exist = 0 THEN
            --先查询是否拥有非未启用、默认的规则
            EXECUTE IMMEDIATE 'SELECT COUNT(*) FROM POM_RULE_EXAMINATION RULE
                                LEFT JOIN POM_RULE_SET_PLAN_TYPE PRULE ON RULE.ID = PRULE.RULE_ID
                                WHERE PRULE.PLAN_TYPE = '''||node_plan_type||''' 
                                      AND RULE.NODE_TYPE = '''||node_self_type||'''
                                      AND RULE.IS_DEFAULT = 1
                                      AND RULE.IS_ACTIVE = 1
                                      ' INTO expression_is_default;
            IF expression_is_default != 0 THEN
                --若未查到对应的公司考核规则，则按照默认的计划及节点规则进行考核分值计算
                EXECUTE IMMEDIATE 'SELECT RULE.EXPRESSION FROM POM_RULE_EXAMINATION RULE
                                    LEFT JOIN POM_RULE_SET_PLAN_TYPE PRULE ON RULE.ID = PRULE.RULE_ID
                                    WHERE PRULE.PLAN_TYPE = '''||node_plan_type||''' 
                                          AND RULE.NODE_TYPE = '''||node_self_type||'''
                                          AND RULE.IS_DEFAULT = 1
                                          AND RULE.IS_ACTIVE = 1
                                          ' INTO node_expression;
            END IF;
        ELSE
            EXECUTE IMMEDIATE 'SELECT EXPRESSION FROM POM_RULE_EXAMINATION WHERE APPLY_COMPANY_ID = (
                                SELECT PLAN.COMPANY_ID FROM POM_PROJ_PLAN_NODE NODE LEFT JOIN
                                    POM_PROJ_PLAN PLAN ON NODE.PROJ_PLAN_ID = PLAN.ID
                                    WHERE NODE.ID = '''||node_self_id||'''
                            ) AND IS_ACTIVE = 1' INTO node_expression;
        END IF;
        --DBMS_OUTPUT.put_line('查询考核规则完毕');
        --DBMS_OUTPUT.put_line('node_self_id：'||node_self_id);
        --DBMS_OUTPUT.put_line('node_expression：'||node_expression);
        IF node_expression IS NOT NULL THEN
        --解析关键字
        user_expression :=REPLACE( REPLACE(
                REPLACE(
                    REPLACE(
                        REPLACE(
                            REPLACE(
                                REPLACE(
                                    REPLACE(
                                        REPLACE(REPLACE(node_expression, '{所属公司}', 'COMPANY_ID'),'{计划类型}','PLAN_TYPE'),
                                        '{任务级别}', 'NODE_LEVEL'
                                    ),  '{审批时间}', 'APPROVAL_TIME'
                                ), '{计划开始时间}','PLAN_START_DATE'
                            ),'{计划完成时间}','PLAN_END_DATE'
                        ),'{实际开始时间}','ACTUAL_START_DATE'
                    ),'{实际完成时间}', 'ACTUAL_END_DATE'
                ), '{标准分值}','STANDARD_SCORE'
            ), '{当前日期}','SYSDATE');
        DBMS_OUTPUT.put_line('user_expression：'||user_expression);
        DBMS_OUTPUT.put_line('node_self_id：'||node_self_id);

        EXECUTE IMMEDIATE 'INSERT INTO POM_NODE_EXAMINATION(
                        ID,
                        NODE_ID,
                        ORIGINAL_NODE_ID,
                        NODE_LEVEL,
                        STANDARD_SCORE,
                        DUTY_DEPT_ID,
                        DUTY_DEPT,
                        COMPLETE_FEEDBACK_ID,
                        ORIGINAL_PLAN_ID,
                        PLAN_ID,
                        PLAN_TYPE,
                        EXAMINATION_SCORE,
                        NEW_EXAMINATION_SCORE,
                        PLAN_START_DATE,
                        PLAN_END_DATE,
                        ACTUAL_START_DATE,
                        ACTUAL_END_DATE,
                        EXAMINATION_DATE,
                        COMPLETE_FEEDBACK_APPROVE_TIME,
                        CHARGE_PERSON_ID,
                        CHARGE_PERSON,
                        NODE_NAME
                    )
                    SELECT
                        ID,
                        NODE_ID,
                        ORIGINAL_NODE_ID,
                        NODE_LEVEL,
                        STANDARD_SCORE,
                        DUTY_DEPARTMENT_ID,
                        DUTY_DEPARTMENT,
                        BASE.FEEDBACK_ID,
                        ORIGINAL_PLAN_ID,
                        PLAN_ID,
                        PLAN_TYPE,
                        (SELECT '||user_expression||' FROM POM_PROJ_PLAN_NODE WHERE ID = NODE_ID),
                        (SELECT '||user_expression||' FROM POM_PROJ_PLAN_NODE WHERE ID = NODE_ID),
                        PLAN_START_DATE,
                        PLAN_END_DATE,
                        ACTUAL_START_DATE,
                        ACTUAL_END_DATE,
                        CURRENT_DATE,
                        APPROVAL_TIME,
                        PERSONIDs,
                        PERSONs,
                        NODE_NAME
                    FROM(
                           SELECT GET_UUID() AS ID,
                           NODE.ID AS NODE_ID,
                           NODE.ORIGINAL_NODE_ID,
                           NODE.NODE_LEVEL,
                           NODE.STANDARD_SCORE,
                           NODE.DUTY_DEPARTMENT_ID,
                           NODE.DUTY_DEPARTMENT,
                           FB.ID AS FEEDBACK_ID,
                           NODE.ORIGINAL_PLAN_ID,
                           PLAN.ID AS PLAN_ID,
                           PLAN.PLAN_TYPE,
                           PLAN.COMPANY_ID,
                           NODE.PLAN_START_DATE,
                           NODE.PLAN_END_DATE,
                           NODE.ACTUAL_START_DATE,
                           NODE.ACTUAL_END_DATE,
                           SYSDATE AS CURRENT_DATE,
                           FB.APPROVAL_TIME,
                           (SELECT WM_CONCAT(CHARGE_PERSON_ID)
                            FROM POM_NODE_CHARGE_PERSON
                            WHERE NODE_ID = NODE.ID) AS PERSONIDs,
                           (SELECT WM_CONCAT(CHARGE_PERSON) FROM POM_NODE_CHARGE_PERSON WHERE NODE_ID = NODE.ID) AS PERSONs,
                           NODE.NODE_NAME
                    FROM POM_PROJ_PLAN_NODE NODE
                             LEFT JOIN POM_PROJ_PLAN PLAN ON NODE.PROJ_PLAN_ID = PLAN.ID
                             LEFT JOIN POM_NODE_FEEDBACK FB ON NODE.ID = FB.FEEDBACK_NODE_ID
                    WHERE NODE.ID = '''||node_self_id||'''
                      AND FB.FEEDBACK_TYPE = ''CARRY_OUT''
                      AND IS_DISABLE = 0
                      AND IS_DELETE = 0
                      )BASE';
                END IF;
    END IF;
    COMMIT;
END P_POM_EXAMELATE_NODE;
/

prompt
prompt Creating procedure P_POM_EXPORT_COMPANY
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_export_company (
    companyid     IN            VARCHAR2,--输入变量：公司id
    currentcompanyid     IN     VARCHAR2,--当前用户的公司
	userid        IN            VARCHAR2,--用户id用于过滤关注的任务
    currentstationid     IN            VARCHAR2,---当前用户的岗位
    currentdeptid        IN            VARCHAR2,---当前用户的部门
    bizcode       IN            VARCHAR2,---权限code
--    pageindex     IN            INT,
--    pagesizes     IN            INT,
    currenttype   IN            VARCHAR2,--完成节点类型(本月任务,超期未完成任务,所有未完成任务,所有已完成任务,所有任务,次月任务,本季度任务,本年任务)
    searchcondition IN          VARCHAR2,--模糊查询条件
    items         OUT           SYS_REFCURSOR,
    total         OUT           INT
--  spiditems         OUT           SYS_REFCURSOR
) IS
--本部门负责的任务
--作者：陈丽
--日期：2019/11/15

    v_sql_start          CLOB;
    v_sql_end            CLOB;
    v_sql_content       CLOB;
    v_sql               CLOB;
    v_sql_exec          CLOB;
    v_sql_exec_paging   CLOB;
    v_where              CLOB;
    v_spid              VARCHAR2(200);--数据权限验证spid
    testmsg             CLOB;
    wwhere          CLOB;
    v_where_like       CLOB;
BEGIN
----------------------------------------------------统一解析
    wwhere := companyid;
    --wwhere := ''' or ''1''=''1';
    testmsg := 'companyid:'
               || companyid
--               || '；pageindex:'
--               || pageindex
--               || '；pagesizes:'
--               || pagesizes
               || '；currenttype:'
               || currenttype;

    BEGIN
        total := 1000;
        v_sql_start := ' case ';
        v_sql_content := '';
        v_sql_end := '  else '''' end  ';
--调用数据权限验证存储过程
 P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );

-- open  spiditems   for select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = v_spid;
--1.拼接查询语句
        FOR item IN (
            SELECT
                s.expression,
                vv.node_level,
                vv.plan_type
            FROM
                pom_rule_set s
                LEFT JOIN (
                    SELECT
                        MAX(s.created_time) AS t,
                        node_level,
                        plan_type
                    FROM
                        pom_rule_set             s
                        LEFT JOIN pom_rule_set_plan_type   pt ON s.id = pt.rule_id
                    WHERE
                        rule_type = '亮灯规则'
                        --AND plan_type = '关键节点计划'
                        AND s.is_disable = 0
                    GROUP BY
                        node_level,
                        plan_type
                ) vv ON s.created_time = vv.t
                        AND s.node_level = vv.node_level
            WHERE
                vv.t IS NOT NULL
        ) LOOP
    ---拼接字符串
         v_sql_content := v_sql_content
                                || '  when plan_type='''
                                ||
            CASE item.plan_type
                WHEN '项目全景计划' THEN
                    '项目主项计划'
                ELSE item.plan_type
            END
                                || ''' and node_level='''
                                || item.node_level
                                || ''' then ('
                                || item.expression
                                || ')';
        END LOOP;

    --dbms_output.put_line('123333');
    --dbms_output.put_line(v_sql_content);
    --规则内容大于0才拼规则语句

        IF length(v_sql_content) > 0 THEN
            v_sql := v_sql_start
                     || v_sql_content
                     || v_sql_end;
        ELSE
    --无规则亮灯显示空
            v_sql := '''''';
        END IF;

-------------------------------------------------------------------------------------------内容

            IF currenttype = '本月任务' THEN
            v_where := ' and ACTUAL_END_DATE is null and (PLAN_END_DATE>=trunc(sysdate, ''month'') and PLAN_END_DATE<=trunc(last_day(sysdate))) ';
        ELSIF currenttype = '超期未完成任务' THEN
            v_where := ' and sysdate>PLAN_END_DATE  and ACTUAL_END_DATE is null';
        ELSIF currenttype = '所有未完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is null ';
        ELSIF currenttype = '所有已完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is not null ';
        ELSIF currenttype = '所有任务' THEN
            v_where := ' ';
        ELSIF currenttype = '次月任务' THEN
            v_where := ' and (PLAN_END_DATE>last_day(trunc(sysdate))+1 and PLAN_END_DATE<last_day(last_day(trunc(sysdate))+1))';
        ELSIF currenttype = '本季度任务' THEN
            v_where := ' and (PLAN_END_DATE>trunc(sysdate, ''Q'') and PLAN_END_DATE<add_months(trunc(sysdate, ''Q''), 3) - 1) ';
        ELSIF currenttype = '本年任务' THEN
            v_where := ' and (PLAN_END_DATE>trunc(sysdate, ''yyyy'') and PLAN_END_DATE<add_months(trunc(sysdate, ''yyyy''), 12) - 1)  ';
        ELSE
            v_where := ' and 1=2';
        END IF;

 --当输入条件部位空时
        IF searchcondition is not null THEN
          v_where_like := 'WHERE (instr(n.NODE_NAME,'''||searchcondition||''')>0 OR instr(n.PLAN_NAME,'''||searchcondition||''')>0
              OR instr(n.PROJ_NAME,'''||searchcondition||''')>0 OR instr(n.DUTY_DEPARTMENT,'''||searchcondition||''')>0
              OR instr(charge_person,'''||searchcondition||''')>0 )';
        ELSE
          v_where_like := '';
        END IF;
--3.拼接完整语句
IF companyid <> '333' THEN
        v_sql_exec := ' select  rownum as rowno,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
		CHARGE_PERSON,
    NODE_LEVEL,
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE is null then ''催办''
else null end as HASTEN

                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    n.ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门
		person.CHARGE_PERSON,
    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n
		LEFT JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
		LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON n.ID=person.NODE_ID
        left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id
        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
        on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
        WHERE tal.orgid is not null
        AND (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and APPROVAL_STATUS=''已审核''
		AND	n.IS_DISABLE=0
    and n.COMPANY_ID='''
                      || wwhere
                      || ''' '
                      || v_where
                      || '
UNION ALL
SELECT
    n.ID   AS id,
     p.id as ORIGINAL_PLAN_ID,
    n.ID   AS ORIGINAL_NODE_ID,
    PLAN_ID,
    2 AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    PREDICT_END_DATE,
    ''所属项目'' AS E,
    ''专项计划'' AS F,
    DUTY_DEPARTMENT,
		person.CHARGE_PERSON,
    ''专项计划级'' AS M,
    0 AS N
FROM
    POM_SPECIAL_PLAN_NODE n
		LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID
		LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON n.ID=person.NODE_ID
        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on  n.DUTY_DEPARTMENT_ID in tal.orgid or n.COMPANY_ID in tal.orgid or p.COMPANY_ID in tal.orgid
        WHERE tal.orgid is not null
        AND APPROVAL_STATUS=''已审核''  AND n.IS_DELETE=0 and n.COMPANY_ID='''
                      || wwhere
                      || ''' '
                      || v_where
                      || '
UNION ALL
    SELECT    n.id,
    p.ORIGINAL_PLAN_ID,
    n.original_node_id,
    dept_monthly_plan_id,
    4 as  PLAN_TYPE_INT,

    node_name,
    p.PLAN_NAME,
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    ''无'' as PROJ_NAME,          --所属项目
    ''部门月度计划'' as  PLAN_TYPE,        --计划类型显示名
    p.DEPT_NAME,          --主责部门
		person.CHARGE_PERSON,
    node_Type,           --任务等级
    stand_SCORE          --标准分值
FROM
    pom_dept_monthly_plan_node n
    left join pom_dept_monthly_plan p on n.dept_monthly_plan_id=p.id
    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON n.ID=person.NODE_ID
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on p.DEPT_ID in tal.orgid or p.COMPANY_ID in tal.orgid
    WHERE tal.orgid is not null
    AND  node_source is null AND (IS_DEL=0 OR IS_DEL=null) and APPROVE_STATUS=''已审核'' and p.COMPANY_ID='''
                      || companyid
                      || ''' '
                      || v_where
                      || ')n
    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID WHERE (n.NODE_NAME LIKE ''%'||searchcondition||'%'' OR  n.PLAN_NAME LIKE ''%'||searchcondition||'%'' 
    OR n.PROJ_NAME LIKE ''%'||searchcondition||'%'' OR n. DUTY_DEPARTMENT LIKE ''%'||searchcondition||'%'' OR n.CHARGE_PERSON LIKE ''%'||searchcondition||'%'') ORDER BY n.PLAN_END_DATE) a ';
ELSE
v_sql_exec := ' select  rownum as rowno,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
		CHARGE_PERSON,
    NODE_LEVEL,
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE is null then ''催办''
else null end as HASTEN
                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    n.ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门
		person.CHARGE_PERSON,
    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n
		LEFT JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
		LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON n.ID=person.NODE_ID
        left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id
        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
        on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
        WHERE tal.orgid is not null
        AND (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and APPROVAL_STATUS=''已审核''
		AND	n.IS_DISABLE=0
         '|| v_where || '
UNION ALL
SELECT
    n.ID   AS id,
     p.id as ORIGINAL_PLAN_ID,
    n.ID   AS ORIGINAL_NODE_ID,
    PLAN_ID,
    2 AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    PREDICT_END_DATE,
    ''所属项目'' AS E,
    ''专项计划'' AS F,
    DUTY_DEPARTMENT,
		cp.CHARGE_PERSON,
    ''专项计划级'' AS M,
    0 AS N
FROM
    POM_SPECIAL_PLAN_NODE n
		LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID
		left join (SELECT node_id,LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
        FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID
        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal
        on n.DUTY_DEPARTMENT_ID in tal.orgid or n.COMPANY_ID in tal.orgid or  p.COMPANY_ID in tal.orgid
        WHERE tal.orgid is not null AND APPROVAL_STATUS=''已审核''  AND n.IS_DELETE=0 '|| v_where || '
UNION ALL
    SELECT    n.id,
    p.ORIGINAL_PLAN_ID,
    n.original_node_id,
    dept_monthly_plan_id,
    3 as  PLAN_TYPE_INT,

    node_name,
    p.PLAN_NAME,
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    ''无'' as PROJ_NAME,          --所属项目
    ''部门月度计划'' as  PLAN_TYPE,        --计划类型显示名
    p.DEPT_NAME,          --主责部门
		cp.CHARGE_PERSON,
    node_Type,           --任务等级
    stand_SCORE          --标准分值
FROM
    pom_dept_monthly_plan_node n
    left join pom_dept_monthly_plan p on n.dept_monthly_plan_id=p.id
    left join (SELECT node_id,LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
    FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal
    on p.DEPT_ID in tal.orgid or p.COMPANY_ID in tal.orgid
    WHERE tal.orgid is not null AND (IS_DEL=0 OR IS_DEL=null) and APPROVE_STATUS=''已审核'' ' || v_where|| ')n
    left join （SELECT * FROM SYS_BIZ_WATCH w WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID '||v_where_like||' ORDER BY n.PLAN_END_DATE) a  ';
END IF;
-------------------------------------------------------------------------------------------内容

        v_sql_exec_paging := '
select a.* from ( '
                             || v_sql_exec
--                             || ' where rownum <= '
--                             || pageindex * pagesizes
--                             || ' ) a where a.rowno >= '
--                             || pagesizes * ( pageindex - 1 )
                             || ')a';

       -- dbms_output.put_line(v_sql_exec_paging);

				dbms_output.put_line(v_sql_exec_paging);
----获取总条数
--        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
--                          || v_sql_exec
--                          || ') a '
--        INTO total;

-- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN items FOR v_sql_exec_paging;
--SELECT '' A FROM DUAL;

    EXCEPTION
        WHEN OTHERS THEN
        testmsg:=sqlerrm||testmsg;
            OPEN items FOR SELECT
                               '失败咯' || testmsg plan_name
                           FROM
                               dual;

           -- dbms_output.put_line(sqlerrm);
    END;

END p_pom_export_company;
/

prompt
prompt Creating procedure P_POM_EXPORT_DEPT
prompt ====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_export_dept (
    userid        IN            VARCHAR,--用户id，用于过滤关注的任务
    deptid        IN            VARCHAR2,--输入变量：部门
    currentcompanyid     IN            VARCHAR2,--当前用户公司
    currentdeptid        IN            VARCHAR2,--当前用户部门
    currentstationid     IN            VARCHAR2,---当前用户的岗位
    bizcode       IN            VARCHAR2,---权限code
--    pageindex     IN            INT,
--    pagesizes     IN            INT,
    currenttype   IN            VARCHAR2,--完成节点类型(本月任务,超期未完成任务,所有未完成任务,所有已完成任务,所有任务,次月任务,本季度任务,本年任务)
    searchcondition IN          VARCHAR2,
    items         OUT           SYS_REFCURSOR,
    total         OUT           INT
) IS
--本部门负责的任务
--作者：陈丽
--日期：2019/11/15

    v_sql_start          CLOB;
    v_sql_end            CLOB;
    v_sql_content        CLOB;
    v_sql               CLOB;
    v_sql_exec          CLOB;
    v_sql_exec_paging   CLOB;
    v_spid              CLOB;            
    deptidwhere         CLOB;
    v_where              CLOB;
    testmsg             CLOB;
BEGIN
----------------------------------------------------统一解析
--    IF (deptid <> '444') THEN
       deptidwhere := deptid;
--    ELSE
--        deptidwhere := '';
--    END IF;
    --deptidwhere := ''' or ''1''=''1';
    testmsg := 'deptid:'
               || deptid
--               || '；pageindex:'
--               || pageindex
--               || '；pagesizes:'
--               || pagesizes
               || '；currenttype:'
               || currenttype;

    BEGIN
        total := 1000;
        v_sql_start := ' case ';
        v_sql_content := '';
        v_sql_end := '  else '''' end  ';

--调用数据权限验证存储过程
 P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
--        test_sql:=' select n.*,orgid  FROM POM_SPECIAL_PLAN_NODE n
--        LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID
--        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=n.DUTY_DEPARTMENT_ID or tal.orgid=n.COMPANY_ID
--
--        WHERE  APPROVAL_STATUS=''已审核'' and n.IS_DELETE=0';
--
--
--        open auth for test_sql;
--1.拼接查询语句
        FOR item IN (
            SELECT
                s.expression,
                vv.node_level,
                vv.plan_type
            FROM
                pom_rule_set s
                LEFT JOIN (
                    SELECT
                        MAX(s.created_time) AS t,
                        node_level,
                        plan_type
                    FROM
                        pom_rule_set             s
                        LEFT JOIN pom_rule_set_plan_type   pt ON s.id = pt.rule_id
                    WHERE
                        rule_type = '亮灯规则'
                       -- AND plan_type != '关键节点计划'
                        AND s.is_disable = 0
                    GROUP BY
                        node_level,
                        plan_type
                ) vv ON s.created_time = vv.t
                        AND s.node_level = vv.node_level
            WHERE
                vv.t IS NOT NULL
        ) LOOP
    ---拼接字符串
         v_sql_content := v_sql_content
                                || '  when plan_type='''
                                ||
            CASE item.plan_type
                WHEN '项目全景计划' THEN
                    '项目主项计划'
                ELSE item.plan_type
            END
                                || ''' and node_level='''
                                || item.node_level
                                || ''' then ('
                                || item.expression
                                || ')';
        END LOOP;

    --dbms_output.put_line('123333');
    --dbms_output.put_line(v_sql_content);
    --规则内容大于0才拼规则语句

        IF length(v_sql_content) > 0 THEN
            v_sql := v_sql_start
                     || v_sql_content
                     || v_sql_end;
        ELSE
    --无规则亮灯显示空
            v_sql := '''''';
        END IF;

-------------------------------------------------------------------------------------------内容

       IF currenttype = '本月任务' THEN
            v_where := ' and ACTUAL_END_DATE is null  and (PLAN_END_DATE>=trunc(sysdate, ''month'') and PLAN_END_DATE<=trunc(last_day(sysdate))) ';
        ELSIF currenttype = '超期未完成任务' THEN
            v_where := ' and sysdate>PLAN_END_DATE and ACTUAL_END_DATE is null';
        ELSIF currenttype = '所有未完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is null ';
        ELSIF currenttype = '所有已完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is not null ';
        ELSIF currenttype = '所有任务' THEN
            v_where := ' ';
        ELSIF currenttype = '次月任务' THEN
            v_where := ' and (PLAN_END_DATE>=last_day(trunc(sysdate))+1 and PLAN_END_DATE<=last_day(last_day(trunc(sysdate))+1))';
        ELSIF currenttype = '本季度任务' THEN
            v_where := ' and (PLAN_END_DATE>=trunc(sysdate, ''Q'') and PLAN_END_DATE<=add_months(trunc(sysdate, ''Q''), 3) - 1) ';
        ELSIF currenttype = '本年任务' THEN
            v_where := ' and (PLAN_END_DATE>=trunc(sysdate, ''yyyy'') and PLAN_END_DATE<=add_months(trunc(sysdate, ''yyyy''), 12) - 1)  ';
        ELSE
            v_where := ' and 1=2';
        END IF;
--3.拼接完整语句
IF (deptid <> '444') THEN
        v_sql_exec := ' select  rownum as rowno,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
    NODE_LEVEL,
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,charge_person,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,charge_person,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE is null then ''催办''
else null end as HASTEN

                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门

    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n LEFT
    JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
   left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id
    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
    WHERE  (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and APPROVAL_STATUS=''已审核''  AND	n.IS_DISABLE=0  and DUTY_DEPARTMENT_ID='''
                      || deptidwhere
                      || ''' '
                      || v_where
                      || '
UNION ALL
SELECT
    n.ID   AS id,
     p.id as ORIGINAL_PLAN_ID,
    n.ID   AS ORIGINAL_NODE_ID,
    PLAN_ID,
    2 AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    PREDICT_END_DATE,
    ''所属项目'' AS E,
    ''专项计划'' AS F,
    DUTY_DEPARTMENT,

    ''专项计划级'' AS M,
    0 AS N
FROM
    POM_SPECIAL_PLAN_NODE n
    LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID
     LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=n.DUTY_DEPARTMENT_ID or tal.orgid=n.COMPANY_ID
     WHERE  p.APPROVAL_STATUS=''已审核'' and n.IS_DELETE=0  and n.DUTY_DEPARTMENT_ID='''
                      || deptidwhere
                      || ''' '
                      || v_where
                      || '
UNION ALL
    SELECT    n.id,
    p.ORIGINAL_PLAN_ID,
    original_node_id,
    dept_monthly_plan_id,
    3 as  PLAN_TYPE_INT,

    node_name,
    p.PLAN_NAME,
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    ''无'' as PROJ_NAME,          --所属项目
    ''部门月度计划'' as  PLAN_TYPE,        --计划类型显示名
    p.DEPT_NAME,          --主责部门

    node_Type,           --任务等级
    stand_SCORE          --标准分值
FROM
    pom_dept_monthly_plan_node n
    left join pom_dept_monthly_plan p on n.dept_monthly_plan_id=p.id
     LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=p.DEPT_ID or tal.orgid=p.COMPANY_ID
     WHERE APPROVE_STATUS=''已审核''   AND n.IS_DEL=0 and DUTY_DEPT_ID='''
                      || deptidwhere
                      || ''' '
                      || v_where
                      || ')n
    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID
    left join (SELECT node_id,
     LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
      FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID WHERE (n.NODE_NAME LIKE ''%'||searchcondition||'%'' OR  n.PLAN_NAME LIKE ''%'||searchcondition||'%''
    OR n.PROJ_NAME LIKE ''%'||searchcondition||'%'' OR n. DUTY_DEPARTMENT LIKE ''%'||searchcondition||'%'' OR cp.charge_person like ''%'||searchcondition||'%'' )  ORDER BY n.PLAN_END_DATE) a ';
else
     v_sql_exec := ' select  rownum as rowno,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
    NODE_LEVEL,
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,charge_person,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,charge_person,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE is null then ''催办''
else null end as HASTEN

                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门

    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n LEFT
    JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
    left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id
    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
    WHERE (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and APPROVAL_STATUS=''已审核''  AND	n.IS_DISABLE=0 '
                      || v_where
                      || '
UNION ALL
SELECT
    n.ID   AS id,
     p.id as ORIGINAL_PLAN_ID,
    n.ID   AS ORIGINAL_NODE_ID,
    PLAN_ID,
    2 AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    PREDICT_END_DATE,
    ''所属项目'' AS E,
    ''专项计划'' AS F,
    DUTY_DEPARTMENT,

    ''专项计划级'' AS M,
    0 AS N
FROM
    POM_SPECIAL_PLAN_NODE n
    LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID
     LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=n.DUTY_DEPARTMENT_ID or tal.orgid=n.COMPANY_ID
     WHERE  APPROVAL_STATUS=''已审核'' and n.IS_DELETE=0  '
                      || v_where
                      || '
UNION ALL
    SELECT    n.id,
    p.ORIGINAL_PLAN_ID,
    original_node_id,
    dept_monthly_plan_id,
    3 as  PLAN_TYPE_INT,

    node_name,
    p.PLAN_NAME,
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    ''无'' as PROJ_NAME,          --所属项目
    ''部门月度计划'' as  PLAN_TYPE,        --计划类型显示名
    p.DEPT_NAME,          --主责部门

    node_Type,           --任务等级
    stand_SCORE          --标准分值
FROM
    pom_dept_monthly_plan_node n
    left join pom_dept_monthly_plan p on n.dept_monthly_plan_id=p.id
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=p.DEPT_ID or tal.orgid=p.COMPANY_ID
    WHERE APPROVE_STATUS=''已审核''   AND n.IS_DEL=0  '
                      || v_where
                      || ')n
    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID
    left join (SELECT node_id,
    LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
    FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID WHERE (n.NODE_NAME LIKE ''%'||searchcondition||'%'' OR  n.PLAN_NAME LIKE ''%'||searchcondition||'%''
    OR n.PROJ_NAME LIKE ''%'||searchcondition||'%'' OR n.DUTY_DEPARTMENT LIKE ''%'||searchcondition||'%'' OR cp.charge_person like ''%'||searchcondition||'%'' )  ORDER BY n.PLAN_END_DATE) a ';
end if;
-------------------------------------------------------------------------------------------内容

       v_sql_exec_paging := '
select a.* from ( '
                             || v_sql_exec
                             --|| ' where rownum <= '
--                             || pageindex * pagesizes
--                             || ' ) a where a.rowno >= '
--                             || pagesizes * ( pageindex - 1 )
                            || ') a';

        dbms_output.put_line(v_sql_exec_paging);
------获取总条数
--        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
--                          || v_sql_exec
--                          || ') a '
--        INTO total;

-- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN items FOR v_sql_exec_paging;
--SELECT '' A FROM DUAL;

    EXCEPTION
        WHEN OTHERS THEN
            testmsg := sqlerrm || testmsg;
            OPEN items FOR SELECT
                               '失败咯' || testmsg plan_name
                           FROM
                               dual;

            dbms_output.put_line(sqlerrm);
    END;

END p_pom_export_dept;
/

prompt
prompt Creating procedure P_POM_EXPORT_PERSONAL
prompt ========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_export_personal (
    userid        IN            VARCHAR2,--输入变量：用户ID
    currenttype   IN            VARCHAR2,--完成节点类型（所有未完成，超期未完成，所有已完成）
    searchcondition IN          VARCHAR2,
    items         OUT           SYS_REFCURSOR
--    total         OUT           INT
) IS

    v_sql_start          CLOB;
    v_sql_end           CLOB;
    v_sql_content        CLOB;
    v_sql               CLOB;
    v_sql_exec          CLOB;
    v_sql_exec_paging   CLOB;
    v_where              CLOB;
    testmsg             CLOB;
BEGIN
    --total := 1000;
    v_sql_start := ' case ';
    v_sql_content := '';
    v_sql_end := '  else '''' end  ';
    BEGIN

--1.拼接查询语句
        FOR item IN (
            SELECT
                s.expression,
                vv.node_level,
                vv.plan_type
            FROM
                pom_rule_set s
                LEFT JOIN (
                    SELECT
                        MAX(s.created_time) AS t,
                        node_level,
                        plan_type
                    FROM
                        pom_rule_set             s
                        LEFT JOIN pom_rule_set_plan_type   pt ON s.id = pt.rule_id
                    WHERE
                        rule_type = '亮灯规则'
                        --AND plan_type != '关键节点计划'
                        AND s.is_disable = 0
                    GROUP BY
                        node_level,
                        plan_type
                ) vv ON s.created_time = vv.t
                        AND s.node_level = vv.node_level
            WHERE
                vv.t IS NOT NULL
        ) LOOP 
    ---拼接字符串
         v_sql_content := v_sql_content
                                || '  when plan_type='''
                                ||
            CASE item.plan_type
                WHEN '项目全景计划' THEN
                    '项目主项计划'
                ELSE item.plan_type
            END
                                || ''' and node_level='''
                                || item.node_level
                                || ''' then ('
                                || item.expression
                                || ')';
        END LOOP;

    --dbms_output.put_line('123333');
    --dbms_output.put_line(v_sql_content);
    --规则内容大于0才拼规则语句

        IF length(v_sql_content) > 0 THEN
            v_sql := v_sql_start
                     || v_sql_content
                     || v_sql_end;
        ELSE
    --无规则亮灯显示空
            v_sql := '''''';
        END IF;
-------------------------------------------------------------------------------------------内容

        IF currenttype = '所有未完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is null';
        ELSIF currenttype = '超期未完成任务' THEN
            v_where := ' and sysdate>PLAN_END_DATE  and ACTUAL_END_DATE is null';
        ELSIF currenttype = '所有已完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is not null ';
        ELSE
            v_where := '';
        END IF;
--3.拼接完整语句

        v_sql_exec := ' select  rownum as rowno,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,         
    PLAN_TYPE,       
    DUTY_DEPARTMENT,         
    NODE_LEVEL,  
		CHARGE_PERSON,
    STANDARD_SCORE ,WACTH,HASTEN,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,''关注'' as WACTH,''催办'' as HASTEN from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    n.ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    n.NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门
		person.CHARGE_PERSON,
    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n 
		LEFT JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
		LEFT JOIN POM_NODE_CHARGE_PERSON person ON n.ID=person.NODE_ID	
		WHERE (p.PLAN_TYPE=''项目主项计划'' OR p.PLAN_TYPE=''关键节点计划'')  AND n.IS_DISABLE=0  and APPROVAL_STATUS=''已审核'' 
		AND CHARGE_PERSON_ID='''||userid||'''  '
                      || v_where
                      || '
UNION ALL
SELECT
    n.ID   AS id,
     p.id as ORIGINAL_PLAN_ID,
    n.ID   AS ORIGINAL_NODE_ID,
    PLAN_ID,
    2 AS PLAN_TYPE_INT,

    n.NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    PREDICT_END_DATE,
    ''所属项目'' AS E,
    ''专项计划'' AS F,
    DUTY_DEPARTMENT,
		person.CHARGE_PERSON,
    ''专项计划级'' AS M,
    0 AS N
FROM
    POM_SPECIAL_PLAN_NODE n 
		LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID 
		LEFT JOIN POM_NODE_CHARGE_PERSON person ON n.ID=person.NODE_ID
		where n.IS_DELETE=0 AND APPROVAL_STATUS=''已审核'' 
		AND CHARGE_PERSON_ID='''||userid||'''  '
                      || v_where
                      || '
UNION ALL
    SELECT    n.id,
    p.ORIGINAL_PLAN_ID,
    n.original_node_id,
    dept_monthly_plan_id,
    10 as  PLAN_TYPE_INT,

    n.node_name,
    p.PLAN_NAME,
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    ''无'' as PROJ_NAME,          --所属项目
    ''部门月度计划'' as  PLAN_TYPE,        --计划类型显示名
    p.DEPT_NAME,          --主责部门
		person.CHARGE_PERSON,
    node_Type,           --任务等级
    stand_SCORE          --标准分值
FROM
    pom_dept_monthly_plan_node n
    left join pom_dept_monthly_plan p on n.dept_monthly_plan_id=p.id
		LEFT JOIN POM_NODE_CHARGE_PERSON person ON n.ID=person.NODE_ID
    where node_source is null AND n.IS_DEL=0 and APPROVE_STATUS=''已审核''
		AND CHARGE_PERSON_ID='''||userid||'''  '
                      || v_where
                      || ')n  
  WHERE (n.NODE_NAME LIKE ''%'||searchcondition||'%'' OR  n.PLAN_NAME LIKE ''%'||searchcondition||'%'' 
    OR n.PROJ_NAME LIKE ''%'||searchcondition||'%'' OR n. DUTY_DEPARTMENT LIKE ''%'||searchcondition||'%'' )  ORDER BY n.PLAN_END_DATE  ) a  ';-- left join POM_NODE_CHARGE_PERSON cp on n.id=cp.NODE_ID where CHARGE_PERSON_ID='''||userid||'''  
-------------------------------------------------------------------------------------------内容


       v_sql_exec_paging := '
select a.* from ( '
                             || v_sql_exec
                             --|| ' where rownum <= '
--                             || pageindex * pagesizes
--                             || ' ) a where a.rowno >= '
--                             || pagesizes * ( pageindex - 1 )
                            || ') a';

        --dbms_output.put_line(v_sql_exec_paging);
----获取总条数

--        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
--                          || v_sql_exec
--                          || ') a '
--        INTO total;
        dbms_output.put_line(v_sql_exec_paging);
-- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN items FOR v_sql_exec;
--SELECT '' A FROM DUAL;

    EXCEPTION
        WHEN OTHERS THEN
            OPEN items FOR SELECT
                               '失败咯' || testmsg plan_name
                           FROM
                               dual;

            dbms_output.put_line(sqlerrm);
    END;

END p_pom_export_personal;
/

prompt
prompt Creating procedure P_POM_EXPORT_PROJECT
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_export_project (
    projid        IN            VARCHAR2,--输入变量：项目
    userid        IN 			VARCHAR2,--用户id，用于过滤关注的任务
    currentcompanyid     IN            VARCHAR2,--当前用户公司
    currentdeptid        IN            VARCHAR2,--当前用户部门
    currentstationid     IN            VARCHAR2,---当前用户的岗位
    bizcode       IN            VARCHAR2,---权限code
--    pageindex     IN            INT,
--    pagesizes     IN            INT,
    currenttype   IN            VARCHAR2,--完成节点类型(本月任务,超期未完成任务,所有未完成任务,所有已完成任务,所有任务,次月任务,本季度任务,本年任务)
    searchcondition IN          VARCHAR2,--模糊查询条件
    items         OUT           SYS_REFCURSOR,
    total         OUT           INT
) IS
--本部门负责的任务
--作者：陈丽
--日期：2019/11/15

    v_sql_start          CLOB;
    v_sql_end            CLOB;
    v_sql_content        CLOB;
    v_sql               CLOB;
    v_sql_exec          CLOB;
    v_sql_exec_paging   CLOB;
    v_where              CLOB;
    v_spid              CLOB; 
    testmsg              CLOB;
BEGIN
----------------------------------------------------统一解析
    testmsg := 'projid:'
               || projid
--               || '；pageindex:'
--               || pageindex
--               || '；pagesizes:'
--               || pagesizes
--               || '；currenttype:'
               || currenttype;

    BEGIN
        total := 1000;
        v_sql_start := ' case ';
        v_sql_content := '';
        v_sql_end := '  else '''' end  ';

--调用数据权限验证存储过程
 P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
--1.拼接查询语句
        FOR item IN (
            SELECT
                s.expression,
                vv.node_level,
                vv.plan_type
            FROM
                pom_rule_set s
                LEFT JOIN (
                    SELECT
                        MAX(s.created_time) AS t,
                        node_level,
                        plan_type
                    FROM
                        pom_rule_set             s
                        LEFT JOIN pom_rule_set_plan_type   pt ON s.id = pt.rule_id
                    WHERE
                        rule_type = '亮灯规则'
                       -- AND plan_type != '关键节点计划'
                        AND s.is_disable = 0
                    GROUP BY
                        node_level,
                        plan_type
                ) vv ON s.created_time = vv.t
                        AND s.node_level = vv.node_level
            WHERE
                vv.t IS NOT NULL
        ) LOOP 
    ---拼接字符串
         v_sql_content := v_sql_content
                                || '  when plan_type='''
                                ||
            CASE item.plan_type
                WHEN '项目全景计划' THEN
                    '项目主项计划'
                ELSE item.plan_type
            END
                                || ''' and node_level='''
                                || item.node_level
                                || ''' then ('
                                || item.expression
                                || ')';
        END LOOP;

    --dbms_output.put_line('123333');
    --dbms_output.put_line(v_sql_content);
    --规则内容大于0才拼规则语句

        IF length(v_sql_content) > 0 THEN
            v_sql := v_sql_start
                     || v_sql_content
                     || v_sql_end;
        ELSE
    --无规则亮灯显示空
            v_sql := '''''';
        END IF;

-------------------------------------------------------------------------------------------内容


       IF currenttype = '本月任务' THEN
            v_where := ' and ACTUAL_END_DATE is null and (PLAN_END_DATE>=trunc(sysdate, ''month'') and PLAN_END_DATE<=trunc(last_day(sysdate))) ';
        ELSIF currenttype = '超期未完成任务' THEN
            v_where := ' and sysdate>PLAN_END_DATE and ACTUAL_END_DATE is null';
        ELSIF currenttype = '所有未完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is null ';
        ELSIF currenttype = '所有已完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is not null ';
        ELSIF currenttype = '所有任务' THEN
            v_where := ' ';
        ELSIF currenttype = '次月任务' THEN
            v_where := ' and (PLAN_END_DATE>last_day(trunc(sysdate))+1 and PLAN_END_DATE<last_day(last_day(trunc(sysdate))+1))';
        ELSIF currenttype = '本季度任务' THEN
            v_where := ' and (PLAN_END_DATE>trunc(sysdate, ''Q'') and PLAN_END_DATE<add_months(trunc(sysdate, ''Q''), 3) - 1) ';
        ELSIF currenttype = '本年任务' THEN
            v_where := ' and (PLAN_END_DATE>trunc(sysdate, ''yyyy'') and PLAN_END_DATE<add_months(trunc(sysdate, ''yyyy''), 12) - 1)  ';
        ELSE
            v_where := ' and 1=2';
        END IF;

--3.拼接完整语句
if projid <> '111' then
        v_sql_exec := ' select  rownum as rowno,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,         
    PLAN_TYPE,       
    DUTY_DEPARTMENT,      
		CHARGE_PERSON,
    NODE_LEVEL,      
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE is null then ''催办''
else null end as HASTEN

                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    n.ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门
    person.CHARGE_PERSON,
    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n 
		LEFT JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID 
		LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID) person ON n.ID=person.NODE_ID
        left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id 
        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal 
        on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
        WHERE tal.orgid is not null 
        AND (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and APPROVAL_STATUS=''已审核'' 
		AND n.IS_DISABLE=0 
		AND (p.PROJ_ID='''||projid||''' OR p.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID='''||projid||'''))  '||v_where||'
)n 
    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID  WHERE (n.NODE_NAME LIKE ''%'||searchcondition||'%'' OR  n.PLAN_NAME LIKE ''%'||searchcondition||'%'' 
    OR n.PROJ_NAME LIKE ''%'||searchcondition||'%'' OR n. DUTY_DEPARTMENT LIKE ''%'||searchcondition||'%'' OR n.CHARGE_PERSON LIKE ''%'||searchcondition||'%'')  ORDER BY n.PLAN_END_DATE) a ';
else 
    v_sql_exec := ' select  rownum as rowno,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,         
    PLAN_TYPE,       
    DUTY_DEPARTMENT,      
		CHARGE_PERSON,
    NODE_LEVEL,      
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,''催办'' as HASTEN

                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    n.ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门
    person.CHARGE_PERSON,
    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n 
		LEFT JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID 
		LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID) person ON n.ID=person.NODE_ID
		left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id 
        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal 
        on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
        WHERE tal.orgid is not null 
        AND (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and APPROVAL_STATUS=''已审核'' 
		AND n.IS_DISABLE=0 
		  '||v_where||'
)n 
    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID   WHERE (n.NODE_NAME LIKE ''%'||searchcondition||'%'' OR  n.PLAN_NAME LIKE ''%'||searchcondition||'%'' 
    OR n.PROJ_NAME LIKE ''%'||searchcondition||'%'' OR n. DUTY_DEPARTMENT LIKE ''%'||searchcondition||'%'' OR n.CHARGE_PERSON LIKE ''%'||searchcondition||'%'')  ORDER BY n.PLAN_END_DATE) a ';
end if;
-------------------------------------------------------------------------------------------内容

        v_sql_exec_paging := '
select a.* from ( '
                             || v_sql_exec
--                             || ' where rownum <= '
--                             || pageindex * pagesizes
--                             || ' ) a where a.rowno >= '
--                             || pagesizes * ( pageindex - 1 )
                             || ')a';

        dbms_output.put_line(v_sql_exec_paging);
----获取总条数
--        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
--                          || v_sql_exec
--                          || ') a '
--        INTO total;

-- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN items FOR v_sql_exec_paging;
--SELECT '' A FROM DUAL;

    EXCEPTION
        WHEN OTHERS THEN
        testmsg:=sqlerrm||testmsg;
            OPEN items FOR SELECT
                               '失败咯' || testmsg plan_name
                           FROM
                               dual;

            dbms_output.put_line(sqlerrm);
    END;

END p_pom_export_project;
/

prompt
prompt Creating procedure P_POM_FEEDBACK_APPROVAL_CB
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_feedback_approval_cb (
    feedbackid IN VARCHAR2 --反馈id
) AS 
--反馈审批回调，只有审批通过才执行操作
--作者：陈丽
--日期：2019/11/13

    approvalstatus           NVARCHAR2(100);--审核状态
    feedbacktype             NVARCHAR2(100);--反馈类型（0：过程反馈，1：完成反馈，2：到期未完成反馈）
    feedbacknodeoriginalid   NVARCHAR2(100); --反馈节点原始id
    plantype                 NVARCHAR2(100);--节点所属计划类型(0：关键节点计划，1：项目主项计划、2：专项计划、3：部门月度计划）
    actualstarttime          DATE;--实际开始时间
    actualendtime            DATE;--实际结束时间
    estimatestarttime        DATE;--预计开始时间
    estimateendtime          DATE;--预计结束时间
BEGIN
    BEGIN
          --o、获取反馈信息
        SELECT
            approval_status,
            node_source_plan_type,
            feedback_type,
            feedback_node_original_id,
            actual_start_time,
            actual_end_time,
            estimate_start_time,
            estimate_end_time
        INTO
            approvalstatus,
            plantype,
            feedbacktype,
            feedbacknodeoriginalid,
            actualstarttime,
            actualendtime,
            estimatestarttime,
            estimateendtime
        FROM
            pom_node_feedback
        WHERE
            id = feedbackid;
						
						--KEY_NODE：关键节点计划，MAIN_ITEM：项目主项计划、SPECIAL：专项计划、DEPARTMENT:部门月度计划
						--PROCESS：过程反馈，CARRY_OUT：完成反馈，EXPIRED：到期未完成反馈
--1、更新反馈对应节点，【完成反馈】更新节点实际开始时间和实际完成时间，【未完成反馈】【过程反馈】更新节点预计开始时间和预计完成时间。
  dbms_output.put_line('feedbacktype='||feedbacktype);
  dbms_output.put_line('plantype='||plantype);
	  dbms_output.put_line('approvalstatus='||approvalstatus);
        IF (feedbacktype = 'PROCESS' OR feedbacktype = 'EXPIRED') and approvalstatus='已审核'   THEN--过程反馈，到期未完成反馈
            BEGIN
                IF (plantype = 'KEY_NODE' OR plantype = 'MAIN_ITEM') and approvalstatus='已审核'  THEN--0：关键节点计划，1：项目主项计划,【未完成反馈】【过程反馈】更新节点预计开始时间和预计完成时间。
                    dbms_output.put_line('--0：关键节点计划，1：项目主项计划,【未完成反馈】【过程反馈】');
                    UPDATE pom_proj_plan_node
                    SET
                        estimate_start_date = estimatestarttime,
                        estimate_end_date = estimateendtime,
                        feedback_id = feedbackid
                    WHERE
                        original_node_id = feedbacknodeoriginalid;

                ELSIF feedbacktype = 'SPECIAL' and approvalstatus='已审核'  THEN--2：专项计划
                    UPDATE pom_special_plan_node
                    SET
                        PREDICT_BEGIN_DATE = estimatestarttime,
                        predict_end_date = estimateendtime,
                        feedback_id = feedbackid
                    WHERE
                        original_node_id = feedbacknodeoriginalid;

                ELSIF feedbacktype = 'DEPARTMENT' and approvalstatus='已审核'  THEN--3：部门月度计划
                    UPDATE pom_dept_monthly_plan_node
                    SET
                        estimate_start_date = estimatestarttime,
                        estimate_end_date = estimateendtime,
                        feedback_id = feedbackid
                    WHERE
                        original_node_id = feedbacknodeoriginalid;

                END IF;

            END;

        ELSIF feedbacktype = 'CARRY_OUT'and approvalstatus='已审核'   THEN--完成反馈，【完成反馈】更新节点实际开始时间和实际完成时间
            BEGIN
                IF (plantype = 'KEY_NODE' OR plantype = 'MAIN_ITEM')and approvalstatus='已审核'   THEN--0：关键节点计划，1：项目主项计划,【未完成反馈】【过程反馈】更新节点预计开始时间和预计完成时间。
                    UPDATE pom_proj_plan_node
                    SET
                        actual_start_date = actualstarttime,
                        actual_end_date = actualendtime,
                        feedback_id = feedbackid
                    WHERE
                        original_node_id = feedbacknodeoriginalid;

                ELSIF plantype = 'SPECIAL' and approvalstatus='已审核' THEN--2：专项计划
                    UPDATE pom_special_plan_node
                    SET
                        PREDICT_BEGIN_DATE = actualstarttime,
                        actual_end_date = actualendtime,
                        feedback_id = feedbackid
                    WHERE
                        original_node_id = feedbacknodeoriginalid;

                ELSIF plantype = 'DEPARTMENT'and approvalstatus='已审核'   THEN--3：部门月度计划
                    UPDATE pom_dept_monthly_plan_node
                    SET
                        actual_start_date = actualstarttime,
                        actual_end_date = actualendtime,
                        feedback_id = feedbackid
                    WHERE
                        original_node_id = feedbacknodeoriginalid;

                END IF;

            END;
        END IF;
--2、项目主项计划反馈时，更新月度计划引入的项目主项计划节点，【完成反馈】更新节点实际开始时间和实际完成时间，【未完成反馈】【过程反馈】更新节点预计开始时间和预计完成时间。

        IF feedbacktype = 'CARRY_OUT' AND plantype = 'MAIN_ITEM' and approvalstatus='已审核'   THEN --项目主项计划，完成反馈
                --更新月度计划，引入项目的未完成节点，条件 实际完成日期为空
            UPDATE pom_proj_plan_node
            SET
                actual_start_date = estimatestarttime,
                actual_end_date = estimateendtime,
                feedback_id = feedbackid
            WHERE
                original_node_id = feedbacknodeoriginalid
                AND actual_end_date IS NULL;

        ELSIF ( feedbacktype = 'PROCESS' OR feedbacktype = 'CARRY_OUT' ) AND plantype = 'MAIN_ITEM' and approvalstatus='已审核'   THEN --项目主项计划，过程反馈，未完成反馈
            UPDATE pom_proj_plan_node
            SET
                estimate_start_date = estimatestarttime,
                estimate_end_date = estimateendtime,
                feedback_id = feedbackid
            WHERE
                original_node_id = feedbacknodeoriginalid
                AND actual_end_date IS NULL;
                --更新月度计划，引入项目的未完成节点

        END IF;

--3、关键节点计划、项目主项计划、部门月度计划。完成反馈，根据考核规则计算得分，生成数据到考核表。

    EXCEPTION
        WHEN OTHERS THEN
           return;
    END;
END p_pom_feedback_approval_cb;
/

prompt
prompt Creating procedure P_POM_FEEDBACK_APPROVAL_CODE
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_FEEDBACK_APPROVAL_CODE
(
		FEEDBACKID    IN VARCHAR2 --反馈id
	 ,FORMCODE      OUT VARCHAR2 --表单编码
	 ,FORMGROUPCODE OUT VARCHAR2 --表单分组编码
) AS
		--反馈工作流审批时获取审批需要的表单编码和分组编码
		--作者：陈丽
		--日期：2019/11/13
		V_NODE_TYPE VARCHAR2(100);
BEGIN

		SELECT A.NODE_SOURCE_PLAN_TYPE INTO V_NODE_TYPE FROM POM_NODE_FEEDBACK A WHERE A.ID = FEEDBACKID;

		IF V_NODE_TYPE = 'KEY_NODE' THEN
				FORMCODE := 'pom_feedback_key_nodes';
		ELSIF V_NODE_TYPE = 'MAIN_ITEM' THEN
				FORMCODE := 'pom_feedback_main_nodes';
		ELSE
				FORMCODE := 'pom_feedback_key_nodes';
		END IF;
/*		FORMCODE := 'pom_feedback_key_nodes';*/
		FORMGROUPCODE := '';
END P_POM_FEEDBACK_APPROVAL_CODE;
/

prompt
prompt Creating procedure P_POM_FISSION_NODE_UPDATE
prompt ============================================
prompt
create or replace procedure pom0813.P_POM_FISSION_NODE_UPDATE(
    feedbackId in varchar2
) as
    oldId varchar2(36);
begin
    begin
        select pn.ID into oldId
        from POM_NODE_FEEDBACK pnf
            left join POM_PROJ_PLAN_NODE pn on pnf.feedback_node_id = pn.id
        where pnf.ID = feedbackId;
    exception when others then
        oldId := null;
        DBMS_OUTPUT.PUT_LINE('未获取到节点数据');
    end;
    if oldId is not null then
        -- 添加新数据
        insert into POM_PROJ_PLAN_NODE(
            ID, PROJ_PLAN_ID, ORIGINAL_NODE_ID, TEMPLATE_NODE_ID, STANDARD_NODE_ID,
            NODE_GRADE, NODE_NAME, NODE_CODE, NODE_LEVEL, PROJ_STAGE, MAIN_RESPONSIBILITY,
            CONTROL_TYPE, DUTY_DEPARTMENT_ID, DUTY_DEPARTMENT, PLAN_START_DATE, PLAN_END_DATE,
            IS_DISABLE, DISABLE_TIME, DISABLE_REASON_ID, STANDARD_SCORE, REFERENCE_DATE_NODE_ID,
            REFERENCE_DAY, PRECONDITION_REMARK, IS_CONTAINS_PERMIT, PERMIT_TYPE,
            COMPLETION_STANDARD, COMPLETION_RESULTS_REMARK, INPUT_CONDITION, OTHER_REMARK,
            CREATED, CREATOR_ID, CREATOR, MODIFIED, MODIFIER_ID, MODIFIER, PLAN_VERSION,
            IS_DELETE, DISABLE_REASON, ORIGINAL_PLAN_ID, COMPANY_NAME, COMPANY_ID,
            ACTUAL_END_DATE, ACTUAL_START_DATE, FEEDBACK_ID,
            FISSION_SOURCE_ORIGINAL_ID)
        select
            GET_UUID() ID, PROJ_PLAN_ID, pn.ORIGINAL_NODE_ID, TEMPLATE_NODE_ID, STANDARD_NODE_ID, NODE_GRADE,
            NODE_NAME || neb.BUILD_NAME NODE_NAME, NODE_CODE NODE_CODE, NODE_LEVEL, PROJ_STAGE,
            MAIN_RESPONSIBILITY,CONTROL_TYPE, DUTY_DEPARTMENT_ID, DUTY_DEPARTMENT, neb.PLAN_START_DATE PLAN_START_DATE,
            neb.PLAN_END_DATE PLAN_END_DATE, IS_DISABLE, DISABLE_TIME, DISABLE_REASON_ID, STANDARD_SCORE,
            REFERENCE_DATE_NODE_ID, REFERENCE_DAY, PRECONDITION_REMARK, IS_CONTAINS_PERMIT, pn.PERMIT_TYPE,
            COMPLETION_STANDARD, COMPLETION_RESULTS_REMARK, INPUT_CONDITION, pn.OTHER_REMARK, sysdate CREATED,
            pn.CREATOR_ID, pn.CREATOR, pn.MODIFIED, pn.MODIFIER_ID, pn.MODIFIER, pn.PLAN_VERSION, pn.IS_DELETE,
            DISABLE_REASON, pn.ORIGINAL_PLAN_ID, pn.COMPANY_NAME, pn.COMPANY_ID,
            null ACTUAL_END_DATE, null ACTUAL_START_DATE, null FEEDBACK_ID, pn.ID FISSION_SOURCE_ORIGINAL_ID
        from POM_PROJ_PLAN_NODE pn
            left join (
            select neb1.NODE_ID, neb1.PLAN_START_DATE, neb1.PLAN_END_DATE,
                wm_concat(neb1.BUILD_NAME) BUILD_NAME from (
                select mb.BUILD_NAME, neb1.NODE_ID, neb1.PLAN_START_DATE, neb1.PLAN_END_DATE
                from POM_NEXT_EVIDENCE_BUILD neb1
                    left join MDM_BUILD mb on mb.ID = neb1.BUILD_ID
                order by NODE_ID, mb.BUILD_NAME
            ) neb1
            group by neb1.NODE_ID, neb1.PLAN_START_DATE, neb1.PLAN_END_DATE
        ) neb on neb.NODE_ID = pn.ID
        where pn.id = oldId and pn.IS_CONTAINS_PERMIT = 1;
    end if;
end;
/

prompt
prompt Creating procedure P_POM_GETPJPLAN_EXM_SOCRE
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_GETPJPLAN_EXM_SOCRE

AS

BEGIN 
DELETE FROM POM_PJPLAN_EXM_SOCRE_TABLE;
INSERT  into POM_PJPLAN_EXM_SOCRE_TABLE
SELECT * FROM V_POM_PJPLAN_EXM_SOCRE;
END;
/

prompt
prompt Creating procedure P_POM_GET_BUSINESS_TREE
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_GET_BUSINESS_TREE(
    IS_NEED_AUTHENTICATE IN VARCHAR2,
    BIZ_CODE IN VARCHAR2,
    CURRENT_USER_ID IN VARCHAR2,
    CURRENT_STATION_ID IN VARCHAR2,
    CURRENT_DEPARTMENT_ID IN VARCHAR2,
    CURRENT_COMPANY_ID IN VARCHAR2,
    TOP_ORG_ID IN VARCHAR2,
    BUSINESS_TREE OUT SYS_REFCURSOR
)
IS
    DATA_AUTH_SPID VARCHAR2(200);
    START_ORG_ID VARCHAR2(36);
BEGIN
    IF TOP_ORG_ID IS NULL THEN
        START_ORG_ID:= '003200000000000000000000000000';
    ELSE
        START_ORG_ID := TOP_ORG_ID;
    END IF;
    IF IS_NEED_AUTHENTICATE = '1' THEN
        P_SYS_GET_COMPANY_PROJ_SPID(
            USERID => CURRENT_USER_ID,
            STATIONID => CURRENT_STATION_ID,
            DEPTID => CURRENT_DEPARTMENT_ID,
            COMPANYID => CURRENT_COMPANY_ID,
            BIZCODE => BIZ_CODE,
            DATA_AUTH_SPID => DATA_AUTH_SPID
          );
        OPEN BUSINESS_TREE FOR 
            SELECT 
                ID,
                ORG_NAME,
                PARENT_ID,
                IS_COMPANY,
                ORG_TYPE
            FROM SYS_BUSINESS_UNIT UNIT
            LEFT JOIN (SELECT DISTINCT ORG_ID AS ORGID FROM  TMP_AUTH_LIST WHERE ID = DATA_AUTH_SPID) TAL ON UNIT.ID = TAL.ORGID
            WHERE TAL.ORGID IS NOT NULL
            START WITH UNIT.ID= START_ORG_ID
            CONNECT BY PRIOR UNIT.ID=UNIT.PARENT_ID ORDER BY ORDER_HIERARCHY_CODE ASC;
    ELSE 
    OPEN BUSINESS_TREE FOR 
        SELECT 
            ID,
            ORG_NAME,
            PARENT_ID,
            IS_COMPANY,
            ORG_TYPE
        FROM SYS_BUSINESS_UNIT start with id=START_ORG_ID  connect by prior id=parent_id ORDER BY ORDER_HIERARCHY_CODE ASC;
    END IF;
END P_POM_GET_BUSINESS_TREE;
/

prompt
prompt Creating procedure P_POM_GET_DEPARTMENT_TREE
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_GET_DEPARTMENT_TREE
(
    TOP_DEPARTMENT_ID IN VARCHAR2,
    IS_NEED_AUTHENTICATE IN VARCHAR2,
    BIZ_CODE IN VARCHAR2,
    CURRENT_USER_ID IN VARCHAR2,
    CURRENT_STATION_ID IN VARCHAR2,
    CURRENT_DEPARTMENT_ID IN VARCHAR2,
    CURRENT_COMPANY_ID IN VARCHAR2,
    DEPARTMENT_TREE OUT SYS_REFCURSOR
)
IS
DATA_AUTH_SPID VARCHAR2(200);
BEGIN
    IF IS_NEED_AUTHENTICATE = '1' THEN
        P_SYS_GET_COMPANY_PROJ_SPID(
            USERID => CURRENT_USER_ID,
            STATIONID => CURRENT_STATION_ID,
            DEPTID => CURRENT_DEPARTMENT_ID,
            COMPANYID => CURRENT_COMPANY_ID,
            BIZCODE => BIZ_CODE,
            DATA_AUTH_SPID => DATA_AUTH_SPID
          );
        OPEN DEPARTMENT_TREE FOR
            SELECT
                ID AS "orgId",
                ORG_NAME AS "orgName",
                PARENT_ID AS "parentId",
                IS_COMPANY AS "isCompany",
                ORG_TYPE AS "orgType",
                ID AS "id"
            FROM SYS_BUSINESS_UNIT UNIT
            LEFT JOIN (SELECT DISTINCT ORG_ID AS ORGID FROM  TMP_AUTH_LIST WHERE ID = DATA_AUTH_SPID) TAL ON UNIT.ID = TAL.ORGID
            WHERE TAL.ORGID IS NOT NULL AND IS_COMPANY = 0
            START WITH UNIT.ID= TOP_DEPARTMENT_ID
            CONNECT BY PRIOR UNIT.ID=UNIT.PARENT_ID ORDER BY ORDER_HIERARCHY_CODE ASC;
    ELSE
        OPEN DEPARTMENT_TREE FOR
            SELECT
                ID AS "orgId",
                ORG_NAME AS "orgName",
                PARENT_ID AS "parentId",
                IS_COMPANY AS "isCompany",
                ORG_TYPE AS "orgType",
                ID as "id"
            FROM SYS_BUSINESS_UNIT UNIT
            WHERE  IS_COMPANY = 0
            START WITH UNIT.ID= TOP_DEPARTMENT_ID
            CONNECT BY PRIOR UNIT.ID=UNIT.PARENT_ID ORDER BY ORDER_HIERARCHY_CODE ASC;
    END IF;

END P_POM_GET_DEPARTMENT_TREE;
/

prompt
prompt Creating procedure P_POM_GET_MY_WATCHLIST
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_GET_MY_WATCHLIST
(
    watcherID IN VARCHAR2,
    planType in VARCHAR2,
    completeStatus IN VARCHAR2,
    nodeLevel IN VARCHAR2,
    pageSize IN INT,
    pageIndex IN INT,
    items OUT SYS_REFCURSOR
)
    IS
    v_begin int;
    v_end   int;
BEGIN
    v_begin := pageSize * (pageIndex - 1) + 1;
    v_end := pageSize * pageIndex;



    open items for
        SELECT * FROM
            (
                SELECT ROWNUM AS rn,X.* FROM (
                                                 select * from (
                                                                   SELECT A.PLAN_TYPE       as "planType",
                                                                          B.ID                     AS "id",
                                                                          TO_CHAR(B.PLAN_END_DATE, 'YYYY-MM-DD')          AS "planEndDate",
                                                                          B.ORIGINAL_NODE_ID       AS "originalNodeId",
                                                                          B.NODE_NAME              AS "nodeName",
                                                                          TO_CHAR(D.CHARGE_PERSON) AS "chargePerson",
                                                                          TO_CHAR(E.MODIFIED, 'YYYY-MM-DD')     as "finalFeedBack",
                                                                          A.APPROVAL_STATUS        AS APPROVAL_STATUS,
                                                                          C.WATCHER_ID,
                                                                          case when
                                                                                           B.NODE_LEVEL = '里程碑' or
                                                                                           B.NODE_LEVEL = '一级节点' or
                                                                                           B.NODE_LEVEL = '二级节点' or
                                                                                           B.NODE_LEVEL = '三级节点' then
                                                                                   B.NODE_LEVEL
                                                                               else '其他' end as NODE_LEVEL,
                                                                          CASE
                                                                              WHEN B.ACTUAL_END_DATE IS NOT NULL THEN
                                                                                  '已完成'
                                                                              WHEN TO_DATE(TO_CHAR(SYSDATE, 'YYYY-MM-DD'), 'YYYY-MM-DD') -
                                                                                   TO_DATE(TO_CHAR(B.PLAN_END_DATE, 'YYYY-MM-DD'), 'YYYY-MM-DD') > 0 AND
                                                                                   B.ACTUAL_END_DATE IS NULL THEN
                                                                                  '已超期'
                                                                              ELSE
                                                                                  '未完成'
                                                                              END                  AS "completeStatus"
                                                                   FROM POM_PROJ_PLAN_NODE B
                                                                            LEFT JOIN POM_PROJ_PLAN A ON A.ID = B.PROJ_PLAN_ID
                                                                            LEFT JOIN SYS_BIZ_WATCH C
                                                                                      ON B.ORIGINAL_NODE_ID = C.BIZ_ID
                                                                            LEFT JOIN (SELECT M.NODE_ID, WM_CONCAT(M.CHARGE_PERSON) AS CHARGE_PERSON
                                                                                       FROM POM_NODE_CHARGE_PERSON M
                                                                                       GROUP BY M.NODE_ID) D
                                                                                      ON D.NODE_ID = B.ID
                                                                            LEFT JOIN (SELECT FEEDBACK_NODE_ID, MAX(MODIFIED) AS MODIFIED
                                                                                       FROM POM_NODE_FEEDBACK
                                                                                       GROUP BY FEEDBACK_NODE_ID) E
                                                                                      ON E.FEEDBACK_NODE_ID = B.ID
                                                                   where APPROVAL_STATUS = '已审核' and C.IS_UN_WATCH = 0 and C.WATCHER_ID = watcherID
                                                                   union
                                                                   SELECT '专项计划'                   AS "planType",
                                                                          B.ID                     AS "id",
                                                                          TO_CHAR(B.PLAN_END_DATE, 'YYYY-MM-DD')          AS "planEndDate",
                                                                          B.ORIGINAL_NODE_ID       AS "originalNodeId",
                                                                          B.NODE_NAME              AS "nodeName",
                                                                          TO_CHAR(D.CHARGE_PERSON) AS "chargePerson",
                                                                          TO_CHAR(E.MODIFIED, 'YYYY-MM-DD')     as "finalFeedBack",
                                                                          A.APPROVAL_STATUS        AS APPROVAL_STATUS,
                                                                          C.WATCHER_ID,
                                                                          '其他'                       AS NODE_LEVEL,
                                                                          CASE
                                                                              WHEN B.ACTUAL_END_DATE IS NOT NULL THEN
                                                                                  '已完成'
                                                                              WHEN TO_DATE(TO_CHAR(SYSDATE, 'YYYY-MM-DD'), 'YYYY-MM-DD') -
                                                                                   TO_DATE(TO_CHAR(B.PLAN_END_DATE, 'YYYY-MM-DD'), 'YYYY-MM-DD') > 0 AND
                                                                                   B.ACTUAL_END_DATE IS NULL THEN
                                                                                  '已超期'
                                                                              ELSE
                                                                                  '未完成'
                                                                              END                  AS "completeStatus"
                                                                   FROM POM_SPECIAL_PLAN_NODE B
                                                                            LEFT JOIN POM_SPECIAL_PLAN A ON B.PLAN_ID = A.ID
                                                                            LEFT JOIN SYS_BIZ_WATCH C
                                                                                      ON B.ORIGINAL_NODE_ID = C.BIZ_ID
                                                                            LEFT JOIN (SELECT M.NODE_ID, WM_CONCAT(M.CHARGE_PERSON) AS CHARGE_PERSON
                                                                                       FROM POM_NODE_CHARGE_PERSON M
                                                                                       GROUP BY M.NODE_ID) D
                                                                                      ON D.NODE_ID = B.ID
                                                                            LEFT JOIN (SELECT FEEDBACK_NODE_ID, MAX(MODIFIED) AS MODIFIED
                                                                                       FROM POM_NODE_FEEDBACK
                                                                                       GROUP BY FEEDBACK_NODE_ID) E
                                                                                      ON E.FEEDBACK_NODE_ID = B.ID
                                                                   where APPROVAL_STATUS = '已审核' and C.IS_UN_WATCH = 0 and C.WATCHER_ID = watcherID
                                                                   union
                                                                   SELECT '部门月度计划'                 AS "planType",
                                                                          B.ID                     AS "id",
                                                                          TO_CHAR(B.PLAN_END_DATE, 'YYYY-MM-DD')          AS "planEndDate",
                                                                          B.ORIGINAL_NODE_ID       AS "originalNodeId",
                                                                          B.NODE_NAME              AS "nodeName",
                                                                          TO_CHAR(D.CHARGE_PERSON) AS "chargePerson",
                                                                          TO_CHAR(E.MODIFIED, 'YYYY-MM-DD')     as "finalFeedBack",
                                                                          A.APPROVE_STATUS         AS APPROVAL_STATUS,
                                                                          C.WATCHER_ID,
                                                                          case when
                                                                                           B.SOUCE_NODE_LEVEL = '里程碑' or
                                                                                           B.SOUCE_NODE_LEVEL = '一级节点' or
                                                                                           B.SOUCE_NODE_LEVEL = '二级节点' or
                                                                                           B.SOUCE_NODE_LEVEL = '三级节点' then
                                                                                   B.SOUCE_NODE_LEVEL
                                                                               else '其他' end as NODE_LEVEL,
                                                                          CASE
                                                                              WHEN B.ACTUAL_END_DATE IS NOT NULL THEN
                                                                                  '已完成'
                                                                              WHEN TO_DATE(TO_CHAR(SYSDATE, 'YYYY-MM-DD'), 'YYYY-MM-DD') -
                                                                                   TO_DATE(TO_CHAR(B.PLAN_END_DATE, 'YYYY-MM-DD'), 'YYYY-MM-DD') > 0 AND
                                                                                   B.ACTUAL_END_DATE IS NULL THEN
                                                                                  '已超期'
                                                                              ELSE
                                                                                  '未完成'
                                                                              END                  AS "completeStatus"
                                                                   FROM POM_DEPT_MONTHLY_PLAN_NODE B
                                                                            LEFT JOIN POM_DEPT_MONTHLY_PLAN A ON A.ID = B.DEPT_MONTHLY_PLAN_ID
                                                                            LEFT JOIN SYS_BIZ_WATCH C
                                                                                      ON B.ORIGINAL_NODE_ID = C.BIZ_ID
                                                                            LEFT JOIN (SELECT M.NODE_ID, WM_CONCAT(M.CHARGE_PERSON) AS CHARGE_PERSON
                                                                                       FROM POM_NODE_CHARGE_PERSON M
                                                                                       GROUP BY M.NODE_ID) D
                                                                                      ON D.NODE_ID = B.ID
                                                                            LEFT JOIN (SELECT FEEDBACK_NODE_ID, MAX(MODIFIED) AS MODIFIED
                                                                                       FROM POM_NODE_FEEDBACK
                                                                                       GROUP BY FEEDBACK_NODE_ID) E
                                                                                      ON E.FEEDBACK_NODE_ID = B.ID
                                                                   where APPROVE_STATUS = '已审核' and C.IS_UN_WATCH = 0 and C.WATCHER_ID = watcherID
                                                               )total
                                                 WHERE 1=1
                                                   and total."planType" in ( select substr(planType,decode(level - 1, 0, 0, instr(planType, ',', 1, level - 1)) + 1,
                                                                                         (decode(level,
                                                                                                 regexp_count(planType, ',') + 1,
                                                                                                 length(planType) + 1,
                                                                                                 instr(planType, ',', 1, level))) -
                                                                                         (decode(level - 1, 0, 0, instr(planType, ',', 1, level - 1)) + 1)) from dual
                                                                           connect by level <= regexp_count(planType, ',') + 1 )
                                                   and total."completeStatus" in ( select substr(completeStatus,decode(level - 1, 0, 0, instr(completeStatus, ',', 1, level - 1)) + 1,
                                                                                               (decode(level,
                                                                                                       regexp_count(completeStatus, ',') + 1,
                                                                                                       length(completeStatus) + 1,
                                                                                                       instr(completeStatus, ',', 1, level))) -
                                                                                               (decode(level - 1, 0, 0, instr(completeStatus, ',', 1, level - 1)) + 1)) from dual
                                                                                 connect by level <= regexp_count(completeStatus, ',') + 1 )
                                                   and total.NODE_LEVEL in ( select substr(nodeLevel,decode(level - 1, 0, 0, instr(nodeLevel, ',', 1, level - 1)) + 1,
                                                                                           (decode(level,
                                                                                                   regexp_count(nodeLevel, ',') + 1,
                                                                                                   length(nodeLevel) + 1,
                                                                                                   instr(nodeLevel, ',', 1, level))) -
                                                                                           (decode(level - 1, 0, 0, instr(nodeLevel, ',', 1, level - 1)) + 1)) from dual
                                                                             connect by level <= regexp_count(nodeLevel, ',') + 1  )
                                                 ORDER BY "planEndDate" DESC
                                             )X
            )Y where Y.rn >= v_begin  AND Y.rn <= v_end;


END P_POM_GET_MY_WATCHLIST;
/

prompt
prompt Creating procedure P_POM_GET_PORTAL_COMPLETE_MSG
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_GET_PORTAL_COMPLETE_MSG" (
    bizid   IN      VARCHAR2,--业务id-即反馈id
    info    OUT     SYS_REFCURSOR--消息集合
) IS
--已办/已阅/取关消息获取，即（0：待办，10：待阅，20：关注）的已处理数据
--作者：陈丽
--日期：2020/01/09

    nodeid           VARCHAR2(36);
    nodeoriginalid   VARCHAR2(36);
    feedbackerid     VARCHAR2(36);
    ownercode        VARCHAR2(50);
BEGIN

--查询节点id 推送已办消息
  
  --要和传科沟通调整为原始id，不容易出错
    SELECT
        feedback_node_id,
        feedbacker_id,
        feedback_node_original_id
    INTO
        nodeid,
        feedbackerid,
        nodeoriginalid
    FROM
        pom_node_feedback
    WHERE
        id = bizid;

    dbms_output.put_line('打印' || nodeoriginalid);
    OPEN info FOR SELECT
                      '0' "msgType",--任务类型（0：待办，10：待阅，20：关注）
                      nodeid            AS "taskId",--任务ID
                      b1.user_account   AS "ownerName",--拥有人
                      'v-xufeng' AS "creatorName",--创建人
                      'http://pom.crccre.cn/pom/pom/middle?originalUrl='
                      || url_encode('http://pom.crccre.cn/pom/pom/mission-center-feedback/my-responsible-task?cancelType=0'
                                    || CHR(38)
                                    || 'id='
                                    || a.proj_plan_id
                                    || CHR(38)
                                    || 'feedbackNodeId='
                                    || a.id
                                    || CHR(38)
                                    || 'feedbackNodeOriginalId='
                                    || a.original_node_id
                                    || CHR(38)
                                    || 'nodeSourcePlanType=1') AS "pcUrl",--应用系统的url地址
                      'https://www.baidu.com' AS "mobileUrl",--应用系统的手机端url地址
                      SYSDATE           AS "created",--创建时间
                      SYSDATE           AS "expireTime",--创建时间
                      SYSDATE           AS "completeTime",--完成时间
                      trunc(SYSDATE) + 1 AS "expireTime",
                      '【节点超期预警】【'
                      || a.proj_name
                      || '-'
                      || a.plan_type
                      || '-'
                      || a.node_name
                      || '】超期'
                      || TO_CHAR(trunc(SYSDATE) - a.plan_end_date)
                      || '天预警' AS "taskName",--任务名称
                      '计划运营' AS "typeName",--任务类型
                      '1' AS "priority",--优先级
                      '测试计划运营推送已办到门户' AS "remark",--备注
                      'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "sourceAppId"--应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段
                  FROM
                      v_pom_node_dt                   a
                      LEFT JOIN sys_role_user_relation_result   b1 ON b1.dept_id = a.duty_department_id
                                                                    AND b1.virtual_group_name = '部门计划专员'
                  WHERE
                      original_node_id = ''
                                         || nodeoriginalid
                                         || '' ;

--    OPEN info FOR SELECT
--                     '0' "msgType",--任务类型（0：待办，10：待阅，20：关注）
--                     '32' AS "taskId",--任务ID
--                     'yuzheng1' AS "ownerName",--拥有人
--                     'v-xufeng' AS "creatorName",--创建人
--                     'https://www.baidu.com' AS "pcUrl",--应用系统的url地址
--                     'https://www.baidu.com' AS "mobileUrl",--应用系统的手机端url地址
--                     SYSDATE   AS "created",--创建时间
--                     SYSDATE   AS "expireTime",--创建时间
--                     SYSDATE   AS "completeTime",--完成时间
--                     trunc(SYSDATE) + 1 AS "expireTime",
--                     '计划运营-测试' AS "taskName",--任务名称
--                     '计划运营' AS "typeName",--任务类型
--                     '1' AS "priority",--优先级
--                     '测试计划运营推送已办到门户' AS "remark",--备注
--                     'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "sourceAppId"--应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段
--                 FROM
--                     dual;

END p_pom_get_portal_complete_msg;
/

prompt
prompt Creating procedure P_POM_GET_PROJECT_BYCOMPANY
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_get_project_bycompany (
    conmpanyid   IN           VARCHAR,
    items        OUT          SYS_REFCURSOR
) AS
BEGIN
    OPEN items FOR SELECT
                       project_name   AS "projName",
                       id             AS "projId"
                   FROM sys_project where unit_id in(
                           SELECT
                               id
                           FROM
                               sys_business_unit where is_company=1
                           START WITH
                               parent_id = conmpanyid
                           CONNECT BY
                               PRIOR id = parent_id) OR unit_id = conmpanyid;


END p_pom_get_project_bycompany;
/

prompt
prompt Creating procedure P_POM_GET_PROJ_TREE
prompt ======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_get_proj_tree (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    data_auth_info   OUT              SYS_REFCURSOR
) AS
--获取有权限的项目树
--作者：陈丽
--日期：2020/06/14
      data_auth_spid   VARCHAR2(200);
   
BEGIN

    p_sys_get_company_tree_spid(userid => userid, stationid => stationid, deptid => deptid, companyid => companyid, bizcode
    => bizcode, data_auth_spid => data_auth_spid);

    OPEN data_auth_info FOR SELECT
                             orgid      orgId,
                             orgname    AS orgName,
                             parentid   AS parentId,
                             orgtype    AS orgType
                         FROM
                             (
                                 SELECT DISTINCT
                                     org_id       AS orgid,
                                     org_name     AS orgname,
                                     order_code   AS ordercode,
                                     parent_id    AS parentid,
                                     org_type     AS orgtype
                                     
                                 FROM
                                     tmp_company_tree
                                 WHERE
                                     id = data_auth_spid
                                     AND org_id IN (
                                         SELECT DISTINCT
                                             id
                                         FROM
                                             sys_business_unit
                                         START WITH
                                             id IN (
                                                 SELECT
                                                     id
                                                 FROM
                                                     (
                                                         SELECT
                                                             unit_id AS id
                                                         FROM
                                                             sys_project
                                                         UNION
                                                         SELECT
                                                             subordinate_company_id AS id
                                                         FROM
                                                             cdb_feasible_project_config
                                                     ) ds
                                             )
                                         CONNECT BY
                                             PRIOR parent_id = id
                                     )
                                 UNION ALL
                                 SELECT
                                     id             AS projid,
                                     project_name   AS projname,
                                     project_code   AS ordercode,
                                     unit_id        AS parentid,
                                     '10' AS orgtype
                                 FROM
                                     sys_project
                             ) t
                         ORDER BY
                             ordercode;

    

END p_pom_get_proj_tree;
/

prompt
prompt Creating procedure P_POM_GET_PUSH_PORTAL_MSG
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_GET_PUSH_PORTAL_MSG(INFO OUT SYS_REFCURSOR --消息集合
																											) IS
		--待办/待阅/关注消息获取 废弃使用【p_pom_portal_msg】
		--作者：陈丽
		--日期：2020/01/09
BEGIN
		OPEN INFO FOR
		
		--超期任务提醒
				SELECT 0 AS "msgType", A.ORIGINAL_NODE_ID AS "taskId", B1.USER_ACCOUNT AS "ownerName", 'v-xufeng' AS "creatorName",
							 'http://pom.crccre.cn/pom/pom/middle?originalUrl=' ||
								URL_ENCODE('http://pom.crccre.cn/pom/pom/mission-center-feedback/my-responsible-task?cancelType=0' || CHR(38) || 'id=' || A.PROJ_PLAN_ID || CHR(38) || 'feedbackNodeId=' || A.ID ||
													 CHR(38) || 'feedbackNodeOriginalId=' || A.ORIGINAL_NODE_ID || CHR(38) || 'nodeSourcePlanType=1') AS "pcUrl", '' AS "mobileUrl", SYSDATE AS "created",
							 TRUNC(SYSDATE) + 1 AS "expireTime", '【节点超期预警】【' || A.PROJ_NAME || '-' || A.PLAN_TYPE || '-' || A.NODE_NAME || '】超期' || TO_CHAR(TRUNC(SYSDATE) - A.PLAN_END_DATE) || '天预警' AS "taskName",
							 '计划运营' AS "typeName",1 AS "priority", '' AS "remark"
, 'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "sourceAppId",meg.MESSAGE_MSG_TYPE AS "messageMsgType"
				FROM   V_POM_NODE_DT A
				LEFT   JOIN SYS_ROLE_USER_RELATION_RESULT B1
				ON     B1.DEPT_ID = A.DUTY_DEPARTMENT_ID AND
							 B1.VIRTUAL_GROUP_NAME = '部门计划专员'
				LEFT JOIN SYS_MESSAGE_CENTER meg
				ON meg.TASK_ID=A.id AND meg.CREATED-SYSDATE=0
				WHERE  A.FINISH_NO_STATUS_TYPE = '超期未完成' AND
							 NOT EXISTS (SELECT 1
								FROM   SYS_MESSAGE_CENTER_PUSH_RECORD P
								WHERE  P.RESPONSE_RESULTS LIKE '%{"errcode":0%' AND
											 TRUNC(SYSDATE) - TRUNC(P.REQUEST_TIME) = 0 AND
											 A.ID = P.TASK_ID AND
											 B1.USER_ACCOUNT = P.OWNER_NAME) AND
							 B1.USER_ACCOUNT IS NOT NULL AND b1.USER_ACCOUNT = 'zhangzhuohan';


/*		SELECT '0' "msgType",
            --任务类型（0：待办，10：待阅，20：关注）
           '32' AS "taskId",
            --任务ID
           'yuzheng1' AS "ownerName",
            --拥有人
           'v-xufeng' AS "creatorName",
            --创建人
           'http://pom.crccre.cn/pom/pom/middle?originalUrl='||url_encode('http://pom.crccre.cn/pom/pom/mission-center-feedback/my-responsible-task?cancelType=0&id=d209390c-3471-4b98-a719-219f6da5c609&feedbackNodeId=00c63db3-6bca-494f-b74a-e62e6b540f3a&feedbackNodeOriginalId=00c63db3-6bca-494f-b74a-e62e6b540f3a&nodeSourcePlanType=1') AS "pcUrl",
            --应用系统的url地址 不用改变这串字符（http://pom.crccre.cn/pom//pom/middle?originalUrl=），注意只能打开计划系统，如要打开其他系统需要开发  
           'https://www.baidu.com' AS "mobileUrl",
            --应用系统的手机端url地址
           SYSDATE AS "created",
            --创建时间
           SYSDATE AS "expireTime",
            --过期时间
           'huangw衡泽-测试-待办' || TO_CHAR(SYSDATE, 'yyyy-mm-ddhh24:mi:ss') AS "taskName",
            --任务名称
           '计划运营' AS "typeName",
            --任务类型
           '1' AS "priority",
            --优先级
           '测试计划运营推送待办到门户' AS "remark",
            --备注
           'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "sourceAppId" --应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段
    FROM   DUAL;*/

END P_POM_GET_PUSH_PORTAL_MSG;
/

prompt
prompt Creating procedure P_POM_JUDGE_FISSION_DATA
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_JUDGE_FISSION_DATA"
(
    projectId      IN NVARCHAR2  --项目or 分期id
   ,planNodeId  IN NVARCHAR2 ---节点id
   ,data OUT SYS_REFCURSOR --返回值
) AS
BEGIN
---OPEN data FOR select 1 id from dual where 1=2;
OPEN data FOR

SELECT id,BUILD_NAME  FROM MDM_BUILD a where (PROJ_ID=''||projectId||''  or PERIOD_ID= ''||projectId||'' )  and  id not in (
SELECT id FROM(
SELECT *  FROM (
SELECT id
--,BUILD_NAME,IS_GET_CON_PLAN_PERMIT ,GET_CON_PLAN_PERMIT_DATE
,'规划许可证'  as "PERMIT_TYPE" FROM MDM_BUILD  a 
where (PROJ_ID=''||projectId||''  or PERIOD_ID= ''||projectId||'' ) and nvl(IS_GET_CON_PLAN_PERMIT,0)=1
UNION ALL 
--是否取规划许可证
SELECT id
--,BUILD_NAME,IS_GET_CONSTRCUTION_PERMIT,GET_CONSTRCUTION_PERMIT_DATE
,'施工许可证' FROM MDM_BUILD  a where (PROJ_ID=''||projectId||''  or PERIOD_ID= ''||projectId||'' )
and nvl(IS_GET_CONSTRCUTION_PERMIT,0)=1
 UNION ALL 
--是否取规划许可证
SELECT id
--,BUILD_NAME,IS_GET_PRE_SALE_PERMIT,GET_PRE_SALE_PERMIT_DATE
,'预售许可证' FROM MDM_BUILD  a where (PROJ_ID=''||projectId||''  or PERIOD_ID= ''||projectId||'' )
and nvl(IS_GET_PRE_SALE_PERMIT,0)=1
UNION ALL 
--是否取规划许可证
SELECT id
--,BUILD_NAME,IS_GET_COMPLETED_PERMIT,GET_COMPLETED_PERMIT_DATE
,'竣工备案证' FROM MDM_BUILD  a where (PROJ_ID=''||projectId||''  or PERIOD_ID= ''||projectId||'' )
and nvl(IS_GET_COMPLETED_PERMIT,0)=1
) a1  where    PERMIT_TYPE=(
 SELECT PERMIT_TYPE  FROM POM_PROJ_PLAN_NODE  a   where a.id =''||planNodeId||'' )
 
 
UNION ALL 
 /*本次取证楼栋*/
SELECT c.BLD_ID,PERMIT_TYPE FROM POM_CURRENT_EVIDENCE_INFO a INNER JOIN  MDM_PERMIT b  on a.PERMIT_ID=b.id
INNER JOIN MDM_PERMIT_BLD c on c.PERMIT_ID=b.id
INNER JOIN MDM_BUILD d on d.id=bld_id
WHERE b.APPROVAL_STATUS<>'未审核'
 and (PROJ_ID=''||projectId||''  or PERIOD_ID= ''||projectId||'' )
 
 
AND PERMIT_TYPE=(
 SELECT PERMIT_TYPE  FROM POM_PROJ_PLAN_NODE  a   where a.id =''||planNodeId||'' )
 
 ) a2 ) ;

end;
/

prompt
prompt Creating procedure P_POM_JUDGE_FISSION_RESULT
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_JUDGE_FISSION_RESULT
(
    projectId      IN NVARCHAR2  --项目or 分期id
   ,permitType  IN NVARCHAR2 --证照类型
   ,planNodeId  IN NVARCHAR2 ---节点id
   ,result OUT INT --返回值
) AS
BEGIN
   DECLARE  
    v_count INT :=0;
    BEGIN
    select count(*) INTO result
from mdm_permit_bld mb
inner join (select *
   from mdm_permit mp
   inner join(select *
       from POM_NODE_FEEDBACK nf
       inner join (select id, fission_source_original_id
           from pom_proj_plan_node a
           start with a.id = ''||planNodeId||''
           CONNECT BY PRIOR a.fission_source_original_id = a.id
       ) n on nf.FEEDBACK_NODE_ID = n.id and n.id is not null
   ) f on mp.id = f.PERMIT_ID and mp.approval_status='已审核'
) m on mb.permit_id = m.id and mb.id is not null
right join (
        SELECT A.id 
        FROM   MDM_BUILD A
        INNER  JOIN MDM_BUILD_PHASE B
        ON     A.ID = B.BUILD_ID
        INNER  JOIN MDM_OBJ_PHASE_INDEX C
        ON     C.OBJ_PHASE_ID = B.ID
        INNER  JOIN (SELECT B1.PRODUCT_TYPE_CODE, A1.*
                     FROM   MDM_OBJ_PHASE_PT_INDEX A1
                     INNER  JOIN MDM_BUILD_PRODUCT_TYPE B1
                     ON     A1.PRODUCT_TYPE_ID = B1.ID) D
        ON     D.OBJ_PHASE_ID = B.ID
        LEFT   JOIN (SELECT B3.BUILD_ID, B3.ID AS OBJ_PHASE_ID, A3.BUILD_AREA,
                            A3.GROUND_TOTAL_BUILD_AREA,
                            A3.UNDERGROUND_TOTAL_BUILD_AREA
                     FROM   MDM_OBJ_PHASE_PT_INDEX A3
                     INNER  JOIN MDM_BUILD_PHASE B3
                     ON     A3.OBJ_PHASE_ID = B3.ID AND
                            B3.PHASE_NAME = '竣工备案证阶段') F
        ON     F.BUILD_ID = A.ID AND
               F.OBJ_PHASE_ID = B.ID
        WHERE  EXISTS (SELECT 1
                FROM   (SELECT ROW_NUMBER() OVER(PARTITION BY A.ID ORDER BY C.PHASE_ORDER DESC) AS PRANK,
                                A.ID BUILDID, C.PHASE_ORDER PHASEORDER,
                                C.PHASE_NAME PHASENAME, C.ID PHASEID
                         FROM   MDM_BUILD A
                         INNER  JOIN MDM_BUILD_PHASE B
                         ON     A.ID = B.BUILD_ID
                         INNER  JOIN MDM_PHASE C
                         ON     B.PHASE_ID = C.ID) P
                WHERE  P.PRANK = 1 AND
                       P.PHASEID = B.PHASE_ID AND
                       P.BUILDID = A.ID) AND A.BUILD_STATE = 10
                      AND   A.PERIOD_ID =''||projectId||''  OR A.PROJ_ID=''||projectId||''
        ORDER  BY BUILD_NAME
) t on mb.bld_id = t.id
where mb.bld_id is null;
    END;
end;
--==========================项目主项计划监控解析计划专员===================
/

prompt
prompt Creating procedure P_POM_JUDGE_NODE_ISSINGLE
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_JUDGE_NODE_ISSINGLE(
    NODELIST IN VARCHAR2,
    judgeType IN VARCHAR2 ,   --0为执行反馈，1为查看任务
    errmsg OUT VARCHAR2, --提示消息
    errcode OUT INT --0成功，1失败
)
AS
BEGIN

    IF length(NODELIST) < 36 THEN
        IF judgeType = '0' THEN
            errcode := 1;
            errmsg := '请选择要执行反馈的任务项';
        ELSIF judgeType = '1' THEN
            errcode := 1;
            errmsg := '请选择要查看的任务项';
        END IF;
    ELSIF length(NODELIST) > 36 THEN
        IF judgeType = '0' THEN
            errcode := 1;
            errmsg := '只可选择单个任务执行反馈';
        ELSIF judgeType = '1' THEN
            errcode := 1;
            errmsg := '只可选择单个任务查看';
        END IF;
    ELSE
        errcode := 0;
    END IF;

END P_POM_JUDGE_NODE_ISSINGLE;
/

prompt
prompt Creating procedure P_POM_KEYNODE_TASK_LIST
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_KEYNODE_TASK_LIST (
     tabType VARCHAR2,
     planType VARCHAR2,
     businessId VARCHAR2,
     currentcompanyid   IN                 VARCHAR2,--当前用户的公司
     userid             IN                 VARCHAR2,--用户id用于过滤关注的任务
     currentstationid   IN                 VARCHAR2,---当前用户的岗位
     currentdeptid      IN                 VARCHAR2,---当前用户的部门
     bizcode            IN                 VARCHAR2,---权限code
     pageRows INTEGER,
     pageIndex INTEGER,
     taskList  OUT SYS_REFCURSOR
) IS 
--项目主项计划监控项目完成率前排行榜详情列表
--作者：谢松宏
--修改：叶丁荣//数据权限过滤
--日期：2020/03/20
v_condition varchar2(4000);
v_sql clob;
v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN 
v_condition:= ' AND 1=1';
IF(tabType is not null) THEN
    IF(tabType='超期任务')
        then  v_condition:=' and  to_char(node.plan_end_date, ''yyyy-MM-dd'') <  to_char(sysdate, ''yyyy-MM-dd'') and node.actual_end_date is null order by node.plan_end_date desc'; 
    ELSIF(tabType='今日完成')
        then  v_condition:=' and  to_char(node.plan_end_date, ''yyyy-MM-dd'') = to_char(sysdate, ''yyyy-MM-dd'') and node.actual_end_date is not null  order by node.actual_end_date desc'; 
    ELSIF(tabType='今日待办')
        then  v_condition:=' and  to_char(node.plan_end_date, ''yyyy-MM-dd'') = to_char(sysdate, ''yyyy-MM-dd'') and node.actual_end_date is null order by node.plan_end_date desc'; 
    END IF;
END IF;

--调用数据权限验证存储过程
    p_sys_auth_data_rule_spid(userid => userid, stationid => currentstationid, deptid => currentdeptid, companyid => currentcompanyid
    , bizcode => bizcode, data_auth_spid => v_spid);

v_sql:='SELECT *
  FROM (SELECT tt.*, ROWNUM AS rowno
    FROM (  
        select 
        node.id as "nodeId", 
        node.original_node_id as "nodeOriginalId",
        node.node_name as "nodeName",
        plan.plan_type as "nodePlanType",
        case 
            when '''||tabType||'''=''超期任务'' then to_char(node.plan_end_date, ''yyyy-MM-dd'')
            when '''||tabType||'''=''今日完成'' then to_char(node.actual_end_date, ''yyyy-MM-dd'')
            when '''||tabType||'''=''今日待办'' then to_char(node.plan_end_date, ''yyyy-MM-dd'')
        end  as "nodeTime",
        case 
            when (to_char(node.plan_end_date, ''yyyy-MM-dd'') < to_char(sysdate, ''yyyy-MM-dd'') and node.actual_end_date is null) then ''已超期''
            when (to_char(node.plan_end_date, ''yyyy-MM-dd'') = to_char(sysdate, ''yyyy-MM-dd'') and node.actual_end_date is not null) then ''已完成''
            when (to_char(node.plan_end_date, ''yyyy-MM-dd'') = to_char(sysdate, ''yyyy-MM-dd'') and node.actual_end_date is null) then ''未完成''
        end as "nodeStatus"
        from pom_proj_plan_node node 
        left join pom_proj_plan plan on node.proj_plan_id = plan.id 
        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
        on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
        where tal.orgid is not null AND node.is_disable = 0 and plan_type='''||planType||''' and plan.proj_id = '''||businessId||''' and plan.approval_status = ''已审核'''||v_condition||') tt
    WHERE ROWNUM <= '||pageRows||' * '||pageIndex||') table_alias
 WHERE table_alias.rowno >= '||pageRows||' * ('||pageIndex||'-1) + 1';
 dbms_output.put_line(v_sql);
open taskList for v_sql;
END P_POM_KEYNODE_TASK_LIST;
/

prompt
prompt Creating procedure P_POM_KEY_NODE_ALREADY_DELAY
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_KEY_NODE_ALREADY_DELAY" (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    orgid          IN             VARCHAR2,--组织id(）
    title          OUT            VARCHAR2,
    info           OUT            SYS_REFCURSOR--需要程序组装树,并汇总子级数据
) AS
--关键节点计划监控-当前一出现延误项目
--作者：陈丽
--日期：2019/11/13
BEGIN
    OPEN info FOR SELECT
                      '西南公司' AS "orgName",--组织名
                      '1' AS "orgId",---组织id
                      '' AS "parentId",--父级id
                      '100' AS "projDelay",--已延误项目数量
                      '1' AS "periodDelay",--已延误分期数量
                      '1' AS "nodeDelay",--已延误节点数量
                      '1' AS "startWorkDelay",--开工节点延误数量
                      '10' AS "openPlateDelay",--开盘节点延误数量
                      '' AS "openUrl"--打开地址，无数据不打开
                  FROM
                      dual
                  UNION ALL
                  SELECT
                      '华南公司' AS "orgName",--组织名
                      '2' AS "orgId",---组织id
                      '' AS "parentId",--父级id
                      '100' AS "projDelay",--已延误项目数量
                      '1' AS "periodDelay",--已延误分期数量
                      '1' AS "nodeDelay",--已延误节点数量
                      '1' AS "startWorkDelay",--开工节点延误数量
                      '10' AS "openPlateDelay",--开盘节点延误数量
                      '' AS "openUrl"--打开地址
                  FROM
                      dual
                  UNION ALL
                  SELECT
                      '华东公司' AS "orgName",--组织名
                      '3' AS "orgId",---组织id
                      '' AS "parentId",--父级id
                      '100' AS "projDelay",--已延误项目数量
                      '1' AS "periodDelay",--已延误分期数量
                      '1' AS "nodeDelay",--已延误节点数量
                      '1' AS "startWorkDelay",--开工节点延误数量
                      '10' AS "openPlateDelay",--开盘节点延误数量
                      '' AS "openUrl"--打开地址
                  FROM
                      dual
                  UNION ALL
                  SELECT
                      '北方公司' AS "orgName",--组织名
                      '4' AS "orgId",---组织id
                      '' AS "parentId",--父级id
                      '100' AS "projDelay",--已延误项目数量
                      '1' AS "periodDelay",--已延误分期数量
                      '1' AS "nodeDelay",--已延误节点数量
                      '1' AS "startWorkDelay",--开工节点延误数量
                      '10' AS "openPlateDelay",--开盘节点延误数量
                      '' AS "openUrl"--打开地址
                  FROM
                      dual
                  UNION ALL
                  SELECT
                      '事业部1' AS "orgName",--组织名
                      '5' AS "orgId",---组织id
                      '1' AS "parentId",--父级id
                      '100' AS "projDelay",--已延误项目数量
                      '1' AS "periodDelay",--已延误分期数量
                      '1' AS "nodeDelay",--已延误节点数量
                      '1' AS "startWorkDelay",--开工节点延误数量
                      '10' AS "openPlateDelay",--开盘节点延误数量
                      '' AS "openUrl"--打开地址
                  FROM
                      dual
                  UNION ALL
                  SELECT
                      '事业部1' AS "orgName",--组织名
                      '6' AS "orgId",---组织id
                      '5' AS "parentId",--父级id
                      '100' AS "projDelay",--已延误项目数量
                      '1' AS "periodDelay",--已延误分期数量
                      '1' AS "nodeDelay",--已延误节点数量
                      '1' AS "startWorkDelay",--开工节点延误数量
                      '10' AS "openPlateDelay",--开盘节点延误数量
                      '' AS "openUrl"--打开地址
                  FROM
                      dual;

END p_pom_key_node_already_delay;
/

prompt
prompt Creating procedure P_POM_KEY_NODE_COMPLETION_RATE
prompt =================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_KEY_NODE_COMPLETION_RATE
(
		ORGID          IN VARCHAR2 
	 ,DATASCOPE      IN VARCHAR2
	 ,PLANTYPE       IN VARCHAR2
	 ,SEARCHKEY      IN VARCHAR2

	 ,COMPLETIONRATE OUT SYS_REFCURSOR
) AS
		--关键节点计划监控-关键节点完成率查询
		--作者：陈丽
		--日期：2019/11/13
		--查询2级单位SELECT * from  SYS_BUSINESS_UNIT A WHERE  A.COMPANY_TYPE='5' AND  PARENT_ID='003200000000000000000000000000'
    

	
BEGIN


		IF DATASCOPE = 'thisMonth' THEN
				OPEN COMPLETIONRATE FOR
				--月份
						SELECT 
						   CASE WHEN A.LEVEL_RANK=1 THEN '集团'  WHEN A.LEVEL_RANK=2 THEN '二级'  WHEN A.LEVEL_RANK=3 THEN '三级'  WHEN A.LEVEL_RANK=4 THEN '项目'  ELSE '项目'   END  AS "rightLable",--角标
										ISDELAY AS "delayedTotal",--已延误
										TO_CHAR(ISFINISHTOTAL)||'/'||	TO_CHAR(NODESUM) AS "completionRateDescription",
										ISFINISHTOTAL AS "completedTotal",--已完成
										NODESUM AS "shouldComplete",--应完成
									 CASE 
									 WHEN A.CTYPE = 'TYPE_PROJLAST'
									 THEN 	'/smart/dialog/page?height=75%25&width=1220&title=本月已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=1&planType=XXX'  
									 WHEN CTYPE='TYPE_ORG' 
									 THEN '/smart/dialog/page?height=75%25&width=1220&title=本月已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=1&planType=XXX'  
								ELSE	 '/smart/dialog/page?height=75%25&width=1220&title=本月已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=1&planType=XXX'  
									END  AS "delayedTotalUrl",--已延误 跳转地址为空前端不做跳转，只需要调整项目id
  	 CASE WHEN A.CTYPE = 'TYPE_PROJLAST'
		 THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本月已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=2&planType=XXX'  
		 WHEN CTYPE='TYPE_ORG' THEN   '/smart/dialog/page?height=75%25&width=1220&title=本月已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=2&planType=XXX'  
		ELSE'/smart/dialog/page?height=75%25&width=1220&title=本月已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=2&planType=XXX'  
	END  AS "completedTotalUrl",--已完成 跳转地址为空前端不做跳转
            	 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' 
											THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本月应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=3&planType=XXX'  						 WHEN CTYPE='TYPE_ORG'
											THEN '/smart/dialog/page?height=75%25&width=1220&title=本月应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=3&planType=XXX'  
				ELSE '/smart/dialog/page?height=75%25&width=1220&title=本月应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=3&planType=XXX'  
				END   AS "shouldCompleteUrl",--应完成 跳转地址为空前端不做跳转
									 --右上角显示排序
									 NVL(A.ID, ORGID) AS "orgId",
									 --ID
									 A.ORG_NAME AS "orgName",
									 --显示名称
									 A.FINLISHRATE AS "completionRate",
									 --完成率
									 A.DELAYFINISHTOTAL AS "delayCompleteTotal",
									 --延迟完成
									 A.ADVANCEFINISHTOTAL AS "advanceCompleteTotal",
									 --提前完成
									 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN
									  '/pom/plan-assess/node-monitoring/plan-nodes?companyid='||COMPANY_ID||'&ppid='||a.ID||'&planType=关键节点计划'
									ELSE
									 '' || ORGID || ''
							END  AS "clickOperationTypeContent",
									 --穿透ID
									 '#00e18f' AS "completionRateColor",
									 --颜色
									 CASE
												WHEN  A.CTYPE = 'TYPE_PROJLAST' THEN
												 '2'
												ELSE
												 '1'
										END AS "clickOperationType",
									 --穿透类型
									 0 AS "isRoot", '' || ORGID || '' AS "parentId"
									 --父级ID
									 , 'ThisMoth' AS "dataScope" --范围
						--A表项目计划主表计划类别通过TYPE判断
						FROM   V_POM_PJMOTHPLAN_STATISTICS A
						WHERE  PARENT_ID = '' || ORGID || '' AND
									 NODESUM > 0 /*AND a.ORG_NAME NOT LIKE '%无分期%'*/
						--AND  dataScope='thisMonth'
-- 						AND  a.ORG_NAME  ='西南公司'
						UNION ALL
						SELECT  CASE WHEN A.LEVEL_RANK=1 THEN '集团'  WHEN A.LEVEL_RANK=2 THEN '二级'  WHEN A.LEVEL_RANK=3 THEN '三级'  WHEN A.LEVEL_RANK=4 THEN '项目'  ELSE '项目'   END AS "rightLable", 
                                          ISDELAY AS "delayedTotal",--已延误
																		TO_CHAR(ISFINISHTOTAL)||'/'||	TO_CHAR(NODESUM) AS "completionRateDescription",
                                    ISFINISHTOTAL AS "completedTotal",--已完成
                                    NODESUM AS "shouldComplete",--应完成
                                   CASE 
																			WHEN A.CTYPE = 'TYPE_PROJLAST'
																				THEN 	'/smart/dialog/page?height=75%25&width=1220&title=本月已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=1&planType=XXX'  
																			WHEN CTYPE='TYPE_ORG'
																				THEN '/smart/dialog/page?height=75%25&width=1220&title=本月已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=1&planType=XXX' 
		ELSE	'/smart/dialog/page?height=75%25&width=1220&title=本月已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=1&planType=XXX'   END  AS "delayedTotalUrl",--已延误 跳转地址为空前端不做跳转，只需要调整项目id
																	CASE WHEN A.CTYPE = 'TYPE_PROJLAST'
																			THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本月已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=2&planType=XXX' 
																			WHEN CTYPE='TYPE_ORG' 
																				THEN  '/smart/dialog/page?height=75%25&width=1220&title=本月已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=2&planType=XXX' 
																			ELSE '/smart/dialog/page?height=75%25&width=1220&title=本月已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=2&planType=XXX' 
		END  AS "completedTotalUrl",--已完成 跳转地址为空前端不做跳转
            	 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本月应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=3&planType=XXX' 
							 WHEN CTYPE='TYPE_ORG' THEN  '/smart/dialog/page?height=75%25&width=1220&title=本月应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=3&planType=XXX' 
						ELSE 	 '/smart/dialog/page?height=75%25&width=1220&title=本月应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisMonth&pageType=3&planType=XXX' 
							END   AS "shouldCompleteUrl",--应完成 跳转地址为空前端不做跳转
                                        NVL(A.ID, ORGID) AS "orgId",
									 A.ORG_NAME AS "orgName",
									 A.FINLISHRATE AS "completionRate",
									 A.DELAYFINISHTOTAL AS "delayCompleteTotal",
									 A.ADVANCEFINISHTOTAL AS "advanceCompleteTotal",
									 -------------------chenl集团点击时还是加载集团下的数据
									 CASE
												WHEN ID = '003200000000000000000000000000' THEN
												'003200000000000000000000000000'
												ELSE
												  A.PARENT_ID
										END AS "clickOperationTypeContent",
                                    -------------------chenl集团点击时还是加载集团下的数据
									 '#00e18f' AS "completionRateColor",
									 '1' AS "clickOperationType", 1 AS "isRoot",
									 CASE
												WHEN ID = '003200000000000000000000000000' THEN
												 NULL
												ELSE
												 PARENT_ID
										END AS "parentId", 'ThisMoth' AS "dataScope"
						FROM   V_POM_PJMOTHPLAN_STATISTICS A
						WHERE  ID = '' || ORGID || '' AND
									 NODESUM > 0
								ORDER BY 11  desc 	
									/*AND a.ORG_NAME NOT LIKE '%无分期%'*/; --AND  dataScope='thisMonth';

		ELSIF DATASCOPE = 'thisQuarter' THEN
				OPEN COMPLETIONRATE FOR
				--季度
						SELECT --TO_CHAR(RANK)
					CASE WHEN A.LEVEL_RANK=1 THEN '集团'  WHEN A.LEVEL_RANK=2 THEN '二级'  WHEN A.LEVEL_RANK=3 THEN '三级'  WHEN A.LEVEL_RANK=4 THEN '项目'  ELSE '项目'   END  	AS "rightLable",
						 --右上角显示排序
                          ISDELAY AS "delayedTotal",--已延误
													TO_CHAR(ISFINISHTOTAL)||'/'||	TO_CHAR(NODESUM) AS "completionRateDescription",
                                    ISFINISHTOTAL AS "completedTotal",--已完成
                                    NODESUM AS "shouldComplete",--应完成
									 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	'/smart/dialog/page?height=75%25&width=1220&title=本季度已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=1&planType=XXX'   WHEN CTYPE='TYPE_ORG' THEN '/smart/dialog/page?height=75%25&width=1220&title=本季度已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=1&planType=XXX' 
	ELSE	'/smart/dialog/page?height=75%25&width=1220&title=本季度已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=1&planType=XXX' 
									END  AS "delayedTotalUrl",--已延误 跳转地址为空前端不做跳转，只需要调整项目id
  	 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本季度已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=2&planType=XXX'  WHEN CTYPE='TYPE_ORG' THEN   '/smart/dialog/page?height=75%25&width=1220&title=本季度已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=2&planType=XXX' 
else	 	'/smart/dialog/page?height=75%25&width=1220&title=本季度已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=2&planType=XXX' 
	
	END  AS "completedTotalUrl",--已完成 跳转地址为空前端不做跳转
            	 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本季度应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=3&planType=XXX'   WHEN CTYPE='TYPE_ORG' THEN '/smart/dialog/page?height=75%25&width=1220&title=本季度应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=3&planType=XXX'
		else		'/smart/dialog/page?height=75%25&width=1220&title=本季度应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=3&planType=XXX'
					END   AS "shouldCompleteUrl",--应完成 跳转地址为空前端不做跳转
									 --右上角显示排序
						 NVL(A.ID, ORGID) AS "orgId",
						 --ID
						 A.ORG_NAME AS "orgName",
						 --显示名称
						 A.FINLISHRATE AS "completionRate",
						 --完成率
						 A.DELAYFINISHTOTAL AS "delayCompleteTotal",
						 --延迟完成
						 A.ADVANCEFINISHTOTAL AS "advanceCompleteTotal",
						 --提前完成
						 CASE WHEN ID = '003200000000000000000000000000' OR A.CTYPE = 'TYPE_PROJLAST' THEN
									 '/pom/plan-assess/node-monitoring/plan-nodes?companyid='||COMPANY_ID||'&ppid='||a.ID||'&planType=关键节点计划'
									ELSE
									 '' || ORGID || ''
							END  AS "clickOperationTypeContent",
						 --穿透ID
						 '#00e18f' AS "completionRateColor",
						 --颜色
						 CASE
									WHEN ID = '003200000000000000000000000000' OR A.CTYPE = 'TYPE_PROJLAST' THEN
									 '2'
									ELSE
									 '1'
							END AS "clickOperationType",
						 --穿透类型
						 0 AS "isRoot", '' || ORGID || '' AS "parentId"
						 --父级ID
						 , 'ThisQuarter' AS "dataScope" --范围
						--A表项目计划主表计划类别通过TYPE判断
						
						FROM   V_POM_PJQUARTERPLAN_STATISTICS A
						WHERE  PARENT_ID = '' || ORGID || '' AND
									 NODESUM > 0 /*AND a.ORG_NAME NOT LIKE '%无分期%'*/ --AND  dataScope='thisQuarter'
						
						UNION ALL
						SELECT  CASE WHEN A.LEVEL_RANK=1 THEN '集团'  WHEN A.LEVEL_RANK=2 THEN '二级'  WHEN A.LEVEL_RANK=3 THEN '三级'  WHEN A.LEVEL_RANK=4 THEN '项目'  ELSE '项目'   END   AS "rightLable",
                                         ISDELAY AS "delayedTotal",--已延误
																				 	TO_CHAR(ISFINISHTOTAL)||'/'||	TO_CHAR(NODESUM) AS "completionRateDescription",
                                    ISFINISHTOTAL AS "completedTotal",--已完成
								NODESUM AS "shouldComplete",--应完成
								CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	'/smart/dialog/page?height=75%25&width=1220&title=本季度已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=1&planType=XXX' WHEN CTYPE='TYPE_ORG' THEN  '/smart/dialog/page?height=75%25&width=1220&title=本季度已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=1&planType=XXX' 
						ELSE 	'/smart/dialog/page?height=75%25&width=1220&title=本季度已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=1&planType=XXX' 
							END  AS "delayedTotalUrl",--已延误 跳转地址为空前端不做跳转，只需要调整项目id
  	 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本季度已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=2&planType=XXX'  WHEN CTYPE='TYPE_ORG' THEN  '/smart/dialog/page?height=75%25&width=1220&title=本季度已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=2&planType=XXX'  ELSE  '/smart/dialog/page?height=75%25&width=1220&title=本季度已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=2&planType=XXX'  END  AS "completedTotalUrl",--已完成 跳转地址为空前端不做跳转
            	 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本季度应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=3&planType=XXX' WHEN CTYPE='TYPE_ORG' THEN  '/smart/dialog/page?height=75%25&width=1220&title=本季度应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=3&planType=XXX'  ELSE '/smart/dialog/page?height=75%25&width=1220&title=本季度应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisQuarter&pageType=3&planType=XXX'  END   AS "shouldCompleteUrl",--应完成 跳转地址为空前端不做跳转
                                    NVL(A.ID, ORGID) AS "orgId",
									 A.ORG_NAME AS "orgName",
									 A.FINLISHRATE AS "completionRate",
									 A.DELAYFINISHTOTAL AS "delayCompleteTotal",
									 A.ADVANCEFINISHTOTAL AS "advanceCompleteTotal",
									 -------------------chenl集团点击时还是加载集团下的数据
									 CASE
												WHEN ID = '003200000000000000000000000000' THEN
												'003200000000000000000000000000'
												ELSE
												  A.PARENT_ID
										END AS "clickOperationTypeContent",
                                    -------------------chenl集团点击时还是加载集团下的数据
									 '#00e18f' AS "completionRateColor",
									 CASE
												WHEN ID = '003200000000000000000000000000' OR A.CTYPE = 'TYPE_PROJLAST' THEN
												 '2'
												ELSE
												 '1'
										END AS "clickOperationType", 1 AS "isRoot",
									 CASE
												WHEN ID = '003200000000000000000000000000' THEN
												 NULL
												ELSE
												 PARENT_ID
										END AS "parentId", 'ThisQuarter' AS "dataScope"
						FROM   V_POM_PJQUARTERPLAN_STATISTICS A
						WHERE  ID = '' || ORGID || '' AND
									 NODESUM > 0 
									 ORDER BY 11 desc 	
									 /*AND a.ORG_NAME NOT LIKE '%无分期%'*/; --AND  dataScope='thisQuarter';
		ELSIF DATASCOPE = 'thisYear' THEN
				OPEN COMPLETIONRATE FOR
				--年度
						SELECT
						CASE WHEN A.LEVEL_RANK=1 THEN '集团'  WHEN A.LEVEL_RANK=2 THEN '二级'  WHEN A.LEVEL_RANK=3 THEN '三级'  WHEN A.LEVEL_RANK=4 THEN '项目'  ELSE '项目'   END   AS "rightLable",
						 --右上角显示排序
                          ISDELAY AS "delayedTotal",--已延误
														TO_CHAR(ISFINISHTOTAL)||'/'||	TO_CHAR(NODESUM) AS "completionRateDescription",
                                    ISFINISHTOTAL AS "completedTotal",--已完成
                                    NODESUM AS "shouldComplete",--应完成
									 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	'/smart/dialog/page?height=75%25&width=1220&title=本年已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=1&planType=XXX'  WHEN CTYPE='TYPE_ORG' THEN '/smart/dialog/page?height=75%25&width=1220&title=本年已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=1&planType=XXX'
								ELSE 	 '/smart/dialog/page?height=75%25&width=1220&title=本年已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=1&planType=XXX'
									END  AS "delayedTotalUrl",--已延误 跳转地址为空前端不做跳转，只需要调整项目id
  	 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本年已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=2&planType=XXX'  WHEN CTYPE='TYPE_ORG' THEN   '/smart/dialog/page?height=75%25&width=1220&title=本年已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=2&planType=XXX'   ELSE '/smart/dialog/page?height=75%25&width=1220&title=本年已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=2&planType=XXX'   END  AS "completedTotalUrl",--已完成 跳转地址为空前端不做跳转
            	 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本年应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=3&planType=XXX'  WHEN CTYPE='TYPE_ORG' THEN '/smart/dialog/page?height=75%25&width=1220&title=本年应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=3&planType=XXX' ELSE '/smart/dialog/page?height=75%25&width=1220&title=本年应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=3&planType=XXX' END   AS "shouldCompleteUrl",--应完成 跳转地址为空前端不做跳转
									 --右上角显示排序
						 NVL(A.ID, ORGID) AS "orgId",
						 --ID
						 A.ORG_NAME AS "orgName",
						 --显示名称
						 A.FINLISHRATE AS "completionRate",
						 --完成率
						 A.DELAYFINISHTOTAL AS "delayCompleteTotal",
						 --延迟完成
						 A.ADVANCEFINISHTOTAL AS "advanceCompleteTotal",
						 --提前完成
						 CASE WHEN ID = '003200000000000000000000000000' OR A.CTYPE = 'TYPE_PROJLAST' THEN
									 '/pom/plan-assess/node-monitoring/plan-nodes?companyid='||COMPANY_ID||'&ppid='||a.ID||'&planType=关键节点计划'
									ELSE
									 '' || ORGID || ''
							END  AS "clickOperationTypeContent",
						 --穿透ID
						 '#00e18f' AS "completionRateColor",
						 --颜色
						 CASE
									WHEN ID = '003200000000000000000000000000' OR A.CTYPE = 'TYPE_PROJLAST' THEN
									 '2'
									ELSE
									 '1'
							END AS "clickOperationType",
						 --穿透类型
						 0 AS "isRoot", '' || ORGID || '' AS "parentId"
						 --父级ID
						 , 'ThisYear' AS "dataScope" --范围
						--A表项目计划主表计划类别通过TYPE判断
						
						FROM   V_POM_PJYEARPLAN_STATISTICS A
						WHERE  PARENT_ID = '' || ORGID || '' AND
									 NODESUM > 0 /*AND a.ORG_NAME NOT LIKE '%无分期%'*/ --AND  dataScope='thisYear'
						
						UNION ALL
						SELECT CASE WHEN A.LEVEL_RANK=1 THEN '集团'  WHEN A.LEVEL_RANK=2 THEN '二级'  WHEN A.LEVEL_RANK=3 THEN '三级'  WHEN A.LEVEL_RANK=4 THEN '项目'  ELSE '项目'   END   AS "rightLable", 
                                         ISDELAY AS "delayedTotal",--已延误
																				 	TO_CHAR(ISFINISHTOTAL)||'/'||	TO_CHAR(NODESUM) AS "completionRateDescription",
                                    ISFINISHTOTAL AS "completedTotal",--已完成
                                    NODESUM AS "shouldComplete",--应完成
							 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	'/smart/dialog/page?height=75%25&width=1220&title=本年已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=1&planType=XXX'  WHEN CTYPE='TYPE_ORG' THEN  '/smart/dialog/page?height=75%25&width=1220&title=本年已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=1&planType=XXX'  ELSE'/smart/dialog/page?height=75%25&width=1220&title=本年已延误任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=1&planType=XXX' END  AS "delayedTotalUrl",--已延误 跳转地址为空前端不做跳转，只需要调整项目id
  	 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本年已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=2&planType=XXX'  WHEN CTYPE='TYPE_ORG' THEN  '/smart/dialog/page?height=75%25&width=1220&title=本年已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=2&planType=XXX' ELSE '/smart/dialog/page?height=75%25&width=1220&title=本年已完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=2&planType=XXX'   END  AS "completedTotalUrl",--已完成 跳转地址为空前端不做跳转
            	 CASE WHEN A.CTYPE = 'TYPE_PROJLAST' THEN 	         '/smart/dialog/page?height=75%25&width=1220&title=本年应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=3&planType=XXX'  WHEN CTYPE='TYPE_ORG' THEN  '/smart/dialog/page?height=75%25&width=1220&title=本年应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=3&planType=XXX' else '/smart/dialog/page?height=75%25&width=1220&title=本年应完成任务明细&functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||A.ID||'&companyId='||a.ID||'&dataScope=thisYear&pageType=3&planType=XXX'END   AS "shouldCompleteUrl",--应完成 跳转地址为空前端不做跳转
                                        NVL(A.ID, ORGID) AS "orgId",
									 A.ORG_NAME AS "orgName",
									 A.FINLISHRATE AS "completionRate",
									 A.DELAYFINISHTOTAL AS "delayCompleteTotal",
									 A.ADVANCEFINISHTOTAL AS "advanceCompleteTotal",
                                     -------------------chenl集团点击时还是加载集团下的数据
									 CASE
												WHEN ID = '003200000000000000000000000000' THEN
												'003200000000000000000000000000'
												ELSE
												  A.PARENT_ID
										END AS "clickOperationTypeContent",
                                    -------------------chenl集团点击时还是加载集团下的数据
									 '#00e18f' AS "completionRateColor",
									 CASE
												WHEN ID = '003200000000000000000000000000' OR A.CTYPE = 'TYPE_PROJLAST' THEN
												 '2'
												ELSE
												 '1'
										END AS "clickOperationType", 1 AS "isRoot",
									 CASE
												WHEN ID = '003200000000000000000000000000' THEN
												 NULL
												ELSE
												 PARENT_ID
										END AS "parentId", 'ThisYear' AS "dataScope"
						FROM   V_POM_PJYEARPLAN_STATISTICS A
						WHERE  ID = '' || ORGID || '' AND
									 NODESUM > 0 
									 ORDER BY 11 desc 	
									 /*AND a.ORG_NAME NOT LIKE '%无分期%'*/;
		END IF;
		
		
		
		
		
END P_POM_KEY_NODE_COMPLETION_RATE;
/

prompt
prompt Creating procedure P_POM_KEY_NODE_CONDITIONS
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_KEY_NODE_CONDITIONS" (planType in VARCHAR2
,searchText out VARCHAR2
,promptInfo out VARCHAR2
,description  out VARCHAR2
,dateScope OUT sys_refcursor)
AS  
--关键节点计划监控-关键节点计划条件
--作者：陈丽
--日期：2019/11/13
BEGIN
open dateScope for
select 'thisMonth' as "id",'本月' as "name" from dual
union all
select 'thisQuarter' as "id",'本季' as "name" from dual
union all
select 'thisYear' as "id",'本年' as "name" from dual;
description:= '项目计划按时完成率排名榜';
searchText:='';
promptInfo:='请输入公司名称';
END p_pom_key_node_conditions;
/

prompt
prompt Creating procedure P_POM_KEY_NODE_CONDITIONS1
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_KEY_NODE_CONDITIONS1" (planType in VARCHAR2
,searchText out VARCHAR2
,promptInfo out VARCHAR2
,description  out VARCHAR2
,dateScope OUT sys_refcursor)
AS  
--关键节点计划监控-关键节点计划条件
--作者：陈丽
--日期：2019/11/13
BEGIN
open dateScope for
select 'thisMonth' as "id",'本月' as "name" from dual
union all
select 'thisQuarter' as "id",'本季' as "name" from dual
union all
select 'thisYear' as "id",'本年' as "name" from dual;
description:= '项目计划按时完成率排名榜';
searchText:='';
promptInfo:='请输入公司名称';
END p_pom_key_node_conditions1;
/

prompt
prompt Creating procedure P_POM_KEY_NODE_DELAY_PROJ
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_KEY_NODE_DELAY_PROJ"
(
		USERID       IN VARCHAR2
	 , --当前用户id
		STATIONID    IN VARCHAR2
	 , --当前用户岗位id
		DEPARTMENTID IN VARCHAR2
	 , --当前用户部门id
		COMPANYID    IN VARCHAR2
	 , --当前用户公司id
		ORGID        IN VARCHAR2
	 , --组织id(）
		TITLE        OUT VARCHAR2
	 ,INFO         OUT SYS_REFCURSOR --需要程序组装树,并汇总子级数据
) AS
		--关键节点计划监控-当前已出现延误项目
		--作者：陈丽
		--日期：2019/11/13
BEGIN
		OPEN INFO FOR
		WITH TMP_PRO_NODE(ORG_ID,COMPANY_ID,ORGCODE,ORGNAME,PARENTID,ORDER_HIERARCHY_CODE,not_finish_node,NO_FINISH_KG_NODE,NO_FINISH_KP_NODE,orgtype,period_delay,project_delay) 
		AS (
	 
			SELECT a.id AS org_id
 		,b.COMPANY_ID as COMPANY_ID
		,LPAD(A.SN,4,'0') AS ORGCODE
			,a.STAGE_NAME AS orgname,a.PROJECT_ID AS parentid,NULL AS ORDER_HIERARCHY_CODE
			,SUM(CASE WHEN (TRUNC(SYSDATE) >= c.PLAN_END_DATE AND c.ACTUAL_END_DATE IS NULL)  or (ACTUAL_END_TIME- c.PLAN_END_DATE>5)  THEN 1 ELSE 0 END) AS not_finish_node
			,SUM(CASE WHEN TRUNC(SYSDATE) >= c.PLAN_END_DATE AND c.ACTUAL_END_DATE IS NULL AND C.NODE_NAME = '首开楼栋基础开工' THEN 1 ELSE 0 END) AS NO_FINISH_KG_NODE
			,SUM(CASE WHEN TRUNC(SYSDATE) >= c.PLAN_END_DATE AND c.ACTUAL_END_DATE IS NULL AND C.NODE_NAME = '首开楼栋达到预售条件' THEN 1 ELSE 0 END) AS NO_FINISH_KP_NODE
			,'2' AS orgtype
			,CASE WHEN SUM(CASE WHEN (TRUNC(SYSDATE) >= c.PLAN_END_DATE AND c.ACTUAL_END_DATE IS NULL)  or (ACTUAL_END_TIME- c.PLAN_END_DATE>5)  THEN 1 ELSE 0 END) <> 0 THEN 1 ELSE 0 END AS period_delay,0 AS project_delay
				FROM SYS_PROJECT_STAGE a
				INNER JOIN POM_PROJ_PLAN b ON a.ID = b.PROJ_ID AND b.APPROVAL_STATUS = '已审核' AND b.PLAN_TYPE = '关键节点计划'
				INNER JOIN POM_PROJ_PLAN_NODE c ON b.id = c.PROJ_PLAN_ID
				LEFT JOIN  POM_NODE_FEEDBACK d on  d.FEEDBACK_NODE_ID=c.id and  d.APPROVAL_STATUS='已审核' and   FEEDBACK_TYPE='CARRY_OUT'
				
				
				
				
				
				where  c.IS_DISABLE=0  and ACTUAL_END_DATE is null--20200326lxc调整 
				GROUP BY a.id,a.STAGE_NAME,a.PROJECT_ID,b.COMPANY_ID,A.SN
			UNION ALL
			SELECT A2.ORG_ID,A2.COMPANY_ID,A2.ORGCODE  ,A2.ORGNAME,A2.PARENT_ID,A2.ORDER_HIERARCHY_CODE,A1.not_finish_node,A1.NO_FINISH_KG_NODE,A1.NO_FINISH_KP_NODE,a2.orgtype,a1.period_delay,CASE WHEN/* a1.orgtype<>'2' AND*/ a1.period_delay <> 0 THEN 1 ELSE 0 END  AS project_delay
				FROM TMP_PRO_NODE A1
				INNER JOIN (
	SELECT DISTINCT a.id AS ORG_ID
 				,a.UNIT_ID as COMPANY_ID
				,LPAD(A.SN,4,'0') AS ORGCODE
				,A.PROJECT_NAME AS ORGNAME,A.UNIT_ID AS PARENT_ID,A.ORDER_HIERARCHY_CODE
				,CASE WHEN  listagg(STAGE_NAME,',')  WITHIN GROUP (ORDER BY a.id ) like '无分期' THEN '3' ELSE '1' END   AS orgtype
				FROM SYS_PROJECT A
 				left JOIN SYS_PROJECT_STAGE b on a.id=b.PROJECT_ID 
			GROUP BY a.id  
 				,a.UNIT_ID  
				,A.PROJECT_NAME ,A.UNIT_ID  ,A.ORDER_HIERARCHY_CODE,A.SN
		 
				UNION ALL 
				SELECT A.ID,A.ID,a.ORDER_HIERARCHY_CODE AS ORGCODE,A.ORG_NAME,A.PARENT_ID,A.ORDER_HIERARCHY_CODE,'0' AS orgtype
				FROM SYS_BUSINESS_UNIT A
				WHERE A.IS_COMPANY = 1 
				
				) A2 ON A1.PARENTID = A2.ORG_ID
			 
		)
SELECT *
FROM (		
		SELECT  P.ORGNAME AS "orgName",ORDER_HIERARCHY_CODE,p.org_id AS "orgId",p.parentid AS "parentId",SUM(p.project_delay) AS "projDelay",SUM(p.period_delay) AS "periodDelay",SUM(p.not_finish_node) AS "nodeDelay",SUM(p.NO_FINISH_KG_NODE) AS "startWorkDelay",SUM(p.NO_FINISH_KP_NODE) AS "openPlateDelay"
		,CASE WHEN p.orgtype = '1' 
		THEN '/smart/dialog/page?functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&projId='||p.ORG_ID||'&companyId='||p.COMPANY_ID||'&title=节点延误明细&dataScope=thisProjAll&planType=XXX&pageType=1'
		

		WHEN p.orgtype='0' 
			THEN '/smart/dialog/page?functionGuid=9ad32c0a-0961-7107-e053-8606160aa4bd&companyId='||p.COMPANY_ID||'&title=节点延误明细&dataScope=thisCompanyAll&planType=XXX&pageType=1'
else  		'/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||NVL(p.COMPANY_ID,'003200000000000000000000000002')||'&ppid='||
	p.ORG_ID ||'&planType=关键节点计划' 
	
	END "openUrl"
		FROM TMP_PRO_NODE P
		WHERE p.orgname <> '无分期'
		GROUP BY p.orgname,p.parentid,p.orgtype,p.org_id,p.COMPANY_ID,ORDER_HIERARCHY_CODE
		HAVING SUM(p.not_finish_node) > 0
		) aa
		START WITH aa."orgId"=ORGID
		CONNECT BY PRIOR aa."orgId"=aa."parentId"
ORDER BY ORDER_HIERARCHY_CODE
				;
				

END P_POM_KEY_NODE_DELAY_PROJ;
/

prompt
prompt Creating procedure P_POM_KEY_NODE_ORBITAL_WACTH
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_KEY_NODE_ORBITAL_WACTH"
(
		PROJECTID       IN VARCHAR2
	 ,PROJECTPERIODID IN VARCHAR2
	 ,PLANTYPE        IN VARCHAR2_LIST
	 ,DESCRIPTION     OUT VARCHAR2
	 ,STATES          OUT SYS_REFCURSOR
	 ,ORBITALNODE     OUT SYS_REFCURSOR
) AS
		--关键节点计划监控-轨道图
		--作者：陈丽
		--日期：2019/11/13

		V_SQL CLOB := ''; --拼接SQL字符串
		/*    V_CON    NUMBER(2, 0);*/
		V_PROJECTID VARCHAR2(36);
		V_FLAG      VARCHAR2(10);
		V_PERIODID  VARCHAR2(36);

BEGIN
		OPEN STATES FOR
				SELECT '按时完成' AS "stateDescription", '#60955a' AS "stateColor", 'punctualityComplete' AS "state"
				FROM   DUAL
				UNION ALL
				SELECT '超期5天内完成' AS "stateDescription", '#ff9933' AS "stateColor", 'beyondComplete' AS "state"
				FROM   DUAL
				UNION ALL
				SELECT '超期5天' AS "stateDescription", '#f00' AS "stateColor", 'beyonduncomplete' AS "state"
				FROM   DUAL
				UNION ALL
				SELECT '未开始' AS "stateDescription", '#ccc' AS "stateColor", 'uncomplete' AS "state"
				FROM   DUAL;

		/*  OPEN ORBITALNODE FOR
    SELECT CASE
             WHEN PLAN_END_DATE < SYSDATE THEN
              'punctualityComplete'
             WHEN PLAN_END_DATE > SYSDATE THEN
              'beyondComplete'
             ELSE
              'uncomplete'
           END AS "nodeState", NODE_NAME AS "nodeName",
           NODE_CODE AS "nodeContent",
           PLAN_END_DATE || '<br/>' || PLAN_END_DATE AS "nodeTime",
           '计划完成日期' || PLAN_END_DATE || '<br/>实际完成日期' || ACTUAL_END_DATE ||
            '<br/>相差天数0' AS "nodeDescription",
           '/basic-settings/standard-node/standard-node?action=Create' "nodeUrl"
    FROM   POM_PROJ_PLAN_NODE;*/

		/*
        遍历PLANTYPE数组
    */
		SELECT P.FLAG INTO V_FLAG FROM (SELECT '项目' AS FLAG FROM SYS_PROJECT_STAGE A WHERE A.PROJECT_ID = PROJECTPERIODID UNION ALL SELECT DISTINCT '分期' FROM SYS_PROJECT_STAGE B WHERE B.ID = PROJECTPERIODID) P;

		IF V_FLAG = '项目' THEN
				SELECT Q.ID
				INTO   V_PERIODID
				FROM   MDM_PROJECT P
				INNER  JOIN MDM_PERIOD_VERSION O
				ON     O.PROJECT_ORIGINAL_ID = P.PROJECT_ORIGINAL_ID AND
							 O.APPROVAL_STATUS = '已审核' AND
							 O.PERIOD_VERSION = (SELECT MAX(PERIOD_VERSION)
																	 FROM   MDM_PERIOD_VERSION
																	 WHERE  PROJECT_ORIGINAL_ID = O.PROJECT_ORIGINAL_ID AND
																					APPROVAL_STATUS = '已审核'
																	 GROUP  BY PROJECT_ORIGINAL_ID)
				INNER  JOIN MDM_PERIOD Q
				ON     O.ID = Q.PERIOD_VERSION_ID
				WHERE  P.PROJECT_ORIGINAL_ID = PROJECTPERIODID AND p.APPROVAL_STATUS = '已审核';

		ELSIF V_FLAG = '分期' THEN
				V_PERIODID := PROJECTPERIODID;
		END IF;

		IF V_FLAG = '项目' THEN

				V_PROJECTID := PROJECTPERIODID;

		ELSIF V_FLAG = '分期' THEN
				SELECT B.PROJECT_ORIGINAL_ID
				INTO   V_PROJECTID
				FROM   MDM_PERIOD A
				INNER  JOIN MDM_PERIOD_VERSION B
				ON     A.PERIOD_VERSION_ID = B.ID AND
							 B.PERIOD_VERSION = (SELECT MAX(PERIOD_VERSION)
																	 FROM   MDM_PERIOD_VERSION
																	 WHERE  PROJECT_ORIGINAL_ID = B.PROJECT_ORIGINAL_ID AND
																					APPROVAL_STATUS = '已审核'
																	 GROUP  BY PROJECT_ORIGINAL_ID)
				WHERE  A.ID = PROJECTPERIODID AND
							 B.APPROVAL_STATUS = '已审核';
		END IF;

		FOR I IN 1 .. PLANTYPE.COUNT
		LOOP
				IF PLANTYPE(I) = '可研计划' THEN
						V_SQL := V_SQL || '
SELECT CASE
					 WHEN B.ACTUAL_END_DATE IS NOT NULL THEN
						(CASE
								WHEN B.ACTUAL_END_DATE - B.PLAN_END_DATE > 5 THEN
								 ''beyonduncomplete''
								 WHEN  B.ACTUAL_END_DATE - B.PLAN_END_DATE <= 5 and B.ACTUAL_END_DATE - B.PLAN_END_DATE > 0 THEN
								 ''beyondComplete''
								ELSE
								 ''punctualityComplete''
						END)
					 WHEN B.ACTUAL_END_DATE IS NULL THEN
						(CASE
								WHEN SYSDATE - B.PLAN_END_DATE > 5 THEN
								 ''beyonduncomplete''
								ELSE
								 ''uncomplete''
						END)
			 END AS "nodeState", B.NODE_NAME AS "nodeName",
			 B.NODE_CODE AS "nodeContent",
			 ''<div style="
    color: #696969;
">计划完成日期''||''    ''||TO_CHAR(B.PLAN_END_DATE,''YYYY-MM-DD'') || ''<br/>'' ||''实际完成日期''||''    ''||TO_CHAR(NVL(B.ACTUAL_END_DATE, ''''),''YYYY-MM-DD'')|| ''<br/>'' || NVL(''审核完成日期''||''    ''||TO_CHAR(nvl(C.APPROVAL_TIME,B.ACTUAL_END_DATE),''YYYY-MM-DD''), '''')||''</div>'' AS "nodeTime",
			 ''计划完成日期'' ||TO_CHAR( NVL(B.PLAN_END_DATE, SYSDATE),''YYYY-MM-DD'') || ''<br/>实际完成日期'' ||
				NVL(B.ACTUAL_END_DATE, '''') || ''<br/>相差天数'' ||
				NVL(TO_DATE(B.PLAN_END_DATE) - TO_DATE(B.ACTUAL_END_DATE), '''') AS "nodeDescription",
			 ''/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0''||CHR(38)||''id='' || A.ID ||
				CHR(38) || ''feedbackNodeid=''||B.ID||CHR(38)||''feedbackNodeOriginalId=''||B.ORIGINAL_NODE_ID||CHR(38)||''nodeSourcePlanType=0''  AS "nodeUrl", B.ID AS "nodeId",
			 B.ORIGINAL_NODE_ID AS "originalNodeId"
				FROM   POM_PROJ_PLAN A, POM_PROJ_PLAN_NODE B
				WHERE  A.ID = B.PROJ_PLAN_ID AND B.FISSION_SOURCE_ORIGINAL_ID IS NULL AND  
							 A.PROJ_ID = ''' || PROJECTID || '''AND a.APPROVAL_STATUS = ''已审核'' and 
							 A.PLAN_TYPE = ''' || PLANTYPE(I) || ''' UNION ALL ';
				ELSE
						V_SQL := V_SQL || 'SELECT CASE
					 WHEN B.ACTUAL_END_DATE IS NOT NULL THEN
						(CASE
								WHEN B.ACTUAL_END_DATE - B.PLAN_END_DATE > 5 THEN
								 ''beyonduncomplete''
								 WHEN  B.ACTUAL_END_DATE - B.PLAN_END_DATE <= 5 and B.ACTUAL_END_DATE - B.PLAN_END_DATE > 0 THEN
								 ''beyondComplete''
								ELSE
								 ''punctualityComplete''
						END)
					 WHEN B.ACTUAL_END_DATE IS NULL THEN
						(CASE
								WHEN SYSDATE - B.PLAN_END_DATE > 5 THEN
								 ''beyonduncomplete''
								 WHEN SYSDATE - B.PLAN_END_DATE <= 5 and SYSDATE - B.PLAN_END_DATE >0  THEN
								 ''beyondComplete''
								ELSE
								 ''uncomplete''
						END)
			 END AS "nodeState", B.NODE_NAME AS "nodeName",
			 B.NODE_CODE AS "nodeContent",
			 ''<div style="
    color: #696969;
">计划完成日期''||''    ''||TO_CHAR(B.PLAN_END_DATE,''YYYY-MM-DD'') || ''<br/>'' || NVL(''实际完成日期''||''    ''||TO_CHAR(B.ACTUAL_END_DATE,''YYYY-MM-DD''), '''')|| ''<br/>'' || NVL(''审核完成日期''||''    ''||TO_CHAR(nvl(C.APPROVAL_TIME,B.ACTUAL_END_DATE),''YYYY-MM-DD''), '''')||''</div>'' AS "nodeTime",
			 ''计划完成日期'' || to_char(NVL(B.PLAN_END_DATE, SYSDATE),''yyyy-mm-dd'') || ''<br/>实际完成日期'' ||
				to_char(NVL(B.ACTUAL_END_DATE, ''''),''yyyy-mm-dd'') || ''<br/>相差天数'' ||
				NVL(TO_DATE(B.PLAN_END_DATE) - TO_DATE(B.ACTUAL_END_DATE), '''') AS "nodeDescription",
			 ''/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0''||CHR(38)||''id='' || A.ID ||
				CHR(38) || ''feedbackNodeId=''||B.ID||CHR(38)||''feedbackNodeOriginalId=''||B.ORIGINAL_NODE_ID||CHR(38)||''nodeSourcePlanType=0'' AS "nodeUrl", B.ID AS "nodeId",
			 B.ORIGINAL_NODE_ID AS "originalNodeId"
				FROM   POM_PROJ_PLAN A
				INNER JOIN POM_PROJ_PLAN_NODE B ON A.ID = B.PROJ_PLAN_ID 
				LEFT JOIN POM_NODE_FEEDBACK c ON b.ID = c.FEEDBACK_NODE_ID AND c.FEEDBACK_TYPE = ''CARRY_OUT'' AND c.APPROVAL_STATUS = ''已审核''
        WHERE  b.is_disable = 0 and a.APPROVAL_STATUS = ''已审核'' and 
							 A.PROJ_ID = ''' || V_PERIODID || '''AND B.FISSION_SOURCE_ORIGINAL_ID IS NULL AND
							 A.PLAN_TYPE = ''' || PLANTYPE(I) || ''' UNION ALL ';
				END IF;
		END LOOP;

		V_SQL := RTRIM(V_SQL, 'UNION ALL') || ' ORDER BY 3';

		DBMS_OUTPUT.PUT_LINE(V_SQL);

		OPEN ORBITALNODE FOR V_SQL;

		DESCRIPTION := '';
END P_POM_KEY_NODE_ORBITAL_WACTH;
/

prompt
prompt Creating procedure P_POM_MONTH_QUARTER_YEAR
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_MONTH_QUARTER_YEAR" (
    now_date     in      DATE := SYSDATE,
    o_m_begin         OUT               DATE,
    o_m_end           OUT               DATE,
    o_quarter_begin   OUT               DATE,
    o_quarter_end     OUT               DATE,
    o_year_begin      OUT               DATE,
    o_year_end        OUT               DATE
) AS
		----计划考核日--计算当前时间，本年，本季度，本月考核的开始时间和结束时间
		--作者：陈丽
		--日期：2020-06-14
BEGIN
  SELECT
--    yyyy,
--    mm,
--    q,
    m_begin,
    m_end,
    quarter_begin,
    quarter_end,
    year_begin,
    year_end
    into 
    o_m_begin,
    o_m_end,
    o_quarter_begin,
    o_quarter_end,
    o_year_begin,
    o_year_end
    
FROM
    v_pom_month_quarter_years
    where lpad(mm, 2,'0')=to_char(now_date, 'MM') and lpad(yyyy, 4,'0')=to_char(now_date, 'yyyy');

END P_POM_MONTH_QUARTER_YEAR;
/

prompt
prompt Creating procedure P_POM_KEY_NODE_SCHEDULE
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_KEY_NODE_SCHEDULE
(COMPANYGUID IN VARCHAR2,USERID VARCHAR2,STATIONID VARCHAR2,DEPTID VARCHAR2,COMPANYID VARCHAR2,YEARS NUMBER,MONTHS NUMBER,ITEMS OUT SYS_REFCURSOR) 
IS V_SQL CLOB; V_ID VARCHAR2 (100); BIZCODE VARCHAR2 (200) :='POM.JHJKYKHPH.01'; DATA_AUTH_SPID VARCHAR2 (200); datebase DATE; NOW_DATE DATE; O_M_BEGIN DATE; O_M_END DATE; O_QUARTER_BEGIN DATE; O_QUARTER_END DATE; O_YEAR_BEGIN DATE; O_YEAR_END DATE; BEGIN IF COMPANYGUID IS NULL THEN V_ID :='003200000000000000000000000000'; ELSE V_ID :=COMPANYGUID; END IF; datebase :=TO_DATE('' || YEARS || '-' || MONTHS || '-01','YYYY-MM-DD');-----chenl 20200730 获取指定时间年月日
BEGIN NOW_DATE :=datebase; P_POM_MONTH_QUARTER_YEAR (NOW_DATE=> NOW_DATE,O_M_BEGIN=> O_M_BEGIN,O_M_END=> O_M_END,O_QUARTER_BEGIN=> O_QUARTER_BEGIN,O_QUARTER_END=> O_QUARTER_END,O_YEAR_BEGIN=> O_YEAR_BEGIN,O_YEAR_END=> O_YEAR_END); END; 
BEGIN P_SYS_GET_COMPANY_PROJ_SPID (USERID=> USERID,STATIONID=> STATIONID,DEPTID=> DEPTID,COMPANYID=> COMPANYID,BIZCODE=> BIZCODE,DATA_AUTH_SPID=> DATA_AUTH_SPID); END;-- 轨道图地址
--/pom/plan-assess/node-monitoring/plan-nodes?companyid=''|| sp.unit_id ||''&ppid=''|| sp.id ||''&planType=关键节点计划''
OPEN ITEMS FOR WITH 分期 AS (
SELECT CASE WHEN 总分期数量 =0 THEN GET_UUID ELSE PS.ID END AS ID,PS.STAGE_NAME,PS.PROJECT_ID,PROJ.PROJECT_NAME,UNIT_ID,TO_CHAR(PS.SN,'0.0') AS SN,CASE WHEN 无分期数量 =1 AND 总分期数量 =1 THEN 1 ELSE 0 END 是无分期 FROM SYS_PROJECT_STAGE PS LEFT JOIN SYS_PROJECT PROJ ON PS.PROJECT_ID=PROJ.ID LEFT JOIN (
SELECT PROJECT_ID,SUM(CASE WHEN STAGE_NAME='无分期' THEN 1 ELSE 0 END) AS 无分期数量,COUNT(PROJECT_ID) AS 总分期数量 FROM SYS_PROJECT_STAGE GROUP BY PROJECT_ID) PCOUNT ON PROJ.ID=PCOUNT.PROJECT_ID),/*
         basedata
        */
BASEDATA AS (---查询已审核的分期 关键节点计划 基础信息
SELECT PLAN.PROJ_ID,COUNT(NODE.ID) AS 有效节点数-- 所有未删除，未禁用的节点
,SUM(CASE WHEN NODE.PLAN_END_DATE<=TRUNC(SYSDATE) THEN NODE.STANDARD_SCORE ELSE 0 END) AS 应得总分,SUM(NVL(NODEE.NEW_EXAMINATION_SCORE,0)) AS 实际得分,--              SUM(CASE WHEN TRUNC(NODE.PLAN_END_DATE ,'MM') = TRUNC(SYSDATE,'MM') THEN NODE.STANDARD_SCORE ELSE 0 END) AS 应得总分本月,

SUM(CASE WHEN NODE.PLAN_END_DATE> O_M_BEGIN AND NODE.PLAN_END_DATE< O_M_END THEN NODE.STANDARD_SCORE ELSE 0 END) AS 应得总分本月,SUM(CASE WHEN NODE.PLAN_END_DATE> O_M_BEGIN AND NODE.PLAN_END_DATE< O_M_END THEN 1 ELSE 0 END) AS 应完成数量本月,SUM(CASE WHEN NODEE.COMPLETE_FEEDBACK_APPROVE_TIME> O_M_BEGIN AND NODEE.COMPLETE_FEEDBACK_APPROVE_TIME< O_M_END THEN NODEE.NEW_EXAMINATION_SCORE ELSE 0 END) AS 实际得分本月,SUM(CASE WHEN NODEE.COMPLETE_FEEDBACK_APPROVE_TIME> O_M_BEGIN AND NODEE.COMPLETE_FEEDBACK_APPROVE_TIME< O_M_END THEN 1 ELSE 0 END) AS 已完成数量本月,SUM(CASE WHEN NODE.PLAN_END_DATE> O_QUARTER_BEGIN AND NODE.PLAN_END_DATE< O_QUARTER_END THEN NODE.STANDARD_SCORE ELSE 0 END) AS 应得总分本季度,SUM(CASE WHEN NODE.PLAN_END_DATE> O_QUARTER_BEGIN AND NODE.PLAN_END_DATE< O_QUARTER_END THEN 1 ELSE 0 END) AS 应完成数量本季度,SUM(CASE WHEN NODEE.NEW_EXAMINATION_SCORE IS NOT NULL AND NODEE.COMPLETE_FEEDBACK_APPROVE_TIME> O_QUARTER_BEGIN AND NODEE.COMPLETE_FEEDBACK_APPROVE_TIME< O_QUARTER_END THEN NODEE.NEW_EXAMINATION_SCORE ELSE 0 END) AS 实际得分本季度,SUM(CASE WHEN NODEE.NEW_EXAMINATION_SCORE IS NOT NULL AND NODEE.COMPLETE_FEEDBACK_APPROVE_TIME> O_QUARTER_BEGIN AND NODEE.COMPLETE_FEEDBACK_APPROVE_TIME< O_QUARTER_END THEN 1 ELSE 0 END) AS 已完成数量本季度,SUM(CASE WHEN NODE.PLAN_END_DATE> O_YEAR_BEGIN AND NODE.PLAN_END_DATE< O_YEAR_END THEN NODE.STANDARD_SCORE ELSE 0 END) AS 应得总分本年度,SUM(CASE WHEN NODE.PLAN_END_DATE> O_YEAR_BEGIN AND NODE.PLAN_END_DATE< O_YEAR_END THEN 1 ELSE 0 END) AS 应完成数量本年度,SUM(CASE WHEN NODEE.NEW_EXAMINATION_SCORE IS NOT NULL AND NODEE.COMPLETE_FEEDBACK_APPROVE_TIME> O_YEAR_BEGIN AND NODEE.COMPLETE_FEEDBACK_APPROVE_TIME< O_YEAR_END THEN NODEE.NEW_EXAMINATION_SCORE ELSE 0 END) AS 实际得分本年度,SUM(CASE WHEN NODEE.NEW_EXAMINATION_SCORE IS NOT NULL AND NODEE.COMPLETE_FEEDBACK_APPROVE_TIME> O_YEAR_BEGIN AND NODEE.COMPLETE_FEEDBACK_APPROVE_TIME< O_YEAR_END THEN 1 ELSE 0 END) AS 已完成数量本年度,--    case
--绿灯：到期当天内完成反馈；红灯：①到期超过5天未反馈②超期反馈
SUM(CASE--未到期不亮灯
WHEN NODE.ACTUAL_END_DATE IS NULL AND TRUNC(SYSDATE)-TRUNC(NODE.PLAN_END_DATE)<=0 THEN 0--到期当天内完成反馈
WHEN NODE.ACTUAL_END_DATE IS NOT NULL AND (TRUNC(NODE.ACTUAL_END_DATE)-TRUNC(NODE.PLAN_END_DATE))<=0 THEN 1 ELSE 0 END) AS 绿灯--1-5天内反馈 黄灯：①到期1-5天内完成反馈、②到期15天内未反馈；
,SUM(CASE--未到期不亮灯
WHEN NODE.ACTUAL_END_DATE IS NOT NULL AND (TRUNC(NODE.ACTUAL_END_DATE)-TRUNC(NODE.PLAN_END_DATE)) BETWEEN 1 AND 5 THEN 1--到期未反馈黄灯
WHEN NODE.ACTUAL_END_DATE IS NULL AND (TRUNC(SYSDATE)-TRUNC(NODE.PLAN_END_DATE)) BETWEEN 1 AND 5 THEN 1 ELSE 0 END) AS 黄灯-- 超期五天反馈，或超期五天未反馈
,SUM(CASE--未到期不亮灯
WHEN (NODE.ACTUAL_END_DATE IS NULL AND (TRUNC(SYSDATE)-TRUNC(NODE.PLAN_END_DATE))> 5) OR ((TRUNC(NODE.ACTUAL_END_DATE)-TRUNC(NODE.PLAN_END_DATE))> 5) THEN 1 ELSE 0 END) AS 红灯,SUM(CASE WHEN NODE.NODE_LEVEL='里程碑' AND NODE.PLAN_END_DATE<=TRUNC(SYSDATE) THEN 1 ELSE 0 END) AS 里程碑应完成-- 里程碑节点、计划完成时间<=当天年月日 如 2020-05-25
,SUM(CASE WHEN NODE.NODE_LEVEL='里程碑' AND NODE.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END) AS 里程碑已完成-- 里程碑节点、实际完成时间不为空
,SUM(CASE WHEN NODE.NODE_LEVEL='里程碑' AND NODE.PLAN_END_DATE<=TRUNC(SYSDATE) AND NODE.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END) AS 里程碑未完成-- 里程碑节点 and 计划完成时间<=当天年月日 and 实际完成时间为空
,SUM(CASE WHEN NODE.NODE_LEVEL='一级节点' AND NODE.PLAN_END_DATE<=TRUNC(SYSDATE) THEN 1 ELSE 0 END) AS 一级应完成,SUM(CASE WHEN NODE.NODE_LEVEL='一级节点' AND NODE.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END) AS 一级已完成,SUM(CASE WHEN NODE.NODE_LEVEL='一级节点' AND NODE.PLAN_END_DATE<=TRUNC(SYSDATE) AND NODE.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END) AS 一级未完成 FROM POM_PROJ_PLAN_NODE NODE LEFT JOIN POM_PROJ_PLAN PLAN ON NODE.PROJ_PLAN_ID=PLAN.ID LEFT JOIN POM_NODE_EXAMINATION NODEE ON NODE.ORIGINAL_NODE_ID=NODEE.ORIGINAL_NODE_ID--- 未考虑一个节点重复考核情况
---已审核、关键节点计划、未禁用节点
WHERE PLAN.APPROVAL_STATUS='已审核' AND PLAN.PLAN_TYPE='关键节点计划' AND NODE.ID IS NOT NULL AND NODE.IS_DISABLE=0 AND NODE.IS_DELETE=0 GROUP BY PLAN.PROJ_ID),/*
             项目_分期
       */
项目分期 AS (
SELECT 分期.ID,CASE WHEN 分期.是无分期=1 THEN 分期.PROJECT_NAME ELSE 分期.PROJECT_NAME || '-' || 分期.STAGE_NAME END AS NAME--统计的父级字段处理，无分期项目父级是公司，有分期项目父级是项目
,CASE WHEN 分期.是无分期=1 THEN 分期.UNIT_ID ELSE PROJECT_ID END PARENT_ID,
             有效节点数,
             应得总分,
             实际得分,
             应得总分本月,
             应完成数量本月,
             实际得分本月,
             已完成数量本月,
             应得总分本季度,
             应完成数量本季度,
             实际得分本季度,
             已完成数量本季度,
             应得总分本年度,
             应完成数量本年度,
             实际得分本年度,
             已完成数量本年度,
             绿灯,
             黄灯,
             红灯,
             里程碑应完成,
             里程碑已完成,
             里程碑未完成,
             一级应完成,
             一级已完成,
             一级未完成,'/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||
             分期.UNIT_ID || '&ppid=' || CASE WHEN 分期.是无分期=1 THEN PROJECT_ID ELSE 分期.ID END || '&planType=关键节点计划' AS URL,
             分期.UNIT_ID,
             分期.SN,CASE WHEN (CASE WHEN (里程碑应完成 + 一级应完成)=0 THEN 0 ELSE ROUND((里程碑已完成 + 一级已完成)/(里程碑应完成 + 一级应完成),4)*100 END)< 90 THEN 1 ELSE 0 END AS "isWarning" FROM BASEDATA LEFT JOIN 分期 ON BASEDATA.PROJ_ID= 分期.ID UNION ALL
SELECT PROJ.ID,PROJ.PROJECT_NAME AS NAME,PROJ.UNIT_ID AS PARENT_ID,0 有效节点数,0 应得总分,0 应得总分本月,0 应完成数量本月,0 实际得分本月,0 已完成数量本月,0 应得总分本季度,0 应完成数量本季度,0 实际得分本季度,0 已完成数量本季度,0 应得总分本年度,0 应完成数量本年度,0 实际得分本年度,0 已完成数量本年度,0 绿灯,0 黄灯,0 红灯,0 里程碑应完成,0 里程碑已完成,0 里程碑未完成,0 一级应完成,0 一级已完成,0 一级未完成,0 实际得分,'' AS URL,PROJ.UNIT_ID,PROJ.SN,0 "isWarning" FROM SYS_PROJECT PROJ LEFT JOIN (
SELECT*FROM 分期 WHERE 是无分期 =1) S ON PROJ.ID=S.PROJECT_ID WHERE S.ID IS NULL),/*
             拼接项目公司树
       */
拼接项目公司树 AS (
SELECT*FROM (
SELECT DISTINCT ORG_ID AS ID,ORG_NAME AS NAME,PARENT_ID AS PARENT_ID,0 有效节点数,0 应得总分,0 绿灯,0 黄灯,0 红灯,0 里程碑应完成,0 里程碑已完成,0 里程碑未完成,0 一级应完成,0 一级已完成,0 一级未完成,0 实际得分,0 应得总分本月,0 应完成数量本月,0 实际得分本月,0 已完成数量本月,0 应得总分本季度,0 应完成数量本季度,0 实际得分本季度,0 已完成数量本季度,0 应得总分本年度,0 应完成数量本年度,0 实际得分本年度,0 已完成数量本年度,'' URL,ORDER_CODE AS SN,0 "isWarning" FROM TMP_COMPANY_TREE WHERE ID=DATA_AUTH_SPID AND ORG_ID IN (
SELECT DISTINCT ID FROM SYS_BUSINESS_UNIT
START WITH ID IN (
SELECT ID FROM (
SELECT UNIT_ID AS ID FROM SYS_PROJECT UNION
SELECT SUBORDINATE_COMPANY_ID AS ID FROM CDB_FEASIBLE_PROJECT_CONFIG) DS) CONNECT BY PRIOR PARENT_ID=ID)--                               )   start with id=v_id connect by prior id=parent_id
UNION ALL
SELECT ID,NAME,PARENT_ID,
                     有效节点数,
                     应得总分,
                     绿灯,
                     黄灯,
                     红灯,
                     里程碑应完成,
                     里程碑已完成,
                     里程碑未完成,
                     一级应完成,
                     一级已完成,
                     一级未完成,
                     实际得分,
                     应得总分本月,
                     应完成数量本月,
                     实际得分本月,
                     已完成数量本月,
                     应得总分本季度,
                     应完成数量本季度,
                     实际得分本季度,
                     已完成数量本季度,
                     应得总分本年度,
                     应完成数量本年度,
                     实际得分本年度,
                     已完成数量本年度,URL,SN,"isWarning" FROM 项目分期)
START WITH ID=V_ID CONNECT BY PRIOR ID=PARENT_ID)--
,/*
        汇总
       */
汇总 AS (
SELECT ID,NAME,PARENT_ID,URL,SN-- ,有效节点数,应得总分
,(
SELECT SUM(有效节点数) FROM 拼接项目公司树
START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 有效节点数,(
SELECT SUM(应得总分) FROM 拼接项目公司树
START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 应得总分--,绿灯,黄灯,红灯
,(
SELECT SUM(绿灯) FROM 拼接项目公司树
START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 绿灯,(
SELECT SUM(黄灯) FROM 拼接项目公司树
START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 黄灯,(
SELECT SUM(红灯) FROM 拼接项目公司树
START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 红灯--,里程碑应完成,里程碑已完成,里程碑未完成
,(
SELECT SUM(里程碑应完成) FROM 拼接项目公司树
START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 里程碑应完成,(
SELECT SUM(里程碑已完成) FROM 拼接项目公司树
START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 里程碑已完成,(
SELECT SUM(里程碑未完成) FROM 拼接项目公司树
START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 里程碑未完成--,一级应完成,一级已完成,一级未完成
,(SELECT SUM(一级应完成) FROM 拼接项目公司树
START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 一级应完成,(
SELECT SUM(一级已完成) FROM 拼接项目公司树
START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 一级已完成,(
SELECT SUM(一级未完成) FROM 拼接项目公司树
START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 一级未完成,(
SELECT SUM(实际得分) FROM 拼接项目公司树
START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 实际得分,(
SELECT SUM(应得总分本月) FROM 拼接项目公司树
START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 应得总分本月,(
SELECT SUM(应完成数量本月) FROM 拼接项目公司树
START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 应完成数量本月,(
SELECT SUM(实际得分本月) FROM 拼接项目公司树
START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 实际得分本月,(
SELECT SUM(已完成数量本月) FROM 拼接项目公司树
START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 已完成数量本月,(
SELECT SUM(应得总分本季度) FROM 拼接项目公司树
START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 应得总分本季度,(
SELECT SUM(应完成数量本季度) FROM 拼接项目公司树
START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 应完成数量本季度,(
SELECT SUM(实际得分本季度) FROM 拼接项目公司树
START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 实际得分本季度,(
SELECT SUM(已完成数量本季度) FROM 拼接项目公司树
START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 已完成数量本季度,(
SELECT SUM(应得总分本年度) FROM 拼接项目公司树
START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 应得总分本年度,(
SELECT SUM(应完成数量本年度) FROM 拼接项目公司树
START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 应完成数量本年度,(
SELECT SUM(实际得分本年度) FROM 拼接项目公司树
START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 实际得分本年度,(
SELECT SUM(已完成数量本年度) FROM 拼接项目公司树
START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) 已完成数量本年度,(
SELECT SUM("isWarning") FROM 拼接项目公司树
START WITH ID=S.ID CONNECT BY PRIOR ID=PARENT_ID) AS "isWarning" FROM 拼接项目公司树 S)--
/*
    查询
    */
SELECT ID AS "id",SN,CASE WHEN URL IS NOT NULL THEN '<span style="color:#409eff">' || NAME || '</span>' ELSE NAME END AS "company",URL AS "jumpUrl",PARENT_ID AS "parentId",CASE WHEN (里程碑应完成 + 一级应完成)=0 THEN 0 ELSE ROUND((里程碑已完成 + 一级已完成)/(里程碑应完成 + 一级应完成),4)*100 END || '%' AS "completionRate",
           有效节点数 AS "validTasks",
           里程碑应完成 + 一级应完成 AS "completeNum",
           里程碑已完成 + 一级已完成 AS "completed",
           里程碑未完成 + 一级未完成 AS "unfinished",
           应得总分 AS "needResult",CASE WHEN (应得总分)=0 THEN 0 ELSE ROUND((实际得分)/(应得总分),4)*100 END "dynamicResult",
           实际得分 "realResult",
           应得总分本月 AS "needResultMonth",
           应完成数量本月 AS "needResultCountMonth",CASE WHEN (应得总分本月)=0 THEN 0 ELSE round(实际得分本月/应得总分本月,4)*100 END AS "dynamicResultMonth",
           实际得分本月 AS "realResultMonth",
           已完成数量本月 AS "realResultCountMonth",
           应得总分本季度 AS "needResultQuarter",
           应完成数量本季度 AS "needResultCountQuarter",CASE WHEN (应得总分本季度)=0 THEN 0 ELSE round(实际得分本季度/应得总分本季度,4)*100 END AS "dynamicResultQuarter",
           实际得分本季度 AS "realResultQuarter",
           已完成数量本季度 AS "realResultCountQuarter",
            应得总分本年度 AS "needResultYear",
            应完成数量本年度 AS "needResultCountYear",CASE WHEN (应得总分本年度)=0 THEN 0 ELSE round(实际得分本年度/应得总分本年度,4)*100 END AS "dynamicResultYear",
           实际得分本年度 AS "realResultYear",        
           已完成数量本年度 AS "realResultCountYear",      
           绿灯 AS "greenLight",
           黄灯 AS "yellowLight",
           红灯 AS "redLight",
           里程碑应完成 AS "miCompleteNum",
           里程碑已完成 AS "miCompleted",
           里程碑未完成 AS "miUnfinished",
           一级应完成 AS "olCompleteNum",
           一级已完成 AS "olCompleted",
           一级未完成 AS "olUnfinished",'<span style="font-size:14px">预警说明：公司存在项目完成率低于90%，显示预警图标</span>' AS "remark",CASE WHEN ("isWarning">=1 AND ID<> '003200000000000000000000000000') THEN 1 ELSE "isWarning" END AS "isWarning"--,"isWarning"
FROM 汇总 WHERE 1=1 AND 有效节点数 > 0 ORDER BY LPAD(SN,10,'0'); END P_POM_KEY_NODE_SCHEDULE;
/

prompt
prompt Creating procedure P_POM_KN_PERFORM_DYNAMIC
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_KN_PERFORM_DYNAMIC
(
		IN_ORG_ID    IN VARCHAR2
	 ,DATASCOPE    IN VARCHAR2
	 ,IN_PLAN_TYPE IN VARCHAR2
	 ,IN_PROJID  IN VARCHAR2 
	 ,PAGEINDEX    IN INT
	 ,PAGESIZES    IN INT
	 ,P_PAGETYPE  IN INT
	 ,ITEMS        OUT SYS_REFCURSOR
	 ,TOTAL        OUT INT
) AS
		--传入的参数有三个，1：IN_ORG_ID（公司ID）
		--，2：DATASCOPE（统计期间，3个值“THIS_MONTH、THIS_QUARTER、THIS_YEAR"）
		--，3：PLAN_TYPE（计划类型，预留，估计后面会用的到）
		--，4：P_PAGETYPE（页面类型：1：已延误 2：已完成 3：应完成）//alterby 李小聪
		--关键节点计划-执行动态查询（wangck需要）
		--作者：陈丽
		--日期：2019/12/07
-- 20200326:晓聪修订

		CURSOR CUR_COMPANY_LIST(V_ORG_ID SYS_BUSINESS_UNIT.ID%TYPE) IS
				SELECT P.ID, P.PARENT_ID, P.ORG_NAME FROM SYS_BUSINESS_UNIT P WHERE P.IS_COMPANY = 1 START WITH P.ID = V_ORG_ID CONNECT BY PRIOR P.ID = P.PARENT_ID;
		V_SQL_TOTAL     CLOB := ' ';
		V_SQL           CLOB := ' ';
		V_SQL_DATASCOPE CLOB := ' ';
		V_COMPANY_LIST  CLOB := ' ';

BEGIN

  dbms_output.put_line('开始');
--月度
--已延误
		IF DATASCOPE = 'thisMonth' AND P_PAGETYPE=1  THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL   AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';
--月度
--已完成--当前已延误项目
	ELSIF DATASCOPE = 'thisProjAll' AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := ' AND   1=1 AND pj.id='''||IN_PROJID||'''AND ((TRUNC(SYSDATE) >= pn.PLAN_END_DATE AND pn.ACTUAL_END_DATE IS NULL)  or (ACTUAL_END_TIME- pn.PLAN_END_DATE>0)) ';
	--已完成--当前已延误项目
	ELSIF DATASCOPE = 'thisCompanyAll' AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := ' AND   1=1 AND pj.id='''||IN_PROJID||'''AND ((TRUNC(SYSDATE) >= pn.PLAN_END_DATE AND pn.ACTUAL_END_DATE IS NULL)  or (ACTUAL_END_TIME- pn.PLAN_END_DATE>0)) ';
				
		ELSIF DATASCOPE = 'thisMonth' AND P_PAGETYPE=2  THEN
				V_SQL_DATASCOPE := ' AND  PN.ACTUAL_END_DATE IS  NOT NULL  AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';

--月度
--应完成

		ELSIF DATASCOPE = 'thisMonth' AND P_PAGETYPE=3  THEN
				V_SQL_DATASCOPE := 'AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';

--季度
--已延误
	ELSIF DATASCOPE = 'thisQuarter' AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := ' AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL    AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((	SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((	SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
--季度
--已完成
	ELSIF DATASCOPE = 'thisQuarter' AND P_PAGETYPE=2 THEN
				V_SQL_DATASCOPE := 'AND  PN.ACTUAL_END_DATE IS  NOT NULL AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((	SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((	SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
--季度
--季度应完成
	ELSIF DATASCOPE = 'thisQuarter' AND P_PAGETYPE=3 THEN
				V_SQL_DATASCOPE := '  AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((	SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((	SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
--年度
--已延误
		ELSIF DATASCOPE = 'thisYear'AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL  
			 AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) ';
--年度
--已完成
		ELSIF DATASCOPE = 'thisYear'AND P_PAGETYPE=2 THEN
				V_SQL_DATASCOPE := 'AND  PN.ACTUAL_END_DATE IS  NOT NULL  
				 AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH)  ';
--年度
--应完成
		ELSIF DATASCOPE = 'thisYear' AND P_PAGETYPE=3 THEN
				V_SQL_DATASCOPE := ' AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) ';
--全部，没有时间限
--已延误
	ELSIF DATASCOPE = 'thisAll' AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL ';
--计划所有节点
	ELSIF DATASCOPE = 'thisAll' AND P_PAGETYPE=2 THEN
				V_SQL_DATASCOPE := ' AND   1=1 ';
	ELSIF DATASCOPE = 'thisAll' AND P_PAGETYPE=3 THEN
				V_SQL_DATASCOPE := '1=2 ';
	
				
			

		END IF;
		
		FOR ITEM_COMPANY_LIST IN CUR_COMPANY_LIST(IN_ORG_ID)
		LOOP
				/*DBMS_OUTPUT.PUT_LINE(ITEM_COMPANY_LIST.ORG_NAME || ',PARENT_ID' ||
        ITEM_COMPANY_LIST.PARENT_ID || ',ID:' ||
        ITEM_COMPANY_LIST.ID);*/
				V_COMPANY_LIST := V_COMPANY_LIST || '''' || ITEM_COMPANY_LIST.ID || '''' || ',';
		END LOOP;
-- 	dbms_output.put_line(V_COMPANY_LIST);
		V_COMPANY_LIST := '('  || SUBSTR(V_COMPANY_LIST, 1, LENGTH(V_COMPANY_LIST) - 1) || ')';
-- 		dbms_output.put_line(V_COMPANY_LIST);
IF  V_COMPANY_LIST='()'
	 THEN  V_COMPANY_LIST := '('''||IN_ORG_ID||''')';
END  IF;
-- 	dbms_output.put_line(V_COMPANY_LIST);
		V_SQL := V_SQL ||
						 'SELECT ROW_NUMBER() OVER( ORDER BY  PN.PROJ_PLAN_ID,  PN.NODE_CODE) as ROW_CODE,PP.COMPANY_ID, PP.COMPANY_NAME AS COMPANY_NAME,PP.PROJ_name AS PROJ_NAME,PP.PLAN_NAME AS PLAN_NAME, PN.ID,PN.PROJ_PLAN_ID,PN.ORIGINAL_NODE_ID,CASE WHEN PN.IS_DISABLE = 0 THEN	PN.NODE_NAME ELSE	''【禁用】'' || PN.NODE_NAME END AS NODE_NAME, PN.NODE_CODE, PN.NODE_LEVEL, PN.PROJ_STAGE, PN.MAIN_RESPONSIBILITY, PN.DUTY_DEPARTMENT, TO_CHAR(PN.PLAN_START_DATE, ''yyyy-MM-dd'') AS PLAN_START_DATE, TO_CHAR(PN.PLAN_END_DATE, ''yyyy-MM-dd'') AS PLAN_END_DATE, PN.IS_DISABLE, PN.COMPLETION_STANDARD, PN.COMPLETION_RESULTS_REMARK, TO_CHAR(PN.ACTUAL_END_DATE, ''yyyy-MM-dd'') AS ACTUAL_END_DATE
	, case 
 --未到期不亮灯
 WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
 --到期当天内完成反馈
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
 then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
  --到期1-5天内完成反馈
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
 then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
 --到期未反馈黄灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 1 and 4
 THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>'' 
  --到期超过5天未反馈红灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(PLAN_END_DATE)) >5) THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' 
 ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END
  AS PLAN_STATUS, TO_CHAR(PN.ESTIMATE_END_DATE,''YYYY-MM-DD'') AS "ESTIMATE_END_DATE" ,	nps.CHARGE_PERSON
	FROM  pom_proj_plan_node pn 
LEFT JOIN pom_proj_plan pp ON pn.proj_plan_id = pp.id 
LEFT JOIN  POM_NODE_FEEDBACK d on  d.FEEDBACK_NODE_ID=pn.id  and  d.APPROVAL_STATUS=''已审核'' and   FEEDBACK_TYPE=''CARRY_OUT''
LEFT JOIN  SYS_PROJECT_STAGE ps on  ps.id=pp.proj_id
LEFT JOIN SYS_PROJECT pj on  ps.PROJECT_ID =pj.id
LEFT JOIN(	SELECT  NODE_ID, listagg(CHARGE_PERSON,'','') WITHIN GROUP (ORDER BY CHARGE_PERSON )  as CHARGE_PERSON
	FROM POM_NODE_CHARGE_PERSON 
	GROUP BY NODE_ID) nps on  nps.NODE_ID=pn.id
	WHERE   PP.PLAN_TYPE = ''关键节点计划'' AND PN.IS_DISABLE=0  AND pp.APPROVAL_STATUS = ''已审核'' AND 1=1 
	and  ((pp.proj_id ='''||IN_PROJID||''' or pn.proj_plan_id='''||IN_PROJID||'''  OR  pj.id='''||IN_PROJID||''' )
	OR PP.COMPANY_ID IN ' || V_COMPANY_LIST ||' ) '|| V_SQL_DATASCOPE || '  ORDER BY PN.PROJ_PLAN_ID,  PN.NODE_CODE';

		DBMS_OUTPUT.PUT_LINE(V_SQL);
			V_SQL_TOTAL := V_SQL_TOTAL|| 				 'SELECT  TO_CHAR(COUNT(pn.ID))
	FROM  pom_proj_plan_node pn 
LEFT JOIN pom_proj_plan pp ON pn.proj_plan_id = pp.id 
LEFT JOIN  POM_NODE_FEEDBACK d on  d.FEEDBACK_NODE_ID=pn.id  and  d.APPROVAL_STATUS=''已审核'' and   FEEDBACK_TYPE=''CARRY_OUT''
LEFT JOIN  SYS_PROJECT_STAGE ps on  ps.id=pp.proj_id
LEFT JOIN SYS_PROJECT pj on  ps.PROJECT_ID =pj.id
LEFT JOIN(	SELECT  NODE_ID, listagg(CHARGE_PERSON,'','') WITHIN GROUP (ORDER BY CHARGE_PERSON )  as CHARGE_PERSON
	FROM POM_NODE_CHARGE_PERSON 
	GROUP BY NODE_ID) nps on  nps.NODE_ID=pn.id
	WHERE  PP.PLAN_TYPE = ''关键节点计划''     AND pp.APPROVAL_STATUS = ''已审核'' AND 1=1  AND PN.IS_DISABLE=0 
	and  ((pp.proj_id ='''||IN_PROJID||''' or pn.proj_plan_id='''||IN_PROJID||'''  OR  pj.id='''||IN_PROJID||''' )
	OR PP.COMPANY_ID IN ' || V_COMPANY_LIST ||' ) '|| V_SQL_DATASCOPE || '  ORDER BY PN.PROJ_PLAN_ID,  PN.NODE_CODE';

		--DBMS_OUTPUT.PUT_LINE(V_SQL_TOTAL);
		 execute immediate V_SQL_TOTAL into TOTAL; 
	--	 DBMS_OUTPUT.PUT_LINE(TOTAL);

		OPEN ITEMS FOR V_SQL;

END P_POM_KN_PERFORM_DYNAMIC;
/

prompt
prompt Creating procedure P_POM_KN_PERFORM_DYNAMIC_OUT
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_KN_Perform_dynamic_Out
(
		IN_ORG_ID    IN VARCHAR2
	 ,DATASCOPE    IN VARCHAR2

	 ,IN_PROJID  IN VARCHAR2 
	 ,P_PAGETYPE  IN INT

	 ,ITEMS        OUT SYS_REFCURSOR
	 ,TOTAL        OUT INT
) AS
		--传入的参数有三个，1：IN_ORG_ID（公司ID）
		--，2：DATASCOPE（统计期间，3个值“THIS_MONTH、THIS_QUARTER、THIS_YEAR"）
		--，3：PLAN_TYPE（计划类型，预留，估计后面会用的到）
		--，4：P_PAGETYPE（页面类型：1：已延误 2：已完成 3：应完成）//alterby 李小聪
		--关键节点计划-执行动态查询（wangck需要）
		--作者：陈丽
		--日期：2019/12/07
-- 20200326:晓聪修订

		CURSOR CUR_COMPANY_LIST(V_ORG_ID SYS_BUSINESS_UNIT.ID%TYPE) IS
				SELECT P.ID, P.PARENT_ID, P.ORG_NAME FROM SYS_BUSINESS_UNIT P WHERE P.IS_COMPANY = 1 START WITH P.ID = V_ORG_ID CONNECT BY PRIOR P.ID = P.PARENT_ID;
		V_SQL_TOTAL     CLOB := ' ';
		V_SQL           CLOB := ' ';
		V_SQL_DATASCOPE CLOB := ' ';
		V_COMPANY_LIST  CLOB := ' ';

BEGIN

  dbms_output.put_line('开始');
--月度
--已延误
		IF DATASCOPE = 'thisMonth' AND P_PAGETYPE=1  THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL   AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';
--月度
--已完成--当前已延误项目
	ELSIF DATASCOPE = 'thisProjAll' AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := ' AND   1=1 AND pj.id='''||IN_PROJID||'''AND ((TRUNC(SYSDATE) >= pn.PLAN_END_DATE AND pn.ACTUAL_END_DATE IS NULL)  or (ACTUAL_END_TIME- pn.PLAN_END_DATE>0)) ';
	--已完成--当前已延误项目
	ELSIF DATASCOPE = 'thisCompanyAll' AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := ' AND   1=1 AND pj.id='''||IN_PROJID||'''AND ((TRUNC(SYSDATE) >= pn.PLAN_END_DATE AND pn.ACTUAL_END_DATE IS NULL)  or (ACTUAL_END_TIME- pn.PLAN_END_DATE>0)) ';
				
		ELSIF DATASCOPE = 'thisMonth' AND P_PAGETYPE=2  THEN
				V_SQL_DATASCOPE := ' AND  PN.ACTUAL_END_DATE IS  NOT NULL  AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';

--月度
--应完成

		ELSIF DATASCOPE = 'thisMonth' AND P_PAGETYPE=3  THEN
				V_SQL_DATASCOPE := 'AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';

--季度
--已延误
	ELSIF DATASCOPE = 'thisQuarter' AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := ' AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL    AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((	SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((	SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
--季度
--已完成
	ELSIF DATASCOPE = 'thisQuarter' AND P_PAGETYPE=2 THEN
				V_SQL_DATASCOPE := 'AND  PN.ACTUAL_END_DATE IS  NOT NULL AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((	SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((	SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
--季度
--季度应完成
	ELSIF DATASCOPE = 'thisQuarter' AND P_PAGETYPE=3 THEN
				V_SQL_DATASCOPE := '  AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((	SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((	SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
--年度
--已延误
		ELSIF DATASCOPE = 'thisYear'AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL  
			 AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) ';
--年度
--已完成
		ELSIF DATASCOPE = 'thisYear'AND P_PAGETYPE=2 THEN
				V_SQL_DATASCOPE := 'AND  PN.ACTUAL_END_DATE IS  NOT NULL  
				 AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH)  ';
--年度
--应完成
		ELSIF DATASCOPE = 'thisYear' AND P_PAGETYPE=3 THEN
				V_SQL_DATASCOPE := ' AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) ';
--全部，没有时间限
--已延误
	ELSIF DATASCOPE = 'thisAll' AND P_PAGETYPE=1 THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL ';
--计划所有节点
	ELSIF DATASCOPE = 'thisAll' AND P_PAGETYPE=2 THEN
				V_SQL_DATASCOPE := ' AND   1=1 ';
	ELSIF DATASCOPE = 'thisAll' AND P_PAGETYPE=3 THEN
				V_SQL_DATASCOPE := '1=2 ';
	
				
			

		END IF;
		
		FOR ITEM_COMPANY_LIST IN CUR_COMPANY_LIST(IN_ORG_ID)
		LOOP
				/*DBMS_OUTPUT.PUT_LINE(ITEM_COMPANY_LIST.ORG_NAME || ',PARENT_ID' ||
        ITEM_COMPANY_LIST.PARENT_ID || ',ID:' ||
        ITEM_COMPANY_LIST.ID);*/
				V_COMPANY_LIST := V_COMPANY_LIST || '''' || ITEM_COMPANY_LIST.ID || '''' || ',';
		END LOOP;
-- 	dbms_output.put_line(V_COMPANY_LIST);
		V_COMPANY_LIST := '('  || SUBSTR(V_COMPANY_LIST, 1, LENGTH(V_COMPANY_LIST) - 1) || ')';
-- 		dbms_output.put_line(V_COMPANY_LIST);
IF  V_COMPANY_LIST='()'
	 THEN  V_COMPANY_LIST := '('''||IN_ORG_ID||''')';
END  IF;
-- 	dbms_output.put_line(V_COMPANY_LIST);
		V_SQL := V_SQL ||
						 'SELECT ROW_NUMBER() OVER( ORDER BY  PN.PROJ_PLAN_ID,  PN.NODE_CODE) as ROW_CODE,PP.COMPANY_ID, PP.COMPANY_NAME AS COMPANY_NAME,PP.PROJ_name AS PROJ_NAME,PP.PLAN_NAME AS PLAN_NAME, PN.ID,PN.PROJ_PLAN_ID,PN.ORIGINAL_NODE_ID,CASE WHEN PN.IS_DISABLE = 0 THEN	PN.NODE_NAME ELSE	''【禁用】'' || PN.NODE_NAME END AS NODE_NAME, PN.NODE_CODE, PN.NODE_LEVEL, PN.PROJ_STAGE, PN.MAIN_RESPONSIBILITY, PN.DUTY_DEPARTMENT, TO_CHAR(PN.PLAN_START_DATE, ''yyyy-MM-dd'') AS PLAN_START_DATE, TO_CHAR(PN.PLAN_END_DATE, ''yyyy-MM-dd'') AS PLAN_END_DATE, PN.IS_DISABLE, PN.COMPLETION_STANDARD, PN.COMPLETION_RESULTS_REMARK, TO_CHAR(PN.ACTUAL_END_DATE, ''yyyy-MM-dd'') AS ACTUAL_END_DATE
	, case 
 --未到期不亮灯
 WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
 --到期当天内完成反馈
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
 then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
  --到期1-5天内完成反馈
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
 then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
 --到期未反馈黄灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE))  BETWEEN 1 and 4
 THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>'' 
  --到期超过5天未反馈红灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(PLAN_END_DATE)) >5) THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' 
 ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END
  AS PLAN_STATUS, TO_CHAR(PN.ESTIMATE_END_DATE,''YYYY-MM-DD'') AS "ESTIMATE_END_DATE" ,	nps.CHARGE_PERSON
	FROM  pom_proj_plan_node pn 
LEFT JOIN pom_proj_plan pp ON pn.proj_plan_id = pp.id 
LEFT JOIN  POM_NODE_FEEDBACK d on  d.FEEDBACK_NODE_ID=pn.id  and  d.APPROVAL_STATUS=''已审核'' and   FEEDBACK_TYPE=''CARRY_OUT''
LEFT JOIN  SYS_PROJECT_STAGE ps on  ps.id=pp.proj_id
LEFT JOIN SYS_PROJECT pj on  ps.PROJECT_ID =pj.id
LEFT JOIN(	SELECT  NODE_ID, listagg(CHARGE_PERSON,'','') WITHIN GROUP (ORDER BY CHARGE_PERSON )  as CHARGE_PERSON
	FROM POM_NODE_CHARGE_PERSON 
	GROUP BY NODE_ID) nps on  nps.NODE_ID=pn.id
	WHERE   PP.PLAN_TYPE = ''关键节点计划'' AND PN.IS_DISABLE=0  AND pp.APPROVAL_STATUS = ''已审核'' AND 1=1 
	and  ((pp.proj_id ='''||IN_PROJID||''' or pn.proj_plan_id='''||IN_PROJID||'''  OR  pj.id='''||IN_PROJID||''' )
	OR PP.COMPANY_ID IN ' || V_COMPANY_LIST ||' ) '|| V_SQL_DATASCOPE || '  ORDER BY PN.PROJ_PLAN_ID,  PN.NODE_CODE';

		DBMS_OUTPUT.PUT_LINE(V_SQL);
			V_SQL_TOTAL := V_SQL_TOTAL|| 				 'SELECT  TO_CHAR(COUNT(pn.ID))
	FROM  pom_proj_plan_node pn 
LEFT JOIN pom_proj_plan pp ON pn.proj_plan_id = pp.id 
LEFT JOIN  POM_NODE_FEEDBACK d on  d.FEEDBACK_NODE_ID=pn.id  and  d.APPROVAL_STATUS=''已审核'' and   FEEDBACK_TYPE=''CARRY_OUT''
LEFT JOIN  SYS_PROJECT_STAGE ps on  ps.id=pp.proj_id
LEFT JOIN SYS_PROJECT pj on  ps.PROJECT_ID =pj.id
LEFT JOIN(	SELECT  NODE_ID, listagg(CHARGE_PERSON,'','') WITHIN GROUP (ORDER BY CHARGE_PERSON )  as CHARGE_PERSON
	FROM POM_NODE_CHARGE_PERSON 
	GROUP BY NODE_ID) nps on  nps.NODE_ID=pn.id
	WHERE  PP.PLAN_TYPE = ''关键节点计划''     AND pp.APPROVAL_STATUS = ''已审核'' AND 1=1  AND PN.IS_DISABLE=0 
	and  ((pp.proj_id ='''||IN_PROJID||''' or pn.proj_plan_id='''||IN_PROJID||'''  OR  pj.id='''||IN_PROJID||''' )
	OR PP.COMPANY_ID IN ' || V_COMPANY_LIST ||' ) '|| V_SQL_DATASCOPE || '  ORDER BY PN.PROJ_PLAN_ID,  PN.NODE_CODE';

		--DBMS_OUTPUT.PUT_LINE(V_SQL_TOTAL);
		 execute immediate V_SQL_TOTAL into TOTAL; 
	--	 DBMS_OUTPUT.PUT_LINE(TOTAL);

		OPEN ITEMS FOR V_SQL;

END P_POM_KN_Perform_dynamic_Out;
/

prompt
prompt Creating procedure P_POM_MAIN_PLAN_MONITOR
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_main_plan_monitor (
    userid                 IN                     VARCHAR2,--用户id
    planid                 IN                     VARCHAR2,--计划id
    timeout_info           OUT                    SYS_REFCURSOR,--超期未完成任务 
    timeout_title          OUT                    VARCHAR2,--标题 超期未完成任务：共0项
    expect_timeout_info    OUT                    SYS_REFCURSOR,--四、预计超期任务 
    expect_timeout_title   OUT                    VARCHAR2,--标题预计超期任务：共0项
    completion_level_rate_title   OUT                    VARCHAR2,---一、按任务级别统计完成率 (%)
    pandect_info           out SYS_REFCURSOR,       --计划明细一览表
    completion_level_rate  out SYS_REFCURSOR---按任务等级统计完成率
) AS
--项目主项计划监控，详情页 ：超期未完成任务,预计超期任务
--作者：陈丽定义，李小聪实现
--日期：2020/02/26
  v_timeout_count VARCHAR2(20):='';
  v_expect_timeout_count VARCHAR2(20):='';
BEGIN
completion_level_rate_title:='一、按任务级别统计完成率 (%)';
 OPEN timeout_info FOR
      SELECT   a.*,nvl(b.IS_UN_WATCH,1)  as  IS_UN_WATCH ,b.UN_WATCH_TIME  ,b.WATCH_TIME  
      FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' --and   b.WATCH_TIME is  not   null
      WHERE     a.PLAN_ID=''||planid||''
      AND  TRUNC( a.PLAN_END_DATE)-TRUNC(SYSDATE)<0  and  a.ACTUAL_END_DATE  is null   ;
 OPEN expect_timeout_info FOR 
          SELECT   a.*,nvl(b.IS_UN_WATCH,1)  as  IS_UN_WATCH ,b.UN_WATCH_TIME  ,b.WATCH_TIME  
      FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND   TRUNC( a.ESTIMATE_END_DATE)-TRUNC(SYSDATE)<0   and  a.ACTUAL_END_DATE  is null ;


SELECT  (SELECT  TO_CHAR(COUNT(NODE_ID))        FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND  TRUNC( PLAN_END_DATE)-TRUNC(SYSDATE)<0  and  ACTUAL_END_DATE  is null   )  
INTO v_timeout_count  FROM  DUAL;
SELECT  (SELECT  TO_CHAR(COUNT(NODE_ID))        FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND   TRUNC( ESTIMATE_END_DATE)-TRUNC(SYSDATE)<0  and  ACTUAL_END_DATE  is null ) 
INTO v_expect_timeout_count  FROM  DUAL;
    timeout_title := '超期未完成任务：共'||v_timeout_count||'项';
    expect_timeout_title := '预计超期任务：共'||v_expect_timeout_count||'项';

    ----计划明细一览表
    OPEN pandect_info FOR
         SELECT   a.*,nvl(b.IS_UN_WATCH,1)  as  IS_UN_WATCH ,b.UN_WATCH_TIME  ,b.WATCH_TIME  
      FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' --and   b.WATCH_TIME is  not   null
      WHERE     a.PLAN_ID=''||planid||'' ORDER BY NODE_CODE asc ;
     
    --按任务等级统计完成率
    OPEN Completion_level_rate FOR
--      SELECT  '里程碑' as "nodeName",1 as "percentage" from dual
--      UNION all 
--      SELECT  '一级节点' as "nodeName",1 as "percentage" from dual
--     UNION all 
--      SELECT  '二级节点' as "nodeName",1 as "percentage" from dual;
		SELECT   NODE_LEVEL  as "nodeName",	ROUND(SUM( CASE WHEN   B.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END) /COUNT(b.id),2)  AS "percentage" 
			FROM POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE B ON A.ID=B.PROJ_PLAN_ID
			INNER JOIN SYS_PROJECT_STAGE C ON C.ID=PROJ_ID
			INNER JOIN SYS_PROJECT D ON D.ID=C.PROJECT_ID
			WHERE     A.PLAN_TYPE='项目主项计划' AND A.APPROVAL_STATUS='已审核' AND B.IS_DISABLE=0  AND B.PLAN_END_DATE<=SYSDATE and  a.id=''||planid||''
			GROUP BY NODE_LEVEL    ORDER BY   CASE  WHEN   NODE_LEVEL='里程碑' THEN  0 WHEN   NODE_LEVEL='一级节点' THEN  1 WHEN   NODE_LEVEL='二级节点' THEN  3   WHEN   NODE_LEVEL='三级节点' THEN  4  WHEN   NODE_LEVEL='四级节点' THEN  5 else 6 END asc;
		 
		 
		 
		 

END p_pom_main_plan_monitor;
/

prompt
prompt Creating procedure P_POM_MAIN_PLAN_W_OVERDUE
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_main_plan_w_overdue (
    userid                 IN                     VARCHAR2,--用户id
    planid                 IN                     VARCHAR2,--计划id
    timeout_info           OUT                    SYS_REFCURSOR,--三、超期未完成任务 
    timeout_title          OUT                    VARCHAR2,--标题 超期未完成任务：共0项
    expect_timeout_info    OUT                    SYS_REFCURSOR,--四、预计超期任务 
    expect_timeout_title   OUT                    VARCHAR2--标题预计超期任务：共0项
) AS
--项目主项计划监控，详情页 ：超期未完成任务,预计超期任务
--作者：陈丽定义，李小聪实现
--日期：2020/02/26
  v_timeout_count VARCHAR2(20):='';
  v_expect_timeout_count VARCHAR2(20):='';
BEGIN
 OPEN timeout_info FOR
      SELECT   a.*,nvl(b.IS_UN_WATCH,1)  as  IS_UN_WATCH ,b.UN_WATCH_TIME  ,b.WATCH_TIME  
      FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' --and   b.WATCH_TIME is  not   null
      WHERE     a.PLAN_ID=''||planid||''
      AND  TRUNC( a.PLAN_END_DATE)-TRUNC(SYSDATE)<0  and  a.ACTUAL_END_DATE  is null   ;
 OPEN expect_timeout_info FOR 
          SELECT   a.*,nvl(b.IS_UN_WATCH,1)  as  IS_UN_WATCH ,b.UN_WATCH_TIME  ,b.WATCH_TIME  
      FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND   TRUNC( a.ESTIMATE_END_DATE)-TRUNC(SYSDATE)<0   and  a.ACTUAL_END_DATE  is null ;


SELECT  (SELECT  TO_CHAR(COUNT(NODE_ID))        FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND  TRUNC( PLAN_END_DATE)-TRUNC(SYSDATE)<0  and  ACTUAL_END_DATE  is null   )  
INTO v_timeout_count  FROM  DUAL;
SELECT  (SELECT  TO_CHAR(COUNT(NODE_ID))        FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND   TRUNC( ESTIMATE_END_DATE)-TRUNC(SYSDATE)<0  and  ACTUAL_END_DATE  is null ) 
INTO v_expect_timeout_count  FROM  DUAL;
    timeout_title := '超期未完成任务：共'||v_timeout_count||'项';
    expect_timeout_title := '预计超期任务：共'||v_expect_timeout_count||'项';



END p_pom_main_plan_w_overdue;
/

prompt
prompt Creating procedure P_POM_MD_SITUATION
prompt =====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_md_situation (
    projtreeinfo OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN projtreeinfo FOR SELECT
                              a.id,
                              a.parent_id   parentsid,
                              a.org_name    orgname,
                              b.nums        projtotal,
                              nvl(c.salesarea, 0) salesarea,
                              nvl(c.salescarport, 0) salescarport
                          FROM
                              sys_business_unit a
                              INNER JOIN (
                                  SELECT
                                      COUNT(b.company_id) nums,
                                      b.company_id
                                  FROM
                                      mdm_project b
                                  WHERE
                                      b.approval_status = '已审核'
                                  GROUP BY
                                      b.company_id
                              ) b ON a.id = b.company_id
                              LEFT JOIN (
                                  SELECT
                                      company_id,
                                      SUM(mdm_obj_phase_index.total_sale_area) salesarea,
                                      SUM(mdm_obj_phase_index.underground_total_sale_carport) salescarport
                                  FROM
                                      mdm_project left
                                      JOIN (
                                          SELECT
                                              t1.id,
                                              t1.phase_id,
                                              t1.proj_id,
                                              t2.phase_order
                                          FROM
                                              mdm_project_phase                                                                  t1
                                              LEFT JOIN (
                                                  SELECT
                                                      proj_id,
                                                      MAX(phase_order) AS phase_order
                                                  FROM
                                                      mdm_project_phase
                                                  GROUP BY
                                                      proj_id
                                              ) t2 ON t1.proj_id = t2.proj_id
                                                      AND t1.phase_order = t2.phase_order
                                          WHERE
                                              t2.phase_order IS NOT NULL
                                      ) phase ON mdm_project.project_original_id = phase.proj_id
                                      LEFT JOIN mdm_phase ON phase.phase_id = mdm_phase.id
                                      LEFT JOIN mdm_obj_phase_index ON phase.id = mdm_obj_phase_index.obj_phase_id
                                                                       AND mdm_obj_phase_index.obj_type = 0
                                  WHERE
                                      approval_status = '已审核'
                                  GROUP BY
                                      company_id
                              ) c ON c.company_id = a.id
                          WHERE
                              a.org_type = 0
                              AND ( a.id != '000100000000000000000000000000'
                                    AND a.id != '000200000000000000000000000000' );

END p_pom_md_situation;
/

prompt
prompt Creating procedure P_POM_MD_SITUATION_ODL
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_md_situation_odl (
    projtreeinfo OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN projtreeinfo FOR SELECT
                              a.id,
                              a.parent_id   parentsid,
                              a.org_name    orgname,
                              b.nums        projtotal,
                              nvl(c.salesarea, 0) salesarea,
                              nvl(c.salescarport, 0) salescarport
                          FROM
                              sys_business_unit a
                              INNER JOIN (
                                  SELECT
                                      COUNT(b.company_id) nums,
                                      b.company_id
                                  FROM
                                      mdm_project b
                                  WHERE
                                      b.approval_status = '已审核'
                                  GROUP BY
                                      b.company_id
                              ) b ON a.id = b.company_id
                              LEFT JOIN (
                                  SELECT
                                      company_id,
                                      SUM(mdm_obj_phase_index.total_sale_area) salesarea,
                                      SUM(mdm_obj_phase_index.underground_total_sale_carport) salescarport
                                  FROM
                                      mdm_project left
                                      JOIN (
                                          SELECT
                                              t1.id,
                                              t1.phase_id,
                                              t1.proj_id,
                                              t2.phase_order
                                          FROM
                                              mdm_project_phase                                                                  t1
                                              LEFT JOIN (
                                                  SELECT
                                                      proj_id,
                                                      MAX(phase_order) AS phase_order
                                                  FROM
                                                      mdm_project_phase
                                                  GROUP BY
                                                      proj_id
                                              ) t2 ON t1.proj_id = t2.proj_id
                                                      AND t1.phase_order = t2.phase_order
                                          WHERE
                                              t2.phase_order IS NOT NULL
                                      ) phase ON mdm_project.project_original_id = phase.proj_id
                                      LEFT JOIN mdm_phase ON phase.phase_id = mdm_phase.id
                                      LEFT JOIN mdm_obj_phase_index ON phase.id = mdm_obj_phase_index.obj_phase_id
                                                                       AND mdm_obj_phase_index.obj_type = 0
                                  WHERE
                                      approval_status = '已审核'
                                  GROUP BY
                                      company_id
                              ) c ON c.company_id = a.id
                          WHERE
                              a.org_type = 0
                              AND ( a.id != '000100000000000000000000000000'
                                    AND a.id != '000200000000000000000000000000' );

END p_pom_md_situation_odl;
/

prompt
prompt Creating procedure P_POM_MESSAGE_TYPE_LIST
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_MESSAGE_TYPE_LIST (
     systemId VARCHAR2,
     userId VARCHAR2,
     MESSAGETYPEINFO  OUT SYS_REFCURSOR
) AS
 v_sys_code VARCHAR2 (50);
 v_get_code_sql VARCHAR2 (2000);
 v_sql Clob;
BEGIN 
      v_get_code_sql := 'select user_code from sys_user where id=:sys_code';

      EXECUTE IMMEDIATE v_get_code_sql INTO v_sys_code  using userId;

    v_sql := 'SELECT 
    BASE.M_TYPE as "msgType",
    S_RESULT.TOTAL  as "msgTypeUnreadCount",
    S_RESULT.TITLE as "fristMsg",
    S_RESULT.ID as "id"
FROM (
(SELECT ''预警消息'' as "M_TYPE" FROM dual UNION ALL SELECT ''提醒消息'' as "M_TYPE" FROM dual UNION ALL SELECT ''催办消息'' as "M_TYPE" FROM dual) BASE
LEFT JOIN (
SELECT A.BIZ_MSG_CATEGORY,TOTAL,TITLE,A.ID FROM (
    (select SMRB.CREATED_TIME, SMRB.BIZ_MSG_CATEGORY, SMRB.ID
      from (
        SELECT CREATED_TIME,  
                   BIZ_MSG_CATEGORY,  
                   biz.ID,
                   dense_rank() over(partition by BIZ_MSG_CATEGORY order by CREATED_TIME desc) rank  
              FROM SYS_MSG_RECORD_BIZ biz
			  LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
			  LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID  
              WHERE BIZ.SYSTEM_ID='''||systemId||''' AND
              ((sms.receiver_id = '''||v_sys_code||''') or (wechat.receiver_id = '''||v_sys_code||''' and sms.receiver_id is not null))
      )SMRB 
     where SMRB.rank = 1)A 
     LEFT JOIN 
     (
        select count(*) AS "TOTAL",BIZ_MSG_CATEGORY from SYS_MSG_RECORD_BIZ smrb 
        LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON smrb.ID = wechat.MSG_RECORD_BIZ_ID
         LEFT JOIN SYS_MSG_RECORD_SMS sms ON smrb.ID = sms.MSG_RECORD_BIZ_ID
        left join SYS_MSG_READ_RECORD smrr on smrb.ID  = smrr.MSG_RECORD_BIZ_GUID --未阅读条数及分
        where SMRB.SYSTEM_ID='''||systemId||'''
            and smrb.BIZ_MSG_CATEGORY is not null
            and smrr.ID is null
            AND ((sms.receiver_id = '''||v_sys_code||''') or (wechat.receiver_id = '''||v_sys_code||''' and smrr.reader_id is not null))
        GROUP BY BIZ_MSG_CATEGORY 
     )B ON A.BIZ_MSG_CATEGORY = B.BIZ_MSG_CATEGORY
     LEFT JOIN 
     (
       SELECT  WECHAT_MSG_TYPE,TITLE,MSG_RECORD_BIZ_ID FROM SYS_MSG_RECORD_WECHAT
     )C ON C.MSG_RECORD_BIZ_ID = A.ID
    )) S_RESULT ON BASE.M_TYPE = S_RESULT.BIZ_MSG_CATEGORY )';

           DBMS_OUTPUT.PUT_LINE(v_sql);  
    OPEN MESSAGETYPEINFO FOR v_sql;

END P_POM_MESSAGE_TYPE_LIST;
/

prompt
prompt Creating procedure P_POM_MOBILE_CENTER_MESSAGE
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_MOBILE_CENTER_MESSAGE (
    MESSAGEINFO  OUT SYS_REFCURSOR
)
IS
a clob;
b clob;
c clob;
BEGIN
 a:='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAF62lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDIgNzkuMTYwOTI0LCAyMDE3LzA3LzEzLTAxOjA2OjM5ICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgKFdpbmRvd3MpIiB4bXA6Q3JlYXRlRGF0ZT0iMjAyMC0wMi0xMVQxMDoyMToyMCswODowMCIgeG1wOk1ldGFkYXRhRGF0ZT0iMjAyMC0wMi0xMVQxMDoyMToyMCswODowMCIgeG1wOk1vZGlmeURhdGU9IjIwMjAtMDItMTFUMTA6MjE6MjArMDg6MDAiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MDQ0MDI1MzItZTc0NS0yOTQzLTkzODEtM2Y1NDJkYTAyNWFmIiB4bXBNTTpEb2N1bWVudElEPSJhZG9iZTpkb2NpZDpwaG90b3Nob3A6MzljMTUyZmUtY2FmZi05YzRjLTkwZjgtNjU3YTFkMDM1ZjdjIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YjQ5Y2FjYzctZWY2Yy02NDRjLTk3NjctMTVlMjFhMjQzODdhIiBkYzpmb3JtYXQ9ImltYWdlL3BuZyIgcGhvdG9zaG9wOkNvbG9yTW9kZT0iMyIgcGhvdG9zaG9wOklDQ1Byb2ZpbGU9InNSR0IgSUVDNjE5NjYtMi4xIj4gPHhtcE1NOkhpc3Rvcnk+IDxyZGY6U2VxPiA8cmRmOmxpIHN0RXZ0OmFjdGlvbj0iY3JlYXRlZCIgc3RFdnQ6aW5zdGFuY2VJRD0ieG1wLmlpZDpiNDljYWNjNy1lZjZjLTY0NGMtOTc2Ny0xNWUyMWEyNDM4N2EiIHN0RXZ0OndoZW49IjIwMjAtMDItMTFUMTA6MjE6MjArMDg6MDAiIHN0RXZ0OnNvZnR3YXJlQWdlbnQ9IkFkb2JlIFBob3Rvc2hvcCBDQyAoV2luZG93cykiLz4gPHJkZjpsaSBzdEV2dDphY3Rpb249InNhdmVkIiBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOjA0NDAyNTMyLWU3NDUtMjk0My05MzgxLTNmNTQyZGEwMjVhZiIgc3RFdnQ6d2hlbj0iMjAyMC0wMi0xMVQxMDoyMToyMCswODowMCIgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWRvYmUgUGhvdG9zaG9wIENDIChXaW5kb3dzKSIgc3RFdnQ6Y2hhbmdlZD0iLyIvPiA8L3JkZjpTZXE+IDwveG1wTU06SGlzdG9yeT4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7KrSW+AAAL8ElEQVR42u1daWwU5xken3uADw7b4BpIisvV/nCTBpo6Tbn8Iw6kIa3VBqlRkdI/KZQiNUp6h9I2OEpLRIKbVk2AOCUSBX4UpYGEVCKHGyVFKWpsRG0otSvbsWzjYK+9xsbu80zmRaPNzto7O7Mzs8wrvZpjd2e+73ve+/tmNmtyclLxyT2U7Q+BD4hPPiA+ID75gPiA+OQD4gPikw+ID4hPPiA++YD4gPjkA5IBlGv0wc6dO1O68LVr15Tx8XGlrq5O6e3tVbq7u5VAIKBMTEwoUvLnNicnR4lEIsro6OjckpKSqrGxsc9nZ2fPxmfkPHxtAHwF+61ZWVnvYnsBn0/w9zhWr8dtXl6eMjIyol6PJOcLCgoUfF9xcpphw4YNqQOSJvocgLs3FAqtDwaDKwFGSMDkYOpJO57E9iK2r4BPgf/CczeEhthMNeAdGNy7ZLDJIsWxYOhxAS/G97ZiuxXbNvBeaEADfnPN9yFJkDbIn8EAHsX2VfBd8hmBMGlSKsF78dtmmMc6H5ApSHwEbThs+jdgiv6J0/dZDTTusxSAHMZ9DmasyaJTTNWpExD4BV7r59h/LA0a+AB4Oe5F7evLKEAkWkllgMLhsNLa2kobvy0/Pz9dfboN/A64GtyTMYCUlZWZNlM0UQQD21/BlGzjcQJHbYe20Le8Cb4F+5GM8CES+Zjl3Nzcb4J/RE1LJxg6WgI+7rVlToYawmTNDDH5Q15RgYH4U6p+yAJnv2Z4ePinSA53OZ0cpgxIbW2tqQt2dXUply5dasSAZLthABBc/CIajb6I9vzH04AsXbrUrGTWtLS0rKamOE2SbAKQp6EhGxQPkCEgR48eNeXQIZGPFxcXu6aDGih3w5etACgtbtcSQ0B6enqSBiMvL+8WRFe30pG7reOI9nYAkO94FpBkTQ47ilxjixvB0KrCLK1sg9BE3QyKISAzZ85MutOs3Lq1sxCwov7+/hrwcZbqb4TSyWcBRoWbzQGE5iswW8cZAnsOEBOS/gU3gzE6Oqog2KgqLy9XPGmykqllaTb65ngTS24h9mdsbKzy/Pnz2WjnRDrbacmMoQmTVe5WMHRUBnNVCA0ZcKvZsnLGsMjNSNBMQWDyFi5cWITtgOdMlsPXss2vQ/Nd3U5LGqdlw8MeAGR8ZGRk0JNOnQ46GXMAm3zZzT6EPgPZeqSjo+MKlyd5zockI0XaIoV2NwPCIAUg/G/BggVRT5qs3NykrdkHHihv/9vNWXpCQEyo9N9h5sbd6typvTBV79FcuVmTDQePDU8yrPwIHX0LvNqtYS+E7FXPakiyU7i00cFg8BB4tZNTt4nMFYTlfbu0I3b1peMaQkJIeQgNeioMSiZKS4d25OTkPGvn1MDVq1ft1ZB169aZuV6ks7Nz38WLFx8OhUJu8h+cA3nWjJBNwwyqzOKlVg2wB5AlS5aYbeSvm5ubvwdAAi4CZBfaNWIVCEZBkK2AHDlyxNQFYaoGZs2a9X3s/s4leHRSSKzIY6zyE6YAGRoaMnVB2mnaa9jU+7CtYT7jVH5CqY1Go3Vg05m5BCiMzrgcNtUltqYBKSpKrXiLDnwN2tKGDpWmO+6nAFAQAoHAw2hDEx3udAGRtjIoIfM6BELCZbuFyxCQjRs3pnrtwZaWlrVNTU3/ArhZ6QSDPDg4uLe7u/tJ7scmg5T6eKG5mCMCgfBdmTNnjrrYg+fSFcpbWTr5BKEzzZCs1YhAXoGqhylldksYBxUCsK+1tXV7R0eHOrCiHRxUPh7BQY4XAotT5rqy2bNnq5qhfybSUUBOnz4dz2Grq1H4IKU8/8EO0EbPnz9fKS0tVaVRQl6Cis/eqKysXAVQXobULrQrF5BnUebNm
/fY8uXLd547d069vyz2Zns5wAg4lMLCQoVz6/rcQR4gZV8ECCdyKUNADh8+/IlzjLUrKiqURYsWqftsNDvMjs2YMUPtyOXLl5WqqipVyvr7+1XbW1ZW9kFfX9/Knp6ePwCse6wufWuJXyfaw+juzxxI3oP31mvl4sWL1WMIhhKrrWKuCCr741S9yxAQSnu8bJR2lRLGfUmMpCMst1BDLly4oO4zMKDmIFHk5x+ik1/FoP0Eg7fLSi3BdVswwFwT1grglTNnzqiCA225PrAUHmo2hUSkX68BAojTZZ9cCyVU1RACw4d1JEyUMgy4BuZuE7671mqThcEsgalpxHWP4XAfhCVC3yF5g64NitvJ9lI5Bud+SN12aNIqu6QPQJQQFPAqHG7H9incqxEa0K3XEC9QtsUDc90uA4CvQyLfh685hMFYlcY+laMNT1Aj9X7AirKG5zSEHQYQn8buHvA9+kQrzYnhk7hvo95ceeXRNssA0cLdBxDjN8BUzHCwT7vAP9OH6qId+sRP71+cEhzbTBYjLTj1BuwexL6TYNQLGJJ7SFGQhIDjfuQmv0dw8SXRGuF0J4C2aQg6UYYOH0FH73CyQ7g3wXhUJF9CWgEDgvIIANnN6A/7tchFbqICxYa9TmtLqoDwefC/oSMLHBYsFQy9A4/xbY9gs1tnsvjqJ8bkI7G/cdp0pQLITWh8E7YlToOBwZwSjJjfRHDelV7erA8pBL/lNjDiRH3xwPBmlBVv0p71Ky1COYHDT7kJDDE1OtOTCAx+KeopQOLVskgFBQVPI0K53SHHrVZwwfWIilQHrr1tKFYzfozNL9PVLiv9jiEgLMzFDgYilHXo/FYOghPOj2AgOmoYGBh4lPtsh5TTdcnfdMAoRvtfYyQMTmVONo8LBGE19mF7yoooc1pLSbUwMhdm7CWnIhEWL9GG/3Z1dX23vb1dBYdzGixk6szUjmlqBiOs9VZpLYT0XrRnEQ7bbQMkTha7x0knzjmMZcuWNVZXV6smihpx9uzZ634NNAf8Wyfapr396FZs7QNEr34YAL49dKuTMbrWnkvUFJkJpMkiINoChDG7V4RM3UQbTRanMmWeA1zvdMLEyaW2trZiTs1Kx3lOZ7KugDdj/5BDWmLJABkCMnfuXBWMoaGhmyORSK0Vix5SIZqp/Pz8uwOBwG+k73HGgD4uDFD+mG7thQU5YysgNAeac/+Bi+YR1qDztRCUvyYwsc+hvRM4fj7BdZhkvWEmytJPW/PN22jLRxCWBgQ8ljxBZggIbTMcaQg325KO5TtJ0DG05U4Myrv6+lPMu3/3szQC2m9wjQF8VmO2AbGFS/FdVgBiWDrh2wdWrFixaXh4OOSyyZ0AIqw3ISgr9QMgy310bT2A4y125EJcKEGBFTNu5WykoYacPHmSoeXmZN8KlCYHmk9QMCBfFk2RAETmNrQ86oAG0v44ghhMtnwik1uhUOg2WI0f4vgdHD+hSolFb9AzBKSvry+Im6xxcrF0sqCIphAM3XtX4oESNJtv4Dq5hYWFxwB6Be6xSfn4ffT1VvXL0GRBCu7g8k83z0ULKGK+pK3i83TrrgjKt3U/7cXxKH8jACZTLtHmU2QaeLdWyLRXQ9DQaje/3Wcq80VQZFWlRgfx3Tb0qQaafwI8KRm/LPqbZl+JOh/ADOvOyeRXvW2AoLHLvLBsxggUSj0Lj3xtrZgynH8bu29LpETHLIvnLOirJaAk0tUqxUMkoGBAbteHwfpHEWTBgyx7lap1kmBEFeM/kUnZfCUCpEjxHhGUJvBaASXegMv8iU3vO0kJlET1EM7GHfSYlqggwCe8Dh/xII6f08zTepish3BczOw8BfPEKIGVzGK7zFciQF4Av4eLVmqlBi+91X4WtGBcy024tPQ1B6JFgjKK+z6D/XErACGd09hzRHNEP4EB+aKDr2LaA8FoxfZlqwBRvAqGPH4gf7HnBGk+LKlqQMYBonfi2oBkOZXc4tabwa/fsIDIc4L69bygf6T7H360tjyIzUvJCkPGaYj8w6hOSzrC4TCfFXkIn3G1yVgql9eirDuVjxdKGIHBKvMBq8NeT5usmNL8KauW6Wj3+BCbUqvBmCoxzBhKlw9JFYwbBhCLKRhv3KwAI2PDXjvMYBxQLAfD1xBzNAru1YHxLavA8DVkmlFbrEtCkPA4Qmn+Y88JAPKipS9B8NofL2Y6+SbLB8QnHxAP0f8BZ5KgB0Puc50AAAAASUVORK5CYII=';
 b:='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAecUlEQVR4Xu1dC5gcRbU+p6eHR5KFKILsGhSMQeDyRnzrJSCoYAgBHLardhMBEVEUvRdBxEe8ihfF9wsQJbKZql5GICbR4Duo+AKfKF4IoKgYiCiJeUpmps/9Tr7eONmd3eme6e7p7qn6vvk2MFXn8Vf9U11dVecgmGIQMAhMigAabAwCBoHJETAEiXl0VCqV3arV6mGFQmE/z/P6iKgPEfmzNxFNG/tv/gsAeyOi3cSkzQCwFgAe9f+uJaK1nuetfeihh9YtXrzYi9mNnhVvCBJR11cqlf3r9fohAHAIET137C8iHggAceJcB4DHiOiviPh/iHi353l3F4vFX5dKpe0RudezYuLsuFyCunjxYus5z3nOIYj4fAB4PiIeTURHIuL0NDlMRFUA+DUA/BwA7iKiu6SUTCBKk51pt8UQJEAPLV26tN+yrDMAgD8vSRsZArgwVoUf1X4CAN8jom8LIX5pCDM1eoYgk+CjlHoWIp4FAPx5UcyPSSHGeHRViegfTBZEvN3zvFuHhoY2Ric9H5IMQRr6sVKpHFSr1c4morP9R6h89HIAL/iRDBG/DQC3ENFXpZTrAzTLfZWeJ0ilUtm7VqtJIlrUa6SYYnTz4v6rRHSDEOK7vfwY1rME0Vq/FAAuAIDXAsCeuf8pbN/BhwHgi/wRQqxrX0w2W/YUQVavXm0/9thjJc/zrkTEw7LZZV2z+kkAGCGiq6WUf+iaFQkr7gmCjIyMTC8UCucDwDsQcVbCGOdKHRF5iLiciK6SUv4iV841cSbXBFFKPQUALkbEtwHAU/PemUn7R0S3FQqFKwYHB9ckrTspfbkkiOu6A57nvR0ALsrwnkVSY6BTPbyTfxMiLnYc5y+dCktb+1wRxD/3dCkAvAcR90gb2Hm2h4j+hYif9Dzvf/O0n5IbgmitTwSALwDA7DwPxLT75m8+fmDz5s2fv/DCC/m4S6ZL5gkyMjKyX6FQ+AQiikz3RP6Mf4iILpBSrs6ya5klCBGh1voCRPwIHxPPcifk2XYi0oh4iRDi71n0M5MEGR0dPbRer9+IiC/MIui9ZjMRrbcs61LHcW7Mmu+ZIog/a7zVnzV2yxrYxt4dx1fOy9I5r8wQxF9r8HR9khlo2UWAiPhWpMzK2iQTBFFKvRIAFCLuk92hYSxvQIAvbV29Zs2ad6f9unCqCXL99dcX+/r6ruIjImZ45RKB73metyDN+yapJYjrugd4nrcMEY/L5dAwTo0h8FC9Xj9teHj4/jRCkkqCaK1fBQCj5vVtGodM9DYR0RYAKEkpV0UvvTOJqSOIUuq1iOgCQKEz10zrLCHAp4QB4FIp5SfSZHeqCKKU4sOFn08TQMaWxBFYYtv2BaVSiQ9Bdr2khiBKqasQ8V1dR8QYkAYEvler1U5fuHAhP3p1tXSdILz557ouX+k8r6tIGOWpQoCIfkFEJ3b7DVdXCcJB2ObMmTOCiDJVvWOMSQsC91Sr1RMXLVrE4Ym6UrpGEL4fvnbt2lsQcX5XPDdKs4LAAwDwsm4FjOgKQZgcjz766K0AcHpWesnY2VUE7t1zzz1fumDBgg1JW5E4QQw5ku7ifOgjoru3b9/+8nPPPfdfSXqUKEEMOZLs2vzpIqJvDQwMnDZ37txaUt4lRhD/bdVX/Fi3SfmXFT0cyfAJInoCEXlBut7/9xMAUCOiZyLiswCAP/15jBMctKOIaFRK6QSt32m9xAiitf4wAFzWqcEZb09ExBHVv0VEnIrgQdu2HyyVSo8H9csPTPGsQqFwkOd5BxHR4Yh4CgAcHFRGDupdLYS4Igk/EiGIUup8ROS9jp4rRLTBJ8TtxWLx62HIEAascrk8q1AozPc872QAOBkRp4Vpn7W6RHShlJKDdMRaYieIUupUAFiJiFasnqRLOD8ucayo5f39/T9K8pmZYViyZMkexWJxrmVZ5wDAUB7Ptflnt+bFfcAxVoKMjo7O9jyPsxzNSNf4jccaXkRalnXDxo0bl6cl5A2ndKhWq+8EgHMRsRiP512Turlerx8zPDz8YFwWxEaQlStXTtu4cSM/b3O+vryX+wDgjUKI76fVUdd1DySiLwEAxw/LU7mvr6/vuHnz5m2Nw6nYCKKUuhURz4zD6LTIJCLOyHRlsVi8Ni2nT1th47ouJwj6FAAMtKqboe9vEUJwGovISywE0VpfCADXRW5tugRWbNu+OK5Fd5yuLlu2bObWrVs/jYjDcepJUjYiXuQ4TuRjLnKC8LqjXq//Lq+xcTnGEy98414cJjG4XNc9nfcV8pBAiGMDFwqF4wcHB38XJXaREsQ/nXtXXu+RE9FPPc87c3h4mEPX5KK4rvtiz/NuR8S9cuDQmieffPKoKI+jREoQpdTliHh1DoBu5sLHbNu+PCtrjTB9oJQ62s92y/lUMl2I6AtSSn7Ej6RERpByuXyYZVm/AoA8Rjz8HyHE+yJBPKVCRkdHj6/X63fkYYMREV/jOM7Xo4A6EoL4dzv4le4RURiVJhlE9GUp5blpsikuW1zXPYGIOBW0HZeOJOQS0SPFYvHQUqm0uVN9kRBEKbUYEfP4C3vrmjVrSmmP/tfpIGhsn6PAGZ8RQry1U2w6JojW+kgA4GSOmf7VGQ8kEd1fLBaPLJVKfNK2p4rW+msAcFrGneaDocd3mmi0I4L40db5lW7eUipv9zzveUNDQ7/N+CBpy3w/+em9iMhH67Nc7rFt+9hOXqx0RBDXdc/zjy9kGcRmtl8mhLgmb06F8Ucp9TpEXBKmTRrrIuLFjuN8rl3b2ibIqlWrdt+wYQNnNd23XeUpbXen4zgvR0SOQN7TRWv9SwA4Jssg+Bu7s9vNSdI2QbTW7wWA92cZvGa2e553ZK8+Wo3HQyn1CkTkt1qZLp3sjbRFED+ZzR/z8M68seeJ6DYp5VmZHg0RG6+1/j0AHBqx2KTFked5R7Xzw9cWQZRSH0fEtyftZZz6+AKO53mHpTUMf5y+TyU7L+vMdn/8QhOkUqnsX61WefbYo1udFodeIlJSSr59Z0oDArzWXL9+/d/ycFYLEY91HIdPewQuoQmilPosIr45sIaMVEzL2oOzau29995HENFeiLjF87w/dyuq4FjXKaXKeQgPS0Rfk1LOCzMkQxFk6dKl/YVC4eG8nbfiQMlSyueFAS6qunwltlar8WWf44joUH9PaZfcKH7iy9FCoXBj1Me5g/ihtT4DAJYFqZv2OmFnkVAE0Vp/DAD+K+0ghLWPiN4kpbw2bLt261cqlUKtVjuXiC5AxOeHlLMSAN4thLgnZLu2q/uhhv6Zk8fqshAi8EWxwARZvnx535YtW9bl4XLNuJHyZK1W2yepXBTlcvkIy7Ju7vDN0JOI+BbHcW5oe9SHbKi1/gEHkQ7ZLI3VOSrjrKCPrYEJopR6FyJyxtlcFSLSnLQ7Cae01vz8y9Eld49I3zVCiESC8SmlrkbEyyOyu6tiiOiDUsr3BDEiEEF4iq3Vao/kcNecMRoWQpSDgNVJHT8x6fKo129EdKWU8kOd2BakrU/uFUHqZqDOEzNnzhw49dRTn2xlayCCaK359efSVsKy+H2tVnv6woUL/xan7f5lpB/E+Ax/ihAi1h3vSqXyDP9HMk6oEpNNRIuklCOtFAYlyB0A8J+thGXw+zVCiFjjdvGCvFqtrkHEZ8eIz19t255TKpW2xagDtNaceiCqx8M4TQ0i+2dCiBe2qtiSIJVK5Zm1Wu1PrQRl8Xsiuk5KeVGctiulLkHET8apg2XHFfam0W6tNUfJPCpuXxKUf7gQ4t6p9LUkSJ6jshORI6XksDexFI6Ru9tuuz2CiPvEomBXod8XQpwQpx6tNb9gODtOHQnLvlEIcX7bBPEvRD2GiPslbHhS6lr+gnRiSMLXV/kG3T7tHusO4qfW+tMA8JYgdTNSZ5tt2zOnujU65QyiteY4rt/Ni
LOhzZw5c+YeQd5khBbsN9Ba/xQAXtBu+7DtLMs6enBw8Ddh2wWt77ru+4hocdD6WajH4XEdx5n0lEArgnD+hQuy4GhYG4noD1LK2WHbBa3vH8tZG7R+FPU8zzt1aGjo9ihkNZOhlLoYET8Tl/xuyG11SHVSgvhvXx5HxMwHE5sE+G8IIV4dV6copc5ERM7km1ghooVSythexyulBhHRTcyhBBRxAPJisbjvZI9ZkxKEE98gYiTBtxLwM7QKIvq0lPKS0A0DNujGznPcM4jrugv4XkVACDJTbapAc5MSRGvNkbIjC+GYNrQQ8T2O43wwLruUUl9FxPlxyZ9E7lFxHmL0g13zaYC8leuFEG9s5tRUM8hfEHFW3pBo8OftQojY9ie01hwy6PCk8COifwgh9o0z2ERenyo4EqOU8oDABFm6dOlzC4UCZ03KbSGi10spOeNSLEUpxSmdk1y/tXyn36mjeT5yNNkbwKYzSFK7v512WCftEXHQcRw+dh5L0VrzQbjEAnnH/YqXQdJa8yPplbEA1n2hfMdmwmn1pgTRWvPinLPT5rZEGQF8PEicJ+Xggw+uJwjeCiFE7OudPKfVI6IfSSlfOr7PJhDE79x/9kBmWr6Rx9mi4iic8jqpy0WxZ3odA0gpldt1KRFVN2/ePH18duIJBBkdHT3W8zwORm1KBhCIcyZsdN+/CZnYNd9uQI+IL3Ec58eNuicQRCn1dkT8eDcMNDrDIZDUZSm2ynXddxPRB8JZmLnaE2IyTyCI1prPpXAUC1NSjAARfU5KeXFSJiqlfp7X3JNjGBLRcinlLmO/GUEeA4CnJwW80RMeASK6WQjhxLnn0WiVnwMmtkOQ4RGIrcU6IcT+kz5icf7sbdu2xbVwjc2rHhO8wrbtMzvJeREWr7wEjgvit23b+5RKpSfG6u4yg+T9eHsQgFJeZ0V/f/9Zc+fO5dA1iRQOVG7b9l/zlkFsMvAsy3rl4ODgt5oSpBc2CBMZVTEoIaKvDAwMiCTJwW5orT8CAO+IwaW0itxloT5+BuFAZK9Pq+W9ahffWeBogEmtOcZwVkrNQUROf5Cr/JNTjaPx90PGEyQv0fNywyU+li+EeFvS5ODr1q7r/iTJG5Ep6bRdop3sQpA875SmBPwwZvBRFT5x3JUbfAnfpw+DS9x1d3mTtZMgfkDlxBZ/cXuZZfl8yw0RTxdCfL8bfriue6DnefcgYl839Hdbp23b08ZijO0kSC8cce828AH18z32k4QQXbluwPlJ+vr67s5Z/KuA0O+sdugY/jsJUi6XX21Z1qqwkkz9SBFYZ1nWywcHB9dEKjWEsByG9gnh/c6qrxZCfIP/aydBlFLnI+IX25Fm2nSOABH9sVAonDw4OPhQ59Lak5DXG4NtoHGeEGJHjvhGglyOiFe3Icw06RyBBxDxBMdxEg0T1Gi267rHeJ73Q0Sc3rk7mZewcy+kkSDXIOKlmXctew7cU61WT1y0aNE/umU6x1+uVqu/TChEarfcDKP3I0KIHblQGgmyBBFfF0aKqdsZApwbkYhOHBoa2tiZpPZb33TTTfvYtn1XzNHn2zewOy133u9vJMhKvnzTHXt6UuuPa7XaKUmlfmuG8MjIyPRCobAaEY/vyR6Y3OmdV5h3EkRrzTF4ORavKfEj8DARHRtnoOlWLvDJ7a1bt34n73c8WuHQ7Hsi+q6U8hXjH7Hu5CuH7Qg0bYIjwJuAAPA8KeUDwVtFW9N/rOKMV4dFKzk30u4UQuyIKdA4g/DmUFdyhecG1taO8PER3gTsyg45m+cfX78TAOa0Nrc3axDR3VLKHem5GwmSaCTAXoQ+6Xzs4zEeHR09ql6vL0PEg3oR/xA+3yOE2JFJq5EgvHtrflVCoBimKhHdLqXsWqwxrfVbiOhjiFgMY3cv1iWi+6WUh4wnCJ/7P7QXAYnbZ1531Ov1OXFn023mh1LqKYjIKRFOi9vPvMgnot9LKf9jPEHylqAxNf1FROdKKb+ctEH+qdw7EPFZSevOsj4i+rWU8phdCKKU4s0i8z48+p79nhDipOjFTi2xXC7PQsSf5DxCfyywEtFdUsodqfMa1yA/BIAJsUljsaB3hNZ4h9pxnL8k6bJPDn5tb2aO9oD/oRDi5eMJYjYK2wNzqlY3CSESPb6jtX46Ef3MkKP9zmy6UWgiKrYP6CQtybKsQ5K828GXnWbMmMEzx453+Ka0jcAyIcSZ49cgX0TEKZOqt62uBxs2C2MZNwxaa34RsChuPT0g/4tCiB3ZnRvXIB8GgMt6wPlEXOQXHo7j/DwRZQBgYppFivTVQogrxhOEycEkMaVzBHYJHdO5uKkl8GUnPh4BAIW4dfWCfCJ6h5Tyo+MfscyV24h6n4gukVJ+OiJxLcX0QuT1liBEW2HilVsTtCEyhAkA+oUQ6yKTOIUgpdTrEHHH/WlTokGgMT7vzjXI6OjooZ7n8XETUzpAgIhWSykTuVezfPnyvi1btvwBAJ7Wgcmm6TgELMt67tjbx50EWbly5bRNmzZtMWh1hgARXSil/EJnUoK11lqbdWMwqELVsm3bHksvMT427+Pm1ygUlhMq27a9X6lUYhxjLRw7V2v9MCI+M1ZFvSf8r0KIWWNuj4/Nm/s0WzH398NCiETuWoyOjp7ied43Y/anF8XvPGbCzo8nyAgiDvciKlH4zDk8pJSlKGS1kqG1vg0AFrSqZ74PjcDnhRBvnmwGuRQRrwkt0jTYgUDj+/M4IVm1atXuGzZs2NxLeTvixHOc7DcKIa5vShCt9ckAsDP9VIJG5UXVCUncN3dd9yQi+k5eQEuTH57nvWhoaOinkxGEs9tylltT2kBg+vTpe82fP39TG01DNdFafxAArgzVyFQOhEBfX9/0efPmbW1KEP6fSql1iLhfIGmmUiMCm4UQieTT0Fr/CABebOCPFgEielBKuUtchmZ50pcDwOnRqs6/NCL6g5RydhKeaq03AMDeSejqMR0jQohdTkNPIIhSykR5b2NUENFPpZQvaqNpqCZ+gpvtoRqZykER2GWBzo0mEMR13ZcRESfzNCUcAjvjuYZrFq42B2LgXCLhWpnaQRDwPO/IoaEhjg+3s0wgSKVS2bNarf7TxE8KAum/6xDRl6SUsafQLpfLL7Qsi7PPmhIhAkS06YEHHpi5ePFib0qC8JdKKROnNzz4Nwgh3hC+WbgWJgtUOLyC1iair0kp542vP2EG8QnyLkS8KqhwU28HAmUhROynELTWfFKYA2yYEiECiHix4zifC0qQoxHxVxHqz70oIrpNSnlW3I66rvsCfiEQt55ek09EBzeLuN90BmFwtNZ/A4B9ew2odv1NKvZuuVw+wrKse9q107SbiAARPSKlPKAZNlMRhO807IjsYEogBO4QQswNVLODSkqpZyNi1zLhdmB6apsS0XVSyotCEcQsBlPbn8awiBEgoldJKZteHZh0BqlUKrtVq9XHEXGviO0x4gwCqUGAiNYXi8V9x24QBlqkj1VSSilEFKnxxhhiEIgegeuFEG+cTOykM4i/UOe3MrdEb5ORaBBIBwKchltKubotgvi76n9HxGnpcMdYYRCIFIHHHMcZQEQO1dS0TDmD+LPIDQAQ+xGKSN02wgwCARAgog9JKae8VxOEIJyK6ncB9JkqBoFMIUBEB0op/zSV0S0J4s8ivHO7I+OOKQaBPCAQNMBfUILwJZLEc+zloSOMD+lEABGl4zi6lXWBCOJH0VgLAE9tJdB8bxDIAAKP27Y9q1Qqtbx4Fogg7LBS6gOI+O4MON8tEznt2TuTUE5EKwFgRhK6cqrjCiHE1UF8C0wQzn0HAI+YWEzNYU3qsKL/Y7UeEWcG6WBTZ1cE+GLUjBkznhE0+kxggvgdY3bWJxlxhiCZoeLHhBCXBrU2FEH8TEa/DCq8l+oZgmSit7fX6/UDh4eHHw1qbSiCsFCt9QoAmHA1MajCvNYzBMlEz35KCPG2MJaGJoiZRcwaJMwAS0tdIvpXrVabtWjRon+Es
Sk0QfxZxEQWH4eymUHCDLuu1A219hizsC2C+Nc+f9MsrlZXXE+BUkOQFHTC5C9Qttbr9YMWLlzI18hDlbYI4s8i5hBjA9SGIKHGXaKVEfE9juNwwO/QpW2CVCqVfavV6kOImEjA5tCeJdzAECRhwIOre3zmzJkHnHrqqU8Gb/Lvmm0ThEUopS5BxE+2ozhvbQxB0tmjiHi+4zg3tmtdRwSpVCqFarV6DyIe1q4BeWlnCJLKnrzXcZwjproQ1crqjgjir0U4ojnnq+hYVitj0/y9IUjqeqcGAMcJITqKIRbJoNZac8jGN6UOogQNMgRJEOwAqojo/VLKxQGqTlklEoJUKpUZtVrtAQDYv1ODstreECQ9PUdEvx0YGDh27ty5PIt0VCIhCFvguu7pRMTZqXqyGIKkptu3W5Z13ODgYCTXxCMjiP9W63pEjD0FQGq6osEQQ5DU9MplQojIUplHSpAlS5bssfvuu/MO+8GpgSshQwxBEgJ6CjVE9AshxPGdvLUaLz5SgrDw0dHRwz3P+wUA7NZ9yJKzwBAkOaybaeLDiIVC4fDBwcFIA3tHThA2XmvNb7QmJCPpLoTxajcEiRffVtIR8SLHca5rVS/s97EQxCfJVwDg7LAGZbW+IUj3ei7O5EWxEWTlypXTNm3axI9ah3QPuuQ0G4Ikh3WjJiK6f6+99jp23rx5W+OwIDaCsLFLly59jmVZv+mF2L6GIHEMz5YyN1uWdXTU645GrbEShBW5rnua53krENFq6W6GKxiCJNt5RORZlnW64zhfj1Nz7ARh45VSb0DE6+N0pNuyiehBdjUhOy5HxD0S0pVKNUR0oZSS0wTGWhIhiE+SaxAxcLiVWL02wrOOwEeEEJcn4URiBCEidF230ktvtpLowB7UcYvjOKUoNwOnwjAxgrARq1evth999NFvA8AJPdixxuXOEVhh2/aZk+UT7Fz8RAmJEoTV8+vfjRs33oGIx8fhkJGZWwRW9Pf3nxXFCd0wCCVOEDZu2bJlM7dt23YnAHByHlMMAq0Q6Ao52KiuEIQVVyqV/avVKs8kz22Fjvm+dxEgoq8MDAyIpGeOMcS7RhA2QGv9NCL6NiIe3btDwHg+GQJEpIQQw0ktyJvZ0VWCsEHlcnkvRPyOWZMYojQiQETXCiHe3E1ydPURqxEMvrJbrVa/iognmWFiECCiD0gp35sGJLo+g4yBwCGEarXatQBwQRqAMTZ0BQEiordKKT/bFe1NlKaGIGO2aa3/GwD4ymTqbEtLp+XUjhoRDUspR9PkXyoHYblcfo1lWa7Jw5emoRKrLf8konOklN+MVUsbwlNJEP8NF98juR0ADmzDL9MkIwjwPXLLshY4jvOXNJqcWoIwWEqpp/CWCSK+Io3gGZs6QoAA4OP9/f3v7NYeRxDrU00QdmDx4sXWnDlzPoSIl5l1SZAuTX8dIuIsTzKNj1Tj0Us9QcYMVkrN5UkFEfvTPwSMhZMhQETfrdfrop1kNt1ANTMEGXvkQsSlAHBaN8AyOjtCYDsAXCGE+HhHUhJunCmCNMwmr+PnV0TkNYop6Ufgh0R0vpSS4zdnqmSSIIzwyMjIfrZtc/IeJ1OI95CxRLTBsqzLHMfhdH2ZLJklyBjao6Ojp3ie93kAmJ3JHsip0US0tF6vX5qVtcZk3ZB5grBjlUplt2q1ehG/9ELEmTkdc1lx6yEiOk9K+YOsGDyVnbkgyJiDlUpl71qt9i4+z9PrUT+6MDi3AcBVtm1fUyqVeEGei5Irgoz1SLlcnoWIPJvwYr6Qi55KqRNEtAkAOO3FR4UQ61JqZttm5ZIgY2horQ8hoqsQ8cy2ETINmyLgb/Z9atq0aZ9ZsGDBhrzClGuCNCzkj/c87woAOMPsxnc2lInoT/yKvVgs3lAqlfixKtelJwjSQJSDPc/j4HWLei1/SQSj+DdEdE2xWBxNMuxOBHZ3JKKnCNKwmN+/Xq+/nog4XdwBHSGY78Y8Q3AaixuEEByFpudKTxJkrJc52uPNN998sud5fIuRH7/snhsBTRwmorsQ8abp06cvnT9/Pi/Ce7b0NEEae52P1iPiGUT0WkQ8udfI4pPiFtu2by6VSn/uWUaMc9wQpMlI8PdT+M3Xq4jolJxuPvL97x8DwK0AcJuUkhffphiChBsD/n2UY3hWIaKTEPGFGb4KvJmIfoSIK2q12i1ZPwYSrifbq21mkJC48bpFKXUoIj4fAPjzPAA4GhGLIUXFXX0zAPwWAH4FAHdZlnXXOeecc1+340zF7XTU8g1BIkB01apVu69fv/4oy7KOJyL+HIaIAwCwf5w7+ZxlCQD+hIj3A8C9iMhJfO4rFAr3lUqlxyJwredFGILEOAT48Wz27NlPt237GUTUzx8AGPDJ8wwAmN5E/XY+voGI/DjEfzf5xzk287/543kev1laVywWf5+nc08xdkXbog1B2obONOwFBAxBeqGXjY9tI/D/JrWhbrQpc7gAAAAASUVORK5CYII=';
 c:='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAeqElEQVR4Xu1dCbxVVdVf69x7QeNJaGn4RAVNTTFt1swBh0pxwKnLu3s/ULDCyuxrMj8zwtLUUj/r04oyKXh7n8fNMkTRzML4nBrQyLB6mKko4AjKQ5N771nfb+FFn/CGM98z7P37vV8Da6/hv/f/nnP2sBaCaQYBg8CACKDBxiBgEBgYAUMQMzsMAoMgYAhipodBwBDEzAGDgD8EzBPEH26mV04QMATJyUCbMP0hYAjiDzfTKycIGILkZKBNmP4QMATxh5vplRMEDEEiGuhFixYNX7t27S4AMMayrDFEtDsRtSPiGP7/mn9vA4ChxoAA4GkiegIANv+t5P+OiE8Q0cre3t6VM2bMqEUUSq7VDjU4uQbHTfBEhPPnzx/faDQORMTxALA/EY1HxHEuJr8bE25kiIj+jYjLAWA5Ef2tUCgsmzx58nJEZIKZ5hMBQxCPwC1evLi4Zs2aDzqOcxgiHgIAhwLAmz2qiUWciNYi4r0AcA8iLhk9evS9Rx55ZD0W4xkxYgjiYiDnzp27U6FQOBYAJgLAcYg40kW3JIq8QES3I+ItAHCLEOLZJDqZJJ8MQQYYjQULFmzX29t7GgBIADgKEa0kDVxQX4jIAYDFANBVKpVuKJfLvUF1ZrG/IUifUW2+Pn2UiCQRnYKI22Rx0LeMiYj+g4g3IqIqFAq3lcvlRh7idhOjIQgAdHd3v8dxnKnNp8Vb3QCXVRkiehoRNSLOrVQqD2Q1Trdx5ZYgs2fPLo0cOfJjjuOcj4jvdAtYzuT+TERX9/b2VvO6jJw7gtx4442jXn755c8Q0bmIuFPOJryvcIloNSJeu+222157yimnrPOlJKWdckMQ/uh+6aWXPuc4zpdTvArV0mlGROssy7qyUChcnZeP+swThHe0161bdw4AXAAAO7R0hmXH+PMA8K1Ro0ZdM3HixFeyE9bWkWSaILZtH+84zrWIuHuWB7GFsT1KRGdLKX/dQh8iNZ1JgiilmBA/QcSjI0XPKN+EABHdbFnWZyuVyqNZgyRTBKlWq8MajcZ5RHQhAAzP2mAlOR7eS+HXrlKpdHm5XN6YZF+9+JYZgiilDkfE6wFgTy8AGNnQEfgXEU2XUi4JXXMLFKaeIM2P8B8AwLQW4GdMDozAnGKxeHbanyapJki1Wt2tVqvdbDb6EsvTB4rF4snlcvnxxHo4hGOpJYhS6hhEvCGpR83TOiEi8JtPEJ8upbwjAt2Rq0wdQfhA4erVq2c19zVS53/kI5pAA82Tw5eVSqWZaTsImaoJZtv2ro7jVBHx4ATOA+PSEAgQ0X2WZZUrlQpfGU5FSw1BtNZ8YanbvFKlYl4N5uQLANAhhLgtDZGkgiBKqQ5EnAcAxTSAanwcEoE6EU2RUvIPXqJb4gmilDoHEb8XYwKERA9YhpzjRBPnSimvSXJMiSaIUuoSRORDhqZlF4FLhBB88iGRLZEE4ctMbW1tcxGxI5GoGadCRYCIVG9v77QkXspKHEGq1WpbvV6/tZlOJ9SBMMqSiwARLWlrazth0qRJ65PkZaIIwpeaNmzY8H8AcGCSQDK+xIbAshEjRhyWJJIkhiB8Erder3MaGk7GZlp+EbirWCwenZQzXIkgSLVaLdRqtV8h4gn5nRcm8j4I3FQsFk9Nwq57IgiiteZj6uY0bjgceYCIbrAsa1mhUHiw70HBarW6Q6PReDcRvR8ApgPAXuGYjETLHCEE+9jS1nKCaK1nAsBFLUUh/cZ5T+HHRHRNZ2fng27D0Vp/mIguRsQPuO0Ts9zXhRDfiNnmG8y1lCC2bU8mosTvprZygIayTUQPFQqFKR0dHfcPJdvfv8+aNcvaZ599PkVE3wGAbf3oiLIPL/VXKpX5UdoYTHfLCMI3AAHgDkQstSr4tNslolt7e3snhbF/0N3d/RHHcTipdaKO8xAR1z05plU3FFtCEK3124iIa1e8Je2TtFX+E9HP29vbRZjlDGzbPp31tiqmgewS0XOlUunAcrn8ZNy+xU6Q5n0Ovq/8wbiDzYo9Irp7xYoVh8+aNYsztIfalFLfR8RPhao0BGVEtLS9vf3gMH8Q3LgVO0G01lcAwBfdOGdktkaAsxsi4juEEE9Fgc+cOXO2GT58OF+R3TEK/QF1Xi2E+HxAHZ66x0qQrq6uEyzLWujJQyP8BgSI6Awp5dwoYVFKXYWIsU5ED/GcJISIbQ7FRpBqtTq6Vqs9hIjbewDDiL4Rgad23nnnMVG/ZjTLQSxNIvhcVq5UKu1XLpfXxOFfLAThQpda6zsRkVeuTPOJABHNlFJ+02d31934ZEO9XuecuwXXnWIU5IONQogJcRQojYUgSqkvISKvs5sWAIFGo7HXlClTHg6gwnVXrfXfAeAdrjvELEhEX5ZS8vdspC1ygnR3d+/pOM5DADAs0kgyrpyXOqWUsVW/UkrdhYgfSjCsGxuNxviofzAiJQjv0u611173ISKf/TEtGAI3CiFODabCfW+t9Z8A4H3ue8QvSUR/LJVKh0R5qDFSgmitzweAS+OHLnsWiegHUspPxxWZ1vpvADA+LnsB7Py3EOKyAP0H7RoZQTiHFRGtMFnWQxu62PYAmpu5Lyft2MkASG4sFot7RZXeNDKCaK1vAoATQ5seRtFVQohYNlht2z6Ik7ylCPKbhBCTovA3EoLYtn00EaUyF2sUIIehk4h+KaU8LQxdQ+lQSn0eEa8aSi5J/05ER0RxoDF0gjRvB/Yg4h5JAjDtvvCxdillLN8ESql/IOI+acKM8SmVSgeE/cEeOkGUUmch4nVpAjclvjbq9Xr71KlTn47SX631UQDw2yhtRKWbiD4upfxJmPpDJQh/3K1atepfiLhbmE4aXa8h8CUhxJVR4qG15sQZE6K0EZVuInq8vb19zzCP4oRKEPP0iGroX9VLRI9s3Lhx/LRp07geYOgtCycewn6KhEYQ8/QIfb4OpHC2EOLssK1prfl+Dt/TSdSNQq9xhv0UCY0gtm0LTiHpNSAj7x0BIpompfyp957991BK8RJpNyJuE5bOFusRQgg7DB9CI4jWehkAHBCGU0bH4Ag0KzZNlVIG+kHiZH21Wu1riJjY5NE+58JfhRChZOcMhSBpXvnwOQCJ6MYZYRqNxuf8rGxlvWw2ER0lpeQFh0AtFIIopRYh4nGBPDGdfSFARBsQ8WdEdLWUko/2DNiUUnxZjYsRnQEAB/kymJ5Oi4QQxwd1NzBBuBRzvV5/1BS4CToUwfsT0WOIyJkV+XoBp8vhVuJNPyLanzMpIqIV3FIqNFCxWBwb9IxWYIJorS8HgPNSAZlxMm8IfFsI8ZUgQQciSHNpd43JbxVkCEzfqBDgS2bt7e2jg2wcBiKI1roCADqqAI1eg0AICARa8g1KEE5VOTGEIIwKg0BUCNwihPBdVsM3QbgaVG9v73Mmt24k40oA8CIArG0miusFgJEAsD0RjULE7SKxmk2lG0eMGPFWv1WrfBNEKXUmIs7JJqaxR8WbrH9CxKX8x7U9BquwVK1Wt3UcZ3/+4xSuRMRLt4Y0Aw/bmUKIn/kZ1SAEMXsffhB/9dDhBgBYgIi3c8FSPxt9fU3PnTt3RLFY5Doa55jsMf0Oiu89EV8EWbhw4ZtefPFFzhFrShd4I0kPEX2/ra3ter+P/MHMKaW4YtSchKfr8YZYCNJcQqHRaGw/depU/mHy1HwRRGt9MgDc6MlSvoX/DABfE0LcFjUMnGpp77335lffqVHbSpN+IjpZSrnAq8++CKKUmo2In/RqLIfyyxBxZqVS4QQWsbVmhnauOLVvbEYTboiIfiSlnOHVTV8E0VpzIZN2r8byIk9EnB6Unxjz48gf2x+uWutDAYBrzpv26nffE1LKXb2C4ZkgXV1d+1mWtdyroZzIP8sJptvb238cZPc2LKy01py6J+uHEl3D5TjO+M7OTj6n5rp5Joht2
2dzlj/XFnIiSESLEbESVWEbPzAqpc5BxP/10zejfc4WQsz2EptngiilFCIKL0YyLlvn16lKpXJ5q16nBsJXa81pgjiFqGmvvmYpKWWnFzA8E0RrvRoARnsxkmHZZxzHOamzszORWQi7urpGWpb1Qobx9xraKiHELl46eSJI8+7HY14MZFj2nmKxeNpglY74ghIilgFAAgB/NPPxkQuEEN+PCxetNRf69DTOcfnWCjvFYnF3L3dEPAFn2/ZJROR5LbkVQERpk4i+VSqVZg6Uxa9JjK8DAGcfGb6lL0T0binlX6L0kXVzZS/btkOvhBu13xHr91Tj0BNBtNZfBYCLIw4gseqbR0Q4WcIvB3Jy3rx5by8UCr8BgLEDyRDRp6WUkS90zJ07d6disRhJNdzEDtLQjl0ohLhkaLFXJTwRRCnFqWEmu1WeMbnniejogX75+de6u7t7huM4VyDiiMFiJ6KKlLI7any6uro+ZFnWXVHbSZN+Ipovpexw67MngmiteQ05d7uzRPRvAPjoQEkReOd62LBh/OPhJgX/RgDYRQjxrNtB8itn2/ZniOgav/2z2M9rEnCvBOFEAKnOvOdj0Fcg4oRKpbKqv77VarWtXq9zehm35cpiK4Sjtebbnnzr07TXEahXKpVhbpfkXRPEtu2xzV/S3IBNRP9ExEMH+rVvLqPe7na3moheLJVK48rl8vNRg9j8QF8LAG+O2lba9BPRWCmlq9VYLwSZwLvFaQMjgL+ruPjoIE+OXWq12u2IuJ8HG7zEG0vNxmZiuN978C03ooh4ZKVSudNNwK4JorWeBgDXu1GaBRkiOkhK+cf+Ypk3b94+hUKBa2h42XR66pVXXhkbVWb2Lf3UWnOdjOlZGIsIYpguhHB1G9YLQS4CgJkROJs4lYMdjdZaH0BEv/OR6ugTQohYCgvxDcNCofDUUKtpiQM+JoeI6JtSSldz2QtBfggAns/TxxRzmGYGzMjHry0AsBAROYGCl9bT09Oz76xZs2LZtLNt+xNMci8O5kzWdQkJ1wRRSv0CEWMrZN+qAePrmVLKYVvat217OhHxSVDPq3h+b7P5xSCvy/Ee8PqFEOJ0N/JeCPJ7RORf0Mw33s/YfAuQl3FrtdqFiOgrhSURLZVSul0CDoyt1vrDAMAra6YNgAARLZFSHuEGINcEydOvEhGttyzrPMdx2prEeKsbMPuTcRzn0M7Ozrv99vfaz2TaHxoxL5uFXgjyhMdVm6E9zbgEH+yUUnKCi1iaUupdnN09FmPpNvKkEGKMmxC8EITLD+/oRqmR2XSS1ikUCvt2dHT0xIWHUuo2RPxoXPZSbOcZIcRObvx3TRCl1As+Vm/c+JBVmeuEEJ+IKzjbtg8iokRe3IoLA7d2+ESDlNLVCQPXBNFac+nhre42uHUqT3JE9B9EHBvn/XSl1B2IeHSecPYbK4+PlHJbN/29EIQTKpvmDoFLhRAXuBMNLmWeHt4xFEK4mvuuhNi8UqqRo/Jd3hF/vcfzjuOM6+zs5Ou1sTSlVG6W4MMAlL8PpZQFN7q8EOTlDNXRdoONLxki+oKU8n98dfbRyVQY9g5aJK9Y5iPd1UA8uX79+nEzZszYXEDTVacgQiY5nHf0ovpIfwYAfG+YeQ8jlT2mCCG64vK8u7v7I47j/Douexmy86wQwtWWhetXLK212SgcZIYQ0YNSygPinETm6eEbbdf5sbwQ5EEA4IpGpvWDABEdK6WM7ddcKTUREblGpGkeEfDyY+aFIHybcIJHX/Iifo8Q4kNxBquUegAR3xWnzQzZulMIcaSbeLwQ5AYAOM2N0rzJENH7pJRL44rbJPALjPQNQoiPudHihSB5uTDlBrfXZLzmWfKkfABh8/QIjGIkF6ZmISKn0zTtdQQaxWJxr3K5zHmzYmlKqVMR8RexGMuoESK6SEo5y014Xp4guUra4AY8TsompfysG9mwZPJ0LycszLbUQ0TTpJQ/daPfNUGUUkci4u/cKM2DDOfpLZVKu8WR42oznlprzhQ/Pw/4RhljJGl/qtXquHq9/kiUjqdM99eFEFybPJbWrF7LxXByl/o1bIARcVylUnnUjV7XT5DFixcXV69ezUfeXR3ycmM8xTJP1ev1Pf3U3fYbs23bgisk+e1v+r2GQGPnnXfexm0NSdcEYfVKqeUeMwlmclziKl+wGbzm04NvJu6ZSUDjDWq5EML1hrdXguS5/MGmYeT8xKVSiVeuGnGNq1JqKiL+LC57WbbjdVneE0Fs276Qs9JlGUAXsU0WQlRdyIUiUq1WC/V6/Z/m6REKnKwk0gI6kxDxV6G5mjJFfOdbCHGI29T5YYTXTFjHeXZNCwEBr0n8vD5B2onoyRD8TKUKRHxPpVKJLa1O8+nBm5C7phKwBDrdaDTap0yZwpWaXTVPBGl+qD+KiLu70p4toVuEECfEGZJS6pOI6KnwfZz+pc0WET0mpRywdmR/8fghSBciclnj3LRmjqv9Ozo6/h5X0NVqdVi9Xn/YPD1CRbxLCDHFi0bPBLFt+2wiirxCq5cgYpCdK4Q4IwY7r5nQWn8aAK6N02YObJ0thPD0RPZMkO7u7n0dx+FinnlphIh7uN15DQOU5tODS4SNDkOf0fEqAo7jjO/s7PQ0dz0TpPkdshIRXeU2zcDguE6VH1asSqlzEfG7YekzejYh4PqabV+8/BJkNiJ+MifA7y+EWB5XrFxSevjw4bxyZZ4eIYI+WNWwwcz4Ioht26cQ0S9D9D+pqhYJIY6P0zmt9RcA4Mo4bebE1ilCCM97eL4IwjXwisUilzLeqhJTlsCOe9+Dnx7Dhg17wkf9wyzBHnosXDVs5MiRo0488cSXvCr3RRA2orW+GQBi/XX1GlxA+d8JIWJNBq21Pg8ALvfrNxFxoZ57AWCaIdkbUPS9h+WbIEqpMxHRVSldvwPeyn5ejyQE9bVZmfYxPxOb92kQ8fJKpfJVPgbTTGbNRPE9vkHjSVj/M4UQvg57+gZwwYIF223YsGFtFu+HENHDK1as2CeuqrTNlcFvIOLXvE4sIuLCRh+TUi7p21drzXXcj/KqL4PyjREjRmw/adKk9X5i802Q5qAuQsTj/BhOeJ/YapozDtVqdcdarfZvH3XNlyHixEqlsmpLPHPwCuxqChHRrVLKia6E+xEKRJCM3pF+Yf369TvGmYBaKfVdRDzX4yD+wXGcj/RXZqH5sf+UqQi2CdFA1xMCEWT27Nml7bbbjn+9MpPUmoi+J6X8nMfJ6lu8q6trDCI+goglt0qI6I6NGzeeOG3aNL4CvVXzSTi35lMjR0TPtbe3j3Z7vba/wAIRpPmadZnfGuJJRNqyrPd2dHTcH5dvWmuuJfJfHuzN7enpmTbQ95FS6hhE/I0HfZkVJaLLpZTnBwkwDILsjoi88xtYV5BAwuhLRI9IKWO7971o0aLha9eufdrNqxCvVAHA56WU3xsoVqXUHojI5HZVoDIMzBKsg4rF4thyufx4EB9DmdRZ+SBExFmVSuWiIIB66evhrnkvEU2WUi4ahBz8Q8X7ILt48SGrskR0s5TyxKDxhUKQrCSVsyzrXR0dHcuCguq2v9Z6yITgRPQ41z4XQvxjIL3d3d17Oo7ze0OO1xHykhxusPEKhSDNb5G0p+P3ddrTLRm2lCMitG2b95EGfB0ioj/V6/XjzjjjjOcGsqO1fgcRcRHPnfz6ksF+fxVCHBhGXGESRCJibOXHwgi+rw4iulZKeU7YegfSV61Wd6jX6/1O/ObO+LfXr18/c7DlZqXUBwDg14g4Ki6/02CHb7xWKhUdhq+hEYQzL65aterhFN9X93XaM8ggaK05nc/em3U0iXGLZVlfGep6L69WAcBCU3n4jSPAr6QrVqwYF9YpiNAIwm5qrdOcAX60EOKpIBPea1+t9XgA4Dxj2yPinYVC4bpyuTxk1hilVEfzaW3SwG4N+nQhRGhnBEMlSIqfIr1CiO28TvC45avV6rb1ep33TWbEbTsN9vjp0d7evmeQj
cEt4wyVIM2P9bMQ8bo0ANrHx2VCiETX++vq6nonIv4cEfdJGbaxuUtEH5dShppkL3SCcLKzWq32D0R8e2zIBDf0ByHEwcHVhK+Bn8pr1qw533GcmV6Oo4TvSbI1EtFDpVLpgLBzJodOEIYxhQXu7xJCHJa0KcBPDcuy5gFAKEuWSYsvTH+I6Igtj/yHoT8SgjRftXiFJdZMhAEAWSmE2C1A/1C7Lly48E3r16/nepBfzOJ9m1DBelXZQiHESRHoje781Lx5895eKBS4ItLwKBwPW2exWBxVLpdfCFuvV31aaz4ewQnjTD5ed+C90mg09p8yZQpnoQy9RfYEYU+11nyS8tLQvY5AIRHNkFL+KALVrlRqrQ8lou8gYiK/hVwF0Rqh/xZCXBaV6UgJ0sxOvjQN79BEdL+U8r1RAT2Q3q6uroP5kCSft4rbdgbs/bWnp+fdYW0K9odHpARhg11dXftZlsUlAxKfIoiIviylvCKOiWOIERjljc3DpZEmFI+cIM1XLf7YjGXiBYS9DgBThRB2QD39dq9Wq2+u1+unsg0AmBCFjbzojOvHLBaCNE+uLgaAI9IwgER0RalUmlkul18O6m8zlSivsFQAgJMHJP5JGjTmqPsT0RIpZSxzKRaCMGDz5s3b2bIsrpK7fdQAhqSfz2VdRUR3lkqlpV42oJRSHOPhnI4HEScBQFtIPuVeDRGtLZVK+5XL5TVxgBEbQZqvWryEeVMcgYVpg4heQkRebLiPiFYj4vOO4zxnWdYriLgDHzZ0HGdHANgPEd9vCm6Gif5Wuk4SQiyM1EIf5bESpEkSTszMCZpNMwh4ReBKIcSXvHYKIh87QZonfu9p/tIG8d30zRECRLS0vb394DBP6rqBL3aCsFPVanWXWq3GWQHf4sZJI5NvBDi/ValUOtDNXZmwkWoJQTgI27YnOI5zuzmhGvaQZksfly5AxA8LITgpReytZQRpkkQQkYo9amMwNQggYkelUpnfKodbShAOWin1NUT8RqsAMHaTiwARzZRS8pXklrWWE4Qj11rzLbDpLUPBGE4iAtcLIc5qtWOJIEjzUCNXrDq21YAY+61HgLMilkqlk71szkbldSIIwsE1j2Rw0uVDowrW6E0FAvcUi8Ujy+XyxiR4mxiCMBhctaq3t3cJIiY6gUISBi6LPhDRX9ra2g73Ww0qCkwSRZA+JLkZEfksk2k5QYBrnrS1tZ2aJHIw9IkjCDvFhXna2trmcArJnMyPXIfJS/2lUumMJHxzbDkQiSTIZie11hcDwFdzPXuyH/wlQogLkxpmognCoCmlzkFELhqTeF+TOsgJ9YuI6Fwp5TUJ9W+TW6mYdM1ctJwfqphkMI1vrhGoE9EUKWW36x4tEkwFQRgbrTXvkTCgprxYiyZLSGY5tVKHEOK2kPRFqiY1BGEUbNve1XGcqkmNE+mciEw5Ed1nWVa5UqmsjMxIyIpTRRCOvXmf5GJEPC8tr4ghj1ka1REAXF4sFi9M4krVYICmjiCbg1FKcR6pblNdKfF8eYGITpdS3pF4T/txMLUEaa5wcWXXBWlITJfGyRHUZyJ6sFQqnRC0FHNQP4L0TzVBOPBmrfFrEbHlJz+DDEQG+84ZNWrUpyZOnPhKmmNLPUH6vHIdjojXm4wiLZ+O/yKi6VGUImhFZJkhCINXrVaH1et1Tph9QVqyyrdi0KOwSUT/QcRLi8XiZUk5iRtGnJkiSJ+nyR6IeDUAcB4u0yJGgO9vAMA5UsrHIjYVu/pMEqTvShci/hAAxsaObA4MEtFjlmWdValUfpvVcDNNkM0f8evWrTuLiM5LcQ33RM0/JgYifnvUqFE/SftH+FDAZp4gmwFoFhc9tbnB+L6hgDH/vjUCRPRHRLyyp6fnhihrciQJ+9wQpC/otm0fTUSzzPVe11PxLi7yk+VXqYGQyCVB+nyjHAMA3zRnu/qfHkR0NwDMSusuuGv6DyKYa4JsxqW7u/s9juNwUZspAMDZ2vPcnuHD05Zlze3o6Lg/z0Bw7IYgfWYAH4R88sknj7UsizM+noKI2+RhgjT3MG50HEcPGzbs1rQdKIxyjAxBBkC3q6trpGVZpwFAJxFNQEQryoGIWzcROYh4J5eRLBaLPy+Xy71x+5AGe4YgLkapWq3uWKvVjkPE44noWEQc6aJbEkX4ZC0nDL8FAG4RQjybRCeT5JMhiMfR4NewNWvWfNBxnMMQ8ZDmSlgibzkS0ToAuBcR70bEJaNHj7437voaHuFNnLghSMAh4QKl8+fPH99oNA5ExP0BYDwRjUfEcTF+43EChEcR8W8AsJz/LMv6y+TJk7kmJF9WMs0nAoYgPoEbqhsfnKzVamMAYIxlWWOIaHciakfETf9f8+9tLkjEE5wLij7Bf0S06T/5DxH5f6/s7e1dOWPGjNpQPpl/946AIYh3zEyPHCFgCJKjwTahekfAEMQ7ZqZHjhAwBMnRYJtQvSNgCOIdM9MjRwgYguRosE2o3hEwBPGOmemRIwQMQXI02CZU7wgYgnjHzPTIEQKGIDkabBOqdwT+H2yVV24xe7jFAAAAAElFTkSuQmCC';
    OPEN MESSAGEINFO FOR
    SELECT
    '' AS aboutphone,
    '' AS aboutdescription,
    '20px' AS lineheight,
     a AS lefticon,
    'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAKb0lEQVR4Xu2dv4ul1RnHzxmWGS6kmdtYxGLDWlikiI0mpAoLiiKsYLyJzeiAm/dNBkK6NAkZ0sTOQpb7vnsXEm2yJEZsrDbFElZd3SaQNmVg5g9IwMjc+4ZrZmEd58d7nvOc857zno+tz49zPt/z4e4dZ9Ea/oEABM4kYGEDAQicTQBBeB0QOIcAgvA8IIAgvAEIyAjwCSLjRlchBBCkkKC5powAgsi40VUIAQQpJGiuKSOAIDJudBVCAEEKCZprygggiIwbXYUQQJBCguaaMgIIIuNGVyEEEKSQoLmmjACCyLjRVQgBBCkkaK4pI4AgMm50FUKgSEEWi8Xjq9Vqxxiz2XXdf5fL5e/39vYOC8mcazoQKE6Qtm0Xxpg3TjLquu7tuq5/7sCO0gIIFCVI0zQfWGuvnZVr13Xv1XX9SgG5c8WeBIoRpGmaX1pr37yIC5JcRKisf1+EILdu3ZoeHR39y1o76RMvkvShVEZNEYI0TbNjrX3HJVIkcaE13toiBGnb9tfGmN+6xogkrsTGV1+KIL8wxrwljO8vVVX9UNhLW+YEihBksVh8d7VafeKR1Yfb29vXZrPZ0mMGrRkSKEKQdS5N0/zDWvttj4yQxANerq3FCDKfzy9vbGz81RhzRRpW13Xv13X9srSfvvwIFCPIOprFYvHYarW6Z4x5wiMqPkk84OXWWpQgSJLb8xz+vMUJgiTDP7qcTlCkIEiS0xMd9qzFCoIkwz68XLYXLQiS5PJMhztn8YIgyXCPL4fNCHKcEj8CzuG5xj8jgjzCHEniP8DUNyLIiYSQJPUnG/d8CHIKby1JDg4OXtrf3z+KGynbNAkgyBk0NSTpuu7O4eHhC0ii+WTjzkKQc3gjSdzHmOI2BLkgFSRJ8dnGOxOC9GCNJD0gjbQEQXoGiyQ9QY2sDEEcAkUSB1gjKUUQxyCRxBFY5uUIIggQSQTQMm1BEGFwSCIEl1kbgngEhiQe8DJpRRDPoJDEE2Di7QiiEBCSKEBMdASCKAWDJEogExuDIIqBIIkizERGIYhyEFqSTKfTF2ez2RfKx2OcIwEEcQTWp1xJkrvT6fQ5JOlDPFwNggRiiySBwEYeiyABgSNJQLiRRiNIYNBIEhhw4PEIEhjwejySRIAcaAWCBAJ7ciySRAKtvAZBlIGeNw5JIsJWWoUgSiD7jkGSvqTSqEOQAXJAkgGgC1ciiBCcbxuS+BKM048gcTifugVJBoTfczWC9AQVqgxJQpHVmYsgOhy9piCJF76gzQgSFG//4UjSn1XMSgSJSfuCXVqSbG1tPb+7u/t5QlfL9igIklh0GpIYYz7e3Ny8iiT+4SKIP0P1CUiijlQ8EEHE6MI2riVZLpf3rbWXPTbxSeIBb92KIJ4AQ7bP5/NvWmvvIUlIyufPRpDh2PfajCS9MAUrQpBgaPUGI4keS9dJCOJKbKB6JBkGPIIMw120FUlE2LyaEMQLX/xmJInLHEHi8lbZhiQqGHsNQZBemNIrQpI4mSBIHM5BtiBJEKxfGYog4RkH3YAkQfHyX9LD4o0zHUnCceYTJBzbqJO1JJlMJs/u7Oz8J+rhE16GIAmH43o0JUkeTCaTHyDJ/+kjiOsrTLweSXQDQhBdnklMQxK9GBBEj2VSk5BEJw4E0eGY5BQk8Y8FQfwZJj0BSfziQRA/fll0I4k8JgSRs8uqE0lkcSGIjFuWXUjiHhuCuDPLugNJ3OJDEDdeo6heLBaPr1arvxljviW9UNd1ny2Xy6t7e3v/ls7IoQ9BckgpwBmVJHmvrutXAhwvmZEIkkwU8Q+iJMmzdV3fiX/6OBsRJA7nZLcoSHK7qqpXk72g58EQxBPgGNo9v7j/vaqqp8bA4bQ7IMhYk3W4l6cgD6qqetphXValCJJVXPqH9ZTDdF3X1HX9U/2TpTERQdLIYZBTHH//uGuMuSI9wMbGxveuX79+X9qfeh+CpJ5QoPNpyNF13bt1Xb8W6IhJjEWQJGKIewgNOYwxn04mk6tj/6u5CBL3bQ6+zfc7x/EFivl76wgy+JONdwDkcGeNIO7MsuxADllsCCLjllUXcsjjQhA5uyw6kcMvJgTx45d0N3L4x4Mg/gyTnIAcOrEgiA7HpKYgh14cCKLHMolJyKEbA4Lo8hx0GnLo40cQfaaDTESOMNgRJAzXqFOV5PiY/zfI12NDkKhPWX+Zlhybm5tXd3d3P9c/Yd4TESTj/JAjfHgIEp5xkA3IEQTr14YiSBzOqluQQxXnucMQJB5rlU3IoYKx9xAE6Y1q+ELkiJ8BgsRnLtqIHCJs3k0I4o0w/ADkCM/4rA0IMhz7XpuRoxemYEUIEgyt/2Dk8GfoOwFBfAkG6keOQGAdxyKII7AY5cgRg3K/HQjSj1O0KuSIhrrXIgTphSlOkYYcXdfd3draep5fPNTJDEF0OHpP0ZJjOp0+N5vNvvA+EAO+JIAgCTwE5EgghDOOgCADZ4McAwdwwXoEGTCfxWLx2HK5vG+tvSw9xvo7B3+sktK7uA9BLmYUpGItx2q1umeMeUK6ADmk5Pr3IUh/VmqVyKGGMvggBAmO+KsLkCMycM91COIJ0KUdOVxopVGLIJFyQI5IoJXXIIgy0NPGIUcEyIFWIEggsA/HIkdgwIHHI0hAwMgREG6k0QgSCLSSHHem0+mL/G5VoJB6jEWQHpBcS7TkODw8fGF/f//IdT/1egQQRI/ll5OQQxnowOMQRDEA5FCEmcgoBFEKAjmUQCY2BkEUAkEOBYiJjkAQz2CQwxNg4u0I4hEQcnjAy6QVQYRBIYcQXGZtCCIIDDkE0DJtQRDH4JDDEVjm5QjiECByOMAaSSmC9AwSOXqCGlkZgvQIFDl6QBppCYJcEKyGHMaYDw8ODl7iFw/zswhBzslMS47t7e1rs9lsmd/z4MQIcsYbQA7kWBNAkFPeAXIgx0MCCHLiLSAHcjxKAEEeoYEcyHGSAIIcE0EO5DiNAIIo/TXZ9Y9y+WnV+CQrXhA+Ocb3qDVvVLQgyKH5lMY5q1hBkGOcD1r7VkUKghzaz2i884oTBDnG+5hD3KwoQZAjxBMa98xiBLlx48Y3Ll269MAY86RHpH+uqmrm0U9rZgSKEaRt2z8YY17zyAc5PODl2lqEIG3bXjHG/NMjJOTwgJdzaxGCNE3zM2vtDUlQXdf9qa7rH0l66cmfQBGCtG27b4z5jSAuPjkE0MbUUoQgTdP8xFrbOgaHHI7AxlhehCCu30H4Y9UYn7rsTkUIskbTtu1tY0yf7xK3q6p6VYaTrrERKEaQY0n+aIz58TkhvlNV1etjC5n7yAkUJcga082bN1/uuu5XxpjvPMTWdd1n1trfVVX1gRwlnWMkUJwgD0Ocz+fft9Y+Y639qKqqT8cYLnfyJ1CsIP7omFACAQQpIWXuKCaAIGJ0NJZAAEFKSJk7igkgiBgdjSUQQJASUuaOYgIIIkZHYwkEEKSElLmjmACCiNHRWAIBBCkhZe4oJoAgYnQ0lkAAQUpImTuKCSCIGB2NJRBAkBJS5o5iAggiRkdjCQQQpISUuaOYAIKI0dFYAgEEKSFl7igm8D/F3QsjHGil9QAAAABJRU5ErkJggg==' AS righttext,
    '岗位切换' AS describe,
    'Link' AS itemtype,
    '' AS beforewarningmsg,
    '' msgtitle,
    'pom-station-list' dataurl
FROM
    dual
UNION ALL
SELECT
    '' AS aboutphone,
    '' AS aboutdescription,
    '20px' AS lineheight,
     b AS lefticon,
    'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAKb0lEQVR4Xu2dv4ul1RnHzxmWGS6kmdtYxGLDWlikiI0mpAoLiiKsYLyJzeiAm/dNBkK6NAkZ0sTOQpb7vnsXEm2yJEZsrDbFElZd3SaQNmVg5g9IwMjc+4ZrZmEd58d7nvOc857zno+tz49zPt/z4e4dZ9Ea/oEABM4kYGEDAQicTQBBeB0QOIcAgvA8IIAgvAEIyAjwCSLjRlchBBCkkKC5powAgsi40VUIAQQpJGiuKSOAIDJudBVCAEEKCZprygggiIwbXYUQQJBCguaaMgIIIuNGVyEEEKSQoLmmjACCyLjRVQgBBCkkaK4pI4AgMm50FUKgSEEWi8Xjq9Vqxxiz2XXdf5fL5e/39vYOC8mcazoQKE6Qtm0Xxpg3TjLquu7tuq5/7sCO0gIIFCVI0zQfWGuvnZVr13Xv1XX9SgG5c8WeBIoRpGmaX1pr37yIC5JcRKisf1+EILdu3ZoeHR39y1o76RMvkvShVEZNEYI0TbNjrX3HJVIkcaE13toiBGnb9tfGmN+6xogkrsTGV1+KIL8wxrwljO8vVVX9UNhLW+YEihBksVh8d7VafeKR1Yfb29vXZrPZ0mMGrRkSKEKQdS5N0/zDWvttj4yQxANerq3FCDKfzy9vbGz81RhzRRpW13Xv13X9srSfvvwIFCPIOprFYvHYarW6Z4x5wiMqPkk84OXWWpQgSJLb8xz+vMUJgiTDP7qcTlCkIEiS0xMd9qzFCoIkwz68XLYXLQiS5PJMhztn8YIgyXCPL4fNCHKcEj8CzuG5xj8jgjzCHEniP8DUNyLIiYSQJPUnG/d8CHIKby1JDg4OXtrf3z+KGynbNAkgyBk0NSTpuu7O4eHhC0ii+WTjzkKQc3gjSdzHmOI2BLkgFSRJ8dnGOxOC9GCNJD0gjbQEQXoGiyQ9QY2sDEEcAkUSB1gjKUUQxyCRxBFY5uUIIggQSQTQMm1BEGFwSCIEl1kbgngEhiQe8DJpRRDPoJDEE2Di7QiiEBCSKEBMdASCKAWDJEogExuDIIqBIIkizERGIYhyEFqSTKfTF2ez2RfKx2OcIwEEcQTWp1xJkrvT6fQ5JOlDPFwNggRiiySBwEYeiyABgSNJQLiRRiNIYNBIEhhw4PEIEhjwejySRIAcaAWCBAJ7ciySRAKtvAZBlIGeNw5JIsJWWoUgSiD7jkGSvqTSqEOQAXJAkgGgC1ciiBCcbxuS+BKM048gcTifugVJBoTfczWC9AQVqgxJQpHVmYsgOhy9piCJF76gzQgSFG//4UjSn1XMSgSJSfuCXVqSbG1tPb+7u/t5QlfL9igIklh0GpIYYz7e3Ny8iiT+4SKIP0P1CUiijlQ8EEHE6MI2riVZLpf3rbWXPTbxSeIBb92KIJ4AQ7bP5/NvWmvvIUlIyufPRpDh2PfajCS9MAUrQpBgaPUGI4keS9dJCOJKbKB6JBkGPIIMw120FUlE2LyaEMQLX/xmJInLHEHi8lbZhiQqGHsNQZBemNIrQpI4mSBIHM5BtiBJEKxfGYog4RkH3YAkQfHyX9LD4o0zHUnCceYTJBzbqJO1JJlMJs/u7Oz8J+rhE16GIAmH43o0JUkeTCaTHyDJ/+kjiOsrTLweSXQDQhBdnklMQxK9GBBEj2VSk5BEJw4E0eGY5BQk8Y8FQfwZJj0BSfziQRA/fll0I4k8JgSRs8uqE0lkcSGIjFuWXUjiHhuCuDPLugNJ3OJDEDdeo6heLBaPr1arvxljviW9UNd1ny2Xy6t7e3v/ls7IoQ9BckgpwBmVJHmvrutXAhwvmZEIkkwU8Q+iJMmzdV3fiX/6OBsRJA7nZLcoSHK7qqpXk72g58EQxBPgGNo9v7j/vaqqp8bA4bQ7IMhYk3W4l6cgD6qqetphXValCJJVXPqH9ZTDdF3X1HX9U/2TpTERQdLIYZBTHH//uGuMuSI9wMbGxveuX79+X9qfeh+CpJ5QoPNpyNF13bt1Xb8W6IhJjEWQJGKIewgNOYwxn04mk6tj/6u5CBL3bQ6+zfc7x/EFivl76wgy+JONdwDkcGeNIO7MsuxADllsCCLjllUXcsjjQhA5uyw6kcMvJgTx45d0N3L4x4Mg/gyTnIAcOrEgiA7HpKYgh14cCKLHMolJyKEbA4Lo8hx0GnLo40cQfaaDTESOMNgRJAzXqFOV5PiY/zfI12NDkKhPWX+Zlhybm5tXd3d3P9c/Yd4TESTj/JAjfHgIEp5xkA3IEQTr14YiSBzOqluQQxXnucMQJB5rlU3IoYKx9xAE6Y1q+ELkiJ8BgsRnLtqIHCJs3k0I4o0w/ADkCM/4rA0IMhz7XpuRoxemYEUIEgyt/2Dk8GfoOwFBfAkG6keOQGAdxyKII7AY5cgRg3K/HQjSj1O0KuSIhrrXIgTphSlOkYYcXdfd3draep5fPNTJDEF0OHpP0ZJjOp0+N5vNvvA+EAO+JIAgCTwE5EgghDOOgCADZ4McAwdwwXoEGTCfxWLx2HK5vG+tvSw9xvo7B3+sktK7uA9BLmYUpGItx2q1umeMeUK6ADmk5Pr3IUh/VmqVyKGGMvggBAmO+KsLkCMycM91COIJ0KUdOVxopVGLIJFyQI5IoJXXIIgy0NPGIUcEyIFWIEggsA/HIkdgwIHHI0hAwMgREG6k0QgSCLSSHHem0+mL/G5VoJB6jEWQHpBcS7TkODw8fGF/f//IdT/1egQQRI/ll5OQQxnowOMQRDEA5FCEmcgoBFEKAjmUQCY2BkEUAkEOBYiJjkAQz2CQwxNg4u0I4hEQcnjAy6QVQYRBIYcQXGZtCCIIDDkE0DJtQRDH4JDDEVjm5QjiECByOMAaSSmC9AwSOXqCGlkZgvQIFDl6QBppCYJcEKyGHMaYDw8ODl7iFw/zswhBzslMS47t7e1rs9lsmd/z4MQIcsYbQA7kWBNAkFPeAXIgx0MCCHLiLSAHcjxKAEEeoYEcyHGSAIIcE0EO5DiNAIIo/TXZ9Y9y+WnV+CQrXhA+Ocb3qDVvVLQgyKH5lMY5q1hBkGOcD1r7VkUKghzaz2i884oTBDnG+5hD3KwoQZAjxBMa98xiBLlx48Y3Ll269MAY86RHpH+uqmrm0U9rZgSKEaRt2z8YY17zyAc5PODl2lqEIG3bXjHG/NMjJOTwgJdzaxGCNE3zM2vtDUlQXdf9qa7rH0l66cmfQBGCtG27b4z5jSAuPjkE0MbUUoQgTdP8xFrbOgaHHI7AxlhehCCu30H4Y9UYn7rsTkUIskbTtu1tY0yf7xK3q6p6VYaTrrERKEaQY0n+aIz58TkhvlNV1etjC5n7yAkUJcga082bN1/uuu5XxpjvPMTWdd1n1trfVVX1gRwlnWMkUJwgD0Ocz+fft9Y+Y639qKqqT8cYLnfyJ1CsIP7omFACAQQpIWXuKCaAIGJ0NJZAAEFKSJk7igkgiBgdjSUQQJASUuaOYgIIIkZHYwkEEKSElLmjmACCiNHRWAIBBCkhZe4oJoAgYnQ0lkAAQUpImTuKCSCIGB2NJRBAkBJS5o5iAggiRkdjCQQQpISUuaOYAIKI0dFYAgEEKSFl7igm8D/F3QsjHGil9QAAAABJRU5ErkJggg==' AS righttext,
    '帮助中心' AS describe,
    'Link' AS itemtype,
    '' AS beforewarningmsg,
    '' msgtitle,
    'question-list' dataurl
FROM
    dual
UNION ALL
SELECT
    '18590769090' AS aboutphone,
    '系统名称：计划运营管理系统</br>服务顾问：王传科</br>咨询电话：185-9076-9090' AS aboutdescription,
    '20px' AS lineheight,
     c AS lefticon,
    '' AS righttext,
    '关于我们' AS describe,
    'Info' AS itemtype,
    '' AS beforewarningmsg,
    '' msgtitle,
    '' dataurl
FROM
    dual;
END P_POM_MOBILE_CENTER_MESSAGE;
/

prompt
prompt Creating procedure P_POM_MOBILE_DELAY_NODE
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_mobile_delay_node (
    currentuserid IN VARCHAR2,
    currentstationid IN VARCHAR2,
    currentdeptid IN VARCHAR2,
    currentcompanyid IN VARCHAR2,
    bizcode IN VARCHAR2,
    plantype       IN             VARCHAR2,
    orgid          IN             VARCHAR2,
    title          OUT            VARCHAR2,
    pageindex     IN            INT,
    pagesizes     IN            INT,
    titleicon      OUT            VARCHAR2,
    currentdelay   OUT            SYS_REFCURSOR
) IS
    v_spid              VARCHAR2(200);
    --关键节点计划监控-当前延误节点
    --作者：鲜晓勇
    --日期：2020/03/20
BEGIN
    title := '当前延误节点';
    --图标库地址 https://element.eleme.cn/#/zh-CN/component/icon
    titleicon := 'el-icon-tickets';
    --调用数据权限验证存储过程
    P_SYS_AUTH_DATA_RULE_SPID(
            USERID => currentuserid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
    OPEN CURRENTDELAY FOR
        SELECT t.* from
           (
              select t1.*,rownum as rowno from (
                SELECT DISTINCT
                    '已超期' as "nodeStatus",
                    B2.PLAN_END_DATE AS "nodeTime",
                    B2.ORIGINAL_PLAN_ID as "nodeOriginalId",
                    plantype as "nodePlanType",
                    A.ORG_NAME AS "orgName",
                    B2.PROJECTSTAGE_NAME AS "projName",
                    '【'||B2.PROJECTSTAGE_NAME||'】'||B2.NODE_NAME AS "nodeName",
                    NODE_ID as "nodeId",
                    ORIGINAL_NODE_ID as "nodeOriginId",
                    '' AS "projOpenUrl",
                    '' AS "nodeOpenUrl",
                    '已延期'
                        ||TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd'))
                        ||'天' 			AS "delayDays",
                    TO_NUMBER(nvl(TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd')),0)) as days
                FROM   SYS_BUSINESS_UNIT A
                        LEFT   JOIN
                    (
                            SELECT LEVEL, ORG_NAME, CONNECT_BY_ROOT ID AS ID,
                               CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
                               B.UNIT_ID, B.NODE_NAME, B.NODE_ID,
                               B.ACTUAL_END_DATE, B.PLAN_END_DATE,
                               B.PROJECTSTAGE_NAME, B.PPID, B.PID,
                               'TYPE_ORG' AS CTYPE, B.ESTIMATE_END_DATE,
                               B.PLANID, ORIGINAL_NODE_ID,B.COMPANY_ID,
                               B.PROJ_ID,
                               B.STAGE_PROJECT_ID,
                               B.STAGE_ID,
                               ORIGINAL_PLAN_ID
                        FROM   SYS_BUSINESS_UNIT A
                                LEFT   JOIN
                            (
                                    SELECT B1.UNIT_ID,
                                           A.ID AS PLANID,
                                           A.COMPANY_ID,
                                           A.PROJ_ID,
                                           C1.PROJECT_ID AS STAGE_PROJECT_ID,
                                           C1.ID as STAGE_ID,
                                           B1.ID AS PPID, B1.ID AS PID,
                                           A1.ORIGINAL_NODE_ID,
                                           A1.ORIGINAL_PLAN_ID,
                                           A.PROJ_NAME AS PROJECTSTAGE_NAME,
                                           A1.NODE_NAME, A1.ID AS NODE_ID,
                                           A1.ACTUAL_END_DATE,
                                           A1.PLAN_END_DATE,
                                           A1.ESTIMATE_END_DATE
                                    FROM   POM_PROJ_PLAN A
                                                INNER  JOIN POM_PROJ_PLAN_NODE A1
                                                    ON     A.ID = A1.PROJ_PLAN_ID AND A1.IS_DISABLE=0
                                                INNER  JOIN SYS_PROJECT_STAGE C1
                                                    ON     A.PROJ_ID = C1.ID
                                                INNER  JOIN SYS_PROJECT B1
                                                     ON    C1.PROJECT_ID = B1.ID  WHERE  A.PLAN_TYPE = plantype
                                                        AND A.APPROVAL_STATUS = '已审核'
                                                        AND TRUNC(SYSDATE, 'dd') -TRUNC(PLAN_END_DATE, 'dd') > 0
                                                        AND ACTUAL_END_DATE IS NULL
                             ) B
                                    ON A.ID = B.UNIT_ID WHERE  ORG_TYPE = 0
                                        START  WITH ID = ORGID
                                        CONNECT BY PRIOR A.ID = A.PARENT_ID) B2
                                             ON     A.ID = B2.ID
                                       LEFT JOIN
                                        (
                                           select DISTINCT org_id AS ogid from  TMP_AUTH_LIST where id = v_spid)  tal
                                            on tal.ogid=B2.STAGE_PROJECT_ID
                            WHERE  NODE_NAME IS NOT NULL AND
                                    tal.ogid is not null AND
                                    ACTUAL_END_DATE IS NULL AND
                                        TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 --分期
                            UNION
                            SELECT DISTINCT
                                '已超期' as "nodeStatus",
                                PLAN_END_DATE AS "nodeTime",
                                A1.ORIGINAL_PLAN_ID as "nodeOriginalId",
                                plantype as "nodePlanType",
                                '' AS "orgName",
                                A.PROJ_NAME AS "projName",
                                '【'||A.PROJ_NAME||'】'||A1.NODE_NAME AS "nodeName",
                                A1.ID as "nodeId",
                                A1.ORIGINAL_NODE_ID as "nodeOriginId",
                                '' AS "projOpenUrl",
                                '' AS "nodeOpenUrl",
                                '已延期'
                                    ||TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd'))
                                    ||'天' 			AS "delayDays",
                                TO_NUMBER(nvl(TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd')),0)) as days

                            FROM   POM_PROJ_PLAN A
                                       INNER  JOIN POM_PROJ_PLAN_NODE A1
                                                   ON     A.ID = A1.PROJ_PLAN_ID AND A1.IS_DISABLE=0
                                       INNER  JOIN SYS_PROJECT_STAGE C1
                                                   ON     A.PROJ_ID = C1.ID
                                       INNER  JOIN SYS_PROJECT B1
                                                   ON     C1.PROJECT_ID = B1.ID
                                       LEFT JOIN (select DISTINCT org_id AS ogid from  TMP_AUTH_LIST where id = v_spid)  tal
                                                 on tal.ogid=C1.PROJECT_ID or tal.ogid=C1.ID
                            WHERE  A.PLAN_TYPE = plantype AND
                                    A.APPROVAL_STATUS = '已审核'   AND
                                    tal.ogid is not null AND
                                        TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 AND
                                    ACTUAL_END_DATE IS NULL AND
                                    C1.PROJECT_ID = ORGID
                            order by days desc
              ) t1
           )t  where  rownum <=  pageindex * pagesizes AND t.rowno >= pagesizes * ( pageindex - 1 );
END p_pom_mobile_delay_node;
/

prompt
prompt Creating procedure P_POM_MOBILE_DELAY_NODE_MORE
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_mobile_delay_node_more (
    currentuserid IN VARCHAR2,
    currentstationid IN VARCHAR2,
    currentdeptid IN VARCHAR2,
    currentcompanyid IN VARCHAR2,
    bizcode IN VARCHAR2,
    plantype       IN             VARCHAR2,
    orgid          IN             VARCHAR2,
    pageIndex     IN            INT,
    pageRows     IN            INT,
    currentdelay   OUT            SYS_REFCURSOR
) IS
    v_spid              VARCHAR2(200);
    --关键节点计划监控-当前延误节点
    --作者：鲜晓勇
    --日期：2020/03/20
BEGIN

    --调用数据权限验证存储过程
    P_SYS_AUTH_DATA_RULE_SPID(
            USERID => currentuserid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
    );
    OPEN CURRENTDELAY FOR
        SELECT t3.*
        from (
            select t2.*
            from (
                 select
                     t1.*,
                     rownum as rowno
                 from (
                     SELECT DISTINCT
                         '已超期' as "nodeStatus",
                         to_char(B2.PLAN_END_DATE,'yyyy-MM-dd') as "nodeTime",
                         B2.ORIGINAL_PLAN_ID as "planOriginalId",
                         ''||plantype||'' as "nodePlanType",
                         A.ORG_NAME AS "orgName",
                         B2.PROJECTSTAGE_NAME AS "projName",
                         '【'||B2.PROJECTSTAGE_NAME||'】'||B2.NODE_NAME AS "nodeName",
                         NODE_ID as "nodeId",
                         ORIGINAL_NODE_ID as "nodeOriginalId",
                         '' AS "projOpenUrl",
                         '' AS "nodeOpenUrl",
                         '已延期'
                             ||TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd'))
                             ||'天' 			AS "delayDays",
                         TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd')) days
                     FROM SYS_BUSINESS_UNIT A
                     LEFT JOIN (
                         SELECT LEVEL, ORG_NAME, CONNECT_BY_ROOT ID AS ID,
                            CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
                            B.UNIT_ID, B.NODE_NAME, B.NODE_ID,
                            B.ACTUAL_END_DATE, B.PLAN_END_DATE,
                            B.PROJECTSTAGE_NAME, B.PPID, B.PID,
                            'TYPE_ORG' AS CTYPE, B.ESTIMATE_END_DATE,
                            B.PLANID, ORIGINAL_NODE_ID,B.COMPANY_ID,
                            ORIGINAL_PLAN_ID
                         FROM SYS_BUSINESS_UNIT A
                         LEFT JOIN (
                             SELECT B1.UNIT_ID, A.ID AS PLANID,A.COMPANY_ID,
                                 B1.ID AS PPID, B1.ID AS PID,
                                 A1.ORIGINAL_NODE_ID,
                                 A1.ORIGINAL_PLAN_ID,
                                 A.PROJ_NAME AS PROJECTSTAGE_NAME,
                                 A1.NODE_NAME, A1.ID AS NODE_ID,
                                 A1.ACTUAL_END_DATE,
                                 A1.PLAN_END_DATE,
                                 A1.ESTIMATE_END_DATE
                             FROM POM_PROJ_PLAN A
                             INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
                                   AND A.ID = A1.PROJ_PLAN_ID AND A1.IS_DISABLE = 0
                             INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
                             INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID
                             WHERE A.PLAN_TYPE = plantype AND A.APPROVAL_STATUS = '已审核'
                                 AND TRUNC(SYSDATE, 'dd') -TRUNC(PLAN_END_DATE, 'dd') > 0
                                 AND ACTUAL_END_DATE IS NULL
                         ) B  ON A.ID = B.UNIT_ID
                         WHERE  ORG_TYPE = 0
                         START  WITH ID = ORGID
                         CONNECT BY PRIOR A.ID = A.PARENT_ID
                     ) B2 ON A.ID = B2.ID
                     LEFT JOIN (
                         select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = v_spid
                     ) tal on tal.orgid=B2.PLANID or tal.orgid=B2.COMPANY_ID
                     WHERE NODE_NAME IS NOT NULL AND tal.orgid IS NOT NULL AND  ACTUAL_END_DATE IS NULL
                       AND TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0
                     UNION
                     SELECT DISTINCT
                         '已超期' as "nodeStatus",
                         to_char(PLAN_END_DATE,'yyyy-MM-dd') as "nodeTime",
                         A1.ORIGINAL_PLAN_ID as "planOriginalId",
                         ''||plantype||'' as "nodePlanType",
                         '' AS "orgName",
                         A.PROJ_NAME AS "projName",
                         '【'||A.PROJ_NAME||'】'||A1.NODE_NAME AS "nodeName",
                         A1.ID as "nodeId",
                         A1.ORIGINAL_NODE_ID as "nodeOriginalId",
                         '' AS "projOpenUrl",
                         '' AS "nodeOpenUrl",
                         '已延期'
                              ||TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd'))
                              ||'天' 			AS "delayDays",
                          TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd')) days
                      FROM POM_PROJ_PLAN A
                               INNER  JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
                          AND A.ID = A1.PROJ_PLAN_ID AND A1.IS_DISABLE=0
                               INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
                               INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID
                               LEFT JOIN (
                          select DISTINCT org_id AS orgid
                          from  TMP_AUTH_LIST where id = v_spid
                      )  tal on tal.orgid=C1.PROJECT_ID or tal.orgid=A1.COMPANY_ID
                      WHERE A.PLAN_TYPE = plantype AND A.APPROVAL_STATUS = '已审核' AND tal.orgid is not null
                        AND TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0
                        AND ACTUAL_END_DATE IS NULL AND C1.PROJECT_ID = ORGID
                  ) t1 order by days*1 desc
            ) t2 where rowno > pageRows * (pageIndex - 1)
        ) t3
        where t3.rowno <= pageRows * pageIndex;
END p_pom_mobile_delay_node_more;
/

prompt
prompt Creating procedure P_POM_MOBILE_DELAY_NODE_PRED
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_mobile_delay_node_pred (
    plantype       IN             VARCHAR2,
    ctype           IN             INT, ---0 查询 近五天内到期或预计延误   1 查询预计延误  2 查询近五天内到期
    orgid          IN             VARCHAR2,
    pageindex      IN              INT,
    pagesizes      IN              INT,
    userid  IN             VARCHAR2,
    currentstationid  IN          VARCHAR2,
    currentdeptid  IN       VARCHAR2,
    currentcompanyid  IN          VARCHAR2,
    bizcode  IN             VARCHAR2,
    title          OUT            VARCHAR2,
    titleicon      OUT            VARCHAR2,
    predictdelay   OUT            SYS_REFCURSOR
) AS -- 移动端 关键节点计划监控-预计延误节点
		--作者：鲜晓勇
		--日期：2020/03/20
    v_sql   CLOB;
    v_sql_exec CLOB;
    v_caseSql  CLOB;
    v_whereSql CLOB;
    v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN
    title := '预计延误及5天内到期节点';
    titleicon := '';
     IF ctype=0 THEN
    v_whereSql:=' AND (TRUNC(ESTIMATE_END_DATE , ''dd'' ) - TRUNC(PLAN_END_DATE , ''dd'' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, ''dd'' ) - TRUNC( SYSDATE, ''dd'' )  BETWEEN 0 AND 5)
                             AND (TRUNC(SYSDATE , ''dd'' ) - TRUNC(PLAN_END_DATE , ''dd'' ) < 0)
                             ';
    v_caseSql:='
                 CASE
                      WHEN TRUNC(ESTIMATE_END_DATE, ''dd'') - TRUNC(PLAN_END_DATE, ''dd'') > 0 THEN
                          TO_CHAR(TRUNC(ESTIMATE_END_DATE, ''dd'') - TRUNC(PLAN_END_DATE, ''dd''))
                      WHEN TRUNC(SYSDATE, ''dd'') - TRUNC(PLAN_END_DATE) = 0 THEN TO_CHAR(0)
                      ELSE TO_CHAR(TRUNC(PLAN_END_DATE, ''dd'') - TRUNC(SYSDATE, ''dd''))
                      END         AS "days",   
                CASE  WHEN TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ) > 0   THEN
						''预计延误''||TO_CHAR( TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ))||''天'' 
								WHEN  TRUNC(SYSDATE, ''dd'') - TRUNC(PLAN_END_DATE)=0 THEN 
						''今天到期'' 
								ELSE ''余''
																||TO_CHAR(TRUNC(PLAN_END_DATE, ''dd'')-TRUNC(SYSDATE, ''dd''))
																||''天到期'' 	 END				
														AS "delayDays"';
    ELSIF ctype=1 THEN
    v_whereSql:=' AND (TRUNC(ESTIMATE_END_DATE , ''dd'' ) - TRUNC(PLAN_END_DATE , ''dd'' ) > 0 )
                 AND (TRUNC(SYSDATE , ''dd'' ) - TRUNC(PLAN_END_DATE , ''dd'' ) < 0)'
                  ;
    v_caseSql:='
                 CASE  WHEN TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ) > 0   THEN
						TO_CHAR( TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' )) END AS "days",

                CASE  WHEN TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ) > 0   THEN
						''预计延误''||TO_CHAR( TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ))||''天'' END AS "delayDays"';
    ELSE
    v_whereSql:=' AND ( TRUNC( PLAN_END_DATE, ''dd'' ) - TRUNC( SYSDATE, ''dd'' )  BETWEEN 0 AND 5)
                 AND (TRUNC(SYSDATE , ''dd'' ) - TRUNC(PLAN_END_DATE , ''dd'' ) < 0)
    ';
    v_caseSql:='  
                CASE	WHEN  TRUNC(SYSDATE, ''dd'') - TRUNC(PLAN_END_DATE)=0 THEN 
							TO_CHAR(TRUNC(PLAN_END_DATE, ''dd'')-TRUNC(SYSDATE, ''dd''))
                            END	AS "days",
                CASE	WHEN  TRUNC(SYSDATE, ''dd'') - TRUNC(PLAN_END_DATE)=0 THEN 
						''今天到期'' 
								ELSE ''余''
																||TO_CHAR(TRUNC(PLAN_END_DATE, ''dd'')-TRUNC(SYSDATE, ''dd''))
																||''天到期'' 	 END				
														AS "delayDays" 
                                                        ';
    END IF;

    --调用数据权限验证存储过程
    p_sys_auth_data_rule_spid(userid => userid, stationid => currentstationid, deptid => currentdeptid, companyid => currentcompanyid
    , bizcode => bizcode, data_auth_spid => v_spid);

    v_sql:='select t3.* from (
                select rownum as rowno, t2.* from (
                select t1.* from (
                    SELECT DISTINCT
                  ''未完成'' as "nodeStatus",
                  B2.ORIGINAL_PLAN_ID as "planOriginalId",
                  '''||plantype||''' as "nodePlanType",
                  to_char(B2.PLAN_END_DATE,''yyyy-MM-dd'') as "nodeTime",
                  A.ORG_NAME AS "orgName",
                  B2.PROJECTSTAGE_NAME AS "projName",
                  B2.NODE_NAME AS "nodeName",
                  ''【''||B2.PROJECTSTAGE_NAME||''】''||B2.NODE_NAME AS "allNodeName",
                  NODE_ID as "nodeId",
                  ORIGINAL_NODE_ID as "nodeOriginalId",
                  '''' AS "projOpenUrl",
                  '''' AS "nodeOpenUrl",
                  '||v_caseSql||'
                FROM
                  SYS_BUSINESS_UNIT a
                  LEFT JOIN (
                  SELECT LEVEL,
                    ORG_NAME,
                    CONNECT_BY_ROOT ID AS ID,
                    CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
                    B.UNIT_ID,
                    B.COMPANY_ID,
                    B.NODE_NAME,
                    B.ORIGINAL_PLAN_ID,
                    B.NODE_ID,
                    B.STAGE_PROJECT_ID,
                    B.ACTUAL_END_DATE,
                    B.PLAN_END_DATE,
                    B.PROJECTSTAGE_NAME,
                    B.PPID,
                    B.PID,
                    ''TYPE_ORG'' AS CTYPE,
                    B.ESTIMATE_END_DATE,
                    PLANID,
                    ORIGINAL_NODE_ID 
                  FROM
                    SYS_BUSINESS_UNIT A
                    LEFT JOIN (
                    SELECT
                      B1.UNIT_ID,
                      A.ID AS PLANID,
                      A1.ORIGINAL_NODE_ID,
                      A.PROJ_ID AS PPID,
                      C1.PROJECT_ID AS STAGE_PROJECT_ID,
                      B1.ID AS PID,
                       A.PROJ_NAME AS PROJECTSTAGE_NAME,
                       A1.ORIGINAL_PLAN_ID,
                      A1.NODE_NAME,
                      A1.ID AS NODE_ID,
                      A1.ACTUAL_END_DATE,
                      A1.PLAN_END_DATE,
                      A1.ESTIMATE_END_DATE,
                      A.COMPANY_ID
                    FROM
                      POM_PROJ_PLAN A
                      INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID AND A1.IS_DISABLE=0 
                      INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
                      INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
                    WHERE
                      A.PLAN_TYPE = '''||plantype||''' 
                      AND A.APPROVAL_STATUS = ''已审核'' 
                      '||v_whereSql||'
                      AND ACTUAL_END_DATE IS NULL 

                    ) B ON A.ID = B.UNIT_ID 
                  WHERE
                    ORG_TYPE = 0 START WITH ID = ''' || orgId || ''' CONNECT BY PRIOR A.ID = A.PARENT_ID 
                  ) B2 ON A.ID = B2.ID 
                   LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=B2.STAGE_PROJECT_ID or tal.orgid=B2.PPID
                WHERE
                  NODE_NAME IS NOT NULL 
                  AND tal.orgid is not null 
                AND
                  ACTUAL_END_DATE IS NULL 
                        --判断条件
                AND (TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ) > 0  OR 
                                         TRUNC( PLAN_END_DATE, ''dd'' ) - TRUNC( SYSDATE, ''dd'' )  BETWEEN 0 AND 5 --5天内到期
                            )
                        --分期
                UNION ALL
                SELECT DISTINCT
                   ''未完成'' as "nodeStatus",
                  A1.ORIGINAL_PLAN_ID as "planOriginalId",
                  '''||plantype||''' as "nodePlanType",
                     to_char(A1.PLAN_END_DATE,''yyyy-MM-dd'') as "nodeTime",
                  '''' AS "orgName",
                   A.PROJ_NAME AS "projName",
                  A1.NODE_NAME AS "nodeName",
                  ''【''||A.PROJ_NAME||''】''||A1.NODE_NAME AS "allNodeName",
                    A1.ID as "nodeId",
                  A1.ORIGINAL_NODE_ID as "nodeOriginalId",
                  '''' AS "projOpenUrl",
                  '''' AS "nodeOpenUrl",
                '||v_caseSql||'
                FROM
                  POM_PROJ_PLAN A
                  INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID AND A1.IS_DISABLE=0 
                  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
                  INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
                  LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal 
                  on tal.orgid=C1.PROJECT_ID or tal.orgid=A.PROJ_ID
                WHERE
                  A.PLAN_TYPE = '''||plantype||''' 
                  AND A.APPROVAL_STATUS = ''已审核'' 
                  AND tal.orgid is not null
                  ' ||v_whereSql||'
                  AND ACTUAL_END_DATE IS NULL 
                  AND C1.PROJECT_ID = ''' || orgId || '''
                ) t1 order by nvl("days", 0)*1 desc
                ) t2 
                ) t3 where t3.rowno>'||pagesizes * ( pageindex - 1 )||'';
       v_sql_exec := '
select t.* from ( '
                  || v_sql

                  || ' ) t where t.rowno <= '
                  || pagesizes * pageindex
                  || '';
       dbms_output.put_line(v_sql_exec);
   open predictdelay FOR v_sql_exec;
END p_pom_mobile_delay_node_pred;
/

prompt
prompt Creating procedure P_POM_MOBILE_ES_DEL_NODE_MORE
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_mobile_es_del_node_more (
    plantype       IN             VARCHAR2,
    ctype           IN             INT, ---0 查询 近五天内到期或预计延误   1 查询预计延误  2 查询近五天内到期
    orgid          IN             VARCHAR2,
    pageIndex      IN              INT,
    pageRows      IN              INT,
    userid  IN             VARCHAR2,
    currentstationid  IN          VARCHAR2,
    currentdeptid  IN       VARCHAR2,
    currentcompanyid  IN          VARCHAR2,
    bizcode  IN             VARCHAR2,
    predictdelay   OUT            SYS_REFCURSOR
) AS -- 移动端 关键节点计划监控-预计延误节点
		--作者：鲜晓勇
		--日期：2020/03/20
    v_sql   CLOB;
    v_sql_exec CLOB;
    v_caseSql  CLOB;
    v_whereSql CLOB;
    v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN
    IF ctype=0 THEN
    v_whereSql:=' AND (TRUNC(ESTIMATE_END_DATE , ''dd'' ) - TRUNC(PLAN_END_DATE , ''dd'' ) > 0  OR 
							 TRUNC( PLAN_END_DATE, ''dd'' ) - TRUNC( SYSDATE, ''dd'' )  BETWEEN 0 AND 5)
                             AND (TRUNC(SYSDATE , ''dd'' ) - TRUNC(PLAN_END_DATE , ''dd'' ) < 0)
                             ';
    v_caseSql:='
                 CASE
                      WHEN TRUNC(ESTIMATE_END_DATE, ''dd'') - TRUNC(PLAN_END_DATE, ''dd'') > 0 THEN
                          TO_CHAR(TRUNC(ESTIMATE_END_DATE, ''dd'') - TRUNC(PLAN_END_DATE, ''dd''))
                      WHEN TRUNC(SYSDATE, ''dd'') - TRUNC(PLAN_END_DATE) = 0 THEN TO_CHAR(0)
                      ELSE TO_CHAR(TRUNC(PLAN_END_DATE, ''dd'') - TRUNC(SYSDATE, ''dd''))
                      END         AS "days",   
                CASE  WHEN TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ) > 0   THEN
						''预计延误''||TO_CHAR( TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ))||''天'' 
								WHEN  TRUNC(SYSDATE, ''dd'') - TRUNC(PLAN_END_DATE)=0 THEN 
						''今天到期'' 
								ELSE ''余''
																||TO_CHAR(TRUNC(PLAN_END_DATE, ''dd'')-TRUNC(SYSDATE, ''dd''))
																||''天到期'' 	 END				
														AS "delayDays"';
    ELSIF ctype=1 THEN
    v_whereSql:=' AND (TRUNC(ESTIMATE_END_DATE , ''dd'' ) - TRUNC(PLAN_END_DATE , ''dd'' ) > 0 )
                 AND (TRUNC(SYSDATE , ''dd'' ) - TRUNC(PLAN_END_DATE , ''dd'' ) < 0)'
                  ;
    v_caseSql:='
                 CASE  WHEN TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ) > 0   THEN
						TO_CHAR( TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' )) END AS "days",

                CASE  WHEN TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ) > 0   THEN
						''预计延误''||TO_CHAR( TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ))||''天'' END AS "delayDays"';
    ELSE
    v_whereSql:=' AND ( TRUNC( PLAN_END_DATE, ''dd'' ) - TRUNC( SYSDATE, ''dd'' )  BETWEEN 0 AND 5)
                 AND (TRUNC(SYSDATE , ''dd'' ) - TRUNC(PLAN_END_DATE , ''dd'' ) < 0)
    ';
    v_caseSql:='  
                CASE	WHEN  TRUNC(SYSDATE, ''dd'') - TRUNC(PLAN_END_DATE)=0 THEN 
							TO_CHAR(TRUNC(PLAN_END_DATE, ''dd'')-TRUNC(SYSDATE, ''dd''))
                            END	AS "days",
                CASE	WHEN  TRUNC(SYSDATE, ''dd'') - TRUNC(PLAN_END_DATE)=0 THEN 
						''今天到期'' 
								ELSE ''余''
																||TO_CHAR(TRUNC(PLAN_END_DATE, ''dd'')-TRUNC(SYSDATE, ''dd''))
																||''天到期'' 	 END				
														AS "delayDays" 
                                                        ';
    END IF;

    --调用数据权限验证存储过程
    p_sys_auth_data_rule_spid(userid => userid, stationid => currentstationid, deptid => currentdeptid, companyid => currentcompanyid
    , bizcode => bizcode, data_auth_spid => v_spid);

    v_sql:='select t3.* from (
                select rownum as rowno, t2.* from (
                select t1.* from (
                    SELECT DISTINCT
                  ''未完成'' as "nodeStatus",
                  B2.ORIGINAL_PLAN_ID as "planOriginalId",
                  '''||plantype||''' as "nodePlanType",
                  to_char(B2.PLAN_END_DATE,''yyyy-MM-dd'') as "nodeTime",
                  A.ORG_NAME AS "orgName",
                  B2.PROJECTSTAGE_NAME AS "projName",
                  B2.NODE_NAME AS "nodeName",
                  ''【''||B2.PROJECTSTAGE_NAME||''】''||B2.NODE_NAME AS "allNodeName",
                  NODE_ID as "nodeId",
                  ORIGINAL_NODE_ID as "nodeOriginalId",
                  '''' AS "projOpenUrl",
                  '''' AS "nodeOpenUrl",
                  '||v_caseSql||'
                FROM
                  SYS_BUSINESS_UNIT a
                  LEFT JOIN (
                  SELECT LEVEL,
                    ORG_NAME,
                    CONNECT_BY_ROOT ID AS ID,
                    CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
                    B.UNIT_ID,
                    B.COMPANY_ID,
                    B.NODE_NAME,
                    B.ORIGINAL_PLAN_ID,
                    B.NODE_ID,
                    B.STAGE_PROJECT_ID,
                    B.ACTUAL_END_DATE,
                    B.PLAN_END_DATE,
                    B.PROJECTSTAGE_NAME,
                    B.PPID,
                    B.PID,
                    ''TYPE_ORG'' AS CTYPE,
                    B.ESTIMATE_END_DATE,
                    PLANID,
                    ORIGINAL_NODE_ID 
                  FROM
                    SYS_BUSINESS_UNIT A
                    LEFT JOIN (
                    SELECT
                      B1.UNIT_ID,
                      A.ID AS PLANID,
                      A1.ORIGINAL_NODE_ID,
                      A.PROJ_ID AS PPID,
                      C1.PROJECT_ID AS STAGE_PROJECT_ID,
                      B1.ID AS PID,
                       A.PROJ_NAME AS PROJECTSTAGE_NAME,
                       A1.ORIGINAL_PLAN_ID,
                      A1.NODE_NAME,
                      A1.ID AS NODE_ID,
                      A1.ACTUAL_END_DATE,
                      A1.PLAN_END_DATE,
                      A1.ESTIMATE_END_DATE,
                      A.COMPANY_ID
                    FROM
                      POM_PROJ_PLAN A
                      INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID AND A1.IS_DISABLE=0 
                      INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
                      INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
                    WHERE
                      A.PLAN_TYPE = '''||plantype||''' 
                      AND A.APPROVAL_STATUS = ''已审核'' 
                      '||v_whereSql||'
                      AND ACTUAL_END_DATE IS NULL 

                    ) B ON A.ID = B.UNIT_ID 
                  WHERE
                    ORG_TYPE = 0 START WITH ID = ''' || orgId || ''' CONNECT BY PRIOR A.ID = A.PARENT_ID 
                  ) B2 ON A.ID = B2.ID 
                   LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=B2.STAGE_PROJECT_ID or tal.orgid=B2.PPID
                WHERE
                  NODE_NAME IS NOT NULL 
                  AND tal.orgid is not null 
                AND
                  ACTUAL_END_DATE IS NULL 
                        --判断条件
                AND (TRUNC(ESTIMATE_END_DATE, ''dd'' ) - TRUNC(  PLAN_END_DATE, ''dd'' ) > 0  OR 
                                         TRUNC( PLAN_END_DATE, ''dd'' ) - TRUNC( SYSDATE, ''dd'' )  BETWEEN 0 AND 5 --5天内到期
                            )
                        --分期
                UNION ALL
                SELECT DISTINCT
                   ''未完成'' as "nodeStatus",
                  A1.ORIGINAL_PLAN_ID as "planOriginalId",
                  '''||plantype||''' as "nodePlanType",
                     to_char(A1.PLAN_END_DATE,''yyyy-MM-dd'') as "nodeTime",
                  '''' AS "orgName",
                   A.PROJ_NAME AS "projName",
                  A1.NODE_NAME AS "nodeName",
                  ''【''||A.PROJ_NAME||''】''||A1.NODE_NAME AS "allNodeName",
                    A1.ID as "nodeId",
                  A1.ORIGINAL_NODE_ID as "nodeOriginalId",
                  '''' AS "projOpenUrl",
                  '''' AS "nodeOpenUrl",
                '||v_caseSql||'
                FROM
                  POM_PROJ_PLAN A
                  INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID AND A1.IS_DISABLE=0 
                  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
                  INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID 
                  LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal 
                  on tal.orgid=C1.PROJECT_ID or tal.orgid=A.PROJ_ID
                WHERE
                  A.PLAN_TYPE = '''||plantype||''' 
                  AND A.APPROVAL_STATUS = ''已审核'' 
                  AND tal.orgid is not null
                  ' ||v_whereSql||'
                  AND ACTUAL_END_DATE IS NULL 
                  AND C1.PROJECT_ID = ''' || orgId || '''
                ) t1 order by nvl("days", 0)*1 desc
                ) t2 
                ) t3 where t3.rowno>'||pageRows * ( pageIndex - 1 )||'';
       v_sql_exec := '
select t.* from ( '
                  || v_sql

                  || ' ) t where t.rowno <= '
                  || pageRows * pageIndex
                  || '';
       dbms_output.put_line(v_sql_exec);
   open predictdelay FOR v_sql_exec;


END p_pom_mobile_es_del_node_more;
/

prompt
prompt Creating procedure P_POM_MOBILE_HELP_CENTER
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_MOBILE_HELP_CENTER (
    HELPINFO  OUT SYS_REFCURSOR
) IS BEGIN 

    OPEN HELPINFO FOR 
		SELECT
			ID as "id" ,
			Question as "question",
			Answer as "answer",
			System_ID as "systemId",
			Category as "category",
			Usable as "usable",
			Useless as "useless",
			CREATOR_ID as "creatorId",
			CREATED as "created",
			CREATOR as "creator",
			MODIFIER_ID as "modifierId",
			MODIFIER as "modifier",
			MODIFIED as "modified"
		FROM
			POM_FAQ;
END P_POM_MOBILE_HELP_CENTER;
/

prompt
prompt Creating procedure P_POM_MOBILE_HELP_MESSAGE
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_MOBILE_HELP_MESSAGE (
    FAQID POM_FAQ.ID%TYPE,
    HELPINFO  OUT SYS_REFCURSOR
) IS BEGIN 

    OPEN HELPINFO FOR 
		SELECT
			ID as "id" ,
			Question as "question",
			Answer as "answer",
			System_ID as "systemId",
			Category as "category",
			Usable as "usable",
			Useless as "useless",
			CREATOR_ID as "creatorId",
			CREATED as "created",
			CREATOR as "creator",
			MODIFIER_ID as "modifierId",
			MODIFIER as "modifier",
			MODIFIED as "modified"
		FROM
			POM_FAQ
        WHERE
            ID = FAQID;
END P_POM_MOBILE_HELP_MESSAGE;
/

prompt
prompt Creating procedure P_POM_MOBILE_KEY_NODE_RATE
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_MOBILE_KEY_NODE_RATE
(
      ORGID          IN VARCHAR2 := '003200000000000000000000000000'
	 ,DATASCOPE      IN VARCHAR2
	 ,PLANTYPE       IN VARCHAR2
     ,LEVEL_RANK     IN  INT
	 ,COMPLETIONRATE OUT SYS_REFCURSOR
     ,USERID         IN  VARCHAR2
     ,STATIONID      IN  VARCHAR2
     ,DEPTID         IN  VARCHAR2
     ,COMPANYID      IN  VARCHAR2
     ,BIZCODE        IN  VARCHAR2
     ,AUTHORGS       out clob
) AS
		--移动端关键节点计划监控-关键节点完成率查询
		--作者：鲜晓勇
		--日期：2020/03/20
		--查询2级单位SELECT * from  SYS_BUSINESS_UNIT A WHERE  A.COMPANY_TYPE='5' AND  PARENT_ID='003200000000000000000000000000'
    v_sql              CLOB;
    v_spid             VARCHAR2(200);---数据验证spid
    v_viewName         VARCHAR2(50);
    v_levelSql         CLOB;
    v_whereSql         CLOB:='where 1=1 ';
    v_unionSql         CLOB :=' AND 1=1 ';
    v_exectSql          CLOB:='';
    v_parentSql        CLOB :='''' || ORGID ||''' AS "parentId"';
BEGIN

        IF DATASCOPE='thisMonth' THEN
            IF PLANTYPE='关键节点计划'THEN
                 v_viewName:='V_POM_KEYNODE_M_STATISTICS';
            ELSE 
                 v_viewName:='V_POM_MAIN_PLAN_M_STATISTICS';
            END IF;
        ELSIF DATASCOPE='thisQuarter'THEN
            IF PLANTYPE='关键节点计划'THEN
                v_viewName:='V_POM_KEY_NODE_Q_STATISTICS';
            ELSE 
                v_viewName:='V_POM_MAIN_PLAN_Q_STATISTICS';
            END IF;
        ELSIF DATASCOPE='thisYear' THEN
            IF PLANTYPE='关键节点计划'THEN
                v_viewName:='V_POM_KEY_NODE_Y_STATISTICS';
            ELSE
                v_viewName:='V_POM_MAIN_PLAN_Y_STATISTICS';
            END IF;
        END IF;
        IF(LEVEL_RANK=3)THEN 
        P_SYS_GET_PROJ_TREE_SPID(
            USERID => USERID,
            STATIONID => STATIONID,
            DEPTID => DEPTID,
            COMPANYID => COMPANYID,
            BIZCODE => BIZCODE,
            AUTH_SPID => v_spid
          );
          --AUTHORGS:= 
            SELECT WM_CONCAT(b1."projtId") into AUTHORGS
                  FROM
                      sys_business_unit a1
                      LEFT JOIN (
                          SELECT
                              c.id   AS "projtId",
                              a.company_id
                          FROM
                              pom_proj_plan        a
                              INNER JOIN pom_proj_plan_node   b ON a.id = b.proj_plan_id
                              INNER JOIN sys_project_stage    c ON c.id = proj_id
                              INNER JOIN sys_project          d ON d.id = c.project_id
                              LEFT  JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                              on (case when c.id is not null then c.PROJECT_ID else a.proj_id end)=tal.orgId
                            WHERE
                              a.plan_type = ''||PLANTYPE||''
                              AND a.approval_status = '已审核'
                              AND b.is_disable = 0
                          GROUP BY
                              a.company_id,
                              a.company_name,
                              c.id
                      ) b1 ON b1.company_id = a1.id
                      LEFT JOIN (
                          SELECT
                              wm_concat(user_name) AS user_name,
                              project_id
                          FROM
                              sys_role_user_relation_result
                          WHERE
                              role_code = 'pom_project_plan_manager'
                          GROUP BY
                              project_id
                      ) c1 ON c1.project_id = b1."projtId"
                  WHERE
                      b1."projtId" is not null
                      AND CONNECT_BY_ROOT id = ''
                                               || orgid
                                               || ''
                                                CONNECT BY
                      PRIOR a1.id = a1.parent_id;

            v_parentsql:='
             CASE
												WHEN ID = ''003200000000000000000000000000'' THEN
												 NULL
                                                WHEN ID='''||ORGID||'''
                                                THEN A.PARENT_ID
												ELSE
												 '''||ORGID||'''
										END AS "parentId"
            ';
            v_whereSql:='  AND 1=1 ';
            v_levelSql:='	FROM   '||v_viewName||' A
                        START WITH A.ID='''||ORGID||''' 
                        CONNECT BY PRIOR A.ID=A.PARENT_ID ';
        ELSE 
        --查询有权限的数据
         P_GET_COMPANY_TREE_PROJ_SPID(
            USERID => USERID,
            STATIONID => STATIONID,
            DEPTID => DEPTID,
            COMPANYID => COMPANYID,
            BIZCODE => BIZCODE,
            data_auth_spid => v_spid
          );
          --AUTHORGS
         SELECT DISTINCT
               WM_CONCAT(
              TO_CHAR(   
                     org_id  ) 
                )  into AUTHORGS
        FROM tmp_company_tree
        WHERE id = ''||v_spid||''  
            AND org_id IN (
               SELECT DISTINCT id
               FROM sys_business_unit
               START WITH id IN (
                   SELECT id
                   FROM (
                       SELECT unit_id AS id
                       FROM sys_project
                       UNION
                       SELECT subordinate_company_id AS id
                       FROM cdb_feasible_project_config
                   ) ds
               ) CONNECT BY PRIOR parent_id = id
            );
            v_whereSql:='WHERE  PARENT_ID = ''' || ORGID || '''';
            v_levelSql:='FROM   '||v_viewName||' A ';
            v_unionSql:='UNION 
                        SELECT
                                     A.CTYPE  AS   "ctype",
                                     A. LEVEL_RANK AS "levelRank",
                                     NVL(case when A.CTYPE=''TYPE_PROJLAST'' THEN A.STAGEID END,A.PARENT_ID) AS "clickOperationTypeContent",
                                      CASE
												WHEN  A.CTYPE = ''TYPE_PROJLAST'' THEN
												 ''2''
                                                WHEN  '''||ORGID||'''=''003200000000000000000000000000''
                                                THEN ''0''
												ELSE
												 ''1''
										END AS "clickOperationType" ,
                                    ISFINISHTOTAL AS "completedTotal",--已完成
                                    NODESUM AS "shouldComplete",--应完成
                                    NVL(NVL(CASE WHEN A.CTYPE=''TYPE_PROJLAST'' THEN A.STAGEID END,A.ID), '''||ORGID||''') AS "orgId",
									 A.ORG_NAME AS "orgName",
									 A.FINLISHRATE AS "completionRate",
									 CASE
												WHEN ID = ''003200000000000000000000000000'' THEN
												 NULL
												ELSE
												 PARENT_ID
										END AS "parentId", ''ThisMoth'' AS "dataScope"
						'||v_levelSql||'
						WHERE  ID = ''' || ORGID || ''' AND
									 NODESUM > 0';
        END IF;
        v_sql:='SELECT 
                                    A.CTYPE  AS   "ctype",
                                    A. LEVEL_RANK AS "levelRank",
                                     NVL(case when A.CTYPE=''TYPE_PROJLAST'' THEN A.STAGEID END,A.PARENT_ID) AS "clickOperationTypeContent",
                                     CASE
												WHEN  A.CTYPE = ''TYPE_PROJLAST'' THEN
												 ''2''
												ELSE
												 ''1''
										END AS "clickOperationType",
                                     ISFINISHTOTAL AS "completedTotal",--已完成
                                     NODESUM AS "shouldComplete",--应完成
									 --右上角显示排序
									  NVL(NVL(CASE WHEN A.CTYPE=''TYPE_PROJLAST'' THEN A.STAGEID END,A.ID), '''||ORGID||''') AS "orgId",
									 --ID
									 A.ORG_NAME AS "orgName",
									 --显示名称
									 A.FINLISHRATE AS "completionRate",
									 --完成率
									 '||v_parentSql||'
									 --父级ID
									 , ''ThisMoth'' AS "dataScope" --范围
						--A表项目计划主表计划类别通过TYPE判断
						'||v_levelSql||'
                        '||v_whereSql||'
                         AND
									 NODESUM > 0 
                        '||v_unionSql||'
                         ';
                        -- v_sql:=v_sql||' order by "completionRate"  desc';

                      IF LEVEL_RANK=3 THEN 
                      v_exectSql:='select   LPAD(rownum-1,2,''0'') as "rightLable",t.* from ('||v_sql||') t  where t."ctype"!=''TYPE_PROJTOP'' START WITH t."orgId"='''||ORGID||''' 
                        CONNECT BY PRIOR t."orgId"=t."parentId" order SIBLINGS by t."completionRate" desc';
                      ELSE
                      v_exectSql:='select LPAD(rownum-1,2,''0'') as "rightLable",t.* from ('||v_sql||') t  START WITH t."orgId"='''||ORGID||''' 
                        CONNECT BY PRIOR t."orgId"=t."parentId" order SIBLINGS by t."completionRate" desc';
                      END IF;
                            dbms_output.put_line(v_exectSql);
                                     OPEN COMPLETIONRATE FOR v_exectSql;


END P_POM_MOBILE_KEY_NODE_RATE;
/

prompt
prompt Creating procedure P_POM_MONTHLY_ASSESSMENT_DTL
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_MONTHLY_ASSESSMENT_DTL" (
    year         IN           VARCHAR2, --年
    month        IN           VARCHAR2, --月
    companyid    IN           VARCHAR2, --当前用户公司id
    plantype     IN           INT,--计划类型30 关键节点计划、40主项计划
    baseinfo     OUT          SYS_REFCURSOR, --基本信息
    detailinfo   OUT          SYS_REFCURSOR --明细信息
) AS --公司月度考核排行详情
--作者：叶丁荣
--日期：2019/12/05
    v_plantype       VARCHAR2(20);--用于过滤计划类型
    v_currentmonth   VARCHAR2(200);--过滤月份
    v_month          VARCHAR2(200);--拼接月份条件
    v_monthbegin     DATE;
    v_monthend       DATE;
    v_quarterbegin   DATE;
    v_quarterend     DATE;
    v_yearbegin      DATE;
    v_yearend        DATE; 
BEGIN
    IF month < 10 THEN
        v_month := TO_CHAR(0 || month);
    ELSE
        v_month := TO_CHAR(month);
    END IF;
dbms_output.put_line(month);
    v_currentmonth := TO_CHAR(SYSDATE, 'yyyy')
                      || '-'
                      || v_month||'-01';
    P_POM_MONTH_QUARTER_YEAR(
        now_date =>to_date(v_currentmonth,'yyyy-MM-dd'),
        o_m_begin => v_monthbegin,
        o_m_end => v_monthend,
        o_quarter_begin => v_quarterbegin,
        o_quarter_end => v_quarterend,
        o_year_begin => v_yearbegin,
        o_year_end => v_yearend
    );

--判断计划类型
    IF plantype = 30 THEN
        v_plantype := '关键节点计划';
    ELSE
        v_plantype := '项目主项计划';
    END IF;
--判断是否查询当前月，如果是当前月则直接联查计划表和考核表，如果是历史月则查询拍照表    
    IF month = to_number(TO_CHAR(SYSDATE, 'MM')) THEN
        OPEN baseinfo FOR SELECT
                              round((SUM(
                                  CASE
                                      WHEN node.actual_end_date IS NOT NULL THEN
                                          1
                                      ELSE
                                          0
                                  END
                              ) / COUNT(node.id)), 2) * 100
                              || '%' AS "percentageComplete",--完成率(P=N/N*100)
                              COUNT(node.plan_end_date) AS "assessmentTasksCount",
                              COUNT(node.actual_end_date) AS "missionsCompleted",
                              round((SUM(exam.new_examination_score) / SUM(node.standard_score) * 100), 2) AS "assessmentScore",
                              SUM(node.standard_score) AS "assessmentStandardNodeScore",--∑考核期内节点标准分(A)
                              SUM(exam.new_examination_score) AS "assessmentActualNodeScore" --∑考核期内节点实际得分(B)
                          FROM
                              pom_proj_plan          plan
                              INNER JOIN  pom_proj_plan_node       node ON plan.id = node.proj_plan_id
                              LEFT JOIN sys_business_unit      business ON plan.company_id = business.id
                              LEFT JOIN sys_business_unit      biz ON business.parent_id = biz.id
                              LEFT JOIN pom_node_feedback      feedback ON feedback.feedback_node_id = node.id
                              LEFT JOIN pom_node_examination   exam ON exam.node_id = node.id
                          WHERE
                              plan.approval_status = '已审核'
                              AND plan.plan_type = v_plantype
                              AND node.is_disable=0
                              AND  (node.plan_end_date < v_monthend AND node.plan_end_date > v_monthbegin)
                              AND ( biz.id = companyid
                                    OR business.id = companyid 
                                    OR plan.proj_id IN (
                                   SELECT
                                       id
                                   FROM
                                       sys_project_stage
                                   WHERE
                                       project_id = companyid
                               ));

        OPEN detailinfo FOR SELECT
                               CASE 
 --未到期不亮灯
                                   WHEN node.actual_end_date IS NULL
                                        AND trunc(SYSDATE) - trunc(node.plan_end_date) <= 0 THEN
                                       ''
 --到期当天内完成反馈
                                   WHEN node.actual_end_date IS NOT NULL
                                        AND ( trunc(node.actual_end_date) - trunc(node.plan_end_date) ) <= 0 THEN
                                       '<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>'
  --到期1-5天内完成反馈
                                   WHEN node.actual_end_date IS NOT NULL
                                        AND ( trunc(node.actual_end_date) - trunc(node.plan_end_date) ) BETWEEN 1 AND 5 THEN
                                       '<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>'
 --到期未反馈黄灯 
                                   WHEN node.actual_end_date IS NULL
                                        AND ( trunc(SYSDATE) - trunc(node.plan_end_date) ) BETWEEN 1 AND 5 THEN
                                       '<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>' 
  --到期超过5天未反馈红灯 
                                   WHEN node.actual_end_date IS NULL
                                        AND ( ( trunc(SYSDATE) - trunc(node.plan_end_date) ) > 5 ) THEN
                                       '<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'
                                   ELSE
                                       '<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'
                               END AS "alertStatus",--预警状态
                               CASE
                                   WHEN node.actual_end_date IS NULL THEN
                                       '未完成'
                                   WHEN node.actual_end_date IS NOT NULL THEN
                                       '已完成'
                               END AS "completionStatus",--完成状态
                               node.node_name         AS "taskName",--任务名称
                               plan.plan_name         AS "planName",--计划名称
                               CASE
                                   WHEN biz.level_rank = 1  THEN
                                       plan.company_name
                                   WHEN biz.level_rank <> 1 THEN
                                       biz.org_name
                               END "area",--区域
                               plan.company_name      AS "businessDivision",--事业部
                               plan.proj_name           AS "project", --项目
                               node.duty_department   AS "department",--主责部门
                               node.node_level        AS "tasnkLevel",--任务级别
                               TO_CHAR(node.plan_end_date,'yyyy-MM-dd')     AS "planEndDate",--计划完成日期
                               TO_CHAR(node.actual_end_date,'yyyy-MM-dd')    AS "factEndDate",--实际完成日期
                               CASE
                                   WHEN node.actual_end_date IS NULL THEN
                                       NULL
                                   WHEN node.actual_end_date IS NOT NULL THEN
                                       TO_CHAR(feedback.approval_time,'yyyy-MM-dd')
                               END AS "auditCompletionDate",--核完成日期
                               node.standard_score    AS "standardScore",--标准分值
                               CASE
                                   WHEN node.actual_end_date IS NULL THEN
                                       0 || '%'
                                   WHEN node.actual_end_date IS NOT NULL THEN
                                       round(exam.new_examination_score / exam.standard_score, 2) * 100
                                       || '%'
                               END AS "scoringPercentage",--得分比例
                               CASE
                                   WHEN node.actual_end_date IS NULL
                                        OR exam.new_examination_score IS NULL THEN
                                       0
                                   WHEN node.actual_end_date IS NOT NULL THEN
                                       exam.new_examination_score
                               END AS "actualScore",--实际得分
                               node.id AS "node_id",
                               plan.id AS "plan_id",
                               node.original_node_id AS "original_node_id"
                           FROM
                               pom_proj_plan          plan
                               INNER JOIN pom_proj_plan_node     node ON plan.id = node.proj_plan_id
                               LEFT JOIN sys_business_unit      business ON plan.company_id = business.id
                               LEFT JOIN sys_business_unit      biz ON business.parent_id = biz.id
                               LEFT JOIN pom_node_feedback      feedback ON feedback.feedback_node_id = node.id
                               LEFT JOIN pom_node_examination   exam ON exam.node_id = node.id
                           WHERE
                               plan.approval_status = '已审核'
                               AND plan.plan_type = v_plantype
                                AND node.is_disable=0
                                AND  (node.plan_end_date < v_monthend AND node.plan_end_date > v_monthbegin)
                               AND ( biz.id = companyid
                                     OR business.id =companyid 
                                     OR plan.proj_id IN (
                                   SELECT
                                       id
                                   FROM
                                       sys_project_stage
                                   WHERE
                                       project_id = companyid
                               ) );

    ELSE
        OPEN baseinfo FOR SELECT
                              round((SUM(
                                  CASE
                                      WHEN actual_end_date IS NOT NULL THEN
                                          1
                                      ELSE
                                          0
                                  END
                              ) / COUNT(id)), 2) * 100
                              || '%' AS "percentageComplete",--完成率(P=N/N*100)
                              COUNT(id) AS "assessmentTasksCount",--考核任务数量(M)
                              SUM(
                                  CASE
                                      WHEN actual_end_date IS NOT NULL THEN
                                          1
                                      ELSE
                                          0
                                  END
                              ) AS "missionsCompleted",--已完成任务(N)
                              round((SUM(examination_score) / SUM(standard_score)), 2) * 100 AS "assessmentScore",--考核得分S=(B/A)*100
                              SUM(standard_score) AS "assessmentStandardNodeScore",--∑考核期内节点标准分(A)
                              SUM(examination_score) AS "assessmentActualNodeScore"--∑考核期内节点实际得分(B)
                          FROM
                              pom_node_photograph
                          WHERE
                              ( area_company_id = companyid
                                OR company_id = companyid
                                OR project_id IN (
                                  SELECT
                                      id
                                  FROM
                                      sys_project_stage
                                  WHERE
                                      project_id = companyid
                              ) )
                              AND plan_type = v_plantype
                               AND record_type=0
		AND affiliation_year = year
                              AND   ( plan_end_date < v_monthend AND plan_end_date > v_monthbegin);

        OPEN detailinfo FOR SELECT
                               alert_status        AS "alertStatus",--预警状态
                               completion_status   AS "completionStatus",--完成状态
                               node_name           AS "taskName",--任务名称
                               plan_name           AS "planName",--计划名称
                               area_company_name   AS "area",--区域
                               company_name        AS "businessDivision",--事业部
                               project_name        AS "project", --项目
                               duty_dept           AS "department",--主责部门
                               node_level          AS "tasnkLevel",--任务级别
                               TO_CHAR(plan_end_date, 'yyyy-MM-dd') AS "planEndDate",--计划完成日期
                               TO_CHAR(actual_end_date, 'yyyy-MM-dd') AS "factEndDate",--实际完成日期
                               TO_CHAR(examination_date, 'yyyy-MM-dd') AS "auditCompletionDate",--核完成日期
                               standard_score      AS "standardScore",--标准分值
                               scoring_percentage || '%' AS "scoringPercentage",--得分比例
                               examination_score   AS "actualScore",--实际得分
                               original_node_id,
                               plan_id,
                               node_id
                           FROM
                               pom_node_photograph
                           WHERE
                                (plan_end_date < v_monthend AND plan_end_date > v_monthbegin)
                               AND plan_type = v_plantype
                               AND record_type=0
                               AND ( area_company_id = companyid
                                     OR company_id = companyid
                                     OR project_id IN (
                                   SELECT
                                       id
                                   FROM
                                       sys_project_stage
                                   WHERE
                                       project_id = companyid
                               ) )
                               AND affiliation_year = year;

    END IF;

END p_pom_monthly_assessment_dtl;
/

prompt
prompt Creating procedure P_POM_MSGTYPE_LIST
prompt =====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_msgType_list ( systemId IN VARCHAR2, msgTypeList OUT SYS_REFCURSOR, unreadCount OUT VARCHAR2 ) AS
--移动端消息类型列表
--作者：叶丁荣
--日期：2019/12/12
	v_COUNT NUMBER;
BEGIN
		OPEN msgTypeList FOR SELECT
		'57b55283-ce3a-4fc4-a70d-8240e66a1254' AS id,
		'提醒消息' AS msg_type,
		(
		SELECT
			* 
		FROM
			(
			SELECT
				wechat.TITLE 
			FROM
				SYS_MSG_RECORD_BIZ biz
				LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
				LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
			WHERE
				biz.BIZ_MSG_CATEGORY = '提醒消息' 
			AND biz.SYSTEM_ID=''||systemId||''
			ORDER BY
				biz.CREATED_TIME DESC 
			) 
		WHERE
			ROWNUM = 1 
		) AS frist_msg,
		(
		SELECT
			COUNT( * ) 
		FROM
			SYS_MSG_RECORD_BIZ biz
			LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
			LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
		WHERE
			biz.BIZ_MSG_CATEGORY = '提醒消息' 
			AND biz.ID NOT IN ( SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD ) 
			AND biz.SYSTEM_ID=''||systemId||''
		) AS msg_type_unreadcount 
	FROM
		dual UNION ALL
	SELECT
		'58055283-ce3a-4fc4-a70d-8240e66a1254' AS id,
		'预警消息' AS msg_type,
		(
		SELECT
			* 
		FROM
			(
			SELECT
				wechat.TITLE 
			FROM
				SYS_MSG_RECORD_BIZ biz
				LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
				LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
			WHERE
				biz.BIZ_MSG_CATEGORY = '预警消息' 
				AND biz.SYSTEM_ID=''||systemId||''
			ORDER BY
				biz.CREATED_TIME DESC 
			) 
		WHERE
			ROWNUM = 1 
		) AS frist_msg,
		(
		SELECT
			COUNT( * ) 
		FROM
			SYS_MSG_RECORD_BIZ biz
			LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
			LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
		WHERE
			biz.BIZ_MSG_CATEGORY = '预警消息' 
			AND biz.ID NOT IN ( SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD ) 
			AND biz.SYSTEM_ID=''||systemId||''
		) AS msg_type_unreadcount 
	FROM
		dual UNION ALL
	SELECT
		'58055283-ce3a-4fc4-a70d-8240e66a1254' AS id,
		'催办消息' AS msg_type,
		(
		SELECT
			* 
		FROM
			(
			SELECT
				wechat.TITLE 
			FROM
				SYS_MSG_RECORD_BIZ biz
				LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
				LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
			WHERE
				biz.BIZ_MSG_CATEGORY = '催办消息' 
				AND biz.SYSTEM_ID=''||systemId||''
			ORDER BY
				biz.CREATED_TIME DESC 
			) 
		WHERE
			ROWNUM = 1 
		) AS frist_msg,
		(
		SELECT
			COUNT( * ) 
		FROM
			SYS_MSG_RECORD_BIZ biz
			LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
			LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
		WHERE
			biz.BIZ_MSG_CATEGORY = '催办消息' 
			AND biz.ID NOT IN ( SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD ) 
			AND biz.SYSTEM_ID=''||systemId||''
		) AS msg_type_unreadcount 
	FROM
		dual;


		SELECT
	(
	SELECT
		COUNT( * ) 
	FROM
		SYS_MSG_RECORD_BIZ biz
		LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
		LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
	WHERE
		( biz.BIZ_MSG_CATEGORY = '提醒消息' OR biz.BIZ_MSG_CATEGORY = '预警消息' OR biz.BIZ_MSG_CATEGORY = '催办消息' ) 
		AND biz.ID NOT IN ( SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD ) -- 			AND biz.SYSTEM_ID=''||systemId||''

	)  INTO v_COUNT 
FROM
	dual;



	unreadCount := v_COUNT;

END p_pom_msgType_list;
/

prompt
prompt Creating procedure P_POM_MSG_LIST
prompt =================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_MSG_LIST" ( msgType IN VARCHAR2,
systemId IN VARCHAR2,
isRead IN NUMBER, 
msgList OUT SYS_REFCURSOR ) AS 
--�ƶ�����Ϣ�б�
--���ߣ�Ҷ����
--���ڣ�2019/12/12
BEGIN
                --CASE WHEN (sms.SMS_CONTENT IS NULL) THEN
					--wechat.TITLE
				--WHEN (sms.SMS_CONTENT IS NOT NULL) THEN
					--sms.SMS_CONTENT END msg_title,
 		IF (isRead=1) THEN
			OPEN msgList FOR SELECT
			 	biz.ID AS  id,
				wechat.TITLE AS msg_title,
				CASE WHEN (sms.SMS_CONTENT IS NULL) THEN
					wechat.JUMP_LINK_URL
				WHEN (sms.SMS_CONTENT IS NOT NULL) THEN
					NULL END jump_link_url,	
				biz.CREATED_TIME AS msg_push_time,
				'true' AS is_read
			FROM
				SYS_MSG_RECORD_BIZ biz
				LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
				LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
			WHERE
				biz.BIZ_MSG_CATEGORY = ''||msgType||''
				AND biz.SYSTEM_ID=''||systemId||''
				AND biz.ID IN (SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD );

		ELSE 
                --CASE WHEN (sms.SMS_CONTENT IS NULL) THEN
					--wechat.TITLE
				--WHEN (sms.SMS_CONTENT IS NOT NULL) THEN
					--sms.SMS_CONTENT END msg_title,
 			OPEN msgList FOR SELECT
			 	biz.ID AS  id,
				wechat.TITLE AS msg_title,
				CASE WHEN (sms.SMS_CONTENT IS NULL) THEN
					wechat.JUMP_LINK_URL
				WHEN (sms.SMS_CONTENT IS NOT NULL) THEN
					NULL END jump_link_url,	
				biz.CREATED_TIME AS msg_push_time,
				CASE WHEN (biz.ID IN (SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD )) THEN
				'true'
				WHEN (biz.ID NOT IN (SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD )) THEN
					'false' END is_read
			FROM
				SYS_MSG_RECORD_BIZ biz
				LEFT JOIN SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
				LEFT JOIN SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
			WHERE
				biz.BIZ_MSG_CATEGORY = ''||msgType||''
				AND biz.SYSTEM_ID=''||systemId||'';

		END IF;



END p_pom_msg_list;
/

prompt
prompt Creating procedure P_POM_MSG_LIST_ADJUSTMENT
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_MSG_LIST_ADJUSTMENT ( msgType IN VARCHAR2,
systemId IN VARCHAR2,
userId IN VARCHAR2,
isRead IN NUMBER, 
msgList OUT SYS_REFCURSOR ) AS 
 v_sys_code VARCHAR2 (50);
 v_sql CLOB;
 v_isIn varchar2 (100);
 v_get_code_sql VARCHAR2 (2000);
BEGIN
      v_get_code_sql := 'select user_code from sys_user where id=:sys_code';

      EXECUTE IMMEDIATE v_get_code_sql INTO v_sys_code  using userId;


 		IF (isRead=1) THEN
			v_isIn := ' and 1=1';
		ELSE 
            v_isIn := ' and biz.id not in (SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD )';
		END IF;

        v_sql := '
        select biz.ID AS  id,
            nvl(wechat.TITLE,biz.biz_source_category) AS msg_title,
            PRECORD.MOBILE_URL AS jump_link_url,	
            biz.CREATED_TIME AS msg_push_time,
            to_char((biz.CREATED_TIME), ''yyyy-MM-dd hh24:mi:ss'') AS msg_push_time_str,
            CASE WHEN (biz.ID IN (SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD)) THEN
                ''true''
            WHEN (biz.ID NOT IN (SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD)) THEN
                ''false''
            end is_read
            from SYS_MSG_RECORD_BIZ biz  
            left join sys_msg_read_record rr on biz.id = rr.msg_record_biz_guid 
            left join SYS_MSG_RECORD_WECHAT wechat ON biz.ID = wechat.MSG_RECORD_BIZ_ID
            left join SYS_MSG_RECORD_SMS sms ON biz.ID = sms.MSG_RECORD_BIZ_ID 
            LEFT JOIN SYS_MESSAGE_CENTER_PUSH_RECORD PRECORD ON BIZ.ID = PRECORD.TASK_ID
            where BIZ.BIZ_MSG_CATEGORY = '''||msgType||'''
            and biz.system_id ='''||systemId||'''
            and (sms.receiver_id = '''||v_sys_code||''' or wechat.receiver_id = '''||v_sys_code||''')'||v_isIn||' order by msg_push_time desc ';

                     dbms_output.put_line(v_sql);
        OPEN msgList FOR v_sql;

END P_POM_MSG_LIST_ADJUSTMENT;
/

prompt
prompt Creating procedure P_POM_MY_DUTY_NODE
prompt =====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_MY_DUTY_NODE"
(
	USERID               IN VARCHAR2 --当前用户ID
 ,STATISTICALBEGINDATA IN DATE -- 开始日期
 ,STATISTICALENDDATA   IN DATE --结束日期
 ,CURRENTDATE          IN DATE --当前日期
 ,CALENDARSCOPETYPE    IN NVARCHAR2 -- 查看范围（本月到期OR本周到期），传入的值为，currentWeek：本周到期、currentMonth：本月到期
 ,ISONLYLOOKME         IN VARCHAR2 --是否只看本人
 ,NODEINFO             OUT SYS_REFCURSOR --返回的任务信息
) AS
	--计划首页-我的任务节点
	--作者：陈丽
	--日期：2019/11/15
BEGIN
	--/pom/mission-center-feedback/my-responsible-task?id=xxx&nodeSourcePlanType=XXX&feedbackNodeOriginalId=XXX&feedbackNodeId=XXX
--	IF CALENDARSCOPETYPE = 'currentWeek' THEN
--		OPEN NODEINFO FOR
--			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
--						 B.NODE_LEVEL AS NODELEVEL,
--						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
--							CHR(38) || 'nodeSourcePlanType=' || CASE
--								WHEN A.PLAN_TYPE = '关键节点计划' THEN
--								 '0'
--								WHEN A.PLAN_TYPE = '项目主项计划' THEN
--								 '1'
--								WHEN A.PLAN_TYPE = '专项计划' THEN
--								 '2'
--							END || CHR(38) || 'feedbackNodeOriginalId=' ||
--							B.ORIGINAL_NODE_ID || CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
--						 B.PLAN_END_DATE AS PLANENDDATE
--			FROM   POM_PROJ_PLAN A
--			INNER  JOIN POM_PROJ_PLAN_NODE B
--			ON     A.ID = B.PROJ_PLAN_ID
--			LEFT   JOIN POM_NODE_CHARGE_PERSON C
--			ON     B.ID = C.NODE_ID
--			WHERE  C.CHARGE_PERSON_ID = ''|| USERID||''
--
--						  AND TRUNC(CURRENTDATE, 'WW') = TRUNC(B.PLAN_END_DATE, 'WW')
--			UNION ALL
--			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
--						 '' AS NODELEVEL,
--						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
--							CHR(38) || 'nodeSourcePlanType=2' || CHR(38) ||
--							'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID || CHR(38) ||
--							'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
--						 B.PLAN_END_DATE AS PLANENDDATE
--			FROM   POM_SPECIAL_PLAN A
--			INNER  JOIN POM_SPECIAL_PLAN_NODE B
--			ON     A.ID = B.PLAN_ID
--			LEFT   JOIN POM_NODE_CHARGE_PERSON C
--			ON     B.ID = C.NODE_ID
--			WHERE  C.CHARGE_PERSON_ID = ''|| USERID||''  AND
--						 TRUNC(CURRENTDATE, 'WW') = TRUNC(B.PLAN_END_DATE, 'WW')
--			UNION ALL
--			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
--						 B.NODE_TYPE AS NODELEVEL,
--						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
--							CHR(38) || 'nodeSourcePlanType=3' || CHR(38) ||
--							'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID || CHR(38) ||
--							'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
--						 B.PLAN_END_DATE AS PLANENDDATE
--			FROM   POM_DEPT_MONTHLY_PLAN A
--			INNER  JOIN POM_DEPT_MONTHLY_PLAN_NODE B
--			ON     A.ID = B.DEPT_MONTHLY_PLAN_ID
--			LEFT   JOIN POM_NODE_CHARGE_PERSON C
--			ON     B.ID = C.NODE_ID
--			WHERE  B.SOURCE_PLAN_ID IS NULL AND
--						 C.CHARGE_PERSON_ID = ''|| USERID||''  AND
--						 TRUNC(CURRENTDATE, 'WW') = TRUNC(B.PLAN_END_DATE, 'WW');
--
--	ELSIF CALENDARSCOPETYPE = 'currentMonth' THEN
--		OPEN NODEINFO FOR
--			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
--						 B.NODE_LEVEL AS NODELEVEL,
--						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
--							CHR(38) || 'nodeSourcePlanType=' || CASE
--								WHEN A.PLAN_TYPE = '关键节点计划' THEN
--								 '0'
--								WHEN A.PLAN_TYPE = '项目主项计划' THEN
--								 '1'
--								WHEN A.PLAN_TYPE = '专项计划' THEN
--								 '2'
--							END || CHR(38) || 'feedbackNodeOriginalId=' ||
--							B.ORIGINAL_NODE_ID || CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
--						 B.PLAN_END_DATE AS PLANENDDATE
--			FROM   POM_PROJ_PLAN A
--			INNER  JOIN POM_PROJ_PLAN_NODE B
--			ON     A.ID = B.PROJ_PLAN_ID
--			LEFT   JOIN POM_NODE_CHARGE_PERSON C
--			ON     B.ID = C.NODE_ID
--			WHERE  C.CHARGE_PERSON_ID = ''|| USERID||'' AND
--						 TRUNC(CURRENTDATE, 'mm') = TRUNC(B.PLAN_END_DATE, 'mm')
--			UNION ALL
--			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
--						 '' AS NODELEVEL,
--						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
--							CHR(38) || 'nodeSourcePlanType=2' || CHR(38) ||
--							'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID || CHR(38) ||
--							'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
--						 B.PLAN_END_DATE AS PLANENDDATE
--			FROM   POM_SPECIAL_PLAN A
--			INNER  JOIN POM_SPECIAL_PLAN_NODE B
--			ON     A.ID = B.PLAN_ID
--			LEFT   JOIN POM_NODE_CHARGE_PERSON C
--			ON     B.ID = C.NODE_ID
--			WHERE  C.CHARGE_PERSON_ID = ''|| USERID||''  AND
--						 TRUNC(CURRENTDATE, 'mm') = TRUNC(B.PLAN_END_DATE, 'mm')
--			UNION ALL
--			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
--						 B.NODE_TYPE AS NODELEVEL,
--						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
--							CHR(38) || 'nodeSourcePlanType=3' || CHR(38) ||
--							'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID || CHR(38) ||
--							'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
--						 B.PLAN_END_DATE AS PLANENDDATE
--			FROM   POM_DEPT_MONTHLY_PLAN A
--			INNER  JOIN POM_DEPT_MONTHLY_PLAN_NODE B
--			ON     A.ID = B.DEPT_MONTHLY_PLAN_ID
--			LEFT   JOIN POM_NODE_CHARGE_PERSON C
--			ON     B.ID = C.NODE_ID
--			WHERE  B.SOURCE_PLAN_ID IS NULL AND
--						 C.CHARGE_PERSON_ID = ''|| USERID||''  AND
--						 TRUNC(CURRENTDATE, 'mm') = TRUNC(B.PLAN_END_DATE, 'mm');

--	ELSE  --在没有勾选本周/本月时间范围的时候默认全部查询By Yedr//2020-01-07
		OPEN NODEINFO FOR
			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
						 B.NODE_LEVEL AS NODELEVEL,
						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
							CHR(38) || 'nodeSourcePlanType=' || CASE
								WHEN A.PLAN_TYPE = '关键节点计划' THEN
								 '0'
								WHEN A.PLAN_TYPE = '项目主项计划' THEN
								 '1'
								WHEN A.PLAN_TYPE = '专项计划' THEN
								 '2'
							END || CHR(38) || 'feedbackNodeOriginalId=' ||
							B.ORIGINAL_NODE_ID || CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
						 B.PLAN_END_DATE AS PLANENDDATE
			FROM   POM_PROJ_PLAN A
			INNER  JOIN POM_PROJ_PLAN_NODE B
			ON     A.ID = B.PROJ_PLAN_ID
			LEFT   JOIN POM_NODE_CHARGE_PERSON C
			ON     B.ID = C.NODE_ID
			WHERE  C.CHARGE_PERSON_ID = ''|| USERID||''
 						  AND CURRENTDATE = B.PLAN_END_DATE
			UNION ALL
			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
						 '' AS NODELEVEL,
						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
							CHR(38) || 'nodeSourcePlanType=2' || CHR(38) ||
							'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID || CHR(38) ||
							'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
						 B.PLAN_END_DATE AS PLANENDDATE
			FROM   POM_SPECIAL_PLAN A
			INNER  JOIN POM_SPECIAL_PLAN_NODE B
			ON     A.ID = B.PLAN_ID
			LEFT   JOIN POM_NODE_CHARGE_PERSON C
			ON     B.ID = C.NODE_ID
			WHERE  C.CHARGE_PERSON_ID = ''|| USERID||''
 						 AND CURRENTDATE = B.PLAN_END_DATE
			UNION ALL
			SELECT A.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
						 B.NODE_TYPE AS NODELEVEL,
						 '/pom/mission-center-feedback/my-responsible-task?id=' || B.ID ||
							CHR(38) || 'nodeSourcePlanType=3' || CHR(38) ||
							'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID || CHR(38) ||
							'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
						 B.PLAN_END_DATE AS PLANENDDATE
			FROM   POM_DEPT_MONTHLY_PLAN A
			INNER  JOIN POM_DEPT_MONTHLY_PLAN_NODE B
			ON     A.ID = B.DEPT_MONTHLY_PLAN_ID
			LEFT   JOIN POM_NODE_CHARGE_PERSON C
			ON     B.ID = C.NODE_ID
			WHERE  B.SOURCE_PLAN_ID IS NULL AND
						 C.CHARGE_PERSON_ID = ''|| USERID||''
 						  AND CURRENTDATE = B.PLAN_END_DATE;
--	END IF;

END P_POM_MY_DUTY_NODE;
/

prompt
prompt Creating procedure P_POM_MY_MESSAGE
prompt ===================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_MY_MESSAGE"
(
    USERID      IN VARCHAR2
   ,MESSAGETYPE IN VARCHAR2
   ,TOTAL       OUT INT
   , --消息总数
    MESSAGEINFO OUT SYS_REFCURSOR
) AS
    --计划首页-我的消息
    --作者：陈丽
    --日期：2019/11/15
BEGIN
    TOTAL := -1;
    OPEN MESSAGEINFO FOR
         SELECT  *  FROM (  SELECT
           plan.PLAN_NAME AS "messageContent",
           node.NODE_LEVEL AS "nodeLevel",
           msg.ACTUAL_CREATED AS "messageArrivalTime", 
           msg.pc_url AS "openUrl",
           CASE
            WHEN node.PLAN_END_DATE - SYSDATE < 0 THEN
                '超期'
            WHEN node.PLAN_END_DATE - SYSDATE > 0 THEN
                '正常'
           END AS  "nodeState",
           node.PLAN_END_DATE AS "planEndDate"
           FROM          
           POM_PROJ_PLAN_NODE node
           LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID 
           LEFT JOIN SYS_MESSAGE_CENTER msg ON msg.TASK_ID = node.ID
           LEFT JOIN SYS_USER u ON msg.owner_name=u.user_code where msg.TASK_ID = node.ID and  msg.TASK_STATE = 0 AND u.ID=''||USERID||''
           AND msg.biz_msg_category=''||MESSAGETYPE||'' ORDER BY "messageArrivalTime" DESC) WHERE ROWNUM <= 20 ;
END P_POM_MY_MESSAGE;
/

prompt
prompt Creating procedure P_POM_MY_NODE_CALENDAR
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_MY_NODE_CALENDAR"
(
      USERID               IN VARCHAR2 --传入用户ID
	 ,STATISTICALBEGINDATA IN DATE --日历中每月开始日期
	 ,STATISTICALENDDATA   IN DATE --日历中每月结束日期
--	 ,CURRENTDATE          IN DATE --日历中当前选中日期
--	 ,CALENDARSCOPETYPE    IN VARCHAR2 --查看范围（本月到期OR本周到期），传入的值为，0：本周到期、1：本月到期
--	 ,ISONLYLOOKME         IN VARCHAR2 --是否只看自己
	 ,STATISTICALINFO      OUT SYS_REFCURSOR --返回值
) AS
		--计划首页-首页日历
		--作者：陈丽
    --日期：2019/11/15
BEGIN
    /*    OPEN STATISTICALINFO FOR
    SELECT PLAN_END_DATE AS "date", COUNT(PLAN_END_DATE) "total"
    FROM   POM_PROJ_PLAN_NODE
    GROUP  BY PLAN_END_DATE;*/
    OPEN STATISTICALINFO FOR
        SELECT to_char(PLAN_END_DATE,'yyyy-mm-dd') AS nodeDate, COUNT(NODE_NAME) AS total
        FROM   (SELECT A.PLAN_TYPE, B.NODE_NAME, B.PLAN_END_DATE
                 FROM   POM_PROJ_PLAN A
                 INNER  JOIN POM_PROJ_PLAN_NODE B
                 ON     A.ID = B.PROJ_PLAN_ID
                 INNER  JOIN POM_NODE_CHARGE_PERSON C
                 ON     B.ID = C.NODE_ID
                 WHERE  B.ACTUAL_END_DATE IS NULL AND
                        C.CHARGE_PERSON_ID = USERID AND
                        B.PLAN_END_DATE BETWEEN STATISTICALBEGINDATA AND
                        STATISTICALENDDATA
                 UNION ALL
                 SELECT '专项计划', B.NODE_NAME, B.PLAN_END_DATE
                 FROM   POM_SPECIAL_PLAN A
                 INNER  JOIN POM_SPECIAL_PLAN_NODE B
                 ON     A.ID = B.PLAN_ID
                 INNER  JOIN POM_NODE_CHARGE_PERSON C
                 ON     B.ID = C.NODE_ID
                 WHERE  B.ACTUAL_END_DATE IS NULL AND
                        C.CHARGE_PERSON_ID = USERID AND
                        B.PLAN_END_DATE BETWEEN STATISTICALBEGINDATA AND
                        STATISTICALENDDATA
                 UNION ALL
                 SELECT '部门月度计划', B.NODE_NAME, B.PLAN_END_DATE
                 FROM   POM_DEPT_MONTHLY_PLAN A
                 INNER  JOIN POM_DEPT_MONTHLY_PLAN_NODE B
                 ON     A.ID = B.DEPT_MONTHLY_PLAN_ID
                 INNER  JOIN POM_NODE_CHARGE_PERSON C
                 ON     B.ID = C.NODE_ID
                 WHERE  B.ACTUAL_END_DATE IS NULL AND
                        B.SOURCE_PLAN_ID IS NULL AND
                        C.CHARGE_PERSON_ID = USERID AND
                        B.PLAN_END_DATE BETWEEN STATISTICALBEGINDATA AND
                        STATISTICALENDDATA)
        GROUP  BY PLAN_END_DATE;

END P_POM_MY_NODE_CALENDAR;
/

prompt
prompt Creating procedure P_POM_MY_WACTH_NODE
prompt ======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_MY_WACTH_NODE"
(
		USERID               IN NVARCHAR2 --当前用户ID
	 ,STATISTICALBEGINDATA IN DATE --日历中选中日期对应本月开始日期
	 ,STATISTICALENDDATA   IN DATE --日历中选中日期对应本月结束日期
	 ,CURRENTDATE          IN DATE --日历中当前选择日期
	 ,CALENDARSCOPETYPE    IN VARCHAR2 --查看范围，currentWeek：本周，currentMonth：本月
	 ,ISONLYLOOKME         IN VARCHAR2 --是否只查看我的，0：否，1：是
	 ,NODEINFO             OUT SYS_REFCURSOR --返回值
) AS
		--计划首页-关注的节点
		--作者：陈丽
		--日期：2019/11/15
		--调整存储过程为根据CALENDARSCOPETYPE（日期范围）判断查询数据。默认全部查询，前端勾选了日期范围在根据前端传递日期范围查询  By Yedr 2020-01-07
BEGIN
		/*OPEN NODEINFO FOR
    SELECT POM_PROJ_PLAN.PLAN_NAME AS "planName",
           POM_PROJ_PLAN_NODE.NODE_NAME AS "nodeName",
           POM_PROJ_PLAN_NODE.NODE_LEVEL AS "nodeLevel", '' AS "openUrl",
           PLAN_END_DATE "planEndDate", '正常' "nodeState"
    FROM   POM_PROJ_PLAN_NODE
    LEFT   JOIN POM_PROJ_PLAN
    ON     POM_PROJ_PLAN_NODE.PROJ_PLAN_ID = POM_PROJ_PLAN.ID;*/

--		IF ISONLYLOOKME = 1 THEN
--				RETURN;
--		ELSE
--			IF CALENDARSCOPETYPE='currentWeek' THEN
				OPEN NODEINFO FOR
				--关键节点计划、项目主项计划
						SELECT C.PLAN_NAME AS "planName", B.NODE_NAME AS "nodeName",
									 B.NODE_LEVEL AS "nodeLevel",
									 '/pom/mission-center-feedback/my-responsible-task/view-task-information?planId=' || C.ID ||
									 CHR(38) || 'nodeSourcePlanType=' || CASE
											 WHEN C.PLAN_TYPE = '关键节点计划' THEN
												'0'
											 WHEN C.PLAN_TYPE = '项目主项计划' THEN
												'1'
											 WHEN C.PLAN_TYPE = '专项计划' THEN
												'2'
											 ELSE
												NULL
									 END || CHR(38) || 'feedbackNodeOriginalId=' ||
									 B.ORIGINAL_NODE_ID || CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS "openUrl",
									 B.PLAN_END_DATE AS "planEndDate",
									 CASE
											 WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN
												'正常'
											 WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN
												'已超期'
											 ELSE
												NULL
									 END AS "nodeState"
						FROM   SYS_BIZ_WATCH A
						INNER  JOIN POM_PROJ_PLAN_NODE B
						ON     A.BIZ_ID = B.ORIGINAL_NODE_ID
						INNER  JOIN POM_PROJ_PLAN C
						ON     B.PROJ_PLAN_ID = C.ID
						WHERE  A.WATCHER_ID =''|| USERID||''
                   AND c.APPROVAL_STATUS='已审核'
									 AND CURRENTDATE = B.PLAN_END_DATE
									 --AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')
						UNION ALL
						--专项计划
						SELECT C.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
									 '' AS NODELEVEL,
									 '/pom/mission-center-feedback/my-responsible-task/view-task-information?planId=' || C.ID ||
										CHR(38) || 'nodeSourcePlanType=' || '2' || CHR(38) ||
										'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID ||
										CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
									 B.PLAN_END_DATE AS PLANENDDATE,
									 CASE
												WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN
												 '正常'
												WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN
												 '已超期'
												ELSE
												 NULL
										END AS NODESTATE
						FROM   SYS_BIZ_WATCH A
						INNER  JOIN POM_SPECIAL_PLAN_NODE B
						ON     A.BIZ_ID = B.ORIGINAL_NODE_ID
						INNER  JOIN POM_SPECIAL_PLAN C
						ON     B.PLAN_ID = C.ID
						WHERE  A.WATCHER_ID = ''|| USERID||''
									 and c.APPROVAL_STATUS='已审核'
									 AND CURRENTDATE = B.PLAN_END_DATE
									-- AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')
						UNION ALL
						--部门月度计划
						SELECT C.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
									 B.NODE_TYPE AS NODELEVEL,
									 '/pom/mission-center-feedback/my-responsible-task/view-task-information?planId=' || C.ID ||
										CHR(38) || 'nodeSourcePlanType=' || '3' || CHR(38) ||
										'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID ||
										CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
									 B.PLAN_END_DATE AS PLANENDDATE,
									 CASE
												WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN
												 '正常'
												WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN
												 '已超期'
												ELSE
												 NULL
										END AS NODESTATE
						FROM   SYS_BIZ_WATCH A
						INNER  JOIN POM_DEPT_MONTHLY_PLAN_NODE B
						ON     A.BIZ_ID =  B.ORIGINAL_NODE_ID
						INNER  JOIN POM_DEPT_MONTHLY_PLAN C
						ON     B.DEPT_MONTHLY_PLAN_ID = C.ID
						WHERE  A.WATCHER_ID = ''|| USERID||''
									 AND CURRENTDATE = B.PLAN_END_DATE;
-- 									 AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')   ;

--			ELSIF CALENDARSCOPETYPE='currentMonth' THEN
--				OPEN NODEINFO FOR
--				--关键节点计划、项目主项计划
--						SELECT C.PLAN_NAME AS "planName", B.NODE_NAME AS "nodeName",
--									 B.NODE_LEVEL AS "nodeLevel",
--									 '/pom/mission-center-feedback/my-responsible-task/view-task-information?planId=' || C.ID ||
--									 CHR(38) || 'nodeSourcePlanType=' || CASE
--											 WHEN C.PLAN_TYPE = '关键节点计划' THEN
--												'0'
--											 WHEN C.PLAN_TYPE = '项目主项计划' THEN
--												'1'
--											 WHEN C.PLAN_TYPE = '专项计划' THEN
--												'2'
--											 ELSE
--												NULL
--									 END || CHR(38) || 'feedbackNodeOriginalId=' ||
--									 B.ORIGINAL_NODE_ID || CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS "openUrl",
--									 B.PLAN_END_DATE AS "planEndDate",
--									 CASE
--											 WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN
--												'正常'
--											 WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN
--												'已超期'
--											 ELSE
--												NULL
--									 END AS "nodeState"
--						FROM   SYS_BIZ_WATCH A
--						INNER  JOIN POM_PROJ_PLAN_NODE B
--						ON     A.BIZ_ID = B.ORIGINAL_NODE_ID
--						INNER  JOIN POM_PROJ_PLAN C
--						ON     B.PROJ_PLAN_ID = C.ID
--						WHERE  A.WATCHER_ID =''|| USERID||''
--                   AND c.APPROVAL_STATUS='已审核'
--									 AND TRUNC(CURRENTDATE, 'mm') = TRUNC(B.PLAN_END_DATE, 'mm')
--									  --AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')
--						UNION ALL
--						--专项计划
--						SELECT C.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
--									 '' AS NODELEVEL,
--									 '/pom/mission-center-feedback/my-responsible-task/view-task-information?planId=' || C.ID ||
--										CHR(38) || 'nodeSourcePlanType=' || '2' || CHR(38) ||
--										'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID ||
--										CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
--									 B.PLAN_END_DATE AS PLANENDDATE,
--									 CASE
--												WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN
--												 '正常'
--												WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN
--												 '已超期'
--												ELSE
--												 NULL
--										END AS NODESTATE
--						FROM   SYS_BIZ_WATCH A
--						INNER  JOIN POM_SPECIAL_PLAN_NODE B
--						ON     A.BIZ_ID = B.ORIGINAL_NODE_ID
--						INNER  JOIN POM_SPECIAL_PLAN C
--						ON     B.PLAN_ID = C.ID
--						WHERE  A.WATCHER_ID = ''|| USERID||''
--									 AND c.APPROVAL_STATUS='已审核'
--									 AND TRUNC(CURRENTDATE, 'mm') = TRUNC(B.PLAN_END_DATE, 'mm')
--									  --AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')
--						UNION ALL
--						--部门月度计划
--						SELECT C.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
--									 B.NODE_TYPE AS NODELEVEL,
--									 '/pom/mission-center-feedback/my-responsible-task/view-task-information?planId=' || C.ID ||
--										CHR(38) || 'nodeSourcePlanType=' || '3' || CHR(38) ||
--										'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID ||
--										CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
--									 B.PLAN_END_DATE AS PLANENDDATE,
--									 CASE
--												WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN
--												 '正常'
--												WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN
--												 '已超期'
--												ELSE
--												 NULL
--										END AS NODESTATE
--						FROM   SYS_BIZ_WATCH A
--						INNER  JOIN POM_DEPT_MONTHLY_PLAN_NODE B
--						ON     A.BIZ_ID =  B.ORIGINAL_NODE_ID
--						INNER  JOIN POM_DEPT_MONTHLY_PLAN C
--						ON     B.DEPT_MONTHLY_PLAN_ID = C.ID
--						WHERE  A.WATCHER_ID = ''|| USERID||''
--									 AND TRUNC(CURRENTDATE, 'mm') = TRUNC(B.PLAN_END_DATE, 'mm');
--									-- AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')   ;
--			ELSE
--				OPEN NODEINFO FOR
--				--关键节点计划、项目主项计划
--						SELECT C.PLAN_NAME AS "planName", B.NODE_NAME AS "nodeName",
--									 B.NODE_LEVEL AS "nodeLevel",
--									 '/pom/mission-center-feedback/my-responsible-task/view-task-information?planId=' || C.ID ||
--									 CHR(38) || 'nodeSourcePlanType=' || CASE
--											 WHEN C.PLAN_TYPE = '关键节点计划' THEN
--												'0'
--											 WHEN C.PLAN_TYPE = '项目主项计划' THEN
--												'1'
--											 WHEN C.PLAN_TYPE = '专项计划' THEN
--												'2'
--											 ELSE
--												NULL
--									 END || CHR(38) || 'feedbackNodeOriginalId=' ||
--									 B.ORIGINAL_NODE_ID || CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS "openUrl",
--									 B.PLAN_END_DATE AS "planEndDate",
--									 CASE
--											 WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN
--												'正常'
--											 WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN
--												'已超期'
--											 ELSE
--												NULL
--									 END AS "nodeState"
--						FROM   SYS_BIZ_WATCH A
--						INNER  JOIN POM_PROJ_PLAN_NODE B
--						ON     A.BIZ_ID = B.ORIGINAL_NODE_ID
--						INNER  JOIN POM_PROJ_PLAN C
--						ON     B.PROJ_PLAN_ID = C.ID
--						WHERE  A.WATCHER_ID =''|| USERID||''
--									 --AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')
--                                    and c.APPROVAL_STATUS='已审核'
--						UNION ALL
--						--专项计划
--						SELECT C.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
--									 '' AS NODELEVEL,
--									 '/pom/mission-center-feedback/my-responsible-task/view-task-information?planId=' || C.ID ||
--										CHR(38) || 'nodeSourcePlanType=' || '2' || CHR(38) ||
--										'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID ||
--										CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
--									 B.PLAN_END_DATE AS PLANENDDATE,
--									 CASE
--												WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN
--												 '正常'
--												WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN
--												 '已超期'
--												ELSE
--												 NULL
--										END AS NODESTATE
--						FROM   SYS_BIZ_WATCH A
--						INNER  JOIN POM_SPECIAL_PLAN_NODE B
--						ON     A.BIZ_ID = B.ORIGINAL_NODE_ID
--						INNER  JOIN POM_SPECIAL_PLAN C
--						ON     B.PLAN_ID = C.ID
--						WHERE  A.WATCHER_ID = ''|| USERID||''
--									 --AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')
--                                     and c.APPROVAL_STATUS='已审核'
--						UNION ALL
--						--部门月度计划
--						SELECT C.PLAN_NAME AS PLANNAME, B.NODE_NAME AS NODENAME,
--									 B.NODE_TYPE AS NODELEVEL,
--									 '/pom/mission-center-feedback/my-responsible-task/view-task-information?planId=' || C.ID ||
--										CHR(38) || 'nodeSourcePlanType=' || '3' || CHR(38) ||
--										'feedbackNodeOriginalId=' || B.ORIGINAL_NODE_ID ||
--										CHR(38) || 'feedbackNodeId=' || B.ID||'&cancelType=0' AS OPENURL,
--									 B.PLAN_END_DATE AS PLANENDDATE,
--									 CASE
--												WHEN B.PLAN_END_DATE - SYSDATE > 0 THEN
--												 '正常'
--												WHEN B.PLAN_END_DATE - SYSDATE < 0 THEN
--												 '已超期'
--												ELSE
--												 NULL
--										END AS NODESTATE
--						FROM   SYS_BIZ_WATCH A
--						INNER  JOIN POM_DEPT_MONTHLY_PLAN_NODE B
--						ON     A.BIZ_ID =  B.ORIGINAL_NODE_ID
--						INNER  JOIN POM_DEPT_MONTHLY_PLAN C
--						ON     B.DEPT_MONTHLY_PLAN_ID = C.ID
--						WHERE  A.WATCHER_ID = ''|| USERID||'';
--									-- AND to_char(B.PLAN_END_DATE,'YYYY/MM/DD')=to_char(CURRENTDATE,'YYYY/MM/DD')   ;
--			END IF;

--		END IF;
		/*/pom/mission-center-feedback/my-responsible-task/view-task-information;

		所需参数:{

		planId: String, //计划id
		nodeSourcePlanType: String, //计划类型
		feedbackNodeOriginalId: String, //任务原始id
		feedbackNodeId: String //任务id

		}*/
END P_POM_MY_WACTH_NODE;
/

prompt
prompt Creating procedure P_POM_NODE_EXAMINATION
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_NODE_EXAMINATION"
(
		ORIGINALNODEID  IN VARCHAR2
	 ,EXAMINATIONINFO OUT SYS_REFCURSOR
) AS
		--查看反馈，考核信息查看列表
		--作者：陈丽
		--日期：2019/11/15
BEGIN
		OPEN EXAMINATIONINFO FOR
				SELECT C.PROJ_NAME AS "projName",
							 --项目名称
							 A.NODE_NAME AS "nodeName",
							 --任务名称
							 A.NODE_LEVEL AS "nodeLevel",
							 --任务级别
							 A.DUTY_DEPT AS "dutyDepartment",
							 --主责部门
							 NULL AS "dutyPerson",
							 --主责人
							 A.PLAN_END_DATE AS "planEndDate",
								--计划完成日期
							 A.ACTUAL_END_DATE AS "actualEndDate",
								--实际完成日期
							 A.NEW_EXAMINATION_SCORE AS "examinationScore",
								--考核得分
							 A.PLAN_START_DATE AS "planStartDate",
								--计划开始日期
--							 A. AS "estimateEndDate",
--								--预计完成日期
							 A.STANDARD_SCORE AS "standardScore" ---，标准分值
				FROM   POM_NODE_EXAMINATION A LEFT JOIN 
                POM_PROJ_PLAN_NODE B ON A.NODE_ID=B.ID LEFT JOIN 
                POM_PROJ_PLAN C ON C.ID=B.PROJ_PLAN_ID
				WHERE a.ORIGINAL_NODE_ID = ORIGINALNODEID;

END P_POM_NODE_EXAMINATION;
/

prompt
prompt Creating procedure P_POM_NODE_EXAMINATION_CREATE
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_NODE_EXAMINATION_CREATE"
AS
--考核数据生成 1、根据设置的范围，创建考核范围数据。2、已经如表的本次考核范围数据，只更新修改时间
--作者：陈丽
--日期：2019/11/13
BEGIN
null;
END p_pom_node_examination_create;
/

prompt
prompt Creating procedure P_POM_NODE_FEEDBACK_RESULTS
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_NODE_FEEDBACK_RESULTS" (
    unitid         IN             VARCHAR2,--所属公司
    projectid      IN             VARCHAR2,--所属项目
    filename       IN             VARCHAR2,--文件名称
    nodename       IN             VARCHAR2,--计划节点
    filecreator    IN             VARCHAR2,---上传人
    begindate      IN             VARCHAR2,--范围开始时间
    beginend       IN             VARCHAR2,----范围结束日期
    userid         IN             VARCHAR2,--用户id(用户当前）
    stationid      IN             VARCHAR2,--岗位id(用户当前）
    departmentid   IN             VARCHAR2,--部门id(用户当前）
    companyid      IN             VARCHAR2,--公司id(用户所在公司)
    bizcode        IN             VARCHAR2,-- 权限编码
    pageindex      IN             INT,--页码
    pagesizes      IN             INT,--每页条数
    total          OUT            INT,--总数
    items          OUT            SYS_REFCURSOR--项
)
	--任务成功查询//鲜晓勇负责实现
	--作者：陈丽
	--日期：2019/12/08

	--修改：徐正来
	--日期：2020/06/05
 AS
    v_sql        CLOB;
    v_sql_exec   CLOB;
    v_where      VARCHAR2(500) := ' and 1=1 ';
    testmsg             NVARCHAR2(4000);
    v_spid      NVARCHAR2(4000);
    v_auth_sql         VARCHAR2(4000) :=' ';
    v_pcount int;
    v_proj  VARCHAR2(4000) :=' ';
    v_file_name_searchcondition CLOB;
    v_node_name_searchcondition CLOB;
    v_creator_searchcondition CLOB;
    v_projectid CLOB;
BEGIN


    BEGIN
        total := 1000;

            --执行数据权限存储过程。拿到零时表id 用户连临时表鉴权
 --调用查询数据权限的存储过程,返回spid
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => stationid,
            DEPTID => departmentid,
            COMPANYID => companyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
         --V_AUTH_SQL:='left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||V_SPID||''') ta on ta.orgid=plan.company_id or ta.orgid=plan.proj_id  where ta.orgid is not null ';
       --展示去掉权限取数 chenl
--        V_AUTH_SQL:=' where 1=1';
        --如果查询不到项目就是分期，暂时这样紧急处理，升级

select count(proj_id) into v_pcount from POM_PROJ_PLAN where proj_id=projectid;
if v_pcount=0  then
select wm_concat(id) into v_proj from SYS_PROJECT_STAGE where PROJECT_ID=projectid;
else
v_proj:=projectid;
end if;


testmsg := 'unitid:'
               || unitid
               || ';pageindex:'
               || pageindex
               || ';pagesizes:'
               || pagesizes
               || ';projectid:'
               || projectid
               || ';begindate:'
               || begindate
               || ';beginend:'
               || beginend;
        -------------------------------------------条件

        IF ( begindate IS NOT NULL ) THEN
            v_where := v_where
                       || 'and  to_char(attachment.created,''yyyy-MM-dd'')>='''
                       || begindate
                       || '''';
        END IF;

        IF ( beginend IS NOT NULL ) THEN
            v_where := v_where
                       || ' and  to_char(attachment.created,''yyyy-MM-dd'')<='''
                       || beginend
                       || '''';
        END IF;

    IF  filename IS NOT NULL  THEN
        v_file_name_searchcondition:='AND file_origin_name like ''%'|| filename|| '%'' ';
    ELSE    
        v_file_name_searchcondition:='';
    END IF;
    IF nodename IS NOT NULL THEN
        v_node_name_searchcondition:='AND node_name like ''%'|| nodename || '%''';
    ELSE
        v_node_name_searchcondition:='';
    END IF;
    IF  filecreator IS NOT NULL THEN
        v_creator_searchcondition:='AND attachment.creator like ''%'|| filecreator|| '%''';
    ELSE
        v_creator_searchcondition:='';
    END IF;
    IF  projectid IS NOT NULL THEN
        v_projectid :=' AND instr('''||v_proj||''', plan.proj_id) > 0';
    ELSE
        v_projectid :='';
    END IF;
    --------------------------------------拼接完整的sql
    IF unitid IS NULL THEN
    dbms_output.put_line(unitid);
        v_sql := '
    SELECT
    rownum as rowno,
    feedback.id             as "bizId",
    node.node_name      AS "nodeName",
    attachment.id             AS "attachmentId",
    attachment.file_origin_name as "fileName",
    TO_CHAR(attachment.file_size/(1024*1024),''FM99990.99'')||''M'' as "fileSize",
    1 AS "isAllowDownload",--是否允许下载，1允许。0不允许
    to_char(attachment.created ,''yyyy-MM-dd'') as "created",
    attachment.creator        AS "fileCreator",
    plan.plan_name      AS "planName",
    plan.company_id     AS "companyId",
    plan.proj_id        as "projId",
    plan.plan_type      AS "planType"
FROM
    pom_node_feedback    feedback
    LEFT JOIN pom_proj_plan_node   node ON feedback.FEEDBACK_NODE_ORIGINAL_ID = node.original_node_id
    LEFT JOIN pom_proj_plan        plan ON node.proj_plan_id = plan.id
    LEFT JOIN sys_attachment       attachment ON attachment.biz_id = feedback.id
    LEFT JOIN SYS_PROJECT_STAGE    stage ON plan.proj_id=stage.id
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||V_SPID||''') ta 
    on (case when stage.id is not null then stage.PROJECT_ID else plan.proj_id end)=ta.orgId  where ta.orgid is not null
    AND attachment.file_origin_name is not null
    AND plan.approval_status = ''已审核'''
    || v_file_name_searchcondition 
    || v_node_name_searchcondition
    || v_creator_searchcondition
    || v_where
   ;
    ELSE 
        v_sql := '
    SELECT
    rownum as rowno,
    feedback.id             as "bizId",
    node.node_name      AS "nodeName",
    attachment.id             AS "attachmentId",
    attachment.file_origin_name as "fileName",
    TO_CHAR(attachment.file_size/(1024*1024),''FM99990.99'')||''M'' as "fileSize",
    1 AS "isAllowDownload",--是否允许下载，1允许。0不允许
    to_char(attachment.created ,''yyyy-MM-dd'') as "created",
    attachment.creator        AS "fileCreator",
    plan.plan_name      AS "planName",
    plan.company_id     AS "companyId",
    plan.proj_id        as "projId",
    plan.plan_type      AS "planType"
FROM
    pom_node_feedback    feedback
    LEFT JOIN pom_proj_plan_node   node ON feedback.FEEDBACK_NODE_ORIGINAL_ID = node.original_node_id
    LEFT JOIN pom_proj_plan        plan ON node.proj_plan_id = plan.id
    LEFT JOIN sys_attachment       attachment ON attachment.biz_id = feedback.id
    LEFT JOIN SYS_PROJECT_STAGE    stage ON plan.proj_id=stage.id
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||V_SPID||''') ta 
    on (case when stage.id is not null then stage.PROJECT_ID else plan.proj_id end)=ta.orgId  where ta.orgid is not null
    AND attachment.file_origin_name is not null
    AND plan.approval_status = ''已审核'''
    ||v_projectid||'
    AND (plan.company_id='''||unitid||''' OR plan.company_id in (SELECT
                               id
                           FROM
                               sys_business_unit where is_company=1
                           START WITH
                               parent_id = '''||unitid||'''
                           CONNECT BY
                               PRIOR id = parent_id))'
    || v_file_name_searchcondition 
    || v_node_name_searchcondition
    || v_creator_searchcondition
    || v_where ;
    END IF;

    ----------------------------------------分页

        v_sql_exec := '
select a.* from ( '
                      || v_sql
                      || ' AND rownum <= '
                      || pageindex * pagesizes
                      || ' ) a where a.rowno >= '
                      || pagesizes * ( pageindex - 1 )
                      || '';

        dbms_output.put_line(v_sql_exec);
----获取总条数
        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
                          || v_sql
                          || ') a '
        INTO total;
-- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN items FOR v_sql_exec;
    EXCEPTION
        WHEN OTHERS THEN
            testmsg := sqlerrm || testmsg;
            OPEN items FOR SELECT
                               '失败咯'
                           FROM
                               dual;

            dbms_output.put_line(sqlerrm);
    END;

END p_pom_node_feedback_results;
/

prompt
prompt Creating procedure P_POM_NODE_FEEDBACK_RESULTS_C
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_node_feedback_results_c (
    unitid         IN             VARCHAR2,--所属公司
    projectid      IN             VARCHAR2,--所属项目
    filename       IN             VARCHAR2,--文件名称
    nodename       IN             VARCHAR2,--计划节点
    filecreator    IN             VARCHAR2,---上传人
    begindate      IN             VARCHAR2,--范围开始时间
    beginend       IN             VARCHAR2,----范围结束日期
    userid         IN             VARCHAR2,--用户id(用户当前）
    stationid      IN             VARCHAR2,--岗位id(用户当前）
    departmentid   IN             VARCHAR2,--部门id(用户当前）
    companyid      IN             VARCHAR2,--公司id(用户所在公司)
    bizcode        IN             VARCHAR2,-- 权限编码
    pageindex      IN             INT,--页码
    pagesizes      IN             INT,--每页条数
    total          OUT            INT,--总数
    items_test          OUT            SYS_REFCURSOR,--项
    items          OUT            SYS_REFCURSOR--项
) 
	--任务成功查询//鲜晓勇负责实现
	--作者：陈丽
	--日期：2019/12/08	
 AS
    v_sql        CLOB;
    v_sql_exec   CLOB;
    v_where      VARCHAR2(500) := ' and 1=1 ';
    testmsg             NVARCHAR2(4000);
    v_spid      NVARCHAR2(4000);
    v_auth_sql         VARCHAR2(4000) :=' ';
    v_pcount int;
    v_proj  VARCHAR2(4000) :=' ';
     v_unitid               VARCHAR2(4000) :=' ';--所属公司
BEGIN


    BEGIN
        total := 1000;

            --执行数据权限存储过程。拿到零时表id 用户连临时表鉴权
 --调用查询数据权限的存储过程,返回spid 
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => stationid,
            DEPTID => departmentid,
            COMPANYID => companyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
        V_AUTH_SQL:='left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||V_SPID||''') ta on ta.orgid=pp.company_id or ta.orgid=p.id  where ta.orgid is not null ';        
       --展示去掉权限取数 chenl 
        --V_AUTH_SQL:=' where 1=1';
        --如果查询不到项目就是分期，暂时这样紧急处理，升级
                dbms_output.put_line(11111);
  OPEN items_test FOR select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = V_SPID;
 ---查找项目的分期
       if projectid is null then
            v_proj:=''' or ''1''=''1';
        else
          select id into v_proj from SYS_PROJECT_STAGE where PROJECT_ID=projectid;
        end if;

  ---查找项目的分期
       if unitid is null then
            v_unitid:=''' or ''1''=''1';
        else
          v_unitid:=unitid;
        end if;


testmsg := 'unitid:'
               || unitid
               || '；pageindex:'
               || pageindex
               || '；pagesizes:'
               || pagesizes
               || '；projectid:'
               || projectid
               || '；begindate:'
               || begindate
               || '；beginend:'
               || beginend;
        -------------------------------------------条件

        IF ( begindate <> NULL ) THEN
            v_where := v_where
                       || 'and  to_char(sa.created,''yyyy-MM-dd'')>='
                       || begindate
                       || '';
        END IF;

        IF ( beginend <> NULL ) THEN
            v_where := v_where
                       || ' and  to_char(sa.created,''yyyy-MM-dd'')<='
                       || beginend
                       || '';
        END IF;

    --------------------------------------拼接完整的sql

        v_sql := '
    SELECT
    rownum as rowno,
    pf.id             as "bizId",
    pn.node_name      AS "nodeName",
    sa.id             AS "attachmentId",
    sa.file_origin_name as "fileName",
    TO_CHAR(sa.file_size/(1024*1024),''FM99990.99'')||''M'' as "fileSize",
    1 AS "isAllowDownload",--是否允许下载，1允许。0不允许
    to_char(sa.created ,''yyyy-MM-dd'') as "created",
    sa.creator        AS "fileCreator",
    pp.plan_name      AS "planName",
    pp.company_id     AS "companyId",
    pp.proj_id        as "projId",
    pp.plan_type      AS "planType",
p.PROJECT_NAME,
ta.orgid
FROM
    pom_node_feedback    pf
    LEFT JOIN pom_proj_plan_node   pn ON pf.FEEDBACK_NODE_ORIGINAL_ID = pn.original_node_id
    LEFT JOIN pom_proj_plan        pp ON pn.proj_plan_id = pp.id
    LEFT JOIN sys_attachment       sa ON sa.biz_id = pf.id 
      left join SYS_PROJECT_STAGE ps on ps.id=pp.proj_id
      left join sys_project p on ps.PROJECT_ID=p.id

    '||v_auth_sql||'
    AND
    pn.actual_end_date IS NOT NULL 
    AND sa.file_origin_name is not null 
    AND pp.approval_status = ''已审核''
    AND (pp.proj_id='''||v_proj||''')
    and (pp.company_id='''||v_unitid||''')
    and (file_origin_name like ''%'
                 || filename
                 || '%'' and node_name like ''%'
                 || nodename
                 || '%'' and sa.creator like ''%'
                 || filecreator
                 || '%'')'
                 || v_where;


    ----------------------------------------分页

        v_sql_exec := '
select a.* from ( '
                      || v_sql
                      || ' AND rownum <= '
                      || pageindex * pagesizes
                      || ' ) a where a.rowno >= '
                      || pagesizes * ( pageindex - 1 )
                      || '';

        dbms_output.put_line(v_sql_exec);
----获取总条数
        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
                          || v_sql
                          || ') a '
        INTO total;

-- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN items FOR v_sql_exec;
    EXCEPTION
        WHEN OTHERS THEN
            testmsg := sqlerrm || testmsg;
            OPEN items FOR SELECT
                               testmsg
                           FROM
                               dual;

            dbms_output.put_line(sqlerrm);
    END;

END p_pom_node_feedback_results_c;
--=================================本公司负责的任务Start=========================

--=================================本公司负责的任务Start=========================
/

prompt
prompt Creating procedure P_POM_NODE_MESSAGE
prompt =====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_node_message
(
  originalNodeId IN VARCHAR2,
  messageInfo OUT sys_refcursor
) AS 
--查看反馈，任务相关消息列表查询
--作者：陈丽
--日期：2019/11/15
BEGIN
 open messageInfo for
  select * from(    
  SELECT 
  biz.BIZ_SOURCE_CATEGORY  AS    "title"--消息标题
  ,node.NODE_NAME ||'-'|| node.NODE_LEVEL  AS  "nodeInfo"--任务信息
  ,nvl(UR.USER_NAME,URS.USER_NAME) AS "recipient"
  ,cast(nvl(MSG.SEND_DATE,msgs.SEND_DATE) as timestamp)   AS   "executionTime"
  --,to_timestamp(nvl(MSG.SEND_DATE,msgs.SEND_DATE),'yyyy-mm-dd hh24:mi:ss') AS   "executionTime"
  ,nvl(BIZ_MSG_CATEGORY,BIZ_SOURCE_CATEGORY)   AS  "msgType"
      FROM
      POM_PROJ_PLAN_NODE node  
      LEFT JOIN SYS_MSG_RECORD_BIZ biz ON node.ID = biz.BIZ_KEY
      LEFT JOIN SYS_MSG_RECORD_WECHAT msg ON biz.id = msg.MSG_RECORD_BIZ_ID 
      left join SYS_MSG_RECORD_SMS msgs on biz.id = msgs.MSG_RECORD_BIZ_ID 
      LEFT JOIN  SYS_USER UR ON UR.user_code=MSG.RECEIVER_ID
      LEFT JOIN  SYS_USER URS ON URS.user_code=msgs.RECEIVER_ID
    WHERE
      node.id = biz.biz_key  and  node.id=''||originalNodeId||''
      AND biz.ID NOT IN ( SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD ) ) a order by "executionTime" desc;
    
--  SELECT 
--  MSG.TITLE  AS    "title"--消息标题
--  ,node.NODE_NAME ||'-'|| node.NODE_LEVEL  AS  "nodeInfo"--任务信息
--  ,UR.USER_NAME AS "recipient"
--  ,MSG.SEND_DATE  AS   "executionTime"
--  ,MSG.ACTUAL_EXECUTE_TYPE   AS  "msgType"
--      FROM
--      POM_PROJ_PLAN_NODE node  
--      LEFT JOIN SYS_MSG_RECORD_BIZ biz ON node.ID = biz.BIZ_KEY
--      LEFT JOIN SYS_MSG_RECORD_WECHAT msg ON biz.id = msg.MSG_RECORD_BIZ_ID 
--      LEFT JOIN  SYS_USER UR ON UR.ID=MSG.RECEIVER_ID
--    WHERE
--      node.id = biz.biz_key  and  node.id=''||originalNodeId||''
--      AND biz.ID NOT IN ( SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD ) ;
      
        
END p_pom_node_message;
/

prompt
prompt Creating procedure P_POM_NODE_MESSAGE_ADJUSTMENT
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_node_message_adjustment
(
  originalNodeId IN VARCHAR2,
  messageInfo OUT sys_refcursor
) AS 
--查看反馈，任务相关消息列表查询
--作者：谢松宏
--日期：2020/03/13
BEGIN
 open messageInfo for
Select * from (
select 
	nvl(MSG.TITLE, biz.BIZ_SOURCE_CATEGORY)  AS    "title"--消息标题
	,node.NODE_NAME ||'-'|| node.NODE_LEVEL  AS  "nodeInfo"--任务信息
	,nvl(UR.USER_NAME,URS.USER_NAME) AS "recipient"
	,nvl(MSG.SEND_DATE, sms.SEND_DATE)  AS   "executionTime"
    ,to_char(nvl(MSG.SEND_DATE, sms.SEND_DATE), 'yyyy-MM-dd hh24:mi:ss') AS "executionTimeString" --添加一个返回字段用于将操作时间转换为字符串格式。
	,nvl(msg.WECHAT_MSG_TYPE, BIZ.BIZ_MSG_CATEGORY) AS  "msgType"
 from 
(select * from POM_PROJ_PLAN_NODE where  proj_plan_id = (select id from (select * from POM_PROJ_PLAN plan where plan.id in (select proj_plan_id from POM_PROJ_PLAN_NODE where original_node_id=''||originalNodeId||'') and approval_status='已审核'))) node 
LEFT JOIN SYS_MSG_RECORD_BIZ biz ON node.ID = biz.BIZ_KEY
LEFT JOIN SYS_MSG_RECORD_WECHAT msg ON biz.id = msg.MSG_RECORD_BIZ_ID 
LEFT JOIN SYS_MSG_RECORD_SMS sms on biz.id = sms.MSG_RECORD_BIZ_ID
LEFT JOIN  SYS_USER UR ON UR.ID=msg.RECEIVER_ID
LEFT JOIN  SYS_USER URS ON URS.user_code=sms.RECEIVER_ID
where 
node.id = biz.biz_key  and
original_node_id = ''||originalNodeId||''
AND biz.ID NOT IN ( SELECT MSG_RECORD_BIZ_GUID FROM SYS_MSG_READ_RECORD )) order by "executionTime" desc;

END p_pom_node_message_adjustment;
/

prompt
prompt Creating procedure P_POM_NODE_MONTH_PHOTOGRAPH
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_NODE_MONTH_PHOTOGRAPH" (
    year in NUMBER,
    currentmonth IN NUMBER
)

--作者：yder
--日期：2020-06-10
--描述：记录节点考核 “月度”数据
 AS
    v_currentmonth VARCHAR2(200);
    v_month VARCHAR2(200);
    v_monthbegin     DATE;
    v_monthend       DATE;
    v_quarterbegin   DATE;
    v_quarterend     DATE;
    v_yearbegin      DATE;
    v_yearend        DATE; 
BEGIN

    IF currentmonth < 10 THEN
        v_month := TO_CHAR(0 || currentmonth);
    ELSE
        v_month := TO_CHAR(currentmonth);
    END IF;
    IF currentmonth IS NULL AND year is NULL  THEN
        v_currentmonth := TO_CHAR(SYSDATE, 'yyyy-MM-dd');
    ELSIF  currentmonth IS NOT NULL AND year is NULL THEN
        v_currentmonth :=  TO_CHAR(SYSDATE, 'yyyy')||'-'||v_month||'-01';
    ELSIF  currentmonth IS NOT NULL AND year is NOT NULL THEN    
         v_currentmonth :=  year||'-'||v_month||'-01';
    END IF;

    P_POM_MONTH_QUARTER_YEAR(
        now_date =>to_date(v_currentmonth,'yyyy-MM-dd'),
        o_m_begin => v_monthbegin,
        o_m_end => v_monthend,
        o_quarter_begin => v_quarterbegin,
        o_quarter_end => v_quarterend,
        o_year_begin => v_yearbegin,
        o_year_end => v_yearend
    );
    dbms_output.put_line(v_currentmonth);
-- 为保证拍照数据不重复，先删除记录类型为'0'并且计划完成月份和实际完成月份等于条件月份的数据
    DELETE POM_NODE_PHOTOGRAPH WHERE (plan_end_date < v_monthend AND  plan_end_date > v_monthbegin) AND record_type=0;
    commit;
--批量插入月度拍照数据
    INSERT INTO POM_NODE_PHOTOGRAPH (
        id,
        node_id,
        node_name,
        node_level,
        standard_score,
        examination_score,
        scoring_percentage,
        completion_status,
        plan_start_date,
        plan_end_date,
        actual_start_date,
        actual_end_date,
        alert_status,
        plan_name,
        plan_id,
        plan_type,
        company_id,
        company_name,
        area_company_id,
        area_company_name,
        duty_dept_id,
        duty_dept,
        affiliation_month,
        affiliation_quarter,
        record_type,
        examination_date,
        complete_feedback_id,
        complete_feedback_approve_time,
        PROJECT_NAME,
        AFFILIATION_YEAR,
        PROJECT_ID,
        ORIGINAL_NODE_ID
    )
        SELECT
            get_uuid(),
            node.id,
            node.node_name,
            node.node_level,
            node.standard_score,
            CASE
                WHEN node.actual_end_date IS NULL OR exam.new_examination_score IS NULL THEN
                    0
                WHEN node.actual_end_date IS NOT NULL THEN
                    exam.new_examination_score
            END,
            CASE
                WHEN node.actual_end_date IS NULL THEN
                    0
                WHEN node.actual_end_date IS NOT NULL THEN
                    ROUND(exam.new_examination_score / exam.standard_score,2)*100
            END,
            CASE
                WHEN node.actual_end_date IS NULL THEN
                    '未完成'
                WHEN node.actual_end_date IS NOT NULL THEN
                    '已完成'
            END,
            node.plan_start_date,
            node.plan_end_date,
            node.actual_start_date,
            node.actual_end_date,
            CASE 
 --未到期不亮灯
                WHEN node.actual_end_date IS NULL
                     AND trunc(SYSDATE) - trunc(node.plan_end_date) <= 0 THEN
                    ''
 --到期当天内完成反馈
                WHEN node.actual_end_date IS NOT NULL
                     AND ( trunc(node.actual_end_date) - trunc(node.plan_end_date) ) <= 0 THEN
                    '<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>'
  --到期1-5天内完成反馈
                WHEN node.actual_end_date IS NOT NULL
                     AND ( trunc(node.actual_end_date) - trunc(node.plan_end_date) ) BETWEEN 1 AND 5 THEN
                    '<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>'
 --到期未反馈黄灯 
                WHEN node.actual_end_date IS NULL
                     AND ( trunc(SYSDATE) - trunc(node.plan_end_date) ) BETWEEN 1 AND 5 THEN
                    '<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>' 
  --到期超过5天未反馈红灯 
                WHEN node.actual_end_date IS NULL
                     AND ( ( trunc(SYSDATE) - trunc(node.plan_end_date) ) > 5 ) THEN
                    '<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'
                ELSE
                    '<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'
            END,
            plan.plan_name,
            plan.id,
            plan.plan_type,
            plan.company_id,
            plan.company_name,
            case when biz.level_rank=1 then
            plan.company_id
            when biz.level_rank <>1 then
             biz.id end,
            case when biz.level_rank=1 then
            plan.company_name
            when biz.level_rank <>1  then
            biz.org_name end,
            node.duty_department_id,
            node.duty_department,
            case when currentmonth is not null then 
            currentmonth
            when currentmonth is null then 
            to_number(TO_CHAR(sysdate,'MM')) end,
            NULL,
            0,
            CASE
                WHEN node.actual_end_date IS NULL THEN
                    NULL
                WHEN node.actual_end_date IS NOT NULL THEN
--                    feedback.approval_time
(select approval_time from pom_node_feedback where feedback_node_id=node.id and feedback_type='CARRY_OUT')
            END,
            CASE
                WHEN node.actual_end_date IS NULL THEN
                    NULL
                WHEN node.actual_end_date IS NOT NULL THEN
                    exam.id
            END AS complete_feedback_id,
            CASE
                WHEN node.actual_end_date IS NULL THEN
                    NULL
                WHEN node.actual_end_date IS NOT NULL THEN
                    exam.complete_feedback_approve_time
            END,
            plan.proj_name,
            to_number(TO_CHAR(node.plan_end_date, 'yyyy')),
            plan.proj_id,
            node.ORIGINAL_NODE_ID
        FROM
            pom_proj_plan          plan
            INNER JOIN pom_proj_plan_node     node ON plan.id = node.proj_plan_id
            LEFT JOIN sys_business_unit      business ON plan.company_id = business.id
            LEFT JOIN sys_business_unit      biz ON business.parent_id = biz.id
--            LEFT JOIN pom_node_feedback      feedback ON feedback.feedback_node_id = node.id
            LEFT JOIN pom_node_examination   exam ON exam.node_id = node.id
        WHERE
            plan.approval_status = '已审核'
            AND node.is_disable = 0
            AND ( plan.plan_type = '项目主项计划'
                  OR plan.plan_type = '关键节点计划' )
            AND (node.plan_end_date < v_monthend AND  node.plan_end_date > v_monthbegin);
commit;
END p_pom_node_month_photograph;
/

prompt
prompt Creating procedure P_POM_NODE_QUART_PHOTOGRAPH
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_NODE_QUART_PHOTOGRAPH" (
    year   IN  NUMBER,
    currentquarter IN NUMBER
)

--作者：yder
--日期：2020-06-10
--描述：记录节点考核 “季度”数据
 AS
    v_currentquarter NUMBER;
    v_currentdate   VARCHAR2(20);
    v_monthbegin     DATE;
    v_monthend       DATE;
    v_quarterbegin   DATE;
    v_quarterend     DATE;
    v_yearbegin      DATE;
    v_yearend        DATE; 
BEGIN
    IF currentquarter IS NULL THEN
        v_currentquarter := to_number(TO_CHAR(SYSDATE, 'q'));
    ELSE
        v_currentquarter := currentquarter;
    END IF;

    IF year is not null then
        SELECT TO_CHAR(ADD_MONTHS(ADD_MONTHS(TRUNC(to_date(year,'YYYY')),A * 3),-ROWNUM),'yyyy-MM-dd')  INTO  v_currentdate 
        FROM (SELECT v_currentquarter A FROM DUAL)  
        CONNECT BY ROWNUM <= 1 
        ORDER BY 1;  
    else 
        SELECT TO_CHAR(ADD_MONTHS(ADD_MONTHS(TRUNC(SYSDATE, 'YYYY'),A * 3),-ROWNUM),'yyyy-MM-dd')  INTO  v_currentdate 
        FROM (SELECT v_currentquarter A FROM DUAL)  
        CONNECT BY ROWNUM <= 1 
        ORDER BY 1;  
    END IF;   

    P_POM_MONTH_QUARTER_YEAR(
        now_date =>to_date(v_currentdate,'yyyy-MM-dd'),
        o_m_begin => v_monthbegin,
        o_m_end => v_monthend,
        o_quarter_begin => v_quarterbegin,
        o_quarter_end => v_quarterend,
        o_year_begin => v_yearbegin,
        o_year_end => v_yearend
    );

-- 为保证拍照数据不重复，先删除记录类型为'1'并且计划完成日期或者实际完成日期为该季度的节点
    DELETE POM_NODE_PHOTOGRAPH WHERE  (plan_end_date < v_quarterend AND  plan_end_date > v_quarterbegin) AND record_type=1;
--批量插入月度拍照数据
    INSERT INTO POM_NODE_PHOTOGRAPH (
        id,
        node_id,
        node_name,
        node_level,
        standard_score,
        examination_score,
        scoring_percentage,
        completion_status,
        plan_start_date,
        plan_end_date,
        actual_start_date,
        actual_end_date,
        alert_status,
        plan_name,
        plan_id,
        plan_type,
        company_id,
        company_name,
        area_company_id,
        area_company_name,
        duty_dept_id,
        duty_dept,
        affiliation_month,
        affiliation_quarter,
        record_type,
        examination_date,
        complete_feedback_id,
        complete_feedback_approve_time,
        PROJECT_NAME,
        AFFILIATION_YEAR,
        PROJECT_ID,
        ORIGINAL_NODE_ID
    )
        SELECT
        distinct
            get_uuid(),
            node.id,
            node.node_name,
            node.node_level,
            node.standard_score,
            CASE
                WHEN node.actual_end_date IS NULL THEN
                    0
                WHEN node.actual_end_date IS NOT NULL THEN
                    exam.new_examination_score
            END,
            CASE
                WHEN node.actual_end_date IS NULL THEN
                    0
                WHEN node.actual_end_date IS NOT NULL THEN
                    ROUND(exam.new_examination_score / exam.standard_score,2)*100
            END,
            CASE
                WHEN node.actual_end_date IS NULL THEN
                    '未完成'
                WHEN node.actual_end_date IS NOT NULL THEN
                    '已完成'
            END,
            node.plan_start_date,
            node.plan_end_date,
            node.actual_start_date,
            node.actual_end_date,
            CASE 
 --未到期不亮灯
                WHEN node.actual_end_date IS NULL
                     AND trunc(SYSDATE) - trunc(node.plan_end_date) <= 0 THEN
                    ''
 --到期当天内完成反馈
                WHEN node.actual_end_date IS NOT NULL
                     AND ( trunc(node.actual_end_date) - trunc(node.plan_end_date) ) <= 0 THEN
                    '<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>'
  --到期1-5天内完成反馈
                WHEN node.actual_end_date IS NOT NULL
                     AND ( trunc(node.actual_end_date) - trunc(node.plan_end_date) ) BETWEEN 1 AND 5 THEN
                    '<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>'
 --到期未反馈黄灯 
                WHEN node.actual_end_date IS NULL
                     AND ( trunc(SYSDATE) - trunc(node.plan_end_date) ) BETWEEN 1 AND 5 THEN
                    '<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>' 
  --到期超过5天未反馈红灯 
                WHEN node.actual_end_date IS NULL
                     AND ( ( trunc(SYSDATE) - trunc(node.plan_end_date) ) > 5 ) THEN
                    '<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'
                ELSE
                    '<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'
            END,
            plan.plan_name,
            plan.id,
            plan.plan_type,
            plan.company_id,
            plan.company_name,
             case when biz.level_rank=1 then
            plan.company_id
            when biz.level_rank <>1 then
             biz.id end,
            case when biz.level_rank=1 then
            plan.company_name
            when biz.level_rank <>1  then
            biz.org_name end,
            node.duty_department_id,
            node.duty_department,
            NULL,
            case when currentquarter is not null then 
             currentquarter
             when currentquarter is null then
            to_number(TO_CHAR(sysdate, 'q')) end,
            1,
            CASE
                WHEN node.actual_end_date IS NULL THEN
                    NULL
                WHEN node.actual_end_date IS NOT NULL THEN
--                    feedback.approval_time
(select approval_time from pom_node_feedback where feedback_node_id=node.id and feedback_type='CARRY_OUT')
            END,
            CASE
                WHEN node.actual_end_date IS NULL THEN
                    NULL
                WHEN node.actual_end_date IS NOT NULL THEN
                    exam.id
            END AS complete_feedback_id,
            CASE
                WHEN node.actual_end_date IS NULL THEN
                    NULL
                WHEN node.actual_end_date IS NOT NULL THEN
                    exam.complete_feedback_approve_time
            END,
            plan.proj_name,
            to_number(TO_CHAR(node.plan_end_date, 'yyyy')),
            plan.proj_id,
            node.ORIGINAL_NODE_ID
        FROM
            pom_proj_plan          plan
            INNER JOIN pom_proj_plan_node     node ON plan.id = node.proj_plan_id
            LEFT JOIN sys_business_unit      business ON plan.company_id = business.id
            LEFT JOIN sys_business_unit      biz ON business.parent_id = biz.id
--            LEFT JOIN pom_node_feedback      feedback ON feedback.feedback_node_id = node.id
            LEFT JOIN pom_node_examination   exam ON exam.node_id = node.id
        WHERE
            plan.approval_status = '已审核'
            AND  node.is_disable=0	
            AND  node.fission_source_original_id is null
            AND ( plan.plan_type = '项目主项计划'
                  OR plan.plan_type = '关键节点计划' )
            AND (node.plan_end_date < v_quarterend AND  node.plan_end_date > v_quarterbegin) ;

END p_pom_node_quart_photograph;
/

prompt
prompt Creating procedure P_POM_OUT_EXCEL
prompt ==================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_OUT_EXCEL
( 
    PROJID      IN VARCHAR2 --输入变量：项目
   ,CURRENTTYPE IN VARCHAR2
   , --完成节点类型(本月任务,超期未完成任务,所有未完成任务,所有已完成任务,所有任务,次月任务,本季度任务,本年任务)
    userid        IN            VARCHAR2,--用户id用于过滤关注的任务
    currentcompanyid     IN     VARCHAR2,--当前用户的公司
    currentstationid     IN            VARCHAR2,---当前用户的岗位
    currentdeptid        IN            VARCHAR2,---当前用户的部门
    bizcode       IN            VARCHAR2,---权限code
    ITEMS       OUT SYS_REFCURSOR
   ,TOTAL       OUT INT
) IS
    --本部门负责的任务
    --作者：陈丽
    --日期：2019/11/15

    V_SQL_START       CLOB;
    V_SQL_END         CLOB;
    V_SQL_CONTENT     CLOB;
    V_SQL             CLOB;
    V_SQL_EXEC        CLOB;
    V_SQL_EXEC_PAGING CLOB;
    V_WHERE           VARCHAR2(500);
    TESTMSG           NVARCHAR2(200);
    v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN
    ----------------------------------------------------统一解析
    TESTMSG := 'projid:' || PROJID ||'；currenttype:' || CURRENTTYPE;

    BEGIN
        TOTAL         := 1000;
        V_SQL_START   := ' case ';
        V_SQL_CONTENT := '';
        V_SQL_END     := '  else '''' end  ';


        --调用数据权限验证存储过程
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
        --1.拼接查询语句
        FOR ITEM IN (SELECT S.EXPRESSION, VV.NODE_LEVEL, VV.PLAN_TYPE
                     FROM   POM_RULE_SET S
                     LEFT   JOIN (SELECT MAX(S.CREATED_TIME) AS T, NODE_LEVEL, PLAN_TYPE
                                 FROM   POM_RULE_SET S
                                 LEFT   JOIN POM_RULE_SET_PLAN_TYPE PT
                                 ON     S.ID = PT.RULE_ID
                                 WHERE  RULE_TYPE = '亮灯规则'
                                       -- AND plan_type != '关键节点计划'
                                        AND
                                        S.IS_DISABLE = 0
                                 GROUP  BY NODE_LEVEL, PLAN_TYPE) VV
                     ON     S.CREATED_TIME = VV.T AND
                            S.NODE_LEVEL = VV.NODE_LEVEL
                     WHERE  VV.T IS NOT NULL)
        LOOP
            ---拼接字符串
            V_SQL_CONTENT := V_SQL_CONTENT || '  when plan_type=''' || CASE ITEM.PLAN_TYPE
                                 WHEN '项目全景计划' THEN
                                  '项目主项计划'
                                 ELSE
                                  ITEM.PLAN_TYPE
                             END || ''' and node_level=''' || ITEM.NODE_LEVEL || ''' then (' || ITEM.EXPRESSION || ')';
        END LOOP;

        --dbms_output.put_line('123333');
        --dbms_output.put_line(v_sql_content);
        --规则内容大于0才拼规则语句

        IF LENGTH(V_SQL_CONTENT) > 0
        THEN
            V_SQL := V_SQL_START || V_SQL_CONTENT || V_SQL_END;
        ELSE
            --无规则亮灯显示空
            V_SQL := '''''';
        END IF;

        -------------------------------------------------------------------------------------------内容


        IF CURRENTTYPE = '本月任务'
        THEN
            V_WHERE := ' and ACTUAL_END_DATE is null and (PLAN_END_DATE>=trunc(sysdate, ''month'') and PLAN_END_DATE<=trunc(last_day(sysdate))) ';
        ELSIF CURRENTTYPE = '超期未完成任务'
        THEN
            V_WHERE := ' and TRUNC(SYSDATE) > PLAN_END_DATE and ACTUAL_END_DATE is null';
        ELSIF CURRENTTYPE = '所有未完成任务'
        THEN
            V_WHERE := ' and ACTUAL_END_DATE is null ';
        ELSIF CURRENTTYPE = '所有已完成任务'
        THEN
            V_WHERE := ' and ACTUAL_END_DATE is not null ';
        ELSE
            V_WHERE := ' and 1=2';
        END IF;

        --3.拼接完整语句
        IF PROJID<>'111' THEN 
        V_SQL_EXEC := ' select  rownum as rowno,ID,
                    ORIGINAL_NODE_ID,
                    ORIGINAL_PLAN_ID,
                    PROJ_PLAN_ID as PLAN_ID,
                    PLAN_TYPE_INT,
                    NODE_NAME,
                    PLAN_NAME,
                    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
                    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
                    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
                    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
                    case when ACTUAL_END_DATE is null then ''未完成''
                    else ''已完成'' end as COMPLETION_STATUS,
                    PROJ_NAME,
                    PLAN_TYPE,
                    DUTY_DEPARTMENT,
                    CHARGE_PERSON,
                    NODE_LEVEL,
                    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,w_Url,' || V_SQL || ' as NODE_WARNING from (select n.*,w.IS_UN_WATCH
                ,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
                ,case when n.ACTUAL_END_DATE IS NOT NULL THEN NULL 
                ELSE ''催办'' END as HASTEN
                ,case when w.IS_UN_WATCH=0 then ''/api/pom/planfollow/unfollow?cancelType=0=724=300=''||ORIGINAL_NODE_ID else ''/pom/biz-watch/bizwatch-setting?cancelType=0=724=300==''||ORIGINAL_NODE_ID end as w_Url

                                      from(SELECT
                    n.ID,
                     p.ORIGINAL_PLAN_ID,
                    ORIGINAL_NODE_ID,
                    n.PROJ_PLAN_ID,
                    CASE p.PLAN_TYPE
                        WHEN ''关键节点计划''   THEN
                            0
                        WHEN ''项目主项计划''   THEN
                            1
                    END AS PLAN_TYPE_INT,

                    NODE_NAME,
                    p.PLAN_NAME,--计划名称
                    PLAN_START_DATE,
                    PLAN_END_DATE,

                    ACTUAL_END_DATE,
                    ESTIMATE_END_DATE,           --预计完成时间
                    p.PROJ_NAME,          --所属项目
                    p.PLAN_TYPE,        --计划类型显示名
                    DUTY_DEPARTMENT,          --主责部门
                    person.CHARGE_PERSON,
                    NODE_LEVEL,           --任务等级
                    STANDARD_SCORE          --标准分值
                FROM
                    POM_PROJ_PLAN_NODE n LEFT
                    JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
                    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON n.ID=person.NODE_ID
                    LEFT JOIN SYS_PROJECT_STAGE sps on p.proj_id=sps.id 
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal 
                    ON (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null 
                    AND   p.PLAN_TYPE=''关键节点计划'' AND NVL(n.IS_DISABLE,0) <> 1 and APPROVAL_STATUS=''已审核''
                    AND (p.PROJ_ID=''' || PROJID || ''' OR p.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''' || PROJID || '''))  ' || V_WHERE || '
                )n
                    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID  )  a ';
        ELSE
            V_SQL_EXEC := 'select  rownum as rowno,ID,
                    ORIGINAL_NODE_ID,
                    ORIGINAL_PLAN_ID,
                    PROJ_PLAN_ID as PLAN_ID,
                    PLAN_TYPE_INT,
                    NODE_NAME,
                    PLAN_NAME,
                    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
                    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
                    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
                    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
                    case when ACTUAL_END_DATE is null then ''未完成''
                    else ''已完成'' end as COMPLETION_STATUS,
                    PROJ_NAME,
                    PLAN_TYPE,
                    DUTY_DEPARTMENT,
                    CHARGE_PERSON,
                    NODE_LEVEL,
                    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,w_Url,' || V_SQL || ' as NODE_WARNING from (select n.*,w.IS_UN_WATCH
                ,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
                ,case when n.ACTUAL_END_DATE IS NOT NULL THEN NULL 
                ELSE ''催办'' END as HASTEN
                ,case when w.IS_UN_WATCH=0 then ''/api/pom/planfollow/unfollow?cancelType=0=724=300=''||ORIGINAL_NODE_ID else ''/pom/biz-watch/bizwatch-setting?cancelType=0=724=300==''||ORIGINAL_NODE_ID end as w_Url

                                      from(SELECT
                    n.ID,
                     p.ORIGINAL_PLAN_ID,
                    ORIGINAL_NODE_ID,
                    n.PROJ_PLAN_ID,
                    CASE p.PLAN_TYPE
                        WHEN ''关键节点计划''   THEN
                            0
                        WHEN ''项目主项计划''   THEN
                            1
                    END AS PLAN_TYPE_INT,

                    NODE_NAME,
                    p.PLAN_NAME,--计划名称
                    PLAN_START_DATE,
                    PLAN_END_DATE,

                    ACTUAL_END_DATE,
                    ESTIMATE_END_DATE,           --预计完成时间
                    p.PROJ_NAME,          --所属项目
                    p.PLAN_TYPE,        --计划类型显示名
                    DUTY_DEPARTMENT,          --主责部门
                    person.CHARGE_PERSON,
                    NODE_LEVEL,           --任务等级
                    STANDARD_SCORE          --标准分值
                FROM
                    POM_PROJ_PLAN_NODE n LEFT
                    JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
                    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON n.ID=person.NODE_ID
                    LEFT JOIN SYS_PROJECT_STAGE sps on p.proj_id=sps.id 
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal 
                    ON (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null 
                    AND   p.PLAN_TYPE=''关键节点计划'' AND NVL(n.IS_DISABLE,0) <> 1 and APPROVAL_STATUS=''已审核''
                     ' || V_WHERE || '
                )n
                    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID  ) a ';
        END IF;
        -------------------------------------------------------------------------------------------内容

        V_SQL_EXEC_PAGING := '
select a.* from ( ' || V_SQL_EXEC || ')a';

        DBMS_OUTPUT.PUT_LINE(V_SQL_EXEC);
        ----获取总条数
        EXECUTE IMMEDIATE 'SELECT count(rowno) from(' || V_SQL_EXEC || ') a '
            INTO TOTAL;

        -- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN ITEMS FOR V_SQL_EXEC_PAGING;
        --SELECT '' A FROM DUAL;

    EXCEPTION
        WHEN OTHERS THEN
            TESTMSG := SQLERRM || TESTMSG;
            OPEN ITEMS FOR
                SELECT '失败咯' || TESTMSG PLAN_NAME FROM DUAL;

            DBMS_OUTPUT.PUT_LINE(SQLERRM);
    END;

END P_POM_OUT_EXCEL;
/

prompt
prompt Creating procedure P_POM_PERMIT_ID_LIST
prompt =======================================
prompt
create or replace procedure pom0813.P_POM_PERMIT_ID_LIST(
    info out SYS_REFCURSOR,
    originNodeId in varchar2
) is
--根据裂变原始节点Id查询所有节点所关联的证照id
--作者：韩金明
--日期：2010/02/28
--输入变量：裂变原始节点Id
begin
    open info for
        select fb.PERMIT_ID
        from POM_NODE_FEEDBACK fb
        left join POM_PROJ_PLAN_NODE node on fb.id = node.FISSION_SOURCE_ORIGINAL_ID
        left join POM_PROJ_PLAN plan on node.PROJ_PLAN_ID = plan.id
        where plan.ORIGINAL_PLAN_ID = originNodeId;
    -- 将原始节点id传入POM_PROJ_PLAN查询所有裂变计划
    -- 关联计划节点id
end P_POM_PERMIT_ID_LIST;
/

prompt
prompt Creating procedure P_POM_PLAN_COMPLETIONRANKING
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_plan_completionranking (
    companyid          IN                 VARCHAR2,--公司id
    currentcompanyid   IN                 VARCHAR2,--当前用户的公司
    userid             IN                 VARCHAR2,--用户id用于过滤关注的任务
    currentstationid   IN                 VARCHAR2,---当前用户的岗位
    currentdeptid      IN                 VARCHAR2,---当前用户的部门
    bizcode            IN                 VARCHAR2,---权限code
    authdata           OUT                SYS_REFCURSOR,--有权限数据的ID集合
    datasource              OUT                SYS_REFCURSOR --亮灯信息
) AS
--项目主项计划监控项目完成率前排行榜
--作者：叶丁荣
--日期：2020/03/20
    v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN
--调用数据权限验证存储过程
    p_sys_auth_data_rule_spid(userid => userid, stationid => currentstationid, deptid => currentdeptid, companyid => currentcompanyid
    , bizcode => bizcode, data_auth_spid => v_spid);

    OPEN datasource FOR SELECT
                      ROWNUM,
                      b1."fullName",
                      b1."competationRate",
                      b1."projtId"
                  FROM
                      sys_business_unit a1
                      LEFT JOIN (
                          SELECT
                              '【'
                              || a.company_name
                              || '】'
                              || d.project_name
                              ||
                                  CASE
                                      WHEN c.stage_name NOT LIKE '%无分期%' THEN
                                          '_' || c.stage_name
                                      ELSE
                                          NULL
                                  END
                              AS "fullName",
                              c.id   AS "projtId",
                              a.company_id,
                              COUNT(b.id) AS "TOTALNODECOUNT",
                              SUM(
                                  CASE
                                      WHEN b.actual_end_date IS NOT NULL THEN
                                          1
                                      ELSE
                                          0
                                  END
                              ) AS "actualEndNodeCount",
                              round(SUM(
                                  CASE
                                      WHEN b.actual_end_date IS NOT NULL THEN
                                          1
                                      ELSE
                                          0
                                  END
                              ) /(

                                   CASE
                                      WHEN COUNT(b.id) = 0 THEN
                                          1
                                      ELSE
                                          COUNT(b.id)
                                  END

                              ),4) AS "competationRate"
--完成率说明：截止当前完成节点数量/截止当前应完成任务数量    亮灯规则说明：1）绿灯：完成率≥95% 2）黄灯：95%>完成率≥90% 3）红灯：完成率＜90%
                          FROM
                              pom_proj_plan        a
                              INNER JOIN pom_proj_plan_node   b ON a.id = b.proj_plan_id
                              INNER JOIN sys_project_stage    c ON c.id = proj_id
                              INNER JOIN sys_project          d ON d.id = c.project_id
                          WHERE
                              a.plan_type = '项目主项计划'
                              AND a.approval_status = '已审核'
                              AND b.is_disable = 0
                              AND b.plan_end_date is not null
                              AND b.plan_end_date <= SYSDATE
                          GROUP BY
                              '【'
                              || a.company_name
                              || '】'
                              || d.project_name
                              ||
                                  CASE
                                      WHEN c.stage_name NOT LIKE '%无分期%' THEN
                                          '_' || c.stage_name
                                      ELSE
                                          NULL
                                  END,
                              a.company_id,
                              a.company_name,
                              c.id
                      ) b1 ON b1.company_id = a1.id
                      LEFT JOIN (
                          SELECT
                              wm_concat(user_name) AS user_name,
                              project_id
                          FROM
                              sys_role_user_relation_result
                          WHERE
                              role_code = 'pom_project_plan_manager'
                          GROUP BY
                              project_id
                      ) c1 ON c1.project_id = b1."projtId"
                  WHERE
                      nvl(b1.totalnodecount, 0) > 0
                      AND ROWNUM <= 10
                      AND CONNECT_BY_ROOT id = ''
                                               || companyid
                                               || ''
                  CONNECT BY
                      PRIOR a1.id = a1.parent_id
                  ORDER BY
                      b1."competationRate" DESC;

    OPEN authdata FOR SELECT
                      b1."projtId"
                  FROM
                      sys_business_unit a1
                      LEFT JOIN (
                          SELECT
                              c.id   AS "projtId",
                              a.company_id
                          FROM
                              pom_proj_plan        a
                              INNER JOIN pom_proj_plan_node   b ON a.id = b.proj_plan_id
                              INNER JOIN sys_project_stage    c ON c.id = proj_id
                              INNER JOIN sys_project          d ON d.id = c.project_id
                              LEFT  JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                              on (case when c.id is not null then c.PROJECT_ID else a.proj_id end)=tal.orgId
                            WHERE
                              a.plan_type = '项目主项计划'
                              AND a.approval_status = '已审核'
                              AND b.is_disable = 0
                          GROUP BY
                              a.company_id,
                              a.company_name,
                              c.id
                      ) b1 ON b1.company_id = a1.id
                      LEFT JOIN (
                          SELECT
                              wm_concat(user_name) AS user_name,
                              project_id
                          FROM
                              sys_role_user_relation_result
                          WHERE
                              role_code = 'pom_project_plan_manager'
                          GROUP BY
                              project_id
                      ) c1 ON c1.project_id = b1."projtId"
                  WHERE
                      b1."projtId" is not null
                      AND CONNECT_BY_ROOT id = ''
                                               || companyid
                                               || ''
                                                CONNECT BY
                      PRIOR a1.id = a1.parent_id
                ;

END p_pom_plan_completionranking;
/

prompt
prompt Creating procedure P_POM_PLAN_MONITOR_LIST
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_plan_monitor_list (
    plantype    IN          VARCHAR2, --输入变量：计划类型
    currentcompanyid   IN                 VARCHAR2,--当前用户的公司
    userid             IN                 VARCHAR2,--用户id用于过滤关注的任务
    currentstationid   IN                 VARCHAR2,---当前用户的岗位
    currentdeptid      IN                 VARCHAR2,---当前用户的部门
    bizcode            IN                 VARCHAR2,---权限code
    pageindex   IN          VARCHAR2,--输入变量：页码
    pagesizes    IN          VARCHAR2,--输入面临：页面条数
    items       OUT         SYS_REFCURSOR
) IS
    v_where              CLOB;
    v_sql_exec          CLOB;
    v_sql_exec_paging   CLOB;
    v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN
    --调用数据权限验证存储过程
    p_sys_auth_data_rule_spid(userid => userid, stationid => currentstationid, deptid => currentdeptid, companyid => currentcompanyid
    , bizcode => bizcode, data_auth_spid => v_spid);
    
  execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd hh24:mi:ss''';
    IF plantype = '关键节点计划' THEN
        v_where:= 'AND plan.PLAN_TYPE = ''关键节点计划''';
    ELSE
        v_where := 'AND plan.PLAN_TYPE = ''项目主项计划''';
    END IF;

 --open items for select * from  TMP_AUTH_LIST where id =v_spid ;
v_sql_exec:='SELECT  rownum as "rowno","userName", "executionTime","executionContent", "executionType","orgid","projid","stageid","deptid","ncompanyid","pcompanyid" from
(select "userName","executionTime","executionContent","executionType","orgid","projid","stageid","deptid","ncompanyid","pcompanyid" from (
SELECT
    back.FEEDBACKER AS "userName",
    back.CREATED AS "executionTime",
    case when  FEEDBACK_TYPE=''PROCESS'' then
    ''<span style="color:#A2A2A2">反馈了任务:</span> ''|| ( ''【'' || stage.STAGE_FULL_NAME || ''】''|| node.node_name )
    when FEEDBACK_TYPE=''CARRY_OUT'' then
    ''<span style="color:#A2A2A2">完成了任务:</span>''|| ( ''【'' || stage.STAGE_FULL_NAME || ''】''|| node.node_name ) 

     else 
     ''<span style="color:#A2A2A2">反馈了超期未完成任务:</span>''|| ( ''【'' || stage.STAGE_FULL_NAME || ''】''|| node.node_name ) 
     end  AS "executionContent",
	case when  FEEDBACK_TYPE=''PROCESS'' then
        ''feedback''
     when FEEDBACK_TYPE=''CARRY_OUT'' then
        ''complete''
     else
        ''overdu''
     end AS "executionType",
     tal.org_id AS "orgid",
     plan.proj_id AS "projid",
     stage.id AS "stageid",
     node.duty_department_id AS "deptid",
     node.company_id AS "ncompanyid",
     plan.company_id AS "pcompanyid"
     
--     to_char(back.CREATED,''yyyy-mm-dd'') as "groupDate"
    FROM
	pom_proj_plan_node node
	LEFT JOIN pom_proj_plan plan ON node.proj_plan_id = plan.id
    LEFT JOIN SYS_PROJECT_STAGE stage on plan.proj_id=stage.id
    LEFT JOIN SYS_PROJECT proj
    on (case when stage.id is not null then stage.ID else plan.proj_id end)=proj.id
    INNER join pom_node_feedback back on back.FEEDBACK_NODE_ORIGINAL_ID=node.original_node_id
    INNER JOIN (select * from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    ON plan.proj_id=tal.org_id OR node.company_id=tal.org_id OR stage.id=tal.org_id OR plan.company_id=tal.org_id
    OR node.duty_department_id=tal.org_id
    where plan.ID is not null and plan.APPROVAL_STATUS=''已审核'' '|| v_where||'
    UNION ALL
   SELECT
    message.user_name AS "userName",
      message.created_time AS "executionTime",
    ''<span style="color:#A2A2A2">催办了任务:</span>''|| ( ''【'' || stage.STAGE_FULL_NAME || ''】''|| node.node_name )   AS "executionContent",
    ''urge'' AS "executionType",
     tal.org_id AS "orgid",
     plan.proj_id AS "projid",
     stage.id AS "stageid",
     node.duty_department_id AS "deptid",
     node.company_id AS "ncompanyid",
     plan.company_id AS "pcompanyid"
FROM
    pom_proj_plan_node   node
    LEFT JOIN pom_proj_plan        plan ON node.proj_plan_id = plan.id
    LEFT JOIN sys_project_stage    stage ON plan.proj_id = stage.id
    LEFT JOIN sys_project          proj ON (
        CASE
            WHEN stage.id IS NOT NULL THEN
                stage.ID
            ELSE
                plan.proj_id
        END
    ) = proj.id
    INNER JOIN (
         SELECT
            msg.biz_key,
            msg.biz_msg_category,
            msg.created_time,
            sms.sender_id      AS "sms_sender_id",
            sms.sms_content,
            wechat.sender_id   AS "wechat_sender_id",
            wechat.title,
            suser.user_name
        FROM
            sys_msg_record_biz      msg
            LEFT JOIN sys_msg_record_sms      sms ON sms.msg_record_biz_id = msg.id
            LEFT JOIN sys_msg_record_wechat   wechat ON wechat.msg_record_biz_id = msg.id
            INNER JOIN sys_user suser on suser.user_code=sms.sender_id OR suser.id=wechat.sender_id
        WHERE
            msg.biz_msg_category = ''催办消息'' 
    ) message ON message.biz_key = node.original_node_id
--    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
--    ON (case when stage.id is not null then stage.PROJECT_ID else plan.proj_id end)=tal.orgId
    INNER JOIN (select * from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    ON plan.proj_id=tal.org_id OR node.company_id=tal.org_id OR stage.id=tal.org_id OR plan.company_id=tal.org_id
    OR node.duty_department_id=tal.org_id
    WHERE  plan.APPROVAL_STATUS=''已审核'' '|| v_where||'
    UNION ALL
    select
    '''' AS "userName",
    to_date(  to_char("executionTime",''yyyy-mm-dd'')||'' 23:59:59'' ) AS "executionTime",
    ''''  AS "executionContent",
    to_char("executionTime",''mm"月"dd"日"'') "executionType",
     null AS "orgid",
     null AS "projid",
     null AS "stageid",
     null AS "deptid",
     null AS "ncompanyid",
     null AS "pcompanyid" from (
SELECT
    back.FEEDBACKER AS "userName",
    back.CREATED AS "executionTime",
    case when  FEEDBACK_TYPE=''PROCESS'' then
    ''反馈了任务 ''|| ( ''【'' || stage.STAGE_FULL_NAME || ''】''|| node.node_name )
    when FEEDBACK_TYPE=''CARRY_OUT'' then
    ''完成了任务''|| ( ''【'' || stage.STAGE_FULL_NAME || ''】''|| node.node_name ) 

     else 
     ''反馈了超期未完成任务''|| ( ''【'' || stage.STAGE_FULL_NAME || ''】''|| node.node_name ) 
     end  AS "executionContent",
  case when  FEEDBACK_TYPE=''PROCESS'' then
        ''feedback''
     when FEEDBACK_TYPE=''CARRY_OUT'' then
        ''overdu''
     else
        ''complete''
     end AS "executionType",
     tal.org_id AS "orgid",
     plan.proj_id AS "projid",
     stage.id AS "stageid",
     node.duty_department_id AS "deptid",
     node.company_id AS "ncompanyid",
     plan.company_id AS "pcompanyid"
--     to_char(back.CREATED,''yyyy-mm-dd'') as "groupDate"
    FROM
  pom_proj_plan_node node
  LEFT JOIN pom_proj_plan plan ON node.proj_plan_id = plan.id
    LEFT JOIN SYS_PROJECT_STAGE stage on plan.proj_id=stage.id
    LEFT JOIN SYS_PROJECT proj
    on (case when stage.id is not null then stage.ID else plan.proj_id end)=proj.id
    INNER join pom_node_feedback back on back.FEEDBACK_NODE_ORIGINAL_ID=node.original_node_id
     INNER JOIN (select * from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    ON plan.proj_id=tal.org_id OR node.company_id=tal.org_id OR stage.id=tal.org_id OR plan.company_id=tal.org_id
    OR node.duty_department_id=tal.org_id
    where plan.ID is not null and plan.APPROVAL_STATUS=''已审核'' '|| v_where||'
    UNION ALL
   SELECT
     message.user_name AS "userName",
      message.created_time AS "executionTime",
    ''催办了任务:''|| ( ''【'' || stage.STAGE_FULL_NAME || ''】''|| node.node_name )   AS "executionContent",
    ''urge'' AS "executionType",
     tal.org_id AS "orgid",
     plan.proj_id AS "projid",
     stage.id AS "stageid",
     node.duty_department_id AS "deptid",
     node.company_id AS "ncompanyid",
     plan.company_id AS "pcompanyid"
FROM
    pom_proj_plan_node   node
    LEFT JOIN pom_proj_plan        plan ON node.proj_plan_id = plan.id
    LEFT JOIN sys_project_stage    stage ON plan.proj_id = stage.id
    INNER JOIN (select * from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    ON plan.proj_id=tal.org_id OR node.company_id=tal.org_id OR stage.id=tal.org_id OR plan.company_id=tal.org_id
    OR node.duty_department_id=tal.org_id
    INNER JOIN (
         SELECT
            msg.biz_key,
            msg.biz_msg_category,
            msg.created_time,
            sms.sender_id      AS "sms_sender_id",
            sms.sms_content,
            wechat.sender_id   AS "wechat_sender_id",
            wechat.title,
            suser.user_name
        FROM
            sys_msg_record_biz      msg
            LEFT JOIN sys_msg_record_sms      sms ON sms.msg_record_biz_id = msg.id
            LEFT JOIN sys_msg_record_wechat   wechat ON wechat.msg_record_biz_id = msg.id
            INNER JOIN sys_user suser on suser.user_code=sms.sender_id OR suser.id=wechat.sender_id
        WHERE
            msg.biz_msg_category = ''催办消息'' 
    ) message ON message.biz_key = node.original_node_id   WHERE  plan.APPROVAL_STATUS=''已审核'' '|| v_where||')a
    group by to_char("executionTime",''mm"月"dd"日"'')
    , to_date(  to_char("executionTime",''yyyy-mm-dd'')||'' 23:59:59'' )) order BY "executionTime" DESC)   ';







      v_sql_exec_paging := '
select a.* from ( '
                         || v_sql_exec
                         || ' where rownum <= '
                         || pageIndex * pageSizes
                         || ' ) a where a."rowno" > '
                         || pagesizes * ( pageindex - 1 )
                         || '';

    dbms_output.put_line(v_sql_exec_paging);
    OPEN items FOR v_sql_exec_paging;

END p_pom_plan_monitor_list;
/

prompt
prompt Creating procedure P_POM_PLAN_MONITOR_TASK_COUNT
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_PLAN_MONITOR_TASK_COUNT ( plantype IN VARCHAR2, --输入变量：计划类型
    currentcompanyid   IN                 VARCHAR2,--当前用户的公司
    userid             IN                 VARCHAR2,--用户id用于过滤关注的任务
    currentstationid   IN                 VARCHAR2,---当前用户的岗位
    currentdeptid      IN                 VARCHAR2,---当前用户的部门
    bizcode            IN                 VARCHAR2,---权限code
	beyondtask OUT VARCHAR2,
    completedtodaytask OUT VARCHAR2,
    todotodaytask OUT VARCHAR2 )
 IS
    v_where CLOB;
    v_beyondtask_sql  CLOB;
    v_completedtodaytask_sql  CLOB;
    v_todotodaytask_sql  CLOB;
    v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN
--调用数据权限验证存储过程
    p_sys_auth_data_rule_spid(userid => userid, stationid => currentstationid, deptid => currentdeptid, companyid => currentcompanyid
    , bizcode => bizcode, data_auth_spid => v_spid);

	IF
		plantype = '关键节点计划' THEN
			v_where := 'AND plan.PLAN_TYPE = ''关键节点计划''';
		ELSE v_where := 'AND plan.PLAN_TYPE = ''项目主项计划''';

	END IF;
	--超期任务
    v_beyondtask_sql:=	'SELECT COUNT( * ) FROM POM_PROJ_PLAN_NODE node LEFT JOIN
    POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID 
    LEFT JOIN sys_project_stage    c ON c.id = plan.proj_id
    LEFT JOIN sys_project          d ON d.id = c.project_id
--    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
--    on (case when c.id is not null then c.PROJECT_ID else plan.proj_id end)=tal.orgId
    INNER JOIN (select * from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    ON plan.proj_id=tal.org_id OR node.company_id=tal.org_id OR c.id=tal.org_id OR plan.company_id=tal.org_id
    OR node.duty_department_id=tal.org_id
    WHERE plan.APPROVAL_STATUS=''已审核'' AND node.PLAN_END_DATE IS NOT NULL
    AND ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE ' ||v_where;
    EXECUTE IMMEDIATE  v_beyondtask_sql into beyondtask;
	--今日待办
	 v_completedtodaytask_sql:='SELECT COUNT( * ) FROM POM_PROJ_PLAN_NODE node LEFT JOIN
	 POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID 
     LEFT JOIN sys_project_stage    c ON c.id = plan.proj_id
    LEFT JOIN sys_project          d ON d.id = c.project_id
--    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
--    on (case when c.id is not null then c.PROJECT_ID else plan.proj_id end)=tal.orgId
 INNER JOIN (select * from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    ON plan.proj_id=tal.org_id OR node.company_id=tal.org_id OR c.id=tal.org_id OR plan.company_id=tal.org_id
    OR node.duty_department_id=tal.org_id
     WHERE plan.APPROVAL_STATUS=''已审核'' AND node.PLAN_END_DATE IS NOT NULL
     AND ACTUAL_END_DATE IS NULL AND SYSDATE = node.PLAN_END_DATE ' || v_where;
--     dbms_output.put_line(v_where);
--     dbms_output.put_line(v_completedtodaytask_sql);
     EXECUTE IMMEDIATE  v_completedtodaytask_sql into completedtodaytask;
	--今日完成
	v_todotodaytask_sql:='SELECT COUNT( * ) FROM POM_PROJ_PLAN_NODE node LEFT JOIN
    POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID 
    LEFT JOIN sys_project_stage    c ON c.id = plan.proj_id
    LEFT JOIN sys_project          d ON d.id = c.project_id
--    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
--    on (case when c.id is not null then c.PROJECT_ID else plan.proj_id end)=tal.orgId
    INNER JOIN (select * from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    ON plan.proj_id=tal.org_id OR node.company_id=tal.org_id OR c.id=tal.org_id OR plan.company_id=tal.org_id
    OR node.duty_department_id=tal.org_id
    WHERE plan.APPROVAL_STATUS=''已审核''
	AND	SYSDATE = ACTUAL_END_DATE ' || v_where;
    EXECUTE IMMEDIATE  v_todotodaytask_sql into todotodaytask;
--    dbms_output.put_line(v_where);

END P_POM_PLAN_MONITOR_TASK_COUNT;
/

prompt
prompt Creating procedure P_POM_PLAN_MONITOR_TASK_LIST
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_plan_monitor_task_list (
    plantype    IN          VARCHAR2, --输入变量：计划类型
    tabtype     IN          VARCHAR2, --输入变量：查询类型//超期任务、今日待办、 今日完成
    pageIndex   IN          VARCHAR2,
    pageRows    IN          VARCHAR2,
    currentcompanyid   IN                 VARCHAR2,--当前用户的公司
    userid             IN                 VARCHAR2,--用户id用于过滤关注的任务
    currentstationid   IN                 VARCHAR2,---当前用户的岗位
    currentdeptid      IN                 VARCHAR2,---当前用户的部门
    bizcode            IN                 VARCHAR2,---权限code
    items       OUT         SYS_REFCURSOR
) IS
    v_whre              CLOB;
    v_sql_exec          CLOB;
    nodestatus          VARCHAR2(20);
    v_nodeTime          CLOB;
    v_sql_exec_paging   CLOB;
    v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN
    --调用数据权限验证存储过程
    p_sys_auth_data_rule_spid(userid => userid, stationid => currentstationid, deptid => currentdeptid, companyid => currentcompanyid
    , bizcode => bizcode, data_auth_spid => v_spid);

    IF tabtype = '超期任务' THEN
        v_whre := ' AND ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE AND plan.PLAN_TYPE ='''
                  || plantype
                  || '''';
        v_nodeTime:='TO_CHAR(node.PLAN_END_DATE,''yyyy-mm-dd'') AS "nodeTime"';
        nodestatus := '已超期';
    ELSIF tabtype = '今日待办' THEN
        v_whre := 'AND ACTUAL_END_DATE IS NULL AND SYSDATE = node.PLAN_END_DATE AND plan.PLAN_TYPE ='''
                  || plantype
                  || '''';
        v_nodeTime:='TO_CHAR(node.PLAN_END_DATE,''yyyy-mm-dd'') AS "nodeTime"';
        nodestatus := '未完成';
    ELSE
        v_whre := 'AND SYSDATE = ACTUAL_END_DATE AND plan.PLAN_TYPE ='''
                  || plantype
                  || '''';
        v_nodeTime:='TO_CHAR(node.ACTUAL_END_DATE,''yyyy-mm-dd'') AS "nodeTime"';
        nodestatus := '已完成';
    END IF;

    v_sql_exec := ' SELECT
    rownum as rowno,
	node.id AS "nodeId",
	node.ORIGINAL_NODE_ID AS "nodeOriginalId",
	--plan.plan_name,
	'''
                  || nodestatus
                  || ''' AS "nodeStatus",
	(node.node_name || ''【'' || stage.STAGE_FULL_NAME || ''】'') AS "nodeName",
    plan.plan_type as "nodePlanType",
	'||v_nodeTime||'

    FROM
	pom_proj_plan_node node
	LEFT JOIN pom_proj_plan plan ON node.proj_plan_id = plan.id
    LEFT JOIN SYS_PROJECT_STAGE stage on plan.proj_id=stage.id
    LEFT JOIN SYS_PROJECT proj
    on (case when stage.id is not null then stage.ID else plan.proj_id end)=proj.id
--    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
--    ON (case when stage.id is not null then stage.PROJECT_ID else plan.proj_id end)=tal.orgId
 INNER JOIN (select * from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    ON plan.proj_id=tal.org_id OR node.company_id=tal.org_id OR stage.id=tal.org_id OR plan.company_id=tal.org_id
    OR node.duty_department_id=tal.org_id
where plan.ID is not null and plan.APPROVAL_STATUS=''已审核'''
                  || v_whre;
    v_sql_exec_paging := '
select a.* from ( '
                         || v_sql_exec
                         || ' and rownum <= '
                         || pageIndex * pageRows
                         || ' ) a where a.rowno > '
                         || pageRows * ( pageIndex - 1 )
                         || '';

    dbms_output.put_line(v_sql_exec_paging);
    OPEN items FOR v_sql_exec_paging;

END p_pom_plan_monitor_task_list;
/

prompt
prompt Creating procedure P_POM_PLAN_PERFROM_DYNAMIC
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_PLAN_PERFROM_DYNAMIC
(
		IN_ORG_ID    IN VARCHAR2
	 ,DATASCOPE    IN VARCHAR2
	 ,IN_PLAN_TYPE IN VARCHAR2
	 ,IN_PROJID    IN VARCHAR2
	 ,PAGEINDEX    IN INT
	 ,PAGESIZES    IN INT
	 ,P_PAGETYPE   IN INT
	 ,ITEMS        OUT SYS_REFCURSOR
	 ,TOTAL        OUT INT
) AS
		--传入的参数有三个，1：IN_ORG_ID（公司ID）
		--，2：DATASCOPE（统计期间，3个值“THIS_MONTH、THIS_QUARTER、THIS_YEAR"）
		--，3：PLAN_TYPE（计划类型，预留，估计后面会用的到）
		--，4：P_PAGETYPE（页面类型：1：已延误 2：已完成 3：应完成）//alterby 李小聪
		--关键节点计划-执行动态查询（wangck需要）
		--作者：陈丽
		--日期：2019/12/07
		CURSOR CUR_COMPANY_LIST(V_ORG_ID SYS_BUSINESS_UNIT.ID%TYPE) IS
				SELECT P.ID, P.PARENT_ID, P.ORG_NAME FROM SYS_BUSINESS_UNIT P WHERE P.IS_COMPANY = 1 START WITH P.ID = V_ORG_ID CONNECT BY PRIOR P.ID = P.PARENT_ID;
		V_SQL_TOTAL     CLOB := ' ';
		V_SQL           CLOB := ' ';
		V_SQL_DATASCOPE CLOB := ' ';
		V_COMPANY_LIST  CLOB := ' ';
BEGIN

		DBMS_OUTPUT.PUT_LINE('开始');
		--月度
		--已延误
		IF DATASCOPE = 'thisMonth'
			 AND P_PAGETYPE = 1
		THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL   AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when  TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';
				--月度
				--已完成
		ELSIF DATASCOPE = 'thisMonth'
					AND P_PAGETYPE = 2
		THEN
				V_SQL_DATASCOPE := ' AND  PN.ACTUAL_END_DATE IS  NOT NULL  AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when  TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';

				--月度
				--应完成

		ELSIF DATASCOPE = 'thisMonth'
					AND P_PAGETYPE = 3
		THEN
				V_SQL_DATASCOPE := 'AND PN.PLAN_END_DATE BETWEEN TO_DATE ((SELECT   case when TO_NUMBER(铁建_本月) >1 then     TO_CHAR( A.铁建_本年)  else   TO_CHAR( A.铁建_本年-1) end   ||''-''||case when TO_NUMBER(铁建_本月) >1 then  TO_CHAR( TO_NUMBER(铁建_本月)-1) else''12'' end ||''-''||''26''  FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')  AND
 TO_DATE ((SELECT    A.铁建_本年||''-''||铁建_本月||''-''||''25'' FROM V_POM_GETEXAMINE_MOTH A),''yyyy-mm-dd'')';

				--季度
				--已延误
		ELSIF DATASCOPE = 'thisQuarter'
					AND P_PAGETYPE = 1
		THEN
				V_SQL_DATASCOPE := ' AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL    AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((  SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((  SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
				--季度
				--已完成
		ELSIF DATASCOPE = 'thisQuarter'
					AND P_PAGETYPE = 2
		THEN
				V_SQL_DATASCOPE := 'AND  PN.ACTUAL_END_DATE IS  NOT NULL AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((  SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((  SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
				--季度
				--季度应完成
		ELSIF DATASCOPE = 'thisQuarter'
					AND P_PAGETYPE = 3
		THEN
				V_SQL_DATASCOPE := '  AND PN.PLAN_END_DATE BETWEEN
 TO_DATE((  SELECT A.开始年度||''-''||A.开始月份||''-26''   FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')  AND
 TO_DATE((  SELECT A.结束年度||''-''||A.结束月份||''-25'' FROM V_POM_GETEXAMINE_QUARTER A),''YYYY-MM-DD'')';
				--年度
				--已延误
		ELSIF DATASCOPE = 'thisYear'
					AND P_PAGETYPE = 1
		THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL  
			 AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) ';
				--年度
				--已完成
		ELSIF DATASCOPE = 'thisYear'
					AND P_PAGETYPE = 2
		THEN
				V_SQL_DATASCOPE := 'AND  PN.ACTUAL_END_DATE IS  NOT NULL  
				 AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH)  ';
				--年度
				--应完成
		ELSIF DATASCOPE = 'thisYear'
					AND P_PAGETYPE = 3
		THEN
				V_SQL_DATASCOPE := ' AND  PN.PLAN_END_DATE BETWEEN (SELECT TO_DATE( "铁建_本年"-1||''-12''||''-26'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) AND (SELECT TO_DATE( "铁建_本年"||''-12''||''-25'',''YYYY-MM-DD'') FROM V_POM_GETEXAMINE_MOTH) ';
				--全部，没有时间限
				--已延误
		ELSIF DATASCOPE = 'thisAll'
					AND P_PAGETYPE = 1
		THEN
				V_SQL_DATASCOPE := 'AND TRUNC(SYSDATE)>PN.PLAN_END_DATE  AND  PN.ACTUAL_END_DATE IS   NULL ';
				--计划所有节点
		ELSIF DATASCOPE = 'thisAll'
					AND P_PAGETYPE = 2
		THEN
				V_SQL_DATASCOPE := ' AND   1=1 ';



		END IF;

		FOR ITEM_COMPANY_LIST IN CUR_COMPANY_LIST(IN_ORG_ID)
		LOOP
				/*DBMS_OUTPUT.PUT_LINE(ITEM_COMPANY_LIST.ORG_NAME || ',PARENT_ID' ||
        ITEM_COMPANY_LIST.PARENT_ID || ',ID:' ||
        ITEM_COMPANY_LIST.ID);*/
				V_COMPANY_LIST := V_COMPANY_LIST || '''' || ITEM_COMPANY_LIST.ID || '''' || ',';
		END LOOP;
		--   dbms_output.put_line(V_COMPANY_LIST);
		V_COMPANY_LIST := '(' || SUBSTR(V_COMPANY_LIST, 1, LENGTH(V_COMPANY_LIST) - 1) || ')';
		--     dbms_output.put_line(V_COMPANY_LIST);
		IF V_COMPANY_LIST = '()'
		THEN
				V_COMPANY_LIST := '(''' || IN_ORG_ID || ''')';
		END IF;
		--   dbms_output.put_line(V_COMPANY_LIST);
		V_SQL := V_SQL || 'SELECT PP.COMPANY_ID, PP.COMPANY_NAME AS COMPANY_NAME,PP.PROJ_name AS PROJ_NAME,PP.PLAN_NAME AS PLAN_NAME, PN.ID,PN.PROJ_PLAN_ID,PN.ORIGINAL_NODE_ID,CASE WHEN PN.IS_DISABLE = 0 THEN  PN.NODE_NAME ELSE  ''【禁用】'' || PN.NODE_NAME END AS NODE_NAME, PN.NODE_CODE, PN.NODE_LEVEL, PN.PROJ_STAGE, PN.MAIN_RESPONSIBILITY, PN.DUTY_DEPARTMENT, TO_CHAR(PN.PLAN_START_DATE, ''yyyy-MM-dd'') AS PLAN_START_DATE, TO_CHAR(PN.PLAN_END_DATE, ''yyyy-MM-dd'') AS PLAN_END_DATE, PN.IS_DISABLE, PN.COMPLETION_STANDARD, PN.COMPLETION_RESULTS_REMARK, TO_CHAR(PN.ACTUAL_END_DATE, ''yyyy-MM-dd'') AS ACTUAL_END_DATE
	, case 
 --未到期不亮灯
 WHEN    ACTUAL_END_DATE IS NULL AND  TRUNC( SYSDATE )-trunc(PLAN_END_DATE)<0  THEN ''''
 --到期当天内完成反馈
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE)) <= 0
 then ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
	--到期1-5天内完成反馈
 when  ACTUAL_END_DATE IS  not  NULL   and  (TRUNC( ACTUAL_END_DATE)-trunc(PLAN_END_DATE))   BETWEEN 1 and 5
 then ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
 --到期未反馈黄灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   (trunc(SYSDATE)-trunc(PLAN_END_DATE)) >0
 THEN  ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>'' 
	--到期超过5天未反馈红灯 
 WHEN  ACTUAL_END_DATE IS NULL  and   ((trunc(SYSDATE)-trunc(PLAN_END_DATE)) >5) THEN  ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' 
 ELSE ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'' END
	AS PLAN_STATUS,PN.ESTIMATE_END_DATE,  nps.CHARGE_PERSON
	FROM  pom_proj_plan_node pn 
LEFT JOIN pom_proj_plan pp ON pn.proj_plan_id = pp.id 
LEFT JOIN  SYS_PROJECT_STAGE ps on  ps.id=pp.proj_id
LEFT JOIN SYS_PROJECT pj on  ps.PROJECT_ID =pj.id
LEFT JOIN(  SELECT  NODE_ID, listagg(CHARGE_PERSON,'','') WITHIN GROUP (ORDER BY CHARGE_PERSON )  as CHARGE_PERSON
	FROM POM_NODE_CHARGE_PERSON 
	GROUP BY NODE_ID) nps on  nps.NODE_ID=pn.id
	WHERE  PP.PLAN_TYPE = ''项目主项计划''  AND APPROVAL_STATUS = ''已审核'' AND 1=1 AND PN.IS_DISABLE = 0 
	and  ((pp.proj_id =''' || IN_PROJID || ''' or pn.proj_plan_id=''' || IN_PROJID || '''  OR  pj.id=''' || IN_PROJID || ''' )
	OR PP.COMPANY_ID IN ' || V_COMPANY_LIST || ' ) ' || V_SQL_DATASCOPE || '  ORDER BY PN.PROJ_PLAN_ID,  PN.NODE_CODE';

		DBMS_OUTPUT.PUT_LINE(V_SQL);
		V_SQL_TOTAL := V_SQL_TOTAL || 'SELECT  TO_CHAR(COUNT(pn.ID))
	FROM  pom_proj_plan_node pn 
LEFT JOIN pom_proj_plan pp ON pn.proj_plan_id = pp.id 
LEFT JOIN  SYS_PROJECT_STAGE ps on  ps.id=pp.proj_id
LEFT JOIN SYS_PROJECT pj on  ps.PROJECT_ID =pj.id
LEFT JOIN(  SELECT  NODE_ID, listagg(CHARGE_PERSON,'','') WITHIN GROUP (ORDER BY CHARGE_PERSON )  as CHARGE_PERSON
	FROM POM_NODE_CHARGE_PERSON 
	GROUP BY NODE_ID) nps on  nps.NODE_ID=pn.id
	WHERE  PP.PLAN_TYPE = ''项目主项计划''  AND APPROVAL_STATUS = ''已审核'' AND 1=1 
	and  ((pp.proj_id =''' || IN_PROJID || ''' or pn.proj_plan_id=''' || IN_PROJID || '''  OR  pj.id=''' || IN_PROJID || ''' )
	OR PP.COMPANY_ID IN ' || V_COMPANY_LIST || ' ) ' || V_SQL_DATASCOPE || '  ORDER BY PN.PROJ_PLAN_ID,  PN.NODE_CODE';

		--DBMS_OUTPUT.PUT_LINE(V_SQL_TOTAL);
		EXECUTE IMMEDIATE V_SQL_TOTAL
				INTO TOTAL;
		--   DBMS_OUTPUT.PUT_LINE(TOTAL);
		OPEN ITEMS FOR V_SQL;
END P_POM_PLAN_PERFROM_DYNAMIC;
/

prompt
prompt Creating procedure P_POM_PMP_NODE_COMP_RATE
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_PMP_NODE_COMP_RATE (
     tabType VARCHAR2,
     planType VARCHAR2,
     companyId VARCHAR2,
     nodeLevel VARCHAR2,
     currentcompanyid   IN                 VARCHAR2,--当前用户的公司
     userid             IN                 VARCHAR2,--用户id用于过滤关注的任务
     currentstationid   IN                 VARCHAR2,---当前用户的岗位
     currentdeptid      IN                 VARCHAR2,---当前用户的部门
     bizcode            IN                 VARCHAR2,---权限code
     pageRows INTEGER,
     pageIndex INTEGER,
     nodeList  OUT SYS_REFCURSOR
) IS 
v_condition varchar2(4000);
v_sql clob;
v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN 
v_condition:= ' AND 1=1';
IF(tabType is not null) THEN
    IF(tabType='超期任务')
        then  v_condition:=' and to_char(node.plan_end_date, ''yyyy-MM-dd'') <  to_char(sysdate, ''yyyy-MM-dd'') and node.actual_end_date is null order by node.plan_end_date desc'; 
    ELSIF(tabType='已完成')
        then  v_condition:=' and node.actual_end_date is not null order by node.actual_end_date desc'; 
    END IF;
END IF;

--调用数据权限验证存储过程
    p_sys_auth_data_rule_spid(userid => userid, stationid => currentstationid, deptid => currentdeptid, companyid => currentcompanyid
    , bizcode => bizcode, data_auth_spid => v_spid);

v_sql:='SELECT *
  FROM (SELECT tt.*, ROWNUM AS rowno
    FROM (  
        select 
            node.id as "nodeId",
            node.original_node_id as "nodeOriginalId",
            node.node_name||''【''|| nvl(proj.project_name, projs.stage_full_name)  ||''】''  as "nodeName",
			plan.plan_type as "nodePlanType",
            case 
                when '''||tabType||'''=''超期任务'' then to_char(node.plan_end_date, ''yyyy-MM-dd'')
                when '''||tabType||'''=''已完成'' then to_char(node.actual_end_date, ''yyyy-MM-dd'')
            end  as "nodeTime",
            case 
                when (to_char(node.plan_end_date, ''yyyy-MM-dd'') <  to_char(sysdate, ''yyyy-MM-dd'') and node.actual_end_date is null) then ''已超期''
                when (node.actual_end_date is not null) then ''已完成''
            end  as "nodeStatus"
        from pom_proj_plan_node node
        left join pom_proj_plan plan on node.proj_plan_id = plan.id
        left join sys_project proj on plan.proj_id = proj.id 
        left join sys_project_stage projs on plan.proj_id = projs.id
        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=proj.id or tal.orgid=plan.company_id or tal.orgid = projs.id
        where tal.orgid is not null and  plan_type='''||planType||''' and plan.company_id in (select id from sys_business_unit unit start with unit.id='''||companyId||''' connect by prior unit.id=unit.parent_id) and node.node_level = '''||nodeLevel||''' and plan.approval_status = ''已审核'''||v_condition||') tt
    WHERE ROWNUM <= '||pageRows||' * '||pageIndex||') table_alias
 WHERE table_alias.rowno >= '||pageRows||' * ('||pageIndex||'-1) + 1';
--dbms_output.put_line(v_sql);
open nodeList for v_sql;

END P_POM_PMP_NODE_COMP_RATE;
/

prompt
prompt Creating procedure P_POM_PORTAL_ALREADY_MSG
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_portal_already_msg (
    bizid  in varchar2,
    info     OUT      SYS_REFCURSOR--消息集合
) IS
--门户推送数据，发送微信、短信消息记录获取
--作者：陈丽
--日期：2020/02/13
BEGIN
    OPEN info FOR SELECT
                ------------------------------------------------------------基础必须信息             
                      '71313f018a35f3a558166cba7599b5d6' AS "systemId",--系统id
                      'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "appid",--应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段，
                 ------------------------------------------------------------业务变动必须信息   
                      'bizid' AS "bizKey",--业务id
                       'tjWeChat,tjSMS' AS "msgChannel",--使用消息渠道 多个，逗号分隔   tjWeChat：铁建微信,tjSMS：铁建短信
                     ------------------------------------------------------------短信必须参数
                      '40010' AS "smsTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID
                      '["1","2","3","4"]' AS "smsParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》说明{1}为您的登录验证码，请于{2}分钟内填写，如非本人操作，请忽略本短信。
                      '13896186104' as "mobile",--短信接收人电话
                      ------------------------------------------------------------微信必须参数
                      '40011' AS "wechatTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID
                      '["1","2","3","4"]' AS "wechatParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》说明{1}为您的登录验证码，请于{2}分钟内填写，如非本人操作，请忽略本短信。
                       '///' AS "wechatJumplinkUrl",--微信打开地址，程序调用发消息前需要编码
                      'v-xufeng' AS "recipientAccount",--接收人usercode如：a-xiexuhua
                 ------------------------------------------------------------消息记录方追溯信息
                       '部门月度计划流程预警' AS "title",--消息标题
                      'v-xufeng' AS "senderAccount",--发送人usercode如：a-xiexuhua
                      '月度计划' AS "bizSourceCategory",--业务所属类别=》 （由业务系统自定义，方便根据业务回溯，同一类别下有很多个类似业务，如月度计划）
                      '预警消息' AS "bizMsgCategory"--消息所属类别=》 （由业务系统自定义，方便根据业务回溯，同一业务主键，有多个分类，如预警消息，提醒消息）
                  FROM
                      dual;

END p_pom_portal_already_msg;
/

prompt
prompt Creating procedure P_POM_PORTAL_MSG
prompt ===================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_portal_msg (
    messagetype   OUT           VARCHAR2,     --0:门户终端消息都推送，1：只推送门户，2：只推送短信或微信
    info          OUT           SYS_REFCURSOR--消息集合
) IS
BEGIN
    messagetype := 0;
    OPEN info FOR
    
--    --超期任务提醒
--				SELECT 0 AS "msgType", A.ORIGINAL_NODE_ID AS "taskId", B1.USER_ACCOUNT AS "ownerName", 'v-xufeng' AS "creatorName",
--							 'http://pom.crccre.cn/pom/pom/middle?originalUrl=' ||
--								URL_ENCODE('http://pom.crccre.cn/pom/pom/mission-center-feedback/my-responsible-task?cancelType=0' || CHR(38) || 'id=' || A.PROJ_PLAN_ID || CHR(38) || 'feedbackNodeId=' || A.ID ||
--													 CHR(38) || 'feedbackNodeOriginalId=' || A.ORIGINAL_NODE_ID || CHR(38) || 'nodeSourcePlanType=1') AS "pcUrl", '' AS "mobileUrl", SYSDATE AS "created",
--							 TRUNC(SYSDATE) + 1 AS "expireTime", '【节点超期预警】【' || A.PROJ_NAME || '-' || A.PLAN_TYPE || '-' || A.NODE_NAME || '】超期' || TO_CHAR(TRUNC(SYSDATE) - A.PLAN_END_DATE) || '天预警' AS "taskName",
--							 '计划运营' AS "typeName",1 AS "priority", '' AS "remark"
--, 'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "sourceAppId",meg.MESSAGE_MSG_TYPE AS "messageMsgType"
--				FROM   V_POM_NODE_DT A
--				LEFT   JOIN SYS_ROLE_USER_RELATION_RESULT B1
--				ON     B1.DEPT_ID = A.DUTY_DEPARTMENT_ID AND
--							 B1.VIRTUAL_GROUP_NAME = '部门计划专员'
--				LEFT JOIN SYS_MESSAGE_CENTER meg
--				ON meg.TASK_ID=A.id AND meg.CREATED-SYSDATE=0
--				WHERE  A.FINISH_NO_STATUS_TYPE = '超期未完成' AND
--							 NOT EXISTS (SELECT 1
--								FROM   SYS_MESSAGE_CENTER_PUSH_RECORD P
--								WHERE  P.RESPONSE_RESULTS LIKE '%{"errcode":0%' AND
--											 TRUNC(SYSDATE) - TRUNC(P.REQUEST_TIME) = 0 AND
--											 A.ID = P.TASK_ID AND
--											 B1.USER_ACCOUNT = P.OWNER_NAME) AND
--							 B1.USER_ACCOUNT IS NOT NULL AND b1.USER_ACCOUNT = 'zhangzhuohan';

     SELECT
            ------------------------------------------------------------基础配置数据【必须】（集团门户网站和设备消息都必须配置）------------------------------------------------------------ 
                      'v-xufeng'   AS "senderAccount",--发送人usercode如：a-xiexuhua,---门户网站的creatorName
                      B1.USER_ACCOUNT       AS "recipientAccount",--接收人usercode如：a-xiexuhua--门户网站的ownerName
                      'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "appid",--应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段---门户网站的sourceAppId
                      '71313f018a35f3a558166cba7599b5d6' AS "systemId",--系统id
                      A.ORIGINAL_NODE_ID||B1.USER_ACCOUNT   AS "bizKey",--业务id--门户网站的taskId
                      '超期预警' AS "bizMsgCategory",--消息所属类别=》 （由业务系统自定义，方便根据业务回溯，同一业务主键，有多个分类，如预警消息，提醒消息）
            ------------------------------------------------------------设备消息配置开始------------------------------------------------------------ 
            ------------------------------------------------------------【短信微信必须】基础信息
                      'tjSMS,tjWeChat' AS "msgChannel",--使用消息渠道 多个，逗号分隔   tjWeChat：铁建微信,tjSMS：铁建短信
                        ------------【短信必须】参数
                      '400013' AS "smsTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID  
                      --{1}您好，您负责的任务“{2}”已超期{3}天，请及时到门户网站查看待办并在《计划管理系统》中反馈任务进度{4}。
                      '["'
                      || B1.USER_NAME
                      || '","'
                      || A.PROJ_NAME || '-' || A.PLAN_TYPE || '-' || A.NODE_NAME
                      || '","'
                      || TO_CHAR(TRUNC(SYSDATE) - A.PLAN_END_DATE) 
                      || '",""]' AS "smsParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
                      MOBILE_PHONE   AS "mobile",--短信接收人电话
                        ------------【微信必须】参数
                      '400013' AS "wechatTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID
                      '["'
                      || B1.USER_NAME
                      || '","'
                      || A.PROJ_NAME || '-' || A.PLAN_TYPE || '-' || A.NODE_NAME
                      || '","'
                      || TO_CHAR(TRUNC(SYSDATE) - A.PLAN_END_DATE) 
                      || '",""]' AS "wechatParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
                      'http://pom.crccre.cn/pom/wfi/bridge?jumpUrl=http%3a%2f%2fpom.crccre.cn%2fpom-h5%2fwfi%2fhow-to-read%3FinformationId%3D1786238shizebin%26bizUrl%3D'
                      || url_encode('http://pom.crccre.cn/pom-h5/pom/task-details?feedbackNodeId='||A.ORIGINAL_NODE_ID||'%26nodeSourcePlanType=KEY_NODE%26feedbackNodeOriginalId='||A.ORIGINAL_NODE_ID||'')||'&remoteUrl=aHR0cDovL3BvbS5jcmNjcmUuY24vcG9t'  AS "wechatJumplinkUrl",--微信打开地址，程序调用发消息前需要编码
                        ------------消息记录方便追溯信息
                      '【节点超期预警】【' || A.PROJ_NAME || '-' || A.PLAN_TYPE || '-' || A.NODE_NAME || '】超期' || TO_CHAR(TRUNC(SYSDATE) - A.PLAN_END_DATE) || '天预警' AS "title",--消息标题
                      '【节点超期预警】【' || A.PROJ_NAME || '-' || A.PLAN_TYPE || '-' || A.NODE_NAME || '】超期' || TO_CHAR(TRUNC(SYSDATE) - A.PLAN_END_DATE) || '天预警' AS "bizSourceCategory",--业务所属类别=》 （由业务系统自定义，方便根据业务回溯，同一类别下有很多个类似业务，如月度计划）
            ------------------------------------------------------------设备消息配置结束------------------------------------------------------------ 
            ------------------------------------------------------------集团门户网站信息------------------------------------------------------------ 
                --taskid	是	String	任务ID---------------------共有门户网站的1、插入待办/2、插入已办taskid，3、插入待阅/4、插入已阅informationid，5、插入我的关注的informationid
                --creatorname	是	String	创建人
                --ownername	是	String	拥有人
                --sourceAppId	是	String	推送应用的appId
                      0 "portalMsgType", --集团门户网站消息类型（0：待办,1:已办，10：待阅，11:已阅，20：关注）--已办，需要先根据bizKey删除待办，已阅接口需要根据bizKey调用集团待阅删除接口
                      'http://pom.crccre.cn/pom/pom/middle?originalUrl=' ||
								URL_ENCODE('http://pom.crccre.cn/pom/pom/mission-center-feedback/my-responsible-task?cancelType=0' || CHR(38) || 'id=' || A.PROJ_PLAN_ID || CHR(38) || 'feedbackNodeId=' || A.ID ||
													 CHR(38) || 'feedbackNodeOriginalId=' || A.ORIGINAL_NODE_ID || CHR(38) || 'nodeSourcePlanType=1') "url",--url	是	String	应用系统的url地址
                    --http://pom.crccre.cn/pom/wfi/bridge?jumpUrl=http%3A%2F%2Fpom.crccre.cn%2Fpom-h5%2Fwfi%2Fhow-to-read%3FinformationId%3D1786238shizebin%26bizUrl%3Dhttp%253A%252F%252Fpom.crccre.cn%252Fpom-h5%252Fwfi%252Fprocess-info%253FrootProcInstId%253D288110%2526item_id%253Dd6c370aa-ddd6-40b9-95de-6fc25fdef1f0%2526actInstID%253D1990892%2526procInstId%253D288110%2526workItemId%253D1786238&remoteUrl=aHR0cDovL3BvbS5jcmNjcmUuY24vcG9t
                      'http://pom.crccre.cn/pom/wfi/bridge?jumpUrl=http%3a%2f%2fpom.crccre.cn%2fpom-h5%2fwfi%2fhow-to-read%3FinformationId%3D1786238shizebin%26bizUrl%3D'
                      || url_encode('http://pom.crccre.cn/pom-h5/pom/task-details?feedbackNodeId='||A.ORIGINAL_NODE_ID||'%26nodeSourcePlanType=KEY_NODE%26feedbackNodeOriginalId='||A.ORIGINAL_NODE_ID||'')||'&remoteUrl=aHR0cDovL3BvbS5jcmNjcmUuY24vcG9t' as "mobileUrl",--mobileUrl	否	String	应用系统的手机端url地址
                       '【节点超期预警】【' || A.PROJ_NAME || '-' || A.PLAN_TYPE || '-' || A.NODE_NAME || '】超期' || TO_CHAR(TRUNC(SYSDATE) - A.PLAN_END_DATE) || '天预警' as "taskname",--taskname	是	String	任务名称，等于3、插入待阅/4、插入已阅informationname;等于插入关注的attentionname
                      '计划运营' "typename",--typename	是	String	任务类型
                      A.ORIGINAL_NODE_ID||B1.USER_ACCOUNT         "remark",--remark	否	String	备注

              ----------------------------------------------
              -----除【关注外特有】
                      SYSDATE          "expiretime",--expiretime	否	String	过期时间，格式yyyy-MM-dd HH:mm:ss-----过期时间，除关注都有
                      1 "priority"--priority	否	Integer	优先级，除关注都有
                      FROM   V_POM_NODE_DT A
				LEFT   JOIN SYS_ROLE_USER_RELATION_RESULT B1
				ON     B1.DEPT_ID = A.DUTY_DEPARTMENT_ID AND
							 B1.VIRTUAL_GROUP_NAME = '部门计划专员'
				LEFT JOIN SYS_MESSAGE_CENTER meg
				ON meg.TASK_ID=A.id AND meg.CREATED-SYSDATE=0
                left join sys_user u on  B1.USER_ACCOUNT=u.USER_CODE
				WHERE  A.FINISH_NO_STATUS_TYPE = '超期未完成' AND
							 NOT EXISTS (SELECT 1
								FROM   SYS_MESSAGE_CENTER_PUSH_RECORD P
								WHERE  P.RESPONSE_RESULTS LIKE '%{"errcode":0%' AND
											 TRUNC(SYSDATE) - TRUNC(P.REQUEST_TIME) = 0 AND
											 A.ID = P.TASK_ID AND
											 B1.USER_ACCOUNT = P.OWNER_NAME)
                                             AND
							 B1.USER_ACCOUNT IS NOT NULL 
                             --AND b1.USER_ACCOUNT = 'zhangzhuohan'
                             ;

END p_pom_portal_msg;
/

prompt
prompt Creating procedure P_POM_PREDICT_DELAY
prompt ======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_PREDICT_DELAY" (planType in VARCHAR2
,dataScope in VARCHAR2
,searchKey in VARCHAR2
,orgId  in VARCHAR2
,currentDelay OUT sys_refcursor)
AS
BEGIN
open currentDelay for
SELECT
    p.COMPANY_NAME as  "orgName",
    proj_name as "projName",
    node_name as "nodeName",
    '' as "projOpenUrl",
    '' as "nodeOpenUrl",
    ROUND(TO_NUMBER(plan_end_date-sysdate)) as "delayDays"
FROM
    pom_proj_plan_node n
    left join
    pom_proj_plan p  on  n.proj_plan_id=p.id where proj_name is not null;


END p_pom_predict_delay;
/

prompt
prompt Creating procedure P_POM_PROJ_BY_KEY_NODE_PLAN
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_PROJ_BY_KEY_NODE_PLAN
(
    companyGUID IN VARCHAR2,
    USERID VARCHAR2,
    STATIONID VARCHAR2,
    DEPTID VARCHAR2,
    COMPANYID VARCHAR2,
    items OUT SYS_REFCURSOR
)IS
    v_sql clob;
    v_id varchar2(100);
    --当前日期
    nowdate date:=trunc(sysdate);
    BIZCODE VARCHAR2(200):='POM.JHJKYKHPH.01';
    DATA_AUTH_SPID VARCHAR2(200);
BEGIN
    IF companyGUID IS NULL THEN
        v_id := '003200000000000000000000000000';
    ELSE
        v_id := companyGUID;
    END IF;

    DECLARE


BEGIN
  P_SYS_GET_COMPANY_PROJ_SPID(
    USERID => USERID,
    STATIONID => STATIONID,
    DEPTID => DEPTID,
    COMPANYID => COMPANYID,
    BIZCODE => BIZCODE,
    DATA_AUTH_SPID => DATA_AUTH_SPID
  );
END;

     open items for   
    WITH
     分期 as(
     select  case when 总分期数量=0 then get_uuid else ps.id end as id,ps.STAGE_NAME,ps.PROJECT_ID,proj.PROJECT_NAME,UNIT_ID,to_char(ps.sn,'0.0') as sn
     ,case when 无分期数量=1 and 总分期数量=1 then 1 else 0 end 是无分期 
     from SYS_PROJECT_STAGE ps
     left join SYS_PROJECT proj on ps.PROJECT_ID=proj.id
     left join (select PROJECT_ID,sum(case when STAGE_NAME='无分期' then 1 else 0 end) as 无分期数量,count(PROJECT_ID) as 总分期数量 from SYS_PROJECT_STAGE group by PROJECT_ID)  pcount
     on proj.id=pcount.PROJECT_ID
     )
    ,basedata AS(
    ---查询已审核的分期 关键节点计划 基础信息
   select 
   plan.PROJ_ID
   from  POM_PROJ_PLAN_NODE node
   left join POM_PROJ_PLAN plan on node.PROJ_PLAN_ID=plan.id
   --- 未考虑一个节点重复考核情况
   left join POM_NODE_EXAMINATION nodee on node.ORIGINAL_NODE_ID=nodee.ORIGINAL_NODE_ID

   ---已审核、关键节点计划、未禁用节点
   where plan.APPROVAL_STATUS='已审核' 
   and plan.PLAN_TYPE='关键节点计划'
   and node.id is not null
   and node.IS_DISABLE=0
   and node.IS_DELETE=0
   group by plan.PROJ_ID )


   ,项目_分期 as(
   select case when 分期.是无分期=1 then 分期.PROJECT_ID else 分期.id end as id
   ,case when 分期.是无分期=1 then 分期.PROJECT_NAME else 分期.PROJECT_NAME||'-'||分期.STAGE_NAME end as name 
    --统计的父级字段处理，无分期项目父级是公司，有分期项目父级是项目
   ,case when 分期.是无分期=1 then 分期.UNIT_ID else PROJECT_ID end parent_id
   ,分期.UNIT_ID
   ,分期.sn
   from basedata
   left join 分期 on basedata.PROJ_ID=分期.id
   union all 
   select proj.id
   ,proj.project_name as name
   ,proj.UNIT_ID  as parent_id
   ,proj.UNIT_ID
   ,proj.sn
   from (SELECT
       *
   FROM sys_project where id in( select PROJ_ID from basedata )) proj
   left join (select * from 分期 where 是无分期=1) s on proj.id=s.project_id
   where s.id is null 
   )

    select Id
   ,NAME
   ,PARENT_ID
   ,UNIT_ID
   ,sn FROM 项目_分期
  where UNIT_ID=v_id
  order by sn
   ;

END P_POM_PROJ_BY_KEY_NODE_PLAN;
/

prompt
prompt Creating procedure P_POM_PROJ_PLAN_DATA
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_proj_plan_data (
    condition     IN            VARCHAR2,--输入变量;项目或部门id   专项计划传入部门id 其他计划传入项目id
    companyid     IN            VARCHAR2,--当前用户公司
    stationid     IN            VARCHAR2,---当前用户的岗位
    deptid        IN            VARCHAR2,---当前用户的部门
    bizcode       IN            VARCHAR2,---权限code
    userid        IN            VARCHAR2,---当前用户id
    pageindex     IN            INT,
    search1       IN            VARCHAR2, --输入变量 查询条件
    pagesizes     IN            INT,
    currenttype   IN            INT,--
    plantype      IN            VARCHAR2, --计划类型
    items         OUT           SYS_REFCURSOR,
    total         OUT           INT
  --  tabledata          OUT           SYS_REFCURSOR
) IS
--专项计划，可研计划，全盘开发计划，项目主项计划列表配置
--作者：鲜晓勇
--日期：2019/12/11

--更改：纪海龙
--日期：2020/4/14

    v_sql              CLOB;
    v_sql_exec         CLOB;
    v_spid             VARCHAR2(200);---数据验证spid
    v_where            VARCHAR2(4000);
    testmsg            NVARCHAR2(4000);
    v_maintable        NVARCHAR2(100);
    v_subtable         NVARCHAR2(100);
    v_middlesql        VARCHAR2(4000);   --非专项计划使用。用于区分调整表与计划表字段差异的拼接
    v_middlesql2       VARCHAR2(4000);
    quarantine_rule   VARCHAR2(50) :='';
    v_auth_sql         VARCHAR2(4000) :=' where 1=1';
    v_isneed_proj      VARCHAR2(200);  --是否需要proj进行排序
    conpanys            NVARCHAR2(4000);

BEGIN
     OPEN items FOR select ''||companyid||'' as companyid,
    ''||stationid||'' as  stationid,
    ''||deptid||'' as  deptid,
     ''||condition||'' as  condition,
      ''||userid||'' as  userid
    from dual;

----------------------------------------------------统一解析
    testmsg := 'condition:'
               || condition
               || '；pageindex:'
               || pageindex
               || '；pagesizes:'
               || pagesizes
               || '；currenttype:'
               || currenttype;

    BEGIN
        total := 1000;


    --执行数据权限存储过程。拿到零时表id 用户连临时表鉴权
 --调用查询数据权限的存储过程,返回spid
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => stationid,
            DEPTID => deptid,
            COMPANYID => companyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
--        OPEN tabledata FOR select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = v_spid;
       -- OPEN tabledata FOR select * from SYS_PROJECT_STAGE sps   inner join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') ta on sps.project_id=ta.orgid;
        --拼接权限验证sql
        v_auth_sql:=' left join SYS_PROJECT_STAGE projs on pp.proj_id=projs.id
                    --关联权限表结果
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') org
                    on (case when projs.id is not null then projs.PROJECT_ID else pp.proj_id end)=org.orgId
                    --左连接权限字段为空表示没有权限
                    where org.orgId is not null ';
         -- v_auth_sql:=' inner join SYS_PROJECT_STAGE sps on pp.proj_id=sps.id inner join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') ta on sps.project_id=ta.orgid or pp.proj_id=ta.orgid where ta.orgid is not null ';

    IF ( plantype <> '专项计划' ) THEN
--      IF(quarantine_rule='集团')THEN
--        v_auth_sql:=v_auth_sql||' proj_id='''||companyid||'''';
--    END IF;

    --选择父级公司查找计划
    conpanys := 'select distinct sbu.id
    from SYS_BUSINESS_UNIT sbu
    where IS_COMPANY = 1
    start with sbu.id = '''|| condition ||'''
    connect by prior sbu.id = sbu.PARENT_ID';


    v_isneed_proj := ',a.proj_name';

    --项目主项计划，可研计划，标准节点计划，全盘开发计划
        IF ( currenttype = 0 ) THEN
    --当前使用版本
            v_maintable := 'POM_PROJ_PLAN ';
            v_subtable := 'POM_PROJ_PLAN_NODE';
            v_middlesql := ' ps.cnt1 as finish_count,
    ps.cnt2 as not_ebd_count,
    ps.cnt3 as template_node_count,
    ps.cnt4 as user_add_node_count,
    (case when ps.cnt8-ps.cnt7 >= 0 then ps.cnt8-ps.cnt7 else 0 end) as valid_node_count,
    (case when pp.plan_type = ''项目主项计划'' then ps.cnt8 else ps.cnt6 end) as node_count,
    ps.cnt7 as disable_count,'
            ;
            v_middlesql2 := ' left join(   select proj_plan_id,count(id) as numid,IS_DELETE,
    sum(case when n.ACTUAL_END_DATE is not null and n.IS_DISABLE=0 then 1  else 0 end) as cnt1, --已完成
    sum(case when n.ACTUAL_END_DATE is null and n.IS_DISABLE=0  then 1 else 0 end) as cnt2,--未完成
    sum(case when n.TEMPLATE_NODE_ID is not null then 1 else 0 end) as cnt3,--模板节点
    sum(case when n.STANDARD_NODE_ID is null and n.TEMPLATE_NODE_ID is null then 1 else 0 end) as cnt4,--新增节点
    sum(case when n.TEMPLATE_NODE_ID is not null then 1 else 0 end) + sum(case when n.STANDARD_NODE_ID is null and n.TEMPLATE_NODE_ID is null then 1 else 0 end) as cnt5,
    sum(case when n.IS_DISABLE = 0 then 1 else 0 end) as cnt6,--任务节点
    sum(case when n.IS_DISABLE=1 then 1 else 0 end) cnt7,
    count(*) as cnt8
    from '
                            || v_subtable
                            || '  n GROUP by proj_plan_id,IS_DELETE )ps on pp.id=ps.proj_plan_id '||v_auth_sql;


            v_where := ' and ps.IS_DELETE = 0 and
            (Approval_Status = ''已审核'' or (Approval_Status != ''已审核'' and plan_version =''1''))and plan_type='''
                       || plantype
                       || ''' and (plan_name like ''%'
                       || search1
                       || '%'' or creator like ''%'
                       || search1
                       || '%'')';
            IF(condition!='默认')THEN
               v_where:=v_where||' and COMPANY_ID in ( '
                       || conpanys
                       || ' ) ';
            END IF;
        ELSE
    --历史调整版本
            v_maintable := 'POM_PROJ_PLAN_HISTORY';
            v_subtable := 'POM_PROJ_PLAN_NODE_HISTORY';
            v_where := ' and COMPANY_ID in ( '
                       || conpanys
                       || ' ) and plan_type='''
                       || plantype
                       || ''' and (plan_name like ''%'
                       || search1
                       || '%'' or creator like ''%'
                       || search1
                       || '%'')';

            v_middlesql := ' (case when pp.plan_type = ''项目主项计划'' then ps.cnt8 else ps.cnt6 end) as node_count,';
    --暂时未查询 调整新增数量，调整修改数量，调整 禁用数量
            v_middlesql2 := ' left join(   select proj_plan_id,
    sum(case when n.IS_DISABLE = 0 then 1 else 0 end) as cnt6, --任务节点
    count(*) as cnt8,
    count(id) as numid
    from '
                            || v_subtable
                            || '  n WHERE IS_DISABLE = 0 GROUP by proj_plan_id )ps on pp.id=ps.proj_plan_id '||v_auth_sql;
        END IF;

        v_sql := 'SELECT
    pp.id as id,
    pp.original_plan_id,
    template_id,
    plan_name,
    plan_version,
     (''v'' || to_char(plan_version,''0.0'')) verson,
    company_id,
    company_name,
    proj_id,
    proj_name,
    plan_type,
    approval_status,
    approver_id,
    (case when approval_status = ''未审核'' then null else to_char(approval_time,''yyyy-MM-dd'') end) as approval_time,
    other_remark,
    to_char(created,''yyyy-MM-dd'') as created,
     case plan_version when plan_version then (plan_version-1) end as adjuest_Number,
    creator_id,
    creator,
    to_char(modified,''yyyy-MM-dd'') as modified,
    modifier_id,
    modifier,
    adjust_source_id,
    adjust_subject,
    adjust_remark,
    ps.numid as ADJUEST_NODE_COUNT,
    (case when plan_version = 1 then ps.numid else 
        ( select count(*) from POM_PROJ_PLAN_NODE_HISTORY ppnh where ppnh.proj_plan_id = (
            select pph.id from POM_PROJ_PLAN_HISTORY pph where pph.original_plan_id = pp.original_plan_id 
            and pph.plan_version = (
                select pph1.plan_version-1 from POM_PROJ_PLAN_HISTORY pph1 where pph1.id = 
                pp.id GROUP BY pph1.plan_version)) and ppnh.IS_DISABLE = 0 )
    end) as ADJUEST_BEFORE_NODE_COUNT,
    '
                 || v_middlesql
                 || ' approver FROM '
                 || v_maintable
                 || ' pp '
                 || v_middlesql2
                 || v_where
                 || '' ;

    ELSE
    --专项计划

        --选择父级公司查找计划
        conpanys := 'select distinct sbu.id
        from SYS_BUSINESS_UNIT sbu
        start with sbu.id = '''|| condition ||'''
        connect by prior sbu.id = sbu.PARENT_ID';

        IF ( currenttype = 0 ) THEN
--          IF(quarantine_rule='集团')THEN
--             v_auth_sql:=v_auth_sql||' and (company_id='''||companyid||''' or department_id='''||deptid||''')';
--          END IF;

          v_isneed_proj := '';

          --当前使用版本
            v_where := ' and DEPARTMENT_ID in ('
                       || conpanys
                       || ' ) and (Approval_Status = ''已审核'' or (Approval_Status != ''已审核'' and plan_version =''1'')) and (plan_name like ''%'
                       || search1
                       || '%'' or creator like ''%'
                       || search1
                       || '%'')';
            v_maintable := 'POM_SPECIAL_PLAN';
            v_subtable := 'POM_SPECIAL_PLAN_NODE';
        ELSE
            --历史调整版本
            v_where := ' and DEPARTMENT_ID in ('
                       || conpanys
                       || ' ) and (plan_name like ''%'
                       || search1
                       || '%'' or creator like ''%'
                       || search1
                       || '%'')';

            v_maintable := 'POM_SPECIAL_PLAN_HIST';
            v_subtable := 'POM_SPECIAL_PLAN_NODE_HIST';
        END IF;

        v_sql := '
    select
    distinct
    ps.id,
    template_id,
    plan_name,
    plan_subclass,
    (''v'' || to_char(plan_version,''0.0'')) verson,
    company_id,
    company_name,
    department_id,
    department_name,
    remark,
    approval_status,
    approver_id,
    (case when approval_status = ''未审核'' then null else to_char(approval_time,''yyyy-MM-dd'') end) as approval_time,
    to_char(created,''yyyy-MM-dd'') as created,
    creator_id,
    creator,
    to_char(modified,''yyyy-MM-dd'') as modified,
    modifier_id,
    modifier,
    approver,
    original_plan_id,
    plan_version,
    adjust_theme,
    adjust_remark,
    is_delete,
    case plan_version when plan_version then (plan_version-1) end as adjuest_Number,
    case when  pn.cnt1 is null then 0 else pn.cnt1 end as finish_count,
    case when  pn.cnt2 is null then 0 else pn.cnt2 end as not_ebd_count,
    case when  pn.cnt3 is null then 0 else pn.cnt3 end as node_count
    FROM '
                 || v_maintable
                 || '
     ps left join (
    SELECT
    plan_id,
     sum(case  when n.ACTUAL_END_DATE is not null then 1 else 0 end) as cnt1,--完成数量
     sum(case  when n.ACTUAL_END_DATE is null then 1 else 0 end) as cnt2,--未数量,
         count(*) as cnt3
FROM
    '
                 || v_subtable
                 || ' n
    group by plan_id) pn on ps.id=pn.plan_id  where 1=1 '
                 || v_where
                 || '';

    END IF;


v_sql_exec := 'select c.* from(
                select b.*,rownum as rowno from (
                    select a.* from ( '
                      || v_sql
                      || ' ) a left join SYS_BUSINESS_UNIT s1 on a.company_id = s1.id 
                        order by s1.order_hierarchy_code '
                      || v_isneed_proj
                      || ' ) b where rownum <= '
                      || pageindex * pagesizes
                      || ' ) c where c.rowno > '
                      || pagesizes * ( pageindex - 1 );



    dbms_output.put_line(v_sql_exec);
----获取总条数
    EXECUTE IMMEDIATE 'SELECT count(id) from('
                      || v_sql
                      || ') a '
    INTO total;

-- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
    OPEN items FOR v_sql_exec;

EXCEPTION
    WHEN OTHERS THEN
        testmsg := sqlerrm || testmsg;
        OPEN items FOR SELECT
                           '失败'
                       FROM
                           dual;

        dbms_output.put_line(sqlerrm);
        end;
END p_pom_proj_plan_data;
/

prompt
prompt Creating procedure P_POM_PROJ_PLAN_DTL_CONDITION
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_PROJ_PLAN_DTL_CONDITION" (
    userid                 IN                     VARCHAR2,--用户id
    planid                 IN                     VARCHAR2,--计划id
    conditiontype          IN                     VARCHAR2,--条件类型0:节点级别1：公司ID
    condition              IN                     VARCHAR2,--条件：公司ID；节点级别
    total                  out              number,
    pageindex     IN            INT,
    pagesizes     IN            INT,
    items           out SYS_REFCURSOR      --计划明细一览表
) AS
--项目主项计划监控，详情页 ：明细
--作者：叶丁荣
--日期：2020/04/15
v_sql_exec   CLOB;
v_sql_exec_paging  CLOB;
BEGIN
----计划明细一览表
total:=100;
    IF conditiontype='0' THEN
      v_sql_exec:= '
        SELECT
          rownum AS rowno,
         a.PROJ_ID AS "PROJ_ID"
         ,a.PROJ_NAME AS "PROJ_NAME"
         ,a.PROJ_PLAN_ID AS "PROJ_PLAN_ID"
         ,a.NODE_ID AS "NODE_ID"
         ,a.PLAN_ID AS "PLAN_ID"
         ,a.PLAN_TYPE AS "PLAN_TYPE"
         ,a.ORIGINAL_NODE_ID AS "ORIGINAL_NODE_ID"
         ,CASE a.WARNING_STATUS
         WHEN ''红灯'' THEN
            ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
         WHEN ''绿灯'' THEN
            ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
         WHEN ''黄灯'' THEN
            ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
        ELSE NULL
         END AS "WARNING_STATUS"
         ,case when b.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as "IS_UN_WATCH"
        ,case when a.ACTUAL_END_DATE is null then ''催办'' else null end as "HASTEN"
         ,a.NODE_CODE AS "NODE_CODE"
         ,a.NODE_NAME AS "NODE_NAME"
         ,a.NODE_LEVEL AS "NODE_LEVEL"
         ,a.DUTY_DEPARTMENT AS "DUTY_DEPARTMENT"
         ,a.DUTY_MANS AS "DUTY_MANS"
         ,a.FINISH_STATUS AS "FINISH_STATUS"
         ,a.STANDARD_SCORE AS "STANDARD_SCORE"
         ,a.PLAN_START_DATE AS "PLAN_START_DATE"
         ,a.PLAN_END_DATE AS "PLAN_END_DATE"
         ,a.ACTUAL_START_DATE AS "ACTUAL_START_DATE"
         ,a.ACTUAL_END_DATE AS "ACTUAL_END_DATE"
         ,a.ESTIMATE_END_DATE AS "ESTIMATE_END_DATE"
         ,a.PROCESS_FEED_BACK_CON AS "PROCESS_FEED_BACK_CON"
         ,a.FINISH_FEED_BACK_CON AS "FINISH_FEED_BACK_CON"
         ,a.OVERDUE_FEED_BACK_CON AS "OVERDUE_FEED_BACK_CON"
         ,a.NODE_FLAG AS "NODE_FLAG"
         ,a.ESTIMATE_BEYOND_NODE_FLAG AS "ESTIMATE_BEYOND_NODE_FLAG"
         ,a.COMPLETION_STANDARD AS "COMPLETION_STANDARD"
         ,a.COMPLETION_RESULTS_REMARK AS "COMPLETION_RESULTS_REMARK"
         --,nvl(b.IS_UN_WATCH,1) as  "IS_UN_WATCH"
         ,to_char(a.PLAN_START_DATE, ''YYYY-mm-dd'') as "PLAN_START_TIME"
         ,to_char(a.PLAN_END_DATE, ''YYYY-mm-dd'') as "PLAN_END_TIME"
         ,to_char(a.ACTUAL_START_DATE, ''YYYY-mm-dd'') as "ACTUAL_START_TIME"
         ,to_char(a.ACTUAL_END_DATE, ''YYYY-mm-dd'') as "ACTUAL_END_TIME"
         ,to_char(a.ESTIMATE_END_DATE, ''YYYY-mm-dd'') as "ESTIMATE_END_TIME"
          ,b.UN_WATCH_TIME  ,b.WATCH_TIME
      FROM  v_pom_proj_monitor_node_list  a
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID='''||userid||''' --and   b.WATCH_TIME is  not   null
      WHERE     a.PLAN_ID='''||planid||''' AND a.NODE_LEVEL='''||condition||'''    ' ;
    ELSE
        IF condition='未指定主责部门' THEN
            v_sql_exec:= '
                 SELECT
                 rownum AS rowno,
                 a.PROJ_ID AS "PROJ_ID"
                 ,a.PROJ_NAME AS "PROJ_NAME"
                 ,a.PROJ_PLAN_ID AS "PROJ_PLAN_ID"
                 ,a.NODE_ID AS "NODE_ID"
                 ,a.PLAN_ID AS "PLAN_ID"
                 ,a.PLAN_TYPE AS "PLAN_TYPE"
                 ,a.ORIGINAL_NODE_ID AS "ORIGINAL_NODE_ID"
                 ,CASE a.WARNING_STATUS
                 WHEN ''红灯'' THEN
                    ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
                 WHEN ''绿灯'' THEN
                    ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
                 WHEN ''黄灯'' THEN
                    ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                ELSE NULL
                 END AS "WARNING_STATUS"
                 ,case when b.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as "IS_UN_WATCH"
                ,case when a.ACTUAL_END_DATE is null then ''催办'' else null end as  "HASTEN"
                 ,a.NODE_CODE AS "NODE_CODE"
                 ,a.NODE_NAME AS "NODE_NAME"
                 ,a.NODE_LEVEL AS "NODE_LEVEL"
                 ,a.DUTY_DEPARTMENT AS "DUTY_DEPARTMENT"
                 ,a.DUTY_MANS AS "DUTY_MANS"
                 ,a.FINISH_STATUS AS "FINISH_STATUS"
                 ,a.STANDARD_SCORE AS "STANDARD_SCORE"
                 ,a.PLAN_START_DATE AS "PLAN_START_DATE"
                 ,a.PLAN_END_DATE AS "PLAN_END_DATE"
                 ,a.ACTUAL_START_DATE AS "ACTUAL_START_DATE"
                 ,a.ACTUAL_END_DATE AS "ACTUAL_END_DATE"
                 ,a.ESTIMATE_END_DATE AS "ESTIMATE_END_DATE"
                 ,a.PROCESS_FEED_BACK_CON AS "PROCESS_FEED_BACK_CON"
                 ,a.FINISH_FEED_BACK_CON AS "FINISH_FEED_BACK_CON"
                 ,a.OVERDUE_FEED_BACK_CON AS "OVERDUE_FEED_BACK_CON"
                 ,a.NODE_FLAG AS "NODE_FLAG"
                 ,a.ESTIMATE_BEYOND_NODE_FLAG AS "ESTIMATE_BEYOND_NODE_FLAG"
                 ,a.COMPLETION_STANDARD AS "COMPLETION_STANDARD"
                 ,a.COMPLETION_RESULTS_REMARK AS "COMPLETION_RESULTS_REMARK"
                 --,nvl(b.IS_UN_WATCH,1) as  "IS_UN_WATCH"
                 ,to_char(a.PLAN_START_DATE, ''YYYY-mm-dd'') as "PLAN_START_TIME"
                 ,to_char(a.PLAN_END_DATE, ''YYYY-mm-dd'') as "PLAN_END_TIME"
                 ,to_char(a.ACTUAL_START_DATE, ''YYYY-mm-dd'') as "ACTUAL_START_TIME"
                 ,to_char(a.ACTUAL_END_DATE, ''YYYY-mm-dd'') as "ACTUAL_END_TIME"
                 ,to_char(a.ESTIMATE_END_DATE, ''YYYY-mm-dd'') as "ESTIMATE_END_TIME"
                  ,b.UN_WATCH_TIME  ,b.WATCH_TIME
              FROM  v_pom_proj_monitor_node_list  a
              LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID='''||userid||''' --and   b.WATCH_TIME is  not   null
              WHERE     a.PLAN_ID='''||planid||''' ' ;
        ELSE
           v_sql_exec:= '
                 SELECT
                 rownum AS rowno,
                 a.PROJ_ID AS "PROJ_ID"
                 ,a.PROJ_NAME AS "PROJ_NAME"
                 ,a.PROJ_PLAN_ID AS "PROJ_PLAN_ID"
                 ,a.NODE_ID AS "NODE_ID"
                 ,a.PLAN_ID AS "PLAN_ID"
                 ,a.PLAN_TYPE AS "PLAN_TYPE"
                 ,a.ORIGINAL_NODE_ID AS "ORIGINAL_NODE_ID"
                 ,CASE a.WARNING_STATUS
                 WHEN ''红灯'' THEN
                    ''<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>''
                 WHEN ''绿灯'' THEN
                    ''<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>''
                 WHEN ''黄灯'' THEN
                    ''<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>''
                ELSE NULL
                 END AS "WARNING_STATUS"
                 ,case when b.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as "IS_UN_WATCH"
                ,case when a.ACTUAL_END_DATE is null then ''催办'' else null end as  "HASTEN"
                 ,a.NODE_CODE AS "NODE_CODE"
                 ,a.NODE_NAME AS "NODE_NAME"
                 ,a.NODE_LEVEL AS "NODE_LEVEL"
                 ,a.DUTY_DEPARTMENT AS "DUTY_DEPARTMENT"
                 ,a.DUTY_MANS AS "DUTY_MANS"
                 ,a.FINISH_STATUS AS "FINISH_STATUS"
                 ,a.STANDARD_SCORE AS "STANDARD_SCORE"
                 ,a.PLAN_START_DATE AS "PLAN_START_DATE"
                 ,a.PLAN_END_DATE AS "PLAN_END_DATE"
                 ,a.ACTUAL_START_DATE AS "ACTUAL_START_DATE"
                 ,a.ACTUAL_END_DATE AS "ACTUAL_END_DATE"
                 ,a.ESTIMATE_END_DATE AS "ESTIMATE_END_DATE"
                 ,a.PROCESS_FEED_BACK_CON AS "PROCESS_FEED_BACK_CON"
                 ,a.FINISH_FEED_BACK_CON AS "FINISH_FEED_BACK_CON"
                 ,a.OVERDUE_FEED_BACK_CON AS "OVERDUE_FEED_BACK_CON"
                 ,a.NODE_FLAG AS "NODE_FLAG"
                 ,a.ESTIMATE_BEYOND_NODE_FLAG AS "ESTIMATE_BEYOND_NODE_FLAG"
                 ,a.COMPLETION_STANDARD AS "COMPLETION_STANDARD"
                 ,a.COMPLETION_RESULTS_REMARK AS "COMPLETION_RESULTS_REMARK"
                 --,nvl(b.IS_UN_WATCH,1) as  "IS_UN_WATCH"
                 ,to_char(a.PLAN_START_DATE, ''YYYY-mm-dd'') as "PLAN_START_TIME"
                 ,to_char(a.PLAN_END_DATE, ''YYYY-mm-dd'') as "PLAN_END_TIME"
                 ,to_char(a.ACTUAL_START_DATE, ''YYYY-mm-dd'') as "ACTUAL_START_TIME"
                 ,to_char(a.ACTUAL_END_DATE, ''YYYY-mm-dd'') as "ACTUAL_END_TIME"
                 ,to_char(a.ESTIMATE_END_DATE, ''YYYY-mm-dd'') as "ESTIMATE_END_TIME"
                  ,b.UN_WATCH_TIME  ,b.WATCH_TIME
              FROM  v_pom_proj_monitor_node_list  a
              LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID='''||userid||''' --and   b.WATCH_TIME is  not   null
              WHERE     a.PLAN_ID='''||planid||''' AND a.DUTY_DEPARTMENT='''||condition||'''  ' ;
        END IF;
    END IF;


     v_sql_exec_paging := '
select f.* from ( '
                             || v_sql_exec
                             || '  AND rownum  <= '
                             || pageindex * pagesizes
                             ||' order by node_code asc'|| ' ) f where rowno > '
                             || pagesizes * ( pageindex - 1 )
                             || '';
    dbms_output.put_line(v_sql_exec_paging);
    EXECUTE IMMEDIATE 'SELECT count(rownum) from('
                          || v_sql_exec
                          || ') a '
        INTO total;
      OPEN items FOR v_sql_exec_paging;
END p_pom_proj_plan_dtl_condition;
/

prompt
prompt Creating procedure P_POM_PUSH_WATCH_MESSAGE
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_PUSH_WATCH_MESSAGE" (bizId in varchar,message OUT sys_refcursor)
AS  
--任务关注后推送相关消息
--作者：陈丽
--日期：2019/11/15
BEGIN  
open message for  
select 
'消息描述' as  "msgDescription",
'接收人id' as "RecipientId" ,
bizId as "bizKey" ,
'发送人id' as "senderId",
'业务类型' as "bizSourceCategory" ,
'消息业务类型' as "bizMsgCategory" ,
'系统id' as "systemId" ,
'微信跳转url'  as "wechatJumplinkUrl"
from dual;

END p_pom_Push_watch_message;
/

prompt
prompt Creating procedure P_POM_QUARTER_ASSESSMENT_DTL
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_QUARTER_ASSESSMENT_DTL" (
    year         IN           VARCHAR2, --年
    quarter      IN           VARCHAR2, --季度
    companyid    IN           VARCHAR2, --当前用户公司id
    plantype     IN           INT,--计划类型30 关键节点计划、40主项计划
    baseinfo     OUT          SYS_REFCURSOR, --基本信息
    detailinfo   OUT          SYS_REFCURSOR --明细信息
) AS
	--公司月度考核排行详情
--作者：叶丁荣
--日期：2019/12/05
    v_plantype         VARCHAR2(20);
    v_currentquarter   VARCHAR2(20);
    v_currentdate   VARCHAR2(20);
    v_monthbegin     DATE;
    v_monthend       DATE;
    v_quarterbegin   DATE;
    v_quarterend     DATE;
    v_yearbegin      DATE;
    v_yearend        DATE; 
BEGIN
--获取当前季度
    SELECT
        trunc((TO_CHAR(SYSDATE, 'mm') + 2) / 3)
    INTO v_currentquarter
    FROM
        dual;

    SELECT TO_CHAR(ADD_MONTHS(ADD_MONTHS(TRUNC(SYSDATE, 'YYYY'),A * 3),-ROWNUM),'yyyy-MM-dd')  INTO  v_currentdate 
    FROM (SELECT quarter A FROM DUAL)  
    CONNECT BY ROWNUM <= 1 
    ORDER BY 1;  

    P_POM_MONTH_QUARTER_YEAR(
        now_date =>to_date(v_currentdate,'yyyy-MM-dd'),
        o_m_begin => v_monthbegin,
        o_m_end => v_monthend,
        o_quarter_begin => v_quarterbegin,
        o_quarter_end => v_quarterend,
        o_year_begin => v_yearbegin,
        o_year_end => v_yearend
    );


    IF plantype = 30 THEN
        v_plantype := '关键节点计划';
    ELSE
        v_plantype := '项目主项计划';
    END IF;

    IF v_currentquarter = quarter THEN
        OPEN baseinfo FOR SELECT
                              round((SUM(
                                  CASE
                                      WHEN node.actual_end_date IS NOT NULL THEN
                                          1
                                      ELSE
                                          0
                                  END
                              ) / COUNT(node.id)), 2) * 100
                              || '%' AS "percentageComplete",--完成率(P=N/N*100)
                              COUNT(node.plan_end_date) AS "assessmentTasksCount",
                              COUNT(node.actual_end_date) AS "missionsCompleted",
                              round((SUM(exam.new_examination_score) / SUM(node.standard_score) * 100), 2) AS "assessmentScore",
                              SUM(node.standard_score) AS "assessmentStandardNodeScore",--∑考核期内节点标准分(A)
                              SUM(exam.new_examination_score) AS "assessmentActualNodeScore" --∑考核期内节点实际得分(B)
                          FROM
                              pom_proj_plan          plan
                              INNER JOIN pom_proj_plan_node          node ON plan.id = node.proj_plan_id
                              LEFT JOIN sys_business_unit      business ON plan.company_id = business.id
                              LEFT JOIN sys_business_unit      biz ON business.parent_id = biz.id
                              LEFT JOIN pom_node_feedback      feedback ON feedback.feedback_node_id = node.id
                              LEFT JOIN pom_node_examination   exam ON exam.node_id = node.id
                          WHERE
                              plan.approval_status = '已审核'
                              AND plan.plan_type = v_plantype
                              AND node.is_disable=0
                              AND  (node.plan_end_date < v_quarterend AND node.plan_end_date > v_quarterbegin)
                              AND ( biz.id = companyid
                                    OR business.id = companyid 
                                    OR plan.proj_id IN (
                                   SELECT
                                       id
                                   FROM
                                       sys_project_stage
                                   WHERE
                                       project_id = companyid
                               ));

        OPEN detailinfo FOR SELECT
                               CASE 
 --未到期不亮灯
                                   WHEN node.actual_end_date IS NULL
                                        AND trunc(SYSDATE) - trunc(node.plan_end_date) <= 0 THEN
                                       ''
 --到期当天内完成反馈
                                   WHEN node.actual_end_date IS NOT NULL
                                        AND ( trunc(node.actual_end_date) - trunc(node.plan_end_date) ) <= 0 THEN
                                       '<p style=" font-size: 40px;color: green;margin-bottom: 0px;">●</p>'
  --到期1-5天内完成反馈
                                   WHEN node.actual_end_date IS NOT NULL
                                        AND ( trunc(node.actual_end_date) - trunc(node.plan_end_date) ) BETWEEN 1 AND 5 THEN
                                       '<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>'
 --到期未反馈黄灯 
                                   WHEN node.actual_end_date IS NULL
                                        AND ( trunc(SYSDATE) - trunc(node.plan_end_date) ) BETWEEN 1 AND 5 THEN
                                       '<p style=" font-size: 40px;color: yellow;margin-bottom: 0px;">●</p>' 
  --到期超过5天未反馈红灯 
                                   WHEN node.actual_end_date IS NULL
                                        AND ( ( trunc(SYSDATE) - trunc(node.plan_end_date) ) > 5 ) THEN
                                       '<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'
                                   ELSE
                                       '<p style=" font-size: 40px;color: red;margin-bottom: 0px;">●</p>'
                               END AS "alertStatus",--预警状态
                               CASE
                                   WHEN node.actual_end_date IS NULL THEN
                                       '未完成'
                                   WHEN node.actual_end_date IS NOT NULL THEN
                                       '已完成'
                               END AS "completionStatus",--完成状态
                               node.node_name         AS "taskName",--任务名称
                               plan.plan_name         AS "planName",--计划名称
                               CASE
                                   WHEN biz.level_rank = 1  THEN
                                       plan.company_name
                                   WHEN biz.level_rank <> 1 THEN
                                       biz.org_name
                               END "area",--区域
                               plan.company_name      AS "businessDivision",--事业部
                               plan.proj_name           AS "project", --项目
                               node.duty_department   AS "department",--主责部门
                               node.node_level        AS "tasnkLevel",--任务级别
                               TO_CHAR(node.plan_end_date, 'yyyy-MM-dd') AS "planEndDate",--计划完成日期
                               TO_CHAR(node.actual_end_date, 'yyyy-MM-dd') AS "factEndDate",--实际完成日期
                               CASE
                                   WHEN node.actual_end_date IS NULL THEN
                                       NULL
                                   WHEN node.actual_end_date IS NOT NULL THEN
                                       TO_CHAR(feedback.approval_time, 'yyyy-MM-dd')
                               END AS "auditCompletionDate",--核完成日期
                               node.standard_score    AS "standardScore",--标准分值
                               CASE
                                   WHEN node.actual_end_date IS NULL THEN
                                       0 || '%'
                                   WHEN node.actual_end_date IS NOT NULL THEN
                                       round(exam.new_examination_score / exam.standard_score, 2) * 100
                                       || '%'
                               END AS "scoringPercentage",--得分比例
                               CASE
                                   WHEN node.actual_end_date IS NULL
                                        OR exam.new_examination_score IS NULL THEN
                                       0
                                   WHEN node.actual_end_date IS NOT NULL THEN
                                       exam.new_examination_score
                               END AS "actualScore",--实际得分
                               node.id AS "node_id",
                               plan.id AS "plan_id",
                               node.original_node_id AS "original_node_id"
                           FROM
                               pom_proj_plan          plan
                               INNER JOIN pom_proj_plan_node     node ON plan.id = node.proj_plan_id
                               LEFT JOIN sys_business_unit      business ON plan.company_id = business.id
                               LEFT JOIN sys_business_unit      biz ON business.parent_id = biz.id
                               LEFT JOIN pom_node_feedback      feedback ON feedback.feedback_node_id = node.id
                               LEFT JOIN pom_node_examination   exam ON exam.node_id = node.id
                           WHERE
                               plan.approval_status = '已审核'
                               AND plan.plan_type = v_plantype
                               AND node.is_disable=0
                               AND ( node.plan_end_date < v_quarterend AND node.plan_end_date > v_quarterbegin)
                               AND ( biz.id = companyid
                                     OR business.id = companyid
                                    OR plan.proj_id IN (
                                   SELECT
                                       id
                                   FROM
                                       sys_project_stage
                                   WHERE
                                       project_id = companyid
                               ));

    ELSE
        OPEN baseinfo FOR SELECT
                              round((SUM(
                                  CASE
                                      WHEN actual_end_date IS NOT NULL THEN
                                          1
                                      ELSE
                                          0
                                  END
                              ) / COUNT(id)), 2) * 100
                              || '%' AS "percentageComplete",--完成率(P=N/N*100)
                              COUNT(id) AS "assessmentTasksCount",--考核任务数量(M)
                              SUM(
                                  CASE
                                      WHEN actual_end_date IS NOT NULL THEN
                                          1
                                      ELSE
                                          0
                                  END
                              ) AS "missionsCompleted",--已完成任务(N)
                              round(SUM(examination_score) / SUM(standard_score), 2) * 100 AS "assessmentScore",--考核得分S=(B/A)*100
                              SUM(standard_score) AS "assessmentStandardNodeScore",--∑考核期内节点标准分(A)
                              SUM(examination_score) AS "assessmentActualNodeScore"--∑考核期内节点实际得分(B)
                          FROM
                              pom_node_photograph
                          WHERE
                              ( area_company_id = companyid
                                OR company_id = companyid
                                OR project_id IN (
                                  SELECT
                                      id
                                  FROM
                                      sys_project_stage
                                  WHERE
                                      project_id = companyid
                              ) )
                              AND plan_type = v_plantype
	             AND affiliation_year = year
                 AND record_type=1
                              AND  (plan_end_date < v_quarterend AND plan_end_date > v_quarterbegin);
        OPEN detailinfo FOR SELECT
                               alert_status        AS "alertStatus",--预警状态
                               completion_status   AS "completionStatus",--完成状态
                               node_name           AS "taskName",--任务名称
                               plan_name           AS "planName",--计划名称
                               area_company_name   AS "area",--区域
                               company_name        AS "businessDivision",--事业部
                               project_name        AS "project", --项目
                               duty_dept           AS "department",--主责部门
                               node_level          AS "tasnkLevel",--任务级别
                               TO_CHAR(plan_end_date, 'yyyy-MM-dd') AS "planEndDate",--计划完成日期
                               TO_CHAR(actual_end_date, 'yyyy-MM-dd') AS "factEndDate",--实际完成日期
                               TO_CHAR(examination_date, 'yyyy-MM-dd') AS "auditCompletionDate",--核完成日期
                               standard_score      AS "standardScore",--标准分值
                               scoring_percentage || '%' AS "scoringPercentage",--得分比例
                               examination_score   AS "actualScore",--实际得分
                               original_node_id,
                               plan_id,
                               node_id
                           FROM
                               pom_node_photograph
                           WHERE
                              (plan_end_date < v_quarterend AND plan_end_date > v_quarterbegin)
                               AND plan_type = v_plantype
                               AND ( area_company_id = companyid
                                     OR company_id = companyid
                                     OR project_id IN (
                                   SELECT
                                       id
                                   FROM
                                       sys_project_stage
                                   WHERE
                                       project_id = companyid
                               ) )
                               AND affiliation_year = year
                               AND record_type=1
                               ;

    END IF;

END p_pom_quarter_assessment_dtl;
/

prompt
prompt Creating procedure P_POM_RANK_EXAMINATION_DTL
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_RANK_EXAMINATION_DTL" (
    rangetype   IN          INT,--时间范围类型（10:月度，20季度）
    rangeval    IN          VARCHAR2,--范围值，月度：2019|09。季度：2019|04
    orgid       IN          VARCHAR2,--组织id(关键节点计划传空,项目主项计划传）
    title       OUT         VARCHAR2,
    bartype     OUT         VARCHAR2,
    unit        OUT         VARCHAR2,
    wacthinfo   OUT         SYS_REFCURSOR
) AS
--考核排行详情
--作者：陈丽
--日期：2019/11/13
BEGIN
    OPEN wacthinfo FOR SELECT
                           '广佛事业部-项目A' AS "name",
                           '100' AS "total",
                           '#37cd69' AS "color"
                       FROM
                           dual
                       UNION
                       SELECT
                           '南宁事业部-项目B' AS "name",
                           '25' AS "total",
                           '#37cd69' AS "color"
                       FROM
                           dual
                       UNION
                       SELECT
                           '广佛事业部-项目C' AS "name",
                           '25' AS "total",
                           '#37cd69' AS "color"
                       FROM
                           dual
                       UNION
                       SELECT
                           '福州地产-项目D' AS "name",
                           '25' AS "total",
                           '#37cd69' AS "color"
                       FROM
                           dual;

    title := '项目主项计划考核_项目排行榜：';
    unit := '%';
    bartype := 'column';
END p_pom_rank_examination_dtl;
/

prompt
prompt Creating procedure P_POM_RANK_ORG_EXAMINATION
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_RANK_ORG_EXAMINATION" (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    rankype        IN             INT,--时间范围类型（10:月度，20季度）
    plantype       IN             INT,--计划类型（30：关键节点计划，40：项目主项计划）
    rankval        IN             VARCHAR2,--范围值，月度：2019|09。季度：2019|04
    orgid          IN             VARCHAR2,--组织id(传前端选择的公司）
    title          OUT            VARCHAR2,
    bartype        OUT            VARCHAR2,
    unit           OUT            VARCHAR2,
    info      OUT            SYS_REFCURSOR
) AS
--考核排行-组织排行，包括月度排行的 关键节点和项目主项计划。季度排行的关键节点和项目主项计划
--作者：陈丽
--日期：2019/11/13
  org_lenth NUMBER(10):=60;
  lpad_str  VARCHAR2(10):=' ';
BEGIN

IF rankype=10  AND plantype=30
THEN
OPEN info FOR

with 树 ( 
   
ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH
,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯, CTYPE
)as( 



select   
ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分
	,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成
	,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯
,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯
,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯
, CTYPE
from POM_PJPLAN_EXM_SOCRE_TABLE where plan_type='关键节点计划' and PLANYEAR= SUBSTR(rankval, 0, 4) and PLANMOTH=LPAD( TO_CHAR(SUBSTR( rankval, 6, 1 )),2,'0')
		
		
UNION all 
select    
a2.ID,a2.PARENT_ID,a2.ORG_NAME,a1.PLAN_TYPE,a1.PROJECT_NAME ,a2.ORDER_CODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成
,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成
,三级节点已完成,里程碑绿灯,一级节点绿灯,二级节点绿灯
,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯
,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯
,三级节点红灯
, 'TYPE_ORG' as CTYPE

from  树 a1 INNER JOIN　SYS_BUSINESS_UNIT a2 on a1.parent_id=a2.id 

		where is_company=1
		
		
		)
		
		
		
		
    
		
		
,结果 as( 

select  
lpad(ORG_NAME,org_lenth-length(ORG_NAME),lpad_str)   AS "name"  
, TO_CHAR(
   CASE WHEN  SUM(
                  CASE
                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND LPAD( TO_CHAR(SUBSTR( rankval, 6, 1 )),2,'0') = PLANMOTH THEN
                  SUMNODESCORE ELSE 0
                    END
                )>0
        THEN   ROUND(
              SUM(
                  CASE

                      WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                      AND LPAD( TO_CHAR(SUBSTR( rankval, 6, 1 )),2,'0') = PLANMOTH THEN
                        "动态得分" ELSE 0
                      END
                        ) / SUM(
                      CASE

                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND LPAD( TO_CHAR(SUBSTR( rankval, 6, 1 )),2,'0') = PLANMOTH THEN
                    SUMNODESCORE ELSE 0
                  END
                ) * 100,
                2
              )
          ELSE  0 END
          
           ) AS "total" 
--,TO_CHAR(SUMNODESCORE)AS "total" 
			--,'90 'AS "total"
		   ,  
   CASE WHEN  SUM(
                  CASE
                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND LPAD( TO_CHAR(SUBSTR( rankval, 6, 1 )),2,'0') = PLANMOTH THEN
                  SUMNODESCORE ELSE 0
                    END
                )>0
        THEN   ROUND(
              SUM(
                  CASE

                      WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                      AND LPAD( TO_CHAR(SUBSTR( rankval, 6, 1 )),2,'0') = PLANMOTH THEN
                        "动态得分" ELSE 0
                      END
                        ) / SUM(
                      CASE

                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND LPAD( TO_CHAR(SUBSTR( rankval, 6, 1 )),2,'0') = PLANMOTH THEN
                    SUMNODESCORE ELSE 0
                  END
                ) * 100,
                2
              )
          ELSE  0 END
          
            AS   totalRank 
     , '#37cd69' AS "color"

 FROM 树 a where PARENT_ID = ''||orgid||''

group by org_name
ORDER BY  totalRank asc
)
    
    select * from 结果  
    
 ;



ELSIF rankype=10  AND plantype=40
THEN
OPEN info FOR


with 树 ( 
   
ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH
,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯, CTYPE
)as( 



select   
ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分
	,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成
	,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯
,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯
,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯
, CTYPE
from POM_PJPLAN_EXM_SOCRE_TABLE where plan_type='项目主项计划' and PLANYEAR= SUBSTR(rankval, 0, 4)
		
		
UNION all 
select    
a2.ID,a2.PARENT_ID,a2.ORG_NAME,a1.PLAN_TYPE,a1.PROJECT_NAME ,a2.ORDER_CODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成
,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成
,三级节点已完成,里程碑绿灯,一级节点绿灯,二级节点绿灯
,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯
,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯
,三级节点红灯
, 'TYPE_ORG' as CTYPE

from  树 a1 INNER JOIN　SYS_BUSINESS_UNIT a2 on a1.parent_id=a2.id 

		where is_company=1
		
		
		)
		
		
		
		
    

		
		
		
,结果 as( 
select  lpad(ORG_NAME,org_lenth-length(ORG_NAME),lpad_str)   AS "name"  , TO_CHAR(
   CASE WHEN  SUM(
                  CASE
                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND  LPAD( TO_CHAR(SUBSTR( rankval, 6, 1 )),2,'0') = PLANMOTH THEN
                  SUMNODESCORE ELSE 0
                    END
                )>0
        THEN   ROUND(
              SUM(
                  CASE

                      WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                      AND  LPAD( TO_CHAR(SUBSTR( rankval, 6, 1 )),2,'0') = PLANMOTH THEN
                        "动态得分" ELSE 0
                      END
                        ) / SUM(
                      CASE

                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND  LPAD( TO_CHAR(SUBSTR( rankval, 6, 1 )),2,'0') = PLANMOTH THEN
                    SUMNODESCORE ELSE 0
                  END
                ) * 100,
                2
              )
          ELSE  0 END
            )
           AS "total" --,'90 'AS "total"
		   ,  
   CASE WHEN  SUM(
                  CASE
                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND  LPAD( TO_CHAR(SUBSTR( rankval, 6, 1 )),2,'0') = PLANMOTH THEN
                  SUMNODESCORE ELSE 0
                    END
                )>0
        THEN   ROUND(
              SUM(
                  CASE

                      WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                      AND  LPAD( TO_CHAR(SUBSTR( rankval, 6, 1 )),2,'0') = PLANMOTH THEN
                        "动态得分" ELSE 0
                      END
                        ) / SUM(
                      CASE

                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND  LPAD( TO_CHAR(SUBSTR( rankval, 6, 1 )),2,'0') = PLANMOTH THEN
                    SUMNODESCORE ELSE 0
                  END
                ) * 100,
                2
              )
          ELSE  0 END
          
           AS   totalRank 
     , '#37cd69' AS "color"

 FROM 树 a where CTYPE='TYPE_ORG' and PARENT_ID = ''||orgid||''

group by org_name,    id,    parent_id
ORDER BY  totalRank asc
)
    
    select * from 结果  
    
 ;
     




ELSIF rankype=20    AND plantype=30
THEN
OPEN info FOR

with 树 ( 
   
ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH
,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯, CTYPE
)as( 



select   
ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分
	,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成
	,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯
,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯
,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯
, CTYPE
from POM_PJPLAN_EXM_SOCRE_TABLE where plan_type='关键节点计划' and PLANYEAR= SUBSTR(rankval, 0, 4)
		
		
UNION all 
select    
a2.ID,a2.PARENT_ID,a2.ORG_NAME,a1.PLAN_TYPE,a1.PROJECT_NAME ,a2.ORDER_CODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成
,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成
,三级节点已完成,里程碑绿灯,一级节点绿灯,二级节点绿灯
,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯
,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯
,三级节点红灯
, 'TYPE_ORG' as CTYPE

from  树 a1 INNER JOIN　SYS_BUSINESS_UNIT a2 on a1.parent_id=a2.id 

		where is_company=1
		
		
		)
		
		
		
		
    
		
		
,结果 as( 
select  lpad(ORG_NAME,org_lenth-length(ORG_NAME),lpad_str)   AS "name"  , TO_CHAR(
   CASE WHEN  SUM(
                  CASE
                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND SUBSTR( rankval, 6, 2 ) = PLANQUATOR THEN
                  SUMNODESCORE ELSE 0
                    END
                )>0
        THEN   ROUND(
              SUM(
                  CASE

                      WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                      AND SUBSTR( rankval, 6, 2 ) = PLANQUATOR THEN
                        "动态得分" ELSE 0
                      END
                        ) / SUM(
                      CASE

                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND SUBSTR( rankval, 6, 2 ) = PLANQUATOR THEN
                    SUMNODESCORE ELSE 0
                  END
                ) * 100,
                2
              )
          ELSE  0 END
            )
           AS "total" --,'90 'AS "total"
		   ,  
   CASE WHEN  SUM(
                  CASE
                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND SUBSTR( rankval, 6, 2 ) = PLANQUATOR THEN
                  SUMNODESCORE ELSE 0
                    END
                )>0
        THEN   ROUND(
              SUM(
                  CASE

                      WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                      AND SUBSTR( rankval, 6, 2 ) = PLANQUATOR THEN
                        "动态得分" ELSE 0
                      END
                        ) / SUM(
                      CASE

                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND SUBSTR( rankval, 6, 2 ) = PLANQUATOR THEN
                    SUMNODESCORE ELSE 0
                  END
                ) * 100,
                2
              )
          ELSE  0 END
          
           AS   totalRank 
     , '#37cd69' AS "color"

 FROM 树 a where CTYPE='TYPE_ORG' and PARENT_ID = ''||orgid||''

group by org_name,    id,    parent_id
ORDER BY  totalRank asc
)
    
    select * from 结果  
    
 ;



ELSIF rankype=20    AND plantype=40
THEN
OPEN info FOR



with 树 ( 
   
ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH
,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯, CTYPE
)as( 



select   
ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分
	,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成
	,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯
,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯
,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯
, CTYPE
from POM_PJPLAN_EXM_SOCRE_TABLE where plan_type='项目主项计划' and PLANYEAR= SUBSTR(rankval, 0, 4)
		
		
UNION all 
select    
a2.ID,a2.PARENT_ID,a2.ORG_NAME,a1.PLAN_TYPE,a1.PROJECT_NAME ,a2.ORDER_CODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成
,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成
,三级节点已完成,里程碑绿灯,一级节点绿灯,二级节点绿灯
,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯
,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯
,三级节点红灯
, 'TYPE_ORG' as CTYPE

from  树 a1 INNER JOIN　SYS_BUSINESS_UNIT a2 on a1.parent_id=a2.id 

		where is_company=1
		
		
		)
		
		
		
		
    
		
		
,结果 as( 
select  lpad(ORG_NAME,org_lenth-length(ORG_NAME),lpad_str)   AS "name"  , TO_CHAR(
   CASE WHEN  SUM(
                  CASE
                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND SUBSTR( rankval, 6, 2 ) = PLANQUATOR THEN
                  SUMNODESCORE ELSE 0
                    END
                )>0
        THEN   ROUND(
              SUM(
                  CASE

                      WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                      AND SUBSTR( rankval, 6, 2 ) = PLANQUATOR THEN
                        "动态得分" ELSE 0
                      END
                        ) / SUM(
                      CASE

                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND SUBSTR( rankval, 6, 2 ) = PLANQUATOR THEN
                    SUMNODESCORE ELSE 0
                  END
                ) * 100,
                2
              )
          ELSE  0 END
            )
           AS "total" --,'90 'AS "total"
		   ,  
   CASE WHEN  SUM(
                  CASE
                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND SUBSTR( rankval, 6, 2 ) = PLANQUATOR THEN
                  SUMNODESCORE ELSE 0
                    END
                )>0
        THEN   ROUND(
              SUM(
                  CASE

                      WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                      AND SUBSTR( rankval, 6, 2 ) = PLANQUATOR THEN
                        "动态得分" ELSE 0
                      END
                        ) / SUM(
                      CASE

                  WHEN SUBSTR( rankval, 0, 4 ) = PLANYEAR
                  AND SUBSTR( rankval, 6, 2 ) = PLANQUATOR THEN
                    SUMNODESCORE ELSE 0
                  END
                ) * 100,
                2
              )
          ELSE  0 END
          
           AS   totalRank 
     , '#37cd69' AS "color"

 FROM 树 a where CTYPE='TYPE_ORG' and PARENT_ID = ''||orgid||''

group by org_name,    id,    parent_id
ORDER BY  totalRank asc
)
    
    select * from 结果  
    
 ;

  END IF ;



    title :=   CASE WHEN  plantype=40 THEN '项目主项计划' ELSE '关键节点计划'  END  ||'考核排行榜：按照考核得分进行排行统计，展示公司得分的排行';
    unit := '';
    bartype := 'column';
END p_pom_rank_org_examination;
/

prompt
prompt Creating procedure P_POM_RANK_ORG_EXAM_DTL
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_RANK_ORG_EXAM_DTL" (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    rangetype   IN          INT,--时间范围类型（10:月度，20季度）
  --计划类型  30关键节点计划，40项目主项计划
    rangeval    IN          VARCHAR2,--范围值，月度：2019|09。季度：2019|04
    orgid       IN          VARCHAR2,--组织id(关键节点计划传空,项目主项计划传）
    title       OUT         VARCHAR2,
    info   OUT         SYS_REFCURSOR
) AS
--公司考核排行详情
--作者：陈丽
--日期：2019/11/13
BEGIN
  IF rangetype=10
      THEN
    OPEN info FOR

with 树 ( 
   
ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH
,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯, CTYPE
)as( 



select   
ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分
	,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成
	,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯
,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯
,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯
, CTYPE
from POM_PJPLAN_EXM_SOCRE_TABLE where plan_type='关键节点计划' and PLANYEAR= SUBSTR(RANGEVAL, 0, 4)
		
		
UNION all 
select    
a2.ID,a2.PARENT_ID,a2.ORG_NAME,a1.PLAN_TYPE,a1.PROJECT_NAME ,a2.ORDER_CODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成
,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成
,三级节点已完成,里程碑绿灯,一级节点绿灯,二级节点绿灯
,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯
,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯
,三级节点红灯
, 'TYPE_ORG' as CTYPE

from  树 a1 INNER JOIN　SYS_BUSINESS_UNIT a2 on a1.parent_id=a2.id 

		where is_company=1
		
		
		)
    

		
		
		
,结果 as( 
select org_name AS "company",id AS "ORGID" ,parent_id
 ,TO_CHAR(ROUND(CASE
												 WHEN SUM(CASE
																			WHEN SUBSTR(RANGEVAL, 0, 4) = PLANYEAR THEN
																			 应完成
																			ELSE
																			 0
																	END) > 0 THEN
													SUM(CASE
																	WHEN SUBSTR(RANGEVAL, 0, 4) = PLANYEAR THEN
																	 已完成
																	ELSE
																	 0
															END) / SUM(CASE
																						 WHEN SUBSTR(RANGEVAL, 0, 4) = PLANYEAR THEN
																							应完成
																						 ELSE
																							0
																				 END) * 100
												 ELSE
													0
										 END, 2)) AS "yearPercentageComplete",
			 TO_CHAR(SUM(CASE
											 WHEN SUBSTR(RANGEVAL, 0, 4) = PLANYEAR THEN
												应完成
											 ELSE
												0
									 END)) AS "yearShouldComplete"
				--本年应完成数
			 ,
			 TO_CHAR(SUM(CASE
											 WHEN SUBSTR(RANGEVAL, 0, 4) = PLANYEAR THEN
												已完成
											 ELSE
												0
									 END)) AS "yearDone"
				--本年已完成数
			 ,
			 TO_CHAR(SUM(CASE
											 WHEN SUBSTR(RANGEVAL, 0, 4) = PLANYEAR THEN
												应完成
											 ELSE
												0
									 END) - SUM(CASE
																	WHEN SUBSTR(RANGEVAL, 0, 4) = PLANYEAR THEN
																	 已完成
																	ELSE
																	 0
															END)) AS "yearUnfinished"
				--本年未完成数
			 ,
			 TO_CHAR(ROUND(CASE
												 WHEN SUM(CASE
																			WHEN  LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0')= PLANMOTH THEN
																			 SUMNODESCORE
																			ELSE
																			 0
																	END) > 0 THEN
													SUM(CASE
																	WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
																	 动态得分
																	ELSE
																	 0
															END) / SUM(CASE
																						 WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
																							SUMNODESCORE
																						 ELSE
																							0
																				 END) * 100
												 ELSE
													0
										 END, 2)) AS "dynamicScoring"
				--本月、季度动态得分
			 ,
			 TO_CHAR(SUM(CASE
											 WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
												应完成
											 ELSE
												0
									 END)) AS "monthShouldComplete"
				--本月、季度应完成数
			 ,
       TO_CHAR(SUM(CASE
											 WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
												SUMNODESCORE
											 ELSE
												0
									 END)) AS "monthShouldCompleteScore"
				--本月应完成总分
        ,
			 TO_CHAR(SUM(CASE
											 WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
												已完成
											 ELSE
												0
									 END)) AS "monthdDone"
				--本月、季度已完成数
			 ,
       TO_CHAR(SUM(CASE
           WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
            已完成总分
           ELSE
            0
        END)) AS "monthdDoneScore"
				--本月已完成总分
			 ,
			 TO_CHAR(SUM(CASE
											 WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
												应完成
											 ELSE
												0
									 END) - SUM(CASE
																	WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
																	 已完成
																	ELSE
																	 0
															END)) AS "monthUnfinished"
				--本月未完成数
			 ,
			 TO_CHAR(SUM(CASE
											 WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
												里程碑红灯
											 ELSE
												0
									 END) + SUM(CASE
																	WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
																	 一级节点红灯
																	ELSE
																	 0
															END) + SUM(CASE
																						 WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
																							二级节点红灯 + 三级节点红灯
																						 ELSE
																							0
																				 END)) AS "red"
				--红灯数
			 ,
			 TO_CHAR(SUM(CASE
											 WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
												里程碑黄灯
											 ELSE
												0
									 END) + SUM(CASE
																	WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
																	 一级节点黄灯
																	ELSE
																	 0
															END) + SUM(CASE
																						 WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
																							二级节点黄灯 + 三级节点黄灯
																						 ELSE
																							0
																				 END)) AS "yellow"
				--黄灯数
			 ,
			 TO_CHAR(SUM(CASE
											 WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
												里程碑绿灯
											 ELSE
												0
									 END) + SUM(CASE
																	WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
																	 一级节点绿灯
																	ELSE
																	 0
															END) + SUM(CASE
																						 WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
																							二级节点绿灯 + 三级节点绿灯
																						 ELSE
																							0
																				 END)) AS "green"
				--绿灯数
			 ,
			 TO_CHAR(SUM(CASE
											 WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
												里程碑应完成
											 ELSE
												0
									 END)) AS "milestoneShouldComplete"
				--里程碑应完成数
			 ,
			 TO_CHAR(SUM(CASE
											 WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
												里程碑已完成
											 ELSE
												0
									 END)) AS "milestoneDone"
				--里程碑已完成数
			 ,
			 TO_CHAR(SUM(CASE
											 WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
												里程碑应完成
											 ELSE
												0
									 END) - SUM(CASE
																	WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
																	 里程碑已完成
																	ELSE
																	 0
															END)) AS "milestoneUnfinished"
				--里程碑未完成数
			 ,
			 TO_CHAR(SUM(CASE
											 WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
												一级节点应完成
											 ELSE
												0
									 END)) AS "oneLevelNodeShouldComplete"
				--一级节点应完成数
			 ,
			 TO_CHAR(SUM(CASE
											 WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
												一级节点已完成
											 ELSE
												0
									 END)) AS "oneLevelNodeDone"
				--一级节点已完成数
			 ,
			 TO_CHAR(SUM(CASE
											 WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
												一级节点应完成
											 ELSE
												0
									 END) - SUM(CASE
																	WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
																	 一级节点已完成
																	ELSE
																	 0
															END)) AS "oneLevelNodeUnfinished"
				--一级节点未完成数
			 , 'WWW.BAIDU.COM' AS "openUrl" --打开地址
			 ,ROUND(CASE
												 WHEN SUM(CASE
																			WHEN  LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0')= PLANMOTH THEN
																			 SUMNODESCORE
																			ELSE
																			 0
																	END) > 0 THEN
													SUM(CASE
																	WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
																	 动态得分
																	ELSE
																	 0
															END) / SUM(CASE
																						 WHEN LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = PLANMOTH THEN
																							SUMNODESCORE
																						 ELSE
																							0
																				 END) * 100
												 ELSE
													0
										 END, 2) as rankorder

 FROM 树 a where CTYPE='TYPE_ORG' and PARENT_ID = '' || ORGID || ''

group by org_name,    id,    parent_id
ORDER BY  24 desc
)
    
    select * from 结果  
    
;
ELSIF RANGETYPE = 20 THEN OPEN INFO FOR

with 树 ( 
   
ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH
,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯, CTYPE
)as( 



select   
ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分
	,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成
	,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯
,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯
,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯
, CTYPE
from POM_PJPLAN_EXM_SOCRE_TABLE where plan_type='关键节点计划' and PLANYEAR= SUBSTR(RANGEVAL, 0, 4)
		
		
UNION all 
select    
a2.ID,a2.PARENT_ID,a2.ORG_NAME,a1.PLAN_TYPE,a1.PROJECT_NAME ,a2.ORDER_CODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成
,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成
,三级节点已完成,里程碑绿灯,一级节点绿灯,二级节点绿灯
,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯
,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯
,三级节点红灯
, 'TYPE_ORG' as CTYPE

from  树 a1 INNER JOIN　SYS_BUSINESS_UNIT a2 on a1.parent_id=a2.id 

		where is_company=1
		
		
		)
    

		
		
		
,结果 as( 
select org_name AS "company"
,id AS "ORGID" ,parent_id
,ROUND(sum(已完成)/sum(应完成),2)*100 as "yearPercentageComplete"
,sum(应完成) AS "yearShouldComplete"
,sum(已完成) AS "yearDone"
,sum(应完成) - sum(已完成)  AS "yearUnfinished" --本年未完成数
, ROUND( case when SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN SUMNODESCORE ELSE 0 END) >0 then  SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 动态得分 ELSE 0 END)
/ SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN SUMNODESCORE ELSE 0 END) * 100  else 0 end, 2) AS "dynamicScoring" --本月、季度动态得分

, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 应完成 ELSE 0 END) AS "quarterShouldComplete" --本月、季度应完成数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN SUMNODESCORE ELSE 0 END) AS "quarterShouldCompleteScore" --本月、季度应完成分数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 已完成 ELSE 0 END) AS "quarterDone" --本月、季度已完成数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 已完成总分 ELSE 0 END) AS "quarterDoneScore" --本月、季度已完成分数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 应完成 ELSE 0 END) - SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 已完成 ELSE 0 END) AS "quarterUnfinished" --本月未完成数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 里程碑红灯 ELSE 0 END) + SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 一级节点红灯 ELSE 0 END) + SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 二级节点红灯 + 三级节点红灯 ELSE 0 END) AS "red" --红灯数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 里程碑黄灯 ELSE 0 END) + SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 一级节点黄灯 ELSE 0 END) + SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 二级节点黄灯 + 三级节点黄灯 ELSE 0 END) AS "yellow" --黄灯数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 里程碑绿灯 ELSE 0 END) + SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 一级节点绿灯 ELSE 0 END) + SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 二级节点绿灯 + 三级节点绿灯 ELSE 0 END) AS "green" --绿灯数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 里程碑应完成 ELSE 0 END) AS "milestoneShouldComplete" --里程碑应完成数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 里程碑已完成 ELSE 0 END) AS "milestoneDone" --里程碑已完成数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 里程碑应完成 ELSE 0 END) - SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 里程碑已完成 ELSE 0 END) AS "milestoneUnfinished" --里程碑未完成数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 一级节点应完成 ELSE 0 END) AS "oneLevelNodeShouldComplete" --一级节点应完成数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 一级节点已完成 ELSE 0 END) AS "oneLevelNodeDone" --一级节点已完成数
, SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 一级节点应完成 ELSE 0 END) - SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 一级节点已完成 ELSE 0 END) AS "oneLevelNodeUnfinished" --一级节点未完成数
, '' AS "openUrl" --打开地址
, ROUND( case when SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN SUMNODESCORE ELSE 0 END) >0 then  SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN 动态得分 ELSE 0 END)
/ SUM(CASE WHEN SUBSTR(RANGEVAL, 6, 2) = PLANQUATOR THEN SUMNODESCORE ELSE 0 END) * 100  else 0 end, 2) as rankorder
 FROM 树 a where CTYPE='TYPE_ORG' and PARENT_ID = '' || ORGID || ''

group by org_name,    id,    parent_id
ORDER BY  24 desc
)
    
    select * from 结果  
    
;

--WHERE 应完成 > 0 AND PLAN_TYPE = '关键节点计划' AND CTYPE = 'TYPE_ORG' AND SUBSTR(RANGEVAL, 0, 4) = PLANYEAR AND PARENT_ID = '' || ORGID || '' GROUP BY ORG_NAME,ORG_FULL_NAME, ID ORDER BY ORG_FULL_NAME asc;

END IF; TITLE := '月度考核排行榜_明细数据统计'; END P_POM_RANK_ORG_EXAM_DTL;
/

prompt
prompt Creating procedure P_POM_RANK_ORG_GETDTL
prompt ========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_RANK_ORG_GETDTL
(
		PLANTYPE  IN VARCHAR2
	 , --计划类型
		RANGETYPE IN INT
	 , --时间范围类型（10:月度，20季度）
		RANGEVAL  IN VARCHAR2
	 , --范围值，月度：2019|09。季度：2019|04
		RANKDTL   OUT SYS_REFCURSOR
) AS
BEGIN
		IF RANGETYPE = 10 THEN
				OPEN RANKDTL FOR
						SELECT ROW_NUMBER() OVER(PARTITION BY A.PARENT_ID ORDER BY ROUND(CASE
											 WHEN NVL(B.本年应完成, 0) > 0 THEN
												NVL(本年已完成, 0) / NVL(B.本年应完成, 0)
											 ELSE
												0
									 END * 100, 2) DESC) AS RANK, A.ID, A.PARENT_ID,
									 A.ORG_NAME, NVL(B.本年应完成, 0) AS 本年应完成,
									 NVL(B.本年已完成, 0) AS 本年已完成
									 --     ,NVL(B.本季度应完成,0) AS 本季度应完成
									 --     ,NVL(B.本季度已完成,0) AS 本季度已完成
									, NVL(B.本月应完成, 0) AS 本月应完成, NVL(B.本月已完成, 0) AS 本月已完成
									 /*动态得分情况*/, NVL(B.本月动态得分, 0) AS 本月动态得分
									 --     ,NVL(B.本季度动态得分,0) AS 本季度动态得分
									 /*里程碑、一级节点完成情况*/, NVL(B.本月里程碑应完成, 0) AS 本月里程碑应完成,
									 NVL(B.本月里程碑已完成, 0) AS 本月里程碑已完成,
									 NVL(B.本月一级节点应完成, 0) AS 本月一级节点应完成,
									 NVL(B.本月一级节点已完成, 0) AS 本月一级节点已完成
									 --     ,NVL(B.本季度里程碑应完成,0) AS 本季度里程碑应完成
									 --     ,NVL(B.本季度里程碑已完成,0) AS 本季度里程碑已完成
									 --     ,NVL(B.本季度一级节点应完成,0) AS 本季度一级节点应完成
									 --     ,NVL(B.本季度一级节点已完成,0) AS 本季度一级节点已完成
									 /*亮点情况*/, NVL(B.本月里程碑绿灯, 0) AS 本月里程碑绿灯,
									 NVL(B.本月里程碑黄灯, 0) AS 本月里程碑黄灯,
									 NVL(B.本月里程碑红灯, 0) AS 本月里程碑红灯,
									 NVL(B.本月一级节点绿灯, 0) AS 本月一级节点绿灯,
									 NVL(B.本月一级节点黄灯, 0) AS 本月一级节点黄灯,
									 NVL(B.本月一级节点红灯, 0) AS 本月一级节点红灯,
									 NVL(B.本月二三级节点绿灯, 0) AS 本月二三级节点绿灯,
									 NVL(B.本月二三级节点黄灯, 0) AS 本月二三级节点黄灯,
									 NVL(B.本月二三级节点红灯, 0) AS 本月二三级节点红灯
									 --     ,NVL(B.本季度里程碑绿灯,0) AS 本季度里程碑绿灯
									 --     ,NVL(B.本季度里程碑黄灯,0) AS 本季度里程碑黄灯
									 --     ,NVL(B.本季度里程碑红灯,0) AS 本季度里程碑红灯
									 --     ,NVL(B.本季度一级节点绿灯,0) AS 本季度一级节点绿灯
									 --     ,NVL(B.本季度一级节点黄灯,0) AS 本季度一级节点黄灯
									 --     ,NVL(B.本季度一级节点红灯,0) AS 本季度一级节点红灯
									 --     ,NVL(B.本季度二三级节点绿灯,0) AS 本季度二三级节点绿灯
									 --     ,NVL(B.本季度二三级节点黄灯,0) AS 本季度二三级节点黄灯
									 --     ,NVL(B.本季度二三级节点红灯,0) AS 本季度二三级节点红灯
									 
									, 'TYPE_ORG' AS CTYPE
						FROM   SYS_BUSINESS_UNIT A
						LEFT   JOIN (SELECT AB.ID, AB.PARENT_ID, SUM(AB.本年应完成) AS 本年应完成,
																SUM(AB.本年已完成) AS 本年已完成
																--     ,SUM(AB.本季度应完成) AS 本季度应完成
																--     ,SUM(AB.本季度已完成) AS 本季度已完成
															 , SUM(AB.本月应完成) AS 本月应完成,
																SUM(AB.本月已完成) AS 本月已完成
																/*动态得分情况*/, SUM(AB.本月动态得分) AS 本月动态得分
																--     ,SUM(AB.本季度动态得分) AS 本季度动态得分
																/*里程碑、一级节点完成情况*/,
																SUM(AB.本月里程碑应完成) AS 本月里程碑应完成,
																SUM(AB.本月里程碑已完成) AS 本月里程碑已完成,
																SUM(AB.本月一级节点应完成) AS 本月一级节点应完成,
																SUM(AB.本月一级节点已完成) AS 本月一级节点已完成
																--     ,SUM(AB.本季度里程碑应完成) AS 本季度里程碑应完成
																--     ,SUM(AB.本季度里程碑已完成) AS 本季度里程碑已完成
																--     ,SUM(AB.本季度一级节点应完成) AS 本季度一级节点应完成
																--     ,SUM(AB.本季度一级节点已完成) AS 本季度一级节点已完成
																/*亮点情况*/, SUM(AB.本月里程碑绿灯) AS 本月里程碑绿灯,
																SUM(AB.本月里程碑黄灯) AS 本月里程碑黄灯,
																SUM(AB.本月里程碑红灯) AS 本月里程碑红灯,
																SUM(AB.本月一级节点绿灯) AS 本月一级节点绿灯,
																SUM(AB.本月一级节点黄灯) AS 本月一级节点黄灯,
																SUM(AB.本月一级节点红灯) AS 本月一级节点红灯,
																SUM(AB.本月二三级节点绿灯) AS 本月二三级节点绿灯,
																SUM(AB.本月二三级节点黄灯) AS 本月二三级节点黄灯,
																SUM(AB.本月二三级节点红灯) AS 本月二三级节点红灯
												 --     ,SUM(AB.本季度里程碑绿灯) AS 本季度里程碑绿灯
												 --     ,SUM(AB.本季度里程碑黄灯) AS 本季度里程碑黄灯
												 --     ,SUM(AB.本季度里程碑红灯) AS 本季度里程碑红灯
												 --     ,SUM(AB.本季度一级节点绿灯) AS 本季度一级节点绿灯
												 --     ,SUM(AB.本季度一级节点黄灯) AS 本季度一级节点黄灯
												 --     ,SUM(AB.本季度一级节点红灯) AS 本季度一级节点红灯
												 --     ,SUM(AB.本季度二三级节点绿灯) AS 本季度二三级节点绿灯
												 --     ,SUM(AB.本季度二三级节点黄灯) AS 本季度二三级节点黄灯
												 --     ,SUM(AB.本季度二三级节点红灯) AS 本季度二三级节点红灯
												 FROM   (
																	--  11
																	
																	SELECT
																	/*完成情况*/
																	 NVL(B.本年应完成, 0) AS 本年应完成,
																		NVL(B.本年已完成, 0) AS 本年已完成
																		--                    ,NVL(B.本季度应完成,0) AS 本季度应完成
																		--                    ,NVL(B.本季度已完成,0) AS 本季度已完成
																	, NVL(B.本月应完成, 0) AS 本月应完成,
																		NVL(B.本月已完成, 0) AS 本月已完成
																		/*动态得分情况*/, NVL(B.本月动态得分, 0) AS 本月动态得分
																		--                    ,NVL(B.本季度动态得分,0) AS 本季度动态得分
																		/*里程碑、一级节点完成情况*/,
																		NVL(B.本月里程碑应完成, 0) AS 本月里程碑应完成,
																		NVL(B.本月里程碑已完成, 0) AS 本月里程碑已完成,
																		NVL(B.本月一级节点应完成, 0) AS 本月一级节点应完成,
																		NVL(B.本月一级节点已完成, 0) AS 本月一级节点已完成
																		--                    ,NVL(B.本季度里程碑应完成,0) AS 本季度里程碑应完成
																		--                    ,NVL(B.本季度里程碑已完成,0) AS 本季度里程碑已完成
																		--                    ,NVL(B.本季度一级节点应完成,0) AS 本季度一级节点应完成
																		--                    ,NVL(B.本季度一级节点已完成,0) AS 本季度一级节点已完成
																		/*亮点情况*/, NVL(B.本月里程碑绿灯, 0) AS 本月里程碑绿灯,
																		NVL(B.本月里程碑黄灯, 0) AS 本月里程碑黄灯,
																		NVL(B.本月里程碑红灯, 0) AS 本月里程碑红灯,
																		NVL(B.本月一级节点绿灯, 0) AS 本月一级节点绿灯,
																		NVL(B.本月一级节点黄灯, 0) AS 本月一级节点黄灯,
																		NVL(B.本月一级节点红灯, 0) AS 本月一级节点红灯,
																		NVL(B.本月二三级节点绿灯, 0) AS 本月二三级节点绿灯,
																		NVL(B.本月二三级节点黄灯, 0) AS 本月二三级节点黄灯,
																		NVL(B.本月二三级节点红灯, 0) AS 本月二三级节点红灯
																		--                    ,NVL(B.本季度里程碑绿灯,0) AS 本季度里程碑绿灯
																		--                    ,NVL(B.本季度里程碑黄灯,0) AS 本季度里程碑黄灯
																		--                    ,NVL(B.本季度里程碑红灯,0) AS 本季度里程碑红灯
																		--                    ,NVL(B.本季度一级节点绿灯,0) AS 本季度一级节点绿灯
																		--                    ,NVL(B.本季度一级节点黄灯,0) AS 本季度一级节点黄灯
																		--                    ,NVL(B.本季度一级节点红灯,0) AS 本季度一级节点红灯
																		--                    ,NVL(B.本季度二三级节点绿灯,0) AS 本季度二三级节点绿灯
																		--                    ,NVL(B.本季度二三级节点黄灯,0) AS 本季度二三级节点黄灯
																		--                    ,NVL(B.本季度二三级节点红灯,0) AS 本季度二三级节点红灯
																	, CONNECT_BY_ROOT ID AS ID,
																		CONNECT_BY_ROOT PARENT_ID AS PARENT_ID
																	FROM   SYS_BUSINESS_UNIT A
																	LEFT   JOIN (
																							 
																							 SELECT B1.UNIT_ID,
																											 COUNT(A1.ID) AS "NODESUM",
																											 SUM(STANDARD_SCORE) AS "SUMNODESCORE"
																											 --完成规则
																											 
																											 ------------------
																											 /*本年任务*/
																											 ------------------
																											 ------
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.PLAN_END_DATE, 'YYYY') = TO_CHAR(SYSDATE, 'YYYY') THEN
																																 1
																																ELSE
																																 0
																														END
																														
																														) AS "本年应完成",
																											 SUM((CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本年
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY') = TO_CHAR(SYSDATE, 'YYYY')
																																--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																 THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本年已完成"
																											 
																											 ------------------
																											 /*本月任务*/
																											 ------------------
																											 ------
																											 ,
																											 SUM((CASE
																																WHEN TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																			FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本月应完成",
																											 SUM((CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																 THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本月已完成"
																											 
																											 ,
																											 SUM((CASE
																														--按时完成
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(A1.PLAN_END_DATE, 'DD') - TRUNC(D.APPROVAL_TIME, 'DD')) BETWEEN 0 AND 29 THEN
																																 A1.STANDARD_SCORE * 1
																														--提前一个月完成
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL --判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(A1.PLAN_END_DATE, 'DD') - TRUNC(D.APPROVAL_TIME, 'DD')) >= 30 AND
																																		 A1.NODE_LEVEL = '里程碑' THEN
																																 A1.STANDARD_SCORE * 1.2
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(A1.PLAN_END_DATE, 'DD') - TRUNC(D.APPROVAL_TIME, 'DD')) >= 30 AND
																																		 A1.NODE_LEVEL = '一级节点' THEN
																																 A1.STANDARD_SCORE * 1.1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(A1.PLAN_END_DATE, 'DD') - TRUNC(D.APPROVAL_TIME, 'DD')) >= 30 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 A1.STANDARD_SCORE * 1.0
																														--延时完成
																														--里程碑、一级节点3天
																														--二三级节点5天
																														--延时完成
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('里程碑', '一级节点') THEN
																																 A1.STANDARD_SCORE * 0.6
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 3 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 A1.STANDARD_SCORE * 1.0
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 4 AND 7 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 A1.STANDARD_SCORE * 0.6
																														--红灯
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('里程碑', '一级节点') THEN
																																 A1.STANDARD_SCORE * 0
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 8 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 A1.STANDARD_SCORE * 0
																																ELSE
																																 0
																														END)) AS "本月动态得分"
																											 
																											 ------------------
																											 /*-里程碑完成情况*/
																											 ------------------
																											 ,
																											 SUM((CASE
																																WHEN A1. NODE_LEVEL = '里程碑' AND
																																		 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																			FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本月里程碑应完成",
																											 SUM((CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL AND A1.
																																 NODE_LEVEL = '里程碑' AND
																																		 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																			FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本月里程碑已完成"
																											 ------------------
																											 /*-一级节点完成情况*/
																											 ------------------
																											 ,
																											 SUM((CASE
																																WHEN A1. NODE_LEVEL = '一级节点' AND
																																		 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																			FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本月一级节点应完成",
																											 SUM((CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL AND A1.
																																 NODE_LEVEL = '一级节点' AND
																																		 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																			FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本月一级节点已完成"
																											 
																											 ------------------
																											 /*-里程碑本月亮灯情况*/
																											 ------------------
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) <= 0 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月里程碑绿灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月里程碑黄灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月里程碑红灯"
																											 
																											 ------------------
																											 /*一级节点本月亮灯情况*/
																											 ------------------
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) <= 0 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月一级节点绿灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月一级节点黄灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月一级节点红灯"
																											 
																											 ------------------
																											 /*二三级节点本月亮灯情况*/
																											 ------------------
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) <= 2 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月二三级节点绿灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 3 AND 7 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 3 AND 7 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月二三级节点黄灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 8 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本月
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.铁建_本年 || '-' || TO_CHAR(TO_NUMBER(铁建_本月) - 1) || '-' || '26'
																																					FROM   V_POM_GETEXAMINE_MOTH A) AND
																																		 (SELECT A.铁建_本年 || '-' || 铁建_本月 || '-' || '25'
																																			FROM   V_POM_GETEXAMINE_MOTH A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 8 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本月二三级节点红灯"
																							 
																							 FROM   POM_PROJ_PLAN A
																							 INNER  JOIN POM_PROJ_PLAN_NODE A1
																							 ON     A.ID = A1.PROJ_PLAN_ID
																							 INNER  JOIN SYS_PROJECT_STAGE C1
																							 ON     A.PROJ_ID = C1.ID
																							 INNER  JOIN SYS_PROJECT B1
																							 ON     C1.PROJECT_ID = B1.ID
																							 LEFT   JOIN POM_NODE_FEEDBACK D
																							 ON     D.FEEDBACK_NODE_ID = A1.ID AND
																											FEEDBACK_TYPE = '完成反馈' AND
																											D.APPROVAL_STATUS = '已审核'
																							 WHERE  A.PLAN_TYPE = '项目主项计划' AND
																											A.APPROVAL_STATUS = '已审核'
																							 GROUP  BY B1.UNIT_ID) B
																	ON     A.ID = B.UNIT_ID
																	WHERE  NVL(B.NODESUM, 0) > 0
																	CONNECT BY PRIOR A.ID = A.PARENT_ID) AB
												 GROUP  BY AB.ID, AB.PARENT_ID) B
						ON     A.ID = B.ID
						WHERE  A.ORG_TYPE = 0 AND
									 A.COMPANY_TYPE = '5' AND
									 A.PARENT_ID = '003200000000000000000000000000';
		
		ELSIF RANGETYPE = 20 THEN
				OPEN RANKDTL FOR
						SELECT ROW_NUMBER() OVER(PARTITION BY A.PARENT_ID ORDER BY ROUND(CASE
											 WHEN NVL(B.本年应完成, 0) > 0 THEN
												NVL(本年已完成, 0) / NVL(B.本年应完成, 0)
											 ELSE
												0
									 END * 100, 2) DESC) AS RANK, A.ID, A.PARENT_ID,
									 A.ORG_NAME, NVL(B.本年应完成, 0) AS 本年应完成,
									 NVL(B.本年已完成, 0) AS 本年已完成, NVL(B.本季度应完成, 0) AS 本季度应完成,
									 NVL(B.本季度已完成, 0) AS 本季度已完成
									 --     ,NVL(B.本月应完成,0) AS 本月应完成
									 --     ,NVL(B.本月已完成,0) AS 本月已完成
									 /*动态得分情况*/
									 --     ,NVL(B.本月动态得分,0) AS 本月动态得分
									, NVL(B.本季度动态得分, 0) AS 本季度动态得分
									 /*里程碑、一级节点完成情况*/
									 --     ,NVL(B.本月里程碑应完成,0) AS 本月里程碑应完成
									 --     ,NVL(B.本月里程碑已完成,0) AS 本月里程碑已完成
									 --     ,NVL(B.本月一级节点应完成,0) AS 本月一级节点应完成
									 --     ,NVL(B.本月一级节点已完成,0) AS 本月一级节点已完成
									, NVL(B.本季度里程碑应完成, 0) AS 本季度里程碑应完成,
									 NVL(B.本季度里程碑已完成, 0) AS 本季度里程碑已完成,
									 NVL(B.本季度一级节点应完成, 0) AS 本季度一级节点应完成,
									 NVL(B.本季度一级节点已完成, 0) AS 本季度一级节点已完成
									 /*亮点情况*/
									 --     ,NVL(B.本月里程碑绿灯,0) AS 本月里程碑绿灯
									 --     ,NVL(B.本月里程碑黄灯,0) AS 本月里程碑黄灯
									 --     ,NVL(B.本月里程碑红灯,0) AS 本月里程碑红灯
									 --     ,NVL(B.本月一级节点绿灯,0) AS 本月一级节点绿灯
									 --     ,NVL(B.本月一级节点黄灯,0) AS 本月一级节点黄灯
									 --     ,NVL(B.本月一级节点红灯,0) AS 本月一级节点红灯
									 --     ,NVL(B.本月二三级节点绿灯,0) AS 本月二三级节点绿灯
									 --     ,NVL(B.本月二三级节点黄灯,0) AS 本月二三级节点黄灯
									 --     ,NVL(B.本月二三级节点红灯,0) AS 本月二三级节点红灯
									, NVL(B.本季度里程碑绿灯, 0) AS 本季度里程碑绿灯,
									 NVL(B.本季度里程碑黄灯, 0) AS 本季度里程碑黄灯,
									 NVL(B.本季度里程碑红灯, 0) AS 本季度里程碑红灯,
									 NVL(B.本季度一级节点绿灯, 0) AS 本季度一级节点绿灯,
									 NVL(B.本季度一级节点黄灯, 0) AS 本季度一级节点黄灯,
									 NVL(B.本季度一级节点红灯, 0) AS 本季度一级节点红灯,
									 NVL(B.本季度二三级节点绿灯, 0) AS 本季度二三级节点绿灯,
									 NVL(B.本季度二三级节点黄灯, 0) AS 本季度二三级节点黄灯,
									 NVL(B.本季度二三级节点红灯, 0) AS 本季度二三级节点红灯
									 
									, 'TYPE_ORG' AS CTYPE
						FROM   SYS_BUSINESS_UNIT A
						LEFT   JOIN (SELECT AB.ID, AB.PARENT_ID, SUM(AB.本年应完成) AS 本年应完成,
																SUM(AB.本年已完成) AS 本年已完成,
																SUM(AB.本季度应完成) AS 本季度应完成,
																SUM(AB.本季度已完成) AS 本季度已完成
																--     ,SUM(AB.本月应完成) AS 本月应完成
																--     ,SUM(AB.本月已完成) AS 本月已完成
																/*动态得分情况*/
																--     ,SUM(AB.本月动态得分) AS 本月动态得分
															 , SUM(AB.本季度动态得分) AS 本季度动态得分
																/*里程碑、一级节点完成情况*/
																--     ,SUM(AB.本月里程碑应完成) AS 本月里程碑应完成
																--     ,SUM(AB.本月里程碑已完成) AS 本月里程碑已完成
																--     ,SUM(AB.本月一级节点应完成) AS 本月一级节点应完成
																--     ,SUM(AB.本月一级节点已完成) AS 本月一级节点已完成
															 , SUM(AB.本季度里程碑应完成) AS 本季度里程碑应完成,
																SUM(AB.本季度里程碑已完成) AS 本季度里程碑已完成,
																SUM(AB.本季度一级节点应完成) AS 本季度一级节点应完成,
																SUM(AB.本季度一级节点已完成) AS 本季度一级节点已完成
																/*亮点情况*/
																--     ,SUM(AB.本月里程碑绿灯) AS 本月里程碑绿灯
																--     ,SUM(AB.本月里程碑黄灯) AS 本月里程碑黄灯
																--     ,SUM(AB.本月里程碑红灯) AS 本月里程碑红灯
																--     ,SUM(AB.本月一级节点绿灯) AS 本月一级节点绿灯
																--     ,SUM(AB.本月一级节点黄灯) AS 本月一级节点黄灯
																--     ,SUM(AB.本月一级节点红灯) AS 本月一级节点红灯
																--     ,SUM(AB.本月二三级节点绿灯) AS 本月二三级节点绿灯
																--     ,SUM(AB.本月二三级节点黄灯) AS 本月二三级节点黄灯
																--     ,SUM(AB.本月二三级节点红灯) AS 本月二三级节点红灯
															 , SUM(AB.本季度里程碑绿灯) AS 本季度里程碑绿灯,
																SUM(AB.本季度里程碑黄灯) AS 本季度里程碑黄灯,
																SUM(AB.本季度里程碑红灯) AS 本季度里程碑红灯,
																SUM(AB.本季度一级节点绿灯) AS 本季度一级节点绿灯,
																SUM(AB.本季度一级节点黄灯) AS 本季度一级节点黄灯,
																SUM(AB.本季度一级节点红灯) AS 本季度一级节点红灯,
																SUM(AB.本季度二三级节点绿灯) AS 本季度二三级节点绿灯,
																SUM(AB.本季度二三级节点黄灯) AS 本季度二三级节点黄灯,
																SUM(AB.本季度二三级节点红灯) AS 本季度二三级节点红灯
												 FROM   (
																	--  11
																	
																	SELECT
																	/*完成情况*/
																	 NVL(B.本年应完成, 0) AS 本年应完成,
																		NVL(B.本年已完成, 0) AS 本年已完成,
																		NVL(B.本季度应完成, 0) AS 本季度应完成,
																		NVL(B.本季度已完成, 0) AS 本季度已完成
																		--                    ,NVL(B.本月应完成,0) AS 本月应完成
																		--                    ,NVL(B.本月已完成,0) AS 本月已完成
																		/*动态得分情况*/
																		--                    ,NVL(B.本月动态得分,0) AS 本月动态得分
																	, NVL(B.本季度动态得分, 0) AS 本季度动态得分
																		/*里程碑、一级节点完成情况*/
																		--                    ,NVL(B.本月里程碑应完成,0) AS 本月里程碑应完成
																		--                    ,NVL(B.本月里程碑已完成,0) AS 本月里程碑已完成
																		--                    ,NVL(B.本月一级节点应完成,0) AS 本月一级节点应完成
																		--                    ,NVL(B.本月一级节点已完成,0) AS 本月一级节点已完成
																	, NVL(B.本季度里程碑应完成, 0) AS 本季度里程碑应完成,
																		NVL(B.本季度里程碑已完成, 0) AS 本季度里程碑已完成,
																		NVL(B.本季度一级节点应完成, 0) AS 本季度一级节点应完成,
																		NVL(B.本季度一级节点已完成, 0) AS 本季度一级节点已完成
																		/*亮点情况*/
																		--                    ,NVL(B.本月里程碑绿灯,0) AS 本月里程碑绿灯
																		--                    ,NVL(B.本月里程碑黄灯,0) AS 本月里程碑黄灯
																		--                    ,NVL(B.本月里程碑红灯,0) AS 本月里程碑红灯
																		--                    ,NVL(B.本月一级节点绿灯,0) AS 本月一级节点绿灯
																		--                    ,NVL(B.本月一级节点黄灯,0) AS 本月一级节点黄灯
																		--                    ,NVL(B.本月一级节点红灯,0) AS 本月一级节点红灯
																		--                    ,NVL(B.本月二三级节点绿灯,0) AS 本月二三级节点绿灯
																		--                    ,NVL(B.本月二三级节点黄灯,0) AS 本月二三级节点黄灯
																		--                    ,NVL(B.本月二三级节点红灯,0) AS 本月二三级节点红灯
																	, NVL(B.本季度里程碑绿灯, 0) AS 本季度里程碑绿灯,
																		NVL(B.本季度里程碑黄灯, 0) AS 本季度里程碑黄灯,
																		NVL(B.本季度里程碑红灯, 0) AS 本季度里程碑红灯,
																		NVL(B.本季度一级节点绿灯, 0) AS 本季度一级节点绿灯,
																		NVL(B.本季度一级节点黄灯, 0) AS 本季度一级节点黄灯,
																		NVL(B.本季度一级节点红灯, 0) AS 本季度一级节点红灯,
																		NVL(B.本季度二三级节点绿灯, 0) AS 本季度二三级节点绿灯,
																		NVL(B.本季度二三级节点黄灯, 0) AS 本季度二三级节点黄灯,
																		NVL(B.本季度二三级节点红灯, 0) AS 本季度二三级节点红灯,
																		CONNECT_BY_ROOT ID AS ID,
																		CONNECT_BY_ROOT PARENT_ID AS PARENT_ID
																	FROM   SYS_BUSINESS_UNIT A
																	LEFT   JOIN (
																							 
																							 SELECT B1.UNIT_ID,
																											 COUNT(A1.ID) AS "NODESUM",
																											 SUM(STANDARD_SCORE) AS "SUMNODESCORE"
																											 --完成规则
																											 
																											 ------------------
																											 /*本年任务*/
																											 ------------------
																											 ------
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.PLAN_END_DATE, 'YYYY') = TO_CHAR(SYSDATE, 'YYYY') THEN
																																 1
																																ELSE
																																 0
																														END
																														
																														) AS "本年应完成",
																											 SUM((CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本年
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY') = TO_CHAR(SYSDATE, 'YYYY')
																																--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																 THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本年已完成"
																											 
																											 ------------------
																											 /*本季度任务*/
																											 ------------------
																											 ------
																											 ,
																											 SUM((CASE
																																WHEN
																																--判断季度
																																 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																 (SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																	FROM   V_POM_GETEXAMINE_QUARTER A) AND
																																 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																	FROM   V_POM_GETEXAMINE_QUARTER A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本季度应完成",
																											 SUM((CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 (SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																 THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本季度已完成"
																											 
																											 ,
																											 SUM((CASE
																														--按时完成
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(A1.PLAN_END_DATE, 'DD') - TRUNC(D.APPROVAL_TIME, 'DD')) BETWEEN 0 AND 29 THEN
																																 A1.STANDARD_SCORE * 1
																														
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL --判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(A1.PLAN_END_DATE, 'DD') - TRUNC(D.APPROVAL_TIME, 'DD')) >= 30 AND
																																		 A1.NODE_LEVEL = '里程碑' THEN
																																 A1.STANDARD_SCORE * 1.2
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(A1.PLAN_END_DATE, 'DD') - TRUNC(D.APPROVAL_TIME, 'DD')) >= 30 AND
																																		 A1.NODE_LEVEL = '一级节点' THEN
																																 A1.STANDARD_SCORE * 1.1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(A1.PLAN_END_DATE, 'DD') - TRUNC(D.APPROVAL_TIME, 'DD')) >= 30 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 A1.STANDARD_SCORE * 1.0
																														--延时完成
																														--里程碑、一级节点3天
																														--二三级节点5天
																														--延时完成
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('里程碑', '一级节点') THEN
																																 A1.STANDARD_SCORE * 0.6
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 3 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 A1.STANDARD_SCORE * 1.0
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 4 AND 7 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 A1.STANDARD_SCORE * 0.6
																														--红灯
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('里程碑', '一级节点') THEN
																																 A1.STANDARD_SCORE * 0
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 8 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 A1.STANDARD_SCORE * 0
																																ELSE
																																 0
																														END)) AS "本季度动态得分"
																											 
																											 ------------------
																											 /*-里程碑完成情况*/
																											 ------------------
																											 ,
																											 SUM((CASE
																																WHEN A1. NODE_LEVEL = '里程碑' AND
																																		 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																			 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本季度里程碑应完成",
																											 SUM((CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL AND A1.
																																 NODE_LEVEL = '里程碑' AND
																																		 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本季度里程碑已完成"
																											 ------------------
																											 /*-一级节点完成情况*/
																											 ------------------
																											 ,
																											 SUM((CASE
																																WHEN A1. NODE_LEVEL = '一级节点' AND
																																		 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																			 FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本季度一级节点应完成",
																											 SUM((CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL AND A1.
																																 NODE_LEVEL = '一级节点' AND
																																		 TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A) THEN
																																 1
																																ELSE
																																 0
																														END)) AS "本季度一级节点已完成"
																											 
																											 ------------------
																											 /*-里程碑本季度亮灯情况*/
																											 ------------------
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) <= 0 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度里程碑绿灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度里程碑黄灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('里程碑') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度里程碑红灯"
																											 
																											 ------------------
																											 /*一级节点本季度亮灯情况*/
																											 ------------------
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) <= 0 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度一级节点绿灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 1 AND 4 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度一级节点黄灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 5 AND
																																		 A1.NODE_LEVEL IN ('一级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度一级节点红灯"
																											 
																											 ------------------
																											 /*二三级节点本季度亮灯情况*/
																											 ------------------
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) <= 2 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度二三级节点绿灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 3 AND 7 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) BETWEEN 3 AND 7 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度二三级节点黄灯"
																											 
																											 ,
																											 SUM(CASE
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NOT NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND
																																		 (TRUNC(D.APPROVAL_TIME, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 8 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																																WHEN TO_CHAR(A1.ACTUAL_END_DATE, 'YYYY-MM-DD') IS NULL
																																		--判断本季度
																																		 AND TO_CHAR(A1.PLAN_END_DATE, 'YYYY-MM-DD') BETWEEN
																																		 ((SELECT A.开始年度 || '-' || A.开始月份 || '-26'
																																					FROM   V_POM_GETEXAMINE_QUARTER A)) AND
																																		 (SELECT A.开始年度 || '-' || A.结束月份 || '-25'
																																			FROM   V_POM_GETEXAMINE_QUARTER A)
																																		--WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
																																		 AND (TRUNC(SYSDATE, 'DD') - TRUNC(A1.PLAN_END_DATE, 'DD')) >= 8 AND
																																		 A1.NODE_LEVEL IN ('二级节点', '三级节点') THEN
																																 1
																														
																																ELSE
																																 0
																														END) AS "本季度二三级节点红灯"
																							 
																							 FROM   POM_PROJ_PLAN A
																							 INNER  JOIN POM_PROJ_PLAN_NODE A1
																							 ON     A.ID = A1.PROJ_PLAN_ID
																							 INNER  JOIN SYS_PROJECT_STAGE C1
																							 ON     A.PROJ_ID = C1.ID
																							 INNER  JOIN SYS_PROJECT B1
																							 ON     C1.PROJECT_ID = B1.ID
																							 LEFT   JOIN POM_NODE_FEEDBACK D
																							 ON     D.FEEDBACK_NODE_ID = A1.ID AND
																											FEEDBACK_TYPE = '完成反馈' AND
																											D.APPROVAL_STATUS = '已审核'
																							 WHERE  A.PLAN_TYPE = '项目主项计划' AND
																											A.APPROVAL_STATUS = '已审核'
																							 GROUP  BY B1.UNIT_ID) B
																	ON     A.ID = B.UNIT_ID
																	WHERE  NVL(B.NODESUM, 0) > 0
																	CONNECT BY PRIOR A.ID = A.PARENT_ID) AB
												 GROUP  BY AB.ID, AB.PARENT_ID) B
						ON     A.ID = B.ID
						WHERE  A.ORG_TYPE = 0 AND
									 A.COMPANY_TYPE = '5' AND
									 A.PARENT_ID = '003200000000000000000000000000';
		END IF;

END P_POM_RANK_ORG_GETDTL;
/

prompt
prompt Creating procedure P_POM_RANK_PROJ_EXAMINATION
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_rank_proj_examination (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    rangetype        IN             INT,--时间范围类型（10:月度，20季度）
     plantype       IN             INT,--计划类型（30：关键节点计划，40：项目主项计划）
    rangeval    IN          VARCHAR2,--范围值，月度：2019|09。季度：2019|04
    orgid       IN          VARCHAR2,--组织id(关键节点计划传空,项目主项计划传）
    title          OUT            VARCHAR2,--标题
    bartype        OUT            VARCHAR2,--图类型
    unit           OUT            VARCHAR2,--单位
    info      OUT            SYS_REFCURSOR--图数据
) AS
--项目考核排行
--作者：陈丽
--日期：2019/11/13
  org_lenth NUMBER(10):=60;
  lpad_str  VARCHAR2(10):=' ';
BEGIN

IF rangetype=10  AND plantype=30
THEN
OPEN info FOR
SELECT  lpad(A.ORG_NAME,org_lenth-length(A.ORG_NAME),lpad_str) AS "name",
			 TO_CHAR(CASE
									 WHEN SUM(CASE
																WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND
																		 LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = A.PLANMOTH THEN
																 SUMNODESCORE
																ELSE
																 0
														END) > 0 THEN
										ROUND(SUM(CASE

																	WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND
																			LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = A.PLANMOTH THEN
																	  "动态得分"
																	ELSE
																	 0
															END) / SUM(CASE

																						 WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND
																									LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = A.PLANMOTH THEN
																							SUMNODESCORE
																						 ELSE
																							0
																				 END) * 100, 2)
									 ELSE
										0
							 END) AS "total"
			  ,  
   CASE
									 WHEN SUM(CASE
																WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND
																		 LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = A.PLANMOTH THEN
																 SUMNODESCORE
																ELSE
																 0
														END) > 0 THEN
										ROUND(SUM(CASE

																	WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND
																			 LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = A.PLANMOTH THEN
																	  "动态得分"
																	ELSE
																	 0
															END) / SUM(CASE

																						 WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND
																									LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = A.PLANMOTH THEN
																							SUMNODESCORE
																						 ELSE
																							0
																				 END) * 100, 2)
									 ELSE
										0
							 END
          
           AS   totalRank
				--,'90 'AS "total"
			 , '#37cd69' AS "color"
FROM   POM_PJPLAN_EXM_SOCRE_TABLE A
 
WHERE  1=1

		AND 	 A.PLAN_TYPE = '关键节点计划'
		AND 	 A.CTYPE = 'TYPE_PROJTOP'  
		AND 	 SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR  
		AND 	 LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = A.PLANMOTH  
		 AND( A.PARENT_ID  IN (  SELECT a.ID
 	from   SYS_BUSINESS_UNIT A
 	where  1=1 and    IS_COMPANY=1
 	START WITH a.id=''||orgid||''
 	CONNECT  by PRIOR   A.ID= A.PARENT_ID	)
 	OR A.ID=''||orgid||'')
--      AND   B.COMPANY_TYPE='5'
GROUP  BY A.ORG_NAME
HAVING SUM(SUMNODESCORE)>0
ORDER  BY 3 asc;







ELSIF RANGETYPE = 10 AND PLANTYPE = 40 THEN OPEN INFO FOR

SELECT  lpad(A.ORG_NAME,org_lenth-length(A.ORG_NAME),lpad_str) AS "name"
, TO_CHAR(CASE WHEN SUM(CASE WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = A.PLANMOTH THEN SUMNODESCORE ELSE 0 END) > 0 THEN ROUND(SUM(CASE
WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = A.PLANMOTH THEN  "动态得分" ELSE 0 END)
/ SUM(CASE
WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = A.PLANMOTH THEN SUMNODESCORE ELSE 0 END) * 100, 2) ELSE 0 END) AS "total" --,'90 'AS "total"
  ,  
  CASE WHEN SUM(CASE WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = A.PLANMOTH THEN SUMNODESCORE ELSE 0 END) > 0 THEN ROUND(SUM(CASE
WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = A.PLANMOTH THEN  "动态得分" ELSE 0 END)
/ SUM(CASE
WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = A.PLANMOTH THEN SUMNODESCORE ELSE 0 END) * 100, 2) ELSE 0 END
          
           AS   totalRank
			
, '#37cd69' AS "color"
FROM POM_PJPLAN_EXM_SOCRE_TABLE A 
-- INNER JOIN SYS_BUSINESS_UNIT B ON A.ID = B.ID
WHERE 1=1
AND SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR 
AND LPAD( TO_CHAR(SUBSTR( RANGEVAL, 6, 1 )),2,'0') = A.PLANMOTH 
AND A.CTYPE = 'TYPE_PROJTOP' AND A.PLAN_TYPE = '项目主项计划'
AND( A.PARENT_ID  IN (  SELECT a.ID
 	from   SYS_BUSINESS_UNIT A
 	where  1=1 and    IS_COMPANY=1
 	START WITH a.id=''||orgid||''
 	CONNECT  by PRIOR   A.ID= A.PARENT_ID	)
 	OR A.ID=''||orgid||'')
GROUP BY A.ORG_NAME ORDER BY 3 asc ;




ELSIF RANGETYPE = 20 AND PLANTYPE = 30 THEN 

OPEN INFO FOR 

SELECT  lpad(A.ORG_NAME,org_lenth-length(A.ORG_NAME),lpad_str) AS "name"
, TO_CHAR(CASE WHEN SUM(CASE WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN SUMNODESCORE ELSE 0 END) > 0 THEN ROUND(SUM(CASE
WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN  "动态得分" ELSE 0 END)
/ SUM(CASE
WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN SUMNODESCORE ELSE 0 END) * 100, 2) ELSE 0 END) AS "total" --,'90 'AS "total"
  ,  
   CASE WHEN SUM(CASE WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN SUMNODESCORE ELSE 0 END) > 0 THEN ROUND(SUM(CASE
WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN  "动态得分" ELSE 0 END)
/ SUM(CASE
WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN SUMNODESCORE ELSE 0 END) * 100, 2) ELSE 0 END
          
           AS   totalRank
, '#37cd69' AS "color" 
FROM POM_PJPLAN_EXM_SOCRE_TABLE A 
-- INNER JOIN SYS_BUSINESS_UNIT B ON A.ID = B.ID 
WHERE 1=1
AND A.CTYPE = 'TYPE_PROJTOP' 
AND A.PLAN_TYPE = '关键节点计划' 
AND SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR
AND( A.PARENT_ID  IN (  SELECT a.ID
 	from   SYS_BUSINESS_UNIT A
 	where  1=1 and    IS_COMPANY=1
 	START WITH a.id=''||orgid||''
 	CONNECT  by PRIOR   A.ID= A.PARENT_ID	)
 	OR A.ID=''||orgid||'')
--      AND   B.COMPANY_TYPE='5'
GROUP BY A.ORG_NAME ORDER BY 3 asc;


ELSIF RANGETYPE = 20 AND PLANTYPE = 40 THEN 
OPEN INFO FOR 
SELECT  lpad(A.ORG_NAME,org_lenth-length(A.ORG_NAME),lpad_str) AS "name"
, TO_CHAR(CASE WHEN SUM(CASE WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN SUMNODESCORE ELSE 0 END) > 0 THEN ROUND(SUM(CASE
WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN  "动态得分" ELSE 0 END)
/ SUM(CASE
WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN SUMNODESCORE ELSE 0 END) * 100, 2) ELSE 0 END) AS "total" --,'90 'AS "total"
  ,  
 CASE WHEN SUM(CASE WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN SUMNODESCORE ELSE 0 END) > 0 THEN ROUND(SUM(CASE
WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN  "动态得分" ELSE 0 END)
/ SUM(CASE
WHEN SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR THEN SUMNODESCORE ELSE 0 END) * 100, 2) ELSE 0 END
          
           AS   totalRank
			
, '#37cd69' AS "color" 
FROM POM_PJPLAN_EXM_SOCRE_TABLE A 
-- INNER JOIN SYS_BUSINESS_UNIT B ON A.ID = B.ID 
WHERE 1=1
AND SUBSTR(RANGEVAL, 0, 4) = A.PLANYEAR 
AND SUBSTR(RANGEVAL, 6, 2) = A.PLANQUATOR 
AND A.CTYPE = 'TYPE_PROJTOP' 
AND A.PLAN_TYPE = '项目主项计划'
AND( A.PARENT_ID  IN (  SELECT a.ID
 	from   SYS_BUSINESS_UNIT A
 	where  1=1 and    IS_COMPANY=1
 	START WITH a.id=''||orgid||''
 	CONNECT  by PRIOR   A.ID= A.PARENT_ID	)
 	OR A.ID=''||orgid||'')
GROUP BY A.ORG_NAME ORDER BY 3 asc; END IF; TITLE := CASE WHEN PLANTYPE = 40 THEN '项目主项计划' ELSE '关键节点计划' END || '考核_项目排行榜：'; UNIT := '%'; BARTYPE := 'column';

END P_POM_RANK_PROJ_EXAMINATION;
/

prompt
prompt Creating procedure P_POM_RANK_PROJ_EXAM_DTL
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_rank_proj_exam_dtl (
    userid         IN             VARCHAR2, --当前用户id
    stationid      IN             VARCHAR2, --当前用户岗位id
    departmentid   IN             VARCHAR2, --当前用户部门id
    companyid      IN             VARCHAR2, --当前用户公司id
    rangetype      IN             INT,--时间范围类型（10:月度，20季度）
    rangeval       IN             VARCHAR2,--范围值，月度：2019|09。季度：2019|04
    orgid          IN             VARCHAR2,--组织id(关键节点计划传空,项目主项计划传）
    title          OUT            VARCHAR2,
    info           OUT            SYS_REFCURSOR--需要程序组装树
) AS
--公司考核排行详情
--作者：陈丽
--日期：2019/11/13
BEGIN

 

IF rangetype=10 then
   OPEN info FOR
 
  

with 树 ( 
   
ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH
,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯, CTYPE
)as( 



select   
ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分
	,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成
	,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯
,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯
,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯
, CTYPE
from POM_PJPLAN_EXM_SOCRE_TABLE where plan_type='项目主项计划' and PLANYEAR= SUBSTR(rangeval, 0, 4)
		
		
UNION all 
select    
a2.ID,a2.PARENT_ID,a2.ORG_NAME,a1.PLAN_TYPE,a1.PROJECT_NAME ,a2.ORDER_CODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成
,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成
,三级节点已完成,里程碑绿灯,一级节点绿灯,二级节点绿灯
,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯
,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯
,三级节点红灯
, 'TYPE_ORG' as CTYPE

from  树 a1 INNER JOIN　SYS_BUSINESS_UNIT a2 on a1.parent_id=a2.id 

		where is_company=1 and (a2.PARENT_ID='003200000000000000000000000000' or a2.id='003200000000000000000000000000')
		
		
		)
    

		
		
		
,结果 as( 

select ORG_NAME  AS "company"

     ,  ID AS "orgId"
 		 , CASE  WHEN  ID='003200000000000000000000000000'  THEN NULL ELSE PARENT_ID END    AS "parentId"
    --,TO_CHAR(ROUND(CASE WHEN SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  应完成  ELSE 0 END )>0 THEN   SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  已完成  ELSE 0 END)/SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  应完成  ELSE 0 END )*100  ELSE 0 END,2) )   AS  "yearPercentageComplete"
    ,TO_CHAR(SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  应完成  ELSE 0 END)) AS "yearShouldComplete"--本年应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  已完成  ELSE 0 END) AS "yearDone"--本年已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  应完成  ELSE 0 END) - SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  已完成  ELSE 0 END) AS "yearUnfinished"--本年未完成数
    , CASE  WHEN SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  SUMNODESCORE  ELSE 0 END)  >0 THEN SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  动态得分  ELSE 0 END)
		--/SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  SUMNODESCORE  ELSE 0 END)*100,2) 
		ELSE 0 END  AS "dynamicScoring"--本月、季度动态得分
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  应完成  ELSE 0 END) AS "monthShouldComplete"--本月、季度应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  SUMNODESCORE  ELSE 0 END) AS "monthShouldCompleteScore"--本月应完成总分
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  已完成  ELSE 0 END)  AS "monthdDone"--本月、季度已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  已完成总分  ELSE 0 END)  AS "monthdDoneScore"--本月已完成总分
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  应完成  ELSE 0 END)  - SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  已完成  ELSE 0 END)  AS "monthUnfinished"--本月未完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  里程碑红灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  一级节点红灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN   二级节点红灯 + 三级节点红灯  ELSE 0 END)  AS "red"--红灯数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  里程碑黄灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  一级节点黄灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  二级节点黄灯+三级节点黄灯  ELSE 0 END)   AS "yellow"--黄灯数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  里程碑绿灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  一级节点绿灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  二级节点绿灯+三级节点绿灯  ELSE 0 END)  AS "green"--绿灯数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  里程碑应完成  ELSE 0 END)  AS "milestoneShouldComplete"--里程碑应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  里程碑已完成  ELSE 0 END) AS "milestoneDone"--里程碑已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  里程碑应完成  ELSE 0 END)-SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  里程碑已完成  ELSE 0 END) AS "milestoneUnfinished"--里程碑未完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  一级节点应完成  ELSE 0 END) AS "oneLevelNodeShouldComplete"--一级节点应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  一级节点已完成  ELSE 0 END)  AS "oneLevelNodeDone"--一级节点已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  一级节点应完成  ELSE 0 END) -SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  一级节点已完成  ELSE 0 END)   AS "oneLevelNodeUnfinished"--一级节点未完成数
 --
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  二级节点应完成  ELSE 0 END) AS "twoLevelNodeShouldComplete"--二级节点应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  二级节点已完成  ELSE 0 END)  AS "twoLevelNodeDone"--二级节点已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  二级节点应完成  ELSE 0 END) -SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  二级节点已完成  ELSE 0 END)   AS "twoLevelNodeUnfinished"--二级节点未完成数
      ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  三级节点应完成  ELSE 0 END) AS "threeLevelNodeShouldComplete"--三级节点应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  三级节点已完成  ELSE 0 END)  AS "threeLevelNodeDone"--三级节点已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  三级节点应完成  ELSE 0 END) -SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  三级节点已完成  ELSE 0 END)   AS "threeLevelNodeUnfinished"--三级节点未完成数
    ,    '' as  "openUrl"--打开地址
 --

 FROM 树 a where 1=1 
group by org_name,    id,    parent_id,ORGCODE
ORDER BY  ORGCODE desc
 

)
    
    select * from 结果  
    
;



 

ELSIF rangetype=20 then
   OPEN info FOR



with 树 ( 
   
ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH
,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯, CTYPE
)as( 



select   
ID,PARENT_ID,ORG_NAME,PLAN_TYPE,PROJECT_NAME ,ORGCODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分
	,里程碑应完成,里程碑已完成,一级节点应完成,一级节点已完成
	,二级节点应完成,二级节点已完成,三级节点应完成,三级节点已完成
,里程碑绿灯,一级节点绿灯,二级节点绿灯,三级节点绿灯
,里程碑黄灯,一级节点黄灯,二级节点黄灯,三级节点黄灯
,里程碑红灯,一级节点红灯,二级节点红灯,三级节点红灯
, CTYPE
from POM_PJPLAN_EXM_SOCRE_TABLE where plan_type='项目主项计划' and PLANYEAR= SUBSTR(rangeval, 0, 4)
		
		
UNION all 
select    
a2.ID,a2.PARENT_ID,a2.ORG_NAME,a1.PLAN_TYPE,a1.PROJECT_NAME ,a2.ORDER_CODE,PLANYEAR,PLANQUATOR,PLANMOTH		
	,应完成,已完成,SUMNODESCORE,已完成总分,动态得分,里程碑应完成,里程碑已完成,一级节点应完成
,一级节点已完成,二级节点应完成,二级节点已完成,三级节点应完成
,三级节点已完成,里程碑绿灯,一级节点绿灯,二级节点绿灯
,三级节点绿灯,里程碑黄灯,一级节点黄灯,二级节点黄灯
,三级节点黄灯,里程碑红灯,一级节点红灯,二级节点红灯
,三级节点红灯
, 'TYPE_ORG' as CTYPE

from  树 a1 INNER JOIN　SYS_BUSINESS_UNIT a2 on a1.parent_id=a2.id 

		where is_company=1 and (a2.PARENT_ID='003200000000000000000000000000' or a2.id='003200000000000000000000000000')
		
		
		)
    

		
		
		
,结果 as( 

select ORG_NAME  AS "company"

     ,  ID AS "orgId"
 		 , CASE  WHEN  ID='003200000000000000000000000000'  THEN NULL ELSE PARENT_ID END    AS "parentId"
    --,TO_CHAR(ROUND(CASE WHEN SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  应完成  ELSE 0 END )>0 THEN   SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  已完成  ELSE 0 END)/SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  应完成  ELSE 0 END )*100  ELSE 0 END,2) )   AS  "yearPercentageComplete"
    ,TO_CHAR(SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  应完成  ELSE 0 END)) AS "yearShouldComplete"--本年应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  已完成  ELSE 0 END) AS "yearDone"--本年已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  应完成  ELSE 0 END) - SUM(CASE WHEN SUBSTR(rangeval, 0, 4)=PLANYEAR  THEN  已完成  ELSE 0 END) AS "yearUnfinished"--本年未完成数
    , CASE  WHEN SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  SUMNODESCORE  ELSE 0 END)  >0 THEN SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  动态得分  ELSE 0 END)
		--/SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANMOTH  THEN  SUMNODESCORE  ELSE 0 END)*100,2) 
		ELSE 0 END  AS "dynamicScoring"--本月、季度动态得分
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  应完成  ELSE 0 END) AS "quarterShouldComplete"--本月、季度应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  SUMNODESCORE  ELSE 0 END) AS "quarterShouldCompleteScore"--本月应完成总分
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  已完成  ELSE 0 END)  AS "quarterDone"--本月、季度已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  已完成总分  ELSE 0 END)  AS "quarterDoneScore"--本月已完成总分
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  应完成  ELSE 0 END)  - SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  已完成  ELSE 0 END)  AS "quarterUnfinished"--本月未完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  里程碑红灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  一级节点红灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN   二级节点红灯 + 三级节点红灯  ELSE 0 END)  AS "red"--红灯数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  里程碑黄灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  一级节点黄灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  二级节点黄灯+三级节点黄灯  ELSE 0 END)   AS "yellow"--黄灯数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  里程碑绿灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  一级节点绿灯  ELSE 0 END) +SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  二级节点绿灯+三级节点绿灯  ELSE 0 END)  AS "green"--绿灯数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  里程碑应完成  ELSE 0 END)  AS "milestoneShouldComplete"--里程碑应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  里程碑已完成  ELSE 0 END) AS "milestoneDone"--里程碑已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  里程碑应完成  ELSE 0 END)-SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  里程碑已完成  ELSE 0 END) AS "milestoneUnfinished"--里程碑未完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  一级节点应完成  ELSE 0 END) AS "oneLevelNodeShouldComplete"--一级节点应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  一级节点已完成  ELSE 0 END)  AS "oneLevelNodeDone"--一级节点已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  一级节点应完成  ELSE 0 END) -SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  一级节点已完成  ELSE 0 END)   AS "oneLevelNodeUnfinished"--一级节点未完成数
 --
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  二级节点应完成  ELSE 0 END) AS "twoLevelNodeShouldComplete"--二级节点应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  二级节点已完成  ELSE 0 END)  AS "twoLevelNodeDone"--二级节点已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  二级节点应完成  ELSE 0 END) -SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  二级节点已完成  ELSE 0 END)   AS "twoLevelNodeUnfinished"--二级节点未完成数
      ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  三级节点应完成  ELSE 0 END) AS "threeLevelNodeShouldComplete"--三级节点应完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  三级节点已完成  ELSE 0 END)  AS "threeLevelNodeDone"--三级节点已完成数
    ,SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  三级节点应完成  ELSE 0 END) -SUM(CASE WHEN SUBSTR(rangeval, 6, 2)=PLANQUATOR  THEN  三级节点已完成  ELSE 0 END)   AS "threeLevelNodeUnfinished"--三级节点未完成数
    ,    '' as  "openUrl"--打开地址
 --

 FROM 树 a where 1=1 
group by org_name,    id,    parent_id,ORGCODE
ORDER BY  ORGCODE desc
 

)
    
    select * from 结果  
    
;




END  IF;
    title := '考核排行榜_主项目计划明细数据统计';
END p_pom_rank_proj_exam_dtl;
/

prompt
prompt Creating procedure P_POM_RANK_PROJ_EXAM_DTLTEST
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_rank_proj_exam_dtltest
(
orgid   IN  VARCHAR2,
info           OUT            SYS_REFCURSOR
)
AS
BEGIN

OPEN info FOR
SELECT
  row_number() over( PARTITION  BY A.PARENT_ID  order by ROUND( CASE WHEN NVL(B.应完成,0)>0 THEN nvl(已完成,0)/NVL(B.应完成,0) ELSE 0 END *100,2) desc) as rank ,
  '项目主项计划'AS  PLAN_TYPE,A.ID,A.PARENT_ID,A.ORG_NAME ,B.PLANYEAR  ,B.PLANQUATOR,B.PLANMOTH
--     ,NVL(B.本季度应完成,0) AS 本季度应完成
--     ,NVL(B.本季度已完成,0) AS 本季度已完成
    ,NVL(B.应完成,0) AS 应完成
    ,NVL(B.已完成,0) AS 已完成
    /*动态得分情况*/
    , NVL(B.动态得分,0) AS 动态得分
    ,NVL(B.SUMNODESCORE,0) AS SUMNODESCORE
--     ,NVL(B.本季度动态得分,0) AS 本季度动态得分
    /*里程碑、一级节点完成情况*/
    ,NVL(B.里程碑应完成,0) AS 里程碑应完成
    ,NVL(B.里程碑已完成,0) AS 里程碑已完成
    ,NVL(B.一级节点应完成,0) AS 一级节点应完成
    ,NVL(B.一级节点已完成,0) AS 一级节点已完成
    ,NVL(B.二级节点应完成,0) AS 二级节点应完成
    ,NVL(B.二级节点已完成,0) AS 二级节点已完成
    ,NVL(B.三级节点应完成,0) AS 三级节点应完成
    ,NVL(B.三级节点已完成,0) AS 三级节点已完成
--     ,NVL(B.本季度里程碑应完成,0) AS 本季度里程碑应完成
--     ,NVL(B.本季度里程碑已完成,0) AS 本季度里程碑已完成
--     ,NVL(B.本季度一级节点应完成,0) AS 本季度一级节点应完成
--     ,NVL(B.本季度一级节点已完成,0) AS 本季度一级节点已完成
    /*亮点情况*/
    ,NVL(B.里程碑绿灯,0) AS 里程碑绿灯
    ,NVL(B.里程碑黄灯,0) AS 里程碑黄灯
    ,NVL(B.里程碑红灯,0) AS 里程碑红灯
    ,NVL(B.一级节点绿灯,0) AS 一级节点绿灯
    ,NVL(B.一级节点黄灯,0) AS 一级节点黄灯
    ,NVL(B.一级节点红灯,0) AS 一级节点红灯
    ,NVL(B.二级节点绿灯,0) AS 二级节点绿灯
    ,NVL(B.二级节点黄灯,0) AS 二级节点黄灯
    ,NVL(B.二级节点红灯,0) AS 二级节点红灯
    ,NVL(B.三级节点绿灯,0) AS 三级节点绿灯
    ,NVL(B.三级节点黄灯,0) AS 三级节点黄灯
    ,NVL(B.三级节点红灯,0) AS 三级节点红灯

--     ,NVL(B.本季度里程碑绿灯,0) AS 本季度里程碑绿灯
--     ,NVL(B.本季度里程碑黄灯,0) AS 本季度里程碑黄灯
--     ,NVL(B.本季度里程碑红灯,0) AS 本季度里程碑红灯
--     ,NVL(B.本季度一级节点绿灯,0) AS 本季度一级节点绿灯
--     ,NVL(B.本季度一级节点黄灯,0) AS 本季度一级节点黄灯
--     ,NVL(B.本季度一级节点红灯,0) AS 本季度一级节点红灯
--     ,NVL(B.本季度二三级节点绿灯,0) AS 本季度二三级节点绿灯
--     ,NVL(B.本季度二三级节点黄灯,0) AS 本季度二三级节点黄灯
--     ,NVL(B.本季度二三级节点红灯,0) AS 本季度二三级节点红灯

  ,'TYPE_ORG' AS CTYPE
FROM SYS_BUSINESS_UNIT A LEFT JOIN  (
 SELECT AB.ID,AB.PARENT_ID
 ,AB.PLANYEAR  ,AB.PLANQUATOR,AB.PLANMOTH
--     ,SUM(AB.本季度应完成) AS 本季度应完成
--     ,SUM(AB.本季度已完成) AS 本季度已完成
    ,SUM(AB.应完成) AS 应完成
    ,SUM(AB.已完成) AS 已完成
    /*动态得分情况*/
    ,SUM(AB.动态得分) AS 动态得分
    ,SUM(AB.SUMNODESCORE) AS SUMNODESCORE
--     ,SUM(AB.本季度动态得分) AS 本季度动态得分
    /*里程碑、一级节点完成情况*/
    ,SUM(AB.里程碑应完成) AS 里程碑应完成
     ,SUM(AB.里程碑已完成) AS 里程碑已完成
     ,SUM(AB.一级节点应完成) AS 一级节点应完成
     ,SUM(AB.一级节点已完成) AS 一级节点已完成
     ,SUM(AB.二级节点应完成) AS 二级节点应完成
     ,SUM(AB.二级节点已完成) AS 二级节点已完成
     ,SUM(AB.三级节点应完成) AS 三级节点应完成
     ,SUM(AB.三级节点已完成) AS 三级节点已完成
  --                    ,NVL(B.本季度里程碑应完成,0) AS 本季度里程碑应完成
  --                    ,NVL(B.本季度里程碑已完成,0) AS 本季度里程碑已完成
  --                    ,NVL(B.本季度一级节点应完成,0) AS 本季度一级节点应完成
  --                    ,NVL(B.本季度一级节点已完成,0) AS 本季度一级节点已完成
     /*亮点情况*/
     ,SUM(AB.里程碑绿灯) AS 里程碑绿灯
     ,SUM(AB.里程碑黄灯) AS 里程碑黄灯
     ,SUM(AB.里程碑红灯) AS 里程碑红灯
     ,SUM(AB.一级节点绿灯) AS 一级节点绿灯
     ,SUM(AB.一级节点黄灯) AS 一级节点黄灯
     ,SUM(AB.一级节点红灯) AS 一级节点红灯
     ,SUM(AB.二级节点绿灯) AS 二级节点绿灯
     ,SUM(AB.二级节点黄灯) AS 二级节点黄灯
     ,SUM(AB.二级节点红灯) AS 二级节点红灯
     ,SUM(AB.三级节点绿灯) AS 三级节点绿灯
     ,SUM(AB.三级节点黄灯) AS 三级节点黄灯
     ,SUM(AB.三级节点红灯) AS 三级节点红灯

--     ,SUM(AB.本季度里程碑绿灯) AS 本季度里程碑绿灯
--     ,SUM(AB.本季度里程碑黄灯) AS 本季度里程碑黄灯
--     ,SUM(AB.本季度里程碑红灯) AS 本季度里程碑红灯
--     ,SUM(AB.本季度一级节点绿灯) AS 本季度一级节点绿灯
--     ,SUM(AB.本季度一级节点黄灯) AS 本季度一级节点黄灯
--     ,SUM(AB.本季度一级节点红灯) AS 本季度一级节点红灯
--     ,SUM(AB.本季度二三级节点绿灯) AS 本季度二三级节点绿灯
--     ,SUM(AB.本季度二三级节点黄灯) AS 本季度二三级节点黄灯
--     ,SUM(AB.本季度二三级节点红灯) AS 本季度二三级节点红灯
     FROM  (
--  11

                   SELECT
                  /*完成情况*/
--                    ,NVL(B.本季度应完成,0) AS 本季度应完成
--                    ,NVL(B.本季度已完成,0) AS 本季度已完成
                    B.PLANYEAR
                    ,B.PLANQUATOR
                    ,B.PLANMOTH
                   ,NVL(B.应完成,0) AS 应完成
                   ,NVL(B.已完成,0) AS 已完成
                   /*动态得分情况*/
                   ,NVL(B.SUMNODESCORE,0)  AS "SUMNODESCORE"
                   ,NVL(B.动态得分,0) AS 动态得分
--                    ,NVL(B.本季度动态得分,0) AS 本季度动态得分
                   /*里程碑、一级节点完成情况*/
                   ,NVL(B.里程碑应完成,0) AS 里程碑应完成
                   ,NVL(B.里程碑已完成,0) AS 里程碑已完成
                   ,NVL(B.一级节点应完成,0) AS 一级节点应完成
                   ,NVL(B.一级节点已完成,0) AS 一级节点已完成
                   ,NVL(B.二级节点应完成,0) AS 二级节点应完成
                   ,NVL(B.二级节点已完成,0) AS 二级节点已完成
                   ,NVL(B.三级节点应完成,0) AS 三级节点应完成
                   ,NVL(B.三级节点已完成,0) AS 三级节点已完成
--                    ,NVL(B.本季度里程碑应完成,0) AS 本季度里程碑应完成
--                    ,NVL(B.本季度里程碑已完成,0) AS 本季度里程碑已完成
--                    ,NVL(B.本季度一级节点应完成,0) AS 本季度一级节点应完成
--                    ,NVL(B.本季度一级节点已完成,0) AS 本季度一级节点已完成
                   /*亮点情况*/
                   ,NVL(B.里程碑绿灯,0) AS 里程碑绿灯
                   ,NVL(B.里程碑黄灯,0) AS 里程碑黄灯
                   ,NVL(B.里程碑红灯,0) AS 里程碑红灯
                   ,NVL(B.一级节点绿灯,0) AS 一级节点绿灯
                   ,NVL(B.一级节点黄灯,0) AS 一级节点黄灯
                   ,NVL(B.一级节点红灯,0) AS 一级节点红灯
                   ,NVL(B.二级节点绿灯,0) AS 二级节点绿灯
                   ,NVL(B.二级节点黄灯,0) AS 二级节点黄灯
                   ,NVL(B.二级节点红灯,0) AS 二级节点红灯
                   ,NVL(B.三级节点绿灯,0) AS 三级节点绿灯
                   ,NVL(B.三级节点黄灯,0) AS 三级节点黄灯
                   ,NVL(B.三级节点红灯,0) AS 三级节点红灯

--                    ,NVL(B.本季度里程碑绿灯,0) AS 本季度里程碑绿灯
--                    ,NVL(B.本季度里程碑黄灯,0) AS 本季度里程碑黄灯
--                    ,NVL(B.本季度里程碑红灯,0) AS 本季度里程碑红灯
--                    ,NVL(B.本季度一级节点绿灯,0) AS 本季度一级节点绿灯
--                    ,NVL(B.本季度一级节点黄灯,0) AS 本季度一级节点黄灯
--                    ,NVL(B.本季度一级节点红灯,0) AS 本季度一级节点红灯
--                    ,NVL(B.本季度二三级节点绿灯,0) AS 本季度二三级节点绿灯
--                    ,NVL(B.本季度二三级节点黄灯,0) AS 本季度二三级节点黄灯
--                    ,NVL(B.本季度二三级节点红灯,0) AS 本季度二三级节点红灯
                   ,CONNECT_BY_ROOT ID AS  ID ,CONNECT_BY_ROOT PARENT_ID  AS  PARENT_ID
                   from   SYS_BUSINESS_UNIT A  LEFT JOIN
                   (


                   SELECT  B1.UNIT_ID ,COUNT(A1.ID) AS "NODESUM"

                , TO_CHAR(A1.PLAN_END_DATE,'YYYY')   AS  "PLANYEAR"
                , CASE WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '12-26'  AND '03-25'  THEN 1
                       WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '03-26'  AND '06-25'  THEN 2
                       WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '06-26'  AND '09-25'  THEN 3
                       WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '09-26'  AND '12-25'  THEN 4  END
                      AS "PLANQUATOR"
                ,CASE
                        WHEN
                        CASE
                            WHEN TO_CHAR( PLAN_END_DATE, 'DD' ) > 25 THEN
                            TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) )
                          END > 12 THEN
                    1 ELSE
                  CASE
                      WHEN TO_CHAR( PLAN_END_DATE, 'DD' ) > 25 THEN
                      TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) )
                    END
                    END AS "PLANMOTH"
                  ,SUM(STANDARD_SCORE)   AS "SUMNODESCORE"
                   --完成规则




                   ------------------
                   /*任务*/
                   ------------------
                   ------
                  , SUM(
                    (CASE
                      WHEN
                        TO_CHAR( A1.PLAN_END_DATE, 'YYYY-MM-DD' ) IS NOT NULL

                      THEN    1
                      ELSE 0
                      END
                      )
                    ) AS "应完成"
                  ,SUM( (CASE      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                   --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                     THEN     1  ELSE    0 END))   AS "已完成"

                  ,SUM(
                  (CASE
                  --按时完成
                      WHEN
                          TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                         --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                        AND  (TRUNC( A1.PLAN_END_DATE, 'DD' ) -TRUNC( D.APPROVAL_TIME, 'DD' ) )BETWEEN 0 AND 29
                      THEN   A1.STANDARD_SCORE*1
                      --提前一个月完成
                      WHEN
                          TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
                          --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( A1.PLAN_END_DATE, 'DD' ) -TRUNC( D.APPROVAL_TIME, 'DD' ) )>= 30   AND  A1.NODE_LEVEL='里程碑'
                      THEN   A1.STANDARD_SCORE*1.2
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                         --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                        AND  (TRUNC( A1.PLAN_END_DATE, 'DD' ) -TRUNC( D.APPROVAL_TIME, 'DD' ) )>= 30   AND  A1.NODE_LEVEL='一级节点'
                      THEN   A1.STANDARD_SCORE*1.1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                         --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'

                          AND  (TRUNC( A1.PLAN_END_DATE, 'DD' ) - TRUNC( D.APPROVAL_TIME, 'DD' ) )>= 30   AND  A1.NODE_LEVEL IN ('二级节点' ,'三级节点')
                      THEN   A1.STANDARD_SCORE*1.0
                  --延时完成
                  --里程碑、一级节点3天
                  --二三级节点5天
                  --延时完成
                    WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                         --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'

                        AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC(A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 1 AND 4 AND   A1.NODE_LEVEL IN ('里程碑' ,'一级节点')
                    THEN   A1.STANDARD_SCORE*0.6
                    WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                         --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'

                        AND  ( TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC(A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 1 AND 3 AND A1.NODE_LEVEL IN ('二级节点' ,'三级节点')
                    THEN   A1.STANDARD_SCORE*1.0
                    WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                       --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                        AND  ( TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC(A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 4 AND 7 AND A1.NODE_LEVEL IN ('二级节点' ,'三级节点')
                    THEN   A1.STANDARD_SCORE*0.6
                  --红灯
                    WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                       --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'

                      AND  ( TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC(A1.PLAN_END_DATE, 'DD' )  )  >=5 AND    A1.NODE_LEVEL IN ('里程碑' ,'一级节点')
                    THEN   A1.STANDARD_SCORE*0
                    WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                       --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'

                      AND  ( TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC(A1.PLAN_END_DATE, 'DD' )  )>=8  AND  A1.NODE_LEVEL IN ('二级节点' ,'三级节点')
                    THEN   A1.STANDARD_SCORE*0
                  ELSE  0 END
                  )
                  )   AS "动态得分"

                   ------------------
                   /*-里程碑完成情况*/
                   ------------------
                  ,SUM((CASE  WHEN      A1. NODE_LEVEL='里程碑'

                              THEN   1  ELSE    0 END))   AS "里程碑应完成"
                  ,SUM((CASE  WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
                              AND A1. NODE_LEVEL='里程碑'
                              THEN   1  ELSE    0 END))   AS "里程碑已完成"
                   ------------------
                   /*-一级节点完成情况*/
                   ------------------
                  ,SUM((CASE   WHEN     A1. NODE_LEVEL='一级节点'
                                THEN   1  ELSE    0 END))   AS "一级节点应完成"
                  ,SUM((CASE   WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
                              AND A1. NODE_LEVEL='一级节点'
                                   THEN   1  ELSE    0 END))   AS "一级节点已完成"
                   ------------------
                   /*-二级节点完成情况*/
                   ------------------
                  ,SUM((CASE   WHEN     A1. NODE_LEVEL='二级节点'
                                THEN   1  ELSE    0 END))   AS "二级节点应完成"
                  ,SUM((CASE   WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
                              AND A1. NODE_LEVEL='二级节点'
                                   THEN   1  ELSE    0 END))   AS "二级节点已完成"
                     ------------------
                   /*-三级节点完成情况*/
                   ------------------
                  ,SUM((CASE   WHEN     A1. NODE_LEVEL='三级节点'
                                THEN   1  ELSE    0 END))   AS "三级节点应完成"
                  ,SUM((CASE   WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL
                              AND A1. NODE_LEVEL='三年级节点'
                                   THEN   1  ELSE    0 END))   AS "三级节点已完成"

                    ------------------
                   /*-里程碑亮灯情况*/
                   ------------------
                   ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  <= 0 AND    A1.NODE_LEVEL IN ('里程碑')
                        THEN 1

                       ELSE  0  END ) AS  "里程碑绿灯"

                   ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 1 AND 4 AND    A1.NODE_LEVEL IN ('里程碑')
                        THEN 1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 1 AND 4  AND    A1.NODE_LEVEL IN ('里程碑')
                        THEN 1


                       ELSE  0  END ) AS  "里程碑黄灯"


                  ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=5 AND    A1.NODE_LEVEL IN ('里程碑')
                        THEN 1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=5 AND    A1.NODE_LEVEL IN ('里程碑')
                        THEN 1


                       ELSE  0  END ) AS  "里程碑红灯"



                    ------------------
                   /*一级节点亮灯情况*/
                   ------------------
                   ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  <= 0  AND    A1.NODE_LEVEL IN ('一级节点')
                        THEN 1

                       ELSE  0  END ) AS  "一级节点绿灯"

                   ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 1 AND 4 AND    A1.NODE_LEVEL IN ('一级节点')
                        THEN 1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 1 AND 4  AND    A1.NODE_LEVEL IN ('一级节点')
                        THEN 1


                       ELSE  0  END ) AS  "一级节点黄灯"


                  ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=5 AND    A1.NODE_LEVEL IN ('一级节点')
                        THEN 1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=5 AND    A1.NODE_LEVEL IN ('一级节点')
                        THEN 1


                       ELSE  0  END ) AS  "一级节点红灯"




                    ------------------
                   /*二级节点亮灯情况*/
                   ------------------
                   ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  <= 2 AND     A1.NODE_LEVEL IN ('二级节点')
                        THEN 1

                       ELSE  0  END ) AS  "二级节点绿灯"

                   ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 3 AND 7 AND    A1.NODE_LEVEL IN ('二级节点')
                        THEN 1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 3 AND 7  AND    A1.NODE_LEVEL IN  ('二级节点')
                        THEN 1


                       ELSE  0  END ) AS  "二级节点黄灯"


                  ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=8 AND    A1.NODE_LEVEL IN  ('二级节点')
                        THEN 1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=8 AND    A1.NODE_LEVEL IN  ('二级节点')
                        THEN 1


                    ELSE  0  END ) AS  "二级节点红灯"

                    ------------------
                   /*三级节点亮灯情况*/
                   ------------------
                   ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  <= 2 AND     A1.NODE_LEVEL IN ('三级节点')
                        THEN 1

                       ELSE  0  END ) AS  "三级节点绿灯"

                   ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 3 AND 7 AND    A1.NODE_LEVEL IN ('三级节点')
                        THEN 1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  BETWEEN 3 AND 7  AND    A1.NODE_LEVEL IN  ('三级节点')
                        THEN 1


                       ELSE  0  END ) AS  "三级节点黄灯"


                  ,SUM(CASE
                        WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS NOT NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( D.APPROVAL_TIME, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=8 AND    A1.NODE_LEVEL IN  ('三级节点')
                        THEN 1
                      WHEN TO_CHAR( A1.ACTUAL_END_DATE,'YYYY-MM-DD') IS  NULL

                            --WHERE  B1.UNIT_ID='1b922b32-928c-44a7-85d7-ee12b74f97e0'
                          AND  (TRUNC( SYSDATE, 'DD' )-TRUNC( A1.PLAN_END_DATE, 'DD' )  )  >=8 AND    A1.NODE_LEVEL IN  ('三级节点')
                        THEN 1


                    ELSE  0  END ) AS  "三级节点红灯"

                  FROM
                  POM_PROJ_PLAN A
                  INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID=A1.PROJ_PLAN_ID
                  INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID=C1.ID
                  INNER  JOIN    SYS_PROJECT B1  ON  C1.PROJECT_ID=B1.ID
                  LEFT JOIN POM_NODE_FEEDBACK D ON D.FEEDBACK_NODE_ID=A1.ID AND  FEEDBACK_TYPE='1' AND  D.APPROVAL_STATUS='已审核'
                  WHERE  A.PLAN_TYPE='项目主项计划' AND  A.APPROVAL_STATUS='已审核'
                  GROUP BY B1.UNIT_ID  , TO_CHAR(A1.PLAN_END_DATE,'YYYY')
                  , CASE WHEN CASE   WHEN TO_CHAR( PLAN_END_DATE, 'DD' ) > 25 THEN  TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) )
                        END > 12 THEN  1 ELSE  CASE    WHEN TO_CHAR( PLAN_END_DATE, 'DD' ) > 25 THEN    TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) ) + 1 ELSE TO_NUMBER( TO_CHAR( PLAN_END_DATE, 'MM' ) )
                  END   END
                  , CASE WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '12-26'  AND '03-25'  THEN 1    WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '03-26'  AND '06-25'  THEN 2
                   WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '06-26'  AND '09-25'  THEN 3      WHEN    TO_CHAR( PLAN_END_DATE ,'MM-DD') BETWEEN '09-26'  AND '12-25'  THEN 4  END

                    )  B ON  A.ID=B.UNIT_ID
                    WHERE NVL(B.NODESUM,0)>0
										start with  a.id='45e9c408-dd59-4a41-8c50-7b4eaf6c1e46'
                  CONNECT  by PRIOR   A.ID= A.PARENT_ID
									
) AB
GROUP BY AB.ID,AB.PARENT_ID  ,AB.PLANYEAR  ,AB.PLANQUATOR,AB.PLANMOTH
)B  ON  A.ID=B.ID
WHERE  A.ORG_TYPE=0  ;--  AND  A.COMPANY_TYPE='5' AND  A.PARENT_ID='003200000000000000000000000000'
--

 

END p_pom_rank_proj_exam_dtltest;
/

prompt
prompt Creating procedure P_POM_REPAIR_GET_BUILDING
prompt ============================================
prompt
create or replace procedure pom0813.P_POM_REPAIR_GET_BUILDING(
    info out sys_refcursor,
    projectStageId in varchar2
) AS
begin
    open info for with t1 as (
        select ID, ORDER_HIERARCHY_CODE, BUILD_NAME, PERIOD_ID, PROJ_ID
        from MDM_BUILD mb1
        where IS_GET_COMPLETED_PERMIT = 1
          and (projectStageId is null or mb1.PERIOD_ID = projectStageId)
    ), t2 as (
        select
            mbp.BUILD_ID,
            WM_CONCAT(moppi.PRODUCT_TYPE_ID) productTypeIds,
            WM_CONCAT(moppi.PRODUCT_TYPE_NAME) productTypeNames
        from t1 inner join MDM_BUILD_PHASE mbp on t1.ID = mbp.BUILD_ID
             inner join MDM_OBJ_PHASE_PT_INDEX moppi on moppi.OBJ_PHASE_ID = mbp.ID
        group by mbp.BUILD_ID
    )
                  select
                      mb1.ID "id",
                      mb1.ORDER_HIERARCHY_CODE "buildingCode",
                      mb1.BUILD_NAME "buildingName",
                          mp2.PROJECT_NAME || '_' || mp1.PERIOD_NAME || '_' || mb1.BUILD_NAME "buildingFullName",
                      mp1.ID "projectStageId",
                      mp1.PERIOD_NAME "projectStageName",
                      '' "buildingDeliveryDate",
                      mp2.ID "projectId",
                      mp2.PROJECT_NAME "projectName",
                      productTypeIds "productTypeIds",
                      productTypeNames "productTypeNames"
                  from t1 mb1
                       inner join MDM_PERIOD mp1 on mb1.PERIOD_ID = mp1.ID
                       inner join MDM_PROJECT mp2 on mp2.ID = mb1.PROJ_ID
                       inner join t2 on t2.BUILD_ID = mb1.ID;
end;
/

prompt
prompt Creating procedure P_POM_REPAIR_PRODUCT_TYPE
prompt ============================================
prompt
create or replace procedure pom0813.P_POM_REPAIR_PRODUCT_TYPE(
    info out sys_refcursor
) as
begin
    open info for
        select
            mbpt.ID "id",
            mbpt.PRODUCT_TYPE_SHORT_CODE "productTypeShortCode",
            mbpt.PRODUCT_TYPE_SHORT_NAME "productTypeShortName",
            mbpt.PRODUCT_TYPE_CODE "productTypeCode",
            mbpt.PRODUCT_TYPE_NAME "productTypeName",
            mbpt.PARENT_CODE "parentCode",
            mbpt.PRODUCT_TYPE_LEVEL "level",
            mbpt.IS_END "isEnd"
        from MDM_BUILD_PRODUCT_TYPE mbpt
        order by mbpt.PRODUCT_TYPE_SHORT_CODE;
end;
/

prompt
prompt Creating procedure P_POM_RULE_MSG_PRE_GENERATED
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_RULE_MSG_PRE_GENERATED"
(
    RULEID        IN VARCHAR --规则ID
   ,MSGGROUPID    OUT VARCHAR --本次插入至POM_PRE_GENERATED_MESSAGE表中，唯一标识
   ,TOTAL         OUT NUMBER --本次更新的数据总数
   ,EXECUTIONTIME OUT VARCHAR --存储过程执行的时间
) AS
    --预警与提醒，消息预生成。
    --作者：陈丽
    --日期：2019/11/15

    VS_WHERE     CLOB; --SQL后面where过滤条件动态SQL
    VS_KEY_PLAN  CLOB; --关键节点计划动态SQL
    VS_PROJ_PLAN CLOB; --项目主项计划动态SQL
    VS_DEPT_PLAN CLOB; --部门月度计划动态SQL
    VS_SPEC_PLAN CLOB; --专项计划动态SQL
    VS_QUERY     CLOB; --拼接所有SQL

    V_FLAG            NUMBER(2, 0); --判断当前规则是否可执行，若判断规则设置有问题，直接RETURN
    V_RULE_TYPE       VARCHAR2(100); --记录当前规则类型
    V_PLAN_TYPE       VARCHAR(200); --存储规则类型
    V_SYSTEM_ID       VARCHAR(100); --系统ID，固定值，插入POM_PRE_GENERATED_MESSAGE表中时使用，勿改
    V_RULE_NODE_LEVEL VARCHAR(100); --存储规则的任务级别，用于拼接VS_WHERE字符串
    V_RULE_MSG        VARCHAR(200); --存储规则中定义的消息格式
    V_RULE_FERQ_TYPE  VARCHAR(200); --执行频率类别
    V_RULE_FERQ_DATE  VARCHAR(200); --哪一天执行，需根据执行类别进行判断

    V_MONTH_DAY VARCHAR(20); -- 取日期中的号
    V_WEEK_DAY  VARCHAR(20); -- 取星期几
    --定义RC_NODE_INFO类型，存储节点信息
    TYPE RC_NODE_INFO IS RECORD(
         PLAN_NAME        POM_PROJ_PLAN.PLAN_NAME%TYPE
        ,COMPANY_NAME     POM_PROJ_PLAN.COMPANY_NAME%TYPE
        ,DEPT_ID          POM_NODE_CHARGE_PERSON.CHARGE_PERSON_DEPT_ID%TYPE
        ,COMPANY_ID       POM_NODE_CHARGE_PERSON.CHARGE_PERSON_COMPANY_ID%TYPE
        ,NODE_NAME        POM_PROJ_PLAN_NODE.NODE_NAME%TYPE
        ,NODE_LEVEL       POM_PROJ_PLAN_NODE.NODE_LEVEL%TYPE
        ,PLAN_ID          POM_PROJ_PLAN_NODE.PROJ_PLAN_ID%TYPE
        ,NODE_ID          POM_PROJ_PLAN_NODE.ID%TYPE
        ,PLAN_START_DATE  VARCHAR(50)
        ,PLAN_END_DATE    VARCHAR(50)
        ,CHARGE_PERSON_ID POM_NODE_CHARGE_PERSON.ID%TYPE
        ,CHARGE_PERSON    POM_NODE_CHARGE_PERSON.CHARGE_PERSON%TYPE
        ,CURRENT_DATE     VARCHAR(50)
        ,NODE_MSG         VARCHAR(100)
        ,PROJ_ID          VARCHAR(100));
    --声明V_NODE_INFO变量

    V_NODE_INFO RC_NODE_INFO;
    --定义ref_type类型
    TYPE REF_TYPE IS REF CURSOR;
    VC_REF REF_TYPE;

    V_BUFFER VARCHAR(200); --用来存储过程中临时使用的值

BEGIN
    EXECUTIONTIME := TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MM:SS');
    MSGGROUPID    := GET_UUID();
    V_SYSTEM_ID   := '71313f018a35f3a558166cba7599b5d6';

    V_MONTH_DAY := TO_CHAR(SYSDATE, 'dd');
    V_WEEK_DAY := CASE
                      WHEN TO_CHAR(SYSDATE, 'day') = '星期一' THEN
                       1
                      WHEN TO_CHAR(SYSDATE, 'day') = '星期二' THEN
                       2
                      WHEN TO_CHAR(SYSDATE, 'day') = '星期三' THEN
                       3
                      WHEN TO_CHAR(SYSDATE, 'day') = '星期四' THEN
                       4
                      WHEN TO_CHAR(SYSDATE, 'day') = '星期五' THEN
                       5
                      WHEN TO_CHAR(SYSDATE, 'day') = '星期六' THEN
                       6
                      WHEN TO_CHAR(SYSDATE, 'day') = '星期日' THEN
                       7
                  END;

    DBMS_OUTPUT.PUT_LINE(V_WEEK_DAY || ' ,' || V_MONTH_DAY);

    BEGIN
        SELECT NVL(A.IS_DISABLE, 0)
        INTO   V_FLAG
        FROM   POM_RULE_SET A
        WHERE  A.ID = RULEID;

        SELECT COUNT(1)
        INTO   V_FLAG
        FROM   POM_RULE_SET_PLAN_TYPE A
        WHERE  A.RULE_ID = RULEID;

        IF V_FLAG = 0 THEN
            DBMS_OUTPUT.PUT_LINE('检测到【POM_RULE_SET_PLAN_TYPE】表中无数据，请检查配置信息');
            RETURN;
        END IF;

    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            V_FLAG := 0;
            DBMS_OUTPUT.PUT_LINE('该规则初始化信息有误，请检查规则配置');
    END;

    SELECT A.EXPRESSION, A.RULE_TYPE, A.NODE_LEVEL, A.MESSAGE_TEMPLATE,
           A.TIME_FREQUENCY, A.MSG_FREQUENCY_TYPE, A.DATE_FREQUENCY
    INTO   VS_WHERE, V_RULE_TYPE, V_RULE_NODE_LEVEL, V_RULE_MSG,
           EXECUTIONTIME, V_RULE_FERQ_TYPE, V_RULE_FERQ_DATE
    FROM   POM_RULE_SET A
    WHERE  A.ID = RULEID AND
           IS_DISABLE <> 1;
    /*
    WHERE条件拼接
    */
    V_RULE_NODE_LEVEL := ' AND NODE_LEVEL = ''' || V_RULE_NODE_LEVEL || '''';
    VS_WHERE          := 'WHERE 1=1 ' || ' AND ' || VS_WHERE; --1=1勿删，确保无论where后是否有条件，SQL都能执行
    VS_WHERE          := VS_WHERE || V_RULE_NODE_LEVEL;

    SELECT TO_CHAR(WM_CONCAT(A.PLAN_TYPE))
    INTO   V_PLAN_TYPE
    FROM   POM_RULE_SET_PLAN_TYPE A
    WHERE  A.RULE_ID = RULEID;

    --执行频率判断
    IF V_RULE_FERQ_TYPE = '每周' THEN
        IF V_WEEK_DAY <> V_RULE_FERQ_DATE THEN
            TOTAL := 0;
            RETURN;
        END IF;
    ELSIF V_RULE_FERQ_TYPE = '每月' THEN
        IF V_MONTH_DAY <> V_RULE_FERQ_DATE THEN
            TOTAL := 0;
            RETURN;
        END IF;
    ELSIF V_RULE_FERQ_TYPE = '提醒一次' THEN
        VS_WHERE := VS_WHERE ||
                    ' AND NOT EXISTS (SELECT 1 FROM POM_PRE_GENERATED_MESSAGE WHERE POM_PRE_GENERATED_MESSAGE.BIZ_KEY = NODE_ID) ';
    END IF;

    IF INSTR(V_PLAN_TYPE, '项目主项计划', 1, 1) <> 0 THEN
        /*
            SQL拼接，where条件中的1=1勿删，防止RTRIM时，将NULL字符删除
        */
        VS_PROJ_PLAN := ' SELECT A.PLAN_NAME, A.COMPANY_NAME,C.CHARGE_PERSON_DEPT_ID AS DEPT_ID,C.CHARGE_PERSON_COMPANY_ID AS COMPANY_ID, B.NODE_NAME,B.NODE_LEVEL AS NODE_LEVEL, A.ID AS PLAN_ID, B.ID AS NODE_ID,TO_CHAR(B.PLAN_START_DATE, ''YYYY-MM-DD'') AS PLAN_START_DATE,TO_CHAR(B.PLAN_END_DATE, ''YYYY-MM-DD'') AS PLAN_END_DATE,C.CHARGE_PERSON_ID, C.CHARGE_PERSON,TO_CHAR(SYSDATE, ''YYYY-MM-DD'') AS CURRENT_DATE,a.PROJ_ID FROM   POM_PROJ_PLAN A INNER  JOIN POM_PROJ_PLAN_NODE B ON     A.ID = B.PROJ_PLAN_ID INNER  JOIN POM_NODE_CHARGE_PERSON C ON     B.ID = C.NODE_ID WHERE  A.PLAN_TYPE = ''项目主项计划'' AND B.ACTUAL_END_DATE IS NULL AND 1=1   UNION ALL';
    ELSE
        VS_PROJ_PLAN := '';
    END IF;

    IF INSTR(V_PLAN_TYPE, '关键节点计划', 1, 1) <> 0 THEN
        VS_KEY_PLAN := ' SELECT A.PLAN_NAME, A.COMPANY_NAME, C.CHARGE_PERSON_DEPT_ID AS DEPT_ID,C.CHARGE_PERSON_COMPANY_ID AS COMPANY_ID, B.NODE_NAME,B.NODE_LEVEL AS NODE_LEVEL, A.ID AS PLAN_ID, B.ID AS NODE_ID,TO_CHAR(B.PLAN_START_DATE, ''YYYY-MM-DD'') AS PLAN_START_DATE,TO_CHAR(B.PLAN_END_DATE, ''YYYY-MM-DD'') AS PLAN_END_DATE,C.CHARGE_PERSON_ID, C.CHARGE_PERSON,TO_CHAR(SYSDATE, ''YYYY-MM-DD'') AS CURRENT_DATE,a.PROJ_ID  FROM   POM_PROJ_PLAN A INNER  JOIN POM_PROJ_PLAN_NODE B ON     A.ID = B.PROJ_PLAN_ID INNER  JOIN POM_NODE_CHARGE_PERSON C ON     B.ID = C.NODE_ID WHERE  A.PLAN_TYPE = ''关键节点计划'' AND B.ACTUAL_END_DATE IS NULL AND 1=1 UNION ALL';
    ELSE
        VS_KEY_PLAN := '';
    END IF;

    IF INSTR(V_PLAN_TYPE, '专项计划', 1, 1) <> 0 THEN
        VS_SPEC_PLAN := ' SELECT A.PLAN_NAME, A.COMPANY_NAME, C.CHARGE_PERSON_DEPT_ID AS DEPT_ID,C.CHARGE_PERSON_COMPANY_ID AS COMPANY_ID, B.NODE_NAME,NULL AS NODE_LEVEL, A.ID AS PLAN_ID, B.ID AS NODE_ID,TO_CHAR(B.PLAN_START_DATE, ''YYYY-MM-DD'') AS PLAN_START_DATE,TO_CHAR(B.PLAN_END_DATE, ''YYYY-MM-DD'') AS PLAN_END_DATE,C.CHARGE_PERSON_ID, C.CHARGE_PERSON,TO_CHAR(SYSDATE, ''YYYY-MM-DD'') AS CURRENT_DATE,null FROM   POM_SPECIAL_PLAN A INNER  JOIN POM_SPECIAL_PLAN_NODE B ON     A.ID = B.PLAN_ID INNER  JOIN POM_NODE_CHARGE_PERSON C ON     B.ID = C.NODE_ID WHERE  B.ACTUAL_END_DATE IS NULL AND 1=1 UNION ALL';
    ELSE
        VS_SPEC_PLAN := '';
    END IF;

    IF INSTR(V_PLAN_TYPE, '部门月度计划', 1, 1) <> 0 THEN
        VS_DEPT_PLAN := ' SELECT A.PLAN_NAME, A.COMPANY_NAME, C.CHARGE_PERSON_DEPT_ID AS DEPT_ID,C.CHARGE_PERSON_COMPANY_ID AS COMPANY_ID, B.NODE_NAME,B.NODE_TYPE AS NODE_LEVEL, A.ID AS PLAN_ID, B.ID AS NODE_ID,TO_CHAR(B.PLAN_START_DATE, ''YYYY-MM-DD'') AS PLAN_START_DATE,TO_CHAR(B.PLAN_END_DATE, ''YYYY-MM-DD'') AS PLAN_END_DATE,C.CHARGE_PERSON_ID, C.CHARGE_PERSON,TO_CHAR(SYSDATE, ''YYYY-MM-DD'') AS CURRENT_DATE FROM   POM_DEPT_MONTHLY_PLAN A INNER  JOIN POM_DEPT_MONTHLY_PLAN_NODE B ON     A.ID = B.DEPT_MONTHLY_PLAN_ID INNER  JOIN POM_NODE_CHARGE_PERSON C ON     B.ID = C.NODE_ID WHERE  B.ACTUAL_END_DATE IS NULL AND 1=1 UNION ALL';
    ELSE
        VS_DEPT_PLAN := '';
    END IF;

    /*    IF V_RULE_TYPE = '提醒规则' THEN
        --下方需补充提醒规则的条件

        VS_WHERE = VS_WHERE || '';

    ELSIF V_RULE_TYPE = '预警规则' THEN
        --下方补充预警规则的条件
        VS_WHERE = VS_WHERE || '';

    END IF;*/

    VS_QUERY := 'SELECT PLAN_NAME,COMPANY_NAME,DEPT_ID,COMPANY_ID,NODE_NAME,NODE_LEVEL,PLAN_ID,NODE_ID,PLAN_START_DATE,PLAN_END_DATE,CHARGE_PERSON_ID,CHARGE_PERSON, CURRENT_DATE, ' ||
                V_RULE_MSG || ' AS NODE_MSG FROM (' ||
                RTRIM(VS_PROJ_PLAN || ' ' || VS_KEY_PLAN || ' ' ||
                      VS_SPEC_PLAN || ' ' || VS_DEPT_PLAN, 'UNION ALL') || ')' || ' ' ||
                VS_WHERE;

    DBMS_OUTPUT.PUT_LINE(VS_QUERY);
    /*
        更新值至POM_PRE_GENERATED_MESSAGE表中
    */

    OPEN VC_REF FOR VS_QUERY;
    LOOP
        FETCH VC_REF
            INTO V_NODE_INFO;
        EXIT WHEN VC_REF%NOTFOUND;
        INSERT INTO POM_PRE_GENERATED_MESSAGE
        VALUES
            (GET_UUID(),MSGGROUPID, V_NODE_INFO.NODE_MSG, V_NODE_INFO.CHARGE_PERSON_ID,
             V_NODE_INFO.NODE_ID, 'wangck', '计划管理',
             CASE WHEN V_RULE_TYPE = '提醒规则' THEN '提醒消息' WHEN
              V_RULE_TYPE = '预警规则' THEN '预警消息' ELSE NULL END, V_SYSTEM_ID,
             'wechat_jumpLink_Url',V_NODE_INFO.COMPANY_ID,V_NODE_INFO.DEPT_ID,V_NODE_INFO.PROJ_ID);
    END LOOP;
    
    VS_QUERY:=' insert into POM_PRE_GENERATED_MESSAGE  '||VS_QUERY; 
    execute immediate VS_QUERY;
    TOTAL := VC_REF%ROWCOUNT;
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('更新成功，已更新数据' || TOTAL || '条');
    CLOSE VC_REF;

END P_POM_RULE_MSG_PRE_GENERATED;
/

prompt
prompt Creating procedure P_POM_RULE_MSG_PUSH
prompt ======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_RULE_MSG_PUSH"
(
    RULEID     IN VARCHAR
   ,MSGGROUPID IN VARCHAR
   ,MESSAGE    OUT SYS_REFCURSOR
) AS
    --预警与提醒，消息推送。p_pom_rule_msg_pre_generated
    --作者：陈丽
    --日期：2019/11/15
    TYPE REF_CURSOR IS REF CURSOR;
    VC_REF_CURSOR REF_CURSOR;

    TYPE RC_PRE_MSG IS RECORD(
         ID                  POM_PRE_GENERATED_MESSAGE.ID%TYPE
        ,MSG_GROUP_ID        POM_PRE_GENERATED_MESSAGE.MSG_GROUP_ID%TYPE
        ,MSG_DESCRIPTION     POM_PRE_GENERATED_MESSAGE.MSG_DESCRIPTION%TYPE
        ,RECIPIENT_ID        POM_PRE_GENERATED_MESSAGE.RECIPIENT_ID%TYPE
        ,BIZ_KEY             POM_PRE_GENERATED_MESSAGE.BIZ_KEY%TYPE
        ,SENDER_ID           POM_PRE_GENERATED_MESSAGE.SENDER_ID%TYPE
        ,BIZ_SOURCE_CATEGORY POM_PRE_GENERATED_MESSAGE.BIZ_SOURCE_CATEGORY%TYPE
        ,BIZ_MSG_CATEGORY    POM_PRE_GENERATED_MESSAGE.BIZ_MSG_CATEGORY%TYPE
        ,SYSTEM_ID           POM_PRE_GENERATED_MESSAGE.SYSTEM_ID%TYPE
        ,WECHAT_JUMPLINK_URL POM_PRE_GENERATED_MESSAGE.WECHAT_JUMPLINK_URL%TYPE
        ,COMPANY_ID          POM_PRE_GENERATED_MESSAGE.COMPANY_ID%TYPE
        ,DEPT_ID             POM_PRE_GENERATED_MESSAGE.DEPT_ID%TYPE
        ,PROJ_ID             POM_PRE_GENERATED_MESSAGE.PROJ_ID%TYPE);
    V_RC_PRE_MSG RC_PRE_MSG;
BEGIN
    OPEN VC_REF_CURSOR FOR
        SELECT A.ID, A.MSG_GROUP_ID AS "msgGroupId",
               A.MSG_DESCRIPTION AS "msgDescription",
               A.RECIPIENT_ID AS "RecipientId", A.BIZ_KEY AS "bizKey",
               A.SENDER_ID AS "senderId",
               A.BIZ_SOURCE_CATEGORY AS "bizSourceCategory",
               A.BIZ_MSG_CATEGORY AS "bizMsgCategory",
               A.SYSTEM_ID AS "systemId",
               A.WECHAT_JUMPLINK_URL AS "wechatJumplinkUrl"
        FROM   POM_PRE_GENERATED_MESSAGE A
        INNER  JOIN POM_PROJ_PLAN_NODE B
        ON     A.BIZ_KEY = B.ID
        WHERE  MSG_GROUP_ID = MSGGROUPID AND
               B.ACTUAL_END_DATE IS NOT NULL
        UNION ALL
        SELECT A.ID, A.MSG_GROUP_ID AS "msgGroupId",
               A.MSG_DESCRIPTION AS "msgDescription",
               A.RECIPIENT_ID AS "RecipientId", A.BIZ_KEY AS "bizKey",
               A.SENDER_ID AS "senderId",
               A.BIZ_SOURCE_CATEGORY AS "bizSourceCategory",
               A.BIZ_MSG_CATEGORY AS "bizMsgCategory",
               A.SYSTEM_ID AS "systemId",
               A.WECHAT_JUMPLINK_URL AS "wechatJumplinkUrl"
        FROM   POM_PRE_GENERATED_MESSAGE A
        INNER  JOIN POM_SPECIAL_PLAN_NODE B
        ON     A.BIZ_KEY = B.ID
        WHERE  MSG_GROUP_ID = MSGGROUPID AND
               B.ACTUAL_END_DATE IS NOT NULL
        UNION ALL
        SELECT A.ID, A.MSG_GROUP_ID AS "msgGroupId",
               A.MSG_DESCRIPTION AS "msgDescription",
               A.RECIPIENT_ID AS "RecipientId", A.BIZ_KEY AS "bizKey",
               A.SENDER_ID AS "senderId",
               A.BIZ_SOURCE_CATEGORY AS "bizSourceCategory",
               A.BIZ_MSG_CATEGORY AS "bizMsgCategory",
               A.SYSTEM_ID AS "systemId",
               A.WECHAT_JUMPLINK_URL AS "wechatJumplinkUrl"
        FROM   POM_PRE_GENERATED_MESSAGE A
        INNER  JOIN POM_DEPT_MONTHLY_PLAN_NODE B
        ON     A.BIZ_KEY = B.ID
        WHERE  MSG_GROUP_ID = MSGGROUPID AND
               B.ACTUAL_END_DATE IS NOT NULL;
    LOOP
        FETCH VC_REF_CURSOR
            INTO V_RC_PRE_MSG;
        EXIT WHEN VC_REF_CURSOR%NOTFOUND;
        DELETE POM_PRE_GENERATED_MESSAGE WHERE ID = V_RC_PRE_MSG.ID;
    END LOOP;

    OPEN MESSAGE FOR
        SELECT A.ID AS "id", MSG_GROUP_ID AS "msgGroupId",
               A.MSG_DESCRIPTION AS "msgDescription",
               A.RECIPIENT_ID AS "RecipientId", A.BIZ_KEY AS "bizKey",
               A.SENDER_ID AS "senderId",
               A.BIZ_SOURCE_CATEGORY AS "bizSourceCategory",
               A.BIZ_MSG_CATEGORY AS "bizMsgCategory",
               A.SYSTEM_ID AS "systemId",
               A.WECHAT_JUMPLINK_URL AS "wechatJumplinkUrl",
               A.COMPANY_ID AS "companyId", A.DEPT_ID AS "deptId",
               A.PROJ_ID AS "projId"
        FROM   POM_PRE_GENERATED_MESSAGE A
        WHERE  MSG_GROUP_ID = MSGGROUPID;
END P_POM_RULE_MSG_PUSH;
/

prompt
prompt Creating procedure P_POM_SMART_CURRENTCOMPANY_TBS
prompt =================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_SMART_CURRENTCOMPANY_TBS" (
        --orgtype IN VARCHAR2, --查询类型，用于判断过滤 0,公司|1,部门|2,项目|3,,本人
		condition IN VARCHAR2, --输入变量：公司id
        currentuserid        IN 			VARCHAR2,--用户id，用于过滤关注的任务
        currentcompanyid     IN            VARCHAR2,--当前用户公司
        currentdeptid        IN            VARCHAR2,--当前用户部门
        currentstationid     IN            VARCHAR2,---当前用户的岗位
        bizcode       IN            VARCHAR2,---权限code
        searchcondition IN          VARCHAR2,--模糊查询条件
        item OUT SYS_REFCURSOR ) IS --任务中心tabs任务条数统计数据源
--作者：yedr
--日期：2020/04/07

    v_spid              VARCHAR2(200);
	BEGIN
--调用数据权限验证存储过程
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => currentuserid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
		IF  condition <> '111' THEN
            OPEN item FOR SELECT
            SUM(ACOUNT) AS ACOUNT,
            SUM(BCOUNT) AS BCOUNT,
            SUM(CCOUNT) AS CCOUNT,
            SUM(DCOUNT) AS DCOUNT,
            SUM(ECOUNT) AS ECOUNT,
            SUM(FCOUNT) AS FCOUNT,
            SUM(GCOUNT) AS GCOUNT,
            SUM(HCOUNT) AS HCOUNT
            FROM(
                SELECT NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE <= last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT

                FROM
                POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    LEFT JOIN (SELECT node_id,LISTAGG( to_char(charge_person), ',') WITHIN GROUP(ORDER BY charge_person) AS charge_person
                    FROM POM_NODE_CHARGE_PERSON group by node_id) person on node.id=person.NODE_ID
                    LEFT JOIN SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                    ON (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.PROJ_NAME like '%'||searchcondition||'%' OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
					AND node.COMPANY_ID in (select sbu.id
                            from SYS_BUSINESS_UNIT sbu
                            start with sbu.id = '' || condition ||''
                            connect by prior sbu.id = sbu.PARENT_ID)
                UNION ALL
                SELECT
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE <= last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT
                FROM
                POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (SELECT node_id,LISTAGG( to_char(charge_person), ',') WITHIN GROUP(ORDER BY charge_person) AS charge_person
                    FROM POM_NODE_CHARGE_PERSON group by node_id) person on node.id=person.NODE_ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  
                    tal on tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null AND node.ACTUAL_END_DATE IS NULL
					AND plan.APPROVAL_STATUS = '已审核'
					AND	node.IS_DELETE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
					AND plan.COMPANY_ID in (select sbu.id
                            from SYS_BUSINESS_UNIT sbu
                            start with sbu.id = '' || condition ||''
                            connect by prior sbu.id = sbu.PARENT_ID)
                UNION ALL
                SELECT
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE <= last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT
                FROM
                pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (SELECT node_id,LISTAGG( to_char(charge_person), ',') WITHIN GROUP(ORDER BY charge_person) AS charge_person
                    FROM POM_NODE_CHARGE_PERSON group by node_id) person on node.id=person.NODE_ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  
                    tal on tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
					AND APPROVE_STATUS = '已审核'
					AND (node.IS_DEL=0 OR node.IS_DEL=null)
                     AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.DEPT_NAME like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
					AND plan.COMPANY_ID in (select sbu.id
                            from SYS_BUSINESS_UNIT sbu
                            start with sbu.id = '' || condition ||''
                            connect by prior sbu.id = sbu.PARENT_ID)

            );
		ELSE
			OPEN item FOR SELECT
            SUM(ACOUNT) AS ACOUNT,
            SUM(BCOUNT) AS BCOUNT,
            SUM(CCOUNT) AS CCOUNT,
            SUM(DCOUNT) AS DCOUNT,
            SUM(ECOUNT) AS ECOUNT,
            SUM(FCOUNT) AS FCOUNT,
            SUM(GCOUNT) AS GCOUNT,
            SUM(HCOUNT) AS HCOUNT
            FROM(
                SELECT NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE <= last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT

                FROM
                POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    LEFT JOIN (SELECT node_id,LISTAGG( to_char(charge_person), ',') WITHIN GROUP(ORDER BY charge_person) AS charge_person
                    FROM POM_NODE_CHARGE_PERSON group by node_id) person on node.id=person.NODE_ID
                    LEFT JOIN SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                    ON (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.PROJ_NAME like '%'||searchcondition||'%' OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
                UNION ALL
                SELECT
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE <= last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT
                FROM
                POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (SELECT node_id,LISTAGG( to_char(charge_person), ',') WITHIN GROUP(ORDER BY charge_person) AS charge_person
                    FROM POM_NODE_CHARGE_PERSON group by node_id) person on node.id=person.NODE_ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') 
                    tal on tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null AND node.ACTUAL_END_DATE IS NULL
					AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
					AND plan.APPROVAL_STATUS = '已审核'
					AND	node.IS_DELETE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
                UNION ALL
                SELECT
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE <= last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT
                FROM
                pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (SELECT node_id,LISTAGG( to_char(charge_person), ',') WITHIN GROUP(ORDER BY charge_person) AS charge_person
                    FROM POM_NODE_CHARGE_PERSON group by node_id) person on node.id=person.NODE_ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') 
                    tal on tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
					AND APPROVE_STATUS = '已审核'
					AND (node.IS_DEL=0 OR node.IS_DEL=null)
                     AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.DEPT_NAME like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')

            );
		END IF;

END P_POM_SMART_CURRENTCOMPANY_TBS;
/

prompt
prompt Creating procedure P_POM_SMART_CURRENTDEPT_TBS
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_SMART_CURRENTDEPT_TBS" (
        --orgtype IN VARCHAR2, --查询类型，用于判断过滤 0,公司|1,部门|2,项目|3,,本人
		condition IN VARCHAR2, --输入变量：部门id
        currentuserid        IN 			VARCHAR2,--用户id，用于过滤关注的任务
        currentcompanyid     IN            VARCHAR2,--当前用户公司
        currentdeptid        IN            VARCHAR2,--当前用户部门
        currentstationid     IN            VARCHAR2,---当前用户的岗位
        bizcode       IN            VARCHAR2,---权限code
        searchcondition IN          VARCHAR2,--模糊查询条件
        item OUT SYS_REFCURSOR ) IS --任务中心tabs任务条数统计数据源
--作者：yedr
--日期：2020/04/07

    v_spid              VARCHAR2(200);
	BEGIN
--调用数据权限验证存储过程
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => currentuserid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
		IF  condition <> '111' THEN
            OPEN item FOR SELECT
            SUM(ACOUNT) AS ACOUNT,
            SUM(BCOUNT) AS BCOUNT,
            SUM(CCOUNT) AS CCOUNT,
            SUM(DCOUNT) AS DCOUNT,
            SUM(ECOUNT) AS ECOUNT,
            SUM(FCOUNT) AS FCOUNT,
            SUM(GCOUNT) AS GCOUNT,
            SUM(HCOUNT) AS HCOUNT
            FROM(
                SELECT NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE <= last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT

                FROM
                POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON node.ID=person.NODE_ID
                    LEFT JOIN SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                    ON (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE  ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.PROJ_NAME like '%'||searchcondition||'%' OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
					AND node.DUTY_DEPARTMENT_ID = ''|| condition ||''
                UNION ALL
                SELECT
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE <= last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT
                FROM
                POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON node.ID=person.NODE_ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE  node.ACTUAL_END_DATE IS NULL
					AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
					AND plan.APPROVAL_STATUS = '已审核'
					AND	node.IS_DELETE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
					AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
                UNION ALL
                SELECT
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE <= last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT
                FROM
                pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON node.ID=person.NODE_ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE  APPROVE_STATUS = '已审核'
					AND (node.IS_DEL=0 OR node.IS_DEL=null)
                     AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.DEPT_NAME like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
					AND plan.DEPT_ID = '' || condition || ''

            );
		ELSE
			OPEN item FOR SELECT
            SUM(ACOUNT) AS ACOUNT,
            SUM(BCOUNT) AS BCOUNT,
            SUM(CCOUNT) AS CCOUNT,
            SUM(DCOUNT) AS DCOUNT,
            SUM(ECOUNT) AS ECOUNT,
            SUM(FCOUNT) AS FCOUNT,
            SUM(GCOUNT) AS GCOUNT,
            SUM(HCOUNT) AS HCOUNT
            FROM(
                SELECT NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE <= last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT

                FROM
                POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON node.ID=person.NODE_ID
                    LEFT JOIN SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                    ON (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.PROJ_NAME like '%'||searchcondition||'%' OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
					--AND node.DUTY_DEPARTMENT_ID = ''|| condition ||''
                UNION ALL
                SELECT
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE <= last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT
                FROM
                POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON node.ID=person.NODE_ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE  node.ACTUAL_END_DATE IS NULL
					AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
					AND plan.APPROVAL_STATUS = '已审核'
					AND	node.IS_DELETE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
					--AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
                UNION ALL
                SELECT
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(*) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE <= last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT
                FROM
                pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON node.ID=person.NODE_ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE APPROVE_STATUS = '已审核'
					AND (node.IS_DEL=0 OR node.IS_DEL=null)
                     AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.DEPT_NAME like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
					--AND plan.DEPT_ID = '' || condition || ''

            );
		END IF;


END P_POM_SMART_CURRENTDEPT_TBS;
/

prompt
prompt Creating procedure P_POM_SMART_CURRENTPROJ_TBS
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_SMART_CURRENTPROJ_TBS" (
        --orgtype IN VARCHAR2, --查询类型，用于判断过滤 0,公司|1,部门|2,项目|3,,本人
		condition IN VARCHAR2, --输入变量：项目id
        currentuserid        IN 			VARCHAR2,--用户id，用于过滤关注的任务
        currentcompanyid     IN            VARCHAR2,--当前用户公司
        currentdeptid        IN            VARCHAR2,--当前用户部门
        currentstationid     IN            VARCHAR2,---当前用户的岗位
        bizcode       IN            VARCHAR2,---权限code
        searchcondition IN          VARCHAR2,--模糊查询条件
        item OUT SYS_REFCURSOR ) IS --任务中心tabs任务条数统计数据源
--作者：yedr
--日期：2020/04/07

    v_spid              VARCHAR2(200);
	BEGIN
--调用数据权限验证存储过程
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => currentuserid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
		IF  condition <> '111' THEN
            OPEN item FOR SELECT
            SUM(ACOUNT) AS ACOUNT,
            SUM(BCOUNT) AS BCOUNT,
            SUM(CCOUNT) AS CCOUNT,
            SUM(DCOUNT) AS DCOUNT,
            SUM(ECOUNT) AS ECOUNT,
            SUM(FCOUNT) AS FCOUNT,
            SUM(GCOUNT) AS GCOUNT,
            SUM(HCOUNT) AS HCOUNT
            FROM(
                SELECT NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(node.id) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE <= last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT

                FROM
                POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON node.ID=person.NODE_ID
                    LEFT JOIN SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                    ON (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.PROJ_NAME like '%'||searchcondition||'%' OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%'
                    OR person.CHARGE_PERSON like '%'||searchcondition||'%')
					AND (plan.PROJ_ID=''||condition||'' OR plan.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''||condition||''))
            );
		ELSE
			OPEN item FOR SELECT
            SUM(ACOUNT) AS ACOUNT,
            SUM(BCOUNT) AS BCOUNT,
            SUM(CCOUNT) AS CCOUNT,
            SUM(DCOUNT) AS DCOUNT,
            SUM(ECOUNT) AS ECOUNT,
            SUM(FCOUNT) AS FCOUNT,
            SUM(GCOUNT) AS GCOUNT,
            SUM(HCOUNT) AS HCOUNT
            FROM(
                SELECT NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND
                ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                THEN  1 ELSE 0 END), 0)AS ACOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS DCOUNT,
                COUNT(node.id) AS ECOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE <= last_day( last_day( trunc( SYSDATE ) ) + 1 )
					) THEN 1 ELSE 0 END),0) AS FCOUNT,
                NVL(SUM(CASE WHEN  (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					) THEN 1 ELSE 0 END),0) AS GCOUNT,
                NVL(SUM(CASE WHEN (
						node.PLAN_END_DATE >= trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE <= add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					) THEN 1 ELSE 0 END),0) AS HCOUNT

                FROM
                POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    LEFT JOIN SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON node.ID=person.NODE_ID
                    LEFT JOIN (select org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'' GROUP BY org_id) tal
                    ON (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.PROJ_NAME like '%'||searchcondition||'%' OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
					--AND node.COMPANY_ID = ''|| condition ||''
  );
		END IF;

END P_POM_SMART_CURRENTPROJ_TBS;
/

prompt
prompt Creating procedure P_POM_SMART_CURRENTPSRSON_TBS
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_SMART_CURRENTPSRSON_TBS" (
		condition IN VARCHAR2, --输入变量：当前用户ID
        searchcondition IN          VARCHAR2,--模糊查询条件
        item OUT SYS_REFCURSOR ) IS --任务中心tabs任务条数统计数据源
--作者：yedr
--日期：2020/04/07

    v_spid              VARCHAR2(200);
	BEGIN
    OPEN item FOR SELECT
            SUM(ACOUNT) AS ACOUNT,
            SUM(BCOUNT) AS BCOUNT,
            SUM(CCOUNT) AS CCOUNT
            FROM(
                SELECT
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS ACOUNT,
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS CCOUNT
                    FROM
                    POM_PROJ_PLAN_NODE node
                    LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
                    WHERE  (plan.PLAN_TYPE = '项目主项计划' OR  plan.PLAN_TYPE = '关键节点计划')
                    AND plan.APPROVAL_STATUS = '已审核'
                    AND node.IS_DISABLE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.PROJ_NAME like '%'||searchcondition||'%' OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
                    AND person.CHARGE_PERSON_ID = '' || condition || ''
                UNION ALL
                SELECT
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS ACOUNT,
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS CCOUNT
                    FROM POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
                    WHERE node.ACTUAL_END_DATE IS NULL
					AND plan.APPROVAL_STATUS = '已审核'
					AND	node.IS_DELETE=0
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR node.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')
                    AND person.CHARGE_PERSON_ID = '' || condition || ''
                UNION ALL
                SELECT
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL THEN 1 ELSE 0 END),0) AS CCOUNT,
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NULL AND SYSDATE > node.PLAN_END_DATE THEN 1 ELSE 0 END),0)AS BCOUNT,
                    NVL(SUM(CASE WHEN node.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END),0) AS ECOUNT
                    FROM pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
                    WHERE APPROVE_STATUS = '已审核'
					AND (node.IS_DEL=0 OR node.IS_DEL=null)
                    AND person.CHARGE_PERSON_ID = '' || condition || ''
                    AND (node.node_name like '%'||searchcondition||'%' OR plan.plan_name like '%'||searchcondition||'%'
                    OR plan.DEPT_NAME like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%')

            );

END P_POM_SMART_CURRENTPSRSON_TBS;
/

prompt
prompt Creating procedure P_POM_SMART_DELAY_NODE_CURRENT
prompt =================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_smart_delay_node_current (
    plantype       IN             VARCHAR2,
    datascope      IN             VARCHAR2,
    orgid          IN             VARCHAR2,
    title          OUT            VARCHAR2,
    titleicon      OUT            VARCHAR2,
    currentdelay   OUT            SYS_REFCURSOR
) AS --关键节点计划监控-当前延误节点
        --作者：陈丽
        --日期：2019/11/13
BEGIN
    title := '当前延误节点';
    --图标库地址 https://element.eleme.cn/#/zh-CN/component/icon
    titleicon := 'el-icon-tickets';

                OPEN CURRENTDELAY FOR
                        SELECT DISTINCT A.ORG_NAME AS "orgName",
                                                        B2.PROJECTSTAGE_NAME AS "projName",
                                                        B2.NODE_NAME|| CASE WHEN ESTIMATE_END_DATE IS NOT NULL THEN   '(预计完成日期：'||TO_CHAR(ESTIMATE_END_DATE,'YYYY-MM-DD ')||')'END  AS "nodeName",
                                                        NODE_ID as "nodeId",
                                                        ORIGINAL_NODE_ID as "nodeOriginId",
                                                        '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||
                                                         NVL(B2.COMPANY_ID, '003200000000000000000000000000') ||
                                                         '&ppid=' || B2.PPID || '&planType=关键节点计划' AS "projOpenUrl",
                                                        '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id=' ||
                                                         B2.PLANID || '&feedbackNodeId=' || NODE_ID ||
                                                         '&feedbackNodeOriginalId=' || ORIGINAL_NODE_ID ||
                                                         '&nodeSourcePlanType=0' AS "nodeOpenUrl",
                                                          '<span class="right"> 已延误 <span style="display: inline-block;
                                                                width: 40px;
                                                                text-align: center;
                                                                border-radius: 4px;
                                                                margin: 0 4px;
                                                                background-color: rgb(248, 94, 90);
                                                                color: #fff;
                                                                font-weight: 700;">'
                                                                ||TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd'))
                                                                ||'</span> 天 </span>'             AS "delayDays"
																																,TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') as "DelayDAYsRUNK"
                        FROM   SYS_BUSINESS_UNIT A

                        LEFT   JOIN (SELECT LEVEL, ORG_NAME, CONNECT_BY_ROOT ID AS ID,
                                                                CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
                                                                B.UNIT_ID, B.NODE_NAME, B.NODE_ID,
                                                                B.ACTUAL_END_DATE, B.PLAN_END_DATE,
                                                                B.PROJECTSTAGE_NAME, B.PPID, B.PID,
                                                                'TYPE_ORG' AS CTYPE, B.ESTIMATE_END_DATE,
                                                                B.PLANID, ORIGINAL_NODE_ID,B.COMPANY_ID
                                                 FROM   SYS_BUSINESS_UNIT A
                                                 LEFT   JOIN (SELECT B1.UNIT_ID, A.ID AS PLANID,A.COMPANY_ID,
                                                                                        case when  STAGE_NAME like '%无分期%' then  B1.ID else A.PROJ_ID end   AS PPID,--20200427李小聪调整勿修改
																																												B1.ID AS PID,
                                                                                        A1.ORIGINAL_NODE_ID,

                                                                                         A.PROJ_NAME AS PROJECTSTAGE_NAME,
                                                                                        A1.NODE_NAME, A1.ID AS NODE_ID,
                                                                                        A1.ACTUAL_END_DATE,
                                                                                        A1.PLAN_END_DATE,
                                                                                        A1.ESTIMATE_END_DATE
                                                                         FROM   POM_PROJ_PLAN A
                                                                         INNER  JOIN POM_PROJ_PLAN_NODE A1
                                                                         ON     A.ID = A1.PROJ_PLAN_ID
                                                                         INNER  JOIN SYS_PROJECT_STAGE C1
                                                                         ON     A.PROJ_ID = C1.ID
                                                                         INNER  JOIN SYS_PROJECT B1
                                                                         ON     C1.PROJECT_ID = B1.ID
                                                                         WHERE  A.PLAN_TYPE = '关键节点计划' AND

                                                                                        A.APPROVAL_STATUS = '已审核'
																																									and  A1.IS_DISABLE=0
																																									AND

                                                                                        TRUNC(SYSDATE, 'dd') -TRUNC(PLAN_END_DATE, 'dd') > 0 AND
                                                                                        ACTUAL_END_DATE IS NULL) B
                                                 ON     A.ID = B.UNIT_ID
                                                 WHERE  ORG_TYPE = 0
                                                 START  WITH ID = '' || ORGID || ''
                                                 CONNECT BY PRIOR A.ID = A.PARENT_ID) B2
                        ON     A.ID = B2.ID
                        WHERE  NODE_NAME IS NOT NULL AND
                                     ACTUAL_END_DATE IS NULL AND
                                     TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 --分期
                        UNION ALL
                        SELECT DISTINCT '' AS "orgName",
                                                     A.PROJ_NAME AS "projName",
                                                        A1.NODE_NAME|| CASE WHEN ESTIMATE_END_DATE IS NOT NULL THEN   '(预计完成日期：'||TO_CHAR(ESTIMATE_END_DATE,'YYYY-MM-DD ')||')'END  AS "nodeName",
                                                         A1.ID as "nodeId",
                                                        A1.ORIGINAL_NODE_ID as "nodeOriginId",
                                                        '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||
                                                         NVL(A.COMPANY_ID,
                                                                 '003200000000000000000000000001') ||
                                                         '&ppid=' || C1.ID || '&planType=关键节点计划' AS "projOpenUrl",
                                                        '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id' || A.ID ||
                                                         '&feedbackNodeId=' || A1.ID ||
                                                         '&feedbackNodeOriginalId=' ||
                                                         A1.ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
                                                          '<span class="right"> 已延误 <span style="display: inline-block;
                                                                width: 40px;
                                                                text-align: center;
                                                                border-radius: 4px;
                                                                margin: 0 4px;
                                                                background-color: rgb(248, 94, 90);
                                                                color: #fff;
                                                                font-weight: 700;">'
                                                                ||TO_CHAR(TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd'))
                                                                ||'</span> 天 </span>'             AS "delayDays"
--                                                        TRUNC(SYSDATE, 'dd') -
--                                                         TRUNC(PLAN_END_DATE, 'dd') AS "delayDays"
,TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') as "DelayDAYsRUNK"

                        FROM   POM_PROJ_PLAN A
                        INNER  JOIN POM_PROJ_PLAN_NODE A1
                        ON     A.ID = A1.PROJ_PLAN_ID
                        INNER  JOIN SYS_PROJECT_STAGE C1
                        ON     A.PROJ_ID = C1.ID
                        INNER  JOIN SYS_PROJECT B1
                        ON     C1.PROJECT_ID = B1.ID
                        WHERE  A.PLAN_TYPE = '关键节点计划' AND
                                     A.APPROVAL_STATUS = '已审核'
																		 and  A1.IS_DISABLE=0
																		 AND

                                     TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') > 0 AND
                                     ACTUAL_END_DATE IS NULL AND
                                     C1.PROJECT_ID = '' || ORGID || ''
                        ORDER  BY 9 DESC,2;

END p_pom_smart_delay_node_current;
/

prompt
prompt Creating procedure P_POM_SMART_DELAY_NODE_PREDICT
prompt =================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_smart_delay_node_predict (
    plantype       IN             VARCHAR2,
    datascope      IN             VARCHAR2,
    orgid          IN             VARCHAR2,
    title          OUT            VARCHAR2,
    titleicon      OUT            VARCHAR2,
    predictdelay   OUT            SYS_REFCURSOR
) AS --关键节点计划监控-预计延误节点
		--作者：陈丽
		--日期：2019/11/13
BEGIN

    title := '预计延误及5天内到期节点';
    titleicon := '';

   open predictdelay FOR


      SELECT DISTINCT
      A.ORG_NAME AS "orgName",
      B2.PROJECTSTAGE_NAME AS "projName",
      B2.NODE_NAME ||case when  ESTIMATE_END_DATE is NOT null then '   (预计完成日期：'||  TO_CHAR(ESTIMATE_END_DATE,'yyyy-mm-dd') ||')' else  null end AS "nodeName",
      NODE_ID as "nodeId",
      ORIGINAL_NODE_ID as "nodeOriginId",
      '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' || b2.UNIT_ID ||  '&ppid=' || B2.PPID || '&planType=关键节点计划' AS "projOpenUrl",
      '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id=' || B2.PLANID || '&feedbackNodeId=' || NODE_ID || '&feedbackNodeOriginalId=' || ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",

				CASE  WHEN TRUNC(ESTIMATE_END_DATE, 'dd' ) - TRUNC(  PLAN_END_DATE, 'dd' ) > 0   THEN
						'<span class="right"> 预计延误 <span style="display: inline-block;
																width: 40px;
																text-align: center;
																border-radius: 4px;
																margin: 0 4px;
																background-color: rgb(248, 94, 90);
																color: #fff;
																font-weight: 700;">'
																||TO_CHAR( TRUNC(ESTIMATE_END_DATE, 'dd' ) - TRUNC(  PLAN_END_DATE, 'dd' ))
																||'</span> 天 </span>'
								WHEN  TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE)=0 THEN
						'<span class="right"> 今天到期 </span>'
								ELSE
													'<span class="right"> 余  <span style="display: inline-block;
																width: 30px;
																text-align: center;
																border-radius: 4px;
																margin: 0 4px;
																background-color:  #409eff;
																color: #fff;
																font-weight: 700;">'
																||TO_CHAR(TRUNC(PLAN_END_DATE, 'dd')-TRUNC(SYSDATE, 'dd'))
																||'</span> 天到期 </span>' 	 END
														AS "delayDays"
											, case when ESTIMATE_END_DATE is not null  then  TRUNC(ESTIMATE_END_DATE, 'dd' ) - TRUNC(  PLAN_END_DATE, 'dd' )   else  TRUNC(PLAN_END_DATE, 'dd')-TRUNC(SYSDATE, 'dd')
										  end  as daycount
    FROM
      SYS_BUSINESS_UNIT a
      LEFT JOIN (
      SELECT LEVEL
        ,
        ORG_NAME,
        CONNECT_BY_ROOT ID AS ID,
        CONNECT_BY_ROOT PARENT_ID AS PARENT_ID,
        B.UNIT_ID,
        B.NODE_NAME,
        B.NODE_ID,
        B.ACTUAL_END_DATE,
        B.PLAN_END_DATE,
        B.PROJECTSTAGE_NAME,
        B.PPID,
        B.PID,
        'TYPE_ORG' AS CTYPE,
        B.ESTIMATE_END_DATE,
        PLANID,
        ORIGINAL_NODE_ID
      FROM
        SYS_BUSINESS_UNIT A
        LEFT JOIN (
        SELECT
          B1.UNIT_ID,
          A.ID AS PLANID,
          A1.ORIGINAL_NODE_ID,
         	 case when  STAGE_NAME like '%无分期%' then  B1.ID else A.PROJ_ID end   AS PPID,--20200427李小聪调整勿修改
          B1.ID AS PID,
           A.PROJ_NAME AS PROJECTSTAGE_NAME,
          A1.NODE_NAME,
          A1.ID AS NODE_ID,
          A1.ACTUAL_END_DATE,
          A1.PLAN_END_DATE,
          A1.ESTIMATE_END_DATE
        FROM
          POM_PROJ_PLAN A
          INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
          INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
          INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID
        WHERE
          A.PLAN_TYPE = '关键节点计划'
          AND A.APPROVAL_STATUS = '已审核'
					and  A1.IS_DISABLE=0
          AND (TRUNC(ESTIMATE_END_DATE , 'dd' ) - TRUNC(PLAN_END_DATE , 'dd' ) > 0  OR
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5)
          AND ACTUAL_END_DATE IS NULL

        ) B ON A.ID = B.UNIT_ID
      WHERE
        ORG_TYPE = 0 START WITH ID = '' || orgId || '' CONNECT BY PRIOR A.ID = A.PARENT_ID
      ) B2 ON A.ID = B2.ID
    WHERE
      NODE_NAME IS NOT NULL
      AND ACTUAL_END_DATE IS NULL
			--判断条件

    AND (TRUNC(ESTIMATE_END_DATE, 'dd' ) - TRUNC(  PLAN_END_DATE, 'dd' ) > 0  OR
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5 --5天内到期
				)
				--	未超期
		AND		TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') <= 0
			--分期
    UNION ALL
    SELECT DISTINCT
      '' AS "orgName",
       A.PROJ_NAME AS "projName",
      A1.NODE_NAME  ||case when  ESTIMATE_END_DATE is NOT null then '   (预计完成日期：'||  TO_CHAR(ESTIMATE_END_DATE,'yyyy-mm-dd') ||')' else  null end  AS "nodeName",
        A1.ID as "nodeId",
      A1.ORIGINAL_NODE_ID as "nodeOriginId",
      '/pom/plan-assess/node-monitoring/plan-nodes?companyid=' ||A.COMPANY_ID || '&ppid=' || B1.ID || '&planType=关键节点计划' AS "projOpenUrl",
      '/pom/mission-center-feedback/my-responsible-task/view-task-information?cancelType=0&id=' || A.ID || '&feedbackNodeId=' || A1.ID || '&feedbackNodeOriginalId=' || A1.ORIGINAL_NODE_ID || '&nodeSourcePlanType=0' AS "nodeOpenUrl",
			CASE  WHEN  TRUNC(ESTIMATE_END_DATE, 'dd' ) - TRUNC(  PLAN_END_DATE, 'dd' ) > 0   THEN
						'<span class="right"> 预计延误 <span style="display: inline-block;
																width: 40px;
																text-align: center;
																border-radius: 4px;
																margin: 0 4px;
																background-color: rgb(248, 94, 90);
																color: #fff;
																font-weight: 700;">'
																||TO_CHAR( TRUNC(ESTIMATE_END_DATE, 'dd' ) - TRUNC(  PLAN_END_DATE, 'dd' ))
																||'</span> 天 </span>'
								WHEN  TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE)=0 THEN
						'<span class="right"> 今天到期 </span>'
								ELSE
													'<span class="right"> 余  <span style="display: inline-block;
																width: 30px;
																text-align: center;
																border-radius: 4px;
																margin: 0 4px;
																background-color:  #409eff;
																color: #fff;
																font-weight: 700;">'
																||TO_CHAR(TRUNC(PLAN_END_DATE, 'dd')-TRUNC(SYSDATE, 'dd'))
																||'</span> 天到期 </span>' 	 END
														AS "delayDays"
				, case when ESTIMATE_END_DATE is not null  then  TRUNC(ESTIMATE_END_DATE, 'dd' ) - TRUNC(  PLAN_END_DATE, 'dd' )
				else  TRUNC(PLAN_END_DATE, 'dd')-TRUNC(SYSDATE, 'dd')
										  end  as daycount
    FROM
      POM_PROJ_PLAN A
      INNER JOIN POM_PROJ_PLAN_NODE A1 ON A.ID = A1.PROJ_PLAN_ID
      INNER JOIN SYS_PROJECT_STAGE C1 ON A.PROJ_ID = C1.ID
      INNER JOIN SYS_PROJECT B1 ON C1.PROJECT_ID = B1.ID
    WHERE
      A.PLAN_TYPE = '关键节点计划'
      AND A.APPROVAL_STATUS = '已审核'
				and  A1.IS_DISABLE=0
      AND (TRUNC(ESTIMATE_END_DATE, 'dd' ) - TRUNC(  PLAN_END_DATE, 'dd' ) > 0  OR
							 TRUNC( PLAN_END_DATE, 'dd' ) - TRUNC( SYSDATE, 'dd' )  BETWEEN 0 AND 5)
			AND	 TRUNC(SYSDATE, 'dd') - TRUNC(PLAN_END_DATE, 'dd') <= 0
      AND ACTUAL_END_DATE IS NULL

      AND C1.PROJECT_ID = '' || orgId || ''
    ORDER BY
      daycount asc;

END p_pom_smart_delay_node_predict;
/

prompt
prompt Creating procedure P_POM_SMART_EXAMRULE_SET_STATE
prompt =================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_smart_examrule_set_state ( ruleid IN VARCHAR2, --输入变量：规则id
		statetype IN INT, --0生效，1失效
		errmsg OUT VARCHAR2, --提示消息
		errcode OUT INT --0成功，1失败
	) IS --考核规则生效失效设置
--作者：叶丁荣
--日期：2019/11/21
	typemsg VARCHAR2 ( 50 );
ruleids VARCHAR2 ( 4000 );
countdtl INT;
testmsg NVARCHAR2 ( 200 );
statuscount NUMBER;
BEGIN
	BEGIN
			testmsg := 'ruleid:' || ruleid || '.statetype:' || statetype;
		countdtl := 0;
		IF
			statetype = 0 THEN
				typemsg := '失效';
			ELSE typemsg := '生效';

		END IF;
		IF
			length( ruleid ) < 36 THEN
				raise_application_error ( - 20000, '请选择要' || typemsg || '的规则' || testmsg );

		END IF;
--循环规则id
		FOR item IN (
			SELECT
				regexp_substr( '' || ruleid || '', '[^,]+', 1, ROWNUM ) AS id 
			FROM
				dual CONNECT BY ROWNUM <= length( '' || ruleid || '' ) - length( regexp_replace( '' || ruleid || '', ',', '' ) ) + 1 
			)
			LOOP---拼接字符串
			ruleids := ruleids || item.id;
		SELECT COUNT(IS_ACTIVE) INTO statuscount  FROM POM_RULE_EXAMINATION WHERE ID='' || item.id || '' AND IS_ACTIVE=statetype ;

			IF(statuscount>0) THEN
				errcode := 1;
				errmsg := '已有'''||typemsg||'''的规则，请选择相同状态的数据进行操作';
				return;
			ELSE 
					UPDATE POM_RULE_EXAMINATION 
					SET IS_ACTIVE = statetype 
					WHERE
						id = '' || item.id || '';
					countdtl := countdtl + 1;
			END IF;

	END LOOP;

			errcode := 0;
			errmsg := typemsg || '设置成功！' || countdtl || '条规则';

EXCEPTION 
	WHEN OTHERS THEN
	errcode := 1;
errmsg := sqlerrm;

END;

END p_pom_smart_examrule_set_state;
/

prompt
prompt Creating procedure P_POM_SMART_EXAM_RUEL_DEL
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_SMART_EXAM_RUEL_DEL
(
		RULEID  IN VARCHAR2
	 , --输入变量：规则id
		ERRMSG  OUT VARCHAR2
	 , --提示消息
		ERRCODE OUT INT --0成功，1失败
) IS
		--考核规则删除
		--作者：叶丁荣
		--日期：2019/11/22
		COUNTDTL INT;
BEGIN
		BEGIN
				COUNTDTL := 0;
				IF LENGTH(RULEID) < 32 THEN
						RAISE_APPLICATION_ERROR(-20000, '请选择要删除的规则');
				END IF;
				--循环规则id
		
				FOR ITEM IN (SELECT REGEXP_SUBSTR('' || RULEID || '', '[^,]+', 1,
																					 ROWNUM) AS ID
										 FROM   DUAL
										 CONNECT BY ROWNUM <=
																LENGTH('' || RULEID || '') -
																LENGTH(REGEXP_REPLACE('' || RULEID || '', ',',
																											'')) + 1)
				LOOP
						---删除规则
						DELETE POM_RULE_EXAMINATION WHERE ID = '' || ITEM.ID || '';
				
						COUNTDTL := COUNTDTL + 1;
				END LOOP;
		
				ERRCODE := 0;
				ERRMSG  := '删除成功！' || COUNTDTL || '条规则';
		EXCEPTION
				WHEN OTHERS THEN
						ERRCODE := 1;
						ERRMSG  := SQLERRM;
		END;
END P_POM_SMART_EXAM_RUEL_DEL;
/

prompt
prompt Creating procedure P_POM_SMART_KEYNODEPLAN_TBS
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_SMART_KEYNODEPLAN_TBS ( orgtype IN VARCHAR2, --查询类型，用于判断过滤 0,公司|1,部门|2,项目|3,,本人
    condition IN VARCHAR2, --输入变量：公司id | 部门id | 项目id | 当前用户ID
  item OUT SYS_REFCURSOR ) IS
  --任务中心tabs任务条数统计数据源
  --作者：yedr
  --日期：2019/12/25
BEGIN

OPEN item FOR

            POM_PROJ_PLAN_NODE node
            LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
          WHERE
            plan.PLAN_TYPE = '关键节点计划'
            AND plan.APPROVAL_STATUS = '已审核'
            AND plan.PROJ_ID ='e381dc98-c7db-4a4a-872c-02faa4c0759e'
        ) AS ACOUNT,
--超期未完成任务
        1 AS BCOUNT,
--所有未完成任务

          2
         AS CCOUNT,
--所有已完成任务

          3
         AS DCOUNT,
--所有任务

          4
         AS ECOUNT,
--次月任务

          5
        AS FCOUNT,
--本季度任务

          6
        AS GCOUNT,
--本年任务

          7
         AS HCOUNT
      FROM
        dual;

END P_POM_SMART_KEYNODEPLAN_TBS;
/

prompt
prompt Creating procedure P_POM_SMART_KEY_NODE_PLAN_PROJ
prompt =================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_SMART_KEY_NODE_PLAN_PROJ"
(
    PROJID      IN VARCHAR2
   , --输入变量：项目
    PAGEINDEX   IN INT
   ,PAGESIZES   IN INT
   ,CURRENTTYPE IN VARCHAR2
   , --完成节点类型(本月任务,超期未完成任务,所有未完成任务,所有已完成任务,所有任务,次月任务,本季度任务,本年任务)
    userid        IN            VARCHAR2,--用户id用于过滤关注的任务
    currentcompanyid     IN     VARCHAR2,--当前用户的公司
    currentstationid     IN            VARCHAR2,---当前用户的岗位
    currentdeptid        IN            VARCHAR2,---当前用户的部门
    searchcondition IN          VARCHAR2,--模糊查询条件
    bizcode       IN            VARCHAR2,---权限code
    ITEMS       OUT SYS_REFCURSOR
   ,TOTAL       OUT INT
) IS
    --本部门负责的任务
    --作者：陈丽
    --日期：2019/11/15

    V_SQL_START       CLOB;
    V_SQL_END         CLOB;
    V_SQL_CONTENT     CLOB;
    V_SQL             CLOB;
    V_SQL_EXEC        CLOB;
    V_SQL_EXEC_PAGING CLOB;
    V_WHERE           VARCHAR2(500);
    TESTMSG           NVARCHAR2(200);
    v_spid              VARCHAR2(200);--数据权限验证spid
    v_where_like       CLOB;
    v_test_land        CLOB;
BEGIN
    ----------------------------------------------------统一解析
    TESTMSG := 'projid:' || PROJID || '；pageindex:' || PAGEINDEX || '；pagesizes:' || PAGESIZES || '；currenttype:' || CURRENTTYPE;

    BEGIN
        TOTAL         := 1000;
        V_SQL_START   := ' case ';
        V_SQL_CONTENT := '';
        V_SQL_END     := '  else '''' end  ';


        --调用数据权限验证存储过程
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
        --1.拼接查询语句
        FOR ITEM IN (SELECT S.EXPRESSION, VV.NODE_LEVEL, VV.PLAN_TYPE
                     FROM   POM_RULE_SET S
                     LEFT   JOIN (SELECT MAX(S.CREATED_TIME) AS T, NODE_LEVEL, PLAN_TYPE
                                 FROM   POM_RULE_SET S
                                 LEFT   JOIN POM_RULE_SET_PLAN_TYPE PT
                                 ON     S.ID = PT.RULE_ID
                                 WHERE  RULE_TYPE = '亮灯规则'
                                       -- AND plan_type != '关键节点计划'
                                        AND
                                        S.IS_DISABLE = 0
                                 GROUP  BY NODE_LEVEL, PLAN_TYPE) VV
                     ON     S.CREATED_TIME = VV.T AND
                            S.NODE_LEVEL = VV.NODE_LEVEL
                     WHERE  VV.T IS NOT NULL)
        LOOP
            ---拼接字符串
            V_SQL_CONTENT := V_SQL_CONTENT || '  when plan_type=''' || CASE ITEM.PLAN_TYPE
                                 WHEN '项目全景计划' THEN
                                  '项目主项计划'
                                 ELSE
                                  ITEM.PLAN_TYPE
                             END || ''' and node_level=''' || ITEM.NODE_LEVEL || ''' then (' || ITEM.EXPRESSION || ')';
        END LOOP;

        --dbms_output.put_line('123333');
        --dbms_output.put_line(v_sql_content);
        --规则内容大于0才拼规则语句

        IF LENGTH(V_SQL_CONTENT) > 0
        THEN
            V_SQL := V_SQL_START || V_SQL_CONTENT || V_SQL_END;
        ELSE
            --无规则亮灯显示空
            V_SQL := '''''';
        END IF;

        -------------------------------------------------------------------------------------------内容


        IF CURRENTTYPE = '本月任务'
        THEN
            V_WHERE := ' and ACTUAL_END_DATE is null and (PLAN_END_DATE>=trunc(sysdate, ''month'') and PLAN_END_DATE<=trunc(last_day(sysdate))) ';
        ELSIF CURRENTTYPE = '超期未完成任务'
        THEN
            V_WHERE := ' and TRUNC(SYSDATE) > PLAN_END_DATE and ACTUAL_END_DATE is null';
        ELSIF CURRENTTYPE = '所有未完成任务'
        THEN
            V_WHERE := ' and ACTUAL_END_DATE is null ';
        ELSIF CURRENTTYPE = '所有已完成任务'
        THEN
            V_WHERE := ' and ACTUAL_END_DATE is not null ';
        ELSIF CURRENTTYPE = '所有任务'
        THEN
            V_WHERE := ' ';
        ELSE
            V_WHERE := ' and 1=2';
        END IF;

        --当输入条件部位空时
        IF searchcondition is not null THEN
          v_where_like := 'WHERE (instr(n.NODE_NAME,'''||searchcondition||''')>0 OR instr(n.PLAN_NAME,'''||searchcondition||''')>0
              OR instr(n.PROJ_NAME,'''||searchcondition||''')>0 OR instr(n.DUTY_DEPARTMENT,'''||searchcondition||''')>0
              OR instr(charge_person,'''||searchcondition||''')>0 )';
        ELSE
          v_where_like := '';
        END IF;

        --3.拼接完整语句
        IF PROJID<>'111' THEN
        V_SQL_EXEC := ' select  rownum as rowno,ID,
                    ORIGINAL_NODE_ID,
                    ORIGINAL_PLAN_ID,
                    PROJ_PLAN_ID as PLAN_ID,
                    PLAN_TYPE_INT,
                    NODE_NAME,
                    PLAN_NAME,
                    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
                    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
                    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
                    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
                    case when ACTUAL_END_DATE is null then ''未完成''
                    else ''已完成'' end as COMPLETION_STATUS,
                    PROJ_NAME,
                    PLAN_TYPE,
                    DUTY_DEPARTMENT,
                    CHARGE_PERSON,
                    NODE_LEVEL,
                    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,w_Url,' || V_SQL || ' as NODE_WARNING from (select n.*,w.IS_UN_WATCH
                ,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
                ,case when n.ACTUAL_END_DATE IS NOT NULL THEN NULL
                ELSE ''催办'' END as HASTEN
                ,case when w.IS_UN_WATCH=0 then ''/api/pom/planfollow/unfollow?cancelType=0=724=300=''||ORIGINAL_NODE_ID else ''/pom/biz-watch/bizwatch-setting?cancelType=0=724=300==''||ORIGINAL_NODE_ID end as w_Url

                                      from(SELECT
                    n.ID,
                     p.ORIGINAL_PLAN_ID,
                    ORIGINAL_NODE_ID,
                    n.PROJ_PLAN_ID,
                    CASE p.PLAN_TYPE
                        WHEN ''关键节点计划''   THEN
                            0
                        WHEN ''项目主项计划''   THEN
                            1
                    END AS PLAN_TYPE_INT,

                    NODE_NAME,
                    p.PLAN_NAME,--计划名称
                    PLAN_START_DATE,
                    PLAN_END_DATE,

                    ACTUAL_END_DATE,
                    ESTIMATE_END_DATE,           --预计完成时间
                    p.PROJ_NAME,          --所属项目
                    p.PLAN_TYPE,        --计划类型显示名
                    DUTY_DEPARTMENT,          --主责部门
                    cp.CHARGE_PERSON,
                    NODE_LEVEL,           --任务等级
                    STANDARD_SCORE          --标准分值
                FROM
                    POM_PROJ_PLAN_NODE n LEFT
                    JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
                    left join (SELECT node_id,LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
                    FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID
                    LEFT JOIN SYS_PROJECT_STAGE sps on p.proj_id=sps.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal
                    ON (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
                    WHERE tal.orgId is not null
                    and p.PLAN_TYPE=''关键节点计划'' AND NVL(n.IS_DISABLE,0) <> 1 and APPROVAL_STATUS=''已审核''
                    AND (p.PROJ_ID=''' || PROJID || ''' OR p.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''' || PROJID || '''))  ' || V_WHERE || '
                )n
                    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID '||v_where_like||' ORDER BY n.PLAN_END_DATE)  a ';

        ELSE
            V_SQL_EXEC := 'select  rownum as rowno,ID,
                    ORIGINAL_NODE_ID,
                    ORIGINAL_PLAN_ID,
                    PROJ_PLAN_ID as PLAN_ID,
                    PLAN_TYPE_INT,
                    NODE_NAME,
                    PLAN_NAME,
                    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
                    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
                    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
                    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
                    case when ACTUAL_END_DATE is null then ''未完成''
                    else ''已完成'' end as COMPLETION_STATUS,
                    PROJ_NAME,
                    PLAN_TYPE,
                    DUTY_DEPARTMENT,
                    CHARGE_PERSON,
                    NODE_LEVEL,
                    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,w_Url,' || V_SQL || ' as NODE_WARNING from (select n.*,w.IS_UN_WATCH
                ,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
                ,case when n.ACTUAL_END_DATE IS NOT NULL THEN NULL
                ELSE ''催办'' END as HASTEN
                ,case when w.IS_UN_WATCH=0 then ''/api/pom/planfollow/unfollow?cancelType=0=724=300=''||ORIGINAL_NODE_ID else ''/pom/biz-watch/bizwatch-setting?cancelType=0=724=300==''||ORIGINAL_NODE_ID end as w_Url

                                      from(SELECT
                    n.ID,
                     p.ORIGINAL_PLAN_ID,
                    ORIGINAL_NODE_ID,
                    n.PROJ_PLAN_ID,
                    CASE p.PLAN_TYPE
                        WHEN ''关键节点计划''   THEN
                            0
                        WHEN ''项目主项计划''   THEN
                            1
                    END AS PLAN_TYPE_INT,

                    NODE_NAME,
                    p.PLAN_NAME,--计划名称
                    PLAN_START_DATE,
                    PLAN_END_DATE,

                    ACTUAL_END_DATE,
                    ESTIMATE_END_DATE,           --预计完成时间
                    p.PROJ_NAME,          --所属项目
                    p.PLAN_TYPE,        --计划类型显示名
                    DUTY_DEPARTMENT,          --主责部门
                    cp.CHARGE_PERSON,
                    NODE_LEVEL,           --任务等级
                    STANDARD_SCORE          --标准分值
                FROM
                    POM_PROJ_PLAN_NODE n LEFT
                    JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
                    left join (SELECT node_id,LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
                    FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID
                    LEFT JOIN SYS_PROJECT_STAGE sps on p.proj_id=sps.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal
                    ON (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
                    WHERE tal.orgId is not null
                    and p.PLAN_TYPE=''关键节点计划'' AND NVL(n.IS_DISABLE,0) <> 1 and APPROVAL_STATUS=''已审核''
                     ' || V_WHERE || '
                )n
                    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID '||v_where_like||' ORDER BY n.PLAN_END_DATE) a ';
        END IF;
        -------------------------------------------------------------------------------------------内容

        V_SQL_EXEC_PAGING := '
select a.* from ( ' || V_SQL_EXEC || ' where rownum <= ' || PAGEINDEX * PAGESIZES || ' ) a where a.rowno > ' || PAGESIZES * (PAGEINDEX - 1) || '';

        DBMS_OUTPUT.PUT_LINE(V_SQL_EXEC);
        ----获取总条数
        EXECUTE IMMEDIATE 'SELECT count(rowno) from(' || V_SQL_EXEC || ') a '
            INTO TOTAL;

        -- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN ITEMS FOR V_SQL_EXEC_PAGING;
        --SELECT '' A FROM DUAL;

    EXCEPTION
        WHEN OTHERS THEN
            TESTMSG := SQLERRM || TESTMSG;
            OPEN ITEMS FOR
                SELECT '失败咯' || TESTMSG PLAN_NAME FROM DUAL;

            DBMS_OUTPUT.PUT_LINE(SQLERRM);
    END;

END P_POM_SMART_KEY_NODE_PLAN_PROJ;
/

prompt
prompt Creating procedure P_POM_SMART_KEY_NODE_PLAN_TBS
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_SMART_KEY_NODE_PLAN_TBS
(
    ORGTYPE   IN VARCHAR2
   , --查询类型，用于判断过滤 0,公司|1,部门|2,项目|3,本人
    CONDITION IN VARCHAR2
   , --输入变量：公司id | 部门id | 项目id | 当前用户ID
    userid        IN            VARCHAR2,--用户id用于过滤关注的任务
    currentcompanyid     IN     VARCHAR2,--当前用户的公司
    currentstationid     IN            VARCHAR2,---当前用户的岗位
    currentdeptid        IN            VARCHAR2,---当前用户的部门
    bizcode       IN            VARCHAR2,---权限code
    searchcondition IN          VARCHAR2,--模糊查询条件
    ITEM      OUT SYS_REFCURSOR
) IS
    --任务中心tabs任务条数统计数据源
    --作者：yedr
    --日期：2019/12/25
    v_spid              VARCHAR2(200);--数据权限验证spid
BEGIN

    --调用数据权限验证存储过程
        P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
    IF CONDITION<>'222' THEN
        OPEN ITEM FOR
            SELECT NVL(SUM(CASE
                               WHEN B.ACTUAL_END_DATE IS NULL
                               AND ( B.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND B.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) ) THEN
                                1
                               ELSE
                                0
                           END), 0) AS ACOUNT,
                   NVL(SUM(CASE
                               WHEN B.ACTUAL_END_DATE IS NULL
                                    AND TRUNC(SYSDATE) > B.PLAN_END_DATE THEN
                                1
                               ELSE
                                0
                           END),
                       0) AS BCOUNT,
                   NVL(SUM(CASE
                               WHEN B.ACTUAL_END_DATE IS NULL THEN
                                1
                               ELSE
                                0
                           END),
                       0) AS CCOUNT,
                   NVL(SUM(CASE
                               WHEN B.ACTUAL_END_DATE IS NOT NULL THEN
                                1
                               ELSE
                                0
                           END),
                       0) AS DCOUNT,
                   COUNT(*) AS ECOUNT
            FROM  POM_PROJ_PLAN_NODE B
            LEFT JOIN  POM_PROJ_PLAN A ON  A.ID = B.PROJ_PLAN_ID
            LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON B.ID=person.NODE_ID
            LEFT JOIN  SYS_PROJECT_STAGE sps on A.proj_id=sps.id
            LEFT JOIN  (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
            on (case when sps.id is not null then sps.PROJECT_ID else A.proj_id end)=tal.orgId
            WHERE
                   tal.orgId is not null and
                   A.APPROVAL_STATUS = '已审核' AND
                   A.PLAN_TYPE = '关键节点计划' AND
                   NVL(B.IS_DISABLE, 0) <> 1 AND
                   (A.PROJ_ID = '' || CONDITION || '' OR A.PROJ_ID IN (SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID = '' || CONDITION || ''))
                   AND (b.node_name like '%'||searchcondition||'%' OR a.plan_name like '%'||searchcondition||'%'
                   OR a.PROJ_NAME like '%'||searchcondition||'%' OR b.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%');
        ELSE
             OPEN ITEM FOR
             SELECT NVL(SUM(CASE
                               WHEN B.ACTUAL_END_DATE IS NULL
                               AND ( B.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND B.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
                               THEN
                                1
                               ELSE
                                0
                           END), 0) AS ACOUNT,
                   NVL(SUM(CASE
                               WHEN B.ACTUAL_END_DATE IS NULL
                                    AND TRUNC(SYSDATE) > B.PLAN_END_DATE THEN
                                1
                               ELSE
                                0
                           END),
                       0) AS BCOUNT,
                   NVL(SUM(CASE
                               WHEN B.ACTUAL_END_DATE IS NULL THEN
                                1
                               ELSE
                                0
                           END),
                       0) AS CCOUNT,
                   NVL(SUM(CASE
                               WHEN B.ACTUAL_END_DATE IS NOT NULL THEN
                                1
                               ELSE
                                0
                           END),
                       0) AS DCOUNT,
                   COUNT(*) AS ECOUNT
            FROM  POM_PROJ_PLAN_NODE B
            LEFT JOIN  POM_PROJ_PLAN A ON  A.ID = B.PROJ_PLAN_ID
            LEFT JOIN (SELECT wm_concat(CHARGE_PERSON) AS CHARGE_PERSON,NODE_ID FROM POM_NODE_CHARGE_PERSON GROUP BY NODE_ID)  person ON B.ID=person.NODE_ID
            LEFT JOIN  SYS_PROJECT_STAGE sps on A.proj_id=sps.id
            LEFT JOIN  (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
            on (case when sps.id is not null then sps.PROJECT_ID else A.proj_id end)=tal.orgId
            WHERE
                   tal.orgId is not null and
                   A.APPROVAL_STATUS = '已审核' AND
                   A.PLAN_TYPE = '关键节点计划' AND
                   NVL(B.IS_DISABLE, 0) <> 1
                  AND (b.node_name like '%'||searchcondition||'%' OR a.plan_name like '%'||searchcondition||'%'
                   OR a.PROJ_NAME like '%'||searchcondition||'%' OR b.DUTY_DEPARTMENT like '%'||searchcondition||'%' OR person.CHARGE_PERSON like '%'||searchcondition||'%');
                  --AND (A.PROJ_ID = '' || CONDITION || '' OR A.PROJ_ID IN (SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID = '' || CONDITION || ''))
        END IF;
END P_POM_SMART_KEY_NODE_PLAN_TBS;
/

prompt
prompt Creating procedure P_POM_SMART_MY_CURRENT_COMPANY
prompt =================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_SMART_MY_CURRENT_COMPANY" (
    companyid     IN            VARCHAR2,--输入变量：公司id
    currentcompanyid     IN     VARCHAR2,--当前用户的公司
	userid        IN            VARCHAR2,--用户id用于过滤关注的任务
    currentstationid     IN            VARCHAR2,---当前用户的岗位
    currentdeptid        IN            VARCHAR2,---当前用户的部门
    bizcode       IN            VARCHAR2,---权限code
    pageindex     IN            INT,
    pagesizes     IN            INT,
    currenttype   IN            VARCHAR2,--完成节点类型(本月任务,超期未完成任务,所有未完成任务,所有已完成任务,所有任务,次月任务,本季度任务,本年任务)
    searchcondition IN          VARCHAR2,--模糊查询条件
    items         OUT           SYS_REFCURSOR,
    total         OUT           INT
--  spiditems         OUT           SYS_REFCURSOR
) IS
--本部门负责的任务
--作者：陈丽
--日期：2019/11/15

    v_sql_start          CLOB;
    v_sql_end            CLOB;
    v_sql_content       CLOB;
    v_sql               CLOB;
    v_sql_exec          CLOB;
    v_sql_exec_paging   CLOB;
    v_where              CLOB;
    v_spid              VARCHAR2(200);--数据权限验证spid
    testmsg             CLOB;
    wwhere          CLOB;
    v_where_like       CLOB;
    company_ids        CLOB;

BEGIN
----------------------------------------------------统一解析
    wwhere := companyid;
    testmsg := 'companyid:'
               || companyid
               || '；pageindex:'
               || pageindex
               || '；pagesizes:'
               || pagesizes
               || '；currenttype:'
               || currenttype;
    --通过id获取三级子公司
    company_ids := 'select sbu.id
        from SYS_BUSINESS_UNIT sbu
        start with sbu.id = ''' || companyid || '''
        connect by prior sbu.id = sbu.PARENT_ID';

    BEGIN
        total := 1000;
        v_sql_start := ' case ';
        v_sql_content := '';
        v_sql_end := '  else '''' end  ';
--调用数据权限验证存储过程
 P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );

-- open  spiditems   for select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = v_spid;
--1.拼接查询语句
        FOR item IN (
            SELECT
                s.expression,
                vv.node_level,
                vv.plan_type
            FROM
                pom_rule_set s
                LEFT JOIN (
                    SELECT
                        MAX(s.created_time) AS t,
                        node_level,
                        plan_type
                    FROM
                        pom_rule_set             s
                        LEFT JOIN pom_rule_set_plan_type   pt ON s.id = pt.rule_id
                    WHERE
                        rule_type = '亮灯规则'
                        --AND plan_type = '关键节点计划'
                        AND s.is_disable = 0
                    GROUP BY
                        node_level,
                        plan_type
                ) vv ON s.created_time = vv.t
                        AND s.node_level = vv.node_level
            WHERE
                vv.t IS NOT NULL
        ) LOOP
    ---拼接字符串
         v_sql_content := v_sql_content
                                || '  when plan_type='''
                                ||
            CASE item.plan_type
                WHEN '项目全景计划' THEN
                    '项目主项计划'
                ELSE item.plan_type
            END
                                || ''' and node_level='''
                                || item.node_level
                                || ''' then ('
                                || item.expression
                                || ')';
        END LOOP;

    --dbms_output.put_line('123333');
    --dbms_output.put_line(v_sql_content);
    --规则内容大于0才拼规则语句

        IF length(v_sql_content) > 0 THEN
            v_sql := v_sql_start
                     || v_sql_content
                     || v_sql_end;
        ELSE
    --无规则亮灯显示空
            v_sql := '''''';
        END IF;

-------------------------------------------------------------------------------------------内容

            IF currenttype = '本月任务' THEN
            v_where := ' and ACTUAL_END_DATE is null and (PLAN_END_DATE>=trunc(sysdate, ''month'') and PLAN_END_DATE<=trunc(last_day(sysdate))) ';
        ELSIF currenttype = '超期未完成任务' THEN
            v_where := ' and sysdate>PLAN_END_DATE  and ACTUAL_END_DATE is null';
        ELSIF currenttype = '所有未完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is null ';
        ELSIF currenttype = '所有已完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is not null ';
        ELSIF currenttype = '所有任务' THEN
            v_where := ' ';
        ELSIF currenttype = '次月任务' THEN
            v_where := ' and (PLAN_END_DATE>=last_day(trunc(sysdate))+1 and PLAN_END_DATE<=last_day(last_day(trunc(sysdate))+1))';
        ELSIF currenttype = '本季度任务' THEN
            v_where := ' and (PLAN_END_DATE>=trunc(sysdate, ''Q'') and PLAN_END_DATE<=add_months(trunc(sysdate, ''Q''), 3) - 1) ';
        ELSIF currenttype = '本年任务' THEN
            v_where := ' and (PLAN_END_DATE>=trunc(sysdate, ''yyyy'') and PLAN_END_DATE<=add_months(trunc(sysdate, ''yyyy''), 12) - 1)  ';
        ELSE
            v_where := ' and 1=2';
        END IF;

        --当输入条件部位空时
        IF searchcondition is not null THEN
          v_where_like := 'WHERE (instr(n.NODE_NAME,'''||searchcondition||''')>0 OR instr(n.PLAN_NAME,'''||searchcondition||''')>0
              OR instr(n.PROJ_NAME,'''||searchcondition||''')>0 OR instr(n.DUTY_DEPARTMENT,'''||searchcondition||''')>0
              OR instr(charge_person,'''||searchcondition||''')>0 )';
        ELSE
          v_where_like := '';
        END IF;

--3.拼接完整语句
IF companyid <> '333' THEN
        v_sql_exec := ' select  rownum as rowno,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
		CHARGE_PERSON,
    NODE_LEVEL,
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,w_Url,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE is null then ''催办''
else null end as HASTEN
,case when w.IS_UN_WATCH=0 then ''/pom/biz-watch/bizwatch-unfollow?cancelType=0&windowWidth=400&windowHeight=70&bizId=''||ORIGINAL_NODE_ID else ''/pom/biz-watch/bizwatch-setting?cancelType=0&windowWidth=724&windowHeight=300&bizId=''||ORIGINAL_NODE_ID end as W_Url

                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    n.ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门
		cp.CHARGE_PERSON,
    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n
		LEFT JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
		left join (SELECT node_id,LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
      FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID
        left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id
        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal
        on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
        WHERE tal.orgid is not null AND (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and APPROVAL_STATUS=''已审核''
		AND	n.IS_DISABLE=0
    and n.COMPANY_ID in ( '
                      || company_ids
                      || ' ) '
                      || v_where
                      || '
UNION ALL
SELECT
    n.ID   AS id,
     p.id as ORIGINAL_PLAN_ID,
    n.ID   AS ORIGINAL_NODE_ID,
    PLAN_ID,
    2 AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    PREDICT_END_DATE,
    ''所属项目'' AS E,
    ''专项计划'' AS F,
    DUTY_DEPARTMENT,
		cp.CHARGE_PERSON,
    ''专项计划级'' AS M,
    0 AS N
FROM
    POM_SPECIAL_PLAN_NODE n
		LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID
		left join (SELECT node_id,LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
        FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID
        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal
        on p.COMPANY_ID in tal.orgid
        WHERE tal.orgid is not null AND APPROVAL_STATUS=''已审核''  AND n.IS_DELETE=0 and p.COMPANY_ID in ( '
                      || company_ids
                      || ' ) '
                      || v_where
                      || '
UNION ALL
    SELECT    n.id,
    p.ORIGINAL_PLAN_ID,
    n.original_node_id,
    dept_monthly_plan_id,
    3 as  PLAN_TYPE_INT,

    node_name,
    p.PLAN_NAME,
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    ''无'' as PROJ_NAME,          --所属项目
    ''部门月度计划'' as  PLAN_TYPE,        --计划类型显示名
    p.DEPT_NAME,          --主责部门
		cp.CHARGE_PERSON,
    node_Type,           --任务等级
    stand_SCORE          --标准分值
FROM
    pom_dept_monthly_plan_node n
    left join pom_dept_monthly_plan p on n.dept_monthly_plan_id=p.id
    left join (SELECT node_id,LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
    FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal
    on p.COMPANY_ID in tal.orgid
    WHERE tal.orgid is not null AND (IS_DEL=0 OR IS_DEL=null) and APPROVE_STATUS=''已审核'' and p.COMPANY_ID in ( '
                      || company_ids
                      || ' ) '
                      || v_where
                      || ')n
    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID '||v_where_like||' ORDER BY n.PLAN_END_DATE) a ';
ELSE
v_sql_exec := ' select  rownum as rowno,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
		CHARGE_PERSON,
    NODE_LEVEL,
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,w_Url,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE is null then ''催办''
else null end as HASTEN
,case when w.IS_UN_WATCH=0 then ''/pom/biz-watch/bizwatch-unfollow?cancelType=0&windowWidth=400&windowHeight=70&bizId=''||ORIGINAL_NODE_ID else ''/pom/biz-watch/bizwatch-setting?cancelType=0&windowWidth=724&windowHeight=300&bizId=''||ORIGINAL_NODE_ID end as W_Url

                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    n.ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门
		cp.CHARGE_PERSON,
    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n
		LEFT JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
		left join (SELECT node_id,LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
        FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID
        left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id
        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal
        on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
        WHERE tal.orgid is not null AND (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and APPROVAL_STATUS=''已审核''
		AND	n.IS_DISABLE=0
         '|| v_where || '
UNION ALL
SELECT
    n.ID   AS id,
     p.id as ORIGINAL_PLAN_ID,
    n.ID   AS ORIGINAL_NODE_ID,
    PLAN_ID,
    2 AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    PREDICT_END_DATE,
    ''所属项目'' AS E,
    ''专项计划'' AS F,
    DUTY_DEPARTMENT,
		cp.CHARGE_PERSON,
    ''专项计划级'' AS M,
    0 AS N
FROM
    POM_SPECIAL_PLAN_NODE n
		LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID
		left join (SELECT node_id,LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
        FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID
        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal
        on p.COMPANY_ID in tal.orgid
        WHERE tal.orgid is not null AND APPROVAL_STATUS=''已审核''  AND n.IS_DELETE=0 '|| v_where || '
UNION ALL
    SELECT    n.id,
    p.ORIGINAL_PLAN_ID,
    n.original_node_id,
    dept_monthly_plan_id,
    3 as  PLAN_TYPE_INT,

    node_name,
    p.PLAN_NAME,
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    ''无'' as PROJ_NAME,          --所属项目
    ''部门月度计划'' as  PLAN_TYPE,        --计划类型显示名
    p.DEPT_NAME,          --主责部门
		cp.CHARGE_PERSON,
    node_Type,           --任务等级
    stand_SCORE          --标准分值
FROM
    pom_dept_monthly_plan_node n
    left join pom_dept_monthly_plan p on n.dept_monthly_plan_id=p.id
    left join (SELECT node_id,LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
    FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal
    on p.COMPANY_ID in tal.orgid
    WHERE tal.orgid is not null AND (IS_DEL=0 OR IS_DEL=null) and APPROVE_STATUS=''已审核'' ' || v_where|| ')n
    left join （SELECT * FROM SYS_BIZ_WATCH w WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID '||v_where_like||' ORDER BY n.PLAN_END_DATE) a  ';
END IF;
-------------------------------------------------------------------------------------------内容

        v_sql_exec_paging := '
select a.* from ( '
                             || v_sql_exec
                             || ' where rownum <= '
                             || pageindex * pagesizes
                             || ' ) a where a.rowno >= '
                             || pagesizes * ( pageindex - 1 )
                             || '';

       -- dbms_output.put_line(v_sql_exec_paging);

				dbms_output.put_line(v_sql_exec_paging);
----获取总条数
        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
                          || v_sql_exec
                          || ') a '
        INTO total;

-- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN items FOR v_sql_exec_paging;
--SELECT '' A FROM DUAL;

    EXCEPTION
        WHEN OTHERS THEN
        testmsg:=sqlerrm||testmsg;
            OPEN items FOR SELECT
                               '失败咯' || testmsg plan_name
                           FROM
                               dual;

           -- dbms_output.put_line(sqlerrm);
    END;

END p_pom_smart_my_current_company;
/

prompt
prompt Creating procedure P_POM_SMART_MY_CURRENT_DEPT
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_SMART_MY_CURRENT_DEPT" (
    userid        IN            VARCHAR,--用户id，用于过滤关注的任务
    deptid        IN            VARCHAR2,--输入变量：部门
    currentcompanyid     IN            VARCHAR2,--当前用户公司
    currentdeptid        IN            VARCHAR2,--当前用户部门
    currentstationid     IN            VARCHAR2,---当前用户的岗位
    bizcode       IN            VARCHAR2,---权限code
    pageindex     IN            INT,
    pagesizes     IN            INT,
    currenttype   IN            VARCHAR2,--完成节点类型(本月任务,超期未完成任务,所有未完成任务,所有已完成任务,所有任务,次月任务,本季度任务,本年任务)
    searchcondition IN          VARCHAR2,
    items         OUT           SYS_REFCURSOR,
    total         OUT           INT
--    auth          OUT           SYS_REFCURSOR
) IS
--本部门负责的任务
--作者：陈丽
--日期：2019/11/15

    v_sql_start          CLOB;
    v_sql_end            CLOB;
    v_sql_content        CLOB;
    v_sql               CLOB;
    v_sql_exec          CLOB;
    v_sql_exec_paging   CLOB;
    v_spid              CLOB;
    deptidwhere         CLOB;
    v_where              CLOB;
    testmsg             CLOB;
--    test_sql        CLOB;
BEGIN
----------------------------------------------------统一解析
--    IF (deptid <> '444') THEN
        deptidwhere := deptid;
--    ELSE
--        deptidwhere := '';
--    END IF;
    --deptidwhere := ''' or ''1''=''1';
    testmsg := 'deptid:'
               || deptid
               || '；pageindex:'
               || pageindex
               || '；pagesizes:'
               || pagesizes
               || '；currenttype:'
               || currenttype;

    BEGIN
        total := 1000;
        v_sql_start := ' case ';
        v_sql_content := '';
        v_sql_end := '  else '''' end  ';

--调用数据权限验证存储过程
 P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
--        test_sql:=' select n.*,orgid  FROM POM_SPECIAL_PLAN_NODE n
--        LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID
--        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=n.DUTY_DEPARTMENT_ID or tal.orgid=n.COMPANY_ID
--
--        WHERE  APPROVAL_STATUS=''已审核'' and n.IS_DELETE=0';
--
--
--        open auth for test_sql;
--1.拼接查询语句
        FOR item IN (
            SELECT
                s.expression,
                vv.node_level,
                vv.plan_type
            FROM
                pom_rule_set s
                LEFT JOIN (
                    SELECT
                        MAX(s.created_time) AS t,
                        node_level,
                        plan_type
                    FROM
                        pom_rule_set             s
                        LEFT JOIN pom_rule_set_plan_type   pt ON s.id = pt.rule_id
                    WHERE
                        rule_type = '亮灯规则'
                       -- AND plan_type != '关键节点计划'
                        AND s.is_disable = 0
                    GROUP BY
                        node_level,
                        plan_type
                ) vv ON s.created_time = vv.t
                        AND s.node_level = vv.node_level
            WHERE
                vv.t IS NOT NULL
        ) LOOP
    ---拼接字符串
         v_sql_content := v_sql_content
                                || '  when plan_type='''
                                ||
            CASE item.plan_type
                WHEN '项目全景计划' THEN
                    '项目主项计划'
                ELSE item.plan_type
            END
                                || ''' and node_level='''
                                || item.node_level
                                || ''' then ('
                                || item.expression
                                || ')';
        END LOOP;

    --dbms_output.put_line('123333');
    --dbms_output.put_line(v_sql_content);
    --规则内容大于0才拼规则语句

        IF length(v_sql_content) > 0 THEN
            v_sql := v_sql_start
                     || v_sql_content
                     || v_sql_end;
        ELSE
    --无规则亮灯显示空
            v_sql := '''''';
        END IF;

-------------------------------------------------------------------------------------------内容

       IF currenttype = '本月任务' THEN
            v_where := ' and ACTUAL_END_DATE is null  and (PLAN_END_DATE>=trunc(sysdate, ''month'') and PLAN_END_DATE<=trunc(last_day(sysdate))) ';
        ELSIF currenttype = '超期未完成任务' THEN
            v_where := ' and sysdate>PLAN_END_DATE and ACTUAL_END_DATE is null';
        ELSIF currenttype = '所有未完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is null ';
        ELSIF currenttype = '所有已完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is not null ';
        ELSIF currenttype = '所有任务' THEN
            v_where := ' ';
        ELSIF currenttype = '次月任务' THEN
            v_where := ' and (PLAN_END_DATE>=last_day(trunc(sysdate))+1 and PLAN_END_DATE<=last_day(last_day(trunc(sysdate))+1))';
        ELSIF currenttype = '本季度任务' THEN
            v_where := ' and (PLAN_END_DATE>=trunc(sysdate, ''Q'') and PLAN_END_DATE<=add_months(trunc(sysdate, ''Q''), 3) - 1) ';
        ELSIF currenttype = '本年任务' THEN
            v_where := ' and (PLAN_END_DATE>=trunc(sysdate, ''yyyy'') and PLAN_END_DATE<=add_months(trunc(sysdate, ''yyyy''), 12) - 1)  ';
        ELSE
            v_where := ' and 1=2';
        END IF;
--3.拼接完整语句
IF (deptid <> '444') THEN
        v_sql_exec := ' select  rownum as rowno,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
    NODE_LEVEL,
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,charge_person,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,charge_person,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE is null then ''催办''
else null end as HASTEN

                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门

    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n LEFT
    JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
   left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id
    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
    WHERE  (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and APPROVAL_STATUS=''已审核''  AND	n.IS_DISABLE=0  and DUTY_DEPARTMENT_ID='''
                      || deptidwhere
                      || ''' '
                      || v_where
                      || '
UNION ALL
SELECT
    n.ID   AS id,
     p.id as ORIGINAL_PLAN_ID,
    n.ID   AS ORIGINAL_NODE_ID,
    PLAN_ID,
    2 AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    PREDICT_END_DATE,
    ''所属项目'' AS E,
    ''专项计划'' AS F,
    DUTY_DEPARTMENT,

    ''专项计划级'' AS M,
    0 AS N
FROM
    POM_SPECIAL_PLAN_NODE n
    LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID
     LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=n.DUTY_DEPARTMENT_ID or tal.orgid=n.COMPANY_ID
     WHERE  p.APPROVAL_STATUS=''已审核'' and n.IS_DELETE=0  and n.DUTY_DEPARTMENT_ID='''
                      || deptidwhere
                      || ''' '
                      || v_where
                      || '
UNION ALL
    SELECT    n.id,
    p.ORIGINAL_PLAN_ID,
    original_node_id,
    dept_monthly_plan_id,
    3 as  PLAN_TYPE_INT,

    node_name,
    p.PLAN_NAME,
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    ''无'' as PROJ_NAME,          --所属项目
    ''部门月度计划'' as  PLAN_TYPE,        --计划类型显示名
    p.DEPT_NAME,          --主责部门

    node_Type,           --任务等级
    stand_SCORE          --标准分值
FROM
    pom_dept_monthly_plan_node n
    left join pom_dept_monthly_plan p on n.dept_monthly_plan_id=p.id
     LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=p.DEPT_ID or tal.orgid=p.COMPANY_ID
     WHERE APPROVE_STATUS=''已审核''   AND n.IS_DEL=0 and DUTY_DEPT_ID='''
                      || deptidwhere
                      || ''' '
                      || v_where
                      || ')n
    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID
    left join (SELECT node_id,
     LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
      FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID WHERE (n.NODE_NAME LIKE ''%'||searchcondition||'%'' OR  n.PLAN_NAME LIKE ''%'||searchcondition||'%''
    OR n.PROJ_NAME LIKE ''%'||searchcondition||'%'' OR n. DUTY_DEPARTMENT LIKE ''%'||searchcondition||'%'' OR cp.charge_person like ''%'||searchcondition||'%'' )  ORDER BY n.PLAN_END_DATE) a ';
else
     v_sql_exec := ' select  rownum as rowno,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
    NODE_LEVEL,
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,charge_person,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,charge_person,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE is null then ''催办''
else null end as HASTEN

                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门

    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n LEFT
    JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
    left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id
    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
    on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
    WHERE (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and APPROVAL_STATUS=''已审核''  AND	n.IS_DISABLE=0 '
                      || v_where
                      || '
UNION ALL
SELECT
    n.ID   AS id,
     p.id as ORIGINAL_PLAN_ID,
    n.ID   AS ORIGINAL_NODE_ID,
    PLAN_ID,
    2 AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    PREDICT_END_DATE,
    ''所属项目'' AS E,
    ''专项计划'' AS F,
    DUTY_DEPARTMENT,

    ''专项计划级'' AS M,
    0 AS N
FROM
    POM_SPECIAL_PLAN_NODE n
    LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID
     LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=n.DUTY_DEPARTMENT_ID or tal.orgid=n.COMPANY_ID
     WHERE  APPROVAL_STATUS=''已审核'' and n.IS_DELETE=0  '
                      || v_where
                      || '
UNION ALL
    SELECT    n.id,
    p.ORIGINAL_PLAN_ID,
    original_node_id,
    dept_monthly_plan_id,
    3 as  PLAN_TYPE_INT,

    node_name,
    p.PLAN_NAME,
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    ''无'' as PROJ_NAME,          --所属项目
    ''部门月度计划'' as  PLAN_TYPE,        --计划类型显示名
    p.DEPT_NAME,          --主责部门

    node_Type,           --任务等级
    stand_SCORE          --标准分值
FROM
    pom_dept_monthly_plan_node n
    left join pom_dept_monthly_plan p on n.dept_monthly_plan_id=p.id
    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''')  tal on tal.orgid=p.DEPT_ID or tal.orgid=p.COMPANY_ID
    WHERE APPROVE_STATUS=''已审核''   AND n.IS_DEL=0  '
                      || v_where
                      || ')n
    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID
    left join (SELECT node_id,
    LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
    FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID WHERE (n.NODE_NAME LIKE ''%'||searchcondition||'%'' OR  n.PLAN_NAME LIKE ''%'||searchcondition||'%''
    OR n.PROJ_NAME LIKE ''%'||searchcondition||'%'' OR n.DUTY_DEPARTMENT LIKE ''%'||searchcondition||'%'' OR cp.charge_person like ''%'||searchcondition||'%'' )  ORDER BY n.PLAN_END_DATE) a ';
end if;
-------------------------------------------------------------------------------------------内容

        v_sql_exec_paging := '
select a.* from ( '
                             || v_sql_exec
                             || ' where rownum <= '
                             || pageindex * pagesizes
                             || ' ) a where a.rowno > '
                             || pagesizes * ( pageindex - 1 )
                             || '';

        dbms_output.put_line(v_sql_exec_paging);
----获取总条数
        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
                          || v_sql_exec
                          || ') a '
        INTO total;

-- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN items FOR v_sql_exec_paging;
--SELECT '' A FROM DUAL;

    EXCEPTION
        WHEN OTHERS THEN
            testmsg := sqlerrm || testmsg;
            OPEN items FOR SELECT
                               '失败咯' || testmsg plan_name
                           FROM
                               dual;

            dbms_output.put_line(sqlerrm);
    END;

END p_pom_smart_my_current_dept;
/

prompt
prompt Creating procedure P_POM_SMART_MY_CURRENT_PERSON
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_SMART_MY_CURRENT_PERSON" (
    userid        IN            VARCHAR2,--输入变量：用户ID
    pageindex     IN            INT,
    pagesizes     IN            INT,
    currenttype   IN            VARCHAR2,--完成节点类型（所有未完成，超期未完成，所有已完成）
    searchcondition IN          VARCHAR2,
    items         OUT           SYS_REFCURSOR,
    total         OUT           INT
) IS
--我负责的任务  关键节点计划、项目主项计划、专项计划
--作者：陈丽
--日期：2019/11/15
    v_sql_start          CLOB;
    v_sql_end           CLOB;
    v_sql_content        CLOB;
    v_sql               CLOB;
    v_sql_exec          CLOB;
    v_sql_exec_paging   CLOB;
    v_where              CLOB;
    testmsg             CLOB;
    v_where_like       CLOB;
BEGIN
    total := 1000;
    v_sql_start := ' case ';
    v_sql_content := '';
    v_sql_end := '  else '''' end  ';
    BEGIN

--1.拼接查询语句
        FOR item IN (
            SELECT
                s.expression,
                vv.node_level,
                vv.plan_type
            FROM
                pom_rule_set s
                LEFT JOIN (
                    SELECT
                        MAX(s.created_time) AS t,
                        node_level,
                        plan_type
                    FROM
                        pom_rule_set             s
                        LEFT JOIN pom_rule_set_plan_type   pt ON s.id = pt.rule_id
                    WHERE
                        rule_type = '亮灯规则'
                        --AND plan_type != '关键节点计划'
                        AND s.is_disable = 0
                    GROUP BY
                        node_level,
                        plan_type
                ) vv ON s.created_time = vv.t
                        AND s.node_level = vv.node_level
            WHERE
                vv.t IS NOT NULL
        ) LOOP
    ---拼接字符串
         v_sql_content := v_sql_content
                                || '  when plan_type='''
                                ||
            CASE item.plan_type
                WHEN '项目全景计划' THEN
                    '项目主项计划'
                ELSE item.plan_type
            END
                                || ''' and node_level='''
                                || item.node_level
                                || ''' then ('
                                || item.expression
                                || ')';
        END LOOP;

    --dbms_output.put_line('123333');
    --dbms_output.put_line(v_sql_content);
    --规则内容大于0才拼规则语句

        IF length(v_sql_content) > 0 THEN
            v_sql := v_sql_start
                     || v_sql_content
                     || v_sql_end;
        ELSE
    --无规则亮灯显示空
            v_sql := '''''';
        END IF;
-------------------------------------------------------------------------------------------内容

        IF currenttype = '所有未完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is null';
        ELSIF currenttype = '超期未完成任务' THEN
            v_where := ' and sysdate>PLAN_END_DATE  and ACTUAL_END_DATE is null';
        ELSIF currenttype = '所有已完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is not null ';
        ELSE
            v_where := '';
        END IF;

        --当输入条件不为空时
        IF searchcondition is not null THEN
          v_where_like := 'WHERE (instr(n.NODE_NAME,'''||searchcondition||''')>0 OR instr(n.PLAN_NAME,'''||searchcondition||''')>0
              OR instr(n.PROJ_NAME,'''||searchcondition||''')>0 OR instr(n.DUTY_DEPARTMENT,'''||searchcondition||''')>0
              OR instr(n.charge_person,'''||searchcondition||''')>0 )';
        ELSE
          v_where_like := '';
        END IF;

--3.拼接完整语句

        v_sql_exec := ' select  rownum as rowno,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
    NODE_LEVEL,
		CHARGE_PERSON,
    STANDARD_SCORE ,WACTH,HASTEN,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,''关注'' as WACTH,''催办'' as HASTEN from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    n.ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    n.NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门
		person.CHARGE_PERSON,
    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n
		LEFT JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
		LEFT JOIN POM_NODE_CHARGE_PERSON person ON n.ID=person.NODE_ID
		WHERE (p.PLAN_TYPE=''项目主项计划'' OR p.PLAN_TYPE=''关键节点计划'') AND n.IS_DISABLE=0  and APPROVAL_STATUS=''已审核''
		AND CHARGE_PERSON_ID='''||userid||'''  '
                      || v_where
                      || '
UNION ALL
SELECT
    n.ID   AS id,
     p.id as ORIGINAL_PLAN_ID,
    n.ID   AS ORIGINAL_NODE_ID,
    PLAN_ID,
    2 AS PLAN_TYPE_INT,
    n.NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    PREDICT_END_DATE,
    ''所属项目'' AS E,
    ''专项计划'' AS F,
    DUTY_DEPARTMENT,
		person.CHARGE_PERSON,
    ''专项计划级'' AS M,
    0 AS N
FROM
    POM_SPECIAL_PLAN_NODE n
		LEFT JOIN POM_SPECIAL_PLAN p ON n.PLAN_ID = p.ID
		LEFT JOIN POM_NODE_CHARGE_PERSON person ON n.ID=person.NODE_ID
		where n.IS_DELETE=0 AND APPROVAL_STATUS=''已审核''
		AND CHARGE_PERSON_ID='''||userid||'''  '
                      || v_where
                      || '
UNION ALL
    SELECT    n.id,
    p.ORIGINAL_PLAN_ID,
    n.original_node_id,
    dept_monthly_plan_id,
    3 as  PLAN_TYPE_INT,

    n.node_name,
    p.PLAN_NAME,
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    ''无'' as PROJ_NAME,          --所属项目
    ''部门月度计划'' as  PLAN_TYPE,        --计划类型显示名
    p.DEPT_NAME,          --主责部门
		person.CHARGE_PERSON,
    node_Type,           --任务等级
    stand_SCORE          --标准分值
FROM
    pom_dept_monthly_plan_node n
    left join pom_dept_monthly_plan p on n.dept_monthly_plan_id=p.id
		LEFT JOIN POM_NODE_CHARGE_PERSON person ON n.ID=person.NODE_ID
    where n.IS_DEL=0 and APPROVE_STATUS=''已审核''
		AND CHARGE_PERSON_ID='''||userid||'''  '
                      || v_where
                      || ')n '||v_where_like||'
   ORDER BY n.PLAN_END_DATE  ) a  ';-- left join POM_NODE_CHARGE_PERSON cp on n.id=cp.NODE_ID where CHARGE_PERSON_ID='''||userid||'''
-------------------------------------------------------------------------------------------内容

       -- dbms_output.put_line(v_sql_exec);
        v_sql_exec_paging := '
select a.* from ( '
                             || v_sql_exec
                             || ' where rownum <= '
                             || pageindex * pagesizes
                             || ' ) a where a.rowno > '
                             || pagesizes * ( pageindex - 1 )
                             || '';
----获取总条数

        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
                          || v_sql_exec
                          || ') a '
        INTO total;
        dbms_output.put_line(v_sql_exec_paging);
-- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN items FOR v_sql_exec_paging;
--SELECT '' A FROM DUAL;

    EXCEPTION
        WHEN OTHERS THEN
            OPEN items FOR SELECT
                               '失败咯' || testmsg plan_name
                           FROM
                               dual;

            dbms_output.put_line(sqlerrm);
    END;

END p_pom_smart_my_current_person;
/

prompt
prompt Creating procedure P_POM_SMART_MY_CURRENT_PROJ
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_SMART_MY_CURRENT_PROJ" (
    projid        IN            VARCHAR2,--输入变量：项目
    userid        IN 			VARCHAR2,--用户id，用于过滤关注的任务
    currentcompanyid     IN            VARCHAR2,--当前用户公司
    currentdeptid        IN            VARCHAR2,--当前用户部门
    currentstationid     IN            VARCHAR2,---当前用户的岗位
    bizcode       IN            VARCHAR2,---权限code
    pageindex     IN            INT,
    pagesizes     IN            INT,
    currenttype   IN            VARCHAR2,--完成节点类型(本月任务,超期未完成任务,所有未完成任务,所有已完成任务,所有任务,次月任务,本季度任务,本年任务)
    searchcondition IN          VARCHAR2,--模糊查询条件
    items         OUT           SYS_REFCURSOR,
    total         OUT           INT
) IS
--本部门负责的任务
--作者：陈丽
--日期：2019/11/15

    v_sql_start          CLOB;
    v_sql_end            CLOB;
    v_sql_content        CLOB;
    v_sql               CLOB;
    v_sql_exec          CLOB;
    v_sql_exec_paging   CLOB;
    v_where              CLOB;
    v_spid              CLOB;
    testmsg              CLOB;
    v_where_like       CLOB;
BEGIN
----------------------------------------------------统一解析
    testmsg := 'projid:'
               || projid
               || '；pageindex:'
               || pageindex
               || '；pagesizes:'
               || pagesizes
               || '；currenttype:'
               || currenttype;

    BEGIN
        total := 1000;
        v_sql_start := ' case ';
        v_sql_content := '';
        v_sql_end := '  else '''' end  ';

--调用数据权限验证存储过程
 P_SYS_AUTH_DATA_RULE_SPID(
            USERID => userid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
--1.拼接查询语句
        FOR item IN (
            SELECT
                s.expression,
                vv.node_level,
                vv.plan_type
            FROM
                pom_rule_set s
                LEFT JOIN (
                    SELECT
                        MAX(s.created_time) AS t,
                        node_level,
                        plan_type
                    FROM
                        pom_rule_set             s
                        LEFT JOIN pom_rule_set_plan_type   pt ON s.id = pt.rule_id
                    WHERE
                        rule_type = '亮灯规则'
                       -- AND plan_type != '关键节点计划'
                        AND s.is_disable = 0
                    GROUP BY
                        node_level,
                        plan_type
                ) vv ON s.created_time = vv.t
                        AND s.node_level = vv.node_level
            WHERE
                vv.t IS NOT NULL
        ) LOOP
    ---拼接字符串
         v_sql_content := v_sql_content
                                || '  when plan_type='''
                                ||
            CASE item.plan_type
                WHEN '项目全景计划' THEN
                    '项目主项计划'
                ELSE item.plan_type
            END
                                || ''' and node_level='''
                                || item.node_level
                                || ''' then ('
                                || item.expression
                                || ')';
        END LOOP;

    --dbms_output.put_line('123333');
    --dbms_output.put_line(v_sql_content);
    --规则内容大于0才拼规则语句

        IF length(v_sql_content) > 0 THEN
            v_sql := v_sql_start
                     || v_sql_content
                     || v_sql_end;
        ELSE
    --无规则亮灯显示空
            v_sql := '''''';
        END IF;

-------------------------------------------------------------------------------------------内容


       IF currenttype = '本月任务' THEN
            v_where := ' and ACTUAL_END_DATE is null and (PLAN_END_DATE>=trunc(sysdate, ''month'') and PLAN_END_DATE<=trunc(last_day(sysdate))) ';
        ELSIF currenttype = '超期未完成任务' THEN
            v_where := ' and sysdate>PLAN_END_DATE and ACTUAL_END_DATE is null';
        ELSIF currenttype = '所有未完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is null ';
        ELSIF currenttype = '所有已完成任务' THEN
            v_where := ' and ACTUAL_END_DATE is not null ';
        ELSIF currenttype = '所有任务' THEN
            v_where := ' ';
        ELSIF currenttype = '次月任务' THEN
            v_where := ' and (PLAN_END_DATE>=last_day(trunc(sysdate))+1 and PLAN_END_DATE<=last_day(last_day(trunc(sysdate))+1))';
        ELSIF currenttype = '本季度任务' THEN
            v_where := ' and (PLAN_END_DATE>=trunc(sysdate, ''Q'') and PLAN_END_DATE<=add_months(trunc(sysdate, ''Q''), 3) - 1) ';
        ELSIF currenttype = '本年任务' THEN
            v_where := ' and (PLAN_END_DATE>=trunc(sysdate, ''yyyy'') and PLAN_END_DATE<=add_months(trunc(sysdate, ''yyyy''), 12) - 1)  ';
        ELSE
            v_where := ' and 1=2';
        END IF;

        --当输入条件部位空时
        IF searchcondition is not null THEN
          v_where_like := 'WHERE (instr(n.NODE_NAME,'''||searchcondition||''')>0 OR instr(n.PLAN_NAME,'''||searchcondition||''')>0
              OR instr(n.PROJ_NAME,'''||searchcondition||''')>0 OR instr(n.DUTY_DEPARTMENT,'''||searchcondition||''')>0
              OR instr(cp.charge_person,'''||searchcondition||''')>0 )';
        ELSE
          v_where_like := '';
        END IF;

--3.拼接完整语句
if projid <> '111' then
        v_sql_exec := ' select  rownum as rowno,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
		CHARGE_PERSON,
    NODE_LEVEL,
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,w_Url,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,charge_person,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE is null then ''催办''
else null end as HASTEN
,case when w.IS_UN_WATCH=0 then ''/api/pom/planfollow/unfollow?cancelType=0&windowWidth=724&windowHeight=300&bizId=''||ORIGINAL_NODE_ID else ''/pom/biz-watch/bizwatch-setting?cancelType=0&windowWidth=724&windowHeight=300&bizId=&bizId=''||ORIGINAL_NODE_ID end as w_Url

                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    n.ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门
    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n
		LEFT JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
        left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id
        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
        on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
        WHERE tal.orgid is not null AND (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and APPROVAL_STATUS=''已审核''
		AND n.IS_DISABLE=0
		AND (p.PROJ_ID='''||projid||''' OR p.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID='''||projid||'''))  '||v_where||'
)n
    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID
    left join (SELECT node_id,
    LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
    FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID '||v_where_like||' ORDER BY n.PLAN_END_DATE) a ';
else
    v_sql_exec := ' select  rownum as rowno,ID,
    ORIGINAL_NODE_ID,

    ORIGINAL_PLAN_ID,
    PROJ_PLAN_ID as PLAN_ID,
    PLAN_TYPE_INT,
    NODE_NAME,
    PLAN_NAME,
    TO_CHAR(PLAN_START_DATE, ''YYYY-MM-DD'') PLAN_START_DATE ,
    TO_CHAR(PLAN_END_DATE, ''YYYY-MM-DD'') PLAN_END_DATE,
    TO_CHAR(ACTUAL_END_DATE, ''YYYY-MM-DD'') ACTUAL_END_DATE,
    TO_CHAR(ESTIMATE_END_DATE, ''YYYY-MM-DD'') PREDICT_END_DATE,
    case when ACTUAL_END_DATE is null then ''未完成''
    else ''已完成'' end as COMPLETION_STATUS,
    PROJ_NAME,
    PLAN_TYPE,
    DUTY_DEPARTMENT,
		CHARGE_PERSON,
    NODE_LEVEL,
    STANDARD_SCORE ,WACTH,HASTEN,IS_UN_WATCH,w_Url,'
                      || v_sql
                      || ' as NODE_WARNING from (select n.*,charge_person,w.IS_UN_WATCH
,case when w.IS_UN_WATCH=0 then ''取关'' else ''关注'' end as WACTH
,case when n.ACTUAL_END_DATE is null then ''催办''
else null end as HASTEN
,case when w.IS_UN_WATCH=0 then ''/api/pom/planfollow/unfollow?cancelType=0&windowWidth=724&windowHeight=300&bizId=''||ORIGINAL_NODE_ID else ''/pom/biz-watch/bizwatch-setting?cancelType=0&windowWidth=724&windowHeight=300&bizId=&bizId=''||ORIGINAL_NODE_ID end as w_Url

                      from(SELECT
    n.ID,
     p.ORIGINAL_PLAN_ID,
    n.ORIGINAL_NODE_ID,
    n.PROJ_PLAN_ID,
    CASE p.PLAN_TYPE
        WHEN ''关键节点计划''   THEN
            0
        WHEN ''项目主项计划''   THEN
            1
    END AS PLAN_TYPE_INT,

    NODE_NAME,
    p.PLAN_NAME,--计划名称
    PLAN_START_DATE,
    PLAN_END_DATE,

    ACTUAL_END_DATE,
    ESTIMATE_END_DATE,           --预计完成时间
    p.PROJ_NAME,          --所属项目
    p.PLAN_TYPE,        --计划类型显示名
    DUTY_DEPARTMENT,          --主责部门
    NODE_LEVEL,           --任务等级
    STANDARD_SCORE          --标准分值
FROM
    POM_PROJ_PLAN_NODE n
		LEFT JOIN POM_PROJ_PLAN p ON n.PROJ_PLAN_ID = p.ID
		left join SYS_PROJECT_STAGE sps on p.proj_id=sps.id
        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = '''||v_spid||''') tal
        on (case when sps.id is not null then sps.PROJECT_ID else p.proj_id end)=tal.orgId
        WHERE tal.orgid is not null AND (p.PLAN_TYPE=''项目主项计划'' or p.PLAN_TYPE=''关键节点计划'') and APPROVAL_STATUS=''已审核''
		AND n.IS_DISABLE=0
		  '||v_where||'
)n
    left join (SELECT * FROM SYS_BIZ_WATCH WHERE WATCHER_ID='''||userid||''') w on n.ORIGINAL_NODE_ID=w.BIZ_ID
    left join (SELECT node_id,
    LISTAGG( to_char(charge_person), '','') WITHIN GROUP(ORDER BY charge_person) AS charge_person
    FROM POM_NODE_CHARGE_PERSON group by node_id) cp on n.id=cp.NODE_ID '||v_where_like||' ORDER BY n.PLAN_END_DATE) a ';
end if;
-------------------------------------------------------------------------------------------内容

        v_sql_exec_paging := '
select a.* from ( '
                             || v_sql_exec
                             || ' where rownum <= '
                             || pageindex * pagesizes
                             || ' ) a where a.rowno > '
                             || pagesizes * ( pageindex - 1 )
                             || '';

        dbms_output.put_line(v_sql_exec_paging);
----获取总条数
        EXECUTE IMMEDIATE 'SELECT count(rowno) from('
                          || v_sql_exec
                          || ') a '
        INTO total;

-- execute immediate 'SELECT ' || v_sql_exec ||' FROM dual' into nodes;
        OPEN items FOR v_sql_exec_paging;
--SELECT '' A FROM DUAL;

    EXCEPTION
        WHEN OTHERS THEN
        testmsg:=sqlerrm||testmsg;
            OPEN items FOR SELECT
                               '失败咯' || testmsg plan_name
                           FROM
                               dual;

            dbms_output.put_line(sqlerrm);
    END;

END p_pom_smart_my_current_proj;
/

prompt
prompt Creating procedure P_POM_SMART_PROJECT_PLAN_DEL
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_SMART_PROJECT_PLAN_DEL"
(
		PLANID  IN VARCHAR2
	 , --输入变量：规则id
		TYPE    IN VARCHAR2
	 , --0删除前验证，1执行删除
		ERRMSG  OUT VARCHAR2
	 , --提示消息
		ERRCODE OUT INT --0成功，1失败
) IS
		--规则删除
		--作者：鲜晓勇
		--日期：2019/11/27
		COUNTDTL    INT;
		TESTMSG     NVARCHAR2(200);
		ERRORCOUNT  INT;
		HIDDLECOUNT INT;
BEGIN
		BEGIN
				ERRORCOUNT := 0;
				TESTMSG    := 'planid:' || PLANID || '.type:' || TYPE;
				COUNTDTL   := 0;
				IF LENGTH(PLANID) < 36 THEN
						RAISE_APPLICATION_ERROR(-20000, '请选择要删除的计划' || TESTMSG);
				END IF;
				--循环规则id
				-------------------------------------------------------
				-------------------------------------------------------
				IF (TYPE = 1) THEN
						FOR ITEM IN (SELECT REGEXP_SUBSTR('' || PLANID || '', '[^,]+', 1,
																							 ROWNUM) AS ID
												 FROM   DUAL
												 CONNECT BY ROWNUM <=
																		LENGTH('' || PLANID || '') -
																		LENGTH(REGEXP_REPLACE('' || PLANID || '',
																													',', '')) + 1)
						LOOP
								---删除计划
								DELETE POM_PROJ_PLAN WHERE ID = '' || ITEM.ID || '';
						
								COUNTDTL := COUNTDTL + 1;
						END LOOP;
						ERRCODE := 0;
						ERRMSG  := '删除成功！' || COUNTDTL || '条计划';
				ELSIF (TYPE = 0) THEN
						FOR ITEM IN (SELECT REGEXP_SUBSTR('' || PLANID || '', '[^,]+', 1,
																							 ROWNUM) AS ID
												 FROM   DUAL
												 CONNECT BY ROWNUM <=
																		LENGTH('' || PLANID || '') -
																		LENGTH(REGEXP_REPLACE('' || PLANID || '',
																													',', '')) + 1)
						LOOP
								SELECT COUNT(ID)
								INTO   HIDDLECOUNT
								FROM   POM_PROJ_PLAN
								WHERE  ID = '' || ITEM.ID || '' AND
											 APPROVAL_STATUS = '已审核';
								ERRORCOUNT := ERRORCOUNT + HIDDLECOUNT;
						END LOOP;
						IF ERRORCOUNT > 0 THEN
								ERRCODE := 1;
								ERRMSG  := '存在已审核的计划！';
						ELSE
								ERRCODE := 0;
								ERRMSG  := '验证通过！';
						END IF;
				END IF;
		
		EXCEPTION
				WHEN OTHERS THEN
						ERRCODE := 1;
						ERRMSG  := SQLERRM;
		END;
END P_POM_SMART_PROJECT_PLAN_DEL;
/

prompt
prompt Creating procedure P_POM_SMART_PROJ_PLAN_DEL
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_SMART_PROJ_PLAN_DEL" (
    planid    IN        VARCHAR2,--输入变量：规则id
    type      IN        VARCHAR2,--0删除前验证，1执行删除,2调整验证
    errmsg    OUT       VARCHAR2,--提示消息
    errcode   OUT       INT--0成功，1失败
) IS
--规则删除
--作者：鲜晓勇 
--日期：2019/11/27
    countdtl   INT;
    testmsg    NVARCHAR2(200);
    errorCount INT;
     hiddleCount INT;
BEGIN
    BEGIN
                 errorCount := 0;
        testmsg := 'planid:'
                   || planid
                   || '.type:'
                   || type;
        countdtl := 0;
        IF length(planid) < 36 THEN
            raise_application_error(-20000, '请选择要删除的计划');
        END IF;
--循环计划id
-------------------------------------------------------
-------------------------------------------------------
        IF ( type = 1 ) THEN
            FOR item IN (
                SELECT
                    regexp_substr(''
                                  || planid
                                  || '', '[^,]+', 1, ROWNUM) AS id
                FROM
                    dual
                CONNECT BY
                    ROWNUM <= length(''
                                     || planid
                                     || '') - length(regexp_replace(''
                                                                    || planid
                                                                    || '', ',', '')) + 1
            ) LOOP 
    ---删除计划
                DELETE pom_proj_plan 
                WHERE
                    id = ''
                         || item.id
                         || '';

                DELETE pom_proj_plan_node 
                WHERE
                    PROJ_PLAN_ID = ''
                                   || item.id
                                   || '';

                countdtl := countdtl + 1;
            END LOOP;
            errcode := 0;
            errmsg := '删除成功！'
                      || countdtl
                      || '条计划';
        ELSIF ( type = 0 ) THEN
               FOR item IN (
                SELECT
                    regexp_substr(''
                                  || planid
                                  || '', '[^,]+', 1, ROWNUM) AS id
                FROM
                    dual
                CONNECT BY
                    ROWNUM <= length(''
                                     || planid
                                     || '') - length(regexp_replace(''
                                                                    || planid
                                                                    || '', ',', '')) + 1
            ) LOOP          
        SELECT
            COUNT(id)
        INTO hiddleCount
        FROM
            pom_proj_Plan
        WHERE
            id = ''
                        || item.id
                        || '' and (APPROVAL_STATUS='已审核' or APPROVAL_STATUS='审核中');
               errorCount:=errorCount+hiddleCount;
            END LOOP; 
              IF errorCount > 0 THEN
              errcode := 1;
            errmsg := '只允许删除未审核状态的计划！';
            ELSE
            errcode := 0;
            errmsg := '';
            END IF;

        ELSIF ( type = 2 ) THEN
        IF length(planid)>36 THEN
        errcode:=1;
        errmsg:='一次只允许调整一条计划';
        ELSE 
         SELECT COUNT(id) INTO hiddleCount FROM POM_PROJ_PLAN WHERE APPROVAL_STATUS <>'已审核' AND ID=''|| planid;
         IF hiddleCount>0 THEN
          errcode:=1;
          errmsg:='该计划还未审批,请将计划审批完成后再调整！';
          ELSE
          errcode:=0;
          errmsg:='';
          END IF;
        END IF;

    END IF;

    EXCEPTION
        WHEN OTHERS THEN
            errcode := 1;
            errmsg := sqlerrm;
    END;
END p_pom_smart_proj_plan_del;
/

prompt
prompt Creating procedure P_POM_SMART_RULE_SET_DEL
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_SMART_RULE_SET_DEL
(
		RULEID  IN VARCHAR2
	 , --输入变量：规则id
		TYPE    IN VARCHAR2
	 , --0删除前验证，1执行删除
		ERRMSG  OUT VARCHAR2
	 , --提示消息
		ERRCODE OUT INT --0成功，1失败
) IS
		--规则删除
		--作者：陈丽
		--日期：2019/11/17
		COUNTDTL INT;
		TESTMSG  NVARCHAR2(4000);
BEGIN
		BEGIN
				TESTMSG  := 'ruleid:' || RULEID || '.type:' || TYPE;
				COUNTDTL := 0;
				IF LENGTH(RULEID) < 36 THEN
						RAISE_APPLICATION_ERROR(-20000, '请选择要删除的规则' || TESTMSG);
				END IF;
				--循环规则id
		
				IF (TYPE = 1) THEN
						FOR ITEM IN (SELECT REGEXP_SUBSTR('' || RULEID || '', '[^,]+', 1,
																							 ROWNUM) AS ID
												 FROM   DUAL
												 CONNECT BY ROWNUM <=
																		LENGTH('' || RULEID || '') -
																		LENGTH(REGEXP_REPLACE('' || RULEID || '',
																													',', '')) + 1)
						LOOP
								---删除规则
								DELETE POM_RULE_SET WHERE ID = '' || ITEM.ID || '';
						
								COUNTDTL := COUNTDTL + 1;
						END LOOP;
				
						ERRCODE := 0;
						ERRMSG  := '删除成功！' || COUNTDTL || '条规则';
				ELSIF (TYPE = 0) THEN
						ERRCODE := 0;
						ERRMSG  := '验证通过！';
				END IF;
		
		EXCEPTION
				WHEN OTHERS THEN
						ERRCODE := 1;
						ERRMSG  := SQLERRM;
		END;
END P_POM_SMART_RULE_SET_DEL;
/

prompt
prompt Creating procedure P_POM_SMART_RULE_SET_STATE
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_smart_rule_set_state (
    ruleid      IN          VARCHAR2,--输入变量：规则id
    statetype   IN          INT,--0生效，1失效
    errmsg      OUT         VARCHAR2,--提示消息
    errcode     OUT         INT--0成功，1失败
) IS
--规则生效失效设置
--作者：陈丽
--日期：2019/11/17
    typemsg    VARCHAR2(50);
    ruleids    VARCHAR2(4000);
    countdtl   INT;
     testmsg NVARCHAR2(4000);
		 statuscount NUMBER;
BEGIN
    BEGIN
        testmsg:='ruleid:'||ruleid||'.statetype:'||statetype;
        countdtl := 0;
        IF statetype = 0 THEN
            typemsg := '生效';
        ELSE
            typemsg := '失效';
        END IF;

        IF length(ruleid) < 36 THEN
            raise_application_error(-20000, '请选择要'
                                            || typemsg
                                            || '的规则'||testmsg);
        END IF;



--循环规则id

        FOR item IN (
            SELECT
                regexp_substr(''
                              || ruleid
                              || '', '[^,]+', 1, ROWNUM) AS id
            FROM
                dual
            CONNECT BY
                ROWNUM <= length(''
                                 || ruleid
                                 || '') - length(regexp_replace(''
                                                                || ruleid
                                                                || '', ',', '')) + 1
        ) LOOP 
    ---拼接字符串
		  ruleids := ruleids || item.id;
			SELECT COUNT(is_disable) INTO statuscount  FROM pom_rule_set WHERE ID='' || item.id || '' AND is_disable=statetype ;
			IF(statuscount>0) THEN
				errcode := 1;
				errmsg := '已有'''||typemsg||'''的规则，请选择相同状态的数据进行操作';
				return;
			ELSE 
					UPDATE pom_rule_set 
					SET is_disable = statetype 
					WHERE
						id = '' || item.id || '';
					countdtl := countdtl + 1;
			END IF;


--             UPDATE pom_rule_set
--             SET
--                 is_disable = statetype
--             WHERE
--                 id = ''
--                      || item.id
--                      || '';
-- 
--             countdtl := countdtl + 1;
        END LOOP;

        errcode := 0;
        errmsg := typemsg
                  || '设置成功！'
                  || countdtl
                  || '条规则';
    EXCEPTION
        WHEN OTHERS THEN
            errcode := 1;
            errmsg := sqlerrm;
    END;
END p_pom_smart_rule_set_state;
/

prompt
prompt Creating procedure P_POM_SMART_SPECIALTEMP_DEL
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_smart_specialtemp_del ( templateid IN VARCHAR2, --输入变量：专项计划模板ID
		type IN VARCHAR2, 
		errmsg OUT VARCHAR2, --提示消息
		errcode OUT INT --0成功，1失败
	) IS --专项计划模板删除
--作者：叶丁荣
--日期：2019/11/21
	hiddleCount INT;
BEGIN
	BEGIN
		IF
			length( templateid ) < 36 THEN
				raise_application_error ( - 20000, '请选择要删除的模板' );

		END IF;
		IF
			( type = 1 ) THEN
-- 				DELETE POM_SPECIAL_TEMPLATE 
-- 			WHERE
-- 				id = ''||templateid||'';
-- 			errcode := 0;
-- 			errmsg := '删除成功！';
-- 			


				SELECT
				COUNT( ID ) INTO hiddleCount 
			FROM
				POM_SPECIAL_TEMPLATE 
			WHERE
				ID = ''||templateid||'' 
				AND TEMPLATE_STATUS = '正式';
			IF
				( hiddleCount > 0 ) THEN
					errcode := 1;
				errmsg := '已发布的计划模板不允许删除！';
				ELSE errcode := 0;
				errmsg := '';

			END IF;
			ELSE
							DELETE POM_SPECIAL_TEMPLATE 
			WHERE
				id = ''||templateid||'';
			errcode := 0;
			errmsg := '删除成功！';


		END IF;
		EXCEPTION 
			WHEN OTHERS THEN
			errcode := 1;
		errmsg := sqlerrm;

	END;

END p_pom_smart_specialtemp_del;
/

prompt
prompt Creating procedure P_POM_SMART_SPECIAL_PLAN_DEL
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_SMART_SPECIAL_PLAN_DEL" (
    planid    IN        VARCHAR2,--输入变量：规则id
    type      IN        VARCHAR2,--0删除前验证，1执行删除,2 调整验证
    errmsg    OUT       VARCHAR2,--提示消息
    errcode   OUT       INT--0成功，1失败
) IS
--规则删除
--作者：鲜晓勇 
--日期：2019/11/27
    countdtl   INT;
    testmsg    NVARCHAR2(200);
    errorCount INT;
     hiddleCount INT;
BEGIN
    BEGIN
                 errorCount := 0;
        testmsg := 'planid:'
                   || planid
                   || '.type:'
                   || type;
        countdtl := 0;
        IF length(planid) < 36 THEN
            raise_application_error(-20000, '请选择要删除的计划');
        END IF;
--循环计划id
-------------------------------------------------------
-------------------------------------------------------
        IF ( type = 1 ) THEN
            FOR item IN (
                SELECT
                    regexp_substr(''
                                  || planid
                                  || '', '[^,]+', 1, ROWNUM) AS id
                FROM
                    dual
                CONNECT BY
                    ROWNUM <= length(''
                                     || planid
                                     || '') - length(regexp_replace(''
                                                                    || planid
                                                                    || '', ',', '')) + 1
            ) LOOP 
    ---删除计划
                DELETE POM_SPECIAL_PLAN 
                WHERE
                    id = ''
                         || item.id
                         || '';

                DELETE POM_SPECIAL_PLAN_NODE
                WHERE
                    PLAN_ID = ''
                         || item.id
                         || '';

                countdtl := countdtl + 1;
            END LOOP;
            errcode := 0;
            errmsg := '删除成功！'
                      || countdtl
                      || '条计划';
        ELSIF ( type = 0 ) THEN
               FOR item IN (
                SELECT
                    regexp_substr(''
                                  || planid
                                  || '', '[^,]+', 1, ROWNUM) AS id
                FROM
                    dual
                CONNECT BY
                    ROWNUM <= length(''
                                     || planid
                                     || '') - length(regexp_replace(''
                                                                    || planid
                                                                    || '', ',', '')) + 1
            ) LOOP          
        SELECT
            COUNT(id)
        INTO hiddleCount
        FROM
            POM_SPECIAL_PLAN
        WHERE
            id = ''
                        || item.id
                        || '' and (APPROVAL_STATUS='已审核' or APPROVAL_STATUS='审核中');
               errorCount:=errorCount+hiddleCount;
            END LOOP; 
              IF errorCount > 0 THEN
              errcode := 1;
            errmsg := '只允许删除未审核状态的计划！';
            ELSE
            errcode := 0;
            errmsg := '';
            END IF;
        ELSIF ( type = 2 ) THEN
        IF length(planid)>36 THEN
        errcode:=1;
        errmsg:='一次只允许调整一条计划';
        ELSE 
         SELECT COUNT(id) INTO hiddleCount FROM POM_SPECIAL_PLAN WHERE APPROVAL_STATUS<>'已审核' AND ID=''|| planid;
         IF hiddleCount>0 THEN
          errcode:=1;
          errmsg:='该计划还未审批,请将计划审批完成再调整！';
          ELSE
          errcode:=0;
          errmsg:='';
          END IF;
        END IF;
        END IF;

    EXCEPTION
        WHEN OTHERS THEN
            errcode := 1;
            errmsg := sqlerrm;
    END;
END p_pom_smart_special_plan_del;
/

prompt
prompt Creating procedure P_POM_SMART_STANDARD_NODE_DEL
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_SMART_STANDARD_NODE_DEL" ( nodeid IN VARCHAR2, --输入变量：任务项ID
		type IN VARCHAR2,--操作类型   0：
		errmsg OUT VARCHAR2, --提示消息
		errcode OUT INT --0成功，1失败
	) IS --标准节点库批量删除
--作者：叶丁荣
--日期：2019/11/21
    countdtl NUMBER;
		templatenodecount NUMBER;
        nodelist CLOB;
BEGIN


 BEGIN
        countdtl := 0;
        IF length(nodeid) < 36 THEN
            raise_application_error(-20000, '请选择要删除的任务项');
        END IF;

		IF (type=1) THEN
				--循环规则id

        FOR item IN (
            SELECT
                regexp_substr(''
                              || nodeid
                              || '', '[^,]+', 1, ROWNUM) AS id
            FROM
                dual
            CONNECT BY
                ROWNUM <= length(''
                                 || nodeid
                                 || '') - length(regexp_replace(''
                                                                || nodeid
                                                                || '', ',', '')) + 1
        ) LOOP
    ---删除任务项
            DELETE POM_STANDARD_NODE
            WHERE
                id = ''
                     || item.id
                     || '';

            countdtl := countdtl + 1;
        END LOOP;

        errcode := 0;
        errmsg := '删除成功！'
                  || countdtl
                  || '条任务项';

		ELSE
			--循环规则id

        FOR item IN (
            SELECT
                regexp_substr(''
                              || nodeid
                              || '', '[^,]+', 1, ROWNUM) AS id
            FROM
                dual
            CONNECT BY
                ROWNUM <= length(''
                                 || nodeid
                                 || '') - length(regexp_replace(''
                                                                || nodeid
                                                                || '', ',', '')) + 1
        ) LOOP
    ---删除验证
          SELECT COUNT(ID) INTO templatenodecount FROM POM_TEMPLATE_NODE WHERE STANDARD_NODE_ID=''||item.id||'';
					IF (templatenodecount>0) THEN
						 errcode := 1;
							errmsg := '已经被模板引用的节点不允许删除';
					ELSE
					 errcode := 0;
						errmsg := '';

					END IF;
          select wm_concat(NODE_NAME) into nodelist from POM_STANDARD_NODE where REFERENCE_DATE_NODE_ID = ''||item.id||'';
                    IF (nodelist is not null) THEN
                        errcode := 1;
                        errmsg := '当前节点是“'|| nodelist ||'”节点的参考时间节点，请清除该依赖关系后，再进行节点删除';
					ELSE
                        errcode := 0;
                        errmsg := '';

					END IF;

        END LOOP;

		END IF;

    EXCEPTION
        WHEN OTHERS THEN
            errcode := 1;
            errmsg :=  '删除节点失败！';
    END;





END p_pom_smart_standard_node_del;
/

prompt
prompt Creating procedure P_POM_SMART_TASKCENTER_TBS
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_SMART_TASKCENTER_TBS (
        orgtype IN VARCHAR2, --查询类型，用于判断过滤 0,公司|1,部门|2,项目|3,,本人
		condition IN VARCHAR2, --输入变量：公司id | 部门id | 项目id | 当前用户ID
        currentuserid        IN 			VARCHAR2,--用户id，用于过滤关注的任务
        currentcompanyid     IN            VARCHAR2,--当前用户公司
        currentdeptid        IN            VARCHAR2,--当前用户部门
        currentstationid     IN            VARCHAR2,---当前用户的岗位
        bizcode       IN            VARCHAR2,---权限code
        item OUT SYS_REFCURSOR ) IS --任务中心tabs任务条数统计数据源
--作者：yedr
--日期：2019/12/25

    v_spid              VARCHAR2(200);
	BEGIN--========================================================本公司负责的任务
--调用数据权限验证存储过程
 P_SYS_AUTH_DATA_RULE_SPID(
            USERID => currentuserid,
            STATIONID => currentstationid,
            DEPTID => currentdeptid,
            COMPANYID => currentcompanyid,
            BIZCODE => bizcode,
            DATA_AUTH_SPID => v_spid
        );
	IF
		( orgtype = 0 ) THEN
		IF  condition <> '111' THEN
			OPEN item FOR SELECT--本月任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NULL
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					AND node.COMPANY_ID = '' || condition || ''
                    AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NULL
					AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
					AND plan.APPROVAL_STATUS = '已审核'
					AND	node.IS_DELETE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND (node.IS_DEL=0 OR node.IS_DEL=null)
					AND node.ACTUAL_END_DATE IS NULL
					AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
					AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS ACOUNT,
--超期未完成任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND SYSDATE > node.PLAN_END_DATE
					AND node.ACTUAL_END_DATE IS NULL
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND SYSDATE > node.PLAN_END_DATE
					AND node.ACTUAL_END_DATE IS NULL
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					AND node.COMPANY_ID = '' || condition || ''
					) +(
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND SYSDATE > node.PLAN_END_DATE
					AND node.ACTUAL_END_DATE IS NULL
					AND (node.IS_DEL=0 OR node.IS_DEL=null)
					AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS BCOUNT,
--所有未完成任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NULL
                    AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NULL
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND node.IS_DEL=0
					AND ACTUAL_END_DATE IS NULL
					AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS CCOUNT,
--所有已完成任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NOT NULL
                    AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND ACTUAL_END_DATE IS NOT NULL
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND ACTUAL_END_DATE IS NOT NULL
					AND node.IS_DEL=0
					AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS DCOUNT,
--所有任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND node.IS_DEL=0
					AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS ECOUNT,
--次月任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
					)
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
					)
					AND node.IS_DELETE=0
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND node.IS_DEL=0
					AND APPROVE_STATUS = '已审核'
					AND ( PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1 AND PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 ) )
					AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS FCOUNT,
--本季度任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					)
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					)
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND ( PLAN_END_DATE > trunc( SYSDATE, 'Q' ) AND PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1 )
					AND node.IS_DEL=0
					AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS GCOUNT,
--本年任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.proj_plan_id = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					)
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					AND node.COMPANY_ID = '' || condition || ''
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					)
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					AND node.COMPANY_ID = 'condition'
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND ( PLAN_END_DATE > trunc( SYSDATE, 'yyyy' ) AND PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1 )
					AND node.IS_DEL=0
					AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS HCOUNT
		FROM
			dual;
		ELSE
				OPEN item FOR SELECT--本月任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NULL
					AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NULL
					AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
					AND plan.APPROVAL_STATUS = '已审核'
					AND	node.IS_DELETE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND (node.IS_DEL=0 OR node.IS_DEL=null)
					AND node.ACTUAL_END_DATE IS NULL
					AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
				)
			) AS ACOUNT,
--超期未完成任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND SYSDATE > node.PLAN_END_DATE
					AND node.ACTUAL_END_DATE IS NULL
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND SYSDATE > node.PLAN_END_DATE
					AND node.ACTUAL_END_DATE IS NULL
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					) +(
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND SYSDATE > node.PLAN_END_DATE
					AND node.ACTUAL_END_DATE IS NULL
					AND (node.IS_DEL=0 OR node.IS_DEL=null)
				)
			) AS BCOUNT,
--所有未完成任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NULL
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NULL
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND node.IS_DEL=0
					AND ACTUAL_END_DATE IS NULL
					--AND plan.COMPANY_ID = '' || condition || ''
				)
			) AS CCOUNT,
--所有已完成任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND node.ACTUAL_END_DATE IS NOT NULL
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND ACTUAL_END_DATE IS NOT NULL
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND ACTUAL_END_DATE IS NOT NULL
					AND node.IS_DEL=0
				)
			) AS DCOUNT,
--所有任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND node.IS_DEL=0
				)
			) AS ECOUNT,
--次月任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
					)
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
						AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
					)
					AND node.IS_DELETE=0
					AND plan.APPROVAL_STATUS = '已审核'
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND node.IS_DEL=0
					AND APPROVE_STATUS = '已审核'
					AND ( PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1 AND PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 ) )
				)
			) AS FCOUNT,
--本季度任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND(
						node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					)
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
					)
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND ( PLAN_END_DATE > trunc( SYSDATE, 'Q' ) AND PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1 )
					AND node.IS_DEL=0
				)
			) AS GCOUNT,
--本年任务
			(
				(
				SELECT
					COUNT( * )
				FROM
					POM_PROJ_PLAN_NODE node
					LEFT JOIN POM_PROJ_PLAN plan ON node.proj_plan_id = plan.ID
                    left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                    left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                     on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					)
					AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DISABLE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					POM_SPECIAL_PLAN_NODE node
					LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND (
						node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
						AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
					)
					AND plan.APPROVAL_STATUS = '已审核'
					AND node.IS_DELETE=0
					) + (
				SELECT
					COUNT( * )
				FROM
					pom_dept_monthly_plan_node node
					LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                    LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                    WHERE tal.orgid is not null
                    AND node_source IS NULL
					AND APPROVE_STATUS = '已审核'
					AND ( PLAN_END_DATE > trunc( SYSDATE, 'yyyy' ) AND PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1 )
					AND node.IS_DEL=0
				)
			) AS HCOUNT
		FROM
			dual;
		END IF;
--========================================================本公司负责的任务END
--========================================================本部门负责的任务
		ELSIF ( orgtype = 1 ) THEN
			IF(condition <> '222') THEN
                OPEN item FOR SELECT--本月任务
			(
				(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						AND node.IS_DELETE=0
						AND plan.APPROVAL_STATUS = '已审核'
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND ACTUAL_END_DATE IS NULL
						AND node.IS_DEL=0
						AND ( PLAN_END_DATE > trunc( SYSDATE, 'month' ) AND PLAN_END_DATE < trunc( last_day( SYSDATE ) ) )
						AND DUTY_DEPT_ID = '' || condition || ''
					)
				) AS ACOUNT,
--超期未完成任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND SYSDATE > node.PLAN_END_DATE
						AND node.ACTUAL_END_DATE IS NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND SYSDATE > node.PLAN_END_DATE
						AND node.ACTUAL_END_DATE IS NULL
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND SYSDATE > PLAN_END_DATE
						AND ACTUAL_END_DATE IS NULL
						AND node.IS_DEL=0
						AND DUTY_DEPT_ID = '' || condition || ''
					)
				) AS BCOUNT,
--所有未完成任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND ACTUAL_END_DATE IS NULL
						AND node.IS_DEL=0
						AND DUTY_DEPT_ID = '' || condition || ''
					)
				) AS CCOUNT,
--所有已完成任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NOT NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND ACTUAL_END_DATE IS NOT NULL
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND ACTUAL_END_DATE IS NOT NULL
						AND node.IS_DEL=0
						AND DUTY_DEPT_ID = '' || condition || ''
					)
				) AS DCOUNT,
--所有任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND node.IS_DEL=0
						AND DUTY_DEPT_ID = '' || condition || ''
					)
				) AS ECOUNT,
--次月任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND(
							node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
							AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
							AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
						)
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND ( PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1 AND PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 ) )
						AND node.IS_DEL=0
						AND DUTY_DEPT_ID = '' || condition || ''
					)
				) AS FCOUNT,
--本季度任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
						)
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND node.IS_DEL=0
						AND ( PLAN_END_DATE > trunc( SYSDATE, 'Q' ) AND PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1 )
						AND DUTY_DEPT_ID = '' || condition || ''
					)
				) AS GCOUNT,
--本年任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
						)
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						AND node.DUTY_DEPARTMENT_ID = '' || condition || ''
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND node.IS_DEL=0
						AND ( PLAN_END_DATE > trunc( SYSDATE, 'yyyy' ) AND PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1 )
						AND DUTY_DEPT_ID = '' || condition || ''
					)
				) AS HCOUNT
			FROM
				dual;
            ELSE
                OPEN item FOR SELECT--本月任务
			(
				(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
						AND node.IS_DELETE=0
						AND plan.APPROVAL_STATUS = '已审核'
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND ACTUAL_END_DATE IS NULL
						AND node.IS_DEL=0
						AND ( PLAN_END_DATE > trunc( SYSDATE, 'month' ) AND PLAN_END_DATE < trunc( last_day( SYSDATE ) ) )
					)
				) AS ACOUNT,
--超期未完成任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND SYSDATE > node.PLAN_END_DATE
						AND node.ACTUAL_END_DATE IS NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND SYSDATE > node.PLAN_END_DATE
						AND node.ACTUAL_END_DATE IS NULL
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND SYSDATE > PLAN_END_DATE
						AND ACTUAL_END_DATE IS NULL
						AND node.IS_DEL=0
					)
				) AS BCOUNT,
--所有未完成任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND ACTUAL_END_DATE IS NULL
						AND node.IS_DEL=0
					)
				) AS CCOUNT,
--所有已完成任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NOT NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND ACTUAL_END_DATE IS NOT NULL
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND ACTUAL_END_DATE IS NOT NULL
						AND node.IS_DEL=0
					)
				) AS DCOUNT,
--所有任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND node.IS_DEL=0
					)
				) AS ECOUNT,
--次月任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
							AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
							AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
						)
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND ( PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1 AND PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 ) )
						AND node.IS_DEL=0
					)
				) AS FCOUNT,
--本季度任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND(
							node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
						)
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND node.IS_DEL=0
						AND ( PLAN_END_DATE > trunc( SYSDATE, 'Q' ) AND PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1 )
					)
				) AS GCOUNT,
--本年任务
				(
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						POM_SPECIAL_PLAN_NODE node
						LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
                         LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=node.DUTY_DEPARTMENT_ID or tal.orgid=node.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
						)
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DELETE=0
						) + (
					SELECT
						COUNT( * )
					FROM
						pom_dept_monthly_plan_node node
						LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
                        LEFT JOIN (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'')  tal on tal.orgid=plan.DEPT_ID or tal.orgid=plan.COMPANY_ID
                        WHERE tal.orgid is not null
                        AND node_source IS NULL
						AND APPROVE_STATUS = '已审核'
						AND node.IS_DEL=0
						AND ( PLAN_END_DATE > trunc( SYSDATE, 'yyyy' ) AND PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1 )
					)
				) AS HCOUNT
			FROM
				dual;
            END IF;
--========================================================本部门负责的任务END
--========================================================本项目负责的任务
			ELSIF ( orgtype = 2 ) THEN
				IF ( condition <> '111') THEN
					OPEN item FOR SELECT--本月任务
				(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND node.ACTUAL_END_DATE IS NULL
						AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND (plan.PROJ_ID=''||condition||'' OR plan.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''||condition||''))
					) AS ACOUNT,
--超期未完成任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND SYSDATE > node.PLAN_END_DATE
						AND node.ACTUAL_END_DATE IS NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND (plan.PROJ_ID=''||condition||'' OR plan.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''||condition||''))
					) AS BCOUNT,
--所有未完成任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND (plan.PROJ_ID=''||condition||'' OR plan.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''||condition||''))
					) AS CCOUNT,
--所有已完成任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NOT NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND (plan.PROJ_ID=''||condition||'' OR plan.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''||condition||''))
					) AS DCOUNT,
--所有任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND (plan.PROJ_ID=''||condition||'' OR plan.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''||condition||''))
					) AS ECOUNT,
--次月任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
							AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND (plan.PROJ_ID=''||condition||'' OR plan.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''||condition||''))
					) AS FCOUNT,
--本季度任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND (plan.PROJ_ID=''||condition||'' OR plan.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''||condition||''))
					) AS GCOUNT,
--本年任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
						AND (plan.PROJ_ID=''||condition||'' OR plan.PROJ_ID IN( SELECT ID FROM SYS_PROJECT_STAGE WHERE PROJECT_ID=''||condition||''))
					) AS HCOUNT
				FROM
					dual;
				ELSE
					OPEN item FOR SELECT--本月任务
				(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND node.ACTUAL_END_DATE IS NULL
						AND ( node.PLAN_END_DATE >= trunc( SYSDATE, 'month' ) AND node.PLAN_END_DATE <= trunc( last_day( SYSDATE ) ) )
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
					) AS ACOUNT,
--超期未完成任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND SYSDATE > node.PLAN_END_DATE
						AND node.ACTUAL_END_DATE IS NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
					) AS BCOUNT,
--所有未完成任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
					) AS CCOUNT,
--所有已完成任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND node.ACTUAL_END_DATE IS NOT NULL
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
					) AS DCOUNT,
--所有任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
					) AS ECOUNT,
--次月任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > last_day( trunc( SYSDATE ) ) + 1
							AND node.PLAN_END_DATE < last_day( last_day( trunc( SYSDATE ) ) + 1 )
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
					) AS FCOUNT,
--本季度任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'Q' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'Q' ), 3 ) - 1
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
					) AS GCOUNT,
--本年任务
					(
					SELECT
						COUNT( * )
					FROM
						POM_PROJ_PLAN_NODE node
						LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
                        left join SYS_PROJECT_STAGE sps on plan.proj_id=sps.id
                        left join (select DISTINCT org_id AS orgid from  TMP_AUTH_LIST where id = ''||v_spid||'') tal
                         on (case when sps.id is not null then sps.PROJECT_ID else plan.proj_id end)=tal.orgId
                        WHERE tal.orgid is not null
                        AND (
							node.PLAN_END_DATE > trunc( SYSDATE, 'yyyy' )
							AND node.PLAN_END_DATE < add_months( trunc( SYSDATE, 'yyyy' ), 12 ) - 1
						)
						AND ( plan.PLAN_TYPE = '项目主项计划' OR plan.PLAN_TYPE = '关键节点计划' )
						AND plan.APPROVAL_STATUS = '已审核'
						AND node.IS_DISABLE=0
					) AS HCOUNT
				FROM
					dual;
				END IF;
--========================================================本项目负责的任务END
--========================================================本人负责的任务
				ELSE OPEN item FOR SELECT--所有未完成任务
				(
					(
						SELECT
							COUNT( * )
						FROM
							POM_PROJ_PLAN_NODE node
							LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							node.ACTUAL_END_DATE IS NULL
							AND ( plan.PLAN_TYPE = '项目主项计划' )
							AND plan.APPROVAL_STATUS = '已审核'
							AND node.IS_DISABLE=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
							) + (
						SELECT
							COUNT( * )
						FROM
							POM_SPECIAL_PLAN_NODE node
							LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							node.ACTUAL_END_DATE IS NULL
							AND plan.APPROVAL_STATUS = '已审核'
							AND node.IS_DELETE=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
							) + (
						SELECT
							COUNT( * )
						FROM
							pom_dept_monthly_plan_node node
							LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							node_source IS NULL
							AND ACTUAL_END_DATE IS NULL
							AND APPROVE_STATUS = '已审核'
							AND node.IS_DEL=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
						)
					) AS ACOUNT,
--超期未完成任务
					(
						(
						SELECT
							COUNT( * )
						FROM
							POM_PROJ_PLAN_NODE node
							LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							SYSDATE > node.PLAN_END_DATE
							AND node.ACTUAL_END_DATE IS NULL
							AND ( plan.PLAN_TYPE = '项目主项计划' )
							AND plan.APPROVAL_STATUS = '已审核'
							AND node.IS_DISABLE=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
							) + (
						SELECT
							COUNT( * )
						FROM
							POM_SPECIAL_PLAN_NODE node
							LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							SYSDATE > node.PLAN_END_DATE
							AND node.ACTUAL_END_DATE IS NULL
							AND plan.APPROVAL_STATUS = '已审核'
							AND node.IS_DELETE=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
							) + (
						SELECT
							COUNT( * )
						FROM
							pom_dept_monthly_plan_node node
							LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							node_source IS NULL
							AND SYSDATE > PLAN_END_DATE
							AND ACTUAL_END_DATE IS NULL
							AND APPROVE_STATUS = '已审核'
							AND node.IS_DEL=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
						)
					) AS BCOUNT,
--所有已完成任务
					(
						(
						SELECT
							COUNT( * )
						FROM
							POM_PROJ_PLAN_NODE node
							LEFT JOIN POM_PROJ_PLAN plan ON node.PROJ_PLAN_ID = plan.ID
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							node.ACTUAL_END_DATE IS NOT NULL
							AND ( plan.PLAN_TYPE = '项目主项计划' )
							AND plan.APPROVAL_STATUS = '已审核'
							AND node.IS_DISABLE=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
							) + (
						SELECT
							COUNT( * )
						FROM
							POM_SPECIAL_PLAN_NODE node
							LEFT JOIN POM_SPECIAL_PLAN plan ON node.PLAN_ID = plan.ID
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							ACTUAL_END_DATE IS NOT NULL
							AND plan.APPROVAL_STATUS = '已审核'
							AND node.IS_DELETE=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
							) + (
						SELECT
							COUNT( * )
						FROM
							pom_dept_monthly_plan_node node
							LEFT JOIN pom_dept_monthly_plan plan ON node.dept_monthly_plan_id = plan.id
							LEFT JOIN POM_NODE_CHARGE_PERSON person ON node.ID = person.node_id
						WHERE
							node_source IS NULL
							AND ACTUAL_END_DATE IS NOT NULL
							AND APPROVE_STATUS = '已审核'
							AND node.IS_DEL=0
							AND person.CHARGE_PERSON_ID = '' || condition || ''
						)
					) AS CCOUNT
				FROM
					dual;
--========================================================本人负责的任务END

			END IF;

END P_POM_SMART_TASKCENTER_TBS;
--============================任务中心数据源=====================================


--============================任务中心数据源=====================================
/

prompt
prompt Creating procedure P_POM_TASKLEVELCOMPLETIONRATE
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_tasklevelcompletionrate(
items out SYS_REFCURSOR)
is
--项目主项计划监控任务级别完成率
--作者：叶丁荣
--日期：2020/03/20
begin
open items for select nodes.* from (select node_level as "fullName",round(SUM(
                CASE
                    WHEN node.actual_end_date IS NOT NULL THEN
                        1
                    ELSE
                        0
                END
            ) /(
                CASE
                    WHEN COUNT(node.id) = 0 THEN
                        1
                    ELSE
                        COUNT(node.id)
                END
            ), 4) AS "competationRate" FROM pom_proj_plan_node node left join pom_proj_plan plan on plan.id=node.proj_plan_id
where plan.plan_type='项目主项计划' AND plan.approval_status = '已审核'  GROUP BY node.node_level
) nodes left join sys_bizparam_option param on param.PARAM_VALUE=nodes."fullName" order by param.PARAM_CODE;
end p_pom_tasklevelcompletionrate;
--===================================项目主项计划监控任务级别完成率=========
/

prompt
prompt Creating procedure P_POM_URGED_MSG
prompt ==================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_urged_msg (
    bizid      IN         VARCHAR2,--输入变量：业务id
    biztype    IN         VARCHAR2,--业务类型：1:关键节点计划节点，2：项目主项计划节点，3：专项计划节点，4：月度计划节点
    urgedmsg   OUT        SYS_REFCURSOR--0推送消息
) IS
--点击催办按钮，获取消息信息
--作者：陈丽
--日期：2019/11/17
    testmsg    NVARCHAR2(4000);
BEGIN
    BEGIN
        OPEN urgedmsg FOR SELECT
                              sysdate||'id' AS "msgGroupId",
                              '消息描述' || sysdate AS "msgDescription",
                              '1' AS "RecipientId",
                              bizid AS "bizKey",
                              'v-xufeng' AS "senderId",
                              biztype AS "bizSourceCategory",
                              '催办消息' AS "bizMsgCategory",
                              '预警' AS "systemId",
                              '111' AS "wechatJumplinkUrl"
                          FROM
                              dual;

    EXCEPTION
        WHEN OTHERS THEN
            testmsg := sqlerrm;
    END;
END p_pom_urged_msg;
/

prompt
prompt Creating procedure P_POM_URGE_MESSAGE
prompt =====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_urge_message (
    originalnodeid    varchar2,     --节点原始ID
    USERID IN VARCHAR2,--当前登录人
    plantype          varchar2,     --计划类型 （关键节点计划/项目主项计划/专项计划/部门月度计划）
   
    info     OUT      SYS_REFCURSOR--消息集合
) IS
--催办消息
--作者：谢松宏
--日期：2020/02/18
  m_user         varchar2(3000); -- 催办人名称
  m_nodeid         varchar2(300); -- 节点id
  m_userName         varchar2(2000); -- 被催办人名称
  m_userId varchar2(2000); -- 被催办人id
  m_MOBILE_PHONE varchar2(2000); -- 被催办人电话
  m_nodeName         varchar2(2000); -- 催办节点
BEGIN

 begin

if plantype = '关键节点计划' or plantype = '项目主项计划' then
    dbms_output.put_line('1');
       select NODE_NAME,n.id into m_nodeName,m_nodeid from POM_PROJ_PLAN_NODE n left join 
       POM_Proj_PLAN p on n.PROJ_PLAN_ID=p.id
       where  ORIGINAL_NODE_ID=originalnodeid and p.APPROVAL_STATUS='已审核';
       dbms_output.put_line('2');
  elsif plantype = '专项计划' then
     select NODE_NAME,n.id into m_nodeName,m_nodeid from POM_SPECIAL_PLAN_NODE n left join 
       POM_SPECIAL_PLAN p on n.PLAN_ID=p.id
       where  ORIGINAL_NODE_ID=originalnodeid and p.APPROVAL_STATUS='已审核';
  elsif plantype = '部门月度计划' then
       select NODE_NAME,n.id into m_nodeName,m_nodeid from POM_DEPT_MONTHLY_PLAN_NODE n left join 
       POM_DEPT_MONTHLY_PLAN p on n.DEPT_MONTHLY_PLAN_ID=p.id
       where  ORIGINAL_NODE_ID=originalnodeid and p.APPROVE_STATUS='已审核';
end if;
 select CHARGE_PERSON,CHARGE_PERSON_ID into m_userName,m_userId from POM_NODE_CHARGE_PERSON where node_id=m_nodeid;
 select MOBILE_PHONE into m_MOBILE_PHONE from sys_user where id=m_userId;
 select user_name into m_user from sys_user where id=USERID;
   EXCEPTION
        WHEN OTHERS THEN
--           m_userName:='未知';
--           m_nodeName:='未知';
            dbms_output.put_line(sqlerrm);
    END;
    OPEN info FOR SELECT
                ------------------------------------------------------------基础必须信息
              '71313f018a35f3a558166cba7599b5d6' AS "systemId",--系统id
              'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "appid",--应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段，
            ------------------------------------------------------------业务变动必须信息
              originalnodeid AS "bizKey",--业务id
               'tjSMS' AS "msgChannel",--使用消息渠道 多个，逗号分隔   tjWeChat：铁建微信,tjSMS：铁建短信
            ------------------------------------------------------------短信必须参数
              '400014' AS "smsTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID  --{1}您好，{2}对您负责的任务“{3}”进行了催办，请及时到门户网站查看待办并在《计划管理系统》中反馈任务进度{4}。
              '["'||m_userName||'","'||m_user||'","'||m_nodeName||'",""]' AS "smsParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
              m_MOBILE_PHONE as "mobile",--短信接收人电话
            ------------------------------------------------------------微信必须参数
              '400014' AS "wechatTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID
              '["'||m_userName||'","'||m_user||'","'||m_nodeName||'",""]' AS "wechatParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
               '///' AS "wechatJumplinkUrl",--微信打开地址，程序调用发消息前需要编码
              'v-xufeng' AS "recipientAccount",--接收人usercode如：a-xiexuhua
            ------------------------------------------------------------消息记录方追溯信息
              '催办消息' AS "title",--消息标题
              'v-xufeng' AS "senderAccount",--发送人usercode如：a-xiexuhua
              ''||m_userName||'您好，'||m_user||'对您负责的任务“'||m_nodeName||'”进行了催办' AS "bizSourceCategory",--业务所属类别=》 （由业务系统自定义，方便根据业务回溯，同一类别下有很多个类似业务，如月度计划）
              '催办消息' AS "bizMsgCategory"--消息所属类别=》 （由业务系统自定义，方便根据业务回溯，同一业务主键，有多个分类，如预警消息，提醒消息）
             FROM
                      dual;

END p_pom_urge_message;
/

prompt
prompt Creating procedure P_POM_URGE_MSG_INFO
prompt ======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_POM_URGE_MSG_INFO
(
		ORIGINALNODEID IN VARCHAR2 --节点原始ID
	 ,USERID         IN VARCHAR2 --当前登录人
	 ,PLANTYPE       IN VARCHAR2 --计划类型 （关键节点计划/项目主项计划/专项计划/部门月度计划）
	 ,MESSAGETYPE    OUT VARCHAR2 --0:门户终端消息都推送，1：只推送门户，2：只推送短信或微信
	 ,INFO           OUT SYS_REFCURSOR --消息集合
) IS
		--通用推送集团门户和短信微信消息数据获取存储过程-------催办消息实例
		--1、输入参数可根据存储过程注册自定义
		--2、输出删除messageType和info必须，info返回结果字段名称和大小写需要严格按照定义返回
		--作者：陈丽
		--日期：2020/03/03
		M_USER           VARCHAR2(3000); -- 催办人名称
		M_URGEUSERCODE   VARCHAR2(3000); -- 催办人code
		M_PLANID         VARCHAR2(300); -- 计划id
		M_NODEID         VARCHAR2(300); -- 节点id
		M_USERNAME       VARCHAR2(2000); -- 被催办人名称
		M_USERCODE       VARCHAR2(2000); -- 被催办人id
		M_MOBILE_PHONE   VARCHAR2(2000); -- 被催办人电话
		M_NODENAME       VARCHAR2(2000); -- 催办节点
		M_SEC_COMPANY_ID VARCHAR(2000); -- 二级单位ID
		M_PLAN_NAME      VARCHAR2(1000); --计划名称
		M_IS_GROUPS      VARCHAR2(1000); --用于判断是否是"集团人员发的催办信息
        JUMP_URL_DOMAIN  VARCHAR2(1000); --用于获取当前系统的域名地址
BEGIN
		MESSAGETYPE := 0;

		BEGIN
				--货取节点信息
				IF PLANTYPE = '关键节点计划' OR PLANTYPE = '项目主项计划' THEN
						DBMS_OUTPUT.PUT_LINE('1');
						SELECT NODE_NAME, N.ID, P.ID
						INTO   M_NODENAME, M_NODEID, M_PLANID
						FROM   POM_PROJ_PLAN_NODE N
						LEFT   JOIN POM_PROJ_PLAN P
						ON     N.PROJ_PLAN_ID = P.ID
						WHERE  ORIGINAL_NODE_ID = ORIGINALNODEID AND P.APPROVAL_STATUS = '已审核';
						DBMS_OUTPUT.PUT_LINE('2');
				ELSIF PLANTYPE = '专项计划' THEN
						SELECT NODE_NAME, N.ID, P.ID
						INTO   M_NODENAME, M_NODEID, M_PLANID
						FROM   POM_SPECIAL_PLAN_NODE N
						LEFT   JOIN POM_SPECIAL_PLAN P
						ON     N.PLAN_ID = P.ID
						WHERE  ORIGINAL_NODE_ID = ORIGINALNODEID AND P.APPROVAL_STATUS = '已审核';
				ELSIF PLANTYPE = '部门月度计划' THEN
						SELECT NODE_NAME, N.ID, P.ID
						INTO   M_NODENAME, M_NODEID, M_PLANID
						FROM   POM_DEPT_MONTHLY_PLAN_NODE N
						LEFT   JOIN POM_DEPT_MONTHLY_PLAN P
						ON     N.DEPT_MONTHLY_PLAN_ID = P.ID
						WHERE  ORIGINAL_NODE_ID = ORIGINALNODEID AND P.APPROVE_STATUS = '已审核';
				END IF;
				--获取二级单位公司ID
				SELECT A.ID
				INTO   M_SEC_COMPANY_ID
				FROM   SYS_BUSINESS_UNIT A
				WHERE  A.LEVEL_RANK = 2
				START  WITH A.ID = (SELECT P.COMPANY_ID FROM POM_PROJ_PLAN P WHERE P.ID = M_PLANID)
				CONNECT BY PRIOR A.PARENT_ID = A.ID;

				--获取项目名称
				SELECT A.PLAN_NAME INTO M_PLAN_NAME FROM POM_PROJ_PLAN A WHERE A.ID = M_PLANID;

				--判断是否是集团公司人员发的催办信息//若是集团人员发的催办信息,需推送给二级单位计划运营负责人

				SELECT COUNT(1)
				INTO   M_IS_GROUPS
				FROM   SYS_USER A
				INNER  JOIN SYS_STATION_TO_USER B
				ON     A.ID = B.USER_ID
				INNER  JOIN SYS_STATION C
				ON     B.STATION_ID = C.ID
				INNER  JOIN SYS_BUSINESS_UNIT D
				ON     C.ORG_ID = D.ID
				WHERE  A.ID = USERID AND (SELECT P.ORG_NAME FROM SYS_BUSINESS_UNIT P WHERE P.IS_COMPANY = 1 AND P.LEVEL_RANK = 2 START WITH P.ID = C.ORG_ID CONNECT BY PRIOR P.PARENT_ID = P.ID) = '集团总部';

				IF USERID = '622f125e-e475-4a56-88e7-34d1ced1c063' THEN--时凡,非集团人员,但是暂时在集团兼职,特殊处理
						M_IS_GROUPS := 1;
				ELSIF USERID = 'c5c997cc-23fd-4c2f-8933-c3c9f488668f' THEN--代世光，非集团人员，但是暂时在集团兼职，特殊处理
						M_IS_GROUPS := 1;
				END IF;

				--获取被催办人信息

				/* select CHARGE_PERSON,u.user_code,u.MOBILE_PHONE into m_userName,m_userCode,m_MOBILE_PHONE from POM_NODE_CHARGE_PERSON p
        left join  sys_user u on p.CHARGE_PERSON_ID=u.id where node_id=m_nodeid;*/

				SELECT USER_NAME, USER_CODE INTO M_USER, M_URGEUSERCODE FROM SYS_USER WHERE ID = USERID;

		EXCEPTION
				WHEN OTHERS THEN
						--           m_userName:='未知';
						--           m_nodeName:='未知';
						DBMS_OUTPUT.PUT_LINE(SQLERRM);
		END;
         --调用函数，获取跳转域名
            JUMP_URL_DOMAIN:= GET_JUMP_URL_DOMAIN('H5', '71313f018a35f3a558166cba7599b5d6');
		IF M_IS_GROUPS <> 0 THEN
				BEGIN
						OPEN INFO FOR
								SELECT
								------------------------------------------------------------基础配置数据【必须】（集团门户网站和设备消息都必须配置）----------------------------
								 M_URGEUSERCODE AS "senderAccount",
								 --发送人usercode如：a-xiexuhua,---门户网站的creatorName
								 U.USER_CODE AS "recipientAccount",
								 --接收人usercode如：a-xiexuhua--门户网站的ownerName
								 'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "appid",
								 --应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段---门户网站的sourceAppId
								 '71313f018a35f3a558166cba7599b5d6' AS "systemId",
								 --系统id
								 ORIGINALNODEID AS "bizKey",
								 --业务id--门户网站的taskId
								 '催办消息' AS "bizMsgCategory",
								 --消息所属类别=》 （由业务系统自定义，方便根据业务回溯，同一业务主键，有多个分类，如预警消息，提醒消息）
								 ------------------------------------------------------------设备消息配置开始------------------------------------------------------------ 
								 ------------------------------------------------------------【短信微信必须】基础信息
								 'tjSMS,tjWeChat' AS "msgChannel",
								 --使用消息渠道 多个，逗号分隔   tjWeChat：铁建微信,tjSMS：铁建短信
								 ------------【短信必须】参数
								 '400014' AS "smsTemplateid",
								 --模板 ID，在腾讯云短信审核通过的模板 ID  --{1}您好，{2}对您负责的任务“{3}”进行了催办，请及时到门户网站查看待办并在《计划管理系统》中反馈任务进度{4}。
								 '["' || P.CHARGE_PERSON || '","' || M_USER || '","' || M_NODENAME || '",""]' AS "smsParams",
								 --接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
								 U.MOBILE_PHONE AS "mobile",
								 --短信接收人电话
								 ------------【微信必须】参数
								 '400014' AS "wechatTemplateid",
								 --模板 ID，在腾讯云短信审核通过的模板 ID
								 '["' || P.CHARGE_PERSON || '","' || M_USER || '","' || M_NODENAME || '",""]' AS "wechatParams",
								 --接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
								 'USERID' AS "wechatJumplinkUrl",
								 --微信打开地址，程序调用发消息前需要编码
								 ------------消息记录方便追溯信息
								 '' || P.CHARGE_PERSON || '您好，' || M_USER || '对您负责的任务“' || M_NODENAME || '”进行了催办' AS "title",
								 --消息标题
								 '' || P.CHARGE_PERSON || '您好，' || M_USER || '对您负责的任务“' || M_NODENAME || '”进行了催办' AS "bizSourceCategory",
								 --业务所属类别=》 （由业务系统自定义，方便根据业务回溯，同一类别下有很多个类似业务，如月度计划）
								 ------------------------------------------------------------设备消息配置结束------------------------------------------------------------ 
								 ------------------------------------------------------------集团门户网站信息------------------------------------------------------------ 
								 --taskid  是 String  任务ID---------------------共有门户网站的1、插入待办/2、插入已办taskid，3、插入待阅/4、插入已阅informationid，5、插入我的关注的informationid
								 --creatorname 是 String  创建人
								 --ownername 是 String  拥有人
								 --sourceAppId 是 String  推送应用的appId
								 0 "portalMsgType",
								 --集团门户网站消息类型（0：待办,1:已办，10：待阅，11:已阅，20：关注）--已办，需要先根据bizKey删除待办，已阅接口需要根据bizKey调用集团待阅删除接口
								 JUMP_URL_DOMAIN||'/pom/middle?originalUrl=' ||
									URL_ENCODE(JUMP_URL_DOMAIN||'/pom/mission-center-feedback/my-responsible-task?cancelType=0' || CHR(38) || 'id=' || M_PLANID || CHR(38) || 'feedbackNodeId=' || M_NODEID ||
														 CHR(38) || 'feedbackNodeOriginalId=' || ORIGINALNODEID || CHR(38) || 'nodeSourcePlanType=1') "url",
								 --url 是 String  应用系统的url地址
								 JUMP_URL_DOMAIN||'/pom/middle?originalUrl=' ||
									URL_ENCODE(JUMP_URL_DOMAIN||'/pom/mission-center-feedback/my-responsible-task?cancelType=0' || CHR(38) || 'id=' || M_PLANID || CHR(38) || 'feedbackNodeId=' || M_NODEID ||
														 CHR(38) || 'feedbackNodeOriginalId=' || ORIGINALNODEID || CHR(38) || 'nodeSourcePlanType=1') "mobileUrl",
								 --mobileUrl  否 String  应用系统的手机端url地址
								 '' || P.CHARGE_PERSON || '您好，' || M_USER || '对您负责的任务“' || M_NODENAME || '”进行了催办' "taskname",
								 --taskname 是 String  任务名称，等于3、插入待阅/4、插入已阅informationname;等于插入关注的attentionname
								 '计划运营' "typename",
								 --typename 是 String  任务类型
								 PLANTYPE "remark",
								 --remark 否 String  备注

								 ----------------------------------------------
								 -----除【关注外特有】
								 TO_CHAR(SYSDATE,'yyyy-MM-dd HH:mm:ss')  "expiretime",
								 --expiretime  否 String  过期时间，格式yyyy-MM-dd HH:mm:ss-----过期时间，除关注都有
								 1 "priority" --priority 否 Integer 优先级，除关注都有
								FROM   POM_NODE_CHARGE_PERSON P
								LEFT   JOIN SYS_USER U
								ON     P.CHARGE_PERSON_ID = U.ID
								WHERE  NODE_ID = M_NODEID
								UNION ALL
								--获取二级单位计划运营负责人
								SELECT
								------------------------------------------------------------基础配置数据【必须】（集团门户网站和设备消息都必须配置）----------------------------
								 M_URGEUSERCODE AS "senderAccount",
								 --发送人usercode如：a-xiexuhua,---门户网站的creatorName
								 U.USER_CODE AS "recipientAccount",
								 --接收人usercode如：a-xiexuhua--门户网站的ownerName
								 (SELECT APP_ID FROM SYS_APPLICATION WHERE ID = '71313f018a35f3a558166cba7599b5d6') AS "appid",
								 --应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段---门户网站的sourceAppId
								 '71313f018a35f3a558166cba7599b5d6' AS "systemId",
								 --系统id
								 ORIGINALNODEID AS "bizKey",
								 --业务id--门户网站的taskId
								 '催办消息' AS "bizMsgCategory",
								 --消息所属类别=》 （由业务系统自定义，方便根据业务回溯，同一业务主键，有多个分类，如预警消息，提醒消息）
								 ------------------------------------------------------------设备消息配置开始------------------------------------------------------------ 
								 ------------------------------------------------------------【短信微信必须】基础信息
								 'tjSMS,tjWeChat' AS "msgChannel",
								 --使用消息渠道 多个，逗号分隔   tjWeChat：铁建微信,tjSMS：铁建短信
								 ------------【短信必须】参数
								 '400014' AS "smsTemplateid",
								 --模板 ID，在腾讯云短信审核通过的模板 ID  --{1}您好，{2}对您负责的任务“{3}”进行了催办，请及时到门户网站查看待办并在《计划管理系统》中反馈任务进度{4}。
								 '["' || U.USER_NAME || '","' || M_USER || '","' || M_NODENAME || '",""]' AS "smsParams",
								 --接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
								 U.MOBILE_PHONE AS "mobile",
								 --短信接收人电话
								 ------------【微信必须】参数
								 '400014' AS "wechatTemplateid",
								 --模板 ID，在腾讯云短信审核通过的模板 ID
								 '["' || U.USER_NAME || '","' || M_USER || '","' || M_NODENAME || '",""]' AS "wechatParams",
								 --接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
								 '///' AS "wechatJumplinkUrl",
								 --微信打开地址，程序调用发消息前需要编码
								 ------------消息记录方便追溯信息
								 '' || U.USER_NAME || '您好，' || M_USER || '对您负责的任务“' || M_NODENAME || '”进行了催办' AS "title",
								 --消息标题
								 '' || U.USER_NAME || '您好，' || M_USER || '对您负责的任务“' || M_NODENAME || '”进行了催办' AS "bizSourceCategory",
								 --业务所属类别=》 （由业务系统自定义，方便根据业务回溯，同一类别下有很多个类似业务，如月度计划）
								 ------------------------------------------------------------设备消息配置结束------------------------------------------------------------ 
								 ------------------------------------------------------------集团门户网站信息------------------------------------------------------------ 
								 --taskid  是 String  任务ID---------------------共有门户网站的1、插入待办/2、插入已办taskid，3、插入待阅/4、插入已阅informationid，5、插入我的关注的informationid
								 --creatorname 是 String  创建人
								 --ownername 是 String  拥有人
								 --sourceAppId 是 String  推送应用的appId
								 10 "portalMsgType",
								 --集团门户网站消息类型（0：待办,1:已办，10：待阅，11:已阅，20：关注）--已办，需要先根据bizKey删除待办，已阅接口需要根据bizKey调用集团待阅删除接口
								 JUMP_URL_DOMAIN||'/pom/middle?originalUrl=' ||
									URL_ENCODE(JUMP_URL_DOMAIN||'/pom/mission-center-feedback/my-responsible-task?cancelType=0' || CHR(38) || 'id=' || M_PLANID || CHR(38) || 'feedbackNodeId=' || M_NODEID ||
														 CHR(38) || 'feedbackNodeOriginalId=' || ORIGINALNODEID || CHR(38) || 'nodeSourcePlanType=1') "url",
								 --url 是 String  应用系统的url地址
								 JUMP_URL_DOMAIN||'/pom/middle?originalUrl=' ||
									URL_ENCODE(JUMP_URL_DOMAIN||'/pom/mission-center-feedback/my-responsible-task?cancelType=0' || CHR(38) || 'id=' || M_PLANID || CHR(38) || 'feedbackNodeId=' || M_NODEID ||
														 CHR(38) || 'feedbackNodeOriginalId=' || ORIGINALNODEID || CHR(38) || 'nodeSourcePlanType=1') "mobileUrl",
								 --mobileUrl  否 String  应用系统的手机端url地址
								 '' || U.USER_NAME || '您好，' || M_USER || '对任务“' || M_NODENAME || '”进行了催办，请督促任务责任人及时进行反馈' "taskname",
								 --taskname 是 String  任务名称，等于3、插入待阅/4、插入已阅informationname;等于插入关注的attentionname
								 '计划运营' "typename",
								 --typename 是 String  任务类型
								 PLANTYPE "remark",
								 --remark 否 String  备注

								 ----------------------------------------------
								 -----除【关注外特有】
								 TO_CHAR(SYSDATE,'yyyy-MM-dd HH:mm:ss')  "expiretime",
								 --expiretime  否 String  过期时间，格式yyyy-MM-dd HH:mm:ss-----过期时间，除关注都有
								 1 "priority" --priority 否 Integer 优先级，除关注都有
								FROM   POM_PROJ_PLAN_NODE O
								INNER  JOIN SYS_USER U
								ON     1 = 1 AND U.USER_CODE IN
											 (SELECT OO.USER_ACCOUNT
																	FROM   (SELECT (SELECT P.ID FROM SYS_BUSINESS_UNIT P WHERE P.LEVEL_RANK = 2 START WITH P.ID = A.COMPANY_ID CONNECT BY PRIOR P.PARENT_ID = P.ID) AS SEC_COMPANY_ID, A.*
																					 FROM   SYS_ROLE_USER_RELATION_RESULT A
																					 WHERE  A.ROLE_TYPE = 40 AND VIRTUAL_GROUP_NAME = '二级单位计划运营负责人') OO
																	WHERE  OO.SEC_COMPANY_ID = M_SEC_COMPANY_ID) AND EXISTS
								 (SELECT 1 FROM POM_PROJ_PLAN QQ WHERE QQ.ORIGINAL_PLAN_ID = O.ORIGINAL_PLAN_ID AND QQ.PLAN_TYPE = '关键节点计划' AND QQ.APPROVAL_STATUS = '已审核')
								WHERE  O.ID = M_NODEID;
				END;
		ELSE
				BEGIN
						OPEN INFO FOR
								SELECT
								------------------------------------------------------------基础配置数据【必须】（集团门户网站和设备消息都必须配置）----------------------------
								 M_URGEUSERCODE AS "senderAccount",
								 --发送人usercode如：a-xiexuhua,---门户网站的creatorName
								 U.USER_CODE AS "recipientAccount",
								 --接收人usercode如：a-xiexuhua--门户网站的ownerName
								 'ce475375-7627-40b0-b77f-2d9bbaf98a7c' AS "appid",
								 --应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段---门户网站的sourceAppId
								 (SELECT APP_ID FROM SYS_APPLICATION WHERE ID = '71313f018a35f3a558166cba7599b5d6') AS "systemId",
								 --系统id
								 ORIGINALNODEID AS "bizKey",
								 --业务id--门户网站的taskId
								 '催办消息' AS "bizMsgCategory",
								 --消息所属类别=》 （由业务系统自定义，方便根据业务回溯，同一业务主键，有多个分类，如预警消息，提醒消息）
								 ------------------------------------------------------------设备消息配置开始------------------------------------------------------------ 
								 ------------------------------------------------------------【短信微信必须】基础信息
								 'tjSMS,tjWeChat' AS "msgChannel",
								 --使用消息渠道 多个，逗号分隔   tjWeChat：铁建微信,tjSMS：铁建短信
								 ------------【短信必须】参数
								 '400014' AS "smsTemplateid",
								 --模板 ID，在腾讯云短信审核通过的模板 ID  --{1}您好，{2}对您负责的任务“{3}”进行了催办，请及时到门户网站查看待办并在《计划管理系统》中反馈任务进度{4}。
								 '["' || P.CHARGE_PERSON || '","' || M_USER || '","' || M_NODENAME || '",""]' AS "smsParams",
								 --接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
								 U.MOBILE_PHONE AS "mobile",
								 --短信接收人电话
								 ------------【微信必须】参数
								 '400014' AS "wechatTemplateid",
								 --模板 ID，在腾讯云短信审核通过的模板 ID
								 '["' || P.CHARGE_PERSON || '","' || M_USER || '","' || M_NODENAME || '",""]' AS "wechatParams",
								 --接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
								 '///' AS "wechatJumplinkUrl",
								 --微信打开地址，程序调用发消息前需要编码
								 ------------消息记录方便追溯信息
								 '' || P.CHARGE_PERSON || '您好，' || M_USER || '对您负责的任务“' || M_NODENAME || '”进行了催办' AS "title",
								 --消息标题
								 '' || P.CHARGE_PERSON || '您好，' || M_USER || '对您负责的任务“' || M_NODENAME || '”进行了催办' AS "bizSourceCategory",
								 --业务所属类别=》 （由业务系统自定义，方便根据业务回溯，同一类别下有很多个类似业务，如月度计划）
								 ------------------------------------------------------------设备消息配置结束------------------------------------------------------------ 
								 ------------------------------------------------------------集团门户网站信息------------------------------------------------------------ 
								 --taskid  是 String  任务ID---------------------共有门户网站的1、插入待办/2、插入已办taskid，3、插入待阅/4、插入已阅informationid，5、插入我的关注的informationid
								 --creatorname 是 String  创建人
								 --ownername 是 String  拥有人
								 --sourceAppId 是 String  推送应用的appId
								 0 "portalMsgType",
								 --集团门户网站消息类型（0：待办,1:已办，10：待阅，11:已阅，20：关注）--已办，需要先根据bizKey删除待办，已阅接口需要根据bizKey调用集团待阅删除接口
								 JUMP_URL_DOMAIN||'/pom/middle?originalUrl=' ||
									URL_ENCODE(JUMP_URL_DOMAIN||'/pom/mission-center-feedback/my-responsible-task?cancelType=0' || CHR(38) || 'id=' || M_PLANID || CHR(38) || 'feedbackNodeId=' || M_NODEID ||
														 CHR(38) || 'feedbackNodeOriginalId=' || ORIGINALNODEID || CHR(38) || 'nodeSourcePlanType=1') "url",
								 --url 是 String  应用系统的url地址
								 JUMP_URL_DOMAIN||'/pom/middle?originalUrl=' ||
									URL_ENCODE(JUMP_URL_DOMAIN||'/pom/mission-center-feedback/my-responsible-task?cancelType=0' || CHR(38) || 'id=' || M_PLANID || CHR(38) || 'feedbackNodeId=' || M_NODEID ||
														 CHR(38) || 'feedbackNodeOriginalId=' || ORIGINALNODEID || CHR(38) || 'nodeSourcePlanType=1') "mobileUrl",
								 --mobileUrl  否 String  应用系统的手机端url地址
								 '' || P.CHARGE_PERSON || '您好，' || M_USER || '对您负责的任务“' || M_NODENAME || '”进行了催办' "taskname",
								 --taskname 是 String  任务名称，等于3、插入待阅/4、插入已阅informationname;等于插入关注的attentionname
								 '计划运营' "typename",
								 --typename 是 String  任务类型
								 PLANTYPE "remark",
								 --remark 否 String  备注

								 ----------------------------------------------
								 -----除【关注外特有】
								 TO_CHAR(SYSDATE,'yyyy-MM-dd HH:mm:ss')  "expiretime",
								 --expiretime  否 String  过期时间，格式yyyy-MM-dd HH:mm:ss-----过期时间，除关注都有
								 1 "priority" --priority 否 Integer 优先级，除关注都有
								FROM   POM_NODE_CHARGE_PERSON P
								LEFT   JOIN SYS_USER U
								ON     P.CHARGE_PERSON_ID = U.ID
								WHERE  NODE_ID = M_NODEID;
				END;
		END IF;

END;
/

prompt
prompt Creating procedure P_POM_VERIFY_ATTR_AREA_USE
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_VERIFY_ATTR_AREA_USE" (
    attrid     IN         VARCHAR2_LIST,--输入变量：单位面积等级id集合
    attrtype   IN         INT,--0单位面积等级,10项目合作属性,20经营属性
    message    OUT        VARCHAR2,--提示消息
    isuse      OUT        INT--0未使用，1已使用
) IS
--验证业态是否被使用
--作者：陈丽
--日期：2019/11/17
BEGIN
    BEGIN
        isuse := 0;
        message := '验证通过';
    --查看是否在指标表使用---先单个后期调整
--        SELECT
--            COUNT(attribute_area_level_id)
--        INTO isuse
--        FROM
--            mdm_obj_phase_area_level
--        WHERE
--            attribute_area_level_id = ''
--                                      || attributeid
--                                      || '';
        IF isuse > 0 THEN
            raise_application_error(-20000, '属性已被使用不允许删除');
        END IF;

    EXCEPTION
        WHEN OTHERS THEN
            isuse := 1;
            message := '验证失败，' || sqlerrm;
    END;
END p_pom_verify_attr_area_use;
/

prompt
prompt Creating procedure P_POM_VERIFY_BUILDING_USE
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_VERIFY_BUILDING_USE"
(
		BUILDINGID IN VARCHAR2
	 , --输入变量：楼栋id
		MESSAGE    OUT VARCHAR2
	 , --提示消息
		ISUSE      OUT INT --0未使用，1已使用
) IS
		--验证楼栋是否被使用
		--作者：陈丽
		--日期：2019/11/17
BEGIN
		BEGIN
				ISUSE := 0;
				--查看分期是否在指标表使用
				SELECT COUNT(BUILD_ID)
				INTO   ISUSE
				FROM   MDM_BUILD_PHASE
				WHERE  BUILD_ID = '' || BUILDINGID || '';
				IF LENGTH(ISUSE) > 0 THEN
						RAISE_APPLICATION_ERROR(-20000, '楼栋已存在指标数据不允许删除');
				END IF;
		EXCEPTION
				WHEN OTHERS THEN
						ISUSE   := 1;
						MESSAGE := '验证失败，' || SQLERRM;
		END;
END P_POM_VERIFY_BUILDING_USE;
/

prompt
prompt Creating procedure P_POM_VERIFY_PERIOD_USE
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_VERIFY_PERIOD_USE" (
periodoriginalid IN VARCHAR2,--输入变量：分期原始id,多个逗号分隔
message OUT VARCHAR2,--提示消息
isuse OUT INT--0未使用，1已使用
) IS--验证分期是否被使用
--作者：陈丽
--日期：2019/11/17
--分期删除验证计划（全盘、关键节点、项目主项计划）是否使用，目标货值是否使用，证照是否使用，主数据维护是否使用）
PLAN_USE int:=0;
TARGET_WORTH_USE int:=0;
PERMIT_USE int:=0;
PHASE_USE int:=0;
BEGIN 
BEGIN 
isuse :=0;--查看分期是否在指标表使用
--分期删除验证计划（关键节点、项目主项计划）是否使用
SELECT COUNT(id) INTO PLAN_USE FROM POM_PROJ_PLAN WHERE PROJ_ID IN (SELECT column_value FROM TABLE ( split(periodoriginalid) ))   ; 
--分期删除验证,目标货值是否使用
SELECT COUNT(id) INTO TARGET_WORTH_Use FROM DWM_TARGET_WORTH_DTL WHERE OBJ_ID IN (SELECT column_value FROM TABLE ( split(periodoriginalid) ))   ; 
--证照是否使用
SELECT COUNT(id) INTO PERMIT_USE FROM MDM_PERMIT WHERE PROJECT_ID IN (SELECT column_value FROM TABLE ( split(periodoriginalid) ))   ;  
--主数据维护是否使用
SELECT COUNT(period_id) INTO PHASE_USE FROM mdm_period_phase WHERE period_id IN (SELECT column_value FROM TABLE ( split(periodoriginalid) ))   ;  

IF plan_Use> 0 THEN 
isuse:=1;
message:='分期已存在计划不允许删除'; 
END IF; 
IF PHASE_USE> 0 THEN 
isuse:=1;
message:='分期已存在指标数据不允许删除分期'; 
END IF; 
IF TARGET_WORTH_Use> 0 THEN 
isuse:=1;
message:='分期已存在目标货值数据不允许删除'; 
END IF; 
IF PERMIT_Use> 0 THEN 
isuse:=1;
message:='分期已存在证照不允许删除'; 
END IF; 

EXCEPTION WHEN OTHERS THEN isuse :=1; message :='验证失败，' || sqlerrm;
END;
END p_pom_verify_period_use;
/

prompt
prompt Creating procedure P_POM_VERIFY_PRODUCT_TYPE_USE
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_POM_VERIFY_PRODUCT_TYPE_USE" (
    ptid   IN           VARCHAR2,--输入变量：业态id。多个逗号分隔，
    message      OUT          VARCHAR2,--提示消息
    isuse        OUT          INT--0未使用，1已使用
) IS
--验证业态是否被使用
--作者：陈丽
--日期：2019/11/17
BEGIN
  BEGIN
        isuse := 0;
    --查看分期是否在指标表使用
        SELECT
            COUNT(PRODUCT_TYPE_ID)
        INTO isuse
        FROM
            MDM_OBJ_PHASE_PT_INDEX
        WHERE
            PRODUCT_TYPE_ID = ''
                        || ptid
                        || '';
        IF isuse > 0 THEN
            raise_application_error(-20000, '业务已被使用不允许删除');
        END IF;
        message := '验证通过';
    EXCEPTION
        WHEN OTHERS THEN
            isuse := 1;
            message := '验证失败，'||isuse || sqlerrm;
    END;
END p_pom_verify_product_type_use;
/

prompt
prompt Creating procedure P_POM_WARNING_MSG_LIST
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_warning_msg_list ( isread IN VARCHAR2, --0、未读1、已读
    userid IN VARCHAR2,--当前用户ID
    items OUT SYS_REFCURSOR,    
    total OUT INT ,--明细信息
    pageindex     IN            INT,
    pagesizes     IN            INT
  )IS--预警消息台账
--作者：叶丁荣
--日期：2019/12/18
--日期：2020/01/13 康文靖修改
    v_sql               CLOB;
    v_sql_exec          CLOB;
    v_sql_exec_paging   CLOB;
BEGIN
    v_sql :='SELECT
      node.ID,
      ROWNUM as rowno,
      node.DUTY_DEPARTMENT AS DEPARTMENT,--部门
      node.NODE_LEVEL AS NODE_LEVEL,--任务级别
      node.STANDARD_SCORE,--标准分值
      to_char(node.PLAN_START_DATE,''yyyy-mm-dd'')   AS PLAN_BEGIN_TIME,--计划开始时间
      to_char(node.PLAN_END_DATE,''yyyy-mm-dd'') AS PLAN_END_TIME,--计划结束时间
      to_char(msg.ACTUAL_CREATED,''yyyy-mm-dd'')  AS WARNING_TIME,--预警时间
      msg.pc_url AS URL, --跳转URL
      msg.TASK_NAME AS WARNING_INFO,--预警信息
    CASE
        WHEN node.PLAN_END_DATE - SYSDATE < 0 THEN
        ''<i style="margin-left:0.6cm;width:20px;height:20px;border-radius:50%;background-color:red;display: block"></i>''
        WHEN node.PLAN_END_DATE - SYSDATE > 0 THEN
      ''<i style="margin-left:0.6cm;width:20px;height:20px;border-radius:50%;background-color:green;display: block"></i>''
    END AS WARNING_STATUS,
    msg.biz_msg_category as WARNING_TYPE
    FROM
      POM_PROJ_PLAN_NODE node
      left JOIN SYS_MESSAGE_CENTER msg ON msg.TASK_ID = node.ID
      left JOIN SYS_USER u ON msg.owner_name=u.user_code
      where msg.TASK_ID = node.ID AND u.ID='''||userid||'''
      AND (msg.biz_msg_category=''提醒消息'' OR msg.biz_msg_category=''预警消息'')';

    IF(isread='已读消息') THEN
      v_sql_exec :=v_sql ||'  and  msg.TASK_STATE = 10 ';

    ELSE 
      v_sql_exec :=v_sql ||' and  msg.TASK_STATE = 0 ';  

    END IF;

      v_sql_exec_paging :='select a.* from ( '|| v_sql_exec|| ' and ROWNUM <= '|| pageindex * pagesizes|| ' ) a where a.rowno >= '|| pagesizes * ( pageindex - 1 )|| '';


        dbms_output.put_line(v_sql_exec);
       ----获取总条数
        EXECUTE IMMEDIATE 'SELECT count(ROWNUM) from('
                          || v_sql_exec
                          || ') a' 
                          INTO total;

        OPEN items FOR v_sql_exec_paging;

END p_pom_warning_msg_list;
/

prompt
prompt Creating procedure P_POM_WARNING_RULES_MSG
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_warning_rules_msg
(
    ruleId IN varchar2,
    messageType OUT VARCHAR2,
    info OUT SYS_REFCURSOR
)
    IS
    UseableRule clob;
    RuleType varchar2(200);
    RulePlanType varchar2(100);
    RuleNodeLevel varchar2(200);
    UseableTemplate clob;
    UseableProjIds clob;
    backlogTemplate clob;

    RuleReceiveType Number; --"接收人类型(0:集团级通用角色。10：公司级通用角色。20部门级通用角色，30，项目级通用角色。100：组织架构-公司，:110：组织-部门。120：组织架构-岗位。130：组织架构-人。200：相对人"
    RuleReceiveCode varchar2(36);

    RuleReceiveCodeStr clob;
    JUMP_URL_DOMAIN varchar2(100);
    v_sql_exec clob;
BEGIN
    --集团门户网站
    messageType:='1';
    --根据传入的规则ID，查询规则信息
    SELECT 
            REPLACE(REPLACE(EXPRESSION, '{', ''), '}', '')
            ,RULE_TYPE
            ,NODE_LEVEL
            ,'REPLACE(
                   REPLACE(
                   REPLACE(
                   REPLACE(
                   REPLACE(
                   REPLACE(
                   REPLACE(
                   REPLACE(
                   REPLACE(REPLACE('''||MESSAGE_TEMPLATE||''', ''{审核完成日期}'', APPROVAL_TIME_STR),''{任务级别}'',NODE_LEVEL),
                   ''{计划类型}'', PLAN_TYPE
                   ),  ''{当前日期}'', CURRENT_DATE_STR
                   ), ''{计划开始日期}'',PLAN_START_DATE_STR
                   ),''{计划完成日期}'',PLAN_END_DATE_STR
                   ),''{实际开始日期}'',ACTUAL_START_DATE_STR
                   ), ''{标准得分}'',STANDARD_SCORE
                   ), ''{项目名称}'',STAGE_FULL_NAME
                   ), ''{任务名称}'',NODE_NAME
               )'
        INTO 
            UseableRule
            ,RuleType
            ,RuleNodeLevel
            ,UseableTemplate
    FROM POM_RULE_SET  WHERE ID = ruleId;

    --获取规则的计划类型
     EXECUTE IMMEDIATE 'SELECT 
            WM_CONCAT(RPLANTYPE.PLAN_TYPE)
            FROM POM_RULE_SET RSET 
                LEFT JOIN POM_RULE_SET_PLAN_TYPE RPLANTYPE ON RSET.ID = RPLANTYPE.RULE_ID WHERE RSET.ID = '''||ruleId||'''' INTO RulePlanType;  --ruleId

    --根据传入的规则ID，查询未被禁用的项目IDs
    EXECUTE IMMEDIATE 'SELECT WM_CONCAT(RSCOPE.PROJECT_ID) FROM POM_RULE_SET RSET
    LEFT JOIN POM_RULE_SET_SCOPE RSCOPE ON RSET.ID = RSCOPE.RULE_ID
    WHERE RSET.IS_DISABLE = 0 
    AND RSET.ID = '''||ruleId||'''
    AND (RSCOPE.START_DATE < SYSDATE OR RSCOPE.START_DATE IS NULL)
    AND (RSCOPE.END_DATE > SYSDATE OR RSCOPE.END_DATE IS NULL)' INTO UseableProjIds;  --ruleId

    --调用函数，获取跳转域名
    JUMP_URL_DOMAIN:= GET_JUMP_URL_DOMAIN('PC', '71313f018a35f3a558166cba7599b5d6');
    --根据不同的规则类型，设置不同的待阅模板
    IF RuleType  = '预警规则' THEN
        backlogTemplate:= '{节点责任人}负责节点{任务名称},预计{10}天到期,请督促责任人进行反馈';
    ELSIF RuleType  = '提醒规则' THEN
        backlogTemplate:= '{节点责任人}负责节点{任务名称},已超期{10}天,请督促责任人进行反馈';
    END IF;
    --dbms_output.put_line('backlogTemplate'||backlogTemplate);
    --dbms_output.put_line('UseableProjIds'||UseableProjIds);
    --dbms_output.put_line('RuleNodeLevel'||RuleNodeLevel);
    --dbms_output.put_line('RulePlanType'||RulePlanType);
    --dbms_output.put_line('UseableRule'||UseableRule);
    --dbms_output.put_line('JUMP_URL_DOMAIN'||JUMP_URL_DOMAIN);
    v_sql_exec := 'SELECT * FROM (
                  select
                      ''yuzheng1'' AS "senderAccount",
     --发送人usercode如：a-xiexuhua,---门户网站的creatorName
                      USER_CODE AS "recipientAccount",
                      (SELECT APP_ID FROM SYS_APPLICATION WHERE ID = ''71313f018a35f3a558166cba7599b5d6'') AS "appid",
     --应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段---门户网站的sourceAppId
                      ''71313f018a35f3a558166cba7599b5d6'' AS "systemId",
                      ID AS "bizKey",
                      CASE WHEN '''||RuleType||''' = ''预警规则'' THEN 
                        ''预警消息''
                        WHEN '''||RuleType||''' = ''提醒规则'' THEN 
                        ''提醒消息'' END  AS "bizMsgCategory",
                      ''tjSMS,tjWeChat'' AS "msgChannel",
                      ''400014'' AS "smsTemplateid",
                      ''[]'' AS "smsParams",
                      ''无'' AS "mobile",
                      ''400014'' AS "wechatTemplateid",
                      ''[]'' AS "wechatParams",
                      ''无'' AS "wechatJumplinkUrl",
                      CASE 
                        WHEN '''||RuleType||''' = ''预警规则'' THEN 
                            REPLACE((REPLACE(REPLACE(''{节点责任人}负责节点{任务名称},已超期{10}天,请督促责任人进行反馈'', ''{10}'', TRUNC(SYSDATE)- TRUNC(PLAN_END_DATE)), ''{任务名称}'', NODE_NAME)), ''{节点责任人}'', PERSON_Names)
                        WHEN '''||RuleType||''' = ''提醒规则'' THEN 
                            REPLACE((REPLACE(REPLACE(''{节点责任人}负责节点{任务名称},预计{10}天到期,请督促责任人进行反馈'', ''{10}'', TRUNC(PLAN_END_DATE)-TRUNC(SYSDATE) ), ''{任务名称}'', NODE_NAME)), ''{节点责任人}'', PERSON_Names)
                             END AS "title",
                      CASE 
                        WHEN '''||RuleType||''' = ''预警规则'' THEN 
                            REPLACE((REPLACE(REPLACE(''{节点责任人}负责节点{任务名称},已超期{10}天,请督促责任人进行反馈'', ''{10}'', TRUNC(SYSDATE)- TRUNC(PLAN_END_DATE)), ''{任务名称}'', NODE_NAME)), ''{节点责任人}'', PERSON_Names)
                        WHEN '''||RuleType||''' = ''提醒规则'' THEN 
                            REPLACE((REPLACE(REPLACE(''{节点责任人}负责节点{任务名称},预计{10}天到期,请督促责任人进行反馈'', ''{10}'', TRUNC(PLAN_END_DATE)-TRUNC(SYSDATE) ), ''{任务名称}'', NODE_NAME)), ''{节点责任人}'', PERSON_Names)
                              END AS "bizSourceCategory",
                      10 "portalMsgType",
                      --集团门户网站消息类型（0：待办,1:已办，10：待阅，11:已阅，20：关注）
                      '''||JUMP_URL_DOMAIN||'/pom/middle?originalUrl=''||URL_ENCODE('''||JUMP_URL_DOMAIN||'/pom/mission-center-feedback/my-responsible-task?cancelType=0''||CHR(38)||''id=''||PLAN_ID||CHR(38)||''feedbackNodeId=''||ID||
                      CHR(38) || ''feedbackNodeOriginalId='' || ORIGINAL_NODE_ID || CHR(38) || ''nodeSourcePlanType=1'') "url",
                      CASE 
                        WHEN '''||RuleType||''' = ''预警规则'' THEN 
                            REPLACE((REPLACE(REPLACE(''{节点责任人}负责节点{任务名称},已超期{10}天,请督促责任人进行反馈'', ''{10}'', TRUNC(SYSDATE)- TRUNC(PLAN_END_DATE)), ''{任务名称}'', NODE_NAME)), ''{节点责任人}'', PERSON_Names)
                        WHEN '''||RuleType||''' = ''提醒规则'' THEN 
                            REPLACE((REPLACE(REPLACE(''{节点责任人}负责节点{任务名称},预计{10}天到期,请督促责任人进行反馈'', ''{10}'', TRUNC(PLAN_END_DATE)-TRUNC(SYSDATE) ), ''{任务名称}'', NODE_NAME)), ''{节点责任人}'', PERSON_Names)
                             END AS "taskname",
                      ''计划运营'' "typename",
                      PLAN_TYPE "remark",
                      TO_CHAR(SYSDATE,''yyyy-MM-dd HH:mm:ss'')  "expiretime",
                      1 "priority" --priority 否 Integer 优先级，除关注都有
                  from(
                  SELECT * FROM (
                      (
                        SELECT USER_CODE FROM SYS_USER WHERE ID IN (SELECT RECEIVER_ROLE_CODE FROM POM_RULE_RECEIVER WHERE BIZ_ID = '''||ruleId||''' AND RECEIVER_TYPE = 130)   --单个接收人
                        UNION
                        SELECT USER_CODE FROM SYS_USER WHERE ID IN(
                            SELECT USER_ID FROM SYS_STATION_TO_USER WHERE STATION_ID IN (
                                SELECT RECEIVER_ROLE_CODE FROM POM_RULE_RECEIVER WHERE BIZ_ID = '''||ruleId||''' AND RECEIVER_TYPE = 120 ))     --岗位接收人                                                                                                               --项目级角色
                      ) a
                      cross join
                      (
                        SELECT
                               NODE.ID
                              ,NODE.ORIGINAL_NODE_ID
                              ,NODE.NODE_NAME
                              ,PROJ.PROJECT_NAME
                              ,NODE.NODE_LEVEL
                              ,PLAN.ID AS PLAN_ID
                              ,PROJS.STAGE_FULL_NAME
                              ,PROJS.ID AS PROJS_ID
                              ,TO_CHAR(SYSDATE, ''yyyy-MM-dd'') AS CURRENT_DATE_STR
                              ,TO_CHAR(NODE.PLAN_START_DATE, ''yyyy-MM-dd'') AS PLAN_START_DATE_STR
                              ,TO_CHAR(NODE.PLAN_END_DATE, ''yyyy-MM-dd'') AS PLAN_END_DATE_STR
                              ,TO_CHAR(NODE.ACTUAL_START_DATE, ''yyyy-MM-dd'') AS ACTUAL_START_DATE_STR
                              ,TO_CHAR(NODE.ACTUAL_END_DATE, ''yyyy-MM-dd'') AS ACTUAL_END_DATE_STR
                              ,FB.APPROVAL_TIME
                              ,TO_CHAR(FB.APPROVAL_TIME, ''yyyy-MM-dd'') AS APPROVAL_TIME_STR
                              ,PLAN.COMPANY_ID
                              ,PLAN.PLAN_TYPE
                              ,NODE.STANDARD_SCORE
                              ,NODE.PLAN_START_DATE AS PLAN_START_DATE
                              ,NODE.PLAN_END_DATE AS PLAN_END_DATE
                              ,NODE.ACTUAL_START_DATE
                              ,NODE.ACTUAL_END_DATE
                              ,(SELECT WM_CONCAT(CHARGE_PERSON_ID) FROM POM_NODE_CHARGE_PERSON WHERE NODE_ID = NODE.ID) AS PERSON_IDs
                              ,(SELECT WM_CONCAT(CHARGE_PERSON) FROM POM_NODE_CHARGE_PERSON WHERE NODE_ID = NODE.ID) AS PERSON_Names
                          FROM POM_PROJ_PLAN_NODE NODE
                              LEFT JOIN POM_PROJ_PLAN PLAN ON NODE.PROJ_PLAN_ID = PLAN.ID
                              LEFT JOIN SYS_PROJECT_STAGE PROJS ON PLAN.PROJ_ID = PROJS.ID
                              LEFT JOIN SYS_PROJECT PROJ ON PROJS.PROJECT_ID = PROJ.ID
                              LEFT JOIN POM_NODE_FEEDBACK FB ON NODE.ID = FB.FEEDBACK_NODE_ID
                          WHERE PROJ.ID IN (                           
                                    SELECT REGEXP_SUBSTR ('''||UseableProjIds||''', ''[^,]+'', 1,rownum) from dual 
                                    connect by rownum<=LENGTH ('''||UseableProjIds||''') - LENGTH (regexp_replace('''||UseableProjIds||''', '','', ''''))+1
                              )
                              AND NODE.NODE_LEVEL = '''||RuleNodeLevel||'''
                              AND PLAN.PLAN_TYPE IN (
                                SELECT REGEXP_SUBSTR ('''||RulePlanType||''', ''[^,]+'', 1,rownum) from dual 
                                connect by rownum<=LENGTH ('''||RulePlanType||''') - LENGTH (regexp_replace('''||RulePlanType||''', '','', ''''))+1
                              ) 
                              AND PLAN.APPROVAL_STATUS = ''已审核''
                              AND NODE.PLAN_END_DATE IS NOT NULL
                              AND NODE.ACTUAL_END_DATE IS NULL
                              AND NODE.IS_DISABLE = 0
                        ) b 
                    )WHERE  '||UseableRule||'   --待阅
              )
UNION           --单个接收人与岗位接收人
select
                      ''yuzheng1'' AS "senderAccount",
     --发送人usercode如：a-xiexuhua,---门户网站的creatorName
                      USER_CODE AS "recipientAccount",
                      (SELECT APP_ID FROM SYS_APPLICATION WHERE ID = ''71313f018a35f3a558166cba7599b5d6'') AS "appid",
     --应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段---门户网站的sourceAppId
                      ''71313f018a35f3a558166cba7599b5d6'' AS "systemId",
                      ID AS "bizKey",
                      CASE WHEN '''||RuleType||''' = ''预警规则'' THEN 
                        ''预警消息''
                        WHEN '''||RuleType||''' = ''提醒规则'' THEN 
                        ''提醒消息'' END  AS "bizMsgCategory",
                      ''tjSMS,tjWeChat'' AS "msgChannel",
                      ''400014'' AS "smsTemplateid",
                      ''[]'' AS "smsParams",
                      ''无'' AS "mobile",
                      ''400014'' AS "wechatTemplateid",
                      ''[]'' AS "wechatParams",
                      ''无'' AS "wechatJumplinkUrl",
                  '||UseableTemplate||' AS "title",
                  '||UseableTemplate||' AS "bizSourceCategory",
                  10 "portalMsgType",
                  --集团门户网站消息类型（0：待办,1:已办，10：待阅，11:已阅，20：关注）
                  '''||JUMP_URL_DOMAIN||'/pom/middle?originalUrl=''||URL_ENCODE('''||JUMP_URL_DOMAIN||'/pom/mission-center-feedback/my-responsible-task?cancelType=0''||CHR(38)||''id=''||PLAN_ID||CHR(38)||''feedbackNodeId=''||ID||
                  CHR(38) || ''feedbackNodeOriginalId='' || ORIGINAL_NODE_ID || CHR(38) || ''nodeSourcePlanType=1'') "url",
                  '||UseableTemplate||' "taskname",
                  ''计划运营'' "typename",
                  PLAN_TYPE "remark",
                  TO_CHAR(SYSDATE,''yyyy-MM-dd HH:mm:ss'')  "expiretime",
                  1 "priority" --priority 否 Integer 优先级，除关注都有
FROM(
    SELECT A.USER_ACCOUNT AS USER_CODE,B.* FROM(
        SELECT RRESULT.USER_ACCOUNT ,UNIT.PARENT_ID FROM SYS_ROLE_USER_RELATION_RESULT RRESULT
            LEFT JOIN SYS_BUSINESS_UNIT UNIT ON RRESULT.COMPANY_ID = UNIT.ID
                WHERE VIRTUAL_GROUP_ID IN (
                    SELECT RECEIVER_ROLE_CODE
                    FROM POM_RULE_RECEIVER
                    WHERE BIZ_ID = '''||ruleId||'''
                      AND RECEIVER_TYPE = 40
                ) AND RRESULT.COMPANY_ID IS NOT NULL 
                GROUP BY UNIT.PARENT_ID,RRESULT.USER_ACCOUNT
    )A
    CROSS JOIN
    (
        SELECT
                NODE.ID
              ,NODE.ORIGINAL_NODE_ID
              ,NODE.NODE_NAME
              ,PROJ.PROJECT_NAME
              ,NODE.NODE_LEVEL
              ,PLAN.ID AS PLAN_ID
              ,PROJS.STAGE_FULL_NAME
              ,PROJS.ID AS PROJS_ID
              ,TO_CHAR(SYSDATE, ''yyyy-MM-dd'') AS CURRENT_DATE_STR
              ,TO_CHAR(NODE.PLAN_START_DATE, ''yyyy-MM-dd'') AS PLAN_START_DATE_STR
              ,TO_CHAR(NODE.PLAN_END_DATE, ''yyyy-MM-dd'') AS PLAN_END_DATE_STR
              ,TO_CHAR(NODE.ACTUAL_START_DATE, ''yyyy-MM-dd'') AS ACTUAL_START_DATE_STR
              ,TO_CHAR(NODE.ACTUAL_END_DATE, ''yyyy-MM-dd'') AS ACTUAL_END_DATE_STR
              ,FB.APPROVAL_TIME
              ,TO_CHAR(FB.APPROVAL_TIME, ''yyyy-MM-dd'') AS APPROVAL_TIME_STR
              ,PROJ.UNIT_ID
              ,PLAN.COMPANY_ID
              ,PLAN.PLAN_TYPE
              ,NODE.STANDARD_SCORE
              ,NODE.PLAN_START_DATE AS PLAN_START_DATE
              ,NODE.PLAN_END_DATE AS PLAN_END_DATE
              ,NODE.ACTUAL_START_DATE
              ,NODE.ACTUAL_END_DATE
              ,(SELECT WM_CONCAT(CHARGE_PERSON_ID) FROM POM_NODE_CHARGE_PERSON WHERE NODE_ID = NODE.ID) AS PERSON_IDs
              ,(SELECT WM_CONCAT(CHARGE_PERSON) FROM POM_NODE_CHARGE_PERSON WHERE NODE_ID = NODE.ID) AS PERSON_Names
            FROM POM_PROJ_PLAN_NODE NODE
                     LEFT JOIN POM_PROJ_PLAN PLAN ON NODE.PROJ_PLAN_ID = PLAN.ID
                     LEFT JOIN SYS_PROJECT_STAGE PROJS ON PLAN.PROJ_ID = PROJS.ID
                     LEFT JOIN SYS_PROJECT PROJ ON PROJS.PROJECT_ID = PROJ.ID
                     LEFT JOIN POM_NODE_FEEDBACK FB ON NODE.ID = FB.FEEDBACK_NODE_ID
            WHERE PROJ.ID IN (                           
                    SELECT REGEXP_SUBSTR ('''||UseableProjIds||''', ''[^,]+'', 1,rownum) from dual 
                    connect by rownum<=LENGTH ('''||UseableProjIds||''') - LENGTH (regexp_replace('''||UseableProjIds||''', '','', ''''))+1
              )
              AND NODE.NODE_LEVEL = '''||RuleNodeLevel||'''
              AND NODE.ACTUAL_END_DATE IS NULL
              AND NODE.IS_DISABLE = 0
              AND PLAN.PLAN_TYPE IN (
                SELECT REGEXP_SUBSTR ('''||RulePlanType||''', ''[^,]+'', 1,rownum) from dual 
                connect by rownum<=LENGTH ('''||RulePlanType||''') - LENGTH (regexp_replace('''||RulePlanType||''', '','', ''''))+1
              ) 
              AND PLAN.APPROVAL_STATUS = ''已审核''
              AND PROJ.UNIT_ID IN (
                SELECT PARENT_ID
                FROM SYS_BUSINESS_UNIT
                WHERE ID IN (
                    SELECT COMPANY_ID
                    FROM SYS_ROLE_USER_RELATION_RESULT
                    WHERE VIRTUAL_GROUP_ID IN (
                        SELECT RECEIVER_ROLE_CODE
                        FROM POM_RULE_RECEIVER
                        WHERE BIZ_ID = '''||ruleId||'''
                          AND RECEIVER_TYPE = 40
                    )
                      AND COMPANY_ID IS NOT NULL
                    GROUP BY COMPANY_ID
                    UNION
                    SELECT PARENT_ID AS COMPANY_ID
                    FROM SYS_BUSINESS_UNIT
                    WHERE PARENT_ID IN (
                        SELECT ID
                        FROM SYS_BUSINESS_UNIT
                        WHERE ID IN (
                            SELECT PARENT_ID
                            FROM SYS_BUSINESS_UNIT
                            WHERE ID IN (
                                SELECT COMPANY_ID
                                FROM SYS_ROLE_USER_RELATION_RESULT
                                WHERE VIRTUAL_GROUP_ID IN (
                                    SELECT RECEIVER_ROLE_CODE
                                    FROM POM_RULE_RECEIVER
                                    WHERE BIZ_ID = '''||ruleId||'''
                                      AND RECEIVER_TYPE = 40
                                )
                                  AND COMPANY_ID IS NOT NULL
                                GROUP BY COMPANY_ID
                            )
                              AND IS_COMPANY = 1
                              AND LEVEL_RANK = 3
                            GROUP BY PARENT_ID
                        )
                    )
                      AND ORDER_CODE = 1
                )
                GROUP BY PARENT_ID
            )
    )B WHERE A.PARENT_ID = B.UNIT_ID           --解析虚拟组
)WHERE  '||UseableRule||' 
UNION
select
                      ''yuzheng1'' AS "senderAccount",
     --发送人usercode如：a-xiexuhua,---门户网站的creatorName
                      USER_CODE AS "recipientAccount",
                      (SELECT APP_ID FROM SYS_APPLICATION WHERE ID = ''71313f018a35f3a558166cba7599b5d6'') AS "appid",
     --应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段---门户网站的sourceAppId
                      ''71313f018a35f3a558166cba7599b5d6'' AS "systemId",
                      ID AS "bizKey",
                      CASE WHEN '''||RuleType||''' = ''预警规则'' THEN 
                        ''预警消息''
                        WHEN '''||RuleType||''' = ''提醒规则'' THEN 
                        ''提醒消息'' END  AS "bizMsgCategory",
                      ''tjSMS,tjWeChat'' AS "msgChannel",
                      ''400014'' AS "smsTemplateid",
                      ''[]'' AS "smsParams",
                      ''无'' AS "mobile",
                      ''400014'' AS "wechatTemplateid",
                      ''[]'' AS "wechatParams",
                      ''无'' AS "wechatJumplinkUrl",
                  '||UseableTemplate||' AS "title",
                  '||UseableTemplate||' AS "bizSourceCategory",
                  10 "portalMsgType",
                  --集团门户网站消息类型（0：待办,1:已办，10：待阅，11:已阅，20：关注）
                  '''||JUMP_URL_DOMAIN||'/pom/middle?originalUrl=''||URL_ENCODE('''||JUMP_URL_DOMAIN||'/pom/mission-center-feedback/my-responsible-task?cancelType=0''||CHR(38)||''id=''||PLAN_ID||CHR(38)||''feedbackNodeId=''||ID||
                  CHR(38) || ''feedbackNodeOriginalId='' || ORIGINAL_NODE_ID || CHR(38) || ''nodeSourcePlanType=1'') "url",
                  '||UseableTemplate||' "taskname",
                  ''计划运营'' "typename",
                  PLAN_TYPE "remark",
                  TO_CHAR(SYSDATE,''yyyy-MM-dd HH:mm:ss'')  "expiretime",
                  1 "priority" --priority 否 Integer 优先级，除关注都有
FROM(
    SELECT A.USER_CODE,B.* FROM(
            SELECT USER_ACCOUNT AS USER_CODE, PROJECT_ID FROM SYS_ROLE_USER_RELATION_RESULT RRESULT WHERE ROLE_TYPE = ''30'' AND ROLE_CODE IN (
               SELECT RECEIVER_ROLE_CODE FROM POM_RULE_RECEIVER WHERE BIZ_ID = '''||ruleId||'''
            )
    )A
    CROSS JOIN
    (
        SELECT
                NODE.ID
              ,NODE.ORIGINAL_NODE_ID
              ,NODE.NODE_NAME
              ,PROJ.PROJECT_NAME
              ,NODE.NODE_LEVEL
              ,PLAN.ID AS PLAN_ID
              ,PROJS.STAGE_FULL_NAME
              ,PROJS.ID AS PROJS_ID
              ,TO_CHAR(SYSDATE, ''yyyy-MM-dd'') AS CURRENT_DATE_STR
              ,TO_CHAR(NODE.PLAN_START_DATE, ''yyyy-MM-dd'') AS PLAN_START_DATE_STR
              ,TO_CHAR(NODE.PLAN_END_DATE, ''yyyy-MM-dd'') AS PLAN_END_DATE_STR
              ,TO_CHAR(NODE.ACTUAL_START_DATE, ''yyyy-MM-dd'') AS ACTUAL_START_DATE_STR
              ,TO_CHAR(NODE.ACTUAL_END_DATE, ''yyyy-MM-dd'') AS ACTUAL_END_DATE_STR
              ,FB.APPROVAL_TIME
              ,TO_CHAR(FB.APPROVAL_TIME, ''yyyy-MM-dd'') AS APPROVAL_TIME_STR
              ,PROJ.ID AS PROJ_ID
              ,PLAN.COMPANY_ID
              ,PLAN.PLAN_TYPE
              ,NODE.STANDARD_SCORE
              ,NODE.PLAN_START_DATE AS PLAN_START_DATE
              ,NODE.PLAN_END_DATE AS PLAN_END_DATE
              ,NODE.ACTUAL_START_DATE
              ,NODE.ACTUAL_END_DATE
              ,(SELECT WM_CONCAT(CHARGE_PERSON_ID) FROM POM_NODE_CHARGE_PERSON WHERE NODE_ID = NODE.ID) AS PERSON_IDs
              ,(SELECT WM_CONCAT(CHARGE_PERSON) FROM POM_NODE_CHARGE_PERSON WHERE NODE_ID = NODE.ID) AS PERSON_Names
            FROM POM_PROJ_PLAN_NODE NODE
                     LEFT JOIN POM_PROJ_PLAN PLAN ON NODE.PROJ_PLAN_ID = PLAN.ID
                     LEFT JOIN SYS_PROJECT_STAGE PROJS ON PLAN.PROJ_ID = PROJS.ID
                     LEFT JOIN SYS_PROJECT PROJ ON PROJS.PROJECT_ID = PROJ.ID
                     LEFT JOIN POM_NODE_FEEDBACK FB ON NODE.ID = FB.FEEDBACK_NODE_ID
            WHERE  PROJ.ID IN (
                  SELECT PROJECT_ID FROM SYS_ROLE_USER_RELATION_RESULT RRESULT WHERE ROLE_TYPE = ''30'' AND ROLE_CODE IN (
                      SELECT RECEIVER_ROLE_CODE FROM POM_RULE_RECEIVER WHERE BIZ_ID = '''||ruleId||'''
                      ) GROUP BY PROJECT_ID
                )
              AND NODE.NODE_LEVEL = '''||RuleNodeLevel||'''
              AND NODE.ACTUAL_END_DATE IS NULL
              AND NODE.IS_DISABLE = 0
              AND PLAN.PLAN_TYPE IN (
                SELECT REGEXP_SUBSTR ('''||RulePlanType||''', ''[^,]+'', 1,rownum) from dual 
                connect by rownum<=LENGTH ('''||RulePlanType||''') - LENGTH (regexp_replace('''||RulePlanType||''', '','', ''''))+1
              ) 
              AND PLAN.APPROVAL_STATUS = ''已审核''
    )B           --解析项目级角色接收人
)WHERE  '||UseableRule||' 
UNION
    select
                      ''yuzheng1'' AS "senderAccount",
     --发送人usercode如：a-xiexuhua,---门户网站的creatorName
                      USER_CODE AS "recipientAccount",
                      (SELECT APP_ID FROM SYS_APPLICATION WHERE ID = ''71313f018a35f3a558166cba7599b5d6'') AS "appid",
     --应用id。根据系统id 联合SYS_APPLICATION 查询 appid字段---门户网站的sourceAppId
                      ''71313f018a35f3a558166cba7599b5d6'' AS "systemId",
                      ID AS "bizKey",
                      CASE WHEN '''||RuleType||''' = ''预警规则'' THEN 
                        ''预警消息''
                        WHEN '''||RuleType||''' = ''提醒规则'' THEN 
                        ''提醒消息'' END  AS "bizMsgCategory",
                      ''tjSMS,tjWeChat'' AS "msgChannel",
                      ''400014'' AS "smsTemplateid",
                      ''[]'' AS "smsParams",
                      ''无'' AS "mobile",
                      ''400014'' AS "wechatTemplateid",
                      ''[]'' AS "wechatParams",
                      ''无'' AS "wechatJumplinkUrl",
                  '||UseableTemplate||' AS "title",
                  '||UseableTemplate||' AS "bizSourceCategory",
                  0 "portalMsgType",
                  --集团门户网站消息类型（0：待办,1:已办，10：待阅，11:已阅，20：关注）
                  '''||JUMP_URL_DOMAIN||'/pom/middle?originalUrl=''||URL_ENCODE('''||JUMP_URL_DOMAIN||'/pom/mission-center-feedback/my-responsible-task?cancelType=0''||CHR(38)||''id=''||PLAN_ID||CHR(38)||''feedbackNodeId=''||ID||
                  CHR(38) || ''feedbackNodeOriginalId='' || ORIGINAL_NODE_ID || CHR(38) || ''nodeSourcePlanType=1'') "url",
                  '||UseableTemplate||' "taskname",
                  ''计划运营'' "typename",
                  PLAN_TYPE "remark",
                  TO_CHAR(SYSDATE,''yyyy-MM-dd HH:mm:ss'')  "expiretime",
                  1 "priority" --priority 否 Integer 优先级，除关注都有
FROM
        (
            SELECT * FROM (
                SELECT
                      NODE.ID
                     ,NODE.ORIGINAL_NODE_ID
                     ,NODE.NODE_NAME
                     ,PROJ.PROJECT_NAME
                     ,NODE.NODE_LEVEL
                     ,TO_CHAR(FB.APPROVAL_TIME, ''yyyy-MM-dd'') AS APPROVAL_TIME_STR
                     ,PLAN.ID AS PLAN_ID
                     ,PROJS.STAGE_FULL_NAME
                     ,PROJS.ID AS PROJS_ID
                     ,TO_CHAR(SYSDATE, ''yyyy-MM-dd'') AS CURRENT_DATE_STR
                     ,TO_CHAR(NODE.PLAN_START_DATE, ''yyyy-MM-dd'') AS PLAN_START_DATE_STR
                     ,TO_CHAR(NODE.PLAN_END_DATE, ''yyyy-MM-dd'') AS PLAN_END_DATE_STR
                     ,TO_CHAR(NODE.ACTUAL_START_DATE, ''yyyy-MM-dd'') AS ACTUAL_START_DATE_STR
                     ,TO_CHAR(NODE.ACTUAL_END_DATE, ''yyyy-MM-dd'') AS ACTUAL_END_DATE_STR
                     ,FB.APPROVAL_TIME
                     ,PLAN.COMPANY_ID
                     ,PLAN.PLAN_TYPE
                     ,PLAN.PLAN_NAME
                     ,SUSER.USER_CODE
                     ,NODE.PLAN_START_DATE AS PLAN_START_DATE
                     ,NODE.PLAN_END_DATE AS PLAN_END_DATE
                     ,NODE.ACTUAL_START_DATE
                     ,NODE.ACTUAL_END_DATE
                     ,NODE.STANDARD_SCORE
                     ,CHARGE_PERSON_ID AS PERSON_IDs
                     ,CHARGE_PERSON AS PERSON_Names
                FROM POM_PROJ_PLAN_NODE NODE
                         LEFT JOIN POM_PROJ_PLAN PLAN ON NODE.PROJ_PLAN_ID = PLAN.ID
                         LEFT JOIN SYS_PROJECT_STAGE PROJS ON PLAN.PROJ_ID = PROJS.ID
                         LEFT JOIN SYS_PROJECT PROJ ON PROJS.PROJECT_ID = PROJ.ID
                         LEFT JOIN POM_NODE_CHARGE_PERSON PERSON ON NODE.ID = PERSON.NODE_ID
                         LEFT JOIN SYS_USER SUSER ON PERSON.CHARGE_PERSON_ID = SUSER.ID
                         LEFT JOIN POM_NODE_FEEDBACK FB ON NODE.ID = FB.FEEDBACK_NODE_ID
                WHERE PROJ.ID IN (                           SELECT REGEXP_SUBSTR ('''||UseableProjIds||''', ''[^,]+'', 1,rownum) from dual connect by rownum<=LENGTH ('''||UseableProjIds||''') - LENGTH (regexp_replace('''||UseableProjIds||''', '','', ''''))+1
                              )
                              AND NODE.NODE_LEVEL = '''||RuleNodeLevel||'''
                              AND PLAN.PLAN_TYPE IN (
                                SELECT REGEXP_SUBSTR ('''||RulePlanType||''', ''[^,]+'', 1,rownum) from dual 
                                connect by rownum<=LENGTH ('''||RulePlanType||''') - LENGTH (regexp_replace('''||RulePlanType||''', '','', ''''))+1
                              ) 
                              AND PLAN.APPROVAL_STATUS = ''已审核''
                              AND NODE.PLAN_END_DATE IS NOT NULL
                              AND NODE.ACTUAL_END_DATE IS NULL
                              AND NODE.IS_DISABLE = 0
                 ) b  
            )WHERE  '||UseableRule||' )  --待办
    ';
     --dbms_output.put_line('444'||v_sql_exec);

    OPEN info FOR v_sql_exec;
END p_pom_warning_rules_msg;
/

prompt
prompt Creating procedure P_POM_W_PROJ_MAIN_LIGHT_UP
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_w_proj_main_light_up (
    companyId    IN           VARCHAR2,--公司id
    info    OUT          SYS_REFCURSOR --亮灯信息
) AS  
--项目主项计划监控-亮灯集合
--作者：陈丽
--修改：联合查询SYS_ROLE_USER_RELATION_RESULT表查询出项目计划专员  ByYedr 20200309
--日期：2019/12/07
BEGIN
    OPEN info FOR                    
    SELECT DISTINCT   B1.*,B1.TOTALNODECOUNT AS "totalNodeCount"  ,'项目计划专员:'|| CASE WHEN C1.USER_NAME is null then '无' else to_char(C1.USER_NAME) end AS "projectPlanManager"  
		FROM SYS_BUSINESS_UNIT A1  LEFT JOIN(
SELECT  D.PROJECT_NAME|| CASE WHEN C.STAGE_NAME NOT LIKE '%无分期%' THEN '_'||C.STAGE_NAME ELSE NULL END    AS "projectName"
,A.ID AS "planId"
,D.ID  as  "PROJECT_ID"
,A.COMPANY_ID
,COUNT(B.ID)  AS  "TOTALNODECOUNT"
,SUM( CASE WHEN    B.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END)  AS "actualEndNodeCount" 
,ROUND(SUM( CASE WHEN    B.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END)/COUNT(B.ID),2) AS "completeRate"
--完成率说明：截止当前完成节点数量/截止当前应完成任务数量    亮灯规则说明：1）绿灯：完成率≥95% 2）黄灯：95%>完成率≥90% 3）红灯：完成率＜90%
,
case when COUNT(B.ID)>0 then 
CASE WHEN ROUND(SUM( CASE WHEN    B.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END)/COUNT(B.ID),2)*100>=95 THEN 3 
      WHEN ROUND(SUM( CASE WHEN    B.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END)/COUNT(B.ID),2)*100>=90 then 2 
      WHEN ROUND(SUM( CASE WHEN    B.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END)/COUNT(B.ID),2)*100 <90 then 1
      ELSE 1 
  END else 1 END  AS "completeStatus"
    ,SUM( CASE WHEN  B.NODE_LEVEL='里程碑'    AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END) 
    +SUM( CASE WHEN  B.NODE_LEVEL='一级节点'  AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END) 
    +SUM( CASE WHEN  B.NODE_LEVEL='二级节点'  AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END) 
    +SUM( CASE WHEN  B.NODE_LEVEL='三级节点'  AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END) 
  --  +SUM( CASE WHEN  B.NODE_LEVEL='四级节点'  AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END) 

AS "overDueNotCompletedCount"

,SUM( CASE WHEN  B.NODE_LEVEL='里程碑'  AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END)  AS "milestoneNotCompleteCount" 
,SUM( CASE WHEN  B.NODE_LEVEL='一级节点'  AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END)  AS "oneNodeNotCompleteCount" 
,SUM( CASE WHEN  B.NODE_LEVEL='二级节点'  AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END)  AS "twoNodeNotCompleteCount" 
,SUM( CASE WHEN  B.NODE_LEVEL='三级节点'  AND  B.ACTUAL_END_DATE IS NULL AND  TRUNC(  B.PLAN_END_DATE)  < TRUNC( SYSDATE) THEN 1 ELSE 0 END)  AS "threeNodeNotCompleteCount" 
--李晓聪20200330修改排除零做除数
, case when SUM( CASE WHEN  B.NODE_LEVEL='里程碑'  THEN 1 ELSE 0 END)>0 then  ROUND(SUM( CASE WHEN  B.NODE_LEVEL='里程碑'  AND  B.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END) /SUM( CASE WHEN  B.NODE_LEVEL='里程碑'  THEN 1 ELSE 0 END),2)  else 1 end  AS "milestoneNotCompletePercent" 
,case when SUM( CASE WHEN  B.NODE_LEVEL='一级节点'  THEN 1 ELSE 0 END)>0 then ROUND(SUM( CASE WHEN  B.NODE_LEVEL='一级节点'  AND  B.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END) /SUM( CASE WHEN  B.NODE_LEVEL='一级节点'  THEN 1 ELSE 0 END),2)  else 1 end  AS "oneNodeNotCompletePercent" 
,case when SUM( CASE WHEN  B.NODE_LEVEL='二级节点'  THEN 1 ELSE 0 END)>0 then ROUND(SUM( CASE WHEN  B.NODE_LEVEL='二级节点'  AND  B.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END) /SUM( CASE WHEN  B.NODE_LEVEL='二级节点'  THEN 1 ELSE 0 END),2) else 1  end   AS "twoNodeNotCompletePercent" 
,case when SUM( CASE WHEN  B.NODE_LEVEL='三级节点'  THEN 1 ELSE 0 END)>0 then ROUND(SUM( CASE WHEN  B.NODE_LEVEL='三级节点'  AND  B.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END) /SUM( CASE WHEN  B.NODE_LEVEL='三级节点'  THEN 1 ELSE 0 END),2) else 1 end   AS "threeNodeNotCompletePercent" 

FROM POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE B ON A.ID=B.PROJ_PLAN_ID
LEFT  JOIN SYS_PROJECT_STAGE C ON C.ID=PROJ_ID
INNER JOIN SYS_PROJECT D ON (D.ID=C.PROJECT_ID or PROJ_ID=d.id) 
WHERE     A.PLAN_TYPE='项目主项计划' AND A.APPROVAL_STATUS='已审核' AND B.IS_DISABLE=0  AND B.PLAN_END_DATE<=SYSDATE
 AND  A.PLAN_VERSION IN ( SELECT MAX(PLAN_VERSION) FROM POM_PROJ_PLAN A1 WHERE  A1.PROJ_ID=A.PROJ_ID AND A1.APPROVAL_STATUS='已审核' )
GROUP BY D.PROJECT_NAME|| CASE WHEN C.STAGE_NAME NOT LIKE '%无分期%' THEN '_'||C.STAGE_NAME ELSE NULL END,A.COMPANY_ID,A.ID,D.ID )
B1 ON B1.COMPANY_ID=A1.ID 
LEFT JOIN(SELECT wm_concat(USER_NAME) AS USER_NAME,PROJECT_ID FROM SYS_ROLE_USER_RELATION_RESULT WHERE ROLE_CODE='pom_project_plan_manager' GROUP BY PROJECT_ID) C1 ON C1.PROJECT_ID=B1.PROJECT_ID
WHERE  NVL(B1.TOTALNODECOUNT,0)>0 AND  CONNECT_BY_ROOT ID =''||companyId||''
CONNECT  by PRIOR   A1.ID= A1.PARENT_ID ;
END p_pom_w_proj_main_light_up;
/

prompt
prompt Creating procedure P_POM_W_PROJ_MAIN_TREE
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_w_proj_main_tree (
    USERID VARCHAR2,
    STATIONID VARCHAR2,
    DEPTID VARCHAR2,
    COMPANYID VARCHAR2,
    info OUT SYS_REFCURSOR
)IS
    v_sql clob;
    --当前日期
    nowdate date:=trunc(sysdate);
    BIZCODE VARCHAR2(200):='POM.JHJKYKHPH.01';
    DATA_AUTH_SPID VARCHAR2(200);
BEGIN
BEGIN
  P_SYS_GET_COMPANY_PROJ_SPID(
    USERID => USERID,
    STATIONID => STATIONID,
    DEPTID => DEPTID,
    COMPANYID => COMPANYID,
    BIZCODE => BIZCODE,
    DATA_AUTH_SPID => DATA_AUTH_SPID
  );
END;
    OPEN info FOR                    
      WITH
     项目or分期 as (
    SELECT DISTINCT   B1.*
		FROM SYS_BUSINESS_UNIT A1  LEFT JOIN(
SELECT  D.PROJECT_NAME|| CASE WHEN C.STAGE_NAME NOT LIKE '%无分期%' THEN '_'||C.STAGE_NAME ELSE NULL END    AS "projectName"
,A.ID AS "planId"
,D.ID  as  "PROJECT_ID"
,A.COMPANY_ID
,COUNT(B.ID)  AS  "TOTALNODECOUNT"
,ROUND(SUM( CASE WHEN    B.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END)/COUNT(B.ID),4) AS "completeRate"
--完成率说明：截止当前完成节点数量/截止当前应完成任务数量    亮灯规则说明：1）绿灯：完成率≥95% 2）黄灯：95%>完成率≥90% 3）红灯：完成率＜90%
,
case when COUNT(B.ID)>0 then 
CASE WHEN ROUND(SUM( CASE WHEN    B.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END)/COUNT(B.ID),2)*100>=95 THEN 3 
      WHEN ROUND(SUM( CASE WHEN    B.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END)/COUNT(B.ID),2)*100>=90 then 2 
      WHEN ROUND(SUM( CASE WHEN    B.ACTUAL_END_DATE IS NOT NULL   THEN 1 ELSE 0 END)/COUNT(B.ID),2)*100 <90 then 1
      ELSE 1 
  END else 1 END  AS "completeStatus"
FROM POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE B ON A.ID=B.PROJ_PLAN_ID
LEFT  JOIN SYS_PROJECT_STAGE C ON C.ID=PROJ_ID
INNER JOIN SYS_PROJECT D ON (D.ID=C.PROJECT_ID or PROJ_ID=d.id) 
WHERE     A.PLAN_TYPE='项目主项计划' AND A.APPROVAL_STATUS='已审核' AND B.IS_DISABLE=0  AND B.PLAN_END_DATE<=SYSDATE
AND  A.PLAN_VERSION IN ( SELECT MAX(PLAN_VERSION) FROM POM_PROJ_PLAN A1 WHERE  A1.PROJ_ID=A.PROJ_ID AND A1.APPROVAL_STATUS='已审核' )
GROUP BY D.PROJECT_NAME|| CASE WHEN C.STAGE_NAME NOT LIKE '%无分期%' THEN '_'||C.STAGE_NAME ELSE NULL END,A.COMPANY_ID,A.ID,D.ID )
B1 ON B1.COMPANY_ID=A1.ID 
LEFT JOIN(SELECT wm_concat(USER_NAME) AS USER_NAME,PROJECT_ID FROM SYS_ROLE_USER_RELATION_RESULT WHERE ROLE_CODE='pom_project_plan_manager' GROUP BY PROJECT_ID) C1 ON C1.PROJECT_ID=B1.PROJECT_ID
WHERE  NVL(B1.TOTALNODECOUNT,0)>0 AND  CONNECT_BY_ROOT ID ='003200000000000000000000000000'

CONNECT  by PRIOR   A1.ID= A1.PARENT_ID)

 ,拼接项目公司树 as(
   SELECT DISTINCT
   org_id       AS "orgId",
   org_name     AS "orgName",
   0 as  "orgType",
   parent_id    AS "parentId",
   1 as "isCompany"
   ,order_code as "orderCode"
   ,0 as "red"
    ,0 as "yellow"
    ,0 as "green"

                           FROM
                               tmp_company_tree
                           WHERE
                               id = DATA_AUTH_SPID
                               AND org_id IN (
                                   SELECT DISTINCT
                                       id
                                   FROM
                                       sys_business_unit
                                   START WITH
                                       id IN (
                                           SELECT
                                               id
                                           FROM
                                               (
                                                   SELECT
                                                       unit_id AS id
                                                   FROM
                                                       sys_project
                                                   UNION
                                                   SELECT
                                                       subordinate_company_id AS id
                                                   FROM
                                                       cdb_feasible_project_config
                                               ) ds
                                       )
                                   CONNECT BY
                                       PRIOR parent_id = id
                               )

   union all
    select    "planId"       AS "orgId",
   "projectName"     AS "orgName",
   0 as  "orgType",
   COMPANY_ID    AS "parentId",
   0 as "isCompany"
   ,'0' "orderCode"
   ,case when "completeStatus"=1 then 1 else 0 end as "red"
   ,case when "completeStatus"=2 then 1 else 0 end as "yellow"
   ,case when "completeStatus"=3 then 1 else 0 end as "green"  FROM 项目or分期)

   ,汇总 as(select
    "orgId",
    "orgName",
    "orgType",
    "parentId",
   "isCompany",
   "orderCode"
--,绿灯,黄灯,红灯
,(select sum("red") from 拼接项目公司树 start with "orgId"=s."orgId" connect by prior "orgId"="parentId" ) "red"
,(select sum("yellow") from 拼接项目公司树 start with "orgId"=s."orgId" connect by prior "orgId"="parentId" ) "yellow"
,(select sum("green") from 拼接项目公司树 start with "orgId"=s."orgId" connect by prior "orgId"="parentId" ) "green"
 from 拼接项目公司树 s)

   select  *
   from 汇总   where "isCompany"=1

   order by LPAD("orderCode",10,'0')
   ;

END p_pom_w_proj_main_tree;
/

prompt
prompt Creating procedure P_POM_W_PROJ_PLAN_CHART
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_w_proj_plan_chart (
   userid                 IN                     VARCHAR2,--用户id
    planid                 IN                     VARCHAR2,--计划id
    completion_level_rate_title   OUT                    VARCHAR2,---一、按任务级别统计完成率 (%)--标题
    completion_level_rate  out SYS_REFCURSOR,---一、按任务级别统计完成率 (%)
    completion_dept_rate_title   OUT                    VARCHAR2,--- 二、按执行部门统计完成率 (%) --标题
    completion_dept_rate  out SYS_REFCURSOR---二、按执行部门统计完成率 (%)
) AS
--项目主项计划监控，详情页 ：图表
--作者：陈丽定义，李小聪实现  
--日期：2020/02/26
  v_timeout_count VARCHAR2(20):='';
  v_expect_timeout_count VARCHAR2(20):='';
BEGIN
completion_level_rate_title:='一、按任务级别统计完成率 (%)';
completion_dept_rate_title:='二、按执行部门统计完成率 (%)';

    OPEN Completion_level_rate FOR
--      SELECT  '里程碑' as "nodeName",1 as "percentage" from dual
--      UNION all 
--      SELECT  '一级节点' as "nodeName",1 as "percentage" from dual
--     UNION all 
--      SELECT  '二级节点' as "nodeName",1 as "percentage" from dual;
		SELECT   NODE_LEVEL  as "nodeName",	ROUND(SUM( CASE WHEN   B.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END) /COUNT(b.id),2)  AS "percentage" 
			FROM POM_PROJ_PLAN A INNER JOIN POM_PROJ_PLAN_NODE B ON A.ID=B.PROJ_PLAN_ID
			INNER JOIN SYS_PROJECT_STAGE C ON C.ID=PROJ_ID
			INNER JOIN SYS_PROJECT D ON D.ID=C.PROJECT_ID
			WHERE     A.PLAN_TYPE='项目主项计划' AND A.APPROVAL_STATUS='已审核' AND B.IS_DISABLE=0  AND B.PLAN_END_DATE<=SYSDATE and  a.id=''||planid||''
			GROUP BY NODE_LEVEL    ORDER BY   CASE  WHEN   NODE_LEVEL='里程碑' THEN  0 WHEN   NODE_LEVEL='一级节点' THEN  1 WHEN   NODE_LEVEL='二级节点' THEN  3   WHEN   NODE_LEVEL='三级节点' THEN  4  WHEN   NODE_LEVEL='四级节点' THEN  5 else 6 END asc;

	 OPEN completion_dept_rate FOR	 

SELECT 　B.DUTY_DEPARTMENT as "department"  , TO_CHAR( ROUND ( SUM(CASE WHEN B.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END )/COUNT(B.ID),2)) AS "percentage" 
FROM  POM_PROJ_PLAN A  INNER JOIN POM_PROJ_PLAN_NODE B ON A.id=b.PROJ_PLAN_ID
where A.PLAN_TYPE='项目主项计划' AND A.APPROVAL_STATUS='已审核'  AND B.IS_DISABLE=0  AND A.ID=''||planId||''
GROUP BY   B.DUTY_DEPARTMENT_ID,B.DUTY_DEPARTMENT
ORDER BY 2 desc;

END p_pom_w_proj_plan_chart;
/

prompt
prompt Creating procedure P_POM_W_PROJ_PLAN_DEPT
prompt =========================================
prompt
create or replace procedure pom0813.p_pom_w_proj_plan_dept(planId in varchar2,wacthinfo OUT sys_refcursor)
AS
--项目主项计划监控，部门排行图
--作者：陈丽
--日期：2019/11/13
BEGIN
open wacthinfo for

SELECT 　B.DUTY_DEPARTMENT as "department"  , TO_CHAR( ROUND ( SUM(CASE WHEN B.ACTUAL_END_DATE IS NOT NULL THEN 1 ELSE 0 END )/COUNT(B.ID),2)) AS "percentage" 
FROM  POM_PROJ_PLAN A  INNER JOIN POM_PROJ_PLAN_NODE B ON A.id=b.PROJ_PLAN_ID
where A.PLAN_TYPE='项目主项计划' AND A.APPROVAL_STATUS='已审核'  AND B.IS_DISABLE=0  AND A.ID=''||planId||''
GROUP BY   B.DUTY_DEPARTMENT_ID,B.DUTY_DEPARTMENT
ORDER BY 2 desc
;
 
 
END p_pom_w_proj_plan_dept;
/

prompt
prompt Creating procedure P_POM_W_PROJ_PLAN_DTL
prompt ========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_w_proj_plan_dtl (
    userid                 IN                     VARCHAR2,--用户id
    planid                 IN                     VARCHAR2,--计划id
    pandect_info           out SYS_REFCURSOR      --计划明细一览表
) AS
--项目主项计划监控，详情页 ：明细一览表
--作者：陈丽
--修改者：谢松宏
--修改时间：2020/05/08 
--添加5个时间转换为字符串后查询的字段，日期字段去掉时间格式
--日期：2020/02/26
BEGIN
----计划明细一览表
    OPEN pandect_info FOR
        SELECT
    proj_id,
    proj_name,
    proj_plan_id,
    node_id,
    plan_id,
    plan_type,
    original_node_id,
    warning_status,
    node_code,
    node_name,
    node_level,
    duty_department,
    duty_department_id,
    duty_mans,
    finish_status,
    standard_score,
    to_char(a.PLAN_START_DATE, 'YYYY-mm-dd') as plan_start_date,
    to_char(a.PLAN_END_DATE, 'YYYY-mm-dd') as  plan_end_date,
    to_char(a.ACTUAL_START_DATE, 'YYYY-mm-dd')  as actual_start_date,
    to_char(a.ACTUAL_END_DATE, 'YYYY-mm-dd') as actual_end_date,
    to_char(a.ESTIMATE_END_DATE, 'YYYY-mm-dd') as estimate_end_date,
    process_feed_back_con,
    finish_feed_back_con,
    overdue_feed_back_con,
     nvl(b.IS_UN_WATCH,1) as  IS_UN_WATCH
         ,to_char(a.PLAN_START_DATE, 'YYYY-mm-dd') as "PLAN_START_TIME"
         ,to_char(a.PLAN_END_DATE, 'YYYY-mm-dd') as "PLAN_END_TIME"
         ,to_char(a.ACTUAL_START_DATE, 'YYYY-mm-dd') as "ACTUAL_START_TIME"
         ,to_char(a.ACTUAL_END_DATE, 'YYYY-mm-dd') as "ACTUAL_END_TIME"
         ,to_char(a.ESTIMATE_END_DATE, 'YYYY-mm-dd') as "ESTIMATE_END_TIME"
          ,b.UN_WATCH_TIME  ,b.WATCH_TIME , 
    node_flag,
    estimate_beyond_node_flag,
    completion_standard,
    completion_results_remark
      FROM  V_POM_PROJ_MONITOR_SUMMARYLIST  a   
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' --and   b.WATCH_TIME is  not   null
      WHERE     a.PLAN_ID=''||planid||'' ORDER BY NODE_CODE asc ;
END p_pom_w_proj_plan_dtl;
/

prompt
prompt Creating procedure P_POM_W_PROJ_PLAN_OVERDUE
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_pom_w_proj_plan_overdue (
    userid                 IN                     VARCHAR2,--用户id
    planid                 IN                     VARCHAR2,--计划id
    timeout_info           OUT                    SYS_REFCURSOR,--三、超期未完成任务 
    timeout_title          OUT                    VARCHAR2,--标题 超期未完成任务：共0项
    expect_timeout_info    OUT                    SYS_REFCURSOR,--四、预计超期任务 
    expect_timeout_title   OUT                    VARCHAR2--标题预计超期任务：共0项
) AS
--项目主项计划监控，详情页 ：超期未完成任务,预计超期任务
--作者：陈丽定义，李小聪实现
--修改：联合查询SYS_ROLE_USER_RELATION_RESULT表查询出项目计划专员  ByYedr 20200309
--日期：2020/02/26
  v_timeout_count VARCHAR2(20):='';
  v_expect_timeout_count VARCHAR2(20):='';
  planning_specialist VARCHAR2(20):='';
BEGIN
   EXECUTE IMMEDIATE  
    'SELECT role.USER_NAME FROM POM_PROJ_PLAN plan LEFT JOIN SYS_PROJECT_STAGE stage ON plan.PROJ_ID=stage.ID
    LEFT JOIN SYS_PROJECT proj ON proj.ID=stage.PROJECT_ID
    LEFT JOIN (SELECT wm_concat(USER_NAME) AS USER_NAME,PROJECT_ID FROM SYS_ROLE_USER_RELATION_RESULT WHERE ROLE_CODE=''pom_project_plan_manager'' GROUP BY PROJECT_ID) role ON role.PROJECT_ID=stage.PROJECT_ID WHERE plan.ID='''||planid||'''' into planning_specialist;

    IF to_char(planning_specialist) is null then
        planning_specialist:='无';
    END IF;


 OPEN timeout_info FOR
      SELECT   a.*,nvl(b.IS_UN_WATCH,1)  as  IS_UN_WATCH ,b.UN_WATCH_TIME  ,b.WATCH_TIME  
      FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' --and   b.WATCH_TIME is  not   null
      WHERE     a.PLAN_ID=''||planid||''
      AND  TRUNC( a.PLAN_END_DATE)-TRUNC(SYSDATE)<0  and  a.ACTUAL_END_DATE  is null   ;
 OPEN expect_timeout_info FOR 
          SELECT   a.*,nvl(b.IS_UN_WATCH,1)  as  IS_UN_WATCH ,b.UN_WATCH_TIME  ,b.WATCH_TIME  
      FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND   TRUNC( a.ESTIMATE_END_DATE)-TRUNC(SYSDATE)<0   and  a.ACTUAL_END_DATE  is null  
			and  TRUNC( a.PLAN_END_DATE)-TRUNC(SYSDATE)>=0;


SELECT  (SELECT  TO_CHAR(COUNT(NODE_ID))        FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND  TRUNC( PLAN_END_DATE)-TRUNC(SYSDATE)<0  and  ACTUAL_END_DATE  is null   )  
INTO v_timeout_count  FROM  DUAL;
SELECT  (SELECT  TO_CHAR(COUNT(NODE_ID))        FROM  v_pom_proj_monitor_node_list  a    
      LEFT   JOIN SYS_BIZ_WATCH b   ON     a.NODE_ID = b.BIZ_ID  and   b.WATCHER_ID=''||userid||'' 
      WHERE     a.PLAN_ID=''||planid||''
      AND   TRUNC( ESTIMATE_END_DATE)-TRUNC(SYSDATE)<0  and  ACTUAL_END_DATE  is null 	and  TRUNC( PLAN_END_DATE)-TRUNC(SYSDATE)>=0 ) 
		
INTO v_expect_timeout_count  FROM  DUAL;
    timeout_title := '超期未完成任务：共'||v_timeout_count||'项       (项目计划专员：'||planning_specialist||')';
    expect_timeout_title := '预计超期任务：共'||v_expect_timeout_count||'项';



END p_pom_w_proj_plan_overdue;
--==========================项目主项计划监控解析计划专员===================


--==========================任务中心--关键节点计划反馈====================
/

prompt
prompt Creating procedure P_SYS_AUTH_DATA_RULE
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_SYS_AUTH_DATA_RULE ( USERID IN VARCHAR2, STATIONID IN VARCHAR2, DEPTID IN VARCHAR2, COMPANYID IN VARCHAR2, BIZCODE IN VARCHAR2 ,
DATA_AUTH_INFO OUT sys_refcursor) 
AS
--数据鉴权，返回数据权限中有权限的项目或部门（不考虑隔离规则）
--作者：谷国斌
--日期：2019/12/13
AUTHCOUNT INT;--用于判断当前公司、部门是否与数据授权的主体有关系
SPID VARCHAR2(36);--使用临时表的批次号
BEGIN

select get_uuid() into SPID from dual;


--插入数据授权的数据：

        DECLARE
                OWNERID  VARCHAR2(36);
                OENERTYPE NVARCHAR2(50);
                CURSOR cursor_company IS
                select distinct auth_owner_id,auth_owner_type from SYS_DATA_AUTH where auth_biz_code=BIZCODE and is_disabled=0;

            BEGIN   

            --打开游标
                OPEN cursor_company;
                loop
                    fetch cursor_company into OWNERID,OENERTYPE;
                    exit when cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                if OENERTYPE='公司' or OENERTYPE='集团'
                then
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                     SELECT count(*) into AUTHCOUNT FROM sys_business_unit where is_company=1 and id=COMPANYID
                    START WITH ID=OWNERID CONNECT BY PRIOR  ID=parent_id;
                    if AUTHCOUNT<>0
                    then
                        insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
                        values(SPID,OWNERID,OENERTYPE);

                    end if;

                end if;

                 if OENERTYPE='部门'
                then
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                     SELECT count(*) into AUTHCOUNT FROM sys_business_unit where is_company=0 and id=DEPTID
                    START WITH ID=OWNERID CONNECT BY PRIOR  ID=parent_id;
                    if AUTHCOUNT<>0
                    then
                        insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
                        values(SPID,OWNERID,OENERTYPE);

                    end if;

                end if;

                 if (OENERTYPE='岗位' and OWNERID=STATIONID) or (OENERTYPE='人员' and OWNERID=USERID)
                then

                       insert into TMP_AUTH_OWNER(ID,auth_owner_id,auth_owner_type)
                        values(SPID,OWNERID,OENERTYPE);    
                end if;

                end loop;

                close cursor_company;

            END;   


          --获取有权限的公司及其部门：            
                DECLARE
                        OWNERID2  VARCHAR2(36);
                        CURSOR cursor_auth IS
                        select distinct auth_owner_id from TMP_AUTH_OWNER where ID=SPID;

                    BEGIN   

                    --打开游标
                        OPEN cursor_auth;
                        loop
                            fetch cursor_auth into OWNERID2;
                            exit when cursor_auth%notfound;


                            --授权对象为公司：
                            --取授权公司的子级：
                            insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,ID FROM
                            sys_business_unit where is_company=0
                                START WITH ID in (
                                select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type in ('公司','集团') and auth_type='部门'
                                )  CONNECT BY PRIOR  ID=parent_id;


                         insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,org_id FROM
                            v_sys_project where org_type<>0
                                START WITH org_id in (
                                select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type in ('公司','集团') and auth_type='项目'
                                )  CONNECT BY PRIOR  org_id=parent_id;

                           --插入可研项目     
                          insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,id FROM
                            CDB_FEASIBLE_PROJECT_CONFIG 
                            where subordinate_company_id in
                                (select id from sys_business_unit where is_company=1 START WITH id in (
                                select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type in ('公司','集团') and auth_type='项目'
                                )  CONNECT BY PRIOR  id=parent_id);       

                             --授权对象为部门：
                               --取授权部门及其子级：

                                 insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,ID FROM
                            sys_business_unit where is_company=0
                                START WITH ID in  (select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type='部门' and auth_type='部门'
                                )  CONNECT BY PRIOR  ID=parent_id;

                               --授权对象为项目： 
                            insert into TMP_AUTH_LIST(ID,ORG_ID)
                            select SPID,org_id FROM
                            v_sys_project where org_type<>0 and project_id in 
                                 (select distinct auth_scope_id from SYS_DATA_AUTH where auth_biz_code=BIZCODE 
                                 and is_disabled=0 and auth_owner_id=OWNERID2 and auth_scope_type='项目' and auth_type='项目'
                                );   

                              end loop;
                           close  cursor_auth;    
                        end;

    --2020/2/20:成本数据库需要，增加
    --插入隔离规则-项目：
    insert into TMP_AUTH_LIST(ID,ORG_ID)
    select SPID,id from sys_project a inner join (
    select ISOLATION_RULE_VALUE from SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE=BIZCODE and ISOLATION_RULE_VALUE='全集团')
    on 1=1;
    --插入隔离规则-可研项目：
    insert into TMP_AUTH_LIST(ID,ORG_ID)
    select SPID,id from CDB_FEASIBLE_PROJECT_CONFIG a inner join (
    select ISOLATION_RULE_VALUE from SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE=BIZCODE and ISOLATION_RULE_VALUE='全集团')
    on 1=1;
    --插入隔离规则-项目：
    insert into TMP_AUTH_LIST(ID,ORG_ID)
    select SPID,id from sys_project a inner join (
    select ISOLATION_RULE_VALUE from SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE=BIZCODE and ISOLATION_RULE_VALUE='本公司')
    on 1=1 where a.unit_id=COMPANYID;
    --插入隔离规则-可研项目：
    insert into TMP_AUTH_LIST(ID,ORG_ID)
    select SPID,id from CDB_FEASIBLE_PROJECT_CONFIG a inner join (
    select ISOLATION_RULE_VALUE from SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE=BIZCODE and ISOLATION_RULE_VALUE='本公司')
    on 1=1 where a.subordinate_company_id=COMPANYID;



 open DATA_AUTH_INFO for
select distinct ORG_ID as orgId
from TMP_AUTH_LIST WHERE ID=SPID;

END P_SYS_AUTH_DATA_RULE;
/

prompt
prompt Creating procedure P_SYS_AUTH_ISOLATION_RULE
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_SYS_AUTH_ISOLATION_RULE
(
		USER_ID        IN VARCHAR2
	 ,STATION_ID     IN VARCHAR2
	 ,DEPT_ID        IN VARCHAR2
	 ,COMPANY_ID     IN VARCHAR2
	 ,BIZ_CODE       IN VARCHAR2
	 ,DATA_AUTH_INFO OUT SYS_REFCURSOR
) AS
		--隔离规则鉴权
		--作者：徐峰
		--日期：2019/12/14
BEGIN
		OPEN DATA_AUTH_INFO FOR
				SELECT CASE ISOLATION_RULE_VALUE
										WHEN '全集团' THEN
										 '003200000000000000000000000000'
										WHEN '本公司' THEN
										 COMPANY_ID
										WHEN '本部门' THEN
										 DEPT_ID
										WHEN '本岗位' THEN
										 STATION_ID
										WHEN '本岗位' THEN
										 USER_ID
										ELSE
										 ''
								END AS AUTH_SCOPE_ID,
							 SUBSTR(ISOLATION_RULE_VALUE, 2, LENGTH(ISOLATION_RULE_VALUE)) AS AUTH_SCOPE_TYPE
				FROM   SYS_DATA_AUTH_BIZ
				WHERE  BIZ_OBJ_CODE = BIZ_CODE;
END;
/

prompt
prompt Creating procedure P_SYS_DATA_AUTH
prompt ==================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_SYS_DATA_AUTH ( USER_ID IN VARCHAR2, STATION_ID IN VARCHAR2, DEPT_ID IN VARCHAR2, COMPANY_ID IN VARCHAR2, BIZ_CODE IN VARCHAR2 ,
  DATA_AUTH_INFO OUT sys_refcursor) 
AS
--数据鉴权。包含数据权限和隔离规则的鉴权。
--作者：徐峰
--日期：2019/11/17
BEGIN
 open DATA_AUTH_INFO for
--数据权限
SELECT
	AUTH_SCOPE_ID,
	AUTH_SCOPE_TYPE,
	'数据权限' AS Auth_TYPE 
FROM
	SYS_DATA_AUTH 
WHERE
    IS_DISABLED = 0
    AND auth_biz_code = BIZ_CODE
		AND ( AUTH_OWNER_ID = USER_ID OR AUTH_OWNER_ID = STATION_ID OR AUTH_OWNER_ID = DEPT_ID OR AUTH_OWNER_ID = COMPANY_ID )
	UNION all 
--隔离规则
	SELECT
CASE
	ISOLATION_RULE_VALUE 
	WHEN '全集团' THEN '003200000000000000000000000000'
	WHEN '本公司' THEN COMPANY_ID
	WHEN '本部门' THEN DEPT_ID
	WHEN '本岗位' THEN STATION_ID
	else USER_ID
END AS AUTH_SCOPE_ID,
	SUBSTR( ISOLATION_RULE_VALUE, 2, length( ISOLATION_RULE_VALUE )) AS AUTH_SCOPE_TYPE,
	'隔离规则' AS Auth_TYPE 
FROM SYS_DATA_AUTH_BIZ where BIZ_OBJ_CODE = BIZ_CODE;
END P_SYS_DATA_AUTH;
/

prompt
prompt Creating procedure P_SYS_GET_COMPANY_TREE
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_SYS_GET_COMPANY_TREE" (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    data_auth_info   OUT              SYS_REFCURSOR
) AS
--获取公司树
--作者：谷国斌
--日期：2019/12/13
    rulevalue   VARCHAR2(50);
    authcount   INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    spid        VARCHAR2(36);--使用临时表的批次号
BEGIN
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;
--插入集团作为根节点

    INSERT INTO tmp_company_tree (
        id,
        org_id,
        org_name,
        org_type,
        parent_id,
        is_company,
        order_code
    )
        SELECT
            spid,
            id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_hierarchy_code
        FROM
            sys_business_unit
        WHERE
            id = '003200000000000000000000000000';

--获取隔离规则：

    SELECT
        isolation_rule_value
    INTO rulevalue
    FROM
        sys_data_auth_biz
    WHERE
        biz_obj_code = bizcode;

    IF rulevalue = '全集团' THEN
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                is_company,
                order_hierarchy_code
            FROM
                sys_business_unit
            WHERE
                is_company = 1;

    ELSE 
--插入本公司及其父级
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                is_company,
                order_hierarchy_code
            FROM
                sys_business_unit
            WHERE
                is_company = 1
            START WITH
                id = companyid
            CONNECT BY
                PRIOR parent_id = id;

--插入数据授权的数据：

        DECLARE
            ownerid     VARCHAR2(36);
            oenertype   NVARCHAR2(50);
            CURSOR cursor_company IS
            SELECT DISTINCT
                auth_owner_id,
                auth_owner_type
            FROM
                sys_data_auth
            WHERE
                auth_biz_code = bizcode
                AND is_disabled = 0;

        BEGIN   

            --打开游标
            OPEN cursor_company;
            LOOP
                FETCH cursor_company INTO
                    ownerid,
                    oenertype;
                EXIT WHEN cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                IF oenertype = '公司' OR oenertype = '集团' THEN
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                        AND id = companyid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF oenertype = '部门' THEN
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 0
                        AND id = deptid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                    INSERT INTO tmp_auth_owner (
                        id,
                        auth_owner_id,
                        auth_owner_type
                    ) VALUES (
                        spid,
                        ownerid,
                        oenertype
                    );

                END IF;

            END LOOP;

            CLOSE cursor_company;
        END;   

          --获取有权限的公司及其父级：            

        DECLARE
            ownerid2 VARCHAR2(36);
            CURSOR cursor_auth IS
            SELECT
                auth_owner_id
            FROM
                tmp_auth_owner
            WHERE
                id = spid;

        BEGIN   

                    --打开游标
            OPEN cursor_auth;
            LOOP
                FETCH cursor_auth INTO ownerid2;
                EXIT WHEN cursor_auth%notfound;


                            --授权对象为公司：
                            --取授权公司的子级：
                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type IN (
                                    '公司',
                                    '集团'
                                )
                        )
                    CONNECT BY
                        PRIOR id = parent_id;


                            --取授权公司的父级：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type IN (
                                    '公司',
                                    '集团'
                                )
                        )
                    CONNECT BY
                        PRIOR parent_id = id;

                             --授权对应为部门：
                               --取授权部门的父级：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type = '部门'
                        )
                    CONNECT BY
                        PRIOR parent_id = id;
                               --授权对应为项目：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT
                                unit_id
                            FROM
                                sys_project
                            WHERE
                                id IN (
                                    SELECT DISTINCT
                                        auth_scope_id
                                    FROM
                                        sys_data_auth
                                    WHERE
                                        auth_biz_code = bizcode
                                        AND is_disabled = 0
                                        AND auth_owner_id = ownerid2
                                        --20200516 chenl 组织鉴权，按项目范围授权，单个项目 auth_scope_type 第一次保存错误"集团"，兼容改类数据
                                        AND (auth_scope_type = '项目' or auth_type='项目')
                                )
                        )
                    CONNECT BY
                        PRIOR parent_id = id;

            END LOOP;

            CLOSE cursor_auth;
        END;

    END IF;

    OPEN data_auth_info FOR SELECT DISTINCT
                               org_id       AS orgid,
                               org_name     AS orgname,
                               org_type     AS orgtype,
                               parent_id    AS parentid,
                               is_company   AS iscompany,
                               order_code   AS ordercode
                           FROM
                               tmp_company_tree
                           WHERE
                               id = spid
                           ORDER BY
                               order_code;

END p_sys_get_company_tree;
/

prompt
prompt Creating procedure P_SYS_GET_COMPANY_TREE_PROJ
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_sys_get_company_tree_proj (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    data_auth_info   OUT              SYS_REFCURSOR
) AS
--获取有项目的公司树
--作者：谷国斌
--日期：2019/12/13
    rulevalue   VARCHAR2(50);
    authcount   INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    spid        VARCHAR2(36);--使用临时表的批次号
BEGIN
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;
--插入集团作为根节点

    INSERT INTO tmp_company_tree (
        id,
        org_id,
        org_name,
        org_type,
        parent_id,
        is_company,
        order_code
    )
        SELECT
            spid,
            id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_hierarchy_code
        FROM
            sys_business_unit
        WHERE
            id = '003200000000000000000000000000';

--获取隔离规则：

    SELECT
        isolation_rule_value
    INTO rulevalue
    FROM
        sys_data_auth_biz
    WHERE
        biz_obj_code = bizcode;

    IF rulevalue = '全集团' THEN
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                is_company,
                order_hierarchy_code
            FROM
                sys_business_unit
            WHERE
                is_company = 1;

    ELSE 
--插入本公司及其父级
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                is_company,
                order_hierarchy_code
            FROM
                sys_business_unit
            WHERE
                is_company = 1
            START WITH
                id = companyid
            CONNECT BY
                PRIOR parent_id = id;

--插入数据授权的数据：

        DECLARE
            ownerid     VARCHAR2(36);
            oenertype   NVARCHAR2(50);
            CURSOR cursor_company IS
            SELECT DISTINCT
                auth_owner_id,
                auth_owner_type
            FROM
                sys_data_auth
            WHERE
                auth_biz_code = bizcode
                AND is_disabled = 0;

        BEGIN   

            --打开游标
            OPEN cursor_company;
            LOOP
                FETCH cursor_company INTO
                    ownerid,
                    oenertype;
                EXIT WHEN cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                IF oenertype = '公司' OR oenertype = '集团' THEN
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                        AND id = companyid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF oenertype = '部门' THEN
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 0
                        AND id = deptid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                    INSERT INTO tmp_auth_owner (
                        id,
                        auth_owner_id,
                        auth_owner_type
                    ) VALUES (
                        spid,
                        ownerid,
                        oenertype
                    );

                END IF;

            END LOOP;

            CLOSE cursor_company;
        END;   

          --获取有权限的公司及其父级：            

        DECLARE
            ownerid2 VARCHAR2(36);
            CURSOR cursor_auth IS
            SELECT
                auth_owner_id
            FROM
                tmp_auth_owner
            WHERE
                id = spid;

        BEGIN   

                    --打开游标
            OPEN cursor_auth;
            LOOP
                FETCH cursor_auth INTO ownerid2;
                EXIT WHEN cursor_auth%notfound;


                            --授权对象为公司：
                            --取授权公司的子级：
                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type IN (
                                    '公司',
                                    '集团'
                                )
                        )
                    CONNECT BY
                        PRIOR id = parent_id;


                            --取授权公司的父级：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type IN (
                                    '公司',
                                    '集团'
                                )
                        )
                    CONNECT BY
                        PRIOR parent_id = id;

                             --授权对应为部门：
                               --取授权部门的父级：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type = '部门'
                        )
                    CONNECT BY
                        PRIOR parent_id = id;
                               --授权对应为项目：

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                    START WITH
                        id IN (
                            SELECT
                                unit_id
                            FROM
                                sys_project
                            WHERE
                                id IN (
                                    SELECT DISTINCT
                                        auth_scope_id
                                    FROM
                                        sys_data_auth
                                    WHERE
                                        auth_biz_code = bizcode
                                        AND is_disabled = 0
                                        AND auth_owner_id = ownerid2
                                        --20200516 chenl 组织鉴权，按项目范围授权，单个项目 auth_scope_type 第一次保存错误"集团"，兼容改类数据
                                        AND (auth_scope_type = '项目' or auth_type='项目')
                                )
                        )
                    CONNECT BY
                        PRIOR parent_id = id;

            END LOOP;

            CLOSE cursor_auth;
        END;

    END IF;

    OPEN data_auth_info FOR SELECT DISTINCT
                               org_id       AS orgid,
                               org_name     AS orgname,
                               org_type     AS orgtype,
                               parent_id    AS parentid,
                               1 AS iscompany,
                               order_code   AS ordercode
                           FROM
                               tmp_company_tree
                           WHERE
                               id = spid
                               AND org_id IN (
                                   SELECT DISTINCT
                                       id
                                   FROM
                                       sys_business_unit
                                   START WITH
                                       id IN (
                                           SELECT
                                               id
                                           FROM
                                               (
                                                   SELECT
                                                       unit_id AS id
                                                   FROM
                                                       sys_project
                                                   UNION
                                                   SELECT
                                                       subordinate_company_id AS id
                                                   FROM
                                                       cdb_feasible_project_config
                                               ) ds
                                       )
                                   CONNECT BY
                                       PRIOR parent_id = id
                               )
                           ORDER BY
                               order_code;

END p_sys_get_company_tree_proj;
/

prompt
prompt Creating procedure P_SYS_GET_DPT_TREE
prompt =====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_sys_get_dpt_tree (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    data_auth_info   OUT              SYS_REFCURSOR
) AS
--获取有权限的公司部门树
--作者：谷国斌
--日期：2019/12/13
    rulevalue   VARCHAR2(50);
    authcount   INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    spid        VARCHAR2(36);--使用临时表的批次号
BEGIN
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;

--IS_COMPANY在这个存储过程中调整为判断是否有权限使用，如本部门时，不能看父级部门的数据。
--获取隔离规则：

    SELECT
        isolation_rule_value
    INTO rulevalue
    FROM
        sys_data_auth_biz
    WHERE
        biz_obj_code = bizcode;

    IF rulevalue = '全集团' THEN
        INSERT INTO tmp_company_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            is_company,
            order_code
        )
            SELECT
                spid,
                id,
                org_name,
                org_type,
                parent_id,
                0,
                order_hierarchy_code
            FROM
                sys_business_unit;

    ELSE
        BEGIN
            IF rulevalue = '本公司' THEN
--插入本公司及其部门
                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        0,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    START WITH
                        id = companyid
                    CONNECT BY PRIOR id = parent_id
                               AND is_company = 0;

            ELSE  
--插入本公司及当前部门
                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        0,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    WHERE
                        id = companyid;

                INSERT INTO tmp_company_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    is_company,
                    order_code
                )
                    SELECT
                        spid,
                        id,
                        org_name,
                        org_type,
                        parent_id,
                        CASE
                            WHEN id = deptid THEN
                                0
                            ELSE
                                1
                        END AS is_company,
                        order_hierarchy_code
                    FROM
                        sys_business_unit
                    START WITH
                        id = deptid
                    CONNECT BY PRIOR parent_id = id
                               AND is_company = 0;

            END IF;   
--插入数据授权的数据：

            DECLARE
                ownerid     VARCHAR2(36);
                oenertype   NVARCHAR2(50);
                CURSOR cursor_company IS
                SELECT DISTINCT
                    auth_owner_id,
                    auth_owner_type
                FROM
                    sys_data_auth
                WHERE
                    auth_biz_code = bizcode
                    AND is_disabled = 0
                    AND auth_type = '部门';

            BEGIN   

            --打开游标
                OPEN cursor_company;
                LOOP
                    FETCH cursor_company INTO
                        ownerid,
                        oenertype;
                    EXIT WHEN cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                    IF oenertype = '公司' OR oenertype = '集团' THEN
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                        SELECT
                            COUNT(*)
                        INTO authcount
                        FROM
                            sys_business_unit
                        WHERE
                            is_company = 1
                            AND id = companyid
                        START WITH
                            id = ownerid
                        CONNECT BY
                            PRIOR id = parent_id;

                        IF authcount <> 0 THEN
                            INSERT INTO tmp_auth_owner (
                                id,
                                auth_owner_id,
                                auth_owner_type
                            ) VALUES (
                                spid,
                                ownerid,
                                oenertype
                            );

                        END IF;

                    END IF;

                    IF oenertype = '部门' THEN
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                        SELECT
                            COUNT(*)
                        INTO authcount
                        FROM
                            sys_business_unit
                        WHERE
                            is_company = 0
                            AND id = deptid
                        START WITH
                            id = ownerid
                        CONNECT BY
                            PRIOR id = parent_id;

                        IF authcount <> 0 THEN
                            INSERT INTO tmp_auth_owner (
                                id,
                                auth_owner_id,
                                auth_owner_type
                            ) VALUES (
                                spid,
                                ownerid,
                                oenertype
                            );

                        END IF;

                    END IF;

                    IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END LOOP;

                CLOSE cursor_company;
            END;   

          --获取有权限的公司及其部门：            

            DECLARE
                ownerid2 VARCHAR2(36);
                CURSOR cursor_auth IS
                SELECT
                    auth_owner_id
                FROM
                    tmp_auth_owner
                WHERE
                    id = spid;

            BEGIN   

                    --打开游标
                OPEN cursor_auth;
                LOOP
                    FETCH cursor_auth INTO ownerid2;
                    EXIT WHEN cursor_auth%notfound;


                            --授权对象为公司：
                            --取授权公司的子级：
                    INSERT INTO tmp_company_tree (
                        id,
                        org_id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_code
                    )
                        SELECT
                            spid,
                            id,
                            org_name,
                            org_type,
                            parent_id,
                            0,
                            order_hierarchy_code
                        FROM
                            sys_business_unit
                        START WITH
                            id IN (
                                SELECT DISTINCT
                                    auth_scope_id
                                FROM
                                    sys_data_auth
                                WHERE
                                    auth_biz_code = bizcode
                                    AND is_disabled = 0
                                    AND auth_owner_id = ownerid2
                                    AND auth_scope_type IN (
                                        '公司',
                                        '集团'
                                    )
                                    AND auth_type = '部门'
                            )
                        CONNECT BY
                            PRIOR id = parent_id;


                             --授权对象为部门：
                               --取授权部门及其子级：

                    INSERT INTO tmp_company_tree (
                        id,
                        org_id,
                        org_name,
                        org_type,
                        parent_id,
                        is_company,
                        order_code
                    )
                        SELECT
                            spid,
                            id,
                            org_name,
                            org_type,
                            parent_id,
                            0,
                            order_hierarchy_code
                        FROM
                            sys_business_unit
                        START WITH
                            id IN (
                                SELECT DISTINCT
                                    auth_scope_id
                                FROM
                                    sys_data_auth
                                WHERE
                                    auth_biz_code = bizcode
                                    AND is_disabled = 0
                                    AND auth_owner_id = ownerid2
                                    AND auth_scope_type = '部门'
                                    AND auth_type = '部门'
                            )
                        CONNECT BY
                            PRIOR id = parent_id;

                END LOOP;

                CLOSE cursor_auth;
            END;

        END;
    END IF;

    OPEN data_auth_info FOR SELECT DISTINCT
                               org_id       AS orgid,
                               org_name     AS orgname,
                               org_type     AS orgtype,
                               parent_id    AS parentid,
                               is_company   AS isdisable,
                               CASE
                                   WHEN org_type = 0 THEN
                                       1
                                   ELSE
                                       0
                               END AS iscompany,
                               order_code   AS ordercode
                           FROM
                               tmp_company_tree
                           WHERE
                               id = spid
                           ORDER BY
                               order_code;

END p_sys_get_dpt_tree;
/

prompt
prompt Creating procedure P_SYS_GET_HAS_PROJ_TREE
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_SYS_GET_HAS_PROJ_TREE (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    data_auth_info   OUT              SYS_REFCURSOR
) AS
    --获取有权限的公司树
    --作者：韩金明
    --日期：2020年5月9日
    ruleValue   VARCHAR2(50);
    ruleOrgId        VARCHAR2(36);--使用临时表的批次号
BEGIN
    SELECT isolation_rule_value INTO rulevalue FROM sys_data_auth_biz WHERE biz_obj_code = bizcode;
    if ruleValue = '全集团' then
        ruleOrgId := '003200000000000000000000000000';
    end if;
    if ruleValue = '本公司' then
        ruleOrgId := companyId;
    end if;
    if ruleValue = '本部门' then
        ruleOrgId := deptid;
    end if;
    open data_auth_info for with t1 as (
        -- 获取所有权限公司id
        select *
        from SYS_DATA_AUTH sda
        where instr(userId||','|| stationId || ',' || deptId || ',' || companyId, sda.AUTH_OWNER_ID) > 0
          and nvl(sda.AUTH_TYPE, '项目') = '项目' and sda.AUTH_BIZ_CODE=bizCode
    ), t2 as (
        -- 加上隔离规则id
        select AUTH_SCOPE_ID from t1
        union
        select ruleOrgId from dual
    ), t3 as (
        -- 查询公司的下面所有子公司
        select distinct *
        from SYS_BUSINESS_UNIT sbu
        where IS_COMPANY = 1
        start with sbu.id in (select AUTH_SCOPE_ID from t2)
        connect by prior sbu.id = sbu.PARENT_ID
    ), t4 as (
        --查询项目不为空的公司ID
        select  distinct mp.id mid, mp.PROJECT_NAME, mp.UNIT_ID mParentId,
            nvl(mp.ORDER_HIERARCHY_CODE, mp.PROJECT_CODE)  as pCode,
            t3.*
        from t3 left join SYS_PROJECT mp on t3.ID = mp.UNIT_ID
        where mp.ID is not null
    ) select
            distinct ID orgId,
            ORG_NAME orgName,
            ORG_TYPE orgType,
            PARENT_ID parentId,
            IS_COMPANY isCompany,
            ORDER_HIERARCHY_CODE || '' orderCode
    from SYS_BUSINESS_UNIT sbu
    start with sbu.ID in (select ID from t4)
    connect by prior sbu.PARENT_ID = sbu.ID
    union
    select
        t4.mid orgId,
        t4.PROJECT_NAME orgName,
        '10' orgType,
        t4.mParentId parentId,
        0 isCompany,
        nvl(pCode, '0') orderCode
    from t4;
END P_SYS_GET_HAS_PROJ_TREE;
/

prompt
prompt Creating procedure P_SYS_GET_ISOLATION_ID
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_SYS_GET_ISOLATION_ID"
(
		USER_ID           IN VARCHAR2
	 ,STATION_ID        IN VARCHAR2
	 ,DEPT_ID           IN VARCHAR2
	 ,COMPANY_ID        IN VARCHAR2
	 ,BIZ_CODE          IN VARCHAR2
	 ,OUT_AUTH_SCOPE_ID OUT VARCHAR2
) AS
		--隔离规则鉴权
		--作者：徐峰
		--日期：2019/12/14
BEGIN

		SELECT AUTH_SCOPE_ID
		INTO   OUT_AUTH_SCOPE_ID
		FROM   (SELECT CASE ISOLATION_RULE_VALUE
												 WHEN '全集团' THEN
													'集团'
												 WHEN '本公司' THEN
													COMPANY_ID
												 WHEN '本部门' THEN
													DEPT_ID
												 WHEN '本岗位' THEN
													STATION_ID
												 WHEN '本岗位' THEN
													USER_ID
												 ELSE
													''
										 END AS AUTH_SCOPE_ID
						 FROM   SYS_DATA_AUTH_BIZ
						 WHERE  BIZ_OBJ_CODE = BIZ_CODE);

END;
/

prompt
prompt Creating procedure P_SYS_GET_PROJ_STAGE_TREE
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_sys_get_proj_stage_tree (
     userid           IN               VARCHAR2,
     stationid        IN               VARCHAR2,
     deptid           IN               VARCHAR2,
     companyid        IN               VARCHAR2,
     bizcode          IN               VARCHAR2,
     data_auth_info   OUT              SYS_REFCURSOR
 ) AS
 --获取有权限的项目树
 --作者：谢松宏
 --日期：2020/04/10
     rulevalue   VARCHAR2(50);
     authcount   INT;--用于判断当前公司、部门是否与数据授权的主体有关系
     spid        VARCHAR2(36);--使用临时表的批次号
 BEGIN
     SELECT
         get_uuid()
     INTO spid
     FROM
         dual;

 --获取隔离规则：

     SELECT
         isolation_rule_value
     INTO rulevalue
     FROM
         sys_data_auth_biz
     WHERE
             biz_obj_code = bizcode;

     IF rulevalue = '全集团' THEN
         INSERT INTO tmp_proj_tree (
             id,
             org_id,
             org_name,
             org_type,
             parent_id,
             full_name,
             is_end,
             city_name,
             company_id,
             order_code
         )
         SELECT
             spid,
             org_id,
             org_name,
             org_type,
             parent_id,
             full_name,
             is_end,
             city_name,
             company_id,
             sn
         FROM
             V_SYS_PROJECT_STAGE_TREE;

     ELSE
 --插入本公司的项目
         INSERT INTO tmp_proj_tree (
             id,
             org_id,
             org_name,
             org_type,
             parent_id,
             full_name,
             is_end,
             city_name,
             company_id,
             order_code
         )
         SELECT
             spid,
             org_id,
             org_name,
             org_type,
             parent_id,
             full_name,
             is_end,
             city_name,
             company_id,
             sn
         FROM
             V_SYS_PROJECT_STAGE_TREE
         WHERE
                 company_id = companyid;

 --插入数据授权的数据：

         DECLARE
             ownerid     VARCHAR2(36);
             oenertype   NVARCHAR2(50);
             CURSOR cursor_company IS
                 SELECT DISTINCT
                     auth_owner_id,
                     auth_owner_type
                 FROM
                     sys_data_auth
                 WHERE
                         auth_biz_code = bizcode
                   AND is_disabled = 0
                   AND nvl(auth_type, '项目') = '项目';

         BEGIN

             --打开游标
             OPEN cursor_company;
             LOOP
                 FETCH cursor_company INTO
                     ownerid,
                     oenertype;
                 EXIT WHEN cursor_company%notfound;

                 --过滤当前用户有权限的授权对象：
                 IF oenertype = '公司' OR oenertype = '集团' THEN
                     --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                     SELECT
                         COUNT(*)
                     INTO authcount
                     FROM
                         sys_business_unit
                     WHERE
                             is_company = 1
                       AND id = companyid
                     START WITH
                             id = ownerid
                     CONNECT BY
                             PRIOR id = parent_id;

                     IF authcount <> 0 THEN
                         INSERT INTO tmp_auth_owner (
                             id,
                             auth_owner_id,
                             auth_owner_type
                         ) VALUES (
                                      spid,
                                      ownerid,
                                      oenertype
                                  );

                     END IF;

                 END IF;

                 IF oenertype = '部门' THEN
                     --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                     SELECT
                         COUNT(*)
                     INTO authcount
                     FROM
                         sys_business_unit
                     WHERE
                             is_company = 0
                       AND id = deptid
                     START WITH
                             id = ownerid
                     CONNECT BY
                             PRIOR id = parent_id;

                     IF authcount <> 0 THEN
                         INSERT INTO tmp_auth_owner (
                             id,
                             auth_owner_id,
                             auth_owner_type
                         ) VALUES (
                                      spid,
                                      ownerid,
                                      oenertype
                                  );

                     END IF;

                 END IF;

                 IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                     INSERT INTO tmp_auth_owner (
                         id,
                         auth_owner_id,
                         auth_owner_type
                     ) VALUES (
                                  spid,
                                  ownerid,
                                  oenertype
                              );

                 END IF;

             END LOOP;

             CLOSE cursor_company;
         END;

         --获取有权限的公司及其父级：            

         DECLARE
             ownerid2 VARCHAR2(36);
             CURSOR cursor_auth IS
                 SELECT
                     auth_owner_id
                 FROM
                     tmp_auth_owner
                 WHERE
                         id = spid;

         BEGIN

             --打开游标
             OPEN cursor_auth;
             LOOP
                 FETCH cursor_auth INTO ownerid2;
                 EXIT WHEN cursor_auth%notfound;


                 --授权对象为公司：
                 --取授权公司的子级：
                 INSERT INTO tmp_proj_tree (
                     id,
                     org_id,
                     org_name,
                     org_type,
                     parent_id,
                     full_name,
                     is_end,
                     city_name,
                     company_id,
                     order_code
                 )
                 SELECT
                     spid,
                     org_id,
                     org_name,
                     org_type,
                     parent_id,
                     full_name,
                     is_end,
                     city_name,
                     company_id,
                     sn
                 FROM
                     V_SYS_PROJECT_STAGE_TREE
                 WHERE
                         company_id IN (
                         SELECT
                             id
                         FROM
                             sys_business_unit
                         WHERE
                                 is_company = 1
                         START WITH
                                 id IN (
                                 SELECT DISTINCT
                                     auth_scope_id
                                 FROM
                                     sys_data_auth
                                 WHERE
                                         auth_biz_code = bizcode
                                   AND is_disabled = 0
                                   AND auth_owner_id = ownerid2
                                   AND auth_scope_type IN (
                                                           '公司',
                                                           '集团'
                                     )
                                   AND nvl(auth_type, '项目') = '项目'
                             )
                         CONNECT BY
                                 PRIOR id = parent_id
                     );



                 --授权对应为项目：

                 INSERT INTO tmp_proj_tree (
                     id,
                     org_id,
                     org_name,
                     org_type,
                     parent_id,
                     full_name,
                     is_end,
                     city_name,
                     company_id,
                     order_code
                 )
                 SELECT
                     spid,
                     org_id,
                     org_name,
                     org_type,
                     parent_id,
                     full_name,
                     is_end,
                     city_name,
                     company_id,
                     sn
                 FROM
                     V_SYS_PROJECT_STAGE_TREE
                 WHERE
                         project_id IN (
                         SELECT DISTINCT
                             auth_scope_id
                         FROM
                             sys_data_auth
                         WHERE
                                 auth_biz_code = bizcode
                           AND is_disabled = 0
                           AND auth_owner_id = ownerid2
                           AND auth_scope_type = '项目'
                           AND nvl(auth_type, '项目') = '项目'
                     );

             END LOOP;

             CLOSE cursor_auth;
         END;

     END IF;

     OPEN data_auth_info FOR SELECT DISTINCT
                                 a.org_id         AS orgid,
                                 a.org_name       AS orgname,
                                 a.org_type       AS orgtype,
                                 a.parent_id      AS parentid,
                                 a.full_name      AS fullname,
                                 a.is_end         AS isend,
                                 a.city_name      AS cityname,
                                 a.company_id     AS companyid,
                                 b.company_type   AS companytype,
                                 a.order_code     AS ordercode
                             FROM
                                 tmp_proj_tree       a
                                     LEFT JOIN sys_business_unit   b ON a.org_id = b.id
                             ORDER BY
                                 a.order_code;

 END p_sys_get_proj_stage_tree;
/

prompt
prompt Creating procedure P_SYS_GET_PROJ_TREE
prompt ======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_sys_get_proj_tree (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    data_auth_info   OUT              SYS_REFCURSOR
) AS
--获取有权限的项目树
--作者：谷国斌
--日期：2019/12/14
    rulevalue   VARCHAR2(50);
    authcount   INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    spid        VARCHAR2(36);--使用临时表的批次号
BEGIN
    SELECT
        get_uuid()
    INTO spid
    FROM
        dual;

--获取隔离规则：

    SELECT
        isolation_rule_value
    INTO rulevalue
    FROM
        sys_data_auth_biz
    WHERE
        biz_obj_code = bizcode;

    IF rulevalue = '全集团' THEN
        INSERT INTO tmp_proj_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            full_name,
            is_end,
            city_name,
            company_id,
            order_code
        )
            SELECT
                spid,
                org_id,
                org_name,
                org_type,
                parent_id,
                full_name,
                is_end,
                city_name,
                company_id,
                sn
            FROM
                v_sys_project;

    ELSE 
--插入本公司的项目
        INSERT INTO tmp_proj_tree (
            id,
            org_id,
            org_name,
            org_type,
            parent_id,
            full_name,
            is_end,
            city_name,
            company_id,
            order_code
        )
            SELECT
                spid,
                org_id,
                org_name,
                org_type,
                parent_id,
                full_name,
                is_end,
                city_name,
                company_id,
                sn
            FROM
                v_sys_project
            WHERE
                company_id = companyid;

--插入数据授权的数据：

        DECLARE
            ownerid     VARCHAR2(36);
            oenertype   NVARCHAR2(50);
            CURSOR cursor_company IS
            SELECT DISTINCT
                auth_owner_id,
                auth_owner_type
            FROM
                sys_data_auth
            WHERE
                auth_biz_code = bizcode
                AND is_disabled = 0
                AND nvl(auth_type, '项目') = '项目';

        BEGIN   

            --打开游标
            OPEN cursor_company;
            LOOP
                FETCH cursor_company INTO
                    ownerid,
                    oenertype;
                EXIT WHEN cursor_company%notfound;

                --过滤当前用户有权限的授权对象：
                IF oenertype = '公司' OR oenertype = '集团' THEN
                   --AUTHCOUNT不等于0说明授权的公司包含有该公司，以下语句为递归查找所有子公司                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 1
                        AND id = companyid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF oenertype = '部门' THEN
                   --AUTHCOUNT不等于0说明授权的部门包含有该部门，以下语句为递归查找所有子部门                
                    SELECT
                        COUNT(*)
                    INTO authcount
                    FROM
                        sys_business_unit
                    WHERE
                        is_company = 0
                        AND id = deptid
                    START WITH
                        id = ownerid
                    CONNECT BY
                        PRIOR id = parent_id;

                    IF authcount <> 0 THEN
                        INSERT INTO tmp_auth_owner (
                            id,
                            auth_owner_id,
                            auth_owner_type
                        ) VALUES (
                            spid,
                            ownerid,
                            oenertype
                        );

                    END IF;

                END IF;

                IF ( oenertype = '岗位' AND ownerid = stationid ) OR ( oenertype = '人员' AND ownerid = userid ) THEN
                    INSERT INTO tmp_auth_owner (
                        id,
                        auth_owner_id,
                        auth_owner_type
                    ) VALUES (
                        spid,
                        ownerid,
                        oenertype
                    );

                END IF;

            END LOOP;

            CLOSE cursor_company;
        END;   

          --获取有权限的公司及其父级：            

        DECLARE
            ownerid2 VARCHAR2(36);
            CURSOR cursor_auth IS
            SELECT
                auth_owner_id
            FROM
                tmp_auth_owner
            WHERE
                id = spid;

        BEGIN   

                    --打开游标
            OPEN cursor_auth;
            LOOP
                FETCH cursor_auth INTO ownerid2;
                EXIT WHEN cursor_auth%notfound;


                            --授权对象为公司：
                            --取授权公司的子级：
                INSERT INTO tmp_proj_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    full_name,
                    is_end,
                    city_name,
                    company_id,
                    order_code
                )
                    SELECT
                        spid,
                        org_id,
                        org_name,
                        org_type,
                        parent_id,
                        full_name,
                        is_end,
                        city_name,
                        company_id,
                        sn
                    FROM
                        v_sys_project
                    WHERE
                        company_id IN (
                            SELECT
                                id
                            FROM
                                sys_business_unit
                            WHERE
                                is_company = 1
                            START WITH
                                id IN (
                                    SELECT DISTINCT
                                        auth_scope_id
                                    FROM
                                        sys_data_auth
                                    WHERE
                                        auth_biz_code = bizcode
                                        AND is_disabled = 0
                                        AND auth_owner_id = ownerid2
                                        AND auth_scope_type IN (
                                            '公司',
                                            '集团'
                                        )
                                        AND nvl(auth_type, '项目') = '项目'
                                )
                            CONNECT BY
                                PRIOR id = parent_id
                        );



                               --授权对应为项目：

                INSERT INTO tmp_proj_tree (
                    id,
                    org_id,
                    org_name,
                    org_type,
                    parent_id,
                    full_name,
                    is_end,
                    city_name,
                    company_id,
                    order_code
                )
                    SELECT
                        spid,
                        org_id,
                        org_name,
                        org_type,
                        parent_id,
                        full_name,
                        is_end,
                        city_name,
                        company_id,
                        sn
                    FROM
                        v_sys_project
                    WHERE
                        project_id IN (
                            SELECT DISTINCT
                                auth_scope_id
                            FROM
                                sys_data_auth
                            WHERE
                                auth_biz_code = bizcode
                                AND is_disabled = 0
                                AND auth_owner_id = ownerid2
                                AND auth_scope_type = '项目'
                                AND nvl(auth_type, '项目') = '项目'
                        );

            END LOOP;

            CLOSE cursor_auth;
        END;

    END IF;

    OPEN data_auth_info FOR SELECT DISTINCT
                               a.org_id         AS orgid,
                               a.org_name       AS orgname,
                               a.org_type       AS orgtype,
                               a.parent_id      AS parentid,
                               a.full_name      AS fullname,
                               a.is_end         AS isend,
                               a.city_name      AS cityname,
                               a.company_id     AS companyid,
                               b.company_type   AS companytype,
                               a.order_code     AS ordercode
                           FROM
                               tmp_proj_tree       a
                               LEFT JOIN sys_business_unit   b ON a.org_id = b.id
                           ORDER BY
                               a.order_code;

END p_sys_get_proj_tree;
/

prompt
prompt Creating procedure P_SYS_MSG_BY_TYPE
prompt ====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_sys_msg_by_type( isMobile in int,msgType IN VARCHAR2,systemId IN VARCHAR2,userName IN VARCHAR2,wherestr  IN VARCHAR2,datalist OUT SYS_REFCURSOR,total out int )
as
rowcountBySystemId  int;
whereSql VARCHAR2(200);
orderSql VARCHAR2(200);
systemWhereSql VARCHAR2(2000);
appid VARCHAR2(1000);
selectSql VARCHAR2(4000);
likeWhereSql  VARCHAR2(1000);
v_sql VARCHAR2(1000);
systemIds VARCHAR2(1000);
BEGIN
likeWhereSql:=' ';
/*判断是否传入筛选语句，传入格式为%条件%*/
if wherestr is not null then
likeWhereSql:=' and ( task_name like '''||wherestr||''' or  type_name like '''||wherestr||''')';
end if;
/*判断是否传入系统id条件，加入系统筛选*/
if systemId is not null then
   if instr(systemId,',',1,1) !=0 then
         systemIds:=''''||replace(systemId, ',', ''',''')||'''';
         execute immediate ' select count(1) from  SYS_APPLICATION  s where s.id in ('||systemIds||')' INTO  rowcountBySystemId;
          if rowcountBySystemId<>0 THEN
             execute immediate '  select  WMSYS.WM_CONCAT(APP_ID)  from  SYS_APPLICATION  s  where s.id in ('||systemIds||')' INTO  appid;
             appid:=''''||replace(appid, ',', ''',''')||'''';
             systemWhereSql:=' and SOURCE_APP_ID in ('||appid||')';
          end if;
    else
        select count(1) into rowcountBySystemId  from  SYS_APPLICATION  s
        where s.id=systemId;
        if rowcountBySystemId<>0 THEN
        select APP_ID into appid  from  SYS_APPLICATION  s
        where s.id=systemId;
        systemWhereSql:=' and SOURCE_APP_ID= '''||appid||'''';
        end if;
   end if;
end if;
/*根据传入类型不同展示不同的时间列*/
if msgType='todo' then
selectSql:=' SELECT
    {url},
   created as startTime,
    task_name as processInstName,
    CREATOR_NAME as partiName,
    BIZ_MSG_CATEGORY  as activityInstName,
    type_name as processChName,
    CREATOR_NAME as sender
FROM
    sys_message_center where owner_name=  '''||userName||'''';
whereSql:=' and MSG_TYPE=0 and TASK_STATE=0';
ELSIF  msgType='haveTodo' then
selectSql:=' SELECT
    {url},
    complete_time as startTime,
    task_name as processInstName,
    CREATOR_NAME as partiName,
    BIZ_MSG_CATEGORY  as activityInstName,
    type_name as processChName,
    CREATOR_NAME as sender
FROM
    sys_message_center where owner_name=  '''||userName||'''';
whereSql:=' and MSG_TYPE=0 and TASK_STATE=10';
orderSql:=' order by EXPIRE_TIME desc';
ELSIF  msgType='unRead' then
selectSql:=' SELECT
    {url},
    created as startTime,
    task_name as processInstName,
    cuser.user_name as partiName,
    BIZ_MSG_CATEGORY  as activityInstName,
    type_name as processChName,
    cuser.user_name as sender
FROM
    sys_message_center 
    left join sys_user cuser 
    on sys_message_center.CREATOR_NAME=cuser.user_code 
    where owner_name=  '''||userName||'''';
whereSql:=' and MSG_TYPE=10 and TASK_STATE=0';
ELSIF  msgType='haveRead' then
selectSql:=' SELECT
    {url},
    complete_time as startTime,
    task_name as processInstName,
    cuser.user_name as partiName,
    BIZ_MSG_CATEGORY  as activityInstName,
    type_name as processChName,
    cuser.user_name as sender
FROM
    sys_message_center 
    left join sys_user cuser 
    on sys_message_center.CREATOR_NAME=cuser.user_code 
    where owner_name=  '''||userName||'''';
whereSql:=' and MSG_TYPE=10 and TASK_STATE=10';
else
selectSql:=' SELECT
    {url},
    complete_time as startTime,
    task_name as processInstName,
    cuser.user_name as partiName,
    BIZ_MSG_CATEGORY  as activityInstName,
    type_name as processChName,
    cuser.user_name as sender
FROM
    sys_message_center 
    left join sys_user cuser 
    on sys_message_center.CREATOR_NAME=cuser.user_code 
    where owner_name=  '''||userName||'''';
whereSql:=' and MSG_TYPE=20';
end if;
dbms_output.put_line(whereSql);
/*拼接sql*/
selectSql:=selectSql||whereSql||systemWhereSql||likeWhereSql;
/*根据传入是否为移动端来打开不同的地址*/
if isMobile=1 then
selectSql:=replace(selectSql,'{url}','mobile_url as url');
else
selectSql:=replace(selectSql,'{url}','pc_url as url');
end if;
dbms_output.put_line(selectSql);
  v_sql:= 'select count(*) FROM (' || selectSql || ')';
  EXECUTE IMMEDIATE v_sql INTO total;
OPEN datalist FOR selectSql;
EXCEPTION
WHEN OTHERS THEN
 CLOSE datalist;
end p_sys_msg_by_type;
--==============================================================数据动态化==================================================================
/

prompt
prompt Creating procedure P_SYS_MSG_CONFIG_HAVETODO
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_sys_msg_config_havetodo(
    havetodoPCAddress in varchar2,         --消息打开pc端地址
    projectID  in varchar2,                    --项目实例ID
    msgCode in varchar2,                     --消息的code
    messageType out      varchar2,       --0:门户终端消息都推送，1：只推送门户，2：只推送短信或微信
    info     OUT      SYS_REFCURSOR     --消息集合
) IS
rowcount number;
config_code varchar2(100);
havetodopcurl  varchar2(4000);
systemId varchar2(36);
systemappId varchar(36);
bizMsgCategory varchar2(50);
project_id varchar2(50);
begin
  execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd hh24:mi:ss''';
  if projectID is not null and instr(projectID,';',1,1) <> 0 then
        project_id:=splitstr(projectID,1,';');
    else
        project_id:=projectID;
  end if;
  execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd hh24:mi:ss''';
  messageType:=1;
  bizMsgCategory:='催办消息';
  config_code:=replace(msgCode,'HaveToDo','');
  havetodopcurl:=replace(havetodoPCAddress,'||','&');
  select count(1) into rowcount from SYS_MESSAGE_CONFIG  where CODE=msgCode;
  if rowcount=1 then
    select f.SYSTEM_ID,s.APP_ID into systemId,systemappId from SYS_MESSAGE_CONFIG f left join SYS_APPLICATION s on f.SYSTEM_ID=s.ID  where f.CODE=msgCode;
    OPEN info FOR 
 select 
    tab.CREATOR_NAME as "senderAccount",                        --发送人
    tab.OWNER_NAME as  "recipientAccount",    --接收人
    systemId as  "systemId",--系统id
    systemappId as   "appid",--应用id
    tab.TASK_ID as "bizKey",--业务id--门户网站的taskId
    tab.BIZ_MSG_CATEGORY as "bizMsgCategory",--消息所属类别
-------------------------------------------------------------【短信微信必须】基础信息 ------------------------------------------------------------
    '' as "msgChannel", --使用消息渠道 多个，逗号分隔   tjWeChat：铁建微信,tjSMS：铁建短信
    '' as "smsTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID  --{1}您好，{2}对您负责的任务“{3}”进行了催办，请及时到门户网站查看待办并在《计划管理系统》中反馈任务进度{4}。
    '[]' AS "smsParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
    ''  as "mobile",--短信接收人电话
    '' AS "wechatTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID
    '[]' AS "wechatParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
    '' AS "wechatJumplinkUrl",--微信打开地址，程序调用发消息前需要编码
    '' AS "title",--消息标题
    '' AS "bizSourceCategory",
-------------------------------------------------------------【门户消息必须】基础信息 ------------------------------------------------------------
    1 as "portalMsgType",
    havetodopcurl as "url",--pc端的url地址
    '' as "mobileUrl",--移动端的url地址
    tab.TASK_NAME as "taskname", --任务名称，等于3、插入待阅/4、插入已阅informationname;等于插入关注的attentionname
    tab.TYPE_NAME as "typename",--任务类型
    '' as "remark",
     to_char(sysdate,'yyyy-MM-dd HH24:mi:ss')  "expiretime",--expiretime	否	String	过期时间，格式yyyy-MM-dd HH:mm:ss-----过期时间，除关注都有
     1  "priority"--priority	否	Integer	优先级，除关注都有 
    from 
    (select CREATOR_NAME,OWNER_NAME,TASK_ID,TASK_NAME,TYPE_NAME,BIZ_MSG_CATEGORY from SYS_MESSAGE_CENTER where  TASK_STATE=0 and MSG_TYPE=0 and  (REMARK=config_code||'ToDo_'||projectID or  REMARK=config_code||'ToDo_'||project_id)
      )tab;    
end if;
END p_sys_msg_config_havetodo;
/

prompt
prompt Creating procedure P_SYS_PERSON_LIST_ANALYSIS
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_sys_person_list_analysis (
    noticepersons        IN                   CLOB,          --用户code多个
    noticegroups         IN                   CLOB,        --虚拟组
    noticeprojectroles   IN                   CLOB,  --项目级角色
    noticeorgids         IN                   CLOB,        --组织Id
    projectid            IN                   VARCHAR2,
    uuid                 OUT                  VARCHAR2
) IS
    companyid   VARCHAR2(36);
    row_count   NUMBER;
BEGIN
    SELECT
        get_uuid()
    INTO uuid
    FROM
        dual;

    IF noticepersons IS NOT NULL THEN
        INSERT INTO person_role_analysis_table
            SELECT
                splitstr(column_value, 2),
                splitstr(column_value, 1) AS detail,
                'userid' AS type
            FROM
                TABLE ( split(noticepersons, ';') );

        INSERT INTO person_role_analysis_table
            SELECT
                r.user_code,
                uuid,
                'person'
            FROM
                (
                    SELECT
                        *
                    FROM
                        person_role_analysis_table
                    WHERE
                        type = 'userid'
                        AND code IS NOT NULL
                ) tab
                LEFT JOIN sys_user r ON tab.code = r.id
            WHERE
                r.user_code IS NOT NULL;

        DELETE person_role_analysis_table
        WHERE
            type = 'userid';

    END IF;

    IF noticegroups IS NOT NULL THEN
        INSERT INTO person_role_analysis_table
            SELECT
                splitstr(column_value, 1) AS code,
                splitstr(column_value, 2) AS detail,
                'group' AS type
            FROM
                TABLE ( split(noticegroups, ';') );

        IF projectid IS NULL THEN
            INSERT INTO person_role_analysis_table
                SELECT
                    r.user_account,
                    uuid,
                    'person'
                FROM
                    (
                        SELECT
                            *
                        FROM
                            person_role_analysis_table
                        WHERE
                            type = 'group'
                            AND code IS NOT NULL
                    ) tab
                    LEFT JOIN sys_role_user_relation_result r ON tab.code = r.virtual_group_name
                WHERE
                    r.role_type = 40
                    AND r.user_account IS NOT NULL;

        ELSE
        --获取项目的所属公司
          --判断是否能够在mdm中查询到id=项目原始id(传入项目id)的数据
            SELECT
                COUNT(1)
            INTO row_count
            FROM
                mdm_project
            WHERE
                id = projectid;

            IF row_count <> 0 THEN
                SELECT
                    company_id
                INTO companyid
                FROM
                    mdm_project
                WHERE
                    id = projectid
                    AND ROWNUM = 1;

            END IF;
            --判断是否能够在mdm中查询到项目原始id=项目原始id(传入项目id)的数据，如果有查询审批时间最近的一条
            SELECT
                COUNT(1)
            INTO row_count
            FROM
                mdm_project
            WHERE
                project_original_id = projectid
                AND approval_time IS NOT NULL
            ORDER BY
                approval_time DESC;
            IF row_count <> 0 THEN
                SELECT
                    company_id
                INTO companyid
                FROM
                    mdm_project
                WHERE
                    project_original_id = projectid
                    AND ROWNUM = 1
                    AND approval_time IS NOT NULL
                ORDER BY
                    approval_time DESC;

            END IF;

            IF companyid IS NOT NULL THEN
                dbms_output.put_line('COMPANYID:' || companyid);
                INSERT INTO person_role_analysis_table
                    SELECT
                        r.user_account,
                        uuid,
                        'person'
                    FROM
                        sys_role_user_relation_result r    

                        --【三级单位】：获取当前项目所属公司，递归所有父级公司集合（项目所属公司在三级单位子级公司），包含自身（项目所属公司在三级单位），并且公司层级=3，公司id作为虚拟组解析公司。

                        --递归所有父级公司集合，包含自身，并且公司层级=3
                        INNER JOIN (
                            SELECT
                                id
                            FROM
                                (
                                    SELECT
                                        *
                                    FROM
                                        sys_business_unit m
                                    START WITH
                                        m.id = companyid
                                    CONNECT BY
                                        PRIOR m.parent_id = m.id
                                ) org
                            WHERE
                                org.is_company = 1
                                AND org.level_rank = 3
                            UNION ALL

                        --chenl  20200718  项目所属公司在三级单位。期望解析三级单位的子公司，计划运营岗位（实际是四级单位的）的人。
                            SELECT
                                id
                            FROM
                                sys_business_unit m
                            WHERE
                                m.parent_id = companyid
                                AND m.is_company = 1
                                AND m.level_rank = 4
                        ) org ON r.company_id = org.id
                    WHERE
                        r.virtual_group_name IN (
                            SELECT
                                code
                            FROM
                                person_role_analysis_table
                            WHERE
                                type = 'group'
                                AND code IS NOT NULL
                                AND code LIKE '%【三级单位】%'
                        )
                        AND r.role_type = 40
                        AND r.user_account IS NOT NULL
                    UNION
                    SELECT
                        r.user_account,
                        uuid,
                        'person'
                    FROM
                        sys_role_user_relation_result r    

                          --兄弟节点和所有子级，并且公司层级=3
                        INNER JOIN (
                            SELECT
                                id
                            FROM
                                (
                                    SELECT
                                        *
                                    FROM
                                        sys_business_unit m1
                                    WHERE
                                        EXISTS (
                                            SELECT
                                                *
                                            FROM
                                                sys_business_unit m2
                                            WHERE
                                                m1.parent_id = m2.parent_id
                                                AND m2.id = companyid
                                        )
                                    UNION
                                    SELECT
                                        *
                                    FROM
                                        sys_business_unit m
                                    START WITH
                                        m.id = companyid
                                    CONNECT BY
                                        m.parent_id = PRIOR m.id
                                ) org
                            WHERE
                                org.is_company = 1
                                AND org.level_rank = 3
                        ) org ON r.company_id = org.id
                    WHERE
                        r.virtual_group_name IN (
                            SELECT
                                code
                            FROM
                                person_role_analysis_table
                            WHERE
                                type = 'group'
                                AND code IS NOT NULL
                                AND code LIKE '%【二级单位】%'
                        )
                        AND r.role_type = 40
                        AND r.user_account IS NOT NULL;

            END IF;

        END IF;

        DELETE person_role_analysis_table
        WHERE
            type = 'group';

    END IF;

    IF noticeprojectroles IS NOT NULL THEN
        INSERT INTO person_role_analysis_table
            SELECT
                splitstr(column_value, 2) AS code,
                splitstr(column_value, 1) AS detail,
                'projectRole' AS type
            FROM
                TABLE ( split(noticeprojectroles, ';') );

        INSERT INTO person_role_analysis_table
            SELECT
                r.user_account,
                uuid,
                'person'
            FROM
                (
                    SELECT
                        *
                    FROM
                        person_role_analysis_table
                    WHERE
                        type = 'projectRole'
                        AND code IS NOT NULL
                ) tab
                LEFT JOIN sys_role_user_relation_result r ON tab.code = r.role_code
            WHERE
                r.role_type = 30
                AND r.project_id = projectid
                AND r.user_account IS NOT NULL;

        DELETE person_role_analysis_table
        WHERE
            type = 'projectRole';

    END IF;

    IF noticeorgids IS NOT NULL THEN
        INSERT INTO person_role_analysis_table
            SELECT
                splitstr(column_value, 2) AS code,
                splitstr(column_value, 1) AS detail,
                'org' AS type
            FROM
                TABLE ( split(noticeorgids, ';') );

        INSERT INTO person_role_analysis_table
            SELECT
                sys_user.user_code,
                uuid,
                'person'
            FROM
                (
                    SELECT
                        *
                    FROM
                        sys_business_unit m
                    START WITH
                        m.id IN (
                            SELECT
                                code
                            FROM
                                person_role_analysis_table
                            WHERE
                                type = 'org'
                        )
                    CONNECT BY
                        m.parent_id = PRIOR m.id
                ) tab
                LEFT JOIN sys_station ON tab.id = sys_station.org_id
                LEFT JOIN sys_station_to_user ON sys_station.id = sys_station_to_user.station_id
                LEFT JOIN sys_user ON sys_user.id = sys_station_to_user.user_id
            WHERE
                sys_user.user_code IS NOT NULL;

        DELETE person_role_analysis_table
        WHERE
            type = 'org';

    END IF;

END p_sys_person_list_analysis;
/

prompt
prompt Creating procedure P_SYS_MSG_CONFIG_INFO_HELP
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_SYS_MSG_CONFIG_INFO_HELP" (
    toDoPCAddress    IN     varchar2,     -- 消息打开pc端地址
    toReadPCAddress in varchar2,         --消息打开mobile端地址
    toDoTitle  in varchar2,                     --消息标题
    toReadTitle  in varchar2,                  --消息标题
    projectID  in varchar2,                    --项目实例ID
    msgCode in varchar2,                     --消息的code
    creater in varchar2,                        --发送人usercode
    uuid in varchar2
) IS
todorow number;
toreadrow number;
rowcount number:=0;
todo_systemId  varchar2(100);
todo_systemappId  varchar2(100);
toread_systemId  varchar2(100);
toread_systemappId  varchar2(100);
bizMsgCategory varchar2(100);
todopcurl  varchar2(4000);
toreadpcurl  varchar2(4000);
todomsgId varchar2(36);
toreadmsgId varchar2(36);
config_code varchar(100);

todoNOTICEGROUPS CLOB;
todoNOTICEPROJECTROLES CLOB;
todoNOTICEORGIDS CLOB;
todoNOTICEPERSONS CLOB;

toreadNOTICEGROUPS CLOB;
toreadNOTICEPROJECTROLES CLOB;
toreadNOTICEORGIDS CLOB;
toreadNOTICEPERSONS CLOB;

todopersonuuid varchar2(36);
toreadpersonuuid varchar2(36);
typename varchar2(50);

project_id varchar2(50);
periodId varchar2(50);

project_name varchar2(100);
period_name varchar2(1000);

toDo_Title varchar2(1000);
toRead_Title varchar2(1000);

domain varchar2(1000);
begin
  execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd hh24:mi:ss''';
  if projectID is not null and instr(projectID,';',1,1) <> 0 then
        project_id:=splitstr(projectID,1,';');
        periodId:=splitstr(projectID,2,';');
    else
        project_id:=projectID;
  end if;
  typename:='计划运营';
  bizMsgCategory:='催办消息';
  config_code:=replace(msgCode,'ToDo','');
  todopcurl:=replace(toDoPCAddress,'||','&');
  toreadpcurl:=replace(toReadPCAddress,'||','&');
  toDo_Title:=toDoTitle;
  toRead_Title:=toReadTitle;
  --判断是否已经推送过该消息，如果推送过则不再进行消息推送，【如果不需要验证请注释掉查询语句】
select  count(1) into rowcount from SYS_MESSAGE_CENTER where REMARK=config_code||'ToDo_'||projectID or  REMARK=config_code||'ToDo_'||project_id;
  if rowcount = 0 then   
  --处理关键字 start
  if instr(toreadpcurl,'{projectId}',1,1) <> 0 or instr(todopcurl,'{projectId}',1,1) <> 0 then
      select PROJECT_NAME into  project_name from mdm_project where PROJECT_ORIGINAL_ID=project_id and rownum=1;
                toreadpcurl:=replace(toreadpcurl,'{projectName}',project_name);
                toreadpcurl:=replace(toreadpcurl,'{projectId}',project_id);
                todopcurl:=replace(todopcurl,'{projectName}',project_name);
                todopcurl:=replace(todopcurl,'{projectId}',project_id);
                toDo_Title:=replace(toDo_Title,'{projectName}',project_name);
                toDo_Title:=replace(toDo_Title,'{projectId}',project_id);
                toRead_Title:=replace(toRead_Title,'{projectName}',project_name);
                toRead_Title:=replace(toRead_Title,'{projectId}',project_id);
      if periodId is not null and ( instr(toreadpcurl,'{projectId}',1,1) <> 0 or instr(todopcurl,'{periodId}',1,1) <> 0 ) then
        select PERIOD_NAME into  period_name from MDM_PERIOD where ID=periodId and rownum=1;
                 toreadpcurl:=replace(toreadpcurl,'{periodName}',period_name);
                toreadpcurl:=replace(toreadpcurl,'{periodId}',periodId);
                todopcurl:=replace(todopcurl,'{periodName}',period_name);
                todopcurl:=replace(todopcurl,'{periodId}',periodId);
                toDo_Title:=replace(toDo_Title,'{periodName}',period_name);
                toDo_Title:=replace(toDo_Title,'{periodId}',periodId);
                toRead_Title:=replace(toRead_Title,'{periodName}',period_name);
                toRead_Title:=replace(toRead_Title,'{periodId}',periodId);
      end if;
  end if;
--处理关键字 end

  select count(1) into todorow from SYS_MESSAGE_CONFIG  where CODE=config_code||'ToDo';
  if todorow=1 then
  select f.SYSTEM_ID,s.APP_ID,f.id,case when  f.SYSTEM_ID='534e2b6a0d5bb4fec7d55f551f8930ab' then '项目主数据' when  f.SYSTEM_ID='25094143a887a05c3f0e0f1cd5ac938d' then '动态货值管理' else '计划运营' end typename  into todo_systemId,todo_systemappId,todomsgId,typename from SYS_MESSAGE_CONFIG f left join SYS_APPLICATION s on f.SYSTEM_ID=s.ID  where f.CODE=config_code||'ToDo';
    --处理代办发送人信息 start
    if instr(todopcurl,'http://',1,1) = 0 and instr(todopcurl,'https://',1,1) = 0 then
        select APPLICATION_URL  into domain from SYS_APPLICATION_TERMINAL where APPLICATION_ID=todo_systemId and APPLICATION_TERMINAL_CODE='PC' and rownum=1;
        todopcurl:=domain||todopcurl;
    end if;
    select  count(1) into rowcount from SYS_MESSAGE_CONFIG_RECEIVER where MESSAGE_CONFIG_ID=todomsgId and TYPE=40;
        if rowcount<>0 then
            select RECEIVER_VALUE into todoNOTICEGROUPS from SYS_MESSAGE_CONFIG_RECEIVER where MESSAGE_CONFIG_ID=todomsgId and TYPE=40;
        end if;
    select  count(1) into rowcount from SYS_MESSAGE_CONFIG_RECEIVER where MESSAGE_CONFIG_ID=todomsgId and TYPE=30;
        if rowcount<>0 then
            select RECEIVER_VALUE into todoNOTICEPROJECTROLES from SYS_MESSAGE_CONFIG_RECEIVER where MESSAGE_CONFIG_ID=todomsgId and TYPE=30;
        end if;
     select  count(1) into rowcount from SYS_MESSAGE_CONFIG_RECEIVER where MESSAGE_CONFIG_ID=todomsgId and TYPE=110;
        if rowcount<>0 then
            select RECEIVER_VALUE into todoNOTICEORGIDS from SYS_MESSAGE_CONFIG_RECEIVER where MESSAGE_CONFIG_ID=todomsgId and TYPE=110;
        end if;
     select  count(1) into rowcount from SYS_MESSAGE_CONFIG_RECEIVER where MESSAGE_CONFIG_ID=todomsgId and TYPE=130;
        if rowcount<>0 then
            select RECEIVER_VALUE into todoNOTICEPERSONS from SYS_MESSAGE_CONFIG_RECEIVER where MESSAGE_CONFIG_ID=todomsgId and TYPE=130;
        end if;
 P_SYS_PERSON_LIST_ANALYSIS(
    NOTICEPERSONS => todoNOTICEPERSONS,
    NOTICEGROUPS => todoNOTICEGROUPS,
    NOTICEPROJECTROLES => todoNOTICEPROJECTROLES,
    NOTICEORGIDS => todoNOTICEORGIDS,
    PROJECTID => project_id,
    UUID => todopersonuuid
  );
 select count(1) into rowcount  from PERSON_ROLE_ANALYSIS_TABLE where detail=todopersonuuid;
dbms_output.put_line('todo:'||rowcount);
   --处理代办发送人信息 end;
  end if;
  select count(1) into toreadrow from SYS_MESSAGE_CONFIG  where CODE=config_code||'ToRead';
  if toreadrow=1 then
  select f.SYSTEM_ID,s.APP_ID,f.id into toread_systemId,toread_systemappId,toreadmsgId from SYS_MESSAGE_CONFIG f left join SYS_APPLICATION s on f.SYSTEM_ID=s.ID  where f.CODE=config_code||'ToRead';
    if instr(toreadpcurl,'http://',1,1) = 0 then
        select APPLICATION_URL  into domain from SYS_APPLICATION_TERMINAL where APPLICATION_ID=toread_systemId and APPLICATION_TERMINAL_CODE='PC' and rownum=1;
        toreadpcurl:=domain||toreadpcurl;
    end if;
   --处理待阅发送人信息 start
    select  count(1) into rowcount from SYS_MESSAGE_CONFIG_RECEIVER where MESSAGE_CONFIG_ID=toreadmsgId and TYPE=40;
        if rowcount<>0 then
            select RECEIVER_VALUE into toreadNOTICEGROUPS from SYS_MESSAGE_CONFIG_RECEIVER where MESSAGE_CONFIG_ID=toreadmsgId and TYPE=40;
        end if;
    select  count(1) into rowcount from SYS_MESSAGE_CONFIG_RECEIVER where MESSAGE_CONFIG_ID=toreadmsgId and TYPE=30;
        if rowcount<>0 then
            select RECEIVER_VALUE into toreadNOTICEPROJECTROLES from SYS_MESSAGE_CONFIG_RECEIVER where MESSAGE_CONFIG_ID=toreadmsgId and TYPE=30;
        end if;
     select  count(1) into rowcount from SYS_MESSAGE_CONFIG_RECEIVER where MESSAGE_CONFIG_ID=toreadmsgId and TYPE=110;
        if rowcount<>0 then
            select RECEIVER_VALUE into toreadNOTICEORGIDS from SYS_MESSAGE_CONFIG_RECEIVER where MESSAGE_CONFIG_ID=toreadmsgId and TYPE=110;
        end if;
     select  count(1) into rowcount from SYS_MESSAGE_CONFIG_RECEIVER where MESSAGE_CONFIG_ID=toreadmsgId and TYPE=130;
        if rowcount<>0 then
            select RECEIVER_VALUE into toreadNOTICEPERSONS from SYS_MESSAGE_CONFIG_RECEIVER where MESSAGE_CONFIG_ID=toreadmsgId and TYPE=130;
        end if;
         P_SYS_PERSON_LIST_ANALYSIS(
            NOTICEPERSONS => toreadNOTICEPERSONS,
            NOTICEGROUPS => toreadNOTICEGROUPS,
            NOTICEPROJECTROLES => toreadNOTICEPROJECTROLES,
            NOTICEORGIDS => toreadNOTICEORGIDS,
            PROJECTID => project_id,
            UUID => toreadpersonuuid
          );
          select count(1) into rowcount  from PERSON_ROLE_ANALYSIS_TABLE where detail=toreadpersonuuid;
            dbms_output.put_line('toread:'||rowcount);
    --处理待阅发送人信息 end
  end if;

select count(1) into rowcount  from PERSON_ROLE_ANALYSIS_TABLE;
if toreadrow<>0 and   todorow<>0  and   rowcount<>0 then
dbms_output.put_line('total:'||rowcount);
insert into TEMP_SYS_MESSAGE_SEND_LIST
  select 
    uuid as "id",
    creater as "senderAccount",                        --发送人
    tab.Code as  "recipientAccount",    --接收人
    todo_systemId as  "systemId",--系统id
    todo_systemappId as   "appid",--应用id
    GET_UUID() as "bizKey",--业务id--门户网站的taskId
    bizMsgCategory as "bizMsgCategory",--消息所属类别
-------------------------------------------------------------【短信微信必须】基础信息 ------------------------------------------------------------
    '' as "msgChannel", --使用消息渠道 多个，逗号分隔   tjWeChat：铁建微信,tjSMS：铁建短信
    '' as "smsTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID  --{1}您好，{2}对您负责的任务“{3}”进行了催办，请及时到门户网站查看待办并在《计划管理系统》中反馈任务进度{4}。
    '[]' AS "smsParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
    ''  as "mobile",--短信接收人电话
    '' AS "wechatTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID
    '[]' AS "wechatParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
    '' AS "wechatJumplinkUrl",--微信打开地址，程序调用发消息前需要编码
    '' AS "title",--消息标题
    '' AS "bizSourceCategory",
-------------------------------------------------------------【门户消息必须】基础信息 ------------------------------------------------------------
    0 as "portalMsgType",
    todopcurl as "url",--pc端的url地址
    '' as "mobileUrl",--移动端的url地址
    toDo_Title as "taskname", --任务名称，等于3、插入待阅/4、插入已阅informationname;等于插入关注的attentionname
    typename as "typename",--任务类型
    config_code||'ToDo_'||projectID as "remark",
     to_char(sysdate,'yyyy-MM-dd HH24:mi:ss')  "expiretime",--expiretime	否	String	过期时间，格式yyyy-MM-dd HH:mm:ss-----过期时间，除关注都有
     1  "priority"--priority	否	Integer	优先级，除关注都有 
    from 
     --查询发送人是需要进行按用户user_code进行分组
    (select code from PERSON_ROLE_ANALYSIS_TABLE where detail=todopersonuuid group by code ) tab
    union
    select 
    uuid as "id",
    creater as "senderAccount",                        --发送人
    tab.Code as  "recipientAccount",    --接收人
    toread_systemId as  "systemId",--系统id
    toread_systemappId as   "appid",--应用id
    GET_UUID() as "bizKey",--业务id--门户网站的taskId
    bizMsgCategory as "bizMsgCategory",--消息所属类别
-------------------------------------------------------------【短信微信必须】基础信息 ------------------------------------------------------------
    '' as "msgChannel", --使用消息渠道 多个，逗号分隔   tjWeChat：铁建微信,tjSMS：铁建短信
    '' as "smsTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID  --{1}您好，{2}对您负责的任务“{3}”进行了催办，请及时到门户网站查看待办并在《计划管理系统》中反馈任务进度{4}。
    '[]' AS "smsParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
    ''  as "mobile",--短信接收人电话
    '' AS "wechatTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID
    '[]' AS "wechatParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
    '' AS "wechatJumplinkUrl",--微信打开地址，程序调用发消息前需要编码
    '' AS "title",--消息标题
    '' AS "bizSourceCategory",
-------------------------------------------------------------【门户消息必须】基础信息 ------------------------------------------------------------
    10 as "portalMsgType",
    toreadpcurl as "url",--pc端的url地址
    '' as "mobileUrl",--移动端的url地址
    toRead_Title as "taskname", --任务名称，等于3、插入待阅/4、插入已阅informationname;等于插入关注的attentionname
   typename as "typename",--任务类型
    '' as "remark",
     to_char(sysdate,'yyyy-MM-dd HH24:mi:ss')  "expiretime",--expiretime	否	String	过期时间，格式yyyy-MM-dd HH:mm:ss-----过期时间，除关注都有
     1  "priority"--priority	否	Integer	优先级，除关注都有 
    from 
    --查询发送人是需要进行按用户user_code进行分组
    (select code from PERSON_ROLE_ANALYSIS_TABLE where detail=toreadpersonuuid group by code ) tab;
end if;
end if;
END p_sys_msg_config_info_help;
/

prompt
prompt Creating procedure P_SYS_MSG_CONFIG_INFO
prompt ========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_sys_msg_config_info(
    toDoPCAddress    IN     varchar2,     -- 消息打开pc端地址
    toReadPCAddress in varchar2,         --消息打开mobile端地址
    toDoTitle  in varchar2,                     --消息标题
    toReadTitle  in varchar2,                  --消息标题
    projectID  in varchar2,                    --项目实例ID
    msgCode in varchar2,                     --消息的code
    creater in varchar2,                        --发送人usercode
    messageType out      varchar2,       --0:门户终端消息都推送，1：只推送门户，2：只推送短信或微信
    info     OUT      SYS_REFCURSOR     --消息集合
) IS
uuid  varchar2(36) ;
rowcount number;
begin
uuid:=get_uuid();
messageType:=1;
p_sys_msg_config_info_help(
    TODOPCADDRESS => TODOPCADDRESS,
    TOREADPCADDRESS => TOREADPCADDRESS,
    TODOTITLE => TODOTITLE,
    TOREADTITLE => TOREADTITLE,
    PROJECTID => PROJECTID,
    MSGCODE => MSGCODE,
    CREATER => CREATER,
    uuid => uuid
);
 select count(1) into rowcount from TEMP_SYS_MESSAGE_SEND_LIST WHERE ID=uuid;
    if rowcount <> 0 then
   open info for select 
        senderAccount "senderAccount",
        recipientAccount  "recipientAccount",
        systemId  "systemId",
        appid "appid",
        bizKey "bizKey",
        bizMsgCategory  "bizMsgCategory",
        msgChannel "msgChannel",
        smsTemplateid "smsTemplateid",
        smsParams "smsParams",
        mobile "mobile",
        wechatTemplateid "wechatTemplateid",
        wechatParams "wechatParams",
        wechatJumplinkUrl "wechatJumplinkUrl",
        title "title",
        bizSourceCategory "bizSourceCategory",
        portalMsgType "portalMsgType",
        url "url",
        mobileUrl "mobileUrl",
        taskname "taskname",
        typename "typename",
        remark "remark",
        expiretime "expiretime",
        priority  "priority"
   from TEMP_SYS_MESSAGE_SEND_LIST where id=uuid;
end if;
exception
when others then
 dbms_output.put_line(sqlcode||'--'||sqlerrm);--sqlcode表示异常代码，sqlerrm表示异常信息
END p_sys_msg_config_info;
/

prompt
prompt Creating procedure P_SYS_MSG_CONFIG_LIST_BY_CODE
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_sys_msg_config_list_by_code(
  msgCode in varchar2,
  messageType out      varchar2,       --0:门户终端消息都推送，1：只推送门户，2：只推送短信或微信
  info     OUT      SYS_REFCURSOR     --消息集合
) IS
rowcount number;
betweenDays number;
toDoPCAddress varchar2(4000);
toReadPCAddress varchar2(4000);
toDoTitle varchar2(1000);
toReadTitle  varchar2(1000);
sql_str clob;
INFO_SQL clob;
CREATER varchar2(50):='yuzheng1';
uuid varchar2(36):='';
begin 
sql_str:='';
betweenDays:=0;
messageType:=1;
uuid:=GET_UUID();
select count(1) into rowcount  from SYS_MESSAGE_CONFIG where CODE=msgCode;
if rowcount <>0 then
        select case when DAYS_BETWEEN is null then 0 else DAYS_BETWEEN end as DAYS_BETWEEN,TITLE,LINK_ADDRESS into betweenDays,toDoTitle,toDoPCAddress from SYS_MESSAGE_CONFIG where CODE=msgCode and rownum=1;
        select TITLE,LINK_ADDRESS into toReadTitle,toReadPCAddress from SYS_MESSAGE_CONFIG where CODE=replace(msgCode,'ToDo','')||'ToRead' and rownum=1;
        TODOTITLE:=replace(TODOTITLE,'{daysBetween}',betweenDays);
        TOREADTITLE:=replace(TOREADTITLE,'{daysBetween}',betweenDays);
        --分期维护待办
        if msgCode='staInfoToDo' then
                for item in ( select project.project_Name,project.PROJECT_ORIGINAL_ID from  
               (select * from mdm_project project where project.id=project.PROJECT_ORIGINAL_ID and project.APPROVAL_STATUS='已审核')  project 
               left join (select count(1) APPROVAL_COUNT,PROJECT_ORIGINAL_ID  from MDM_PERIOD_VERSION where APPROVAL_STATUS='已审核'  
                group by PROJECT_ORIGINAL_ID) tab  on  project.PROJECT_ORIGINAL_ID=tab.PROJECT_ORIGINAL_ID 
                where  floor(sysdate-project.PROJECT_GET_TIME)>=betweenDays and tab.APPROVAL_COUNT is null) loop
                        P_SYS_MSG_CONFIG_INFO_HELP(
                            TODOPCADDRESS => TODOPCADDRESS,
                            TOREADPCADDRESS => TOREADPCADDRESS,
                            TODOTITLE => TODOTITLE,
                            TOREADTITLE => TOREADTITLE,
                            PROJECTID => item.PROJECT_ORIGINAL_ID,
                            MSGCODE => MSGCODE,
                            CREATER => CREATER,
                            UUID => uuid
                      );
               end loop;
        --可研计划编制待办
        elsif msgCode='feasiblePlanToDo' then
              for item in ( select PROJECT_ORIGINAL_ID,Project_name from (select * from mdm_project project where project.id=project.PROJECT_ORIGINAL_ID and project.APPROVAL_STATUS='已审核') project 
             left join (select count(1) APPROVAL_COUNT,PROJ_ID from POM_PROJ_PLAN where PLAN_TYPE='可研计划' and ( APPROVAL_STATUS='已审核'   or APPROVAL_STATUS='审核中')
            group by PROJ_ID) plan on project.PROJECT_ORIGINAL_ID=plan.PROJ_ID where plan.APPROVAL_COUNT is null and  floor(sysdate-project.PROJECT_GET_TIME)>=betweenDays) loop
                 P_SYS_MSG_CONFIG_INFO_HELP(
                    TODOPCADDRESS => TODOPCADDRESS,
                    TOREADPCADDRESS => TOREADPCADDRESS,
                    TODOTITLE => TODOTITLE,
                    TOREADTITLE => TOREADTITLE,
                    PROJECTID => item.PROJECT_ORIGINAL_ID,
                    MSGCODE => MSGCODE,
                    CREATER => CREATER,
                     UUID => uuid
                );
             end loop;
         --首开分期关键节点计划编制待办
        elsif msgCode='firstStageKeyNodeToDo' then
             for item in (select pro.PERIOD_ORIGINAL_ID,pro.period_name,pro.project_original_id,project.project_name,project.id from
             --已审核的首开分期分期
             (select per.PERIOD_ORIGINAL_ID,per.period_name,per.project_original_id from MDM_PERIOD per left join MDM_PERIOD_VERSION ver on per.PERIOD_VERSION_ID=ver.id 
             where ver.APPROVAL_STATUS='已审核' and per.IS_FIRST_OPEN_PERIOD=1 and per.Id=per.PERIOD_ORIGINAL_ID) pro
            --关联项目
             left join mdm_project project on project.id=pro.project_original_id
             --查询分期的已审核和审核中的关键节点计划的数量
            left join (select count(1) APPROVAL_COUNT,PROJ_ID from POM_PROJ_PLAN  where PLAN_TYPE='关键节点计划' and ( APPROVAL_STATUS='已审核'   or APPROVAL_STATUS='审核中')
            group by PROJ_ID) plan
            on pro.PERIOD_ORIGINAL_ID=plan.PROJ_ID  where project.id is not null and project.APPROVAL_STATUS='已审核' and plan.APPROVAL_COUNT is null  and  floor(sysdate-project.PROJECT_GET_TIME)>=betweenDays) loop
                     P_SYS_MSG_CONFIG_INFO_HELP(
                        TODOPCADDRESS => TODOPCADDRESS,
                        TOREADPCADDRESS => TOREADPCADDRESS,
                        TODOTITLE => TODOTITLE,
                        TOREADTITLE => TOREADTITLE,
                        PROJECTID => item.PROJECT_ORIGINAL_ID||';'||item.PERIOD_ORIGINAL_ID,
                        MSGCODE => MSGCODE,
                        CREATER => CREATER,
                        UUID => uuid
                    );
            end loop;
        --首开分期项目主项计划编制待办
        elsif msgCode='firstStageProToDo' then
             for item in (select pro.PERIOD_ORIGINAL_ID,pro.period_name,pro.project_original_id,project.project_name,project.id from
             --已审核的首开分期分期
             (select per.PERIOD_ORIGINAL_ID,per.period_name,per.project_original_id from MDM_PERIOD per left join MDM_PERIOD_VERSION ver on per.PERIOD_VERSION_ID=ver.id 
             where ver.APPROVAL_STATUS='已审核' and per.IS_FIRST_OPEN_PERIOD=1 and per.Id=per.PERIOD_ORIGINAL_ID) pro
            --关联项目
             left join mdm_project project on project.id=pro.project_original_id
             --查询分期的已审核和审核中的项目主项计划的数量
            left join (select count(1) APPROVAL_COUNT,PROJ_ID from POM_PROJ_PLAN  where PLAN_TYPE='项目主项计划' and ( APPROVAL_STATUS='已审核'   or APPROVAL_STATUS='审核中')
            group by PROJ_ID) plan
            on pro.PERIOD_ORIGINAL_ID=plan.PROJ_ID  where project.id is not null and project.APPROVAL_STATUS='已审核' and plan.APPROVAL_COUNT is null  and  floor(sysdate-project.PROJECT_GET_TIME)>=betweenDays) loop
                     P_SYS_MSG_CONFIG_INFO_HELP(
                        TODOPCADDRESS => TODOPCADDRESS,
                        TOREADPCADDRESS => TOREADPCADDRESS,
                        TODOTITLE => TODOTITLE,
                        TOREADTITLE => TOREADTITLE,
                        PROJECTID => item.PROJECT_ORIGINAL_ID||';'||item.PERIOD_ORIGINAL_ID,
                        MSGCODE => MSGCODE,
                        CREATER => CREATER,
                         UUID => uuid
                    );
            end loop;
        --续开分期关键节点计划
        elsif msgCode='conStageKeyNodeToDo' then
             for item in (
             --已审核的续开分期分期
             select pro.PERIOD_ORIGINAL_ID,pro.period_name,pro.project_original_id,project.project_name,project.id from
             (select per.PERIOD_ORIGINAL_ID,per.period_name,per.project_original_id from MDM_PERIOD per left join MDM_PERIOD_VERSION ver on per.PERIOD_VERSION_ID=ver.id 
             where ver.APPROVAL_STATUS='已审核' and per.IS_FIRST_OPEN_PERIOD<>1 and per.Id=per.PERIOD_ORIGINAL_ID) pro
             --已审核的续开分期分期所属项目
             left join mdm_project project on project.id=pro.project_original_id
             --查询分期的已审核和审核中的关键节点计划的数量
            left join (select count(1) APPROVAL_COUNT,PROJ_ID from POM_PROJ_PLAN  where PLAN_TYPE='关键节点计划' and ( APPROVAL_STATUS='已审核'   or APPROVAL_STATUS='审核中')
            group by PROJ_ID) plan
            on pro.PERIOD_ORIGINAL_ID=plan.PROJ_ID  where project.id is not null and project.APPROVAL_STATUS='已审核' and  floor(sysdate-project.PROJECT_GET_TIME)>=betweenDays  and plan.APPROVAL_COUNT is null) loop
                  P_SYS_MSG_CONFIG_INFO_HELP(
                        TODOPCADDRESS => TODOPCADDRESS,
                        TOREADPCADDRESS => TOREADPCADDRESS,
                        TODOTITLE => TODOTITLE,
                        TOREADTITLE => TOREADTITLE,
                        PROJECTID => item.PROJECT_ORIGINAL_ID||';'||item.PERIOD_ORIGINAL_ID,
                        MSGCODE => MSGCODE,
                        CREATER => CREATER,
                        UUID => uuid
                    );
             end loop;
        end if;
    select count(1) into rowcount from TEMP_SYS_MESSAGE_SEND_LIST WHERE ID=uuid;
    dbms_output.put_line('rowcount:'||rowcount);
    if rowcount <> 0 then
        open info for select 
        rownum,
        senderAccount "senderAccount",
        recipientAccount  "recipientAccount",
        systemId  "systemId",
        appid "appid",
        bizKey "bizKey",
        bizMsgCategory  "bizMsgCategory",
        msgChannel "msgChannel",
        smsTemplateid "smsTemplateid",
        smsParams "smsParams",
        mobile "mobile",
        wechatTemplateid "wechatTemplateid",
        wechatParams "wechatParams",
        wechatJumplinkUrl "wechatJumplinkUrl",
        title "title",
        bizSourceCategory "bizSourceCategory",
        portalMsgType "portalMsgType",
        url "url",
        mobileUrl "mobileUrl",
        taskname "taskname",
        typename "typename",
        remark "remark",
        expiretime "expiretime",
        priority  "priority"
        from TEMP_SYS_MESSAGE_SEND_LIST WHERE ID=uuid;
    end if;
end if;
exception
when others then
 dbms_output.put_line(sqlcode||'--'||sqlerrm);--sqlcode表示异常代码，sqlerrm表示异常信息
end p_sys_msg_config_list_by_code;
/

prompt
prompt Creating procedure P_SYS_ROLE_ORG
prompt =================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_SYS_ROLE_ORG (
   userInfo out  SYS_REFCURSOR
) AS
	--虚拟组角色数据源
	--作者：陈丽
	--日期：2020-07-16
BEGIN
open userInfo for
select null as "createtime"
,null "nodetype"
,null "pguid"
,null "isparent"
,null "display"
,VIRTUAL_GROUP_NAME as  "name"
,null "guid"
,null "pid"
,null "ordernum"
,VIRTUAL_GROUP_ID as "id"
,VIRTUAL_GROUP_NAME as  "title"
from SYS_ROLE_USER_RELATION_RESULT where ROLE_TYPE=40 group by VIRTUAL_GROUP_ID,VIRTUAL_GROUP_NAME
order by VIRTUAL_GROUP_NAME
;
END P_SYS_ROLE_ORG;
----------------------------------------------chenl20200621结束------从主数据刷新目标货值存储过程


----------------------------------------------chenl20200621开始------从主数据刷新目标货值存储过程注册
/

prompt
prompt Creating procedure P_SYS_ROLE_PROJ
prompt ==================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_SYS_ROLE_PROJ (
   userInfo out  SYS_REFCURSOR,
   o_result out varchar2
) AS
	--项目级角色数据源
	--作者：陈丽
	--日期：2020-07-16
BEGIN
o_result:='';
open userInfo for
select ROLE_CODE as  "roleCode",
ROLE_NAME as  "roleName" 
from SYS_ROLE_USER_RELATION_RESULT where ROLE_TYPE=30 group by ROLE_NAME,ROLE_CODE
order by ROLE_CODE desc
;
END P_SYS_ROLE_PROJ  ;
/

prompt
prompt Creating procedure P_SYS_USER_TREE
prompt ==================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_sys_user_tree (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    parentid         IN               VARCHAR2,
    data_auth_info   OUT              SYS_REFCURSOR
) AS
--获取用户树
--作者：陈丽
--日期：2020/06/18

    rulevalue        VARCHAR2(50);
    authcount        INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    spid             VARCHAR2(36);--使用临时表的批次号
    data_auth_spid   VARCHAR2(200);
    authcode         VARCHAR2(50);---- 权限编码
    v_id varchar2(100);
BEGIN

    IF parentid IS NULL THEN
        v_id := '0001';
    ELSE
        v_id := parentid;
    END IF;
  --先不健全
    OPEN data_auth_info FOR WITH base AS (
                                SELECT
                                    *
                                FROM
                                    (
                                        SELECT DISTINCT
                                            a.id           AS id,
                                            a.id           AS objid,
                                            a.org_name     AS orgname,
                                            a.org_type     AS orgtype,
                                            a.parent_id    AS parentid,
                                            a.order_code   AS ordercode
                                        FROM
                                            sys_business_unit a
                                        UNION ALL
                                   ----岗位
                                        SELECT
                                            id,
                                            id       AS obj_id,
                                            station_name,
                                            '100' AS orgtype,
                                            org_id   AS parent_id,
                                            station_name
                                        FROM
                                            sys_station
                                        UNION ALL
                                   ----人
                                        SELECT
                                            stu.id,
                                            u.id             AS user_id,
                                            u.user_name,
                                            '110' AS orgtype,
                                            stu.station_id   AS parent_id,
                                            user_code
                                        FROM
                                            sys_station_to_user   stu
                                            LEFT JOIN sys_user              u ON stu.user_id = u.id
                                    )
                            ), 计算 AS (
                                SELECT
                                    base1.id,
                                    base1.objid,
                                    base1.orgname,
                                    base1.orgtype,
                                    base1.parentid,
                                    lpad(base1.ordercode, 10, '0') AS ordercode,
                                    CASE
                                        WHEN base2.parentid IS NULL THEN
                                            1
                                        ELSE
                                            0
                                    END AS isleaf
                                FROM
                                    base base1
                                    LEFT JOIN (
                                        SELECT
                                            parentid
                                        FROM
                                            base
                                        GROUP BY
                                            parentid
                                    ) base2 ON base1.id = base2.parentid
                            )
                            SELECT  *  FROM  计算 WHERE  parentid = v_id  ORDER BY ordercode;

END p_sys_user_tree;
/

prompt
prompt Creating procedure P_UDP_COMPONENT_BY_PAGE
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_UDP_COMPONENT_BY_PAGE (containerGuid in varchar,pageComponents OUT sys_refcursor,treeSelect OUT sys_refcursor,tabs OUT sys_refcursor,tableColumn OUT sys_refcursor,buttoneEvent OUT sys_refcursor,eventMonitoring OUT sys_refcursor,datePicker OUT sys_refcursor)
AS  
haspage INTEGER;
BEGIN  
select count(1) into haspage  from UDP_PAGE where ID=containerGuid;
if haspage=1
then
open pageComponents for  
select   c.ID componentId,                                                      --组件ID
p.ID containerGuid,                                                                --容器ID          
c.COMPONENT_HIGH componentHeight,                          --组件高度
c.COMPONENT_WIDE componentWidth,                            --组件宽度
p.TITLE  pageTitle,                                                                    --页面标题
p.WINDOW_WIDTH  windowWidth,                                      --打开窗口宽度
p.WINDOW_HEIGHT windowHeight,                                     --打开窗口高度
c.COMPONENT_ORDER,                                                           --展示顺序 
c.COMPONENT_NAME componentName,                           --组件名称
c.COMPONENT_LABLE lable,                                                   --组件展示标题
c.COMPONENT_TYPE componentType,                                --组件类型
c.PLACEHOLDER placeholder,                                                 --展示水印文字
p.LAYOUT_TEMPLATE_ID templateName,                              --使用模板名称
l.LAYOUT_AREA_TEMPLATE_ID regionMark,                        --使用区域标识名称
s.IS_CHECK,                                                                                 --是否能够多选
s.IS_CHECKED_LAST_STAGE,                                                    --是否只能选中最末级
 s.DEFAULT_VALUE,                                                                   --默认值
s.DATA_SOURCE_TYPE,                                                             --数据源类型
s.DATA_SOURCE componentSource,                                      --组件数据源
s.PK_FIELD,                                                                                    --主键字段
s.LABLE_FIELD,                                                                              --展示字段
c.DATA_SOURCE                                                                          --展示数据(TemplateHyperText、TemplateContainer)
 from  UDP_LAYOUT l  
 left join UDP_PAGE P on  l.page_id=p.ID
 left join UDP_COMPONENT c on  l.COMPONENT_ID=c.ID 
left join UDP_COMPONENT_DATA_SOURCE s on c.COMPONENT_DATA_SOURCE_ID=s.ID
where l.PAGE_ID=containerGuid and l.page_id=c.page_id order by c.COMPONENT_ORDER asc;
else
open pageComponents for  
select   c.ID componentId,                                                      --组件ID
containerGuid containerGuid,                                                 --容器ID         
c.COMPONENT_HIGH componentHeight,                          --组件高度
c.COMPONENT_WIDE componentWidth,                            --组件宽度
''  pageTitle,                                                                              --页面标题
''  windowWidth,                                                                       --打开窗口宽度
'' windowHeight,                                                                       --打开窗口高度
c.COMPONENT_ORDER ,                                                         --展示顺序 
c.COMPONENT_NAME componentName,                           --组件名称
c.COMPONENT_LABLE lable,                                                  --组件展示标题
c.COMPONENT_TYPE componentType,                               --组件类型
c.PLACEHOLDER placeholder,                                                --展示水印文字
'' templateName,                                                                        --模板名称
l.LAYOUT_AREA_TEMPLATE_ID regionMark,                       --使用区域标识名称
s.IS_CHECK,                                                                                --是否能够多选
s.IS_CHECKED_LAST_STAGE,                                                   --是否只能选中最末级
s.DEFAULT_VALUE ,                                                                   --默认值
s.DATA_SOURCE_TYPE,                                                             --数据源类型
s.DATA_SOURCE componentSource,                                      --组件数据源
s.PK_FIELD,                                                                                    --主键字段
s.LABLE_FIELD,                                                                              --展示字段
c.DATA_SOURCE                                                                       --展示数据(TemplateHyperText、TemplateContainer)
from UDP_COMPONENT c
left join UDP_LAYOUT l on  l.COMPONENT_ID=c.ID 
left join UDP_COMPONENT_DATA_SOURCE s on c.COMPONENT_DATA_SOURCE_ID=s.ID
where c.PAGE_ID=containerGuid order by c.COMPONENT_ORDER asc;
end if;

open treeSelect for  
select  
c.id componentId,                                                                     --组件ID
containerGuid containerGuid,                                                 --容器ID       
case when  t.default_expanded is null then '{"node":0,"level":1,"type":"index"}'
else
t.default_expanded end as default_expanded,                                   --默认展开
t.default_checked,                                                                      --默认选中
case when t.IS_CHECKED_LAST_STAGE   is null
then  s.IS_CHECKED_LAST_STAGE  else    t.IS_CHECKED_LAST_STAGE 
end as  IS_CHECKED_LAST_STAGE                                                --是否只能选中最末级
from  UDP_COMPONENT c 
left join UDP_COMPONENT_DATA_SOURCE s on c.COMPONENT_DATA_SOURCE_ID=s.ID
left join UDP_COMPONENT_TREE_SELECT t on t.ID=c.id
where c.page_id=containerGuid and (c.component_type='TemplateTreeSelect') ;


open tabs for  
select  
c.id componentId,                                                               --组件ID
t.default_tabsitem,                                                              --默认选中项
t.layout_style,                                                                       --默认样式
i.ITEM_VALUE,                                                                       --tabs组件的项具体值
i.ITEM_LABLE,                                                                        --tabs组件的项展示值
i.ID                                                                                          --tabs组件的项ID
from  UDP_COMPONENT c 
left join UDP_COMPONENT_TABS t on t.ID=c.id
left join UDP_COMPONENT_TABS_ITEM i on t.ID=i.COMPONENT_TABS_ID
where c.page_id=containerGuid and (c.component_type='TemplateTabs') order by i.item_order;

open tableColumn for
select 
*
from
(select 
n.ID,
c.ID componentId,                                                     --组件ID
n.COLUMN_LABLE,                                                     --列标题
n.COLUMN_FIELD  ,                                                    --列字段名
n.COLUMN_WIDE ,                                                     --列宽度
n.COLUMN_ALIGN ,                                                   --列对齐
n.COLUMN_FIXED ,                                                    --浮动反方向（left,right）
2 COLUMN_NUMBER_FLOAT,                               --小数字段保留几位
n.COLUMN_DATA_TYPE ,                                         --数据类型
n.is_show_total,                                                          --是否显示合计
n.parent_column_id,                                                  --父级列主键
n.is_use_sort,                                                              --是否使用排序
d.IS_CHECK,                                                                 --是否复选
t.detail_url,                                                                   --双击行跳转地址
d.PK_FIELD,                                                                  --主键字段
n.JUMP_URL,                                                               --点击列跳转地址
n.OPEN_MODE,                                                           --点击列打开页面方式
t.OPEN_MODE DETAIL_MODE,                                          --双击行打开页面方式
n.WINDOW_WIDTH,                                                   --单击列打开弹窗的宽度
n.WINDOW_HEIGHT,                                                   --单击列打开弹窗的高度
n.DEAL_WITH_MODE,                                                  --单击列处理的模式
t.WINDOW_WIDTH as ROW_WINDOW_WIDTH,                              --双击行打开弹窗的宽度
t.WINDOW_HEIGHT as ROW_WINDOW_HEIGHT,                             --双击行打开弹窗的高度
n.IS_USE_HTML,                                                                                      --是否使用html
case  when t.IS_SHOW_PAGINATION is null
then 1 else t.IS_SHOW_PAGINATION end IS_SHOW_PAGINATION,           --是否显示分页
case  when t.IS_SHOW_BORDER is null
then 1 else t.IS_SHOW_BORDER end IS_SHOW_BORDER,                   --是否显示边框
case  when t.IS_SHOW_STRIPE is null
then 1 else t.IS_SHOW_STRIPE end is_show_stripe,                    --是否显示斑马纹
1 is_default_expanded,          --是否展开所有子级
t.ENABLE_STATUS_FIELD,
t.ENABLE_DOUBLE_CLICK_FIELD,
t.DISABLE_PROMPT,
0 as IS_SHOW_EXPAND_BY_LEVEL,
0 as DEFAULT_EXPAND_LEVEL,
case  when t.IS_NEED_PARAMETER_CACHE is null then 0 else  t.IS_NEED_PARAMETER_CACHE end as IS_NEED_PARAMETER_CACHE ,
case  when n.IS_NEED_PARAMETER_CACHE is null then 0 else  n.IS_NEED_PARAMETER_CACHE end as COL_IS_NEED_PARAMETER_CACHE,
case  when t.IS_SHOW_SERIAL_NUMBER is null and lower(c.component_type)='templatetable'  then 1 when
t.IS_SHOW_SERIAL_NUMBER is null and lower(c.component_type)<>'templatetable' then 0 
else t.IS_SHOW_SERIAL_NUMBER end as IS_SHOW_SERIAL_NUMBER,
n.COLUMN_ORDER
from UDP_COMPONENT c 
left join UDP_COMPONENT_TABLE_COLUMN n on c.ID=n.component_table_id
left join UDP_COMPONENT_TABLE  t on c.ID=t.ID
left join UDP_COMPONENT_DATA_SOURCE  d on d.ID=c.COMPONENT_DATA_SOURCE_ID
where c.page_id=containerGuid and (lower(c.component_type)='templatetable' or lower(c.component_type)='templatetreetable' )
and n.STATE=1
union 
select 
n.ID,
c.ID componentId,                                                     --组件ID
n.COLUMN_LABLE,                                                     --列标题
n.COLUMN_FIELD  ,                                                    --列字段名
n.COLUMN_WIDE ,                                                     --列宽度
n.COLUMN_ALIGN ,                                                   --列对齐
n.COLUMN_FIXED ,                                                    --浮动反方向（left,right）
2 COLUMN_NUMBER_FLOAT,                               --小数字段保留几位
n.COLUMN_DATA_TYPE ,                                         --数据类型
n.is_show_total,                                                          --是否显示合计
n.parent_column_id,                                                  --父级列主键
n.is_use_sort,                                                              --是否使用排序
d.IS_CHECK,                                                                 --是否复选
t.detail_url,                                                                   --双击行跳转地址
d.PK_FIELD,                                                                  --主键字段
n.JUMP_URL,                                                               --点击列跳转地址
n.OPEN_MODE,                                                           --点击列打开页面方式
t.OPEN_MODE DETAIL_MODE,                                          --双击行打开页面方式
n.WINDOW_WIDTH,                                                   --单击列打开弹窗的宽度
n.WINDOW_HEIGHT,                                                   --单击列打开弹窗的高度
n.DEAL_WITH_MODE,                                                  --单击列处理的模式
t.WINDOW_WIDTH as ROW_WINDOW_WIDTH,                              --双击行打开弹窗的宽度
t.WINDOW_HEIGHT as ROW_WINDOW_HEIGHT,                             --双击行打开弹窗的高度
n.IS_USE_HTML,                                                                                      --是否使用html
0 IS_SHOW_PAGINATION,                                                                    --是否显示分页
case  when t.IS_SHOW_BORDER is null
then 1 else t.IS_SHOW_BORDER end IS_SHOW_BORDER,                   --是否显示边框
case  when t.IS_SHOW_STRIPE is null
then 1 else t.IS_SHOW_STRIPE end is_show_stripe,                    --是否显示斑马纹
case  when t.IS_DEFAULT_EXPANDED is null
then 1 else t.IS_DEFAULT_EXPANDED end is_default_expanded,          --是否展开所有子级
t.ENABLE_STATUS_FIELD,
t.ENABLE_DOUBLE_CLICK_FIELD,
t.DISABLE_PROMPT,
t.IS_SHOW_EXPAND_BY_LEVEL,
t.DEFAULT_EXPAND_LEVEL,
case  when t.IS_NEED_PARAMETER_CACHE is null then 0 else  t.IS_NEED_PARAMETER_CACHE end as IS_NEED_PARAMETER_CACHE ,
case  when n.IS_NEED_PARAMETER_CACHE is null then 0 else  n.IS_NEED_PARAMETER_CACHE end as COL_IS_NEED_PARAMETER_CACHE,
case  when t.IS_SHOW_SERIAL_NUMBER is null then 0 else t.IS_SHOW_SERIAL_NUMBER end as IS_SHOW_SERIAL_NUMBER,
n.COLUMN_ORDER
from UDP_COMPONENT c 
left join UDP_COMPONENT_TABLE_COLUMN n on c.ID=n.component_table_id
left join UDP_COMPONENT_TREE_TABLE  t on c.ID=t.ID
left join UDP_COMPONENT_DATA_SOURCE  d on d.ID=c.COMPONENT_DATA_SOURCE_ID
where c.page_id=containerGuid and lower(c.component_type)='templatetreetable'
and n.STATE=1) tab
order by COLUMN_ORDER asc;



open buttoneEvent for
SELECT
    e.COMPONENT_BUTTON_ID,                                 --按钮组件ID
    b.TRADE_ID,                                                               --权限点ID
    b.icon,                                                                         --按钮图标
    e.EVENT_TYPE ,                                                          --按钮事件类型
    e.EXECUTE_TYPE ,                                                      --按钮执行类型
    e.EXECUTE_CONTENT,                                              --按钮执行内容
    e.DIALOG_TITLE,                                                        --点击弹窗标题
    e.DIALOG_CONTEN,                                                   --点击弹窗内容
    e.WINDOW_WIDTH,                                                   --打开弹窗的宽度
    e.WINDOW_HEIGHT,                                                   --打开弹窗的高度
case  when e.IS_NEED_PARAMETER_CACHE is null then 0 else  e.IS_NEED_PARAMETER_CACHE end  as IS_NEED_PARAMETER_CACHE
FROM
    UDP_COMPONENT c 
    left join UDP_COMPONENT_BUTTON_EVENT e  on c.ID=e.COMPONENT_BUTTON_ID
    left join udp_component_button b  on c.ID=b.ID
    where c.PAGE_ID=containerGuid and  e.COMPONENT_BUTTON_ID  is not null;

open eventMonitoring for
select 
m.ID,                                                                              --事件监听主键
m.COMPONENT_ID ,                                                   --组件ID
m.TARGET_COMPONENT_ID ,                                   --被监听组件ID
c.COMPONENT_TYPE ,                                                --组件类型
m.IS_MUST_MONITORING   from UDP_EVENT_MONITORING m 
left join UDP_COMPONENT c on m.TARGET_COMPONENT_ID=c.ID
where m.component_id in (select  c.ID   from UDP_COMPONENT c where  c.PAGE_ID=containerGuid);

open datePicker for
select 
c.ID componentId,                                                     --组件ID
d.START_TIME,                                                           --开始时间
d.END_TIME,                                                               --结束时间
d.DEFAULT_VALUE,                                                   --默认时间
d.VALUE_FORMAT                                                    --时间格式
from  UDP_COMPONENT c 
left join UDP_COMPONENT_DATE_PICKER d on c.ID=d.ID
where  c.PAGE_ID=containerGuid and (lower(c.component_type)='templatedatepicker' or lower(c.component_type)='templatedatetimepicker' );
END P_UDP_COMPONENT_BY_PAGE;
/

prompt
prompt Creating procedure P_UDP_COMPONENT_BY_TABLE
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_UDP_COMPONENT_BY_TABLE(componentId in varchar,componentInfo OUT sys_refcursor,tableAttributes OUT sys_refcursor)
AS  
haspage INTEGER;
BEGIN  
open componentInfo for  
select   c.ID componentId,                                                      --组件ID   
c.COMPONENT_HIGH componentHeight,                          --组件高度
c.COMPONENT_WIDE componentWidth,                            --组件宽度
''  pageTitle,                                                                              --页面标题
''  windowWidth,                                                                       --打开窗口宽度
'' windowHeight,                                                                       --打开窗口高度
c.COMPONENT_ORDER ,                                                         --展示顺序 
c.COMPONENT_NAME componentName,                           --组件名称
c.COMPONENT_LABLE lable,                                                  --组件展示标题
c.COMPONENT_TYPE componentType,                               --组件类型
c.PLACEHOLDER placeholder,                                                --展示水印文字
s.IS_CHECK,                                                                                --是否能够多选
s.IS_CHECKED_LAST_STAGE,                                                   --是否只能选中最末级
s.DEFAULT_VALUE ,                                                                   --默认值
s.DATA_SOURCE_TYPE,                                                             --数据源类型
s.DATA_SOURCE componentSource,                                      --组件数据源
s.PK_FIELD,                                                                                 --主键字段
s.LABLE_FIELD,                                                                           --展示字段
c.DATA_SOURCE                                                                       --展示数据(TemplateHyperText、TemplateContainer)
from UDP_COMPONENT c
left join UDP_LAYOUT l on  l.COMPONENT_ID=c.ID 
left join UDP_COMPONENT_DATA_SOURCE s on c.COMPONENT_DATA_SOURCE_ID=s.ID
where c.ID=componentId;
open tableAttributes for
select 
n.ID,
c.ID componentId,                                                     --组件ID
n.COLUMN_LABLE,                                                     --列标题
n.COLUMN_FIELD  ,                                                    --列字段名
n.COLUMN_WIDE ,                                                     --列宽度
n.COLUMN_ALIGN ,                                                   --列对齐
n.COLUMN_FIXED ,                                                    --浮动反方向（left,right）
2 COLUMN_NUMBER_FLOAT,                               --小数字段保留几位
n.COLUMN_DATA_TYPE ,                                         --数据类型
n.is_show_total,                                                          --是否显示合计
n.parent_column_id,                                                  --父级列主键
n.is_use_sort,                                                              --是否使用排序
d.IS_CHECK,                                                                 --是否复选
t.detail_url,                                                                   --双击行跳转地址
d.PK_FIELD,                                                                  --主键字段
n.JUMP_URL,                                                               --点击列跳转地址
n.OPEN_MODE,                                                           --点击列打开页面方式
t.OPEN_MODE DETAIL_MODE,                                 --双击行打开页面方式
n.WINDOW_WIDTH,                                                   --单击列打开弹窗的宽度
n.WINDOW_HEIGHT,                                                   --单击列打开弹窗的高度
n.DEAL_WITH_MODE,                                                  --单击列处理的模式
t.WINDOW_WIDTH as "ROW_WINDOW_WIDTH",  --双击行打开弹窗的宽度
t.WINDOW_HEIGHT as "ROW_WINDOW_WIDTH",  --双击行打开弹窗的高度
n.IS_USE_HTML,                                                            --是否显示html
case  when t.IS_SHOW_PAGINATION is null
then 1 else t.IS_SHOW_PAGINATION end IS_SHOW_PAGINATION,           --是否显示分页
case  when t.IS_SHOW_BORDER is null
then 1 else t.IS_SHOW_BORDER end IS_SHOW_BORDER,                   --是否显示边框
case  when t.IS_SHOW_STRIPE is null
then 1 else t.IS_SHOW_STRIPE end is_show_stripe                    --是否显示斑马纹
from UDP_COMPONENT c 
left join UDP_COMPONENT_TABLE_COLUMN n on c.ID=n.component_table_id
left join UDP_COMPONENT_TABLE  t on c.ID=t.ID
left join UDP_COMPONENT_DATA_SOURCE  d on d.ID=c.COMPONENT_DATA_SOURCE_ID
where c.ID=componentId and (lower(c.component_type)='templatetable' or lower(c.component_type)='templatetreetable' )
and n.STATE=1
order by n.COLUMN_ORDER asc;

END P_UDP_COMPONENT_BY_TABLE;
/

prompt
prompt Creating procedure P_UDP_COMPONENT_DATA_SOURCE
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_UDP_COMPONENT_DATA_SOURCE" (componentId in varchar,dataSourceInfo OUT sys_refcursor)
AS  
BEGIN  
open dataSourceInfo for  
select 
c.DATA_SOURCE ,                                                                                      --数据源配置查询语句或者存储过程标识code
c.DATA_SOURCE_TYPE ,                                                                           --数据源类型
c.PARENT_FIELD ,                                                                                       --父级字段名
c.PK_FIELD ,                                                                                                 --主键字段名
c.LABLE_FIELD,                                                                                            --展示字段名
c.CHILD_FIELD,                                                                                            --子级字段名
t.COMPONENT_TYPE
from UDP_COMPONENT t
left join UDP_COMPONENT_DATA_SOURCE c on t.COMPONENT_DATA_SOURCE_ID=c.id
where t.id=componentId;
END p_UDP_Component_Data_Source;
/

prompt
prompt Creating procedure P_UDP_CREATE_TEMP_TABLE
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_UDP_CREATE_TEMP_TABLE(temp_table_name in VARCHAR2,tablename in VARCHAR2,SQL_STR  in VARCHAR2) AUTHID current_user
as
sqlstr VARCHAR2(4000);
sqlstr1 VARCHAR2(4000);
TABLEEXIST NUMBER;
begin
select    WMSYS.WM_CONCAT( tab.col)   into sqlstr1  from (SELECT a.column_name||'  '||a.data_type||case 
 WHEN  a.DATA_TYPE = 'NVARCHAR2' OR a.DATA_TYPE = 'VARCHAR2' or  a.DATA_TYPE ='CHAR'  THEN  '('||a.DATA_LENGTH||')' 
 WHEN  a.DATA_TYPE = 'DATE' OR a.DATA_TYPE = 'CLOB' or  a.DATA_TYPE = 'NUMBER' or   a.DATA_TYPE ='BLOB' THEN ''
 end as col
 FROM USER_TAB_COLUMNS a where a.TABLE_NAME=tablename order by a.column_id ) tab;
  select count(1) into TABLEEXIST from user_tables where table_name = upper(temp_table_name);
    if TABLEEXIST=1 then 
     execute immediate 'drop table '||upper(temp_table_name);
    end if;
 sqlstr:=' create global temporary table '||upper(temp_table_name)||'(';
 sqlstr:=sqlstr||sqlstr1||') on commit delete rows';
 --创建临时表
  execute immediate sqlstr;
--向临时表中导入数据
  if  SQL_STR is not null
  then
  execute immediate ' insert into  '||temp_table_name||' '||SQL_STR;
  end if;
end P_UDP_CREATE_TEMP_TABLE;
/

prompt
prompt Creating procedure P_UDP_DATA_SOURCE_BY_CODE
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_UDP_DATA_SOURCE_BY_CODE (code in varchar,dataSourceInfo OUT sys_refcursor)
AS  
pcode VARCHAR2(1000);
rowcountByCode int;
rowcountBySource int;
BEGIN  
pcode:=code;
select count(1) into rowcountByCode  from  UDP_COMPONENT_DATA_SOURCE c 
where c.CODE=pcode ;
select count(1) into rowcountBySource  from  UDP_COMPONENT_DATA_SOURCE c 
where c.DATA_SOURCE=pcode ;
if rowcountBySource<>0 THEN
open dataSourceInfo for  
select 
c.DATA_SOURCE ,                                                                                      --数据源配置查询语句或者存储过程标识code
c.DATA_SOURCE_TYPE ,                                                                            --数据源类型
c.PARENT_FIELD ,                                                                                       --父级字段名
c.PK_FIELD ,                                                                                                 --主键字段名
c.LABLE_FIELD,                                                                                            --展示字段名
c.CHILD_FIELD                                                                                             --子级字段名
from  UDP_COMPONENT_DATA_SOURCE c 
where c.DATA_SOURCE=pcode and rownum = 1;
ELSIF rowcountByCode<>0 then
open dataSourceInfo for  
select 
c.DATA_SOURCE ,                                                                                      --数据源配置查询语句或者存储过程标识code
c.DATA_SOURCE_TYPE ,                                                                            --数据源类型
c.PARENT_FIELD ,                                                                                       --父级字段名
c.PK_FIELD ,                                                                                                 --主键字段名
c.LABLE_FIELD,                                                                                            --展示字段名
c.CHILD_FIELD                                                                                             --子级字段名
from  UDP_COMPONENT_DATA_SOURCE c 
where c.CODE=pcode and rownum = 1;
else 
open dataSourceInfo for  
SELECT pcode as  DATA_SOURCE,
'procedure' as  DATA_SOURCE_TYPE,
'' as PARENT_FIELD,
'' as PK_FIELD,
'' as LABLE_FIELD,
'' as CHILD_FIELD
from dual;
end if;
END p_UDP_Data_Source_By_Code;
/

prompt
prompt Creating procedure P_UDP_DATA_SOURCE_BY_PAGE
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_UDP_DATA_SOURCE_BY_PAGE (
    p_pagesql  IN CLOB,                  --sql
    p_curPage  IN  NUMBER ,         --当前页
    p_pageSize IN NUMBER ,         --每页显示记录的条数
    total OUT NUMBER,                   --总记录数
    items OUT SYS_REFCURSOR     -- 输出结果集游标
  )
AS
  v_sql    CLOB;                                  --sql语句
  v_startRecord NUMBER;             --开始显示的记录数
  v_endRecord   NUMBER;             --结束显示的记录条数
BEGIN
                                                            --记录总记录条数
  v_sql:= 'select count(*) FROM (' || p_pagesql || ')';
  EXECUTE IMMEDIATE v_sql INTO total;
                                                            --实现分页查询
  v_startRecord :=(p_curPage - 1) * p_pageSize + 1;
  v_endRecord   :=p_curPage  * p_pageSize;
  v_sql         :='select * from (SELECT t.*, ROWNUM RN from (' || p_pagesql || ') t where rownum<=' || v_endRecord || ' ) where RN>=' ||v_startRecord;

  OPEN items FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE items;
END p_UDP_Data_Source_By_Page;
/

prompt
prompt Creating procedure P_UDP_DELETE_SQL_BY_EXCELID
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_UDP_DELETE_SQL_BY_EXCELID(CODE in VARCHAR2, EXPORT_SQL_LIST OUT SYS_REFCURSOR)  AUTHID current_user
as
str_sql VARCHAR2(4000);
TEMP_TABLE_NAME VARCHAR2(200);
TABLE_NAME VARCHAR2(200);
SQL_STR VARCHAR2(4000);
EXPORT_SQL CLOB :='';
row_index NUMBER;
ROW_COUNT NUMBER;
TABLEEXIST NUMBER;
begin
    row_index:=1;
     str_sql := 'create global temporary table EXPORT_SQL_TABLE  (
        ID INT,
        TABLE_NAME VARCHAR(1000),
        SQL  VARCHAR(4000)
     ) 
    on commit preserve rows';
    --判断临时表是否存在存在就删除
    select count(1) into TABLEEXIST from user_tables where table_name = 'EXPORT_SQL_TABLE';
    if TABLEEXIST=0 then 
     --创建临时表
    execute immediate str_sql;
    else 
    execute immediate 'delete EXPORT_SQL_TABLE';
    end if;

  insert into EXPORT_SQL_TABLE VALUES(row_index,'','set define off;');
/*=================================删除字段信息配置=================================================*/
  TABLE_NAME:= 'UDP_EXPORT_FIELD';
  SQL_STR:=' select * from UDP_EXPORT_FIELD where id in (select EXPORT_FIELD_ID from  UDP_EXPORT_SHEET_FIELD where EXPORT_SHEET_ID='''||CODE||'''';
  SQL_STR:=SQL_STR||'UNION select EXPORT_FIELD_ID from  UDP_EXPORT_SHEET_FIELD where  EXPORT_SHEET_ID in (select Id from UDP_EXPORT_SHEET where EXCEL_ID='''||CODE||'''))';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除字段信息配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*=================================删除sheet配置字段信息配置=================================================*/
  TABLE_NAME:= 'UDP_EXPORT_SHEET_FIELD';
  SQL_STR:=' select * from UDP_EXPORT_SHEET_FIELD where EXPORT_SHEET_ID='''||CODE||''' UNION select * from UDP_EXPORT_SHEET_FIELD where EXPORT_SHEET_ID in (select ID from UDP_EXPORT_SHEET where EXCEL_ID='''||CODE||''' )';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除sheet配置字段信息配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*=================================删除sheet配置信息配置=================================================*/
  TABLE_NAME:= 'UDP_EXPORT_SHEET';
  SQL_STR:=' select * from UDP_EXPORT_SHEET where ID='''||CODE||''' UNION select * from UDP_EXPORT_SHEET where EXCEL_ID='''||CODE||''' ';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除sheet配置信息配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*=================================删除excel配置信息配置=================================================*/
  TABLE_NAME:= 'UDP_EXPORT_EXCEL';
  SQL_STR:='select * from UDP_EXPORT_EXCEL where ID='''||CODE||''' ';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除excel配置信息配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
  /*=================================查询导出的sql语句信息=================================================*/
  open EXPORT_SQL_LIST for 'select SQL from EXPORT_SQL_TABLE order by ID';
  commit;
end  P_UDP_DELETE_SQL_BY_EXCELID;
/

prompt
prompt Creating procedure P_UDP_DELETE_SQL_BY_PAGEID
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_UDP_DELETE_SQL_BY_PAGEID (PAGEID in VARCHAR2, EXPORT_SQL_LIST OUT SYS_REFCURSOR  )  AUTHID current_user
as
str_sql VARCHAR2(4000);
SQL_STR CLOB :='';
row_index NUMBER;
TABLEEXIST NUMBER;
TABLE_NAME VARCHAR2(4000);
ROW_COUNT NUMBER;
SELECT_COMPONENT_BY_PAGEID CLOB :='';
BEGIN
 row_index:=1;
    str_sql := 'create global temporary table EXPORT_SQL_TABLE  (
        ID INT,
        TABLE_NAME VARCHAR(1000),
        SQL  VARCHAR(4000)
     ) 
    on commit preserve rows';
    --判断临时表是否存在不存在就创建
    select count(1) into TABLEEXIST from user_tables where table_name = 'EXPORT_SQL_TABLE';
    if TABLEEXIST=0 then 
      --创建临时表
      execute immediate str_sql;
    else
     --删除临时表数据
      execute immediate 'delete  EXPORT_SQL_TABLE';
    end if;
  insert into EXPORT_SQL_TABLE  VALUES(row_index,'','set define off;');
  SQL_STR:='select * from udp_component where  page_id='''||PAGEID||''' UNION select * from udp_component where  page_id in ';
  SQL_STR:=SQL_STR||'(select ID from UDP_COMPONENT_TABS_ITEM where component_tabs_id in  (select id from udp_component where  page_id='''||PAGEID||''' and component_type=''TemplateTabs''))';
  SQL_STR:=SQL_STR||' UNION ';
  SQL_STR:=SQL_STR||' select * from udp_component WHERE page_id IN (select ID from (select * from udp_component where page_id='''||PAGEID||''' ';
  SQL_STR:=SQL_STR||' UNION  ';
  SQL_STR:=SQL_STR||' select * from udp_component where  page_id in ';
  SQL_STR:=SQL_STR||' (select ID from UDP_COMPONENT_TABS_ITEM where component_tabs_id in  ';
  SQL_STR:=SQL_STR||'(select id from udp_component where  page_id='''||PAGEID||''' and component_type=''TemplateTabs''))) tab1';
  SQL_STR:=SQL_STR||' where tab1.COMPONENT_TYPE=''TemplateDropdown'')';
  SELECT_COMPONENT_BY_PAGEID:='select t.ID from ('||SQL_STR||') t';
/*==================================删除 UDP_EXPORT_FIELD 表字段配置================================================*/
  TABLE_NAME:= 'UDP_EXPORT_FIELD';
  SQL_STR:=' select * from '||TABLE_NAME||' where ID in (select EXPORT_FIELD_ID from UDP_EXPORT_SHEET_FIELD where  EXPORT_SHEET_ID in（select ID from  UDP_EXPORT_SHEET  where EXCEL_ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') )';
  SQL_STR:=SQL_STR||' UNION select ID from  UDP_EXPORT_SHEET  where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') ) ) )';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除字段配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_EXPORT_SHEET_FIELD 表sheet导出字段配置================================================*/
  TABLE_NAME:= 'UDP_EXPORT_SHEET_FIELD';
   SQL_STR:=' select * from '||TABLE_NAME||' where  EXPORT_SHEET_ID in（select ID from  UDP_EXPORT_SHEET  where EXCEL_ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') )';
  SQL_STR:=SQL_STR||' UNION select ID from  UDP_EXPORT_SHEET  where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') ) )';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除sheet导出字段配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_EXPORT_SHEET 表excel导出sheet配置================================================*/
  TABLE_NAME:= 'UDP_EXPORT_SHEET';
  SQL_STR:=' select * from  '||TABLE_NAME||' where EXCEL_ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') )';
  SQL_STR:=SQL_STR||' UNION  select * from '||TABLE_NAME||' where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') ) ';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除excel导出sheet配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_EXPORT_EXCEL 表excel导出配置================================================*/
  TABLE_NAME:= 'UDP_EXPORT_EXCEL';
  SQL_STR:=' select * from  '||TABLE_NAME||' where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') )';
  SQL_STR:=SQL_STR||' UNION  select * from '||TABLE_NAME||' where ID in  (select EXCEL_ID from  UDP_EXPORT_SHEET  where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') ) )';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除excel导出配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
  /*==================================删除 UDP_LAYOUT 表组件布局配置================================================*/
  TABLE_NAME:= 'UDP_LAYOUT';
  SQL_STR:='  select * from '||TABLE_NAME||' where COMPONENT_ID  in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除组件布局配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_EVENT_MONITORING 表组件监听配置================================================*/
 TABLE_NAME:= 'UDP_EVENT_MONITORING';
  SQL_STR:='  select *  from '||TABLE_NAME||' where component_id in ('||SELECT_COMPONENT_BY_PAGEID||') and TARGET_COMPONENT_ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除组件监听配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_DATE_PICKER 表存储过程参数配置================================================*/
  TABLE_NAME:= 'UDP_PROCEDURE_PARAMETER';
    SQL_STR:='select r.* from UDP_PROCEDURE_REGISTRATION r where r.code in (select s.data_source from  (select component_data_source_id from UDP_COMPONENT where ID  in   ('||SELECT_COMPONENT_BY_PAGEID||') ';
    SQL_STR:=SQL_STR||' and component_data_source_id is not null) d left join UDP_COMPONENT_DATA_SOURCE s on d.component_data_source_id=s.id where s.data_source_type=''procedure'') ';
    SQL_STR:=SQL_STR|| ' UNION ';
    SQL_STR:=SQL_STR||'select  r.* from ( select  case when instr(s.data_source,''?'',1,1) <>0 then  substr(s.data_source,instr(s.data_source,''?'',1,1)+1)||''&''  end conten ';
    SQL_STR:=SQL_STR||'from  (select component_data_source_id from UDP_COMPONENT where ID in  ('||SELECT_COMPONENT_BY_PAGEID||') ';
    SQL_STR:=SQL_STR||'and component_data_source_id is not null) d left join UDP_COMPONENT_DATA_SOURCE s on d.component_data_source_id=s.id ';
    SQL_STR:=SQL_STR||'where s.data_source LIKE ''/api/udp/getExecuteProcedureResult%'' or  s.data_source LIKE ''/api/udp/getRegisterResult%'' or  s.data_source LIKE ''/api/public/udp/getRegisterResult%'' )tab , UDP_PROCEDURE_REGISTRATION r ';
    SQL_STR:=SQL_STR||'where tab.conten like ''%code=''||r.code||''&%'' ';
    SQL_STR:=SQL_STR||' UNION ';
    SQL_STR:=SQL_STR||'select  r.*  from (select case when instr(EXECUTE_CONTENT,''?'',1,1) <>0 then  substr(EXECUTE_CONTENT,instr(EXECUTE_CONTENT,''?'',1,1)+1)||''&''  end conten   from UDP_COMPONENT_BUTTON_EVENT where COMPONENT_BUTTON_ID in   ('||SELECT_COMPONENT_BY_PAGEID||') ';
    SQL_STR:=SQL_STR||'and EXECUTE_CONTENT LIKE ''/api/udp/getExecuteProcedureResult%'' or  EXECUTE_CONTENT LIKE ''/api/udp/getRegisterResult%'' or  EXECUTE_CONTENT LIKE ''/api/public/udp/getRegisterResult%'' ) tab, UDP_PROCEDURE_REGISTRATION r ';
    SQL_STR:=SQL_STR||'where tab.conten like ''%code=''||r.code||''&%'' ';
  SQL_STR:='select * from '||TABLE_NAME||' where PROCEDURE_REGISTRATION_ID in ('||' select ID  from ('||SQL_STR||') '||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除存储过程参数配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_PROCEDURE_REGISTRATION 表存储过程配置================================================*/
  TABLE_NAME:= 'UDP_PROCEDURE_REGISTRATION';
    SQL_STR:='select r.* from UDP_PROCEDURE_REGISTRATION r where r.code in (select s.data_source from  (select component_data_source_id from UDP_COMPONENT where ID  in   ('||SELECT_COMPONENT_BY_PAGEID||') ';
    SQL_STR:=SQL_STR||' and component_data_source_id is not null) d left join UDP_COMPONENT_DATA_SOURCE s on d.component_data_source_id=s.id where s.data_source_type=''procedure'') ';
    SQL_STR:=SQL_STR|| ' UNION ';
    SQL_STR:=SQL_STR||'select  r.* from ( select  case when instr(s.data_source,''?'',1,1) <>0 then  substr(s.data_source,instr(s.data_source,''?'',1,1)+1)||''&''  end conten ';
    SQL_STR:=SQL_STR||'from  (select component_data_source_id from UDP_COMPONENT where ID in  ('||SELECT_COMPONENT_BY_PAGEID||') ';
    SQL_STR:=SQL_STR||'and component_data_source_id is not null) d left join UDP_COMPONENT_DATA_SOURCE s on d.component_data_source_id=s.id ';
    SQL_STR:=SQL_STR||'where s.data_source LIKE ''/api/udp/getExecuteProcedureResult%'' or  s.data_source LIKE ''/api/udp/getRegisterResult%'' or  s.data_source LIKE ''/api/public/udp/getRegisterResult%'' )tab , UDP_PROCEDURE_REGISTRATION r ';
    SQL_STR:=SQL_STR||'where tab.conten like ''%code=''||r.code||''&%'' ';
    SQL_STR:=SQL_STR||' UNION ';
    SQL_STR:=SQL_STR||'select  r.*  from (select case when instr(EXECUTE_CONTENT,''?'',1,1) <>0 then  substr(EXECUTE_CONTENT,instr(EXECUTE_CONTENT,''?'',1,1)+1)||''&''  end conten   from UDP_COMPONENT_BUTTON_EVENT where COMPONENT_BUTTON_ID in   ('||SELECT_COMPONENT_BY_PAGEID||') ';
    SQL_STR:=SQL_STR||'and EXECUTE_CONTENT LIKE ''/api/udp/getExecuteProcedureResult%'' or  EXECUTE_CONTENT LIKE ''/api/udp/getRegisterResult%'' or  EXECUTE_CONTENT LIKE ''/api/public/udp/getRegisterResult%'' ) tab, UDP_PROCEDURE_REGISTRATION r ';
    SQL_STR:=SQL_STR||'where tab.conten like ''%code=''||r.code||''&%'' ';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除存储过程配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_DATA_SOURCE 表数据源配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_DATA_SOURCE';
  SQL_STR:='select s.*  FROM udp_component c RIGHT join udp_component_data_source s on c.component_data_source_id=s.id where c.id in ('||SELECT_COMPONENT_BY_PAGEID||') UNION ';
  SQL_STR:=SQL_STR||'select s.*  from (SELECT case when instr(s.data_source,''?'',1,1) <>0 then  substr(s.data_source,instr(s.data_source,''?'',1,1)+1)||''&''  end conten  FROM udp_component c RIGHT join udp_component_data_source s on c.component_data_source_id=s.id where c.id in (';
  SQL_STR:=SQL_STR||SELECT_COMPONENT_BY_PAGEID||')';
  SQL_STR:=SQL_STR||' and  s.data_source LIKE ''/api/udp/getDataSource%'')  tab,udp_component_data_source s where  tab.conten   like ''%code=''||s.code||''&%'' ';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除数据源配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_BUTTON_EVENT 表按钮组件事件配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_BUTTON_EVENT';
  SQL_STR:=' select *  from '||TABLE_NAME||' where COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除按钮组件事件配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_BUTTON 表按钮组件配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_BUTTON';
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除按钮组件配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_TABLE_COLUMN 表table列表组件配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_TABLE_COLUMN';
  SQL_STR:=' select *  from '||TABLE_NAME||' where COMPONENT_TABLE_ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除table组件列配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_TABLE 表table列表组件配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_TABLE';
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除table列表组件配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_TREE_SELECT 表tree-select组件配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_TREE_SELECT';
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除tree-select组件配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_DATE_PICKER 表时间选择器组件配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_DATE_PICKER';
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除时间选择器组件配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_TABS_ITEM 表tabs组件items配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_TABS_ITEM';
  SQL_STR:=' select *  from '||TABLE_NAME||' where COMPONENT_TABS_ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除tabs组件items配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT_TABS 表tabs组件配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT_TABS';
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除tabs组件配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_PAGE 表配置================================================*/
  TABLE_NAME:= 'UDP_PAGE';
  SQL_STR:='  select * from '||TABLE_NAME||' where ID='''||PAGEID||'''';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除页面配置');
    row_index:=row_index+1;
     insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*==================================删除 UDP_COMPONENT 表组件配置================================================*/
  TABLE_NAME:= 'UDP_COMPONENT';
  SQL_STR:='select * from udp_component where  page_id='''||PAGEID||''' UNION select * from udp_component where  page_id in ';
  SQL_STR:=SQL_STR||'(select ID from UDP_COMPONENT_TABS_ITEM where component_tabs_id in  (select id from udp_component where  page_id='''||PAGEID||''' and component_type=''TemplateTabs''))';
  SQL_STR:=SQL_STR||' UNION ';
  SQL_STR:=SQL_STR||' select * from udp_component WHERE page_id IN (select ID from (select * from udp_component where page_id='''||PAGEID||''' ';
  SQL_STR:=SQL_STR||' UNION  ';
  SQL_STR:=SQL_STR||' select * from udp_component where  page_id in ';
  SQL_STR:=SQL_STR||' (select ID from UDP_COMPONENT_TABS_ITEM where component_tabs_id in  ';
  SQL_STR:=SQL_STR||'(select id from udp_component where  page_id='''||PAGEID||''' and component_type=''TemplateTabs''))) tab1';
  SQL_STR:=SQL_STR||' where tab1.COMPONENT_TYPE=''TemplateDropdown'')';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除组件配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*=================================查询导出的sql语句信息=================================================*/
open EXPORT_SQL_LIST for 'select SQL from EXPORT_SQL_TABLE order by ID';
END P_UDP_DELETE_SQL_BY_PAGEID;
/

prompt
prompt Creating procedure P_UDP_DELETE_SQL_BY_PROCODE
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_UDP_DELETE_SQL_BY_PROCODE (CODE in VARCHAR2, EXPORT_SQL_LIST OUT SYS_REFCURSOR)  AUTHID current_user
as
str_sql VARCHAR2(4000);
TEMP_TABLE_NAME VARCHAR2(200);
TABLE_NAME VARCHAR2(200);
SQL_STR VARCHAR2(4000);
EXPORT_SQL CLOB :='';
row_index NUMBER;
ROW_COUNT NUMBER;
TABLEEXIST NUMBER;
begin
    row_index:=1;
     str_sql := 'create global temporary table EXPORT_SQL_TABLE  (
        ID INT,
        TABLE_NAME VARCHAR(1000),
        SQL  VARCHAR(4000)
     ) 
    on commit preserve rows';
    --判断临时表是否存在存在就删除
    select count(1) into TABLEEXIST from user_tables where table_name = 'EXPORT_SQL_TABLE';
    if TABLEEXIST=0 then 
     --创建临时表
    execute immediate str_sql;
    else 
    execute immediate 'delete EXPORT_SQL_TABLE';
    end if;

  insert into EXPORT_SQL_TABLE VALUES(row_index,'','set define off;');
/*=================================删除存储过程参数信息配置=================================================*/
  TABLE_NAME:= 'UDP_PROCEDURE_PARAMETER';
  SQL_STR:=' select * from '||TABLE_NAME||' WHERE PROCEDURE_REGISTRATION_ID IN (select ID from UDP_PROCEDURE_REGISTRATION where CODE='''||CODE||''' and  STATE=1)';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除存储过程参数信息配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
/*=================================删除存储过程注册信息配置=================================================*/
  TABLE_NAME:= 'UDP_PROCEDURE_REGISTRATION';
  SQL_STR:='  select * from '||TABLE_NAME||' where CODE='''||CODE||'''  and  STATE=1';
  execute immediate ' select COUNT(1)  from ('||SQL_STR||') t' INTO  ROW_COUNT;
  IF ROW_COUNT <> 0 THEN
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'--删除存储过程注册信息配置');
    row_index:=row_index+1;
    insert into EXPORT_SQL_TABLE  VALUES(row_index,TABLE_NAME,'delete '||TABLE_NAME||' where ID in  (select t.ID from ('||SQL_STR||') t );');
  END IF;
  /*=================================查询导出的sql语句信息=================================================*/
  open EXPORT_SQL_LIST for 'select SQL from EXPORT_SQL_TABLE order by ID';
  commit;
end  P_UDP_DELETE_SQL_BY_PROCODE;
/

prompt
prompt Creating procedure P_UDP_EXPORT_BY_CODE
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_UDP_EXPORT_BY_CODE (code in  VARCHAR2,sheetField OUT sys_refcursor )
AS  
rowcountByExcelId  int;
rowcountByDataSource  int;
BEGIN  
select count(1) into rowcountByExcelId  from  UDP_EXPORT_EXCEL e
where e.id=code;
if rowcountByExcelId<>0 THEN
open sheetField for  
 SELECT
    e.id as excel_id,
    e.file_name,
    s.id as sheet_id,
    data_source,
    name,
    excel_title,
    ROW_BG_COLOR_FIELD,
    header_bg_color,
    header_font_color,
    sheet_order,
    f. id,
    f.lable,
    f.field,
    f.wide,
    f.align,
    f.data_type,
    f.is_show_total,
    f.field_order,
    f.TEXT_ALIGN,
    f.parent_id as PARENT_COLUMN_ID
FROM
    udp_export_sheet s
    left join UDP_EXPORT_EXCEL e on s.excel_id=e.id
    left join UDP_EXPORT_SHEET_FIELD t on  s.Id=t.export_sheet_id
    left join UDP_EXPORT_FIELD f on t.export_field_id=f.id
    where e.id=code order by f.field_order;
else
    select count(1) into rowcountByDataSource  from  udp_export_sheet s
    where s.id=code;
        if rowcountByDataSource<>0 THEN
    open sheetField for  
     SELECT
        e.id as excel_id,
        e.file_name,
        s.id as sheet_id,
        data_source,
        name,
        excel_title,
        ROW_BG_COLOR_FIELD,
        header_bg_color,
        header_font_color,
        sheet_order,
        f. id,
        f.lable,
        f.field,
        f.wide,
        f.align,
        f.data_type,
        f.is_show_total,
        f.field_order,
        f.TEXT_ALIGN,
        f.parent_id as PARENT_COLUMN_ID
    FROM
        udp_export_sheet s
        left join UDP_EXPORT_EXCEL e on s.excel_id=e.id
        left join UDP_EXPORT_SHEET_FIELD t on  s.Id=t.export_sheet_id
        left join UDP_EXPORT_FIELD f on t.export_field_id=f.id
        where s.id=code order by f.field_order;
        end if;
end if;
END P_UDP_EXPORT_BY_CODE;
/

prompt
prompt Creating procedure P_UDP_EXPORT_SQL_BY_TABLE_NAME
prompt =================================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_UDP_EXPORT_SQL_BY_TABLE_NAME(temp_table_name in VARCHAR2,tablename  in VARCHAR2,row_index in NUMBER,WHERE_SQL_STR  in VARCHAR2,COMMENT_STR in VARCHAR2 ,sql_str out  CLOB)  AUTHID current_user
as
sqlstr  VARCHAR2(4000);
sqlstr1 VARCHAR2(4000);
sqlstr2 VARCHAR2(4000);
colimns VARCHAR2(4000);
TABLE_NAME  VARCHAR2(4000);
ROW_NUMBER NUMBER;
ROW_COUNT NUMBER;
WHERE_SQL  VARCHAR2(4000);
TABLE_NAME_STR VARCHAR2(4000);
begin
   TABLE_NAME:=upper(tablename);
    P_UDP_CREATE_TEMP_TABLE(
     TEMP_TABLE_NAME => TEMP_TABLE_NAME,
     TABLENAME => TABLE_NAME,
     SQL_STR=>WHERE_SQL_STR
    );
    execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd hh24:mi:ss''';
    TABLE_NAME_STR:=''''||TABLE_NAME||''',';
    ROW_NUMBER:=row_index+1;
    sqlstr:='';
    ROW_COUNT:=0;
    if WHERE_SQL_STR is not null
    then 
    WHERE_SQL:=replace(WHERE_SQL_STR,'''','''''');
     execute immediate ' select COUNT(1)  from ('||WHERE_SQL_STR||') t' INTO  ROW_COUNT;
    end if;
    if COMMENT_STR is not null AND ROW_COUNT<>0 
    then 
    --拼接sql注释
    sqlstr:=' select '||ROW_NUMBER||','''','''||COMMENT_STR||''' from dual  UNION ';
    ROW_NUMBER:=ROW_NUMBER+1;
    sqlstr:=sqlstr||' select '||ROW_NUMBER||','||''''||TABLE_NAME||'(DELETE)'''||',''delete '||TABLE_NAME||' where ID in  (select t.ID from ('||WHERE_SQL||') t );'' from dual  UNION ';
    end if;
     --拼接插入数据语句
     sql_str:='select '||ROW_NUMBER||'+ROWNUM, '||TABLE_NAME_STR||'  ''insert into '||upper(tablename);
     SELECT WMSYS.WM_CONCAT(t.column_name) INTO colimns  FROM USER_TAB_COLUMNS t where t.TABLE_NAME=upper(temp_table_name);
     sqlstr2:='('||colimns||') values (';
     SELECT  WMSYS.WM_CONCAT(t.col) into sqlstr1
	 FROM (
    SELECT  CASE a.data_type 
    WHEN 'NUMBER'
    THEN  '''||case when '||a.column_name||' is null then ''0''  else to_char('||a.column_name ||')  end || '''
    WHEN 'DATE'
    THEN    '''''''||case when '||a.column_name||' is  not  null then  ''$("time")$''||replace('||a.column_name||','''''''','''''''''''')||''$("timeend")$''' || 'end || '''''''
    else 
    '''''''||case when '||a.column_name||' is  not  null then replace('||a.column_name||','''''''','''''''''''')' || 'end || '''''''
    END AS COL,a.column_id,a.column_name FROM USER_TAB_COLUMNS a where a.TABLE_NAME=upper(temp_table_name)
     ) t ORDER BY column_id;
     sqlstr1:=replace(sqlstr1,'||,','||'',');
     sqlstr1:=sqlstr1||');''';
     sql_str:=sqlstr||sql_str||sqlstr2||sqlstr1||' from '||upper(temp_table_name);
end P_UDP_EXPORT_SQL_BY_TABLE_NAME;
/

prompt
prompt Creating procedure P_UDP_EXPORT_SQL_BY_EXCELID
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_UDP_EXPORT_SQL_BY_EXCELID(EXCELID in VARCHAR2, EXPORT_SQL_LIST OUT SYS_REFCURSOR)  AUTHID current_user
as
str_sql VARCHAR2(4000);
TEMP_TABLE_NAME VARCHAR2(200);
TABLE_NAME VARCHAR2(200);
SQL_STR VARCHAR2(4000);
EXPORT_SQL CLOB :='';
row_index NUMBER;
TABLEEXIST NUMBER;
ROW_COUNT NUMBER;
begin
    row_index:=1;
    str_sql := 'create global temporary table EXPORT_SQL_TABLE  (
        ID INT,
        TABLE_NAME VARCHAR(1000),
        SQL  VARCHAR(4000)
     ) 
    on commit preserve rows';
    --判断临时表是否存在不存在就创建
    select count(1) into TABLEEXIST from user_tables where table_name = 'EXPORT_SQL_TABLE';
    if TABLEEXIST=0 then 
      --创建临时表
      execute immediate str_sql;
    else
     --删除临时表数据
      execute immediate 'delete  EXPORT_SQL_TABLE';
    end if;
  execute immediate 'select count(1) from UDP_EXPORT_EXCEL where id='''||EXCELID||''' '  INTO  ROW_COUNT;
  insert into EXPORT_SQL_TABLE VALUES(row_index,'','set define off;');
/*=================================EXCEL导出文件信息配置=================================================*/
 --需要导出的表名
  TABLE_NAME := 'UDP_EXPORT_EXCEL';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
--查询语句
   if ROW_COUNT = 1  then
   SQL_STR:='  select * from '||TABLE_NAME||' where ID='''||EXCELID||'''  ';
	 
   end if;
    if ROW_COUNT = 0  then
    SQL_STR:='  select * from '||TABLE_NAME||' where ID in (SELECT EXCEL_ID FROM UDP_EXPORT_SHEET WHERE  ID= '''||EXCELID||''') ';
   end if;
	 
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--EXCEL导出文件信息初始化',
    SQL_STR => EXPORT_SQL
  );
    --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================EXCEL导出工作簿信息配置=================================================*/
  select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_EXPORT_SHEET';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  --查询页面显示组件的id的集合
   if ROW_COUNT = 1  then
     SQL_STR:=' select * from '||TABLE_NAME||' WHERE EXCEL_ID ='''||EXCELID||''' ';
   end if;
    if ROW_COUNT = 0  then
    SQL_STR:='  select * from '||TABLE_NAME||' where ID ='''||EXCELID||''' ';
   end if;
	 
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--EXCEL导出工作簿信息初始化' ,
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
 /*=================================EXCEL导出工作簿关联表字段信息配置=================================================*/
  select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_EXPORT_SHEET_FIELD';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_EXPORT_SHEET_FIELD';
   if ROW_COUNT = 1  then
   SQL_STR:='select * from '||TABLE_NAME||'  where EXPORT_SHEET_ID in (select ID from UDP_EXPORT_SHEET WHERE EXCEL_ID ='''||EXCELID||''' )';
   end if;
    if ROW_COUNT = 0  then
    SQL_STR:='select * from '||TABLE_NAME||'  where EXPORT_SHEET_ID ='''||EXCELID||''' ';
   end if;
	 
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--EXCEL导出工作簿关联表字段信息初始化' ,
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
 /*=================================EXCEL导出字段信息配置=================================================*/
  select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_EXPORT_FIELD';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  --查询页面显示组件的id的集合
   if ROW_COUNT = 1  then
     SQL_STR:='select * from '||TABLE_NAME||' where ID in (select  EXPORT_FIELD_ID  from UDP_EXPORT_SHEET_FIELD  where EXPORT_SHEET_ID in (select ID from UDP_EXPORT_SHEET WHERE EXCEL_ID ='''||EXCELID||''' ))';
   end if;
    if ROW_COUNT = 0  then
     SQL_STR:='select * from '||TABLE_NAME||' where ID in (select  EXPORT_FIELD_ID  from UDP_EXPORT_SHEET_FIELD  where EXPORT_SHEET_ID  ='''||EXCELID||''' )';
   end if;
	 	 
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--EXCEL导出字段信息初始化' ,
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================查询导出的sql语句信息=================================================*/
   open EXPORT_SQL_LIST for 'select replace(replace(SQL,''''''$("time")$'',''to_date(''''''),''$("timeend")$'''''','''''',''''yyyy-mm-dd hh24:mi:ss'''')'') SQL from EXPORT_SQL_TABLE order by ID';

  commit;
end  P_UDP_EXPORT_SQL_BY_EXCELID;
/

prompt
prompt Creating procedure P_UDP_EXPORT_SQL_BY_PAGEID
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_UDP_EXPORT_SQL_BY_PAGEID (PAGEID in VARCHAR2,IS_COPY in NUMBER, EXPORT_SQL_LIST OUT SYS_REFCURSOR  )  AUTHID current_user
as
str_sql VARCHAR2(4000);
TEMP_TABLE_NAME VARCHAR2(200);
TABLE_NAME VARCHAR2(200);
SQL_STR CLOB :='';
EXPORT_SQL CLOB :='';
row_index NUMBER;
TABLEEXIST NUMBER;
REGISTRATION_IDS VARCHAR2(4000);
SELECT_COMPONENT_BY_PAGEID VARCHAR2(4000);
SELECT_COL VARCHAR2(4000);
begin
    row_index:=1;
    str_sql := 'create global temporary table EXPORT_SQL_TABLE  (
        ID INT,
        TABLE_NAME VARCHAR(1000),
        SQL  VARCHAR(4000)
     ) 
    on commit preserve rows';
    --判断临时表是否存在不存在就创建
    select count(1) into TABLEEXIST from user_tables where table_name = 'EXPORT_SQL_TABLE';
    if TABLEEXIST=0 then 
      --创建临时表
      execute immediate str_sql;
    else
     --删除临时表数据
      execute immediate 'delete  EXPORT_SQL_TABLE';
    end if;
  insert into EXPORT_SQL_TABLE  VALUES(row_index,'','set define off;');
/*=================================导出页面配置=================================================*/
 --需要导出的表名
  TABLE_NAME := 'UDP_PAGE';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
--查询语句
  if IS_COPY=1 then
   SQL_STR:='  select ID ,LAYOUT_TEMPLATE_ID ,CREATED ,CREATOR_ID ,CREATOR ,MODIFIED ,MODIFIER_ID ,MODIFIER ,FUNCTION_ID ,TITLE ,WINDOW_WIDTH ,WINDOW_HEIGHT ,''《''||ID||''》复制配置信息'' REMARK  from '||TABLE_NAME||' where ID='''||PAGEID||'''';
  else
   SQL_STR:='  select * from '||TABLE_NAME||' where ID='''||PAGEID||'''';
  end if;
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--页面基础信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
 /*=================================导出组件配置=================================================*/
  select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  --查询页面显示组件的id的集合
    SQL_STR:='select * from udp_component where  page_id='''||PAGEID||''' UNION select * from udp_component where  page_id in ';
    SQL_STR:=SQL_STR||'(select ID from UDP_COMPONENT_TABS_ITEM where component_tabs_id in  (select id from udp_component where  page_id='''||PAGEID||''' and component_type=''TemplateTabs''))';
    SQL_STR:=SQL_STR||' UNION ';
    SQL_STR:=SQL_STR||' select * from udp_component WHERE page_id IN (select ID from (select * from udp_component where page_id='''||PAGEID||''' ';
    SQL_STR:=SQL_STR||' UNION  ';
    SQL_STR:=SQL_STR||' select * from udp_component where  page_id in ';
    SQL_STR:=SQL_STR||' (select ID from UDP_COMPONENT_TABS_ITEM where component_tabs_id in  ';
    SQL_STR:=SQL_STR||'(select id from udp_component where  page_id='''||PAGEID||''' and component_type=''TemplateTabs''))) tab1';
    SQL_STR:=SQL_STR||' where tab1.COMPONENT_TYPE=''TemplateDropdown'')';
    SELECT_COMPONENT_BY_PAGEID:='select t.ID from ('||SQL_STR||') t';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--组件基础信息初始化' ,
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出组件布局配置=================================================*/
 select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_LAYOUT';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
   SQL_STR:='  select * from '||TABLE_NAME||' where COMPONENT_ID  in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--组件布局信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出组件监听配置=================================================*/
 select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_EVENT_MONITORING';
 --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  SQL_STR:='  select *  from '||TABLE_NAME||' where component_id in ('||SELECT_COMPONENT_BY_PAGEID||') and TARGET_COMPONENT_ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--组件监听信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出按钮组件配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_BUTTON';
 --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--按钮组件基础信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出按钮组件事件配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_BUTTON_EVENT';
 --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_COMPONENT_BUTTON_EVENT';
  SQL_STR:=' select *  from '||TABLE_NAME||' where COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--按钮组件事件信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '|| EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
--/*=================================导出table列表组件事件配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_TABLE';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--table列表组件基础信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出table组件列配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_TABLE_COLUMN';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_COMPONENT_TABLE_COLUMN';
  SQL_STR:=' select *  from '||TABLE_NAME||' where COMPONENT_TABLE_ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--table列表组件显示列信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出tabs组件配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_TABS';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--tabs选项卡组件基础信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出tabs组件items配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_TABS_ITEM';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_COMPONENT_TABS_ITEM';
  SQL_STR:=' select *  from '||TABLE_NAME||' where COMPONENT_TABS_ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--tabs选项卡组件items项信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出UDP_COMPONENT_TREE_SELECT组件配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_TREE_SELECT';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_COMPONENT_TREE_SELECT';
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--树下拉选择器组件基础信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出UDP_COMPONENT_DATE_PICKER组件配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_DATE_PICKER';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_COMPONENT_DATE_PICKER';
  SQL_STR:=' select *  from '||TABLE_NAME||' where ID in ('||SELECT_COMPONENT_BY_PAGEID||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--时间选择器组件基础信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出udp_component_data_source组件数据源配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_DATA_SOURCE';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_COMPONENT_SOURCE';
  if IS_COPY=1 then
    SELECT_COL:='  s. id, s.data_source, s.data_source_type, s.parent_field, s.pk_field, s.lable_field, s.created, s.creator_id,s.creator,s.modified, s.modifier_id,s.modifier,s.child_field, s.code,s.is_checked_last_stage, s.is_check, s.default_value, ''《''||s.id||''》复制配置信息'' remark';
    else
    SELECT_COL:='  s.* ';
    end if;
  SQL_STR:='select '||SELECT_COL||' FROM udp_component c RIGHT join udp_component_data_source s on c.component_data_source_id=s.id where c.id in ('||SELECT_COMPONENT_BY_PAGEID||') UNION ';
  SQL_STR:=SQL_STR||'select '||SELECT_COL||' from (SELECT case when instr(s.data_source,''?'',1,1) <>0 then  substr(s.data_source,instr(s.data_source,''?'',1,1)+1)||''&''  end conten  FROM udp_component c RIGHT join udp_component_data_source s on c.component_data_source_id=s.id where c.id in (';
  SQL_STR:=SQL_STR||SELECT_COMPONENT_BY_PAGEID||')';
 SQL_STR:=SQL_STR||' and  s.data_source LIKE ''/api/udp/getDataSource%'')  tab,udp_component_data_source s where  tab.conten   like ''%code=''||s.code||''&%'' ';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--数据源信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出组件数据源存储过程配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_PROCEDURE_REGISTRATION';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_PROCEDURE_REGISTRATION';
    if IS_COPY=1 then
    SELECT_COL:=' r.ID ,r.NAME ,r.CODE ,r.STATE ,r.CREATED ,r.CREATOR_ID ,r.CREATOR ,r.MODIFIED ,r.MODIFIER_ID ,r.MODIFIER,''《''||r.ID||''》复制配置信息'' REMARK';
    else
    SELECT_COL:=' r.*';
    end if;
SQL_STR:='select '||SELECT_COL||' from UDP_PROCEDURE_REGISTRATION r where r.code in (select s.data_source from  (select component_data_source_id from UDP_COMPONENT where ID  in   ('||SELECT_COMPONENT_BY_PAGEID||') ';
SQL_STR:=SQL_STR||' and component_data_source_id is not null) d left join UDP_COMPONENT_DATA_SOURCE s on d.component_data_source_id=s.id where s.data_source_type=''procedure'') ';
SQL_STR:=SQL_STR|| ' UNION ';
SQL_STR:=SQL_STR||'select '||SELECT_COL||' from ( select  case when instr(s.data_source,''?'',1,1) <>0 then  substr(s.data_source,instr(s.data_source,''?'',1,1)+1)||''&''  end conten ';
SQL_STR:=SQL_STR||'from  (select component_data_source_id from UDP_COMPONENT where ID in  ('||SELECT_COMPONENT_BY_PAGEID||') ';
SQL_STR:=SQL_STR||'and component_data_source_id is not null) d left join UDP_COMPONENT_DATA_SOURCE s on d.component_data_source_id=s.id ';
SQL_STR:=SQL_STR||'where s.data_source LIKE ''/api/udp/getExecuteProcedureResult%'' or  s.data_source LIKE ''/api/udp/getRegisterResult%'' or  s.data_source LIKE ''/api/public/udp/getRegisterResult%'' )tab , UDP_PROCEDURE_REGISTRATION r ';
SQL_STR:=SQL_STR||'where tab.conten like ''%code=''||r.code||''&%'' ';
SQL_STR:=SQL_STR||' UNION ';
SQL_STR:=SQL_STR||'select '||SELECT_COL||' from (select case when instr(EXECUTE_CONTENT,''?'',1,1) <>0 then  substr(EXECUTE_CONTENT,instr(EXECUTE_CONTENT,''?'',1,1)+1)||''&''  end conten   from UDP_COMPONENT_BUTTON_EVENT where COMPONENT_BUTTON_ID in   ('||SELECT_COMPONENT_BY_PAGEID||') ';
SQL_STR:=SQL_STR||'and EXECUTE_CONTENT LIKE ''/api/udp/getExecuteProcedureResult%'' or  EXECUTE_CONTENT LIKE ''/api/udp/getRegisterResult%'' or  EXECUTE_CONTENT LIKE ''/api/public/udp/getRegisterResult%'' ) tab, UDP_PROCEDURE_REGISTRATION r ';
    SQL_STR:=SQL_STR||'where tab.conten like ''%code=''||r.code||''&%'' ';
execute immediate ' select WMSYS.WM_CONCAT(t.ID)  from ('||SQL_STR||') t' INTO  REGISTRATION_IDS;
if REGISTRATION_IDS is not null then  REGISTRATION_IDS:=replace(REGISTRATION_IDS,',',''','''); end if;
REGISTRATION_IDS:=''''||REGISTRATION_IDS||'''';
SQL_STR:='select * from '||TABLE_NAME||' where ID in ('||REGISTRATION_IDS||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--存储过程注册信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出组件数据源存储过程参数配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_PROCEDURE_PARAMETER';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_PROCEDURE_PARAMETER';
  SQL_STR:='select * from '||TABLE_NAME||' where PROCEDURE_REGISTRATION_ID in ('||' select ID  from ('||SQL_STR||') '||')';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--存储过程参数信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出UDP_EXPORT_EXCEL表导出配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_EXPORT_EXCEL';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
    if IS_COPY=1 then
    SELECT_COL:=' ID ,FILE_NAME ,CREATED ,CREATOR_ID ,CREATOR ,MODIFIED ,MODIFIER_ID ,MODIFIER ,''《''||ID||''》复制配置信息'' REMARK';
    else
    SELECT_COL:=' *';
    end if;
  SQL_STR:=' select '||SELECT_COL||' from  '||TABLE_NAME||' where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') )';
  SQL_STR:=SQL_STR||' UNION  select '||SELECT_COL||' from '||TABLE_NAME||' where ID in  (select EXCEL_ID from  UDP_EXPORT_SHEET  where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') ) )';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--导出excel基础信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出UDP_EXPORT_SHEET表sheet导出配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_EXPORT_SHEET';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  SQL_STR:=' select * from  '||TABLE_NAME||' where EXCEL_ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') )';
  SQL_STR:=SQL_STR||' UNION  select * from '||TABLE_NAME||' where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') ) ';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--导出sheet基础信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出UDP_EXPORT_SHEET_FIELD表sheet导出字段配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_EXPORT_SHEET_FIELD';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_EXPORT_SHEET_FIELD';
  SQL_STR:=' select * from '||TABLE_NAME||' where  EXPORT_SHEET_ID in（select ID from  UDP_EXPORT_SHEET  where EXCEL_ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') )';
  SQL_STR:=SQL_STR||' UNION select ID from  UDP_EXPORT_SHEET  where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') ) )';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--导出sheet字段信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================导出字段配置=================================================*/
select count(*) into row_index from EXPORT_SQL_TABLE;
  --需要导出的表名
  TABLE_NAME := 'UDP_EXPORT_FIELD';
  --需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_'||TABLE_NAME;
  SQL_STR:=' select * from UDP_EXPORT_FIELD where ID in (select EXPORT_FIELD_ID from UDP_EXPORT_SHEET_FIELD where  EXPORT_SHEET_ID in（select ID from  UDP_EXPORT_SHEET  where EXCEL_ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') )';
  SQL_STR:=SQL_STR||' UNION select ID from  UDP_EXPORT_SHEET  where ID in  (select EXECUTE_CONTENT  from UDP_COMPONENT_BUTTON_EVENT  where  EXECUTE_TYPE=''export''  and COMPONENT_BUTTON_ID in ('||SELECT_COMPONENT_BY_PAGEID||') ) ) )';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR=>'--导出字段配置信息初始化',
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
/*=================================查询导出的sql语句信息=================================================*/
 if IS_COPY is not null and IS_COPY <> 0 then
  open EXPORT_SQL_LIST for 'select ID,TABLE_NAME,
  CASE 
  WHEN TABLE_NAME IS NOT NULL
  THEN
   substr(substr(SQL,instr(SQL,'') values ('',1,1)+11,length(SQL)),0,
    instr( substr(SQL,instr(SQL,'') values ('',1,1)+11,length(SQL)) ,'','',1,1)-2
   )
  END  PKID,SQL from EXPORT_SQL_TABLE where  TABLE_NAME is null or  instr(TABLE_NAME,''(DELETE)'',1,1)=0   order by ID';
  else
     open EXPORT_SQL_LIST for 'select replace(replace(SQL,''''''$("time")$'',''to_date(''''''),''$("timeend")$'''''','''''',''''yyyy-mm-dd hh24:mi:ss'''')'') SQL from EXPORT_SQL_TABLE order by ID';
  end if;
  commit;
end P_UDP_EXPORT_SQL_BY_PAGEID;
/

prompt
prompt Creating procedure P_UDP_EXPORT_SQL_BY_PROCODE
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813."P_UDP_EXPORT_SQL_BY_PROCODE" (CODE in VARCHAR2, EXPORT_SQL_LIST OUT SYS_REFCURSOR)  AUTHID current_user
as
str_sql VARCHAR2(4000);
TEMP_TABLE_NAME VARCHAR2(200);
TABLE_NAME VARCHAR2(200);
SQL_STR VARCHAR2(4000);
EXPORT_SQL CLOB :='';
row_index NUMBER;
TABLEEXIST NUMBER;
begin
    row_index:=1;
     str_sql := 'create global temporary table EXPORT_SQL_TABLE  (
        ID INT,
        TABLE_NAME VARCHAR(1000),
        SQL  VARCHAR(4000)
     ) 
    on commit preserve rows';
    --判断临时表是否存在存在就删除
    select count(1) into TABLEEXIST from user_tables where table_name = 'EXPORT_SQL_TABLE';
    if TABLEEXIST=0 then 
     --创建临时表
    execute immediate str_sql;
    else 
    execute immediate 'delete EXPORT_SQL_TABLE';
    end if;

  insert into EXPORT_SQL_TABLE VALUES(row_index,'','set define off;');
/*=================================存储过程注册信息配置=================================================*/
 --需要导出的表名
  TABLE_NAME := 'UDP_PROCEDURE_REGISTRATION';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_PROCEDURE_REGISTRATION';
--查询语句
  SQL_STR:='  select * from '||TABLE_NAME||' where CODE='''||CODE||'''  and  STATE=1';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--存储过程注册信息初始化',
    SQL_STR => EXPORT_SQL
  );
    --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
  /*=================================存储过程参数注册信息配置=================================================*/
  select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_PROCEDURE_PARAMETER';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_PROCEDURE_PARAMETER';
  --查询页面显示组件的id的集合
  SQL_STR:=' select * from '||TABLE_NAME||' WHERE PROCEDURE_REGISTRATION_ID IN (select ID from UDP_PROCEDURE_REGISTRATION where CODE='''||CODE||''' and  STATE=1)';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--存储过程参数注册信息初始化' ,
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
  /*=================================数据源信息配置=================================================*/
  select count(*) into row_index from EXPORT_SQL_TABLE;
 --需要导出的表名
  TABLE_NAME := 'UDP_COMPONENT_DATA_SOURCE';
--需要导出的临时表名
  TEMP_TABLE_NAME:='TEMP_COMPONENT_DATA_SOURCE';
  --查询页面显示组件的id的集合
  SQL_STR:=' select * from '||TABLE_NAME||' WHERE DATA_SOURCE ='''||CODE||''' and  DATA_SOURCE_TYPE=''procedure''  and rownum=1';
--创建临时表生成初始化sql语句
   P_UDP_EXPORT_SQL_BY_TABLE_NAME(
    TEMP_TABLE_NAME => TEMP_TABLE_NAME,
    TABLENAME => TABLE_NAME,
    ROW_INDEX =>row_index,
    WHERE_SQL_STR=>SQL_STR,
    COMMENT_STR => '--数据源信息初始化' ,
    SQL_STR => EXPORT_SQL
  );
  --初始化sql语句记录到临时表中
  execute immediate '  insert into EXPORT_SQL_TABLE  '||EXPORT_SQL;
  --删除临时表
  execute immediate 'drop table '||TEMP_TABLE_NAME;
  /*=================================查询导出的sql语句信息=================================================*/
  open EXPORT_SQL_LIST for 'select replace(replace(SQL,''''''$("time")$'',''to_date(''''''),''$("timeend")$'''''','''''',''''yyyy-mm-dd hh24:mi:ss'''')'') SQL from EXPORT_SQL_TABLE order by ID';
  commit;
end  P_UDP_EXPORT_SQL_BY_PROCODE;
/

prompt
prompt Creating procedure P_UDP_PAGE_COMPONENTS
prompt ========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_UDP_PAGE_COMPONENTS (containerGuid in varchar,pageComponents OUT sys_refcursor,treeSelect OUT sys_refcursor,tabs OUT sys_refcursor,tableColumn OUT sys_refcursor,buttoneEvent OUT sys_refcursor,eventMonitoring OUT sys_refcursor,datePicker OUT sys_refcursor)
AS  
haspage INTEGER;
BEGIN  
select count(1) into haspage  from UDP_PAGE where ID=containerGuid;
if haspage=1
then
open pageComponents for  
select   c.ID componentId,                                 --组件ID
c.COMPONENT_HIGH componentHeight,                          --组件高度
c.COMPONENT_WIDE componentWidth,                            --组件宽度
p.TITLE  pageTitle,                                                                    --页面标题
p.WINDOW_WIDTH  windowWidth,                                      --打开窗口宽度
p.WINDOW_HEIGHT windowHeight,                                     --打开窗口高度
c.COMPONENT_ORDER,                                                           --展示顺序 
c.COMPONENT_NAME componentName,                           --组件名称
c.COMPONENT_LABLE lable,                                                   --组件展示标题
c.COMPONENT_TYPE componentType,                                --组件类型
c.PLACEHOLDER placeholder,                                                 --展示水印文字
p.LAYOUT_TEMPLATE_ID templateName,                              --使用模板名称
l.LAYOUT_AREA_TEMPLATE_ID regionMark,                        --使用区域标识名称
s.IS_CHECK,                                                                                 --是否能够多选
s.IS_CHECKED_LAST_STAGE,                                                    --是否只能选中最末级
'' default_value,                                                                           --默认值
s.DATA_SOURCE_TYPE,                                                             --数据源类型
s.DATA_SOURCE componentSource,                                      --组件数据源
s.PK_FIELD,                                                                                    --主键字段
s.LABLE_FIELD,                                                                              --展示字段
c.DATA_SOURCE                                                                          --展示数据(TemplateHyperText、TemplateContainer)
 from  UDP_LAYOUT l  
 left join UDP_PAGE P on  l.page_id=p.ID
 left join UDP_COMPONENT c on  l.COMPONENT_ID=c.ID 
left join UDP_COMPONENT_DATA_SOURCE s on c.COMPONENT_DATA_SOURCE_ID=s.ID
where l.PAGE_ID=containerGuid and l.page_id=c.page_id order by c.COMPONENT_ORDER asc;
else
open pageComponents for  
select   c.ID componentId,                                                      --组件ID
c.COMPONENT_HIGH componentHeight,                          --组件高度
c.COMPONENT_WIDE componentWidth,                            --组件宽度
''  pageTitle,                                                                              --页面标题
''  windowWidth,                                                                       --打开窗口宽度
'' windowHeight,                                                                       --打开窗口高度
c.COMPONENT_ORDER ,                                                         --展示顺序 
c.COMPONENT_NAME componentName,                           --组件名称
c.COMPONENT_LABLE lable,                                                  --组件展示标题
c.COMPONENT_TYPE componentType,                               --组件类型
c.PLACEHOLDER placeholder,                                                --展示水印文字
'' templateName,                                                                        --模板名称
l.LAYOUT_AREA_TEMPLATE_ID regionMark,                       --使用区域标识名称
s.IS_CHECK,                                                                                --是否能够多选
s.IS_CHECKED_LAST_STAGE,                                                   --是否只能选中最末级
'' default_value,                                                                          --默认值
s.DATA_SOURCE_TYPE,                                                             --数据源类型
s.DATA_SOURCE componentSource,                                      --组件数据源
s.PK_FIELD,                                                                                    --主键字段
s.LABLE_FIELD,                                                                              --展示字段
c.DATA_SOURCE                                                                       --展示数据(TemplateHyperText、TemplateContainer)
from UDP_COMPONENT c
left join UDP_LAYOUT l on  l.COMPONENT_ID=c.ID 
left join UDP_COMPONENT_DATA_SOURCE s on c.COMPONENT_DATA_SOURCE_ID=s.ID
where c.PAGE_ID=containerGuid order by c.COMPONENT_ORDER asc;
end if;

open treeSelect for  
select  
c.id componentId,                                                                     --组件ID
t.default_expanded,                                                                  --默认展开
t.default_checked,                                                                      --默认选中
t.IS_CHECKED_LAST_STAGE                                                      --是否只能选中最末级
from  UDP_COMPONENT c 
left join UDP_COMPONENT_TREE_SELECT t on t.ID=c.id
where c.page_id=containerGuid and (c.component_type='TemplateTreeSelect') ;


open tabs for  
select  
c.id componentId,                                                               --组件ID
t.default_tabsitem,                                                              --默认选中项
t.layout_style,                                                                       --默认样式
i.ITEM_VALUE,                                                                       --tabs组件的项具体值
i.ITEM_LABLE,                                                                        --tabs组件的项展示值
i.ID                                                                                          --tabs组件的项ID
from  UDP_COMPONENT c 
left join UDP_COMPONENT_TABS t on t.ID=c.id
left join UDP_COMPONENT_TABS_ITEM i on t.ID=i.COMPONENT_TABS_ID
where c.page_id=containerGuid and (c.component_type='TemplateTabs') order by i.item_order;

open tableColumn for
select 
n.ID,
c.ID componentId,                                                     --组件ID
n.COLUMN_LABLE,                                                     --列标题
n.COLUMN_FIELD  ,                                                    --列字段名
n.COLUMN_WIDE ,                                                     --列宽度
n.COLUMN_ALIGN ,                                                   --列对齐
n.COLUMN_FIXED ,                                                    --浮动反方向（left,right）
2 COLUMN_NUMBER_FLOAT,                               --小数字段保留几位
n.COLUMN_DATA_TYPE ,                                         --数据类型
n.is_show_total,                                                          --是否显示合计
n.parent_column_id,                                                  --父级列主键
n.is_use_sort,                                                              --是否使用排序
d.IS_CHECK,                                                                 --是否复选
t.detail_url,                                                                   --双击行跳转地址
d.PK_FIELD,                                                                  --主键字段
n.JUMP_URL,                                                               --点击列跳转地址
n.OPEN_MODE,                                                           --点击列打开页面方式
t.OPEN_MODE DETAIL_MODE,                                 --双击行打开页面方式
n.WINDOW_WIDTH,                                                   --单击列打开弹窗的宽度
n.WINDOW_HEIGHT,                                                   --单击列打开弹窗的高度
n.DEAL_WITH_MODE,                                                  --单击列处理的模式
t.WINDOW_WIDTH as "ROW_WINDOW_WIDTH",  --双击行打开弹窗的宽度
t.WINDOW_HEIGHT as "ROW_WINDOW_WIDTH",  --双击行打开弹窗的高度
n.IS_USE_HTML,
'' is_show_stripe from UDP_COMPONENT c 
left join UDP_COMPONENT_TABLE_COLUMN n on c.ID=n.component_table_id
left join UDP_COMPONENT_TABLE  t on c.ID=t.ID
left join UDP_COMPONENT_DATA_SOURCE  d on d.ID=c.COMPONENT_DATA_SOURCE_ID
where c.page_id=containerGuid and (lower(c.component_type)='templatetable' or lower(c.component_type)='templatetreetable' )
and n.STATE=1
order by n.COLUMN_ORDER asc;
open buttoneEvent for
SELECT
    e.COMPONENT_BUTTON_ID,                                 --按钮组件ID
    b.TRADE_ID,                                                               --权限点ID
    b.icon,                                                                         --按钮图标
    e.EVENT_TYPE ,                                                          --按钮事件类型
    e.EXECUTE_TYPE ,                                                      --按钮执行类型
    e.EXECUTE_CONTENT,                                              --按钮执行内容
    e.DIALOG_TITLE,                                                        --点击弹窗标题
    e.DIALOG_CONTEN,                                                   --点击弹窗内容
    e.WINDOW_WIDTH,                                                   --打开弹窗的宽度
    e.WINDOW_HEIGHT                                                   --打开弹窗的高度
FROM
    UDP_COMPONENT c 
    left join UDP_COMPONENT_BUTTON_EVENT e  on c.ID=e.COMPONENT_BUTTON_ID
    left join udp_component_button b  on c.ID=b.ID
    where c.PAGE_ID=containerGuid and  e.COMPONENT_BUTTON_ID  is not null;

open eventMonitoring for
select 
m.ID,                                                                              --事件监听主键
m.COMPONENT_ID ,                                                   --组件ID
m.TARGET_COMPONENT_ID ,                                   --被监听组件ID
c.COMPONENT_TYPE ,                                                --组件类型
m.IS_MUST_MONITORING   from UDP_EVENT_MONITORING m 
left join UDP_COMPONENT c on m.TARGET_COMPONENT_ID=c.ID
where m.component_id in (select  c.ID   from UDP_COMPONENT c where  c.PAGE_ID=containerGuid);

open datePicker for
select 
c.ID componentId,                                                     --组件ID
d.START_TIME,                                                           --开始时间
d.END_TIME,                                                               --结束时间
d.DEFAULT_VALUE,                                                   --默认时间
d.VALUE_FORMAT                                                    --时间格式
from  UDP_COMPONENT c 
left join UDP_COMPONENT_DATE_PICKER d on c.ID=d.ID
where  c.PAGE_ID=containerGuid and (lower(c.component_type)='templatedatepicker' or lower(c.component_type)='templatedatetimepicker' );
END P_UDP_PAGE_COMPONENTS;
/

prompt
prompt Creating procedure P_UDP_PROCEDURE_CONFIG
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_UDP_PROCEDURE_CONFIG (procedure_code in varchar,procedureConfigs OUT sys_refcursor)
AS  
BEGIN  
open procedureConfigs for  
SELECT
    r.id,                                                                                 --存储过程配置信息表主键
    r.name,                                                                          --存储过程名
    r.code,                                                                            --配置标识code
    r.state,                                                                            --是否启用
    p.parameter_name,                                                      --存储过程参数名
    p.data_source_keyword,                                              --参数数据来源的关键字标识
    p.parameter_default,                                                    --参数默认值
    case  sys.IN_OUT                                                           --是否为输出参数
    when 'IN' then 1
    else 0 
    end as is_input_parameter,                                          --是否为输入参数
    sys.DATA_TYPE as parameter_type,                           --参数类型
    sys.SEQUENCE as sort                                                  --参数排序
FROM
    udp_procedure_registration r left join UDP_PROCEDURE_PARAMETER p on r.ID=p.PROCEDURE_REGISTRATION_ID
    left join sys.user_arguments sys on upper(r.name)=sys.OBJECT_NAME and upper(p.parameter_name)=sys.ARGUMENT_NAME
    where code=procedure_code;
END p_UDP_Procedure_Config;
/

prompt
prompt Creating procedure P_USER_TREE_LAZY_LOAD
prompt ========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_user_tree_lazy_load (
    userid           IN               VARCHAR2,
    stationid        IN               VARCHAR2,
    deptid           IN               VARCHAR2,
    companyid        IN               VARCHAR2,
    bizcode          IN               VARCHAR2,
    parentid         IN               VARCHAR2,
    data_auth_info   OUT              SYS_REFCURSOR
) AS
--获取用户树
--作者：陈丽
--日期：2020/06/18

    rulevalue        VARCHAR2(50);
    authcount        INT;--用于判断当前公司、部门是否与数据授权的主体有关系
    spid             VARCHAR2(36);--使用临时表的批次号
    data_auth_spid   VARCHAR2(200);
    authcode         VARCHAR2(50);---- 权限编码
    v_id             VARCHAR2(100);
BEGIN
    IF parentid IS NULL THEN
        v_id := '0001';
    ELSE
        v_id := parentid;
    END IF;
  --先不健全

    OPEN data_auth_info FOR WITH base AS (
                               SELECT
                                   *
                               FROM
                                   (
                                       SELECT DISTINCT
                                           a.id           AS id,
                                           a.id           AS objid,
                                           a.org_name     AS orgname,
                                           CASE
                                               WHEN a.is_company = 1 THEN
                                                   100
                                               WHEN a.is_company = 0 THEN
                                                   110
                                           END AS orgtype,
                                           a.parent_id    AS parentid,
                                           a.order_code   AS ordercode
                                       FROM
                                           sys_business_unit a
                                       UNION ALL
                                   ----岗位
                                       SELECT
                                           id,
                                           id       AS obj_id,
                                           station_name,
                                           120 AS orgtype,
                                           org_id   AS parent_id,
                                           station_name
                                       FROM
                                           sys_station
                                       UNION ALL
                                   ----人
                                       SELECT
                                           stu.id,
                                           u.id             AS user_id,
                                           u.user_name,
                                           130 AS orgtype,
                                           stu.station_id   AS parent_id,
                                           user_code
                                       FROM
                                           sys_station_to_user   stu
                                           LEFT JOIN sys_user              u ON stu.user_id = u.id
                                   )
                           ), 计算 AS (
                               SELECT
                                   base1.id,
                                   base1.objid,
                                   base1.orgname,
                                   base1.orgtype,
                                   base1.parentid,
                                   lpad(base1.ordercode, 10, '0') AS ordercode,
                                   CASE
                                       WHEN base2.parentid IS NULL THEN
                                           1
                                       ELSE
                                           0
                                   END AS isleaf
                               FROM
                                   base base1
                                   LEFT JOIN (
                                       SELECT
                                           parentid
                                       FROM
                                           base
                                       GROUP BY
                                           parentid
                                   ) base2 ON base1.id = base2.parentid
                           )
                           SELECT
                               *
                           FROM
                               计算
                           WHERE
                               parentid = v_id
                           ORDER BY
                               ordercode;

END p_user_tree_lazy_load;
/

prompt
prompt Creating procedure P_WFI_PERSON_ROLE_ANALYSIS
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_wfi_person_role_analysis (
    noticePersons  IN   CLOB,     --用户code多个
    noticeGroups   IN    CLOB,    --虚拟组
    noticeProjectRoles    IN     CLOB --项目级角色
) IS
begin
delete PERSON_ROLE_ANALYSIS_TABLE;

if noticePersons is not null then
insert into PERSON_ROLE_ANALYSIS_TABLE (code , type ) SELECT COLUMN_VALUE ,'person' as type 
FROM table (split (noticePersons,';'));
end if;

if noticeGroups is not null then
insert into PERSON_ROLE_ANALYSIS_TABLE SELECT splitstr(COLUMN_VALUE,1) as code,splitstr(COLUMN_VALUE,2) as detail ,'group' as type 
FROM table (split (noticeGroups,';'));
end if;

if noticeProjectRoles is not null then
insert into PERSON_ROLE_ANALYSIS_TABLE SELECT splitstr(COLUMN_VALUE,1) as code,splitstr(COLUMN_VALUE,2) as detail ,'projectRole' as type 
FROM table (split (noticeProjectRoles,';'));
end if;

end p_wfi_person_role_analysis;
/

prompt
prompt Creating procedure P_WFI_COPY_TO_INFO
prompt =====================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.p_wfi_copy_to_info(
    noticePersons  IN   CLOB,              --用户code多个
    noticeGroups   IN    CLOB,             --虚拟组
    noticeProjectRoles    IN     CLOB,    --项目级角色
    noticeTitle    IN     varchar2,           -- 发送通知标题
    addressParams in varchar2,           --页面参数
    workItemID  in  varchar2,               --工作项ID
    processInstID  in varchar2,             --流程实例ID
    pchost in varchar2,                         --pc端域名
    mobilehost in varchar2,                   --pc端域名
    messageType out      varchar2,       --0:门户终端消息都推送，1：只推送门户，2：只推送短信或微信
    info     OUT      SYS_REFCURSOR     --消息集合
) IS
toreadpc  varchar2(1000);
toreadmobile  varchar2(1000);
systemId  varchar2(100);
systemappId  varchar2(100);
bizMsgCategory varchar2(100);
creater varchar2(100);
processName varchar2(4000);
portalMsgType number;
formcode  varchar2(1000);
addressParamsStr varchar2(1000);
begin
  execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd hh24:mi:ss''';
  toreadpc:=pchost||'/wfi-sys/process-operation';
  toreadmobile:=mobilehost||'/wfi/process-info';
  messageType:=1;
  portalMsgType:=10;
  bizMsgCategory:='催办消息';
  if addressParams is not null then
  addressParamsStr:=replace(addressParams,'||','&');
  end if;
  select PROCESS_INST_NAME,CREATEBY,FORM_CODE into processName,creater,formcode from WFI_PROCESS_INST where Id=processInstID and rownum=1;
  select f.SYSTEM_ID,s.APP_ID into systemId,systemappId from WFI_BIZ_FORM f left join SYS_APPLICATION s on f.SYSTEM_ID=s.ID  where f.FORM_CODE=formcode;
  p_wfi_person_role_analysis(
    noticePersons => noticePersons,
    noticeGroups => noticeGroups,
    noticeProjectRoles =>noticeProjectRoles
  );
 OPEN info FOR 
    select 
    creater as "senderAccount",                        --发送人
    persons.user_code as  "recipientAccount",    --接收人
    systemId as  "systemId",--系统id
    systemappId as   "appid",--应用id
    workItemID||persons.user_code as "bizKey",--业务id--门户网站的taskId
    bizMsgCategory as "bizMsgCategory",--消息所属类别
-------------------------------------------------------------【短信微信必须】基础信息 ------------------------------------------------------------
    '' as "msgChannel", --使用消息渠道 多个，逗号分隔   tjWeChat：铁建微信,tjSMS：铁建短信
    '' as "smsTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID  --{1}您好，{2}对您负责的任务“{3}”进行了催办，请及时到门户网站查看待办并在《计划管理系统》中反馈任务进度{4}。
    '[]' AS "smsParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
    ''  as "mobile",--短信接收人电话
    '' AS "wechatTemplateid",--模板 ID，在腾讯云短信审核通过的模板 ID
    '[]' AS "wechatParams",--接收消息参数，--实例如：["流程","提醒0522"] ---发送时会按顺序替换模板的位置=》
    '' AS "wechatJumplinkUrl",--微信打开地址，程序调用发消息前需要编码
    '' AS "title",--消息标题
    '' AS "bizSourceCategory",
-------------------------------------------------------------【门户消息必须】基础信息 ------------------------------------------------------------
    portalMsgType as "portalMsgType",
    CASE 
    when addressParamsStr is not null then
    toreadpc||'?'||addressParamsStr
    else 
    toreadpc end as "url",--pc端的url地址
    case when addressParamsStr is not null then
    toreadmobile||'?'||addressParamsStr 
    else toreadmobile  end as "mobileUrl",--移动端的url地址
    case 
    when noticeTitle is not null then
    noticeTitle||'—'||processName
    else 
    processName end as "taskname", --任务名称，等于3、插入待阅/4、插入已阅informationname;等于插入关注的attentionname
    '计划运营' as "typename",--任务类型
    '工作流平台待阅消息推送' as "remark",
     to_char(sysdate,'yyyy-MM-dd HH24:mi:ss')  "expiretime",--expiretime	否	String	过期时间，格式yyyy-MM-dd HH:mm:ss-----过期时间，除关注都有
     1  "priority"--priority	否	Integer	优先级，除关注都有 
    from 
    (select  distinct tab1.USER_ACCOUNT as user_code from (SELECT r.USER_CODE USER_ACCOUNT from (select code from PERSON_ROLE_ANALYSIS_TABLE where  type='person') tab left join SYS_USER r on r.USER_CODE = tab.code
   union select r.USER_ACCOUNT from  (select * from PERSON_ROLE_ANALYSIS_TABLE where  type='group' and detail  is not null) tab left join SYS_ROLE_USER_RELATION_RESULT r on 
   tab.code=r.VIRTUAL_GROUP_NAME where r.role_type=40 and (r.COMPANY_ID=tab.detail or r.DEPT_ID=tab.detail)
   union select r.USER_ACCOUNT from  (select * from PERSON_ROLE_ANALYSIS_TABLE where  type='projectRole'  and detail  is not null) tab left join SYS_ROLE_USER_RELATION_RESULT r on 
   tab.code=r.role_code  where r.role_type=30 and r.PROJECT_ID=tab.detail) tab1) persons where persons.user_code is not null;
END p_wfi_copy_to_info;
/

prompt
prompt Creating procedure P_WFI_FORM_DATA_BY_BIZ_ID
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_WFI_FORM_DATA_BY_BIZ_ID (
    biz_id in VARCHAR2,                    --业务主键
    process_inst_id in VARCHAR2,       --流程实例ID
    code OUT VARCHAR2,                  --业务表单code
    formData OUT SYS_REFCURSOR,    -- 输出表单数据结果集游标
    fieldData OUT SYS_REFCURSOR      -- 输出表单字段结果集游标
  )
AS
  v_sql    VARCHAR2(4000);                               
  id_field VARCHAR2(50);
  bizId VARCHAR2(50);
BEGIN
execute immediate ' alter session set nls_date_format = ''yyyy-mm-dd hh24:mi:ss''';
SELECT 
    form_code,biz_id  into code,bizId
FROM
    wfi_process_inst where ID=process_inst_id and ROWNUM=1;
SELECT
    d.field_name INTO id_field
FROM
    wfi_biz_form f,wfi_biz_field d 
where form_code=code and f.id=d.form_id and d.is_pk=1 and ROWNUM=1;
SELECT
    form_sql INTO v_sql
FROM
    wfi_biz_form where form_code=code and ROWNUM=1;
open fieldData for  
SELECT
   d. chinese_name,d.field_name,d.IS_SHOW
FROM
    wfi_biz_form f,wfi_biz_field d 
where form_code=code and f.id=d.form_id and form_code=code order by d.sort;
if  instr(v_sql,'{bizId}',1,1)<>0 then
   v_sql :=replace(v_sql,'{bizId}',bizId);
else 
     v_sql :=replace(v_sql,';','');
    v_sql  :='select * from (' || v_sql || ' ) where  ROWNUM=1 and   '||id_field||' =  '''|| bizId||'''';
end if;
    dbms_output.put_line(v_sql);
OPEN formData FOR v_sql;
EXCEPTION
WHEN OTHERS THEN
  CLOSE formData;
END P_WFI_FORM_DATA_BY_BIZ_ID;
/

prompt
prompt Creating procedure P_WFI_SAVE_FORM_CATALOG
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE POM0813.P_WFI_SAVE_FORM_CATALOG(systemId in VARCHAR2, UUID in VARCHAR2,NEWUUID in VARCHAR2,CATALOGCODE in VARCHAR2,CATALOGNAME in varchar,code OUT NUMBER,msg OUT VARCHAR2)
as
  row_count number;
  appid VARCHAR2(36);
BEGIN
  select count(1) into row_count from SYS_APPLICATION where id=systemId;
  if row_count=1 then
    select APP_ID into appid from SYS_APPLICATION where id=systemId;
    select count(1) into row_count from WFI_BIZ_FORM_CATALOG where ID=UUID;
    if row_count=0 then
        Insert into WFI_BIZ_FORM_CATALOG (ID,APP_ID,CODE,NAME) values (UUID,appid,CATALOGCODE,CATALOGNAME);
        code:=0;
        msg:='保存业务目录信息成功';
    else
        UPDATE WFI_BIZ_FORM_CATALOG SET APP_ID=appid,CODE=CATALOGCODE,NAME=CATALOGNAME,ID=NEWUUID WHERE ID=UUID;
        select count(1) into row_count from WFI_BIZ_FORM where CATALOG_UUID=UUID;
            if  row_count<>0 then
                UPDATE WFI_BIZ_FORM SET BELONG_SYSTEM=CATALOGCODE,SYSTEM_ID=systemId,CATALOG_UUID=NEWUUID WHERE CATALOG_UUID=UUID;
            end if;
           code:=0;
           msg:='保存业务目录信息成功';
    end if;
  ELSE
  code:=1000;
  msg:='保存参数无效';
  end if;
  exception 
        when DUP_VAL_ON_INDEX then 
        code:=100;
        msg:='业务目录ID重复';
        rollback;
END P_WFI_SAVE_FORM_CATALOG;
/

prompt
prompt Creating procedure TMP
prompt ======================
prompt
CREATE OR REPLACE PROCEDURE POM0813.TMP IS
		CURSOR CR_BUILD_LIST IS
				SELECT * FROM MDM_BUILD;

BEGIN
		FOR ITEM_BUILD_LIST IN CR_BUILD_LIST
		LOOP
				DBMS_OUTPUT.PUT_LINE(ITEM_BUILD_LIST.BUILD_NAME);
		END LOOP;
END TMP;
/


prompt Done
spool off
set define on
